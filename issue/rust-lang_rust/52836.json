{"url": "https://api.github.com/repos/rust-lang/rust/issues/52836", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/52836/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/52836/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/52836/events", "html_url": "https://github.com/rust-lang/rust/issues/52836", "id": 345570318, "node_id": "MDU6SXNzdWUzNDU1NzAzMTg=", "number": 52836, "title": "Naked functions generate unsound code", "user": {"login": "roblabla", "id": 1069318, "node_id": "MDQ6VXNlcjEwNjkzMTg=", "avatar_url": "https://avatars.githubusercontent.com/u/1069318?v=4", "gravatar_id": "", "url": "https://api.github.com/users/roblabla", "html_url": "https://github.com/roblabla", "followers_url": "https://api.github.com/users/roblabla/followers", "following_url": "https://api.github.com/users/roblabla/following{/other_user}", "gists_url": "https://api.github.com/users/roblabla/gists{/gist_id}", "starred_url": "https://api.github.com/users/roblabla/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/roblabla/subscriptions", "organizations_url": "https://api.github.com/users/roblabla/orgs", "repos_url": "https://api.github.com/users/roblabla/repos", "events_url": "https://api.github.com/users/roblabla/events{/privacy}", "received_events_url": "https://api.github.com/users/roblabla/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 386798469, "node_id": "MDU6TGFiZWwzODY3OTg0Njk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-naked", "name": "A-naked", "color": "f7e101", "default": false, "description": "Area: #[naked], prologue and epilogue-free, functions, https://git.io/vAzzS"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2018-07-29T22:59:37Z", "updated_at": "2018-07-30T19:14:13Z", "closed_at": "2018-07-30T19:14:13Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "https://github.com/roblabla/unwind-rs/blob/d27dfb13a2dd663d89ba67257bc050b8e76febde/unwind/src/glue/aarch64.rs#L14\r\n\r\nThis function generates the following ASM:\r\n\r\n```asm\r\nstr    x0, [sp, #8] ; wtf\r\nmov    x1, sp\r\nsub    sp, sp, #0xa0\r\nstp    x19, x20, [sp]\r\nstp    x21, x22, [sp, #16]\r\nstp    x23, x24, [sp, #32]\r\nstp    x25, x26, [sp, #48]\r\nstp    x27, x28, [sp, #64]\r\nstp    x29, x30, [sp, #80]\r\nstp    d8, d9, [sp, #96]\r\nstp    d10, d11, [sp, #112]\r\nstp    d12, d13, [sp, #128]\r\nstp    d14, d15, [sp, #144]\r\nmov    x2, sp\r\nbl     0xaaaaaac35dd8 <unwind_recorder>\r\nldr    x30, [sp, #88]\r\nadd    sp, sp, #0xa0\r\nret\r\n```\r\n\r\nThe first instruction was not part of the `asm!` macro. It seems to be a stack slot for the first argument. However, since the prelude got removed, `sp` will not get updated to a new size, and this will write over whatever was in the parent's stack.\r\n\r\nI tried to reproduce it on godbolt, but was unable to do so. It seems to depend on optimization levels and size of the project/code ? I have a similar problem on i386 in another project, so this is not arch-specific.", "closed_by": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/52836/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/52836/timeline", "performed_via_github_app": null, "state_reason": "completed"}