{"url": "https://api.github.com/repos/rust-lang/rust/issues/110695", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/110695/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/110695/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/110695/events", "html_url": "https://github.com/rust-lang/rust/issues/110695", "id": 1679629511, "node_id": "I_kwDOAAsO6M5kHRzH", "number": 110695, "title": "Missing opt: inlining condition into Option optimizes better, than not inlining", "user": {"login": "klensy", "id": 1782831, "node_id": "MDQ6VXNlcjE3ODI4MzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1782831?v=4", "gravatar_id": "", "url": "https://api.github.com/users/klensy", "html_url": "https://github.com/klensy", "followers_url": "https://api.github.com/users/klensy/followers", "following_url": "https://api.github.com/users/klensy/following{/other_user}", "gists_url": "https://api.github.com/users/klensy/gists{/gist_id}", "starred_url": "https://api.github.com/users/klensy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/klensy/subscriptions", "organizations_url": "https://api.github.com/users/klensy/orgs", "repos_url": "https://api.github.com/users/klensy/repos", "events_url": "https://api.github.com/users/klensy/events{/privacy}", "received_events_url": "https://api.github.com/users/klensy/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2023-04-22T17:31:04Z", "updated_at": "2023-04-22T22:06:48Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Consider two functions, one with if...else out of Option, other one with if...else inlined.\r\n```rust\r\npub fn foo(x: u8) -> Option<u8> {\r\n    if x < 146 {\r\n        if x > 42 {\r\n            Some(x - 10)\r\n        } else {\r\n            Some(x + 5)\r\n        }\r\n    } else {\r\n        None\r\n    }\r\n}\r\n```\r\n\r\n```rust\r\npub fn foo(x: u8) -> Option<u8> {\r\n    if x < 146 {\r\n        Some(if x > 42 { x - 10 } else { x + 5 })\r\n    } else {\r\n        None\r\n    }\r\n}\r\n```\r\nExpecting that both variants will produce similar asm, but second one actually shorter (and branchless).\r\nNot true for any inlined conditions, some additional calculation on value required to see trigger the difference.\r\nhttps://rust.godbolt.org/z/3fcnz7coj checked on rustc 1.71.0-nightly (39c6804b9 2023-04-19)\r\n\r\n(Probably already existing somewhere, close it that case)\r\n\r\n@rustbot label: +I-Slow", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/110695/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/110695/timeline", "performed_via_github_app": null, "state_reason": null}