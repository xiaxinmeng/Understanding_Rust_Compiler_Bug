{"url": "https://api.github.com/repos/rust-lang/rust/issues/91628", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/91628/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/91628/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/91628/events", "html_url": "https://github.com/rust-lang/rust/issues/91628", "id": 1073211133, "node_id": "I_kwDOAAsO6M4_9-b9", "number": 91628, "title": "Compiling to WASM with emscripten, parse exception: attempted pop from empty stack / beyond block start boundary", "user": {"login": "zackradisic", "id": 56137411, "node_id": "MDQ6VXNlcjU2MTM3NDEx", "avatar_url": "https://avatars.githubusercontent.com/u/56137411?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zackradisic", "html_url": "https://github.com/zackradisic", "followers_url": "https://api.github.com/users/zackradisic/followers", "following_url": "https://api.github.com/users/zackradisic/following{/other_user}", "gists_url": "https://api.github.com/users/zackradisic/gists{/gist_id}", "starred_url": "https://api.github.com/users/zackradisic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zackradisic/subscriptions", "organizations_url": "https://api.github.com/users/zackradisic/orgs", "repos_url": "https://api.github.com/users/zackradisic/repos", "events_url": "https://api.github.com/users/zackradisic/events{/privacy}", "received_events_url": "https://api.github.com/users/zackradisic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 474645165, "node_id": "MDU6TGFiZWw0NzQ2NDUxNjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-wasm", "name": "O-wasm", "color": "6e6ec0", "default": false, "description": "Target: WASM (WebAssembly), http://webassembly.org/"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 16, "created_at": "2021-12-07T10:58:47Z", "updated_at": "2023-01-26T12:44:48Z", "closed_at": "2023-01-26T12:44:48Z", "author_association": "NONE", "active_lock_reason": null, "body": "**TLDR**: Auto-dereferencing seems to break compiling to WASM with emscripten when threads are enabled?\r\n\r\nWhen compiling to WASM with threads enabled with emscripten I get the following error:\r\n```\r\nnote: [parse exception: attempted pop from empty stack / beyond block start boundary at 5012790 (at 0:5012790)]\r\n          Fatal: error in parsing input\r\n          emcc: error: '/Users/zackradisic/Desktop/Code/emsdk/upstream/bin/wasm-emscripten-finalize --minimize-wasm-changes --dyncalls-i64 /Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.wasm -o /Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.wasm --detect-features' failed (returned 1)\r\n```\r\n\r\n<details>\r\n  <summary>Full error from rustc</summary>\r\n\r\n```\r\nerror: linking with `emcc` failed: exit status: 1\r\n  |\r\n  = note: \"emcc\" \"-s\" \"EXPORTED_FUNCTIONS=[\\\"_alloc\\\",\\\"_dealloc\\\",\\\"_init\\\",\\\"_main\\\",\\\"_print_codecs\\\",\\\"_set_opt\\\",\\\"_rust_eh_personality\\\"]\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.0.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.1.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.10.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.11.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.12.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.13.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.14.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.15.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.2.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.3.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.4.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.5.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.6.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.7.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.8.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.framex.f5802fb7-cgu.9.rcgu.o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.3m9l8ll8ayas3g7v.rcgu.o\" \"-L\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps\" \"-L\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/release/deps\" \"-L\" \"./wasm-libs/lib\" \"-L\" \"/Users/zackradisic/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/wasm32-unknown-emscripten/lib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/libframex-7860c6c7abb794c7.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/libanyhow-612bcb44f12e1d42.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/libffmpeg_next-54ea0b38a1519793.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/libffmpeg_sys_next-8de54784e88d927f.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/liblibc-ab293fa92d812261.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/libbitflags-f0b7a29eeb4093a5.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/libstd-35b925955873f6bf.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/libpanic_unwind-194edf489af57a97.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/libstd_detect-d58dd6fb52ab4b2d.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/librustc_demangle-a1931f836e2321a3.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/libhashbrown-93cb9f33d545cf77.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/librustc_std_workspace_alloc-90ae5f2c3dc1e297.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/libunwind-888b2c34d620fb42.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/libcfg_if-e5bd1b9f540b98e1.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/liblibc-f003f163c4e20282.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/liballoc-b31681533b19d24b.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/librustc_std_workspace_core-e54aa39c126b63d9.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/libcore-7c8d732fc023986c.rlib\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/libcompiler_builtins-70ec426a1130b25e.rlib\" \"-l\" \"avcodec\" \"-l\" \"avformat\" \"-l\" \"avfilter\" \"-l\" \"avdevice\" \"-l\" \"swresample\" \"-l\" \"postproc\" \"-l\" \"swscale\" \"-l\" \"avutil\" \"-l\" \"m\" \"-l\" \"mp3lame\" \"-l\" \"x264\" \"-l\" \"workerfs.js\" \"-l\" \"c\" \"-s\" \"DISABLE_EXCEPTION_CATCHING=0\" \"-L\" \"/Users/zackradisic/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/wasm32-unknown-emscripten/lib\" \"-L\" \"/Users/zackradisic/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/wasm32-unknown-emscripten/lib/self-contained\" \"-o\" \"/Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.js\" \"-O3\" \"--memory-init-file\" \"0\" \"-g0\" \"-s\" \"DEFAULT_LIBRARY_FUNCS_TO_INCLUDE=[]\" \"-O3\" \"-pthread\" \"-s\" \"ALLOW_MEMORY_GROWTH=0\" \"-s\" \"INVOKE_RUN=0\" \"-s\" \"INITIAL_MEMORY=2146435072\" \"-s\" \"MODULARIZE=1\" \"-s\" \"EXPORT_NAME=framex\" \"-s\" \"USE_PTHREADS=1\" \"-s\" \"PROXY_TO_PTHREAD=1\" \"-s\" \"ENVIRONMENT=worker\" \"-s\" \"PTHREAD_POOL_SIZE=navigator.hardwareConcurrency\" \"-s\" \"EXPORTED_RUNTIME_METHODS=[FS,intArrayFromString,writeArrayToMemory,_malloc]\" \"gxx_personality_v0_stub.o\" \"-s\" \"ERROR_ON_UNDEFINED_SYMBOLS=1\" \"-s\" \"ASSERTIONS=1\" \"-s\" \"ABORTING_MALLOC=0\" \"-Wl,--fatal-warnings\"\r\n  = note: [parse exception: attempted pop from empty stack / beyond block start boundary at 5012790 (at 0:5012790)]\r\n          Fatal: error in parsing input\r\n          emcc: error: '/Users/zackradisic/Desktop/Code/emsdk/upstream/bin/wasm-emscripten-finalize --minimize-wasm-changes --dyncalls-i64 /Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.wasm -o /Users/zackradisic/Desktop/Code/modfy/framex/target/wasm32-unknown-emscripten/release/deps/framex.wasm --detect-features' failed (returned 1)\r\n```\r\n  \r\n</details>\r\n\r\nI narrowed down the code causing this and it seems related to auto-dereferencing. This is the section of code, and you can see the type of parameter `s` in the closure is multiple nested references (`&&&str` or `&&str`). This code does not compile.\r\n\r\n<img width=\"852\" alt=\"Screen Shot 2021-12-07 at 10 46 16 AM\" src=\"https://user-images.githubusercontent.com/56137411/145006533-da8e6e2d-6254-4d5f-b9ed-755a239ef044.png\">\r\n\r\nHowever, when I use a reference pattern to dereference the closure parameter, the code compiles and works as expected:\r\n\r\n<img width=\"861\" alt=\"Screen Shot 2021-12-07 at 10 46 02 AM\" src=\"https://user-images.githubusercontent.com/56137411/145006902-880176a3-0828-47e8-89ff-1e6eb018c640.png\">\r\n\r\nI also tested this theory by trying to compile the following code and it fails with the same error:\r\n```rust\r\nlet test: Vec<&str> = vec![\r\n    \"hi\",\r\n    \"hello\",\r\n    \"mitochondria is the powerhouse of the cell\",\r\n];\r\n\r\nlet test = test\r\n    .iter()\r\n    .filter(|s| s.contains(\"h\")) // `s` has the type &&&str\r\n    .map(|s| s.to_string())  // `s` has the type &&str\r\n    .collect::<Vec<String>>();\r\n\r\nprintln!(\"Values: {:?}\", test);\r\n```\r\nNote that this error only occurs when compiling Rust with threads.\r\n\r\nYou can view the repo with the full reproduction [here](https://github.com/zackradisic/rust-emscripten-bug).\r\n\r\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/91628/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/91628/timeline", "performed_via_github_app": null, "state_reason": "completed"}