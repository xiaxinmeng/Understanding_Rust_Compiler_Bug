{"url": "https://api.github.com/repos/rust-lang/rust/issues/83490", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/83490/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/83490/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/83490/events", "html_url": "https://github.com/rust-lang/rust/issues/83490", "id": 841308146, "node_id": "MDU6SXNzdWU4NDEzMDgxNDY=", "number": 83490, "title": "Suggest taking a reference when mapping by value fails", "user": {"login": "teor2345", "id": 8951843, "node_id": "MDQ6VXNlcjg5NTE4NDM=", "avatar_url": "https://avatars.githubusercontent.com/u/8951843?v=4", "gravatar_id": "", "url": "https://api.github.com/users/teor2345", "html_url": "https://github.com/teor2345", "followers_url": "https://api.github.com/users/teor2345/followers", "following_url": "https://api.github.com/users/teor2345/following{/other_user}", "gists_url": "https://api.github.com/users/teor2345/gists{/gist_id}", "starred_url": "https://api.github.com/users/teor2345/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/teor2345/subscriptions", "organizations_url": "https://api.github.com/users/teor2345/orgs", "repos_url": "https://api.github.com/users/teor2345/repos", "events_url": "https://api.github.com/users/teor2345/events{/privacy}", "received_events_url": "https://api.github.com/users/teor2345/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 1596121013, "node_id": "MDU6TGFiZWwxNTk2MTIxMDEz", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-confusing", "name": "D-confusing", "color": "c9f7a3", "default": false, "description": "Confusing diagnostic error that should be reworked"}, {"id": 1596122811, "node_id": "MDU6TGFiZWwxNTk2MTIyODEx", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-newcomer-roadblock", "name": "D-newcomer-roadblock", "color": "c9f7a3", "default": false, "description": "Confusing diagnostic error hard to understand for new users"}, {"id": 1659943986, "node_id": "MDU6TGFiZWwxNjU5OTQzOTg2", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-verbose", "name": "D-verbose", "color": "c9f7a3", "default": false, "description": "Too much output caused by a single piece of incorrect code"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-03-25T21:06:18Z", "updated_at": "2022-12-29T05:09:33Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n\r\nIf you cannot produce a minimal reproduction case (something that would work in\r\nisolation), please provide the steps or even link to a repository that causes\r\nthe problematic output to occur. \r\n-->\r\n\r\nGiven the following code: <!-- Please provide a link to play.rust-lang.org -->\r\n\r\n```rust\r\nfn itr(list: &'_ Vec<()>) -> impl Iterator<Item = ()> + '_ {\r\n    list.iter().cloned()\r\n}\r\n\r\nfn sanitize_by_reference(s: &()) -> () {\r\n    *s\r\n}\r\n\r\nfn sanitized() -> Vec<()> {\r\n    let san = itr(&Vec::new())\r\n        // the code was originally\r\n        //.map(sanitize_by_value)\r\n        // but the function signature was changed\r\n        .map(sanitize_by_reference)\r\n        // so this simple change is required\r\n        //.map(|a| sanitize_by_reference(&a))\r\n        .collect::<Vec<_>>();\r\n    san\r\n}\r\n```\r\nhttps://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=05b4ee27c9cbff1e57b8e802bbcd9d97\r\n\r\nThe current output is:\r\n\r\n```\r\nerror[E0631]: type mismatch in function arguments\r\n  --> src/main.rs:23:14\r\n   |\r\n13 | fn sanitize_by_reference(s: &()) -> () {\r\n   | -------------------------------------- found signature of `for<'r> fn(&'r ()) -> _`\r\n...\r\n23 |         .map(sanitize_by_reference)\r\n   |              ^^^^^^^^^^^^^^^^^^^^^ expected signature of `fn(()) -> _`\r\n\r\nerror[E0599]: the method `collect` exists for struct `Map<impl Iterator, for<'r> fn(&'r ()) {sanitize_by_reference}>`, but its trait bounds were not satisfied\r\n  --> src/main.rs:26:10\r\n   |\r\n26 |           .collect::<Vec<_>>();\r\n   |            ^^^^^^^ method cannot be called on `Map<impl Iterator, for<'r> fn(&'r ()) {sanitize_by_reference}>` due to unsatisfied trait bounds\r\n   |\r\n   = note: the following trait bounds were not satisfied:\r\n           `<for<'r> fn(&'r ()) {sanitize_by_reference} as FnOnce<((),)>>::Output = _`\r\n           which is required by `Map<impl Iterator, for<'r> fn(&'r ()) {sanitize_by_reference}>: Iterator`\r\n           `for<'r> fn(&'r ()) {sanitize_by_reference}: FnMut<((),)>`\r\n           which is required by `Map<impl Iterator, for<'r> fn(&'r ()) {sanitize_by_reference}>: Iterator`\r\n           `Map<impl Iterator, for<'r> fn(&'r ()) {sanitize_by_reference}>: Iterator`\r\n           which is required by `&mut Map<impl Iterator, for<'r> fn(&'r ()) {sanitize_by_reference}>: Iterator`\r\n```\r\n\r\n<!-- The following is not always necessary. -->\r\nIdeally the output should look like:\r\n\r\n```\r\n(current output)\r\nHint: Use map(|a| sanitize_by_reference(&a))\r\n```\r\n\r\n<!--\r\nIf the problem is not self-explanatory, please provide a rationale for the\r\nchange.\r\n-->\r\n\r\nThis large, confusing error happens when a mapped function is changed to take a value by reference. The map needs to be changed to take a reference, but that's not obvious from the output.\r\n\r\nHere is the change in context, with real types and code:\r\nhttps://github.com/ZcashFoundation/zebra/pull/1942/commits/9bcfb4402257a411334e24bae16561c17a83137e\r\n\r\n<!--\r\nIf dramatically different output is caused by small changes, consider also\r\nadding them here.\r\n\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions. The output might also be\r\ndifferent depending on the Edition.\r\n-->\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/83490/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/83490/timeline", "performed_via_github_app": null, "state_reason": null}