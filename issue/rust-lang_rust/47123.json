{"url": "https://api.github.com/repos/rust-lang/rust/issues/47123", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/47123/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/47123/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/47123/events", "html_url": "https://github.com/rust-lang/rust/issues/47123", "id": 285350839, "node_id": "MDU6SXNzdWUyODUzNTA4Mzk=", "number": 47123, "title": "Wrong optimization code calling a C function.", "user": {"login": "kubo", "id": 43904, "node_id": "MDQ6VXNlcjQzOTA0", "avatar_url": "https://avatars.githubusercontent.com/u/43904?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kubo", "html_url": "https://github.com/kubo", "followers_url": "https://api.github.com/users/kubo/followers", "following_url": "https://api.github.com/users/kubo/following{/other_user}", "gists_url": "https://api.github.com/users/kubo/gists{/gist_id}", "starred_url": "https://api.github.com/users/kubo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kubo/subscriptions", "organizations_url": "https://api.github.com/users/kubo/orgs", "repos_url": "https://api.github.com/users/kubo/repos", "events_url": "https://api.github.com/users/kubo/events{/privacy}", "received_events_url": "https://api.github.com/users/kubo/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2018-01-02T03:39:43Z", "updated_at": "2018-01-02T09:47:32Z", "closed_at": "2018-01-02T05:11:56Z", "author_association": "NONE", "active_lock_reason": null, "body": "I made a program which checks the result of an external C function.\r\nIt works fine for non-optimized code. However it doesn't check the result\r\nand executes code as if the C function returns non-zero when it is optimized.\r\n\r\nI made a small program to reproduce it.\r\nIt prints \"Failure\" when it is optimized and the rust version is 1.20 or later.\r\nIt works fine with rust 1.18 and 1.19.\r\n\r\n**foo.c:**\r\n```c\r\ntypedef struct {\r\n    const char *val;\r\n    int val_len;\r\n} param;\r\n\r\nint foo_func(param *param)\r\n{\r\n    return 0;\r\n}\r\n```\r\n\r\n**foo.rs:**\r\n```rust\r\nuse std::os::raw::c_char;\r\nuse std::os::raw::c_int;\r\nuse std::ptr;\r\nuse std::slice;\r\n\r\n#[repr(C)]\r\n#[derive(Debug, Copy)]\r\npub struct Param {\r\n    pub val: *const c_char,\r\n    pub val_len: c_int,\r\n}\r\n\r\nimpl Clone for Param {\r\n    fn clone(&self) -> Self {\r\n        *self\r\n    }\r\n}\r\n\r\nimpl Default for Param {\r\n    fn default() -> Param {\r\n        Param {\r\n            val: ptr::null(),\r\n            val_len: 0,\r\n        }\r\n    }\r\n}\r\n\r\n#[link(name = \"foo\")]\r\nextern \"C\" {\r\n    pub fn foo_func(param: *mut Param) -> c_int;\r\n}\r\n\r\nfn main() {\r\n    // This issue disappears when wasteful code is removed... \r\n    let param1: Param = Default::default();\r\n    let mut param2 = param1;\r\n    if unsafe { foo_func(&mut param2) } == 0 {\r\n        let vec = unsafe { slice::from_raw_parts(param1.val as *const u8, param1.val_len as usize) };\r\n        println!(\"Success {}\", String::from_utf8_lossy(vec).into_owned());\r\n    } else {\r\n        // \"Failure\" should not be printed because foo_func() always returns zero.\r\n        println!(\"Failure\");\r\n    }\r\n}\r\n```\r\n\r\nCompile `foo.c` as a shared library as follows on Linux or macOS.\r\n```shell\r\n$ cc -shared -fPIC -o libfoo.so foo.c\r\n```\r\n\r\nWhen `foo.rs` is compiled without optimization, it prints \"Success\" as expected.\r\n```shell\r\n$ rustc -o foo-non-optimized foo.rs -L.\r\n$ ./foo-non-optimized\r\nSuccess \r\n```\r\n\r\nWhen `foo.rs` is compiled with optimization with rust 1.20 or upper, it prints \"Failure\" even though `foo_func()` always returns zero.\r\n```shell\r\n$ rustc -o foo-optimized -O foo.rs -L.\r\n$ ./foo-optimized\r\nFailure\r\n```\r\n\r\n## rust versions I used\r\n\r\n```shell\r\n$ rustc --version --verbose\r\nrustc 1.20.0 (f3d6973f4 2017-08-27)\r\nbinary: rustc\r\ncommit-hash: f3d6973f41a7d1fb83029c9c0ceaf0f5d4fd7208\r\ncommit-date: 2017-08-27\r\nhost: x86_64-apple-darwin\r\nrelease: 1.20.0\r\nLLVM version: 4.0\r\n```\r\n\r\n```shell\r\n$ rustc --version --verbose\r\nrustc 1.21.0 (3b72af97e 2017-10-09)\r\nbinary: rustc\r\ncommit-hash: 3b72af97e42989b2fe104d8edbaee123cdf7c58f\r\ncommit-date: 2017-10-09\r\nhost: x86_64-apple-darwin\r\nrelease: 1.21.0\r\nLLVM version: 4.0\r\n```\r\n\r\n```shell\r\n$ rustc --version --verbose\r\nrustc 1.22.1 (05e2e1c41 2017-11-22)\r\nbinary: rustc\r\ncommit-hash: 05e2e1c41414e8fc73d0f267ea8dab1a3eeeaa99\r\ncommit-date: 2017-11-22\r\nhost: x86_64-apple-darwin\r\nrelease: 1.22.1\r\nLLVM version: 4.0\r\n```\r\n\r\n```shell\r\n$ rustc --version --verbose\r\nrustc 1.23.0-beta.2 (c9107ee93 2017-12-08)\r\nbinary: rustc\r\ncommit-hash: c9107ee9309636ea1abc97db166c96cc5d721c1b\r\ncommit-date: 2017-12-08\r\nhost: x86_64-apple-darwin\r\nrelease: 1.23.0-beta.2\r\nLLVM version: 4.0\r\n```\r\n\r\n```shell\r\n$ rustc --version --verbose\r\nrustc 1.24.0-nightly (3f916bd30 2017-12-30)\r\nbinary: rustc\r\ncommit-hash: 3f916bd3029262e2270dfbafb9ab045927499abd\r\ncommit-date: 2017-12-30\r\nhost: x86_64-apple-darwin\r\nrelease: 1.24.0-nightly\r\nLLVM version: 4.0\r\n```\r\n", "closed_by": {"login": "retep998", "id": 666308, "node_id": "MDQ6VXNlcjY2NjMwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/666308?v=4", "gravatar_id": "", "url": "https://api.github.com/users/retep998", "html_url": "https://github.com/retep998", "followers_url": "https://api.github.com/users/retep998/followers", "following_url": "https://api.github.com/users/retep998/following{/other_user}", "gists_url": "https://api.github.com/users/retep998/gists{/gist_id}", "starred_url": "https://api.github.com/users/retep998/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/retep998/subscriptions", "organizations_url": "https://api.github.com/users/retep998/orgs", "repos_url": "https://api.github.com/users/retep998/repos", "events_url": "https://api.github.com/users/retep998/events{/privacy}", "received_events_url": "https://api.github.com/users/retep998/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/47123/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/47123/timeline", "performed_via_github_app": null, "state_reason": "completed"}