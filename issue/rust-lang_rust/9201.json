{"url": "https://api.github.com/repos/rust-lang/rust/issues/9201", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/9201/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/9201/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/9201/events", "html_url": "https://github.com/rust-lang/rust/issues/9201", "id": 19513494, "node_id": "MDU6SXNzdWUxOTUxMzQ5NA==", "number": 9201, "title": "OSX: rust runtime hangs doing tcp messaging", "user": {"login": "glycerine", "id": 445247, "node_id": "MDQ6VXNlcjQ0NTI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/445247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/glycerine", "html_url": "https://github.com/glycerine", "followers_url": "https://api.github.com/users/glycerine/followers", "following_url": "https://api.github.com/users/glycerine/following{/other_user}", "gists_url": "https://api.github.com/users/glycerine/gists{/gist_id}", "starred_url": "https://api.github.com/users/glycerine/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/glycerine/subscriptions", "organizations_url": "https://api.github.com/users/glycerine/orgs", "repos_url": "https://api.github.com/users/glycerine/repos", "events_url": "https://api.github.com/users/glycerine/events{/privacy}", "received_events_url": "https://api.github.com/users/glycerine/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 36953, "node_id": "MDU6TGFiZWwzNjk1Mw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-runtime", "name": "A-runtime", "color": "f7e101", "default": false, "description": "Area: std's runtime and \"pre-main\" init for handling backtraces, unwinds, stack overflows"}, {"id": 123111, "node_id": "MDU6TGFiZWwxMjMxMTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-macos", "name": "O-macos", "color": "6e6ec0", "default": false, "description": "Operating system: macOS"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2013-09-15T03:02:22Z", "updated_at": "2014-02-01T01:45:52Z", "closed_at": "2014-02-01T01:45:52Z", "author_association": "NONE", "active_lock_reason": null, "body": "version:\n\n```\nmacbook-pro-2:~/dev/rust-nanomsg$ rustc -v\nrustc 0.8-pre (bb35e23 2013-08-30 21:40:32 -0700)\nhost: x86_64-apple-darwin\n```\n\nNote: The test below works fine on Linux.\n\nHowever under OSX 10.6.8 and 10.8.x the following procedure reliably hangs.  This happens under nanocli, a small, easily readable, test program that uses the nanomsg library from rust. The location of the hang appears to be in calls originating from the rust runtime (see stacktrace of thread 1 below in the gdb session).\n1. preparation: install nanomsg \n\n```\ncd /tmp; git clone https://github.com/nanomsg/nanomsg;\ncd nanomsg; ./autogen.sh; ./configure; make && sudo make install\nsudo ldconfig\n```\n1. clone the rust-nanogen repo\n\n```\ncd /tmp; git clone https://github.com/glycerine/rust-nanomsg;\ncd rust-nanomsg; \n/// if necessary git checkout 5008431df8807beb860ba8728ad7f4b8bd7db216 # if it isn't the head. The test below is drawn from nanoserv.rs and nanocli.rs as of 2013 Sept 9. \nmake clean; make\n```\n1. start server\n\n```\n./nanoserv &\n```\n1. start client. Instead of finishing successfully, the client hangs after send and first receive, never getting its second receive\n\n```\n./nanocli\n```\n\n```\nmacbook-pro-2:~/dev/rust-nanomsg$ ./nanoserv &\n[1] 21774\nmacbook-pro-2:~/dev/rust-nanomsg$ server binding to '\"tcp://127.0.0.1:5555\"'\nnn_socket returned: 0i32\n\nmacbook-pro-2:~/dev/rust-nanomsg$ ./nanocli \nclient binding to '\"tcp://127.0.0.1:5555\"'\nclient: I sent 'WHY'\nserver: I received a 3 byte long msg: 'WHY'\nserver: I sent 'LUV'\nserver: 2nd send, I sent 'CAT'\n```\n\nthe client hangs. Using gdb we can see that it is waiting on a semaphore (thread 1).\n\n```\nmacbook-pro-2:~/dev/rust-nanomsg$ gdb ./nanocli\nGNU gdb (GDB) 7.6\nCopyright (C) 2013 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-apple-darwin10.8.0\".\nFor bug reporting instructions, please see:\n<http://www.gnu.org/software/gdb/bugs/>...\nReading symbols from /Users/me/dev/rust-nanomsg/nanocli...Reading symbols from /Users/me/dev/rust-nanomsg/nanocli.dSYM/Contents/Resources/DWARF/nanocli...done.\ndone.\n(gdb) run\nStarting program: /Users/me/dev/rust-nanomsg/nanocli \nclient binding to '\"tcp://127.0.0.1:5555\"'\nclient: I sent 'WHY'\n(hung; press ctrl-c)\n  C-c C-c[New Thread 0x1903 of process 21221]\n[New Thread 0x1a03 of process 21221]\n[New Thread 0x1b03 of process 21221]\n[New Thread 0x1c03 of process 21221]\n[New Thread 0x1d03 of process 21221]\n\nProgram received signal SIGINT, Interrupt.\n0x00007fff849f9a6a in __semwait_signal () from /usr/lib/libSystem.B.dylib\n(gdb) i th\n  Id   Target Id         Frame \n  6    Thread 0x1d03 of process 21221 0x00007fff849d7c0a in kevent () from /usr/lib/libSystem.B.dylib\n  5    Thread 0x1c03 of process 21221 0x00007fff849d7c0a in kevent () from /usr/lib/libSystem.B.dylib\n  4    Thread 0x1b03 of process 21221 0x00007fff84a41d62 in poll () from /usr/lib/libSystem.B.dylib\n  3    Thread 0x1a03 of process 21221 0x00007fff849bed7a in mach_msg_trap ()\n   from /usr/lib/libSystem.B.dylib\n  2    Thread 0x1903 of process 21221 0x00007fff849bed7a in mach_msg_trap ()\n   from /usr/lib/libSystem.B.dylib\n* 1    Thread 0x1703 of process 21221 0x00007fff849f9a6a in __semwait_signal ()\n   from /usr/lib/libSystem.B.dylib\n(gdb) bt\n#0  0x00007fff849f9a6a in __semwait_signal () from /usr/lib/libSystem.B.dylib\n#1  0x00007fff84a20896 in pthread_join () from /usr/lib/libSystem.B.dylib\n#2  0x0000000100602b50 in ?? ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/librustrt.dylib\n#3  0x000000010009e7a6 in rt::thread::__extensions__::meth_23418::join::_f3525925b944a51::_0$x2e8$x2dpre ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/libstd-6c65cf4b443341b1-0.8-pre.dylib\n#4  0x0000000100120b8c in rt::run_::_82e8c355ab8d949f::_0$x2e8$x2dpre ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/libstd-6c65cf4b443341b1-0.8-pre.dylib\n#5  0x00000001000d00eb in unstable::lang::start::_76d6c774aa357c7a::_0$x2e8$x2dpre ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/libstd-6c65cf4b443341b1-0.8-pre.dylib\n#6  0x000000010000db2b in main ()\n(gdb) thr 2\n[Switching to thread 2 (Thread 0x1903 of process 21221)]\n#0  0x00007fff849bed7a in mach_msg_trap () from /usr/lib/libSystem.B.dylib\n(gdb) bt\n#0  0x00007fff849bed7a in mach_msg_trap () from /usr/lib/libSystem.B.dylib\n#1  0x00007fff849bf3ed in mach_msg () from /usr/lib/libSystem.B.dylib\n#2  0x00007fff89d7a902 in ?? ()\n   from /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation\n#3  0x00007fff89d79d8f in ?? ()\n   from /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation\n#4  0x00007fff89d79b16 in ?? ()\n   from /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation\n#5  0x000000010061c793 in ?? ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/librustrt.dylib\n#6  0x000000010061aee8 in ?? ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/librustrt.dylib\n#7  0x00007fff849f7fd6 in _pthread_start () from /usr/lib/libSystem.B.dylib\n#8  0x00007fff849f7e89 in thread_start () from /usr/lib/libSystem.B.dylib\n#9  0x0000000000000000 in ?? ()\n(gdb) thr 3\n[Switching to thread 3 (Thread 0x1a03 of process 21221)]\n#0  0x00007fff849bed7a in mach_msg_trap () from /usr/lib/libSystem.B.dylib\n(gdb) bt\n#0  0x00007fff849bed7a in mach_msg_trap () from /usr/lib/libSystem.B.dylib\n#1  0x00007fff849bf3ed in mach_msg () from /usr/lib/libSystem.B.dylib\n#2  0x00007fff89d7a902 in ?? ()\n   from /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation\n#3  0x00007fff89d79d8f in ?? ()\n   from /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation\n#4  0x00007fff89d79b16 in ?? ()\n   from /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation\n#5  0x000000010061c793 in ?? ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/librustrt.dylib\n#6  0x000000010061aee8 in ?? ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/librustrt.dylib\n#7  0x00007fff849f7fd6 in _pthread_start () from /usr/lib/libSystem.B.dylib\n#8  0x00007fff849f7e89 in thread_start () from /usr/lib/libSystem.B.dylib\n#9  0x0000000000000000 in ?? ()\n(gdb) thr 4\n[Switching to thread 4 (Thread 0x1b03 of process 21221)]\n#0  0x00007fff84a41d62 in poll () from /usr/lib/libSystem.B.dylib\n(gdb) bt\n#0  0x00007fff84a41d62 in poll () from /usr/lib/libSystem.B.dylib\n#1  0x00000001005ce064 in nn_efd_wait (self=0x10136a370, timeout=-1) at efd.c:48\n#2  0x00000001005c837d in nn_sock_recv () from /usr/local/lib/libnanomsg.0.dylib\ndwarf2read.c:10350: internal-error: dwarf2_record_block_ranges: Assertion `dwarf2_per_objfile->ranges.readin' failed.\nA problem internal to GDB has been detected,\nfurther debugging may prove unreliable.\nQuit this debugging session? (y or n) n\n\ndwarf2read.c:10350: internal-error: dwarf2_record_block_ranges: Assertion `dwarf2_per_objfile->ranges.readin' failed.\nA problem internal to GDB has been detected,\nfurther debugging may prove unreliable.\nCreate a core file of GDB? (y or n) n\n#3  0x00000001005c68cc in nn_recv ()\n   from /usr/local/lib/libnanomsg.0.dylib\ndwarf2read.c:10350: internal-error: dwarf2_record_block_ranges: Assertion `dwarf2_per_objfile->ranges.readin' failed.\nA problem internal to GDB has been detected,\nfurther debugging may prove unreliable.\nQuit this debugging session? (y or n) n\n\ndwarf2read.c:10350: internal-error: dwarf2_record_block_ranges: Assertion `dwarf2_per_objfile->ranges.readin' failed.\nA problem internal to GDB has been detected,\nfurther debugging may prove unreliable.\nCreate a core file of GDB? (y or n) n\n(gdb) i th\n  Id   Target Id         Frame \n  6    Thread 0x1d03 of process 21221 0x00007fff849d7c0a in kevent () from /usr/lib/libSystem.B.dylib\n  5    Thread 0x1c03 of process 21221 0x00007fff849d7c0a in kevent () from /usr/lib/libSystem.B.dylib\n* 4    Thread 0x1b03 of process 21221 0x00007fff84a41d62 in poll () from /usr/lib/libSystem.B.dylib\n  3    Thread 0x1a03 of process 21221 0x00007fff849bed7a in mach_msg_trap ()\n   from /usr/lib/libSystem.B.dylib\n  2    Thread 0x1903 of process 21221 0x00007fff849bed7a in mach_msg_trap ()\n   from /usr/lib/libSystem.B.dylib\n  1    Thread 0x1703 of process 21221 0x00007fff849f9a6a in __semwait_signal ()\n   from /usr/lib/libSystem.B.dylib\n(gdb) thr 5\n[Switching to thread 5 (Thread 0x1c03 of process 21221)]\n#0  0x00007fff849d7c0a in kevent () from /usr/lib/libSystem.B.dylib\n(gdb) bt\n#0  0x00007fff849d7c0a in kevent () from /usr/lib/libSystem.B.dylib\n#1  0x000000010061ce73 in ?? ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/librustrt.dylib\n#2  0x000000010060ed88 in ?? ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/librustrt.dylib\n#3  0x00000001000e01b7 in rt::sched::__extensions__::meth_31118::run::_f3525925b944a51::_0$x2e8$x2dpre\n    ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/libstd-6c65cf4b443341b1-0.8-pre.dylib\n#4  0x000000010009f679 in rt::sched::__extensions__::meth_23547::bootstrap::_0d3444f63df3e14::_0$x2e8$x2dpre ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/libstd-6c65cf4b443341b1-0.8-pre.dylib\n#5  0x0000000100123334 in rt::run_::anon::expr_fn_36480 ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/libstd-6c65cf4b443341b1-0.8-pre.dylib\n#6  0x0000000100602ada in ?? ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/librustrt.dylib\n#7  0x00007fff849f7fd6 in _pthread_start () from /usr/lib/libSystem.B.dylib\n#8  0x00007fff849f7e89 in thread_start () from /usr/lib/libSystem.B.dylib\n#9  0x0000000000000000 in ?? ()\n(gdb) thr 6\n[Switching to thread 6 (Thread 0x1d03 of process 21221)]\n#0  0x00007fff849d7c0a in kevent () from /usr/lib/libSystem.B.dylib\n(gdb) bt\n#0  0x00007fff849d7c0a in kevent () from /usr/lib/libSystem.B.dylib\n#1  0x00000001005ca7ec in nn_poller_wait (self=0x1005e85a0 <self+160>, timeout=0)\n    at /usr/cn/nanomsg/src/aio/poller_kqueue.inc:172\n#2  0x00000001005cd3a4 in nn_worker_routine () from /usr/local/lib/libnanomsg.0.dylib\n#3  0x00000001005cf60d in nn_thread_main_routine () from /usr/local/lib/libnanomsg.0.dylib\n#4  0x00007fff849f7fd6 in _pthread_start () from /usr/lib/libSystem.B.dylib\n#5  0x00007fff849f7e89 in thread_start () from /usr/lib/libSystem.B.dylib\n#6  0x0000000000000000 in ?? ()\n(gdb) thr 1\n[Switching to thread 1 (Thread 0x1703 of process 21221)]\n#0  0x00007fff849f9a6a in __semwait_signal () from /usr/lib/libSystem.B.dylib\n(gdb) bt\n#0  0x00007fff849f9a6a in __semwait_signal () from /usr/lib/libSystem.B.dylib\n#1  0x00007fff84a20896 in pthread_join () from /usr/lib/libSystem.B.dylib\n#2  0x0000000100602b50 in ?? ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/librustrt.dylib\n#3  0x000000010009e7a6 in rt::thread::__extensions__::meth_23418::join::_f3525925b944a51::_0$x2e8$x2dpre ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/libstd-6c65cf4b443341b1-0.8-pre.dylib\n#4  0x0000000100120b8c in rt::run_::_82e8c355ab8d949f::_0$x2e8$x2dpre ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/libstd-6c65cf4b443341b1-0.8-pre.dylib\n#5  0x00000001000d00eb in unstable::lang::start::_76d6c774aa357c7a::_0$x2e8$x2dpre ()\n   from /Users/me/dev/rust-nanomsg/../../../../usr/local/lib/rustc/x86_64-apple-darwin/lib/libstd-6c65cf4b443341b1-0.8-pre.dylib\n#6  0x000000010000db2b in main ()\n(gdb) \n\n```\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/9201/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/9201/timeline", "performed_via_github_app": null, "state_reason": "completed"}