{"url": "https://api.github.com/repos/rust-lang/rust/issues/77495", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/77495/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/77495/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/77495/events", "html_url": "https://github.com/rust-lang/rust/issues/77495", "id": 714123399, "node_id": "MDU6SXNzdWU3MTQxMjMzOTk=", "number": 77495, "title": "rustc 1.46 takes 30+ minutes to recompile repo which used to recompile in 15 seconds under 1.45 (regression)", "user": {"login": "fschutt", "id": 12084016, "node_id": "MDQ6VXNlcjEyMDg0MDE2", "avatar_url": "https://avatars.githubusercontent.com/u/12084016?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fschutt", "html_url": "https://github.com/fschutt", "followers_url": "https://api.github.com/users/fschutt/followers", "following_url": "https://api.github.com/users/fschutt/following{/other_user}", "gists_url": "https://api.github.com/users/fschutt/gists{/gist_id}", "starred_url": "https://api.github.com/users/fschutt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fschutt/subscriptions", "organizations_url": "https://api.github.com/users/fschutt/orgs", "repos_url": "https://api.github.com/users/fschutt/repos", "events_url": "https://api.github.com/users/fschutt/events{/privacy}", "received_events_url": "https://api.github.com/users/fschutt/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2020-10-03T16:18:43Z", "updated_at": "2020-10-03T17:17:17Z", "closed_at": "2020-10-03T17:17:17Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I have a repository (a simple actix-web server) that isn't compiling anymore, because the compiler takes way too long (about 30 minutes) to *recompile* the crate. The repo re-compiles fine in about 30 seconds on 1.45-stable, but on 1.46-stable and nightly it takes 30+ minutes. I've cloned my repository as it is now: https://github.com/fschutt/example-actix-site\r\n\r\nTo compile it, just do `cargo build` (the server won't run, but it should build). A few days ago, this exact repo compiled in about about 3 - 5 minutes from scratch and it took about 15 - 30 *seconds* to rebuild. After upgrading the compiler to 1.46 or nightly, it builds very very slowly and when I run it with `-Ztimings` cargo simply sigkills rustc because it's taking too long. When running without `-Ztimings`, it does build, but it takes 30+ minutes to do so.\r\n\r\nToday, I tested that the bug happens both on the latest stable version and the latest nightly version (2020-10-03), and verified that the bug happens on both Windows and Linux. I also verified that it **doesn't happen** on 1.45.0-stable.\r\n\r\n### Meta\r\n\r\nSucceeded on 1.45.0-stable:\r\n\r\n```\r\nrustc 1.45.0 (5c1f21c3b 2020-07-13)\r\nbinary: rustc\r\ncommit-hash: 5c1f21c3b82297671ad3ae1e8c942d2ca92e84f2\r\ncommit-date: 2020-07-13\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.45.0\r\nLLVM version: 10.0\r\n```\r\n\r\nFailed on Windows (nightly 1.48 + 1.46), Linux (nightly 1.48 + 1.46)\r\n\r\n```\r\nrustc 1.48.0-nightly (8876ffc92 2020-10-02)\r\nbinary: rustc\r\ncommit-hash: 8876ffc9235dade728e1fbc4be4c85415fdd0bcd\r\ncommit-date: 2020-10-02\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.48.0-nightly\r\nLLVM version: 11.0\r\n```\r\n\r\n**Notice the difference in the LLVM version**, possibly related to https://github.com/rust-lang/rust/issues/66617?\r\n\r\n\"Include a backtrace\" - yeah that's the funny part, there is no backtrace because rustc gets a `9 SIGKILL` because of a timeout. Sadly I don't have a backtrace.\r\n\r\nThe log I can perceive is this:\r\n\r\n```\r\n$ rustup update nightly && rustup default nightly && cargo clean && RUST_BACKTRACE=full RUSTFLAGS=\"-Ztime-passes\" cargo build > out.txt\r\n\r\ninfo: syncing channel updates for 'nightly-x86_64-unknown-linux-gnu'\r\n\r\n  nightly-x86_64-unknown-linux-gnu unchanged - rustc 1.48.0-nightly (8876ffc92 2020-10-02)\r\n\r\ninfo: checking for self-updates\r\ninfo: using existing install for 'nightly-x86_64-unknown-linux-gnu'\r\ninfo: default toolchain set to 'nightly-x86_64-unknown-linux-gnu'\r\n\r\n  nightly-x86_64-unknown-linux-gnu unchanged - rustc 1.48.0-nightly (8876ffc92 2020-10-02)\r\n\r\n   Compiling cfg-if v0.1.10\r\n   Compiling libc v0.2.77\r\n   Compiling autocfg v1.0.1\r\n   Compiling proc-macro2 v1.0.23\r\n   Completed cfg-if v0.1.10 in 0.1s\r\n   Compiling unicode-xid v0.2.1\r\n   Completed unicode-xid v0.2.1 in 0.3s\r\n\r\n   [...]\r\n\r\n   Completed ghash v0.3.0 in 0.3s\r\n   Completed thiserror v1.0.20 in 0.3s\r\n   Compiling time-macros v0.1.1\r\n   Completed time-macros v0.1.1 in 0.1s\r\n   Compiling actix-threadpool v0.3.3\r\n   Completed actix-threadpool v0.3.3 in 0.6s\r\n   Completed v_escape v0.13.1 in 0.2s\r\n   Completed rustls v0.18.1 in 23.0s\r\n   Compiling postgres-protocol v0.5.2\r\n   Completed tokio v0.2.22 in 21.3s\r\n\r\n   [...]\r\n\r\n   Compiling actix-session v0.4.0\r\n   Compiling actix-files v0.3.0\r\n   Completed actix-session v0.4.0 in 1.8s\r\n   Completed actix-web v3.0.2 in 9.5s\r\n   Completed actix-files v0.3.0 in 3.0s\r\n   Compiling m4p v0.1.0 (/home/felix/Development/m4p)\r\n\r\n      Timing report saved to /home/felix/Development/m4p/cargo-timing-20201003T102224Z.html\r\n\r\nerror: could not compile `m4p`\r\n\r\nCaused by:\r\n  process didn't exit successfully: `\r\n  rustc --crate-name m4p --edition=2018 src/main.rs --error-format=json\r\n  --json=diagnostic-rendered-ansi,artifacts --crate-type bin\r\n  --emit=dep-info,link -C embed-bitcode=no -C debuginfo=2\r\n  -C metadata=22a9b879b2ed1adc -C extra-filename=-22a9b879b2ed1adc\r\n  --out-dir /home/felix/Development/m4p/target/debug/deps\r\n  -C incremental=/home/felix/Development/m4p/target/debug/incremental\r\n  -L dependency=/home/felix/Development/m4p/target/debug/deps\r\n\r\n  --extern actix_files=/home/felix/Development/m4p/target/debug/deps/libactix_files-e695f67b73f99e5b.rlib\r\n  --extern actix_session=/home/felix/Development/m4p/target/debug/deps/libactix_session-d585b86d2d2e4a82.rlib\r\n  --extern actix_web=/home/felix/Development/m4p/target/debug/deps/libactix_web-2a43995a0412168a.rlib\r\n  --extern chrono=/home/felix/Development/m4p/target/debug/deps/libchrono-deca12871bfa1e40.rlib\r\n  --extern config=/home/felix/Development/m4p/target/debug/deps/libconfig-f558148ed440ebf8.rlib\r\n  --extern cookie=/home/felix/Development/m4p/target/debug/deps/libcookie-40ab7b95923920cb.rlib\r\n  --extern deadpool_postgres=/home/felix/Development/m4p/target/debug/deps/libdeadpool_postgres-bec85540a48b26fa.rlib\r\n   --extern dotenv=/home/felix/Development/m4p/target/debug/deps/libdotenv-ef265213814e1891.rlib\r\n   --extern fast_chemail=/home/felix/Development/m4p/target/debug/deps/libfast_chemail-620b93603bf123c6.rlib\r\n   --extern image=/home/felix/Development/m4p/target/debug/deps/libimage-940aee2557418a77.rlib\r\n   --extern lettre=/home/felix/Development/m4p/target/debug/deps/liblettre-a4b24a82b7bb7002.rlib\r\n   --extern mime=/home/felix/Development/m4p/target/debug/deps/libmime-8080671c8b888b7d.rlib\r\n   --extern printpdf=/home/felix/Development/m4p/target/debug/deps/libprintpdf-19cadf9472f95c5e.rlib\r\n   --extern rustls=/home/felix/Development/m4p/target/debug/deps/librustls-4c397a67d9bbc694.rlib\r\n   --extern serde=/home/felix/Development/m4p/target/debug/deps/libserde-ef931f378a4039d7.rlib\r\n   --extern serde_json=/home/felix/Development/m4p/target/debug/deps/libserde_json-7020026d8a38b1d1.rlib\r\n   --extern sodiumoxide=/home/felix/Development/m4p/target/debug/deps/libsodiumoxide-8eb0b011062484de.rlib\r\n   --extern tokio_pg_mapper=/home/felix/Development/m4p/target/debug/deps/libtokio_pg_mapper-d59273eae2d9cbce.rlib\r\n   --extern tokio_pg_mapper_derive=/home/felix/Development/m4p/target/debug/deps/libtokio_pg_mapper_derive-762f0b80a1a448d4.so\r\n   --extern tokio_postgres=/home/felix/Development/m4p/target/debug/deps/libtokio_postgres-546f30c79cce20b7.rlib\r\n   --extern uuid=/home/felix/Development/m4p/target/debug/deps/libuuid-233c1738ad97210e.rlib\r\n\r\n   -Ztime-passes\r\n   -L native=/home/felix/Development/m4p/target/debug/build/ring-3974b5df818fe7df/out\r\n   -L native=/home/felix/Development/m4p/target/debug/build/brotli-sys-4f3bb85a6c6e368e/out\r\n   -L native=/home/felix/Development/m4p/target/debug/build/libsodium-sys-934800f85608c6c7/out/installed/lib` (signal: 9, SIGKILL: kill)\r\n\r\nCommand exited with non-zero status 101\r\n1808.10user 93.40system 18:31.18elapsed 171%CPU (0avgtext+0avgdata 2598412maxresident)k\r\n4701904inputs+4178376outputs (41769major+19941245minor)pagefaults 0swaps\r\n```\r\n\r\nWhen I open the `out.txt` to look at the time passes, it just ends with this:\r\n\r\n```\r\ntime: 0.000; rss: 511MB\tlayout_testing\r\ntime: 0.011; rss: 512MB\tdeath_checking\r\ntime: 0.003; rss: 512MB\tunused_lib_feature_checking\r\ntime: 0.049; rss: 514MB\tcrate_lints\r\ntime: 0.025; rss: 515MB\tmodule_lints\r\ntime: 0.074; rss: 515MB\tlint_checking\r\ntime: 0.065; rss: 515MB\tprivacy_checking_modules\r\ntime: 0.188; rss: 515MB\tmisc_checking_3\r\ntime: 0.006; rss: 516MB\tmonomorphization_collector_root_collections\r\n```\r\n... and then it times out and crashes. I don't get a backtrace, I don't know which pass the compiler is actually hanging in, all I know so far is that it's only happening when putting the final binary together. I've attached the timing reports in the zip file. For now I can work with the 1.45.0 compiler, but it would be great if this would be fixed.\r\n\r\n[timing.zip](https://github.com/rust-lang/rust/files/5321964/timing.zip)", "closed_by": {"login": "fschutt", "id": 12084016, "node_id": "MDQ6VXNlcjEyMDg0MDE2", "avatar_url": "https://avatars.githubusercontent.com/u/12084016?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fschutt", "html_url": "https://github.com/fschutt", "followers_url": "https://api.github.com/users/fschutt/followers", "following_url": "https://api.github.com/users/fschutt/following{/other_user}", "gists_url": "https://api.github.com/users/fschutt/gists{/gist_id}", "starred_url": "https://api.github.com/users/fschutt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fschutt/subscriptions", "organizations_url": "https://api.github.com/users/fschutt/orgs", "repos_url": "https://api.github.com/users/fschutt/repos", "events_url": "https://api.github.com/users/fschutt/events{/privacy}", "received_events_url": "https://api.github.com/users/fschutt/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/77495/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/77495/timeline", "performed_via_github_app": null, "state_reason": "completed"}