{"url": "https://api.github.com/repos/rust-lang/rust/issues/7235", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/7235/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/7235/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/7235/events", "html_url": "https://github.com/rust-lang/rust/issues/7235", "id": 15759780, "node_id": "MDU6SXNzdWUxNTc1OTc4MA==", "number": 7235, "title": "Remove the trailing null from strings", "user": {"login": "erickt", "id": 84711, "node_id": "MDQ6VXNlcjg0NzEx", "avatar_url": "https://avatars.githubusercontent.com/u/84711?v=4", "gravatar_id": "", "url": "https://api.github.com/users/erickt", "html_url": "https://github.com/erickt", "followers_url": "https://api.github.com/users/erickt/followers", "following_url": "https://api.github.com/users/erickt/following{/other_user}", "gists_url": "https://api.github.com/users/erickt/gists{/gist_id}", "starred_url": "https://api.github.com/users/erickt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/erickt/subscriptions", "organizations_url": "https://api.github.com/users/erickt/orgs", "repos_url": "https://api.github.com/users/erickt/repos", "events_url": "https://api.github.com/users/erickt/events{/privacy}", "received_events_url": "https://api.github.com/users/erickt/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37234, "node_id": "MDU6TGFiZWwzNzIzNA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-cleanup", "name": "C-cleanup", "color": "f5f1fd", "default": false, "description": "Category: PRs that clean code up or issues documenting cleanup."}, {"id": 45472092, "node_id": "MDU6TGFiZWw0NTQ3MjA5Mg==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-ffi", "name": "A-ffi", "color": "f7e101", "default": false, "description": "Area: Foreign Function Interface (FFI)"}, {"id": 46311113, "node_id": "MDU6TGFiZWw0NjMxMTExMw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-unicode", "name": "A-unicode", "color": "f7e101", "default": false, "description": "Area: unicode related"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 14, "created_at": "2013-06-19T18:15:31Z", "updated_at": "2014-06-16T21:56:24Z", "closed_at": "2013-08-10T08:14:16Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "It is unsafe to convert every `&[u8]` into a `&str`, because `&str`s need to have a valid byte after the end of the characters. This means that this pattern:\n\n```\nlet v = &['a' as u8, 'b' as u8, 'c' as u8];\nlet s = str::from_bytes_slice(v);\nstr::as_c_str(s, |ptr| call_c_function(ptr));\n```\n\nis unsafe because `str::as_c_str` dereferences the next byte past the end of the slice. This is safe when working with a `~str` as a `&str`, because it has the trailing null. To do this safely, you need to copy the bytes:\n\n```\nlet v = &['a' as u8, 'b' as u8, 'c' as u8];\nlet s = str::from_bytes(v);\nstr::as_c_str(s, |ptr| call_c_function(ptr));\n```\n\nWhile we could work around this by marking `from_bytes_slice` as unsafe and documenting this unsafe behavior, it would be simplest to just remove the trailing null from strings and allow the end user to add the trailing null if they want it. `.as_c_str()` can still take the fast path if the string is null terminated, or allocate a temporary string otherwise.\n\nSome comments from the IRC discussion:\n\n@graydon suggests renaming `.as_c_str()` to `.as_null_terminated_c_str()`\n\n@cmr suggested `.as_null_terminated_str()`\n\n@bstrie suggested `.null_terminate()`\n\n@kimundi mentioned a `.as_c_str()` that takes a `&mut ~str`, adds a NULL, calls the closure, then removes the NULL before exiting.\n\ncc: #6869\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/7235/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/7235/timeline", "performed_via_github_app": null, "state_reason": "completed"}