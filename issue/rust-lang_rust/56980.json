{"url": "https://api.github.com/repos/rust-lang/rust/issues/56980", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/56980/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/56980/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/56980/events", "html_url": "https://github.com/rust-lang/rust/issues/56980", "id": 392579128, "node_id": "MDU6SXNzdWUzOTI1NzkxMjg=", "number": 56980, "title": "RLS memory usage regression", "user": {"login": "alexheretic", "id": 2331607, "node_id": "MDQ6VXNlcjIzMzE2MDc=", "avatar_url": "https://avatars.githubusercontent.com/u/2331607?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexheretic", "html_url": "https://github.com/alexheretic", "followers_url": "https://api.github.com/users/alexheretic/followers", "following_url": "https://api.github.com/users/alexheretic/following{/other_user}", "gists_url": "https://api.github.com/users/alexheretic/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexheretic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexheretic/subscriptions", "organizations_url": "https://api.github.com/users/alexheretic/orgs", "repos_url": "https://api.github.com/users/alexheretic/repos", "events_url": "https://api.github.com/users/alexheretic/events{/privacy}", "received_events_url": "https://api.github.com/users/alexheretic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 602425123, "node_id": "MDU6TGFiZWw2MDI0MjUxMjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-dev-tools", "name": "T-dev-tools", "color": "bfd4f2", "default": false, "description": "Relevant to the dev-tools subteam, which will review and decide on the PR/issue."}, {"id": 630799571, "node_id": "MDU6TGFiZWw2MzA3OTk1NzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compilemem", "name": "I-compilemem", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to memory usage during compilation."}, {"id": 632925329, "node_id": "MDU6TGFiZWw2MzI5MjUzMjk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-rls", "name": "A-rls", "color": "f7e101", "default": false, "description": "Area: Rust Language Server (RLS)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 24, "created_at": "2018-12-19T12:28:52Z", "updated_at": "2022-10-23T07:01:49Z", "closed_at": "2022-10-23T07:01:49Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "I've noticed RLS is consuming **much** more memory with all projects on Linux. My tests indicate this is not an issue with RLS itself.\r\n\r\nDownstream: https://github.com/rust-lang/rls/issues/1188\r\n\r\n## Reproduction\r\nOriginally I produced the regression with stable vs nightly. \r\n\r\nMemory usage running `rls --cli`. Reading taken after running once until built, quitting and re-running again and waiting for build complete.\r\n\r\n| Project | Linux nightly-2018-12-14 | Linux stable 1.31 |\r\n|---|---|---|\r\n| cargo init --bin  |  80 MiB | 25 MiB |\r\n| rust-random/rand | 500 MiB | 45 MiB |\r\n| rust-lang/regex | 1.5 GiB  | 81 MiB |\r\n\r\n\r\n## Release introduction\r\nTrying to narrow down the regression I found it appeared in `nightly-2018-11-06` by bisecting nightly channel rls releases.\r\n\r\nTesting as above with the regex crate:\r\n* `rustup run nightly-2018-11-03 rls --cli` -> 100 MiB\r\n* _nightly-2018-11-04, nightly-2018-11-05 rls is not available_\r\n* `rustup run nightly-2018-11-06 rls --cli` -> **1.5 GiB**\r\n\r\n## Eliminating RLS source\r\nTo rule out RLS itself, I took current RLS code `173be7729ae9ea41303fbd84f339f76554c9d9af`,\r\n\r\n<details><summary><i>plus a small fix for older compilers</i></summary>\r\n<p>\r\n\r\n```\r\ndiff --git src/build/rustc.rs src/build/rustc.rs\r\nindex be3c52c..9ebc925 100644\r\n--- src/build/rustc.rs\r\n+++ src/build/rustc.rs\r\n@@ -301,6 +301,7 @@ impl<'a> CompilerCalls<'a> for RlsRustcCalls {\r\n                 edition: match state.session.edition() {\r\n                     RustcEdition::Edition2015 => Edition::Edition2015,\r\n                     RustcEdition::Edition2018 => Edition::Edition2018,\r\n+                    _ => panic!(),\r\n                 },\r\n             };\r\n             let files = fetch_input_files(state.session);\r\n```\r\n\r\n</p>\r\n</details>\r\n<br/>\r\n\r\nAgain testing as above with the regex crate _(plus the RLS source checked out next door)_:\r\n* `rustup run nightly-2018-11-03 cargo run --manifest-path ../rls/Cargo.toml --no-default-features --release -- --cli` -> 100 MiB\r\n* `rustup run nightly-2018-11-06 cargo run --manifest-path ../rls/Cargo.toml --no-default-features --release -- --cli` -> **1.6 GiB**\r\n\r\n\r\n## Status\r\n_Tests use regex `d4b9419` on Arch Linux_\r\n\r\n### 2019-03-10\r\n| Release | Idle memory usage |\r\n|---|---|\r\n| 1.31.1  |  62 MB |\r\n| 1.32.0 | 1.6 GB |\r\n| 1.33.0 | 800 MB |\r\n\r\n### Update 2019-07-04\r\n| Release | Idle memory usage |\r\n|---|---|\r\n| 1.34.2 | 740 MB |\r\n| 1.35.0 | 1.3 GB |\r\n| 1.36.0 | 1.0 GB |\r\n\r\n### Update 2019-08-16\r\n| Release | Idle memory usage |\r\n|---|---|\r\n| 1.31.1 | 83 MB |\r\n| 1.37.0 | 2.4 GB |", "closed_by": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/56980/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/56980/timeline", "performed_via_github_app": null, "state_reason": "not_planned"}