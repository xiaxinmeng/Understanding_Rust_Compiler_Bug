{"url": "https://api.github.com/repos/rust-lang/rust/issues/93166", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/93166/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/93166/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/93166/events", "html_url": "https://github.com/rust-lang/rust/issues/93166", "id": 1110735402, "node_id": "I_kwDOAAsO6M5CNHoq", "number": 93166, "title": "Undefined reference error when building on aarch64 architecture with address sanitizer enabled", "user": {"login": "marmeladema", "id": 1629419, "node_id": "MDQ6VXNlcjE2Mjk0MTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1629419?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marmeladema", "html_url": "https://github.com/marmeladema", "followers_url": "https://api.github.com/users/marmeladema/followers", "following_url": "https://api.github.com/users/marmeladema/following{/other_user}", "gists_url": "https://api.github.com/users/marmeladema/gists{/gist_id}", "starred_url": "https://api.github.com/users/marmeladema/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marmeladema/subscriptions", "organizations_url": "https://api.github.com/users/marmeladema/orgs", "repos_url": "https://api.github.com/users/marmeladema/repos", "events_url": "https://api.github.com/users/marmeladema/events{/privacy}", "received_events_url": "https://api.github.com/users/marmeladema/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-01-21T17:47:03Z", "updated_at": "2022-01-21T17:47:03Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nThe project is closed source but when upgrading from rust 1.57.0 to rust 1.58.0, I encountered build failure with address sanitizer enabled on native aarch64 architecture using the follow RUSTFLAGS env variable:\r\n```\r\nRUSTFLAGS=\"-Zsanitizer=address -Csymbol-mangling-version=v0\"\r\n```\r\n\r\nand the following cargo command:\r\n\r\n```\r\ncargo test -Zbuild-std -Ztimings --target $(arch)-unknown-linux-gnu --release --locked\r\n```\r\n\r\nI expected to see this happen: the project build successfully\r\n\r\nInstead, this happened: a bunch of weird undefined symbol errors like\r\n```\r\n= note: /usr/bin/ld: /var/lib/cargo/target/aarch64-unknown-linux-gnu/release/deps/segments_rpc-3f0b579b639a6019.std-cec2ce27c1d4a978.std.3f2a3861-cgu.13.rcgu.o.rcgu.o: in function `_RINvNtNtCscmLdO7Nx2xx_4core4sync6atomic10atomic_subjECsfotvtIokYKH_3std':\r\n/home/builder/.rustup/toolchains/nightly-2022-01-20-aarch64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/sync/atomic.rs:2412: undefined reference to `__aarch64_ldadd8_rel'\r\n/usr/bin/ld: /var/lib/cargo/target/aarch64-unknown-linux-gnu/release/deps/segments_rpc-3f0b579b639a6019.std-cec2ce27c1d4a978.std.3f2a3861-cgu.15.rcgu.o.rcgu.o: in function `_RINvNtNtCscmLdO7Nx2xx_4core4sync6atomic10atomic_subjECsfotvtIokYKH_3std':\r\n/home/builder/.rustup/toolchains/nightly-2022-01-20-aarch64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/sync/atomic.rs:2412: undefined reference to `__aarch64_ldadd8_rel'\r\n/usr/bin/ld: /home/builder/.rustup/toolchains/nightly-2022-01-20-aarch64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/sync/atomic.rs:2412: undefined reference to `__aarch64_ldadd8_rel'\r\n/usr/bin/ld: /home/builder/.rustup/toolchains/nightly-2022-01-20-aarch64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/sync/atomic.rs:2412: undefined reference to `__aarch64_ldadd8_rel'\r\n/usr/bin/ld: /home/builder/.rustup/toolchains/nightly-2022-01-20-aarch64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/sync/atomic.rs:2412: undefined reference to `__aarch64_ldadd8_rel'\r\n/usr/bin/ld: /var/lib/cargo/target/aarch64-unknown-linux-gnu/release/deps/segments_rpc-3f0b579b639a6019.std-cec2ce27c1d4a978.std.3f2a3861-cgu.15.rcgu.o.rcgu.o:/home/builder/.rustup/toolchains/nightly-2022-01-20-aarch64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/sync/atomic.rs:2412: more undefined references to `__aarch64_ldadd8_rel' follow\r\n/usr/bin/ld: /var/lib/cargo/target/aarch64-unknown-linux-gnu/release/deps/segments_rpc-3f0b579b639a6019.std-cec2ce27c1d4a978.std.3f2a3861-cgu.15.rcgu.o.rcgu.o: in function `_RINvNtNtCscmLdO7Nx2xx_4core4sync6atomic11atomic_swaphECsfotvtIokYKH_3std':\r\n/home/builder/.rustup/toolchains/nightly-2022-01-20-aarch64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/sync/atomic.rs:2383: undefined reference to `__aarch64_swp1_acq_rel'\r\n/usr/bin/ld: /var/lib/cargo/target/aarch64-unknown-linux-gnu/release/deps/segments_rpc-3f0b579b639a6019.std-cec2ce27c1d4a978.std.3f2a3861-cgu.15.rcgu.o.rcgu.o: in function `_RINvNtNtCscmLdO7Nx2xx_4core4sync6atomic10atomic_addjECsfotvtIokYKH_3std':\r\n/home/builder/.rustup/toolchains/nightly-2022-01-20-aarch64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/sync/atomic.rs:2398: undefined reference to `__aarch64_ldadd8_relax'\r\n/usr/bin/ld: /var/lib/cargo/target/aarch64-unknown-linux-gnu/release/deps/segments_rpc-3f0b579b639a6019.std-cec2ce27c1d4a978.std.3f2a3861-cgu.15.rcgu.o.rcgu.o: in function `_RINvNtNtCscmLdO7Nx2xx_4core4sync6atomic10atomic_subjECsfotvtIokYKH_3std':\r\n/home/builder/.rustup/toolchains/nightly-2022-01-20-aarch64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/sync/atomic.rs:2414: undefined reference to `__aarch64_ldadd8_relax'\r\n```\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\n$ rustc --version --verbose\r\nrustc 1.58.1 (db9d1b20b 2022-01-20)\r\nbinary: rustc\r\ncommit-hash: db9d1b20bba1968c1ec1fc49616d4742c1725b4b\r\ncommit-date: 2022-01-20\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.58.1\r\nLLVM version: 13.0.0\r\n```\r\n\r\n### Workaround\r\n\r\nAdding `-Ctarget-feature=-outline-atomics` to the RUSTFLAGS environment variable to disable the `outline-atomics` aarch64 target feature circumvents the issue.\r\n\r\nAdditionally, the problem happens on Debian Buster but not on Debian Bullseye with the exact same rust binary installed through rustup.\r\n\r\nNo idea if that's related but we do compile some C and C++ code as part of some `build.rs` files using the cc crate and clang-12 as compiler that gets linked with the project.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/93166/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/93166/timeline", "performed_via_github_app": null, "state_reason": null}