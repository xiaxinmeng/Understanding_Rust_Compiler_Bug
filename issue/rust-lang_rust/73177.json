{"url": "https://api.github.com/repos/rust-lang/cargo/issues/8394", "repository_url": "https://api.github.com/repos/rust-lang/cargo", "labels_url": "https://api.github.com/repos/rust-lang/cargo/issues/8394/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/cargo/issues/8394/comments", "events_url": "https://api.github.com/repos/rust-lang/cargo/issues/8394/events", "html_url": "https://github.com/rust-lang/cargo/issues/8394", "id": 642650980, "node_id": "MDU6SXNzdWU2NDI2NTA5ODA=", "number": 8394, "title": "Optional features not respected with external registry", "user": {"login": "LukeMauldin", "id": 1440808, "node_id": "MDQ6VXNlcjE0NDA4MDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1440808?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LukeMauldin", "html_url": "https://github.com/LukeMauldin", "followers_url": "https://api.github.com/users/LukeMauldin/followers", "following_url": "https://api.github.com/users/LukeMauldin/following{/other_user}", "gists_url": "https://api.github.com/users/LukeMauldin/gists{/gist_id}", "starred_url": "https://api.github.com/users/LukeMauldin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LukeMauldin/subscriptions", "organizations_url": "https://api.github.com/users/LukeMauldin/orgs", "repos_url": "https://api.github.com/users/LukeMauldin/repos", "events_url": "https://api.github.com/users/LukeMauldin/events{/privacy}", "received_events_url": "https://api.github.com/users/LukeMauldin/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2020-06-09T19:22:45Z", "updated_at": "2020-06-22T01:05:34Z", "closed_at": "2020-06-22T01:05:34Z", "author_association": "NONE", "active_lock_reason": null, "body": "I am trying to use a crate that depends on `trust-dns-proto` which has tokio listed as an optional dependency: https://github.com/bluejekyll/trust-dns/blob/0.19.4/crates/proto/Cargo.toml#L77 `\r\ntokio = { version = \"0.2.16\", optional = true }`\r\n\r\nWhen compiling a simple test project with the Cargo.toml file below, it works as expected as long as I am using the standard Rust crates.io registry.  However, when I try to use an external file system registry created by https://github.com/ChrisGreenaway/cargo-local-registry I receive a compile error. \r\nError example:\r\n```\r\nerror[E0433]: failed to resolve: use of undeclared type or module `tokio`\r\n  --> /home/mauldinl@gvl.is.l-3com.com/.cargo/registry/src/-7c1c43276983337d/trust-dns-proto-0.19.4/src/lib.rs:25:5\r\n   |\r\n25 | use tokio::runtime::Runtime;\r\n   |     ^^^^^ use of undeclared type or module `tokio`\r\n```\r\n\r\nI ran the `cargo tree` command and have attached the two output files.  As you can see, the `tree_output_cratesio.txt` file listed the `tokio` crate as a dependency of `trust-dns-proto` while the `tree_output_external_reg.txt` file does not list the `tokio` crate.  I have tried multiple variations in my `Cargo.toml` file to make sure the `tokio-runtime`  feature is selected and from what I can tell, it is being selected since the line of code that imports the `tokio::runtime::Runtime` line is being executed but for some reason when using an external registry the optional tokio package is not being added in.\r\nI have used the external registry for several months and use other crates that have optional dependencies on other crates like `serde`, etc.. and those work as expected.  I am not sure why I am seeing this behavior. \r\n\r\n### Meta\r\n`rustc --version --verbose`:\r\nrustc 1.44.0 (49cae5576 2020-06-01)\r\nbinary: rustc\r\ncommit-hash: 49cae55760da0a43428eba73abcb659bb70cf2e4\r\ncommit-date: 2020-06-01\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.44.0\r\nLLVM version: 9.0\r\n\r\nCargo.toml example:\r\n```\r\n[package]\r\nname = \"tester\"\r\nversion = \"0.1.0\"\r\nedition = \"2018\"\r\n\r\n[dependencies]\r\ntokio = {version = \"0.2.21\", features = [\"full\"]}\r\ntrust-dns-proto = {version = \"=0.19.4\", default-features = false, features = [\"tokio-runtime\"]}\r\n```\r\n\r\n[tree_output_cratesio.txt](https://github.com/rust-lang/rust/files/4754352/tree_output_cratesio.txt)\r\n[tree_output_external_reg.txt](https://github.com/rust-lang/rust/files/4754353/tree_output_external_reg.txt)", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/cargo/issues/8394/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/cargo/issues/8394/timeline", "performed_via_github_app": null, "state_reason": "completed"}