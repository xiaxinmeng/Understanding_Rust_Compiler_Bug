{"url": "https://api.github.com/repos/rust-lang/rust/issues/98809", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/98809/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/98809/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/98809/events", "html_url": "https://github.com/rust-lang/rust/issues/98809", "id": 1292048801, "node_id": "I_kwDOAAsO6M5NAxmh", "number": 98809, "title": "`align_offset` seems to generate worse code than is desirable (unless `size_of::<T>() == 1`)", "user": {"login": "thomcc", "id": 860665, "node_id": "MDQ6VXNlcjg2MDY2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/860665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thomcc", "html_url": "https://github.com/thomcc", "followers_url": "https://api.github.com/users/thomcc/followers", "following_url": "https://api.github.com/users/thomcc/following{/other_user}", "gists_url": "https://api.github.com/users/thomcc/gists{/gist_id}", "starred_url": "https://api.github.com/users/thomcc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thomcc/subscriptions", "organizations_url": "https://api.github.com/users/thomcc/orgs", "repos_url": "https://api.github.com/users/thomcc/repos", "events_url": "https://api.github.com/users/thomcc/events{/privacy}", "received_events_url": "https://api.github.com/users/thomcc/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}, {"id": 2242906716, "node_id": "MDU6TGFiZWwyMjQyOTA2NzE2", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-raw-pointers", "name": "A-raw-pointers", "color": "f7e101", "default": false, "description": "Area: raw pointers, MaybeUninit, NonNull"}], "state": "closed", "locked": false, "assignee": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2022-07-02T12:45:32Z", "updated_at": "2022-07-17T02:41:37Z", "closed_at": "2022-07-17T02:09:08Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "There are many examples where `align_offset` produces worse code than it should (worse than you'd write by hand, at the very least, and in the case of slices, worse then I think it needs to). You can often work around this by going through a `*const u8` pointer, although this is surprising, and not always an option (for example, it is not an option for users of `align_to`).\n\nHere's a minimal example extracted from some real code but massaged somewhat: https://rust.godbolt.org/z/aq8Yo8oYj. For posterity, the generated code here currently is:\n\n```\nexample::simd_align1:\n        mov     eax, edi\n        and     eax, 12\n        mov     ecx, edi\n        shr     ecx, 2\n        neg     ecx\n        and     ecx, 3\n        test    rax, rax\n        cmove   rcx, rax\n        lea     rax, [rdi + 4*rcx]\n        ret\n\nexample::simd_align2:\n        lea     rax, [rdi + 15]\n        and     rax, -16\n        ret\n```\n\n(And `simd_align1` here is actually better than I was getting in my real code, where it ended up as a branch. That said, this is bad enough to demonstrate the problem).\n\nI guess this is because `align_offset` gets passed a `*const T` which itself may not be aligned to `T` (for example, `(1 as *const f32).align_offset(16)` can't be satisfied). That problem is avoided by going through u8 (as is done with `simd_align2`), since that should always succeed (for non-const which isn't relevant here), and hits the `stride == 1` special case added to fix https://github.com/rust-lang/rust/issues/75579).\n\nHowever, in *this* case the compiler should know that the pointer is aligned to 4, since it comes from a slice (and the pointer does end up with `align(4)` in the LLVM). I *think* this means there's no actual reason that `simd_align1` must be less efficient than `simd_align2` (unless I'm missing something), and the issue is just that our `align_offset` impl doesn't have a fast path for this situation. That said, maybe I'm wrong, and the generated code is bad for some other reason.\n\nEither way, it would be very nice for this to do better for the slice use case -- as I mentioned, going through `*const u8` is not viable when `align_offset` is invoked from an API like `align_to` (I suspect if we can't fix it for `align_offset`, we probably could work around it in `align_to` more directly, but it would be better to do it in `align_offset` if possible. That said, if I'm wrong about why this is happening, all bets are certainly off).\n\nSee also https://github.com/rust-lang/rust/issues/72356, which seems related (and my hunch is that it will be fixed if we fix this issue, at least in this case).\n\nCC @nagisa, since [you asked](https://github.com/rust-lang/rust/blob/aedf78e56b2279cc869962feac5153b6ba7001ed/library/core/src/ptr/mod.rs#L1591).\n\nP.S. Sorry that this is a bit of a rambling issue.\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"nagisa\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/98809/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/98809/timeline", "performed_via_github_app": null, "state_reason": "completed"}