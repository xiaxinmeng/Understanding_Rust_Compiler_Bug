{"url": "https://api.github.com/repos/rust-lang/rust/issues/73370", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/73370/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/73370/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/73370/events", "html_url": "https://github.com/rust-lang/rust/issues/73370", "id": 638797646, "node_id": "MDU6SXNzdWU2Mzg3OTc2NDY=", "number": 73370, "title": "linking error: unknown agrument `-no-pie`", "user": {"login": "xMAC94x", "id": 5282251, "node_id": "MDQ6VXNlcjUyODIyNTE=", "avatar_url": "https://avatars.githubusercontent.com/u/5282251?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xMAC94x", "html_url": "https://github.com/xMAC94x", "followers_url": "https://api.github.com/users/xMAC94x/followers", "following_url": "https://api.github.com/users/xMAC94x/following{/other_user}", "gists_url": "https://api.github.com/users/xMAC94x/gists{/gist_id}", "starred_url": "https://api.github.com/users/xMAC94x/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xMAC94x/subscriptions", "organizations_url": "https://api.github.com/users/xMAC94x/orgs", "repos_url": "https://api.github.com/users/xMAC94x/repos", "events_url": "https://api.github.com/users/xMAC94x/events{/privacy}", "received_events_url": "https://api.github.com/users/xMAC94x/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 147085028, "node_id": "MDU6TGFiZWwxNDcwODUwMjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-nightly", "name": "regression-from-stable-to-nightly", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to nightly."}, {"id": 203429200, "node_id": "MDU6TGFiZWwyMDM0MjkyMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-high", "name": "P-high", "color": "eb6420", "default": false, "description": "High priority"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2020-06-15T12:04:16Z", "updated_at": "2020-06-23T07:52:24Z", "closed_at": "2020-06-18T07:52:15Z", "author_association": "NONE", "active_lock_reason": null, "body": "# SUMMARY:\r\n - between `\u01f9ightly-2020-04-17` and `nightly-2020-06-10` linking behavior changes which broke my cross compilation from linux to macos. It now adds the `-no-pie` which is unknown by my compiler.\r\nleaving it out would probably fix the error. Below are detailed informations about my project and the cross compilation setup in order to reproduce.\r\n\r\n### Error message:\r\n```rustc\r\nerror: linking with `/dockercache/osxcross/target/bin/x86_64-apple-darwin17-clang` failed: exit code: 1\r\n  |\r\n  = note: \"/dockercache/osxcross/target/bin/x86_64-apple-darwin17-clang\" \"-m64\" \"-L\" \"/root/.rustup/toolchains/nightly-2020-06-10-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-apple-darwin/lib\" \"/dockercache/veloren/target/x86_64-apple-darwin/release/deps/veloren_server_cli-78b52b471002ffce.veloren_server_cli.dfwsp804-cgu.2.rcgu.o\" \"-o\" \"/dockercache/veloren/target/x86_64-apple-darwin/release/deps/veloren_server_cli-78b52b471002ffce\" \"-Wl,-dead_strip\" \"-no-pie\" \"-nodefaultlibs\" \"-L\" \"/dockercache/veloren/target/x86_64-apple-darwin/release/deps\" \"-L\" \"/dockercache/veloren/target/release/deps\" \"-L\" \"/dockercache/veloren/target/x86_64-apple-darwin/release/build/ring-c41ee91963e5ddb3/out\" \"-L\" \"/dockercache/veloren/target/x86_64-apple-darwin/release/build/libsqlite3-sys-136b28bf48384b6d/out\" \"-L\" \"/root/.rustup/toolchains/nightly-2020-06-10-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-apple-darwin/lib\" \"/tmp/rustcv9Gt5M/liblibsqlite3_sys-ceadf642235a6fee.rlib\" \"/tmp/rustcv9Gt5M/libring-d0f7bae75ed6ea2a.rlib\" \"/tmp/rustcv9Gt5M/libbacktrace_sys-767e350fd8547e78.rlib\" \"/root/.rustup/toolchains/nightly-2020-06-10-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-apple-darwin/lib/libcompiler_builtins-57149daefc485a08.rlib\" \"-framework\" \"Security\" \"-framework\" \"Security\" \"-framework\" \"CoreServices\" \"-framework\" \"CoreServices\" \"-lSystem\" \"-lresolv\" \"-lc\" \"-lm\"\r\n  = note: clang: error: unknown argument: '-no-pie'\r\n          \r\nerror: aborting due to previous error\r\n```\r\n\r\n## I tried this code:\r\nWe for the veloren project we have a CI docker container. i tried to update the toolchain.\r\nwith docker the error is reproduceable quite easy, however if you are familar with docker you can skip some steps in order to save you a hour of compilation\r\n\r\n```bash\r\ngit clone https://gitlab.com/veloren/veloren-docker-ci/\r\ncd veloren-docker-ci\r\ncd base\r\n# modify Dockerfile and change the RUST_TOOLCHAIN argument in line 3 to `nightly-2020-06-10` \r\n#   or similar, it also breaks with 06-05. 06-10 is only taken because of \r\n#   https://rust-lang.github.io/rustup-components-history/\r\nnano Dockerfile\r\n#Wait for BASE IMAGE TO BUILD\r\ntime docker build -t registry.gitlab.com/veloren/veloren-docker-ci:base --no-cache .;\r\n# It will build just fine. It just generate a docker image to build veloren and it's macos cross compiltion\r\n# Now we will see that the compilation will fail, start the container\r\ndocker run -it <id here, some hex number> bash\r\n#inside the docker container setup the project:\r\nexport RUST_TOOLCHAIN=nightly-2020-06-10;\r\nexport PROJECTNAME=veloren;\r\ncd /dockercache; \\\r\n    mkdir /dockercache/cache-all; \\\r\n    mkdir /dockercache/cache-release-linux; \\\r\n    mkdir /dockercache/cache-release-windows; \\\r\n    mkdir /dockercache/cache-release-macos; \\\r\n    mkdir /dockercache/cache-tarpaulin; \\\r\n    git lfs clone \"https://gitlab.com/veloren/${PROJECTNAME}.git\"; \\\r\n    cd \"/dockercache/${PROJECTNAME}\"; \\\r\n    git lfs install; \\\r\n    git lfs fetch --recent; \\\r\n    git checkout master; \\\r\n    git lfs pull; \\\r\n    sleep 10; \\\r\n    echo ${RUST_TOOLCHAIN} > ./rust-toolchain; \\\r\n    . /root/.cargo/env; \\\r\n\r\n    ln -s /dockercache/cache-release-macos /dockercache/veloren/target; \\\r\n    VELOREN_ASSETS=assets PATH=\"/dockercache/osxcross/target/bin:$PATH\" COREAUDIO_SDK_PATH=/dockercache/osxcross/target/SDK/MacOSX10.13.sdk CC=o64-clang CXX=o64-clang++ cargo build --target=x86_64-apple-darwin --release; \\\r\n# the last command will fail with the error above.\r\n# IF you would try this with old `2020-04-17` toolchain it wouldn't fail.\r\n```\r\nI expected to see this happen:\r\n - we successfully build the osxcross enviorment with the first docker container, based on this: https://wapl.es/rust/2019/02/17/rust-cross-compile-linux-to-macos.html\r\n - the code compiles for macos\r\n - after compilation it starts linking using the '/dockercache/osxcross/target/bin/x86_64-apple-darwin17-clang' linker we build in osxcross\r\n - the linking suceeds\r\n\r\nInstead, this happened: \r\n - the linking fails as it tries to use a `-no-pie` flag which isn't supported. Interestingly when you search in the rust code for this flag, you'll find a refactor about a month ago changing `no-pie` behavior here: https://github.com/rust-lang/rust/commit/96a466c3128945627c2f81ec13b8ae98be7c3749. however i personally dont know how that caused the change.\r\n\r\n\r\n### Meta\r\n`rustc --version --verbose`:\r\n```bash\r\nroot@ddc242b44794:/dockercache/veloren# rustc --version --verbose\r\nrustc 1.46.0-nightly (feb3536eb 2020-06-09)\r\nbinary: rustc\r\ncommit-hash: feb3536eba10c2e4585d066629598f03d5ddc7c6\r\ncommit-date: 2020-06-09\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.46.0-nightly\r\nLLVM version: 10.0\r\n```\r\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/73370/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/73370/timeline", "performed_via_github_app": null, "state_reason": "completed"}