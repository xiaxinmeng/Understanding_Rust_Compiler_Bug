{"url": "https://api.github.com/repos/rust-lang/rust/issues/65987", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/65987/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/65987/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/65987/events", "html_url": "https://github.com/rust-lang/rust/issues/65987", "id": 515072293, "node_id": "MDU6SXNzdWU1MTUwNzIyOTM=", "number": 65987, "title": "Rust produces invalid Wasm global variables", "user": {"login": "PiotrSikora", "id": 190297, "node_id": "MDQ6VXNlcjE5MDI5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/190297?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PiotrSikora", "html_url": "https://github.com/PiotrSikora", "followers_url": "https://api.github.com/users/PiotrSikora/followers", "following_url": "https://api.github.com/users/PiotrSikora/following{/other_user}", "gists_url": "https://api.github.com/users/PiotrSikora/gists{/gist_id}", "starred_url": "https://api.github.com/users/PiotrSikora/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PiotrSikora/subscriptions", "organizations_url": "https://api.github.com/users/PiotrSikora/orgs", "repos_url": "https://api.github.com/users/PiotrSikora/repos", "events_url": "https://api.github.com/users/PiotrSikora/events{/privacy}", "received_events_url": "https://api.github.com/users/PiotrSikora/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 474645165, "node_id": "MDU6TGFiZWw0NzQ2NDUxNjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-wasm", "name": "O-wasm", "color": "6e6ec0", "default": false, "description": "Target: WASM (WebAssembly), http://webassembly.org/"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2019-10-31T00:40:41Z", "updated_at": "2019-12-16T22:20:44Z", "closed_at": "2019-12-16T22:20:43Z", "author_association": "NONE", "active_lock_reason": null, "body": "It looks that Rust is producing WebAssembly Global variables which value is the offset in the linear memory to where the value of the Global variable is stored, instead of the value itself.\r\n\r\nFrom my chat with @jakobkummerow, it seem that this is invalid behavior, since Global variables can be stored outside of the linear memory, so it looks that Rust is not adhering to the spec.\r\n```\r\n$ cat test_rust.rs\r\n```\r\n```\r\n#[no_mangle]\r\npub static TEST: u32 = 0xAABBCCDD;\r\n```\r\n```\r\n$ rustc -C link-arg=-S --crate-type cdylib --target wasm32-unknown-unknown test_rust.rs\r\n```\r\n```\r\n$ wasm-objdump -x test_rust.wasm \r\n```\r\n```\r\ntest_rust.wasm: file format wasm 0x1\r\n\r\nSection Details:\r\n\r\nTable[1]:\r\n - table[0] type=funcref initial=1 max=1\r\nMemory[1]:\r\n - memory[0] pages: initial=17\r\nGlobal[4]:\r\n - global[0] i32 mutable=1 - init i32=1048576\r\n - global[1] i32 mutable=0 <__data_end> - init i32=1048580\r\n - global[2] i32 mutable=0 <__heap_base> - init i32=1048580\r\n - global[3] i32 mutable=0 <TEST> - init i32=1048576\r\nExport[4]:\r\n - memory[0] -> \"memory\"\r\n - global[1] -> \"__data_end\"\r\n - global[2] -> \"__heap_base\"\r\n - global[3] -> \"TEST\"\r\nData[1]:\r\n - segment[0] size=4 - init i32=1048576\r\n  - 0100000: ddcc bbaa                                ....\r\nCustom:\r\n - name: \"producers\"\r\n```\r\nIn the above example, Global variable `TEST` has the value `1048576`, which is not the value of the variable in the source code, but an offset in the linear memory that contains `0xAABBCCDD`.\r\n\r\nPlease note that both `__data_end` and `__heap_base` Global variables contain the value, and not the offset in the linear memory, so this behavior is inconsistent.", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/65987/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/65987/timeline", "performed_via_github_app": null, "state_reason": "completed"}