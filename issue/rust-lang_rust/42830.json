{"url": "https://api.github.com/repos/rust-lang/rust/issues/42830", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/42830/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/42830/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/42830/events", "html_url": "https://github.com/rust-lang/rust/issues/42830", "id": 237938626, "node_id": "MDU6SXNzdWUyMzc5Mzg2MjY=", "number": 42830, "title": "[rustbuild] cannot link to `printf` with MSVC on AppVeyor", "user": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 266005765, "node_id": "MDU6TGFiZWwyNjYwMDU3NjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows-msvc", "name": "O-windows-msvc", "color": "6e6ec0", "default": false, "description": "Toolchain: MSVC, Operating system: Windows"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2017-06-22T18:48:57Z", "updated_at": "2017-06-22T20:16:54Z", "closed_at": "2017-06-22T19:54:15Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Spun off from https://github.com/rust-lang/rust/pull/42777#issuecomment-310455372. The test case for error code E0060 contains an invocation to the C function `printf`. On MSVC, performing doctest on this test case failed with \r\n\r\n```\r\n  = note: rust_out.0.o : error LNK2019: unresolved external symbol printf referenced in function _ZN8rust_out4main17ha22022d8940e3e88E\r\n```\r\n\r\nCurrently I'm checking if there is any missing linker args should be added to make the pass without `#[cfg]`ing it out.\r\n\r\n----\r\n\r\n<details><summary>Minimal test case</summary>\r\n\r\nCode (copy of E0060), see https://github.com/kennytm/test-term-coloring/tree/43a23596b\r\n\r\n``````rust\r\n/**\r\n```\r\n# use std::os::raw::{c_char, c_int};\r\n# extern \"C\" { fn printf(_: *const c_char, ...) -> c_int; }\r\nunsafe {\r\n    use std::ffi::CString;\r\n    let fmt = CString::new(\"test\\n\").unwrap();\r\n    printf(fmt.as_ptr());\r\n    let fmt = CString::new(\"number = %d\\n\").unwrap();\r\n    printf(fmt.as_ptr(), 3);\r\n    let fmt = CString::new(\"%d, %d\\n\").unwrap();\r\n    printf(fmt.as_ptr(), 10, 5);\r\n}\r\n```\r\n*/\r\npub fn wut() {}\r\n``````\r\n\r\nTest result, see https://ci.appveyor.com/project/kennytm/test-term-coloring/build/1.0.2\r\n\r\n``````\r\n   Doc-tests test-term-coloring\r\nrunning 1 test\r\nerror: linking with `link.exe` failed: exit code: 1120\r\n  |\r\n  = note: \"C:\\\\Program Files (x86)\\\\Microsoft Visual Studio 14.0\\\\VC\\\\bin\\\\amd64\\\\link.exe\" \"/NOLOGO\" \"/NXCOMPAT\" \"/LIBPATH:C:\\\\Users\\\\appveyor\\\\.rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"C:\\\\Users\\\\appveyor\\\\AppData\\\\Local\\\\Temp\\\\1\\\\rustdoctest.xIdH18C27InS\\\\rust_out.0.o\" \"/OUT:C:\\\\Users\\\\appveyor\\\\AppData\\\\Local\\\\Temp\\\\1\\\\rustdoctest.xIdH18C27InS\\\\rust_out.exe\" \"/OPT:REF,NOICF\" \"/DEBUG\" \"/LIBPATH:C:\\\\projects\\\\test-term-coloring\\\\target\\\\x86_64-pc-windows-msvc\\\\debug\\\\deps\" \"/LIBPATH:C:\\\\Users\\\\appveyor\\\\.rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"/LIBPATH:C:\\\\Users\\\\appveyor\\\\.rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"std-7c926edf41e020d3.dll.lib\" \"C:\\\\Users\\\\appveyor\\\\.rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libcompiler_builtins-ce3e1312c7c980ee.rlib\" \"advapi32.lib\" \"ws2_32.lib\" \"userenv.lib\" \"shell32.lib\" \"msvcrt.lib\"\r\n  = note: rust_out.0.o : error LNK2019: unresolved external symbol printf referenced in function _ZN8rust_out4main17ha22022d8940e3e88E\r\n          C:\\Users\\appveyor\\AppData\\Local\\Temp\\1\\rustdoctest.xIdH18C27InS\\rust_out.exe : fatal error LNK1120: 1 unresolved externals\r\n          \r\nerror: aborting due to previous error(s)\r\nthread 'rustc' panicked at 'Box<Any>', src\\librustc_errors\\lib.rs:512\r\nnote: Run with `RUST_BACKTRACE=1` for a backtrace.\r\nthread 'rustc' panicked at 'couldn't compile the test', src\\librustdoc\\test.rs:278\r\ntest src\\lib.rs - wut (line 1) ... FAILED\r\nfailures:\r\nfailures:\r\n    src\\lib.rs - wut (line 1)\r\ntest result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out\r\n``````\r\n\r\n</details>", "closed_by": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/42830/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/42830/timeline", "performed_via_github_app": null, "state_reason": "completed"}