{"url": "https://api.github.com/repos/rust-lang/rust/issues/67782", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/67782/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/67782/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/67782/events", "html_url": "https://github.com/rust-lang/rust/issues/67782", "id": 544389469, "node_id": "MDU6SXNzdWU1NDQzODk0Njk=", "number": 67782, "title": "Internal compiler error: building dynamic library is unsupported on Emscripten", "user": {"login": "kubkon", "id": 1519747, "node_id": "MDQ6VXNlcjE1MTk3NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/1519747?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kubkon", "html_url": "https://github.com/kubkon", "followers_url": "https://api.github.com/users/kubkon/followers", "following_url": "https://api.github.com/users/kubkon/following{/other_user}", "gists_url": "https://api.github.com/users/kubkon/gists{/gist_id}", "starred_url": "https://api.github.com/users/kubkon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kubkon/subscriptions", "organizations_url": "https://api.github.com/users/kubkon/orgs", "repos_url": "https://api.github.com/users/kubkon/repos", "events_url": "https://api.github.com/users/kubkon/events{/privacy}", "received_events_url": "https://api.github.com/users/kubkon/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 474645165, "node_id": "MDU6TGFiZWw0NzQ2NDUxNjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-wasm", "name": "O-wasm", "color": "6e6ec0", "default": false, "description": "Target: WASM (WebAssembly), http://webassembly.org/"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2020-01-01T19:18:20Z", "updated_at": "2020-07-17T15:45:34Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Apologies if this is a duplicate, but I couldn't find a similar issue. Anyhow, the issue appears to be caused when trying to build for `wasm32-unknown-emscripten` target and including a lib crate with `crate-type = [\"rlib\", \"staticlib\", \"cdylib\"]` causes the following compiler panic:\r\n\r\n```\r\nthread 'rustc' panicked at 'src/librustc_codegen_ssa/back/linker.rs:878: building dynamic library is unsupported on Emscripten', src/librustc/util/bug.rs:37:26\r\nstack backtrace:\r\n   0:        0x1082d6c55 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::h9462d4b5888539ab\r\n   1:        0x10830a510 - core::fmt::write::hfc4799bb5f5713e1\r\n   2:        0x1082c977b - std::io::Write::write_fmt::h688ebb99d695121f\r\n   3:        0x1082db053 - std::panicking::default_hook::{{closure}}::h46807e40cc5c9ec9\r\n   4:        0x1082dad5a - std::panicking::default_hook::hfa3fa9913244654c\r\n   5:        0x1025301e2 - rustc_driver::report_ice::h37932e7c4f1fba7f\r\n   6:        0x1082db84c - std::panicking::rust_panic_with_hook::hb7e09606b75e30c0\r\n   7:        0x105974ec5 - std::panicking::begin_panic::hcf494bfc97f475ef\r\n   8:        0x105a61c3c - rustc::util::bug::opt_span_bug_fmt::{{closure}}::h826c2d7833f6f58e\r\n   9:        0x105a503ba - rustc::ty::context::tls::with_opt::{{closure}}::h50671f3cc14a88db\r\n  10:        0x105a5036c - rustc::ty::context::tls::with_opt::ha2373df8753b454e\r\n  11:        0x105a61b68 - rustc::util::bug::opt_span_bug_fmt::h894addd94d24f6bd\r\n  12:        0x105a61abb - rustc::util::bug::bug_fmt::he4d8ec493683828c\r\n  13:        0x10501fa7d - <rustc_codegen_ssa::back::linker::EmLinker as rustc_codegen_ssa::back::linker::Linker>::build_dylib::hd75fbf4112e25780\r\n  14:        0x102753c1e - rustc_codegen_ssa::back::link::link_natively::h710fa9b0482dda87\r\n  15:        0x102751ed2 - rustc_codegen_ssa::back::link::link_binary::h40e7f85745f8fa06\r\n  16:        0x1028a20d7 - <rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_utils::codegen_backend::CodegenBackend>::join_codegen_and_link::{{closure}}::h48ab3e569fa83cb0\r\n  17:        0x102898d37 - rustc::util::common::time::h0fa921a50246e4dc\r\n  18:        0x10284d7ce - <rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_utils::codegen_backend::CodegenBackend>::join_codegen_and_link::hff6da34c9bbbb753\r\n  19:        0x102679dcd - rustc_interface::queries::Linker::link::h892d2dbb5d6c10b7\r\n  20:        0x10250011c - rustc_interface::interface::run_compiler_in_existing_thread_pool::ha1b7eef4d8bad1d7\r\n  21:        0x1024d1479 - scoped_tls::ScopedKey<T>::set::he6a052ea9f345ec5\r\n  22:        0x10254c415 - syntax::with_globals::h445b4296ae442554\r\n  23:        0x1024d83cd - std::sys_common::backtrace::__rust_begin_short_backtrace::he6da9f1213f05905\r\n  24:        0x1082eb00f - __rust_maybe_catch_panic\r\n  25:        0x1024e4bc7 - core::ops::function::FnOnce::call_once{{vtable.shim}}::h62a536cce0774879\r\n  26:        0x1082bb66e - <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once::h88795daf010cbf80\r\n  27:        0x1082e9f9e - std::sys::unix::thread::Thread::new::thread_start::h731ad860c1aa479e\r\n  28:     0x7fff63737e65 - _pthread_start\r\n\r\nerror: internal compiler error: unexpected panic\r\n```\r\n\r\nAfter further investigation, removing the `cdylib` from `crate-type` removes the error.\r\n\r\nThe weird thing is that this issue only seems to appear when building the main crate with `cargo rustc` instead of `cargo build` (the reason here involved passing in additional compiler flags). Also, the issue seems to concern all toolchains: 1.40.0-stable, 1.41.0-beta and 1.42.0-nightly.\r\n\r\nAnyhow, the error can be replicated by running a [`build.sh` script] in [wasmtime/crates/wasi-common/js-polyfill] crate. For reference, the PR introducing this bit of functionality into `wasmtime` is bytecodealliance/wasmtime#720.\r\n\r\n[`build.sh` script]: https://github.com/kubkon/wasmtime/blob/js-poly/crates/wasi-common/js-polyfill/build.sh\r\n[wasmtime/crates/wasi-common/js-polyfill]: https://github.com/kubkon/wasmtime/tree/js-poly/crates/wasi-common/js-polyfill", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/67782/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/67782/timeline", "performed_via_github_app": null, "state_reason": null}