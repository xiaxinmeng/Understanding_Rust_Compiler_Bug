{"url": "https://api.github.com/repos/rust-lang/rust/issues/86125", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/86125/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/86125/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/86125/events", "html_url": "https://github.com/rust-lang/rust/issues/86125", "id": 914141487, "node_id": "MDU6SXNzdWU5MTQxNDE0ODc=", "number": 86125, "title": "Windows linker error when importing a crate that has external symbols", "user": {"login": "radu-matei", "id": 13103165, "node_id": "MDQ6VXNlcjEzMTAzMTY1", "avatar_url": "https://avatars.githubusercontent.com/u/13103165?v=4", "gravatar_id": "", "url": "https://api.github.com/users/radu-matei", "html_url": "https://github.com/radu-matei", "followers_url": "https://api.github.com/users/radu-matei/followers", "following_url": "https://api.github.com/users/radu-matei/following{/other_user}", "gists_url": "https://api.github.com/users/radu-matei/gists{/gist_id}", "starred_url": "https://api.github.com/users/radu-matei/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/radu-matei/subscriptions", "organizations_url": "https://api.github.com/users/radu-matei/orgs", "repos_url": "https://api.github.com/users/radu-matei/repos", "events_url": "https://api.github.com/users/radu-matei/events{/privacy}", "received_events_url": "https://api.github.com/users/radu-matei/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2021-06-08T01:40:02Z", "updated_at": "2021-06-09T13:47:56Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "When importing a crate that has external symbols, but only actually calling functions that do not use any externals, Linux compilation is successful, while Windows fails (both MSVC and GNU).\r\n\r\nRepository for repro: https://github.com/radu-matei/rust-windows-linker-external-symbols-issue\r\n\r\nI have the following crate that exports two functions: one which uses external symbols, one which doesn't.\r\n\r\n```rust\r\n// crate_with_external_symbols\r\n\r\npub fn test_not_using_extern() {}\r\n\r\npub fn abc() {\r\n    let _ = unsafe { foo(1, 2) };\r\n}\r\n\r\nextern \"C\" {\r\n    fn foo(x: i32, y: i32) -> i32;\r\n}\r\n```\r\n\r\nThen, taking the crate as a dependency in another binary, and using the function that does not import any external symbols:\r\n\r\n```rust\r\nuse crate_with_external_symbols::test_not_using_extern;\r\n\r\nfn main() {\r\n    test_not_using_extern();\r\n    println!(\"Hello, world!\");\r\n}\r\n```\r\n\r\nOn Linux (and IIRC on macOS as well), everything works fine, the program compiles and runs properly, given that the external symbols from the crate are not actually called at any point in the program.\r\n\r\nOn Windows, however, this fails to compile (regardless of building incrementally or not, which is why I suspect this is not a duplicate of #45929), resulting in a linker error using both the MSVC and the GNU toolchains (see backtrace below for the full log):\r\n\r\n```\r\n# MSVC\r\nerror LNK2019: unresolved external symbol foo referenced in function _ZN27crate_with_external_symbols3abc17hfc584f18839f815eE\r\n\r\n# GNU\r\nundefined reference to `foo'\r\n```\r\n\r\nNote: this is not a duplicate of #45929, which only fails for incremental builds, nor is it a duplicate of #71720, which only happens when using LTO.\r\n\r\n\r\n\r\n### Meta\r\n\r\n```\r\n\u279c rustc --version --verbose\r\nrustc 1.52.1 (9bc8c42bb 2021-05-09)\r\nbinary: rustc\r\ncommit-hash: 9bc8c42bb2f19e745a63f3445f1ac248fb015e53\r\ncommit-date: 2021-05-09\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.52.1\r\nLLVM version: 12.0.0\r\n```\r\n\r\n\r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```\r\n\u279c cargo build --release\r\n   Compiling rust-windows-linker-external-symbols-issue v0.1.0 (Z:\\home\\radu\\projects\\src\\github.com\\misc\\rust-windows-linker-external-symbols-issue)\r\nerror: linking with `link.exe` failed: exit code: 1120\r\n  |\r\n  = note: \"D:\\\\VS\\\\VS19\\\\VC\\\\Tools\\\\MSVC\\\\14.29.30037\\\\bin\\\\HostX64\\\\x64\\\\link.exe\" \"/NOLOGO\" \"/NXCOMPAT\" \"/LIBPATH:C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"Z:\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\\\\rust_windows_linker_external_symbols_issue.rust_windows_linker_external_symbols_issue.8qm5rhon-cgu.0.rcgu.o\" \"Z:\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\\\\rust_windows_linker_external_symbols_issue.rust_windows_linker_external_symbols_issue.8qm5rhon-cgu.1.rcgu.o\" \"Z:\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\\\\rust_windows_linker_external_symbols_issue.rust_windows_linker_external_symbols_issue.8qm5rhon-cgu.2.rcgu.o\" \"/OUT:Z:\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\\\\rust_windows_linker_external_symbols_issue.exe\" \"Z:\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\\\\rust_windows_linker_external_symbols_issue.4wa3aibiqoh6uxwt.rcgu.o\" \"/OPT:REF,ICF\" \"/DEBUG\" \"/NATVIS:C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\etc\\\\intrinsic.natvis\" \"/NATVIS:C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\etc\\\\liballoc.natvis\" \"/NATVIS:C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\etc\\\\libcore.natvis\" \"/NATVIS:C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\etc\\\\libstd.natvis\" \"/LIBPATH:Z:\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\" \"/LIBPATH:C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"\\\\\\\\wsl$\\\\Ubuntu-20.04\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\\\\libcrate_with_external_symbols-1dff5dd8370c4e1e.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libstd-68b25ab3829cbbae.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libpanic_unwind-dd86b2a9657509c7.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\librustc_demangle-a32547dedd895cf6.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libhashbrown-2d29ef3bbf523eaa.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\librustc_std_workspace_alloc-2a226fea424b96ba.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libunwind-e28afa8739a1fa1c.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libcfg_if-5e97a47829d8661c.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\liblibc-c7a4b246b1481113.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\liballoc-2b5ec6322b49dd45.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\librustc_std_workspace_core-c1df47dd61fa6cd5.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libcore-3cedc7817d8eb468.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libcompiler_builtins-c115f0a110b00510.rlib\" \"advapi32.lib\" \"ws2_32.lib\" \"userenv.lib\" \"msvcrt.lib\"\r\n\r\n  = note: libcrate_with_external_symbols-1dff5dd8370c4e1e.rlib(crate_with_external_symbols-1dff5dd8370c4e1e.crate_with_external_symbols.759muw3a-cgu.0.rcgu.o) : \r\nerror LNK2019: unresolved external symbol foo referenced in function _ZN27crate_with_external_symbols3abc17hfc584f18839f815eE\r\n\r\n          Z:\\home\\radu\\projects\\src\\github.com\\misc\\rust-windows-linker-external-symbols-issue\\target\\release\\deps\\rust_windows_linker_external_symbols_issue.exe : \r\nfatal error LNK1120: 1 unresolved externals\r\n\r\n\r\n\r\n# building with the GNU toolchain results in the same error:\r\n\r\n\u279c cargo +stable-x86_64-pc-windows-gnu build --release\r\n   Compiling crate-with-external-symbols v0.1.0 (Z:\\home\\radu\\projects\\src\\github.com\\misc\\rust-windows-linker-external-symbols-issue\\crate\\crate-with-external-symbols)\r\n   Compiling rust-windows-linker-external-symbols-issue v0.1.0 (Z:\\home\\radu\\projects\\src\\github.com\\misc\\rust-windows-linker-external-symbols-issue)\r\nerror: linking with `x86_64-w64-mingw32-gcc` failed: exit code: 1\r\n  |\r\n  = note: \"x86_64-w64-mingw32-gcc\" \"-fno-use-linker-plugin\" \"-Wl,--nxcompat\" \"-Wl,--dynamicbase\" \"-Wl,--disable-auto-image-base\" \"-m64\" \"-Wl,--high-entropy-va\" \"-nostartfiles\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\self-contained\\\\crt2.o\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\rsbegin.o\" \"-L\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\" \"-L\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\self-contained\" \"Z:\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\\\\rust_windows_linker_external_symbols_issue-7411ee82aa505e47.rust_windows_linker_external_symbols_issue.2hciqv4d-cgu.0.rcgu.o\" \"Z:\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\\\\rust_windows_linker_external_symbols_issue-7411ee82aa505e47.rust_windows_linker_external_symbols_issue.2hciqv4d-cgu.1.rcgu.o\" \"Z:\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\\\\rust_windows_linker_external_symbols_issue-7411ee82aa505e47.rust_windows_linker_external_symbols_issue.2hciqv4d-cgu.2.rcgu.o\" \"-o\" \"Z:\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\\\\rust_windows_linker_external_symbols_issue-7411ee82aa505e47.exe\" \"Z:\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\\\\rust_windows_linker_external_symbols_issue-7411ee82aa505e47.2jhj2xj0mxvtzlcl.rcgu.o\" \"-Wl,--gc-sections\" \"-nodefaultlibs\" \"-L\" \"Z:\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\" \"-L\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\" \"-Wl,-Bstatic\" \"\\\\\\\\wsl$\\\\Ubuntu-20.04\\\\home\\\\radu\\\\projects\\\\src\\\\github.com\\\\misc\\\\rust-windows-linker-external-symbols-issue\\\\target\\\\release\\\\deps\\\\libcrate_with_external_symbols-e8b2ecdf14825a14.rlib\" \"-Wl,--start-group\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\libstd-5c720e8db4b99e37.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\libpanic_unwind-29283164da786e03.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\libobject-1776be3a32adbb49.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\libaddr2line-0892c1b32ffa2c4d.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\libgimli-517a95b0a57b9e8e.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\librustc_demangle-82d48d88ac13ce1c.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\libhashbrown-37de12e440fa77bc.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\librustc_std_workspace_alloc-7549ba16005c4b88.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\libunwind-b131f4022158fa79.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\libcfg_if-bfa5ff0422f13358.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\liblibc-454b6cdb3888a4db.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\liballoc-90ee5fe37d1109a4.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\librustc_std_workspace_core-f5802464b35b87c4.rlib\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\libcore-7ca46f1af2cdfb26.rlib\" \"-Wl,--end-group\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\libcompiler_builtins-13d041c714b5c5f4.rlib\" \"-Wl,-Bdynamic\" \"-ladvapi32\" \"-lws2_32\" \"-luserenv\" \"-lgcc_eh\" \"-l:libpthread.a\" \"-lmsvcrt\" \"-lmingwex\" \"-lmingw32\" \"-lgcc\" \"-lmsvcrt\" \"-luser32\" \"-lkernel32\" \"C:\\\\Users\\\\root\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-gnu\\\\lib\\\\rustlib\\\\x86_64-pc-windows-gnu\\\\lib\\\\rsend.o\"\r\n  \r\n= note: \\\\wsl$\\Ubuntu-20.04\\home\\radu\\projects\\src\\github.com\\misc\\rust-windows-linker-external-symbols-issue\\target\\release\\deps\\libcrate_with_external_symbols-e8b2ecdf14825a14.rlib(crate_with_external_symbols-e8b2ecdf14825a14.crate_with_external_symbols.etkck3m3-cgu.0.rcgu.o):crate_with_externa:(.text+0x1b): \r\n\r\nundefined reference to `foo'\r\n```\r\n\r\n</p>\r\n</details>\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/86125/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/86125/timeline", "performed_via_github_app": null, "state_reason": null}