{"url": "https://api.github.com/repos/rust-lang/rust/issues/78125", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/78125/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/78125/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/78125/events", "html_url": "https://github.com/rust-lang/rust/issues/78125", "id": 725117190, "node_id": "MDU6SXNzdWU3MjUxMTcxOTA=", "number": 78125, "title": "Severe memory leak in Rustc", "user": {"login": "Davester47", "id": 59511328, "node_id": "MDQ6VXNlcjU5NTExMzI4", "avatar_url": "https://avatars.githubusercontent.com/u/59511328?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Davester47", "html_url": "https://github.com/Davester47", "followers_url": "https://api.github.com/users/Davester47/followers", "following_url": "https://api.github.com/users/Davester47/following{/other_user}", "gists_url": "https://api.github.com/users/Davester47/gists{/gist_id}", "starred_url": "https://api.github.com/users/Davester47/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Davester47/subscriptions", "organizations_url": "https://api.github.com/users/Davester47/orgs", "repos_url": "https://api.github.com/users/Davester47/repos", "events_url": "https://api.github.com/users/Davester47/events{/privacy}", "received_events_url": "https://api.github.com/users/Davester47/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 630799571, "node_id": "MDU6TGFiZWw2MzA3OTk1NzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compilemem", "name": "I-compilemem", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to memory usage during compilation."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1049510487, "node_id": "MDU6TGFiZWwxMDQ5NTEwNDg3", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-async-await", "name": "A-async-await", "color": "f7e101", "default": false, "description": "Area: Async & Await"}, {"id": 1168029555, "node_id": "MDU6TGFiZWwxMTY4MDI5NTU1", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-hang", "name": "I-hang", "color": "e10c02", "default": false, "description": "Issue: The compiler never terminates, due to infinite loops, deadlock, livelock, etc."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2020-10-20T01:57:40Z", "updated_at": "2020-10-20T15:53:52Z", "closed_at": "2020-10-20T02:36:22Z", "author_association": "NONE", "active_lock_reason": null, "body": "AFAICT, this isn't a security vulnerability, so I'm reporting this here.\r\n\r\nI was attempting to build a RESTful CRUD API with Actix-web, and I've stumbled into a compiler bug. All the source files are about 150-200 LoC, so I'm not going to post them all here. The code that reproduces this bug is available at https://github.com/Davester47/rustc-leak. I left instructions to reproduce the leak in the README.md\r\n\r\n## To Reproduce:\r\nWhen I try to compile it with `cargo build`, it compiles all the dependencies fine. However, as soon as it gets to building the final binary (\"snack-actix\"), it starts leaking memory like crazy (500+ MB/s) and it never stops. It ran for over 10 minutes on the final phase on my Windows laptop, and I think it used over 15 GB of swap (I can't tell for sure on the task manager). On linux, the computer becomes unusable as soon as it starts using swap space.\r\n\r\nMy advice if you try to reproduce this is to have Task Manager or `htop` open while you compile it, and be ready to hit Ctrl+C. It will use *all* of your memory if you don't.\r\n\r\nThe last thing that I did before it started leaking memory was finish the function in src/controllers/snack.rs. I know that my code is probably bad style or not idiomatic or something, but it shouldn't use over 12 GBs of memory.\r\n\r\nI don't know how I would find where the leak happens or why it happens, so I'm hoping someone here will be able to. Let me know if you need more information. Please don't let this issue get sidelined.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\nI've confirmed that the leak occurs on all of the following toolchains.\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.47.0 (18bf6b4f0 2020-10-07)\r\nbinary: rustc\r\ncommit-hash: 18bf6b4f01a6feaf7259ba7cdae58031af1b7b39\r\ncommit-date: 2020-10-07\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.47.0\r\nLLVM version: 11.0\r\n\r\nrustc 1.49.0-nightly (b1496c6e6 2020-10-18)\r\nbinary: rustc\r\ncommit-hash: b1496c6e606dd908dd651ac2cce89815e10d7fc5\r\ncommit-date: 2020-10-18\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.49.0-nightly\r\nLLVM version: 11.0\r\n\r\nrustc 1.47.0 (18bf6b4f0 2020-10-07)\r\nbinary: rustc\r\ncommit-hash: 18bf6b4f01a6feaf7259ba7cdae58031af1b7b39\r\ncommit-date: 2020-10-07\r\nhost: x86_64-pc-windows-gnu\r\nrelease: 1.47.0\r\nLLVM version: 11.0\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\nThere's no backtrace, since I had to kill rustc with Ctrl+C every time to avoid crashing my computer (Sometimes I failed). I have 8 GBs of RAM, which should be enough to compile anything. It never panicked.\r\n", "closed_by": {"login": "camelid", "id": 37223377, "node_id": "MDQ6VXNlcjM3MjIzMzc3", "avatar_url": "https://avatars.githubusercontent.com/u/37223377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camelid", "html_url": "https://github.com/camelid", "followers_url": "https://api.github.com/users/camelid/followers", "following_url": "https://api.github.com/users/camelid/following{/other_user}", "gists_url": "https://api.github.com/users/camelid/gists{/gist_id}", "starred_url": "https://api.github.com/users/camelid/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camelid/subscriptions", "organizations_url": "https://api.github.com/users/camelid/orgs", "repos_url": "https://api.github.com/users/camelid/repos", "events_url": "https://api.github.com/users/camelid/events{/privacy}", "received_events_url": "https://api.github.com/users/camelid/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/78125/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/78125/timeline", "performed_via_github_app": null, "state_reason": "completed"}