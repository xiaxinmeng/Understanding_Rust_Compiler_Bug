{"url": "https://api.github.com/repos/rust-lang/rust/issues/45145", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/45145/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/45145/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/45145/events", "html_url": "https://github.com/rust-lang/rust/issues/45145", "id": 263967929, "node_id": "MDU6SXNzdWUyNjM5Njc5Mjk=", "number": 45145, "title": "A miscompilation with -C lto -O -C target-cpu=haswell", "user": {"login": "leonardo-m", "id": 22328461, "node_id": "MDQ6VXNlcjIyMzI4NDYx", "avatar_url": "https://avatars.githubusercontent.com/u/22328461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/leonardo-m", "html_url": "https://github.com/leonardo-m", "followers_url": "https://api.github.com/users/leonardo-m/followers", "following_url": "https://api.github.com/users/leonardo-m/following{/other_user}", "gists_url": "https://api.github.com/users/leonardo-m/gists{/gist_id}", "starred_url": "https://api.github.com/users/leonardo-m/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/leonardo-m/subscriptions", "organizations_url": "https://api.github.com/users/leonardo-m/orgs", "repos_url": "https://api.github.com/users/leonardo-m/repos", "events_url": "https://api.github.com/users/leonardo-m/events{/privacy}", "received_events_url": "https://api.github.com/users/leonardo-m/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2017-10-09T17:19:12Z", "updated_at": "2018-02-10T17:07:03Z", "closed_at": "2018-02-10T17:07:03Z", "author_association": "NONE", "active_lock_reason": null, "body": "This small program solves the Euler problem n.97:\r\n\r\n```\r\n#[inline(never)]\r\nfn e97() -> u64 {\r\n    // Input.\r\n    const BASE: f64 = 28_433.0;\r\n    const EXP: u64 = 7_830_457;\r\n    const BIG: f64 = 1e10;\r\n\r\n    let mut b = 1;\r\n    while b < EXP { b <<= 1; }\r\n\r\n    let mut n = 1.0;\r\n    while b > 0 {\r\n        if EXP & b != 0 {\r\n            n = (n * n * 2.0) % BIG;\r\n        } else {\r\n            n = (n * n) % BIG;\r\n        }\r\n        b >>= 1;\r\n    }\r\n\r\n    ((n * BASE + 1.0) % BIG) as u64\r\n}\r\n\r\nfn main() {\r\n    assert_eq!(e97(), 8_739_992_577);\r\n}\r\n```\r\n\r\n\r\nIf I compile it with normal compilation arguments like this it works correctly:\r\n`rustc -C lto -O -C target-cpu=haswell e97.rs`\r\n\r\n\r\nIf I compile it with -C target-cpu=native or like this, it asserts at run time:\r\n`rustc -C lto -O -C target-cpu=haswell e97.rs`\r\n\r\n\r\n```\r\nthread 'main' panicked at 'assertion failed: `(left == right)`\r\n  left: `9246255105`,\r\n right: `8739992577`', e97.rs:27:4\r\n```\r\n\r\n------------------------------\r\n\r\nThe asm compiling with:\r\n`rustc -C lto -O --emit asm e97.rs`\r\n\r\n```\r\n_ZN3e973e9717h3d13175579ebef2eE:\r\n    pushq   %rsi\r\n    subq    $48, %rsp\r\n    movaps  %xmm6, 32(%rsp)\r\n    movsd   .LCPI1_0(%rip), %xmm0\r\n    movl    $8388608, %esi\r\n    movsd   .LCPI1_1(%rip), %xmm6\r\n    .p2align    4, 0x90\r\n.LBB1_1:\r\n    testl   $7830457, %esi\r\n    mulsd   %xmm0, %xmm0\r\n    je  .LBB1_3\r\n    addsd   %xmm0, %xmm0\r\n.LBB1_3:\r\n    movaps  %xmm6, %xmm1\r\n    callq   fmod\r\n    testl   $15660914, %esi\r\n    mulsd   %xmm0, %xmm0\r\n    je  .LBB1_5\r\n    addsd   %xmm0, %xmm0\r\n.LBB1_5:\r\n    movaps  %xmm6, %xmm1\r\n    callq   fmod\r\n    shrq    $2, %rsi\r\n    jne .LBB1_1\r\n    mulsd   .LCPI1_2(%rip), %xmm0\r\n    addsd   .LCPI1_0(%rip), %xmm0\r\n    movsd   .LCPI1_1(%rip), %xmm1\r\n    callq   fmod\r\n    movsd   .LCPI1_3(%rip), %xmm1\r\n    movapd  %xmm0, %xmm2\r\n    subsd   %xmm1, %xmm2\r\n    cvttsd2si   %xmm2, %rax\r\n    movabsq $-9223372036854775808, %rcx\r\n    xorq    %rax, %rcx\r\n    cvttsd2si   %xmm0, %rax\r\n    ucomisd %xmm1, %xmm0\r\n    cmovaeq %rcx, %rax\r\n    movaps  32(%rsp), %xmm6\r\n    addq    $48, %rsp\r\n    popq    %rsi\r\n    retq\r\n```\r\n\r\n------------------------------\r\n\r\nThe asm compiling with:\r\n`\r\nrustc -C lto -O -C target-cpu=haswell --emit asm e97.rs`\r\n\r\n```\r\n_ZN3e973e9717h3d13175579ebef2eE:\r\n    .loc    24 0 0 is_stmt 0\r\n    movabsq $9246255105, %rax\r\n    retq\r\n```\r\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/45145/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/45145/timeline", "performed_via_github_app": null, "state_reason": "completed"}