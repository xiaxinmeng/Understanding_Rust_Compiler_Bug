{"url": "https://api.github.com/repos/rust-lang/rust/issues/88995", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/88995/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/88995/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/88995/events", "html_url": "https://github.com/rust-lang/rust/issues/88995", "id": 997623069, "node_id": "I_kwDOAAsO6M47doUd", "number": 88995, "title": "\"-Zbuild_std\" produces a broken std on riscv32gc-unknown-linux-gnu", "user": {"login": "sajattack", "id": 1562711, "node_id": "MDQ6VXNlcjE1NjI3MTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1562711?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sajattack", "html_url": "https://github.com/sajattack", "followers_url": "https://api.github.com/users/sajattack/followers", "following_url": "https://api.github.com/users/sajattack/following{/other_user}", "gists_url": "https://api.github.com/users/sajattack/gists{/gist_id}", "starred_url": "https://api.github.com/users/sajattack/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sajattack/subscriptions", "organizations_url": "https://api.github.com/users/sajattack/orgs", "repos_url": "https://api.github.com/users/sajattack/repos", "events_url": "https://api.github.com/users/sajattack/events{/privacy}", "received_events_url": "https://api.github.com/users/sajattack/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1210355734, "node_id": "MDU6TGFiZWwxMjEwMzU1NzM0", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-riscv", "name": "O-riscv", "color": "6e6ec0", "default": false, "description": "Target: RISC-V architecture"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-09-16T00:13:00Z", "updated_at": "2021-11-12T02:59:08Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I tried this code:\r\n\r\n```rust\r\nfn main() {\r\n    // test if allocation is totally broken\r\n    let string = String::from(\"Hello RISC-V from Rust!\");\r\n    println!(\"{}\", string);\r\n}\r\n```\r\n\r\nwith this .cargo/config\r\n```toml\r\n[unstable]\r\nbuild-std = [\"std\", \"panic_abort\"]\r\nbuild-std-features = [\"panic_immediate_abort\"]\r\n\r\n[build]\r\ntarget= \"riscv32gc-unknown-linux-gnu\"\r\n\r\n[target.riscv32gc-unknown-linux-gnu]\r\nlinker = \"/opt/riscv/bin/riscv32-unknown-linux-gnu-gcc\"\r\nrustflags = [\r\n    \"-C\", \"link-arg=-march=rv32gc\",\r\n    \"-C\", \"link-arg=-mabi=ilp32d\",\r\n    \"-C\", \"linker-flavor=gcc\"\r\n]\r\n```\r\n\r\nand a rv32gc ilp32d gcc linker from https://github.com/riscv/riscv-gnu-toolchain\r\n\r\non a vexriscv-smp soc generated by https://github.com/enjoy-digital/litex\r\n\r\nI expected to see \"Hello RISC-V from Rust!\" on stdout.\r\n\r\nInstead, this happened: \r\n```\r\n[   17.788737] hello-test[114]: unhandled signal 11 code 0x1 at 0x00000000 in libc.so.6[95a48000+152000]\r\n[   17.789848] CPU: 3 PID: 114 Comm: hello-test Not tainted 5.12.0-rc4 #2\r\n[   17.790412] epc : 95ad1578 ra : 95ad14f8 sp : 9d5eab10\r\n[   17.790950]  gp : 692d9800 tp : 95bc9630 t0 : 00000000\r\n[   17.792687]  t1 : 692c8bbc t2 : 00000000 s0 : 692da480\r\n[   17.794541]  s1 : 00000017 a0 : 00000000 a1 : 6c6c6548\r\n[   17.795586]  a2 : 00000008 a3 : fffffff0 a4 : 692da474\r\n[   17.802431]  a5 : 00000000 a6 : 4952206f a7 : ffffffff\r\n[   17.803684]  s2 : 00000000 s3 : 00000000 s4 : 00000017\r\n[   17.809056]  s5 : 95bee3a8 s6 : 9d5eae0c s7 : 00000000\r\n[   17.810680]  s8 : 00000000 s9 : 69390680 s10: 6938e408\r\n[   17.811760]  s11: 00000001 t3 : 95ad1424 t4 : 00000000\r\n[   17.818930]  t5 : 0000000f t6 : 00000080\r\n[   17.820843] status: 00000020 badaddr: 00000000 cause: 0000000f\r\nSegmentation fault\r\n```\r\nGDB backtrace indicates the data for the slice (stdout) is null.\r\n```\r\n(gdb) bt\r\n#0  core::panicking::panic (expr=...) at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:41\r\n#1  0x40024458 in core::slice::raw::from_raw_parts<u8> (data=0x0, len=0)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/slice/raw.rs:89\r\n#2  0x40016256 in alloc::vec::{impl#10}::deref<u8, alloc::alloc::Global> (self=0x4004520c <std::io::stdio::STDOUT+28>)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/vec/mod.rs:2370\r\n#3  0x40005dc8 in std::io::buffered::bufwriter::BufWriter<std::io::stdio::StdoutRaw>::buffer<std::io::stdio::StdoutRaw> (\r\n    self=0x4004520c <std::io::stdio::STDOUT+28>)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/buffered/bufwriter.rs:252\r\n#4  0x4000b4d8 in std::io::buffered::linewritershim::LineWriterShim<std::io::stdio::StdoutRaw>::buffered<std::io::stdio::StdoutRaw> (self=0x3fffefc0)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/buffered/linewritershim.rs:38\r\n#5  0x4000b4f8 in std::io::buffered::linewritershim::LineWriterShim<std::io::stdio::StdoutRaw>::flush_if_completed_line<std::io::stdio::StdoutRaw> (\r\n    self=0x3fffefc0) at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/buffered/linewritershim.rs:45\r\n#6  0x4000b59e in std::io::buffered::linewritershim::{impl#1}::write_all<std::io::stdio::StdoutRaw> (self=0x3fffefc0, buf=...)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/buffered/linewritershim.rs:253\r\n#7  0x40013692 in std::io::buffered::linewriter::{impl#1}::write_all<std::io::stdio::StdoutRaw> (self=0x4004520c <std::io::stdio::STDOUT+28>, buf=...)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/buffered/linewriter.rs:206\r\n#8  0x40006686 in std::io::stdio::{impl#14}::write_all (self=0x3ffff404, buf=...)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/stdio.rs:872\r\n#9  0x4000b932 in std::io::Write::write_fmt::{impl#0}::write_str<std::io::stdio::StdoutLock> (self=0x3ffff380, s=...)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/mod.rs:1656\r\n#10 0x4001fcc2 in core::fmt::Formatter::pad (self=0x3ffff208, s=...)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/mod.rs:1399\r\n#11 0x4002040e in core::fmt::{impl#16}::fmt (self=..., f=0x3ffff208)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/mod.rs:2148\r\n#12 0x4000393c in alloc::string::{impl#20}::fmt (self=0x3ffff578, f=0x3ffff208)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/string.rs:2121\r\n#13 0x4001f316 in core::fmt::write (output=..., args=...)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/mod.rs:1150\r\n#14 0x40006a4a in std::io::Write::write_fmt<std::io::stdio::StdoutLock> (self=0x3ffff404, fmt=...)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/mod.rs:1667\r\n#15 0x400065f2 in std::io::stdio::{impl#13}::write_fmt (self=0x3ffff44c, args=...)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/stdio.rs:852\r\n#16 0x400065a2 in std::io::stdio::{impl#12}::write_fmt (self=0x3ffff4d4, args=...)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/stdio.rs:826\r\n#17 0x40006786 in std::io::stdio::print_to<std::io::stdio::Stdout> (args=..., global_s=0x40006312 <std::io::stdio::stdout>, label=...)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/stdio.rs:1192\r\n#18 0x400069fa in std::io::stdio::_print (args=...)\r\n    at /home/paul/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/stdio.rs:1205\r\n#19 0x40003804 in hello_test::main () at src/main.rs:4\r\n```\r\n\r\nAnother bit of code I tried using rayon failed a malloc, it seems std is just generally broken on this architecture.\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.57.0-nightly (e30b68353 2021-09-05)\r\nbinary: rustc\r\ncommit-hash: e30b68353fe22b00f40d021e7914eeb78473b3c1\r\ncommit-date: 2021-09-05\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.57.0-nightly\r\nLLVM version: 13.0.0\r\n```\r\n\r\n</p>\r\n</details>\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/88995/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/88995/timeline", "performed_via_github_app": null, "state_reason": null}