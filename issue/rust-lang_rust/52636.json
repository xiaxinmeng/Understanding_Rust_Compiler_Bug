{"url": "https://api.github.com/repos/rust-lang/rust/issues/52636", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/52636/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/52636/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/52636/events", "html_url": "https://github.com/rust-lang/rust/issues/52636", "id": 343482550, "node_id": "MDU6SXNzdWUzNDM0ODI1NTA=", "number": 52636, "title": "_mm256_loadu_si256 only loads 128 bits when compiled with default cargo build --release", "user": {"login": "djsweet", "id": 9657980, "node_id": "MDQ6VXNlcjk2NTc5ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/9657980?v=4", "gravatar_id": "", "url": "https://api.github.com/users/djsweet", "html_url": "https://github.com/djsweet", "followers_url": "https://api.github.com/users/djsweet/followers", "following_url": "https://api.github.com/users/djsweet/following{/other_user}", "gists_url": "https://api.github.com/users/djsweet/gists{/gist_id}", "starred_url": "https://api.github.com/users/djsweet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/djsweet/subscriptions", "organizations_url": "https://api.github.com/users/djsweet/orgs", "repos_url": "https://api.github.com/users/djsweet/repos", "events_url": "https://api.github.com/users/djsweet/events{/privacy}", "received_events_url": "https://api.github.com/users/djsweet/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2018-07-23T04:20:53Z", "updated_at": "2018-10-21T01:06:46Z", "closed_at": "2018-10-21T01:06:46Z", "author_association": "NONE", "active_lock_reason": null, "body": "The AVX2 intrinsic `_mm256_loadu_si256` fully loads all 256 bits from memory into the register when compiled without any optimization, but only loads 128 bits when compiled with the default `cargo build --release` option. This small program exhibits the issue:\r\n\r\n```rust\r\nuse std::arch::x86_64;\r\n\r\nfn main() {\r\n    if is_x86_feature_detected!(\"avx2\") {\r\n        let load_bytes: [u8; 32] = [0x0f; 32];\r\n        let lb_ptr = load_bytes.as_ptr();\r\n        let reg_load = unsafe {\r\n            x86_64::_mm256_loadu_si256(\r\n                lb_ptr as *const x86_64::__m256i\r\n            )\r\n        };\r\n        println!(\"{:?}\", reg_load);\r\n        let mut store_bytes: [u8; 32] = [0; 32];\r\n        let sb_ptr = store_bytes.as_mut_ptr();\r\n        unsafe {\r\n            x86_64::_mm256_storeu_si256(sb_ptr as *mut x86_64::__m256i, reg_load);\r\n        }\r\n        assert_eq!(load_bytes, store_bytes);\r\n    } else {\r\n        println!(\"AVX2 is not supported on this machine/build.\");\r\n    }\r\n}\r\n```\r\n\r\nWhen I run `cargo run`, this is the output:\r\n\r\n```\r\n   Compiling...\r\n    Finished dev [unoptimized + debuginfo] target(s) in 0.33s\r\n     Running `target/debug/avx2_bug_hunt`\r\n__m256i(1085102592571150095, 1085102592571150095, 1085102592571150095, 1085102592571150095)\r\n```\r\n\r\nHowever, with `cargo run --release`, this is the output:\r\n```\r\n   Compiling...\r\n    Finished release [optimized] target(s) in 0.26s\r\n     Running `target/release/avx2_bug_hunt`\r\n__m256i(1085102592571150095, 1085102592571150095, 0, 0)\r\nthread 'main' panicked at 'assertion failed: `(left == right)`\r\n  left: `[15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15]`,\r\n right: `[15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]`', src/main.rs:18:9\r\nnote: Run with `RUST_BACKTRACE=1` for a backtrace.\r\n```\r\n\r\nI am on macOS 10.13.6 with a Core i7 I7-4960HQ, and the output of `rustc --version --verbose` is\r\n\r\n```\r\nrustc 1.27.2\r\nbinary: rustc\r\ncommit-hash: unknown\r\ncommit-date: unknown\r\nhost: x86_64-apple-darwin\r\nrelease: 1.27.2\r\nLLVM version: 6.0\r\n```\r\n\r\nCuriously, when inspecting the assembly of `main`, the call to `_mm256_loadu_si256` is not inlined, but instead generates this function:\r\n\r\n```\r\navx2_bug_hunt`core::coresimd::x86::avx::_mm256_loadu_si256::hd7fc98ebefdce593:\r\navx2_bug_hunt[0x1000018a0] <+0>:  pushq  %rbp\r\navx2_bug_hunt[0x1000018a1] <+1>:  movq   %rsp, %rbp\r\navx2_bug_hunt[0x1000018a4] <+4>:  vmovaps %ymm0, (%rdi)\r\navx2_bug_hunt[0x1000018a8] <+8>:  popq   %rbp\r\navx2_bug_hunt[0x1000018a9] <+9>:  vzeroupper \r\navx2_bug_hunt[0x1000018ac] <+12>: retq   \r\navx2_bug_hunt[0x1000018ad] <+13>: nopl   (%rax)\r\n```\r\n\r\nNote the `vzeroupper` instruction, which clears out the non-XMM registers. This is incorrect behavior, `_m256i` requires the full YMM register to be loaded unmodified. A similar spurious `vzeroupper` is also present in the assembly generated for `_mm256_storeu_si256`, but after the register is stored into memory.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/52636/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/52636/timeline", "performed_via_github_app": null, "state_reason": "completed"}