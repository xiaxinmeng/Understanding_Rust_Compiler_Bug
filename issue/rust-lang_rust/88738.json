{"url": "https://api.github.com/repos/rust-lang/rust/issues/88738", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/88738/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/88738/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/88738/events", "html_url": "https://github.com/rust-lang/rust/issues/88738", "id": 990923067, "node_id": "MDU6SXNzdWU5OTA5MjMwNjc=", "number": 88738, "title": "It seems rustc failed to compile a sound code?", "user": {"login": "zylthinking", "id": 1066931, "node_id": "MDQ6VXNlcjEwNjY5MzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1066931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zylthinking", "html_url": "https://github.com/zylthinking", "followers_url": "https://api.github.com/users/zylthinking/followers", "following_url": "https://api.github.com/users/zylthinking/following{/other_user}", "gists_url": "https://api.github.com/users/zylthinking/gists{/gist_id}", "starred_url": "https://api.github.com/users/zylthinking/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zylthinking/subscriptions", "organizations_url": "https://api.github.com/users/zylthinking/orgs", "repos_url": "https://api.github.com/users/zylthinking/repos", "events_url": "https://api.github.com/users/zylthinking/events{/privacy}", "received_events_url": "https://api.github.com/users/zylthinking/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-09-08T09:19:40Z", "updated_at": "2021-09-08T12:46:50Z", "closed_at": "2021-09-08T12:46:50Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nHello, I have the following code, which fails to compile directly.\r\nshowing\r\n```\r\n33  |     let h1 = tokio::spawn(f1);\r\n    |              ^^^^^^^^^^^^ `std::sync::MutexGuard<'_, Box<ListHead>>` cannot be sent between threads safely\r\n    | \r\n   ::: /home/zylthinking/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:61:43\r\n    |\r\n61  | pub const fn from_generator<T>(gen: T) -> impl Future<Output = T::Return>\r\n    |                                           ------------------------------- within this `impl Future`\r\n    | \r\n   ::: /home/zylthinking/.cargo/registry/src/mirrors.ustc.edu.cn-61ef6e0cd06fb9b8/tokio-1.11.0/src/task/spawn.rs:127:21\r\n    |\r\n127 |         T: Future + Send + 'static,\r\n    |                     ---- required by this bound in `tokio::spawn`\r\n    |\r\n    = help: within `impl Future`, the trait `Send` is not implemented for `std::sync::MutexGuard<'_, Box<ListHead>>`\r\n    = note: required because it appears within the type `for<'r, 's, 't0, 't1, 't2> {ResumeTy, &'r Autex, Result<i32, i32>, autex::autex<'s>, std::sync::MutexGuard<'t0, Box<ListHead>>, &'t1 mut autex::autex<'t2>, ()}`\r\n    = note: required because it appears within the type `[static generator@Autex::lock::{closure#0} for<'r, 's, 't0, 't1, 't2> {ResumeTy, &'r Autex, Result<i32, i32>, autex::autex<'s>, std::sync::MutexGuard<'t0, Box<ListHead>>, &'t1 mut autex::autex<'t2>, ()}]`\r\n    = note: required because it appears within the type `from_generator::GenFuture<[static generator@Autex::lock::{closure#0} for<'r, 's, 't0, 't1, 't2> {ResumeTy, &'r Autex, Result<i32, i32>, autex::autex<'s>, std::sync::MutexGuard<'t0, Box<ListHead>>, &'t1 mut autex::autex<'t2>, ()}]>`\r\n    = note: required because it appears within the type `impl Future`\r\n    = note: required because it appears within the type `impl Future`\r\n    = note: required because it appears within the type `for<'r, 's, 't0> {ResumeTy, &'r Autex, Autex, impl Future, (), Guard<'t0>, u64, Duration, Sleep}`\r\n    = note: required because it appears within the type `[static generator@tests/tokio.rs:8:20: 17:6 for<'r, 's, 't0> {ResumeTy, &'r Autex, Autex, impl Future, (), Guard<'t0>, u64, Duration, Sleep}]`\r\n    = note: required because it appears within the type `from_generator::GenFuture<[static generator@tests/tokio.rs:8:20: 17:6 for<'r, 's, 't0> {ResumeTy, &'r Autex, Autex, impl Future, (), Guard<'t0>, u64, Duration, Sleep}]>`\r\n    = note: required because it appears within the type `impl Future`\r\n```\r\n\r\nNoticed there is a MutexGuard as a generated parameter, I put it into another fn a(), and  it compiles.\r\nIs it a compiler bug?\r\n\r\n```rust\r\n    fn a(&self, autx: &mut autex) {\r\n        let mut g0 = self.mux.lock().unwrap();\r\n        unsafe {\r\n            g0.list_add_tail(&mut autx.ent);\r\n        }\r\n        drop(g0);\r\n    }\r\n\r\n    pub async fn lock<'a>(&'a self) -> Guard<'a> {\r\n        let r = self\r\n            .hold\r\n            .atomic_compare_exchange(0, 1, Ordering::Relaxed, Ordering::Relaxed);\r\n        if r.is_ok() {\r\n            return Guard(self);\r\n        }\r\n\r\n        let mut autx = autex::new(self);\r\n\r\n       // this line will compiles\r\n        self.a(&mut autx);\r\n\r\n        // but the following is not\r\n        // let mut g0 = self.mux.lock().unwrap();\r\n        // unsafe {\r\n        //     g0.list_add_tail(&mut autx.ent);\r\n        // }\r\n        // drop(g0);\r\n\r\n        let g1 = (&mut autx).await;\r\n        let g2 = self.mux.lock().unwrap();\r\n        unsafe {\r\n            autx.ent.list_del();\r\n        }\r\n        drop(g2);\r\n        g1\r\n    }\r\n```\r\n\r\nthe compiler is rustc 1.53\r\n", "closed_by": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/88738/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/88738/timeline", "performed_via_github_app": null, "state_reason": "completed"}