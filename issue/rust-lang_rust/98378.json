{"url": "https://api.github.com/repos/rust-lang/rust/issues/98378", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/98378/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/98378/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/98378/events", "html_url": "https://github.com/rust-lang/rust/issues/98378", "id": 1279910536, "node_id": "I_kwDOAAsO6M5MSeKI", "number": 98378, "title": "libstd: -Z build-std is now broken for Cortex-M targets", "user": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2022-06-22T10:17:56Z", "updated_at": "2022-09-25T06:53:24Z", "closed_at": "2022-09-25T06:53:24Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "## Steps to reproduce\r\n\r\nExpected this to work with a recent nightly but it didn't.\r\n\r\n``` console\r\n$ rustup default nightly-2022-06-22\r\n$ rustup component add rust-src\r\n$ rustup component add thumbv7m-none-eabi\r\n\r\n$ cargo new --lib foo\r\n$ cd foo\r\n$ echo '#![no_std]' > src/lib.rs\r\n\r\n$ cargo build -Z build-std --target thumbv7m-none-eabi\r\n(..)\r\nerror: `sys_common::condvar::Condvar::new` is not yet stable as a const fn\r\n   --> /home/japaric/.rustup/toolchains/nightly-2022-06-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sync/condvar.rs:129:26\r\n    |\r\n129 |         Condvar { inner: sys::Condvar::new() }\r\n    |                          ^^^^^^^^^^^^^^^^^^^\r\n    |\r\n    = help: const-stable functions can only call other const-stable functions\r\n\r\nerror: `sys_common::mutex::MovableMutex::new` is not yet stable as a const fn\r\n   --> /home/japaric/.rustup/toolchains/nightly-2022-06-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sync/mutex.rs:220:20\r\n    |\r\n220 |             inner: sys::MovableMutex::new(),\r\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^\r\n    |\r\n    = help: const-stable functions can only call other const-stable functions\r\n\r\nerror: `sys_common::rwlock::MovableRwLock::new` is not yet stable as a const fn\r\n   --> /home/japaric/.rustup/toolchains/nightly-2022-06-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sync/rwlock.rs:153:20\r\n    |\r\n153 |             inner: sys::MovableRwLock::new(),\r\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    |\r\n    = help: const-stable functions can only call other const-stable functions\r\n\r\nerror: could not compile `std` due to 3 previous errors\r\n```\r\n\r\nThe most recent PR that touched code related to those lines is #97791.\r\n\r\nRetrying the above steps with an older nightly (`nightly-2022-06-18`) before #97791 was merged works fine.\r\n\r\n---\r\n\r\nI find a bit odd that `-Z build-std` re-compiles libstd for a no-std target; I presume it's recompiling it to recompile proc_macro for the host. (?)\r\n\r\nWhat's more strange is that using `--target=$HOST` works fine with `nightly-2022-06-22`.\r\n\r\n``` console\r\n$ # same Cargo project as before\r\n$ rustc -Vv | rg host\r\nhost: x86_64-unknown-linux-gnu\r\n\r\n$ cargo build -Z build-std --target x86_64-unknown-linux-gnu && echo OK\r\n   Compiling std\r\n(..)\r\n   Compiling proc_macro\r\n(..)\r\nOK\r\n```\r\n\r\nSo I'm not sure why libstd fails to compile for the host with `-Z build-std --target=thumbv7m-none-eabi` but not with `-Z build-std --target=$HOST`\r\n\r\n## Meta\r\n\r\n``` console\r\n$ rustc -Vv\r\nrustc 1.63.0-nightly (dc80ca78b 2022-06-21)\r\nbinary: rustc\r\ncommit-hash: dc80ca78b6ec2b6bba02560470347433bcd0bb3c\r\ncommit-date: 2022-06-21\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.63.0-nightly\r\nLLVM version: 14.0.5\r\n```\r\n\r\n## Workaround\r\n\r\nUsing `-Z build-std=core` (or `=alloc`) with `thumbv7m-none-eabi` compiles fine.\r\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/98378/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/98378/timeline", "performed_via_github_app": null, "state_reason": "completed"}