{"url": "https://api.github.com/repos/rust-lang/rust/issues/58527", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/58527/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/58527/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/58527/events", "html_url": "https://github.com/rust-lang/rust/issues/58527", "id": 411149841, "node_id": "MDU6SXNzdWU0MTExNDk4NDE=", "number": 58527, "title": "Impossible to specify link-args for lld in json target specification", "user": {"login": "ids1024", "id": 2263150, "node_id": "MDQ6VXNlcjIyNjMxNTA=", "avatar_url": "https://avatars.githubusercontent.com/u/2263150?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ids1024", "html_url": "https://github.com/ids1024", "followers_url": "https://api.github.com/users/ids1024/followers", "following_url": "https://api.github.com/users/ids1024/following{/other_user}", "gists_url": "https://api.github.com/users/ids1024/gists{/gist_id}", "starred_url": "https://api.github.com/users/ids1024/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ids1024/subscriptions", "organizations_url": "https://api.github.com/users/ids1024/orgs", "repos_url": "https://api.github.com/users/ids1024/repos", "events_url": "https://api.github.com/users/ids1024/events{/privacy}", "received_events_url": "https://api.github.com/users/ids1024/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 632453790, "node_id": "MDU6TGFiZWw2MzI0NTM3OTA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-target-specs", "name": "A-target-specs", "color": "f7e101", "default": false, "description": "Area: compile-target specifications"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2019-02-17T05:04:37Z", "updated_at": "2019-02-17T07:59:46Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Rustc target spec json files can specify `link-args` and `pre-link-args`. For instance, here is part of the output of `rustc -Z unstable-options --print target-spec-json --target i686-unknown-linux-gnu`:\r\n\r\n```json\r\n  \"pre-link-args\": {\r\n    \"gcc\": [\r\n      \"-Wl,--as-needed\",\r\n      \"-Wl,-z,noexecstack\",\r\n      \"-m32\"\r\n    ]\r\n  },\r\n```\r\n\r\nAs far as I can tell, for annoying reasons about how it's implemented, it isn't possible to set this with `lld` instead of `gcc`.\r\n\r\nIn [`librustc_target/spec/mod.rs`](https://github.com/rust-lang/rust/blob/master/src/librustc_target/spec/mod.rs):\r\n\r\n```rust\r\n#[derive(Clone, Copy, Debug, Eq, Ord, PartialEq, PartialOrd, Hash,\r\n         RustcEncodable, RustcDecodable)]\r\npub enum LinkerFlavor {\r\n    Em,\r\n    Gcc,\r\n    Ld,\r\n    Msvc,\r\n    Lld(LldFlavor),\r\n    PtxLinker,\r\n}\r\n```\r\n\r\nThis is serialized and de-serialized with `rustc-serialize`. Unlike the other variants, `Lld` contains a field. Looking at how the json serialization/de-serialization is [implemented](https://github.com/rust-lang-deprecated/rustc-serialize/blob/master/src/json.rs), it looks like this is would be represented as `{\"variant\": \"lld\", \"fields\": [...]\"}`.\r\n\r\nThe issue is that this can't appear in the target spec in place of `\"gcc\"` from the example above, since json doesn't allow an object to be the key of an object.\r\n\r\nIs my analysis right, and this is currently impossible to do in a json target spec, or am I missing something?\r\n\r\n### Solution\r\nI think the best solution in the short term is to implement `Decodable` and `Encodable` manually for the enum. I presume changing the representation of this wouldn't break anything in practice, and even if it did it's an implementation detail that doesn't provide stability guarantees?\r\n\r\nIn the long term, I'm not sure what the plans for `rustc-serialize` are. It describes itself as \"deprecated\". Is it ideally intended to be replaced with `serde` at some point, which just hasn't been done since it's a lot of work?", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/58527/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/58527/timeline", "performed_via_github_app": null, "state_reason": null}