{"url": "https://api.github.com/repos/rust-lang/rust/issues/41672", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/41672/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/41672/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/41672/events", "html_url": "https://github.com/rust-lang/rust/issues/41672", "id": 225414051, "node_id": "MDU6SXNzdWUyMjU0MTQwNTE=", "number": 41672, "title": "[ARM] LLVM: Unknown addressing mode for CP reference! UNREACHABLE executed at ARMConstantIslandPass.cpp:755", "user": {"login": "whitequark", "id": 54771, "node_id": "MDQ6VXNlcjU0Nzcx", "avatar_url": "https://avatars.githubusercontent.com/u/54771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/whitequark", "html_url": "https://github.com/whitequark", "followers_url": "https://api.github.com/users/whitequark/followers", "following_url": "https://api.github.com/users/whitequark/following{/other_user}", "gists_url": "https://api.github.com/users/whitequark/gists{/gist_id}", "starred_url": "https://api.github.com/users/whitequark/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/whitequark/subscriptions", "organizations_url": "https://api.github.com/users/whitequark/orgs", "repos_url": "https://api.github.com/users/whitequark/repos", "events_url": "https://api.github.com/users/whitequark/events{/privacy}", "received_events_url": "https://api.github.com/users/whitequark/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2017-05-01T10:05:39Z", "updated_at": "2017-05-04T22:24:54Z", "closed_at": "2017-05-04T22:24:54Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "To reproduce in a real-world example, follow [these instructions](https://github.com/m-labs/ek-tm4c1294xl-demo/tree/b9814d3e5e793177d6760178fe50b8b83f046a49#steam-cannon-start). Note that the bug is somewhat finicky: it's not exhibited in debug builds, and it's not exhibited also until main crosses a certain threshold size (might be related to inliner, not sure). It also does not crash (or AFAICT miscompile) on non-Asserts LLVM builds, so beware.\r\n\r\nReduced example, crashing LLVM from the current nightly:\r\n```\r\n; RUN: llc crash.ll\r\ntarget datalayout = \"e-m:e-p:32:32-i64:64-v128:64:128-a:0:32-n32-S64\"\r\ntarget triple = \"thumbv7em-none--eabihf\"\r\n\r\n@__rustc_debug_gdb_scripts_section__ = internal unnamed_addr constant [34 x i8] c\"\\01gdb_load_rust_pretty_printers.py\\00\", section \".debug_gdb_scripts\", align 1\r\n\r\ndefine i32 @main(i32, i8** nocapture readnone) {\r\ntop:\r\n  %2 = load volatile i8, i8* getelementptr inbounds ([34 x i8], [34 x i8]* @__rustc_debug_gdb_scripts_section__, i32 0, i32 0), align 1\r\n  ret i32 0\r\n}\r\n```\r\nBacktrace:\r\n```\r\n#2  0x000055555636cbaa in llvm::llvm_unreachable_internal (msg=msg@entry=0x5555567aaec8 \"Unknown addressing mode for CP reference!\",\r\n    file=file@entry=0x5555567aa908 \"/home/whitequark/Work/rust/src/llvm/lib/Target/ARM/ARMConstantIslandPass.cpp\", line=line@entry=755)\r\n    at /home/whitequark/Work/rust/src/llvm/lib/Support/ErrorHandling.cpp:118\r\n#3  0x0000555555a5bc48 in (anonymous namespace)::ARMConstantIslands::initializeFunctionInfo (this=this@entry=0x555557402480, CPEMIs=...)\r\n    at /home/whitequark/Work/rust/src/llvm/lib/Target/ARM/ARMConstantIslandPass.cpp:755\r\n#4  0x0000555555a5d23d in (anonymous namespace)::ARMConstantIslands::runOnMachineFunction (this=0x555557402480, mf=...)\r\n    at /home/whitequark/Work/rust/src/llvm/lib/Target/ARM/ARMConstantIslandPass.cpp:373\r\n#5  0x0000555555dacbd5 in llvm::MachineFunctionPass::runOnFunction (this=0x555557402480, F=...)\r\n    at /home/whitequark/Work/rust/src/llvm/lib/CodeGen/MachineFunctionPass.cpp:62\r\n#6  0x000055555606470b in llvm::FPPassManager::runOnFunction (this=0x5555573e5760, F=...)\r\n    at /home/whitequark/Work/rust/src/llvm/lib/IR/LegacyPassManager.cpp:1510\r\n#7  0x00005555560647c4 in llvm::FPPassManager::runOnModule (this=0x5555573e5760, M=...)\r\n    at /home/whitequark/Work/rust/src/llvm/lib/IR/LegacyPassManager.cpp:1531\r\n#8  0x0000555556065321 in (anonymous namespace)::MPPassManager::runOnModule (M=..., this=<optimized out>)\r\n    at /home/whitequark/Work/rust/src/llvm/lib/IR/LegacyPassManager.cpp:1587\r\n#9  llvm::legacy::PassManagerImpl::run (this=0x5555573dcaf0, M=...) at /home/whitequark/Work/rust/src/llvm/lib/IR/LegacyPassManager.cpp:1690\r\n#10 0x000055555583b349 in compileModule (argv=0x7fffffffdb38, Context=...) at /home/whitequark/Work/rust/src/llvm/tools/llc/llc.cpp:532\r\n#11 0x0000555555804e80 in main (argc=2, argv=0x7fffffffdb38) at /home/whitequark/Work/rust/src/llvm/tools/llc/llc.cpp:289\r\n```\r\nMC dump:\r\n```\r\n(gdb) p MF->dump()\r\n# Machine code for function main: NoPHIs, NoVRegs\r\nConstant Pool:\r\n  cp#0: , align=4\r\n\r\nBB#0: derived from LLVM BB %top\r\n        %R0<def,dead> = t2LDRBpci <cp#0>, pred:14, pred:%noreg; mem:Volatile LD1[getelementptr inbounds ([34 x i8], [34 x i8]* @__rustc_debug_gdb_scripts_section__, i32 0, i32 0)](dereferenceable)\r\n        %R0<def>, %CPSR<def,dead> = tMOVi8 0, pred:14, pred:%noreg\r\n        tBX_RET pred:14, pred:%noreg, %R0<imp-use,kill>\r\n\r\nBB#1: Align 2 (4 bytes)\r\n        CONSTPOOL_ENTRY 0, <cp#0>, 36\r\n\r\n# End machine code for function main.\r\n```\r\nThis is actually quite baffling because there's a case for `ARM::t2LDRBpci` in the crashing switch. Not sure what's up.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/41672/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/41672/timeline", "performed_via_github_app": null, "state_reason": "completed"}