{"url": "https://api.github.com/repos/rust-lang/rust/issues/64729", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/64729/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/64729/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/64729/events", "html_url": "https://github.com/rust-lang/rust/issues/64729", "id": 497533699, "node_id": "MDU6SXNzdWU0OTc1MzM2OTk=", "number": 64729, "title": "`rustc` v1.37.0 freezing when passed `--emit`", "user": {"login": "staticfloat", "id": 130920, "node_id": "MDQ6VXNlcjEzMDkyMA==", "avatar_url": "https://avatars.githubusercontent.com/u/130920?v=4", "gravatar_id": "", "url": "https://api.github.com/users/staticfloat", "html_url": "https://github.com/staticfloat", "followers_url": "https://api.github.com/users/staticfloat/followers", "following_url": "https://api.github.com/users/staticfloat/following{/other_user}", "gists_url": "https://api.github.com/users/staticfloat/gists{/gist_id}", "starred_url": "https://api.github.com/users/staticfloat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/staticfloat/subscriptions", "organizations_url": "https://api.github.com/users/staticfloat/orgs", "repos_url": "https://api.github.com/users/staticfloat/repos", "events_url": "https://api.github.com/users/staticfloat/events{/privacy}", "received_events_url": "https://api.github.com/users/staticfloat/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 116993, "node_id": "MDU6TGFiZWwxMTY5OTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-driver", "name": "A-driver", "color": "f7e101", "default": false, "description": "Area: rustc_driver that ties everything together into the `rustc` compiler"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1168029555, "node_id": "MDU6TGFiZWwxMTY4MDI5NTU1", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-hang", "name": "I-hang", "color": "e10c02", "default": false, "description": "Issue: The compiler never terminates, due to infinite loops, deadlock, livelock, etc."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2019-09-24T08:21:19Z", "updated_at": "2019-09-24T21:44:15Z", "closed_at": "2019-09-24T21:44:15Z", "author_association": "NONE", "active_lock_reason": null, "body": "I am distributing `rust 1.37.0` (obtained through `rustup`) inside of an Alpine linux-based container for cross-compiling software for a large number target architectures.  While I have successfully managed to install `rustc` in such a way that I can compile (using `rustc --target=${RUST_TRIPLET} -C linker=${TRIPLET}-gcc -o hello hello.rs`) for all the different architectures I want, I have noticed that if I pass `--emit` to `rustc`, (even just `--emit=link`, which I believe should be the default) it freezes, spinning forever.\r\n\r\nI have been unable to determine why this freezing occurs when `--emit` is passed but doesn't occur when it's omitted.  Running `rustc` within `gdb` gives some hints that something is going wrong, but not many:\r\n\r\n```\r\nsandbox:${WORKSPACE}/hello # gdb --args /opt/x86_64-linux-gnu/bin/rustc --target=x86_64-unknown-linux-gnu -C linker=x86_64-linux-gnu-gcc src/main.rs --emit=link\r\nReading symbols from /opt/x86_64-linux-gnu/bin/rustc...done.\r\n(gdb) r\r\nStarting program: /opt/x86_64-linux-gnu/bin/rustc --target=x86_64-unknown-linux-gnu -C linker=x86_64-linux-gnu-gcc src/main.rs --emit=link\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib64/libthread_db.so.1\".\r\nprocess 182 is executing new program: /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/rustc\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib64/libthread_db.so.1\".\r\n[New Thread 0x7fffef7ff700 (LWP 186)]\r\n^C\r\nThread 1 \"rustc\" received signal SIGINT, Interrupt.\r\n0x00007ffff759c92d in __GI___pthread_timedjoin_ex (threadid=140737211528960, thread_return=0x0, abstime=0x0, block=<optimized out>) at pthread_join_common.c:89\r\n89      pthread_join_common.c: No such file or directory.\r\n```\r\n\r\nThere are two running threads:\r\n```\r\n(gdb) info threads\r\n  Id   Target Id                               Frame\r\n* 1    Thread 0x7ffff7fe1340 (LWP 193) \"rustc\" 0x00007ffff759c92d in __GI___pthread_timedjoin_ex (threadid=140737211528960, thread_return=0x0, abstime=0x0, block=<optimized out>)\r\n    at pthread_join_common.c:89\r\n  2    Thread 0x7fffef7ff700 (LWP 197) \"rustc\" 0x00007ffff7df24b4 in __libc_read (fd=5, buf=0x7fffef7f1080, nbytes=254) at ../sysdeps/unix/sysv/linux/read.c:27\r\n```\r\n\r\nThe first is stuck here:\r\n```\r\n(gdb) bt\r\n#0  0x00007ffff759c92d in __GI___pthread_timedjoin_ex (threadid=140737211528960, thread_return=0x0, abstime=0x0, block=<optimized out>) at pthread_join_common.c:89\r\n#1  0x00007ffff782a22d in std::sys::unix::thread::Thread::join () at src/libstd/sys/unix/thread.rs:165\r\n#2  0x00007ffff7aec4f3 in std::thread::JoinHandle<T>::join () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/librustc_driver-1aa233c0fa499347.so\r\n#3  0x00007ffff7ad9557 in rustc_interface::util::spawn_thread_pool () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/librustc_driver-1aa233c0fa499347.so\r\n#4  0x00007ffff7b3cbe5 in rustc_driver::run_compiler () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/librustc_driver-1aa233c0fa499347.so\r\n#5  0x00007ffff7b0b8e3 in <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once ()\r\n   from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/librustc_driver-1aa233c0fa499347.so\r\n#6  0x00007ffff7ae70c9 in std::panicking::try::do_call () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/librustc_driver-1aa233c0fa499347.so\r\n#7  0x00007ffff782b48a in __rust_maybe_catch_panic () at src/libpanic_unwind/lib.rs:82\r\n#8  0x00007ffff7b45592 in rustc_driver::report_ices_to_stderr_if_any () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/librustc_driver-1aa233c0fa499347.so\r\n#9  0x00007ffff7b45dec in rustc_driver::main () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/librustc_driver-1aa233c0fa499347.so\r\n#10 0x0000555555559423 in std::rt::lang_start::{{closure}} ()\r\n#11 0x00007ffff781a4e3 in std::rt::lang_start_internal::{{closure}} () at src/libstd/rt.rs:49\r\n#12 std::panicking::try::do_call () at src/libstd/panicking.rs:296\r\n#13 0x00007ffff782b48a in __rust_maybe_catch_panic () at src/libpanic_unwind/lib.rs:82\r\n#14 0x00007ffff781b0ad in std::panicking::try () at src/libstd/panicking.rs:275\r\n#15 std::panic::catch_unwind () at src/libstd/panic.rs:394\r\n#16 std::rt::lang_start_internal () at src/libstd/rt.rs:48\r\n#17 0x0000555555559412 in main ()\r\n(gdb)\r\n```\r\n\r\nThe second is stuck here:\r\n```\r\n(gdb) thread 2\r\n[Switching to thread 2 (Thread 0x7fffef7ff700 (LWP 197))]\r\n#0  0x00007ffff7df24b4 in __libc_read (fd=5, buf=0x7fffef7f1080, nbytes=254) at ../sysdeps/unix/sysv/linux/read.c:27\r\n27      ../sysdeps/unix/sysv/linux/read.c: No such file or directory.\r\n(gdb) bt\r\n#0  0x00007ffff7df24b4 in __libc_read (fd=5, buf=0x7fffef7f1080, nbytes=254) at ../sysdeps/unix/sysv/linux/read.c:27\r\n#1  0x00007ffff7ddd8b3 in validate_lib (fd=fd@entry=5, dynamic_addr=<optimized out>, dynamic_size=<optimized out>) at dl-load.c:1422\r\n#2  0x00007ffff7ddf073 in open_verify (\r\n    name=name@entry=0x7fffef7f1250 \"/opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/../lib/libLLVM-8-rust-1.37.0-stable.so\",\r\n    fbp=fbp@entry=0x7fffef7f14e0, loader=loader@entry=0x7fffed2b5000, whatcode=whatcode@entry=4, mode=mode@entry=-2147483648, found_other_class=found_other_class@entry=0x7fffef7f14cf, free_name=false,\r\n    fd=5) at dl-load.c:1748\r\n#3  0x00007ffff7ddf63d in open_path (name=name@entry=0x7fffecc9861b \"libLLVM-8-rust-1.37.0-stable.so\", namelen=namelen@entry=32, mode=mode@entry=-2147483648, sps=0x7fffed2b5318,\r\n    realname=realname@entry=0x7fffef7f14d0, fbp=fbp@entry=0x7fffef7f14e0, loader=0x7fffed2b5000, whatcode=4, found_other_class=0x7fffef7f14cf) at dl-load.c:1824\r\n#4  0x00007ffff7de0fe9 in _dl_map_object (loader=0x7fffed2b5000, name=0x7fffecc9861b \"libLLVM-8-rust-1.37.0-stable.so\", type=2, trace_mode=0, mode=<optimized out>, nsid=<optimized out>) at dl-load.c:2037\r\n#5  0x00007ffff7de5132 in openaux (a=a@entry=0x7fffef7f1d10) at dl-deps.c:63\r\n#6  0x00007ffff6eff18c in __GI__dl_catch_exception (exception=0x7fffef7f1cf0, operate=0x7ffff7de5100 <openaux>, args=0x7fffef7f1d10) at dl-error-skeleton.c:196\r\n#7  0x00007ffff7de5350 in _dl_map_object_deps (map=map@entry=0x7fffed2b5000, preloads=preloads@entry=0x0, npreloads=npreloads@entry=0, trace_mode=trace_mode@entry=0,\r\n    open_mode=open_mode@entry=-2147483648) at dl-deps.c:249\r\n#8  0x00007ffff7deb044 in dl_open_worker (a=a@entry=0x7fffef7f1f50) at dl-open.c:267\r\n#9  0x00007ffff6eff18c in __GI__dl_catch_exception (exception=0x7fffef7f1f30, operate=0x7ffff7deaf40 <dl_open_worker>, args=0x7fffef7f1f50) at dl-error-skeleton.c:196\r\n#10 0x00007ffff7deab9a in _dl_open (\r\n    file=0x7fffed2980a0 \"/opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\", mode=-2147483647,\r\n    caller_dlopen=0x7ffff552aff0 <rustc_metadata::dynamic_lib::DynamicLibrary::open+320>, nsid=<optimized out>, argc=6, argv=<optimized out>, env=0x7fffffffdb10) at dl-open.c:594\r\n#11 0x00007ffff7390f26 in dlopen_doit (a=a@entry=0x7fffef7f2180) at dlopen.c:66\r\n#12 0x00007ffff6eff18c in __GI__dl_catch_exception (exception=exception@entry=0x7fffef7f2120, operate=0x7ffff7390ed0 <dlopen_doit>, args=0x7fffef7f2180) at dl-error-skeleton.c:196\r\n#13 0x00007ffff6eff1ff in __GI__dl_catch_error (objname=0x7fffed200070, errstring=0x7fffed200078, mallocedp=0x7fffed200068, operate=<optimized out>, args=<optimized out>) at dl-error-skeleton.c:215\r\n#14 0x00007ffff7391565 in _dlerror_run (operate=operate@entry=0x7ffff7390ed0 <dlopen_doit>, args=args@entry=0x7fffef7f2180) at dlerror.c:162\r\n#15 0x00007ffff7390fc1 in __dlopen (file=<optimized out>, mode=<optimized out>) at dlopen.c:87\r\n#16 0x00007ffff552aff0 in rustc_metadata::dynamic_lib::DynamicLibrary::open ()\r\n   from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/../lib/librustc_metadata-f289cf194b04b3f9.so\r\n#17 0x00007ffff6ad72cb in rustc_interface::util::load_backend_from_dylib () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/../lib/librustc_interface-7691d2a4317831ca.so\r\n#18 0x00007ffff6ad80f1 in rustc_interface::util::get_codegen_sysroot () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/../lib/librustc_interface-7691d2a4317831ca.so\r\n#19 0x00007ffff6b17ec7 in std::sync::once::Once::call_once::{{closure}} () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/../lib/librustc_interface-7691d2a4317831ca.so\r\n#20 0x00007ffff7815b54 in std::sync::once::Once::call_inner () at src/libstd/sync/once.rs:392\r\n#21 0x00007ffff6ad6b6a in rustc_interface::util::create_session () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/../lib/librustc_interface-7691d2a4317831ca.so\r\n#22 0x00007ffff7ae97b3 in rustc_interface::interface::run_compiler_in_existing_thread_pool ()\r\n   from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/librustc_driver-1aa233c0fa499347.so\r\n#23 0x00007ffff7b0cd42 in std::thread::local::LocalKey<T>::with () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/librustc_driver-1aa233c0fa499347.so\r\n#24 0x00007ffff7b20891 in scoped_tls::ScopedKey<T>::set () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/librustc_driver-1aa233c0fa499347.so\r\n#25 0x00007ffff7b388b4 in syntax::with_globals () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/librustc_driver-1aa233c0fa499347.so\r\n#26 0x00007ffff7b63b1d in std::sys_common::backtrace::__rust_begin_short_backtrace () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/librustc_driver-1aa233c0fa499347.so\r\n#27 0x00007ffff782b48a in __rust_maybe_catch_panic () at src/libpanic_unwind/lib.rs:82\r\n#28 0x00007ffff7aeccc9 in core::ops::function::FnOnce::call_once{{vtable-shim}} () from /opt/x86_64-linux-gnu/toolchains/stable-x86_64-unknown-linux-gnu/bin/../lib/librustc_driver-1aa233c0fa499347.so\r\n#29 0x00007ffff77fde0f in <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once () at /rustc/eae3437dfe991621e8afdc82734f4a172d7ddf9b/src/liballoc/boxed.rs:746\r\n#30 0x00007ffff782a170 in <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once () at /rustc/eae3437dfe991621e8afdc82734f4a172d7ddf9b/src/liballoc/boxed.rs:746\r\n#31 std::sys_common::thread::start_thread () at src/libstd/sys_common/thread.rs:13\r\n#32 std::sys::unix::thread::Thread::new::thread_start () at src/libstd/sys/unix/thread.rs:79\r\n#33 0x00007ffff759b507 in start_thread (arg=0x7fffef7ff700) at pthread_create.c:463\r\n#34 0x00007ffff6ec657f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95\r\n```\r\n\r\nNote that there are a few peculiarities about the system it's running inside of:\r\n\r\n* This is a dual-libc system; it has both `musl` and `glibc` installed side-by-side, with patches applied to `glibc` to allow for intelligent dynamic loading of dependencies (to reject selection of dependencies that link against `musl`).\r\n\r\n* This is a single-user system, as all Alpine-based systems are.\r\n\r\n* The `rust` installation has had things like its `doc` and `man` pages deleted, to save space.  Running this within `strace` doesn't show any attempts to load these files, but I figured I might as well point out that I've tried to trim things down so that's clear from the beginning, in case it is relevant later.", "closed_by": {"login": "staticfloat", "id": 130920, "node_id": "MDQ6VXNlcjEzMDkyMA==", "avatar_url": "https://avatars.githubusercontent.com/u/130920?v=4", "gravatar_id": "", "url": "https://api.github.com/users/staticfloat", "html_url": "https://github.com/staticfloat", "followers_url": "https://api.github.com/users/staticfloat/followers", "following_url": "https://api.github.com/users/staticfloat/following{/other_user}", "gists_url": "https://api.github.com/users/staticfloat/gists{/gist_id}", "starred_url": "https://api.github.com/users/staticfloat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/staticfloat/subscriptions", "organizations_url": "https://api.github.com/users/staticfloat/orgs", "repos_url": "https://api.github.com/users/staticfloat/repos", "events_url": "https://api.github.com/users/staticfloat/events{/privacy}", "received_events_url": "https://api.github.com/users/staticfloat/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/64729/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/64729/timeline", "performed_via_github_app": null, "state_reason": "completed"}