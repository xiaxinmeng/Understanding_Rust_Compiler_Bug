{"url": "https://api.github.com/repos/rust-lang/rust/issues/104625", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/104625/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/104625/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/104625/events", "html_url": "https://github.com/rust-lang/rust/issues/104625", "id": 1456728991, "node_id": "I_kwDOAAsO6M5W0-uf", "number": 104625, "title": "DW_AT_discr_value elided in DWARF for some enum variants", "user": {"login": "bcantrill", "id": 328614, "node_id": "MDQ6VXNlcjMyODYxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/328614?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bcantrill", "html_url": "https://github.com/bcantrill", "followers_url": "https://api.github.com/users/bcantrill/followers", "following_url": "https://api.github.com/users/bcantrill/following{/other_user}", "gists_url": "https://api.github.com/users/bcantrill/gists{/gist_id}", "starred_url": "https://api.github.com/users/bcantrill/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bcantrill/subscriptions", "organizations_url": "https://api.github.com/users/bcantrill/orgs", "repos_url": "https://api.github.com/users/bcantrill/repos", "events_url": "https://api.github.com/users/bcantrill/events{/privacy}", "received_events_url": "https://api.github.com/users/bcantrill/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2022-11-20T01:37:08Z", "updated_at": "2022-11-29T09:50:16Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a regression report! \ud83d\udc1b A regression is something that changed between versions of Rust but was not supposed to.\r\n\r\nPlease provide a short summary of the regression, along with any information you feel is relevant to replicate it.\r\n-->\r\n\r\n### Code\r\n\r\nThere is a regression from 1.64.0 to 1.65.0 in the DWARF emitted for some variants for some enums, as the below program shows:\r\n\r\n```rust\r\n#[repr(u32)]\r\npub enum DontKnowWhyThisIsNeededButItIs {\r\n    Blargh,\r\n}\r\n\r\n//\r\n// When compiled on 1.65.0 or later, the `ThisIsBad` variant in the below\r\n// `Foo` enum does not have a `DW_AT_discr_value` in the DWARF, as displayed\r\n// by `dwarfdump`:\r\n//\r\n//\r\n// ```\r\n// ...\r\n// < 2><0x00000049>      DW_TAG_structure_type\r\n//                         DW_AT_name                  Foo\r\n//                         DW_AT_byte_size             0x0000000c\r\n//                         DW_AT_alignment             0x00000004\r\n// < 3><0x00000050>        DW_TAG_variant_part\r\n//                           DW_AT_discr                 <0x00000055>\r\n// < 4><0x00000055>          DW_TAG_member\r\n//                             DW_AT_type                  <0x00000180>\r\n//                             DW_AT_alignment             0x00000004\r\n//                             DW_AT_data_member_location  0\r\n//                             DW_AT_artificial            yes(1)\r\n// < 4><0x0000005c>          DW_TAG_variant\r\n//                             DW_AT_discr_value           1\r\n// < 5><0x0000005e>            DW_TAG_member\r\n//                               DW_AT_name                  ThisIsFine\r\n//                               DW_AT_type                  <0x00000094>\r\n//                               DW_AT_alignment             0x00000004\r\n//                               DW_AT_data_member_location  0\r\n// < 4><0x0000006a>          DW_TAG_variant\r\n// < 5><0x0000006b>            DW_TAG_member\r\n//                               DW_AT_name                  ThisIsBad\r\n//                               DW_AT_type                  <0x0000009b>\r\n//                               DW_AT_alignment             0x00000004\r\n//                               DW_AT_data_member_location  0\r\n// < 4><0x00000077>          DW_TAG_variant\r\n//                             DW_AT_discr_value           3\r\n// < 5><0x00000079>            DW_TAG_member\r\n//                               DW_AT_name                  ThisIsAlsoFine\r\n//                               DW_AT_type                  <0x000000b9>\r\n//                               DW_AT_alignment             0x00000004\r\n//                               DW_AT_data_member_location  0\r\n// < 4><0x00000085>          DW_TAG_variant\r\n//                             DW_AT_discr_value           4\r\n// < 5><0x00000087>            DW_TAG_member\r\n//                               DW_AT_name                  ThisIsFineToo\r\n//                               DW_AT_type                  <0x000000cc>\r\n//                               DW_AT_alignment             0x00000004\r\n//                               DW_AT_data_member_location  0\r\n// ...\r\n// ```\r\n//\r\n// By contrast, when compiled on 1.64.0, all variants have a\r\n// `DW_AT_discr_value` as expected:\r\n//\r\n// ```\r\n// ...\r\n// < 2><0x00000049>      DW_TAG_structure_type\r\n//                         DW_AT_name                  Foo\r\n//                         DW_AT_byte_size             0x0000000c\r\n//                         DW_AT_alignment             0x00000004\r\n// < 3><0x00000050>        DW_TAG_variant_part\r\n//                           DW_AT_discr                 <0x00000055>\r\n// < 4><0x00000055>          DW_TAG_member\r\n//                             DW_AT_type                  <0x00000181>\r\n//                             DW_AT_alignment             0x00000001\r\n//                             DW_AT_data_member_location  0\r\n//                             DW_AT_artificial            yes(1)\r\n// < 4><0x0000005c>          DW_TAG_variant\r\n//                             DW_AT_discr_value           0\r\n// < 5><0x0000005e>            DW_TAG_member\r\n//                               DW_AT_name                  ThisIsFine\r\n//                               DW_AT_type                  <0x00000095>\r\n//                               DW_AT_alignment             0x00000004\r\n//                               DW_AT_data_member_location  0\r\n// < 4><0x0000006a>          DW_TAG_variant\r\n//                             DW_AT_discr_value           1\r\n// < 5><0x0000006c>            DW_TAG_member\r\n//                               DW_AT_name                  ThisIsBad\r\n//                               DW_AT_type                  <0x0000009c>\r\n//                               DW_AT_alignment             0x00000004\r\n//                               DW_AT_data_member_location  0\r\n// < 4><0x00000078>          DW_TAG_variant\r\n//                             DW_AT_discr_value           2\r\n// < 5><0x0000007a>            DW_TAG_member\r\n//                               DW_AT_name                  ThisIsAlsoFine\r\n//                               DW_AT_type                  <0x000000ba>\r\n//                               DW_AT_alignment             0x00000004\r\n//                               DW_AT_data_member_location  0\r\n// < 4><0x00000086>          DW_TAG_variant\r\n//                             DW_AT_discr_value           3\r\n// < 5><0x00000088>            DW_TAG_member\r\n//                               DW_AT_name                  ThisIsFineToo\r\n//                               DW_AT_type                  <0x000000cd>\r\n//                               DW_AT_alignment             0x00000004\r\n//                               DW_AT_data_member_location  0\r\n// ...\r\n// ```\r\n// \r\n// Note that this is pretty squirrely; if the `#[repr(u32)]` is absent on the\r\n// `DontKnowWhyThisIsNeededButItIs` enum (for example), the `ThisIsBad` member\r\n// will correctly have a `DW_AT_discr_value` -- as it will if the\r\n// `DontKnowWhyThisIsNeededButItIs` is absent entirely, or if the first tuple\r\n// has fewer than 5 elements.  Finally (and perhaps most vexing?) it will also\r\n// be chased away if there is a second variant that has the identical signature\r\n// as `ThisIsBad` -- in which case all variants will correctly have a\r\n// `DW_AT_discr_value`.\r\n//\r\npub enum Foo {\r\n    ThisIsFine,\r\n    ThisIsBad(\r\n        (u8, u8, u8, u8, u8),\r\n        DontKnowWhyThisIsNeededButItIs,\r\n    ),\r\n    ThisIsAlsoFine(\r\n        (u8, u8, u8, u8, u8),\r\n    ),\r\n    ThisIsFineToo(\r\n        (u8, u8, u8, u8),\r\n        DontKnowWhyThisIsNeededButItIs,\r\n    ),\r\n    ThisIsMaybeFine(\r\n        (u8, u8, u8, u8),\r\n        DontKnowWhyThisIsNeededButItIs,\r\n    ),\r\n}\r\n\r\n#[allow(dead_code)]\r\nstatic QUUX: Option<Foo> = None;\r\n\r\nfn main() {}\r\n\r\n```\r\n\r\n### Version it worked on\r\n\r\nAs the comment in the program indicates, the DWARF for the `Foo` enum looks like this on 1.64.0 and earlier:\r\n\r\n```\r\n< 2><0x00000049>      DW_TAG_structure_type\r\n                        DW_AT_name                  Foo\r\n                        DW_AT_byte_size             0x0000000c\r\n                        DW_AT_alignment             0x00000004\r\n< 3><0x00000050>        DW_TAG_variant_part\r\n                          DW_AT_discr                 <0x00000055>\r\n< 4><0x00000055>          DW_TAG_member\r\n                            DW_AT_type                  <0x00000181>\r\n                            DW_AT_alignment             0x00000001\r\n                            DW_AT_data_member_location  0\r\n                            DW_AT_artificial            yes(1)\r\n< 4><0x0000005c>          DW_TAG_variant\r\n                            DW_AT_discr_value           0\r\n< 5><0x0000005e>            DW_TAG_member\r\n                              DW_AT_name                  ThisIsFine\r\n                              DW_AT_type                  <0x00000095>\r\n                              DW_AT_alignment             0x00000004\r\n                              DW_AT_data_member_location  0\r\n< 4><0x0000006a>          DW_TAG_variant\r\n                            DW_AT_discr_value           1\r\n< 5><0x0000006c>            DW_TAG_member\r\n                              DW_AT_name                  ThisIsBad\r\n                              DW_AT_type                  <0x0000009c>\r\n                              DW_AT_alignment             0x00000004\r\n                              DW_AT_data_member_location  0\r\n< 4><0x00000078>          DW_TAG_variant\r\n                            DW_AT_discr_value           2\r\n< 5><0x0000007a>            DW_TAG_member\r\n                              DW_AT_name                  ThisIsAlsoFine\r\n                              DW_AT_type                  <0x000000ba>\r\n                              DW_AT_alignment             0x00000004\r\n                              DW_AT_data_member_location  0\r\n< 4><0x00000086>          DW_TAG_variant\r\n                            DW_AT_discr_value           3\r\n< 5><0x00000088>            DW_TAG_member\r\n                              DW_AT_name                  ThisIsFineToo\r\n                              DW_AT_type                  <0x000000cd>\r\n                              DW_AT_alignment             0x00000004\r\n                              DW_AT_data_member_location  0\r\n```\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.64.0 (a55dd71d5 2022-09-19)\r\nbinary: rustc\r\ncommit-hash: a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52\r\ncommit-date: 2022-09-19\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.64.0\r\nLLVM version: 14.0.6\r\n```\r\n\r\n### Version with regression\r\n\r\nBut on 1.65.0 and later, it looks like this:\r\n\r\n```\r\n< 2><0x00000049>      DW_TAG_structure_type\r\n                        DW_AT_name                  Foo\r\n                        DW_AT_byte_size             0x0000000c\r\n                        DW_AT_alignment             0x00000004\r\n< 3><0x00000050>        DW_TAG_variant_part\r\n                          DW_AT_discr                 <0x00000055>\r\n< 4><0x00000055>          DW_TAG_member\r\n                            DW_AT_type                  <0x00000180>\r\n                            DW_AT_alignment             0x00000004\r\n                            DW_AT_data_member_location  0\r\n                            DW_AT_artificial            yes(1)\r\n< 4><0x0000005c>          DW_TAG_variant\r\n                            DW_AT_discr_value           1\r\n< 5><0x0000005e>            DW_TAG_member\r\n                              DW_AT_name                  ThisIsFine\r\n                              DW_AT_type                  <0x00000094>\r\n                              DW_AT_alignment             0x00000004\r\n                              DW_AT_data_member_location  0\r\n< 4><0x0000006a>          DW_TAG_variant\r\n< 5><0x0000006b>            DW_TAG_member\r\n                              DW_AT_name                  ThisIsBad\r\n                              DW_AT_type                  <0x0000009b>\r\n                              DW_AT_alignment             0x00000004\r\n                              DW_AT_data_member_location  0\r\n< 4><0x00000077>          DW_TAG_variant\r\n                            DW_AT_discr_value           3\r\n< 5><0x00000079>            DW_TAG_member\r\n                              DW_AT_name                  ThisIsAlsoFine\r\n                              DW_AT_type                  <0x000000b9>\r\n                              DW_AT_alignment             0x00000004\r\n                              DW_AT_data_member_location  0\r\n< 4><0x00000085>          DW_TAG_variant\r\n                            DW_AT_discr_value           4\r\n< 5><0x00000087>            DW_TAG_member\r\n                              DW_AT_name                  ThisIsFineToo\r\n                              DW_AT_type                  <0x000000cc>\r\n                              DW_AT_alignment             0x00000004\r\n                              DW_AT_data_member_location  0\r\n```\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.65.0 (897e37553 2022-11-02)\r\nbinary: rustc\r\ncommit-hash: 897e37553bba8b42751c67658967889d11ecd120\r\ncommit-date: 2022-11-02\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.65.0\r\nLLVM version: 15.0.0\r\n```\r\n\r\nUnsurprisingly, there is an LLVM version bump across these two versions.\r\n\r\nIf it helps to have context about how we hit this, we saw this in the debugger (Humility) for our embedded Rust operating system (Hubris); see https://github.com/oxidecomputer/humility/issues/263 for details.\r\n\r\nThanks in advance to anyone who looks at this -- the DWARF emitted by Rust has been invaluable for our work!\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/104625/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/104625/timeline", "performed_via_github_app": null, "state_reason": null}