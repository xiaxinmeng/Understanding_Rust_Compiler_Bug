{"url": "https://api.github.com/repos/rust-lang/rust/issues/44961", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/44961/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/44961/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/44961/events", "html_url": "https://github.com/rust-lang/rust/issues/44961", "id": 261933525, "node_id": "MDU6SXNzdWUyNjE5MzM1MjU=", "number": 44961, "title": "Lifetime of dependent type cannot depend on the function", "user": {"login": "uzytkownik", "id": 5706, "node_id": "MDQ6VXNlcjU3MDY=", "avatar_url": "https://avatars.githubusercontent.com/u/5706?v=4", "gravatar_id": "", "url": "https://api.github.com/users/uzytkownik", "html_url": "https://github.com/uzytkownik", "followers_url": "https://api.github.com/users/uzytkownik/followers", "following_url": "https://api.github.com/users/uzytkownik/following{/other_user}", "gists_url": "https://api.github.com/users/uzytkownik/gists{/gist_id}", "starred_url": "https://api.github.com/users/uzytkownik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/uzytkownik/subscriptions", "organizations_url": "https://api.github.com/users/uzytkownik/orgs", "repos_url": "https://api.github.com/users/uzytkownik/repos", "events_url": "https://api.github.com/users/uzytkownik/events{/privacy}", "received_events_url": "https://api.github.com/users/uzytkownik/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-10-01T17:55:52Z", "updated_at": "2018-01-22T20:08:40Z", "closed_at": "2018-01-22T20:08:40Z", "author_association": "NONE", "active_lock_reason": null, "body": "(This might be partially related to issue #44950)\r\n\r\nCurrently dependent types lifetime must not depend on the lifetime of the iterator. This is problematic when the method of iteration might alter the structure but copy is expensive or impossible (I run into this while binding C API but this affects also database cursors etc.).\r\n\r\nHere's an example of code which shows the issue (`[u8; 4096]` is just an example of expensive-to-copy data).\r\n\r\n```rust\r\nstruct Handle {\r\n    buf: *mut [u8; 4096]\r\n}\r\n\r\nstruct Iter {\r\n    buf: Box<[u8; 4096]>,\r\n    hnd: Handle\r\n}\r\n\r\nunsafe fn fake_c_method_init(buf: *mut [u8; 4096]) -> Handle {\r\n    Handle {\r\n        buf: buf\r\n    }\r\n}\r\n\r\nunsafe fn fake_c_method_next(hnd: &mut Handle) -> bool {\r\n    (*hnd.buf)[0] += 1;\r\n    true\r\n}\r\n\r\nimpl Iter {\r\n    fn new() -> Self {\r\n        use std::borrow::BorrowMut;\r\n        let mut buf = Box::new([0; 4096]);\r\n        let hnd = unsafe {\r\n            fake_c_method_init(buf.borrow_mut() as *mut [u8; 4096])\r\n        };\r\n        Iter {\r\n            buf: buf,\r\n            hnd: hnd\r\n        }\r\n    }\r\n\r\n    fn next_fast(&mut self) -> Option<&[u8; 4096]> {\r\n        use std::borrow::Borrow;\r\n        if unsafe {fake_c_method_next(&mut self.hnd)} {\r\n            Some(self.buf.borrow())\r\n        } else {\r\n            None\r\n        }\r\n    }\r\n}\r\n\r\nimpl Iterator for Iter {\r\n    type Item = [u8; 4096];\r\n    fn next(&mut self) -> Option<Self::Item> {\r\n        self.next_fast().map(|arr| {\r\n            let mut res = [0; 4096];\r\n            for i in 0..4096 {\r\n                res[i] = arr[i];\r\n            }\r\n            res\r\n        })\r\n    }\r\n}\r\n```\r\n\r\nThis is even though in most cases a copy is not needed.", "closed_by": {"login": "XAMPPRocky", "id": 4464295, "node_id": "MDQ6VXNlcjQ0NjQyOTU=", "avatar_url": "https://avatars.githubusercontent.com/u/4464295?v=4", "gravatar_id": "", "url": "https://api.github.com/users/XAMPPRocky", "html_url": "https://github.com/XAMPPRocky", "followers_url": "https://api.github.com/users/XAMPPRocky/followers", "following_url": "https://api.github.com/users/XAMPPRocky/following{/other_user}", "gists_url": "https://api.github.com/users/XAMPPRocky/gists{/gist_id}", "starred_url": "https://api.github.com/users/XAMPPRocky/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/XAMPPRocky/subscriptions", "organizations_url": "https://api.github.com/users/XAMPPRocky/orgs", "repos_url": "https://api.github.com/users/XAMPPRocky/repos", "events_url": "https://api.github.com/users/XAMPPRocky/events{/privacy}", "received_events_url": "https://api.github.com/users/XAMPPRocky/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/44961/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/44961/timeline", "performed_via_github_app": null, "state_reason": "completed"}