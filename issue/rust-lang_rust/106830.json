{"url": "https://api.github.com/repos/rust-lang/rust/issues/106830", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/106830/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/106830/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/106830/events", "html_url": "https://github.com/rust-lang/rust/issues/106830", "id": 1533067772, "node_id": "I_kwDOAAsO6M5bYMH8", "number": 106830, "title": "Embedded projects using `synopsys-usb-otg` are hanging in Beta/Nightly", "user": {"login": "antonok-edm", "id": 22821309, "node_id": "MDQ6VXNlcjIyODIxMzA5", "avatar_url": "https://avatars.githubusercontent.com/u/22821309?v=4", "gravatar_id": "", "url": "https://api.github.com/users/antonok-edm", "html_url": "https://github.com/antonok-edm", "followers_url": "https://api.github.com/users/antonok-edm/followers", "following_url": "https://api.github.com/users/antonok-edm/following{/other_user}", "gists_url": "https://api.github.com/users/antonok-edm/gists{/gist_id}", "starred_url": "https://api.github.com/users/antonok-edm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/antonok-edm/subscriptions", "organizations_url": "https://api.github.com/users/antonok-edm/orgs", "repos_url": "https://api.github.com/users/antonok-edm/repos", "events_url": "https://api.github.com/users/antonok-edm/events{/privacy}", "received_events_url": "https://api.github.com/users/antonok-edm/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 262252628, "node_id": "MDU6TGFiZWwyNjIyNTI2Mjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-beta", "name": "regression-from-stable-to-beta", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to beta."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2023-01-14T00:47:38Z", "updated_at": "2023-01-14T13:31:46Z", "closed_at": "2023-01-14T01:31:07Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a regression report! \ud83d\udc1b A regression is something that changed between versions of Rust but was not supposed to.\r\n\r\nPlease provide a short summary of the regression, along with any information you feel is relevant to replicate it.\r\n-->\r\n\r\n### Code\r\n\r\nI tried this code:\r\n\r\n`Cargo.toml`\r\n```toml\r\n[dependencies]\r\nstm32f4xx-hal = { version = \"0.13\", features = [\"rt\", \"stm32f401\", \"usb_fs\"] }\r\nembedded-hal = \"^ 0.2.6\"\r\ncortex-m = { version = \"^ 0.7\" }\r\ncortex-m-rt = { version = \"^ 0.7\", features = [\"device\"] }\r\nusb-device = \"^ 0.2\"\r\n```\r\n\r\ntoolchain: `thumbv7em-none-eabihf`\r\n\r\n`main.rs`\r\n```rust\r\n#![no_main]\r\n#![no_std]\r\n \r\nuse stm32f4xx_hal::{\r\n    otg_fs::{ USB as Peripheral, UsbBus },\r\n    pac::Peripherals,\r\n    prelude::*,\r\n};\r\n \r\nuse usb_device::{\r\n    bus::UsbBusAllocator,\r\n    prelude::*,\r\n};\r\n \r\n#[entry]\r\nfn main() -> ! {\r\n    const SYS_CLOCK_MHZ: u32 = 84;\r\n \r\n    const VID: u16 = 0x1337;\r\n    const PID: u16 = 0x1337;\r\n    const MANUFACTURER_NAME: &str = \"test\";\r\n    const PRODUCT_NAME: &str = \"test\";\r\n \r\n    static mut EP_MEMORY: [u32; 1024] = [0; 1024];\r\n \r\n    let device = Peripherals::take().unwrap();\r\n    let rcc = device.RCC.constrain();\r\n \r\n    let clocks = rcc.cfgr\r\n        .use_hse(25.MHz())\r\n        .sysclk(SYS_CLOCK_MHZ.MHz())\r\n        .require_pll48clk()\r\n        .freeze();\r\n    assert!(clocks.is_pll48clk_valid());\r\n \r\n    let gpioa = device.GPIOA.split();\r\n \r\n    let usb = stm32f4xx_hal::otg_fs::USB {\r\n        usb_global: device.OTG_FS_GLOBAL,\r\n        usb_device: device.OTG_FS_DEVICE,\r\n        usb_pwrclk: device.OTG_FS_PWRCLK,\r\n        pin_dm: gpioa.pa11.into_alternate(),\r\n        pin_dp: gpioa.pa12.into_alternate(),\r\n        hclk: clocks.hclk(),\r\n    };\r\n \r\n    let usb_allocator: UsbBusAllocator<UsbBus<Peripheral>>;\r\n \r\n    usb_allocator = UsbBus::new(usb, unsafe { &mut EP_MEMORY });\r\n \r\n    // Any code following this assignment never runs on Beta or Nightly\r\n    let usb_bus = UsbDeviceBuilder::new(&usb_allocator, UsbVidPid(VID, PID))\r\n        .manufacturer(MANUFACTURER_NAME)\r\n        .product(PRODUCT_NAME)\r\n        .device_class(0x00)\r\n        .build();\r\n \r\n    // activate a peripheral of your choice here to demonstrate\r\n}\r\n```\r\n\r\nI expected to see this happen: the peripheral activation at the end should occur\r\n\r\nInstead, this happened: the program hangs indefinitely\r\n\r\n### Version it worked on\r\n\r\n<!--\r\nProvide the most recent version this worked on, for example:\r\n\r\nIt most recently worked on: Rust 1.47\r\n-->\r\n\r\nIt most recently worked on: Rust 1.66.1\r\n\r\n### Version with regression\r\n\r\n<!--\r\nProvide the version you are using that has the regression.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.67.0-beta.7 (275123cf6 2023-01-11)\r\nbinary: rustc\r\ncommit-hash: 275123cf608aad2c3b48c7a53b019430244e4574\r\ncommit-date: 2023-01-11\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.67.0-beta.7\r\nLLVM version: 15.0.6\r\n```\r\n\r\n<!--\r\nIf you know when this regression occurred, please add a line like below, replacing `{channel}` with one of stable, beta, or nightly.\r\n\r\n@rustbot modify labels: +regression-from-stable-to-beta -regression-untriaged\r\n-->\r\n\r\n## More details\r\n\r\nSee also @hacknus's provided examples, investigation, and debugger output at https://github.com/stm32-rs/synopsys-usb-otg/issues/33. I don't have the ability to run a debugger on my hardware, unfortunately.\r\n\r\ncc @adamgreig who has also reproduced the issue.\r\n\r\n### Some bisecting\r\n\r\n`nightly-2022-11-09` does not have the issue\r\n`nightly-2022-11-19` does not have the issue\r\n`nightly-2022-11-21` does not have the issue\r\n`nightly-2022-11-22` does not have the issue\r\n`nightly-2022-11-24` does have the issue", "closed_by": {"login": "antonok-edm", "id": 22821309, "node_id": "MDQ6VXNlcjIyODIxMzA5", "avatar_url": "https://avatars.githubusercontent.com/u/22821309?v=4", "gravatar_id": "", "url": "https://api.github.com/users/antonok-edm", "html_url": "https://github.com/antonok-edm", "followers_url": "https://api.github.com/users/antonok-edm/followers", "following_url": "https://api.github.com/users/antonok-edm/following{/other_user}", "gists_url": "https://api.github.com/users/antonok-edm/gists{/gist_id}", "starred_url": "https://api.github.com/users/antonok-edm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/antonok-edm/subscriptions", "organizations_url": "https://api.github.com/users/antonok-edm/orgs", "repos_url": "https://api.github.com/users/antonok-edm/repos", "events_url": "https://api.github.com/users/antonok-edm/events{/privacy}", "received_events_url": "https://api.github.com/users/antonok-edm/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/106830/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/106830/timeline", "performed_via_github_app": null, "state_reason": "completed"}