{"url": "https://api.github.com/repos/rust-lang/rust/issues/76085", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/76085/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/76085/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/76085/events", "html_url": "https://github.com/rust-lang/rust/issues/76085", "id": 688610117, "node_id": "MDU6SXNzdWU2ODg2MTAxMTc=", "number": 76085, "title": "Segfault in llvm_gcda_start_file in a mixed C++/Rust program", "user": {"login": "Minoru", "id": 118875, "node_id": "MDQ6VXNlcjExODg3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/118875?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Minoru", "html_url": "https://github.com/Minoru", "followers_url": "https://api.github.com/users/Minoru/followers", "following_url": "https://api.github.com/users/Minoru/following{/other_user}", "gists_url": "https://api.github.com/users/Minoru/gists{/gist_id}", "starred_url": "https://api.github.com/users/Minoru/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Minoru/subscriptions", "organizations_url": "https://api.github.com/users/Minoru/orgs", "repos_url": "https://api.github.com/users/Minoru/repos", "events_url": "https://api.github.com/users/Minoru/events{/privacy}", "received_events_url": "https://api.github.com/users/Minoru/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1359848690, "node_id": "MDU6TGFiZWwxMzU5ODQ4Njkw", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-mcve", "name": "E-needs-mcve", "color": "02e10c", "default": false, "description": "Call for participation: This issue needs a Minimal Complete and Verifiable Example"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2020-08-29T21:55:00Z", "updated_at": "2021-03-10T20:24:54Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I have a program where C++ code calls into Rust code. To calculate test coverage, I compile the Rust part with a Nightly, and C++ part with Clang 8. I then run a C++ test suite. This worked fine [until recently](https://travis-ci.com/github/newsboat/newsboat/jobs/375196970), but [now segfaults](https://travis-ci.com/github/newsboat/newsboat/jobs/377355448). C++ test suite receives SIGSEGV while writing out the coverage info:\r\n\r\n```\r\n#0  0x0000000002d26c99 in llvm_gcda_start_file ()\r\n#1  0x00000000015e159d in __llvm_gcov_writeout ()\r\n#2  0x00000000015fa856 in __llvm_gcov_flush ()\r\n#3  0x0000000002d28075 in __gcov_flush ()\r\n#4  0x0000000001020c30 in TestHelpers::TempDir::~TempDir (this=0x7fffffffcbf0) at test/test-helpers/tempdir.cpp:36\r\n#5  0x00000000004e5168 in ____C_A_T_C_H____T_E_S_T____10 () at test/cliargsparser.cpp:90\r\n#6  0x0000000000caf89b in Catch::TestInvokerAsFunction::invoke (this=0x3cd9e40) at ./3rd-party/catch.hpp:14222\r\n#7  0x0000000000ca06bf in Catch::TestCase::invoke (this=0x3d6a248) at ./3rd-party/catch.hpp:14065\r\n#8  0x0000000000ca0500 in Catch::RunContext::invokeActiveTestCase (this=0x7fffffffdb50) at ./3rd-party/catch.hpp:12924\r\n#9  0x0000000000c9d946 in Catch::RunContext::runCurrentTest (this=0x7fffffffdb50, Python Exception <class 'gdb.error'> There is no member named _M_dataplus.:\r\nredirectedCout=, Python Exception <class 'gdb.error'> There is no member named _M_dataplus.:\r\nredirectedCerr=) at ./3rd-party/catch.hpp:12897\r\n#10 0x0000000000c9bb97 in Catch::RunContext::runTest (this=0x7fffffffdb50, testCase=...) at ./3rd-party/catch.hpp:12658\r\n#11 0x0000000000ca6e90 in Catch::(anonymous namespace)::TestGroup::execute (this=0x7fffffffdb40) at ./3rd-party/catch.hpp:13252\r\n#12 0x0000000000ca5510 in Catch::Session::runInternal (this=0x7fffffffdf40) at ./3rd-party/catch.hpp:13458\r\n#13 0x0000000000ca4e23 in Catch::Session::run (this=0x7fffffffdf40) at ./3rd-party/catch.hpp:13414\r\n#14 0x0000000000d8c906 in Catch::Session::run<char> (this=0x7fffffffdf40, argc=1, argv=0x7fffffffe1d8) at ./3rd-party/catch.hpp:13136\r\n#15 0x0000000000cde405 in main (argc=1, argv=0x7fffffffe1d8) at test/test.cpp:12\r\n```\r\n\r\nI observe this behaviour with Clang 8 and 9. With Clang 10, things are simply bizarre: the test suite reports numerous SIGSEGVs and then declares that all tests passed; I can't explain such behaviour. With Clang 11, the test suite passes without issue.\r\n\r\nbisect-rustc narrowed this down to a recent upgrade to LLVM 11:\r\n\r\nsearched nightlies: from nightly-2020-08-23 to nightly-2020-08-29\r\nregressed nightly: nightly-2020-08-24\r\nsearched commits: from https://github.com/rust-lang/rust/commit/663d2f5cd3163f17eddb74ee1e028d542255f21a to https://github.com/rust-lang/rust/commit/5180f3da5fd72627a8d38558ad1297df38793acd\r\nregressed commit: https://github.com/rust-lang/rust/commit/7ce71c362be9a89e7897ac066aba6e3e6f747800\r\n\r\n<details>\r\n<summary>bisected with <a href='https://github.com/rust-lang/cargo-bisect-rustc'>cargo-bisect-rustc</a> v0.5.2</summary>\r\n\r\n\r\nHost triple: x86_64-unknown-linux-gnu\r\nReproduce with:\r\n```bash\r\ncargo bisect-rustc --preserve --with-cargo --host x86_64-unknown-linux-gnu --script ./evaluate.sh\r\n```\r\n</details>\r\n\r\nThe `evaluate.sh` is:\r\n\r\n```sh\r\n#!/bin/sh\r\n\r\nexport CARGO_INCREMENTAL=0\r\nexport RUSTFLAGS='-Zprofile -Ccodegen-units=1 -Copt-level=0 -Coverflow-checks=off -Zpanic_abort_tests -Cpanic=abort'\r\nexport RUSTDOCFLAGS='-Cpanic=abort'\r\nexport CC='clang-8'\r\nexport CXX='clang++-8'\r\n\r\nexport TMPDIR=/dev/shm\r\n\r\nmake distclean\r\nmake -j9 PROFILE=1 test\r\ncd test\r\n./test\r\n```\r\n\r\nThe project in question can be cloned from https://github.com/newsboat/newsboat.git I failed to write a small reproducer: it appears that I do need the Catch2 test framework and a lot of other code to trigger this.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/76085/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/76085/timeline", "performed_via_github_app": null, "state_reason": null}