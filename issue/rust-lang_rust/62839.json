{"url": "https://api.github.com/repos/rust-lang/rust/issues/62839", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/62839/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/62839/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/62839/events", "html_url": "https://github.com/rust-lang/rust/issues/62839", "id": 470719470, "node_id": "MDU6SXNzdWU0NzA3MTk0NzA=", "number": 62839, "title": "DWARF variant metadata for compressed enums with niche is ambiguous", "user": {"login": "Kobzol", "id": 4539057, "node_id": "MDQ6VXNlcjQ1MzkwNTc=", "avatar_url": "https://avatars.githubusercontent.com/u/4539057?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Kobzol", "html_url": "https://github.com/Kobzol", "followers_url": "https://api.github.com/users/Kobzol/followers", "following_url": "https://api.github.com/users/Kobzol/following{/other_user}", "gists_url": "https://api.github.com/users/Kobzol/gists{/gist_id}", "starred_url": "https://api.github.com/users/Kobzol/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Kobzol/subscriptions", "organizations_url": "https://api.github.com/users/Kobzol/orgs", "repos_url": "https://api.github.com/users/Kobzol/repos", "events_url": "https://api.github.com/users/Kobzol/events{/privacy}", "received_events_url": "https://api.github.com/users/Kobzol/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 203130, "node_id": "MDU6TGFiZWwyMDMxMzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-debuginfo", "name": "A-debuginfo", "color": "f7e101", "default": false, "description": "Area: Debugging information in compiled programs (DWARF, PDB, etc.)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1944310735, "node_id": "MDU6TGFiZWwxOTQ0MzEwNzM1", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-layout", "name": "A-layout", "color": "f7e101", "default": false, "description": "Area: Memory layout of types"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 10, "created_at": "2019-07-20T22:15:25Z", "updated_at": "2021-08-16T21:41:11Z", "closed_at": "2021-08-16T21:41:10Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "After the change of DWARF metadata generation for enums (https://github.com/rust-lang/rust/pull/54004), compressed enums with niches are not distinguishable from tagged or empty enums in GDB pretty printing (not in the actual Rust pretty printers, as they do not support the new format yet).\r\n\r\nIn the new enum debug metadata format, enums have a variant field that should serve as a discriminant to pretty print the correct variant of the enum. However, when the Rust enum has a niche discriminant, the variant contains some integer value that has to be interpreted in a special way. Before #54004, compressed enums were marked (https://github.com/rust-lang/rust/blob/master/src/etc/debugger_pretty_printers_common.py#L230 ) and could be distinguished from normal enums. But currently, the variant field has the same name for all kinds of enums and therefore it is not possible to distinguish (and correctly pretty print) compressed enums.\r\n\r\nExample:\r\n```rust\r\nenum MyEnum1<T> { A(T), B }\r\n\r\nfn main()\r\n{\r\n    let a1 = MyEnum1::A(String::from(\"111\"));\r\n    let a2: MyEnum1<String> = MyEnum1::B;\r\n}\r\n```\r\nThis is a niche enum that gets its debug niche value here (https://github.com/rust-lang/rust/blob/master/src/librustc_codegen_llvm/debuginfo/metadata.rs#L1516). \r\n\r\nPrinting this in GDB:\r\n```python\r\n# valobj is the debugged variable\r\ncontent = valobj[valobj.type.fields()[0]]\r\nprint(valobj.type.fields()[0].name, content[content.type.fields()[0]])\r\n```\r\noutputs:\r\n```\r\n<<variant>> 94022087334720 // a1\r\n<<variant>> 0 // a2\r\n```\r\n\r\nAs opposed to a tagged enum:\r\n```rust\r\nlet a1 = MyEnum1::A(5);\r\nlet a2: MyEnum1<u32> = MyEnum1::B;\r\n```\r\nwhich outputs:\r\n```\r\n<<variant>> 0 // a1\r\n<<variant>> 1 // a2\r\n```\r\n\r\nI don't see any way how can I distinguish that this is not a normal enum and that the discriminant has to be handled in a special way. And even if there was such a way, how am I supposed to interpret the discriminant? In the old version the name of the discriminant encoded some metadata that helped to interpret the value (https://github.com/rust-lang/rust/blob/master/src/etc/debugger_pretty_printers_common.py#L289), but there's nothing like that in the new version. Am I missing something?\r\n\r\nI noticed this while modifying enum pretty printers in the IntelliJ Rust plugin (https://github.com/intellij-rust/intellij-rust/issues/4155).\r\n\r\nRelated issues:\r\nhttps://github.com/rust-lang/rust/pull/54004\r\nhttps://github.com/rust-lang/rust/pull/55701\r\nhttps://github.com/rust-lang/rust/issues/59509", "closed_by": {"login": "Kobzol", "id": 4539057, "node_id": "MDQ6VXNlcjQ1MzkwNTc=", "avatar_url": "https://avatars.githubusercontent.com/u/4539057?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Kobzol", "html_url": "https://github.com/Kobzol", "followers_url": "https://api.github.com/users/Kobzol/followers", "following_url": "https://api.github.com/users/Kobzol/following{/other_user}", "gists_url": "https://api.github.com/users/Kobzol/gists{/gist_id}", "starred_url": "https://api.github.com/users/Kobzol/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Kobzol/subscriptions", "organizations_url": "https://api.github.com/users/Kobzol/orgs", "repos_url": "https://api.github.com/users/Kobzol/repos", "events_url": "https://api.github.com/users/Kobzol/events{/privacy}", "received_events_url": "https://api.github.com/users/Kobzol/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/62839/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/62839/timeline", "performed_via_github_app": null, "state_reason": "completed"}