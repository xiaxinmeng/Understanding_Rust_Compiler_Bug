{"url": "https://api.github.com/repos/rust-lang/rust/issues/61097", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/61097/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/61097/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/61097/events", "html_url": "https://github.com/rust-lang/rust/issues/61097", "id": 447861255, "node_id": "MDU6SXNzdWU0NDc4NjEyNTU=", "number": 61097, "title": "Move unit tests into separate files unconfigured during normal build", "user": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 36996, "node_id": "MDU6TGFiZWwzNjk5Ng==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-easy", "name": "E-easy", "color": "02e10c", "default": false, "description": "Call for participation: Experience needed to fix: Easy / not much (good first issue)"}, {"id": 120005, "node_id": "MDU6TGFiZWwxMjAwMDU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-testsuite", "name": "A-testsuite", "color": "f7e101", "default": false, "description": "Area: The testsuite used to check the correctness of rustc"}, {"id": 67766349, "node_id": "MDU6TGFiZWw2Nzc2NjM0OQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-mentor", "name": "E-mentor", "color": "02E10C", "default": false, "description": "Call for participation: This issue has a mentor. Use RustcContributor::new on Zulip for discussion."}, {"id": 325438536, "node_id": "MDU6TGFiZWwzMjU0Mzg1MzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-bootstrap", "name": "T-bootstrap", "color": "bfd4f2", "default": false, "description": "Relevant to the bootstrap subteam: Rust's build system (x.py and src/bootstrap)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 13, "created_at": "2019-05-23T20:35:22Z", "updated_at": "2019-08-02T19:07:33Z", "closed_at": "2019-08-02T19:07:33Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "One of the most annoying parts of compiler refactorings is suddenly discovering that after a refactoring change some code in unit tests stops building.\r\n\r\nCompiler unit tests are mostly old, many of them are not really \"unit\" and need to be migrated to regular ui testing or removed, but that's not the point of *this* issue.\r\nThe point of this issue is that after changing such test you have to restart the bootstrapping process from the crate that unit test belongs to (e.g. touched `libsyntax` -> rebuild everything).\r\n\r\nHow to fight this problem?\r\nExclude unit tests from the normal build!\r\n\r\nFiles included from under `cfg(FALSE)` are not considered crate dependencies from build system point of view (not included into dep files).\r\nSo, unit test modules included in the next way\r\n```\r\n#[cfg(test)]\r\nmod tests;\r\n```\r\nwon't cause rebuilds after changing code in them, they will be rebuilt only as a part of unit test run (so they won't participate in bootstrap).\r\n\r\nSteps:\r\n- Standardize on the test module naming (currently `mod test` - 31 instances, `mod tests` - 183 instances, excluding `src/tools` and `src/test` subdirectories).\r\n- Outline test modules into separate files `mod tests { ... }` -> `#[cfg(test)] mod tests;`.\r\n- Running unit tests for `my_crate`: `./x.py test --stage 0 src/my_crate`.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/61097/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/61097/timeline", "performed_via_github_app": null, "state_reason": "completed"}