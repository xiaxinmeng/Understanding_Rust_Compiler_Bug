{"url": "https://api.github.com/repos/rust-lang/rust/issues/37988", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/37988/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/37988/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/37988/events", "html_url": "https://github.com/rust-lang/rust/issues/37988", "id": 191608572, "node_id": "MDU6SXNzdWUxOTE2MDg1NzI=", "number": 37988, "title": "Failure linking against native Windows libraries in a crate that builds both library and executables", "user": {"login": "StrayLightning", "id": 3532164, "node_id": "MDQ6VXNlcjM1MzIxNjQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3532164?v=4", "gravatar_id": "", "url": "https://api.github.com/users/StrayLightning", "html_url": "https://github.com/StrayLightning", "followers_url": "https://api.github.com/users/StrayLightning/followers", "following_url": "https://api.github.com/users/StrayLightning/following{/other_user}", "gists_url": "https://api.github.com/users/StrayLightning/gists{/gist_id}", "starred_url": "https://api.github.com/users/StrayLightning/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/StrayLightning/subscriptions", "organizations_url": "https://api.github.com/users/StrayLightning/orgs", "repos_url": "https://api.github.com/users/StrayLightning/repos", "events_url": "https://api.github.com/users/StrayLightning/events{/privacy}", "received_events_url": "https://api.github.com/users/StrayLightning/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2016-11-25T01:11:20Z", "updated_at": "2016-11-25T01:37:15Z", "closed_at": "2016-11-25T01:37:15Z", "author_association": "NONE", "active_lock_reason": null, "body": "This problem relates to linking against native libraries on Windows when building multiple targets in a crate.  I am using Rust 1.13.0.\r\n\r\nI have a project which I have just converted from a crate that produces a single executable to one that produces a library (most of the code) and three executables (so that the executables can share the library code.)\r\n\r\nI have prepared a git repo with a demonstration:\r\nhttps://github.com/StrayLightning/problematic\r\n\r\nFor comparison, here is a repo with a crate that builds a single executable, representing my project before the refactor, which works fine:\r\nhttps://github.com/StrayLightning/notproblematic\r\n\r\nThe project links against a static build of OpenHMD, which in turn requires SetupAPI.lib from the Windows SDK to be linked.  The build.rs specifies (on Windows):\r\n\r\n    println!(\"cargo:rustc-link-lib=static=openhmd\");\r\n    println!(\"cargo:rustc-link-lib=static=hidapi\");\r\n    println!(\"cargo:rustc-link-lib=static=setupapi\");\r\n    println!(\"cargo:rustc-link-search=native=./lib-win\");\r\n\r\nProblem 1: When linking the executables the library search paths are correctly specified, but not the libraries from build.rs to link against.  Required entrypoints are therefore missing and the link fails.\r\n\r\nProblem 2: Delete lib-win\\setupapi.lib to see this problem.  When building the library code, Cargo specifies the static libraries to link against, and my local library path, but not the Windows SDK library search paths that it normally does when linking an executable.  So it fails to find the requested SetupAPI.lib from the Windows SDK.\r\n\r\nI have searched for some build.rs or Cargo.toml magic to work around these issues, but to no avail. It seems as if Cargo is not specifying the link libraries and library paths at the right times:\r\n\r\n* When linking an executable, the libraries specified in the build.rs are missing (Problem 1)\r\n* When building the library, the native libraries specified in the build.rs are included but not the normal library path used when linking an executable (Problem 2)\r\n", "closed_by": {"login": "StrayLightning", "id": 3532164, "node_id": "MDQ6VXNlcjM1MzIxNjQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3532164?v=4", "gravatar_id": "", "url": "https://api.github.com/users/StrayLightning", "html_url": "https://github.com/StrayLightning", "followers_url": "https://api.github.com/users/StrayLightning/followers", "following_url": "https://api.github.com/users/StrayLightning/following{/other_user}", "gists_url": "https://api.github.com/users/StrayLightning/gists{/gist_id}", "starred_url": "https://api.github.com/users/StrayLightning/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/StrayLightning/subscriptions", "organizations_url": "https://api.github.com/users/StrayLightning/orgs", "repos_url": "https://api.github.com/users/StrayLightning/repos", "events_url": "https://api.github.com/users/StrayLightning/events{/privacy}", "received_events_url": "https://api.github.com/users/StrayLightning/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/37988/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/37988/timeline", "performed_via_github_app": null, "state_reason": "completed"}