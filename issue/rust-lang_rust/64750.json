{"url": "https://api.github.com/repos/rust-lang/rust/issues/64750", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/64750/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/64750/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/64750/events", "html_url": "https://github.com/rust-lang/rust/issues/64750", "id": 497935792, "node_id": "MDU6SXNzdWU0OTc5MzU3OTI=", "number": 64750, "title": "Parallel compiler jobserver management strategy", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 64037154, "node_id": "MDU6TGFiZWw2NDAzNzE1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compiletime", "name": "I-compiletime", "color": "e11d21", "default": false, "description": "Problems and improvements with respect to compile times."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 1576178387, "node_id": "MDU6TGFiZWwxNTc2MTc4Mzg3", "url": "https://api.github.com/repos/rust-lang/rust/labels/WG-compiler-parallel", "name": "WG-compiler-parallel", "color": "c2e0c6", "default": false, "description": "Working group working on parallelizing the compiler"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2019-09-24T21:34:03Z", "updated_at": "2021-06-27T10:43:49Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "I tested out a full crate build of the Cargo crate graph in release mode with a parallel rustc compiler today but it unfortunately regressed the build time relative to nightly by about 20%! The cause of the regression appears to be an enormous amount of time spent in the kernel, particularly related to jobserver management (although there's some other thread-related stuff in the profile too like waiting on cvars).\r\n\r\nAfter a [brief discussion](https://rust-lang.zulipchat.com/#narrow/stream/187679-t-compiler.2Fwg-parallel-rustc/topic/slowdown.20compiling.20Cargo) on Zulip we decided to open an issue here about the jobserver strategy in general. To be clear, the current downsides that I've seen are:\r\n\r\n* Tokens are acquired/reacquired excessively, causing most compilation time get sunk into the kernel.\r\n* Tokens aren't managed quite right because the maximum parallelism went above the jobserver limit. My `-j28` build, for example, at one point had 45 rustc instances running.\r\n\r\nI'm not personally too familiar with the current jobserver code in rustc, but this is something that likely warrants improvement before shipping!\r\n\r\ncc @Mark-Simulacrum @Zoxc ", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/64750/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/64750/timeline", "performed_via_github_app": null, "state_reason": null}