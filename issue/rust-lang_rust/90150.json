{"url": "https://api.github.com/repos/rust-lang/rust/issues/90150", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/90150/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/90150/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/90150/events", "html_url": "https://github.com/rust-lang/rust/issues/90150", "id": 1033084794, "node_id": "I_kwDOAAsO6M49k596", "number": 90150, "title": "ICE on inline const pattern using const generic parameter", "user": {"login": "Esper89", "id": 69338029, "node_id": "MDQ6VXNlcjY5MzM4MDI5", "avatar_url": "https://avatars.githubusercontent.com/u/69338029?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Esper89", "html_url": "https://github.com/Esper89", "followers_url": "https://api.github.com/users/Esper89/followers", "following_url": "https://api.github.com/users/Esper89/following{/other_user}", "gists_url": "https://api.github.com/users/Esper89/gists{/gist_id}", "starred_url": "https://api.github.com/users/Esper89/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Esper89/subscriptions", "organizations_url": "https://api.github.com/users/Esper89/orgs", "repos_url": "https://api.github.com/users/Esper89/repos", "events_url": "https://api.github.com/users/Esper89/events{/privacy}", "received_events_url": "https://api.github.com/users/Esper89/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1282665911, "node_id": "MDU6TGFiZWwxMjgyNjY1OTEx", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-const-generics", "name": "A-const-generics", "color": "f7e101", "default": false, "description": "Area: const generics (parameters and arguments)"}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}, {"id": 1615551553, "node_id": "MDU6TGFiZWwxNjE1NTUxNTUz", "url": "https://api.github.com/repos/rust-lang/rust/labels/glacier", "name": "glacier", "color": "a5e2ff", "default": false, "description": "ICE tracked in rust-lang/glacier"}, {"id": 2306075829, "node_id": "MDU6TGFiZWwyMzA2MDc1ODI5", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-inline_const", "name": "F-inline_const", "color": "f9c0cc", "default": false, "description": "Inline constants (aka: const blocks, const expressions, anonymous constants)"}, {"id": 2341291797, "node_id": "MDU6TGFiZWwyMzQxMjkxNzk3", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-generic_const_exprs", "name": "F-generic_const_exprs", "color": "f9c0cc", "default": false, "description": "`#![feature(generic_const_exprs)]`"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2021-10-22T01:19:21Z", "updated_at": "2021-12-08T21:51:06Z", "closed_at": "2021-12-08T21:51:06Z", "author_association": "NONE", "active_lock_reason": null, "body": "Using a const parameter in an inline const pattern causes an ICE, but only when you don't directly use the parameter. This seems to be the same problem as #82518, although under different circumstances.\r\n\r\n### Code\r\n\r\n```Rust\r\n#![feature(inline_const)]\r\n#![feature(generic_const_exprs)]\r\n\r\nconst fn foo(val: usize) -> usize { val }\r\n\r\nfn bar<const N: usize>(num: usize) -> &'static str\r\nwhere [(); foo(N)]:\r\n{\r\n    match num {\r\n        const { foo(N) } => \"fizz\",\r\n        _ => \"buzz\"\r\n    }\r\n}\r\n```\r\nUsing `const { N }` instead of `const { foo(N) }` gives\r\n```\r\nerror[E0158]: const parameters cannot be referenced in patterns\r\n```\r\nDisappointing, but undoubtedly the intended behavior.\r\n\r\nThe above example wouldn't be easy to come across naturally, but if the const parameter was (for example) an array and you tried to index it, the compiler would tell you to use a `const fn` to do that. This code causes the same ICE:\r\n\r\n```Rust\r\n#![feature(adt_const_params)]\r\n#![feature(inline_const)]\r\n#![feature(generic_const_exprs)]\r\n\r\nconst fn get(array: [usize; 5], index: usize) -> usize { array[index] }\r\n\r\nfn bar<const A: [usize; 5]>(num: usize) -> &'static str\r\nwhere [(); get(A, 0)]:\r\n{\r\n    match num {\r\n        const { get(A, 0) } => \"fizz\",\r\n        _ => \"buzz\"\r\n    }\r\n}\r\n```\r\n\r\nI should note that this issue is only present with the `inline_const` feature *and* the `generic_const_exprs` feature.\r\n\r\n### Meta\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.58.0-nightly (efd048394 2021-10-20)\r\nbinary: rustc\r\ncommit-hash: efd0483949496b067cd5f7569d1b28cd3d5d3c72\r\ncommit-date: 2021-10-20\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.58.0-nightly\r\nLLVM version: 13.0.0\r\n```\r\n\r\n### Error output\r\n```\r\nerror: internal compiler error: /rustc/efd0483949496b067cd5f7569d1b28cd3d5d3c72/compiler/rustc_middle/src/ty/consts.rs:194:32: expected bits of usize, got Const {\r\n    ty: usize,\r\n    val: Unevaluated(\r\n        Unevaluated {\r\n            def: WithOptConstParam {\r\n                did: DefId(0:62 ~ const_testing_stuff[3d48]::arrays::bar::{constant#2}),\r\n                const_param_did: None,\r\n            },\r\n            substs_: None,\r\n            promoted: None,\r\n        },\r\n    ),\r\n}\r\n```\r\n\r\n<details><summary><strong>Backtrace</strong></summary>\r\n<p>\r\n\r\n```\r\nthread 'rustc' panicked at 'Box<dyn Any>', compiler/rustc_errors/src/lib.rs:1147:9\r\nstack backtrace:\r\n   0: std::panicking::begin_panic\r\n   1: std::panic::panic_any\r\n   2: rustc_errors::HandlerInner::bug\r\n   3: rustc_errors::Handler::bug\r\n   4: rustc_middle::ty::context::tls::with_opt\r\n   5: rustc_middle::util::bug::opt_span_bug_fmt\r\n   6: rustc_middle::util::bug::bug_fmt\r\n   7: indexmap::map::core::Entry<K,V>::or_insert_with\r\n   8: rustc_mir_build::build::matches::<impl rustc_mir_build::build::Builder>::test_candidates_with_or\r\n   9: rustc_data_structures::stack::ensure_sufficient_stack\r\n  10: rustc_mir_build::build::matches::<impl rustc_mir_build::build::Builder>::lower_match_tree\r\n  11: rustc_mir_build::build::matches::<impl rustc_mir_build::build::Builder>::match_expr\r\n  12: rustc_mir_build::build::expr::into::<impl rustc_mir_build::build::Builder>::expr_into_dest\r\n  13: rustc_mir_build::build::expr::into::<impl rustc_mir_build::build::Builder>::expr_into_dest\r\n  14: rustc_mir_build::build::block::<impl rustc_mir_build::build::Builder>::ast_block_stmts\r\n  15: rustc_mir_build::build::scope::<impl rustc_mir_build::build::Builder>::in_scope\r\n  16: rustc_mir_build::build::expr::into::<impl rustc_mir_build::build::Builder>::expr_into_dest\r\n  17: rustc_mir_build::build::expr::into::<impl rustc_mir_build::build::Builder>::expr_into_dest\r\n  18: rustc_mir_build::build::expr::into::<impl rustc_mir_build::build::Builder>::expr_into_dest\r\n  19: rustc_mir_build::build::construct_fn\r\n  20: rustc_infer::infer::InferCtxtBuilder::enter\r\n  21: rustc_mir_build::build::mir_built\r\n  22: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task\r\n  23: rustc_data_structures::stack::ensure_sufficient_stack\r\n  24: rustc_query_system::query::plumbing::try_execute_query\r\n  25: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::mir_built\r\n  26: rustc_mir_transform::check_unsafety::unsafety_check_result\r\n  27: core::ops::function::FnOnce::call_once\r\n  28: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task\r\n  29: rustc_data_structures::stack::ensure_sufficient_stack\r\n  30: rustc_query_system::query::plumbing::try_execute_query\r\n  31: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::unsafety_check_result\r\n  32: rustc_mir_transform::mir_const\r\n  33: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task\r\n  34: rustc_data_structures::stack::ensure_sufficient_stack\r\n  35: rustc_query_system::query::plumbing::try_execute_query\r\n  36: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::mir_const\r\n  37: rustc_mir_transform::mir_promoted\r\n  38: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task\r\n  39: rustc_data_structures::stack::ensure_sufficient_stack\r\n  40: rustc_query_system::query::plumbing::try_execute_query\r\n  41: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::mir_promoted\r\n  42: core::ops::function::FnOnce::call_once\r\n  43: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task\r\n  44: rustc_data_structures::stack::ensure_sufficient_stack\r\n  45: rustc_query_system::query::plumbing::try_execute_query\r\n  46: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::mir_borrowck\r\n  47: rustc_middle::hir::map::Map::par_body_owners\r\n  48: rustc_session::utils::<impl rustc_session::session::Session>::time\r\n  49: rustc_interface::passes::analysis\r\n  50: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task\r\n  51: rustc_data_structures::stack::ensure_sufficient_stack\r\n  52: rustc_query_system::query::plumbing::try_execute_query\r\n  53: rustc_query_system::query::plumbing::get_query\r\n  54: rustc_interface::passes::QueryContext::enter\r\n  55: rustc_interface::queries::<impl rustc_interface::interface::Compiler>::enter\r\n  56: rustc_span::with_source_map\r\n  57: scoped_tls::ScopedKey<T>::set\r\n```\r\n\r\n</p>\r\n</details>", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/90150/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/90150/timeline", "performed_via_github_app": null, "state_reason": "completed"}