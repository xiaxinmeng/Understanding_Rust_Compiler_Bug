{"url": "https://api.github.com/repos/rust-lang/rust/issues/50130", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/50130/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/50130/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/50130/events", "html_url": "https://github.com/rust-lang/rust/issues/50130", "id": 316443393, "node_id": "MDU6SXNzdWUzMTY0NDMzOTM=", "number": 50130, "title": "Visibilities of \"private\" items from macros 1.2", "user": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 632573348, "node_id": "MDU6TGFiZWw2MzI1NzMzNDg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-macros-2.0", "name": "A-macros-2.0", "color": "f7e101", "default": false, "description": "Area: declarative macros 2.0, https://github.com/rust-lang/rust/issues/39412"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-04-21T00:05:43Z", "updated_at": "2018-12-02T15:28:31Z", "closed_at": "2018-12-02T15:28:31Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Procedural macros generate tokens, but sometimes the information is kept not in tokens, but rather in the lack of them.\r\nLook at the `struct S` in the macro below, it doesn't have a `pub` annotation, so it's private and \"private\" is desugared into `pub(self)` where `self` is the current module, but \"current module\" depends on the location from which we resolve `self`.\r\n\r\n```rust\r\nmod m {\r\n    pub macro mac() {\r\n        struct S;\r\n    }\r\n}\r\n\r\nm::mac!();\r\n\r\nfn main() {}\r\n```\r\n\r\nIf `self` is resolved from the macro def-site, then the current module is `m`, if `self` is resolved from the macro call-site, then the current module is crate root.\r\n\r\nThe question is what kind of `self` is implicitly generated for private items from macros.\r\n\r\n---\r\nUnfortunately, as far as I know, the only viable answer right now is `self` is the module in which the item will end up after all the macro expansions (i.e. \"transitive call-site\").\r\n\r\nThere are some alternatives potentially (https://github.com/rust-lang/rust/pull/40847#issuecomment-294043841), but if `self` is resolved from def site, then we'll get \"visibilities can only be restricted to ancestor modules\" errors and also conservative type privacy errors on every use of the generated struct.\r\nThese issues are probably resolvable, but they require nontrivial amount of design and implementation work and we can't delay stabilization of items-without-pub defined by macros until then.", "closed_by": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/50130/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/50130/timeline", "performed_via_github_app": null, "state_reason": "completed"}