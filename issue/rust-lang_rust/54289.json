{"url": "https://api.github.com/repos/rust-lang/rust/issues/54289", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/54289/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/54289/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/54289/events", "html_url": "https://github.com/rust-lang/rust/issues/54289", "id": 360811380, "node_id": "MDU6SXNzdWUzNjA4MTEzODA=", "number": 54289, "title": "ICE with async_await + extern crate + invalid import", "user": {"login": "Pauan", "id": 97238, "node_id": "MDQ6VXNlcjk3MjM4", "avatar_url": "https://avatars.githubusercontent.com/u/97238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Pauan", "html_url": "https://github.com/Pauan", "followers_url": "https://api.github.com/users/Pauan/followers", "following_url": "https://api.github.com/users/Pauan/following{/other_user}", "gists_url": "https://api.github.com/users/Pauan/gists{/gist_id}", "starred_url": "https://api.github.com/users/Pauan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Pauan/subscriptions", "organizations_url": "https://api.github.com/users/Pauan/orgs", "repos_url": "https://api.github.com/users/Pauan/repos", "events_url": "https://api.github.com/users/Pauan/events{/privacy}", "received_events_url": "https://api.github.com/users/Pauan/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 1049510487, "node_id": "MDU6TGFiZWwxMDQ5NTEwNDg3", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-async-await", "name": "A-async-await", "color": "f7e101", "default": false, "description": "Area: Async & Await"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-09-17T10:43:31Z", "updated_at": "2018-09-17T13:37:10Z", "closed_at": "2018-09-17T13:37:10Z", "author_association": "NONE", "active_lock_reason": null, "body": "`Cargo.toml`:\r\n\r\n```toml\r\n[package]\r\nname = \"rust-async-ice\"\r\nedition = \"2018\"\r\nversion = \"0.1.0\"\r\nauthors = [\"Pauan <pcxunlimited@gmail.com>\"]\r\n\r\n[dependencies]\r\nfoo = \"0.0.0\"\r\n```\r\n\r\n`main.rs`:\r\n\r\n```rust\r\n#![feature(async_await, await_macro, futures_api)]\r\n\r\nextern crate foo;\r\n\r\n// The Bar type doesn't exist in foo\r\nuse foo::Bar;\r\n\r\nasync fn future_main() -> Result<(), Bar> {\r\n    Ok(())\r\n}\r\n\r\nfn main() {}\r\n```\r\n\r\nWhen running `cargo build --verbose` I get this ICE:\r\n\r\n```\r\n> cargo build --verbose\r\n   Compiling foo v0.0.0\r\n     Running `rustc --crate-name foo C:\\Users\\Pauan\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\foo-0.0.0\\src\\lib.rs --color always --crate-type lib --emit=dep-info,link -C debuginfo=2 -C metadata=b5174b0adc406c09 -C extra-filename=-b5174b0adc406c09 --out-dir \"C:\\Users\\Pauan\\Shared Folders\\NixOS\\rust-async-ice\\target\\debug\\deps\" -L \"dependency=C:\\Users\\Pauan\\Shared Folders\\NixOS\\rust-async-ice\\target\\debug\\deps\" --cap-lints allow`\r\n   Compiling rust-async-ice v0.1.0 (C:\\Users\\Pauan\\Shared Folders\\NixOS\\rust-async-ice)\r\n     Running `rustc --edition=2018 --crate-name rust_async_ice src\\main.rs --color always --crate-type bin --emit=dep-info,link -C debuginfo=2 -C metadata=48b1954b9da344d9 -C extra-filename=-48b1954b9da344d9 --out-dir \"C:\\Users\\Pauan\\Shared Folders\\NixOS\\rust-async-ice\\target\\debug\\deps\" -C \"incremental=C:\\Users\\Pauan\\Shared Folders\\NixOS\\rust-async-ice\\target\\debug\\incremental\" -L \"dependency=C:\\Users\\Pauan\\Shared Folders\\NixOS\\rust-async-ice\\target\\debug\\deps\" --extern \"foo=C:\\Users\\Pauan\\Shared Folders\\NixOS\\rust-async-ice\\target\\debug\\deps\\libfoo-b5174b0adc406c09.rlib\"`\r\nerror: internal compiler error: cat_expr Errd\r\n  --> src\\main.rs:8:43\r\n   |\r\n8  |   async fn future_main() -> Result<(), Bar> {\r\n   |  ___________________________________________^\r\n9  | |     Ok(())\r\n10 | | }\r\n   | |_^\r\n\r\nerror: internal compiler error: cat_expr Errd\r\n  --> src\\main.rs:8:43\r\n   |\r\n8  |   async fn future_main() -> Result<(), Bar> {\r\n   |  ___________________________________________^\r\n9  | |     Ok(())\r\n10 | | }\r\n   | |_^\r\n\r\nerror: internal compiler error: cat_expr Errd\r\n --> src\\main.rs:9:5\r\n  |\r\n9 |     Ok(())\r\n  |     ^^^^^^\r\n\r\nerror: internal compiler error: cat_expr Errd\r\n --> src\\main.rs:9:5\r\n  |\r\n9 |     Ok(())\r\n  |     ^^\r\n\r\nerror: internal compiler error: QualifyAndPromoteConstants: Mir had errors\r\n  --> src\\main.rs:8:43\r\n   |\r\n8  |   async fn future_main() -> Result<(), Bar> {\r\n   |  ___________________________________________^\r\n9  | |     Ok(())\r\n10 | | }\r\n   | |_^\r\n\r\nerror: internal compiler error: broken MIR in DefId(0/1:10 ~ rust_async_ice[6258]::future_main[0]::{{closure}}[0]) (\"return type\"): bad type std::result::Result<(), [type error]>\r\n  --> src\\main.rs:8:43\r\n   |\r\n8  |   async fn future_main() -> Result<(), Bar> {\r\n   |  ___________________________________________^\r\n9  | |     Ok(())\r\n10 | | }\r\n   | |_^\r\n\r\nerror: internal compiler error: broken MIR in DefId(0/1:10 ~ rust_async_ice[6258]::future_main[0]::{{closure}}[0]) (LocalDecl { mutability: Mut, is_user_variable: None, internal: false, ty: std::result::Result<(), [type error]>, user_ty: None, name: None, source_info: SourceInfo { span: src\\main.rs:8:43: 10:2, scope: scope[0] }, visibility_scope: scope[0] }): bad type std::result::Result<(), [type error]>\r\n  --> src\\main.rs:8:43\r\n   |\r\n8  |   async fn future_main() -> Result<(), Bar> {\r\n   |  ___________________________________________^\r\n9  | |     Ok(())\r\n10 | | }\r\n   | |_^\r\n\r\nerror: internal compiler error: broken MIR in DefId(0/1:10 ~ rust_async_ice[6258]::future_main[0]::{{closure}}[0]) (LocalDecl { mutability: Mut, is_user_variable: None, internal: false, ty: [static generator@src\\main.rs:8:43: 10:2 {}], user_ty: None, name: None, source_info: SourceInfo { span: src\\main.rs:8:43: 10:2, scope: scope[0] }, visibility_scope: scope[0] }): bad type [static generator@src\\main.rs:8:43: 10:2 {}]\r\n  --> src\\main.rs:8:43\r\n   |\r\n8  |   async fn future_main() -> Result<(), Bar> {\r\n   |  ___________________________________________^\r\n9  | |     Ok(())\r\n10 | | }\r\n   | |_^\r\n\r\nerror: internal compiler error: QualifyAndPromoteConstants: Mir had errors\r\n  --> src\\main.rs:8:1\r\n   |\r\n8  | / async fn future_main() -> Result<(), Bar> {\r\n9  | |     Ok(())\r\n10 | | }\r\n   | |_^\r\n\r\nerror: internal compiler error: broken MIR in DefId(0/0:5 ~ rust_async_ice[6258]::future_main[0]) (\"return type\"): bad type impl std::future::Future\r\n  --> src\\main.rs:8:1\r\n   |\r\n8  | / async fn future_main() -> Result<(), Bar> {\r\n9  | |     Ok(())\r\n10 | | }\r\n   | |_^\r\n\r\nerror: internal compiler error: broken MIR in DefId(0/0:5 ~ rust_async_ice[6258]::future_main[0]) (LocalDecl { mutability: Mut, is_user_variable: None, internal: false, ty: impl std::future::Future, user_ty: None, name: None, source_info: SourceInfo { span: src\\main.rs:8:1: 10:2, scope: scope[0] }, visibility_scope: scope[0] }): bad type impl std::future::Future\r\n  --> src\\main.rs:8:1\r\n   |\r\n8  | / async fn future_main() -> Result<(), Bar> {\r\n9  | |     Ok(())\r\n10 | | }\r\n   | |_^\r\n\r\nerror: internal compiler error: broken MIR in DefId(0/0:5 ~ rust_async_ice[6258]::future_main[0]) (LocalDecl { mutability: Mut, is_user_variable: None, internal: false, ty: [static generator@src\\main.rs:8:43: 10:2 {}], user_ty: None, name: None, source_info: SourceInfo { span: src\\main.rs:8:43: 10:2, scope: scope[0] }, visibility_scope: scope[0] }): bad type [static generator@src\\main.rs:8:43: 10:2 {}]\r\n  --> src\\main.rs:8:1\r\n   |\r\n8  | / async fn future_main() -> Result<(), Bar> {\r\n9  | |     Ok(())\r\n10 | | }\r\n   | |_^\r\n\r\nerror: internal compiler error: errors selecting obligation during MIR typeck: [FulfillmentError(Obligation(predicate=Binder(TraitPredicate(<impl std::future::Future as std::marker::Sized>)),depth=0),Ambiguity), FulfillmentError(Obligation(predicate=Binder(TraitPredicate(<impl std::future::Future as std::future::Future>)),depth=0),Ambiguity)]\r\n\r\nthread 'main' panicked at 'no errors encountered even though `delay_span_bug` issued', librustc_errors\\lib.rs:321:17\r\nstack backtrace:\r\n   0:     0x7ffa7b0e0a92 - <std::sys::windows::args::Args as core::ops::drop::Drop>::drop::h69dc4a396c83fbea\r\n   1:     0x7ffa7b0c9f2f - std::io::error::Error::get_ref::h3b34149d3fcc474b\r\n   2:     0x7ffa7b0c8348 - std::panicking::take_hook::h45b4c991720c128b\r\n   3:     0x7ffa7b0c8001 - std::panicking::take_hook::h45b4c991720c128b\r\n   4:     0x7ffa5b885175 - <rustc::ty::sty::Binder<rustc::ty::ProjectionPredicate<'tcx>> as rustc::ty::ToPredicate<'tcx>>::to_predicate::h2e6434fb2079e88c\r\n   5:     0x7ffa7b0c8b71 - std::panicking::rust_panic_with_hook::h1ea4d5bad9b899f1\r\n   6:     0x7ffa78e69067 - <rustc_errors::diagnostic::SubDiagnostic as core::fmt::Debug>::fmt::hbf1fd867e36c5c5b\r\n   7:     0x7ffa78e62ae1 - <rustc_errors::Handler as core::ops::drop::Drop>::drop::ha7e5ef5f688ed509\r\n   8:     0x7ffa881adc0c - rustc_driver::target_features::add_configuration::h7dfe8e915c1650c9\r\n   9:     0x7ffa881b424f - rustc_driver::target_features::add_configuration::h7dfe8e915c1650c9\r\n  10:     0x7ffa881b9acf - rustc_driver::target_features::add_configuration::h7dfe8e915c1650c9\r\n  11:     0x7ffa881bc426 - rustc_driver::target_features::add_configuration::h7dfe8e915c1650c9\r\n  12:     0x7ffa7b0fa471 - _rust_maybe_catch_panic\r\n  13:     0x7ffa882542b2 - rustc_driver::profile::dump::had22fd3d322ef3c6\r\n  14:     0x7ffa88266a7d - rustc_driver::main::h5823241893b36e24\r\n  15:     0x7ff6834d1055 - <unknown>\r\n  16:     0x7ffa7b0c8516 - std::panicking::update_panic_count::h2bc483fd32260cb4\r\n  17:     0x7ffa7b0fa471 - _rust_maybe_catch_panic\r\n  18:     0x7ffa7b0da342 - std::rt::lang_start_internal::hf2484ca2ac9591b0\r\n  19:     0x7ff6834d1049 - <unknown>\r\n  20:     0x7ff6834d1298 - <unknown>\r\n  21:     0x7ffac2fd3033 - BaseThreadInitThunk\r\n  22:     0x7ffac3431460 - RtlUserThreadStart\r\nquery stack during panic:\r\nend of query stack\r\n\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: rustc 1.30.0-nightly (2ab3eba30 2018-09-14) running on x86_64-pc-windows-msvc\r\n\r\nnote: compiler flags: -C debuginfo=2 -C incremental --crate-type bin\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n\r\nerror: Could not compile `rust-async-ice`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --edition=2018 --crate-name rust_async_ice src\\main.rs --color always --crate-type bin --emit=dep-info,link -C debuginfo=2 -C metadata=48b1954b9da344d9 -C extra-filename=-48b1954b9da344d9 --out-dir \"C:\\Users\\Pauan\\Shared Folders\\NixOS\\rust-async-ice\\target\\debug\\deps\" -C \"incremental=C:\\Users\\Pauan\\Shared Folders\\NixOS\\rust-async-ice\\target\\debug\\incremental\" -L \"dependency=C:\\Users\\Pauan\\Shared Folders\\NixOS\\rust-async-ice\\target\\debug\\deps\" --extern \"foo=C:\\Users\\Pauan\\Shared Folders\\NixOS\\rust-async-ice\\target\\debug\\deps\\libfoo-b5174b0adc406c09.rlib\"` (exit code: 101)\r\n```\r\n\r\n## Meta\r\n\r\n`rustc --version --verbose`:\r\n\r\n```\r\nrustc 1.30.0-nightly (2ab3eba30 2018-09-14)\r\nbinary: rustc\r\ncommit-hash: 2ab3eba30741652ba538bc2fc2bba9d81a5c84c6\r\ncommit-date: 2018-09-14\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.30.0-nightly\r\nLLVM version: 8.0\r\n```", "closed_by": {"login": "Pauan", "id": 97238, "node_id": "MDQ6VXNlcjk3MjM4", "avatar_url": "https://avatars.githubusercontent.com/u/97238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Pauan", "html_url": "https://github.com/Pauan", "followers_url": "https://api.github.com/users/Pauan/followers", "following_url": "https://api.github.com/users/Pauan/following{/other_user}", "gists_url": "https://api.github.com/users/Pauan/gists{/gist_id}", "starred_url": "https://api.github.com/users/Pauan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Pauan/subscriptions", "organizations_url": "https://api.github.com/users/Pauan/orgs", "repos_url": "https://api.github.com/users/Pauan/repos", "events_url": "https://api.github.com/users/Pauan/events{/privacy}", "received_events_url": "https://api.github.com/users/Pauan/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/54289/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/54289/timeline", "performed_via_github_app": null, "state_reason": "completed"}