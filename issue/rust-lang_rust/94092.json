{"url": "https://api.github.com/repos/rust-lang/rust/issues/94092", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/94092/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/94092/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/94092/events", "html_url": "https://github.com/rust-lang/rust/issues/94092", "id": 1141646357, "node_id": "I_kwDOAAsO6M5EDCQV", "number": 94092, "title": "TCP_NODELAY setsockopt uses BYTE on Windows when it should use BOOL", "user": {"login": "chrisnc", "id": 2592855, "node_id": "MDQ6VXNlcjI1OTI4NTU=", "avatar_url": "https://avatars.githubusercontent.com/u/2592855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chrisnc", "html_url": "https://github.com/chrisnc", "followers_url": "https://api.github.com/users/chrisnc/followers", "following_url": "https://api.github.com/users/chrisnc/following{/other_user}", "gists_url": "https://api.github.com/users/chrisnc/gists{/gist_id}", "starred_url": "https://api.github.com/users/chrisnc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chrisnc/subscriptions", "organizations_url": "https://api.github.com/users/chrisnc/orgs", "repos_url": "https://api.github.com/users/chrisnc/repos", "events_url": "https://api.github.com/users/chrisnc/events{/privacy}", "received_events_url": "https://api.github.com/users/chrisnc/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": {"login": "chrisnc", "id": 2592855, "node_id": "MDQ6VXNlcjI1OTI4NTU=", "avatar_url": "https://avatars.githubusercontent.com/u/2592855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chrisnc", "html_url": "https://github.com/chrisnc", "followers_url": "https://api.github.com/users/chrisnc/followers", "following_url": "https://api.github.com/users/chrisnc/following{/other_user}", "gists_url": "https://api.github.com/users/chrisnc/gists{/gist_id}", "starred_url": "https://api.github.com/users/chrisnc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chrisnc/subscriptions", "organizations_url": "https://api.github.com/users/chrisnc/orgs", "repos_url": "https://api.github.com/users/chrisnc/repos", "events_url": "https://api.github.com/users/chrisnc/events{/privacy}", "received_events_url": "https://api.github.com/users/chrisnc/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "chrisnc", "id": 2592855, "node_id": "MDQ6VXNlcjI1OTI4NTU=", "avatar_url": "https://avatars.githubusercontent.com/u/2592855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chrisnc", "html_url": "https://github.com/chrisnc", "followers_url": "https://api.github.com/users/chrisnc/followers", "following_url": "https://api.github.com/users/chrisnc/following{/other_user}", "gists_url": "https://api.github.com/users/chrisnc/gists{/gist_id}", "starred_url": "https://api.github.com/users/chrisnc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chrisnc/subscriptions", "organizations_url": "https://api.github.com/users/chrisnc/orgs", "repos_url": "https://api.github.com/users/chrisnc/repos", "events_url": "https://api.github.com/users/chrisnc/events{/privacy}", "received_events_url": "https://api.github.com/users/chrisnc/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2022-02-17T17:35:33Z", "updated_at": "2022-03-01T05:40:04Z", "closed_at": "2022-03-01T05:40:04Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "This bug was found and mitigated by the Wine project here:\r\nhttps://source.winehq.org/git/wine.git/commit/d6ea38f32dfd3edbe107a255c37e9f7f3da06ae7\r\n\r\nThe types for each setsockopt are documented here:\r\nhttps://docs.microsoft.com/en-us/windows/win32/api/winsock/nf-winsock-setsockopt\r\n\r\nAs the Wine commit explains, Windows itself is more liberal in what values of optlen it will accept for boolean arguments, which is why this has not affected Windows proper, but it would still be better to pass the expected type and length, so that the Rust bindings will also work on more strict implementations of winsock, such as Wine's prior to this fix. I confirmed that this is the case using Wine 7.0, which is the current stable branch available from https://wiki.winehq.org/Debian. Wine 5.0.3, which is the version that Debian/Ubuntu distribute themselves, is not affected by this problem.\r\n\r\nI tried this code:\r\n\r\n```rust\r\nuse std::io::{self, Write};\r\nuse std::net::TcpStream;\r\n\r\nfn main() -> io::Result<()> {\r\n    let mut stream = TcpStream::connect(\"127.0.0.1:8080\")?;\r\n    stream.set_nodelay(true)?;\r\n    stream.write(b\"hello\")?;\r\n    Ok(())\r\n}\r\n```\r\n\r\nI set up a listening peer with `nc -l -p 8080`,\r\nbuilt with `cargo build --target x86_64-pc-windows-gnu`,\r\nand ran with `wine target/x86_64-pc-windows-gnu/debug/tcp-nodelay-text.exe`.\r\n\r\nI expected to see this happen: all the socket operations succeed, and `nc` prints \"hello\" and exits.\r\n\r\nInstead, this happened: set_nodelay returns an Err:\r\n```\r\nError: Os { code: 10022, kind: InvalidInput, message: \"OS Error 10022 (FormatMessageW() returned error 317)\" }\r\n```\r\n\r\nIf I run with `strace -f wine target/x86_64-pc-windows-gnu/debug/tcp-nodelay-text.exe`, which shows the Linux system calls that wine makes on behalf of the program, I can see:\r\n``` \r\n<pid> setsockopt(9, SOL_TCP, TCP_NODELAY, \"\\1\", 1)         = -1 EINVAL (Invalid argument)\r\n```\r\n\r\nI tested this using rust 1.58.1, but I confirmed that the code in question is still doing the same thing on the `main` branch of rust.\r\n\r\nHere is a commit which should fix the issue:\r\nhttps://github.com/chrisnc/rust/commit/33c1de889884cb3edc276510a17f3e5ba99ca7e4\r\n\r\nI was able to test it myself and confirmed that the error goes away:\r\n\r\n```\r\n$ rustc +stage2 --target x86_64-pc-windows-gnu src/main.rs # the rustc+std that I built with this change\r\n$ wine main.exe # works\r\n$ rustc --target x86_64-pc-windows-gnu src/main.rs # rustc 1.58.1\r\n$ wine main.exe # fails\r\nError: Os { code: 10022, kind: InvalidInput, message: \"OS Error 10022 (FormatMessageW() returned error 317)\" }\r\n```\r\n\r\nThat this error isn't formatted correctly is probably another bug, but I haven't looked into it.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/94092/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/94092/timeline", "performed_via_github_app": null, "state_reason": "completed"}