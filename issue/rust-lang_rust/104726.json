{"url": "https://api.github.com/repos/rust-lang/rust/issues/104726", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/104726/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/104726/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/104726/events", "html_url": "https://github.com/rust-lang/rust/issues/104726", "id": 1460243650, "node_id": "I_kwDOAAsO6M5XCYzC", "number": 104726, "title": "Unsafe precondition violated in the x86_64 SIMD implementation of `str.contains`", "user": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 55302148, "node_id": "MDU6TGFiZWw1NTMwMjE0OA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-x86_64", "name": "O-x86_64", "color": "6e6ec0", "default": false, "description": "Target: x64 processors"}, {"id": 147085028, "node_id": "MDU6TGFiZWwxNDcwODUwMjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-nightly", "name": "regression-from-stable-to-nightly", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to nightly."}, {"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}, {"id": 2238196890, "node_id": "MDU6TGFiZWwyMjM4MTk2ODkw", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-str", "name": "A-str", "color": "f7e101", "default": false, "description": "Area: str and String"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 10, "created_at": "2022-11-22T17:01:56Z", "updated_at": "2022-11-23T17:16:11Z", "closed_at": "2022-11-22T23:43:12Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "PR https://github.com/rust-lang/rust/pull/103779 added a x86_64 SIMD-based implementation of `str.contains(&needle)` to optimize searching into strings when the needle is at most 32 bytes long. Unfortunately, that implementation doesn't seem to be sound.\r\n\r\nWhen compiling the standard library with debug assertions on, running UI tests excluding `src/test/ui/process/no-stdio.rs` results in compiletest itself panicking before executing any test due to a `debug_assert` in libcore:\r\n\r\n```\r\nthread 'main' panicked at 'unsafe precondition(s) violated: slice::get_unchecked requires that the range is within the slice', library/core/src/panicking.rs:89:58\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at .../library/std/src/panicking.rs:575:5\r\n   1: core::panicking::panic_str_nounwind\r\n             at .../library/core/src/panicking.rs:92:14\r\n   2: <core::ops::range::Range<usize> as core::slice::index::SliceIndex<[T]>>::get_unchecked::runtime\r\n   3: core::str::pattern::simd_contains::{{closure}}\r\n             at .../library/core/src/str/pattern.rs:1787:27\r\n   4: core::str::pattern::simd_contains\r\n             at .../library/core/src/str/pattern.rs:1846:19\r\n   5: <&str as core::str::pattern::Pattern>::is_contained_in\r\n             at .../library/core/src/str/pattern.rs:965:43\r\n   6: core::str::<impl str>::contains\r\n             at .../library/core/src/str/mod.rs:1057:9\r\n   7: test::filter_tests::{{closure}}\r\n             at .../library/test/src/lib.rs:464:22\r\n   8: test::filter_tests::{{closure}}::{{closure}}\r\n             at .../library/test/src/lib.rs:475:59\r\n   9: <core::slice::iter::Iter<T> as core::iter::traits::iterator::Iterator>::any\r\n             at .../library/core/src/slice/iter/macros.rs:242:24\r\n  10: test::filter_tests::{{closure}}\r\n             at .../library/test/src/lib.rs:475:33\r\n  11: alloc::vec::Vec<T,A>::retain::{{closure}}\r\n             at .../library/alloc/src/vec/mod.rs:1561:32\r\n  12: alloc::vec::Vec<T,A>::retain_mut::process_loop\r\n             at .../library/alloc/src/vec/mod.rs:1641:21\r\n  13: alloc::vec::Vec<T,A>::retain_mut\r\n             at .../library/alloc/src/vec/mod.rs:1670:9\r\n  14: alloc::vec::Vec<T,A>::retain\r\n             at .../library/alloc/src/vec/mod.rs:1561:9\r\n  15: test::filter_tests\r\n             at .../library/test/src/lib.rs:475:9\r\n  16: test::run_tests\r\n             at .../library/test/src/lib.rs:297:17\r\n  17: test::console::run_tests_console\r\n             at /rustc/47395e0061d50df550cbd8b46dd46c132ea0c95a/library/test/src/console.rs:293:5\r\n  18: compiletest::run_tests\r\n             at /rustc/47395e0061d50df550cbd8b46dd46c132ea0c95a/src/tools/compiletest/src/main.rs:406:15\r\n  19: compiletest::main\r\n             at /rustc/47395e0061d50df550cbd8b46dd46c132ea0c95a/src/tools/compiletest/src/main.rs:57:5\r\n  20: <fn() as core::ops::function::FnOnce<()>>::call_once\r\n             at /rustc/47395e0061d50df550cbd8b46dd46c132ea0c95a/library/core/src/ops/function.rs:422:5\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\nthread panicked while panicking. aborting.\r\n```\r\n\r\nTo reproduce the issue, use the following configuration file:\r\n\r\n```toml\r\nprofile = \"compiler\"\r\nchangelog-seen = 2\r\n\r\n[rust]\r\ndebug-assertions-std = true\r\n```\r\n\r\n...and run:\r\n\r\n```\r\n./x test --stage 1 src/test/ui --exclude src/test/ui/process/no-stdio.rs\r\n```\r\n\r\ncc @the8472 @thomcc ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/104726/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/104726/timeline", "performed_via_github_app": null, "state_reason": "completed"}