{"url": "https://api.github.com/repos/rust-lang/rust/issues/88796", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/88796/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/88796/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/88796/events", "html_url": "https://github.com/rust-lang/rust/issues/88796", "id": 992663122, "node_id": "MDU6SXNzdWU5OTI2NjMxMjI=", "number": 88796, "title": "Windows CI is borked", "user": {"login": "ehuss", "id": 43198, "node_id": "MDQ6VXNlcjQzMTk4", "avatar_url": "https://avatars.githubusercontent.com/u/43198?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ehuss", "html_url": "https://github.com/ehuss", "followers_url": "https://api.github.com/users/ehuss/followers", "following_url": "https://api.github.com/users/ehuss/following{/other_user}", "gists_url": "https://api.github.com/users/ehuss/gists{/gist_id}", "starred_url": "https://api.github.com/users/ehuss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ehuss/subscriptions", "organizations_url": "https://api.github.com/users/ehuss/orgs", "repos_url": "https://api.github.com/users/ehuss/repos", "events_url": "https://api.github.com/users/ehuss/events{/privacy}", "received_events_url": "https://api.github.com/users/ehuss/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 12, "created_at": "2021-09-09T21:45:38Z", "updated_at": "2021-09-11T01:46:20Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Windows CI has stopped working due to an image update on GitHub's side.  The new image is [win19/20210907.4](https://github.com/actions/virtual-environments/releases/tag/win19%2F20210907.4) ([included software](https://github.com/actions/virtual-environments/blob/win19/20210907.4/images/win/Windows2019-Readme.md)). The previous image was [win19/20210903.7](https://github.com/actions/virtual-environments/releases/tag/win19%2F20210903.7) ([included software](https://github.com/actions/virtual-environments/blob/win19/20210903.7/images/win/Windows2019-Readme.md)). The image diff is [here](https://github.com/actions/virtual-environments/commit/b5e5d9f68d1dc94da0abe5857f89efe0783c5805).\r\n\r\nThere are two errors showing up described below.\r\n\r\nI think the most likely culprit is the addition of Windows 10 SDK 20348.  Previously, the most recent SDK installed was 19041.\r\n\r\nThere are some interesting release notes for 20348 [here](https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk/#serverdev):\r\n\r\n> Clang/LLVM for Windows v11 targeting ARM64 is not compatible with the latest winnt.h\r\n> \r\n> As a workaround, use the previous version of the Windows 10 SDK (build 19041), or clang/LLVM for Windows v10 when targeting ARM64 platforms\r\n\r\nI don't know what \"LLVM for Windows v11\" means in this context, but it seems fishy.\r\n\r\n\r\n## dist-aarch64-msvc fails with undeclared identifier '__umulh'\r\n\r\nWhile building `profiler_builtins` there is an error:\r\n\r\n```\r\ncargo:warning=In file included from ../../src/llvm-project/compiler-rt\\lib\\profile\\InstrProfilingRuntime.cpp:11:\r\ncargo:warning=In file included from ../../src/llvm-project/compiler-rt\\lib\\profile/InstrProfiling.h:12:\r\ncargo:warning=In file included from ../../src/llvm-project/compiler-rt\\lib\\profile/InstrProfilingPort.h:65:\r\ncargo:warning=In file included from C:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.20348.0\\um\\windows.h:171:\r\ncargo:warning=In file included from C:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.20348.0\\shared\\windef.h:24:\r\ncargo:warning=In file included from C:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.20348.0\\shared\\minwindef.h:182:\r\ncargo:warning=C:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.20348.0\\um\\winnt.h(6370,20): error: use of undeclared identifier '__umulh'\r\ncargo:warning=    *HighProduct = UnsignedMultiplyHigh(Multiplier, Multiplicand);\r\ncargo:warning=                   ^\r\ncargo:warning=C:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.20348.0\\um\\winnt.h(6236,30): note: expanded from macro 'UnsignedMultiplyHigh'\r\ncargo:warning=#define UnsignedMultiplyHigh __umulh\r\ncargo:warning=                             ^\r\ncargo:warning=1 error generated.\r\nexit code: 1\r\n \r\n--- stderr\r\n \r\n \r\nerror occurred: Command \"D:/a/rust/rust/citools/clang-rust/bin/clang-cl.exe\" \"-nologo\" \"-MT\" \"-O2\" \"-Z7\" \"-Brepro\" \"--target=aarch64-pc-windows-msvc\" \"-I\" \"../../src/llvm-project/compiler-rt\\\\include\" \"/Zl\" \"-Dstrdup=_strdup\" \"-Dopen=_open\" \"-Dfdopen=_fdopen\" \"-Dgetpid=_getpid\" \"-Dfileno=_fileno\" \"-DCOMPILER_RT_HAS_ATOMICS=1\" \"-FoD:\\\\a\\\\rust\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\aarch64-pc-windows-msvc\\\\release\\\\build\\\\profiler_builtins-7ff61bd0c2dd5988\\\\out\\\\../../src/llvm-project/compiler-rt\\\\lib\\\\profile\\\\InstrProfilingRuntime.o\" \"-c\" \"../../src/llvm-project/compiler-rt\\\\lib\\\\profile\\\\InstrProfilingRuntime.cpp\" with args \"clang-cl.exe\" did not execute successfully (status code exit code: 1).\r\n```\r\n\r\nFull log example here: https://github.com/rust-lang-ci/rust/actions/runs/1218329003\r\n\r\n## NatVis error\r\n\r\nThere are three debuginfo tests that are failing:\r\n\r\n```\r\nfailures:\r\n    [debuginfo-cdb] debuginfo\\basic-types.rs\r\n    [debuginfo-cdb] debuginfo\\msvc-pretty-enums.rs\r\n    [debuginfo-cdb] debuginfo\\pretty-std.rs\r\n```\r\n\r\nThese are failing because some Rust types are not displaying correctly (like strings).\r\n\r\nFull log example here: https://github.com/rust-lang-ci/rust/actions/runs/1218098190\r\n\r\nFailing tests report Windows Debugger Version 10.0.20348.1.  \r\n\r\n\r\n## Comments\r\n\r\nI don't know of the proper way of reverting to a previous Windows SDK is.  My understanding is that is usually done by calling `vcvarsall.bat`, where you can specify the SDK version (and sets a bunch of environment variables).  Calling that on CI is awkward (it only really works with cmd, or do weird things like [this](https://gitlab.kitware.com/cmake/cmake/-/blob/master/.gitlab/ci/vcvarsall.ps1)).\r\n\r\nRegarding the cdb errors, I'm also wondering if that might have been caused by the update to Windows SDK.  It is not really clear to me the relationship between the cdb.exe and the Windows Kit (but cdb is installed in `Windows Kits\\10\\Debuggers`).\r\n\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/88796/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/88796/timeline", "performed_via_github_app": null, "state_reason": null}