{"url": "https://api.github.com/repos/rust-lang/rust/issues/65119", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/65119/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/65119/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/65119/events", "html_url": "https://github.com/rust-lang/rust/issues/65119", "id": 502888757, "node_id": "MDU6SXNzdWU1MDI4ODg3NTc=", "number": 65119, "title": "Compiling a file with a non-ASCII name with `--error-format=short` enabled makes error messages contain excessive spaces after \"filename:line:column\"", "user": {"login": "AnthonyMikh", "id": 19252795, "node_id": "MDQ6VXNlcjE5MjUyNzk1", "avatar_url": "https://avatars.githubusercontent.com/u/19252795?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AnthonyMikh", "html_url": "https://github.com/AnthonyMikh", "followers_url": "https://api.github.com/users/AnthonyMikh/followers", "following_url": "https://api.github.com/users/AnthonyMikh/following{/other_user}", "gists_url": "https://api.github.com/users/AnthonyMikh/gists{/gist_id}", "starred_url": "https://api.github.com/users/AnthonyMikh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AnthonyMikh/subscriptions", "organizations_url": "https://api.github.com/users/AnthonyMikh/orgs", "repos_url": "https://api.github.com/users/AnthonyMikh/repos", "events_url": "https://api.github.com/users/AnthonyMikh/events{/privacy}", "received_events_url": "https://api.github.com/users/AnthonyMikh/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 46311113, "node_id": "MDU6TGFiZWw0NjMxMTExMw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-unicode", "name": "A-unicode", "color": "f7e101", "default": false, "description": "Area: unicode related"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2019-10-05T00:01:38Z", "updated_at": "2019-10-08T21:12:09Z", "closed_at": "2019-10-08T21:12:09Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Consider the following rust source (in `test.rs`):\r\n\r\n```rust\r\nfn main() {\r\n    println!(\"hello world\r\n}\r\n```\r\n\r\nIt is obvious that it has syntax error. It also seems obvious that the generated error shouldn't depend on name of file except noting the name of file. However, it doesn't happen in practice:\r\n\r\n```shell\r\n$ rustc test.rs --error-format=short\r\ntest.rs:2:14: error: unterminated double quote string\r\nerror: aborting due to previous error\r\n$ mv test.rs '\u0442\u0435\u0441\u0442.rs'\r\n$ rustc '\u0442\u0435\u0441\u0442.rs' --error-format=short\r\n\u0442\u0435\u0441\u0442.rs:2:14:     error: unterminated double quote string\r\nerror: aborting due to previous error\r\n```\r\n\r\nNote extra spaces after `\u0442\u0435\u0441\u0442.rs:2:14:`.\r\n\r\nRust version (although it is not strictly relevant, see below):\r\n\r\n```\r\n$ rustc -vV\r\nrustc 1.38.0 (625451e37 2019-09-23)\r\nbinary: rustc\r\ncommit-hash: 625451e376bb2e5283fc4741caa0a3e8a2ca4d54\r\ncommit-date: 2019-09-23\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.38.0\r\nLLVM version: 9.0\r\n```\r\n\r\nThe core issue lies in the [implementation of `StyledBuffer::prepend` method](https://github.com/rust-lang/rust/blob/950fe6686da1fdbaf25341cc5fafe1bb9fb1b180/src/librustc_errors/styled_buffer.rs#L112-L123). The idea of the code is to make enough space in the beginning of line (filled with spaces) and then overwrite it character by character. However, in order to estimate the required space, [it uses `.len()`](https://github.com/rust-lang/rust/blob/950fe6686da1fdbaf25341cc5fafe1bb9fb1b180/src/librustc_errors/styled_buffer.rs#L114) which is wrong since `str` in Rust can contain non-ASCII which require more than one byte for storage and `StyledBuffer` keeps lines in `Vec<char>`s. It means that this isuue reveals itself only when a non-ASCII string is passed as an argument \u2014 and that's exactly what's happening in [`EmitterWriter::emit_message_default`](https://github.com/rust-lang/rust/blob/950fe6686da1fdbaf25341cc5fafe1bb9fb1b180/src/librustc_errors/styled_buffer.rs#L114) under very specific circumstances: _when_ processing a primary file, _when_ `self.short_message` is set (i. e. `--error-message=short`) and _when_ name of the primary file happens to have a non-ASCII name.\r\n\r\nThe errorneous code for `StyledBuffer::prepend` was introduced in 2e8e73cb951e2095e444c5cc91403f7e9c5f1065. This bug landed in stable [in 1.28.0](https://github.com/rust-lang/rust/blob/master/RELEASES.md#compiler-9).\r\n\r\nThe obvious fix is to change the line in `prepend` into\r\n\r\n```rust\r\n        let string_len = string.chars().count();\r\n```\r\n\r\ncc @estebank ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/65119/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/65119/timeline", "performed_via_github_app": null, "state_reason": "completed"}