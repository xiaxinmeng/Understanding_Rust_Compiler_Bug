{"url": "https://api.github.com/repos/rust-lang/rust/issues/91409", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/91409/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/91409/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/91409/events", "html_url": "https://github.com/rust-lang/rust/issues/91409", "id": 1067798976, "node_id": "I_kwDOAAsO6M4_pVHA", "number": 91409, "title": "Linking issue with -Zno-profiler-runtime for thumbv7em-none-eabihf", "user": {"login": "xd009642", "id": 3472518, "node_id": "MDQ6VXNlcjM0NzI1MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/3472518?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xd009642", "html_url": "https://github.com/xd009642", "followers_url": "https://api.github.com/users/xd009642/followers", "following_url": "https://api.github.com/users/xd009642/following{/other_user}", "gists_url": "https://api.github.com/users/xd009642/gists{/gist_id}", "starred_url": "https://api.github.com/users/xd009642/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xd009642/subscriptions", "organizations_url": "https://api.github.com/users/xd009642/orgs", "repos_url": "https://api.github.com/users/xd009642/repos", "events_url": "https://api.github.com/users/xd009642/events{/privacy}", "received_events_url": "https://api.github.com/users/xd009642/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-12-01T00:11:44Z", "updated_at": "2021-12-01T08:57:29Z", "closed_at": "2021-12-01T08:57:28Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Nightly version: cargo 1.58.0-nightly (7f08ace4f 2021-11-24)\r\n\r\nSo I'm utilising [minicov](https://github.com/Amanieu/minicov) by @Amanieu to attempt to create a PoC of coverage instrumentation of a bare metal target with Rust. And it seems something odd is happening at link time with thumbv7em-non-eabihf. For reference I implemented a basic version working on x86_64-unknown-linux-gnu using no std APIs (except fs before program close to write output) before moving over to proving it on ARM and this worked perfectly. \r\n\r\nSo generally speaking minicov supplies a no_std compatible implementation of the llvm profiler runtime. So when building my project with `RUSTFLAGS=\"-Zinstrument-coverage -Zno-profiler-runtime\"` the llvm profiler runtime is not included in the binary and the minicov implementation is used. However, when I'm building my binary with these flags enabled I'm finding that my memory.x overrides \r\n\r\nMy reference repo (on feature branch): https://github.com/xd009642/llvm-embedded-coverage/tree/feat/make-no-std  and my own issue tracking attempts to solve this up to now https://github.com/xd009642/llvm-embedded-coverage/issues/1 \r\n\r\nIt seems to me that the presence of `-Zno-profiler-runtime` is causing things to be linked incorrected on thumbv7em-none-eabihf \r\n\r\nWithout default RUSTFLAGS  (things in correct location)\r\n\r\nSections:\r\n\r\n|Idx | Name  |        Size  |    VMA   |    LMA   |    File off | Algn|\r\n|----|-------|--------------|----------|----------|-------------|-----|\r\n |  0 | .vector_table|  00000400 |  08000000 |  08000000 |  00010000 |  2**2 |\r\n  |                CONTENTS |   ALLOC, LOAD, READONLY, DATA |\r\n |  1 | .text        |  00002224 |  08000400 |  08000400 |  00010400 |  2**1 |\r\n |                 CONTENTS |   ALLOC, LOAD, READONLY, CODE  |                  \r\n |  2| .rodata      |  00000468 |  08002624 |  08002624 |  00012624 |  2**4 |\r\n |                 CONTENTS |   ALLOC, LOAD, READONLY, DATA  |                \r\n | 3 |.data        |  00000008 |  200001b8 |  08002a90 |  000201b8 |  2**3 |\r\n |                 CONTENTS |   ALLOC, LOAD, DATA  |                        \r\n | 4 |.bss         |  00002558 |  200001c0 |  200001c0 |  000201c0 |  2**3 |\r\n|                  ALLOC  |                                                \r\n|  5| .uninit      |  00000000 |  20002718 |  20002718 |  000201c0 |  2**2 |\r\n|                  ALLOC |                                                  \r\n|  6 |.debug_loc   |  000035ec |  00000000 |  00000000 |  000201c0 |  2**0 |\r\n|                  CONTENTS |   READONLY, DEBUGGING |                                      \r\n|  7 |.debug_abbrev|  000023d4 |  00000000 |  00000000 |  000237ac |  2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING |                                      \r\n|  8 |.debug_info  |  0002d864 |  00000000 |  00000000 |  00025b80 |  2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING |                                      \r\n|  9 |.debug_aranges|  00002110 |  00000000 |  00000000 |  000533e8 |  2**3|\r\n|                  CONTENTS |   READONLY, DEBUGGING |                                      \r\n|  10| .debug_ranges|  0001a6b8 |  00000000 |  00000000 |  000554f8 |  2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING |                                      \r\n|  11| .debug_str   |  00036ec2 |  00000000 |  00000000 |  0006fbb0 |  2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING |                                     \r\n|  12| .debug_pubnames|  0000f2ec |  00000000 |  00000000 |  000a6a72 |  2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING |                                      \r\n|  13| .debug_pubtypes|  0000222e |  00000000 |  00000000 |  000b5d5e |  2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING |                                      \r\n|  14| .ARM.attributes|  0000003a |  00000000 |  00000000 |  000b7f8c |  2**0|\r\n|                  CONTENTS |   READONLY |                                        \r\n|  15| .debug_frame |  0000705c |  00000000 |  00000000 |  000b7fc8 |  2**2|\r\n|                  CONTENTS |   READONLY, DEBUGGING |                                        \r\n|  16| .debug_line  |  0002a89e |  00000000 |  00000000 |  000bf024 |  2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING |                                        \r\n|  17| .debug_macinfo|  00000007 |  00000000 |  00000000 |  000e98c2 |  2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING |                                        \r\n|  18| .comment     |  000000a3 |  00000000 |  00000000 |  000e98c9 |  2**0 |\r\n|                  CONTENTS |   READONLY |\r\n\r\nWith `RUSTFLAGS=\"-Zinstrument-coverage -Zno-profiler-runtime\"` \r\n\r\nSections:\r\n\r\n|Idx | Name  |        Size  |    VMA   |    LMA   |    File off | Algn|\r\n|----|-------|--------------|----------|----------|-------------|-----|\r\n|  0 | .ARM.exidx |   00000010  |  00010134  |  00010134  |  00000134  |  2**2 |\r\n|                 CONTENTS | ALLOC, LOAD, READONLY, DATA |\r\n|  1 | __llvm_prf_names |  000003a2  |  00010144  |  00010144  |  00000144   | 2**0 | \r\n|                  CONTENTS | ALLOC, LOAD, READONLY, DATA |\r\n|  2 | .text    |     000002e6 | 000204e6 | 000204e6 | 000004e6 | 2**1 |\r\n|                  CONTENTS |  ALLOC, LOAD, READONLY, CODE |\r\n|  3 | .init_array |  00000014 | 000307cc | 000307cc | 000007cc | 2**2 |\r\n|                  CONTENTS |  ALLOC, LOAD, DATA |\r\n|  4 | __llvm_prf_cnts | 00000490 | 000407e0 | 000407e0 | 000007e0 | 2**3 |\r\n|                  CONTENTS |  ALLOC, LOAD, DATA |\r\n|  5 | __llvm_prf_data | 00000820 | 00040c70 | 00040c70 | 00000c70 | 2**3 |\r\n|                  CONTENTS |  ALLOC, LOAD, DATA |\r\n|  6 | __llvm_covfun |  000009fa | 00000000 | 00000000 | 00001490 | 2**3 |\r\n|                  CONTENTS |  READONLY |\r\n|  7 |  __llvm_covmap |  000001cc | 00000000 | 00000000 | 00001e90 | 2**3 |\r\n|                  CONTENTS |  READONLY |\r\n|  8 | .debug_loc |   00002ef3 | 00000000 | 00000000 | 0000205c | 2**0 |\r\n|                  CONTENTS |  READONLY, DEBUGGING |\r\n|  9 | .debug_abbrev | 00002110 | 00000000 | 00000000 | 00004f4f | 2**0 |\r\n|                  CONTENTS |  READONLY, DEBUGGING |\r\n| 10 | .debug_info |  0002bbcb | 00000000 | 00000000 | 0000705f | 2**0 |\r\n|                  CONTENTS |  READONLY, DEBUGGING |\r\n| 11 | .debug_aranges | 000020a0 | 00000000 | 00000000 | 00032c30 | 2**3 |\r\n|                  CONTENTS |  READONLY, DEBUGGING |\r\n| 12 | .debug_ranges | 0001a668 | 00000000 | 00000000 | 00034cd0 | 2**0 |\r\n|                  CONTENTS |  READONLY, DEBUGGING |\r\n| 13 | .debug_str  |   00037061 | 00000000 | 00000000 | 0004f338 | 2**0 |\r\n|                  CONTENTS |  READONLY, DEBUGGING |\r\n| 14 | .debug_pubnames | 0000efef | 00000000 | 00000000 | 00086399 | 2**0 |\r\n|                  CONTENTS |  READONLY, DEBUGGING |\r\n| 15 | .debug_pubtypes | 00001ed7 | 00000000 |  00000000 | 00095388 | 2**0 |\r\n|                  CONTENTS |  READONLY, DEBUGGING |\r\n| 16 | .ARM.attributes | 00000038 | 00000000 | 00000000 |  0009725f | 2**0 |\r\n|                  CONTENTS |  READONLY |\r\n| 17 | .debug_frame |  0000719c | 00000000 |  00000000 | 00097298 | 2**2 |\r\n|                  CONTENTS |  READONLY, DEBUGGING |\r\n| 18 | .debug_line |  0002a639 | 00000000 | 00000000 | 0009e434 | 2**0 |\r\n|                  CONTENTS |  READONLY, DEBUGGING |\r\n| 19 | .debug_macinfo |  00000007 | 00000000 | 00000000 | 000c8a6d | 2**0 |\r\n|                  CONTENTS |  READONLY, DEBUGGING |\r\n| 20 | .comment   |   000000a3 | 00000000 | 00000000 | 000c8a74 | 2**0 |\r\n|                 CONTENTS |  READONLY |\r\n\r\nAnd then for the process of elimination I removed -Zinstrument-coverage and found the follow which seems wrong to me:\r\n\r\nWith `RUSTFLAGS=\"-Zno-profiler-runtime\"` \r\nSections:\r\n\r\n|Idx | Name  |        Size  |    VMA   |    LMA   |    File off | Algn|\r\n|----|-------|--------------|----------|----------|-------------|-----|\r\n | 0 | .debug_loc  |  00003430 | 00000000 | 00000000 | 00000094 | 2**0 |\r\n|                  CONTENTS |   READONLY, DEBUGGING|\r\n|  1 | .debug_abbrev |00002172 | 00000000 | 00000000 | 000034c4 | 2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING|\r\n|  2 | .debug_info |  0002cf7a | 00000000 | 00000000 | 00005636 | 2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING|\r\n|  3 | .debug_aranges| 00002090 | 00000000 | 00000000 | 000325b0 | 2**3|\r\n|                  CONTENTS |   READONLY, DEBUGGING|\r\n|  4 | .debug_ranges| 0001a670 | 00000000 | 00000000 | 00034640 | 2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING|\r\n|  5 | .debug_str |   0003695a | 00000000 | 00000000 | 0004ecb0 | 2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING|\r\n|  6 | .debug_pubnames |0000f089|  00000000 | 00000000 | 0008560a | 2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING|\r\n|  7 | .debug_pubtypes |00001f0f | 00000000 | 00000000 | 00094693  |2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING|\r\n|  8 | .ARM.attributes |0000003a | 00000000 | 00000000 | 000965a2 | 2**0|\r\n|                  CONTENTS |   READONLY|\r\n|  9 | .debug_frame | 00006f64 | 00000000 | 00000000 | 000965dc|  2**2|\r\n|                  CONTENTS |   READONLY, DEBUGGING|\r\n| 10 | .debug_line |  0002a5c8|  00000000 | 00000000 | 0009d540 | 2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING|\r\n| 11 | .debug_macinfo| 00000007 | 00000000 | 00000000 | 000c7b08 | 2**0|\r\n|                  CONTENTS |   READONLY, DEBUGGING|\r\n| 12 | .comment   |   000000a3 | 00000000 | 00000000 | 000c7b0f | 2**0|\r\n|                  CONTENTS |   READONLY | \r\n\r\nI hope this is helpful, and formatting objdump sections as markdown tables wasn't for naught, I can also provide built. I've also been jumping back and forth through the text of this issue trying to edit it for clarity so hopefully it all makes sense.", "closed_by": {"login": "xd009642", "id": 3472518, "node_id": "MDQ6VXNlcjM0NzI1MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/3472518?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xd009642", "html_url": "https://github.com/xd009642", "followers_url": "https://api.github.com/users/xd009642/followers", "following_url": "https://api.github.com/users/xd009642/following{/other_user}", "gists_url": "https://api.github.com/users/xd009642/gists{/gist_id}", "starred_url": "https://api.github.com/users/xd009642/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xd009642/subscriptions", "organizations_url": "https://api.github.com/users/xd009642/orgs", "repos_url": "https://api.github.com/users/xd009642/repos", "events_url": "https://api.github.com/users/xd009642/events{/privacy}", "received_events_url": "https://api.github.com/users/xd009642/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/91409/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/91409/timeline", "performed_via_github_app": null, "state_reason": "completed"}