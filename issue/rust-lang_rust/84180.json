{"url": "https://api.github.com/repos/rust-lang/rust/issues/84180", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/84180/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/84180/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/84180/events", "html_url": "https://github.com/rust-lang/rust/issues/84180", "id": 857486445, "node_id": "MDU6SXNzdWU4NTc0ODY0NDU=", "number": 84180, "title": "-Zinstrument-coverage producing coverage report which claims line is never run", "user": {"login": "alex", "id": 772, "node_id": "MDQ6VXNlcjc3Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/772?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alex", "html_url": "https://github.com/alex", "followers_url": "https://api.github.com/users/alex/followers", "following_url": "https://api.github.com/users/alex/following{/other_user}", "gists_url": "https://api.github.com/users/alex/gists{/gist_id}", "starred_url": "https://api.github.com/users/alex/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alex/subscriptions", "organizations_url": "https://api.github.com/users/alex/orgs", "repos_url": "https://api.github.com/users/alex/repos", "events_url": "https://api.github.com/users/alex/events{/privacy}", "received_events_url": "https://api.github.com/users/alex/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2483744621, "node_id": "MDU6TGFiZWwyNDgzNzQ0NjIx", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-code-coverage", "name": "A-code-coverage", "color": "f7e101", "default": false, "description": "Area: Source-based code coverage (-Cinstrument-coverage)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2021-04-14T03:27:03Z", "updated_at": "2021-04-28T10:46:07Z", "closed_at": "2021-04-28T10:46:07Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "I'm attempting to use `-Zinstrument-coverage` to measure coverage in a Python extension module (using pyo3). This is mostly working well. Except... there's a line that's getting recorded as not being executed, even though it is.\r\n\r\nExact steps for reproducing this can be seen in https://github.com/pyca/cryptography/pull/5970. Specifically it's claimed that this line isn't covered: https://github.com/pyca/cryptography/blob/main/src/rust/src/asn1.rs#L40\r\n\r\nThat is line 40, a chained method call.\r\n\r\n(I realize this is a somewhat involved example (there's Python! and numerous crates!), but I'm also not sure how to minimize it further. If there's any intermediate outputs I can produce, just ask!))\r\n\r\nLooking at the raw `llvm-cov show` output, I see the following:\r\n\r\n```\r\n  | _RNvNtCslsOXpOCSGQA_17cryptography_rust4asn128___pyo3_raw_parse_tls_feature:\r\n  |   36|      4|#[pyo3::prelude::pyfunction]\r\n  ------------------\r\n   37|      4|fn parse_tls_feature(py: pyo3::Python<'_>, data: &[u8]) -> pyo3::PyResult<pyo3::PyObject> {\r\n   38|      4|    let tls_feature_type_to_enum = py\r\n   39|      4|        .import(\"cryptography.x509.extensions\")?\r\n                                                             ^0\r\n   40|      0|        .getattr(\"_TLS_FEATURE_TYPE_TO_ENUM\")?;\r\n   41|       |\r\n   42|      4|    let features = asn1::parse::<_, PyAsn1Error, _>(data, |p| {\r\n   43|      4|        let features = pyo3::types::PyList::empty(py);\r\n   44|      5|        for el in p.read_element::<asn1::SequenceOf<u64>>()? {\r\n                                ^4                                       ^0\r\n   45|      5|            let feature = el?;\r\n                                          ^0\r\n   46|      5|            let py_feature = tls_feature_type_to_enum.get_item(feature.to_object(py))?;\r\n                                                                                                   ^0\r\n   47|      5|            features.append(py_feature)?;\r\n                                                     ^0\r\n   48|       |        }\r\n   49|      4|        Ok(features)\r\n   50|      4|    })?;\r\n                    ^0\r\n   51|       |\r\n   52|      4|    let x509_module = py.import(\"cryptography.x509\")?;\r\n                                                                  ^0\r\n   53|      4|    x509_module\r\n   54|      4|        .call1(\"TLSFeature\", (features,))\r\n   55|      4|        .map(|o| o.to_object(py))\r\n   56|      4|}\r\n   57|       |\r\n```\r\n\r\nThis confirms the same thing, that coverage thinks line 40 isn't being run. But we can tell it is, Line 42 _is_ being run, and we can't get to line 42 without going through line 40 :-)\r\n\r\n### Meta\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.53.0-nightly (07e0e2ec2 2021-03-24)\r\nbinary: rustc\r\ncommit-hash: 07e0e2ec268c140e607e1ac7f49f145612d0f597\r\ncommit-date: 2021-03-24\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.53.0-nightly\r\nLLVM version: 12.0.0\r\n```\r\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/84180/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/84180/timeline", "performed_via_github_app": null, "state_reason": "completed"}