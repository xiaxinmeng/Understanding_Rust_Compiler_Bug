{"url": "https://api.github.com/repos/rust-lang/rust/issues/38160", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/38160/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/38160/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/38160/events", "html_url": "https://github.com/rust-lang/rust/issues/38160", "id": 193368222, "node_id": "MDU6SXNzdWUxOTMzNjgyMjI=", "number": 38160, "title": "Compiler crash when macro generates associated const with stringify", "user": {"login": "MasonRemaley", "id": 5516083, "node_id": "MDQ6VXNlcjU1MTYwODM=", "avatar_url": "https://avatars.githubusercontent.com/u/5516083?v=4", "gravatar_id": "", "url": "https://api.github.com/users/MasonRemaley", "html_url": "https://github.com/MasonRemaley", "followers_url": "https://api.github.com/users/MasonRemaley/followers", "following_url": "https://api.github.com/users/MasonRemaley/following{/other_user}", "gists_url": "https://api.github.com/users/MasonRemaley/gists{/gist_id}", "starred_url": "https://api.github.com/users/MasonRemaley/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/MasonRemaley/subscriptions", "organizations_url": "https://api.github.com/users/MasonRemaley/orgs", "repos_url": "https://api.github.com/users/MasonRemaley/repos", "events_url": "https://api.github.com/users/MasonRemaley/events{/privacy}", "received_events_url": "https://api.github.com/users/MasonRemaley/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 46741598, "node_id": "MDU6TGFiZWw0Njc0MTU5OA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-test", "name": "E-needs-test", "color": "02e10c", "default": false, "description": "Call for participation: writing correctness tests"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2016-12-04T19:03:06Z", "updated_at": "2017-05-26T18:12:07Z", "closed_at": "2017-05-26T18:12:07Z", "author_association": "NONE", "active_lock_reason": null, "body": "I get a compiler crash when running the following code.\r\n\r\nI get the crash with or without `#![feature(associated_consts)]` at the top of the file, but I don't get it if I generate a normal constant, if I replace the `stringify!(abc)` with a string literal, or if I write the code the macro generates directly into the source instead of generating it through a macro.\r\n\r\nI tried this code:\r\n\r\n```\r\ntrait MyTrait {\r\n    const MY_CONST: &'static str;\r\n}\r\n\r\nmacro_rules! my_macro {\r\n    () => {\r\n        struct MyStruct;\r\n\r\n        impl MyTrait for MyStruct {\r\n            // Note the stringify here, without it I don't get a crash.\r\n            const MY_CONST: &'static str = stringify!(abc);\r\n        }\r\n    }\r\n}\r\n\r\nmy_macro!();\r\n\r\nfn main() {}\r\n```\r\n\r\nError message:\r\n```\r\nthread 'rustc' panicked at 'adding a def'n for node-id NodeId(3) and data Initializer but a previous def'n exists: DefData { key: DefKey { parent: Some(DefIndex(0)), disambiguated_data: DisambiguatedDefPathData { data: TypeNs(\"std\"), disambiguator: 0 } }, node_id: NodeId(3) }', ../src/librustc/hir/map/definitions.rs:279\r\n```\r\n\r\n## Meta\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.15.0-nightly (c80c31a50 2016-12-02)\r\nbinary: rustc\r\ncommit-hash: c80c31a502c838f9ec06f1003d7c61cf9de9d551\r\ncommit-date: 2016-12-02\r\nhost: x86_64-apple-darwin\r\nrelease: 1.15.0-nightly\r\nLLVM version: 3.9\r\n```\r\n\r\nBacktrace:\r\n```\r\nstack backtrace:\r\n   1:        0x1102ed0da - std::sys::imp::backtrace::tracing::imp::write::hbea47d9dd19b523c\r\n   2:        0x1102fa3cf - std::panicking::default_hook::{{closure}}::h6875a2976258b020\r\n   3:        0x1102f9f7d - std::panicking::default_hook::h88ffbc5922643264\r\n   4:        0x1102fa896 - std::panicking::rust_panic_with_hook::hc790e47d4ecc86cd\r\n   5:        0x1102fa734 - std::panicking::begin_panic::hc066339e2fdc17d1\r\n   6:        0x1102fa652 - std::panicking::begin_panic_fmt::h5912b2d2df332044\r\n   7:        0x10cbdc3c5 - rustc::hir::map::definitions::Definitions::create_def_with_parent::h9f915077b7729a67\r\n   8:        0x10cbd7275 - <rustc::hir::map::def_collector::DefCollector<'a> as syntax::visit::Visitor>::visit_impl_item::hfd39f06fd36cebc4\r\n   9:        0x10cb68201 - syntax::visit::walk_item::hf2d1c4f2e66576d9\r\n  10:        0x10cbd6c75 - <rustc::hir::map::def_collector::DefCollector<'a> as syntax::visit::Visitor>::visit_item::{{closure}}::hd7b5b0a8a329ace5\r\n  11:        0x10cbd65c2 - <rustc::hir::map::def_collector::DefCollector<'a> as syntax::visit::Visitor>::visit_item::h763ef3a101744485\r\n  12:        0x10ca5a41e - rustc_resolve::macros::<impl syntax::ext::base::Resolver for rustc_resolve::Resolver<'a>>::visit_expansion::h7d935db3784368ad\r\n  13:        0x10fd0717e - syntax::ext::expand::MacroExpander::collect_invocations::h67e2a1c913dc4591\r\n  14:        0x10fd0632e - syntax::ext::expand::MacroExpander::expand::hd3e73837bd4e019c\r\n  15:        0x10fd05456 - syntax::ext::expand::MacroExpander::expand_crate::hdb654461100f1c42\r\n  16:        0x10bae5ceb - rustc_driver::driver::phase_2_configure_and_expand::{{closure}}::h78edc3698ca57871\r\n  17:        0x10badec60 - rustc_driver::driver::phase_2_configure_and_expand::hb40d70b49cec9f8f\r\n  18:        0x10bad8840 - rustc_driver::driver::compile_input::h8e119234b60571d5\r\n  19:        0x10bb20f8b - rustc_driver::run_compiler::h57c4f233cd1a0c04\r\n  20:        0x10ba3fce8 - std::panicking::try::do_call::hf679f17bf3b43b0b\r\n  21:        0x1102fce4a - __rust_maybe_catch_panic\r\n  22:        0x10ba62bdf - <F as alloc::boxed::FnBox<A>>::call_box::h21b5b32059700da6\r\n  23:        0x1102f9514 - std::sys::imp::thread::Thread::new::thread_start::h8084b1107992ae5b\r\n  24:     0x7fff99c7eaaa - _pthread_body\r\n  25:     0x7fff99c7e9f6 - _pthread_start\r\n\r\nerror: Could not compile `BugDemo`.\r\n```", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/38160/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/38160/timeline", "performed_via_github_app": null, "state_reason": "completed"}