{"url": "https://api.github.com/repos/rust-lang/rust/issues/98014", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/98014/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/98014/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/98014/events", "html_url": "https://github.com/rust-lang/rust/issues/98014", "id": 1268440453, "node_id": "I_kwDOAAsO6M5Lmt2F", "number": 98014, "title": "E0502: Borrow checker fails when borrowing with opposite conditions", "user": {"login": "Pegasust", "id": 35638399, "node_id": "MDQ6VXNlcjM1NjM4Mzk5", "avatar_url": "https://avatars.githubusercontent.com/u/35638399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Pegasust", "html_url": "https://github.com/Pegasust", "followers_url": "https://api.github.com/users/Pegasust/followers", "following_url": "https://api.github.com/users/Pegasust/following{/other_user}", "gists_url": "https://api.github.com/users/Pegasust/gists{/gist_id}", "starred_url": "https://api.github.com/users/Pegasust/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Pegasust/subscriptions", "organizations_url": "https://api.github.com/users/Pegasust/orgs", "repos_url": "https://api.github.com/users/Pegasust/repos", "events_url": "https://api.github.com/users/Pegasust/events{/privacy}", "received_events_url": "https://api.github.com/users/Pegasust/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2022-06-12T04:27:20Z", "updated_at": "2022-06-13T02:30:28Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThe borrow checker complains that I borrow a resource both immutably and mutably within the same (loop) scope. \r\nHowever, these borrows are the opposite of an immutable condition. \r\n\r\nI could rewrite the code using tuple destructurization and the borrow checker stops complaining.\r\n\r\nThis issue is opened to suggest a look into the borrow checker, or simply to provide some documentation on the workaround from rustc.\r\n-->\r\n\r\nGiven the following code: <!-- Please provide a link to play.rust-lang.org -->\r\n\r\n```rust\r\nfn no_compile_main() {\r\n    let mut _buf0 = 12;\r\n    let mut _buf1 = 14;\r\n\r\n    for i in 0..5 {\r\n        let last = if i % 2 == 0 {&_buf0} else {&_buf1};\r\n        let this = if i % 2 == 0 {&mut _buf1} else {&mut _buf0};\r\n        *this += 1;\r\n        println!(\"i: {}, last: {}, this: {}\", i, last, this);\r\n    }\r\n}\r\n\r\nfn main() {\r\n    let mut _buf0 = 12;\r\n    let mut _buf1 = 14;\r\n    for i in 0..5 {\r\n        let (last, this) =\r\n            if i % 2 == 0 {\r\n                (&_buf0, &mut _buf1)\r\n            } else {\r\n                (&_buf1, &mut _buf0)\r\n            };\r\n        *this += 1;\r\n        println!(\"i: {}, last: {}, this: {}\", i, last, this);\r\n    }\r\n}\r\n```\r\n\r\nThe current output is:\r\n\r\n```\r\nerror[[E0502]](https://doc.rust-lang.org/stable/error-index.html#E0502): cannot borrow `_buf1` as mutable because it is also borrowed as immutable\r\n  --> src/main.rs:8:35\r\n   |\r\n7  |         let last = if i % 2 == 0 {&_buf0} else {&_buf1};\r\n   |                                                 ------ immutable borrow occurs here\r\n8  |         let this = if i % 2 == 0 {&mut _buf1} else {&mut _buf0};\r\n   |                                   ^^^^^^^^^^ mutable borrow occurs here\r\n9  |         *this += 1;\r\n10 |         println!(\"i: {}, last: {}, this: {}\", i, last, this);\r\n   |                                                  ---- immutable borrow later used here\r\n\r\nerror[[E0502]](https://doc.rust-lang.org/stable/error-index.html#E0502): cannot borrow `_buf0` as mutable because it is also borrowed as immutable\r\n  --> src/main.rs:8:53\r\n   |\r\n7  |         let last = if i % 2 == 0 {&_buf0} else {&_buf1};\r\n   |                                   ------ immutable borrow occurs here\r\n8  |         let this = if i % 2 == 0 {&mut _buf1} else {&mut _buf0};\r\n   |                                                     ^^^^^^^^^^ mutable borrow occurs here\r\n9  |         *this += 1;\r\n10 |         println!(\"i: {}, last: {}, this: {}\", i, last, this);\r\n   |                                                  ---- immutable borrow later used here\r\n\r\nFor more information about this error, try `rustc --explain E0502`.\r\n```\r\n\r\n<!-- The following is not always necessary. -->\r\nIdeally the output should look like:\r\n\r\n```\r\n...\r\nIf the mutable/immutable borrows are under the opposite condition, restructure the code using tuple destructuring:\r\nlet mut a = if cond {&mut _a} else {&mut _b};\r\nlet b = if cond {& _b} else {& a};\r\n\r\ninto\r\nlet (mut a, b) = if cond { (&mut _a, &_b) } else { (&mut _b, &a) };\r\n```\r\n\r\n<!--\r\nIf the problem is not self-explanatory, please provide a rationale for the\r\nchange.\r\n-->\r\n\r\n<!--\r\nIf dramatically different output is caused by small changes, consider also\r\nadding them here.\r\n\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions. The output might also be\r\ndifferent depending on the Edition.\r\n-->\r\n \r\nThe problem still exists in the beta and nightly versions.\r\n[Illustrated code in Godbolt for different versions](https://rust.godbolt.org/#z:OYLghAFBqd5QCxAYwPYBMCmBRdBLAF1QCcAaPECAMzwBtMA7AQwFtMQByARg9KtQYEAysib0QXACx8BBAKoBnTAAUAHpwAMvAFYTStJg1DEArgoKkl9ZATwDKjdAGFUtEywYgATKUcAZPAZMADl3ACNMYm8AdlIAB1QFQjsGFzcPb3jE5IEAoNCWCKivWKtMGxShAiZiAjT3Ty5LTGtbASqagjyQ8Mi9c076jKaB2u6CookASktUE2Jkdg4AUg0AQSoGAGoGVAB9NBY4ukw9liZAiCmt5eiAIVW1reet%2BgItlhN3vbCTKg0bgBmAAiWy4XmWgIe6xer0w70%2B31%2BVC4QNBUkh0LWj1h/GIWzwBO2GgAdCSAKw3e442EvN6vJjmNEEqgEm5eSleNGQ0EA24PLwANh%2Bfw0t1BLSUVIFwuRXHFmJptLh7wICDwCmZeFZhOWHK2XJ5PK2fOpQsRWxFKPFW0lmGlesFFqtYuiwMVMOVWwAVGqNeyHiCwR6nl64sRAgRaAwwJA9V4KA63aQGeYQEngSm/Qp0/yFV4fASUwZzFn1QopiHYQr1jXsetNh8Lgwrg7Pc96c7kXyg%2BCq3T4R8vpa5cyMVClVs8WzAiayZS8%2B3afSICWLFts9cjUuvSy2XrOdyg6asbvdxBHS6U46u38uJWd16bXa26Gz7SL0KrU12U7hy6HzfM8FQnR9nl9csA2NeVQKA2Fw0jaNY0/BNc2pZNUwINCHgw7NsPzQs8GLRl103ftnjrcUOBmWhOHJXhPA4LRSFQTgACUzHeBQ5gWe09UBHhSCwpjqJmABrEBJEkElBQADlkwUpLkhSlIU/ROEkBjNF4ViOF4HMNCE7SZjgWAkEOY56DICgIAsk4ogYPBgAQKMAE8%2BDoAhIhzCAwm00gwkCGpXP8w42EEAB5BhaBCkTSCwc4jHEOL8GIcpbAAN0wHM4swVRyi%2BJZmMjFp/NoPAwmIYKXCwfyCAjFhOB4GYqAMYAFAANTwTAAHcIriRgmt4fhBBEMR2CkGRBEUFR1Di3QmgMIwQFMUtyrCHNIBmVA4jaBgcv0lp0pSBwGGcVwGj0fxAh6Qo%2BiaBIkj2oZGiyJ6UnGXoohGI6Knaapahe/pfr2joxhuiZ7ssAG6gu4Zoc6T67u%2BmZuPmRY9HqzAlma9SOHo0hGOY3TVoIZAdiclyYq2CAONLLZcEIEh2QElMXCOeyWfvXhhK0KZxO8LgSQATmiWSNC8LhRfFyXhdkvHNMJ/zdP0kBDN56jSFMxAQDmAg4i%2BchKDsqzglYJZSfJoXBSF5jMHwIgI3QPQRuEURxEm12ZrUfyFtIHqqriIaaLorS4t0iKvgN95UFZS2KectyafZyzIi5qYeeMgXAUBEkc/zgvC4VsPic4VX1azvGvBLnSy6MkT%2BdILLiCSexJCAA%3D%3D%3D)", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/98014/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/98014/timeline", "performed_via_github_app": null, "state_reason": null}