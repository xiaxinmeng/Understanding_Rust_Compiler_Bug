{"url": "https://api.github.com/repos/rust-lang/rust/issues/34237", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/34237/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/34237/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/34237/events", "html_url": "https://github.com/rust-lang/rust/issues/34237", "id": 159804027, "node_id": "MDU6SXNzdWUxNTk4MDQwMjc=", "number": 34237, "title": "Performance difference based on added no-op scope braces", "user": {"login": "ghost", "id": 10137, "node_id": "MDQ6VXNlcjEwMTM3", "avatar_url": "https://avatars.githubusercontent.com/u/10137?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ghost", "html_url": "https://github.com/ghost", "followers_url": "https://api.github.com/users/ghost/followers", "following_url": "https://api.github.com/users/ghost/following{/other_user}", "gists_url": "https://api.github.com/users/ghost/gists{/gist_id}", "starred_url": "https://api.github.com/users/ghost/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ghost/subscriptions", "organizations_url": "https://api.github.com/users/ghost/orgs", "repos_url": "https://api.github.com/users/ghost/repos", "events_url": "https://api.github.com/users/ghost/events{/privacy}", "received_events_url": "https://api.github.com/users/ghost/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2016-06-12T02:40:44Z", "updated_at": "2017-05-14T19:45:40Z", "closed_at": "2017-05-14T19:45:40Z", "author_association": "NONE", "active_lock_reason": null, "body": "There appears to be an unexpected performance difference when adding an extra level of unneeded scope to a hot function.\n\nUnfortunately, I ran into this while trying to make a raytracer, yet I've been having trouble finding a truly-minimal case that shows the disrepancy in performance (though I have made some progress). So, the MWE I have is 147 lines of a somewhat nonsensical reduction of the raytracer to some bare elements.\n\nAnyway, here is the reproducible steps:\n\n```\n$ git clone git://genki.is/slow\n$ cd slow\n$ git fetch\n$ git checkout master\n$ cargo run --release\nTime: 11.51502833100676 seconds\n$ git checkout add-nop-scope\n$ cargo run --release\nTime: 8.3559323780064 seconds\n```\n\nThis ~1.4-times discrepancy appears to scale with the amount of work done (the easiest way to test this is changing the value `750 * 750` in main()). Also note it only appears to have this difference when using  --release.\n\nYou can see that branch add-nop-scope adds an extra level of scope where it shouldn't be needed.\n\nI expected to see this happen: Them to take just about the same amount of time.\n## Further notes\n\nI brought this up on #rust-beginners and received the help of @ubsan and @aatch in particular. My original observation was that it differed between a deconstructing-let vs a single-case-match. Here are my notes from what the two of them instead said [though please note that I could have misinterpreted them, and I could have missed some other key points]:\n\n@ubsan noticed that it was simply the extra level of scope causing the difference. @aatch then noted that the discrepancy seems to be caused by the series of early-returns. He mentioned the idea that thus Rust generates a separate return slot for each return, but that one would think LLVM would optimize this away. And thus it is surprising that the one with the added scope block is faster. So note that for example, if one changes the last `Some(t)` to `return Some(t);`, it causes both master and add-nop-scope to take the same amount of time: about 10 seconds runtime.\n\n@ubsan also noticed that with -Zorbit, both master and add-nop-scope appear to take about 10 seconds runtime, and thus that this would appear to be a MIR performance regression as well (but that the discrepancy disappears).\n\nI apologize for the nonsensical manner of the code, again, it was hard to find a MWE from the ground up due to the changes seemingly caused by early returns being taken or not.\n## Meta\n\n```\n$ rustc --version --verbose\nrustc 1.11.0-nightly (a967611d8 2016-05-30)\nbinary: rustc\ncommit-hash: a967611d8ffececb5ed0ecf6a205b464d7a5a31e\ncommit-date: 2016-05-30\nhost: x86_64-unknown-linux-gnu\nrelease: 1.11.0-nightly\n```\n\nPlease don't hesitate to let me know if I can add any further details or help!\n", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/34237/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/34237/timeline", "performed_via_github_app": null, "state_reason": "completed"}