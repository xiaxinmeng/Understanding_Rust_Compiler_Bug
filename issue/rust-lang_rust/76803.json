{"url": "https://api.github.com/repos/rust-lang/rust/issues/76803", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/76803/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/76803/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/76803/events", "html_url": "https://github.com/rust-lang/rust/issues/76803", "id": 703008705, "node_id": "MDU6SXNzdWU3MDMwMDg3MDU=", "number": 76803, "title": "starting from nightly-2020-08-18 rustls can't connect to some websites", "user": {"login": "paolobarbolini", "id": 6215781, "node_id": "MDQ6VXNlcjYyMTU3ODE=", "avatar_url": "https://avatars.githubusercontent.com/u/6215781?v=4", "gravatar_id": "", "url": "https://api.github.com/users/paolobarbolini", "html_url": "https://github.com/paolobarbolini", "followers_url": "https://api.github.com/users/paolobarbolini/followers", "following_url": "https://api.github.com/users/paolobarbolini/following{/other_user}", "gists_url": "https://api.github.com/users/paolobarbolini/gists{/gist_id}", "starred_url": "https://api.github.com/users/paolobarbolini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/paolobarbolini/subscriptions", "organizations_url": "https://api.github.com/users/paolobarbolini/orgs", "repos_url": "https://api.github.com/users/paolobarbolini/repos", "events_url": "https://api.github.com/users/paolobarbolini/events{/privacy}", "received_events_url": "https://api.github.com/users/paolobarbolini/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252628, "node_id": "MDU6TGFiZWwyNjIyNTI2Mjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-beta", "name": "regression-from-stable-to-beta", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to beta."}, {"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1927601458, "node_id": "MDU6TGFiZWwxOTI3NjAxNDU4", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-mir-opt", "name": "A-mir-opt", "color": "f7e101", "default": false, "description": "Area: MIR optimizations"}, {"id": 1966877457, "node_id": "MDU6TGFiZWwxOTY2ODc3NDU3", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-critical", "name": "P-critical", "color": "eb6420", "default": false, "description": "Critical priority"}], "state": "closed", "locked": false, "assignee": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 19, "created_at": "2020-09-16T19:11:42Z", "updated_at": "2020-09-30T16:18:19Z", "closed_at": "2020-09-30T16:18:19Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried this code:\r\n\r\n```rust\r\nuse std::io::{self, stdout, Write};\r\nuse std::net::TcpStream;\r\nuse std::sync::Arc;\r\n\r\nuse rustls::{ciphersuite, ClientConfig, ClientSession, Session, Stream};\r\nuse webpki::DNSNameRef;\r\nuse webpki_roots::TLS_SERVER_ROOTS;\r\n\r\nfn main() {\r\n    env_logger::init();\r\n\r\n    let mut config = ClientConfig::with_ciphersuites(&[&ciphersuite::TLS13_AES_256_GCM_SHA384]);\r\n    config\r\n        .root_store\r\n        .add_server_trust_anchors(&TLS_SERVER_ROOTS);\r\n    // works with TLSv1_2 or with different ciphersuites\r\n    config.versions = vec![rustls::ProtocolVersion::TLSv1_3];\r\n    // this is what gets picked by default when using TLS 1.3\r\n    config.ciphersuites = vec![&rustls::ciphersuite::TLS13_AES_256_GCM_SHA384];\r\n\r\n    const DOMAIN: &str = \"example.com\";\r\n\r\n    let dns_name = DNSNameRef::try_from_ascii_str(DOMAIN).unwrap();\r\n    let mut sess = ClientSession::new(&Arc::new(config), dns_name);\r\n    let mut sock = TcpStream::connect((DOMAIN, 443)).unwrap();\r\n    let mut tls = Stream::new(&mut sess, &mut sock);\r\n    tls.write_all(\r\n        [\r\n            \"GET / HTTP/1.1\\r\\n\",\r\n            \"Host: \",\r\n            DOMAIN,\r\n            \"\\r\\n\",\r\n            \"Connection: close\\r\\n\",\r\n            \"\\r\\n\",\r\n        ]\r\n        .join(\"\")\r\n        .as_bytes(),\r\n    )\r\n    .unwrap(); // fails here\r\n    let ciphersuite = tls.sess.get_negotiated_ciphersuite().unwrap();\r\n    println!(\"Current ciphersuite: {:?}\", ciphersuite.suite);\r\n\r\n    let mut out = stdout();\r\n    if let Err(err) = io::copy(&mut tls, &mut out) {\r\n        eprintln!(\"err: {}\", err)\r\n    }\r\n}\r\n```\r\n\r\nWith dependencies:\r\n\r\n```toml\r\nrustls = { version = \"0.18.1\", features = [\"logging\"] }\r\nwebpki = \"0.21.3\"\r\nwebpki-roots = \"0.20.0\"\r\nenv_logger = \"0.7.1\"\r\n```\r\n\r\nI expected to see this happen: *it establishes a TLS connection, sends the HTTP/1.1 request and prints the entire response*\r\n\r\nInstead, this happened: *fails with Custom { kind: InvalidData, error: DecryptError }*\r\n\r\nI bisected this to _nightly-2020-08-18_. I couldn't reproduce this issue with other websites.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.48.0-nightly (9b4154193 2020-09-14)\r\nbinary: rustc\r\ncommit-hash: 9b4154193e8471f36b1a9e781f1ef7d492fc6a6c\r\ncommit-date: 2020-09-14\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.48.0-nightly\r\nLLVM version: 11.0\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary>Backtrace when running with cargo run</summary>\r\n<p>\r\n\r\n```\r\nthread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: Custom { kind: InvalidData, error: DecryptError }', src/main.rs:39:6\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/9b4154193e8471f36b1a9e781f1ef7d492fc6a6c/library/std/src/panicking.rs:483\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/9b4154193e8471f36b1a9e781f1ef7d492fc6a6c/library/core/src/panicking.rs:85\r\n   2: core::option::expect_none_failed\r\n             at /rustc/9b4154193e8471f36b1a9e781f1ef7d492fc6a6c/library/core/src/option.rs:1221\r\n   3: core::result::Result<T,E>::unwrap\r\n             at /home/paolo/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/result.rs:973\r\n   4: proxy_bug::main\r\n             at ./src/main.rs:27\r\n   5: core::ops::function::FnOnce::call_once\r\n             at /home/paolo/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:227\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n```\r\n\r\n</p>\r\n</details>\r\n", "closed_by": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/76803/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/76803/timeline", "performed_via_github_app": null, "state_reason": "completed"}