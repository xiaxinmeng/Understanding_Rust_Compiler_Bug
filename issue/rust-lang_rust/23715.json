{"url": "https://api.github.com/repos/rust-lang/rust/issues/23715", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/23715/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/23715/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/23715/events", "html_url": "https://github.com/rust-lang/rust/issues/23715", "id": 64368934, "node_id": "MDU6SXNzdWU2NDM2ODkzNA==", "number": 23715, "title": "walk_dir uses too many file descriptors", "user": {"login": "hugoduncan", "id": 54043, "node_id": "MDQ6VXNlcjU0MDQz", "avatar_url": "https://avatars.githubusercontent.com/u/54043?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hugoduncan", "html_url": "https://github.com/hugoduncan", "followers_url": "https://api.github.com/users/hugoduncan/followers", "following_url": "https://api.github.com/users/hugoduncan/following{/other_user}", "gists_url": "https://api.github.com/users/hugoduncan/gists{/gist_id}", "starred_url": "https://api.github.com/users/hugoduncan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hugoduncan/subscriptions", "organizations_url": "https://api.github.com/users/hugoduncan/orgs", "repos_url": "https://api.github.com/users/hugoduncan/repos", "events_url": "https://api.github.com/users/hugoduncan/events{/privacy}", "received_events_url": "https://api.github.com/users/hugoduncan/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2015-03-25T20:47:22Z", "updated_at": "2015-12-18T22:32:16Z", "closed_at": "2015-12-18T22:32:16Z", "author_association": "NONE", "active_lock_reason": null, "body": "The current implementation of `fs::walk_dir` is breadth first, with a file descriptor being held for each directory that has been found but not yet traversed.  This can lead to \"Too many open files\" errors.\n\nOn my mac, the default limit for file descriptors is 256.  A `.git/objects` directory can contain 257 directories, so with a breadth first search with a queue of ReadDir objects (each of which holds a DIR), this limit can easily be hit.\n\nI can see two possible solutions: either changing the queue to hold paths rather than ReadDir objects, or switching to depth first traversal.\n\nI hit this error running the following on a directory tree containing a `.git` directory, and with a max directory depth of 9.\n\n```\n#![feature(fs_walk)]\n\nuse std::fs;\nuse std::io;\nuse std::path::Path;\n\nfn main() {\n    match walk() {\n        Ok(_) => (),\n        Err(e) => println!(\"ERROR {}\", e)\n    }\n}\n\nfn walk() -> Result<(), io::Error> {\n    for f in try!(fs::walk_dir(&Path::new(\".\"))) {\n        let f = try!(f);\n        println!(\"copy_tree {:?}\", f.path());\n    }\n    Ok(())\n}\n```\n", "closed_by": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/23715/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/23715/timeline", "performed_via_github_app": null, "state_reason": "completed"}