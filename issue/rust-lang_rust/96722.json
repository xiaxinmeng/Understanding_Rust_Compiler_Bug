{"url": "https://api.github.com/repos/rust-lang/rust/issues/96722", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/96722/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/96722/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/96722/events", "html_url": "https://github.com/rust-lang/rust/issues/96722", "id": 1226193957, "node_id": "I_kwDOAAsO6M5JFjwl", "number": 96722, "title": "miri reports memory leak for RefCell/Rc example", "user": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1244499056, "node_id": "MDU6TGFiZWwxMjQ0NDk5MDU2", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-miri", "name": "A-miri", "color": "f7e101", "default": false, "description": "Area: The miri tool"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2022-05-05T04:45:11Z", "updated_at": "2022-05-05T18:21:17Z", "closed_at": "2022-05-05T18:21:16Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried this code:\r\n\r\n```rust\r\nuse crate::List::{Cons, Nil};\r\nuse std::cell::RefCell;\r\nuse std::rc::Rc;\r\n\r\n#[derive(Debug)]\r\nenum List {\r\n    Cons(i32, RefCell<Rc<List>>),\r\n    Nil,\r\n}\r\n\r\nimpl List {\r\n    fn tail(&self) -> Option<&RefCell<Rc<List>>> {\r\n        match self {\r\n            Cons(_, item) => Some(item),\r\n            Nil => None,\r\n        }\r\n    }\r\n}\r\n\r\n\r\nfn main() {\r\n    let a = Rc::new(Cons(5, RefCell::new(Rc::new(Nil))));\r\n\r\n    println!(\"a initial rc count = {}\", Rc::strong_count(&a));\r\n    println!(\"a next item = {:?}\", a.tail());\r\n\r\n   let b = Rc::new(Cons(10, RefCell::new(Rc::clone(&a))));\r\n\r\n    println!(\"a rc count after b creation = {}\", Rc::strong_count(&a));\r\n    println!(\"b initial rc count = {}\", Rc::strong_count(&b));\r\n    println!(\"b next item = {:?}\", b.tail());\r\n\r\n    if let Some(link) = a.tail() {\r\n        *link.borrow_mut() = Rc::clone(&b);\r\n    }\r\n    /* \r\n    println!(\"b rc count after changing a = {}\", Rc::strong_count(&b));\r\n    println!(\"a rc count after changing a = {}\", Rc::strong_count(&a));\r\n\r\n    // Uncomment the next line to see that we have a cycle;\r\n    // it will overflow the stack\r\n    // println!(\"a next item = {:?}\", a.tail());\r\n    */\r\n}\r\n```\r\n\r\n`cargo miri run`\r\n\r\n````\r\na initial rc count = 1\r\na next item = Some(RefCell { value: Nil })\r\na rc count after b creation = 2\r\nb initial rc count = 1\r\nb next item = Some(RefCell { value: Cons(5, RefCell { value: Nil }) })\r\nThe following memory was leaked: alloc1664 (Rust heap, size: 40, align: 8) {\r\n    0x00 \u2502 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 \u2502 ................\r\n    0x10 \u2502 00 00 00 00 05 00 00 00 00 00 00 00 00 00 00 00 \u2502 ................\r\n    0x20 \u2502 \u257e0x3a150[a5107]<untagged> (8 ptr bytes)\u257c                         \u2502 \u257e\u2500\u2500\u2500\u2500\u2500\u2500\u257c\r\n}\r\nalloc5107 (Rust heap, size: 40, align: 8) {\r\n    0x00 \u2502 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 \u2502 ................\r\n    0x10 \u2502 00 00 00 00 0a 00 00 00 00 00 00 00 00 00 00 00 \u2502 ................\r\n    0x20 \u2502 \u257e0x28488[a1664]<untagged> (8 ptr bytes)\u257c                         \u2502 \u257e\u2500\u2500\u2500\u2500\u2500\u2500\u257c\r\n}\r\n\r\nerror: the evaluated program leaked memory\r\n\r\nnote: pass `-Zmiri-ignore-leaks` to disable this check\r\n\r\nerror: aborting due to previous error\r\n````\r\n", "closed_by": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/96722/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/96722/timeline", "performed_via_github_app": null, "state_reason": "completed"}