{"url": "https://api.github.com/repos/rust-lang/rust/issues/108847", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/108847/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/108847/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/108847/events", "html_url": "https://github.com/rust-lang/rust/issues/108847", "id": 1612965999, "node_id": "I_kwDOAAsO6M5gI-hv", "number": 108847, "title": "ICE with Axum", "user": {"login": "VelvetToroyashi", "id": 42438262, "node_id": "MDQ6VXNlcjQyNDM4MjYy", "avatar_url": "https://avatars.githubusercontent.com/u/42438262?v=4", "gravatar_id": "", "url": "https://api.github.com/users/VelvetToroyashi", "html_url": "https://github.com/VelvetToroyashi", "followers_url": "https://api.github.com/users/VelvetToroyashi/followers", "following_url": "https://api.github.com/users/VelvetToroyashi/following{/other_user}", "gists_url": "https://api.github.com/users/VelvetToroyashi/gists{/gist_id}", "starred_url": "https://api.github.com/users/VelvetToroyashi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/VelvetToroyashi/subscriptions", "organizations_url": "https://api.github.com/users/VelvetToroyashi/orgs", "repos_url": "https://api.github.com/users/VelvetToroyashi/repos", "events_url": "https://api.github.com/users/VelvetToroyashi/events{/privacy}", "received_events_url": "https://api.github.com/users/VelvetToroyashi/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1359848690, "node_id": "MDU6TGFiZWwxMzU5ODQ4Njkw", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-mcve", "name": "E-needs-mcve", "color": "02e10c", "default": false, "description": "Call for participation: This issue needs a Minimal Complete and Verifiable Example"}], "state": "open", "locked": false, "assignee": {"login": "LYF1999", "id": 17444266, "node_id": "MDQ6VXNlcjE3NDQ0MjY2", "avatar_url": "https://avatars.githubusercontent.com/u/17444266?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LYF1999", "html_url": "https://github.com/LYF1999", "followers_url": "https://api.github.com/users/LYF1999/followers", "following_url": "https://api.github.com/users/LYF1999/following{/other_user}", "gists_url": "https://api.github.com/users/LYF1999/gists{/gist_id}", "starred_url": "https://api.github.com/users/LYF1999/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LYF1999/subscriptions", "organizations_url": "https://api.github.com/users/LYF1999/orgs", "repos_url": "https://api.github.com/users/LYF1999/repos", "events_url": "https://api.github.com/users/LYF1999/events{/privacy}", "received_events_url": "https://api.github.com/users/LYF1999/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "LYF1999", "id": 17444266, "node_id": "MDQ6VXNlcjE3NDQ0MjY2", "avatar_url": "https://avatars.githubusercontent.com/u/17444266?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LYF1999", "html_url": "https://github.com/LYF1999", "followers_url": "https://api.github.com/users/LYF1999/followers", "following_url": "https://api.github.com/users/LYF1999/following{/other_user}", "gists_url": "https://api.github.com/users/LYF1999/gists{/gist_id}", "starred_url": "https://api.github.com/users/LYF1999/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LYF1999/subscriptions", "organizations_url": "https://api.github.com/users/LYF1999/orgs", "repos_url": "https://api.github.com/users/LYF1999/repos", "events_url": "https://api.github.com/users/LYF1999/events{/privacy}", "received_events_url": "https://api.github.com/users/LYF1999/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 3, "created_at": "2023-03-07T08:32:34Z", "updated_at": "2023-03-08T13:27:23Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "### Code\nhttps://github.com/VelvetThePanda/Kobalt/blob/ec48f8a07c063ecf1d68f28a3eade815ac1a393a/iridium/src/api.rs#L84-L97\n\n### Meta\n`rustc --version --verbose`:\n```\nrustc 1.70.0-nightly (7820b62d2 2023-03-05)\nbinary: rustc\ncommit-hash: 7820b62d20bc548096d4632a3487987308cb4b5d\ncommit-date: 2023-03-05\nhost: x86_64-pc-windows-msvc\nrelease: 1.70.0-nightly\nLLVM version: 15.0.7\n\n```\n\n### Error output\n\n```\nerror: internal compiler error: compiler\\rustc_middle\\src\\ty\\instance.rs:397:18: failed to resolve instance for <fn(axum::extract::State<Config>, DiscordUser, axum::Json<SubmitImageResponse>) -> impl Future<Output = StatusCode> \n{create_image} as Handler<(axum_core::extract::private::ViaRequest, axum::extract::State<Config>, DiscordUser, axum::Json<SubmitImageResponse>), Config>>::with_state\n```\n\n<!--\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\n-->\n<details><summary><strong>Backtrace</strong></summary>\n<p>\n\n```\nthread 'rustc' panicked at 'Box<dyn Any>', /rustc/7820b62d20bc548096d4632a3487987308cb4b5d\\compiler\\rustc_errors\\src\\lib.rs:1644:9\nstack backtrace:\n   0:     0x7ffb9d746c82 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::h71aa14ca5a78cea9\n   1:     0x7ffb9d78548b - core::fmt::write::hd6dddebeb8f05e68\n   2:     0x7ffb9d73c35a - <std::io::IoSliceMut as core::fmt::Debug>::fmt::hbe5c6512075d6072\n   3:     0x7ffb9d7469cb - std::sys::common::alloc::realloc_fallback::h79f7a2bf9b29d2a9\n   4:     0x7ffb9d74a329 - std::panicking::default_hook::h4c92683644ea5b5f\n   5:     0x7ffb9d749fab - std::panicking::default_hook::h4c92683644ea5b5f\n   6:     0x7ffb71b258cc - rustc_driver_impl[af203be264558e54]::describe_lints\n   7:     0x7ffb9d74ac92 - std::panicking::rust_panic_with_hook::h33ef57ac78d86764\n   8:     0x7ffb7206c1e3 - <rustc_middle[ac858212b739b5f5]::mir::GeneratorInfo as core[f7d117be605e2fd8]::fmt::Debug>::fmt\n   9:     0x7ffb7206a969 - <rustc_middle[ac858212b739b5f5]::mir::GeneratorInfo as core[f7d117be605e2fd8]::fmt::Debug>::fmt\n  10:     0x7ffb720f41d9 - <rustc_middle[ac858212b739b5f5]::ty::print::pretty::TraitRefPrintOnlyTraitPath as rustc_middle[ac858212b739b5f5]::ty::context::Lift>::lift_to_tcx\n  11:     0x7ffb720d0749 - <rustc_middle[ac858212b739b5f5]::ty::instance::InstanceDef as rustc_middle[ac858212b739b5f5]::ty::context::Lift>::lift_to_tcx\n  12:     0x7ffb720ccb20 - <rustc_middle[ac858212b739b5f5]::ty::instance::InstanceDef as rustc_middle[ac858212b739b5f5]::ty::context::Lift>::lift_to_tcx\n  13:     0x7ffb720cc6a2 - <rustc_middle[ac858212b739b5f5]::ty::instance::InstanceDef as rustc_middle[ac858212b739b5f5]::ty::context::Lift>::lift_to_tcx\n  14:     0x7ffb720c336a - rustc_middle[ac858212b739b5f5]::util::bug::bug_fmt\n  15:     0x7ffb720c1b1d - <rustc_middle[ac858212b739b5f5]::ty::consts::kind::UnevaluatedConst as rustc_errors[5eceb53523fa45d6]::diagnostic::IntoDiagnosticArg>::into_diagnostic_arg\n  16:     0x7ffb720c1ae1 - <rustc_middle[ac858212b739b5f5]::ty::consts::kind::UnevaluatedConst as rustc_errors[5eceb53523fa45d6]::diagnostic::IntoDiagnosticArg>::into_diagnostic_arg\n  17:     0x7ffb720c32a8 - rustc_middle[ac858212b739b5f5]::util::bug::bug_fmt\n  18:     0x7ffb720c3225 - rustc_middle[ac858212b739b5f5]::util::bug::bug_fmt\n  19:     0x7ffb705f084d - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  20:     0x7ffb705e5876 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  21:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  22:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  23:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  24:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  25:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  26:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  27:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  28:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  29:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  30:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  31:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  32:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  33:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  34:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  35:     0x7ffb705e5ca3 - <rustc_monomorphize[9ab505a90e433a29]::collector::MirNeighborCollector as rustc_middle[ac858212b739b5f5]::mir::visit::Visitor>::visit_operand\n  36:     0x7ffb6f0ebe84 - <rustc_monomorphize[9ab505a90e433a29]::partitioning::default::DefaultPartitioning as rustc_monomorphize[9ab505a90e433a29]::partitioning::Partitioner>::place_inlined_mono_items\n  37:     0x7ffb6f0ed55e - <rustc_monomorphize[9ab505a90e433a29]::partitioning::default::DefaultPartitioning as rustc_monomorphize[9ab505a90e433a29]::partitioning::Partitioner>::place_inlined_mono_items\n  38:     0x7ffb6f0e7791 - <rustc_mir_transform[bc774b75d18db22b]::elaborate_drops::Elaborator as rustc_mir_dataflow[8b599228352e354b]::elaborate_drops::DropElaborator>::get_drop_flag\n  39:     0x7ffb6f0ef95c - rustc_monomorphize[9ab505a90e433a29]::provide\n  40:     0x7ffb6f24fc1f - rustc_privacy[797d4763e5e864d1]::provide\n  41:     0x7ffb6f2bd9d5 - <rustc_query_impl[f1faa5ca787a8303]::Queries as rustc_middle[ac858212b739b5f5]::ty::query::QueryEngine>::try_mark_green\n  42:     0x7ffb6ecb12e2 - <rustc_codegen_llvm[801c810974492b7f]::ModuleLlvm as core[f7d117be605e2fd8]::ops::drop::Drop>::drop\n  43:     0x7ffb6ecadb6b - <rustc_codegen_llvm[801c810974492b7f]::LlvmCodegenBackend as rustc_codegen_ssa[c53e3e9fe0f57c8d]::traits::backend::CodegenBackend>::codegen_crate\n  44:     0x7ffb6ef562fb - rustc_interface[bff7d1d3f9751698]::passes::start_codegen\n  45:     0x7ffb6ef4fb52 - rustc_interface[bff7d1d3f9751698]::passes::start_codegen\n  46:     0x7ffb6ef52c4a - rustc_interface[bff7d1d3f9751698]::passes::start_codegen\n  47:     0x7ffb6ef7db67 - <rustc_interface[bff7d1d3f9751698]::queries::Queries>::ongoing_codegen\n  48:     0x7ffb6ed93859 - rustc_driver_impl[af203be264558e54]::main\n  49:     0x7ffb6edada1c - rustc_driver_impl[af203be264558e54]::args::arg_expand_all\n  50:     0x7ffb6ed8213a - rustc_driver_impl[af203be264558e54]::main\n  51:     0x7ffb6ed807bd - rustc_driver_impl[af203be264558e54]::main\n  52:     0x7ffb9d75cadc - std::sys::windows::thread::Thread::new::h62b556989e817ecc\n  53:     0x7ffbf7197614 - BaseThreadInitThunk\n  54:     0x7ffbf75e26a1 - RtlUserThreadStart\n\n```\n\n</p>\n</details>\n\n\nThis was initially filed under the Axum repo as that's what I suspected was the issue (and still believe to be), [here](https://github.com/tokio-rs/axum/issues/1823), as per the recommendation of a friend, but given that it's a *compiler* error, I was pointed back here. I'd love to have an mCVE for this issue, but the closest I've gotten is tracking it down to something to do with Axum's `top_level_handler_fn!` macro.\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"LYF1999\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/108847/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/108847/timeline", "performed_via_github_app": null, "state_reason": null}