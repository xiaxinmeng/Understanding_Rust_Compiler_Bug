{"url": "https://api.github.com/repos/rust-lang/rust/issues/44871", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/44871/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/44871/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/44871/events", "html_url": "https://github.com/rust-lang/rust/issues/44871", "id": 260760311, "node_id": "MDU6SXNzdWUyNjA3NjAzMTE=", "number": 44871, "title": "Compile the dynamic library with `#![no_std]` attribute (`--crate-type dylib`) in macOS", "user": {"login": "mssun", "id": 1270392, "node_id": "MDQ6VXNlcjEyNzAzOTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1270392?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mssun", "html_url": "https://github.com/mssun", "followers_url": "https://api.github.com/users/mssun/followers", "following_url": "https://api.github.com/users/mssun/following{/other_user}", "gists_url": "https://api.github.com/users/mssun/gists{/gist_id}", "starred_url": "https://api.github.com/users/mssun/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mssun/subscriptions", "organizations_url": "https://api.github.com/users/mssun/orgs", "repos_url": "https://api.github.com/users/mssun/repos", "events_url": "https://api.github.com/users/mssun/events{/privacy}", "received_events_url": "https://api.github.com/users/mssun/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123111, "node_id": "MDU6TGFiZWwxMjMxMTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-macos", "name": "O-macos", "color": "6e6ec0", "default": false, "description": "Operating system: macOS"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2017-09-26T20:32:45Z", "updated_at": "2020-07-15T21:49:40Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "There is an error in link time when compiling a dynamic library which is `no_std` in macOS.\r\n\r\nHere is the `lib.rs`:\r\n```\r\n$ cat lib.rs\r\n#![feature(lang_items)]\r\n#![no_std]\r\n\r\n#[lang = \"eh_personality\"] extern fn eh_personality() {}\r\n#[lang = \"panic_fmt\"] fn panic_fmt() -> ! { loop {} }\r\n\r\npub fn foo() { }\r\n```\r\n\r\nCompile it:\r\n```\r\n$ rustc lib.rs --crate-type dylib\r\nerror: linking with `cc` failed: exit code: 1\r\n  |\r\n  = note: \"cc\" \"-m64\" \"-L\" \"/Users/sunmingshen/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib\" \"lib.0.o\" \"-o\" \"liblib.dylib\" \"lib.crate.metadata.o\" \"-Wl,-dead_strip\" \"-nodefaultlibs\" \"-L\" \"/Users/sunmingshen/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib\" \"-Wl,-force_load,/var/folders/3r/y_ykzxz11y36c0rc71ds50g4g3sbtb/T/rustc.PUpdamjbR4od/libcore-9ba600218bb6e949.rlib\" \"-dynamiclib\" \"-Wl,-dylib\"\r\n  = note: Undefined symbols for architecture x86_64:\r\n            \"___umodti3\", referenced from:\r\n                core::fmt::num::_$LT$impl$u20$core..fmt..Display$u20$for$u20$i128$GT$::fmt::h8463a1a676e8ee2a in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::fmt::num::_$LT$impl$u20$core..fmt..Display$u20$for$u20$u128$GT$::fmt::h6ca2719d837aed88 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n            \"_memcmp\", referenced from:\r\n                core::str::pattern::StrSearcher::new::h6d2d0dbec00d4a0b in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                _$LT$core..num..bignum..Big32x40$u20$as$u20$core..cmp..PartialEq$GT$::eq::hbe7f5ae8aabcbbd4 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                _$LT$core..num..bignum..tests..Big8x3$u20$as$u20$core..cmp..PartialEq$GT$::eq::h03e930fb3b50fa2c in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n            \"_memset\", referenced from:\r\n                core::num::flt2dec::strategy::dragon::format_shortest::he26a0051f5c08ce1 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::num::flt2dec::strategy::dragon::format_exact::h9709ec9cce61c188 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::num::flt2dec::Part::write::h5c958cc3e4abc401 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::num::dec2flt::num::digits_to_big::hed468cab1e1db275 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::num::bignum::Big32x40::from_small::h0834d495142c5b04 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::num::bignum::Big32x40::div_rem::h8f4710ea0b7696f8 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n            \"___muloti4\", referenced from:\r\n                core::num::from_str_radix::h41585106c29f58f9 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n            \"___udivti3\", referenced from:\r\n                core::num::from_str_radix::h90268c29276886d4 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::num::_$LT$impl$u20$core..str..FromStr$u20$for$u20$u128$GT$::from_str::h56325653e340f0a5 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::fmt::num::_$LT$impl$u20$core..fmt..Display$u20$for$u20$i128$GT$::fmt::h8463a1a676e8ee2a in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::fmt::num::_$LT$impl$u20$core..fmt..Display$u20$for$u20$u128$GT$::fmt::h6ca2719d837aed88 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n            \"_memcpy\", referenced from:\r\n                core::num::flt2dec::strategy::dragon::format_shortest::he26a0051f5c08ce1 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::num::flt2dec::strategy::dragon::format_exact::h9709ec9cce61c188 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::num::flt2dec::Part::write::h5c958cc3e4abc401 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::num::flt2dec::Formatted::write::h5671b2cd48514051 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::num::dec2flt::num::digits_to_big::hed468cab1e1db275 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::num::bignum::Big32x40::from_u64::h9bca3b5d00f012af in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                core::num::bignum::Big32x40::mul_digits::hf9c1d2eae1a420a9 in libcore-9ba600218bb6e949.rlib(core-9ba600218bb6e949.0.o)\r\n                ...\r\n          ld: symbol(s) not found for architecture x86_64\r\n          clang: error: linker command failed with exit code 1 (use -v to see invocation)\r\n\r\n\r\nerror: aborting due to previous error\r\n\r\n```\r\n\r\nSome version info:\r\n```\r\n$  rustc -V\r\nrustc 1.22.0-nightly (6c476ce46 2017-09-25)\r\n```\r\n\r\n```\r\n$ cc -v\r\nApple LLVM version 8.1.0 (clang-802.0.42)\r\nTarget: x86_64-apple-darwin16.7.0\r\nThread model: posix\r\nInstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin\r\n```\r\n\r\nI read some code of `linker.rs`, but still did not find the reason. If someone can point out the main reason, I am glad to help.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/44871/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/44871/timeline", "performed_via_github_app": null, "state_reason": null}