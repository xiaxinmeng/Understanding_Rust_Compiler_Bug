{"url": "https://api.github.com/repos/rust-lang/rust/issues/83043", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/83043/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/83043/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/83043/events", "html_url": "https://github.com/rust-lang/rust/issues/83043", "id": 829648451, "node_id": "MDU6SXNzdWU4Mjk2NDg0NTE=", "number": 83043, "title": "rustc cannot find MSVC on Windows arm64", "user": {"login": "Alovchin91", "id": 8490695, "node_id": "MDQ6VXNlcjg0OTA2OTU=", "avatar_url": "https://avatars.githubusercontent.com/u/8490695?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Alovchin91", "html_url": "https://github.com/Alovchin91", "followers_url": "https://api.github.com/users/Alovchin91/followers", "following_url": "https://api.github.com/users/Alovchin91/following{/other_user}", "gists_url": "https://api.github.com/users/Alovchin91/gists{/gist_id}", "starred_url": "https://api.github.com/users/Alovchin91/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Alovchin91/subscriptions", "organizations_url": "https://api.github.com/users/Alovchin91/orgs", "repos_url": "https://api.github.com/users/Alovchin91/repos", "events_url": "https://api.github.com/users/Alovchin91/events{/privacy}", "received_events_url": "https://api.github.com/users/Alovchin91/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 266005765, "node_id": "MDU6TGFiZWwyNjYwMDU3NjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows-msvc", "name": "O-windows-msvc", "color": "6e6ec0", "default": false, "description": "Toolchain: MSVC, Operating system: Windows"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 24, "created_at": "2021-03-11T23:27:13Z", "updated_at": "2022-10-27T08:48:48Z", "closed_at": "2022-10-27T05:51:09Z", "author_association": "NONE", "active_lock_reason": null, "body": "### Problem\r\n\r\nWhen building Rust projects on Windows 10 arm64, rustc cannot find MSVC installation to use tools like link.exe.\r\nThe reason is because Visual Studio Installer doesn't properly register the installation on arm64.\r\n\r\nTo determine MSVC installation, rustc [uses](https://github.com/rust-lang/rust/blob/77b996e1c628e8089f058244b011a2ee945a8984/compiler/rustc_codegen_ssa/src/back/link.rs#L152) the great cc-rs crate which itself uses the [SetupConfiguration COM component](https://github.com/alexcrichton/cc-rs/blob/master/src/setup_config.rs) (Microsoft.VisualStudio.Setup.Configuration.Native.dll) to determine the path of Visual Studio (or Visual C++ Build Tools) installation. On Windows 10 arm64, it fails to create an instance of a COM class.\r\n\r\n### Steps\r\n\r\n1. Install `aarch64-pc-windows-msvc` toolchain on a Windows 10 arm64 machine\r\n2. Open cmd.exe and navigate to a Rust project\r\n3. Run `cargo build`\r\n\r\n### Possible Solution(s)\r\n\r\nThe issue happens because on arm64 VS Installer doesn't register the COM component. To be more precise, it registers the x86 version of the COM component, but there is no arm64 version. Unfortunately Microsoft is not willing to fix the issue, even though it was [reported](https://developercommunity.visualstudio.com/t/setupconfiguration-doesnt-find-any-vs-installation/1232316) [twice](https://developercommunity.visualstudio.com/t/isetupconfiguration-is-not-registered-on-arm64/1236604), with the reason being that [Visual Studio doesn't support running on arm64](https://twitter.com/richturn_ms/status/1367571316283379712?s=21).\r\n\r\nA (rather easy) workaround to the issue is to always run cargo/rustc within the x86_arm64 Developer Console. To do this, the user has to call `vcvarsx86_arm64.bat` before doing anything else in the console. This way, cc-rs can determine Visual Studio installation from the environment variables.\r\n\r\nFor rustc itself, a solution could be to first attempt searching in the known VS Installer path (`%ProgramFiles(x86)%\\Microsoft Visual Studio\\Installer`) for `vswhere.exe` on arm64 Windows and, if found, running it to get information about the installed VS instances.\r\n\r\nAnother option could be spawning a dedicated x86-emulated process that would be able to use the x86 COM component and give the information back to rustc, though this option seems to be an overkill \ud83d\ude05 \r\n\r\n### Meta\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.50.0 (cb75ad5db 2021-02-10)\r\nbinary: rustc\r\ncommit-hash: cb75ad5db02783e8b0222fee363c5f63f7e2cf5b\r\ncommit-date: 2021-02-10\r\nhost: aarch64-pc-windows-msvc\r\nrelease: 1.50.0\r\n```\r\n\r\nEnvironment:\r\n* Windows 10 arm64 (20H2)\r\n* `aarch64-pc-windows-msvc` toolchain\r\n", "closed_by": {"login": "ChrisDenton", "id": 4459874, "node_id": "MDQ6VXNlcjQ0NTk4NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChrisDenton", "html_url": "https://github.com/ChrisDenton", "followers_url": "https://api.github.com/users/ChrisDenton/followers", "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}", "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions", "organizations_url": "https://api.github.com/users/ChrisDenton/orgs", "repos_url": "https://api.github.com/users/ChrisDenton/repos", "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}", "received_events_url": "https://api.github.com/users/ChrisDenton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/83043/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/83043/timeline", "performed_via_github_app": null, "state_reason": "completed"}