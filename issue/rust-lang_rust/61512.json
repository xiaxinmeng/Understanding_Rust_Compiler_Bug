{"url": "https://api.github.com/repos/rust-lang/rust/issues/61512", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/61512/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/61512/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/61512/events", "html_url": "https://github.com/rust-lang/rust/issues/61512", "id": 451849782, "node_id": "MDU6SXNzdWU0NTE4NDk3ODI=", "number": 61512, "title": "Accessing a TLS variable in its own constructor results in a stack overflow", "user": {"login": "koute", "id": 246574, "node_id": "MDQ6VXNlcjI0NjU3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/246574?v=4", "gravatar_id": "", "url": "https://api.github.com/users/koute", "html_url": "https://github.com/koute", "followers_url": "https://api.github.com/users/koute/followers", "following_url": "https://api.github.com/users/koute/following{/other_user}", "gists_url": "https://api.github.com/users/koute/gists{/gist_id}", "starred_url": "https://api.github.com/users/koute/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/koute/subscriptions", "organizations_url": "https://api.github.com/users/koute/orgs", "repos_url": "https://api.github.com/users/koute/repos", "events_url": "https://api.github.com/users/koute/events{/privacy}", "received_events_url": "https://api.github.com/users/koute/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 632886930, "node_id": "MDU6TGFiZWw2MzI4ODY5MzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-thread-locals", "name": "A-thread-locals", "color": "f7e101", "default": false, "description": "Area: Thread local storage (TLS)"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2019-06-04T07:56:34Z", "updated_at": "2019-08-29T00:00:12Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "Consider the following program ([Playground](https://play.rust-lang.org/?version=nightly&mode=release&edition=2018&gist=b906422f1f99a3a48f4f8935573efb80)):\r\n\r\n```rust\r\nstruct Foobar {}\r\n\r\nthread_local! {\r\n    static TLS: Foobar = {\r\n        let _ = TLS.try_with( |_| {} );\r\n        Foobar {}\r\n    };\r\n}\r\n\r\nfn main() {\r\n    TLS.with( |_| {} );\r\n}\r\n```\r\n\r\nCurrently this results in a stack overflow:\r\n\r\n```\r\nthread 'main' has overflowed its stack\r\nfatal runtime error: stack overflow\r\nAborted (core dumped)\r\n```\r\n\r\nStack trace from GDB:\r\n\r\n```\r\n#71449 0x0000555555559813 in foobar::TLS::__init::ha2c35ff7b5b5b1c5 () at src/main.rs:11\r\n#71450 0x0000555555558543 in _$LT$std..thread..local..LocalKey$LT$T$GT$$GT$::init::hdc42f4a92fb0acaa (self=0x5555555822f8, slot=0x7ffff7b71760) at /rustc/b139669f374eb5024a50eb13f116ff763b1c5935/src/libstd/thread/local.rs:249\r\n#71451 0x00005555555589bb in _$LT$std..thread..local..LocalKey$LT$T$GT$$GT$::try_with::h53a54e92c6f85798 (self=0x5555555822f8, f=...) at /rustc/b139669f374eb5024a50eb13f116ff763b1c5935/src/libstd/thread/local.rs:298\r\n#71452 0x0000555555559813 in foobar::TLS::__init::ha2c35ff7b5b5b1c5 () at src/main.rs:11\r\n#71453 0x0000555555558543 in _$LT$std..thread..local..LocalKey$LT$T$GT$$GT$::init::hdc42f4a92fb0acaa (self=0x5555555822f8, slot=0x7ffff7b71760) at /rustc/b139669f374eb5024a50eb13f116ff763b1c5935/src/libstd/thread/local.rs:249\r\n#71454 0x00005555555589bb in _$LT$std..thread..local..LocalKey$LT$T$GT$$GT$::try_with::h53a54e92c6f85798 (self=0x5555555822f8, f=...) at /rustc/b139669f374eb5024a50eb13f116ff763b1c5935/src/libstd/thread/local.rs:298\r\n#71455 0x0000555555559813 in foobar::TLS::__init::ha2c35ff7b5b5b1c5 () at src/main.rs:11\r\n#71456 0x0000555555558543 in _$LT$std..thread..local..LocalKey$LT$T$GT$$GT$::init::hdc42f4a92fb0acaa (self=0x5555555822f8, slot=0x7ffff7b71760) at /rustc/b139669f374eb5024a50eb13f116ff763b1c5935/src/libstd/thread/local.rs:249\r\n#71457 0x00005555555589bb in _$LT$std..thread..local..LocalKey$LT$T$GT$$GT$::try_with::h53a54e92c6f85798 (self=0x5555555822f8, f=...) at /rustc/b139669f374eb5024a50eb13f116ff763b1c5935/src/libstd/thread/local.rs:298\r\n#71458 0x0000555555559813 in foobar::TLS::__init::ha2c35ff7b5b5b1c5 () at src/main.rs:11\r\n#71459 0x0000555555558543 in _$LT$std..thread..local..LocalKey$LT$T$GT$$GT$::init::hdc42f4a92fb0acaa (self=0x5555555822f8, slot=0x7ffff7b71760) at /rustc/b139669f374eb5024a50eb13f116ff763b1c5935/src/libstd/thread/local.rs:249\r\n#71460 0x000055555555879b in _$LT$std..thread..local..LocalKey$LT$T$GT$$GT$::try_with::h1ec5fdb93a6312a2 (self=0x5555555822f8, f=...) at /rustc/b139669f374eb5024a50eb13f116ff763b1c5935/src/libstd/thread/local.rs:298\r\n#71461 0x0000555555558623 in _$LT$std..thread..local..LocalKey$LT$T$GT$$GT$::with::ha3235fa6d0c897c9 (self=0x5555555822f8, f=...) at /rustc/b139669f374eb5024a50eb13f116ff763b1c5935/src/libstd/thread/local.rs:242\r\n#71462 0x00005555555597f0 in foobar::main::hc8c8fd2120b717f4 () at src/main.rs:17\r\n#71463 0x0000555555558500 in std::rt::lang_start::_$u7b$$u7b$closure$u7d$$u7d$::h1a821f2568568e6c () at /rustc/b139669f374eb5024a50eb13f116ff763b1c5935/src/libstd/rt.rs:64\r\n#71464 0x00005555555615a3 in {{closure}} () at src/libstd/rt.rs:49\r\n#71465 do_call<closure,i32> () at src/libstd/panicking.rs:297\r\n#71466 0x00005555555635ba in __rust_maybe_catch_panic () at src/libpanic_unwind/lib.rs:92\r\n#71467 0x0000555555562086 in try<i32,closure> () at src/libstd/panicking.rs:276\r\n#71468 catch_unwind<closure,i32> () at src/libstd/panic.rs:388\r\n#71469 lang_start_internal () at src/libstd/rt.rs:48\r\n#71470 0x00005555555584d9 in std::rt::lang_start::h8641b0ab47425e46 (main=0x5555555597e0 <foobar::main::hc8c8fd2120b717f4>, argc=1, argv=0x7fffffffe188) at /rustc/b139669f374eb5024a50eb13f116ff763b1c5935/src/libstd/rt.rs:64\r\n#71471 0x000055555555986a in main ()\r\n#71472 0x00007ffff7b99ce3 in __libc_start_main () from /usr/lib/libc.so.6\r\n#71473 0x000055555555817e in _start ()\r\n```\r\n\r\nI'd expect the `try_with` to simply return `Err` instead of going into an infinite loop.\r\n\r\nPlatform: x86_64-unknown-linux-gnu\r\nrustc 1.37.0-nightly (2019-06-03 6ffb8f53ee1cb0903f9d)", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/61512/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/61512/timeline", "performed_via_github_app": null, "state_reason": null}