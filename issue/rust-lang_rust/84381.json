{"url": "https://api.github.com/repos/rust-lang/rust/issues/84381", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/84381/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/84381/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/84381/events", "html_url": "https://github.com/rust-lang/rust/issues/84381", "id": 863339249, "node_id": "MDU6SXNzdWU4NjMzMzkyNDk=", "number": 84381, "title": "Rustdoc: building docs with 3rd party lib - \"serde_json\" results in compilation error", "user": {"login": "pm5k", "id": 9250112, "node_id": "MDQ6VXNlcjkyNTAxMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/9250112?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pm5k", "html_url": "https://github.com/pm5k", "followers_url": "https://api.github.com/users/pm5k/followers", "following_url": "https://api.github.com/users/pm5k/following{/other_user}", "gists_url": "https://api.github.com/users/pm5k/gists{/gist_id}", "starred_url": "https://api.github.com/users/pm5k/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pm5k/subscriptions", "organizations_url": "https://api.github.com/users/pm5k/orgs", "repos_url": "https://api.github.com/users/pm5k/repos", "events_url": "https://api.github.com/users/pm5k/events{/privacy}", "received_events_url": "https://api.github.com/users/pm5k/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 203738, "node_id": "MDU6TGFiZWwyMDM3Mzg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-rustdoc", "name": "T-rustdoc", "color": "bfd4f2", "default": false, "description": "Relevant to the rustdoc team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2021-04-21T00:16:21Z", "updated_at": "2021-04-21T00:34:26Z", "closed_at": "2021-04-21T00:34:26Z", "author_association": "NONE", "active_lock_reason": null, "body": "Hello,\r\n\r\nAllow me to preface this with a disclaimer that I am very new to Rust, so it may be likely this is a self-induced problem rather than a `rustdoc` bug. I will try to explain as best I can:\r\n\r\n## TL:DR;\r\nUsing `cargo run` in the root of my project results in a normal run and outputs the following:\r\n```bash\r\nObject({\"age\": Number(43), \"name\": String(\"John Doe\")})\r\n```\r\n\r\nHowever running `rustdoc src/main.rs && cargo doc` from the root of my project has this output:\r\n```bash\r\nerror[E0433]: failed to resolve: use of undeclared crate or module `serde_json`\r\n  --> src/utils/parser.rs:32:42\r\n   |\r\n32 | pub fn parse_unknown_json(data: &str) -> serde_json::Value {\r\n   |                                          ^^^^^^^^^^ use of undeclared crate or module `serde_json`\r\n\r\nerror: Compilation failed, aborting rustdoc\r\n\r\nerror: aborting due to 2 previous errors\r\n\r\nFor more information about this error, try `rustc --explain E0433`.\r\n```\r\n## Project layout\r\n```\r\nsrc/\r\n|__utils/\r\n|  |__parser.rs\r\n|  |__mod.rs\r\n|__main.rs\r\n```\r\n\r\n## Project files\r\n<details><summary>Cargo.toml</summary>\r\n<p>\r\n\r\n```toml\r\n[package]\r\nname = \"parsing-prog\"\r\n# ...\r\nedition = \"2018\"\r\n# ...\r\n\r\n[[bin]]\r\nname = \"main\"\r\npath = \"./src/main.rs\"\r\ndoc = true\r\n\r\n[dependencies]\r\nserde = { version = \"1.0.125\", features = [\"derive\"] }\r\nserde_json = \"1.0.64\"\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n<details><summary>main.rs</summary>\r\n<p>\r\n\r\n```rust\r\nmod utils;\r\nfn main() {\r\n  let data = r#\"\r\n    {\r\n      \"name\": \"John Doe\",\r\n      \"age\": 43\r\n    }\"#;\r\n  println!(\"{:?}\", utils::parser::parse_unknown_json(data));\r\n}\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n<details><summary>utils/mod.rs</summary>\r\n<p>\r\n\r\n```rust\r\npub mod parser;\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n\r\n<details><summary>utils/parser.rs</summary>\r\n<p>\r\n\r\n```rust\r\npub fn parse_unknown_json(data: &str) -> serde_json::Value {\r\n    let unknown: serde_json::Value = serde_json::from_str(data).unwrap();\r\n    return unknown;\r\n}\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n## What I tried to resolve this:\r\n### In `main.rs`  I tried to include the following at the top:\r\n\r\n`use serde_json;` -- Same error\r\n\r\n`extern crate serde_json;` -- Error changes to: \r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```bash\r\nerror[E0463]: can't find crate for `serde_json`\r\n --> src/aggregator.rs:1:1\r\n  |\r\n1 | extern crate serde_json;\r\n  | ^^^^^^^^^^^^^^^^^^^^^^^^ can't find crate\r\n\r\nerror: aborting due to previous error\r\n\r\nFor more information about this error, try `rustc --explain E0463`.\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n### In `parser.rs` I tried to include:\r\n`use serde_json;`\r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```bash\r\nerror[E0432]: unresolved import `serde_json`\r\n --> src/utils/parser.rs:7:5\r\n  |\r\n7 | use serde_json;\r\n  |     ^^^^^^^^^^ no `serde_json` in the root\r\n\r\nerror: Compilation failed, aborting rustdoc\r\n\r\nerror: aborting due to 2 previous errors\r\n\r\nFor more information about this error, try `rustc --explain E0432`.\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n`use crate::serde_json;`\r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```bash\r\nerror[E0432]: unresolved import `crate::serde_json`\r\n --> src/utils/parser.rs:7:5\r\n  |\r\n7 | use crate::serde_json;\r\n  |     ^^^^^^^^^^^^^^^^^ no `serde_json` in the root\r\n\r\nerror: Compilation failed, aborting rustdoc\r\n\r\nerror: aborting due to 2 previous errors\r\n\r\nFor more information about this error, try `rustc --explain E0432`.\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n`extern crate serde_json;`\r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```bash\r\nerror[E0463]: can't find crate for `serde_json`\r\n --> src/utils/parser.rs:7:1\r\n  |\r\n7 | extern crate serde_json;\r\n  | ^^^^^^^^^^^^^^^^^^^^^^^^ can't find crate\r\n\r\nerror: aborting due to previous error\r\n\r\nFor more information about this error, try `rustc --explain E0463`.\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n## I also recreated a project which uses a path dependency instead of `serde_json`:\r\n\r\nThe top-level package remains the same, the nested dependency's main folder is in the root of the main project (next to the `src/` folder. It has a toml file like so:\r\n\r\n```toml\r\n[package]\r\nname = \"rdtd\"\r\nversion = \"0.1.0\"\r\nedition = \"2018\"\r\n\r\n[lib]\r\nname = \"rdtd\"\r\npath = \"./src/lib.rs\"\r\n\r\n[dependencies]\r\n```\r\n\r\n..And a `lib.rs` file with the method the main package imports:\r\n```rust\r\npub fn test(data: &str) -> String {\r\n    return format!(\"Someprefix-{}\", data);\r\n}\r\n\r\nfn main() {}\r\n```\r\n\r\nFinally - in the top-level project I am importing it as:\r\n```toml\r\n[dependencies]\r\nrdtd = { path = \"rdtd/\" }\r\n```\r\n\r\nAnd using it in `utils::parser.rs` like so:\r\n```rust\r\n// Notice that no import is even specified here or attempted to be specified..\r\npub fn prefix_data(data: &str) -> String {\r\n    let prefixed = rdtd::test(data);\r\n    return prefixed;\r\n}\r\n```\r\n\r\nAnd this not only runs fine, but `rustdoc src/main.rs && cargo doc` runs just fine too. No errors. At all.\r\nSo either I am introducing some strange behaviour or `serde_json` is a very special case...\r\n\r\n## Meta\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.51.0 (2fd73fabe 2021-03-23)\r\nbinary: rustc\r\ncommit-hash: 2fd73fabe469357a12c2c974c140f67e7cdd76d0\r\ncommit-date: 2021-03-23\r\nhost: x86_64-apple-darwin\r\nrelease: 1.51.0\r\nLLVM version: 11.0.1\r\n```", "closed_by": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/84381/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/84381/timeline", "performed_via_github_app": null, "state_reason": "completed"}