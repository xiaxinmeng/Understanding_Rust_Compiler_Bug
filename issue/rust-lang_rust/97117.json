{"url": "https://api.github.com/repos/rust-lang/rust/issues/97117", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/97117/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/97117/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/97117/events", "html_url": "https://github.com/rust-lang/rust/issues/97117", "id": 1238872400, "node_id": "I_kwDOAAsO6M5J17FQ", "number": 97117, "title": "Cannot link Rust (1.60+, ARM64) generated static-object with Go", "user": {"login": "bnpfeife", "id": 13527030, "node_id": "MDQ6VXNlcjEzNTI3MDMw", "avatar_url": "https://avatars.githubusercontent.com/u/13527030?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bnpfeife", "html_url": "https://github.com/bnpfeife", "followers_url": "https://api.github.com/users/bnpfeife/followers", "following_url": "https://api.github.com/users/bnpfeife/following{/other_user}", "gists_url": "https://api.github.com/users/bnpfeife/gists{/gist_id}", "starred_url": "https://api.github.com/users/bnpfeife/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bnpfeife/subscriptions", "organizations_url": "https://api.github.com/users/bnpfeife/orgs", "repos_url": "https://api.github.com/users/bnpfeife/repos", "events_url": "https://api.github.com/users/bnpfeife/events{/privacy}", "received_events_url": "https://api.github.com/users/bnpfeife/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2022-05-17T16:11:53Z", "updated_at": "2022-08-19T15:19:45Z", "closed_at": "2022-08-19T15:19:40Z", "author_association": "NONE", "active_lock_reason": null, "body": "Hello!\r\n\r\nI am working on a project that uses Rust's CFFI to expose functions/symbols to Go. It uses musl to compile for AMD64 and [musl-cross-make](https://github.com/richfelker/musl-cross-make) for ARM64. I've enabled static-linkage for both Rust and Go; and I've enabled PIE for Go. Everything works when I build with the Rust 1.58 toolchain. However, when I build with 1.60/nightly, the linker generates this error:\r\n```\r\n/go/pkg/tool/linux_amd64/link: running /usr/local/bin/aarch64-linux-musl-gcc failed: exit status 1\r\n/usr/local/bin/../lib/gcc/aarch64-linux-musl/9.4.0/../../../../aarch64-linux-musl/bin/ld: read-only segment has dynamic relocations\r\ncollect2: error: ld returned 1 exit status\r\n```\r\n\r\nThis might not be an issue with Rust. I've tried several combinations of `RUSTFLAGS` to fix this, but I am unable to find the right combination. Since the issue isn't present in 1.58, however, I suspect it might be a compiler issue.\r\n\r\nUnfortunately, this is difficult to replicate without a project. I've forked [rust-plus-golang](https://github.com/mediremi/rust-plus-golang) which is a minimal example of Rust CFFI + Go. My [fork](https://github.com/bnpfeife/rust-plus-golang) includes a `docker` subdirectory. The Dockerfile can build the exact environment to replicate the issue. It should also be fairly trivial to switch between 1.58 and 1.60 by modifying that Dockerfile.\r\n\r\nTo build the environment (from the root of the repository):\r\n```\r\n# docker build -t crosscompiler docker\r\n```\r\n\r\nTo build the executables (also from the root of the repository):\r\n```\r\n# docker run -v \"$(pwd):/project\" crosscompiler\r\n```\r\n\r\nPlease, let me know if there is anything else that I can provide/change!\r\n\r\nThanks!\r\n\r\nEdit:\r\nMy apologies, I forgot to mention, that AMD64 builds on both 1.58 and 1.60. It's just ARM64 that is impacted.", "closed_by": {"login": "bnpfeife", "id": 13527030, "node_id": "MDQ6VXNlcjEzNTI3MDMw", "avatar_url": "https://avatars.githubusercontent.com/u/13527030?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bnpfeife", "html_url": "https://github.com/bnpfeife", "followers_url": "https://api.github.com/users/bnpfeife/followers", "following_url": "https://api.github.com/users/bnpfeife/following{/other_user}", "gists_url": "https://api.github.com/users/bnpfeife/gists{/gist_id}", "starred_url": "https://api.github.com/users/bnpfeife/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bnpfeife/subscriptions", "organizations_url": "https://api.github.com/users/bnpfeife/orgs", "repos_url": "https://api.github.com/users/bnpfeife/repos", "events_url": "https://api.github.com/users/bnpfeife/events{/privacy}", "received_events_url": "https://api.github.com/users/bnpfeife/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/97117/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/97117/timeline", "performed_via_github_app": null, "state_reason": "completed"}