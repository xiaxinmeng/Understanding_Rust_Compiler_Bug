{"url": "https://api.github.com/repos/rust-lang/rust/issues/66026", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/66026/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/66026/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/66026/events", "html_url": "https://github.com/rust-lang/rust/issues/66026", "id": 516348144, "node_id": "MDU6SXNzdWU1MTYzNDgxNDQ=", "number": 66026, "title": "Rust functions exported to C are dead code eliminated by emscripten despite being exported", "user": {"login": "lopopolo", "id": 860434, "node_id": "MDQ6VXNlcjg2MDQzNA==", "avatar_url": "https://avatars.githubusercontent.com/u/860434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lopopolo", "html_url": "https://github.com/lopopolo", "followers_url": "https://api.github.com/users/lopopolo/followers", "following_url": "https://api.github.com/users/lopopolo/following{/other_user}", "gists_url": "https://api.github.com/users/lopopolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/lopopolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lopopolo/subscriptions", "organizations_url": "https://api.github.com/users/lopopolo/orgs", "repos_url": "https://api.github.com/users/lopopolo/repos", "events_url": "https://api.github.com/users/lopopolo/events{/privacy}", "received_events_url": "https://api.github.com/users/lopopolo/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2019-11-01T21:08:14Z", "updated_at": "2019-11-18T00:06:52Z", "closed_at": "2019-11-18T00:06:52Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "```\r\n$ rustc --version --verbose\r\nrustc 1.40.0-nightly (c23a7aa77 2019-10-19)\r\nbinary: rustc\r\ncommit-hash: c23a7aa778b0dfeffbf83b099bdf971242c1e1ac\r\ncommit-date: 2019-10-19\r\nhost: x86_64-apple-darwin\r\nrelease: 1.40.0-nightly\r\nLLVM version: 9.0\r\n```\r\n\r\n```\r\n$ emcc --version\r\nemcc (Emscripten gcc/clang-like replacement) 1.39.1 (commit 1b1f08f356d3f10d91e50c09dda6d44372ca908c)\r\nCopyright (C) 2014 the Emscripten authors (see AUTHORS.txt)\r\nThis is free and open source software under the MIT license.\r\nThere is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\r\n```\r\n\r\nI am attempting to upgrade the toolchain of a Rust and C project to Rust nightly's support for the LLVM emscripten backend https://github.com/rust-lang/rust/pull/63649.\r\n\r\nThe project has a crate that compiles a C static library. The C library depends on symbols that are exported from Rust code in the crate as `no_mangle` and `pub unsafe extern \"C\"`.\r\n\r\nThe build preamble sets `RUSTFLAGS` to enable building Wasm with emcc and marks all of the Rust symbols as exported.\r\n\r\n```\r\n$ echo $RUSTFLAGS\r\n-C link-arg=-s -C link-arg=WASM=1 -C link-arg=-s -C link-arg=ASSERTIONS=1 -C link-arg=-s -C link-arg=NO_EXIT_RUNTIME=1 -C link-arg=-s -C link-arg=ALLOW_MEMORY_GROWTH=1 -C link-arg=-s -C link-arg=TOTAL_MEMORY=67108864 -C link-arg=-s -C link-arg=TOTAL_STACK=33554432 -C link-arg=-s -C link-arg=ENVIRONMENT=web -C link-arg=-s -C link-arg=EXPORTED_FUNCTIONS=[\"_artichoke_value_to_ary\",\"_artichoke_ary_new\",\"_artichoke_ary_new_capa\",\"_artichoke_ary_new_from_values\",\"_artichoke_ary_splat\",\"_artichoke_ary_clone\",\"_artichoke_ary_ref\",\"_artichoke_ary_pop\",\"_artichoke_ary_shift\",\"_artichoke_ary_unshift\",\"_artichoke_ary_len\",\"_artichoke_ary_concat\",\"_artichoke_ary_push\",\"_artichoke_ary_set\",\"_artichoke_ary_check\",\"_artichoke_gc_mark_ary\",\"_artichoke_gc_mark_ary_size\",\"_mrb_sys_value_is_nil\",\"_mrb_sys_value_is_false\",\"_mrb_sys_value_is_true\",\"_mrb_sys_range_excl\",\"_mrb_sys_obj_frozen\",\"_mrb_sys_fixnum_to_cint\",\"_mrb_sys_float_to_cdouble\",\"_mrb_sys_cptr_ptr\",\"_mrb_sys_basic_ptr\",\"_mrb_sys_obj_ptr\",\"_mrb_sys_proc_ptr\",\"_mrb_sys_class_ptr\",\"_mrb_sys_class_to_rclass\",\"_mrb_sys_class_of_value\",\"_mrb_sys_nil_value\",\"_mrb_sys_false_value\",\"_mrb_sys_true_value\",\"_mrb_sys_fixnum_value\",\"_mrb_sys_float_value\",\"_mrb_sys_cptr_value\",\"_mrb_sys_obj_value\",\"_mrb_sys_class_value\",\"_mrb_sys_module_value\",\"_mrb_sys_data_value\",\"_mrb_sys_proc_value\",\"_mrb_sys_symbol_name\",\"_mrb_sys_new_symbol\",\"_mrb_sys_set_instance_tt\",\"_mrb_sys_data_init\",\"_mrb_sys_raise\",\"_mrb_sys_raise_current_exception\",\"_mrb_sys_value_debug_str\",\"_mrb_sys_ary_len\",\"_mrb_sys_gc_arena_save\",\"_mrb_sys_gc_arena_restore\",\"_mrb_sys_gc_disable\",\"_mrb_sys_gc_enable\",\"_mrb_sys_value_is_dead\",\"_mrb_sys_gc_live_objects\",\"_mrb_sys_safe_gc_mark\",\"_main\",\"_malloc\",\"_artichoke_web_repl_init\",\"_artichoke_string_new\",\"_artichoke_string_free\",\"_artichoke_string_getlen\",\"_artichoke_string_getch\",\"_artichoke_string_putch\",\"_artichoke_eval\"] -C link-arg=-s -C link-arg=EXTRA_EXPORTED_RUNTIME_METHODS=[\"ccall\",\"cwrap\"]\r\n```\r\n\r\nThe C static library has a macro for injecting an `extern` like modifier. The `build.rs` defines this macro to be `__attribute__((used))` to match the `EMSCRIPTEN_KEEPALIVE` macro.\r\n\r\nThis code compiles and links, but when the application attempts to call a Rust exported symbol from C, Chrome raises a runtime error saying the function is unreachable.\r\n\r\n\r\n```\r\nVM5097:10526 Uncaught RuntimeError: unreachable\r\n    at unreachable:artichoke_ary_push (wasm-function[50]:0x58b7)\r\n    at hash_vals_i (wasm-function[7079]:0x32fba8)\r\n    at ht_foreach (wasm-function[7039]:0x32a4a0)\r\n    at mrb_hash_values (wasm-function[7078]:0x32faa5)\r\n    at dynCall_viii (wasm-function[11266]:0x48ac54)\r\n    at Module.dynCall_viii (eval at module.exports (webpack:///../node_modules/script-loader/addScript.js?), <anonymous>:10366:40)\r\n    at invoke_viii (eval at module.exports (webpack:///../node_modules/script-loader/addScript.js?), <anonymous>:10523:5)\r\n    at mrb_vm_exec (wasm-function[6396]:0x29d490)\r\n    at mrb_vm_run (wasm-function[6386]:0x25f3b4)\r\n    at mrb_top_run (wasm-function[6412]:0x2a84bc)\r\n```\r\n\r\nThis function is explicitly exported and linking succeeds.\r\n\r\nI'm not sure what is going on here. Any ideas?", "closed_by": {"login": "lopopolo", "id": 860434, "node_id": "MDQ6VXNlcjg2MDQzNA==", "avatar_url": "https://avatars.githubusercontent.com/u/860434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lopopolo", "html_url": "https://github.com/lopopolo", "followers_url": "https://api.github.com/users/lopopolo/followers", "following_url": "https://api.github.com/users/lopopolo/following{/other_user}", "gists_url": "https://api.github.com/users/lopopolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/lopopolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lopopolo/subscriptions", "organizations_url": "https://api.github.com/users/lopopolo/orgs", "repos_url": "https://api.github.com/users/lopopolo/repos", "events_url": "https://api.github.com/users/lopopolo/events{/privacy}", "received_events_url": "https://api.github.com/users/lopopolo/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/66026/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/66026/timeline", "performed_via_github_app": null, "state_reason": "completed"}