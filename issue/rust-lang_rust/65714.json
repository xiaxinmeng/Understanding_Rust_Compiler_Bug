{"url": "https://api.github.com/repos/rust-lang/rust/issues/65714", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/65714/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/65714/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/65714/events", "html_url": "https://github.com/rust-lang/rust/issues/65714", "id": 511058826, "node_id": "MDU6SXNzdWU1MTEwNTg4MjY=", "number": 65714, "title": "Document comment representation is inefficient", "user": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2019-10-23T04:06:13Z", "updated_at": "2019-10-23T06:02:59Z", "closed_at": "2019-10-23T06:02:59Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Imagine a doc comment like this:\r\n```\r\n/// aaa\r\n/// `bbb`\r\n/// ccc\r\n```\r\nThis gets treated like this:\r\n```\r\n#[doc=\" aaa\"]\r\n#[doc=\" `bbb`\"]\r\n#[doc=\" ccc\"]\r\n```\r\nAnd each line gets represented with a `TokenStream` containing two elements: a `Eq` token and a `Lit` token. These end up in metadata, and the decoding cost is quite high. Because doc comments can be long, spanning many lines, it would be nice to join them together -- much like rustdoc's collapse-span pass does, but earlier -- to reduce the metadata decoding cost.\r\n\r\nI wrote an experimental, not-quite-right patch that condensed to the following in the parser:\r\n```\r\n#[doc=\"/// aaa\\n/// `bbb`\\n/// ccc\"]\r\n```\r\nIt failed lots of rustdoc tests, but the perf results were great:\r\n```\r\nssue-46449-check\r\n        avg: -16.1%     min: -16.1%     max: -16.1%\r\nhelloworld-check\r\n        avg: -12.6%     min: -12.6%     max: -12.6%\r\nunify-linearly-check\r\n        avg: -10.9%     min: -10.9%     max: -10.9%\r\ndeeply-nested-check\r\n        avg: -8.7%      min: -8.7%      max: -8.7%\r\nawait-call-tree-check\r\n        avg: -8.1%      min: -8.1%      max: -8.1%\r\nregression-31157-check\r\n        avg: -4.0%      min: -4.0%      max: -4.0%\r\nripgrep-check\r\n        avg: -2.7%      min: -2.7%      max: -2.7%\r\nencoding-check\r\n        avg: -2.4%      min: -2.4%      max: -2.4%\r\nregex-check\r\n        avg: -2.0%      min: -2.0%      max: -2.0%\r\nsyn-check\r\n        avg: -1.6%      min: -1.6%      max: -1.6%\r\nfutures-check\r\n        avg: -1.5%      min: -1.5%      max: -1.5%\r\nclap-rs-check\r\n        avg: -0.9%      min: -0.9%      max: -0.9%\r\npiston-image-check\r\n        avg: -0.9%      min: -0.9%      max: -0.9%\r\ncoercions-check\r\n        avg: -0.8%?     min: -0.8%?     max: -0.8%?\r\nwebrender-check\r\n        avg: -0.6%      min: -0.6%      max: -0.6%\r\ntoken-stream-stress-check\r\n        avg: -0.6%      min: -0.6%      max: -0.6%\r\nhtml5ever-check\r\n        avg: -0.6%      min: -0.6%      max: -0.6%\r\ninflate-check\r\n        avg: -0.4%      min: -0.4%      max: -0.4%\r\ncargo-check\r\n        avg: -0.4%      min: -0.4%      max: -0.4%\r\ncranelift-codegen-check\r\n        avg: -0.4%      min: -0.4%      max: -0.4%\r\nserde-check\r\n        avg: -0.3%      min: -0.3%      max: -0.3%\r\nwg-grammar-check\r\n        avg: -0.3%      min: -0.3%      max: -0.3%\r\ndeep-vector-check\r\n        avg: -0.2%      min: -0.2%      max: -0.2%\r\n```\r\nI then modified it to be more correct, like this:\r\n```\r\n#[doc=\"/// aaa\\n `bbb`\\n ccc\"]\r\n```\r\nBut then I get build failures -- the doc string appears to be tokenized somewhere, and it complains about the backticks not being valid tokens (\"error: unknown start of token: \\`\") due to the lack of `///` after the first newline. Anyone know where that tokenization might arise from?\r\n\r\nSo, there is definitely room for improvement in the representation of doc comments, but some care will be needed to keep things working. I'd love to hear suggestions on the right way to do this.\r\n\r\ncc @rust-lang/wg-compiler-performance \r\n", "closed_by": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/65714/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/65714/timeline", "performed_via_github_app": null, "state_reason": "completed"}