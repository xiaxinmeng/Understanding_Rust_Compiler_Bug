{"url": "https://api.github.com/repos/rust-lang/rust/issues/51266", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/51266/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/51266/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/51266/events", "html_url": "https://github.com/rust-lang/rust/issues/51266", "id": 328348859, "node_id": "MDU6SXNzdWUzMjgzNDg4NTk=", "number": 51266, "title": "\"Could not copy\" (Operation not permitted) when compiling in a docker container", "user": {"login": "mattgodbolt", "id": 633973, "node_id": "MDQ6VXNlcjYzMzk3Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/633973?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mattgodbolt", "html_url": "https://github.com/mattgodbolt", "followers_url": "https://api.github.com/users/mattgodbolt/followers", "following_url": "https://api.github.com/users/mattgodbolt/following{/other_user}", "gists_url": "https://api.github.com/users/mattgodbolt/gists{/gist_id}", "starred_url": "https://api.github.com/users/mattgodbolt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mattgodbolt/subscriptions", "organizations_url": "https://api.github.com/users/mattgodbolt/orgs", "repos_url": "https://api.github.com/users/mattgodbolt/repos", "events_url": "https://api.github.com/users/mattgodbolt/events{/privacy}", "received_events_url": "https://api.github.com/users/mattgodbolt/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2018-06-01T01:23:41Z", "updated_at": "2018-06-02T05:15:51Z", "closed_at": "2018-06-02T05:15:51Z", "author_association": "NONE", "active_lock_reason": null, "body": "I'm the maintainer of Compiler Explorer, and recently (in the last 2-3 days) the nightly build of Rust has started reporting an error when I try and compile using it from within a Docker container:\r\n\r\n```\r\nroot@c45dac5bb5c7:/tmp# cat > test.rs\r\npub fn square(num: i32) -> i32 {\r\n    num * num\r\n}\r\nroot@c45dac5bb5c7:/tmp# strace -f -o/tmp/moo /opt/compiler-explorer/rust-nightly/bin/rustc -C debuginfo=1 -o /tmp/moose.s --emit asm test.rs --crate-type rlib                                                     \r\nerror: could not copy \"/tmp/moose.test0.rcgu.s\" to \"/tmp/moose.s\": Operation not permitted (os error 1)\r\n\r\nerror: aborting due to previous error\r\n\r\n```\r\n\r\nThe same compile works just fine outside of a container. The `strace` call yields the problem call:\r\n\r\n```\r\n4809  stat(\"/tmp/moose.test0.rcgu.s\", {st_mode=S_IFREG|0644, st_size=3360, ...}) = 0\r\n4809  open(\"/tmp/moose.test0.rcgu.s\", O_RDONLY|O_CLOEXEC) = 5\r\n4809  open(\"/tmp/moose.s\", O_WRONLY|O_CREAT|O_TRUNC|O_CLOEXEC, 0666) = 6\r\n4809  fstat(5, {st_mode=S_IFREG|0644, st_size=3360, ...}) = 0\r\n4809  syscall_18446744073709551615(0x5, 0, 0x6, 0, 0xd20, 0x7f3200000000) = -1 (errno 1)\r\n4809  close(6)                          = 0\r\n4809  close(5)                          = 0\r\n4809  write(2, \"\\33[0m\\33[1m\\33[38;5;9merror\\33[0m\\33[0m\\33[\"..., 137) = 137\r\n4809  write(2, \"\\n\", 1)                 = 1\r\n4809  unlink(\"/tmp/moose.test0.rcgu.s\") = 0\r\n```\r\n\r\nIt seems whatever \"syscall_18446744073709551615\" is, it's getting `EPERM`.\r\n\r\nCross checking from outside a docker container:\r\n\r\n```\r\n6206  open(\"/tmp/moose.s\", O_WRONLY|O_CREAT|O_TRUNC|O_CLOEXEC, 0666) = 6\r\n6206  fstat(5, {st_mode=S_IFREG|0664, st_size=3360, ...}) = 0\r\n6206  syscall_326(0x5, 0, 0x6, 0, 0xd20, 0x7f3f00000000) = -1 (errno 38)\r\n6206  read(5, \"\\t.text\\n\\t.file\\t\\\"test0-8787f43e282\"..., 8192) = 3360\r\n6206  write(6, \"\\t.text\\n\\t.file\\t\\\"test0-8787f43e282\"..., 3360) = 3360\r\n6206  read(5, \"\", 8192)                 = 0\r\n6206  chmod(\"/tmp/moose.s\", 0100664)    = 0\r\n6206  close(6)                          = 0\r\n6206  close(5)                          = 0\r\n6206  unlink(\"/tmp/moose.test0.rcgu.s\") = 0\r\n```\r\n\r\nin this case things succeed (although the syscall_326, whatever that is still fails, but with `ENOSYS`).\r\n\r\nCan anyone shed any light on this as this is outside of my experience! As I say, it only happens on the nightly build, and it has started happening in the last day or two (e.g. sometime around 29th May 2018).\r\n\r\nI wonder if some new (unsupported on Ubuntu 16) libc function is being called, and in the docker environment `EPERM` is returned instead of `ENOSYS`, which confuses some bailout code in `rustc`?\r\n\r\nThanks in advance, Matt\r\n\r\n(See also https://github.com/mattgodbolt/compiler-explorer/issues/942 )", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/51266/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/51266/timeline", "performed_via_github_app": null, "state_reason": "completed"}