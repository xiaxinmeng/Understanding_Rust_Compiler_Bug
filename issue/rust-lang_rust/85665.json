{"url": "https://api.github.com/repos/rust-lang/rust/issues/85665", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/85665/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/85665/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/85665/events", "html_url": "https://github.com/rust-lang/rust/issues/85665", "id": 900678897, "node_id": "MDU6SXNzdWU5MDA2Nzg4OTc=", "number": 85665, "title": "Const generics in closure arguments result in false \"closure/generator type that references itself\" error", "user": {"login": "mastopgunaf", "id": 56002466, "node_id": "MDQ6VXNlcjU2MDAyNDY2", "avatar_url": "https://avatars.githubusercontent.com/u/56002466?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mastopgunaf", "html_url": "https://github.com/mastopgunaf", "followers_url": "https://api.github.com/users/mastopgunaf/followers", "following_url": "https://api.github.com/users/mastopgunaf/following{/other_user}", "gists_url": "https://api.github.com/users/mastopgunaf/gists{/gist_id}", "starred_url": "https://api.github.com/users/mastopgunaf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mastopgunaf/subscriptions", "organizations_url": "https://api.github.com/users/mastopgunaf/orgs", "repos_url": "https://api.github.com/users/mastopgunaf/repos", "events_url": "https://api.github.com/users/mastopgunaf/events{/privacy}", "received_events_url": "https://api.github.com/users/mastopgunaf/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 122406831, "node_id": "MDU6TGFiZWwxMjI0MDY4MzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-closures", "name": "A-closures", "color": "f7e101", "default": false, "description": "Area: closures (`|args| { .. }`)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1282665911, "node_id": "MDU6TGFiZWwxMjgyNjY1OTEx", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-const-generics", "name": "A-const-generics", "color": "f7e101", "default": false, "description": "Area: const generics (parameters and arguments)"}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}, {"id": 2341291797, "node_id": "MDU6TGFiZWwyMzQxMjkxNzk3", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-generic_const_exprs", "name": "F-generic_const_exprs", "color": "f9c0cc", "default": false, "description": "`#![feature(generic_const_exprs)]`"}, {"id": 5226739262, "node_id": "LA_kwDOAAsO6M8AAAABN4m2Pg", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-incomplete-features", "name": "requires-incomplete-features", "color": "76dcde", "default": false, "description": ""}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2021-05-25T11:31:11Z", "updated_at": "2023-03-04T23:33:53Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I tried compiling this code:\r\n```rust\r\n#![feature(const_generics)]\r\n#![feature(const_evaluatable_checked)]\r\n\r\nuse std::convert::TryInto;\r\n\r\npub const PREFIX_LENGTH: usize = 4;\r\n\r\npub struct Foo<T, const L: usize> {\r\n    template: &'static [u8; L],\r\n    item: T\r\n}\r\n\r\nimpl<T, const L: usize> Foo<T, L> {\r\n    pub fn new<F>(template: &'static [u8; L], constructor: F) -> Self\r\n        where F: Fn(&[u8; L - PREFIX_LENGTH]) -> T\r\n    {\r\n        Self {\r\n            template: template,\r\n\r\n            item: constructor(\r\n                &TryInto::<[u8; L - PREFIX_LENGTH]>::try_into(\r\n                    &template[PREFIX_LENGTH..]\r\n                ).unwrap()\r\n            )\r\n        }\r\n    }\r\n\r\n    pub fn get(&self) -> &T {\r\n        &self.item\r\n    }\r\n}\r\n\r\nconst TEMPLATE: &[u8; 12] = b\"ABCD12345678\";\r\n\r\nfn main() {\r\n    let foo = Foo::new(TEMPLATE,\r\n        |x| x.to_vec()\r\n    );\r\n\r\n    println!(\"{}\",\r\n        String::from_utf8(\r\n            foo.get().clone()\r\n        ).unwrap()\r\n    );\r\n}\r\n```\r\nThe output is supposed to be `12345678`, but instead the compiler throws an error:\r\n```\r\nerror[E0644]: closure/generator type that references itself\r\n  --> src/main.rs:37:9\r\n   |\r\n37 |         |x| x.to_vec()\r\n   |         ^^^^^^^^^^^^^^ cyclic type of infinite size\r\n   |\r\n   = note: closures cannot capture themselves or take themselves as argument;\r\n           this error may be the result of a recent compiler bug-fix,\r\n           see issue #46062 <https://github.com/rust-lang/rust/issues/46062>\r\n           for more information\r\n```\r\nHowever, the code above doesn't include closures that capture themselves or take themselves as an argument.\r\n\r\nThe bug is most likely related to const generics, because omitting `- PREFIX_LENGTH` such that the `const_generics` feature is not used fixes the compilation. `new` function in this case is as follows:\r\n```rust\r\n    pub fn new<F>(template: &'static [u8; L], constructor: F) -> Self\r\n        where F: Fn(&[u8; L]) -> T\r\n    {\r\n        Self {\r\n            template: template,\r\n\r\n            item: constructor(\r\n                &TryInto::<[u8; L]>::try_into(\r\n                    &template[..]\r\n                ).unwrap()\r\n            )\r\n        }\r\n    }\r\n```\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.54.0-nightly (126561cb3 2021-05-24)\r\nbinary: rustc\r\ncommit-hash: 126561cb31e8ebe1e2dd9dfd0d3ca621308dc56f\r\ncommit-date: 2021-05-24\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.54.0-nightly\r\nLLVM version: 12.0.1\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/85665/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/85665/timeline", "performed_via_github_app": null, "state_reason": null}