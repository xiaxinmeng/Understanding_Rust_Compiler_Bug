{"url": "https://api.github.com/repos/rust-lang/rust/issues/46867", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/46867/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/46867/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/46867/events", "html_url": "https://github.com/rust-lang/rust/issues/46867", "id": 283451643, "node_id": "MDU6SXNzdWUyODM0NTE2NDM=", "number": 46867, "title": "Segfault while improperly storing trait object pointer", "user": {"login": "robert-w-gries", "id": 7546625, "node_id": "MDQ6VXNlcjc1NDY2MjU=", "avatar_url": "https://avatars.githubusercontent.com/u/7546625?v=4", "gravatar_id": "", "url": "https://api.github.com/users/robert-w-gries", "html_url": "https://github.com/robert-w-gries", "followers_url": "https://api.github.com/users/robert-w-gries/followers", "following_url": "https://api.github.com/users/robert-w-gries/following{/other_user}", "gists_url": "https://api.github.com/users/robert-w-gries/gists{/gist_id}", "starred_url": "https://api.github.com/users/robert-w-gries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/robert-w-gries/subscriptions", "organizations_url": "https://api.github.com/users/robert-w-gries/orgs", "repos_url": "https://api.github.com/users/robert-w-gries/repos", "events_url": "https://api.github.com/users/robert-w-gries/events{/privacy}", "received_events_url": "https://api.github.com/users/robert-w-gries/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2017-12-20T05:14:42Z", "updated_at": "2017-12-20T19:18:46Z", "closed_at": "2017-12-20T19:18:45Z", "author_association": "NONE", "active_lock_reason": null, "body": "### Summary\r\n\r\nI attempted to pop a trait object pointer off the stack and cast the raw pointer into a trait object.  My first stab at this code was incorrect, but it strangely triggered a segfault in `rustc` instead of returning a compilation error.  The incorrect code involves popping `*mut &MyTrait` pointer value into a data type of `*mut MyTrait`.  Fixing the incorrect code avoids the segfault issue.\r\n\r\n### Error Message\r\n\r\n```\r\n[rob@localhost rxinu]$ RUST_BACKTRACE=1 rustc --crate-name rxinu src/lib.rs --crate-type staticlib --emit=dep-info,link -C debuginfo=2 --cfg 'feature=\"default\"' --cfg 'feature=\"serial\"' -C metadata=31a0723d36405193 -C extra-filename=-31a0723d36405193 --out-dir /home/rob/rxinu/target/x86_64-rxinu/debug/deps --target x86_64-rxinu -L dependency=/home/rob/rxinu/target/x86_64-rxinu/debug/deps -L dependency=/home/rob/rxinu/target/debug/deps --extern bitflags=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libbitflags-6b084702002cf111.rlib --extern x86=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libx86-455753b7dd6b85e3.rlib --extern spin=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libspin-9bd689ac3bbcfdfa.rlib --extern multiboot2=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libmultiboot2-542aac65ec57e3e0.rlib --extern linked_list_allocator=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/liblinked_list_allocator-ef23ed764b8b68b8.rlib --extern volatile=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libvolatile-39e0b219e05681b4.rlib --extern bit_field=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libbit_field-677c54a61c03a33f.rlib --extern lazy_static=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/liblazy_static-870f43b7a19a5d5a.rlib --extern rlibc=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/librlibc-8eabc116dc6e8246.rlib --extern once=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libonce-2c4225e39ad50031.rlib --sysroot /home/rob/.xargo\r\nSegmentation fault (core dumped)\r\n```\r\n\r\n### [Rust Playground Reproduction](https://play.rust-lang.org/?gist=179d49ab8762ff5f9e52ee04481ec6fe&version=nightly)\r\n\r\n### Reproduction of incorrect code sample\r\n\r\n```rust\r\n#![feature(asm)]\r\n\r\ntrait Foo {\r\n    fn do_something(&self) -> usize;\r\n}\r\n\r\nstruct MyStruct;\r\n\r\nimpl Foo for MyStruct {\r\n    fn do_something(&self) -> usize {\r\n        10\r\n    }\r\n}\r\n\r\nfn main() {\r\n    unsafe {\r\n        let boxed_struct: Box<&Foo> = Box::new(&MyStruct {});\r\n        asm!(\"push $0\" : : \"r\"(Box::into_raw(boxed_struct) as usize) : \"memory\" : \"intel\", \"volatile\");\r\n\r\n        let struct_ptr: *mut Foo;  // This line is wrong\r\n        asm!(\"pop $0\" : \"=r\"(struct_ptr) : : \"memory\" : \"intel\", \"volatile\");\r\n\r\n        let trait_object = Box::from_raw(struct_ptr);\r\n        println!(\"{}\", trait_object.do_something());\r\n    }\r\n}\r\n```\r\n\r\n### Diff to fix incorrect code and avoid segfault\r\n\r\n```diff\r\n-let struct_ptr: *mut Foo;  // This line is wrong\r\n+let struct_ptr: *mut &Foo;  // This line is correct\r\n```\r\n\r\n## Meta\r\n\r\n### Compiler Version\r\n\r\n```\r\n[rob@localhost rxinu]$ rustc --version --verbose\r\nrustc 1.24.0-nightly (dc39c3169 2017-12-17)\r\nbinary: rustc\r\ncommit-hash: dc39c31699a83313edf2ac096d0bf3cef871b705\r\ncommit-date: 2017-12-17\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.24.0-nightly\r\nLLVM version: 4.0\r\n```\r\n\r\n### Backtrace\r\n\r\nRunning with RUST_BACKTRACE=1 does not print any useful information.\r\n\r\n```\r\n[rob@localhost rxinu]$ RUST_BACKTRACE=1 rustc --crate-name rxinu src/lib.rs --crate-type staticlib --emit=dep-info,link -C debuginfo=2 --cfg 'feature=\"default\"' --cfg 'feature=\"serial\"' -C metadata=31a0723d36405193 -C extra-filename=-31a0723d36405193 --out-dir /home/rob/rxinu/target/x86_64-rxinu/debug/deps --target x86_64-rxinu -L dependency=/home/rob/rxinu/target/x86_64-rxinu/debug/deps -L dependency=/home/rob/rxinu/target/debug/deps --extern bitflags=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libbitflags-6b084702002cf111.rlib --extern x86=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libx86-455753b7dd6b85e3.rlib --extern spin=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libspin-9bd689ac3bbcfdfa.rlib --extern multiboot2=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libmultiboot2-542aac65ec57e3e0.rlib --extern linked_list_allocator=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/liblinked_list_allocator-ef23ed764b8b68b8.rlib --extern volatile=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libvolatile-39e0b219e05681b4.rlib --extern bit_field=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libbit_field-677c54a61c03a33f.rlib --extern lazy_static=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/liblazy_static-870f43b7a19a5d5a.rlib --extern rlibc=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/librlibc-8eabc116dc6e8246.rlib --extern once=/home/rob/rxinu/target/x86_64-rxinu/debug/deps/libonce-2c4225e39ad50031.rlib --sysroot /home/rob/.xargo\r\nSegmentation fault (core dumped)\r\n```", "closed_by": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/46867/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/46867/timeline", "performed_via_github_app": null, "state_reason": "completed"}