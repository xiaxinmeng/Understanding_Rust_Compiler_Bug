{"url": "https://api.github.com/repos/rust-lang/rust/issues/70589", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/70589/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/70589/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/70589/events", "html_url": "https://github.com/rust-lang/rust/issues/70589", "id": 590563195, "node_id": "MDU6SXNzdWU1OTA1NjMxOTU=", "number": 70589, "title": "wasm target not honoring linker set at bootstrap time (1.42.0 and maybe earlier)", "user": {"login": "gyakovlev", "id": 168902, "node_id": "MDQ6VXNlcjE2ODkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/168902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gyakovlev", "html_url": "https://github.com/gyakovlev", "followers_url": "https://api.github.com/users/gyakovlev/followers", "following_url": "https://api.github.com/users/gyakovlev/following{/other_user}", "gists_url": "https://api.github.com/users/gyakovlev/gists{/gist_id}", "starred_url": "https://api.github.com/users/gyakovlev/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gyakovlev/subscriptions", "organizations_url": "https://api.github.com/users/gyakovlev/orgs", "repos_url": "https://api.github.com/users/gyakovlev/repos", "events_url": "https://api.github.com/users/gyakovlev/events{/privacy}", "received_events_url": "https://api.github.com/users/gyakovlev/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 474645165, "node_id": "MDU6TGFiZWw0NzQ2NDUxNjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-wasm", "name": "O-wasm", "color": "6e6ec0", "default": false, "description": "Target: WASM (WebAssembly), http://webassembly.org/"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2020-03-30T20:13:32Z", "updated_at": "2022-09-30T21:52:05Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "rust for gentoo linux (the one we ship in official repositories)\r\n\r\nhere's how we configure wasm target:\r\n\r\n```toml\r\n[target.wasm32-unknown-unknown]\r\nlinker = \"lld\"\r\n```\r\n\r\nbut it still looks for rust-lld for that target by default.\r\n\r\n```shel-session\r\ncargo build --release --target=wasm32-unknown-unknown --verbose\r\n   Compiling wasm-test v0.1.0 (/tmp/wasm-test)\r\n     Running `rustc --crate-name wasm_test src/lib.rs --error-format=json --json=diagnostic-rendered-ansi --crate-type cdylib --emit=dep-info,link -C opt-level=3 -C metadata=7a89689720da237e --out-dir /tmp/wasm-test/target/wasm32-unknown-unknown/release/deps --target wasm32-unknown-unknown -L dependency=/tmp/wasm-test/target/wasm32-unknown-unknown/release/deps -L dependency=/tmp/wasm-test/target/release/deps`\r\nerror: linker `rust-lld` not found\r\n  |\r\n  = note: No such file or directory (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: could not compile `wasm-test`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name wasm_test src/lib.rs --error-format=json --json=diagnostic-rendered-ansi --crate-type cdylib --emit=dep-info,link -C opt-level=3 -C metadata=7a89689720da237e --out-dir /tmp/wasm-test/target/wasm32-unknown-unknown/release/deps --target wasm32-unknown-unknown -L dependency=/tmp/wasm-test/target/wasm32-unknown-unknown/release/deps -L dependency=/tmp/wasm-test/target/release/deps` (exit code: 1)\r\n```\r\n\r\n\r\nnot sure when it started to happen, but it was working as expected before.\r\n`rustc -Z unstable-options --target=wasm32-unknown-unknown --print target-spec-json`\r\n```json\r\n{\r\n  \"arch\": \"wasm32\",\r\n  \"data-layout\": \"e-m:e-p:32:32-i64:64-n32:64-S128\",\r\n  \"default-hidden-visibility\": true,\r\n  \"dll-prefix\": \"\",\r\n  \"dll-suffix\": \".wasm\",\r\n  \"dynamic-linking\": true,\r\n  \"emit-debug-gdb-scripts\": false,\r\n  \"env\": \"\",\r\n  \"exe-suffix\": \".wasm\",\r\n  \"executables\": true,\r\n  \"has-elf-tls\": true,\r\n  \"is-builtin\": true,\r\n  \"limit-rdylib-exports\": false,\r\n  \"linker\": \"rust-lld\",\r\n  \"linker-flavor\": \"wasm-ld\",\r\n  \"lld-flavor\": \"wasm\",\r\n  \"llvm-target\": \"wasm32-unknown-unknown\",\r\n  \"max-atomic-width\": 64,\r\n  \"only-cdylib\": true,\r\n  \"os\": \"unknown\",\r\n  \"panic-strategy\": \"abort\",\r\n  \"pre-link-args\": {\r\n    \"gcc\": [\r\n      \"-Wl,--no-threads\",\r\n      \"-Wl,-z\",\r\n      \"-Wl,stack-size=1048576\",\r\n      \"-Wl,--stack-first\",\r\n      \"-Wl,--allow-undefined\",\r\n      \"-Wl,--fatal-warnings\",\r\n      \"-Wl,--no-demangle\",\r\n      \"-Wl,--export-dynamic\",\r\n      \"--target=wasm32-unknown-unknown\",\r\n      \"-nostdlib\",\r\n      \"-Wl,--no-entry\"\r\n    ],\r\n    \"wasm-ld\": [\r\n      \"--no-threads\",\r\n      \"-z\",\r\n      \"stack-size=1048576\",\r\n      \"--stack-first\",\r\n      \"--allow-undefined\",\r\n      \"--fatal-warnings\",\r\n      \"--no-demangle\",\r\n      \"--export-dynamic\",\r\n      \"--no-entry\"\r\n    ]\r\n  },\r\n  \"relocation-model\": \"static\",\r\n  \"simd-types-indirect\": false,\r\n  \"singlethread\": true,\r\n  \"target-c-int-width\": \"32\",\r\n  \"target-endian\": \"little\",\r\n  \"target-pointer-width\": \"32\",\r\n  \"tls-model\": \"local-exec\",\r\n  \"vendor\": \"unknown\"\r\n}\r\n```\r\n\r\nfor some reason target spec still lists `rust-lld` as preferred linker\r\n\r\nYes, there are ways to mitigate that, like\r\n`CARGO_TARGET_WASM32_UNKNOWN_UNKNOWN_LINKER=lld`\r\nor \r\n`RUSTFLAGS=\"-C linker=/usr/bin/lld`\r\n\r\nlld is system installed and provides the following files\r\n\r\n```\r\n/usr/bin/lld\r\n/usr/bin/wasm-ld -> lld\r\n/usr/bin/ld64.lld -> lld\r\n/usr/bin/ld.lld -> lld\r\n/usr/bin/lld-link -> lld\r\n```\r\n\r\nif we build using bundled llvm and lld, everything works as expected ofc.\r\n\r\nfull config.toml, happens on x86_64 as well, so powerpc being primay is irrelevant.\r\n```toml\r\n[llvm]\r\noptimize = true\r\nrelease-debuginfo = false\r\nassertions = false\r\ntargets = \"WebAssembly;PowerPC;AMDGPU\"\r\nexperimental-targets = \"\"\r\nlink-shared = true\r\n[build]\r\nbuild = \"powerpc64le-unknown-linux-gnu\"\r\nhost = [\"powerpc64le-unknown-linux-gnu\"]\r\ntarget = [\"powerpc64le-unknown-linux-gnu\",\"wasm32-unknown-unknown\"]\r\ncargo = \"/usr/bin/cargo\"\r\nrustc = \"/usr/bin/rustc\"\r\ndocs = false\r\ncompiler-docs = false\r\nsubmodules = false\r\npython = \"python3.6\"\r\nlocked-deps = true\r\nvendor = true\r\nextended = true\r\ntools = [\"rustfmt\",\"rls\",\"analysis\",\"src\",\"miri\",\"clippy\",\"cargo\",]\r\nverbose = 2\r\n[install]\r\nprefix = \"/usr\"\r\nlibdir = \"lib\"\r\ndocdir = \"share/doc/rust-1.42.0-r1\"\r\nmandir = \"share/man\"\r\n[rust]\r\noptimize = true\r\ndebug = false\r\ndebug-assertions = false\r\ndefault-linker = \"powerpc64le-unknown-linux-gnu-gcc\"\r\nparallel-compiler = true\r\nchannel = \"nightly\"\r\nrpath = false\r\nlld = false\r\nbacktrace-on-ice = true\r\n[dist]\r\nsrc-tarball = false\r\n[target.powerpc64le-unknown-linux-gnu]\r\ncc = \"powerpc64le-unknown-linux-gnu-gcc\"\r\ncxx = \"powerpc64le-unknown-linux-gnu-g++\"\r\nlinker = \"powerpc64le-unknown-linux-gnu-gcc\"\r\nar = \"powerpc64le-unknown-linux-gnu-ar\"\r\nllvm-config = \"/usr/lib/llvm/10/bin/llvm-config\"\r\n[target.wasm32-unknown-unknown]\r\nlinker = \"lld\"\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/70589/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/70589/timeline", "performed_via_github_app": null, "state_reason": null}