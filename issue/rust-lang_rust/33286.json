{"url": "https://api.github.com/repos/rust-lang/rust/issues/33286", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/33286/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/33286/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/33286/events", "html_url": "https://github.com/rust-lang/rust/issues/33286", "id": 152002537, "node_id": "MDU6SXNzdWUxNTIwMDI1Mzc=", "number": 33286, "title": "A `rustc` compiled from the `rust-*-src` tarballs can't be used with the `std` binaries from s.r-l.o/dist", "user": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 36996, "node_id": "MDU6TGFiZWwzNjk5Ng==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-easy", "name": "E-easy", "color": "02e10c", "default": false, "description": "Call for participation: Experience needed to fix: Easy / not much (good first issue)"}, {"id": 67766349, "node_id": "MDU6TGFiZWw2Nzc2NjM0OQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-mentor", "name": "E-mentor", "color": "02E10C", "default": false, "description": "Call for participation: This issue has a mentor. Use RustcContributor::new on Zulip for discussion."}, {"id": 325438536, "node_id": "MDU6TGFiZWwzMjU0Mzg1MzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-bootstrap", "name": "T-bootstrap", "color": "bfd4f2", "default": false, "description": "Relevant to the bootstrap subteam: Rust's build system (x.py and src/bootstrap)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": {"login": "dawnofmidnight", "id": 78233879, "node_id": "MDQ6VXNlcjc4MjMzODc5", "avatar_url": "https://avatars.githubusercontent.com/u/78233879?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dawnofmidnight", "html_url": "https://github.com/dawnofmidnight", "followers_url": "https://api.github.com/users/dawnofmidnight/followers", "following_url": "https://api.github.com/users/dawnofmidnight/following{/other_user}", "gists_url": "https://api.github.com/users/dawnofmidnight/gists{/gist_id}", "starred_url": "https://api.github.com/users/dawnofmidnight/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dawnofmidnight/subscriptions", "organizations_url": "https://api.github.com/users/dawnofmidnight/orgs", "repos_url": "https://api.github.com/users/dawnofmidnight/repos", "events_url": "https://api.github.com/users/dawnofmidnight/events{/privacy}", "received_events_url": "https://api.github.com/users/dawnofmidnight/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "dawnofmidnight", "id": 78233879, "node_id": "MDQ6VXNlcjc4MjMzODc5", "avatar_url": "https://avatars.githubusercontent.com/u/78233879?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dawnofmidnight", "html_url": "https://github.com/dawnofmidnight", "followers_url": "https://api.github.com/users/dawnofmidnight/followers", "following_url": "https://api.github.com/users/dawnofmidnight/following{/other_user}", "gists_url": "https://api.github.com/users/dawnofmidnight/gists{/gist_id}", "starred_url": "https://api.github.com/users/dawnofmidnight/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dawnofmidnight/subscriptions", "organizations_url": "https://api.github.com/users/dawnofmidnight/orgs", "repos_url": "https://api.github.com/users/dawnofmidnight/repos", "events_url": "https://api.github.com/users/dawnofmidnight/events{/privacy}", "received_events_url": "https://api.github.com/users/dawnofmidnight/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 12, "created_at": "2016-04-30T02:52:41Z", "updated_at": "2022-10-02T23:47:56Z", "closed_at": "2022-10-02T23:47:56Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Originally reported [here](https://www.reddit.com/r/rust/comments/4h2ir3/the_crate_std_has_been_compiled_with_rustc_180/)\n\nIn the reported case the `rust` package provided by Arch Linux was compiled from [the `rustc-1.8.0-src.tar.gz` tarball](https://git.archlinux.org/svntogit/community.git/tree/trunk/PKGBUILD?h=packages/rust#n14). Thus their `rustc` binary doesn't have a git commit hash encoded in it:\n\n```\n$ rustc -V\nrust-1.8.0\n```\n\nAnd if you try to use this `rustc` to cross compile using the `std` binaries from [s.r-l.o](https://static.rust-lang.org/dist/) you get the following error:\n\n```\n$ cargo build --target=i686-pc-windows-gnu`\nerror: the crate `std` has been compiled with rustc 1.8.0 (db2939409 2016-04-11), which is incompatible with this version of rustc [E0514]\n```\n\nAt the center of this issue is [this check](https://github.com/rust-lang/rust/blob/db2939409db26ab4904372c82492cd3488e4c44e/src/librustc_metadata/creader.rs#L261), this [rustc_version](https://github.com/rust-lang/rust/blob/db2939409db26ab4904372c82492cd3488e4c44e/src/librustc_metadata/common.rs#L245-L250) function and this [CFG_VERSION](https://github.com/rust-lang/rust/blob/master/mk/main.mk#L85) env variable which is set by the build system.\n\nIn the case of the `std` crate since it was compiled from a git checkout the value returned by `rustc_version` is `1.8.0 ($SOME_HASH $SOME_DATE)` whereas the same function just returns `1.8.0` in the case of a `rustc` that was compiled from a source tarball. The mismatch between these two strings is what causes the error reported above. But the error message is wrong because both binaries where compiled from the exact same source code and can be used together.\n\nHow to fix this? Possible solutions:\n- Ask package maintaners to always build from a git checkout. This way the \"rustc_version\" string always contains a git commit hash.\n- Tweak our build system so that building from a git checkout and from a source tarball yield the same \"rustc_version\" string. Two possible implementations:\n  - Drop the commit hash/date part from the \"rustc_version\" string. This may be OK for the stable and beta channels because you can tell them apart from looking at the version number (e.g. 1.7.0 vs 1.8.0) but that's not the case for nightlies -- two consecutive nightlies would have the same version number (e.g. 1.10.0-nightly).\n  - Include the commit hash part in the `rustc-*-src.tar.gz` tarballs, perhaps as a `.commit-hash` file and tweak the build system to use the contents of this file in the \"rustc_version\" string when one is not building from a git checkout.\n\nThoughts? @alexcrichton @brson \n\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"dawnofmidnight\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/33286/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/33286/timeline", "performed_via_github_app": null, "state_reason": "completed"}