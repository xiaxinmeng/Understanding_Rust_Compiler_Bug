{"url": "https://api.github.com/repos/rust-lang/rust/issues/79280", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/79280/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/79280/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/79280/events", "html_url": "https://github.com/rust-lang/rust/issues/79280", "id": 748113784, "node_id": "MDU6SXNzdWU3NDgxMTM3ODQ=", "number": 79280, "title": "Cross-compiling from x86_64 to arm64 on macOS 11.1 fails to compile stage1 std artifacts ", "user": {"login": "felixbuenemann", "id": 909587, "node_id": "MDQ6VXNlcjkwOTU4Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/909587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/felixbuenemann", "html_url": "https://github.com/felixbuenemann", "followers_url": "https://api.github.com/users/felixbuenemann/followers", "following_url": "https://api.github.com/users/felixbuenemann/following{/other_user}", "gists_url": "https://api.github.com/users/felixbuenemann/gists{/gist_id}", "starred_url": "https://api.github.com/users/felixbuenemann/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/felixbuenemann/subscriptions", "organizations_url": "https://api.github.com/users/felixbuenemann/orgs", "repos_url": "https://api.github.com/users/felixbuenemann/repos", "events_url": "https://api.github.com/users/felixbuenemann/events{/privacy}", "received_events_url": "https://api.github.com/users/felixbuenemann/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123111, "node_id": "MDU6TGFiZWwxMjMxMTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-macos", "name": "O-macos", "color": "6e6ec0", "default": false, "description": "Operating system: macOS"}, {"id": 55302148, "node_id": "MDU6TGFiZWw1NTMwMjE0OA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-x86_64", "name": "O-x86_64", "color": "6e6ec0", "default": false, "description": "Target: x64 processors"}, {"id": 167285428, "node_id": "MDU6TGFiZWwxNjcyODU0Mjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-cross", "name": "A-cross", "color": "f7e101", "default": false, "description": "Area: Cross compilation"}, {"id": 325438536, "node_id": "MDU6TGFiZWwzMjU0Mzg1MzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-bootstrap", "name": "T-bootstrap", "color": "bfd4f2", "default": false, "description": "Relevant to the bootstrap subteam: Rust's build system (x.py and src/bootstrap)"}, {"id": 3940166907, "node_id": "LA_kwDOAAsO6M7q2iz7", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-AArch64", "name": "O-AArch64", "color": "6e6ec0", "default": false, "description": "Armv8-A or later processors in AArch64 mode"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 10, "created_at": "2020-11-21T22:18:51Z", "updated_at": "2022-03-18T01:06:28Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "When cross-compiling either v1.48 or master@d806d656578 from x86_64 to arm64 on MacBook Air (M1, 2020) running macOS 11.1 Beta (20C5048l) and Xcode 12.3 beta (12C5020f), the compilation fails when trying to build the stage1 std artifacts for stage2:\r\n\r\n```\r\n% uname -m\r\narm64\r\n% grep -E \"^(build|host|target) =\" config.toml\r\nbuild = 'x86_64-apple-darwin'\r\nhost = ['aarch64-apple-darwin']\r\ntarget = ['aarch64-apple-darwin']\r\n```\r\n\r\n```\r\n% make\r\n    Finished dev [unoptimized + debuginfo] target(s) in 0.14s\r\nwarning: there have been changes to x.py since you last updated.\r\nhelp: consider looking at the changes in `src/bootstrap/CHANGELOG.md`\r\nnote: to silence this warning, update `config.toml` to use `changelog-seen = 2` instead\r\nBuilding stage0 std artifacts (x86_64-apple-darwin -> x86_64-apple-darwin)\r\n    Finished release [optimized] target(s) in 0.11s\r\nCopying stage0 std from stage0 (x86_64-apple-darwin -> x86_64-apple-darwin / x86_64-apple-darwin)\r\nCould not determine the LLVM submodule commit hash. Assuming that an LLVM rebuild is not necessary.\r\nTo force LLVM to rebuild, remove the file `/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/llvm/llvm-finished-building`\r\nBuilding stage0 compiler artifacts (x86_64-apple-darwin -> x86_64-apple-darwin)\r\n    Finished release [optimized] target(s) in 0.18s\r\nCopying stage0 rustc from stage0 (x86_64-apple-darwin -> x86_64-apple-darwin / x86_64-apple-darwin)\r\nAssembling stage1 compiler (x86_64-apple-darwin)\r\nBuilding stage1 std artifacts (x86_64-apple-darwin -> x86_64-apple-darwin)\r\n    Finished release [optimized] target(s) in 0.13s\r\nCopying stage1 std from stage1 (x86_64-apple-darwin -> x86_64-apple-darwin / x86_64-apple-darwin)\r\nBuilding stage1 compiler artifacts (x86_64-apple-darwin -> x86_64-apple-darwin)\r\n    Finished release [optimized] target(s) in 0.18s\r\nCopying stage1 rustc from stage1 (x86_64-apple-darwin -> x86_64-apple-darwin / x86_64-apple-darwin)\r\nAssembling stage2 compiler (x86_64-apple-darwin)\r\nBuilding stage1 std artifacts (x86_64-apple-darwin -> aarch64-apple-darwin)\r\n   Compiling std v0.0.0 (/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/library/std)\r\nerror: linking with `clang` failed: exit code: 1\r\n  |\r\n  = note: \"clang\" \"-arch\" \"arm64\" \"-L\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1/lib/rustlib/aarch64-apple-darwin/lib\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.0.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.1.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.10.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.11.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.12.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.13.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.14.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.15.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.2.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.3.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.4.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.5.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.6.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.7.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.8.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.std.df713kw9-cgu.9.rcgu.o\" \"-o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/libstd-e2d6f492c8b2d1df.dylib\" \"-Wl,-exported_symbols_list,/private/tmp/rustcCncuXN/list\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.s8krdvcbzje2gsl.rcgu.o\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps/std-e2d6f492c8b2d1df.32vp5h2h70z0baum.rcgu.o\" \"-Wl,-dead_strip\" \"-dynamiclib\" \"-Wl,-dylib\" \"-Wl,-install_name\" \"-Wl,@rpath/libstd-e2d6f492c8b2d1df.dylib\" \"-nodefaultlibs\" \"-L\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/deps\" \"-L\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/release/deps\" \"-L\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1-std/aarch64-apple-darwin/release/build/compiler_builtins-c337dd450e333db0/out\" \"-L\" \"/private/tmp/rust-20201121-94992-iuj811/rustc-1.48.0-src/build/x86_64-apple-darwin/stage1/lib/rustlib/aarch64-apple-darwin/lib\" \"-lSystem\" \"-lresolv\" \"-Wl,-force_load\" \"-Wl,/private/tmp/rustcCncuXN/libpanic_unwind-ae9f774b49d93062.rlib\" \"-Wl,-force_load\" \"-Wl,/private/tmp/rustcCncuXN/libobject-8856f1ded0536c74.rlib\" \"-Wl,-force_load\" \"-Wl,/private/tmp/rustcCncuXN/libaddr2line-0f0383ea697c7750.rlib\" \"-Wl,-force_load\" \"-Wl,/private/tmp/rustcCncuXN/libgimli-92cf120f7800af66.rlib\" \"-Wl,-force_load\" \"-Wl,/private/tmp/rustcCncuXN/librustc_demangle-a7a71dbb2e687bfa.rlib\" \"-Wl,-force_load\" \"-Wl,/private/tmp/rustcCncuXN/libhashbrown-8540130587673a3f.rlib\" \"-Wl,-force_load\" \"-Wl,/private/tmp/rustcCncuXN/librustc_std_workspace_alloc-6b033095361c6f7b.rlib\" \"-Wl,-force_load\" \"-Wl,/private/tmp/rustcCncuXN/libunwind-38f331437c8ebca7.rlib\" \"-Wl,-force_load\" \"-Wl,/private/tmp/rustcCncuXN/libcfg_if-ffd487bab818ca85.rlib\" \"-Wl,-force_load\" \"-Wl,/private/tmp/rustcCncuXN/liblibc-e8ca45c499b5b583.rlib\" \"-Wl,-force_load\" \"-Wl,/private/tmp/rustcCncuXN/liballoc-7869d17a01843983.rlib\" \"-Wl,-force_load\" \"-Wl,/private/tmp/rustcCncuXN/librustc_std_workspace_core-e5304dd642386a97.rlib\" \"-Wl,-force_load\" \"-Wl,/private/tmp/rustcCncuXN/libcore-c584be2e4a499900.rlib\" \"/private/tmp/rustcCncuXN/libcompiler_builtins-235bdf94dbd2400b.rlib\" \"-lc\" \"-lm\" \"-Wl,-rpath,@loader_path/../lib\"\r\n  = note: Undefined symbols for architecture x86_64:\r\n            \"std::net::udp::UdpSocket::set_multicast_loop_v4::h29c5f9a7502375e9\", referenced from:\r\n               -exported_symbol[s_list] command line option\r\n            \"std::fs::Permissions::set_readonly::hca79eaf67028178b\", referenced from:\r\n               -exported_symbol[s_list] command line option\r\n            \"std::io::stdio::Stdin::lock::h7f81bb5795d87a3d\", referenced from:\r\n               -exported_symbol[s_list] command line option\r\n            \"std::net::ip::Ipv4Addr::is_shared::h37f841feb8719198\", referenced from:\r\n               -exported_symbol[s_list] command line option\r\n...\r\n```\r\n\r\nThousands of similar log lines follow with all the different symbols.\r\n\r\nNot sure why it is expecting x86_64 symbols, since the objects are arm64, as verified with `lips -archs some.o`.\r\n\r\nBuild Tools:\r\n\r\n```\r\n% ninja --version\r\n1.10.1\r\n% clang -v\r\nApple clang version 12.0.0 (clang-1200.0.32.28)\r\nTarget: arm64-apple-darwin20.2.0\r\nThread model: posix\r\nInstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin\r\n% ld -v\r\n@(#)PROGRAM:ld  PROJECT:ld64-609.8\r\nBUILD 19:59:02 Nov  4 2020\r\nconfigured to support archs: armv6 armv7 armv7s arm64 arm64e arm64_32 i386 x86_64 x86_64h armv6m armv7k armv7m armv7em\r\nLTO support using: LLVM version 12.0.0, (clang-1200.0.32.28) (static support for 27, runtime is 27)\r\nTAPI support using: Apple TAPI version 12.0.0 (tapi-1200.0.23.5)\r\n```\r\n\r\nLet me know if you need additional info.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/79280/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/79280/timeline", "performed_via_github_app": null, "state_reason": null}