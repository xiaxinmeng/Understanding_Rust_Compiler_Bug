{"url": "https://api.github.com/repos/rust-lang/rust/issues/27396", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/27396/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/27396/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/27396/events", "html_url": "https://github.com/rust-lang/rust/issues/27396", "id": 98095377, "node_id": "MDU6SXNzdWU5ODA5NTM3Nw==", "number": 27396, "title": "std::io::BufReader reads incorrect data", "user": {"login": "cepreu2github", "id": 4133611, "node_id": "MDQ6VXNlcjQxMzM2MTE=", "avatar_url": "https://avatars.githubusercontent.com/u/4133611?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cepreu2github", "html_url": "https://github.com/cepreu2github", "followers_url": "https://api.github.com/users/cepreu2github/followers", "following_url": "https://api.github.com/users/cepreu2github/following{/other_user}", "gists_url": "https://api.github.com/users/cepreu2github/gists{/gist_id}", "starred_url": "https://api.github.com/users/cepreu2github/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cepreu2github/subscriptions", "organizations_url": "https://api.github.com/users/cepreu2github/orgs", "repos_url": "https://api.github.com/users/cepreu2github/repos", "events_url": "https://api.github.com/users/cepreu2github/events{/privacy}", "received_events_url": "https://api.github.com/users/cepreu2github/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2015-07-30T06:18:52Z", "updated_at": "2015-07-30T15:48:01Z", "closed_at": "2015-07-30T15:48:01Z", "author_association": "NONE", "active_lock_reason": null, "body": "Steps to reproduce:\n1) Download test TGA image at https://drive.google.com/file/d/0B7COwFox9fT8Wk9WSk5iMWRaRFk/view?usp=sharing .\n2) Past this code in `bug_example.rs`:\n\n``` Rust\nuse std::fs::File;\nuse std::io::BufReader;\nuse std::io::Read;\nuse std::path::Path;\n\nfn main() {\n    let path = Path::new(\"colors.tga\");\n    let mut file_buf = BufReader::new(File::open(&path).unwrap());\n    let mut file = File::open(&path).unwrap();\n    let mut header_bytes: [u8; 18] = [0; 18];\n    file_buf.read(&mut header_bytes);\n    file.read(&mut header_bytes);\n    let xsize = header_bytes[12] as usize + header_bytes[13] as usize*256;\n    let ysize = header_bytes[14] as usize + header_bytes[15] as usize*256;\n    println!(\"{}x{}\", xsize, ysize);\n    let mut canvas = vec![vec![0;ysize];xsize];\n    for iy in 0..ysize{\n        for ix in 0..xsize{\n            let mut bytes: [u8; 4] = [0; 4];\n            file.read(&mut bytes);\n            let mut bytes_buf: [u8; 4] = [0; 4];\n            file_buf.read(&mut bytes_buf);\n            println!(\"file: {} {} {} {}\", bytes[0], bytes[1], bytes[2], bytes[3]);\n            println!(\" buf: {} {} {} {}\", bytes_buf[0], bytes_buf[1], bytes_buf[2], bytes_buf[3]);\n            assert!(bytes[0] == bytes_buf[0]);\n            assert!(bytes[1] == bytes_buf[1]);\n            assert!(bytes[2] == bytes_buf[2]);\n            assert!(bytes[3] == bytes_buf[3]);\n            canvas[ix][iy] = bytes[2] as u32 + ((bytes[1] as u32) << (8*1)) + ((bytes[0] as u32) << (8*2));\n        }\n    }\n}\n```\n\n3) `rustc bug_example.rs ; ./bug_example`\n4) It FAILS! But it not supposed to do that, because File and BufReader reading the SAME file. There must be same data in buffers.\n\nTested it with Ubuntu 14.04 x64 and Rust 1.1.\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/27396/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/27396/timeline", "performed_via_github_app": null, "state_reason": "completed"}