{"url": "https://api.github.com/repos/rust-lang/rust/issues/43264", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/43264/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/43264/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/43264/events", "html_url": "https://github.com/rust-lang/rust/issues/43264", "id": 243215672, "node_id": "MDU6SXNzdWUyNDMyMTU2NzI=", "number": 43264, "title": "Building `no_std` binary fails with link error \"undefined reference to `__rust_probestack\"", "user": {"login": "ranweiler", "id": 515835, "node_id": "MDQ6VXNlcjUxNTgzNQ==", "avatar_url": "https://avatars.githubusercontent.com/u/515835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ranweiler", "html_url": "https://github.com/ranweiler", "followers_url": "https://api.github.com/users/ranweiler/followers", "following_url": "https://api.github.com/users/ranweiler/following{/other_user}", "gists_url": "https://api.github.com/users/ranweiler/gists{/gist_id}", "starred_url": "https://api.github.com/users/ranweiler/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ranweiler/subscriptions", "organizations_url": "https://api.github.com/users/ranweiler/orgs", "repos_url": "https://api.github.com/users/ranweiler/repos", "events_url": "https://api.github.com/users/ranweiler/events{/privacy}", "received_events_url": "https://api.github.com/users/ranweiler/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2017-07-16T03:55:42Z", "updated_at": "2017-08-07T20:38:23Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "## Platform\r\n- Rust nightly, version: `rustc 1.20.0-nightly (086eaa78e 2017-07-15)`\r\n- OS: `Linux 4.9.0-3-amd64 #1 SMP Debian 4.9.30-2+deb9u2 (2017-06-26) x86_64 GNU/Linux`\r\n\r\n## Summary\r\nCompilation of a `no_std` binary on nightly fails with a linking error about the new stack probe feature. \r\n\r\n**Expected:** The binary builds successfully, and `rustc` links to the new `__rust_probestack` implementation for my platform.\r\n\r\n**Observed:** Building fails with a link error: ```undefined reference to `__rust_probestack'```\r\n\r\n## Comments\r\n\r\nI poked around the Rust source and recent PRs around stack probes, and the feature didn't seem to be configurable. Things that would be nice: the ability to toggle stack probes with a `-C` flag, or to have a configurable language item, like we do for `eh_personality` and `panic_fmt`. I have not yet tried to work around this with linker arguments, as it is more of a weird edge case I ran into in some throwaway example code.\r\n\r\n## Question\r\n\r\nIs there a reason this behavior is expected, and linking _shouldn't_ just work?\r\n\r\n## Test case\r\nThe issue can be reproduced using the following project:\r\n\r\n`Cargo.toml`:\r\n```toml\r\n[package]\r\nname = \"example\"\r\nversion = \"0.1.0\"\r\n\r\n[dependencies]\r\nlibc = { version = \"0.2.11\", default-features = false }\r\n```\r\nand `src/main.rs`:\r\n```rust\r\n#![feature(lang_items)]\r\n#![feature(start)]\r\n#![no_std]\r\nextern crate libc;\r\n\r\n// const SIZE: usize = 2008; // This is a threshold. The project successfully builds.\r\nconst SIZE: usize = 2009; // This is the smallest array size which triggered a failure.\r\n\r\nstruct S { data: [u8; SIZE] }\r\n\r\n#[start]\r\nfn start(_argc: isize, _argv: *const *const u8) -> isize {\r\n    let s = S { data: [0; SIZE] };\r\n    0\r\n}\r\n\r\n#[lang = \"eh_personality\"] extern fn eh_personality() {}\r\n#[lang = \"panic_fmt\"] extern fn panic_fmt() -> ! { loop {} }\r\n```\r\n\r\n## Output\r\nFull error from `cargo build`:\r\n```\r\n$ cargo build --verbose\r\n       Fresh libc v0.2.26\r\n   Compiling example v0.1.0 (file:///home/joe/src/example)\r\n     Running `rustc --crate-name example src/main.rs --crate-type bin --emit=dep-info,link -C debuginfo=2 -C metadata=9cb543322668ed58 -C extra-filename=-9cb543322668ed58 --out-dir /home/joe/src/example/target/debug/deps -L dependency=/home/joe/src/example/target/debug/deps --extern libc=/home/joe/src/example/target/debug/deps/liblibc-d2ff9e092d4e994b.rlib`\r\nwarning: field is never used: `data`\r\n --> src/main.rs:9:12\r\n  |\r\n9 | struct S { data: [u8; SIZE] }\r\n  |            ^^^^^^^^^^^^^^^^\r\n  |\r\n  = note: #[warn(dead_code)] on by default\r\n\r\nwarning: unused variable: `s`\r\n  --> src/main.rs:13:9\r\n   |\r\n13 |     let s = S { data: [0; SIZE] };\r\n   |         ^\r\n   |\r\n   = note: #[warn(unused_variables)] on by default\r\n\r\nerror: linking with `cc` failed: exit code: 1\r\n  |\r\n  = note: \"cc\" \"-Wl,--as-needed\" \"-Wl,-z,noexecstack\" \"-m64\" \"-L\" \"/home/joe/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"/home/joe/src/example/target/debug/deps/example-9cb543322668ed58.0.o\" \"-o\" \"/home/joe/src/example/target/debug/deps/example-9cb543322668ed58\" \"-Wl,--gc-sections\" \"-pie\" \"-nodefaultlibs\" \"-L\" \"/home/joe/src/example/target/debug/deps\" \"-L\" \"/home/joe/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-Wl,-Bstatic\" \"/home/joe/src/example/target/debug/deps/liblibc-d2ff9e092d4e994b.rlib\" \"/home/joe/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcore-225cf0734ab321d6.rlib\" \"-Wl,-Bdynamic\" \"-l\" \"c\" \"-l\" \"m\" \"-l\" \"rt\" \"-l\" \"pthread\" \"-l\" \"util\"\r\n  = note: /home/joe/src/example/target/debug/deps/example-9cb543322668ed58.0.o: In function `example::start':\r\n          /home/joe/src/example/src/main.rs:12: undefined reference to `__rust_probestack'\r\n          collect2: error: ld returned 1 exit status\r\n          \r\n\r\nerror: aborting due to previous error\r\n\r\nerror: Could not compile `example`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name example src/main.rs --crate-type bin --emit=dep-info,link -C debuginfo=2 -C metadata=9cb543322668ed58 -C extra-filename=-9cb543322668ed58 --out-dir /home/joe/src/example/target/debug/deps -L dependency=/home/joe/src/example/target/debug/deps --extern libc=/home/joe/src/example/target/debug/deps/liblibc-d2ff9e092d4e994b.rlib` (exit code: 101)\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/43264/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/43264/timeline", "performed_via_github_app": null, "state_reason": null}