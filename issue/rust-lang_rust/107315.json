{"url": "https://api.github.com/repos/rust-lang/rust/issues/107315", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/107315/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/107315/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/107315/events", "html_url": "https://github.com/rust-lang/rust/issues/107315", "id": 1557656250, "node_id": "I_kwDOAAsO6M5c1_K6", "number": 107315, "title": "ConstGoto can produce invalid control flow in cleanup blocks", "user": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1927601458, "node_id": "MDU6TGFiZWwxOTI3NjAxNDU4", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-mir-opt", "name": "A-mir-opt", "color": "f7e101", "default": false, "description": "Area: MIR optimizations"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2023-01-26T05:39:28Z", "updated_at": "2023-01-26T19:28:46Z", "closed_at": "2023-01-26T19:28:46Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "With https://github.com/rust-lang/rust/pull/106613, the crate `fallible_iterator` doesn't pass MIR validation after ConstGoto (this is why CI on that PR doesn't pass):\r\n\r\n```\r\nerror: internal compiler error: broken MIR in Item(WithOptConstParam { did: DefId(0:415 ~ fallible_iterator[87b6]::{impl#25}::try_fold), const_param_did: None }) (after pass ConstGoto) at bb15[0]:\r\n                                Cleanup control flow violation: The blocks dominated by bb15 have edges to both bb14 and bb10\r\n    --> src/lib.rs:1814:5\r\n     |\r\n1814 |     }\r\n     |     ^\r\n```\r\nThis is the validation check that was improved in https://github.com/rust-lang/rust/pull/106612\r\n\r\nTo reproduce, build `fallible_iterator` 0.2.0 with that PR, and using `-Zvalidate-mir` and `--release`.\r\n\r\nI think the bug here is that ConstGoto is capable of turning MIR that passes validation into MIR that doesn't. It is of course tempting to blame the new pass, but if I recall correctly @JakobDegen previously indicated to me that it seems more likely that a pass which changes the control flow graph is the actual problem here.\r\n\r\nI haven't minimized the code pattern that causes the problematic transformation, but I'm including the MIR graphviz dumps of the problematic function before and after ConstGoto:\r\n\r\n![ConstGoto.before](https://user-images.githubusercontent.com/12105168/214763073-4c60a688-9d95-4bea-aacf-594d3d7991dd.png)\r\n![ConstGoto.after](https://user-images.githubusercontent.com/12105168/214763075-00f6f970-d672-4bc4-b3fb-7a9c27833129.png)\r\n\r\n@rustbot label +A-mir-opt +C-bug", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/107315/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/107315/timeline", "performed_via_github_app": null, "state_reason": "completed"}