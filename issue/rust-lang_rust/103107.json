{"url": "https://api.github.com/repos/rust-lang/rust/issues/103107", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/103107/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/103107/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/103107/events", "html_url": "https://github.com/rust-lang/rust/issues/103107", "id": 1410407907, "node_id": "I_kwDOAAsO6M5UER3j", "number": 103107, "title": "Drop order twist of && and || chains", "user": {"login": "est31", "id": 8872119, "node_id": "MDQ6VXNlcjg4NzIxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8872119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/est31", "html_url": "https://github.com/est31", "followers_url": "https://api.github.com/users/est31/followers", "following_url": "https://api.github.com/users/est31/following{/other_user}", "gists_url": "https://api.github.com/users/est31/gists{/gist_id}", "starred_url": "https://api.github.com/users/est31/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/est31/subscriptions", "organizations_url": "https://api.github.com/users/est31/orgs", "repos_url": "https://api.github.com/users/est31/repos", "events_url": "https://api.github.com/users/est31/events{/privacy}", "received_events_url": "https://api.github.com/users/est31/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668019, "node_id": "MDU6TGFiZWwyMTE2NjgwMTk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-lang", "name": "T-lang", "color": "bfd4f2", "default": false, "description": "Relevant to the language team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-10-16T07:55:27Z", "updated_at": "2022-12-04T16:32:19Z", "closed_at": "2022-12-04T16:32:19Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "If you consider the following program:\r\n\r\n```Rust\r\nstruct LoudDrop(&'static str);\r\n\r\nimpl Drop for LoudDrop {\r\n    fn drop(&mut self) {\r\n        print!(\"{},\", self.0);\r\n    }\r\n}\r\n\r\nimpl LoudDrop {\r\n    fn foo(&self) -> bool {\r\n        true\r\n    }\r\n}\r\n\r\nfn main() {\r\n    if LoudDrop(\"1\").foo() &&\r\n    LoudDrop(\"2\").foo() &&\r\n    LoudDrop(\"3\").foo() &&\r\n    LoudDrop(\"4\").foo() {}\r\n    println!(\"\");\r\n\r\n    let _b = LoudDrop(\"1\").foo() &&\r\n    LoudDrop(\"2\").foo() &&\r\n    LoudDrop(\"3\").foo() &&\r\n    LoudDrop(\"4\").foo();\r\n    println!(\"\");\r\n\r\n    if !LoudDrop(\"1\").foo() ||\r\n    !LoudDrop(\"2\").foo() ||\r\n    !LoudDrop(\"3\").foo() ||\r\n    !LoudDrop(\"4\").foo() {}\r\n    println!(\"\");\r\n\r\n    let _b = !LoudDrop(\"1\").foo() ||\r\n    !LoudDrop(\"2\").foo() ||\r\n    !LoudDrop(\"3\").foo() ||\r\n    !LoudDrop(\"4\").foo();\r\n    println!(\"\");\r\n}\r\n```\r\n\r\nIt will print \"2,3,4,1,\" four times. The issue occurs on recent nightly as well as all the way back to 1.0.0. This is a bit weird IMO, and makes && and || chains non-associative. IMO it's a bug that should be fixed to print \"1,2,3,4,\".\r\n\r\nIDK how much we can do about this at the current point, given backwards compatibility concerns. It might not stop programs from compiling, but programs might differ in their runtime output. There is [RFC 1857](https://github.com/rust-lang/rfcs/pull/1857) with the name \"Stabilize drop order\" but if you read the text, it only concerns the drop order of structs, vecs, tuples, etc. Also, after the merge, the RFC author themself made a PR to add regression tests in #43125 , and mentioned that that PR was enough for getting the RFC tested. The RFC didn't include anything about && chains. I think the language should not be interpreted too generally.\r\n\r\nIt took a long time until #100526 in which we we got some further drop order tests for \"established\" language constructs, while there have been many PRs with drop order tests for let-else.\r\n\r\nOriginally I've discovered this in: https://github.com/rust-lang/rust/pull/102998#discussion_r996153602 , but given that it's so visible, I'm sure that someone else has already complained about this.\r\n\r\nMaybe one can just implement the change to \"1,2,3,4,\" and make a crater run for it?\r\n\r\ncc @Nilstrieb @nathanwhit\r\n\r\n@rustbot label T-lang", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/103107/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/103107/timeline", "performed_via_github_app": null, "state_reason": "completed"}