{"url": "https://api.github.com/repos/rust-lang/rust/issues/28627", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/28627/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/28627/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/28627/events", "html_url": "https://github.com/rust-lang/rust/issues/28627", "id": 108141737, "node_id": "MDU6SXNzdWUxMDgxNDE3Mzc=", "number": 28627, "title": "Installation is broken when custom relative libdir path starts with lib/ or when libdir is changed during installation", "user": {"login": "jauhien", "id": 1590238, "node_id": "MDQ6VXNlcjE1OTAyMzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1590238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jauhien", "html_url": "https://github.com/jauhien", "followers_url": "https://api.github.com/users/jauhien/followers", "following_url": "https://api.github.com/users/jauhien/following{/other_user}", "gists_url": "https://api.github.com/users/jauhien/gists{/gist_id}", "starred_url": "https://api.github.com/users/jauhien/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jauhien/subscriptions", "organizations_url": "https://api.github.com/users/jauhien/orgs", "repos_url": "https://api.github.com/users/jauhien/repos", "events_url": "https://api.github.com/users/jauhien/events{/privacy}", "received_events_url": "https://api.github.com/users/jauhien/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123110, "node_id": "MDU6TGFiZWwxMjMxMTA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-linux", "name": "O-linux", "color": "6e6ec0", "default": false, "description": "Operating system: Linux"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2015-09-24T14:25:43Z", "updated_at": "2017-03-08T17:55:35Z", "closed_at": "2017-03-08T17:55:35Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Gentoo uses installation of multiple rust versions side by side based on the possibility to install libraries to custom locations. At the moment because of this bug (its first part) we need to apply [patch](https://github.com/gentoo/gentoo-rust/blob/master/dev-lang/rust/files/rust-1.1.0-install.patch).\n# Steps to reproduce bug.\n## Case when custom libdir works\n\nWe are installing to `/home/jauhien/w/image-working`, libraries go to `/home/jauhien/w/image-working/customrust`.\n1. Configure rust\n   \n   ```\n   ./configure --prefix=/home/jauhien/w/image-working --libdir=/home/jauhien/w/image-working/customrust --disable-debug --disable-valgrind --disable-helgrind --disable-valgrind-rpass --enable-debuginfo-tests --disable-llvm-assertions --disable-debug-assertions --disable-debug-jemalloc --disable-debuginfo\n   ```\n2. Make rust\n   \n   ```\n   make -j5\n   ```\n   \n   Have some coffee or tea.\n3. Install rust\n   \n   ```\n   make install\n   ```\n\nRust is installed and works. Libraries go to `/home/jauhien/w/image-working/customrust` as expected.\n## Case when custom libdir leads to failure (bug)\n\nWe are going to install rust into `/home/jauhien/w/image`, libraries will go to `/home/jauhien/w/image/lib/customrust`.\n1. Configure rust\n   `\n   ./configure --prefix=/home/jauhien/w/image --libdir=/home/jauhien/w/image/lib/customrust --disable-debug --disable-valgrind --disable-helgrind --disable-valgrind-rpass --enable-debuginfo-tests --disable-llvm-assertions --disable-debug-assertions --disable-debug-jemalloc --disable-debuginfo\n   `\n\nSteps 2 and 3 as in the previous case.\n\nResult: libraries are installed in `/home/jauhien/w/image/lib/customrust/customrust`. Note the `customrust` being repeated twice. Reason: lines in installer removed by mentioned patch.\n# Changing libdir during installation is broken\n\nLibdir option for installer makes no sense as it is anyway broken.\n## Working installation using unchanged libdir\n1. Download rust binary tarball for your arch and unpack it.\n2. Install rust\n   \n   ```\n   ./install.sh --prefix=/home/jauhien/w/image-bin-working\n   ```\n3. Try if it works\n   \n   ```\n   jauhien@jauhien-VirtualBox rust-tmp % LD_LIBRARY_PATH=/home/jauhien/w/image-bin-working/lib ../image-bin-working/bin/rustc -V             \n   rustc 1.3.0 (9a92aaf19 2015-09-15)                                                                                         \n   jauhien@jauhien-VirtualBox rust-tmp % cat test.rs\n   fn main() {\n      println!(\"It works!\");\n   }\n   jauhien@jauhien-VirtualBox rust-tmp % LD_LIBRARY_PATH=/home/jauhien/w/image-bin-working/lib ../image-bin-working/bin/rustc -V\n   rustc 1.3.0 (9a92aaf19 2015-09-15)                                                                                   \n   jauhien@jauhien-VirtualBox rust-tmp % ./test\n   It works!\n   ```\n## Broken installation when libdir option is used\n1. As in previous case\n2. Install rust\n   \n   ```\n   ./install.sh --prefix=/home/jauhien/w/image-bin --libdir=/home/jauhien/w/image-bin/customrust\n   ```\n3. Try if it works\n   \n   ```\n   jauhien@jauhien-VirtualBox rust-tmp % LD_LIBRARY_PATH=/home/jauhien/w/image-bin/customrust ../image-bin/bin/rustc -V        \n   rustc 1.3.0 (9a92aaf19 2015-09-15)                                                                                \n   jauhien@jauhien-VirtualBox rust-tmp % LD_LIBRARY_PATH=/home/jauhien/w/image-bin/customrust ../image-bin/bin/rustc test.rs -o test\n   test.rs:1:1: 1:1 error: can't find crate for `std`                                                          \n   test.rs:1 fn main() {\n            ^\n   error: aborting due to previous error\n   \n   ```\n\nReason: relative [libdir path is captured by rust compiler during build and it is impossible to change it later](https://github.com/rust-lang/rust/blob/master/src/librustc/metadata/filesearch.rs#L272).\n", "closed_by": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/28627/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/28627/timeline", "performed_via_github_app": null, "state_reason": "completed"}