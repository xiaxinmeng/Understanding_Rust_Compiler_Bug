{"url": "https://api.github.com/repos/rust-lang/rust/issues/100632", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/100632/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/100632/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/100632/events", "html_url": "https://github.com/rust-lang/rust/issues/100632", "id": 1340451431, "node_id": "I_kwDOAAsO6M5P5apn", "number": 100632, "title": "armv7-unknown-linux-gnueabihf toolchain has wrong types for some ffi functions", "user": {"login": "mladedav", "id": 16705820, "node_id": "MDQ6VXNlcjE2NzA1ODIw", "avatar_url": "https://avatars.githubusercontent.com/u/16705820?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mladedav", "html_url": "https://github.com/mladedav", "followers_url": "https://api.github.com/users/mladedav/followers", "following_url": "https://api.github.com/users/mladedav/following{/other_user}", "gists_url": "https://api.github.com/users/mladedav/gists{/gist_id}", "starred_url": "https://api.github.com/users/mladedav/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mladedav/subscriptions", "organizations_url": "https://api.github.com/users/mladedav/orgs", "repos_url": "https://api.github.com/users/mladedav/repos", "events_url": "https://api.github.com/users/mladedav/events{/privacy}", "received_events_url": "https://api.github.com/users/mladedav/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2022-08-16T14:33:27Z", "updated_at": "2022-08-17T09:27:01Z", "closed_at": "2022-08-17T09:27:00Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried this code (I know it is not correct to pass a pointer obtained this way to the function, but the type should be correct):\r\n\r\n```rust\r\n    let buffer = Vec::<i8>::new().as_mut_ptr();\r\n    unsafe {\r\n        _ = CString::from_raw(buffer);\r\n    }\r\n```\r\n\r\nI expected it to compile. (this happens on `x86_64-pc-windows-msvc` and `x86_64-unknown-linux-gnu`)\r\n\r\nInstead, it does not compile on `armv7-unknown-linux-gnueabihf` with the following error:\r\n```\r\nerror[E0308]: mismatched types\r\n   --> src/main.rs:7:31\r\n    |\r\n7   |         _ = CString::from_raw(buffer);\r\n    |             ----------------- ^^^^^^ expected `u8`, found `i8`\r\n    |             |\r\n    |             arguments to this function are incorrect\r\n    |\r\n    = note: expected raw pointer `*mut u8`\r\n               found raw pointer `*mut i8`\r\nnote: associated function defined here\r\n   --> /rust/lib/rustlib/src/rust/library/alloc/src/ffi/c_str.rs:397:19\r\n    |\r\n397 |     pub unsafe fn from_raw(ptr: *mut c_char) -> CString {\r\n    |                   ^^^^^^^^\r\n```\r\n\r\nAccording to [documentation](https://docs.rs/rustc-std-workspace-std/1.0.1/std/ffi/struct.CString.html#method.from_raw) these functions should take `*mut i8`, but the docs are platform-specific. I haven't found docs for other platforms than x86_64 and i686 though.\r\n\r\nMy problem is with building a cross-platform library. From the docs I am under the impression that there is an issue with the armv7 compiler but if not, I would need to conditionally cast to the correct types based on the platform (where I don't even know which platforms expect which types without trying it out).\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.63.0 (4b91a6ea7 2022-08-08)\r\nbinary: rustc\r\ncommit-hash: 4b91a6ea7258a947e59c6522cd5898e7c0a6a88f\r\ncommit-date: 2022-08-08\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.63.0\r\nLLVM version: 14.0.5\r\n```\r\n\r\n", "closed_by": {"login": "mladedav", "id": 16705820, "node_id": "MDQ6VXNlcjE2NzA1ODIw", "avatar_url": "https://avatars.githubusercontent.com/u/16705820?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mladedav", "html_url": "https://github.com/mladedav", "followers_url": "https://api.github.com/users/mladedav/followers", "following_url": "https://api.github.com/users/mladedav/following{/other_user}", "gists_url": "https://api.github.com/users/mladedav/gists{/gist_id}", "starred_url": "https://api.github.com/users/mladedav/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mladedav/subscriptions", "organizations_url": "https://api.github.com/users/mladedav/orgs", "repos_url": "https://api.github.com/users/mladedav/repos", "events_url": "https://api.github.com/users/mladedav/events{/privacy}", "received_events_url": "https://api.github.com/users/mladedav/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/100632/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/100632/timeline", "performed_via_github_app": null, "state_reason": "completed"}