{"url": "https://api.github.com/repos/rust-lang/rust/issues/48927", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/48927/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/48927/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/48927/events", "html_url": "https://github.com/rust-lang/rust/issues/48927", "id": 304133598, "node_id": "MDU6SXNzdWUzMDQxMzM1OTg=", "number": 48927, "title": "A potential mpsc::channel bug", "user": {"login": "UncP", "id": 16263931, "node_id": "MDQ6VXNlcjE2MjYzOTMx", "avatar_url": "https://avatars.githubusercontent.com/u/16263931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/UncP", "html_url": "https://github.com/UncP", "followers_url": "https://api.github.com/users/UncP/followers", "following_url": "https://api.github.com/users/UncP/following{/other_user}", "gists_url": "https://api.github.com/users/UncP/gists{/gist_id}", "starred_url": "https://api.github.com/users/UncP/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/UncP/subscriptions", "organizations_url": "https://api.github.com/users/UncP/orgs", "repos_url": "https://api.github.com/users/UncP/repos", "events_url": "https://api.github.com/users/UncP/events{/privacy}", "received_events_url": "https://api.github.com/users/UncP/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2018-03-11T06:07:15Z", "updated_at": "2018-03-13T17:34:30Z", "closed_at": "2018-03-13T17:34:30Z", "author_association": "NONE", "active_lock_reason": null, "body": "`rustc 1.25.0-nightly (73ac5d6a8 2018-01-11)`\r\n\r\n```\r\nuse std::thread;\r\nuse std::sync::mpsc;\r\nuse std::time::Duration;\r\n\r\nfn main() {\r\n\tlet (tx, rx) = mpsc::channel::<u32>();\r\n\r\n\tlet r_handle = thread::spawn(move || {\r\n\t\tmatch rx.recv_timeout(Duration::from_secs(10)){\r\n\t\t\tErr(mpsc::RecvTimeoutError::Timeout) => {}\r\n\t\t\t_ => assert!(false),\r\n\t\t}\r\n                 // next line panics every time.\r\n\t\trx.recv_timeout(Duration::from_secs(10)).unwrap();\r\n\t});\r\n\r\n\tlet t_handle = thread::spawn(move || {\r\n\t\tthread::sleep(Duration::from_secs(2));\r\n\t\tlet _ = tx.clone();\r\n\t\tthread::sleep(Duration::from_secs(10));\r\n\t});\r\n\r\n\tr_handle.join().unwrap();\r\n\tt_handle.join().unwrap();\r\n}\r\n```\r\n\r\n1. `receiver` calls `recv_timeout`\r\n2. `sender` clone itself\r\n3. `recv_timeout` returns timeout\r\n4. `receiver` calls `recv_timeout` the second time\r\n5. boom!\r\n\r\n<img width=\"1096\" alt=\"2018-03-11 1 58 49\" src=\"https://user-images.githubusercontent.com/16263931/37250310-6a34ac62-2534-11e8-8798-04fc4bd0d410.png\">\r\n\r\nThis is what I know, when `sender` calls clone, it will call `inherit_blocker`, and then change `to_wake` in it. The first `recv_timeout` returns `timeout`, when the second `recv_timeout` is called, it will panic in `decrement` in `shared.rs` because it needs to check that `to_wake` equals 0.", "closed_by": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/48927/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/48927/timeline", "performed_via_github_app": null, "state_reason": "completed"}