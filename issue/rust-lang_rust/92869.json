{"url": "https://api.github.com/repos/rust-lang/rust/issues/92869", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/92869/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/92869/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/92869/events", "html_url": "https://github.com/rust-lang/rust/issues/92869", "id": 1102439426, "node_id": "I_kwDOAAsO6M5BteQC", "number": 92869, "title": "`lto = \"thin\"` causes `doctest` to generate invalid code on rust-1.57", "user": {"login": "trofi", "id": 226650, "node_id": "MDQ6VXNlcjIyNjY1MA==", "avatar_url": "https://avatars.githubusercontent.com/u/226650?v=4", "gravatar_id": "", "url": "https://api.github.com/users/trofi", "html_url": "https://github.com/trofi", "followers_url": "https://api.github.com/users/trofi/followers", "following_url": "https://api.github.com/users/trofi/following{/other_user}", "gists_url": "https://api.github.com/users/trofi/gists{/gist_id}", "starred_url": "https://api.github.com/users/trofi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/trofi/subscriptions", "organizations_url": "https://api.github.com/users/trofi/orgs", "repos_url": "https://api.github.com/users/trofi/repos", "events_url": "https://api.github.com/users/trofi/events{/privacy}", "received_events_url": "https://api.github.com/users/trofi/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 203429200, "node_id": "MDU6TGFiZWwyMDM0MjkyMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-high", "name": "P-high", "color": "eb6420", "default": false, "description": "High priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2459791492, "node_id": "MDU6TGFiZWwyNDU5NzkxNDky", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-lto", "name": "A-lto", "color": "f7e101", "default": false, "description": "Area: Link Time Optimization"}], "state": "closed", "locked": false, "assignee": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 15, "created_at": "2022-01-13T21:53:11Z", "updated_at": "2022-03-11T08:41:31Z", "closed_at": "2022-03-09T09:59:07Z", "author_association": "NONE", "active_lock_reason": null, "body": "It's a senf-contained example extracted from https://github.com/rayon-rs/rayon/issues/911 where doctest tests mysteriously crash `rav1e`. This is what crashes for me:\r\n\r\n```rust\r\n// cat src/lib.rs\r\nthread_local! {\r\n    static THREAD_LOCAL_GLOBAL: std::cell::Cell<usize> = std::cell::Cell::new(0);\r\n}\r\n\r\n#[inline(never)]\r\nfn set_state_func(t: &std::cell::Cell<usize>) {\r\n    t.set(42);\r\n}\r\n\r\n#[inline(never)]\r\nfn thread_func() {\r\n    THREAD_LOCAL_GLOBAL.with(set_state_func);\r\n}\r\n\r\n/// # Examples\r\n///\r\n/// ```\r\n/// use bug::do_bug;\r\n///\r\n/// # fn main() {\r\n/// bug::do_bug()\r\n/// # }\r\n/// ```\r\n#[inline(never)]\r\npub fn do_bug() {\r\n  // to ease catching the test with gdb\r\n  //std::thread::sleep(std::time::Duration::from_secs(10));\r\n\r\n  for _ in 0..128 {\r\n    std::thread::spawn(thread_func).join().unwrap();\r\n  }\r\n}\r\n```\r\n\r\nIt needs the following `Cargo.toml`:\r\n\r\n```toml\r\n# cat Cargo.toml\r\n[package]\r\nname = \"bug\"\r\nversion = \"0.1.0\"\r\nedition = \"2018\"\r\n\r\n[profile.dev]\r\ndebug = true\r\nincremental = true\r\nlto = \"thin\"\r\nopt-level = 2\r\ndebug-assertions = false\r\noverflow-checks = false\r\ncodegen-units = 256\r\n```\r\n\r\nRunning the test:\r\n\r\n```\r\n$ cargo test --doc --verbose\r\n   Compiling bug v0.1.0 (/home/slyfox/dev/git/rav1e)\r\n     Running `rustc --crate-name bug --edition=2018 src/lib.rs --error-format=json --json=diagnostic-rendered-ansi --crate-type lib --emit=dep-info,metadata,link -C opt-level=2 -C linker-plugin-lto -C codegen-units=256 -C debuginfo=2 -C metadata=08626d1130101a14 -C extra-filename=-08626d1130101a14 --out-dir /home/slyfox/dev/git/rav1e/target/debug/deps -C incremental=/home/slyfox/dev/git/rav1e/target/debug/incremental -L dependency=/home/slyfox/dev/git/rav1e/target/debug/deps`\r\n    Finished test [optimized + debuginfo] target(s) in 0.15s\r\n   Doc-tests bug\r\n     Running `rustdoc --edition=2018 --crate-type lib --crate-name bug --test /home/slyfox/dev/git/rav1e/src/lib.rs -L dependency=/home/slyfox/dev/git/rav1e/target/debug/deps -L dependency=/home/slyfox/dev/git/rav1e/target/debug/deps --extern bug=/home/slyfox/dev/git/rav1e/target/debug/deps/libbug-08626d1130101a14.rlib -C lto=thin --error-format human`\r\n\r\nrunning 1 test\r\ntest src/lib.rs - do_bug (line 17) ... FAILED\r\n\r\nfailures:\r\n\r\n---- src/lib.rs - do_bug (line 17) stdout ----\r\nTest executable failed (terminated by signal).\r\n\r\n\r\nfailures:\r\n    src/lib.rs - do_bug (line 17)\r\n\r\ntest result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.35s\r\n\r\nerror: test failed, to rerun pass '--doc'\r\n```\r\n\r\nI expected to see this happen: test should pass and not crash.\r\n\r\nInstead, this happened: test crashes mysteriously.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc --version --verbose\r\nrustc 1.57.0\r\nbinary: rustc\r\ncommit-hash: unknown\r\ncommit-date: unknown\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.57.0\r\nLLVM version: 13.0.0\r\n```\r\n\r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```\r\nThread 2 \"rust_out\" received signal SIGSEGV, Segmentation fault.\r\n[Switching to Thread 0x7ff5caf23640 (LWP 2280238)]\r\n0x0000000000000000 in ?? ()\r\n(gdb) bt\r\n#0  0x0000000000000000 in ?? ()\r\n#1  0x00007ff5caf235f8 in ?? ()\r\n#2  0x000000008498015f in ?? ()\r\n#3  0x0000559d328efdd6 in core::ops::function::FnOnce::call_once<fn(), ()> ()\r\n    at /build/rustc-1.57.0-src/library/core/src/ops/function.rs:227\r\n#4  std::sys_common::backtrace::__rust_begin_short_backtrace<fn(), ()> (f=<optimized out>)\r\n    at /build/rustc-1.57.0-src/library/std/src/sys_common/backtrace.rs:123\r\n#5  0x0000559d328efe40 in std::panicking::try::do_call<core::panic::unwind_safe::AssertUnwindSafe<std::thread::{impl#0}::spawn_unchecked::{closure#1}::{closure#0}>, ()> (data=<optimized out>) at /build/rustc-1.57.0-src/library/std/src/panicking.rs:403\r\n#6  std::panicking::try<(), core::panic::unwind_safe::AssertUnwindSafe<std::thread::{impl#0}::spawn_unchecked::{closure#1}::{closure#0}>> (f=...) at /build/rustc-1.57.0-src/library/std/src/panicking.rs:367\r\n#7  0x0000559d328efa11 in std::thread::{impl#0}::spawn_unchecked::{closure#1}<fn(), ()> ()\r\n    at /build/rustc-1.57.0-src/library/std/src/thread/mod.rs:482\r\n#8  core::ops::function::FnOnce::call_once<std::thread::{impl#0}::spawn_unchecked::{closure#1}, ()> ()\r\n    at /build/rustc-1.57.0-src/library/core/src/ops/function.rs:227\r\n#9  0x0000559d329603d5 in std::sys::unix::thread::Thread::new::thread_start ()\r\n#10 0x00007ff5cb0fbd40 in start_thread () from /nix/store/s9qbqh7gzacs7h68b2jfmn9l6q4jwfjz-glibc-2.33-59/lib/libpthread.so.0\r\n#11 0x00007ff5cb02343f in clone () from /nix/store/s9qbqh7gzacs7h68b2jfmn9l6q4jwfjz-glibc-2.33-59/lib/libc.so.6\r\n```\r\n</p>\r\n</details>\r\n", "closed_by": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/92869/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/92869/timeline", "performed_via_github_app": null, "state_reason": "completed"}