{"url": "https://api.github.com/repos/rust-lang/rust/issues/76874", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/76874/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/76874/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/76874/events", "html_url": "https://github.com/rust-lang/rust/issues/76874", "id": 704340337, "node_id": "MDU6SXNzdWU3MDQzNDAzMzc=", "number": 76874, "title": "proc_macro_attribute input has invalid span for various input.", "user": {"login": "thiolliere", "id": 10416848, "node_id": "MDQ6VXNlcjEwNDE2ODQ4", "avatar_url": "https://avatars.githubusercontent.com/u/10416848?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thiolliere", "html_url": "https://github.com/thiolliere", "followers_url": "https://api.github.com/users/thiolliere/followers", "following_url": "https://api.github.com/users/thiolliere/following{/other_user}", "gists_url": "https://api.github.com/users/thiolliere/gists{/gist_id}", "starred_url": "https://api.github.com/users/thiolliere/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thiolliere/subscriptions", "organizations_url": "https://api.github.com/users/thiolliere/orgs", "repos_url": "https://api.github.com/users/thiolliere/repos", "events_url": "https://api.github.com/users/thiolliere/events{/privacy}", "received_events_url": "https://api.github.com/users/thiolliere/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2079070889, "node_id": "MDU6TGFiZWwyMDc5MDcwODg5", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-proc-macros", "name": "A-proc-macros", "color": "f7e101", "default": false, "description": "Area: Procedural macros"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2020-09-18T12:28:57Z", "updated_at": "2021-02-05T10:45:49Z", "closed_at": "2021-02-05T10:45:48Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\n### Context:\r\n\r\ninput of proc_macro_attribute have invalid (null) span for some input.\r\nI test spans with this code:\r\n\r\n```rust\r\n#[proc_macro_attribute]\r\npub fn bar(_attr: proc_macro::TokenStream, item: proc_macro::TokenStream) -> proc_macro::TokenStream {\r\n\tfor tt in item.clone().into_iter() {\r\n\t\tprintln!(\"tt: {}: {:?}\", tt, tt.span());\r\n\t}\r\n\titem\r\n}\r\n```\r\n\r\n### Failing inputs:\r\n\r\n#### 1- inner doc (this is fixed by https://github.com/rust-lang/rust/pull/76130 )\r\n```rust\r\n#[ressai_proc::bar]\r\npub mod inner_doc {\r\n\t//! With this documentation line removed span are working.\r\n}\r\n```\r\nprints\r\n```\r\ntt: pub: #0 bytes(0..0)\r\ntt: mod: #0 bytes(0..0)\r\ntt: inner_doc: #0 bytes(0..0)\r\ntt: {\r\n    //! With this documentation line removed span are working.\r\n\r\n}: #0 bytes(0..0)\r\n```\r\n\r\nremoving the inner doc makes the token tree having non-null spans.\r\n\r\n#### ~~2- another path attribute (with two path segment)~~ (this one is now fixed in rustc 1.49.0-nightly (ffa2e7ae8 2020-10-24))\r\n\r\n```rust\r\n#[ressai_proc::bar]\r\n#[ressai_proc::bar]\r\npub mod another_attribute {\r\n}\r\n```\r\nprints\r\n```\r\ntt: #: #0 bytes(0..0)\r\ntt: [ressai_proc :: bar]: #0 bytes(0..0)\r\ntt: pub: #0 bytes(0..0)\r\ntt: mod: #0 bytes(0..0)\r\ntt: another_attribute: #0 bytes(0..0)\r\ntt: { }: #0 bytes(0..0)\r\ntt: pub: #0 bytes(0..0)\r\ntt: mod: #0 bytes(0..0)\r\ntt: another_attribute: #0 bytes(0..0)\r\ntt: { }: #0 bytes(0..0)\r\n```\r\n\r\nnote that this slightly modified input will give non-null spans:\r\n```rust\r\nuse ressai_proc::bar;\r\n#[ressai_proc::bar]\r\n#[bar]\r\npub mod another_attribute_but_successful {\r\n}\r\n```\r\n\r\n#### 3 - some method on associated type: (this is fixed by https://github.com/rust-lang/rust/pull/78980)\r\n\r\n```rust\r\n#[ressai_proc::bar]\r\nmod foo {\r\n\ttrait Config {\r\n\t\ttype Origin: From<u32>;\r\n\t}\r\n\r\n\tstruct A<T>(T);\r\n\r\n\timpl<T: Config> A<T> {\r\n\t\tfn foo() {\r\n\t\t\t<T as Config>::Origin::from(3);\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n\r\nThis will output:\r\n```\r\n   Compiling ressai-proc v0.1.0 (/home/thiolliere/Developpement/ressai-procedural/ressai-proc)\r\ntt: mod: #0 bytes(0..0)\r\ntt: foo: #0 bytes(0..0)\r\ntt: {\r\n    trait Config { type Origin : From < u32 > ; } struct A < T > (T) ; impl <\r\n    T : Config > A < T > { fn foo() { < T as Config > :: from(3) ; } }\r\n}: #0 bytes(0..0)\r\nerror[E0576]: cannot find method or associated constant `from` in trait `Config`\r\n```\r\nSo the rust error message is not pointing the failing code. All span are `0`.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`cargo rustc -- --version --verbose`:\r\n```\r\nrustc 1.49.0-nightly (ffa2e7ae8 2020-10-24)\r\nbinary: rustc\r\ncommit-hash: ffa2e7ae8fbf9badc035740db949b9dae271c29f\r\ncommit-date: 2020-10-24\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.49.0-nightly\r\nLLVM version: 11.0\r\n```\r\n\r\nEDIT: related https://github.com/rust-lang/rust/issues/43081", "closed_by": {"login": "thiolliere", "id": 10416848, "node_id": "MDQ6VXNlcjEwNDE2ODQ4", "avatar_url": "https://avatars.githubusercontent.com/u/10416848?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thiolliere", "html_url": "https://github.com/thiolliere", "followers_url": "https://api.github.com/users/thiolliere/followers", "following_url": "https://api.github.com/users/thiolliere/following{/other_user}", "gists_url": "https://api.github.com/users/thiolliere/gists{/gist_id}", "starred_url": "https://api.github.com/users/thiolliere/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thiolliere/subscriptions", "organizations_url": "https://api.github.com/users/thiolliere/orgs", "repos_url": "https://api.github.com/users/thiolliere/repos", "events_url": "https://api.github.com/users/thiolliere/events{/privacy}", "received_events_url": "https://api.github.com/users/thiolliere/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/76874/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/76874/timeline", "performed_via_github_app": null, "state_reason": "completed"}