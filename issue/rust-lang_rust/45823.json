{"url": "https://api.github.com/repos/rust-lang/rust/issues/45823", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/45823/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/45823/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/45823/events", "html_url": "https://github.com/rust-lang/rust/issues/45823", "id": 271744667, "node_id": "MDU6SXNzdWUyNzE3NDQ2Njc=", "number": 45823, "title": "missing 'retq` instruction in opt-level=2 codegen with a certain unsafe+transmute usage", "user": {"login": "da-x", "id": 321273, "node_id": "MDQ6VXNlcjMyMTI3Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/321273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/da-x", "html_url": "https://github.com/da-x", "followers_url": "https://api.github.com/users/da-x/followers", "following_url": "https://api.github.com/users/da-x/following{/other_user}", "gists_url": "https://api.github.com/users/da-x/gists{/gist_id}", "starred_url": "https://api.github.com/users/da-x/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/da-x/subscriptions", "organizations_url": "https://api.github.com/users/da-x/orgs", "repos_url": "https://api.github.com/users/da-x/repos", "events_url": "https://api.github.com/users/da-x/events{/privacy}", "received_events_url": "https://api.github.com/users/da-x/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-11-07T08:21:14Z", "updated_at": "2017-11-07T09:32:30Z", "closed_at": "2017-11-07T09:30:57Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "While converting null const pointers to static references seems to work in debug builds, under an optimization build there is some odd codegen taking place.\r\n\r\n(Yes, I know about `unsafe` casts and `std::ptr::null()`, but I am worried that this issue is indicative for an actual bug)\r\n\r\nConsider this program:\r\n\r\n```rust\r\nfn main()\r\n{\r\n    unsafe { ::std::mem::transmute::<_, &'static usize>(0 as *const usize) };\r\n}\r\n```\r\n\r\nCompile with:\r\n```sh\r\nrustc  test.rs --emit asm -C opt-level=2\r\n```\r\n\r\nThere supposed to be a `retq` instruction just before the first `.cfi_endproc`:\r\n\r\n```gasm\r\n        .text\r\n        .file   \"a.cgu-0.rs\"\r\n        .section        .text._ZN1a4main17h02c39649d43f7637E,\"ax\",@progbits\r\n        .p2align        4, 0x90\r\n        .type   _ZN1a4main17h02c39649d43f7637E,@function\r\n_ZN1a4main17h02c39649d43f7637E:\r\n        .cfi_startproc\r\n.Lfunc_end0:\r\n        .size   _ZN1a4main17h02c39649d43f7637E, .Lfunc_end0-_ZN1a4main17h02c39649d43f7637E\r\n        .cfi_endproc\r\n\r\n        .section        .text.main,\"ax\",@progbits\r\n        .globl  main\r\n        .p2align        4, 0x90\r\n        .type   main,@function\r\nmain:\r\n        .cfi_startproc\r\n        movq    %rsi, %rax\r\n        movq    %rdi, %rcx\r\n        leaq    _ZN1a4main17h02c39649d43f7637E(%rip), %rdi\r\n        movq    %rcx, %rsi\r\n        movq    %rax, %rdx\r\n        jmp     _ZN3std2rt10lang_start17hdcba96cc6d0f043dE@PLT\r\n.Lfunc_end1:\r\n        .size   main, .Lfunc_end1-main\r\n        .cfi_endproc\r\n\r\n        .section        \".note.GNU-stack\",\"\",@progbits\r\n```\r\n\r\nWith that `retq` missing, the execution of the actual main function `_ZN1a4main17h02c39649d43f7637E` (which was optimized to nothing in this case) overflows and the rust run-time is being initialized for the second time, tripping over a borrow, unsurprisingly:\r\n\r\n```\r\nthread 'main' panicked at 'assertion failed: c.borrow().is_none()', /checkout/src/libstd/sys_common/thread_info.rs:46:25\r\n```\r\n\r\nProblem reproduces with `stable` and `nightly`.\r\n\r\n", "closed_by": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/45823/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/45823/timeline", "performed_via_github_app": null, "state_reason": "completed"}