{"url": "https://api.github.com/repos/rust-lang/rust/issues/92512", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/92512/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/92512/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/92512/events", "html_url": "https://github.com/rust-lang/rust/issues/92512", "id": 1092354707, "node_id": "I_kwDOAAsO6M5BHAKT", "number": 92512, "title": "CTFE: there is no way to compute the difference between two ptrs in the same allocation if they might be out-of-bounds", "user": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 900795185, "node_id": "MDU6TGFiZWw5MDA3OTUxODU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-const-eval", "name": "A-const-eval", "color": "f7e101", "default": false, "description": "Area: constant evaluation (mir interpretation)"}, {"id": 2242906716, "node_id": "MDU6TGFiZWwyMjQyOTA2NzE2", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-raw-pointers", "name": "A-raw-pointers", "color": "f7e101", "default": false, "description": "Area: raw pointers, MaybeUninit, NonNull"}, {"id": 5226679137, "node_id": "LA_kwDOAAsO6M8AAAABN4jLYQ", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-opsem", "name": "T-opsem", "color": "bfd4f2", "default": false, "description": "Relevant to the opsem team"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 18, "created_at": "2022-01-03T09:31:53Z", "updated_at": "2023-04-26T04:00:56Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "[`offset_from`](https://doc.rust-lang.org/nightly/std/primitive.pointer.html#method.offset_from) is the only way to do pointer subtraction during CTFE (since casting pointers to integers is not possible). However, `offset_from` requires both pointers to be *in-bounds* of the same allocation, making it unsuited for code that handles possibly out-of-bounds pointers. The need for this arises, for example, in the typical way that array/slice iterators support ZSTs, see e.g. https://github.com/slightlyoutofphase/staticvec/issues/48.\r\n\r\nWe should provide some way for `const` code to subtract pointers to the same allocation even if they are not in-bounds. Example code:\r\n```rust\r\nconst C: isize = {\r\n    let start_ptr = &() as *const ();\r\n    let length = 10;\r\n    let end_ptr = (start_ptr as *const u8).wrapping_add(length) as *const ();\r\n    unsafe { (end_ptr as *const u8).offset_from(start_ptr as *const u8) }\r\n};\r\n```\r\nNote that this is currently accepted, but that is just because our `offset_from` implementation does not check for all UB (Cc https://github.com/rust-lang/miri/issues/1950). Once we fix the UB check, the above code would error.\r\n\r\nAlso see [this Zulip discussion](https://rust-lang.zulipchat.com/#narrow/stream/213817-t-lang/topic/offset_from.20in-bounds.20constraint.3F).\r\nCc @rust-lang/wg-const-eval ", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/92512/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/92512/timeline", "performed_via_github_app": null, "state_reason": null}