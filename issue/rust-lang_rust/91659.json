{"url": "https://api.github.com/repos/rust-lang/rust/issues/91659", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/91659/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/91659/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/91659/events", "html_url": "https://github.com/rust-lang/rust/issues/91659", "id": 1074293481, "node_id": "I_kwDOAAsO6M5ACGrp", "number": 91659, "title": "Check target definitions to see if more should have `cfg(target_thread_local)` enabled.", "user": {"login": "thomcc", "id": 860665, "node_id": "MDQ6VXNlcjg2MDY2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/860665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thomcc", "html_url": "https://github.com/thomcc", "followers_url": "https://api.github.com/users/thomcc/followers", "following_url": "https://api.github.com/users/thomcc/following{/other_user}", "gists_url": "https://api.github.com/users/thomcc/gists{/gist_id}", "starred_url": "https://api.github.com/users/thomcc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thomcc/subscriptions", "organizations_url": "https://api.github.com/users/thomcc/orgs", "repos_url": "https://api.github.com/users/thomcc/repos", "events_url": "https://api.github.com/users/thomcc/events{/privacy}", "received_events_url": "https://api.github.com/users/thomcc/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}, {"id": 38105576, "node_id": "MDU6TGFiZWwzODEwNTU3Ng==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-ios", "name": "O-ios", "color": "6e6ec0", "default": false, "description": "Operating system: iOS"}, {"id": 311417367, "node_id": "MDU6TGFiZWwzMTE0MTczNjc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-openbsd", "name": "O-openbsd", "color": "6e6ec0", "default": false, "description": "Operating system: OpenBSD"}, {"id": 311417404, "node_id": "MDU6TGFiZWwzMTE0MTc0MDQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-freebsd", "name": "O-freebsd", "color": "6e6ec0", "default": false, "description": "Operating system: FreeBSD"}, {"id": 311417590, "node_id": "MDU6TGFiZWwzMTE0MTc1OTA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-netbsd", "name": "O-netbsd", "color": "6e6ec0", "default": false, "description": "Operating system: NetBSD"}, {"id": 632886930, "node_id": "MDU6TGFiZWw2MzI4ODY5MzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-thread-locals", "name": "A-thread-locals", "color": "f7e101", "default": false, "description": "Area: Thread local storage (TLS)"}, {"id": 854301764, "node_id": "MDU6TGFiZWw4NTQzMDE3NjQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-dragonfly", "name": "O-dragonfly", "color": "6e6ec0", "default": false, "description": "Operating system: DragonFly BSD"}, {"id": 1472573111, "node_id": "MDU6TGFiZWwxNDcyNTczMTEx", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-thread_local", "name": "F-thread_local", "color": "f9c0cc", "default": false, "description": "`#![feature(thread_local)]`"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2021-12-08T11:13:23Z", "updated_at": "2023-03-02T07:17:04Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "Out of curiosity, I ran a script to print out the list of targets where `cfg(target_thread_local)` (indicating support for [`#[thread_local]`](https://github.com/rust-lang/rust/issues/29594)) is not true.\r\n\r\nThe results (and script) are available here: https://gist.github.com/thomcc/766d76e4da35ce1a73b93ccd548fd143\r\n\r\nThis looks somewhat wrong to me \u2014 I believe several of these should have support for static/linker thread local (or at least `__thread`/`__declspec(thread)` has worked there for me). Here are some items in that list which are... fairly suspicious to me.\r\n\r\n- All the x86_64 (and probably other arches) unix ELF targets, like the various BSDs.\r\n- i686-pc-windows-msvc, x86_64-pc-windows-gnu and i686-pc-windows-gnu\r\n- aarch64-apple-ios (probably), aarch64-apple-tvos (almost certainly)\r\n- ...\r\n\r\nPlaying around with[^1] `clang`, `gcc`, and `msvc` a bit indicates that (the ones I can easily test of these) should have it, and probably others. \r\n\r\n[^1]: I *think* the correct thing to compare against would be `_Thread_local`/`__thread`/`__declspec(thread)` rather than C++'s `thread_local` \u2014 these don't have ctor/dtor support, and thus map more directly to Rust's `#[thread_local]`. That said, I don't really see a difference in what I've checked.\r\n\r\nMy suspicion is:\r\n- Some of these are listed as not having thread locals by accident. It seems very easy to forget to change something like this when updating or adding a target\r\n- Some of these are listed as unsupported because technically we might support very old versions.\r\n\r\nIf the issue is about old versions, I guess a question would be what should the cfg do in situations where the support is version-dependent...\r\n\r\nThis sounds like a tricky thing to decide! Worth noting: support for TLS is what caused us to choose 10.7 as the minimum supported version for macOS: https://github.com/rust-lang/rust/issues/11927, but I guess back then[^2] we might not have had a `#[cfg(target_thread_local)]`?.\r\n\r\n[^2]: I don't feel doing that much spelunking, seems likely that given the numeric gap between the macOS issue and the `thread_local` issue, that things probably worked very differently!\r\n\r\nBut if nothing else, libstd probably has more concrete ideas about what it supports, and this causes it to be far more pessimistic in `std::thread_local!`.\r\n\r\nAnd more concretely: I'm pretty sure if I used `#[thread_local]` in a malloc, I'd be pretty annoyed if it couldn't support, say, FreeBSD, since I know that at least GCC/Clang support `__thread` on that target.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/91659/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/91659/timeline", "performed_via_github_app": null, "state_reason": null}