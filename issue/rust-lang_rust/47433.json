{"url": "https://api.github.com/repos/rust-lang/rust/issues/47433", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/47433/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/47433/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/47433/events", "html_url": "https://github.com/rust-lang/rust/issues/47433", "id": 288446458, "node_id": "MDU6SXNzdWUyODg0NDY0NTg=", "number": 47433, "title": "Internal compiler error when evaluating lifetime of Fn parameter", "user": {"login": "avranju", "id": 628128, "node_id": "MDQ6VXNlcjYyODEyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/628128?v=4", "gravatar_id": "", "url": "https://api.github.com/users/avranju", "html_url": "https://github.com/avranju", "followers_url": "https://api.github.com/users/avranju/followers", "following_url": "https://api.github.com/users/avranju/following{/other_user}", "gists_url": "https://api.github.com/users/avranju/gists{/gist_id}", "starred_url": "https://api.github.com/users/avranju/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/avranju/subscriptions", "organizations_url": "https://api.github.com/users/avranju/orgs", "repos_url": "https://api.github.com/users/avranju/repos", "events_url": "https://api.github.com/users/avranju/events{/privacy}", "received_events_url": "https://api.github.com/users/avranju/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-01-14T22:46:12Z", "updated_at": "2018-06-22T23:24:53Z", "closed_at": "2018-06-22T23:24:53Z", "author_association": "NONE", "active_lock_reason": null, "body": "Internal compiler error with `unexpected panic` when compiling this in stable rust. Works fine in nightly and beta though. Try in [playground](https://play.rust-lang.org/?gist=3be06dacb86386ee6d3b1c876e718d3f&version=stable).\r\n\r\n```rust\r\npub trait Handlers<T: Clone> {\r\n    fn handlers_mut(&mut self) -> &mut Vec<Box<Fn(T)>>;\r\n    fn handlers(&self) -> &Vec<Box<Fn(T)>>;\r\n}\r\n\r\npub trait EventEmitter<T: Clone> : Handlers<T> {\r\n  fn add_handler<F>(&mut self, handler: F) where F : Fn(T) {\r\n    self.handlers_mut().push(Box::new(handler));\r\n  }\r\n  \r\n  fn emit(&self, value: T) {\r\n    for h in self.handlers().iter() {\r\n        h(value.clone());\r\n    }\r\n  }\r\n}\r\n\r\nstruct NumSource {\r\n    handlers: Vec<Box<Fn(u16)>>,\r\n}\r\n\r\nimpl NumSource {\r\n    pub fn new() -> NumSource {\r\n        NumSource{ handlers: vec![] }\r\n    }\r\n}\r\n\r\nimpl Handlers<u16> for NumSource {\r\n    fn handlers_mut(&mut self) -> &mut Vec<Box<Fn(u16)>> {\r\n        &mut self.handlers\r\n    }\r\n    \r\n    fn handlers(&self) -> &Vec<Box<Fn(u16)>> {\r\n        &self.handlers\r\n    }\r\n}\r\n\r\nimpl EventEmitter<u16> for NumSource {}\r\n\r\nfn main() {\r\n    let mut src = NumSource::new();\r\n    src.add_handler(|v| println!(\"f1 - v = {}\", v));\r\n    src.add_handler(|v| println!(\"f2 - v = {}\", v));\r\n    src.emit(10);\r\n    src.emit(20);\r\n}\r\n```\r\nHere's the compiler error:\r\n\r\n```\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: rustc 1.23.0 (766bd11c8 2018-01-01) running on x86_64-unknown-linux-gnu\r\n```\r\n\r\nChanging\r\n\r\n```rust\r\n fn add_handler<F>(&mut self, handler: F) where F : Fn(T) {\r\n```\r\n\r\nto\r\n\r\n```rust\r\n  fn add_handler<F>(&mut self, handler: F) where F : Fn(T) + 'static {\r\n```\r\n\r\nfixes the problem.\r\n\r\n## Meta\r\nrustc 1.23.0 (766bd11c8 2018-01-01)\r\nbinary: rustc\r\ncommit-hash: 766bd11c8a3c019ca53febdcd77b2215379dd67d\r\ncommit-date: 2018-01-01\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.23.0\r\nLLVM version: 4.0\r\n\r\nBacktrace:\r\n\r\n```\r\nthread 'rustc' panicked at 'assertion failed: !(self.has_self && idx == 0)', /checkout/src/librustc/ty/mod.rs:796:16\r\nstack backtrace:\r\n   0:     0x7f51de9acd93 - std::sys::imp::backtrace::tracing::imp::unwind_backtrace::hd278582b7bf125b4\r\n                               at /checkout/src/libstd/sys/unix/backtrace/tracing/gcc_s.rs:49\r\n   1:     0x7f51de9a846c - std::sys_common::backtrace::_print::h585aeaf99da81bd9\r\n                               at /checkout/src/libstd/sys_common/backtrace.rs:68\r\n   2:     0x7f51de9ba2e1 - std::panicking::default_hook::{{closure}}::h2cf5ae2c765258ee\r\n                               at /checkout/src/libstd/sys_common/backtrace.rs:57\r\n                               at /checkout/src/libstd/panicking.rs:381\r\n   3:     0x7f51de9b9fee - std::panicking::default_hook::h4df9c6962fc8f370\r\n                               at /checkout/src/libstd/panicking.rs:391\r\n   4:     0x7f51de9ba7ea - std::panicking::rust_panic_with_hook::hec57cb9076b0053e\r\n                               at /checkout/src/libstd/panicking.rs:577\r\n   5:     0x7f51da6d0833 - std::panicking::begin_panic::h01dde83823c11ad0\r\n   6:     0x7f51da73bfd5 - rustc::ty::Generics::type_param::h4e337eb016824ed9\r\n   7:     0x7f51daba0c30 - rustc::infer::error_reporting::<impl rustc::infer::InferCtxt<'a, 'gcx, 'tcx>>::report_region_errors::hdaae4a85cfadeba9\r\n   8:     0x7f51dabc51a3 - rustc::infer::InferCtxt::resolve_regions_and_report_errors::h2489ea2ac57c357e\r\n   9:     0x7f51db1f47b7 - rustc_typeck::check::regionck::<impl rustc_typeck::check::FnCtxt<'a, 'gcx, 'tcx>>::regionck_fn::hc14e4293e3b679a8\r\n  10:     0x7f51db27e3ba - <std::thread::local::LocalKey<T>>::with::h01f73e03a15e8426\r\n  11:     0x7f51db2f667a - rustc::ty::context::GlobalCtxt::enter_local::h69d9e38a43681cbd\r\n  12:     0x7f51db20ae77 - _ZN12rustc_typeck5check16typeck_tables_of17hda1df5d1a781f516E.llvm.6CA2F5D0\r\n  13:     0x7f51da8a556f - rustc::ty::maps::<impl rustc::ty::maps::queries::typeck_tables_of<'tcx>>::compute_result::ha75df1fb9b8d3d18\r\n  14:     0x7f51daaf95f7 - _ZN5rustc9dep_graph5graph8DepGraph14with_task_impl17hfeaf2a9e09dd54d2E.llvm.F50A461C\r\n  15:     0x7f51da74e12d - rustc_errors::Handler::track_diagnostics::h164606659a2ac147\r\n  16:     0x7f51dac99c8d - rustc::ty::maps::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::cycle_check::h62e23c272a55a3c9\r\n  17:     0x7f51da8a5605 - rustc::ty::maps::<impl rustc::ty::maps::queries::typeck_tables_of<'tcx>>::force::hd19c6c4a34fec988\r\n  18:     0x7f51da8a5d74 - rustc::ty::maps::<impl rustc::ty::maps::queries::typeck_tables_of<'tcx>>::try_get::h68926bb8acb77cbb\r\n  19:     0x7f51daa59caf - rustc::ty::maps::TyCtxtAt::typeck_tables_of::h7b9335e88bc1b0ba\r\n  20:     0x7f51da8a54e5 - rustc::ty::maps::<impl rustc::ty::maps::queries::typeck_tables_of<'tcx>>::ensure::h439a01508b470686\r\n  21:     0x7f51db296e75 - rustc::session::Session::track_errors::h4dcf1131057a0881\r\n  22:     0x7f51db20a73a - _ZN12rustc_typeck5check18typeck_item_bodies17hab9b46dbfd42ae52E.llvm.6CA2F5D0\r\n  23:     0x7f51da8a42ef - rustc::ty::maps::<impl rustc::ty::maps::queries::typeck_item_bodies<'tcx>>::compute_result::h1dbc736fd065c6cf\r\n  24:     0x7f51daaec35b - _ZN5rustc9dep_graph5graph8DepGraph14with_task_impl17hc108b7b2e4ed98c4E.llvm.F50A461C\r\n  25:     0x7f51da76ec1f - rustc_errors::Handler::track_diagnostics::hc2b6cdaae0cd4c7a\r\n  26:     0x7f51dac9fc8d - rustc::ty::maps::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::cycle_check::h7c1717b072245c43\r\n  27:     0x7f51da8a4379 - rustc::ty::maps::<impl rustc::ty::maps::queries::typeck_item_bodies<'tcx>>::force::h8f71571c8a351326\r\n  28:     0x7f51da8a4991 - rustc::ty::maps::<impl rustc::ty::maps::queries::typeck_item_bodies<'tcx>>::try_get::h465200f11ebb0a04\r\n  29:     0x7f51daa59bbd - rustc::ty::maps::TyCtxtAt::typeck_item_bodies::hf490bb31c6267e76\r\n  30:     0x7f51dace0673 - rustc::ty::maps::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'lcx>>::typeck_item_bodies::hee5e0ed807fbd890\r\n  31:     0x7f51db2b46f5 - rustc::util::common::time::h3d96e1b50037fb39\r\n  32:     0x7f51db2e87bb - rustc_typeck::check_crate::hc40e9fd329108497\r\n  33:     0x7f51dedf37e8 - <std::thread::local::LocalKey<T>>::with::hab712da7b05f1721\r\n  34:     0x7f51dedf2d2c - <std::thread::local::LocalKey<T>>::with::h860f3147313caedd\r\n  35:     0x7f51ded3ea0e - rustc::ty::context::TyCtxt::create_and_enter::h1e9eab2229a6f71b\r\n  36:     0x7f51ded86d31 - rustc_driver::driver::compile_input::h3ac66d54d480a26d\r\n  37:     0x7f51dede294a - rustc_driver::run_compiler::h189ce0baff261139\r\n  38:     0x7f51ded62a02 - _ZN3std10sys_common9backtrace28__rust_begin_short_backtrace17h832a69c7866f656aE.llvm.E45E81C6\r\n  39:     0x7f51de9c59de - __rust_maybe_catch_panic\r\n                               at /checkout/src/libpanic_unwind/lib.rs:101\r\n  40:     0x7f51dedd38c2 - _ZN50_$LT$F$u20$as$u20$alloc..boxed..FnBox$LT$A$GT$$GT$8call_box17h89fc984700f7576bE.llvm.5C5B5F27\r\n  41:     0x7f51de9b916b - std::sys::imp::thread::Thread::new::thread_start::h379d0fc65e150416\r\n                               at /checkout/src/liballoc/boxed.rs:772\r\n                               at /checkout/src/libstd/sys_common/thread.rs:24\r\n                               at /checkout/src/libstd/sys/unix/thread.rs:90\r\n  42:     0x7f51d88d37fb - start_thread\r\n  43:     0x7f51de675b0e - clone\r\n  44:                0x0 - <unknown>\r\n```", "closed_by": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/47433/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/47433/timeline", "performed_via_github_app": null, "state_reason": "completed"}