{"url": "https://api.github.com/repos/rust-lang/rust/issues/41908", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/41908/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/41908/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/41908/events", "html_url": "https://github.com/rust-lang/rust/issues/41908", "id": 227957979, "node_id": "MDU6SXNzdWUyMjc5NTc5Nzk=", "number": 41908, "title": "f64::hypot is very slow", "user": {"login": "leonardo-m", "id": 22328461, "node_id": "MDQ6VXNlcjIyMzI4NDYx", "avatar_url": "https://avatars.githubusercontent.com/u/22328461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/leonardo-m", "html_url": "https://github.com/leonardo-m", "followers_url": "https://api.github.com/users/leonardo-m/followers", "following_url": "https://api.github.com/users/leonardo-m/following{/other_user}", "gists_url": "https://api.github.com/users/leonardo-m/gists{/gist_id}", "starred_url": "https://api.github.com/users/leonardo-m/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/leonardo-m/subscriptions", "organizations_url": "https://api.github.com/users/leonardo-m/orgs", "repos_url": "https://api.github.com/users/leonardo-m/repos", "events_url": "https://api.github.com/users/leonardo-m/events{/privacy}", "received_events_url": "https://api.github.com/users/leonardo-m/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-05-11T11:18:17Z", "updated_at": "2017-05-11T11:51:11Z", "closed_at": "2017-05-11T11:51:11Z", "author_association": "NONE", "active_lock_reason": null, "body": "A little program:\r\n\r\n```\r\n#[inline(never)]\r\npub fn foo1(a: f64, b: f64, c: f64, d: f64) -> f64 {\r\n    (a - b).hypot(c - d)\r\n}\r\n\r\n#[inline(never)]\r\npub fn foo2(a: f64, b: f64, c: f64, d: f64) -> f64 {\r\n    ((a - b).powi(2) + (c - d).powi(2)).sqrt()\r\n}\r\n\r\nfn main() {\r\n    println!(\"{}\", foo1(0.5, 1.5, 2.5, 3.5));\r\n    println!(\"{}\", foo1(1.5, 2.5, 3.5, 4.5));\r\n    println!(\"{}\", foo2(0.5, 1.5, 2.5, 3.5));\r\n    println!(\"{}\", foo2(1.5, 2.5, 3.5, 4.5));\r\n}\r\n\r\n```\r\n\r\nCompiled with `-O` this is the asm of the two versions, in foo1 the hypot is not inlined and this is a problem:\r\n\r\n```\r\n_ZN4test4foo117h5fd993c5d2fb81ceE:\r\n    subsd   %xmm1, %xmm0\r\n    subsd   %xmm3, %xmm2\r\n    movapd  %xmm2, %xmm1\r\n    jmp hypot\r\n\r\n_ZN4test4foo217h53da9c06b79737d1E:\r\n    subsd   %xmm1, %xmm0\r\n    mulsd   %xmm0, %xmm0\r\n    subsd   %xmm3, %xmm2\r\n    mulsd   %xmm2, %xmm2\r\n    addsd   %xmm0, %xmm2\r\n    xorps   %xmm0, %xmm0\r\n    sqrtsd  %xmm2, %xmm0\r\n    retq\r\n```\r\n\r\nCompiling in a more aggressive way (`-C opt-level=3 -C target-cpu=native`) the situation is about the same:\r\n\r\n```\r\n_ZN4test4foo117h5fd993c5d2fb81ceE:\r\n    vsubsd  %xmm1, %xmm0, %xmm0\r\n    vsubsd  %xmm3, %xmm2, %xmm1\r\n    jmp hypot\r\n\r\n_ZN4test4foo217h53da9c06b79737d1E:\r\n    vsubsd  %xmm1, %xmm0, %xmm0\r\n    vmulsd  %xmm0, %xmm0, %xmm0\r\n    vsubsd  %xmm3, %xmm2, %xmm1\r\n    vmulsd  %xmm1, %xmm1, %xmm1\r\n    vaddsd  %xmm1, %xmm0, %xmm0\r\n    vsqrtsd %xmm0, %xmm0, %xmm0\r\n    retq\r\n```\r\n\r\n\r\nThis has signficant practical consequences. Code adapted from:\r\nhttps://users.rust-lang.org/t/rust-optimisation/10738/6\r\n\r\n```\r\nfn main() {\r\n    use std::collections::HashMap;\r\n\r\n    let mut universities: HashMap<&str, (f64, f64)> = HashMap::new();\r\n    universities.insert(\"A\", (56.18, 15.59));\r\n    universities.insert(\"B\", (59.85, 17.63));\r\n    universities.insert(\"C\", (55.71, 13.20));\r\n    universities.insert(\"D\", (59.34, 18.07));\r\n    universities.insert(\"E\", (57.68, 11.97));\r\n    universities.insert(\"F\", (65.61, 22.14));\r\n    universities.insert(\"G\", (63.82, 20.30));\r\n    universities.insert(\"H\", (58.39, 15.57));\r\n    universities.insert(\"I\", (59.40, 13.58));\r\n    universities.insert(\"J\", (59.25, 15.24));\r\n\r\n    let mut cities: Vec<&str> = universities\r\n                                .iter()\r\n                                .map(|(name, _)| name)\r\n                                .cloned()\r\n                                .collect();\r\n\r\n    let n = cities.len();\r\n\r\n    let mut shortest_trip = std::f64::INFINITY;\r\n    let mut shortest_trip_universities = vec![];\r\n\r\n    let mut p = vec![n; n + 1];\r\n    let mut i = 0;\r\n\r\n    while i < n {\r\n        p[i] -= 1;\r\n        let j = i % 2 * p[i];\r\n        cities.swap(i, j);\r\n\r\n        let mut trip_length = 0.0;\r\n\r\n        for pair in cities.windows(2) {\r\n            let (lat0, long0) = universities[pair[0]];\r\n            let (lat1, long1) = universities[pair[1]];\r\n\r\n            trip_length += ((lat1 - lat0).powi(2) + (long1 - long0).powi(2)).sqrt();\r\n            //trip_length += (lat1 - lat0).hypot(long1 - long0);\r\n        }\r\n\r\n        if trip_length < shortest_trip {\r\n            shortest_trip = trip_length;\r\n            shortest_trip_universities = cities.to_vec();\r\n        }\r\n\r\n        i = 1;\r\n        while p[i] == 0 {\r\n            p[i] = i;\r\n            i += 1;\r\n        }\r\n    }\r\n\r\n    println!(\"Shortest trip length: {}\", shortest_trip);\r\n    println!(\"{}\", shortest_trip_universities.join(\" --> \"));\r\n}\r\n\r\n```\r\n\r\nCompiling with:\r\n`rustc -C opt-level=3 -C target-cpu=native test.rs`\r\n\r\nThe output should be:\r\n\r\n```\r\nShortest trip length: 20.401442541154484\r\nF --> G --> B --> D --> H --> J --> I --> E --> C --> A\r\n```\r\n\r\nWith `hypot` the run-time is 2.19 seconds, with `(().powi(2)+().powi(2)).sqrt()` the run-time is about 1.80 seconds.", "closed_by": {"login": "leonardo-m", "id": 22328461, "node_id": "MDQ6VXNlcjIyMzI4NDYx", "avatar_url": "https://avatars.githubusercontent.com/u/22328461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/leonardo-m", "html_url": "https://github.com/leonardo-m", "followers_url": "https://api.github.com/users/leonardo-m/followers", "following_url": "https://api.github.com/users/leonardo-m/following{/other_user}", "gists_url": "https://api.github.com/users/leonardo-m/gists{/gist_id}", "starred_url": "https://api.github.com/users/leonardo-m/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/leonardo-m/subscriptions", "organizations_url": "https://api.github.com/users/leonardo-m/orgs", "repos_url": "https://api.github.com/users/leonardo-m/repos", "events_url": "https://api.github.com/users/leonardo-m/events{/privacy}", "received_events_url": "https://api.github.com/users/leonardo-m/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/41908/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/41908/timeline", "performed_via_github_app": null, "state_reason": "completed"}