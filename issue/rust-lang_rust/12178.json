{"url": "https://api.github.com/repos/rust-lang/rust/issues/12178", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/12178/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/12178/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/12178/events", "html_url": "https://github.com/rust-lang/rust/issues/12178", "id": 27329781, "node_id": "MDU6SXNzdWUyNzMyOTc4MQ==", "number": 12178, "title": "Syntax crates are broken on OSX Homebrew builds", "user": {"login": "sfackler", "id": 1455697, "node_id": "MDQ6VXNlcjE0NTU2OTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1455697?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sfackler", "html_url": "https://github.com/sfackler", "followers_url": "https://api.github.com/users/sfackler/followers", "following_url": "https://api.github.com/users/sfackler/following{/other_user}", "gists_url": "https://api.github.com/users/sfackler/gists{/gist_id}", "starred_url": "https://api.github.com/users/sfackler/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sfackler/subscriptions", "organizations_url": "https://api.github.com/users/sfackler/orgs", "repos_url": "https://api.github.com/users/sfackler/repos", "events_url": "https://api.github.com/users/sfackler/events{/privacy}", "received_events_url": "https://api.github.com/users/sfackler/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 100522, "node_id": "MDU6TGFiZWwxMDA1MjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-crash", "name": "I-crash", "color": "e10c02", "default": false, "description": "Issue: The compiler crashes (SIGSEGV, SIGABRT, etc). Use I-ICE instead when the compiler panics."}, {"id": 235146, "node_id": "MDU6TGFiZWwyMzUxNDY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-syntaxext", "name": "A-syntaxext", "color": "f7e101", "default": false, "description": "Area: Syntax extensions"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 13, "created_at": "2014-02-11T07:35:22Z", "updated_at": "2014-03-13T05:02:50Z", "closed_at": "2014-03-13T05:02:50Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "A minimal-ish example:\n\n``` rust\n#[feature(macro_registrar)];\n#[crate_id = \"procmacro\"];\n#[crate_type = \"rlib\"];\n#[crate_type = \"dylib\"];\n\nextern mod syntax;\n\nuse syntax::ast;\nuse syntax::ast::Name;\nuse syntax::codemap::{Span};\nuse syntax::ext::base;\nuse syntax::ext::base::{SyntaxExtension, BasicMacroExpander, NormalTT, ExtCtxt};\nuse syntax::parse::token;\n\n#[macro_registrar]\npub fn macro_registrar(register: |Name, SyntaxExtension|) {\n    register(token::intern(\"mymac\"),\n    NormalTT(~BasicMacroExpander {\n        expander: expand_syntax_ext,\n        span: None,\n    },\n    None));\n}\n\npub fn expand_syntax_ext(_: &mut ExtCtxt,\n                        sp: Span,\n                        _: &[ast::TokenTree]) -> base::MacResult {\n  println!(\"{:?}\", sp);\n  base::MacResult::dummy_expr()\n}\n```\n\n``` rust\n#[feature(phase)];\n\n#[phase(syntax)]\nextern mod procmacro;\n\nfn main() {\n  mymac!(1 + 1);\n}\n```\n\n```\ntry.rs:10:3: 10:8 error: macro undefined: 'mymac'\ntry.rs:10   mymac!(1 + 1);\n            ^~~~~\nerror: aborting due to previous error\nfish: Job 1, 'rustc try.rs -L .' terminated by signal SIGSEGV (Address boundary error)\n```\n\nBacktrace:\n\n```\nthread #2: tid = 0x1a5ec3, 0x00000001000a2243 libstd-966edb7e-0.10-pre.dylib`rt::task::__extensions__::run::anon::anon::expr_fn::aq + 211, stop reason = EXC_BAD_ACCESS (code=1, address=0x10e762470)\n    frame #0: 0x00000001000a2243 libstd-966edb7e-0.10-pre.dylib`rt::task::__extensions__::run::anon::anon::expr_fn::aq + 211\n    frame #1: 0x0000000103402620\n    frame #2: 0x00000001000a215f libstd-966edb7e-0.10-pre.dylib`rt::task::__extensions__::run::anon::expr_fn::ap + 79\n    frame #3: 0x00000001000a987c libstd-966edb7e-0.10-pre.dylib`rust_try + 12\n    frame #4: 0x00000001000a20b1 libstd-966edb7e-0.10-pre.dylib`rt::task::Task::run::hdd180d0b0d7e46390gam::v0.10.pre + 81\n    frame #5: 0x00000001005b9b5e libgreen-80d9e76a-0.10-pre.dylib`task::__extensions__::build_start_wrapper::anon::expr_fn::aP + 302\n```\n\nThere are a couple of things that are weird here:\n- `mymac` isn't being registered properly. Maybe it's using a different interner than the rest of rustc?\n- The segfault is happening way outside of the expansion infrastructure. One possibility is that it's trying to call into the external crate somehow, but that's already been unloaded. Maybe the @-box annihilator?\n- This has cropped up in a couple of places, all on OSX, and all via rust installs built by Homebrew. Manually building and installing seems to fix the issue. The only nonstandard thing the Homebrew build does is symlinking all of the libraries and executables in place.\n", "closed_by": {"login": "sfackler", "id": 1455697, "node_id": "MDQ6VXNlcjE0NTU2OTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1455697?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sfackler", "html_url": "https://github.com/sfackler", "followers_url": "https://api.github.com/users/sfackler/followers", "following_url": "https://api.github.com/users/sfackler/following{/other_user}", "gists_url": "https://api.github.com/users/sfackler/gists{/gist_id}", "starred_url": "https://api.github.com/users/sfackler/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sfackler/subscriptions", "organizations_url": "https://api.github.com/users/sfackler/orgs", "repos_url": "https://api.github.com/users/sfackler/repos", "events_url": "https://api.github.com/users/sfackler/events{/privacy}", "received_events_url": "https://api.github.com/users/sfackler/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/12178/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/12178/timeline", "performed_via_github_app": null, "state_reason": "completed"}