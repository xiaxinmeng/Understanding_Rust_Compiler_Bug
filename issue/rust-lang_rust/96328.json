{"url": "https://api.github.com/repos/rust-lang/rust/issues/96328", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/96328/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/96328/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/96328/events", "html_url": "https://github.com/rust-lang/rust/issues/96328", "id": 1213055908, "node_id": "I_kwDOAAsO6M5ITcOk", "number": 96328, "title": "NetBSD error linking against C library with link dependency", "user": {"login": "tmfink", "id": 5265592, "node_id": "MDQ6VXNlcjUyNjU1OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/5265592?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmfink", "html_url": "https://github.com/tmfink", "followers_url": "https://api.github.com/users/tmfink/followers", "following_url": "https://api.github.com/users/tmfink/following{/other_user}", "gists_url": "https://api.github.com/users/tmfink/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmfink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmfink/subscriptions", "organizations_url": "https://api.github.com/users/tmfink/orgs", "repos_url": "https://api.github.com/users/tmfink/repos", "events_url": "https://api.github.com/users/tmfink/events{/privacy}", "received_events_url": "https://api.github.com/users/tmfink/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2022-04-23T01:24:59Z", "updated_at": "2022-04-25T07:47:52Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I tried this code:\r\n\r\nRepo: https://github.com/tmfink/rust-link-issue\r\n\r\n`build.rs`:\r\n```rust\r\nfn main() {\r\n    println!(\"cargo:rustc-link-lib=z\");\r\n\r\n    let mut builder = cc::Build::new();\r\n    builder.file(\"foo.c\");\r\n    builder.compile(\"foo\");\r\n}\r\n```\r\n\r\n`src/main.rs`:\r\n```rust\r\n#![allow(unused_imports, dead_code)]\r\n\r\nuse std::os::raw::{c_char, c_int};\r\n\r\nextern \"C\" {\r\n    fn foo() -> usize;\r\n\r\n    fn zlibVersion() -> *const c_char;\r\n}\r\n\r\nfn main() {\r\n    unsafe {\r\n        println!(\"{:x}\", foo());\r\n    }\r\n\r\n    // Uncomment to workaround link issue\r\n    //println!(\"zlibVersion() = {:?}\", zlibVersion as *const u8);\r\n}\r\n```\r\n\r\n`foo.c`:\r\n```c\r\n#include <stddef.h>\r\n#include <zlib.h>\r\n\r\nsize_t foo() {\r\n    return (size_t) zlibVersion();\r\n}\r\n```\r\n\r\nI expected this to compile, but got a link error:.\r\n```\r\n$ cargo run\r\n   Compiling simple-link-test v0.1.0 (/tmp/simple-link)\r\nerror: linking with `cc` failed: exit status: 1\r\n  |\r\n  = note: \"cc\" \"-m64\" \"/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.19mun35o71dlrdyq.rcgu.o\" \"/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.1vhj6pe24ldw4n7s.rcgu.o\" \"/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.2nf1opqsnl2ilj43.rcgu.o\" \"/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.3ab3dkn977m6fjp9.rcgu.o\" \"/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.3ocp4b4cpsu29h9o.rcgu.o\" \"/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.427yxpxcwm3nubkp.rcgu.o\" \"/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.4d8kozeslihxvrhw.rcgu.o\" \"/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.51jbqo2gpt5s1yac.rcgu.o\" \"/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.cml30bca6em8mat.rcgu.o\" \"/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.15yztrz1tks35lmt.rcgu.o\" \"-Wl,--as-needed\" \"-L\" \"/tmp/simple-link/target/debug/deps\" \"-L\" \"/tmp/simple-link/target/debug/build/simple-link-test-7198944c1ce9a580/out\" \"-L\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib\" \"-lz\" \"-Wl,-Bstatic\" \"-Wl,--whole-archive\" \"-lfoo\" \"-Wl,--no-whole-archive\" \"-Wl,--start-group\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libstd-88860e2f4119f93f.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libpanic_unwind-990d204efb11a33f.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libminiz_oxide-cdfa5bc4905a97ab.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libadler-4c05554bc3c92490.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libobject-3067f51de7d10974.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libmemchr-ed5ee6ee56f88db6.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libaddr2line-2d5849326f3bbcd0.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libgimli-4868503f350e774c.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/librustc_demangle-7afca5d45a1b8bad.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libstd_detect-1e6f1275d7fa7721.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libhashbrown-40532dff13a43508.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/librustc_std_workspace_alloc-09b9a8d2a247ae60.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libunwind-714b2e0912c21213.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libcfg_if-a59f2f2f9c828895.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/liblibc-851bb90d894793e4.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/liballoc-0aefc5e9fefbf214.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/librustc_std_workspace_core-0a7f08ac42a2e82d.rlib\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libcore-d76f5c5df0fb96f9.rlib\" \"-Wl,--end-group\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libcompiler_builtins-a67bc12173dadc5f.rlib\" \"-Wl,-Bdynamic\" \"-lpthread\" \"-lrt\" \"-lgcc_s\" \"-lc\" \"-lm\" \"-lrt\" \"-lpthread\" \"-lutil\" \"-lrt\" \"-lutil\" \"-Wl,--eh-frame-hdr\" \"-Wl,-znoexecstack\" \"-L\" \"/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib\" \"-o\" \"/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0\" \"-Wl,--gc-sections\" \"-pie\" \"-Wl,-zrelro,-znow\"\r\n  = note: ld: /tmp/simple-link/target/debug/build/simple-link-test-7198944c1ce9a580/out/libfoo.a(foo.o): in function `foo':\r\n          /tmp/simple-link/foo.c:5: undefined reference to `zlibVersion'\r\n          \r\n  = help: some `extern` functions couldn't be found; some native libraries may need to be installed or have their path specified\r\n  = note: use the `-l` flag to specify native libraries to link\r\n  = note: use the `cargo:rustc-link-lib` directive to specify the native libraries to link with Cargo (see https://doc.rust-lang.org/cargo/reference/build-scripts.html#cargorustc-link-libkindname)\r\n\r\nerror: could not compile `simple-link-test` due to previous error\r\n```\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.60.0 (7737e0b5c 2022-04-04)\r\nbinary: rustc\r\ncommit-hash: 7737e0b5c4103216d6fd8cf941b7ab9bdbaace7c\r\ncommit-date: 2022-04-04\r\nhost: x86_64-unknown-netbsd\r\nrelease: 1.60.0\r\nLLVM version: 14.0.0\r\n```\r\n\r\n```\r\n$ cc -v\r\nUsing built-in specs.\r\nCOLLECT_GCC=cc\r\nCOLLECT_LTO_WRAPPER=/usr/libexec/lto-wrapper\r\nTarget: x86_64--netbsd\r\nConfigured with: /usr/src/tools/gcc/../../external/gpl3/gcc/dist/configure --target=x86_64--netbsd --enable-long-long --enable-threads --with-bugurl=http://www.NetBSD.org/Misc/send-pr.html --with-pkgversion='NetBSD nb4 20200810' --with-system-zlib --without-isl --enable-__cxa_atexit --enable-libstdcxx-time=rt --enable-libstdcxx-threads --with-diagnostics-color=auto-if-env --with-tune=nocona --with-default-libstdcxx-abi=new --with-mpc-lib=/var/obj/mknative/amd64-x86_64/usr/src/external/lgpl3/mpc/lib/libmpc --with-mpfr-lib=/var/obj/mknative/amd64-x86_64/usr/src/external/lgpl3/mpfr/lib/libmpfr --with-gmp-lib=/var/obj/mknative/amd64-x86_64/usr/src/external/lgpl3/gmp/lib/libgmp --with-mpc-include=/usr/src/external/lgpl3/mpc/dist/src --with-mpfr-include=/usr/src/external/lgpl3/mpfr/dist/src --with-gmp-include=/usr/src/external/lgpl3/gmp/lib/libgmp/arch/x86_64 --enable-tls --disable-multilib --disable-libstdcxx-pch --build=x86_64--netbsd --host=x86_64--netbsd --with-sysroot=/var/obj/mknative/amd64-x86_64/usr/src/destdir.amd64\r\nThread model: posix\r\ngcc version 7.5.0 (nb4 20200810) \r\n\r\n$ ld -v\r\nGNU ld (NetBSD Binutils nb1) 2.31.1\r\n```\r\n\r\n### Root Cause\r\n\r\nThe issue is caused by the link arg `-lz` **not** appearing at the end.\r\n\r\n```\r\n$ cargo run |& grep 'note:.*cc' | sed 's/= note://' | xargs -n1\r\ncc\r\n-m64\r\n/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.19mun35o71dlrdyq.rcgu.o\r\n/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.1vhj6pe24ldw4n7s.rcgu.o\r\n/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.2nf1opqsnl2ilj43.rcgu.o\r\n/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.3ab3dkn977m6fjp9.rcgu.o\r\n/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.3ocp4b4cpsu29h9o.rcgu.o\r\n/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.427yxpxcwm3nubkp.rcgu.o\r\n/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.4d8kozeslihxvrhw.rcgu.o\r\n/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.51jbqo2gpt5s1yac.rcgu.o\r\n/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.cml30bca6em8mat.rcgu.o\r\n/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0.15yztrz1tks35lmt.rcgu.o\r\n-Wl,--as-needed\r\n-L\r\n/tmp/simple-link/target/debug/deps\r\n-L\r\n/tmp/simple-link/target/debug/build/simple-link-test-7198944c1ce9a580/out\r\n-L\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib\r\n-lz\r\n-Wl,-Bstatic\r\n-Wl,--whole-archive\r\n-lfoo\r\n-Wl,--no-whole-archive\r\n-Wl,--start-group\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libstd-88860e2f4119f93f.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libpanic_unwind-990d204efb11a33f.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libminiz_oxide-cdfa5bc4905a97ab.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libadler-4c05554bc3c92490.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libobject-3067f51de7d10974.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libmemchr-ed5ee6ee56f88db6.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libaddr2line-2d5849326f3bbcd0.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libgimli-4868503f350e774c.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/librustc_demangle-7afca5d45a1b8bad.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libstd_detect-1e6f1275d7fa7721.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libhashbrown-40532dff13a43508.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/librustc_std_workspace_alloc-09b9a8d2a247ae60.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libunwind-714b2e0912c21213.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libcfg_if-a59f2f2f9c828895.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/liblibc-851bb90d894793e4.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/liballoc-0aefc5e9fefbf214.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/librustc_std_workspace_core-0a7f08ac42a2e82d.rlib\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libcore-d76f5c5df0fb96f9.rlib\r\n-Wl,--end-group\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib/libcompiler_builtins-a67bc12173dadc5f.rlib\r\n-Wl,-Bdynamic\r\n-lpthread\r\n-lrt\r\n-lgcc_s\r\n-lc\r\n-lm\r\n-lrt\r\n-lpthread\r\n-lutil\r\n-lrt\r\n-lutil\r\n-Wl,--eh-frame-hdr\r\n-Wl,-znoexecstack\r\n-L\r\n/home/ryucl0ud/.rustup/toolchains/stable-x86_64-unknown-netbsd/lib/rustlib/x86_64-unknown-netbsd/lib\r\n-o\r\n/tmp/simple-link/target/debug/deps/simple_link_test-4fc7c922e98fb1d0\r\n-Wl,--gc-sections\r\n-pie\r\n-Wl,-zrelro,-znow\r\n```\r\n\r\n### Workarounds\r\n\r\n#### Use a link wrapper script\r\n\r\nYou can use a wrapper script that copies the `-l*` arguments to the end:\r\n[`rust_link_fix.sh`](https://github.com/tmfink/rust-link-issue/blob/c82d426559c4cf4c9a2537d52d7643b9c59b0639/rust_link_fix.sh):\r\n```sh\r\n#!/bin/sh\r\n\r\nLINKER=\"cc\"\r\n\r\nlink_args=\r\nfor arg in \"$@\"; do\r\n    case \"${arg}\" in\r\n    -l*) link_args=\"${link_args} ${arg}\" ;;\r\n    esac\r\ndone\r\n\r\n# add link args to end (again)\r\nexec \"${LINKER}\" \"$@\" ${link_args}\r\n```\r\n\r\n[`.cargo/config`](https://github.com/tmfink/rust-link-issue/blob/c82d426559c4cf4c9a2537d52d7643b9c59b0639/.cargo/config):\r\n```toml\r\n[target.x86_64-unknown-netbsd]\r\nlinker = \"rust_link_fix.sh\"\r\n```\r\n\r\n#### Reference the symbol in the Rust code\r\n\r\nYou can \"trick\" the linker into pulling in the library by referencing a symbol from that library in the Rust code:\r\nhttps://github.com/tmfink/rust-link-issue/blob/c82d426559c4cf4c9a2537d52d7643b9c59b0639/src/main.rs#L16-L17", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/96328/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/96328/timeline", "performed_via_github_app": null, "state_reason": null}