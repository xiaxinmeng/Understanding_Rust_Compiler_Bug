{"url": "https://api.github.com/repos/rust-lang/rust/issues/39349", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/39349/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/39349/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/39349/events", "html_url": "https://github.com/rust-lang/rust/issues/39349", "id": 203735263, "node_id": "MDU6SXNzdWUyMDM3MzUyNjM=", "number": 39349, "title": "Compiler panic: conservative_impl_trait & for<>", "user": {"login": "kenOfYugen", "id": 5251559, "node_id": "MDQ6VXNlcjUyNTE1NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/5251559?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kenOfYugen", "html_url": "https://github.com/kenOfYugen", "followers_url": "https://api.github.com/users/kenOfYugen/followers", "following_url": "https://api.github.com/users/kenOfYugen/following{/other_user}", "gists_url": "https://api.github.com/users/kenOfYugen/gists{/gist_id}", "starred_url": "https://api.github.com/users/kenOfYugen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kenOfYugen/subscriptions", "organizations_url": "https://api.github.com/users/kenOfYugen/orgs", "repos_url": "https://api.github.com/users/kenOfYugen/repos", "events_url": "https://api.github.com/users/kenOfYugen/events{/privacy}", "received_events_url": "https://api.github.com/users/kenOfYugen/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2017-01-27T20:41:45Z", "updated_at": "2017-02-08T21:29:39Z", "closed_at": "2017-02-08T21:29:39Z", "author_association": "NONE", "active_lock_reason": null, "body": "I was trying out code that didn't panic the compiler on the playground. When attempting to compile on a local 32bit machine, the compiler panicked.\r\n\r\nI tried this code:\r\n```rust\r\n#![feature(conservative_impl_trait)]\r\n\r\nfn hello_closure<'a>(url: &'a str) -> impl for<'cl> FnMut() -> &'cl Option<&'a str> {\r\n  let mut world = None;\r\n  move || {\r\n    world = Some(url);\r\n    &world\r\n  }\r\n}\r\n\r\nfn main() {\r\n  let mut hello = hello_closure(\"hello\");\r\n  println!(\"{:?}\", hello());\r\n}\r\n\r\n```\r\nI expected to see this happen: https://is.gd/xRgyMz\r\n```\r\nrustc 1.16.0-nightly (df8debf6d 2017-01-25)\r\nerror[E0495]: cannot infer an appropriate lifetime for borrow expression due to conflicting requirements\r\n --> <anon>:7:5\r\n  |\r\n7 |     &world\r\n  |     ^^^^^^\r\n  |\r\nnote: first, the lifetime cannot outlive the lifetime  as defined on the body at 5:10...\r\n --> <anon>:5:11\r\n  |\r\n5 |     move || {\r\n  |  ___________^ starting here...\r\n6 | |     world = Some(url);\r\n7 | |     &world\r\n8 | |   }\r\n  | |___^ ...ending here\r\nnote: ...so that closure can access `world`\r\n --> <anon>:7:5\r\n  |\r\n7 |     &world\r\n  |     ^^^^^^\r\nnote: but, the lifetime must be valid for the lifetime 'cl as defined on the body at 5:10...\r\n --> <anon>:5:11\r\n  |\r\n5 |     move || {\r\n  |  ___________^ starting here...\r\n6 | |     world = Some(url);\r\n7 | |     &world\r\n8 | |   }\r\n  | |___^ ...ending here\r\nnote: ...so that reference does not outlive borrowed content\r\n --> <anon>:7:5\r\n  |\r\n7 |     &world\r\n  |     ^^^^^^\r\n\r\nerror: aborting due to previous error\r\n```\r\nInstead, this happened:\r\n```\r\n$ RUST_BACKTRACE=1 cargo b --verbose\r\n       Fresh matches v0.1.4\r\n       Fresh unicode-normalization v0.1.3\r\n       Fresh unicode-bidi v0.2.4\r\n       Fresh idna v0.1.0\r\n       Fresh url v1.4.0\r\n   Compiling tmp v0.1.0 (file:///home/ken/Desktop/tmp)\r\n     Running `rustc --crate-name tmp src/main.rs --crate-type bin --emit=dep-info,link -C debuginfo=2 -C metadata=671242ebec31e868 -C extra-filename=-671242ebec31e868 --out-dir /home/ken/Desktop/tmp/target/debug/deps -L dependency=/home/ken/Desktop/tmp/target/debug/deps --extern url=/home/ken/Desktop/tmp/target/debug/deps/liburl-323a6d15abd9f54a.rlib`\r\nerror: internal compiler error: /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc/infer/region_inference/mod.rs:1401: collect_error_for_expanding_node() could not find error for var '_#0r, lower_bounds=[RegionAndOrigin(ReFree(CodeExtent(4/CallSiteScope { fn_id: NodeId(4), body_id: NodeId(79) }), BrNamed(CrateNum(0):DefIndex(4), 'a(84), WontChange)),Subtype(TypeTrace(ObligationCause { span: src/main.rs:7:5: 7:11, body_id: NodeId(33), code: ExprAssignable }))), RegionAndOrigin(ReFree(CodeExtent(16/CallSiteScope { fn_id: NodeId(34), body_id: NodeId(33) }), BrNamed(CrateNum(0):DefIndex(7), 'cl(88), WontChange)),DataBorrowed(std::option::Option<&str>, src/main.rs:7:5: 7:11)), RegionAndOrigin(ReFree(CodeExtent(16/CallSiteScope { fn_id: NodeId(34), body_id: NodeId(33) }), BrNamed(CrateNum(0):DefIndex(7), 'cl(88), WontChange)),Reborrow(src/main.rs:7:5: 7:11)), RegionAndOrigin(ReScope(CodeExtent(24/Misc(NodeId(29)))),ExprTypeIsNotInScope(std::option::Option<&str>, src/main.rs:6:13: 6:22)), RegionAndOrigin(ReScope(CodeExtent(26/Misc(NodeId(27)))),ParameterInScope(Path, src/main.rs:6:13: 6:17)), RegionAndOrigin(ReScope(CodeExtent(27/Misc(NodeId(26)))),ExprTypeIsNotInScope(std::option::Option<&str>, src/main.rs:6:5: 6:10)), RegionAndOrigin(ReScope(CodeExtent(29/Misc(NodeId(31)))),ExprTypeIsNotInScope(std::option::Option<&str>, src/main.rs:7:6: 7:11)), RegionAndOrigin(ReScope(CodeExtent(4/CallSiteScope { fn_id: NodeId(4), body_id: NodeId(79) })),CallReturn(src/main.rs:3:1: 9:2)), RegionAndOrigin(ReScope(CodeExtent(10/Remainder(BlockRemainder { block: NodeId(21), first_statement_index: 0 }))),BindingTypeIsNotValidAtDecl(src/main.rs:4:7: 4:16)), RegionAndOrigin(ReScope(CodeExtent(14/Misc(NodeId(24)))),ParameterInScope(Path, src/main.rs:4:19: 4:23)), RegionAndOrigin(ReScope(CodeExtent(15/Misc(NodeId(34)))),ExprTypeIsNotInScope([closure@src/main.rs:5:3: 8:4 world:std::option::Option<&str>, url:&'a str], src/main.rs:5:3: 8:4)), RegionAndOrigin(ReScope(CodeExtent(8/Misc(NodeId(79)))),ExprTypeIsNotInScope([closure@src/main.rs:5:3: 8:4 world:std::option::Option<&str>, url:&'a str], src/main.rs:3:85: 9:2)), RegionAndOrigin(ReScope(CodeExtent(28/Misc(NodeId(32)))),AddrOf(src/main.rs:7:5: 7:11)), RegionAndOrigin(ReScope(CodeExtent(28/Misc(NodeId(32)))),AddrOf(src/main.rs:7:5: 7:11)), RegionAndOrigin(ReScope(CodeExtent(24/Misc(NodeId(29)))),ExprTypeIsNotInScope(std::option::Option<&str>, src/main.rs:6:13: 6:22)), RegionAndOrigin(ReScope(CodeExtent(26/Misc(NodeId(27)))),ParameterInScope(Path, src/main.rs:6:13: 6:17))], upper_bounds=[RegionAndOrigin(ReFree(CodeExtent(4/CallSiteScope { fn_id: NodeId(4), body_id: NodeId(79) }), BrNamed(CrateNum(0):DefIndex(4), 'a(84), WontChange)),Subtype(TypeTrace(ObligationCause { span: src/main.rs:6:18: 6:21, body_id: NodeId(33), code: ExprAssignable }))), RegionAndOrigin(ReFree(CodeExtent(4/CallSiteScope { fn_id: NodeId(4), body_id: NodeId(79) }), BrNamed(CrateNum(0):DefIndex(4), 'a(84), WontChange)),Subtype(TypeTrace(ObligationCause { span: src/main.rs:6:18: 6:21, body_id: NodeId(33), code: ExprAssignable })))]\r\n --> src/main.rs:6:18\r\n  |\r\n6 |     world = Some(url);\r\n  |                  ^^^\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: run with `RUST_BACKTRACE=1` for a backtrace\r\n\r\nthread 'rustc' panicked at 'Box<Any>', /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_errors/lib.rs:375\r\nstack backtrace:\r\n   1: 0xb744ee95 - std::sys::imp::backtrace::tracing::imp::write::h9c41d2f69e5caabf\r\n                at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/sys/unix/backtrace/tracing/gcc_s.rs:42\r\n   2: 0xb745b4ad - std::panicking::default_hook::{{closure}}::hcc803c8663cda123\r\n                at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:351\r\n   3: 0xb745afea - std::panicking::default_hook::hd5bda4e453dfb4be\r\n                at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:361\r\n   4: 0xb745b969 - std::panicking::rust_panic_with_hook::hffbc74969c7b5d87\r\n                at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:555\r\n   5: 0xb631e16f - std::panicking::begin_panic::h70e605b769910643\r\n   6: 0xb64d4983 - rustc::session::opt_span_bug_fmt::{{closure}}::hfd034971cdf18ea9\r\n   7: 0xb64d44a4 - rustc::session::opt_span_bug_fmt::hc2cac313cb6d0020\r\n   8: 0xb64d4359 - rustc::session::span_bug_fmt::hf82ba21f000fdbbb\r\n   9: 0xb64323f5 - rustc::infer::region_inference::RegionVarBindings::infer_variable_values::h93eff0b5677ea455\r\n  10: 0xb642d14b - rustc::infer::region_inference::RegionVarBindings::resolve_regions::hfb4d5b2f9bc17e01\r\n  11: 0xb6448e21 - rustc::infer::InferCtxt::resolve_regions_and_report_errors::h917474edcdeabfa7\r\n  12: 0xb6cedc5f - rustc_typeck::check::regionck::<impl rustc_typeck::check::FnCtxt<'a, 'gcx, 'tcx>>::regionck_fn::he1c667cdbcd741db\r\n  13: 0xb6d4a189 - rustc_typeck::check::check_bare_fn::hff8cbad9cd9ca12c\r\n  14: 0xb6d4d069 - rustc_typeck::check::check_item_body::h2a877e8ee0d16484\r\n  15: 0xb6d474eb - rustc_typeck::check::check_item_bodies::hf9c5a615b1a27ce2\r\n  16: 0xb6dbed38 - rustc_typeck::check_crate::h93455a3168487f9e\r\n  17: 0xb75fd2c3 - rustc_driver::driver::phase_3_run_analysis_passes::{{closure}}::haa13372f770e9055\r\n  18: 0xb75edcdd - rustc_driver::driver::phase_3_run_analysis_passes::h38e9d34781d495de\r\n  19: 0xb75d56df - rustc_driver::driver::compile_input::h44853ffed84a12cb\r\n  20: 0xb7623934 - rustc_driver::run_compiler::hdc4bb0fcf7d0917a\r\n  21: 0xb7529916 - std::panicking::try::do_call::h84a15e0d2b943318\r\n  22: 0xb7465772 - __rust_maybe_catch_panic\r\n                at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libpanic_unwind/lib.rs:98\r\n  23: 0xb7552497 - <F as alloc::boxed::FnBox<A>>::call_box::h61c78220cad685ea\r\n  24: 0xb745a27c - std::sys::imp::thread::Thread::new::thread_start::h76badbf9b0ecaf58\r\n                at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/liballoc/boxed.rs:615\r\n                at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/sys_common/thread.rs:21\r\n                at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/sys/unix/thread.rs:84\r\n  25: 0xb2af1300 - start_thread\r\n  26: 0xb72f80ad - clone\r\n  27:        0x0 - <unknown>\r\n\r\nerror: Could not compile `tmp`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name tmp src/main.rs --crate-type bin --emit=dep-info,link -C debuginfo=2 -C metadata=671242ebec31e868 -C extra-filename=-671242ebec31e868 --out-dir /home/ken/Desktop/tmp/target/debug/deps -L dependency=/home/ken/Desktop/tmp/target/debug/deps --extern url=/home/ken/Desktop/tmp/target/debug/deps/liburl-323a6d15abd9f54a.rlib` (exit code: 101)\r\n```\r\n\r\n## Meta\r\n\r\n`rustc --version --verbose`: \r\n```\r\nrustc 1.16.0-nightly (df8debf6d 2017-01-25)\r\nbinary: rustc\r\ncommit-hash: df8debf6d9afc431adbbd8311dcaf2b70eb9762e\r\ncommit-date: 2017-01-25\r\nhost: i686-unknown-linux-gnu\r\nrelease: 1.16.0-nightly\r\nLLVM version: 3.9\r\n```", "closed_by": {"login": "kenOfYugen", "id": 5251559, "node_id": "MDQ6VXNlcjUyNTE1NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/5251559?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kenOfYugen", "html_url": "https://github.com/kenOfYugen", "followers_url": "https://api.github.com/users/kenOfYugen/followers", "following_url": "https://api.github.com/users/kenOfYugen/following{/other_user}", "gists_url": "https://api.github.com/users/kenOfYugen/gists{/gist_id}", "starred_url": "https://api.github.com/users/kenOfYugen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kenOfYugen/subscriptions", "organizations_url": "https://api.github.com/users/kenOfYugen/orgs", "repos_url": "https://api.github.com/users/kenOfYugen/repos", "events_url": "https://api.github.com/users/kenOfYugen/events{/privacy}", "received_events_url": "https://api.github.com/users/kenOfYugen/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/39349/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/39349/timeline", "performed_via_github_app": null, "state_reason": "completed"}