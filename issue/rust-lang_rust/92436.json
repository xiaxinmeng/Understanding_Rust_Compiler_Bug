{"url": "https://api.github.com/repos/rust-lang/rust/issues/92436", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/92436/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/92436/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/92436/events", "html_url": "https://github.com/rust-lang/rust/issues/92436", "id": 1091124551, "node_id": "I_kwDOAAsO6M5BCT1H", "number": 92436, "title": "Emitted `memset` and `memcpy` are really slow on WASM", "user": {"login": "torokati44", "id": 288816, "node_id": "MDQ6VXNlcjI4ODgxNg==", "avatar_url": "https://avatars.githubusercontent.com/u/288816?v=4", "gravatar_id": "", "url": "https://api.github.com/users/torokati44", "html_url": "https://github.com/torokati44", "followers_url": "https://api.github.com/users/torokati44/followers", "following_url": "https://api.github.com/users/torokati44/following{/other_user}", "gists_url": "https://api.github.com/users/torokati44/gists{/gist_id}", "starred_url": "https://api.github.com/users/torokati44/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/torokati44/subscriptions", "organizations_url": "https://api.github.com/users/torokati44/orgs", "repos_url": "https://api.github.com/users/torokati44/repos", "events_url": "https://api.github.com/users/torokati44/events{/privacy}", "received_events_url": "https://api.github.com/users/torokati44/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2021-12-30T14:04:13Z", "updated_at": "2021-12-31T01:18:07Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "While both functions do the \"usual\" double-loop pattern, with one loop processing 4 or 8 bytes at a time, and the other one doing the remaining few, sadly, the former one also only does 1-byte wide loads and stores, just has more of them per iteration in series.\r\nThis does not look right, it could very well operate on single 32bit or 64bit wide primitives per iteration.\r\n\r\nThis is what `rustc` emits in `--release` mode:\r\n[memset](https://gist.github.com/torokati44/aaf63ed379879fc0c7bef0efcc94ad9e)\r\n[memcpy](https://gist.github.com/torokati44/2c61a72f388a53a19095feb3dabaedd4)\r\n\r\nRunning them through `wasm-opt -O` doesn't do much, only reorders some locals, and changes an \"add -1\" to a \"sub 1\" for some reason:\r\n[memset after wasm-opt](https://gist.github.com/torokati44/336465bc52dd8756a036d1311ee391f1)\r\n[memcpy after wasm-opt](https://gist.github.com/torokati44/6f3242e19565430eb54795068e978ab4)\r\n(I have also extended these sources to be complete modules for experimentation purposes.)\r\n\r\nThese functions constitute a double-digit percentage of total runtime in some cases, see: https://github.com/WebAssembly/binaryen/issues/4403#issuecomment-998326902", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/92436/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/92436/timeline", "performed_via_github_app": null, "state_reason": null}