{"url": "https://api.github.com/repos/rust-lang/rust/issues/69165", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/69165/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/69165/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/69165/events", "html_url": "https://github.com/rust-lang/rust/issues/69165", "id": 565303509, "node_id": "MDU6SXNzdWU1NjUzMDM1MDk=", "number": 69165, "title": "Jemalloc causes os-level deadlock", "user": {"login": "git-blame", "id": 19491679, "node_id": "MDQ6VXNlcjE5NDkxNjc5", "avatar_url": "https://avatars.githubusercontent.com/u/19491679?v=4", "gravatar_id": "", "url": "https://api.github.com/users/git-blame", "html_url": "https://github.com/git-blame", "followers_url": "https://api.github.com/users/git-blame/followers", "following_url": "https://api.github.com/users/git-blame/following{/other_user}", "gists_url": "https://api.github.com/users/git-blame/gists{/gist_id}", "starred_url": "https://api.github.com/users/git-blame/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/git-blame/subscriptions", "organizations_url": "https://api.github.com/users/git-blame/orgs", "repos_url": "https://api.github.com/users/git-blame/repos", "events_url": "https://api.github.com/users/git-blame/events{/privacy}", "received_events_url": "https://api.github.com/users/git-blame/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2020-02-14T12:39:54Z", "updated_at": "2020-02-18T19:57:04Z", "closed_at": "2020-02-18T19:57:03Z", "author_association": "NONE", "active_lock_reason": null, "body": "My rust application has a C component which calls lua-jit to support lua scripts. These scripts sometimes execute system tools via lua's support for launching external process/shell. When these scripts are heavily used, sometimes the application would simply hang.\r\n\r\nI was able to attach gdb to a debug version on one occasion. The stack traces show that most threads are within the lua code, waiting on a low-level lock due to some OS system call. One thread shows that rust's jemalloc (which is the allocator for all code even the C components in this app), is also waiting on a low-level lock.\r\n\r\nBecause of these tests:\r\n* Windows build does not exhibit this behavior (it uses system allocator)\r\n* Linux build hangs with jemalloc\r\n* Linux build is ok with jemalloc disabled (specifying system allocator in rust code)\r\n\r\nI think that rust's version of jemalloc is causing a deadlock. I'm not sure if this would affect pure rust code, rust + C code that doesn't extensively make system calls, etc. or if this is a combination of rust + jemalloc + lua-jit calling lots of system calls (popen, pclose, etc.).\r\n\r\nBacktrace below.\r\n\r\nThis may be related to #31030 or jemalloc/jemalloc/issues/315\r\n\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.30.0 (da5f414c2 2018-10-24)\r\nbinary: rustc\r\ncommit-hash: da5f414c2c0bfe5198934493f04c676e2b23ff2e\r\ncommit-date: 2018-10-24\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.30.0\r\nLLVM version: 8.0\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```\r\n(gdb) thr 3\r\n[Switching to thread 3 (Thread 0x7f7e3c9ff700 (LWP 21340))]\r\n#0  __lll_lock_wait_private () at ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:95\r\n95    ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S: No such file or directory.\r\n(gdb) bt 5\r\n#0  __lll_lock_wait_private () at ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:95\r\n#1  0x00007f7e41a183ba in _IO_flush_all_lockp (do_lock=1) at genops.c:774\r\n#2  0x000055ae035e436a in lj_cf_io_popen (L=0x41776378) at lib_io.c:416\r\n#3  0x000055ae035ccb0e in lj_BC_FUNCC ()\r\n#4  0x000055ae035b930a in lua_pcall (L=0x7f7e41d3e740 <list_all_lock>, nargs=<optimized out>, nresults=<optimized out>,\r\n    errfunc=<optimized out>) at lj_api.c:1129\r\n(More stack frames follow...)\r\n(gdb) thr 4\r\n[Switching to thread 4 (Thread 0x7f7e3c1fe700 (LWP 21341))]\r\n#0  __lll_lock_wait_private () at ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:95\r\n95    in ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S\r\n(gdb) bt 5\r\n#0  __lll_lock_wait_private () at ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:95\r\n#1  0x00007f7e41a1846f in _IO_flush_all_lockp (do_lock=1) at genops.c:783\r\n#2  0x000055ae035e436a in lj_cf_io_popen (L=0x40d5c378) at lib_io.c:416\r\n#3  0x000055ae035ccb0e in lj_BC_FUNCC ()\r\n#4  0x000055ae035b930a in lua_pcall (L=0x7f7e390981f0, nargs=<optimized out>, nresults=<optimized out>, errfunc=<optimized out>)\r\n    at lj_api.c:1129\r\n(More stack frames follow...)\r\n(gdb) thr 5\r\n[Switching to thread 5 (Thread 0x7f7e3b9fd700 (LWP 21342))]\r\n#0  __lll_lock_wait_private () at ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:95\r\n95    in ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S\r\n(gdb) bt 5\r\n#0  __lll_lock_wait_private () at ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:95\r\n#1  0x00007f7e41a16f25 in __GI__IO_un_link (fp=0x7f7e39298100) at genops.c:65\r\n#2  0x00007f7e41a1717a in __GI__IO_un_link (fp=<optimized out>) at genops.c:60\r\n#3  0x00007f7e41a09c55 in _IO_new_fclose (fp=0x7f7e39298100) at iofclose.c:54\r\n#4  0x000055ae035e3695 in io_file_close (L=<optimized out>, iof=<optimized out>) at lib_io.c:101\r\n(More stack frames follow...)\r\n(gdb) thr 6\r\n[Switching to thread 6 (Thread 0x7f7e3b1fc700 (LWP 21343))]\r\n#0  __lll_lock_wait_private () at ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:95\r\n95    in ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S\r\n(gdb) bt 5\r\n#0  __lll_lock_wait_private () at ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:95\r\n#1  0x00007f7e41a18f1a in __GI__IO_list_lock () at genops.c:1216\r\n#2  0x00007f7e41a5b505 in __libc_fork () at ../sysdeps/nptl/fork.c:125\r\n#3  0x00007f7e41a0bc71 in _IO_new_proc_open (fp=fp@entry=0x7f7e38e98200, command=command@entry=0x404e4f90 \"ps p  2> /dev/null\",\r\n    mode=<optimized out>, mode@entry=0x55ae0384b868 \"r\") at iopopen.c:180\r\n#4  0x00007f7e41a0bf68 in _IO_new_popen (command=0x404e4f90 \"ps p  2> /dev/null\", mode=0x55ae0384b868 \"r\") at iopopen.c:296\r\n(More stack frames follow...)\r\n(gdb) thr 7\r\n[Switching to thread 7 (Thread 0x7f7e3a9fb700 (LWP 21344))]\r\n#0  __lll_lock_wait () at ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:135\r\n135    ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S: No such file or directory.\r\n(gdb) bt 18\r\n#0  __lll_lock_wait () at ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:135\r\n#1  0x00007f7e41f62cc6 in __GI___pthread_mutex_lock (mutex=0x7f7e414a0560) at ../nptl/pthread_mutex_lock.c:135\r\n#2  0x000055ae03568ea5 in je_malloc_mutex_lock (tsdn=<optimized out>, mutex=<optimized out>)\r\n    at /rustc/da5f414c2c0bfe5198934493f04c676e2b23ff2e/src/liballoc_jemalloc/../jemalloc/include/jemalloc/internal/mutex.h:101\r\n#3  je_arena_tcache_fill_small (tsdn=0x7f7e3a9fb4c8, arena=0x7f7e4149e980, tbin=0x7f7e40e223a8, binind=1106677596,\r\n    prof_accumbytes=140180237976928)\r\n    at /rustc/da5f414c2c0bfe5198934493f04c676e2b23ff2e/src/liballoc_jemalloc/../jemalloc/src/arena.c:2442\r\n#4  0x000055ae0358278a in je_tcache_alloc_small_hard (tsdn=0x7f7e414a0560, arena=0x80, tcache=<optimized out>,\r\n    tbin=0x7f7e40e223a8, binind=1106677596, tcache_success=0x7f7e3a9f920e)\r\n    at /rustc/da5f414c2c0bfe5198934493f04c676e2b23ff2e/src/liballoc_jemalloc/../jemalloc/src/tcache.c:82\r\n#5  0x000055ae0355d9ce in je_tcache_alloc_small (arena=<optimized out>, size=0, tsd=<optimized out>, tcache=<optimized out>,\r\n    binind=<optimized out>, zero=<optimized out>, slow_path=<optimized out>)\r\n    at /rustc/da5f414c2c0bfe5198934493f04c676e2b23ff2e/src/liballoc_jemalloc/../jemalloc/include/jemalloc/internal/tcache.h:301\r\n#6  je_arena_malloc (tsdn=<optimized out>, size=<optimized out>, zero=<optimized out>, tcache=<optimized out>,\r\n    slow_path=<optimized out>, arena=<optimized out>, ind=<optimized out>)\r\n    at /rustc/da5f414c2c0bfe5198934493f04c676e2b23ff2e/src/liballoc_jemalloc/../jemalloc/include/jemalloc/internal/arena.h:1346\r\n#7  je_iallocztm (size=<optimized out>, zero=<optimized out>, tcache=<optimized out>, is_metadata=<optimized out>,\r\n    slow_path=<optimized out>, tsdn=<optimized out>, ind=<optimized out>, arena=<optimized out>)\r\n    at include/jemalloc/internal/jemalloc_internal.h:1067\r\n#8  je_ialloc (tsd=<optimized out>, size=<optimized out>, ind=<optimized out>, zero=<optimized out>, slow_path=<optimized out>)\r\n    at include/jemalloc/internal/jemalloc_internal.h:1079\r\n#9  ialloc_body (slow_path=false, size=<optimized out>, zero=<optimized out>, tsdn=<optimized out>, usize=<optimized out>)\r\n    at /rustc/da5f414c2c0bfe5198934493f04c676e2b23ff2e/src/liballoc_jemalloc/../jemalloc/src/jemalloc.c:1605\r\n#10 malloc (size=size@entry=4096)\r\n    at /rustc/da5f414c2c0bfe5198934493f04c676e2b23ff2e/src/liballoc_jemalloc/../jemalloc/src/jemalloc.c:1644\r\n#11 0x00007f7e41a09a62 in __GI__IO_file_doallocate (fp=0x7f7e39098100) at filedoalloc.c:101\r\n#12 0x00007f7e41a17a76 in __GI__IO_doallocbuf (fp=fp@entry=0x7f7e39098100) at genops.c:398\r\n#13 0x00007f7e41a16ae4 in _IO_new_file_underflow (fp=0x7f7e39098100) at fileops.c:564\r\n#14 0x00007f7e41a17b32 in __GI__IO_default_uflow (fp=0x7f7e39098100) at genops.c:413\r\n#15 0x00007f7e41a0b54a in __GI__IO_getline_info (fp=fp@entry=0x7f7e39098100,\r\n    buf=buf@entry=0x41f50a10 \"dpkg -S \\\"//var/lib/docker/overlay2/24dfba067742bebc0aef4ae9e772d072484ae200c22aa9e9defbe98c3aa61efb/diff/usr/share/ca-certificates/mozilla/Hellenic_Academic_and_Research_Institutions_RootCA_2015.crt\\\" \"..., n=8191,\r\n    delim=delim@entry=10, extract_delim=extract_delim@entry=1, eof=eof@entry=0x0) at iogetline.c:60\r\n#16 0x00007f7e41a0b658 in __GI__IO_getline (fp=fp@entry=0x7f7e39098100,\r\n---Type <return> to continue, or q <return> to quit---\r\n    buf=buf@entry=0x41f50a10 \"dpkg -S \\\"//var/lib/docker/overlay2/24dfba067742bebc0aef4ae9e772d072484ae200c22aa9e9defbe98c3aa61efb/diff/usr/share/ca-certificates/mozilla/Hellenic_Academic_and_Research_Institutions_RootCA_2015.crt\\\" \"..., n=<optimized out>,\r\n    delim=delim@entry=10, extract_delim=extract_delim@entry=1) at iogetline.c:34\r\n#17 0x00007f7e41a0a3eb in _IO_fgets (\r\n    buf=0x41f50a10 \"dpkg -S \\\"//var/lib/docker/overlay2/24dfba067742bebc0aef4ae9e772d072484ae200c22aa9e9defbe98c3aa61efb/diff/usr/share/ca-certificates/mozilla/Hellenic_Academic_and_Research_Institutions_RootCA_2015.crt\\\" \"..., n=<optimized out>,\r\n    fp=0x7f7e39098100) at iofgets.c:53\r\n(More stack frames follow...)\r\n```\r\n\r\n</p>\r\n</details>\r\n", "closed_by": {"login": "git-blame", "id": 19491679, "node_id": "MDQ6VXNlcjE5NDkxNjc5", "avatar_url": "https://avatars.githubusercontent.com/u/19491679?v=4", "gravatar_id": "", "url": "https://api.github.com/users/git-blame", "html_url": "https://github.com/git-blame", "followers_url": "https://api.github.com/users/git-blame/followers", "following_url": "https://api.github.com/users/git-blame/following{/other_user}", "gists_url": "https://api.github.com/users/git-blame/gists{/gist_id}", "starred_url": "https://api.github.com/users/git-blame/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/git-blame/subscriptions", "organizations_url": "https://api.github.com/users/git-blame/orgs", "repos_url": "https://api.github.com/users/git-blame/repos", "events_url": "https://api.github.com/users/git-blame/events{/privacy}", "received_events_url": "https://api.github.com/users/git-blame/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/69165/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/69165/timeline", "performed_via_github_app": null, "state_reason": "completed"}