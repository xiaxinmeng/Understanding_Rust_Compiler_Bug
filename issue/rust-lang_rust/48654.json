{"url": "https://api.github.com/repos/rust-lang/rust/issues/48654", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/48654/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/48654/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/48654/events", "html_url": "https://github.com/rust-lang/rust/issues/48654", "id": 301642132, "node_id": "MDU6SXNzdWUzMDE2NDIxMzI=", "number": 48654, "title": "missed optimization: fat pointers in two-variant enums with small second variants", "user": {"login": "alercah", "id": 20842325, "node_id": "MDQ6VXNlcjIwODQyMzI1", "avatar_url": "https://avatars.githubusercontent.com/u/20842325?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alercah", "html_url": "https://github.com/alercah", "followers_url": "https://api.github.com/users/alercah/followers", "following_url": "https://api.github.com/users/alercah/following{/other_user}", "gists_url": "https://api.github.com/users/alercah/gists{/gist_id}", "starred_url": "https://api.github.com/users/alercah/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alercah/subscriptions", "organizations_url": "https://api.github.com/users/alercah/orgs", "repos_url": "https://api.github.com/users/alercah/repos", "events_url": "https://api.github.com/users/alercah/events{/privacy}", "received_events_url": "https://api.github.com/users/alercah/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2018-03-02T03:33:08Z", "updated_at": "2020-05-14T04:54:37Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Currently, there's a reasonably well-known optimization for two-variant enums, where one variant is a single pointer and the other has no fields. In this case, Rust uses its knowledge that `0x0` is never a valid pointer value to optimize the discriminant into the address: `0x0` is taken to mean that the non-pointer variant is the correct one.\r\n\r\nThere's a missed optimization, however, when the pointer is a fat one (e.g. a slice or a trait object) and the second variant is small (specifically, `<= usize`). In this case, the enum could be optimized by having the address field zero still indicate the second variant, with the fields being stored where the size or vtable pointer would be stored on a trait object.\r\n\r\nhttps://play.rust-lang.org/?gist=7398c28c7f05bc76a06a7fb6d4af40fa&version=nightly", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/48654/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/48654/timeline", "performed_via_github_app": null, "state_reason": null}