{"url": "https://api.github.com/repos/rust-lang/rust/issues/100923", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/100923/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/100923/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/100923/events", "html_url": "https://github.com/rust-lang/rust/issues/100923", "id": 1348266620, "node_id": "I_kwDOAAsO6M5QXOp8", "number": 100923, "title": "Passing an array to an inlined function from another crate miscompiles on PowerPC", "user": {"login": "linkmauve", "id": 7755816, "node_id": "MDQ6VXNlcjc3NTU4MTY=", "avatar_url": "https://avatars.githubusercontent.com/u/7755816?v=4", "gravatar_id": "", "url": "https://api.github.com/users/linkmauve", "html_url": "https://github.com/linkmauve", "followers_url": "https://api.github.com/users/linkmauve/followers", "following_url": "https://api.github.com/users/linkmauve/following{/other_user}", "gists_url": "https://api.github.com/users/linkmauve/gists{/gist_id}", "starred_url": "https://api.github.com/users/linkmauve/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/linkmauve/subscriptions", "organizations_url": "https://api.github.com/users/linkmauve/orgs", "repos_url": "https://api.github.com/users/linkmauve/repos", "events_url": "https://api.github.com/users/linkmauve/events{/privacy}", "received_events_url": "https://api.github.com/users/linkmauve/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 60329014, "node_id": "MDU6TGFiZWw2MDMyOTAxNA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-low", "name": "P-low", "color": "eb6420", "default": false, "description": "Low priority"}, {"id": 147085028, "node_id": "MDU6TGFiZWwxNDcwODUwMjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-nightly", "name": "regression-from-stable-to-nightly", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to nightly."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1359848690, "node_id": "MDU6TGFiZWwxMzU5ODQ4Njkw", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-mcve", "name": "E-needs-mcve", "color": "02e10c", "default": false, "description": "Call for participation: This issue needs a Minimal Complete and Verifiable Example"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2022-08-23T17:07:17Z", "updated_at": "2023-02-07T16:41:17Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "### Code\r\n\r\nI tried this code:\r\n\r\ncrate1:\r\n```rust\r\n#[inline(always)]\r\npub fn check_something(array: [u8; 7]) {\r\n    for f in array {\r\n        assert!(f < 64);\r\n    }\r\n}\r\n```\r\ncrate2:\r\n```rust\r\nfn main() {\r\n    other_unrelated_function([0x00666666]);\r\n    check_something([0x00, 0x00, 0x15, 0x16, 0x15, 0x00, 0x00]);\r\n}\r\n```\r\n\r\nThis was while trying to build [my GPU branch](https://github.com/linkmauve/luma/tree/bp) of the [Luma](https://github.com/rust-wii/luma) project, which targets the GameCube and the Wii (so use PowerPC codegen).  The bug as I could see it in [Dolphin](https://dolphin-emu.org/)\u2019s debugger is that the register pointing to the beginning of the array minus one byte actually points to the beginning of the array minus five bytes, and thus it reads the four bytes prior to the beginning of the array, then the first three bytes.\r\n\r\nThings which fix this bug:\r\n- Adding a `println!(\"{array:?}\")`\r\n- Making the function `#[inline(never)]`\r\n- Passing the array as an array reference instead.\r\n\r\nI expected to see this happen: no assert would happen, as none of the values in the array are bigger than 0x16 (22).\r\n\r\nInstead, this happened: `panicked at 'assertion failed: f < 64', /home/linkmauve/dev/rust/luma/luma_core/src/gx/bp.rs:150:13`\r\n\r\n### Version it worked on\r\n\r\nIt most recently worked on: nightly from the 2022-08-11.\r\n\r\n### Version with regression\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.65.0-nightly (015a824f2 2022-08-22)\r\nbinary: rustc\r\ncommit-hash: 015a824f2dffe32707fceb59c47effaf7b73486c\r\ncommit-date: 2022-08-22\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.65.0-nightly\r\nLLVM version: 15.0.0\r\n```\r\n\r\n<!--\r\nIf you know when this regression occurred, please add a line like below, replacing `{channel}` with one of stable, beta, or nightly.\r\n\r\n@rustbot modify labels: +regression-from-nightly-to-nightly -regression-untriaged\r\n-->\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/100923/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/100923/timeline", "performed_via_github_app": null, "state_reason": null}