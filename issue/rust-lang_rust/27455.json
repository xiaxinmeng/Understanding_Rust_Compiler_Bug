{"url": "https://api.github.com/repos/rust-lang/rust/issues/27455", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/27455/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/27455/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/27455/events", "html_url": "https://github.com/rust-lang/rust/issues/27455", "id": 98524833, "node_id": "MDU6SXNzdWU5ODUyNDgzMw==", "number": 27455, "title": "Compiler segfault / illegal instruction: llvm: Assertion `Ty && \"Invalid GetElementPtrInst indices for type!\"' failed.", "user": {"login": "AnthIste", "id": 144103, "node_id": "MDQ6VXNlcjE0NDEwMw==", "avatar_url": "https://avatars.githubusercontent.com/u/144103?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AnthIste", "html_url": "https://github.com/AnthIste", "followers_url": "https://api.github.com/users/AnthIste/followers", "following_url": "https://api.github.com/users/AnthIste/following{/other_user}", "gists_url": "https://api.github.com/users/AnthIste/gists{/gist_id}", "starred_url": "https://api.github.com/users/AnthIste/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AnthIste/subscriptions", "organizations_url": "https://api.github.com/users/AnthIste/orgs", "repos_url": "https://api.github.com/users/AnthIste/repos", "events_url": "https://api.github.com/users/AnthIste/events{/privacy}", "received_events_url": "https://api.github.com/users/AnthIste/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2015-08-01T09:46:27Z", "updated_at": "2016-08-08T18:29:44Z", "closed_at": "2016-08-08T18:29:44Z", "author_association": "NONE", "active_lock_reason": null, "body": "## Environment\n#### Local Environment\n\n```\nDarwin genesis.local 14.4.0 Darwin Kernel Version 14.4.0: Thu May 28 11:35:04 PDT 2015; root:xnu-2782.30.5~1/RELEASE_X86_64 x86_64\nrustc 1.0.0 (a59de37e9 2015-05-13) (built 2015-05-14)\n```\n#### Playpen Environment\n\nThis was tested 01/07/2015. I am not sure how to get the exact versions from the playpen.\n## Error\n#### On **1.0.0 Stable** (tested on local environment)\n\n```\nrustc src/lib.rs --crate-name ecs --crate-type lib -g --test -C metadata=33fec8143b6dd287 -C extra-filename=-33fec8143b6dd287 --out-dir /Users/salad/Code/Rust/ecs/target/debug --emit=dep-info,link -L dependency=/Users/salad/Code/Rust/ecs/target/debug -L dependency=/Users/salad/Code/Rust/ecs/target/debug/deps\nsrc/lib.rs:8:5: 8:19 warning: struct field is never used: `entity`, #[warn(dead_code)] on by default\nsrc/lib.rs:8     entity: Entity,\n                 ^~~~~~~~~~~~~~\n[1]    10781 segmentation fault  rustc src/lib.rs --crate-name ecs --crate-type lib -g --test -C  -C  --out-di\n```\n#### On **1.1.0 Stable** (tested on playpen)\n\n```\nIllegal instruction (core dumped)\nplaypen: application terminated with error code 132\n```\n#### On **nightly** (tested on playpen)\n\n```\nrustc: /home/rustbuild/src/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/llvm/include/llvm/IR/Instructions.h:823: llvm::Type* llvm::checkGEPType(llvm::Type*): Assertion `Ty && \"Invalid GetElementPtrInst indices for type!\"' failed.\nAborted (core dumped)\nplaypen: application terminated with error code 134\n```\n## Notes\n\nThis only occurs when trying to compile and run the test cast using `cargo test`. Simply building the example with `cargo build` works as expected (no crash).\n## Related Issues\n\nI searched for related issues but they all seem to be solved, and this is still occurring. Hence I am opening a new issue instead. The related issues that I found with a similar assertion:\n- #23649\n- #3702\n- [search results](https://github.com/rust-lang/rust/search?q=GetElementPtrInst&type=Issues&utf8=\u2713)\n## Minimal Reproducable Example\n\nThanks to @arielb1\n\n```\ntrait SomeTrait {}\nimpl SomeTrait for i32 {}\nstruct Component<T:?Sized>(T);\nfn main() {\n    let ref c = Component(42);\n    let &Component(ref data) = c as &Component<SomeTrait>;\n}\n```\n## Full Code Snippet\n\n```\nuse std::any::Any;\n\nstruct Entity(u64);\n\nstruct Component<T: ?Sized>(T);\n\nstruct EntityData {\n    entity: Entity,\n    components: Vec<Box<Component<Any>>>,\n}\n\nimpl EntityData {\n    pub fn new() -> Self {\n        EntityData {\n            entity: Entity(0),\n            components: Vec::new(),\n        }\n    }\n\n    pub fn attach<T: Sized + Any>(&mut self, data: T) {\n        let c = Component(data);\n        let x = Box::new(c);\n\n        self.components.push(x);\n    }\n\n    pub fn get<T: Any>(&self) -> Option<&T> {\n        let first = &self.components[0];\n\n        let Component(ref data) = **first;\n\n        data.downcast_ref::<T>()\n    }\n}\n\n#[test]\npub fn attach_and_get() {\n    let mut e = EntityData::new();\n    let c = Component::<u64>(1234);\n\n    e.attach(c);\n\n    let u = e.get::<u64>().unwrap();\n\n    assert!(*u == 1234);\n}\n```\n", "closed_by": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/27455/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/27455/timeline", "performed_via_github_app": null, "state_reason": "completed"}