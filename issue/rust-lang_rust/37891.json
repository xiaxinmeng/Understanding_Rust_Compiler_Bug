{"url": "https://api.github.com/repos/rust-lang/rust/issues/37891", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/37891/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/37891/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/37891/events", "html_url": "https://github.com/rust-lang/rust/issues/37891", "id": 190550252, "node_id": "MDU6SXNzdWUxOTA1NTAyNTI=", "number": 37891, "title": "Borrow checker permits use after move in if statements", "user": {"login": "Xaeroxe", "id": 6182002, "node_id": "MDQ6VXNlcjYxODIwMDI=", "avatar_url": "https://avatars.githubusercontent.com/u/6182002?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Xaeroxe", "html_url": "https://github.com/Xaeroxe", "followers_url": "https://api.github.com/users/Xaeroxe/followers", "following_url": "https://api.github.com/users/Xaeroxe/following{/other_user}", "gists_url": "https://api.github.com/users/Xaeroxe/gists{/gist_id}", "starred_url": "https://api.github.com/users/Xaeroxe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Xaeroxe/subscriptions", "organizations_url": "https://api.github.com/users/Xaeroxe/orgs", "repos_url": "https://api.github.com/users/Xaeroxe/repos", "events_url": "https://api.github.com/users/Xaeroxe/events{/privacy}", "received_events_url": "https://api.github.com/users/Xaeroxe/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 171502053, "node_id": "MDU6TGFiZWwxNzE1MDIwNTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-borrow-checker", "name": "A-borrow-checker", "color": "f7e101", "default": false, "description": "Area: The borrow checker"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2016-11-20T10:21:36Z", "updated_at": "2016-12-03T06:48:28Z", "closed_at": "2016-12-01T21:29:55Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Below code when compiled with Rust 1.13 (current stable) and Rust 1.15 (current nightly) will result in segmentation faults and memory corruption.  The unwrap call in the else if should consume the value and prevent further use but it does not.\r\n\r\n```\r\nfn main() {\r\n    let vec = get_vec();\r\n    if let Err(err) = vec {\r\n        println!(\"Got an error: {:?}\", err);\r\n    }\r\n    else if vec.unwrap().len() == 0 {\r\n        println!(\"Vec was 0 length.\");\r\n    }\r\n    else {\r\n        for i in vec.unwrap() {\r\n            println!(\"{}\", i);\r\n        }\r\n    }\r\n}\r\n\r\nfn get_vec() -> Result<Vec<i32>, i32> {\r\n    Ok::<Vec<i32>, i32>(vec![1,2,3])\r\n}\r\n```\r\n\r\nI expected: the borrow checker to mark the for loop as a use after move due to calling unwrap() after the value had been consumed by checking it in the else if statement\r\n\r\nWhat happened: The borrow checker did not prevent this from compiling which resulted in segfaults and memory corruption.\r\n\r\nReproduction tip: You will get slightly different behavior of this code on each execution as memory errors are a bit finicky like that, if it works the first time try it a few more times, I'm sure you'll see it crash before you get to 5 attempts.\r\n\r\n## Meta\r\n`rustc --version --verbose`:\r\nrustc 1.15.0-nightly (ac635aa95 2016-11-18)\r\nbinary: rustc\r\ncommit-hash: ac635aa95ba851898e125b047ad7b8d6a8fecf8e\r\ncommit-date: 2016-11-18\r\nhost: x86_64-pc-windows-gnu\r\nrelease: 1.15.0-nightly\r\nLLVM version: 3.9", "closed_by": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/37891/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/37891/timeline", "performed_via_github_app": null, "state_reason": "completed"}