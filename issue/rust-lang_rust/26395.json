{"url": "https://api.github.com/repos/rust-lang/rust/issues/26395", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/26395/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/26395/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/26395/events", "html_url": "https://github.com/rust-lang/rust/issues/26395", "id": 89288228, "node_id": "MDU6SXNzdWU4OTI4ODIyOA==", "number": 26395, "title": "Misleading example in the Docs regarding TcpListener", "user": {"login": "TheNeikos", "id": 1631166, "node_id": "MDQ6VXNlcjE2MzExNjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1631166?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TheNeikos", "html_url": "https://github.com/TheNeikos", "followers_url": "https://api.github.com/users/TheNeikos/followers", "following_url": "https://api.github.com/users/TheNeikos/following{/other_user}", "gists_url": "https://api.github.com/users/TheNeikos/gists{/gist_id}", "starred_url": "https://api.github.com/users/TheNeikos/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TheNeikos/subscriptions", "organizations_url": "https://api.github.com/users/TheNeikos/orgs", "repos_url": "https://api.github.com/users/TheNeikos/repos", "events_url": "https://api.github.com/users/TheNeikos/events{/privacy}", "received_events_url": "https://api.github.com/users/TheNeikos/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2015-06-18T13:03:37Z", "updated_at": "2015-06-18T14:21:29Z", "closed_at": "2015-06-18T14:21:29Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The docs currently have this example on the page for TcpListener:\nhttps://doc.rust-lang.org/std/net/struct.TcpListener.html\n\n``` rust\nuse std::net::{TcpListener, TcpStream};\nuse std::thread;\n\nlet listener = TcpListener::bind(\"127.0.0.1:80\").unwrap();\n\nfn handle_client(stream: TcpStream) {\n    // ...\n}\n\n// accept connections and process them, spawning a new thread for each one\nfor stream in listener.incoming() {\n    match stream {\n        Ok(stream) => {\n            thread::spawn(move|| {\n                // connection succeeded\n                handle_client(stream)\n            });\n        }\n        Err(e) => { /* connection failed */ }\n    }\n}\n\n// close the socket server\ndrop(listener);\n```\n\nThe problem is, this cannot be exited in a clean way. I stumbled upon this by trying to play around with this and threads, my setup right now is a thread opening the socket, and another continually accepting streams and sending them to another thread. This works until shutdown. I cannot stop the iterator in a clean way. I could kill the thread, but I might leak open filedescriptors that way, which is obviously not clean.\n\nAn option would be having an iterator that blocks with a timeout. But as of today there is no way to set an timeout from outside.\n\nIn  `src/libstd/sys/unix/net.rs` is a `set_timeout` method, but it is not used for the TcpListener as far as I can tell. (A quick `ag set_timeout` only returned results for a TcpStream.)\n\nThe example is misleading that it implies that it closes the Socket Server, which, as of today, it does not. It also means that you can only exit when killing the thread/program, which implies that no Destructors are run.\n\nAre there any solutions? Am I doing something wrong?\n", "closed_by": {"login": "TheNeikos", "id": 1631166, "node_id": "MDQ6VXNlcjE2MzExNjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1631166?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TheNeikos", "html_url": "https://github.com/TheNeikos", "followers_url": "https://api.github.com/users/TheNeikos/followers", "following_url": "https://api.github.com/users/TheNeikos/following{/other_user}", "gists_url": "https://api.github.com/users/TheNeikos/gists{/gist_id}", "starred_url": "https://api.github.com/users/TheNeikos/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TheNeikos/subscriptions", "organizations_url": "https://api.github.com/users/TheNeikos/orgs", "repos_url": "https://api.github.com/users/TheNeikos/repos", "events_url": "https://api.github.com/users/TheNeikos/events{/privacy}", "received_events_url": "https://api.github.com/users/TheNeikos/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/26395/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/26395/timeline", "performed_via_github_app": null, "state_reason": "completed"}