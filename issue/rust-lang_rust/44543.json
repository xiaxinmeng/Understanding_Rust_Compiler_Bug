{"url": "https://api.github.com/repos/rust-lang/rust/issues/44543", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/44543/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/44543/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/44543/events", "html_url": "https://github.com/rust-lang/rust/issues/44543", "id": 257421786, "node_id": "MDU6SXNzdWUyNTc0MjE3ODY=", "number": 44543, "title": "Broken MIR: generator contains type X but typeck does not know it", "user": {"login": "manuels", "id": 31315, "node_id": "MDQ6VXNlcjMxMzE1", "avatar_url": "https://avatars.githubusercontent.com/u/31315?v=4", "gravatar_id": "", "url": "https://api.github.com/users/manuels", "html_url": "https://github.com/manuels", "followers_url": "https://api.github.com/users/manuels/followers", "following_url": "https://api.github.com/users/manuels/following{/other_user}", "gists_url": "https://api.github.com/users/manuels/gists{/gist_id}", "starred_url": "https://api.github.com/users/manuels/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/manuels/subscriptions", "organizations_url": "https://api.github.com/users/manuels/orgs", "repos_url": "https://api.github.com/users/manuels/repos", "events_url": "https://api.github.com/users/manuels/events{/privacy}", "received_events_url": "https://api.github.com/users/manuels/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 679846574, "node_id": "MDU6TGFiZWw2Nzk4NDY1NzQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-generators", "name": "A-generators", "color": "f7e101", "default": false, "description": "Area: Generators"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-09-13T15:21:37Z", "updated_at": "2017-09-17T20:11:45Z", "closed_at": "2017-09-17T20:11:45Z", "author_association": "NONE", "active_lock_reason": null, "body": "I am running into a compiler error when trying to compile this bit of code with rustc 1.22.0-nightly (eba374fb2 2017-09-11) running on x86_64-unknown-linux-gnu and the current `futures-await` crate (579a98bb):\r\n\r\n```\r\n#![feature(proc_macro, conservative_impl_trait, generators)]\r\n\r\nextern crate futures_await as futures;\r\n\r\nuse futures::prelude::*;\r\nuse std::io::Error;\r\n\r\n#[async]\r\nfn foo(x: i8) -> Result<i8, (i8, Error)> {\r\n  Ok(x)\r\n}\r\n\r\n#[async]\r\nfn bar() -> Result<(),()> {\r\n    let mut x = Ok(1);\r\n    loop {\r\n        let y = match x {\r\n           Ok(a) => a,\r\n           Err((b, _e)) => b,\r\n           //Err((b, _)) => b, // Compilation works fine if we use this line instead of the one above!\r\n        };\r\n\r\n        x = await!(foo(y));\r\n    }\r\n}\r\n\r\nfn main() {\r\n    bar().wait().unwrap();\r\n}\r\n```\r\n\r\nThe compiler error reads:\r\n\r\n```\r\n$ RUST_BACKTRACE=1 cargo +nightly run --verbose\r\n       Fresh futures v0.1.15\r\n       Fresh futures-await-macro v0.1.0 (https://github.com/alexcrichton/futures-await#579a98bb)\r\n       Fresh unicode-xid v0.1.0\r\n       Fresh proc-macro2 v0.1.3\r\n       Fresh quote v0.3.15 (https://github.com/dtolnay/quote#873c0d0e)\r\n       Fresh synom v0.11.3 (https://github.com/dtolnay/syn#d5e98599)\r\n       Fresh syn v0.11.11 (https://github.com/dtolnay/syn#d5e98599)\r\n       Fresh futures-async-macro v0.1.0 (https://github.com/alexcrichton/futures-await#579a98bb)\r\n       Fresh futures-await v0.1.0 (https://github.com/alexcrichton/futures-await#579a98bb)\r\n   Compiling foo v0.1.0 (file:///home/manuel/tmp/await-bug)\r\n     Running `rustc --crate-name foo src/main.rs --crate-type bin --emit=dep-info,link -C debuginfo=2 -C metadata=68d8605c99341a0a -C extra-filename=-68d8605c99341a0a --out-dir /home/manuel/tmp/await-bug/target/debug/deps -L dependency=/home/manuel/tmp/await-bug/target/debug/deps --extern futures_await=/home/manuel/tmp/await-bug/target/debug/deps/libfutures_await-5aec48bc7b80f434.rlib`\r\nerror: internal compiler error: /checkout/src/librustc_mir/transform/generator.rs:352: Broken MIR: generator contains type std::io::Error in MIR, but typeck only knows about (std::result::Result<(), ()>, std::result::Result<i8, (i8, std::io::Error)>, i8, (), impl futures::__rt::MyFuture<std::result::Result<i8, (i8, std::io::Error)>>)\r\n --> src/main.rs:14:27\r\n  |\r\n1 | | #![feature(proc_macro, conservative_impl_trait, generators)]\r\n  | |____^\r\n...\r\n14|   fn bar() -> Result<(),()> {\r\n  |  ___________________________^\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: rustc 1.22.0-nightly (eba374fb2 2017-09-11) running on x86_64-unknown-linux-gnu\r\n\r\nnote: run with `RUST_BACKTRACE=1` for a backtrace\r\n\r\nthread 'rustc' panicked at 'Box<Any>', /checkout/src/librustc_errors/lib.rs:439:8\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\nstack backtrace:\r\n   0: std::sys::imp::backtrace::tracing::imp::unwind_backtrace\r\n             at /checkout/src/libstd/sys/unix/backtrace/tracing/gcc_s.rs:49\r\n   1: std::sys_common::backtrace::_print\r\n             at /checkout/src/libstd/sys_common/backtrace.rs:71\r\n   2: std::panicking::default_hook::{{closure}}\r\n             at /checkout/src/libstd/sys_common/backtrace.rs:60\r\n             at /checkout/src/libstd/panicking.rs:381\r\n   3: std::panicking::default_hook\r\n             at /checkout/src/libstd/panicking.rs:391\r\n   4: std::panicking::rust_panic_with_hook\r\n             at /checkout/src/libstd/panicking.rs:577\r\n   5: std::panicking::begin_panic\r\n   6: rustc_errors::Handler::span_bug\r\n   7: rustc::session::opt_span_bug_fmt::{{closure}}\r\n   8: rustc::session::span_bug_fmt\r\n   9: <rustc_mir::transform::generator::StateTransform as rustc::mir::transform::MirPass>::run_pass\r\n  10: rustc_mir::transform::run_suite\r\n  11: rustc_mir::transform::optimized_mir\r\n  12: rustc::dep_graph::graph::DepGraph::with_task\r\n  13: rustc::ty::maps::<impl rustc::ty::maps::queries::optimized_mir<'tcx>>::try_get\r\n  14: rustc::ty::maps::TyCtxtAt::optimized_mir\r\n  15: rustc::ty::maps::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'lcx>>::optimized_mir\r\n  16: rustc_mir::shim::make_shim\r\n  17: rustc::dep_graph::graph::DepGraph::with_task\r\n  18: rustc::ty::maps::<impl rustc::ty::maps::queries::mir_shims<'tcx>>::try_get\r\n  19: rustc::ty::maps::TyCtxtAt::mir_shims\r\n  20: rustc::ty::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::instance_mir\r\n  21: rustc_trans::collector::collect_items_rec\r\n  22: rustc_trans::collector::collect_items_rec\r\n  23: rustc_trans::collector::collect_items_rec\r\n  24: rustc_trans::collector::collect_items_rec\r\n  25: rustc_trans::collector::collect_items_rec\r\n  26: rustc_trans::base::collect_and_partition_translation_items::{{closure}}\r\n  27: rustc_trans::base::trans_crate\r\n  28: rustc_driver::driver::phase_4_translate_to_llvm\r\n  29: rustc_driver::driver::compile_input::{{closure}}\r\n  30: rustc::ty::context::TyCtxt::create_and_enter\r\n  31: rustc_driver::driver::compile_input\r\n  32: rustc_driver::run_compiler\r\n\r\nerror: Could not compile `foo`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name foo src/main.rs --crate-type bin --emit=dep-info,link -C debuginfo=2 -C metadata=68d8605c99341a0a -C extra-filename=-68d8605c99341a0a --out-dir /home/manuel/tmp/await-bug/target/debug/deps -L dependency=/home/manuel/tmp/await-bug/target/debug/deps --extern futures_await=/home/manuel/tmp/await-bug/target/debug/deps/libfutures_await-5aec48bc7b80f434.rlib` (exit code: 101)\r\n\r\n```\r\n\r\nNote, however, that if I use `Err((b, _))` in the match statement instead of `Err((b, _e))` the compilation succeeds.\r\n\r\nIf you need any other information to fix this issue, please let me know!", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/44543/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/44543/timeline", "performed_via_github_app": null, "state_reason": "completed"}