{"url": "https://api.github.com/repos/rust-lang/rust/issues/40738", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/40738/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/40738/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/40738/events", "html_url": "https://github.com/rust-lang/rust/issues/40738", "id": 216139890, "node_id": "MDU6SXNzdWUyMTYxMzk4OTA=", "number": 40738, "title": "RefCell::borrow_mut codegen broken on ARM", "user": {"login": "krdln", "id": 3074996, "node_id": "MDQ6VXNlcjMwNzQ5OTY=", "avatar_url": "https://avatars.githubusercontent.com/u/3074996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/krdln", "html_url": "https://github.com/krdln", "followers_url": "https://api.github.com/users/krdln/followers", "following_url": "https://api.github.com/users/krdln/following{/other_user}", "gists_url": "https://api.github.com/users/krdln/gists{/gist_id}", "starred_url": "https://api.github.com/users/krdln/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/krdln/subscriptions", "organizations_url": "https://api.github.com/users/krdln/orgs", "repos_url": "https://api.github.com/users/krdln/repos", "events_url": "https://api.github.com/users/krdln/events{/privacy}", "received_events_url": "https://api.github.com/users/krdln/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2017-03-22T17:02:30Z", "updated_at": "2017-03-22T17:30:23Z", "closed_at": "2017-03-22T17:30:23Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I was trying to compile some programs on my `armv7l` machine and noticed that most programs using regex crate do panic. I've managed to narrow down the issue to a `RefCell::borrow_mut` call.\r\n\r\nTest program:\r\n\r\n```rust\r\nuse std::cell::RefCell;\r\nfn main() {\r\n    let cell = RefCell::new(1);\r\n    cell.borrow_mut();\r\n    cell.borrow_mut();\r\n}\r\n```\r\n\r\nVersions of Rust tested (installed using rustup, the exact toolchain is `nightly-armv7-unknown-linux-gnueabihf`, etc.):\r\n```sh\r\n> rustc +stable --version\r\nrustc 1.16.0 (30cf806ef 2017-03-10)\r\n> rustc +beta --version\r\nrustc 1.17.0-beta.2 (b7c276653 2017-03-20)\r\n> rustc +nightly --version\r\nrustc 1.17.0-nightly (cab4bff3d 2017-03-21)\r\n```\r\n\r\nThis program works correctly on stable, but on beta and nightly fails with the following backtrace:\r\n```\r\nthread 'main' panicked at 'already borrowed: BorrowMutError', /checkout/src/libcore/result.rs:859\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\nstack backtrace:\r\n   0: <core::result::Result<T, E>>::expect\r\n             at /checkout/src/libcore/result.rs:761\r\n   1: <core::cell::RefCell<T>>::borrow_mut\r\n             at /checkout/src/libcore/cell.rs:736\r\n   2: bm_test::main\r\n             at ./bm_test.rs:5\r\n```\r\nWhat's quite interesting is that **the error is not present when cross-compiling** from x86-64 to arm.\r\n\r\nI've checked the generated assembly, and found a suspicious difference. For this function:\r\n```rust\r\npub fn bm_once(cell: &RefCell<i32>) {\r\n    cell.borrow_mut();\r\n}\r\n```\r\nthe generated assembly on stable (`rustc -O`) (or when cross-compiling using any version) is:\r\n```asm\r\n\t.section\t.text._ZN9borrowmut7bm_once17h7c1ef392d62ede16E,\"ax\",%progbits\r\n\t.globl\tborrowmut::bm_once\r\n\t.p2align\t2\r\n\t.type\tborrowmut::bm_once,%function\r\nborrowmut::bm_once:\r\n\t.fnstart\r\n\tldr\tr1, [r0]\r\n\tcmp\tr1, #0\r\n\tmoveq\tr1, #0     // on beta: mvneq r1, #0\r\n\tstreq\tr1, [r0]\r\n\tbxeq\tlr\r\n\t.save\t{r11, lr}\r\n\tpush\t{r11, lr}\r\n\tbl\tcore::result::unwrap_failed\r\n.Lfunc_end2:\r\n\t.size\tborrowmut::bm_once, .Lfunc_end2-borrowmut::bm_once\r\n\t.fnend\r\n```\r\nThe wrong assembly for beta and nightly differs only by one instruction \u2013 `mvneq` instead of `moveq`.\r\n", "closed_by": {"login": "krdln", "id": 3074996, "node_id": "MDQ6VXNlcjMwNzQ5OTY=", "avatar_url": "https://avatars.githubusercontent.com/u/3074996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/krdln", "html_url": "https://github.com/krdln", "followers_url": "https://api.github.com/users/krdln/followers", "following_url": "https://api.github.com/users/krdln/following{/other_user}", "gists_url": "https://api.github.com/users/krdln/gists{/gist_id}", "starred_url": "https://api.github.com/users/krdln/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/krdln/subscriptions", "organizations_url": "https://api.github.com/users/krdln/orgs", "repos_url": "https://api.github.com/users/krdln/repos", "events_url": "https://api.github.com/users/krdln/events{/privacy}", "received_events_url": "https://api.github.com/users/krdln/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/40738/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/40738/timeline", "performed_via_github_app": null, "state_reason": "completed"}