{"url": "https://api.github.com/repos/rust-lang/rust/issues/83184", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/83184/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/83184/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/83184/events", "html_url": "https://github.com/rust-lang/rust/issues/83184", "id": 832412528, "node_id": "MDU6SXNzdWU4MzI0MTI1Mjg=", "number": 83184, "title": "compiletest SRC_DIR rewriting mishandles symlinks to other disks", "user": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 120005, "node_id": "MDU6TGFiZWwxMjAwMDU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-testsuite", "name": "A-testsuite", "color": "f7e101", "default": false, "description": "Area: The testsuite used to check the correctness of rustc"}, {"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2345380158, "node_id": "MDU6TGFiZWwyMzQ1MzgwMTU4", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-contributor-roadblock", "name": "A-contributor-roadblock", "color": "f7e101", "default": false, "description": "Area: Makes things more difficult for new contributors to rust itself"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-03-16T05:02:03Z", "updated_at": "2023-04-05T17:30:31Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried this code:\r\n\r\n```\r\n% mount | grep /dev/[ns]\r\n/dev/nvme0n1p6 on / type ext4 (rw,noatime,errors=remount-ro)\r\ntmpfs on /dev/shm type tmpfs (rw,nosuid,nodev)\r\n/dev/nvme0n1p1 on /boot/efi type vfat (rw,relatime,fmask=0077,dmask=0077,codepage=437,iocharset=iso8859-1,shortname=mixed,errors=remount-ro)\r\n/dev/sda on /media/pnkfelix/Rust type ext4 (rw,nosuid,nodev,relatime,uhelper=udisks2)\r\n% pwd\r\n/home/pnkfelix/Dev/Rust/rust.git/objdir-opt\r\n% ls -ld /home/pnkfelix/Dev/Rust\r\nlrwxrwxrwx 1 pnkfelix pnkfelix 20 Mar  5 10:45 /home/pnkfelix/Dev/Rust -> /media/pnkfelix/Rust\r\n% ls\r\nbuild  config.toml  config.toml~  Makefile  tmp\r\n% diff ../config.toml.example ./config.toml\r\n% time python ../x.py build --stage 1 library/std && time python ../x.py test --stage 1\r\n[...]\r\n```\r\n\r\nIn particular, note that I've put my Rust stuff into a separate disk that is mounted beneath my personal home directory.\r\n\r\nThen, from the context of a path that, from the viewpoint of `pwd`, is under my home directory (but is physically on that separate disk), I ran our test suite.\r\n\r\nI expected to see this happen: A successful run, since my checkout is pristine.\r\n\r\nInstead, this happened: 125 of the ui tests failed. 11344 passed.\r\n\r\n<details>\r\n\r\n<summary>Click here for the Failure list</summary>\r\n\r\n```\r\nfailures:\r\n    [ui] ui/associated-type-bounds/bad-bounds-on-assoc-in-trait.rs\r\n    [ui] ui/associated-type-bounds/bounds-on-assoc-in-trait.rs\r\n    [ui] ui/associated-types/defaults-wf.rs\r\n    [ui] ui/associated-types/trait-with-supertraits-needing-sized-self.rs\r\n    [ui] ui/async-await/generator-desc.rs\r\n    [ui] ui/async-await/issue-72442.rs\r\n    [ui] ui/async-await/issues/issue-65159.rs\r\n    [ui] ui/bad/bad-sized.rs\r\n    [ui] ui/binop/binop-consume-args.rs\r\n    [ui] ui/binop/binop-move-semantics.rs\r\n    [ui] ui/binop/issue-77910-1.rs\r\n    [ui] ui/bound-suggestions.rs\r\n    [ui] ui/closures/closure-move-sync.rs\r\n    [ui] ui/codemap_tests/tab_3.rs\r\n    [ui] ui/const-generics/const-argument-if-length.rs#full\r\n    [ui] ui/const-generics/invalid-const-arg-for-type-param.rs\r\n    [ui] ui/const-generics/invalid-constant-in-args.rs\r\n    [ui] ui/const-ptr/out_of_bounds_read.rs\r\n    [ui] ui/consts/assume-type-intrinsics.rs\r\n    [ui] ui/consts/const-eval/unwind-abort.rs\r\n    [ui] ui/consts/const-unwrap.rs\r\n    [ui] ui/consts/const_unsafe_unreachable_ub.rs\r\n    [ui] ui/consts/miri_unleashed/drop.rs\r\n    [ui] ui/consts/offset_from_ub.rs\r\n    [ui] ui/consts/offset_ub.rs\r\n    [ui] ui/consts/ptr_comparisons.rs\r\n    [ui] ui/copy-a-resource.rs\r\n    [ui] ui/derives/derive-assoc-type-not-impl.rs\r\n    [ui] ui/derives/derives-span-Eq-enum-struct-variant.rs\r\n    [ui] ui/derives/derives-span-Eq-enum.rs\r\n    [ui] ui/derives/derives-span-Eq-struct.rs\r\n    [ui] ui/derives/derives-span-Eq-tuple-struct.rs\r\n    [ui] ui/derives/derives-span-Hash-enum-struct-variant.rs\r\n    [ui] ui/derives/derives-span-Hash-enum.rs\r\n    [ui] ui/derives/derives-span-Hash-struct.rs\r\n    [ui] ui/derives/derives-span-Hash-tuple-struct.rs\r\n    [ui] ui/derives/deriving-meta-unknown-trait.rs\r\n    [ui] ui/error-codes/E0004-2.rs\r\n    [ui] ui/error-codes/E0005.rs\r\n    [ui] ui/error-codes/E0297.rs\r\n    [ui] ui/feature-gates/feature-gate-associated_type_bounds.rs\r\n    [ui] ui/feature-gates/feature-gate-exhaustive-patterns.rs\r\n    [ui] ui/generator/sized-yield.rs\r\n    [ui] ui/generics/wrong-number-of-args.rs\r\n    [ui] ui/hygiene/panic-location.rs\r\n    [ui] ui/impl-trait/impl-generic-mismatch.rs\r\n    [ui] ui/imports/extern-prelude-extern-crate-restricted-shadowing.rs\r\n    [ui] ui/in-band-lifetimes/mismatched_trait_impl-2.rs\r\n    [ui] ui/interior-mutability/interior-mutability.rs\r\n    [ui] ui/issues/issue-14092.rs\r\n    [ui] ui/issues/issue-16939.rs\r\n    [ui] ui/issues/issue-17546.rs\r\n    [ui] ui/issues/issue-18423.rs\r\n    [ui] ui/issues/issue-20433.rs\r\n    [ui] ui/issues/issue-21160.rs\r\n    [ui] ui/issues/issue-23024.rs\r\n    [ui] ui/issues/issue-27033.rs\r\n    [ui] ui/issues/issue-2823.rs\r\n    [ui] ui/issues/issue-3044.rs\r\n    [ui] ui/issues/issue-31173.rs\r\n    [ui] ui/issues/issue-38857.rs\r\n    [ui] ui/issues/issue-59488.rs\r\n    [ui] ui/issues/issue-60283.rs\r\n    [ui] ui/issues/issue-61108.rs\r\n    [ui] ui/issues/issue-64559.rs\r\n    [ui] ui/issues/issue-69725.rs\r\n    [ui] ui/issues/issue-70724-add_type_neq_err_label-unwrap.rs\r\n    [ui] ui/issues/issue-7607-1.rs\r\n    [ui] ui/issues/issue-78720.rs\r\n    [ui] ui/limits/issue-55878.rs\r\n    [ui] ui/lint/lint-const-item-mutation.rs\r\n    [ui] ui/loops/issue-82916.rs\r\n    [ui] ui/macros/macro-name-typo.rs\r\n    [ui] ui/macros/macro-path-prelude-fail-3.rs\r\n    [ui] ui/macros/unknown-builtin.rs\r\n    [ui] ui/malformed/malformed-derive-entry.rs\r\n    [ui] ui/mir/issue-80742.rs\r\n    [ui] ui/mismatched_types/issue-36053-2.rs\r\n    [ui] ui/mismatched_types/issue-74918-missing-lifetime.rs\r\n    [ui] ui/mismatched_types/overloaded-calls-bad.rs\r\n    [ui] ui/moves/move-fn-self-receiver.rs\r\n    [ui] ui/moves/moves-based-on-type-access-to-field.rs\r\n    [ui] ui/moves/moves-based-on-type-exprs.rs\r\n    [ui] ui/no-capture-arc.rs\r\n    [ui] ui/no-reuse-move-arc.rs\r\n    [ui] ui/no-send-res-ports.rs\r\n    [ui] ui/non-copyable-void.rs\r\n    [ui] ui/noncopyable-class.rs\r\n    [ui] ui/parser/issue-62894.rs\r\n    [ui] ui/pattern/usefulness/match-arm-statics-2.rs\r\n    [ui] ui/pattern/usefulness/match-privately-empty.rs\r\n    [ui] ui/pattern/usefulness/non-exhaustive-match.rs\r\n    [ui] ui/proc-macro/parent-source-spans.rs\r\n    [ui] ui/proc-macro/resolve-error.rs\r\n    [ui] ui/range/range-1.rs\r\n    [ui] ui/recursion/issue-38591-non-regular-dropck-recursion.rs\r\n    [ui] ui/recursion/recursive-types-are-not-uninhabited.rs\r\n    [ui] ui/resolve/levenshtein.rs\r\n    [ui] ui/resolve/resolve-primitive-fallback.rs\r\n    [ui] ui/rfc-1937-termination-trait/termination-trait-test-wrong-type.rs\r\n    [ui] ui/stability-in-private-module.rs\r\n    [ui] ui/suggestions/attribute-typos.rs\r\n    [ui] ui/suggestions/borrow-for-loop-head.rs\r\n    [ui] ui/suggestions/do-not-attempt-to-add-suggestions-with-no-changes.rs\r\n    [ui] ui/suggestions/expected-boxed-future-isnt-pinned.rs\r\n    [ui] ui/suggestions/imm-ref-trait-object.rs\r\n    [ui] ui/suggestions/mut-borrow-needed-by-trait.rs\r\n    [ui] ui/suggestions/suggest-change-mut.rs\r\n    [ui] ui/traits/alias/object-fail.rs\r\n    [ui] ui/traits/associated_type_bound/assoc_type_bound_with_struct.rs\r\n    [ui] ui/traits/mutual-recursion-issue-75860.rs\r\n    [ui] ui/traits/negative-impls/explicitly-unimplemented-error-message.rs\r\n    [ui] ui/traits/suggest-deferences/issue-39029.rs\r\n    [ui] ui/traits/suggest-where-clause.rs\r\n    [ui] ui/type/ascription/issue-34255-1.rs\r\n    [ui] ui/type/type-ascription-instead-of-initializer.rs\r\n    [ui] ui/type_length_limit.rs\r\n    [ui] ui/typeck/typeck-builtin-bound-type-parameters.rs\r\n    [ui] ui/uninhabited/uninhabited-matches-feature-gated.rs\r\n    [ui] ui/union/union-derive-clone.rs\r\n    [ui] ui/union/union-derive-eq.rs\r\n    [ui] ui/unique-object-noncopyable.rs\r\n    [ui] ui/unique-pinned-nocopy.rs\r\n    [ui] ui/unop-move-semantics.rs\r\n    [ui] ui/wf/wf-impl-self-type.rs\r\n```\r\n\r\n</details>\r\n\r\nThe errors all original with problems when compiletest diffs the actual vs expected stder, with compiletest complaining about paths that should have been normalized to SRC_DIR but were not.\r\n\r\n<details>\r\n\r\n<summary>Example here</summary>\r\n\r\n```\r\n---- [ui] ui/associated-type-bounds/bounds-on-assoc-in-trait.rs stdout ----\r\ndiff of stderr:\r\n\r\n4       LL |     type A: Iterator<Item: Debug>;\r\n5          |                            ^^^^^ `<<Self as Case1>::A as Iterator>::Item` cannot be formatted using `{:?}` because it doesn't implement `Debug`\r\n6          |\r\n-         ::: $SRC_DIR/core/src/fmt/mod.rs:LL:COL\r\n+         ::: /media/pnkfelix/Rust/rust.git/library/core/src/fmt/mod.rs:550:1\r\n8          |\r\n9       LL | pub trait Debug {\r\n10         | --------------- required by this bound in `Debug`\r\n\r\n21      LL | pub trait Foo { type Out: Baz<Assoc: Default>; }\r\n22         |                                      ^^^^^^^ the trait `Default` is not implemented for `<<Self as Foo>::Out as Baz>::Assoc`\r\n23         |\r\n-         ::: $SRC_DIR/core/src/default.rs:LL:COL\r\n+         ::: /media/pnkfelix/Rust/rust.git/library/core/src/default.rs:85:1\r\n25         |\r\n26      LL | pub trait Default: Sized {\r\n27         | ------------------------ required by this bound in `Default`\r\n\r\n\r\nThe actual stderr differed from the expected stderr.\r\nActual stderr saved to /media/pnkfelix/Rust/rust.git/objdir-opt/build/x86_64-unknown-linux-gnu/test/ui/associated-type-bounds/bounds-on-assoc-in-trait/bounds-on-assoc-in-trait.stderr\r\n```\r\n\r\n</details>\r\n\r\n\r\n(This may well be a case of \"Q: Doctor, it hurts when I do that. A: Well, don't do that.\" But it wasn't easy for me to see what was going on when I encountered it, and so I thought it warranted a bug.)\r\n\r\nI think the real heart of the problem might be more evident when one sees the concrete output itself for a test:\r\n\r\n<details>\r\n\r\n<summary>Click here for concrete output</summary>\r\n\r\n```\r\nerror[E0277]: `<<Self as Case1>::A as Iterator>::Item` doesn't implement `Debug`\r\n  --> /home/pnkfelix/Dev/Rust/rust.git/src/test/ui/associated-type-bounds/bounds-on-assoc-in-trait.rs:18:28\r\n   |\r\nLL |     type A: Iterator<Item: Debug>;\r\n   |                            ^^^^^ `<<Self as Case1>::A as Iterator>::Item` cannot be formatted using `{:?}` because it doesn't implement `Debug`\r\n   |\r\n  ::: /media/pnkfelix/Rust/rust.git/library/core/src/fmt/mod.rs:550:1\r\n   |\r\nLL | pub trait Debug {\r\n   | --------------- required by this bound in `Debug`\r\n   |\r\n   = help: the trait `Debug` is not implemented for `<<Self as Case1>::A as Iterator>::Item`\r\nhelp: consider further restricting the associated type\r\n   |\r\nLL | trait Case1 where <<Self as Case1>::A as Iterator>::Item: Debug {\r\n   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\nerror[E0277]: the trait bound `<<Self as Foo>::Out as Baz>::Assoc: Default` is not satisfied\r\n  --> /home/pnkfelix/Dev/Rust/rust.git/src/test/ui/associated-type-bounds/bounds-on-assoc-in-trait.rs:35:38\r\n   |\r\nLL | pub trait Foo { type Out: Baz<Assoc: Default>; }\r\n   |                                      ^^^^^^^ the trait `Default` is not implemented for `<<Self as Foo>::Out as Baz>::Assoc`\r\n   |\r\n  ::: /media/pnkfelix/Rust/rust.git/library/core/src/default.rs:85:1\r\n   |\r\nLL | pub trait Default: Sized {\r\n   | ------------------------ required by this bound in `Default`\r\n   |\r\nhelp: consider further restricting the associated type\r\n   |\r\nLL | pub trait Foo where <<Self as Foo>::Out as Baz>::Assoc: Default { type Out: Baz<Assoc: Default>; }\r\n   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\nerror: aborting due to 2 previous errors\r\n\r\n```\r\n\r\n</details>\r\n\r\nNotably, the stderr output has a path with a prefix `/home/pnkfelix/Dev/Rust/` in some parts, but other diagnostics have `/media/pnkfelix/Rust/` for the prefix. That seems like an inconsistency we should try to resolve.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/83184/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 1}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/83184/timeline", "performed_via_github_app": null, "state_reason": null}