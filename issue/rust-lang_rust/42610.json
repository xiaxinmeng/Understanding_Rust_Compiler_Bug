{"url": "https://api.github.com/repos/rust-lang/rust/issues/42610", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/42610/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/42610/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/42610/events", "html_url": "https://github.com/rust-lang/rust/issues/42610", "id": 235332792, "node_id": "MDU6SXNzdWUyMzUzMzI3OTI=", "number": 42610, "title": "[1.19] Erratic (I/O?) behavior from release target that's non-existent in debug target", "user": {"login": "boxofrox", "id": 636691, "node_id": "MDQ6VXNlcjYzNjY5MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/636691?v=4", "gravatar_id": "", "url": "https://api.github.com/users/boxofrox", "html_url": "https://github.com/boxofrox", "followers_url": "https://api.github.com/users/boxofrox/followers", "following_url": "https://api.github.com/users/boxofrox/following{/other_user}", "gists_url": "https://api.github.com/users/boxofrox/gists{/gist_id}", "starred_url": "https://api.github.com/users/boxofrox/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/boxofrox/subscriptions", "organizations_url": "https://api.github.com/users/boxofrox/orgs", "repos_url": "https://api.github.com/users/boxofrox/repos", "events_url": "https://api.github.com/users/boxofrox/events{/privacy}", "received_events_url": "https://api.github.com/users/boxofrox/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 12, "created_at": "2017-06-12T18:57:46Z", "updated_at": "2017-06-19T15:12:55Z", "closed_at": "2017-06-19T01:50:06Z", "author_association": "NONE", "active_lock_reason": null, "body": "## Problem:\r\n\r\nI'm experiencing erratic behavior in my Rust project when I compile the release target binary that I don't experience at all with the debug target binary.  When I perform a database query using `tokio-rs` and the `mysql_async` library involving a result set with 100k+ rows, sometimes the results are acquired without issue, seldomly the program hangs (I presume waiting for I/O that arrived according to Wireshark on the same machine, but was lost), otherwise a \"Packet out of order\" error occurs in the MySQL protocol parser.\r\n\r\nI've created an SSCCE\\[[1](https://github.com/boxofrox/sscce-future-is-buggy-01)] to reproduce the issue.  The SCCEE includes much of the research I performed troubleshooting the issue.\r\n\r\nWhile the program runs the same query, the \"Packet out of order\" error occurs at random locations in the network stream.  As stated in the SSCCE readme\\[[2](https://github.com/boxofrox/sscce-future-is-buggy-01#how-i-know-this-isnt-a-networkdatabase-server-issue)], Wireshark confirms (to the best of my understanding) there is no data corruption from the MySQL server or network.\r\n\r\n\\[1]: https://github.com/boxofrox/sscce-future-is-buggy-01\r\n\\[2]: https://github.com/boxofrox/sscce-future-is-buggy-01#how-i-know-this-isnt-a-networkdatabase-server-issue\r\n\r\n## Expected Behavior:\r\n\r\nThe program should receive all query results and print \"done\" to the console.\r\n\r\n## Actual behavior:\r\n\r\nAt least one in tens times, a \"Packet out of order\" error occurs and interrupts the transfer, and invalidates the query.  Backtrace is provided further below.\r\n\r\n## Additional Notes:\r\n\r\nI've run this SSCCE 355 times with the debug target with no errors whatsoever.  When I run the release target, I find the \"Packet out of order\" error upwards of 40% of the time.  This seems like an optimization bug to me, and I fear I lack the experience to track this down.\r\n\r\nI considered there may be buffer corruption somewhere, particularly with the `std::collections::VecDeque` ring buffer used by `mysql_async` to buffer data before parsing MySQL packets.  Perhaps the buffer head wraps around, laps the tail, and overwrites to-be-used data?  However, I can't reconcile the notion that the slower debug target should have trouble reading the TCP buffer down to zero bytes and move on to parsing before the next network packet arrives, and yet it runs fine.\r\n\r\n## Meta:\r\n\r\n```\r\n\u25b6 rustup run nightly rustc --version --verbose\r\nrustc 1.19.0-nightly (f062832b2 2017-06-07)\r\nbinary: rustc\r\ncommit-hash: f062832b208e94f2f0f26ed7fb5c48c172069fbe\r\ncommit-date: 2017-06-07\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.19.0-nightly\r\nLLVM version: 4.0\r\n```\r\n\r\n### Backtrace:\r\n\r\nI reformatted the backtrace to make it easier to read.\r\n\r\n```\r\n\u25b6 DSN=mysql://testbot:testbot@192.168.70.162/fake_data RUST_BACKTRACE=1 RUST_LOG=bug_test_01=debug target/release/bug-test-01\r\nDEBUG:bug_test_01: running\r\nthread 'main' panicked at 'error resolving future:\r\n  Error ( Msg(\"error resolving future\")\r\n        , State { next_error: Some ( Error ( PacketOutOfOrder\r\n                                           , State { next_error: None\r\n                                                   , backtrace: Some ( stack backtrace:\r\n\r\n   0:     0x5573abad9c2e - backtrace::backtrace::libunwind::trace\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.2/src/backtrace/libunwind.rs:53\r\n                         - backtrace::backtrace::trace<closure>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.2/src/backtrace/mod.rs:42\r\n   1:     0x5573abad9d73 - backtrace::capture::{{impl}}::new\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.2/src/capture.rs:64\r\n   2:     0x5573aba6b916 - error_chain::make_backtrace\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/error-chain-0.10.0/src/lib.rs:417\r\n   3:     0x5573aba6b9bd - error_chain::{{impl}}::default\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/error-chain-0.10.0/src/lib.rs:504\r\n   4:     0x5573aba59739 - mysql_async::errors::{{impl}}::from_kind\r\n                        at /home/boxofrox/files/development/phreebooks-search/work/bugs/001 - spurious packet out of order/bug-test-01/<error_chain_processed macros>:52\r\n                         - mysql_async::errors::{{impl}}::from\r\n                        at /home/boxofrox/files/development/phreebooks-search/work/bugs/001 - spurious packet out of order/bug-test-01/<error_chain_processed macros>:8\r\n                         - core::convert::{{impl}}::into<mysql_async::errors::ErrorKind,mysql_async::errors::Error>\r\n                        at /checkout/src/libcore/convert.rs:398\r\n                         - mysql_async::conn::futures::read_packet::{{impl}}::poll\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/mysql_async-0.9.3/src/conn/futures/read_packet.rs:49\r\n   5:     0x5573aba572b0 - mysql_async::conn::futures::query_result::{{impl}}::either_poll<mysql_async::conn::futures::query_result::TextResult>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/mysql_async-0.9.3/src/conn/futures/query_result/mod.rs:202\r\n   6:     0x5573aba58505 - mysql_async::conn::futures::query_result::{{impl}}::poll<mysql_async::conn::futures::query_result::TextResult>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/mysql_async-0.9.3/src/conn/futures/query_result/mod.rs:220\r\n   7:     0x5573aba5926c - mysql_async::conn::futures::query_result::{{impl}}::poll\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/mysql_async-0.9.3/src/conn/futures/query_result/mod.rs:433\r\n   8:     0x5573aba2d348 - mysql_async::conn::futures::query_result::futures::drop_result::{{impl}}::poll<mysql_async::conn::futures::query_result::TextQueryResult>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/mysql_async-0.9.3/src/conn/futures/query_result/futures/drop_result.rs:37\r\n   9:     0x5573aba2dea7 - futures::future::chain::{{impl}}::poll<futures::future::and_then::AndThen<mysql_async::conn::pool::futures::get_conn::GetConn, mysql_async::conn::futures::query::Query, closure>,mysql_async::conn::futures::query_result::futures::drop_result::DropResult<mysql_async::conn::futures::query_result::TextQueryResult>,closure,closure>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.14/src/future/chain.rs:32\r\n                         - futures::future::and_then::{{impl}}::poll<futures::future::and_then::AndThen<mysql_async::conn::pool::futures::get_conn::GetConn, mysql_async::conn::futures::query::Query, closure>,mysql_async::conn::futures::query_result::futures::drop_result::DropResult<mysql_async::conn::futures::query_result::TextQueryResult>,closure>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.14/src/future/and_then.rs:32\r\n                         - futures::task_impl::std::{{impl}}::poll_future::{{closure}}<futures::future::and_then::AndThen<futures::future::and_then::AndThen<mysql_async::conn::pool::futures::get_conn::GetConn, mysql_async::conn::futures::query::Query, closure>, mysql_async::conn::futures::query_result::futures::drop_result::DropResult<mysql_async::conn::futures::query_result::TextQueryResult>, closure>>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.14/src/task_impl/std/mod.rs:242\r\n                         - futures::task_impl::{{impl}}::enter::{{closure}}<futures::future::and_then::AndThen<futures::future::and_then::AndThen<mysql_async::conn::pool::futures::get_conn::GetConn, mysql_async::conn::futures::query::Query, closure>, mysql_async::conn::futures::query_result::futures::drop_result::DropResult<mysql_async::conn::futures::query_result::TextQueryResult>, closure>,closure,core::result::Result<futures::poll::Async<mysql_async::conn::Conn>, mysql_async::errors::Error>>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.14/src/task_impl/mod.rs:352\r\n  10:     0x5573aba373de - futures::task_impl::std::set<closure,core::result::Result<futures::poll::Async<mysql_async::conn::Conn>, mysql_async::errors::Error>>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.14/src/task_impl/std/mod.rs:90\r\n                         - futures::task_impl::{{impl}}::enter<futures::future::and_then::AndThen<futures::future::and_then::AndThen<mysql_async::conn::pool::futures::get_conn::GetConn, mysql_async::conn::futures::query::Query, closure>, mysql_async::conn::futures::query_result::futures::drop_result::DropResult<mysql_async::conn::futures::query_result::TextQueryResult>, closure>,closure,core::result::Result<futures::poll::Async<mysql_async::conn::Conn>, mysql_async::errors::Error>>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.14/src/task_impl/mod.rs:352\r\n                         - futures::task_impl::std::{{impl}}::poll_future<futures::future::and_then::AndThen<futures::future::and_then::AndThen<mysql_async::conn::pool::futures::get_conn::GetConn, mysql_async::conn::futures::query::Query, closure>, mysql_async::conn::futures::query_result::futures::drop_result::DropResult<mysql_async::conn::futures::query_result::TextQueryResult>, closure>>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.14/src/task_impl/std/mod.rs:242\r\n                         - tokio_core::reactor::{{impl}}::run::{{closure}}<futures::future::and_then::AndThen<futures::future::and_then::AndThen<mysql_async::conn::pool::futures::get_conn::GetConn, mysql_async::conn::futures::query::Query, closure>, mysql_async::conn::futures::query_result::futures::drop_result::DropResult<mysql_async::conn::futures::query_result::TextQueryResult>, closure>>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-core-0.1.7/src/reactor/mod.rs:243\r\n                         - scoped_tls::{{impl}}::set<tokio_core::reactor::Core,closure,core::result::Result<futures::poll::Async<mysql_async::conn::Conn>, mysql_async::errors::Error>>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-0.1.0/src/lib.rs:135\r\n                         - tokio_core::reactor::{{impl}}::run<futures::future::and_then::AndThen<futures::future::and_then::AndThen<mysql_async::conn::pool::futures::get_conn::GetConn, mysql_async::conn::futures::query::Query, closure>, mysql_async::conn::futures::query_result::futures::drop_result::DropResult<mysql_async::conn::futures::query_result::TextQueryResult>, closure>>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-core-0.1.7/src/reactor/mod.rs:242\r\n                         - bug_test_01::main\r\n                        at src/main.rs:37\r\n  11:     0x5573abafce1a - panic_unwind::__rust_maybe_catch_panic\r\n                        at /checkout/src/libpanic_unwind/lib.rs:98\r\n  12:     0x5573abaf6518 - std::panicking::try<(),closure>\r\n                        at /checkout/src/libstd/panicking.rs:433\r\n                         - std::panic::catch_unwind<closure,()>\r\n                        at /checkout/src/libstd/panic.rs:361\r\n                         - std::rt::lang_start\r\n                        at /checkout/src/libstd/rt.rs:59\r\n  13:     0x7f0081732439 - __libc_start_main\r\n  14:     0x5573aba2d209 - _start\r\n  15:                0x0 - <unknown>\r\n\r\n                                                                     ) // end Some\r\n                                                   } // end State\r\n                                           ) // end Error\r\n                                   ) // end Some\r\n                , backtrace: Some ( stack backtrace:\r\n\r\n   0:     0x5573abad9c2e - backtrace::backtrace::libunwind::trace\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.2/src/backtrace/libunwind.rs:53\r\n                         - backtrace::backtrace::trace<closure>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.2/src/backtrace/mod.rs:42\r\n   1:     0x5573abad9d73 - backtrace::capture::{{impl}}::new\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.2/src/capture.rs:64\r\n   2:     0x5573aba6b916 - error_chain::make_backtrace\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/error-chain-0.10.0/src/lib.rs:417\r\n   3:     0x5573aba37652 - core::ops::FnOnce::call_once<fn() -> core::option::Option<alloc::arc::Arc<backtrace::capture::Backtrace>>,()>\r\n                        at /checkout/src/libcore/ops.rs:2683\r\n                         - core::option::{{impl}}::or_else<alloc::arc::Arc<backtrace::capture::Backtrace>,fn() -> core::option::Option<alloc::arc::Arc<backtrace::capture::Backtrace>>>\r\n                        at /checkout/src/libcore/option.rs:658\r\n                         - error_chain::{{impl}}::new<bug_test_01::Error>\r\n                        at /home/boxofrox/.cargo/registry/src/github.com-1ecc6299db9ec823/error-chain-0.10.0/src/lib.rs:518\r\n                         - bug_test_01::{{impl}}::chain_err::{{closure}}<mysql_async::conn::Conn,mysql_async::errors::Error,closure,&str>\r\n                        at /home/boxofrox/files/development/phreebooks-search/work/bugs/001 - spurious packet out of order/bug-test-01/<error_chain_processed macros>:131\r\n                         - core::result::{{impl}}::map_err<mysql_async::conn::Conn,mysql_async::errors::Error,bug_test_01::Error,closure>\r\n                        at /checkout/src/libcore/result.rs:487\r\n                         - bug_test_01::{{impl}}::chain_err<mysql_async::conn::Conn,mysql_async::errors::Error,closure,&str>\r\n                        at /home/boxofrox/files/development/phreebooks-search/work/bugs/001 - spurious packet out of order/bug-test-01/<error_chain_processed macros>:129\r\n                         - bug_test_01::main\r\n                        at src/main.rs:37\r\n   4:     0x5573abafce1a - panic_unwind::__rust_maybe_catch_panic\r\n                        at /checkout/src/libpanic_unwind/lib.rs:98\r\n   5:     0x5573abaf6518 - std::panicking::try<(),closure>\r\n                        at /checkout/src/libstd/panicking.rs:433\r\n                         - std::panic::catch_unwind<closure,()>\r\n                        at /checkout/src/libstd/panic.rs:361\r\n                         - std::rt::lang_start\r\n                        at /checkout/src/libstd/rt.rs:59\r\n   6:     0x7f0081732439 - __libc_start_main\r\n   7:     0x5573aba2d209 - _start\r\n   8:                0x0 - <unknown>\r\n\r\n                                  ) // Some\r\n                } // end State\r\n        )', /checkout/src/libcore/result.rs:860\r\n\r\nstack backtrace:\r\n   0: std::sys::imp::backtrace::tracing::imp::unwind_backtrace\r\n             at /checkout/src/libstd/sys/unix/backtrace/tracing/gcc_s.rs:49\r\n   1: std::sys_common::backtrace::_print\r\n             at /checkout/src/libstd/sys_common/backtrace.rs:71\r\n   2: std::panicking::default_hook::{{closure}}\r\n             at /checkout/src/libstd/sys_common/backtrace.rs:60\r\n             at /checkout/src/libstd/panicking.rs:355\r\n   3: std::panicking::default_hook\r\n             at /checkout/src/libstd/panicking.rs:371\r\n   4: std::panicking::rust_panic_with_hook\r\n             at /checkout/src/libstd/panicking.rs:549\r\n   5: std::panicking::begin_panic\r\n             at /checkout/src/libstd/panicking.rs:511\r\n   6: std::panicking::begin_panic_fmt\r\n             at /checkout/src/libstd/panicking.rs:495\r\n   7: rust_begin_unwind\r\n             at /checkout/src/libstd/panicking.rs:471\r\n   8: core::panicking::panic_fmt\r\n             at /checkout/src/libcore/panicking.rs:69\r\n   9: core::result::unwrap_failed\r\n             at /checkout/src/libcore/macros.rs:29\r\n  10: bug_test_01::main\r\n             at /checkout/src/libcore/result.rs:762\r\n             at src/main.rs:37\r\n  11: __rust_maybe_catch_panic\r\n             at /checkout/src/libpanic_unwind/lib.rs:98\r\n  12: std::rt::lang_start\r\n             at /checkout/src/libstd/panicking.rs:433\r\n             at /checkout/src/libstd/panic.rs:361\r\n             at /checkout/src/libstd/rt.rs:59\r\n  13: __libc_start_main\r\n  14: _start\r\n```", "closed_by": {"login": "boxofrox", "id": 636691, "node_id": "MDQ6VXNlcjYzNjY5MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/636691?v=4", "gravatar_id": "", "url": "https://api.github.com/users/boxofrox", "html_url": "https://github.com/boxofrox", "followers_url": "https://api.github.com/users/boxofrox/followers", "following_url": "https://api.github.com/users/boxofrox/following{/other_user}", "gists_url": "https://api.github.com/users/boxofrox/gists{/gist_id}", "starred_url": "https://api.github.com/users/boxofrox/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/boxofrox/subscriptions", "organizations_url": "https://api.github.com/users/boxofrox/orgs", "repos_url": "https://api.github.com/users/boxofrox/repos", "events_url": "https://api.github.com/users/boxofrox/events{/privacy}", "received_events_url": "https://api.github.com/users/boxofrox/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/42610/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/42610/timeline", "performed_via_github_app": null, "state_reason": "completed"}