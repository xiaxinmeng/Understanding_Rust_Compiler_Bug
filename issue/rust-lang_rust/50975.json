{"url": "https://api.github.com/repos/rust-lang/rust/issues/50975", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/50975/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/50975/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/50975/events", "html_url": "https://github.com/rust-lang/rust/issues/50975", "id": 325404619, "node_id": "MDU6SXNzdWUzMjU0MDQ2MTk=", "number": 50975, "title": "Elf Segment Assumptions cause segfaults", "user": {"login": "tomrittervg", "id": 163497, "node_id": "MDQ6VXNlcjE2MzQ5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/163497?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tomrittervg", "html_url": "https://github.com/tomrittervg", "followers_url": "https://api.github.com/users/tomrittervg/followers", "following_url": "https://api.github.com/users/tomrittervg/following{/other_user}", "gists_url": "https://api.github.com/users/tomrittervg/gists{/gist_id}", "starred_url": "https://api.github.com/users/tomrittervg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tomrittervg/subscriptions", "organizations_url": "https://api.github.com/users/tomrittervg/orgs", "repos_url": "https://api.github.com/users/tomrittervg/repos", "events_url": "https://api.github.com/users/tomrittervg/events{/privacy}", "received_events_url": "https://api.github.com/users/tomrittervg/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-05-22T18:04:38Z", "updated_at": "2018-05-28T16:31:49Z", "closed_at": "2018-05-28T16:31:49Z", "author_association": "NONE", "active_lock_reason": null, "body": "I'm not sure exactly where; but somewhere in rust there seems to be an assumption about the ELF format and when I break it (which I'm trying to do to make elfhack work on lld: https://bugzilla.mozilla.org/show_bug.cgi?id=1423822 ) I get segfaults.\r\n\r\nI'm compiling with clang, using lld as the linker. Here's a simple reproducer that occurs because I offset the second segment 0xF0 bytes from the first PHDR segment.\r\n\r\n```\r\nroot@bca724986ba7:~/myworkspace/build/rust # cat main.rs\r\nfn main() {}\r\n\r\nroot@bca724986ba7:~/myworkspace/build/rust # cat padding.ld\r\nSECTIONS\r\n{\r\n  . = SEGMENT_START(\"text-segment\", 0) + SIZEOF_HEADERS + 0xF0;\r\n}\r\n\r\nroot@bca724986ba7:~/myworkspace/build/rust # cat ./cargo-linker\r\n#!/bin/sh\r\n\r\neval ${MOZ_CARGO_WRAP_LD} ${MOZ_CARGO_WRAP_LDFLAGS} '\"$@\"'\r\n\r\n# Minimal reproducer\r\n\r\nroot@bca724986ba7:~/myworkspace/build/rust # MOZ_CARGO_WRAP_LD=clang MOZ_CARGO_WRAP_LDFLAGS=\"-lpthread -fuse-ld=lld -flto=thin -Wl,-T,./padding.ld -Wl,-z,noexecstack -Wl,-z,text -Wl,-z,relro -Wl,--build-id\" /builds/worker/myworkspace/build/src/rustc/bin/rustc -C linker=./cargo-linker main.rs\r\n\r\nroot@bca724986ba7:~/myworkspace/build/rust # ./main\r\nSegmentation fault (core dumped)\r\n139\r\n\r\n# Remove the padding script:\r\n\r\nroot@bca724986ba7:~/myworkspace/build/rust # MOZ_CARGO_WRAP_LD=clang MOZ_CARGO_WRAP_LDFLAGS=\"-lpthread -fuse-ld=lld -flto=thin  -Wl,-z,noexecstack -Wl,-z,text -Wl,-z,relro -Wl,--build-id\" /builds/worker/myworkspace/build/src/rustc/bin/rustc -C linker=./cargo-linker main.rs\r\n\r\nroot@bca724986ba7:~/myworkspace/build/rust # ./main\r\n(no error)\r\n```\r\n\r\n\r\nI have a second reproducer that's considerably more difficult to reproduce, it involves patching clang to not output the PHDR segment. ", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/50975/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/50975/timeline", "performed_via_github_app": null, "state_reason": "completed"}