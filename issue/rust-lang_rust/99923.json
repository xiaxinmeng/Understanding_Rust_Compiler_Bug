{"url": "https://api.github.com/repos/rust-lang/rust/issues/99923", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/99923/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/99923/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/99923/events", "html_url": "https://github.com/rust-lang/rust/issues/99923", "id": 1322688522, "node_id": "I_kwDOAAsO6M5O1qAK", "number": 99923, "title": "Regression in consteval: error[E0080]: could not evaluate static initializer (unable to turn pointer into raw bytes)", "user": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252628, "node_id": "MDU6TGFiZWwyNjIyNTI2Mjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-beta", "name": "regression-from-stable-to-beta", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to beta."}, {"id": 900795185, "node_id": "MDU6TGFiZWw5MDA3OTUxODU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-const-eval", "name": "A-const-eval", "color": "f7e101", "default": false, "description": "Area: constant evaluation (mir interpretation)"}, {"id": 1966877457, "node_id": "MDU6TGFiZWwxOTY2ODc3NDU3", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-critical", "name": "P-critical", "color": "eb6420", "default": false, "description": "Critical priority"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/rust-lang/rust/milestones/95", "html_url": "https://github.com/rust-lang/rust/milestone/95", "labels_url": "https://api.github.com/repos/rust-lang/rust/milestones/95/labels", "id": 8127235, "node_id": "MI_kwDOAAsO6M4AfAMD", "number": 95, "title": "1.64.0", "description": null, "creator": {"login": "rustbot", "id": 47979223, "node_id": "MDQ6VXNlcjQ3OTc5MjIz", "avatar_url": "https://avatars.githubusercontent.com/u/47979223?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rustbot", "html_url": "https://github.com/rustbot", "followers_url": "https://api.github.com/users/rustbot/followers", "following_url": "https://api.github.com/users/rustbot/following{/other_user}", "gists_url": "https://api.github.com/users/rustbot/gists{/gist_id}", "starred_url": "https://api.github.com/users/rustbot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rustbot/subscriptions", "organizations_url": "https://api.github.com/users/rustbot/orgs", "repos_url": "https://api.github.com/users/rustbot/repos", "events_url": "https://api.github.com/users/rustbot/events{/privacy}", "received_events_url": "https://api.github.com/users/rustbot/received_events", "type": "User", "site_admin": false}, "open_issues": 2, "closed_issues": 857, "state": "closed", "created_at": "2022-06-25T02:07:59Z", "updated_at": "2022-11-09T16:13:06Z", "due_on": null, "closed_at": "2022-10-03T13:56:33Z"}, "comments": 56, "created_at": "2022-07-29T21:24:14Z", "updated_at": "2022-09-21T18:40:46Z", "closed_at": "2022-09-21T18:40:09Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Unfortunately I'm not able to come up with a minimal working example for this, but running `cargo check -p icu_datetime --examples` on https://github.com/unicode-org/icu4x (commit https://github.com/unicode-org/icu4x/commit/021a92e43a07f4178d97fd48ba509fb72164fa14 should be fine)\r\n\r\nends up throwing a ton of errors that look like this:\r\n\r\n```\r\n    Checking icu_testdata v0.6.0 (/home/manishearth/dev/icu4x/provider/testdata)\r\nerror[E0080]: could not evaluate static initializer\r\n   --> /home/manishearth/dev/icu4x/utils/zerovec/src/zerovec/mod.rs:260:14\r\n    |\r\n260 |           let (data, mut metadata): (usize, usize) = core::mem::transmute(bytes);\r\n    |                ^^^^\r\n    |                |\r\n    |                unable to turn pointer into raw bytes\r\n    |                inside `ZeroVec::<(EraStartDate, tinystr::ascii::TinyAsciiStr<16>)>::from_bytes_unchecked` at /home/manishearth/dev/icu4x/utils/zerovec/src/zerovec/mod.rs:260:14\r\n    |\r\n   ::: /home/manishearth/dev/icu4x/provider/testdata/data/baked/calendar/japanese_v1_u_ca.rs:11:9\r\n    |\r\n11  | /         ::zerovec::ZeroVec::from_bytes_unchecked(&[\r\n12  | |             76u8, 7u8, 0u8, 0u8, 9u8, 8u8, 109u8, 101u8, 105u8, 106u8, 105u8, 0u8, 0u8, 0u8, 0u8,\r\n13  | |             0u8, 0u8, 0u8, 0u8, 0u8, 0u8, 0u8, 120u8, 7u8, 0u8, 0u8, 7u8, 30u8, 116u8, 97u8, 105u8,\r\n14  | |             115u8, 104u8, 111u8, 0u8, 0u8, 0u8, 0u8, 0u8, 0u8, 0u8, 0u8, 0u8, 0u8, 134u8, 7u8, 0u8,\r\n...   |\r\n19  | |             0u8, 0u8,\r\n20  | |         ])\r\n    | |__________- inside `japanese_v1_u_ca::UND_U_CA_JAPANESE` at /home/manishearth/dev/icu4x/provider/testdata/data/baked/calendar/japanese_v1_u_ca.rs:11:9\r\n```\r\n\r\n([full errors](https://gist.github.com/Manishearth/2b456dafe64bf5c860f5571f239556fe); they're long since the \"baked\" stuff is a bunch of internationalization data that has been \"serialized\" to Rust code using https://docs.rs/databake)\r\n\r\nWe have a lot of consteval using unsafe code, which is what's tripping up here. The code that's breaking is code that's currently manually constructing a DST of `&[T::ULE]` from `&[u8]`, and in a `const` environment that requires some pointer manipulation:\r\n\r\n```rust\r\n    pub const unsafe fn from_bytes_unchecked(bytes: &'a [u8]) -> Self {\r\n        // &[u8] and &[T::ULE] are the same slice with different length metadata.\r\n        let (data, mut metadata): (usize, usize) = core::mem::transmute(bytes);\r\n        metadata /= core::mem::size_of::<T::ULE>();\r\n        Self::Borrowed(core::mem::transmute((data, metadata)))\r\n    }\r\n```\r\n\r\nBisecting the regression points to https://github.com/rust-lang/rust/pull/97684 (cc @oli-obk, @RalfJung), which seems to be about integer provenance. The code here isn't ideal; there are slightly better ways to do this but nothing is `const`, so this is what we've got.\r\n\r\n\r\nEither way, this is a regression.\r\n\r\n\r\n## Bisection:\r\n\r\nsearched nightlies: from nightly-2022-06-01 to nightly-2022-06-30\r\nregressed nightly: nightly-2022-06-07\r\nsearched commit range: https://github.com/rust-lang/rust/compare/fee3a459dd6aba8e34a5b99f0fbcb4218a1e2401...50b00252aeb77b10db04d65dc9e12ce758def4b5\r\nregressed commit: https://github.com/rust-lang/rust/commit/9d20fd109809f20c049d6895a5be27a1fbd39daa\r\n\r\n<details>\r\n<summary>bisected with <a href='https://github.com/rust-lang/cargo-bisect-rustc'>cargo-bisect-rustc</a> v0.6.3</summary>\r\n\r\n\r\nHost triple: x86_64-unknown-linux-gnu\r\nReproduce with:\r\n```bash\r\ncargo bisect-rustc --start=2022-06-01 --end=2022-06-30 --script=./test.sh \r\n```\r\n", "closed_by": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/99923/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/99923/timeline", "performed_via_github_app": null, "state_reason": "completed"}