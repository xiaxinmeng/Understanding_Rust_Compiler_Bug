{"url": "https://api.github.com/repos/rust-lang/rust/issues/59246", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/59246/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/59246/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/59246/events", "html_url": "https://github.com/rust-lang/rust/issues/59246", "id": 421870613, "node_id": "MDU6SXNzdWU0MjE4NzA2MTM=", "number": 59246, "title": "Rust-gdb print different integer value after add optimization flag", "user": {"login": "yuanboli233", "id": 48196348, "node_id": "MDQ6VXNlcjQ4MTk2MzQ4", "avatar_url": "https://avatars.githubusercontent.com/u/48196348?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yuanboli233", "html_url": "https://github.com/yuanboli233", "followers_url": "https://api.github.com/users/yuanboli233/followers", "following_url": "https://api.github.com/users/yuanboli233/following{/other_user}", "gists_url": "https://api.github.com/users/yuanboli233/gists{/gist_id}", "starred_url": "https://api.github.com/users/yuanboli233/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yuanboli233/subscriptions", "organizations_url": "https://api.github.com/users/yuanboli233/orgs", "repos_url": "https://api.github.com/users/yuanboli233/repos", "events_url": "https://api.github.com/users/yuanboli233/events{/privacy}", "received_events_url": "https://api.github.com/users/yuanboli233/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 203130, "node_id": "MDU6TGFiZWwyMDMxMzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-debuginfo", "name": "A-debuginfo", "color": "f7e101", "default": false, "description": "Area: Debugging information in compiled programs (DWARF, PDB, etc.)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 289259951, "node_id": "MDU6TGFiZWwyODkyNTk5NTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-help-wanted", "name": "E-help-wanted", "color": "02E10C", "default": false, "description": "Call for participation: Help is requested to fix this issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2019-03-17T01:23:44Z", "updated_at": "2023-01-07T06:43:47Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "The issue is related to the #59149, but I think this issue post presents the problem much clearer.\r\n\r\nThe rust-gdb debugger give incorrect value for optimization level 1 for the following \"main.rs\".\r\n```\r\nybli@xxx:$ cat main.rs \r\nfn tmp() {\r\n    println!(\" \");    \r\n}\r\nfn main() {\r\n    let mut counter = 0;\r\n    {\r\n        let mut tick = || counter += 1;\r\n        tick();\r\n        tick();\r\n        tmp();\r\n    }\r\n    assert_eq!(counter, 2);\r\n}\r\n```\r\n\r\nRust-gdb will give different value for variable \"counter\" at the line \"tmp();\". For opt-level=0, it shows the variable has value 2; for opt-level=1, it shows the variable has value 0. Noticing that the program does not complain in the assert statement later, it seems that the program pass the wrong debugging information to the debugger.\r\n\r\nopt-level=0:\r\n```\r\nybli@xxx: $ rustc -g -C opt-level=0 main.rs \r\nybli@xxx: $ rust-gdb ./main\r\nGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.5) 7.11.1\r\n[...... (omit some gdb description here)]\r\nReading symbols from ./main...done.\r\n(gdb) b main.rs:10\r\nBreakpoint 1 at 0x610d: file main.rs, line 10.\r\n(gdb) r\r\nStarting program: /home/ybli/Projects/tmp/experiment/main \r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\r\n\r\nBreakpoint 1, main::main::hfe98083a4c87500f () at main.rs:10\r\n10\t        tmp();\r\n(gdb) p counter\r\n$1 = 2\r\n```\r\n\r\nopt-level=1:\r\n```\r\nybli@xxx:$ rustc -g -C opt-level=1 main.rs \r\nybli@xxx:$ rust-gdb ./main\r\nGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.5) 7.11.1\r\n[...... (omit some gdb description here)]\r\nReading symbols from ./main...done.\r\n(gdb) b main.rs:10\r\nBreakpoint 1 at 0x6050: file main.rs, line 10.\r\n(gdb) r\r\nStarting program: /home/ybli/Projects/tmp/experiment/main \r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\r\n\r\nBreakpoint 1, main::main::hfe98083a4c87500f () at main.rs:10\r\n10\t        tmp();\r\n(gdb) p counter\r\n$1 = 0\r\n```\r\n\r\n## Meta\r\n```\r\nybli@xxx:$ rustc --version --verbose\r\nrustc 1.35.0-nightly (9d71ec135 2019-03-10)\r\nbinary: rustc\r\ncommit-hash: 9d71ec1358ac063fe6ff1eaed0ba6ed3cedde610\r\ncommit-date: 2019-03-10\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.35.0-nightly\r\nLLVM version: 8.0\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/59246/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/59246/timeline", "performed_via_github_app": null, "state_reason": null}