{"url": "https://api.github.com/repos/rust-lang/rust/issues/22702", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/22702/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/22702/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/22702/events", "html_url": "https://github.com/rust-lang/rust/issues/22702", "id": 58556143, "node_id": "MDU6SXNzdWU1ODU1NjE0Mw==", "number": 22702, "title": "Crashes on periodic timers", "user": {"login": "vhbit", "id": 140199, "node_id": "MDQ6VXNlcjE0MDE5OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/140199?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vhbit", "html_url": "https://github.com/vhbit", "followers_url": "https://api.github.com/users/vhbit/followers", "following_url": "https://api.github.com/users/vhbit/following{/other_user}", "gists_url": "https://api.github.com/users/vhbit/gists{/gist_id}", "starred_url": "https://api.github.com/users/vhbit/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vhbit/subscriptions", "organizations_url": "https://api.github.com/users/vhbit/orgs", "repos_url": "https://api.github.com/users/vhbit/repos", "events_url": "https://api.github.com/users/vhbit/events{/privacy}", "received_events_url": "https://api.github.com/users/vhbit/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 55302148, "node_id": "MDU6TGFiZWw1NTMwMjE0OA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-x86_64", "name": "O-x86_64", "color": "6e6ec0", "default": false, "description": "Target: x64 processors"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2015-02-23T08:24:15Z", "updated_at": "2016-01-08T06:10:13Z", "closed_at": "2016-01-08T06:10:13Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I have rare but regular crashes while using periodic timers, here are a couple of stacktraces:\n## Sample 1\n\nThread 1 - crashed thread (timer helper)\n\n```\n0  syncpoint                      0x0000000100181604 sync::mpsc::Sender$LT$T$GT$::send::h16650001638270525609\n1  syncpoint                      0x000000010018c628 sys::timer::helper::signal::hab3153c68321ad88HcF\n2  syncpoint                      0x000000010018c628 sys::timer::helper::signal::hab3153c68321ad88HcF\n3  syncpoint                      0x000000010018783c sys::timer::helper::hdac220bc3f730824MaF\n```\n## Sample 2\n\nThread 1 - crashed thread\n\n```\n0  syncpoint                      0x00000001001d30bc sync::mpsc::stream::Packet$LT$T$GT$::send::h1567901069159111330\n1  syncpoint                      0x00000001001d3284 sync::mpsc::stream::Packet$LT$T$GT$::send::h1567901069159111330\n2  syncpoint                      0x00000001001d1df4 sys_common::helper_thread::Helper$LT$M$GT$::send::h11186096963694568971\n3  syncpoint                      0x00000001001c4410 io::timer::Timer::periodic::h21d0a7b80a1b161f5Tg\n```\n\nThread 2 (timer helper)\n\n```\n0  libsystem_kernel.dylib         0x000000019447b498 __select + 8\n1  syncpoint                      0x00000001001c9074 sys::timer::helper::h0574e0739f8f1c6d6Kw\n```\n## Sample 3\n\nThread 1 - crashed thread\n\n```\n0  syncpoint                      0x00000001001e9bdc sync::mpsc::stream::Packet$LT$T$GT$::send::h12172527083798108928\n1  syncpoint                      0x00000001001e9b6c sync::mpsc::stream::Packet$LT$T$GT$::send::h12172527083798108928\n2  syncpoint                      0x00000001001e847c sys_common::helper_thread::Helper$LT$M$GT$::send::h3499295349918654522\n3  syncpoint                      0x00000001001e6ee4 sys::timer::Timer::inner::h199f8c41d26dfeaaDoF\n4  syncpoint                      0x00000001001d7b90 sys::timer::Timer.Drop::drop::h28078e5d8eac0274jpF\n```\n\nThread 2 (timer helper)\n\n```\n0  libsystem_kernel.dylib         0x000000019387f498 __select + 8\n1  syncpoint                      0x00000001001df824 sys::timer::helper::hdac220bc3f730824MaF\n```\n\nThe most interesting thing is that I can't reproduce it on i386/armv7, crashes happen only on aarch64 devices. \n\nConsidering `Packet.send` is defined as:\n\n``` rust\n    pub fn send(&mut self, t: T) -> Result<(), T> {\n        // If the other port has deterministically gone away, then definitely\n        // must return the data back up the stack. Otherwise, the data is\n        // considered as being sent.\n        if self.port_dropped.load(Ordering::SeqCst) { return Err(t) }\n\n        match self.do_send(Data(t)) {\n            UpSuccess | UpDisconnected => {},\n            UpWoke(token) => { token.signal(); }\n        }\n        Ok(())\n    }\n```\n\nit looks like crash point is inlined `self.port_dropped.load` call, which should be translated into intrinsic, which is weird. \n\nConsidering channels are used quite intensively in the app and have no other crashes other than in periodic timers, it seems the problem is actually related to timer + helper_thread communications, but so far I have no idea what exactly can go wrong.\n", "closed_by": {"login": "huonw", "id": 1203825, "node_id": "MDQ6VXNlcjEyMDM4MjU=", "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4", "gravatar_id": "", "url": "https://api.github.com/users/huonw", "html_url": "https://github.com/huonw", "followers_url": "https://api.github.com/users/huonw/followers", "following_url": "https://api.github.com/users/huonw/following{/other_user}", "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}", "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/huonw/subscriptions", "organizations_url": "https://api.github.com/users/huonw/orgs", "repos_url": "https://api.github.com/users/huonw/repos", "events_url": "https://api.github.com/users/huonw/events{/privacy}", "received_events_url": "https://api.github.com/users/huonw/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/22702/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/22702/timeline", "performed_via_github_app": null, "state_reason": "completed"}