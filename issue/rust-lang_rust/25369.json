{"url": "https://api.github.com/repos/rust-lang/rust/issues/25369", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/25369/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/25369/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/25369/events", "html_url": "https://github.com/rust-lang/rust/issues/25369", "id": 75975760, "node_id": "MDU6SXNzdWU3NTk3NTc2MA==", "number": 25369, "title": "Linking error on Windows when recreating a slice from raw parts", "user": {"login": "pcwiek", "id": 1394568, "node_id": "MDQ6VXNlcjEzOTQ1Njg=", "avatar_url": "https://avatars.githubusercontent.com/u/1394568?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwiek", "html_url": "https://github.com/pcwiek", "followers_url": "https://api.github.com/users/pcwiek/followers", "following_url": "https://api.github.com/users/pcwiek/following{/other_user}", "gists_url": "https://api.github.com/users/pcwiek/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwiek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwiek/subscriptions", "organizations_url": "https://api.github.com/users/pcwiek/orgs", "repos_url": "https://api.github.com/users/pcwiek/repos", "events_url": "https://api.github.com/users/pcwiek/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwiek/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2015-05-13T12:59:51Z", "updated_at": "2015-05-13T16:30:48Z", "closed_at": "2015-05-13T16:30:48Z", "author_association": "NONE", "active_lock_reason": null, "body": "### Background\n\nI wanted to expose a Rust library that would expose C-compatible API & ABI and would be used from C-like platform. What I need to do first is populate an array of structs.\n### Example\n\n```\nuse std::slice;\n\n#[repr(C)]\npub struct Item {\n    num: i32,\n    acc: i32,\n}\n\n#[no_mangle]\npub extern fn fill(arr: *mut Item, arr_size: i32) {\n    let arr = unsafe { slice::from_raw_parts_mut(arr, arr_size as usize) };\n\n    let mut sum = 0;\n\n    for (i, item) in arr.iter_mut().enumerate() {\n        item.num = (i + 1) as i32;\n        item.acc = {sum += item.num; sum};\n    }\n}\n```\n\nNow when I try to compile that using latest Rust 1.0.0-beta5, I get linking errors:\n\n> error: linking with gcc failed: exit code: 1 note: \"gcc\" \"-Wl,--enable-long-section-names\" \"-fno-use-linker-plugin\" \"-Wl,--nxcompat\" \"-Wl,--large-address-aware\" \"-shared-libgcc\" \"-L\" \"C:\\Rust\\bin\\rustlib\\i686-pc-windows-gnu\\lib\" \"-o\" \"C:\\Projects\\Personal\\ALR\\target\\debug\\ALR.dll\" \"C:\\Projects\\Personal\\ALR\\target\\debug\\ALR.o\" \"C:\\Projects\\Personal\\ALR\\target\\debug\\ALR.metadata.o\" \"C:\\Rust\\bin\\rustlib\\i686-pc-windows-gnu\\lib\\libstd-4e7c5e5c.rlib\" \"C:\\Rust\\bin\\rustlib\\i686-pc-windows-gnu\\lib\\libcollections-4e7c5e5c.rlib\" \"C:\\Rust\\bin\\rustlib\\i686-pc-windows-gnu\\lib\\libunicode-4e7c5e5c.rlib\" \"C:\\Rust\\bin\\rustlib\\i686-pc-windows-gnu\\lib\\librand-4e7c5e5c.rlib\" \"C:\\Rust\\bin\\rustlib\\i686-pc-windows-gnu\\lib\\liballoc-4e7c5e5c.rlib\" \"C:\\Rust\\bin\\rustlib\\i686-pc-windows-gnu\\lib\\liblibc-4e7c5e5c.rlib\" \"C:\\Rust\\bin\\rustlib\\i686-pc-windows-gnu\\lib\\libcore-4e7c5e5c.rlib\" \"-L\" \"C:\\Projects\\Personal\\ALR\\target\\debug\" \"-L\" \"C:\\Projects\\Personal\\ALR\\target\\debug\\deps\" \"-L\" \"C:\\Rust\\bin\\rustlib\\i686-pc-windows-gnu\\lib\" \"-L\" \"C:\\Projects\\Personal\\ALR\\src.rust\\bin\\i686-pc-windows-gnu\" \"-L\" \"C:\\Projects\\Personal\\ALR\\src\\bin\\i686-pc-windows-gnu\" \"-Wl,--whole-archive\" \"-Wl,-Bstatic\" \"-Wl,--no-whole-archive\" \"-Wl,-Bdynamic\" \"-lws2_32\" \"-luserenv\" \"-shared\" \"-lcompiler-rt\" \n> **note: \n> C:\\Rust\\bin\\rustlib\\i686-pc-windows-gnu\\lib\\libcore-4e7c5e5c.rlib(core-4e7c5e5c.o):(.text+0x3ab4): undefined reference to rust_begin_unwind' \n> C:\\Rust\\bin\\rustlib\\i686-pc-windows-gnu\\lib\\libcore-4e7c5e5c.rlib(core-4e7c5e5c.o):(.eh_frame+0x5c7f): undefined reference to rust_eh_personality'\n> ld: C:\\Rust\\bin\\rustlib\\i686-pc-windows-gnu\\lib\\libcore-4e7c5e5c.rlib(core-4e7c5e5c.o): bad reloc address 0x5c7f in section `.eh_frame'**\n\nIf I add empty println somewhere in the loop:\n\n```\nfor (i, item) in arr.iter_mut().enumerate() {\n    println!(\"\");    \n    item.num = (i + 1) as i32;\n    item.acc = {sum += item.num; sum};\n}\n```\n\nLinking actually works.\n\nUnfortunately, when using the DLL in the third party platform, I'm getting stack overflow exception in the library (?!). That only happens when working with arrays though (iterating over a slice created from raw array, for example), passing a singular C struct by reference works just fine.\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/25369/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/25369/timeline", "performed_via_github_app": null, "state_reason": "completed"}