{"url": "https://api.github.com/repos/rust-lang/rust/issues/45000", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/45000/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/45000/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/45000/events", "html_url": "https://github.com/rust-lang/rust/issues/45000", "id": 262410961, "node_id": "MDU6SXNzdWUyNjI0MTA5NjE=", "number": 45000, "title": "compiling for msp430 doesn't work with multiple codegen units", "user": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2017-10-03T12:37:37Z", "updated_at": "2017-10-13T11:34:22Z", "closed_at": "2017-10-13T11:34:21Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Background: For this target the LLVM backend doesn't support producing object files so we do something slightly different: rustc uses LLVM to produce an assembly file for each crate, then it calls `msp430-elf-gcc` to assemble that file into an object file and makes an rlib out of that.\r\n\r\nWith multiple codegen units we don't quite do the right thing right now because rustc produces N assembly files and then tries to create a single object file, with the wrong file path:\r\n\r\n``` console\r\n$ cp -r $(rustc --print sysroot)/lib/rustlib/src/rust/src/libcore .\r\n\r\n$ cd libcore\r\n\r\n# with 32 codegen units\r\n$ cargo build --target msp430-none-elf\r\n   Compiling core v0.0.0 (file:///home/japaric/tmp/libcore)\r\nerror: linking with `msp430-elf-gcc` failed: exit code: 1\r\n  |\r\n  = note: \"msp430-elf-gcc\" \"-mcpu=msp430\" \"-c\" \"-o\" \"/home/japaric/tmp/libcore/target/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.o\" \"/home/japaric/tmp/libcore/target/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.s\"\r\n  = note: msp430-elf-gcc: error: /home/japaric/tmp/libcore/target/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.s: No such file or directory\r\n          msp430-elf-gcc: fatal error: no input files\r\n          compilation terminated.\r\n\r\n$ ls target/msp430-none-elf/debug/deps/*.s\r\ntarget/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.0.s\r\ntarget/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.10.s\r\ntarget/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.11.s\r\ntarget/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.12.s\r\ntarget/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.13.s\r\ntarget/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.14.s\r\ntarget/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.15.s\r\ntarget/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.16.s\r\ntarget/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.17.s\r\ntarget/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.18.s\r\ntarget/msp430-none-elf/debug/deps/core-bac07e1e86186fd7.19.s\r\n(..)\r\n```\r\n\r\nTo support multiple codegen units rustc would have to invoke gcc once per assembly file. Which means calling it 32 times in this case. Thus increasing codegen units with this target is likely to slow down the build process.\r\n\r\nAlex suggested tweaking this particular target to use a single codegen unit; at least until the LLVM backend learns how to generate object files.\r\n\r\ncc @alexcrichton @pftbest \r\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/45000/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/45000/timeline", "performed_via_github_app": null, "state_reason": "completed"}