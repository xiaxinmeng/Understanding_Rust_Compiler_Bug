{"url": "https://api.github.com/repos/rust-lang/rust/issues/110897", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/110897/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/110897/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/110897/events", "html_url": "https://github.com/rust-lang/rust/issues/110897", "id": 1686833554, "node_id": "I_kwDOAAsO6M5kiwmS", "number": 110897, "title": "Tracking issue for cleaning up std's thread_local implementation details", "user": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37234, "node_id": "MDU6TGFiZWwzNzIzNA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-cleanup", "name": "C-cleanup", "color": "f5f1fd", "default": false, "description": "Category: PRs that clean code up or issues documenting cleanup."}, {"id": 632886930, "node_id": "MDU6TGFiZWw2MzI4ODY5MzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-thread-locals", "name": "A-thread-locals", "color": "f7e101", "default": false, "description": "Area: Thread local storage (TLS)"}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 13, "created_at": "2023-04-27T13:15:41Z", "updated_at": "2023-06-05T16:46:20Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "`std::thread_local`, `std::thread::local`, `std::thread::local_impl`, `std::sys_common::thread_local_key`, `std::sys_common::thread_local_dtor`, `std::sys::thread_local_key`, etc. etc. are all messy and form quite a confusing maze. Just look at this map I tried to draw of it all:\r\n\r\n![tlmap](https://user-images.githubusercontent.com/783247/234870944-1af910ef-81b7-4e7a-b748-e4212f86e2ca.jpg)\r\n\r\nAAAaaaaAaa\r\n\r\nTime to clean it up.\r\n\r\nAnd maybe also fix some bugs while we're at it. ^^\r\n\r\n---\r\n\r\n- [x] Initial name and module cleanup without touching implementation: https://github.com/rust-lang/rust/pull/110861\r\n- [x] Remove unused `Key` type: https://github.com/rust-lang/rust/pull/110898\r\n- [x] Fix panic-in-drop handling\r\n  - [x] https://github.com/rust-lang/rust/issues/112285\r\n    - [x] https://github.com/rust-lang/rust/pull/112292\r\n- [ ] Stop calling everything `Key`, because most of those things are actually not keys.\r\n- [ ] Use `*const T` rather than `&'static T` when it's not really `'static`.\r\n- [ ] Drop `LazyKeyInner`? (it's mostly just a `OnceCell` that lies about its lifetime)\r\n- [ ] Reduce the amount of unsafe code.\r\n- [ ] Reduce the amount of code in the `thread_local!{}` expansion.\r\n- [ ] Clean up implementation more\r\n  - ...?\r\n- [ ] Remove linux and mac specific code? https://github.com/rust-lang/rust/pull/109858\r\n- [ ] Make `THREAD_INFO` thread local more efficient? (It's just an Arc, can fit in a pointer directly without Boxing it.)\r\n- [ ] Store thread ID and stack guard range in thread locals without destructors (on platforms with `#[thread_local]`)?\r\n- [ ] ...?\r\n\r\nRelated issues to solve, maybe:\r\n\r\n- [ ] https://github.com/rust-lang/rust/issues/110708\r\n- [ ] https://github.com/rust-lang/rust/issues/111272\r\n  - ~~https://github.com/rust-lang/rust/issues/109785~~ \r\n- [ ] Maybe [this](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=06885c38ad9982ec799d012a26d92305) shouldn't work? See conversation around [this comment](https://github.com/rust-lang/rust/issues/110897#issuecomment-1525738849).\r\n- [ ] ...?", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/110897/reactions", "total_count": 11, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 11, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/110897/timeline", "performed_via_github_app": null, "state_reason": null}