{"url": "https://api.github.com/repos/rust-lang/rust/issues/47793", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/47793/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/47793/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/47793/events", "html_url": "https://github.com/rust-lang/rust/issues/47793", "id": 292079101, "node_id": "MDU6SXNzdWUyOTIwNzkxMDE=", "number": 47793, "title": "MIR: End-user description not implemented for field access on `TyGenerator...`.", "user": {"login": "thedodd", "id": 2380740, "node_id": "MDQ6VXNlcjIzODA3NDA=", "avatar_url": "https://avatars.githubusercontent.com/u/2380740?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thedodd", "html_url": "https://github.com/thedodd", "followers_url": "https://api.github.com/users/thedodd/followers", "following_url": "https://api.github.com/users/thedodd/following{/other_user}", "gists_url": "https://api.github.com/users/thedodd/gists{/gist_id}", "starred_url": "https://api.github.com/users/thedodd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thedodd/subscriptions", "organizations_url": "https://api.github.com/users/thedodd/orgs", "repos_url": "https://api.github.com/users/thedodd/repos", "events_url": "https://api.github.com/users/thedodd/events{/privacy}", "received_events_url": "https://api.github.com/users/thedodd/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 604489711, "node_id": "MDU6TGFiZWw2MDQ0ODk3MTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-NLL", "name": "A-NLL", "color": "f7e101", "default": false, "description": "Area: Non Lexical Lifetimes (NLL)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 679846574, "node_id": "MDU6TGFiZWw2Nzk4NDY1NzQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-generators", "name": "A-generators", "color": "f7e101", "default": false, "description": "Area: Generators"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2018-01-27T01:45:16Z", "updated_at": "2018-02-03T20:23:35Z", "closed_at": "2018-02-03T20:23:35Z", "author_association": "NONE", "active_lock_reason": null, "body": "Using nightly. Decent number of features enabled. Using `futures-await`. Attempting to use `map_err` on the result coming out of a call to `await!` seems to cause a panic.\r\n\r\n### code\r\n**Working code:**\r\n```rust\r\n    #[async]\r\n    fn _post(mut state: State) -> Result<(State, Response), (State, HandlerError)> {\r\n        let body_res = await!(Body::take_from(&mut state).concat2());\r\n        let body = match body_res {\r\n            Ok(body) => body.to_vec(),\r\n            Err(err) => {\r\n                return Err((state, err.into_handler_error()));\r\n            }\r\n        };\r\n\r\n        let res = create_response(&state, StatusCode::Ok, Some((body, mime::APPLICATION_JSON)));\r\n        Ok((state, res))\r\n    }\r\n```\r\n\r\n**Broken code:**\r\n```rust\r\n    #[async]\r\n    fn _post(mut state: State) -> Result<(State, Response), (State, HandlerError)> {\r\n        let body = await!(Body::take_from(&mut state).concat2())\r\n            .map(|chunks| chunks.to_vec())\r\n            .map_err(|err| (state, err.into_handler_error()))?;\r\n\r\n        let res = create_response(&state, StatusCode::Ok, Some((body, mime::APPLICATION_JSON)));\r\n        Ok((state, res))\r\n    }\r\n```\r\n\r\nLet me know if adding any additional type info here would be helpful.\r\n\r\n### expectations\r\nI expected to have the code successfully compile and be the same as the working code block.\r\n\r\nInstead, got a panic during compilation.\r\n\r\n### meta\r\n**Nightly features:**\r\n```rust\r\n#![feature(conservative_impl_trait, generators, nll, proc_macro, universal_impl_trait, use_nested_groups)]\r\n```\r\n\r\n**rustc info:**\r\n```\r\n$ rustc --version --verbose\r\nrustc 1.25.0-nightly (a0dcecff9 2018-01-24)\r\nbinary: rustc\r\ncommit-hash: a0dcecff90c45ad5d4eb60859e22bb3f1b03842a\r\ncommit-date: 2018-01-24\r\nhost: x86_64-apple-darwin\r\nrelease: 1.25.0-nightly\r\nLLVM version: 4.0\r\n```\r\n\r\n**Backtrace:**\r\n```\r\nerror: internal compiler error: librustc_mir/borrow_check/error_reporting.rs:762: End-user description not implemented for field access on `TyGenerator(DefId(0/1:49 ~ gateway_service[ace7]::service[0]::{{impl}}[0]::_post[0]::{{closure}}[0]), ClosureSubsts { substs: Slice([futures::Async<futures::__rt::Mu>, std::result::Result<(gotham::state::State, hyper::Response), (gotham::state::State, gotham::handler::HandlerError)>, gotham::state::State]) }, GeneratorInterior { witness: {futures::stream::Concat2<hyper::Body>, futures::Async<futures::__rt::Mu>, (), std::vec::Vec<u8>, std::result::Result<(gotham::state::State, hyper::Response), (gotham::state::State, gotham::handler::HandlerError)>}, movable: true })`\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: rustc 1.25.0-nightly (a0dcecff9 2018-01-24) running on x86_64-apple-darwin\r\n\r\nnote: run with `RUST_BACKTRACE=1` for a backtrace\r\n\r\nthread 'rustc' panicked at 'Box<Any>', librustc_errors/lib.rs:509:9\r\nstack backtrace:\r\n   0:        0x10a383eab - std::sys::unix::backtrace::tracing::imp::unwind_backtrace::ha9efc95a1760cacd\r\n   1:        0x10a390044 - std::sys_common::backtrace::print::hf5c8aa5eb53db16a\r\n   2:        0x10a3836e0 - std::panicking::default_hook::{{closure}}::hdce9608c60053b8f\r\n   3:        0x10a3833e3 - std::panicking::default_hook::hba09553cc28730a2\r\n   4:        0x10a383b66 - std::panicking::rust_panic_with_hook::h3639511a0c7cb848\r\n   5:        0x1063bcbfa - std::panicking::begin_panic::h635ae642d665c620\r\n   6:        0x1063d287c - rustc_errors::Handler::bug::hbe64a18383da6dc4\r\n   7:        0x1091c39cb - <std::thread::local::LocalKey<T>>::with::h541fcea574b37332\r\n   8:        0x109665bd5 - rustc::ty::context::tls::with_opt::hcf7b444f3a2040d7\r\n   9:        0x109248f37 - rustc::session::opt_span_bug_fmt::h78c03a1ab5eaf5a1\r\n  10:        0x109248e01 - rustc::session::bug_fmt::h3fe1e243a47291cd\r\n  11:        0x1055c8ea1 - rustc_mir::borrow_check::error_reporting::<impl rustc_mir::borrow_check::MirBorrowckCtxt<'cx, 'gcx, 'tcx>>::describe_field_from_ty::h49a8c174a0cb9b6c\r\n  12:        0x1055c8a2a - rustc_mir::borrow_check::error_reporting::<impl rustc_mir::borrow_check::MirBorrowckCtxt<'cx, 'gcx, 'tcx>>::describe_field::h78965fd178f95d79\r\n  13:        0x1055c8404 - rustc_mir::borrow_check::error_reporting::<impl rustc_mir::borrow_check::MirBorrowckCtxt<'cx, 'gcx, 'tcx>>::append_place_to_string::h8f79ea72234925a0\r\n  14:        0x1055c5c7c - rustc_mir::borrow_check::error_reporting::<impl rustc_mir::borrow_check::MirBorrowckCtxt<'cx, 'gcx, 'tcx>>::report_use_of_moved_or_uninitialized::hc1998dae45d582c0\r\n  15:        0x1055d12b4 - rustc_mir::borrow_check::MirBorrowckCtxt::check_if_path_is_moved::h6b5e4bc029599395\r\n  16:        0x1055ce35f - <rustc_mir::borrow_check::MirBorrowckCtxt<'cx, 'gcx, 'tcx> as rustc_mir::dataflow::DataflowResultsConsumer<'cx, 'tcx>>::visit_statement_entry::h62ebb1b4fffdcc55\r\n  17:        0x1055cd67d - rustc_mir::borrow_check::do_mir_borrowck::hc1e7f5ca4c20578f\r\n  18:        0x1055efc9b - rustc::ty::context::tls::enter::h1443e4f51080c1ab\r\n  19:        0x10567c795 - rustc::infer::InferCtxtBuilder::enter::h3665c5dd412e5fd6\r\n  20:        0x1055cc726 - rustc_mir::borrow_check::mir_borrowck::h5a5cf133637a758c\r\n  21:        0x10942b303 - rustc::ty::maps::<impl rustc::ty::maps::queries::mir_borrowck<'tcx>>::compute_result::h8ce26d29167e8c3d\r\n  22:        0x109500e96 - rustc::dep_graph::graph::DepGraph::with_task_impl::h92c13dbcd115d438\r\n  23:        0x1091aa3be - rustc_errors::Handler::track_diagnostics::hc789be56ee0e16d2\r\n  24:        0x109059cc3 - rustc::ty::maps::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::cycle_check::h62b3bfc64dcc5416\r\n  25:        0x10942b394 - rustc::ty::maps::<impl rustc::ty::maps::queries::mir_borrowck<'tcx>>::force::h8f25e18a8c999fcc\r\n  26:        0x109145fd9 - rustc::ty::maps::plumbing::force_from_dep_node::hd09e3b3c2deab39c\r\n  27:        0x10952885f - rustc::dep_graph::graph::DepGraph::try_mark_green::hd9972ee6c4efc24b\r\n  28:        0x109090eb2 - rustc::ty::maps::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_mark_green_and_read::ha976c0deb96cdb31\r\n  29:        0x10941c4df - rustc::ty::maps::<impl rustc::ty::maps::queries::optimized_mir<'tcx>>::try_get::h74325177e7bc3dde\r\n  30:        0x1095935e0 - rustc::ty::maps::TyCtxtAt::optimized_mir::he2f762eeb346da9e\r\n  31:        0x109585033 - rustc::ty::sty::ClosureSubsts::field_tys::ha48451c7a027a51d\r\n  32:        0x1056db3ea - rustc_mir::borrow_check::nll::type_check::TypeChecker::typeck_mir::hc7ad7a734db20202\r\n  33:        0x1056d180d - rustc_mir::borrow_check::nll::type_check::type_check_internal::h518be4c3ad2ff3e9\r\n  34:        0x1055f0faf - rustc::ty::context::tls::enter::h4236a27145a73016\r\n  35:        0x10567c87f - rustc::infer::InferCtxtBuilder::enter::h600f468bc4789a28\r\n  36:        0x1056de262 - <rustc_mir::borrow_check::nll::type_check::TypeckMir as rustc_mir::transform::MirPass>::run_pass::hadea65a31f93be35\r\n  37:        0x1055e6c29 - rustc_mir::transform::mir_const::{{closure}}::h02e1b3b2b7d7b18f\r\n  38:        0x1055e3fe8 - rustc_mir::transform::mir_const::hcc025ad467878db2\r\n  39:        0x10941958b - rustc::ty::maps::<impl rustc::ty::maps::queries::mir_const<'tcx>>::compute_result::hbd8b9fd9e305d39f\r\n  40:        0x1095146d7 - rustc::dep_graph::graph::DepGraph::with_task_impl::hee66bf436686dd4d\r\n  41:        0x1091a72a9 - rustc_errors::Handler::track_diagnostics::hb5f11d2f9ffb02ae\r\n  42:        0x109081070 - rustc::ty::maps::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::cycle_check::hd8ac9f49c4833a46\r\n  43:        0x109419617 - rustc::ty::maps::<impl rustc::ty::maps::queries::mir_const<'tcx>>::force::h9d74c11776eebafb\r\n  44:        0x109419d3c - rustc::ty::maps::<impl rustc::ty::maps::queries::mir_const<'tcx>>::try_get::h04568e10b15c7ebb\r\n  45:        0x109593400 - rustc::ty::maps::TyCtxtAt::mir_const::hd2755156a7dbf95d\r\n  46:        0x1090a10a3 - rustc::ty::maps::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'lcx>>::mir_const::h927c411a4f7efbe1\r\n  47:        0x1055e41c2 - rustc_mir::transform::mir_validated::h94b6df5bcb6c3001\r\n  48:        0x10941aa6b - rustc::ty::maps::<impl rustc::ty::maps::queries::mir_validated<'tcx>>::compute_result::hfe06032d6b01c5d6\r\n  49:        0x1095146d7 - rustc::dep_graph::graph::DepGraph::with_task_impl::hee66bf436686dd4d\r\n  50:        0x109194709 - rustc_errors::Handler::track_diagnostics::h6906f37a714bb65d\r\n  51:        0x109063140 - rustc::ty::maps::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::cycle_check::h82a8367f44bba970\r\n  52:        0x10941aaf7 - rustc::ty::maps::<impl rustc::ty::maps::queries::mir_validated<'tcx>>::force::ha7aa7d5f7e14a50f\r\n  53:        0x10941b21c - rustc::ty::maps::<impl rustc::ty::maps::queries::mir_validated<'tcx>>::try_get::h1ac5c2c13a2a5e42\r\n  54:        0x1095934f0 - rustc::ty::maps::TyCtxtAt::mir_validated::hab2b7cdf300d8bf0\r\n  55:        0x1090a10d3 - rustc::ty::maps::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'lcx>>::mir_validated::he7d8147885139b09\r\n  56:        0x1054b0e4b - rustc_borrowck::borrowck::borrowck::hb6f9751697f3d9f3\r\n  57:        0x10950d7e7 - rustc::dep_graph::graph::DepGraph::with_task_impl::hc5e17307633b35cd\r\n  58:        0x109181f09 - rustc_errors::Handler::track_diagnostics::h1a92dd5f67bcfba5\r\n  59:        0x10906cbb0 - rustc::ty::maps::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::cycle_check::h9ecc5cf53eea6ba4\r\n  60:        0x109429bc7 - rustc::ty::maps::<impl rustc::ty::maps::queries::borrowck<'tcx>>::force::h903403cccee498b4\r\n  61:        0x10942a2ba - rustc::ty::maps::<impl rustc::ty::maps::queries::borrowck<'tcx>>::try_get::h576007b4b6c14f04\r\n  62:        0x109593f42 - rustc::ty::maps::TyCtxtAt::borrowck::hd0c291eb8466ca41\r\n  63:        0x1090a1313 - rustc::ty::maps::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'lcx>>::borrowck::h5cd5e26d06dfab2e\r\n  64:        0x1054b0bc1 - rustc_borrowck::borrowck::check_crate::h000dc470c6e4e6db\r\n  65:        0x103f6fb98 - <std::thread::local::LocalKey<T>>::with::hc97c0f695fc47a37\r\n  66:        0x103f6d1ec - <std::thread::local::LocalKey<T>>::with::h5232c8db13d095a5\r\n  67:        0x103f9b3e3 - rustc_driver::driver::compile_input::h13c6388277ea77a3\r\n  68:        0x103fac17c - rustc_driver::run_compiler::hebc5d6e3e17d092c\r\n  69:        0x103f2a2d1 - std::sys_common::backtrace::__rust_begin_short_backtrace::he16271a6bff11c29\r\n  70:        0x10a3b2fbe - __rust_maybe_catch_panic\r\n  71:        0x103ededdd - <F as alloc::boxed::FnBox<A>>::call_box::h838126c6997c937c\r\n  72:        0x10a392a67 - std::sys_common::thread::start_thread::hee6a12d8ac7037fd\r\n  73:        0x10a39eda8 - std::sys::unix::thread::Thread::new::thread_start::hca6ddd0e0fdf932d\r\n  74:     0x7fff6b51d6c0 - _pthread_body\r\n  75:     0x7fff6b51d56c - _pthread_start\r\n```", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/47793/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/47793/timeline", "performed_via_github_app": null, "state_reason": "completed"}