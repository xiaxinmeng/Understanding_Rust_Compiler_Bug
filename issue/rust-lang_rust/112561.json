{"url": "https://api.github.com/repos/rust-lang/rust/issues/112561", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/112561/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/112561/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/112561/events", "html_url": "https://github.com/rust-lang/rust/issues/112561", "id": 1753035716, "node_id": "I_kwDOAAsO6M5ofTPE", "number": 112561, "title": "Manually running CI jobs `dist-various-{1,2}` complains about missing `metrics.json`", "user": {"login": "pjhades", "id": 1171455, "node_id": "MDQ6VXNlcjExNzE0NTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1171455?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pjhades", "html_url": "https://github.com/pjhades", "followers_url": "https://api.github.com/users/pjhades/followers", "following_url": "https://api.github.com/users/pjhades/following{/other_user}", "gists_url": "https://api.github.com/users/pjhades/gists{/gist_id}", "starred_url": "https://api.github.com/users/pjhades/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pjhades/subscriptions", "organizations_url": "https://api.github.com/users/pjhades/orgs", "repos_url": "https://api.github.com/users/pjhades/repos", "events_url": "https://api.github.com/users/pjhades/events{/privacy}", "received_events_url": "https://api.github.com/users/pjhades/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 593503757, "node_id": "MDU6TGFiZWw1OTM1MDM3NTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-infra", "name": "T-infra", "color": "bfd4f2", "default": false, "description": "Relevant to the infrastructure team, which will review and decide on the PR/issue."}, {"id": 2345380158, "node_id": "MDU6TGFiZWwyMzQ1MzgwMTU4", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-contributor-roadblock", "name": "A-contributor-roadblock", "color": "f7e101", "default": false, "description": "Area: Makes things more difficult for new contributors to rust itself"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2023-06-12T15:39:17Z", "updated_at": "2023-06-14T10:33:43Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I ran the CI jobs `dist-various-{1,2}` manually by editing `src/ci/github-actions/ci.yml` but the jobs [failed](https://github.com/rust-lang/rust/pull/111626#issuecomment-1575622889) with the following error:\r\n```\r\ncp: cannot stat 'obj/build/metrics.json': No such file or directory\r\n```\r\nHowever I didn't touch anything on metrics. If I understand correctly, the cause of this error is:\r\n- Build metrics were not enabled, because `GITHUB_REF=refs/pull/111626/merge` was defined in the environment, according to [this logic](https://github.com/rust-lang/rust/blob/master/src/ci/run.sh#L50-L54).\r\n- Build artifacts were asked to be uploaded, because `DEPLOY=1` was defined in the environment, according to [this logic](https://github.com/rust-lang/rust/blob/master/.github/workflows/ci.yml#L151).\r\n\r\nI only ran `dist-various-{1,2}` but I _guess_ that if other `dist-*` jobs are run manually, the same error would happen, because these jobs would have `DEPLOY=1` or `DEPLOY_ALT=1` but metrics would not be enabled as `GITHUB_REF` would be `refs/pull/<PULL_REQUEST_ID>/merge`.\r\n\r\nI think this is somewhat confusing to people who want to use CI to test their PRs, because without this error their PRs could have passed the CI. I'm not sure what would be a good fix for this, maybe we could define an environment variable when build metrics are enabled, and check this variable [before we fetch `metrics.json`](https://github.com/rust-lang/rust/blob/master/src/ci/scripts/upload-artifacts.sh#L29). Or at least the problem could be mentioned in the [document](https://rustc-dev-guide.rust-lang.org/tests/ci.html).", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/112561/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/112561/timeline", "performed_via_github_app": null, "state_reason": null}