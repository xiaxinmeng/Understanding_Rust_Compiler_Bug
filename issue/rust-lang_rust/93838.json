{"url": "https://api.github.com/repos/rust-lang/rust/issues/93838", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/93838/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/93838/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/93838/events", "html_url": "https://github.com/rust-lang/rust/issues/93838", "id": 1129167108, "node_id": "I_kwDOAAsO6M5DTbkE", "number": 93838, "title": "Stabilize guaranteed compile time evaluation of unnamed constant items", "user": {"login": "XrXr", "id": 6457510, "node_id": "MDQ6VXNlcjY0NTc1MTA=", "avatar_url": "https://avatars.githubusercontent.com/u/6457510?v=4", "gravatar_id": "", "url": "https://api.github.com/users/XrXr", "html_url": "https://github.com/XrXr", "followers_url": "https://api.github.com/users/XrXr/followers", "following_url": "https://api.github.com/users/XrXr/following{/other_user}", "gists_url": "https://api.github.com/users/XrXr/gists{/gist_id}", "starred_url": "https://api.github.com/users/XrXr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/XrXr/subscriptions", "organizations_url": "https://api.github.com/users/XrXr/orgs", "repos_url": "https://api.github.com/users/XrXr/repos", "events_url": "https://api.github.com/users/XrXr/events{/privacy}", "received_events_url": "https://api.github.com/users/XrXr/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668019, "node_id": "MDU6TGFiZWwyMTE2NjgwMTk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-lang", "name": "T-lang", "color": "bfd4f2", "default": false, "description": "Relevant to the language team, which will review and decide on the PR/issue."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 10, "created_at": "2022-02-09T23:14:24Z", "updated_at": "2023-03-15T20:51:23Z", "closed_at": "2023-03-15T20:51:23Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "This is a request to stabilize the implementation fact that the definition of [unnamed constant items] are always evaluated at compile time (through [CTFE]). There is no associated RFC as this feature is already available in stable releases and this is mostly a request for using an [FCP] to reach consensus for future support.\r\n\r\nThe [stabilization][const panic stabilization] of `const-panic` introduced a way for CTFE to emit hard compile errors. This allows users to perform compile time assertions using familiar language constructs and a growing set of `const` APIs. Before `const-panic`, users could emit the `const_err` lint, which was less dependable since whether lints fail builds is configurable.\r\n\r\nAuthors of compile time assertions that utilize `const-panic` would probably like to have confidence that what they wrote is in fact evaluated by `rustc` during compilation. Currently, users can ensure evaluation by utilizing const contexts that are inputs to the type checker:\r\n\r\n```rust\r\nconst _: [(); panic!(\"custom error\")] = [];\r\n```\r\n\r\nThis trick relies on the fact that type checking is guaranteed to happen during compilation. Utilizing this to initiate constant evaluation feels more cumbersome than necessary.\r\n\r\nThis report aims to stabilize a more obvious way to initiate compile time evaluation.\r\n\r\n## What is being stabilized\r\n\r\nThe current `rustc` behavior that unnamed constant definitions are evaluated at least once at compile time. Note that compile time evaluation happens even when the function enclosing the unnamed constant is unused:\r\n\r\n```rust\r\nfn unused() {\r\n    const _: () = panic!(\"always a compile error\");\r\n}\r\n```\r\n\r\nStabilizing this seems unlikely to cause maintenance issues in the future due to the constrained nature of unnamed constants. However, I defer to people with `rustc` maintenance experience to judge this claim.\r\n\r\n## What is _not_ being stabilized\r\n\r\nThe evaluation timing of named constant items. Named constant items can be associated constants, which could use generics. Unnamed constants [cannot be associated constants][unnamed constant items] and [cannot use generic parameters][outer func error playground]. While it might be useful to also stabilize the evaluation timing of named constant items, they require more consideration and are out of scope for this report.\r\n\r\n---\r\n\r\nI would like to thank Ralf Jung, Oli Scherer, and Eric Huss for the generous amount of guidance I received. Here is the Zulip [discussion][zulip] leading up to this stabilization request.\r\n\r\n[const panic stabilization]: https://blog.rust-lang.org/2021/12/02/Rust-1.57.0.html#panic-in-const-contexts\r\n[unnamed constant items]: https://doc.rust-lang.org/stable/reference/items/constant-items.html#unnamed-constant\r\n[constant evaluation]: https://doc.rust-lang.org/stable/reference/const_eval.html\r\n[CTFE]: https://github.com/rust-lang/rust/issues/11621\r\n[outer func error playground]: https://gist.github.com/XrXr/0336f977dd17d490d895a721ffc61207\r\n[zulip]: https://rust-lang.zulipchat.com/#narrow/stream/213817-t-lang/topic/Is.20a.20FCP.20required.20for.20basic.20CTFE.20guarantees.3F/near/269816535\r\n[FCP]: https://rustc-dev-guide.rust-lang.org/stabilization_guide.html#fcp", "closed_by": {"login": "XrXr", "id": 6457510, "node_id": "MDQ6VXNlcjY0NTc1MTA=", "avatar_url": "https://avatars.githubusercontent.com/u/6457510?v=4", "gravatar_id": "", "url": "https://api.github.com/users/XrXr", "html_url": "https://github.com/XrXr", "followers_url": "https://api.github.com/users/XrXr/followers", "following_url": "https://api.github.com/users/XrXr/following{/other_user}", "gists_url": "https://api.github.com/users/XrXr/gists{/gist_id}", "starred_url": "https://api.github.com/users/XrXr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/XrXr/subscriptions", "organizations_url": "https://api.github.com/users/XrXr/orgs", "repos_url": "https://api.github.com/users/XrXr/repos", "events_url": "https://api.github.com/users/XrXr/events{/privacy}", "received_events_url": "https://api.github.com/users/XrXr/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/93838/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/93838/timeline", "performed_via_github_app": null, "state_reason": "completed"}