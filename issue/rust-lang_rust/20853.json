{"url": "https://api.github.com/repos/rust-lang/rust/issues/20853", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/20853/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/20853/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/20853/events", "html_url": "https://github.com/rust-lang/rust/issues/20853", "id": 53949896, "node_id": "MDU6SXNzdWU1Mzk0OTg5Ng==", "number": 20853, "title": "thread '<unnamed>' panicked at 'failed to allocate a guard page', when RLIMIT_STACK is not 4K page aligned", "user": {"login": "piyo", "id": 6347, "node_id": "MDQ6VXNlcjYzNDc=", "avatar_url": "https://avatars.githubusercontent.com/u/6347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/piyo", "html_url": "https://github.com/piyo", "followers_url": "https://api.github.com/users/piyo/followers", "following_url": "https://api.github.com/users/piyo/following{/other_user}", "gists_url": "https://api.github.com/users/piyo/gists{/gist_id}", "starred_url": "https://api.github.com/users/piyo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/piyo/subscriptions", "organizations_url": "https://api.github.com/users/piyo/orgs", "repos_url": "https://api.github.com/users/piyo/repos", "events_url": "https://api.github.com/users/piyo/events{/privacy}", "received_events_url": "https://api.github.com/users/piyo/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 36953, "node_id": "MDU6TGFiZWwzNjk1Mw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-runtime", "name": "A-runtime", "color": "f7e101", "default": false, "description": "Area: std's runtime and \"pre-main\" init for handling backtraces, unwinds, stack overflows"}, {"id": 100522, "node_id": "MDU6TGFiZWwxMDA1MjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-crash", "name": "I-crash", "color": "e10c02", "default": false, "description": "Issue: The compiler crashes (SIGSEGV, SIGABRT, etc). Use I-ICE instead when the compiler panics."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2015-01-10T07:12:44Z", "updated_at": "2015-04-22T14:52:07Z", "closed_at": "2015-04-22T14:52:07Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Running the rustc compiler inside of my (misbehaving?) emacs ends in an error as shown in the title. \"Inside\" means, M-x compilation ENTER rustc --verbose --version ENTER.\n\nReported to @aatch on #rust@irc.mozilla.org\n\nThe following C program is a small, low-dependency test case, that can show 3 different cases. See below for sample output.\n\n``` C\n/*\n DESC This test program changes its own rlimits::RLIMIT_STACK to be\n page-aligned or not depending on option, then execve() a\n /usr/local/bin/rustc --verbose --version (installed via nightly).\n\n COMPILE gcc -Wall main.c\n RUN ./a.out e ; ./a.out n ; ./a.out\n\n EXPECT './a.out e' reports thread '<unnamed>' panicked at 'failed to\n allocate a guard page', when rust.git 44a287e63, Ubuntu 12.04.5\n\n EXPECT './a.out n' runs with no errors.\n\n EXPECT './a.out' will inherit whatever RLIMIT_STACK was set (like\n inside an erroneous emacs).\n\n DATE [2015-01-10 Sat 15:51]\n */\n\n#include <stdio.h>\n#include <time.h>\n#include <stdint.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <sys/resource.h>\n\nint main(int argc, char *argv[])\n{\n    struct rlimit old = {0};\n    struct rlimit new = {0};\n\n    int j = 0;\n    for (j = 0; j < argc; ++j)\n      printf(\"argv[%d]: %s\\n\", j, argv[j]);\n\n    getrlimit(RLIMIT_STACK, &old);\n    printf(\"curr: %lu %lu\\n\", old.rlim_cur, old.rlim_max);\n\n    /* option: force normal case */\n    if (argc > 1 && argv[1][0] == 'n') {\n      old.rlim_cur = 8192 * 1024;\n      setrlimit(RLIMIT_STACK, &old);\n    }\n\n    /* option: force abnormal case */\n    if (argc > 1 && argv[1][0] == 'e') {\n      old.rlim_cur = 8720000; /* Ubuntu 12.04.5, Emacs 12.04.05 sample */\n      setrlimit(RLIMIT_STACK, &old);\n    }\n\n    getrlimit(RLIMIT_STACK, &new);\n    printf(\"2nd:  %lu %lu\\n\", new.rlim_cur, new.rlim_max);\n\n    printf(\"Is RLIMIT_STACK 4KB page-aligned? %s\\n\",\n           (new.rlim_cur % 4096 == 0) ? \"Yes\": \"NO!\");\n\n    char *exe = \"/usr/local/bin/rustc\";\n    char *newargv[] = { exe, \"--version\", \"--verbose\", NULL };\n    char *newenv[] = { \"RUST_BACKTRACE=1\", NULL };\n    execve(exe, newargv, newenv);\n\n    exit(0);\n}\n```\n\nOutput on the command line with sane RLIMIT_STACK:\n\n```\n+15470> ./a.out ; ./a.out e; ./a.out n\nargv[0]: ./a.out\ncurr: 8388608 18446744073709551615\n2nd:  8388608 18446744073709551615\nIs RLIMIT_STACK 4KB page-aligned? Yes\nrustc 1.0.0-nightly (44a287e6e 2015-01-08 17:03:40 -0800)\nbinary: rustc\ncommit-hash: 44a287e6eb22ec3c2a687fc156813577464017f7\ncommit-date: 2015-01-08 17:03:40 -0800\nhost: x86_64-unknown-linux-gnu\nrelease: 1.0.0-nightly\nargv[0]: ./a.out\nargv[1]: e\ncurr: 8388608 18446744073709551615\n2nd:  8720000 18446744073709551615\nIs RLIMIT_STACK 4KB page-aligned? NO!\nthread '<unnamed>' panicked at 'failed to allocate a guard page', /home/rustbuild/src/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/sys/unix/thread.rs:109\nstack backtrace:\n   1:     0x7f78a55fd850 - sys::backtrace::write::h5b05e7b061a35107Czt\n   2:     0x7f78a561fa60 - failure::on_fail::h1e9b7e3de59488d1aPz\n   3:     0x7f78a558d5e0 - rt::unwind::begin_unwind_inner::h23dcfb4c37870bd62tz\n   4:     0x7f78a558d530 - rt::unwind::begin_unwind::h14463498374571830842\n   5:     0x7f78a5621840 - rt::lang_start::hf37c6346d533f5c0mJz\n   6:     0x7f78a5160680 - __libc_start_main\n   7:                0x0 - <unknown>\n\nYou've met with a terrible fate, haven't you?\n\nfatal runtime error: Could not unwind stack, error = 5\nzsh: illegal hardware instruction (core dumped)  ./a.out e\nargv[0]: ./a.out\nargv[1]: n\ncurr: 8388608 18446744073709551615\n2nd:  8388608 18446744073709551615\nIs RLIMIT_STACK 4KB page-aligned? Yes\nrustc 1.0.0-nightly (44a287e6e 2015-01-08 17:03:40 -0800)\nbinary: rustc\ncommit-hash: 44a287e6eb22ec3c2a687fc156813577464017f7\ncommit-date: 2015-01-08 17:03:40 -0800\nhost: x86_64-unknown-linux-gnu\nrelease: 1.0.0-nightly\n```\n\nOutput inside of my misbehaving emacs:\n\n```\n-*- mode: compilation; default-directory: \"~/projects/concepts/rust/debug1/\" -*-\nCompilation started at Sat Jan 10 16:01:40\n\ngcc -Wall main.c && ./a.out ; ./a.out e ;./a.out n\nargv[0]: ./a.out\ncurr: 8720000 18446744073709551615\n2nd:  8720000 18446744073709551615\nIs RLIMIT_STACK 4KB page-aligned? NO!\nthread '<unnamed>' panicked at 'failed to allocate a guard page', /home/rustbuild/src/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/sys/unix/thread.rs:109\nstack backtrace:\n   1:     0x7fe3a5fd1850 - sys::backtrace::write::h5b05e7b061a35107Czt\n   2:     0x7fe3a5ff3a60 - failure::on_fail::h1e9b7e3de59488d1aPz\n   3:     0x7fe3a5f615e0 - rt::unwind::begin_unwind_inner::h23dcfb4c37870bd62tz\n   4:     0x7fe3a5f61530 - rt::unwind::begin_unwind::h14463498374571830842\n   5:     0x7fe3a5ff5840 - rt::lang_start::hf37c6346d533f5c0mJz\n   6:     0x7fe3a5b34680 - __libc_start_main\n   7:                0x0 - <unknown>\n\nYou've met with a terrible fate, haven't you?\n\nfatal runtime error: Could not unwind stack, error = 5\nargv[0]: ./a.out\nargv[1]: e\ncurr: 8720000 18446744073709551615\n2nd:  8720000 18446744073709551615\nIs RLIMIT_STACK 4KB page-aligned? NO!\nthread '<unnamed>' panicked at 'failed to allocate a guard page', /home/rustbuild/src/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/sys/unix/thread.rs:109\nstack backtrace:\n   1:     0x7f0de3f56850 - sys::backtrace::write::h5b05e7b061a35107Czt\n   2:     0x7f0de3f78a60 - failure::on_fail::h1e9b7e3de59488d1aPz\n   3:     0x7f0de3ee65e0 - rt::unwind::begin_unwind_inner::h23dcfb4c37870bd62tz\n   4:     0x7f0de3ee6530 - rt::unwind::begin_unwind::h14463498374571830842\n   5:     0x7f0de3f7a840 - rt::lang_start::hf37c6346d533f5c0mJz\n   6:     0x7f0de3ab9680 - __libc_start_main\n   7:                0x0 - <unknown>\n\nYou've met with a terrible fate, haven't you?\n\nfatal runtime error: Could not unwind stack, error = 5\nargv[0]: ./a.out\nargv[1]: n\ncurr: 8720000 18446744073709551615\n2nd:  8388608 18446744073709551615\nIs RLIMIT_STACK 4KB page-aligned? Yes\nrustc 1.0.0-nightly (44a287e6e 2015-01-08 17:03:40 -0800)\nbinary: rustc\ncommit-hash: 44a287e6eb22ec3c2a687fc156813577464017f7\ncommit-date: 2015-01-08 17:03:40 -0800\nhost: x86_64-unknown-linux-gnu\nrelease: 1.0.0-nightly\n\nCompilation finished at Sat Jan 10 16:01:41\n```\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/20853/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/20853/timeline", "performed_via_github_app": null, "state_reason": "completed"}