{"url": "https://api.github.com/repos/rust-lang/rust/issues/112368", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/112368/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/112368/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/112368/events", "html_url": "https://github.com/rust-lang/rust/issues/112368", "id": 1744819642, "node_id": "I_kwDOAAsO6M5n_9W6", "number": 112368, "title": "GNU linker warns \u201ccorrupt .drectve\u201d on staticlib binary generated with Rust 1.70 on Windows", "user": {"login": "yutannihilation", "id": 1978793, "node_id": "MDQ6VXNlcjE5Nzg3OTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1978793?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yutannihilation", "html_url": "https://github.com/yutannihilation", "followers_url": "https://api.github.com/users/yutannihilation/followers", "following_url": "https://api.github.com/users/yutannihilation/following{/other_user}", "gists_url": "https://api.github.com/users/yutannihilation/gists{/gist_id}", "starred_url": "https://api.github.com/users/yutannihilation/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yutannihilation/subscriptions", "organizations_url": "https://api.github.com/users/yutannihilation/orgs", "repos_url": "https://api.github.com/users/yutannihilation/repos", "events_url": "https://api.github.com/users/yutannihilation/events{/privacy}", "received_events_url": "https://api.github.com/users/yutannihilation/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1966910227, "node_id": "MDU6TGFiZWwxOTY2OTEwMjI3", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-prioritize", "name": "I-prioritize", "color": "e10c02", "default": false, "description": "Indicates that prioritization has been requested for this issue"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2023-06-07T00:27:31Z", "updated_at": "2023-06-15T19:04:02Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "It seems, as of version 16, LLVM generates a binary containing incompatible directive with GNU linker. I believe this is the cause:\r\n\r\ncommit: https://github.com/llvm/llvm-project/commit/c5b3de6745c37dd991430b9b88ff97c35b6fc455\r\n\r\nSince Rust 1.70 upgraded LLVM to version 16,  we started to see a lot of warnings by GNU linker when I link against staticlibs compiled by Rust. The warnings are like this:\r\n\r\n```\r\nWarning: .drectve `-exclude-symbols:_ZN7testpkg11hello_world17ha68eef8a416aa303E ' unrecognized\r\nWarning: corrupt .drectve at end of def file\r\n```\r\n\r\nIt seems I can just ignore this warning (while the concern described in [the LLVM's commit](https://github.com/llvm/llvm-project/commit/c5b3de6745c37dd991430b9b88ff97c35b6fc455) can be a real problem in future), but still I feel this is something that should be fixed if possible. I know, from LLVM's viewpoint, it's reasonable to assume the linker is lld and embed the directives that only lld can understand. But, on the other hand, from Rust's viewpoint, is it intentional that the \"GNU\" target produces a binary that is incompatible with \"GNU\" linker? I'm honestly not sure about the answer. I'm yet to figure out what the \"GNU\" in Rust's GNU toolchain/target actually means.\r\n\r\n### Code\r\n\r\nA minimal reproducible code: https://github.com/yutannihilation/rust170_gnu_warning\r\n\r\n```sh\r\n# compile Rust code to create a staticlib\r\ncargo build --target=x86_64-pc-windows-gnu --lib --release\r\n\r\n# compile the C code\r\ngcc -c main.c -o main.o\r\n\r\n# link to the staticlib\r\ngcc -o testpkgrust170_gnu_warning.dll main.o -L./target/x86_64-pc-windows-gnu/release -lrust170_gnu_warning -lws2_32 -ladvapi32 -luserenv -lbcrypt -lntdll \r\n```\r\n\r\nIn case of Rust 1.69, we don't see any warnings. However, if it's compiled using Rust 1.70, GNU linker warns:\r\n\r\n```\r\nWarning: corrupt .drectve at end of def file\r\nWarning: corrupt .drectve at end of def file\r\n```\r\n(This can be reproducible on GHA: [result](https://github.com/yutannihilation/rust170_gnu_warning/actions/runs/5182955142/jobs/9340288940#step:4:13))\r\n\r\n### Version it worked on\r\n\r\nIt most recently worked on: Rust 1.69\r\n\r\n### Version with regression\r\n\r\n<!--\r\nProvide the version you are using that has the regression.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.70.0 (90c541806 2023-05-31)\r\nbinary: rustc\r\ncommit-hash: 90c541806f23a127002de5b4038be731ba1458ca\r\ncommit-date: 2023-05-31\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.70.0\r\nLLVM version: 16.0.2\r\n```\r\n\r\n### Backtrace\r\n\r\n### References\r\n\r\n* the original context: https://github.com/extendr/rextendr/pull/285#issuecomment-1576987501\r\n* post on the Rust user forum before reporting here: https://users.rust-lang.org/t/corrupt-drectve-warning-on-x86-64-pc-windows-gnu-target-with-rust-1-70/94912", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/112368/reactions", "total_count": 2, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/112368/timeline", "performed_via_github_app": null, "state_reason": null}