{"url": "https://api.github.com/repos/rust-lang/rust/issues/47053", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/47053/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/47053/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/47053/events", "html_url": "https://github.com/rust-lang/rust/issues/47053", "id": 285001790, "node_id": "MDU6SXNzdWUyODUwMDE3OTA=", "number": 47053, "title": "What are the semantics of '#[thread_local] static ...' without 'mut'?", "user": {"login": "EdSchouten", "id": 736085, "node_id": "MDQ6VXNlcjczNjA4NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/736085?v=4", "gravatar_id": "", "url": "https://api.github.com/users/EdSchouten", "html_url": "https://github.com/EdSchouten", "followers_url": "https://api.github.com/users/EdSchouten/followers", "following_url": "https://api.github.com/users/EdSchouten/following{/other_user}", "gists_url": "https://api.github.com/users/EdSchouten/gists{/gist_id}", "starred_url": "https://api.github.com/users/EdSchouten/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/EdSchouten/subscriptions", "organizations_url": "https://api.github.com/users/EdSchouten/orgs", "repos_url": "https://api.github.com/users/EdSchouten/repos", "events_url": "https://api.github.com/users/EdSchouten/events{/privacy}", "received_events_url": "https://api.github.com/users/EdSchouten/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-12-28T22:33:55Z", "updated_at": "2018-01-23T19:56:55Z", "closed_at": "2018-01-23T19:56:55Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "**Background:**\r\n\r\nI am currently working on porting Rust's libstd over to the CloudABI sandboxed runtime environment. I'm pretty close to getting it working and hope to send out a pull request in a couple of days.\r\n\r\nAs CloudABI's userspace <-> kernel ABI [is documented](https://github.com/NuxiNL/cloudabi) and [we generate Rust bindings automatically](https://docs.rs/cloudabi/0.0.1/), it's really attractive to implement libstd on top of kernel primitives as much as possible. libstd's locking primitives (mutexes, etc.) are simpler than the POSIX ones (no shared address space support, no configurable clocks, etc). This allows us to shrink condvars, mutexes and rwlocks to four bytes each.\r\n\r\nThe rwlocks implementation I wrote needs to keep track of the number of read locks acquired by the current thread [as follows](https://github.com/EdSchouten/rust/blob/3bcb9598b69d2b22c4cb31bc34226edfef686b31/src/libstd/sys/cloudabi/rwlock.rs#L22-L23):\r\n\r\n```\r\n#[thread_local]\r\nstatic mut RDLOCKS_ACQUIRED: u32 = 0;\r\n```\r\n\r\n**The reason I'm filing this bug report:**\r\n\r\nAn earlier version of my code had this:\r\n\r\n```\r\n#[thread_local]\r\nstatic RDLOCKS_ACQUIRED: u32 = 0;\r\n```\r\n\r\nThis seemed to make the code build, but for some reason, this caused some weird behaviour, where this counter was not always incremented or decremented, causing assertions in my code to fail.\r\n\r\nIs `#[thread_local] static` without `mut` supposed to do anything meaningful in the first place? If not, should we add a compiler warning/error for this?\r\n  \r\n  ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/47053/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/47053/timeline", "performed_via_github_app": null, "state_reason": "completed"}