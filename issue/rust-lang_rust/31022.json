{"url": "https://api.github.com/repos/rust-lang/rust/issues/31022", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/31022/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/31022/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/31022/events", "html_url": "https://github.com/rust-lang/rust/issues/31022", "id": 127436976, "node_id": "MDU6SXNzdWUxMjc0MzY5NzY=", "number": 31022, "title": "Bad macro usage error message does not include correct error location", "user": {"login": "SimonSapin", "id": 291359, "node_id": "MDQ6VXNlcjI5MTM1OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/291359?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SimonSapin", "html_url": "https://github.com/SimonSapin", "followers_url": "https://api.github.com/users/SimonSapin/followers", "following_url": "https://api.github.com/users/SimonSapin/following{/other_user}", "gists_url": "https://api.github.com/users/SimonSapin/gists{/gist_id}", "starred_url": "https://api.github.com/users/SimonSapin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SimonSapin/subscriptions", "organizations_url": "https://api.github.com/users/SimonSapin/orgs", "repos_url": "https://api.github.com/users/SimonSapin/repos", "events_url": "https://api.github.com/users/SimonSapin/events{/privacy}", "received_events_url": "https://api.github.com/users/SimonSapin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 132910982, "node_id": "MDU6TGFiZWwxMzI5MTA5ODI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-macros", "name": "A-macros", "color": "f7e101", "default": false, "description": "Area: All kinds of macros (custom derive, macro_rules!, proc macros, ..)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 1596122130, "node_id": "MDU6TGFiZWwxNTk2MTIyMTMw", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-papercut", "name": "D-papercut", "color": "c9f7a3", "default": false, "description": "Diagnostic error that needs small tweaks"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2016-01-19T12:39:38Z", "updated_at": "2022-12-28T23:02:34Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Consider this reduced test case:\n\n``` rust\nmacro_rules! match_ignore_ascii_case {\n    (@inner $value:expr) => { () };\n    ( $($rest:tt)* ) => { match_ignore_ascii_case!(@inner $($rest)*) };\n}\n\nfn main() {\n    // This is fine\n    match_ignore_ascii_case!(1);\n\n    // This causes an error as it doesn\u2019t match the expected syntax\n    // but the error message does not the location of the actual error.\n    match_ignore_ascii_case!(2 => 3);\n}\n```\n\nThe `@inner` indirection exists because the non-reduced macro is recursive:\n- https://play.rust-lang.org/?gist=f8b1652f43cc720f89a3&version=nightly\n- https://users.rust-lang.org/t/writing-a-macro-rules-macro-used-like-a-match-expression/4328\n\nThis fails to compile (as it should) but the error message does not include the real location of the error, which is line 12. It can be hard to track down in a large crate with many users of the macro.\n\n``` rust\na.rs:3:52: 3:53 error: unexpected token: `@`\na.rs:3     ( $($rest:tt)* ) => { match_ignore_ascii_case!(@inner $($rest)*) };\n```\n\nThe error message looks even worse when the macro is used (with incorrect syntax) from another crate\n\n```\n<cssparser macros>:12:1: 12:2 error: unexpected token: `@`\n<cssparser macros>:12 @ inner $ value , ( $ ( $ rest ) * ) -> (\n```\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/31022/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/31022/timeline", "performed_via_github_app": null, "state_reason": null}