{"url": "https://api.github.com/repos/rust-lang/rust/issues/93321", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/93321/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/93321/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/93321/events", "html_url": "https://github.com/rust-lang/rust/issues/93321", "id": 1114830097, "node_id": "I_kwDOAAsO6M5CcvUR", "number": 93321, "title": "Huge performance gap between lto=\"fat\",cgu=1 and default release profile", "user": {"login": "Robbepop", "id": 8193155, "node_id": "MDQ6VXNlcjgxOTMxNTU=", "avatar_url": "https://avatars.githubusercontent.com/u/8193155?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Robbepop", "html_url": "https://github.com/Robbepop", "followers_url": "https://api.github.com/users/Robbepop/followers", "following_url": "https://api.github.com/users/Robbepop/following{/other_user}", "gists_url": "https://api.github.com/users/Robbepop/gists{/gist_id}", "starred_url": "https://api.github.com/users/Robbepop/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Robbepop/subscriptions", "organizations_url": "https://api.github.com/users/Robbepop/orgs", "repos_url": "https://api.github.com/users/Robbepop/repos", "events_url": "https://api.github.com/users/Robbepop/events{/privacy}", "received_events_url": "https://api.github.com/users/Robbepop/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 474645165, "node_id": "MDU6TGFiZWw0NzQ2NDUxNjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-wasm", "name": "O-wasm", "color": "6e6ec0", "default": false, "description": "Target: WASM (WebAssembly), http://webassembly.org/"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-01-26T09:56:41Z", "updated_at": "2022-04-14T16:06:14Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I was told on Rust's Discord that I should maybe post this issue here together with my research so far which can be found following [this GitHub issue link](https://github.com/paritytech/wasmi/issues/339). The GitHub issue links to other sources of information such as the [GitHub Gist](https://gist.github.com/Robbepop/0644e9eb000bb1dad6a003a72534263a) that accumulates a lot of benchmark results.\r\n\r\nThe **tl;dr** is that we see slowdowns of up to x4.21 with the default release profile compared to using\r\n```toml\r\n[profile.release]\r\nlto = \"fat\"\r\ncodegen-units = 1\r\n```\r\nWhich is a lot more than the 10-15% that I usually see between both profiles.\r\n\r\nPeople told me that maybe this is due to some edge cases within the optimization pipeline. I personally ran out of ideas since whatever I do I usually see slowdowns of at least 75-100% which is unacceptable since this is a very performance critical library. The major problem with the custom profile using `lto=\"fat\",cgu=1` is that it compiled massively slow and probably won't be used by all library users by default which will lead to very poor performance in the default case for those users. The only thing I can do rn is to spam potential users with warnings about using the correct profile settings.\r\n\r\n----\r\n\r\n[I also asked this in Rust's Zulip](https://rust-lang.zulipchat.com/#narrow/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1) but didn't gain a lot of really useful information out of it unfortunately.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/93321/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/93321/timeline", "performed_via_github_app": null, "state_reason": null}