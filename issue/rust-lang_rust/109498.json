{"url": "https://api.github.com/repos/rust-lang/rust/issues/109498", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/109498/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/109498/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/109498/events", "html_url": "https://github.com/rust-lang/rust/issues/109498", "id": 1636361027, "node_id": "I_kwDOAAsO6M5hiOND", "number": 109498, "title": "Rust compilation failed:  ld: failed to convert GOTPCREL relocation; relink with --no-relax", "user": {"login": "yaoxin1995", "id": 86879740, "node_id": "MDQ6VXNlcjg2ODc5NzQw", "avatar_url": "https://avatars.githubusercontent.com/u/86879740?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yaoxin1995", "html_url": "https://github.com/yaoxin1995", "followers_url": "https://api.github.com/users/yaoxin1995/followers", "following_url": "https://api.github.com/users/yaoxin1995/following{/other_user}", "gists_url": "https://api.github.com/users/yaoxin1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/yaoxin1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yaoxin1995/subscriptions", "organizations_url": "https://api.github.com/users/yaoxin1995/orgs", "repos_url": "https://api.github.com/users/yaoxin1995/repos", "events_url": "https://api.github.com/users/yaoxin1995/events{/privacy}", "received_events_url": "https://api.github.com/users/yaoxin1995/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2023-03-22T19:14:37Z", "updated_at": "2023-03-25T20:18:18Z", "closed_at": "2023-03-25T20:18:18Z", "author_association": "NONE", "active_lock_reason": null, "body": "I want to use `rust-mbedtls` in my `no-std` rust project. But, in  no\\_std without libc, I need to provide my own version of the standard C function `calloc()/free()`   Therefore, I wrote my rust version `calloc()/free()` as showed in the following so that the `rust-mbedtls` can use it as C `calloc and free` :\r\n\r\n```\r\nconst ALIGNMENT: usize = 16;\r\n#[no_mangle]\r\npub extern \"C\" fn calloc(number_of_elements: core::ffi::c_ulong, element_size: core::ffi::c_ulong) -> *mut core::ffi::c_void {\r\n\r\n\r\n    // TODO: CHECK number_of_elements or element_size is null\r\n    // 0 as *mut c_void;\r\n    //core::mem::transmute(0) as *mut c_void\r\n    if number_of_elements == 0 || element_size == 0 {\r\n        return core::ptr::null_mut() as *mut core::ffi::c_void;\r\n    }\r\n\r\n    let total_size = number_of_elements * element_size;\r\n    let layout = Layout::from_size_align(total_size as usize, ALIGNMENT).unwrap();\r\n\r\n    let ptr;\r\n    unsafe {\r\n        ptr = alloc(layout);\r\n    }\r\n\r\n    let pointer_addr = ptr.addr();\r\n\r\n    {\r\n        let mut allocator_tracker = ALLCATOR_RECODER.write();\r\n        allocator_tracker.memory_layout_records.insert(pointer_addr, layout.clone());\r\n    }\r\n\r\n    ptr as *mut core::ffi::c_void\r\n}\r\n\r\n#[no_mangle]\r\npub extern \"C\" fn free(ptr: *mut core::ffi::c_void) {\r\n    if ptr.is_null() { return }\r\n\r\n    let ptr = ptr as *mut u8;\r\n\r\n    let ptr_addr = ptr.addr();\r\n\r\n    let layout;\r\n    {\r\n        let allocator_tracker = ALLCATOR_RECODER.write();\r\n        layout = match allocator_tracker.memory_layout_records.get(&ptr_addr) {\r\n            Some(e) => e.clone(),\r\n            None => return,\r\n        };\r\n    }\r\n\r\n    unsafe{\r\n        dealloc(ptr, layout);\r\n    }\r\n}\r\n```\r\n\r\nBut I got a compilation error when I tried to link my rust calloc and free to mbedtls:\r\n\r\n```\r\nld: failed to convert GOTPCREL relocation; relink with --no-relax\r\nmake[1]: *** [makefile:20: ../build/qkernel.bin] Error 1\r\nmake[1]: Leaving directory '/home/yaoxin/master-thesis-quark/qkernel'\r\nmake: *** [makefile:5: release] Error 2\r\n```\r\n\r\nDo you have any idea what should I do?\r\n\r\nI also tried to add the `--no-relax` flag, but it doesn't work, see https://stackoverflow.com/questions/75812992/failed-to-add-linker-flag-to-rust-project\r\n\r\nx86_64-qkernel.json:\r\n```\r\n{\r\n  \"llvm-target\": \"x86_64-unknown-none\",\r\n  \"data-layout\": \"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128\",\r\n  \"linker-flavor\": \"gcc\",\r\n  \"target-endian\": \"little\",\r\n  \"target-pointer-width\": \"64\",\r\n  \"target-c-int-width\": \"32\",\r\n  \"arch\": \"x86_64\",\r\n  \"os\": \"none\",\r\n  \"disable-redzone\": true,\r\n  \"features\": \"-mmx,-avx,-sse,+soft-float\",\r\n  \"frame-pointer\": \"always\"\r\n}\r\n```\r\n\r\nHow I compile the project:\r\n```\r\nRUSTFLAGS=\"--cfg aes_force_soft --cfg polyval_force_soft -Clink-args=-Wl,--no-relax\" CARGO_TARGET_DIR=../target cargo xbuild --target x86_64-qkernel.json  --verbose\r\n```\r\nThe output:\r\n```\r\n  Running `rustc --crate-name qkernel src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts,future-incompat --crate-type staticlib --emit=dep-info,link -C opt-level=3 -C panic=abort -C lto -C codegen-units=1 -C debuginfo=0 -C metadata=97ea9ce0f16c5783 -C extra-filename=-97ea9ce0f16c5783 --out-dir /home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps --target /home/yaoxin/master-thesis-quark/qkernel/x86_64-qkernel.json -L dependency=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps -L dependency=/home/yaoxin/master-thesis-quark/qkernel/../target/release/deps --extern aes_gcm=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libaes_gcm-717643e861007e33.rlib --extern aes_gcm_siv=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libaes_gcm_siv-6f995755fa597bbe.rlib --extern base64ct=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libbase64ct-5496b92f22bd80b8.rlib --extern bit_field=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libbit_field-edd6bdbd617b1f8f.rlib --extern bitflags=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libbitflags-ac365e5f42b95894.rlib --extern cache_padded=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libcache_padded-4f6ef68df93e90d0.rlib --extern enum_dispatch=/home/yaoxin/master-thesis-quark/qkernel/../target/release/deps/libenum_dispatch-671ddf5618cdf268.so --extern getrandom=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libgetrandom-13f5719ebfa51caa.rlib --extern hex_literal=/home/yaoxin/master-thesis-quark/qkernel/../target/release/deps/libhex_literal-2bb5f3d83aaee4c8.so --extern hmac=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libhmac-2655769827370b4b.rlib --extern httparse=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libhttparse-5bed1f6ea6993fbf.rlib --extern lazy_static=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/liblazy_static-94dc823d8024600b.rlib --extern mbedtls=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libmbedtls-24156e7768130449.rlib --extern mbedtls_sys=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libmbedtls_sys-ff2dc58ff93490e8.rlib --extern modular_bitfield=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libmodular_bitfield-03c5fd99465e3eaf.rlib --extern postcard=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libpostcard-9eda30e977dc625d.rlib --extern rand=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/librand-92d7b15db76a3fe4.rlib --extern scopeguard=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libscopeguard-cbe5443c11ade540.rlib --extern serde=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libserde-36089da064e8c146.rlib --extern serde_derive=/home/yaoxin/master-thesis-quark/qkernel/../target/release/deps/libserde_derive-fd9f7691d8feac18.so --extern serde_json=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libserde_json-ec6207dfb10065b9.rlib --extern sha2=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libsha2-bd36cfb2ea89f366.rlib --extern spin=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libspin-f3efecb2ec9af5e5.rlib --extern x86_64=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libx86_64-4f8fad8682003e13.rlib --extern xmas_elf=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/deps/libxmas_elf-674d0e0c9e007595.rlib --cfg aes_force_soft --cfg polyval_force_soft -Clink-args=-Wl,--no-relax --sysroot /home/yaoxin/master-thesis-quark/qkernel/../target/sysroot -L native=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/build/mbedtls-c08fa7036f067dee/out -L native=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/build/mbedtls-sys-auto-32089ec779500d3b/out/build/library -L native=/home/yaoxin/master-thesis-quark/qkernel/../target/x86_64-qkernel/release/build/mbedtls-sys-auto-32089ec779500d3b/out/build/crypto/library`\r\n```\r\nThe compilation error:\r\n```\r\n    Finished release [optimized] target(s) in 1m 05s\r\nld: failed to convert GOTPCREL relocation; relink with --no-relax\r\nmake: *** [makefile:20: ../build/qkernel.bin] Error 1\r\n```\r\n\r\n```\r\nrustc --version --verbose:\r\nrustc 1.65.0-nightly (29e4a9ee0 2022-08-10)\r\nbinary: rustc\r\ncommit-hash: 29e4a9ee0253cd39e552a77f51f11f9a5f1c41e6\r\ncommit-date: 2022-08-10\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.65.0-nightly\r\nLLVM version: 14.0.6\r\n```\r\n\r\nCould you please give me some help?", "closed_by": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/109498/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/109498/timeline", "performed_via_github_app": null, "state_reason": "not_planned"}