{"url": "https://api.github.com/repos/rust-lang/rust/issues/97919", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/97919/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/97919/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/97919/events", "html_url": "https://github.com/rust-lang/rust/issues/97919", "id": 1266335711, "node_id": "I_kwDOAAsO6M5Ler_f", "number": 97919, "title": "Mismatched wasm output on darwin vs Ubuntu", "user": {"login": "nmattia", "id": 6930756, "node_id": "MDQ6VXNlcjY5MzA3NTY=", "avatar_url": "https://avatars.githubusercontent.com/u/6930756?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nmattia", "html_url": "https://github.com/nmattia", "followers_url": "https://api.github.com/users/nmattia/followers", "following_url": "https://api.github.com/users/nmattia/following{/other_user}", "gists_url": "https://api.github.com/users/nmattia/gists{/gist_id}", "starred_url": "https://api.github.com/users/nmattia/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nmattia/subscriptions", "organizations_url": "https://api.github.com/users/nmattia/orgs", "repos_url": "https://api.github.com/users/nmattia/repos", "events_url": "https://api.github.com/users/nmattia/events{/privacy}", "received_events_url": "https://api.github.com/users/nmattia/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1508600909, "node_id": "MDU6TGFiZWwxNTA4NjAwOTA5", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-reproducibility", "name": "A-reproducibility", "color": "f7e101", "default": false, "description": "Area: Reproducible / Deterministic builds"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2022-06-09T15:44:31Z", "updated_at": "2022-07-19T09:35:17Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried this code:\r\n\r\n```rust\r\n// Crate A\r\nuse std::cell::{RefCell};\r\nuse std::collections::HashMap;\r\n\r\nuse internet_identity_interface as other;\r\n\r\n#[export_name = \"the name\"]\r\nfn dummy()\r\n{\r\n    let _err_info = \"hello\".to_string(); // Removing this makes the outputs match\r\n\r\n    other::unreachable(); // Calling unreachable! from this crate makes the outputs match\r\n}\r\n\r\n\r\npub type SomeType = u8; // Inlining 'u8' in the ASSETS below makes the outputs match\r\n\r\nthread_local! {\r\n    static ASSETS: RefCell<HashMap<&'static str, (Vec<SomeType>, &'static [u8])>> = RefCell::new(HashMap::default());\r\n}\r\n\r\nfn main() {}\r\n```\r\n\r\n``` rust\r\n// Crate B (\"other\")\r\npub fn unreachable() {\r\n    unreachable!();\r\n}\r\n```\r\n\r\n\r\nWhen building using the `wasm32-unknown-unknown` target, I expect the output to be the same on Ubuntu and macOS. Instead, I'm getting different outputs. I've tried on different Ubuntu and macOS versions, and the output is consistent across all versions of the same platform. What's really odd is that the slightest various of the code above makes the output match again.\r\n\r\nThis is the command I use to build:\r\n\r\n```\r\ncargo build --manifest-path ./src/path/to/Crate/A/Cargo.toml --target wasm32-unknown-unknown --release -j1\r\n```\r\n\r\nThis _could_ be a cargo issue, I'm not sure of what's happening under the hood.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.58.1 (db9d1b20b 2022-01-20)\r\nbinary: rustc\r\ncommit-hash: db9d1b20bba1968c1ec1fc49616d4742c1725b4b\r\ncommit-date: 2022-01-20\r\nhost: x86_64-apple-darwin\r\nrelease: 1.58.1\r\nLLVM version: 13.0.0\r\n\r\n---\r\n\r\nrustc 1.58.1 (db9d1b20b 2022-01-20)\r\nbinary: rustc\r\ncommit-hash: db9d1b20bba1968c1ec1fc49616d4742c1725b4b\r\ncommit-date: 2022-01-20\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.58.1\r\nLLVM version: 13.0.0\r\n```\r\n\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/97919/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/97919/timeline", "performed_via_github_app": null, "state_reason": null}