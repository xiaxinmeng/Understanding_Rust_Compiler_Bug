{"url": "https://api.github.com/repos/rust-lang/rust/issues/22924", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/22924/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/22924/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/22924/events", "html_url": "https://github.com/rust-lang/rust/issues/22924", "id": 59392496, "node_id": "MDU6SXNzdWU1OTM5MjQ5Ng==", "number": 22924, "title": "Compiler fails to optimize out bounds checks on 32-bit x86 and ARM", "user": {"login": "rprichard", "id": 1572855, "node_id": "MDQ6VXNlcjE1NzI4NTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1572855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rprichard", "html_url": "https://github.com/rprichard", "followers_url": "https://api.github.com/users/rprichard/followers", "following_url": "https://api.github.com/users/rprichard/following{/other_user}", "gists_url": "https://api.github.com/users/rprichard/gists{/gist_id}", "starred_url": "https://api.github.com/users/rprichard/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rprichard/subscriptions", "organizations_url": "https://api.github.com/users/rprichard/orgs", "repos_url": "https://api.github.com/users/rprichard/repos", "events_url": "https://api.github.com/users/rprichard/events{/privacy}", "received_events_url": "https://api.github.com/users/rprichard/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}], "state": "closed", "locked": false, "assignee": {"login": "emberian", "id": 704250, "node_id": "MDQ6VXNlcjcwNDI1MA==", "avatar_url": "https://avatars.githubusercontent.com/u/704250?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emberian", "html_url": "https://github.com/emberian", "followers_url": "https://api.github.com/users/emberian/followers", "following_url": "https://api.github.com/users/emberian/following{/other_user}", "gists_url": "https://api.github.com/users/emberian/gists{/gist_id}", "starred_url": "https://api.github.com/users/emberian/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emberian/subscriptions", "organizations_url": "https://api.github.com/users/emberian/orgs", "repos_url": "https://api.github.com/users/emberian/repos", "events_url": "https://api.github.com/users/emberian/events{/privacy}", "received_events_url": "https://api.github.com/users/emberian/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "emberian", "id": 704250, "node_id": "MDQ6VXNlcjcwNDI1MA==", "avatar_url": "https://avatars.githubusercontent.com/u/704250?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emberian", "html_url": "https://github.com/emberian", "followers_url": "https://api.github.com/users/emberian/followers", "following_url": "https://api.github.com/users/emberian/following{/other_user}", "gists_url": "https://api.github.com/users/emberian/gists{/gist_id}", "starred_url": "https://api.github.com/users/emberian/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emberian/subscriptions", "organizations_url": "https://api.github.com/users/emberian/orgs", "repos_url": "https://api.github.com/users/emberian/repos", "events_url": "https://api.github.com/users/emberian/events{/privacy}", "received_events_url": "https://api.github.com/users/emberian/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 3, "created_at": "2015-03-01T11:26:59Z", "updated_at": "2015-06-20T21:36:56Z", "closed_at": "2015-06-20T21:36:56Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Test case:\n\n``` rust\n#[inline(never)]\npub fn my_write(dst: &mut [u8]) {\n    if dst.len() >= 41 {\n        dst[40] = 17;\n    }\n}\n\nfn main() {\n    let mut buf = [0u8; 41];\n    my_write(&mut buf);\n}\n```\n\nThe 32-bit x86 and ARM disassembly for `my_write` includes two checks of the slice length and a call to `panic_bounds_check`.  The bounds check is optimized away on x86_64.\n\nHere's the x86 assembly:\n\n``` gas\n_ZN8my_write20he7b6161ce2fc6d9beaaE:\n    subl    $12, %esp\n    cmpl    $41, 4(%ecx)\n    jb  .LBB0_3\n    movl    4(%ecx), %eax\n    cmpl    $41, %eax\n    jb  .LBB0_4\n    movl    (%ecx), %eax\n    movb    $17, 40(%eax)\n.LBB0_3:\n    addl    $12, %esp\n    retl\n.LBB0_4:\n    movl    %eax, 8(%esp)\n    movl    $40, 4(%esp)\n    movl    $panic_bounds_check_loc20, (%esp)\n    calll   _ZN9panicking18panic_bounds_check20hdb38771954ce4aaf58rE\n```\n\nLLVM bitcode:\n\n``` llvm\n; Function Attrs: noinline uwtable\ndefine internal fastcc void @_ZN8my_write20he7b6161ce2fc6d9beaaE({ i8*, i32 }* noalias nocapture dereferenceable(8)) unnamed_addr #0 {\nentry-block:\n  %1 = bitcast { i8*, i32 }* %0 to i8*\n  %2 = bitcast { i8*, i32 }* %0 to i64*\n  %3 = load i64* %2, align 4\n  %.sroa.3.0.extract.shift.i.i = lshr i64 %3, 32\n  %.sroa.3.0.extract.trunc.i.i = trunc i64 %.sroa.3.0.extract.shift.i.i to i32\n  %4 = icmp ugt i32 %.sroa.3.0.extract.trunc.i.i, 40\n  %5 = trunc i64 %3 to i32\n  %6 = inttoptr i32 %5 to i8*\n  br i1 %4, label %then-block-17-, label %next-block\n\nthen-block-17-:                                   ; preds = %entry-block\n  %7 = getelementptr inbounds { i8*, i32 }* %0, i32 0, i32 1\n  %8 = load i32* %7, align 4\n  %9 = icmp ult i32 %8, 41\n  br i1 %9, label %cond, label %next, !prof !0\n\nnext:                                             ; preds = %then-block-17-\n  %10 = getelementptr inbounds i8* %6, i32 40\n  store i8 17, i8* %10, align 1\n  br label %next-block\n\ncond:                                             ; preds = %then-block-17-\n  tail call void @_ZN9panicking18panic_bounds_check20hdb38771954ce4aaf58rE({ %str_slice, i32 }* noalias readonly dereferenceable(12) @panic_bounds_check_loc20, i32 40, i32 %8)\n  unreachable\n\nnext-block:                                       ; preds = %entry-block, %next\n  tail call void @llvm.lifetime.end(i64 8, i8* %1)\n  ret void\n}\n```\n\nCompiler version:\n\n```\nrustc 1.0.0-nightly (e233987ce 2015-02-27) (built 2015-02-28)\nbinary: rustc\ncommit-hash: e233987ce1de88a48db2ce612019ba644d3cf5dd\ncommit-date: 2015-02-27\nbuild-date: 2015-02-28\nhost: i686-unknown-linux-gnu\nrelease: 1.0.0-nightly\n```\n\nMy ARM compiler is older -- 2015-02-18 or so.\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/22924/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/22924/timeline", "performed_via_github_app": null, "state_reason": "completed"}