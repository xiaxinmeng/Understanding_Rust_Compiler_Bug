{"url": "https://api.github.com/repos/rust-lang/rust/issues/101194", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/101194/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/101194/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/101194/events", "html_url": "https://github.com/rust-lang/rust/issues/101194", "id": 1355562009, "node_id": "I_kwDOAAsO6M5QzDwZ", "number": 101194, "title": "Deadlock with Rwlock and Thread with version 1.62 and 1.63", "user": {"login": "vireshk", "id": 12929622, "node_id": "MDQ6VXNlcjEyOTI5NjIy", "avatar_url": "https://avatars.githubusercontent.com/u/12929622?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vireshk", "html_url": "https://github.com/vireshk", "followers_url": "https://api.github.com/users/vireshk/followers", "following_url": "https://api.github.com/users/vireshk/following{/other_user}", "gists_url": "https://api.github.com/users/vireshk/gists{/gist_id}", "starred_url": "https://api.github.com/users/vireshk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vireshk/subscriptions", "organizations_url": "https://api.github.com/users/vireshk/orgs", "repos_url": "https://api.github.com/users/vireshk/repos", "events_url": "https://api.github.com/users/vireshk/events{/privacy}", "received_events_url": "https://api.github.com/users/vireshk/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2022-08-30T10:46:06Z", "updated_at": "2023-03-14T11:12:30Z", "closed_at": "2023-03-14T11:12:29Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThe following code is setting fields of a vector from different threads, one thread for one entry and finally reading all of them to make sure the threads have run properly. If we try to read all values in a while loop (as shown in code), the code hangs a lot of times. This works fine with 1.61.0 but hangs since 1.62.0.\r\n-->\r\n\r\nI tried this code:\r\n\r\n```rust\r\nuse std::sync::{Arc, RwLock};\r\nuse std::thread::spawn;\r\n\r\nfn main() {\r\n    let count = 2;\r\n    let data = Arc::new(RwLock::new(vec![Some(true); count]));\r\n\r\n    for i in 0..count {\r\n        let data = data.clone();\r\n\r\n        Some(spawn(move || {\r\n            data.write().unwrap()[i] = None;\r\n        }));\r\n    }\r\n\r\n    // This hangs a lot, since 1.62.0 (1.61 works fine)\r\n    while data.read().unwrap()[0].is_some()\r\n        || data.read().unwrap()[1].is_some()\r\n    {}\r\n\r\n    // This always passes\r\n    while data.read().unwrap()[0].is_some() {}\r\n    while data.read().unwrap()[1].is_some() {}\r\n\r\n    dbg!();\r\n}\r\n```\r\n\r\nI expected to see this happen: *print [src/main.rs:25]*\r\n\r\nInstead, this happened: *but it hangs*\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.63.0 (4b91a6ea7 2022-08-08)\r\nbinary: rustc\r\ncommit-hash: 4b91a6ea7258a947e59c6522cd5898e7c0a6a88f\r\ncommit-date: 2022-08-08\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.63.0\r\nLLVM version: 14.0.5\r\n```\r\n", "closed_by": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/101194/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/101194/timeline", "performed_via_github_app": null, "state_reason": "not_planned"}