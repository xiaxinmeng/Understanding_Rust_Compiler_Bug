{"url": "https://api.github.com/repos/rust-lang/rust/issues/56166", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/56166/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/56166/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/56166/events", "html_url": "https://github.com/rust-lang/rust/issues/56166", "id": 383607490, "node_id": "MDU6SXNzdWUzODM2MDc0OTA=", "number": 56166, "title": "miri function argument passing should use FnAbi", "user": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37234, "node_id": "MDU6TGFiZWwzNzIzNA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-cleanup", "name": "C-cleanup", "color": "f5f1fd", "default": false, "description": "Category: PRs that clean code up or issues documenting cleanup."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 13, "created_at": "2018-11-22T16:45:44Z", "updated_at": "2021-12-24T08:09:42Z", "closed_at": "2021-12-24T08:09:42Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "In the miri engine, when evaluating a function call, it can happen that caller and callee do not agree on the type of an argument. In this case, the argument effectively gets transmuted from the caller type to the callee type. However, this is not legal for all types, and whether it is legal depends on horrible details of the ABI. This logic is implemented for codegen, where it is called `FnType`. miri should probably use that same infrastructure.\r\n\r\nThe relevant code in miri that would need changing [is here](https://github.com/rust-lang/rust/blob/dae6c9364108847393075b57a17fd7eaf3f37600/src/librustc_mir/interpret/terminator.rs#L184-L227). Currently, we only allow argument type punning for the Rust ABI, and we only allow the valid range of a `Scalar`/`ScalarPair` to change -- effectively, we allow one side to have `&T` while the other side has `*const T`.\r\n\r\nFor the `FnType` side, I do not know much, but @eddyb offered to mentor someone trying to do this cleanup. :)  He also left the following hints:\r\n\r\n> move some code from rustc_codegen_ssa and then compare ArgType pairwise.\r\n> \r\n> The main issue to moving that stuff around is pointee_info_at (it would have to be moved to rustc::ty::layout, as an additional method in TyLayoutMethods):\r\n> \r\n> https://github.com/rust-lang/rust/blob/dae6c9364108847393075b57a17fd7eaf3f37600/src/librustc_codegen_llvm/abi.rs#L487\r\n>\r\n> Everything else is mostly relying on rustc_target doing the heavy lifting, already.\r\n\r\nCc @oli-obk ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/56166/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/56166/timeline", "performed_via_github_app": null, "state_reason": "completed"}