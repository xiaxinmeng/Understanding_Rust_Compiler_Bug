{"url": "https://api.github.com/repos/rust-lang/rust/issues/55083", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/55083/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/55083/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/55083/events", "html_url": "https://github.com/rust-lang/rust/issues/55083", "id": 369979536, "node_id": "MDU6SXNzdWUzNjk5Nzk1MzY=", "number": 55083, "title": "\"impossible case reached\" in trait impl involving (infinite?) type recursion and constants", "user": {"login": "TallJimbo", "id": 1330720, "node_id": "MDQ6VXNlcjEzMzA3MjA=", "avatar_url": "https://avatars.githubusercontent.com/u/1330720?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TallJimbo", "html_url": "https://github.com/TallJimbo", "followers_url": "https://api.github.com/users/TallJimbo/followers", "following_url": "https://api.github.com/users/TallJimbo/following{/other_user}", "gists_url": "https://api.github.com/users/TallJimbo/gists{/gist_id}", "starred_url": "https://api.github.com/users/TallJimbo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TallJimbo/subscriptions", "organizations_url": "https://api.github.com/users/TallJimbo/orgs", "repos_url": "https://api.github.com/users/TallJimbo/repos", "events_url": "https://api.github.com/users/TallJimbo/events{/privacy}", "received_events_url": "https://api.github.com/users/TallJimbo/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 13836860, "node_id": "MDU6TGFiZWwxMzgzNjg2MA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-traits", "name": "A-traits", "color": "f7e101", "default": false, "description": "Area: Trait system"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2018-10-15T02:52:14Z", "updated_at": "2023-01-08T02:03:49Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I'm seeing an internal compiler error in something I *think* is related to infinite recursion in the type system while implementing a generic trait.\r\n\r\nI tried compiling this code via cargo as a library crate (all of this in `lib.rs`):\r\n```\r\nuse std::ops::Mul;\r\nuse std::f64::consts::PI;\r\n\r\npub trait Unit: Default + Copy + Clone + PartialOrd + PartialEq {}\r\n\r\n#[derive(Default, Copy, Clone, PartialOrd, PartialEq)]\r\npub struct Quantity<U: Unit>(\r\n    pub f64,\r\n    pub U,\r\n);\r\n\r\n#[derive(Default, Copy, Clone, PartialOrd, PartialEq)]\r\npub struct Point<T=f64> {\r\n    pub x: T,\r\n    pub y: T,\r\n}\r\n\r\nimpl<'b, T> Mul<&'b Point<T>> for f64 where f64: Mul<&'b T> {\r\n    type Output = Point<<f64 as Mul<&'b T>>::Output>;\r\n    fn mul(self, rhs: &'b Point<T>) -> Self::Output { Point{ x: self*&rhs.x, y: self*&rhs.y } }\r\n}\r\n\r\nmod detail {  // private with public struct, for use in a public type alias only\r\n    use super::Unit;\r\n\r\n    #[derive(Default, Copy, Clone, PartialOrd, PartialEq)]\r\n    pub struct AngleUnit;\r\n\r\n    impl Unit for AngleUnit {}\r\n\r\n} // mod detail\r\n\r\npub type Angle = Quantity<detail::AngleUnit>;\r\n\r\npub const RADIANS: Angle = Quantity(1.0, detail::AngleUnit{});\r\npub const DEGREES: Angle = Quantity(RADIANS.0*PI/180.0, detail::AngleUnit{});\r\n```\r\n\r\nI expected to see some reasonable compiler error; I'm pretty confident the code is bad.  In particular, if you comment out the last two lines (the definition of the constants), you get a friendlier error:\r\n```\r\nerror[E0275]: overflow evaluating the requirement `_: std::marker::Sized`\r\n```\r\n(followed by some less-friendly recursive messages that do eventually truncate).\r\n\r\nWith those two `const` lines as above, I get:\r\n```\r\nerror: internal compiler error: librustc/traits/structural_impls.rs:178: impossible case reached\r\n\r\nthread 'main' panicked at 'Box<Any>', librustc_errors/lib.rs:578:9\r\nnote: Run with `RUST_BACKTRACE=1` for a backtrace.\r\nerror: aborting due to previous error\r\n\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: rustc 1.29.1 (b801ae664 2018-09-20) running on x86_64-unknown-linux-gnu\r\n\r\nnote: compiler flags: -C debuginfo=2 -C incremental --crate-type lib\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n```\r\n\r\n## Meta\r\n\r\n(see above for version)\r\n\r\nSince I'm not completely confident in my ability to run just `rustc` with the same options, here's the output of `RUST_BACKTRACE=1 cargo test`, I get:\r\n```\r\nerror: internal compiler error: librustc/traits/structural_impls.rs:178: impossible case reached\r\n\r\nthread 'main' panicked at 'Box<Any>', librustc_errors/lib.rs:578:9\r\nstack backtrace:\r\n   0: std::sys::unix::backtrace::tracing::imp::unwind_backtrace\r\nstack backtrace:\r\n   0: std::sys::unix::backtrace::tracing::imp::unwind_backtrace\r\n             at libstd/sys/unix/backtrace/tracing/gcc_s.rs:49\r\n   1: std::sys_common::backtrace::print\r\n             at libstd/sys/unix/backtrace/tracing/gcc_s.rs:49\r\n   1: std::sys_common::backtrace::print\r\n             at libstd/sys_common/backtrace.rs:71\r\n             at libstd/sys_common/backtrace.rs:59\r\n   2: std::panicking::default_hook::{{closure}}\r\n             at libstd/sys_common/backtrace.rs:71\r\n             at libstd/sys_common/backtrace.rs:59\r\n   2: std::panicking::default_hook::{{closure}}\r\n             at libstd/panicking.rs:211\r\n   3: std::panicking::default_hook\r\n             at libstd/panicking.rs:227\r\n   4: rustc::util::common::panic_hook\r\n   5: std::panicking::rust_panic_with_hook\r\n             at libstd/panicking.rs:479\r\n   6: std::panicking::begin_panic\r\n   7: rustc_errors::Handler::bug\r\n   8: rustc::session::opt_span_bug_fmt::{{closure}}\r\n   9: rustc::ty::context::tls::with_opt::{{closure}}\r\n  10: rustc::ty::context::tls::with_context_opt\r\n  11: rustc::ty::context::tls::with_opt\r\n             at   libstd/panicking.rs12:: 211rustc\r\n::  session ::3opt_span_bug_fmt: \r\nstd::panicking  ::13default_hook: \r\nrustc::           session  at ::libstd/panicking.rsbug_fmt:\r\n227\r\n  14:   rustc ::4traits: ::structural_implsrustc::::<utilimpl:: commonrustc::::panic_hookty\r\n::context::  Lift <5': tcx>std ::forpanicking ::rustcrust_panic_with_hook::\r\ntraits::           SelectionError  at <libstd/panicking.rs':a479>\r\n>::lift_to_tcx  \r\n 6:   15std: ::rustcpanicking::::tybegin_panic::\r\ncontext::TyCtxt  :: lift_to_global7\r\n: rustc_errors  ::16Handler: ::rustcbug::\r\ntraits::select  :: SelectionContext8::: candidate_from_obligation\r\nrustc::session  ::17opt_span_bug_fmt: ::rustc{::{traitsclosure::}select}::\r\nSelectionContext::evaluate_stack  \r\n 9  : 18rustc: ::rustcty::::tycontext::::contexttls::::tlswith_opt::::with_context{\r\n{closure  }19}: \r\nrustc::  dep_graph10::: graph::rustcDepGraph::::tywith_anon_task::\r\ncontext::tls  ::20with_context_opt: \r\nrustc::  traits11::: selectrustc::::SelectionContextty::::evaluate_predicate_recursivelycontext\r\n::tls::  with_opt21\r\n: rustc  ::12infer: ::InferCtxtrustc::::probesession\r\n::opt_span_bug_fmt\r\n  22  : 13: <&rustc'::asession ::mutbug_fmt \r\nI   as14 : core::rustciter::::traitsiterator::::structural_implsIterator::><::implnext \r\nrustc::ty  ::23context: ::Lift<<alloc'::tcxvec>:: Vecfor< Trustc>:: traitsas:: SelectionErroralloc<::'veca::>SpecExtend><::Tlift_to_tcx,\r\n I>  >15::: from_iter\r\nrustc::ty  ::24context: ::TyCtxtrustc::::lift_to_globaltraits\r\n::select  ::16SelectionContext: ::rustccandidate_from_obligation_no_cache::\r\ntraits::select  ::25SelectionContext: ::rustccandidate_from_obligation::\r\nty::context  ::17tls: ::rustcwith_context::\r\ntraits::select  ::26SelectionContext: ::evaluate_stackrustc\r\n::dep_graph::  graph18::: DepGraph::rustcwith_anon_task::\r\nty::  context27::: tls::rustcwith_context::\r\ntraits::select::  SelectionContext19::: candidate_from_obligation\r\nrustc::  dep_graph28::: graph::rustcDepGraph::::traitswith_anon_task::\r\nselect::SelectionContext  ::20evaluate_stack: \r\nrustc::  traits29::: selectrustc::::SelectionContextty::::evaluate_predicate_recursivelycontext\r\n::tls  ::21with_context: \r\nrustc::  infer30::: InferCtxtrustc::::probedep_graph\r\n::graph  ::22DepGraph: ::with_anon_task<\r\n&'  a31 : mutrustc ::Itraits ::asselect ::coreSelectionContext::::iterevaluate_predicate_recursively::\r\niterator::  Iterator32>: ::rustcnext::\r\ninfer::  InferCtxt23::: probe<\r\nalloc::  vec33::: Vec<<T&>' aas  mutalloc ::vec::ISpecExtend <asT ,core ::Iiter>::>iterator::::from_iterIterator\r\n>::next\r\n  24:   34rustc: ::traits<::allocselect::::vecSelectionContext::::Veccandidate_from_obligation_no_cache<\r\nT>   25as:  allocrustc::::vecty::::SpecExtendcontext<::Ttls,:: with_contextI\r\n>>  ::26from_iter: \r\nrustc::  dep_graph35::: graphrustc::::DepGraphtraits::::with_anon_taskselect\r\n::SelectionContext::  candidate_from_obligation_no_cache27\r\n: rustc  ::36traits: ::rustcselect::::tySelectionContext::::contextcandidate_from_obligation::\r\ntls::  with_context28\r\n: rustc  ::37traits: ::selectrustc::::SelectionContextdep_graph::::evaluate_stackgraph\r\n::DepGraph  ::29with_anon_task: \r\nrustc::  ty38::: context::rustctls::::traitswith_context::\r\nselect::SelectionContext  ::30candidate_from_obligation: \r\nrustc::dep_graph  ::39graph: ::rustcDepGraph::::traitswith_anon_task::\r\nselect  ::31SelectionContext: ::evaluate_stackrustc\r\n::traits::  select40::: SelectionContextrustc::::evaluate_predicate_recursivelyty\r\n::context  ::32tls: ::rustcwith_context::\r\ninfer::  InferCtxt41::: probe\r\nrustc  ::33dep_graph: ::<graph&::'DepGrapha:: with_anon_taskmut\r\n I   42as:  corerustc::::itertraits::::iteratorselect::::IteratorSelectionContext>::::evaluate_predicate_recursivelynext\r\n\r\n    4334: : rustc::<inferalloc::::InferCtxtvec::::probeVec\r\n<T>   44as:  <alloc&::'veca:: SpecExtendmut< TI,  asI >core>::::iterfrom_iter::\r\niterator::  Iterator35>: ::rustcnext::\r\ntraits::select  ::45SelectionContext: ::candidate_from_obligation_no_cache<\r\nalloc::  vec36::: Vec<rustcT::>ty ::ascontext ::alloctls::::vecwith_context::\r\nSpecExtend<  T37,:  Irustc>::>dep_graph::::from_itergraph\r\n::DepGraph  ::46with_anon_task: \r\nrustc::traits  ::38select: ::rustcSelectionContext::::traitscandidate_from_obligation_no_cache::\r\nselect  ::47SelectionContext: ::rustccandidate_from_obligation::\r\nty  ::39context: ::tlsrustc::::with_contexttraits\r\n::select::  SelectionContext48::: evaluate_stackrustc\r\n::dep_graph  ::40graph: ::DepGraphrustc::::with_anon_taskty\r\n::context  ::49tls: ::rustcwith_context::\r\ntraits::select  ::41SelectionContext: ::rustccandidate_from_obligation::\r\ndep_graph::graph  ::50DepGraph: ::rustcwith_anon_task::\r\ntraits::  select42::: SelectionContextrustc::::evaluate_stacktraits\r\n::select  ::51SelectionContext: ::rustcevaluate_predicate_recursively::\r\nty  ::43context: ::rustctls::::inferwith_context::\r\nInferCtxt::  probe52\r\n: rustc  ::44dep_graph: ::<graph&::'DepGrapha:: with_anon_taskmut\r\n I   as53 : corerustc::::itertraits::::iteratorselect::::IteratorSelectionContext>::::evaluate_predicate_recursivelynext\r\n\r\n    5445: : <allocrustc::::vecinfer::::VecInferCtxt<::Tprobe>\r\n as   55alloc: ::vec<::&SpecExtend'<aT ,mut  II> >as:: from_itercore\r\n::  iter46::: iterator::rustcIterator::>traits::::nextselect\r\n::SelectionContext  ::56candidate_from_obligation_no_cache: \r\n<alloc  ::47vec: ::rustcVec::<tyT::>context ::astls ::allocwith_context::\r\nvec::  SpecExtend48<: Trustc,:: dep_graphI::>graph>::::DepGraphfrom_iter::\r\nwith_anon_task\r\n    5749: : rustcrustc::::traitstraits::::selectselect::::SelectionContextSelectionContext::::candidate_from_obligation_no_cachecandidate_from_obligation\r\n\r\n    5850: : rustc::rustcty::::traitscontext::::selecttls::::SelectionContextwith_context::\r\nevaluate_stack  \r\n59:   rustc51::: dep_graph::rustcgraph::::tyDepGraph::::contextwith_anon_task::\r\ntls  ::60with_context: \r\nrustc  ::52traits: ::rustcselect::::dep_graphSelectionContext::::graphcandidate_from_obligation::\r\nDepGraph  ::61with_anon_task: \r\nrustc::traits  ::53select: ::SelectionContextrustc::::evaluate_stacktraits\r\n::select  ::62SelectionContext: ::rustcevaluate_predicate_recursively::\r\nty::  context54::: tls::rustcwith_context::\r\ninfer::  InferCtxt63::: proberustc\r\n::dep_graph  ::55graph: ::DepGraph<::&with_anon_task'\r\na   mut64 : Irustc ::astraits ::coreselect::::iterSelectionContext::::iteratorevaluate_predicate_recursively::\r\nIterator>::  next65\r\n: rustc  ::56infer: ::InferCtxt<::allocprobe::\r\nvec::  Vec66<: T>< &as' aalloc ::mutvec ::ISpecExtend <asT ,core ::Iiter>::>iterator::::from_iterIterator\r\n>::  next57\r\n:   rustc67::: traits::<selectalloc::::SelectionContextvec::::candidate_from_obligation_no_cacheVec\r\n<T  >58 : as rustcalloc::::tyvec::::contextSpecExtend::<tlsT::,with_context \r\nI>>  ::59from_iter: \r\nrustc::dep_graph  ::68graph: ::rustcDepGraph::::traitswith_anon_task::\r\nselect::SelectionContext  ::60candidate_from_obligation_no_cache: \r\nrustc::  traits69::: select::rustcSelectionContext::::tycandidate_from_obligation::\r\ncontext::  tls61::: with_contextrustc\r\n::traits  ::70select: ::SelectionContextrustc::::evaluate_stackdep_graph\r\n::graph::  DepGraph62::: with_anon_task\r\nrustc::  ty71::: contextrustc::::tlstraits::::with_contextselect\r\n::SelectionContext  ::63candidate_from_obligation: \r\nrustc::  dep_graph72::: graphrustc::::DepGraphtraits::::with_anon_taskselect\r\n::SelectionContext  ::64evaluate_stack: \r\nrustc::traits::  select73::: SelectionContext::rustcevaluate_predicate_recursively::\r\nty::context::  tls65::: with_context\r\nrustc::infer  ::74InferCtxt: ::rustcprobe::\r\ndep_graph::graph::  DepGraph66::: with_anon_task\r\n<&'  a75 : mut rustcI:: traitsas:: core::iter::selectiterator::::SelectionContextIterator::>evaluate_predicate_recursively::\r\nnext\r\n  76:   rustc67::: infer::<InferCtxtalloc::::probevec\r\n::Vec<  T77>:  <as& 'alloca:: vecmut:: SpecExtendI< Tas,  coreI::>iter>::::iteratorfrom_iter::\r\nIterator>::  next68\r\n: rustc  ::78traits: ::<selectalloc::::SelectionContextvec::::candidate_from_obligation_no_cacheVec\r\n<T>   69as:  allocrustc::::vecty::::SpecExtendcontext<::Ttls,:: with_contextI\r\n>>  ::70from_iter: \r\nrustc::dep_graph  ::79graph: ::rustcDepGraph::::traitswith_anon_task::\r\nselect::  SelectionContext71::: candidate_from_obligation_no_cacherustc\r\n::traits::  select80::: SelectionContextrustc::::candidate_from_obligationty\r\n::context  ::72tls: ::rustcwith_context::\r\ntraits::  select81::: SelectionContextrustc::::evaluate_stackdep_graph\r\n::graph  ::73DepGraph: ::rustcwith_anon_task::\r\nty::context  ::82tls: ::rustcwith_context::\r\ntraits::  select74::: SelectionContextrustc::::candidate_from_obligationdep_graph\r\n::graph  ::83DepGraph: ::rustcwith_anon_task::\r\ntraits::  select75::: SelectionContext::rustcevaluate_stack::\r\ntraits::select  ::SelectionContext84::: evaluate_predicate_recursivelyrustc\r\n::ty  ::76context: ::tlsrustc::::with_contextinfer\r\n::InferCtxt::  probe85\r\n: rustc  ::77dep_graph: ::graph<::&DepGraph'::awith_anon_task \r\nmut   I86 : as rustccore::::traitsiter::::selectiterator::::SelectionContextIterator::>evaluate_predicate_recursively::\r\nnext\r\n  87  : 78: rustc::<inferalloc::::InferCtxtvec::::probeVec\r\n<T>   88as:  <alloc&::'veca:: SpecExtendmut< TI,  asI >core>::::iterfrom_iter::\r\niterator::  Iterator79>: ::rustcnext::\r\ntraits::select  ::89SelectionContext: ::<candidate_from_obligation_no_cachealloc\r\n::vec  ::80Vec: <rustcT::>ty ::ascontext ::alloctls::::vecwith_context::\r\nSpecExtend<T  ,81 : I>rustc>::::dep_graphfrom_iter::\r\ngraph::DepGraph  ::90with_anon_task: \r\nrustc::  traits82::: select::rustcSelectionContext::::traitscandidate_from_obligation_no_cache::\r\nselect::SelectionContext  ::91candidate_from_obligation: \r\nrustc::  ty83::: contextrustc::::tlstraits::::with_contextselect\r\n::SelectionContext::  evaluate_stack92\r\n: rustc  ::84dep_graph: ::graphrustc::::DepGraphty::::with_anon_taskcontext\r\n::tls::  with_context93\r\n: rustc  ::85traits: ::selectrustc::::SelectionContextdep_graph::::candidate_from_obligationgraph\r\n::DepGraph::  with_anon_task94\r\n: rustc  ::86traits: ::selectrustc::::SelectionContexttraits::::evaluate_stackselect\r\n::SelectionContext::  evaluate_predicate_recursively95\r\n: rustc  ::87ty: ::contextrustc::::tlsinfer::::with_contextInferCtxt\r\n::probe  \r\n96:   rustc88::: dep_graph::<graph&::'DepGrapha:: with_anon_taskmut\r\n I   97as:  rustccore::::traitsiter::::selectiterator::::SelectionContextIterator::>evaluate_predicate_recursively::\r\nnext\r\n  98  : 89rustc: ::infer<::allocInferCtxt::::vecprobe::\r\nVec<T  >99 : as< &alloc'::avec ::mutSpecExtend <IT ,as  Icore>::>iter::::from_iteriterator\r\n::Iterator  90: rustc::>traits::::nextselect\r\n::SelectionContext::candidate_from_obligation_no_cache\r\nquery stack during panic:  \r\n91: rustc::ty::context::tls::with_context\r\n  92: rustc::dep_graph::graph::DepGraph::with_anon_task\r\n  93: rustc::traits::select::SelectionContext::candidate_from_obligation\r\n  94: rustc::traits::select::SelectionContext::evaluate_stack\r\n  95: rustc::ty::context::tls::with_context\r\n  96: rustc::dep_graph::graph::DepGraph::with_anon_task\r\n  97: rustc::traits::select::SelectionContext::evaluate_predicate_recursively\r\n  98: rustc::infer::InferCtxt::probe\r\n  99: <&'a mut I as core::iter::iterator::Iterator>::next\r\nquery stack during panic:\r\n#0 [evaluate_obligation] evaluating trait selection obligation `f64: std::ops::Mul<_>`\r\n#1 [typeck_tables_of] processing `DEGREES`\r\nend of query stack\r\n#0 [evaluate_obligation] evaluating trait selection obligation `f64: std::ops::Mul<_>`\r\n#1 [typeck_tables_of] processing `DEGREES`\r\nend of query stack\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/55083/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/55083/timeline", "performed_via_github_app": null, "state_reason": null}