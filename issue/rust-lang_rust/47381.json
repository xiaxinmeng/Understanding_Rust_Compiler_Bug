{"url": "https://api.github.com/repos/rust-lang/rust/issues/47381", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/47381/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/47381/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/47381/events", "html_url": "https://github.com/rust-lang/rust/issues/47381", "id": 288093181, "node_id": "MDU6SXNzdWUyODgwOTMxODE=", "number": 47381, "title": "heisenbug: debug builds `Integer::repr_discr` has transient ICE on `compile-fail/enum-discrim-too-small2.rs`", "user": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 25, "created_at": "2018-01-12T11:42:14Z", "updated_at": "2018-03-24T19:12:15Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "My config.toml:\r\n```toml\r\n[rust]\r\ncodegen-units = 8\r\ndebug = true\r\noptimize = true\r\ndebug-assertions = true\r\ndebuginfo = true\r\ndebuginfo-lines = true\r\n```\r\n\r\nAnd my (odd?) build invocation:\r\n\r\n```\r\n% time python /Users/fklock/Dev/Mozilla/rust-mirborrowck/.git/../x.py test src/tools/tidy && \\\r\n  time python /Users/fklock/Dev/Mozilla/rust-mirborrowck/.git/../x.py build --stage 1 --incremental --keep-stage 0 src/libstd && \\\r\n  time python /Users/fklock/Dev/Mozilla/rust-mirborrowck/.git/../x.py test --stage 1 src/test/{mir-opt,compile-fail,run-pass}\r\n```\r\n\r\nResults in stage 1 binary where we get weirdness on [this compile-fail test](https://github.com/rust-lang/rust/blob/master/src/test/compile-fail/enum-discrim-too-small2.rs):\r\n\r\n```\r\n% ./objdir-dbgopt/build/x86_64-unknown-linux-gnu/stage1/bin/rustc src/test/compile-fail/enum-discrim-too-small2.rs\r\nerror: literal out of range for i8\r\n  --> src/test/compile-fail/enum-discrim-too-small2.rs:18:11\r\n   |\r\n18 |     Ci8 = 223, //~ ERROR literal out of range for i8\r\n   |           ^^^\r\n   |\r\nnote: lint level defined here\r\n  --> src/test/compile-fail/enum-discrim-too-small2.rs:11:9\r\n   |\r\n11 | #![deny(overflowing_literals)]\r\n   |         ^^^^^^^^^^^^^^^^^^^^\r\n\r\nerror: literal out of range for i16\r\n  --> src/test/compile-fail/enum-discrim-too-small2.rs:25:12\r\n   |\r\n25 |     Ci16 = 55555, //~ ERROR literal out of range for i16\r\n   |            ^^^^^\r\n\r\nerror: literal out of range for i32\r\n  --> src/test/compile-fail/enum-discrim-too-small2.rs:32:12\r\n   |\r\n32 |     Ci32 = 3_000_000_000, //~ ERROR literal out of range for i32\r\n   |            ^^^^^^^^^^^^^\r\n\r\nerror: internal compiler error: librustc/ty/layout.rs:553: Integer::repr_discr: `#[repr]` hint too small for discriminant range of enum `Ei64\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: rustc 1.25.0-dev running on x86_64-unknown-linux-gnu\r\n\r\nthread 'rustc' panicked at 'Box<Any>', librustc_errors/lib.rs:508:9\r\nnote: Run with `RUST_BACKTRACE=1` for a backtrace.\r\n```\r\n\r\nI am *pretty* sure this is specific to debug builds. At least, that's my current best guess as to why this hasn't been caught by bors.\r\n\r\nThe code `layout.rs` looks like this:\r\n```rust\r\n       if let Some(ity) = repr.int {\r\n            let discr = Integer::from_attr(tcx, ity);\r\n            let fit = if ity.is_signed() { signed_fit } else { unsigned_fit };\r\n            if discr < fit {\r\n                bug!(\"Integer::repr_discr: `#[repr]` hint too small for \\\r\n                  discriminant range of enum `{}\", ty)\r\n            }\r\n            return (discr, ity.is_signed());\r\n        }\r\n```\r\nit should probably be signalling a proper error, or trusting that the lint will eventually fire and catch this, rather than just triggering a call to `bug!` (since this does not represent a bug in the compiler itself, right?)", "closed_by": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/47381/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/47381/timeline", "performed_via_github_app": null, "state_reason": null}