{"url": "https://api.github.com/repos/rust-lang/rust/issues/70838", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/70838/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/70838/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/70838/events", "html_url": "https://github.com/rust-lang/rust/issues/70838", "id": 595065399, "node_id": "MDU6SXNzdWU1OTUwNjUzOTk=", "number": 70838, "title": "Duplication of libLLVM-*.so in the distributed rustc component.", "user": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 593503757, "node_id": "MDU6TGFiZWw1OTM1MDM3NTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-infra", "name": "T-infra", "color": "bfd4f2", "default": false, "description": "Relevant to the infrastructure team, which will review and decide on the PR/issue."}, {"id": 808123953, "node_id": "MDU6TGFiZWw4MDgxMjM5NTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-release", "name": "T-release", "color": "bfd4f2", "default": false, "description": "Relevant to the release subteam, which will review and decide on the PR/issue."}, {"id": 1049491442, "node_id": "MDU6TGFiZWwxMDQ5NDkxNDQy", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-heavy", "name": "I-heavy", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to binary size of generated code."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 11, "created_at": "2020-04-06T12:15:17Z", "updated_at": "2020-05-22T08:04:41Z", "closed_at": "2020-05-22T08:04:41Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Since #57286, `libLLVM-*.so` has been distributed in the `rustc` component in two locations:\r\n* `lib/libLLVM-*.so` (presumably as a runtime dependency of `bin/rustc`)\r\n* `lib/rustlib/$target/lib/libLLVM-*.so` (not sure, maybe for *linking* custom drivers?)\r\n  * likely belongs in the `rustc-dev` component, *if* the duplication can't be avoided\r\n\r\n<hr/>\r\n\r\nThe difference can be seen in these consecutive nightlies' `rustc` components:\r\n* https://static.rust-lang.org/dist/2019-01-06/rustc-nightly-x86_64-unknown-linux-gnu.tar.xz\r\n  * has just *the second* `libLLVM-*.so`\r\n    * maybe it's used via relative `RPATH` by `lib/rustlib/$target/codegen-backends/librustc_codegen_llvm-llvm.so`? separate codegen backends are gone, maybe we should just try removing it?\r\n* https://static.rust-lang.org/dist/2019-01-07/rustc-nightly-x86_64-unknown-linux-gnu.tar.xz\r\n  * first nightly to include #57286\r\n  * has both copies\r\n\r\nAll 3 of those `libLLVM-8svn.so` files are identical (even across nightlies, yay for deterministic builds):\r\n```\r\ne400d157a7ceaee26f8680cb6f7430bd98c251dbb32e1f10549dda9f5769dc42  before/rustc-nightly-x86_64-unknown-linux-gnu/rustc/lib/rustlib/x86_64-unknown-linux-gnu/lib/libLLVM-8svn.so\r\ne400d157a7ceaee26f8680cb6f7430bd98c251dbb32e1f10549dda9f5769dc42  after/rustc-nightly-x86_64-unknown-linux-gnu/rustc/lib/libLLVM-8svn.so\r\ne400d157a7ceaee26f8680cb6f7430bd98c251dbb32e1f10549dda9f5769dc42  after/rustc-nightly-x86_64-unknown-linux-gnu/rustc/lib/rustlib/x86_64-unknown-linux-gnu/lib/libLLVM-8svn.so\r\n```\r\n\r\nOne fascinating aspect is that the size only increases from `82.22 MiB` to `83.18 MiB`, despite `libLLVM-8svn.so` alone being `67 MiB` uncompressed, so compression is really helping.\r\n\r\nEven the `.tar.gz` only goes from `111.41 MiB` to `113.26 MiB`.\r\n(I'm using archive sizes from the [2019-01-06](https://static.rust-lang.org/dist/2019-01-06) and [2019-01-07](https://static.rust-lang.org/dist/2019-01-07) directory listings in https://static.rust-lang.org/dist, FWIW)\r\n\r\n<hr/>\r\n\r\nThis part of the build system seems relevant, but I'm not sure which of the two this creates: https://github.com/rust-lang/rust/blob/733f104f138477ef20f59eadcbcf8800b21a7732/src/bootstrap/compile.rs#L755-L757\r\n\r\ncc @alexcrichton @rust-lang/release ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/70838/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/70838/timeline", "performed_via_github_app": null, "state_reason": "completed"}