{"url": "https://api.github.com/repos/rust-lang/rust/issues/12118", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/12118/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/12118/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/12118/events", "html_url": "https://github.com/rust-lang/rust/issues/12118", "id": 27215849, "node_id": "MDU6SXNzdWUyNzIxNTg0OQ==", "number": 12118, "title": "Return value/use extra::test::black_box in benchmarks that are optimised to nothing", "user": {"login": "huonw", "id": 1203825, "node_id": "MDQ6VXNlcjEyMDM4MjU=", "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4", "gravatar_id": "", "url": "https://api.github.com/users/huonw", "html_url": "https://github.com/huonw", "followers_url": "https://api.github.com/users/huonw/followers", "following_url": "https://api.github.com/users/huonw/following{/other_user}", "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}", "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/huonw/subscriptions", "organizations_url": "https://api.github.com/users/huonw/orgs", "repos_url": "https://api.github.com/users/huonw/repos", "events_url": "https://api.github.com/users/huonw/events{/privacy}", "received_events_url": "https://api.github.com/users/huonw/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 36996, "node_id": "MDU6TGFiZWwzNjk5Ng==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-easy", "name": "E-easy", "color": "02e10c", "default": false, "description": "Call for participation: Experience needed to fix: Easy / not much (good first issue)"}, {"id": 120005, "node_id": "MDU6TGFiZWwxMjAwMDU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-testsuite", "name": "A-testsuite", "color": "f7e101", "default": false, "description": "Area: The testsuite used to check the correctness of rustc"}, {"id": 67766349, "node_id": "MDU6TGFiZWw2Nzc2NjM0OQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-mentor", "name": "E-mentor", "color": "02E10C", "default": false, "description": "Call for participation: This issue has a mentor. Use RustcContributor::new on Zulip for discussion."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2014-02-09T04:10:17Z", "updated_at": "2014-08-22T18:45:56Z", "closed_at": "2014-08-22T18:45:56Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "As #8261 describes one has to be careful with benchmarks to avoid them being optimised to remove the section of code that's actually of interest; many in tree benchmarks are not this careful.\n#12105 adds two ways to get around this:\n- Return a value from the closure\n  \n  ``` rust\n  // speed of 1 allocation\n  bh.iter(|| ~1);\n  ```\n- Call the noop `extra::test::black_box` function on some result of a calculation, e.g.\n  \n  ``` rust\n  // speed of 100 allocations\n  use extra::test;\n  \n  bh.iter(|| { for _ in range(0, 100) { test::black_box(~1) } }) \n  ```\n\nIn both cases, the value is unused, but LLVM can't be sure and so cannot remove optimise out the computation of the value.\n\n---\n\nThe following are the benchmarks that took less than 10ns on the linux-64-opt buildbot (for the landing of #12105), and so are strong candidates for benchmarks that have been optimised to uselessness (there are probably others which aren't completely optimised to nothing, but still aren't benchmarking what they are purporting to):\n- collections\n  - bitv::tests::bench_big_bitv_big\n  - bitv::tests::bench_big_bitv_small\n  - bitv::tests::bench_bitv_big\n  - bitv::tests::bench_bitv_set_big\n  - bitv::tests::bench_bitv_set_small\n  - bitv::tests::bench_bitv_small\n  - bitv::tests::bench_small_bitv_small\n  - bitv::tests::bench_uint_small\n  - smallintmap::bench::find_seq_100\n  - smallintmap::bench::find_seq_10_000\n  - treemap::bench::find_seq_100\n  - treemap::bench::find_seq_10_000\n- arena\n  - test::bench_pod\n- std\n  - io::buffered::test::bench_buffered_reader\n  - io::buffered::test::bench_buffered_writer\n  - rt::global_heap::bench::alloc_owned_big\n  - rt::global_heap::bench::alloc_owned_small\n  - str::bench::bench_with_capacity\n  - str::bench::is_utf8_100_ascii\n  - str::bench::is_utf8_100_multibyte\n  - util::bench::match_option_some\n  - util::bench::match_vec_pattern\n  - util::bench::trait_static_method_call\n  - util::bench::trait_vtable_method_call\n  - vec::bench::contains_last_element\n  - vec::bench::ends_with_diff_one_element_at_beginning\n  - vec::bench::ends_with_same_vector\n  - vec::bench::ends_with_single_element\n  - vec::bench::push\n  - vec::bench::starts_with_diff_one_element_at_end\n  - vec::bench::starts_with_same_vector\n  - vec::bench::starts_with_single_element\n  - vec::bench::zero_1kb_fixed_repeat\n  - vec::bench::zero_1kb_mut_iter\n  - vec::bench::zero_1kb_set_memory\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/12118/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/12118/timeline", "performed_via_github_app": null, "state_reason": "completed"}