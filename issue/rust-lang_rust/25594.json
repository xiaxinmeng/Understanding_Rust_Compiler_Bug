{"url": "https://api.github.com/repos/rust-lang/rust/issues/25594", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/25594/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/25594/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/25594/events", "html_url": "https://github.com/rust-lang/rust/issues/25594", "id": 77963499, "node_id": "MDU6SXNzdWU3Nzk2MzQ5OQ==", "number": 25594, "title": "FFI:  wrong argument passing order on linux x86_64 C ABI", "user": {"login": "chyh1990", "id": 1158375, "node_id": "MDQ6VXNlcjExNTgzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/1158375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chyh1990", "html_url": "https://github.com/chyh1990", "followers_url": "https://api.github.com/users/chyh1990/followers", "following_url": "https://api.github.com/users/chyh1990/following{/other_user}", "gists_url": "https://api.github.com/users/chyh1990/gists{/gist_id}", "starred_url": "https://api.github.com/users/chyh1990/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chyh1990/subscriptions", "organizations_url": "https://api.github.com/users/chyh1990/orgs", "repos_url": "https://api.github.com/users/chyh1990/repos", "events_url": "https://api.github.com/users/chyh1990/events{/privacy}", "received_events_url": "https://api.github.com/users/chyh1990/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}], "state": "closed", "locked": false, "assignee": {"login": "luqmana", "id": 287063, "node_id": "MDQ6VXNlcjI4NzA2Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/287063?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luqmana", "html_url": "https://github.com/luqmana", "followers_url": "https://api.github.com/users/luqmana/followers", "following_url": "https://api.github.com/users/luqmana/following{/other_user}", "gists_url": "https://api.github.com/users/luqmana/gists{/gist_id}", "starred_url": "https://api.github.com/users/luqmana/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luqmana/subscriptions", "organizations_url": "https://api.github.com/users/luqmana/orgs", "repos_url": "https://api.github.com/users/luqmana/repos", "events_url": "https://api.github.com/users/luqmana/events{/privacy}", "received_events_url": "https://api.github.com/users/luqmana/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "luqmana", "id": 287063, "node_id": "MDQ6VXNlcjI4NzA2Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/287063?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luqmana", "html_url": "https://github.com/luqmana", "followers_url": "https://api.github.com/users/luqmana/followers", "following_url": "https://api.github.com/users/luqmana/following{/other_user}", "gists_url": "https://api.github.com/users/luqmana/gists{/gist_id}", "starred_url": "https://api.github.com/users/luqmana/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luqmana/subscriptions", "organizations_url": "https://api.github.com/users/luqmana/orgs", "repos_url": "https://api.github.com/users/luqmana/repos", "events_url": "https://api.github.com/users/luqmana/events{/privacy}", "received_events_url": "https://api.github.com/users/luqmana/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2015-05-19T06:48:54Z", "updated_at": "2015-10-15T07:11:32Z", "closed_at": "2015-10-15T07:11:32Z", "author_association": "NONE", "active_lock_reason": null, "body": "On linux x86_64, FFI passes arguments in wrong order if the function has more than 6 arguments, with struct (passed by value) mixed.\n## Reproduce\n\n`bug.c`\n\n``` c\n#include <stdio.h>\n\nstruct Rect {\n        int l;\n        int t;\n        int r;\n        int b;\n};\n\nvoid bug(int a, int b, int c, int d,\n        int e, struct Rect f, int g, int h) {\n        fprintf(stderr, \"%d %d %d %d %d\\n\",\n                a, b, c, d, e);\n        fprintf(stderr, \"%d %d %d %d\\n\",\n                f.l, f.t, f.r, f.b);\n        fprintf(stderr, \"%d %d\\n\", g, h);\n}\n```\n\n`bug.rs`\n\n``` rust\n#[repr(C)]\nstruct Rect {\n    l: i32,\n    t: i32,\n    r: i32,\n    b: i32,\n}\n\n#[link(name = \"bug\")]\nextern \"C\" {\n    fn bug(a: i32, b: i32, c: i32, d: i32,\n           e: i32, f: Rect, g: i32, h: i32);\n}\n\nfn main() {\n    let r = Rect {\n        l: 10,\n        t: 20,\n        r: 30,\n        b: 40\n    };\n    unsafe { bug(1, 2, 3, 4, 5, r, 6, 7); }\n}\n```\n\n``` bash\ngcc -fPIC -o libbug.so -shared bug.c\nrustc -L. bug.rs\n./bug\n```\n\nRust version\n\n```\nrustc 1.0.0 (a59de37e9 2015-05-13) (built 2015-05-14)\nbinary: rustc\ncommit-hash: a59de37e99060162a2674e3ff45409ac73595c0e\ncommit-date: 2015-05-13\nbuild-date: 2015-05-14\nhost: x86_64-unknown-linux-gnu\nrelease: 1.0.0\n```\n\nExpected output:\n1 2 3 4 5\n10 20 30 40\n6 7\n\nActual output:\n1 2 3 4 5\n30 40 6 32740\n10 7\n## Reason\n\nOnly 6 arguments can be passed by registers (see http://www.x86-64.org/documentation/abi.pdf).\nIn the above example, `a, b, c, d, e, g` should be passed in registers, `f & h` should be passed on stack.\n\nBut Rust FFI mistakenly passes `a, b, c, d, e` and lower 8bytes of `f` in registers. This is wrong\naccording to [abi.pdf](http://www.x86-64.org/documentation/abi.pdf), page 20:\n\n> If there are no registers available for any eightbyte of an argument, the whole\n> argument is passed on the stack. If registers have already been assigned for some\n> eightbytes of such an argument, the assignments get reverted.\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/25594/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/25594/timeline", "performed_via_github_app": null, "state_reason": "completed"}