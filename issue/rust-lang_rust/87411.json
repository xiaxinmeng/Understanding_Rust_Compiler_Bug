{"url": "https://api.github.com/repos/rust-lang/rust/issues/87411", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/87411/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/87411/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/87411/events", "html_url": "https://github.com/rust-lang/rust/issues/87411", "id": 951775041, "node_id": "MDU6SXNzdWU5NTE3NzUwNDE=", "number": 87411, "title": "FlatMap, Flatten appear to optimize badly", "user": {"login": "adrian17", "id": 4729533, "node_id": "MDQ6VXNlcjQ3Mjk1MzM=", "avatar_url": "https://avatars.githubusercontent.com/u/4729533?v=4", "gravatar_id": "", "url": "https://api.github.com/users/adrian17", "html_url": "https://github.com/adrian17", "followers_url": "https://api.github.com/users/adrian17/followers", "following_url": "https://api.github.com/users/adrian17/following{/other_user}", "gists_url": "https://api.github.com/users/adrian17/gists{/gist_id}", "starred_url": "https://api.github.com/users/adrian17/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/adrian17/subscriptions", "organizations_url": "https://api.github.com/users/adrian17/orgs", "repos_url": "https://api.github.com/users/adrian17/repos", "events_url": "https://api.github.com/users/adrian17/events{/privacy}", "received_events_url": "https://api.github.com/users/adrian17/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 10, "created_at": "2021-07-23T17:32:01Z", "updated_at": "2021-07-28T22:33:05Z", "closed_at": "2021-07-28T22:33:05Z", "author_association": "NONE", "active_lock_reason": null, "body": "Context: I recently saw a perf regression caused by the following change:\r\n```rs\r\npub fn pixels_rgba(&self) -> Vec<u8> {\r\n    let mut output = Vec::new();\r\n    for p in &self.pixels { output.extend_from_slice(&[p.red(), p.green(), p.blue(), p.alpha()]) }\r\n    output\r\n}\r\n->\r\npub fn pixels_rgba(&self) -> Vec<u8> {\r\n    self.pixels.iter().flat_map(|p| [p.red(), p.green(), p.blue(), p.alpha()]).collect();\r\n}\r\n```\r\nThe change was reasonable, with assumption that this would be more idiomatic and guarantee that the output Vec is preallocated. Unfortunately, this made the function several times slower. Recently-merged https://github.com/rust-lang/rust/pull/87168 helped here slightly, but the generated code is still much slower.\r\n\r\nThe same can also be observed for other code using `flat_map` or `flatten`, like a simple iteration over the iterator, and regardless of whether the flattened type has known size (array) or not.\r\n\r\nI made an example benchmark in repo https://github.com/adrian17/flat_map_perf , with the following results on my machine (with today's nightly rustc):\r\n```\r\n\r\ntests::bench_array_4x500000_collect_loop               1,269,560 ns/iter (+/- 146,537)\r\ntests::bench_array_4x500000_collect_loop_with_prealloc 1,255,140 ns/iter (+/- 165,287)\r\ntests::bench_array_4x500000_collect_with_flat_map      2,697,082 ns/iter (+/- 303,411)\r\n\r\ntests::bench_array_4x500000_iteration_nested_loop        220,838 ns/iter (+/- 25,307)\r\ntests::bench_array_4x500000_iteration_flat_map         3,029,744 ns/iter (+/- 463,749)\r\n\r\n\r\ntests::bench_iter_4000x500_collect_loop                  243,537 ns/iter (+/- 34,574)\r\ntests::bench_iter_4000x500_collect_loop_with_prealloc    243,246 ns/iter (+/- 34,197)\r\ntests::bench_iter_4000x500_collect_with_flatten        3,521,586 ns/iter (+/- 597,755)\r\n\r\ntests::bench_iter_4000x500_iteration_nested_loop         290,939 ns/iter (+/- 34,414)\r\ntests::bench_iter_4000x500_iteration_flatten           2,099,386 ns/iter (+/- 512,732)\r\n\r\n\r\ntests::bench_iter_4x500000_collect_loop                3,124,601 ns/iter (+/- 444,296)\r\ntests::bench_iter_4x500000_collect_loop_with_prealloc  2,873,051 ns/iter (+/- 576,719)\r\ntests::bench_iter_4x500000_collect_with_flatten        5,579,601 ns/iter (+/- 796,355)\r\n\r\ntests::bench_iter_4x500000_iteration_nested_loop       2,118,351 ns/iter (+/- 396,325)\r\ntests::bench_iter_4x500000_iteration_flatten           3,187,518 ns/iter (+/- 443,080)\r\n```\r\n", "closed_by": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/87411/reactions", "total_count": 4, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 2}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/87411/timeline", "performed_via_github_app": null, "state_reason": "completed"}