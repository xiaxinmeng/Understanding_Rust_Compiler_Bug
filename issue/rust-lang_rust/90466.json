{"url": "https://api.github.com/repos/rust-lang/rust/issues/90466", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/90466/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/90466/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/90466/events", "html_url": "https://github.com/rust-lang/rust/issues/90466", "id": 1040918881, "node_id": "I_kwDOAAsO6M4-Cylh", "number": 90466, "title": "Inherent impl hygiene difference between declarative macros and macro_rules!", "user": {"login": "zjijz", "id": 8097111, "node_id": "MDQ6VXNlcjgwOTcxMTE=", "avatar_url": "https://avatars.githubusercontent.com/u/8097111?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zjijz", "html_url": "https://github.com/zjijz", "followers_url": "https://api.github.com/users/zjijz/followers", "following_url": "https://api.github.com/users/zjijz/following{/other_user}", "gists_url": "https://api.github.com/users/zjijz/gists{/gist_id}", "starred_url": "https://api.github.com/users/zjijz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zjijz/subscriptions", "organizations_url": "https://api.github.com/users/zjijz/orgs", "repos_url": "https://api.github.com/users/zjijz/repos", "events_url": "https://api.github.com/users/zjijz/events{/privacy}", "received_events_url": "https://api.github.com/users/zjijz/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2021-11-01T08:41:23Z", "updated_at": "2021-11-01T08:42:26Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "It seems that declarative macros (`macro`) do not behave exactly as `macro_rules!` does with regards to defining an inherent `impl` within the macro that is visible at the call site.\r\n\r\nI tried this code:\r\n\r\n```rust\r\n#![feature(decl_macro)]\r\n\r\nmacro_rules! test_old {\r\n    ($name:ident) => {\r\n        struct $name;\r\n        \r\n        impl $name {\r\n            fn test(&self) -> usize { 10 }\r\n        }\r\n    };\r\n}\r\n\r\nmacro test_decl($name:ident) {\r\n    struct $name;\r\n    \r\n    impl $name {\r\n        fn test(&self) -> usize { 10 }\r\n    }\r\n}\r\n\r\ntest_old!(A);\r\ntest_decl!(B);\r\n\r\nfn main() {\r\n    let a = A;\r\n    let b = B;\r\n    \r\n    println!(\"{}\", a.test());\r\n    println!(\"{}\", b.test());\r\n}\r\n```\r\n\r\nI expected to see this happen: \r\n*Both `a.test()` and `b.test()` are valid method calls.*\r\n\r\nInstead, this happened: \r\n*The compiler only recognizes `a.test()` as valid:*\r\n```\r\n   Compiling playground v0.0.1 (/playground)\r\nerror[E0599]: no method named `test` found for struct `B` in the current scope\r\n  --> src/main.rs:29:22\r\n   |\r\n14 |     struct $name;\r\n   |     ------------- method `test` not found for this\r\n...\r\n29 |     println!(\"{}\", b.test());\r\n   |                      ^^^^ method not found in `B`\r\n\r\nFor more information about this error, try `rustc --explain E0599`.\r\nerror: could not compile `playground` due to previous error\r\n```\r\n\r\nI know there were some hygiene changes in the `decl_macro` feature (#39412), so this might be an intentional difference between the two. If this is part of the unfinished work for hygiene bending, I could accept this as the current state of the world, but it seems strange to me that the `struct` definition is visible at the call site, but not the inherent `impl` for `test_decl`.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`: (taken from rust playground)\r\n```\r\n1.58.0-nightly\r\n\r\n(2021-10-31 ff0e14829e1806ca0d42)\r\n```\r\n\r\nThis applied to 2015, 2018, and 2021 editions. I could not try on stable due to needing `#![feature(decl_macro)]`.\r\n\r\nRust Playground link: https://play.rust-lang.org/?version=nightly&mode=debug&edition=2021&gist=5c6afbf54a7d0cd54a85d691daf8bfc8\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/90466/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/90466/timeline", "performed_via_github_app": null, "state_reason": null}