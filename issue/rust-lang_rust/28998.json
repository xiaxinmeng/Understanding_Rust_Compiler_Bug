{"url": "https://api.github.com/repos/rust-lang/rust/issues/28998", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/28998/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/28998/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/28998/events", "html_url": "https://github.com/rust-lang/rust/issues/28998", "id": 111022333, "node_id": "MDU6SXNzdWUxMTEwMjIzMzM=", "number": 28998, "title": "Unable to use an exported Rust function inside a `build.rs`-generated library", "user": {"login": "aomader", "id": 23704, "node_id": "MDQ6VXNlcjIzNzA0", "avatar_url": "https://avatars.githubusercontent.com/u/23704?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aomader", "html_url": "https://github.com/aomader", "followers_url": "https://api.github.com/users/aomader/followers", "following_url": "https://api.github.com/users/aomader/following{/other_user}", "gists_url": "https://api.github.com/users/aomader/gists{/gist_id}", "starred_url": "https://api.github.com/users/aomader/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aomader/subscriptions", "organizations_url": "https://api.github.com/users/aomader/orgs", "repos_url": "https://api.github.com/users/aomader/repos", "events_url": "https://api.github.com/users/aomader/events{/privacy}", "received_events_url": "https://api.github.com/users/aomader/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2015-10-12T17:43:03Z", "updated_at": "2015-10-13T03:58:17Z", "closed_at": "2015-10-13T03:58:17Z", "author_association": "NONE", "active_lock_reason": null, "body": "My Rust lib `test` exports a public symbol, which is in turn used inside a CPP library I build using a custom `build.rs` script. Compiling works fine, until the linker steps in. It complains that the Rust function doesn't exist.\n\n**Cargo.toml**\n\n``` toml\n[package]\nname = \"test\"\nbuild = \"build.rs\"\n\n[build-dependencies]\ngcc = \"*\"\n\n[[bin]]\nname = \"test\"\npath = \"src/test.rs\"\n```\n\n**build.rs**\n\n``` rust\nextern crate gcc;\n\nfn main() {\n    let mut config = gcc::Config::new();\n    config.cpp(true);\n    config.file(\"src/clib.cpp\");\n    config.compile(\"libclib.a\");\n}\n```\n\n**src/lib.rs**\n\n``` rust\npub fn start() {\n    unsafe { c_function(); }\n}\n\nextern \"C\" fn rust_function() {\n    println!(\"Hello from Rust\");\n}\n\nextern {\n    fn c_function();\n}\n```\n\n**src/clib.cpp**\n\n``` cpp\n#include <stdio.h>\n\nextern void rust_function();\n\nextern \"C\" void c_function() {\n    printf(\"Hello from C\\n\");\n    rust_function();\n}\n```\n\n**src/test.rs**\n\n``` rust\nextern crate test;\n\nfn main() {\n    test::start();\n}\n```\n\nInstead of compiling without any problems, the linker produces the following error on my Linux machine:\n\n```\n% cargo build --verbose\n       Fresh gcc v0.3.18\n   Compiling test v0.1.0 (file:///home/b52/test)\n     Running `rustc src/test.rs --crate-name test --crate-type bin -g --out-dir /home/b52/test/target/debug --emit=dep-info,link -L dependency=/home/b52/test/target/debug -L dependency=/home/b52/test/target/debug/deps --extern test=/home/b52/test/target/debug/libtest.rlib -L native=/home/b52/test/target/debug/build/test-12bfe3f88f310e3b/out -L native=/home/b52/test/target/debug/build/test-12bfe3f88f310e3b/out`\nerror: linking with `cc` failed: exit code: 1\nnote: \"cc\" \"-Wl,--as-needed\" \"-m64\" \"-L\" \"/home/b52/.multirust/toolchains/nightly/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"/home/b52/test/target/debug/test.0.o\" \"-o\" \"/home/b52/test/target/debug/test\" \"-Wl,--gc-sections\" \"-pie\" \"-nodefaultlibs\" \"/home/b52/test/target/debug/libtest.rlib\" \"/home/b52/.multirust/toolchains/nightly/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd-35017696.rlib\" \"/home/b52/.multirust/toolchains/nightly/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcollections-35017696.rlib\" \"/home/b52/.multirust/toolchains/nightly/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc_unicode-35017696.rlib\" \"/home/b52/.multirust/toolchains/nightly/lib/rustlib/x86_64-unknown-linux-gnu/lib/librand-35017696.rlib\" \"/home/b52/.multirust/toolchains/nightly/lib/rustlib/x86_64-unknown-linux-gnu/lib/liballoc-35017696.rlib\" \"/home/b52/.multirust/toolchains/nightly/lib/rustlib/x86_64-unknown-linux-gnu/lib/liballoc_jemalloc-35017696.rlib\" \"/home/b52/.multirust/toolchains/nightly/lib/rustlib/x86_64-unknown-linux-gnu/lib/liblibc-35017696.rlib\" \"/home/b52/.multirust/toolchains/nightly/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcore-35017696.rlib\" \"-L\" \"/home/b52/test/target/debug\" \"-L\" \"/home/b52/test/target/debug/deps\" \"-L\" \"/home/b52/test/target/debug/build/test-12bfe3f88f310e3b/out\" \"-L\" \"/home/b52/test/target/debug/build/test-12bfe3f88f310e3b/out\" \"-L\" \"/home/b52/.multirust/toolchains/nightly/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-L\" \"/home/b52/test/.rust/lib/x86_64-unknown-linux-gnu\" \"-L\" \"/home/b52/test/lib/x86_64-unknown-linux-gnu\" \"-Wl,-Bstatic\" \"-Wl,-Bdynamic\" \"-l\" \"stdc++\" \"-l\" \"dl\" \"-l\" \"pthread\" \"-l\" \"rt\" \"-l\" \"gcc_s\" \"-l\" \"pthread\" \"-l\" \"c\" \"-l\" \"m\" \"-Wl,-rpath,$ORIGIN/../../../.multirust/toolchains/nightly/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-Wl,-rpath,/usr/local/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-l\" \"compiler-rt\"\nnote: /home/b52/test/target/debug/libtest.rlib(clib.o): In function `c_function':\n/home/b52/test/src/clib.cpp:7: undefined reference to `rust_function()'\ncollect2: Fehler: ld gab 1 als Ende-Status zur\u00fcck\n\nerror: aborting due to previous error\nCould not compile `test`.\n\nCaused by:\n  Process didn't exit successfully: `rustc src/test.rs --crate-name test --crate-type bin -g --out-dir /home/b52/test/target/debug --emit=dep-info,link -L dependency=/home/b52/test/target/debug -L dependency=/home/b52/test/target/debug/deps --extern test=/home/b52/test/target/debug/libtest.rlib -L native=/home/b52/test/target/debug/build/test-12bfe3f88f310e3b/out -L native=/home/b52/test/target/debug/build/test-12bfe3f88f310e3b/out` (exit code: 101)\n```\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/28998/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/28998/timeline", "performed_via_github_app": null, "state_reason": "completed"}