{"url": "https://api.github.com/repos/rust-lang/rust/issues/108680", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/108680/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/108680/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/108680/events", "html_url": "https://github.com/rust-lang/rust/issues/108680", "id": 1607619811, "node_id": "I_kwDOAAsO6M5f0lTj", "number": 108680, "title": "target_feature 1.1 error should print the list of missing target features", "user": {"login": "est31", "id": 8872119, "node_id": "MDQ6VXNlcjg4NzIxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8872119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/est31", "html_url": "https://github.com/est31", "followers_url": "https://api.github.com/users/est31/followers", "following_url": "https://api.github.com/users/est31/following{/other_user}", "gists_url": "https://api.github.com/users/est31/gists{/gist_id}", "starred_url": "https://api.github.com/users/est31/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/est31/subscriptions", "organizations_url": "https://api.github.com/users/est31/orgs", "repos_url": "https://api.github.com/users/est31/repos", "events_url": "https://api.github.com/users/est31/events{/privacy}", "received_events_url": "https://api.github.com/users/est31/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 36996, "node_id": "MDU6TGFiZWwzNjk5Ng==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-easy", "name": "E-easy", "color": "02e10c", "default": false, "description": "Call for participation: Experience needed to fix: Easy / not much (good first issue)"}, {"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 67766349, "node_id": "MDU6TGFiZWw2Nzc2NjM0OQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-mentor", "name": "E-mentor", "color": "02E10C", "default": false, "description": "Call for participation: This issue has a mentor. Use RustcContributor::new on Zulip for discussion."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 2046153791, "node_id": "MDU6TGFiZWwyMDQ2MTUzNzkx", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-target_feature_11", "name": "F-target_feature_11", "color": "f9c0cc", "default": false, "description": "target feature 1.1 RFC"}, {"id": 5223550385, "node_id": "LA_kwDOAAsO6M8AAAABN1kNsQ", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-target-feature", "name": "A-target-feature", "color": "f7e101", "default": false, "description": "Area: Enabling/disabling target features like AVX, Neon, etc."}], "state": "open", "locked": false, "assignee": {"login": "rohaquinlop", "id": 50106623, "node_id": "MDQ6VXNlcjUwMTA2NjIz", "avatar_url": "https://avatars.githubusercontent.com/u/50106623?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rohaquinlop", "html_url": "https://github.com/rohaquinlop", "followers_url": "https://api.github.com/users/rohaquinlop/followers", "following_url": "https://api.github.com/users/rohaquinlop/following{/other_user}", "gists_url": "https://api.github.com/users/rohaquinlop/gists{/gist_id}", "starred_url": "https://api.github.com/users/rohaquinlop/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rohaquinlop/subscriptions", "organizations_url": "https://api.github.com/users/rohaquinlop/orgs", "repos_url": "https://api.github.com/users/rohaquinlop/repos", "events_url": "https://api.github.com/users/rohaquinlop/events{/privacy}", "received_events_url": "https://api.github.com/users/rohaquinlop/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "rohaquinlop", "id": 50106623, "node_id": "MDQ6VXNlcjUwMTA2NjIz", "avatar_url": "https://avatars.githubusercontent.com/u/50106623?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rohaquinlop", "html_url": "https://github.com/rohaquinlop", "followers_url": "https://api.github.com/users/rohaquinlop/followers", "following_url": "https://api.github.com/users/rohaquinlop/following{/other_user}", "gists_url": "https://api.github.com/users/rohaquinlop/gists{/gist_id}", "starred_url": "https://api.github.com/users/rohaquinlop/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rohaquinlop/subscriptions", "organizations_url": "https://api.github.com/users/rohaquinlop/orgs", "repos_url": "https://api.github.com/users/rohaquinlop/repos", "events_url": "https://api.github.com/users/rohaquinlop/events{/privacy}", "received_events_url": "https://api.github.com/users/rohaquinlop/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 17, "created_at": "2023-03-02T22:36:32Z", "updated_at": "2023-04-05T17:27:44Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Given the following code:\r\n\r\n```Rust\r\n#![feature(target_feature_11)]\r\n\r\n#[target_feature(enable = \"sse2\", enable = \"avx\", enable = \"sse\")]\r\npub fn foo() {}\r\n\r\n#[target_feature(enable = \"sse\")]\r\nfn bar() {\r\n    foo();\r\n}\r\n```\r\n\r\nThe current output is:\r\n\r\n```\r\nerror[E0133]: call to function with `#[target_feature]` is unsafe and requires unsafe function or block\r\n --> src/main.rs:8:5\r\n  |\r\n8 |     foo();\r\n  |     ^^^^^ call to function with `#[target_feature]`\r\n  |\r\n  = note: can only be called if the required target features are available\r\n```\r\n\r\nThe note is easy to be misinterpreted: the function can also be called if the target features are not available, but it requires an `unsafe` annotation.\r\n\r\nI think it would be nice for the note to list the missing target features. In this case, this would be `sse2` and `avx`.\r\nIf one or more of the missing target features are enabled in the current build config, like via `-C target-feature` or `-C target-cpu`, or because the default is just that, then it should acknowledge this situation and explain that a `#[target_feature]` [is still required](https://github.com/rust-lang/rust/pull/99767#issuecomment-1447599807). \r\n\r\nSo I'd imagine something like:\r\n\r\n```\r\nerror[E0133]: call to function with `#[target_feature]` is unsafe and requires unsafe function or block\r\n --> src/main.rs:8:5\r\n  |\r\n8 |     foo();\r\n  |     ^^^^^ call to function with `#[target_feature]`\r\n  |\r\n  = help: in order for the call to be safe, the context requires the following additional target features: sse2, avx\r\n  = note: the sse2 target feature being enabled in the build configuration does not remove the requirement to list it in `#[target_feature]`\r\n```\r\n\r\n------\r\n\r\nTLDR: I ask for two things:\r\n\r\n1. removing the `note` in the general case (I think what it contains is already said in the main error msg), but if there are missing target features that are enabled in the build configuration, emit a note to point out that even though they are enabled, this has no influence on `#[target_feature]` (it's two different systems; see my example for the proposed wording)\r\n1. adding a `help` that lists the missing target features (ideally if too many like more than 5 are missing, then cut the list to keep the error message short (\"avx, sse2, sse, aes, foobar, and 3 more\"))\r\n\r\ncc #69098\r\n\r\n@rustbot label A-diagnostics F-target_feature_11  \r\n\r\n<!-- TRIAGEBOT_START -->\r\n\r\n<!-- TRIAGEBOT_ASSIGN_START -->\r\n\r\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"rohaquinlop\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\r\n\r\n<!-- TRIAGEBOT_ASSIGN_END -->\r\n<!-- TRIAGEBOT_END -->", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/108680/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/108680/timeline", "performed_via_github_app": null, "state_reason": null}