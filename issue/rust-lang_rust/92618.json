{"url": "https://api.github.com/repos/rust-lang/rust/issues/92618", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/92618/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/92618/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/92618/events", "html_url": "https://github.com/rust-lang/rust/issues/92618", "id": 1095510360, "node_id": "I_kwDOAAsO6M5BTClY", "number": 92618, "title": "ICE after switching branches.", "user": {"login": "kaj", "id": 358770, "node_id": "MDQ6VXNlcjM1ODc3MA==", "avatar_url": "https://avatars.githubusercontent.com/u/358770?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kaj", "html_url": "https://github.com/kaj", "followers_url": "https://api.github.com/users/kaj/followers", "following_url": "https://api.github.com/users/kaj/following{/other_user}", "gists_url": "https://api.github.com/users/kaj/gists{/gist_id}", "starred_url": "https://api.github.com/users/kaj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kaj/subscriptions", "organizations_url": "https://api.github.com/users/kaj/orgs", "repos_url": "https://api.github.com/users/kaj/repos", "events_url": "https://api.github.com/users/kaj/events{/privacy}", "received_events_url": "https://api.github.com/users/kaj/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2022-01-06T17:03:24Z", "updated_at": "2022-01-06T20:15:48Z", "closed_at": "2022-01-06T20:15:48Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for finding an Internal Compiler Error! \ud83e\uddca  If possible, try to provide\r\na minimal verifiable example. You can read \"Rust Bug Minimization Patterns\" for\r\nhow to create smaller examples.\r\n\r\nhttp://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/\r\n\r\n-->\r\n\r\n### Code\r\n\r\nI got an ICE when compiling https://github.com/kaj/r4s/commit/eab4d2f5c066966634484f2064e84dd21f94b374 after switching from another branch.  Compiling with nightly did not error, but then compiling with stable (where I got the error initially) after a cargo clean worked fine as well.  I was able to reproduce the error several times before the clean, but not after, even by switching back and forth between the branches.  So this is probably not caused by any specific code, but rather by some unfortunate circumstanses in finding out what parts of the code needs to be recompiled.\r\n\r\nMaybe someone can find something out from the backtrace, but if not I'll take no offence if this PR is just closed as unactionable.\r\n\r\nI've been using rust a lot since just before 1.0 was released, and this is the first time I have seen an ICE first-hand, so thank you all for the amazing quality of Rust and rustc!\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.57.0 (f1edd0429 2021-11-29)\r\nbinary: rustc\r\ncommit-hash: f1edd0429582dd29cccacaf50fd134b05593bd9c\r\ncommit-date: 2021-11-29\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.57.0\r\nLLVM version: 13.0.0\r\n```\r\n\r\n### Error output\r\n\r\n```\r\ncargo check\r\n   Compiling r4s v0.1.0 (/home/kaj/proj/r4s)\r\nthread 'rustc' panicked at 'called `Option::unwrap()` on a `None` value', /rustc/f1edd0429582dd29cccacaf50fd134b05593bd9c/compiler/rustc_hir/src/definitions.rs:452:14\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\r\n\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&template=ice.md\r\n\r\nnote: rustc 1.57.0 (f1edd0429 2021-11-29) running on x86_64-unknown-linux-gnu\r\n\r\nnote: compiler flags: -C embed-bitcode=no -C debuginfo=2 -C incremental --crate-type bin\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n\r\nquery stack during panic:\r\n#0 [evaluate_obligation] evaluating trait selection obligation `impl core::future::future::Future: core::marker::Send`\r\n#1 [typeck] type-checking `server::<impl at src/server/mod.rs:61:1: 149:2>::run`\r\nend of query stack\r\nerror: could not compile `r4s`\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary><strong>Backtrace</strong></summary>\r\n<p>\r\n\r\n```\r\nRUST_BACKTRACE=1 cargo check\r\n    Checking r4s v0.1.0 (/home/kaj/proj/r4s)\r\nthread 'rustc' panicked at 'called `Option::unwrap()` on a `None` value', /rustc/f1edd0429582dd29cccacaf50fd134b05593bd9c/compiler/rustc_hir/src/definitions.rs:452:14\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/f1edd0429582dd29cccacaf50fd134b05593bd9c/library/std/src/panicking.rs:517:5\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/f1edd0429582dd29cccacaf50fd134b05593bd9c/library/core/src/panicking.rs:100:14\r\n   2: core::panicking::panic\r\n             at /rustc/f1edd0429582dd29cccacaf50fd134b05593bd9c/library/core/src/panicking.rs:50:5\r\n   3: <rustc_query_impl::on_disk_cache::OnDiskCache as rustc_middle::ty::context::OnDiskCache>::def_path_hash_to_def_id\r\n   4: rustc_middle::dep_graph::dep_node::<impl rustc_query_system::dep_graph::dep_node::DepNodeParams<rustc_middle::ty::context::TyCtxt> for rustc_span::def_id::LocalDefId>::recover\r\n   5: rustc_query_impl::query_callbacks::hir_owner::force_from_dep_node\r\n   6: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n   7: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n   8: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n   9: rustc_query_system::query::plumbing::try_load_from_disk_and_cache_in_memory\r\n  10: rustc_query_system::query::plumbing::get_query\r\n  11: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::evaluate_obligation\r\n  12: <rustc_infer::infer::InferCtxt as rustc_trait_selection::traits::query::evaluate_obligation::InferCtxtExt>::evaluate_obligation\r\n  13: <rustc_infer::infer::InferCtxt as rustc_trait_selection::traits::query::evaluate_obligation::InferCtxtExt>::evaluate_obligation_no_overflow\r\n  14: rustc_trait_selection::traits::fulfill::FulfillProcessor::process_trait_obligation\r\n  15: rustc_trait_selection::traits::fulfill::FulfillProcessor::progress_changed_obligations\r\n  16: rustc_data_structures::obligation_forest::ObligationForest<O>::process_obligations\r\n  17: rustc_trait_selection::traits::fulfill::FulfillmentContext::select\r\n  18: <rustc_trait_selection::traits::fulfill::FulfillmentContext as rustc_infer::traits::engine::TraitEngine>::select_with_constness_where_possible\r\n  19: rustc_typeck::check::fn_ctxt::checks::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_argument_types\r\n  20: rustc_typeck::check::fn_ctxt::checks::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_method_argument_types\r\n  21: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_kind\r\n  22: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_with_expectation_and_args\r\n  23: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_kind\r\n  24: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_with_expectation_and_args\r\n  25: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_kind\r\n  26: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_with_expectation_and_args\r\n  27: rustc_typeck::check::fn_ctxt::checks::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_argument_types\r\n  28: rustc_typeck::check::fn_ctxt::checks::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_method_argument_types\r\n  29: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_kind\r\n  30: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_with_expectation_and_args\r\n  31: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_kind\r\n  32: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_with_expectation_and_args\r\n  33: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_kind\r\n  34: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_with_expectation_and_args\r\n  35: rustc_typeck::check::fn_ctxt::checks::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_decl_initializer\r\n  36: rustc_typeck::check::fn_ctxt::checks::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_decl_local\r\n  37: rustc_typeck::check::fn_ctxt::checks::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_stmt\r\n  38: rustc_typeck::check::fn_ctxt::checks::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_block_with_expected\r\n  39: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_with_expectation_and_args\r\n  40: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_with_expectation_and_args\r\n  41: rustc_typeck::check::fn_ctxt::checks::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_block_with_expected\r\n  42: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_with_expectation_and_args\r\n  43: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_return_expr\r\n  44: rustc_typeck::check::check::check_fn\r\n  45: rustc_typeck::check::closure::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_closure\r\n  46: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_kind\r\n  47: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_with_expectation_and_args\r\n  48: rustc_typeck::check::fn_ctxt::checks::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_argument_types\r\n  49: rustc_typeck::check::callee::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::confirm_builtin_call\r\n  50: rustc_typeck::check::callee::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_call\r\n  51: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_kind\r\n  52: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_expr_with_expectation_and_args\r\n  53: rustc_typeck::check::expr::<impl rustc_typeck::check::fn_ctxt::FnCtxt>::check_return_expr\r\n  54: rustc_typeck::check::check::check_fn\r\n  55: rustc_infer::infer::InferCtxtBuilder::enter\r\n  56: rustc_typeck::check::typeck\r\n  57: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task\r\n  58: rustc_data_structures::stack::ensure_sufficient_stack\r\n  59: rustc_query_system::query::plumbing::try_execute_query\r\n  60: rustc_query_system::query::plumbing::force_query_impl\r\n  61: rustc_query_impl::query_callbacks::typeck::force_from_dep_node\r\n  62: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n  63: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n  64: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n  65: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n  66: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n  67: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n  68: rustc_query_system::query::plumbing::try_load_from_disk_and_cache_in_memory\r\n  69: rustc_query_system::query::plumbing::try_execute_query\r\n  70: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::type_of\r\n  71: rustc_middle::ty::util::OpaqueTypeExpander::expand_opaque_ty\r\n  72: core::ops::function::impls::<impl core::ops::function::FnOnce<A> for &mut F>::call_once\r\n  73: <smallvec::SmallVec<A> as core::iter::traits::collect::Extend<<A as smallvec::Array>::Item>>::extend\r\n  74: rustc_middle::ty::util::fold_list\r\n  75: rustc_middle::ty::structural_impls::<impl rustc_middle::ty::fold::TypeFoldable for rustc_middle::ty::sty::Binder<T>>::super_fold_with\r\n  76: rustc_middle::ty::structural_impls::<impl rustc_middle::ty::fold::TypeFoldable for &rustc_middle::ty::TyS>::super_fold_with\r\n  77: <smallvec::SmallVec<A> as core::iter::traits::collect::Extend<<A as smallvec::Array>::Item>>::extend\r\n  78: rustc_middle::ty::fold::TypeFoldable::fold_with\r\n  79: rustc_middle::ty::structural_impls::<impl rustc_middle::ty::fold::TypeFoldable for &rustc_middle::ty::TyS>::super_fold_with\r\n  80: rustc_middle::ty::fold::TypeFoldable::fold_with\r\n  81: rustc_middle::ty::util::OpaqueTypeExpander::expand_opaque_ty\r\n  82: rustc_middle::ty::util::OpaqueTypeExpander::expand_opaque_ty\r\n  83: rustc_middle::ty::util::<impl rustc_middle::ty::context::TyCtxt>::try_expand_impl_trait_type\r\n  84: rustc_typeck::check::check::check_item_type\r\n  85: rustc_middle::hir::map::Map::visit_item_likes_in_module\r\n  86: rustc_typeck::check::check::check_mod_item_types\r\n  87: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task\r\n  88: rustc_data_structures::stack::ensure_sufficient_stack\r\n  89: rustc_query_system::query::plumbing::try_execute_query\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&template=ice.md\r\n\r\nnote: rustc 1.57.0 (f1edd0429 2021-11-29) running on x86_64-unknown-linux-gnu\r\n\r\nnote: compiler flags: -C embed-bitcode=no -C debuginfo=2 -C incremental --crate-type bin\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n\r\nquery stack during panic:\r\n#0 [evaluate_obligation] evaluating trait selection obligation `impl core::future::future::Future: core::marker::Send`\r\n#1 [typeck] type-checking `server::<impl at src/server/mod.rs:61:1: 149:2>::run`\r\n#2 [type_of] computing type of `server::<impl at src/server/mod.rs:61:1: 149:2>::run::{opaque#0}`\r\n#3 [check_mod_item_types] checking item types in top-level module\r\n#4 [analysis] running analysis passes on this crate\r\nend of query stack\r\nerror: could not compile `r4s`\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n", "closed_by": {"login": "kaj", "id": 358770, "node_id": "MDQ6VXNlcjM1ODc3MA==", "avatar_url": "https://avatars.githubusercontent.com/u/358770?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kaj", "html_url": "https://github.com/kaj", "followers_url": "https://api.github.com/users/kaj/followers", "following_url": "https://api.github.com/users/kaj/following{/other_user}", "gists_url": "https://api.github.com/users/kaj/gists{/gist_id}", "starred_url": "https://api.github.com/users/kaj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kaj/subscriptions", "organizations_url": "https://api.github.com/users/kaj/orgs", "repos_url": "https://api.github.com/users/kaj/repos", "events_url": "https://api.github.com/users/kaj/events{/privacy}", "received_events_url": "https://api.github.com/users/kaj/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/92618/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/92618/timeline", "performed_via_github_app": null, "state_reason": "completed"}