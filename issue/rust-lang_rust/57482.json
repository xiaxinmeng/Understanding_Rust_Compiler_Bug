{"url": "https://api.github.com/repos/rust-lang/project-rfc-2229/issues/4", "repository_url": "https://api.github.com/repos/rust-lang/project-rfc-2229", "labels_url": "https://api.github.com/repos/rust-lang/project-rfc-2229/issues/4/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/project-rfc-2229/issues/4/comments", "events_url": "https://api.github.com/repos/rust-lang/project-rfc-2229/issues/4/events", "html_url": "https://github.com/rust-lang/project-rfc-2229/issues/4", "id": 637993324, "node_id": "MDU6SXNzdWU2Mzc5OTMzMjQ=", "number": 4, "title": "Always make the \"upvar types\" a tuple of the actual upvar types (Parent issue#53488)", "user": {"login": "blitzerr", "id": 28721905, "node_id": "MDQ6VXNlcjI4NzIxOTA1", "avatar_url": "https://avatars.githubusercontent.com/u/28721905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/blitzerr", "html_url": "https://github.com/blitzerr", "followers_url": "https://api.github.com/users/blitzerr/followers", "following_url": "https://api.github.com/users/blitzerr/following{/other_user}", "gists_url": "https://api.github.com/users/blitzerr/gists{/gist_id}", "starred_url": "https://api.github.com/users/blitzerr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/blitzerr/subscriptions", "organizations_url": "https://api.github.com/users/blitzerr/orgs", "repos_url": "https://api.github.com/users/blitzerr/repos", "events_url": "https://api.github.com/users/blitzerr/events{/privacy}", "received_events_url": "https://api.github.com/users/blitzerr/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "arora-aman", "id": 4193035, "node_id": "MDQ6VXNlcjQxOTMwMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4193035?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arora-aman", "html_url": "https://github.com/arora-aman", "followers_url": "https://api.github.com/users/arora-aman/followers", "following_url": "https://api.github.com/users/arora-aman/following{/other_user}", "gists_url": "https://api.github.com/users/arora-aman/gists{/gist_id}", "starred_url": "https://api.github.com/users/arora-aman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arora-aman/subscriptions", "organizations_url": "https://api.github.com/users/arora-aman/orgs", "repos_url": "https://api.github.com/users/arora-aman/repos", "events_url": "https://api.github.com/users/arora-aman/events{/privacy}", "received_events_url": "https://api.github.com/users/arora-aman/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "arora-aman", "id": 4193035, "node_id": "MDQ6VXNlcjQxOTMwMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4193035?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arora-aman", "html_url": "https://github.com/arora-aman", "followers_url": "https://api.github.com/users/arora-aman/followers", "following_url": "https://api.github.com/users/arora-aman/following{/other_user}", "gists_url": "https://api.github.com/users/arora-aman/gists{/gist_id}", "starred_url": "https://api.github.com/users/arora-aman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arora-aman/subscriptions", "organizations_url": "https://api.github.com/users/arora-aman/orgs", "repos_url": "https://api.github.com/users/arora-aman/repos", "events_url": "https://api.github.com/users/arora-aman/events{/privacy}", "received_events_url": "https://api.github.com/users/arora-aman/received_events", "type": "User", "site_admin": false}, {"login": "roxelo", "id": 12419401, "node_id": "MDQ6VXNlcjEyNDE5NDAx", "avatar_url": "https://avatars.githubusercontent.com/u/12419401?v=4", "gravatar_id": "", "url": "https://api.github.com/users/roxelo", "html_url": "https://github.com/roxelo", "followers_url": "https://api.github.com/users/roxelo/followers", "following_url": "https://api.github.com/users/roxelo/following{/other_user}", "gists_url": "https://api.github.com/users/roxelo/gists{/gist_id}", "starred_url": "https://api.github.com/users/roxelo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/roxelo/subscriptions", "organizations_url": "https://api.github.com/users/roxelo/orgs", "repos_url": "https://api.github.com/users/roxelo/repos", "events_url": "https://api.github.com/users/roxelo/events{/privacy}", "received_events_url": "https://api.github.com/users/roxelo/received_events", "type": "User", "site_admin": false}], "milestone": {"url": "https://api.github.com/repos/rust-lang/project-rfc-2229/milestones/5", "html_url": "https://github.com/rust-lang/project-rfc-2229/milestone/5", "labels_url": "https://api.github.com/repos/rust-lang/project-rfc-2229/milestones/5/labels", "id": 6445617, "node_id": "MDk6TWlsZXN0b25lNjQ0NTYxNw==", "number": 5, "title": "Feature complete", "description": "* The feature largely works as specified\r\n* Migrations are largely complete\r\n* Diagnostics or corner cases may not be covered", "creator": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "open_issues": 1, "closed_issues": 35, "state": "open", "created_at": "2021-02-17T21:29:49Z", "updated_at": "2021-07-01T10:15:07Z", "due_on": "2021-05-01T07:00:00Z", "closed_at": null}, "comments": 18, "created_at": "2019-01-09T23:08:52Z", "updated_at": "2021-02-17T21:43:24Z", "closed_at": "2020-10-15T06:41:32Z", "author_association": "NONE", "active_lock_reason": null, "body": "**Updated by nikomatsakis with current status:**\r\n\r\nIn https://github.com/rust-lang/rust/pull/69968, @eddyb landed the \"first step\" here of introducing a tuple into the upvar types. However, in current rustc, we create that tuple \"eagerly\", as soon as we create the closure type:\r\n\r\nhttps://github.com/rust-lang/rust/blob/1a87c49e33d87955e28fa92a8d59a17264ac6044/src/librustc_typeck/check/closure.rs#L90-L103\r\n\r\nThe next step is to move that tuple creation \"late\", so that it occurs during the \"upvar analysis\" code, so somewhere around here:\r\n\r\nhttps://github.com/rust-lang/rust/blob/1a87c49e33d87955e28fa92a8d59a17264ac6044/src/librustc_typeck/check/upvar.rs#L194-L202\r\n\r\nThe problem with *this* is that the current accessor, [`ClosureSubsts::upvar_tys`](https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.ClosureSubsts.html#method.upvar_tys), assumes that the upvar types are a tuple with known arity. Thus any calls to `upvar_tys` that occur before the upvar analysis code runs will ICE. \r\n\r\nLast time, we added an accessor `upvar_tuple_ty` that returned the *tuple itself* (or an unbound type variable), since it turned out that many of the calls to `upvar_tys` could be replaced by a call that operated on the tuple. Most notably, in the trait system, for example here:\r\n\r\nhttps://github.com/rust-lang/rust/blob/1a87c49e33d87955e28fa92a8d59a17264ac6044/src/librustc_trait_selection/traits/select.rs#L2239-L2242\r\n\r\nWe changed this to yield the tuple always. The problem with *that* was that it was effecting the error messages, because the tuple was being introduced into the \"backtrace\" and we somehow never got things *quiite* right to remove it.\r\n\r\nI still think that is perhaps the right approach, but there is an alternative we could try: we could get the tuple ty and check whether it's been \"resolved\" yet (via a call to [`self.infcx.shallow_resolve`](https://doc.rust-lang.org/nightly/nightly-rustc/rustc_infer/infer/struct.InferCtxt.html#method.shallow_resolve)). If so, we can put each of its components as we do today, but if not, we can return `Ambiguous`, [as we do here](https://github.com/rust-lang/rust/blob/1a87c49e33d87955e28fa92a8d59a17264ac6044/src/librustc_trait_selection/traits/select.rs#L2249-L2254).", "closed_by": {"login": "arora-aman", "id": 4193035, "node_id": "MDQ6VXNlcjQxOTMwMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4193035?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arora-aman", "html_url": "https://github.com/arora-aman", "followers_url": "https://api.github.com/users/arora-aman/followers", "following_url": "https://api.github.com/users/arora-aman/following{/other_user}", "gists_url": "https://api.github.com/users/arora-aman/gists{/gist_id}", "starred_url": "https://api.github.com/users/arora-aman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arora-aman/subscriptions", "organizations_url": "https://api.github.com/users/arora-aman/orgs", "repos_url": "https://api.github.com/users/arora-aman/repos", "events_url": "https://api.github.com/users/arora-aman/events{/privacy}", "received_events_url": "https://api.github.com/users/arora-aman/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/project-rfc-2229/issues/4/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/project-rfc-2229/issues/4/timeline", "performed_via_github_app": null, "state_reason": "completed"}