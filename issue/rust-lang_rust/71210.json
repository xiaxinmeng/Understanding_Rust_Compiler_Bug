{"url": "https://api.github.com/repos/rust-lang/rust/issues/71210", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/71210/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/71210/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/71210/events", "html_url": "https://github.com/rust-lang/rust/issues/71210", "id": 601249214, "node_id": "MDU6SXNzdWU2MDEyNDkyMTQ=", "number": 71210, "title": "My program segfaults and/or aborts when I abuse generic_associated_types", "user": {"login": "jonaskoelker", "id": 4819862, "node_id": "MDQ6VXNlcjQ4MTk4NjI=", "avatar_url": "https://avatars.githubusercontent.com/u/4819862?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonaskoelker", "html_url": "https://github.com/jonaskoelker", "followers_url": "https://api.github.com/users/jonaskoelker/followers", "following_url": "https://api.github.com/users/jonaskoelker/following{/other_user}", "gists_url": "https://api.github.com/users/jonaskoelker/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonaskoelker/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonaskoelker/subscriptions", "organizations_url": "https://api.github.com/users/jonaskoelker/orgs", "repos_url": "https://api.github.com/users/jonaskoelker/repos", "events_url": "https://api.github.com/users/jonaskoelker/events{/privacy}", "received_events_url": "https://api.github.com/users/jonaskoelker/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}, {"id": 1485960423, "node_id": "MDU6TGFiZWwxNDg1OTYwNDIz", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-generic_associated_types", "name": "F-generic_associated_types", "color": "f9c0cc", "default": false, "description": "`#![feature(generic_associated_types)]` a.k.a. GATs"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2020-04-16T17:01:51Z", "updated_at": "2020-04-28T21:44:54Z", "closed_at": "2020-04-17T21:01:18Z", "author_association": "NONE", "active_lock_reason": null, "body": "I tried this code:\r\n\r\n```rust\r\n// segfaults when running on 1.44.0-nightly (94d346360 2020-04-09)\r\n#![allow(incomplete_features)]\r\n#![feature(generic_associated_types)]\r\n\r\nuse std::collections::hash_map::{HashMap, Iter};\r\n\r\npub enum Papadimoulian { True, FileNotFound } // any two will do\r\n\r\nfn visit_directory<FS: FileSystem>(fs: &FS) -> () {\r\n    let _unused = \"----------------------------------------------------------------------------\".to_string();\r\n    let mut iterator = fs.directory_iterator();\r\n    iterator.next();\r\n}\r\n\r\npub trait FileSystem {\r\n    type DirectoryIterator<'a>: Iterator<Item = Result<Box<u8>, Papadimoulian>>;\r\n    fn directory_iterator<'a>(&'a self) -> Self::DirectoryIterator<'a>;\r\n}\r\n\r\nimpl FileSystem for HashMap<(), ()> {\r\n    type DirectoryIterator<'a> = Iter<'a, (), ()>;\r\n    fn directory_iterator<'a>(&'a self) -> Iter<'a, (), ()> {\r\n        self.iter()\r\n    }\r\n}\r\n\r\n/*****/ fn main() { visit_directory(&HashMap::new()) }\r\n#[test] fn segv() { visit_directory(&HashMap::new()) }\r\n```\r\n(See also https://play.rust-lang.org/?version=nightly&mode=debug&edition=2018&gist=05e8a880961163a517c92515c4edff7d)\r\n\r\nWhen I feed this `main.rs` into `rustc` it happily gives me a `main` program. When I run said `main` program, I get `[1]    32118 segmentation fault (core dumped)  RUST_BACKTRACE=1 ./main` from `zsh`. (The `main` program also segfaults without `RUST_BACKTRACE=1`.)\r\n\r\nInstead, I expected the compiler to reject my program with a type error: The `HashMap` iterator has `Self::Item = (&'a K, &'a V)` which is not a `Result<Box<u8>, Papadimoulian>`\u2014yet if my program is to mean what I think it should mean, it's claiming that to be the case.\r\n\r\nIf I compile without `--release` and remove a dash from the unused string, I instead get `munmap_chunk(): invalid pointer`. If I remove all the dashes, or I remove the unused variable alltogether (and still compile without `--release`), I get `free(): invalid pointer`.\r\n\r\nIf I change `Box<u8>` to `Box<()>` I get a test success.\r\n\r\nIf I keep `Box<u8>` and replace `Papadimoulian` with `Option<()>` I get a segfault. I also get segfaults if I replace `Papadimoulian` with `bool` or `u8`, but not if I replace it with `()` (in all cases keeping `Box<u8>`.)\r\n\r\nThese two issues seem to be exploring the same feature, but with different results: #69184 and #67089.", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/71210/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/71210/timeline", "performed_via_github_app": null, "state_reason": "completed"}