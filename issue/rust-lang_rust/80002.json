{"url": "https://api.github.com/repos/rust-lang/rust/issues/80002", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/80002/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/80002/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/80002/events", "html_url": "https://github.com/rust-lang/rust/issues/80002", "id": 765156051, "node_id": "MDU6SXNzdWU3NjUxNTYwNTE=", "number": 80002, "title": "Illegal hardware instruction", "user": {"login": "lunacookies", "id": 31783266, "node_id": "MDQ6VXNlcjMxNzgzMjY2", "avatar_url": "https://avatars.githubusercontent.com/u/31783266?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lunacookies", "html_url": "https://github.com/lunacookies", "followers_url": "https://api.github.com/users/lunacookies/followers", "following_url": "https://api.github.com/users/lunacookies/following{/other_user}", "gists_url": "https://api.github.com/users/lunacookies/gists{/gist_id}", "starred_url": "https://api.github.com/users/lunacookies/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lunacookies/subscriptions", "organizations_url": "https://api.github.com/users/lunacookies/orgs", "repos_url": "https://api.github.com/users/lunacookies/repos", "events_url": "https://api.github.com/users/lunacookies/events{/privacy}", "received_events_url": "https://api.github.com/users/lunacookies/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2020-12-13T07:51:46Z", "updated_at": "2020-12-13T12:27:45Z", "closed_at": "2020-12-13T12:27:45Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I was helping a friend on [Advent of Code Day 13 Part 2](https://adventofcode.com/2020/day/13), and ran this broken (as in doesn\u2019t solve the problem and accidentally loops forever) code:\r\n\r\n```rust\r\nfn main() {\r\n    let data = (\r\n        1015292,\r\n        &[\r\n            19, 0, 0, 0, 0, 0, 0, 0, 0, 41, 0, 0, 0, 0, 0, 0, 0, 0, 0, 743, 0, 0, 0, 0, 0, 0, 0, 0,\r\n            0, 0, 0, 0, 13, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 29, 0, 643, 0, 0, 0, 0,\r\n            0, 37, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 23,\r\n        ][..],\r\n    );\r\n\r\n    println!(\"{}\", find_earliest_timestamp(data));\r\n}\r\n\r\nfn find_earliest_timestamp(data: (usize, &[usize])) -> usize {\r\n    let mut timestamp = 0;\r\n    let mut valid = false;\r\n\r\n    while !valid {\r\n        let valid = true;\r\n        let mut i = 0;\r\n\r\n        while i < data.1.len() {\r\n            if data.1[i] != 0 && (timestamp + i) % data.1[i] != 0 {\r\n                let valid = false;\r\n                break;\r\n            }\r\n\r\n            i += 1;\r\n        }\r\n\r\n        timestamp += data.1[0];\r\n    }\r\n\r\n    timestamp\r\n}\r\n```\r\n\r\n`Cargo.toml`:\r\n\r\n```toml\r\n[package]\r\nname = \"thing\"\r\nversion = \"0.1.0\"\r\nauthors = [\"Aramis Razzaghipour <aramisnoah@gmail.com>\"]\r\nedition = \"2018\"\r\n```\r\n\r\n```console\r\n$ rustc --version --verbose\r\nrustc 1.48.0 (7eac88abb 2020-11-16)\r\nbinary: rustc\r\ncommit-hash: 7eac88abb2e57e752f3302f02be5f3ce3d7adfb4\r\ncommit-date: 2020-11-16\r\nhost: x86_64-apple-darwin\r\nrelease: 1.48.0\r\nLLVM version: 11.0\r\n```\r\n\r\nRunning with `cargo run` does the right thing and loops forever (since `valid` is never mutated to be `true`). Running with `cargo run --release` gives an \u2018illegal hardware instruction\u2019 error:\r\n\r\n```console\r\n$ cargo run --release\r\n   Compiling thing v0.1.0 (/home/me/thing)\r\nwarning: unused variable: `valid`\r\n  --> src/main.rs:19:13\r\n   |\r\n19 |         let valid = true;\r\n   |             ^^^^^ help: if this is intentional, prefix it with an underscore: `_valid`\r\n   |\r\n   = note: `#[warn(unused_variables)]` on by default\r\n\r\nwarning: unused variable: `valid`\r\n  --> src/main.rs:24:21\r\n   |\r\n24 |                 let valid = false;\r\n   |                     ^^^^^ help: if this is intentional, prefix it with an underscore: `_valid`\r\n\r\nwarning: variable does not need to be mutable\r\n  --> src/main.rs:16:9\r\n   |\r\n16 |     let mut valid = false;\r\n   |         ----^^^^^\r\n   |         |\r\n   |         help: remove this `mut`\r\n   |\r\n   = note: `#[warn(unused_mut)]` on by default\r\n\r\nwarning: 3 warnings emitted\r\n\r\n    Finished release [optimized] target(s) in 0.89s\r\n     Running `target/release/thing`\r\nzsh: illegal hardware instruction  cargo run --release\r\n```\r\n\r\nThis happens both when compiling incrementally and when compiling from scratch. \r\n\r\nI repeatedly removed more and more elements from the code until I ended up with the following minimal example (it might not function the same, but it still gives the same error):\r\n\r\n```rust\r\nfn main() {\r\n    a();\r\n}\r\n\r\nfn a() {\r\n    loop {\r\n        loop {}\r\n    }\r\n}\r\n```\r\n\r\nCuriously the \u2018illegal hardware instruction\u2019 error goes away if I manually inline `a()` into `main()`. Adding `#[inline(always)]` to `a()` does **not** remove the error, though.\r\n\r\nCompiling with nightly\r\n\r\n```console\r\n$ rustc --version --verbose\r\nrustc 1.50.0-nightly (7efc097c4 2020-12-12)\r\nbinary: rustc\r\ncommit-hash: 7efc097c4fe6e97f54a44cee91c56189e9ddb41c\r\ncommit-date: 2020-12-12\r\nhost: x86_64-apple-darwin\r\nrelease: 1.50.0-nightly\r\n```\r\n\r\nor beta\r\n\r\n```console\r\n$ rustc --version --verbose\r\nrustc 1.49.0-beta.4 (877c7cbe1 2020-12-10)\r\nbinary: rustc\r\ncommit-hash: 877c7cbe142a373f93d38a23741dcc3a0a17a2af\r\ncommit-date: 2020-12-10\r\nhost: x86_64-apple-darwin\r\nrelease: 1.49.0-beta.4\r\n```\r\n\r\nfixes the issue.", "closed_by": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/80002/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/80002/timeline", "performed_via_github_app": null, "state_reason": "completed"}