{"url": "https://api.github.com/repos/rust-lang/rust/issues/107893", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/107893/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/107893/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/107893/events", "html_url": "https://github.com/rust-lang/rust/issues/107893", "id": 1580035564, "node_id": "I_kwDOAAsO6M5eLW3s", "number": 107893, "title": "Illegal instruction when running built binary on legacy CPU", "user": {"login": "skbeh", "id": 60107333, "node_id": "MDQ6VXNlcjYwMTA3MzMz", "avatar_url": "https://avatars.githubusercontent.com/u/60107333?v=4", "gravatar_id": "", "url": "https://api.github.com/users/skbeh", "html_url": "https://github.com/skbeh", "followers_url": "https://api.github.com/users/skbeh/followers", "following_url": "https://api.github.com/users/skbeh/following{/other_user}", "gists_url": "https://api.github.com/users/skbeh/gists{/gist_id}", "starred_url": "https://api.github.com/users/skbeh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/skbeh/subscriptions", "organizations_url": "https://api.github.com/users/skbeh/orgs", "repos_url": "https://api.github.com/users/skbeh/repos", "events_url": "https://api.github.com/users/skbeh/events{/privacy}", "received_events_url": "https://api.github.com/users/skbeh/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 11, "created_at": "2023-02-10T17:00:25Z", "updated_at": "2023-02-17T23:17:35Z", "closed_at": "2023-02-11T11:11:57Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried to build https://github.com/rapiz1/rathole with `cargo build --features=server,tls`\r\nThe built binary runs fine on a modern CPU, but it crashes on a old one which doesn't support AVX2.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```console\r\nrustc 1.67.1 (d5a82bbd2 2023-02-07) (Arch Linux rust 1:1.67.1-1.1)\r\nbinary: rustc\r\ncommit-hash: d5a82bbd26e1ad8b7401f6a718a9c57c96905483\r\ncommit-date: 2023-02-07\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.67.1\r\nLLVM version: 15.0.7\r\n```\r\n\r\n`/proc/cpuinfo` of executing machine:\r\n```\r\nflags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tscarch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 cx16 xtpr pdcm pcid sse4_1 sse4_2 x2apic popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm cpuid_fault epb ssbd ibrs ibpb stibp tpr_shadow vnmi flexpriority ept vpid fsgsbase smep erms xsaveopt dtherm ida arat pln pts md_clear flush_l1d\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```console\r\n$ gdb ./rathole\r\nGNU gdb 12.1\r\nCopyright (C) 2022 Free Software Foundation, Inc.\r\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\r\nThis is free software: you are free to change and redistribute it.\r\nThere is NO WARRANTY, to the extent permitted by law.\r\nType \"show copying\" and \"show warranty\" for details.\r\nThis GDB was configured as \"x86_64-linux-gnu\".\r\n\r\nFor help, type \"help\".\r\nType \"apropos word\" to search for commands related to \"word\"...\r\nReading symbols from ./rathole...\r\nUse `info auto-load python-scripts [REGEXP]' to list them.\r\n(gdb) run\r\nStarting program: rathole\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\r\n\r\nProgram received signal SIGILL, Illegal instruction.\r\ncore::slice::memchr::memchr_aligned (x=0, text=...) at library/core/src/slice/memchr.rs:93\r\n93      library/core/src/slice/memchr.rs: No such file or directory.\r\n(gdb) bt\r\n#0  core::slice::memchr::memchr_aligned (x=0, text=...) at library/core/src/slice/memchr.rs:93\r\n#1  0x0000555555cf56ef in core::slice::memchr::memchr (x=0, text=...) at library/core/src/slice/memchr.rs:44\r\n#2  core::ffi::c_str::CStr::from_bytes_with_nul (bytes=...) at library/core/src/ffi/c_str.rs:378\r\n#3  0x0000555555ccc02d in std::sys::common::small_c_string::run_with_cstr<std::sys::unix::fs::File, std::sys::unix::fs::{impl#14}::open::{closure_env#0}> (bytes=...,\r\nf=...) at library/std/src/sys/common/small_c_string.rs:42\r\n#4  std::sys::common::small_c_string::run_path_with_cstr<std::sys::unix::fs::File, std::sys::unix::fs::{impl#14}::open::{closure_env#0}> (path=..., f=...)\r\nat library/std/src/sys/common/small_c_string.rs:22\r\n#5  std::sys::unix::fs::File::open (path=..., opts=<optimized out>) at library/std/src/sys/unix/fs.rs:956\r\n#6  std::fs::OpenOptions::_open (self=0x7fffffffbe18, path=...) at library/std/src/fs.rs:1061\r\n#7  0x0000555555b2bbb1 in std::fs::OpenOptions::open<&std::path::Path> (self=0x7fffffffbe18, path=...)\r\nat /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/std/src/fs.rs:1057\r\n#8  0x0000555555b2bc25 in std::fs::File::open<&str> (path=...) at /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/std/src/fs.rs:352\r\n#9  0x0000555555b3394c in num_cpus::linux::Subsys::load_cpu<&str> (proc_path=...) at src/linux.rs:309\r\n#10 0x0000555555b3279c in num_cpus::linux::load_cgroups<&str, &str> (cgroup_proc=..., mountinfo_proc=...) at src/linux.rs:151\r\n#11 0x0000555555b326b4 in num_cpus::linux::init_cgroups () at src/linux.rs:134\r\n#12 0x0000555555b2c099 in core::ops::function::FnOnce::call_once<fn(), ()> () at /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/core/src/ops/function.rs:507\r\n#13 0x0000555555b309e3 in std::sync::once::{impl#2}::call_once::{closure#0}<fn()> () at /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/std/src/sync/once.rs:143\r\n#14 0x0000555555b3660d in std::sys_common::once::futex::Once::call<std::sync::once::{impl#2}::call_once::{closure_env#0}<fn()>> (\r\nself=0x555555f33c40 <num_cpus::linux::cgroups_num_cpus::ONCE>, ignore_poisoning=false, f=0x7fffffffc480)\r\nat /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/std/src/sys_common/once/futex.rs:113\r\n#15 0x0000555555b3096a in std::sync::once::Once::call_once<fn()> (self=0x555555f33c40 <num_cpus::linux::cgroups_num_cpus::ONCE>, f=0x0)\r\nat /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/std/src/sync/once.rs:143\r\n#16 0x0000555555b32618 in num_cpus::linux::cgroups_num_cpus () at src/linux.rs:114\r\n#17 0x0000555555b32409 in num_cpus::linux::get_num_cpus () at src/linux.rs:33\r\n#18 0x0000555555a9ef47 in num_cpus::get () at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/num_cpus-1.14.0/src/lib.rs:74\r\n#19 0x0000555555ad6b86 in tokio::loom::std::sys::num_cpus () at src/loom/std/mod.rs:88\r\n#20 0x0000555555af1ea9 in core::ops::function::FnOnce::call_once<fn() -> usize, ()> ()\r\nat /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/core/src/ops/function.rs:507\r\n#21 0x0000555555afd2b6 in core::option::Option<usize>::unwrap_or_else<usize, fn() -> usize> (self=..., f=0x0)\r\nat /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/core/src/option.rs:828\r\n#22 0x0000555555b02202 in tokio::runtime::builder::Builder::build_threaded_runtime (self=0x7fffffffddb8) at src/runtime/builder.rs:956\r\n#23 0x0000555555b01c99 in tokio::runtime::builder::Builder::build (self=0x7fffffffddb8) at src/runtime/builder.rs:630\r\n#24 0x000055555569780e in rathole::main () at src/main.rs:44\r\n```\r\n\r\n</p>\r\n</details>\r\n", "closed_by": {"login": "thomcc", "id": 860665, "node_id": "MDQ6VXNlcjg2MDY2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/860665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thomcc", "html_url": "https://github.com/thomcc", "followers_url": "https://api.github.com/users/thomcc/followers", "following_url": "https://api.github.com/users/thomcc/following{/other_user}", "gists_url": "https://api.github.com/users/thomcc/gists{/gist_id}", "starred_url": "https://api.github.com/users/thomcc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thomcc/subscriptions", "organizations_url": "https://api.github.com/users/thomcc/orgs", "repos_url": "https://api.github.com/users/thomcc/repos", "events_url": "https://api.github.com/users/thomcc/events{/privacy}", "received_events_url": "https://api.github.com/users/thomcc/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/107893/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/107893/timeline", "performed_via_github_app": null, "state_reason": "not_planned"}