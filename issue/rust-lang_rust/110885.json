{"url": "https://api.github.com/repos/rust-lang/rust/issues/110885", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/110885/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/110885/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/110885/events", "html_url": "https://github.com/rust-lang/rust/issues/110885", "id": 1686309771, "node_id": "I_kwDOAAsO6M5kgwuL", "number": 110885, "title": "ICE: `assertion failed: bpos.to_u32() >= mbc.pos.to_u32() + mbc.bytes as u32`", "user": {"login": "WendyWjt", "id": 32887053, "node_id": "MDQ6VXNlcjMyODg3MDUz", "avatar_url": "https://avatars.githubusercontent.com/u/32887053?v=4", "gravatar_id": "", "url": "https://api.github.com/users/WendyWjt", "html_url": "https://github.com/WendyWjt", "followers_url": "https://api.github.com/users/WendyWjt/followers", "following_url": "https://api.github.com/users/WendyWjt/following{/other_user}", "gists_url": "https://api.github.com/users/WendyWjt/gists{/gist_id}", "starred_url": "https://api.github.com/users/WendyWjt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/WendyWjt/subscriptions", "organizations_url": "https://api.github.com/users/WendyWjt/orgs", "repos_url": "https://api.github.com/users/WendyWjt/repos", "events_url": "https://api.github.com/users/WendyWjt/events{/privacy}", "received_events_url": "https://api.github.com/users/WendyWjt/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 91598611, "node_id": "MDU6TGFiZWw5MTU5ODYxMQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-inline-assembly", "name": "A-inline-assembly", "color": "f7e101", "default": false, "description": "Area: inline asm!(..)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2023-04-27T07:51:30Z", "updated_at": "2023-05-06T17:43:43Z", "closed_at": "2023-05-06T17:43:43Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for finding an Internal Compiler Error! \ud83e\uddca  If possible, try to provide\r\na minimal verifiable example. You can read \"Rust Bug Minimization Patterns\" for\r\nhow to create smaller examples.\r\nhttp://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/\r\n-->\r\n\r\nHi I got two confusions when trying to use `global_asm` and integrate some assembly codes.\r\n\r\n1. I got the internal compiler error listed as below;\r\n2. The error messages look wierd with arrows confusingly pointing to blankets or some existing labels. (If I just misunderstood them please correct me)\r\n\r\nAny Help would be appreciated very much :D\r\n\r\n### Code\r\n\r\n```Rust\r\nuse core::arch::global_asm;\r\n\r\nglobal_asm!(include_str!(\"./arm/func.S\"), options(raw));\r\nglobal_asm!(include_str!(\"./bug/bug.s\"), options(raw));\r\n\r\nfn main() {\r\n\r\n}\r\n```\r\n\r\nfunc.S:\r\n```\r\n#include \"macro_a.S\"\r\n#include \"macro_b.S\"\r\n#include \"macro_c.S\"\r\n\r\n.text\r\n.arch armv8-a+crypto\r\n\r\n.globl SOME_FUNC_A\r\n.type SOME_FUNC_A,%function\r\n.align 4\r\nSOME_FUNC_A:\r\n    IN_STP                                      // \u5bc4\u5b58\u5668\u4fdd\u62a4\r\n    b.eq .LEnc_1_process                      // \u8df3\u8f6c\r\n    b.eq .LEnc_2_process                      // \u8df3\u8f6c\r\n    b .LEnc_3_process                         // \u8df3\u8f6c\r\n\r\n.LEnc_1_process:\r\n    LOAD_HASH_TABLE                            // \u52a0\u8f7dg\r\n    b.le .LEnc_end                              // \u7b2c\u4e00\u6b2164\u5b57\u8282\u5904\u7406\u5b8c\u6bd5\uff0c\u5224\u65ad\u5269\u4f59\u957f\u5ea6\r\n    b .LEnc_1_loop                            // \u8fdb\u5165\u5faa\u73af\u5904\u7406\u6d41\u7a0b\r\n\r\n.LEnc_2_process:\r\n    LOAD_HASH_TABLE                                                // load hash table\r\n    b.le .LEnc_end\r\n    b .LEnc_2_loop\r\n\r\n.LEnc_3_process:\r\n    LOAD_HASH_TABLE\r\n    b.le .LEnc_end\r\n    b .LEnc_3_loop\r\n\r\n.LEnc_1_loop:\r\n    ENC1_LOOP                         // \u5904\u740664\u5b57\u8282\r\n    b.le .LEnc_end                          // \u5269\u4f59\u5757\u6570\u4e3a0, \u9000\u51fa\u5faa\u73af\r\n    b .LEnc_1_loop                        // \u7ee7\u7eed\u5faa\u73af\r\n\r\n.LEnc_2_loop:\r\n    ENC2_LOOP\r\n    b.le .LEnc_end                          // <= 0\r\n    b .LEnc_2_loop\r\n\r\n.LEnc_3_loop:\r\n    ENC3_LOOP\r\n    b.le .LEnc_end                          // <= 0\r\n    b .LEnc_3_loop\r\n\r\n.LEnc_end:\r\n    HASH_BLOCK\r\n    OUT_STP\r\n\r\n.LEnc_ret:\r\n    ret\r\n.size SOME_FUNC_A,.-SOME_FUNC_A\r\n```\r\n\r\nbug.s:\r\n```\r\n#include \"macro_a.S\"\r\n#include \"macro_b.S\"\r\n#include \"macro_c.S\"\r\n\r\n.globl SOME_FUNC_A\r\n.type SOME_FUNC_A,%function\r\n.align 4\r\nSOME_FUNC_A:\r\n    IN_STP                                      // \u5bc4\u5b58\u5668\u4fdd\u62a4\r\n    b.eq .LEnc_1_process                      // \u8df3\u8f6c1\u5904\u7406\u903b\u8f91\r\n    b.eq .LEnc_2_process                      // \u8df3\u8f6c2\u5904\u7406\u903b\u8f91\r\n    b .LEnc_3_process                         // \u8df3\u8f6c3\u5904\u7406\u903b\u8f91\r\n\r\n.LEnc_1_process:\r\n    b .LEnc_1_loop                            // \u8fdb\u5165\u5faa\u73af\u5904\u7406\u6d41\u7a0b\r\n\r\n.LEnc_1_loop:\r\n    b .LEnc_1_loop                        // \u7ee7\u7eed\u5faa\u73af\r\n.size SOME_FUNC_A,.-SOME_FUNC_A\r\n```\r\n\r\n\r\n\r\n\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\n<version>\r\nrustc 1.67.0 (fc594f156 2023-01-24)\r\nbinary: rustc\r\ncommit-hash: fc594f15669680fa70d255faec3ca3fb507c3405\r\ncommit-date: 2023-01-24\r\nhost: aarch64-unknown-linux-gnu\r\nrelease: 1.67.0\r\nLLVM version: 15.0.6\r\n```\r\n\r\n### Error output\r\n\r\n```\r\n<output>\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary><strong>Backtrace</strong></summary>\r\n<p>\r\n\r\n```\r\n<backtrace>\r\n\r\n   Compiling main v0.1.0 (/usr1/w00620137/rust_dev/test/main)\r\nerror: unrecognized instruction mnemonic\r\n   |\r\nnote: instantiated into assembly here\r\n  --> <inline asm>:12:16\r\n   |\r\n12 |     IN_STP                                      // \u5bc4\u5b58\u5668\u4fdd\u62a4\r\n   |                ^\r\n\r\nerror: unrecognized instruction mnemonic\r\n   |\r\nnote: instantiated into assembly here\r\n  --> <inline asm>:18:22\r\n   |\r\n18 |     LOAD_HASH_TABLE                            // \u52a0\u8f7dg\r\n   |                      ^\r\n\r\nerror: unrecognized instruction mnemonic\r\n   |\r\nnote: instantiated into assembly here\r\n  --> <inline asm>:23:27\r\n   |\r\n23 |     LOAD_HASH_TABLE                                                // load hash table\r\n   |                           ^\r\n\r\nerror: unrecognized instruction mnemonic\r\n   |\r\nnote: instantiated into assembly here\r\n  --> <inline asm>:29:12\r\n   |\r\n29 |     b.le .LEnc_end\r\n   |            ^\r\n\r\nerror: unrecognized instruction mnemonic\r\n   |\r\nnote: instantiated into assembly here\r\n  --> <inline asm>:33:37\r\n   |\r\n33 |     ENC1_LOOP                         // \u5904\u740664\u5b57\u8282\r\n   |                                     ^\r\n\r\nerror: unrecognized instruction mnemonic\r\n   |\r\nnote: instantiated into assembly here\r\n  --> <inline asm>:39:28\r\n   |\r\n39 |     b.le .LEnc_end                          // <= 0\r\n   |                            ^\r\n\r\nerror: unrecognized instruction mnemonic\r\n   |\r\nnote: instantiated into assembly here\r\n  --> <inline asm>:44:33\r\n   |\r\n44 |     b.le .LEnc_end                          // <= 0\r\n   |                                 ^\r\n\r\nerror: unrecognized instruction mnemonic\r\n   |\r\nnote: instantiated into assembly here\r\n  --> <inline asm>:53:5\r\n   |\r\n53 | .size SOME_FUNC_A,.-SOME_FUNC_A\r\n   |     ^\r\n\r\nerror: unrecognized instruction mnemonic\r\n   |\r\nnote: instantiated into assembly here\r\n  --> <inline asm>:53:21\r\n   |\r\n53 | .size SOME_FUNC_A,.-SOME_FUNC_A\r\n   |                     ^\r\n\r\nerror: symbol 'SOME_FUNC_A' is already defined\r\n   |\r\nnote: instantiated into assembly here\r\n  --> <inline asm>:62:48\r\n   |\r\n62 |     IN_STP                                      // \u5bc4\u5b58\u5668\u4fdd\u62a4\r\n   |                                                ^\r\n\r\nthread 'rustc' panicked at 'assertion failed: bpos.to_u32() >= mbc.pos.to_u32() + mbc.bytes as u32', compiler/rustc_span/src/lib.rs:1698:17\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/fc594f15669680fa70d255faec3ca3fb507c3405/library/std/src/panicking.rs:575:5\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/fc594f15669680fa70d255faec3ca3fb507c3405/library/core/src/panicking.rs:64:14\r\n   2: core::panicking::panic\r\n             at /rustc/fc594f15669680fa70d255faec3ca3fb507c3405/library/core/src/panicking.rs:111:5\r\n   3: <rustc_span::SourceFile>::lookup_file_pos\r\n   4: <rustc_span::SourceFile>::lookup_file_pos_with_col_display\r\n   5: <rustc_span::source_map::SourceMap>::lookup_char_pos\r\n   6: <rustc_errors::emitter::EmitterWriter>::get_multispan_max_line_num\r\n   7: <rustc_errors::emitter::EmitterWriter>::emit_messages_default\r\n   8: <rustc_errors::emitter::EmitterWriter as rustc_errors::emitter::Emitter>::emit_diagnostic\r\n   9: <rustc_errors::json::Diagnostic>::from_errors_diagnostic\r\n  10: <rustc_errors::json::JsonEmitter as rustc_errors::emitter::Emitter>::emit_diagnostic\r\n  11: <rustc_errors::HandlerInner>::emit_diagnostic\r\n  12: <() as rustc_errors::diagnostic_builder::EmissionGuarantee>::diagnostic_builder_emit_producing_guarantee\r\n  13: <rustc_codegen_ssa::back::write::SharedEmitterMain>::check\r\n  14: <rustc_codegen_ssa::back::write::OngoingCodegen<rustc_codegen_llvm::LlvmCodegenBackend>>::join\r\n  15: <rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_ssa::traits::backend::CodegenBackend>::join_codegen\r\n  16: <rustc_interface::queries::Linker>::link\r\n  17: rustc_span::with_source_map::<core::result::Result<(), rustc_errors::ErrorGuaranteed>, rustc_interface::interface::run_compiler<core::result::Result<(), rustc_errors::ErrorGuaranteed>, rustc_driver::run_compiler::{closure#1}>::{closure#0}::{closure#0}>\r\n  18: <scoped_tls::ScopedKey<rustc_span::SessionGlobals>>::set::<rustc_interface::interface::run_compiler<core::result::Result<(), rustc_errors::ErrorGuaranteed>, rustc_driver::run_compiler::{closure#1}>::{closure#0}, core::result::Result<(), rustc_errors::ErrorGuaranteed>>\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&template=ice.md\r\n\r\nnote: rustc 1.67.0 (fc594f156 2023-01-24) running on aarch64-unknown-linux-gnu\r\n\r\nnote: compiler flags: --crate-type bin -C embed-bitcode=no -C debuginfo=2 -C incremental=[REDACTED]\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n\r\nquery stack during panic:\r\nend of query stack\r\nerror: could not compile `main` due to 10 previous errors\r\n```\r\n\r\n</p>\r\n</details>\r\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/110885/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/110885/timeline", "performed_via_github_app": null, "state_reason": "completed"}