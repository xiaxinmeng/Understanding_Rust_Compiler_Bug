{"url": "https://api.github.com/repos/rust-lang/rust/issues/48677", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/48677/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/48677/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/48677/events", "html_url": "https://github.com/rust-lang/rust/issues/48677", "id": 301842052, "node_id": "MDU6SXNzdWUzMDE4NDIwNTI=", "number": 48677, "title": "Unintentionally cloning references can lead to confusing borrow checker errors", "user": {"login": "HexyWitch", "id": 3444300, "node_id": "MDQ6VXNlcjM0NDQzMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/3444300?v=4", "gravatar_id": "", "url": "https://api.github.com/users/HexyWitch", "html_url": "https://github.com/HexyWitch", "followers_url": "https://api.github.com/users/HexyWitch/followers", "following_url": "https://api.github.com/users/HexyWitch/following{/other_user}", "gists_url": "https://api.github.com/users/HexyWitch/gists{/gist_id}", "starred_url": "https://api.github.com/users/HexyWitch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/HexyWitch/subscriptions", "organizations_url": "https://api.github.com/users/HexyWitch/orgs", "repos_url": "https://api.github.com/users/HexyWitch/repos", "events_url": "https://api.github.com/users/HexyWitch/events{/privacy}", "received_events_url": "https://api.github.com/users/HexyWitch/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 171502053, "node_id": "MDU6TGFiZWwxNzE1MDIwNTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-borrow-checker", "name": "A-borrow-checker", "color": "f7e101", "default": false, "description": "Area: The borrow checker"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 1596121013, "node_id": "MDU6TGFiZWwxNTk2MTIxMDEz", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-confusing", "name": "D-confusing", "color": "c9f7a3", "default": false, "description": "Confusing diagnostic error that should be reworked"}, {"id": 1596122811, "node_id": "MDU6TGFiZWwxNTk2MTIyODEx", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-newcomer-roadblock", "name": "D-newcomer-roadblock", "color": "c9f7a3", "default": false, "description": "Confusing diagnostic error hard to understand for new users"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2018-03-02T17:20:45Z", "updated_at": "2021-01-18T19:04:23Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "(Note from pnkfelix: I have updated the example to continue illustrating the issue even in the presence of NLL.)\r\n\r\nThis issue is a result of all references implementing Clone. The following code will not compile:\r\n\r\n```rust\r\nfn foo<T: Default>(list: &mut Vec<T>) {\r\n    let mut cloned_items = Vec::new();\r\n    for v in list.iter() {\r\n        cloned_items.push(v.clone())\r\n    }\r\n    list.push(T::default());\r\n    drop(cloned_items);\r\n}\r\n```\r\nproducing the misleading error message:\r\n```rust\r\nerror[E0502]: cannot borrow `*list` as mutable because it is also borrowed as immutable\r\n --> src/main.rs:6:5\r\n  |\r\n3 |     for v in list.iter() {\r\n  |              ---- immutable borrow occurs here\r\n...\r\n6 |     list.push(T::default());\r\n  |     ^^^^ mutable borrow occurs here\r\n7 |     drop(cloned_items);\r\n  |          ------------ immutable borrow later used here\r\n  | - immutable borrow ends here\r\n```\r\n\r\nBecause Clone is not a trait bound on T, where you'd expect `v.clone()` to return a cloned T it's actually returning a cloned &T. The type of `cloned_items` is inferred to be `Vec<&T>`, and the lifetime of the `list` immutable borrow is extended to the lifetime of `cloned_items`. This is hard to figure out from the error message. The solution is to add Clone as a trait bound to T. The following code builds:\r\n```rust\r\nfn foo<T: Default + Clone>(list: &mut Vec<T>) {\r\n    let mut cloned_items = Vec::new();\r\n    for v in list.iter() {\r\n        cloned_items.push(v.clone())\r\n    }\r\n    list.push(T::default());\r\n}\r\n```\r\n\r\nIf you give cloned_items an explicit type\r\n```rust\r\nlet mut cloned_items: Vec<T> = Vec::new();\r\n```\r\nit gives an error that more clearly explains what you're doing wrong:\r\n```rust\r\nerror[E0308]: mismatched types\r\n --> src/main.rs:4:27\r\n  |\r\n4 |         cloned_items.push(v.clone())\r\n  |                           ^^^^^^^^^ expected type parameter, found &T\r\n  |\r\n  = note: expected type `T`\r\n             found type `&T`\r\n```\r\n\r\nI'm not sure what my proposed fix would be. I don't know if there are any use cases for explicitly cloning a reference. Ideally you'd get a warning on cloning a reference to a type that doesn't implement Clone.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/48677/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/48677/timeline", "performed_via_github_app": null, "state_reason": null}