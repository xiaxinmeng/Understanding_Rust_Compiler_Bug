{"url": "https://api.github.com/repos/rust-lang/rust/issues/107781", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/107781/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/107781/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/107781/events", "html_url": "https://github.com/rust-lang/rust/issues/107781", "id": 1575198514, "node_id": "I_kwDOAAsO6M5d458y", "number": 107781, "title": "LLVM error with fat LTO and Rust 1.67.0 to Rust 1.69.0 on Windows", "user": {"login": "michaelsproul", "id": 4452260, "node_id": "MDQ6VXNlcjQ0NTIyNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelsproul", "html_url": "https://github.com/michaelsproul", "followers_url": "https://api.github.com/users/michaelsproul/followers", "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}", "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions", "organizations_url": "https://api.github.com/users/michaelsproul/orgs", "repos_url": "https://api.github.com/users/michaelsproul/repos", "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelsproul/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 14, "created_at": "2023-02-07T23:36:15Z", "updated_at": "2023-04-03T12:09:58Z", "closed_at": "2023-04-03T12:09:58Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "While compiling a large Rust binary on Windows I ran into an unusual LLVM error:\r\n\r\n```\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke fastcc void @\"_ZN8smallvec17SmallVec$LT$A$GT$4push17h42691c75a9092543E\"(ptr noalias noundef nonnull align 8 dereferenceable(1328) %26, ptr noalias nocapture noundef nonnull dereferenceable(328) %10)\r\n          to label %32 unwind label %172\r\nCleanupReturnInst must unwind to an EH block which is not a landingpad.\r\n  cleanupret from %47 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke void %95(ptr noundef align 1 %81, ptr noalias noundef nonnull readonly align 8 dereferenceable(128) %3)\r\n          to label %96 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke fastcc void @\"_ZN8smallvec17SmallVec$LT$A$GT$4push17h42691c75a9092543E\"(ptr noalias noundef nonnull align 8 dereferenceable(1328) %99, ptr noalias nocapture noundef nonnull dereferenceable(328) %8)\r\n          to label %105 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke fastcc void @\"_ZN8smallvec17SmallVec$LT$A$GT$4push17h42691c75a9092543E\"(ptr noalias noundef nonnull align 8 dereferenceable(1328) %99, ptr noalias nocapture noundef nonnull dereferenceable(328) %7)\r\n          to label %109 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke fastcc void @\"_ZN8smallvec17SmallVec$LT$A$GT$4push17h42691c75a9092543E\"(ptr noalias noundef nonnull align 8 dereferenceable(1328) %143, ptr noalias nocapture noundef nonnull dereferenceable(328) %5)\r\n          to label %149 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  %156 = invoke fastcc noundef zeroext i1 @_ZN13futures_timer6native5delay5Delay6_reset17h39450cb69010166bE(ptr noalias noundef nonnull align 8 dereferenceable(8) %151, i64 %153, i32 noundef %155)\r\n          to label %157 unwind label %172\r\nCleanupReturnInst must unwind to an EH block which is not a landingpad.\r\n  cleanupret from %167 unwind label %172\r\nCleanupPadInst not the first non-PHI instruction in the block.\r\n  %175 = cleanuppad within none []\r\nin function _ZN94_$LT$libp2p_identify..handler..Handler$u20$as$u20$libp2p_swarm..handler..ConnectionHandler$GT$19on_connection_event17h5b45248c52481422E\r\nLLVM ERROR: Broken function found, compilation aborted!\r\nerror: could not compile `lighthouse`\r\nerror: failed to compile `lighthouse v3.4.0-tree.2 (C:\\Users\\Michael\\code\\lighthouse\\lighthouse)`, intermediate artifacts can be found at `C:\\Users\\Michael\\code\\lighthouse\\target`\r\n```\r\n\r\nI don't know how to produce a more minimal example. My experimenting so far has found that it only happens if all of these conditions are met:\r\n\r\n1. Compiling on Windows. Unaffected: Linux and macOS, as far as I can tell.\r\n2. Compiling with version 1.67.0 or newer of Rust. I tested v1.65.0 and v1.66.1 and they were unaffected. The 1.68.0-beta.2 _is_ affected, and so is nightly-2023-02-06.\r\n3. Using the following Cargo profile:\r\n\r\n```toml\r\n[profile.maxperf]\r\ninherits = \"release\"\r\nlto = \"fat\"\r\ncodegen-units = 1\r\nincremental = false\r\n```\r\n\r\nThe regular `release` profile does not trigger the error, even when all other conditions are met.\r\n\r\n---\r\n\r\nThe version of the binary (Lighthouse) built doesn't seem to matter too much, tags [`v3.4.0`](https://github.com/sigp/lighthouse/commit/38514c07f222ff7783834c48cf5c0a6ee7f346d0) and [`v3.4.0-tree.2`](https://github.com/sigp/lighthouse/commit/43843ca802c0d716959d05ece1b43ab8fd8489b0) both trigger the same error.\r\n\r\nLighthouse is open source and can be compiled locally (see [build deps](https://lighthouse-book.sigmaprime.io/installation-source.html)). It takes about 10 minutes on a fast machine to compile with the `maxperf` profile. The exact command I've been using to test is:\r\n\r\n```\r\ncargo +beta install --path lighthouse --force --locked --features modern,gnosis --profile maxperf\r\n```\r\n\r\nYou can also see a failed compilation on our public CI [here](https://github.com/sigp/lighthouse/actions/runs/4108517089/jobs/7090185548).\r\n\r\n### Meta\r\n\r\ninfo for 1.67.0:\r\n\r\n```\r\nrustc 1.67.0 (fc594f156 2023-01-24)\r\nbinary: rustc\r\ncommit-hash: fc594f15669680fa70d255faec3ca3fb507c3405\r\ncommit-date: 2023-01-24\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.67.0\r\nLLVM version: 15.0.6\r\n```\r\n\r\ninfo for 1.66.1:\r\n\r\n```\r\nrustc 1.66.1 (90743e729 2023-01-10)\r\nbinary: rustc\r\ncommit-hash: 90743e7298aca107ddaa0c202a4d3604e29bfeb6\r\ncommit-date: 2023-01-10\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.66.1\r\nLLVM version: 15.0.2\r\n```\r\n\r\ninfo for 1.68.0 beta:\r\n\r\n```\r\nrustc 1.68.0-beta.2 (10b73bf73 2023-02-01)\r\nbinary: rustc\r\ncommit-hash: 10b73bf73a6b770cd92ad8ff538173bc3298411c\r\ncommit-date: 2023-02-01\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.68.0-beta.2\r\nLLVM version: 15.0.6\r\n```\r\n\r\ninfo for nightly:\r\n\r\n```\r\nrustc 1.69.0-nightly (e1eaa2d5d 2023-02-06)\r\nbinary: rustc\r\ncommit-hash: e1eaa2d5d4d1f5b7b89561a940718058d414e89c\r\ncommit-date: 2023-02-06\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.69.0-nightly\r\nLLVM version: 15.0.7\r\n```\r\n\r\nMSVC info (not sure if this is relevant):\r\n\r\n```\r\nMicrosoft Visual C++ 2015-2019 Redistributable (x64) - 14.28.29334\r\n```\r\n\r\n<details>\r\n<summary>Error from 1.68.0-beta.2</summary>\r\n<p>\r\n\r\n```\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke fastcc void @\"_ZN8smallvec17SmallVec$LT$A$GT$4push17h39287a406bf356daE\"(ptr noalias noundef nonnull align 8 dereferenceable(1328) %26, ptr noalias nocapture noundef nonnull dereferenceable(328) %10)\r\n          to label %32 unwind label %172\r\nCleanupReturnInst must unwind to an EH block which is not a landingpad.\r\n  cleanupret from %47 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke void %95(ptr noundef align 1 %81, ptr noalias noundef nonnull readonly align 8 dereferenceable(128) %3)\r\n          to label %96 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke fastcc void @\"_ZN8smallvec17SmallVec$LT$A$GT$4push17h39287a406bf356daE\"(ptr noalias noundef nonnull align 8 dereferenceable(1328) %99, ptr noalias nocapture noundef nonnull dereferenceable(328) %8)\r\n          to label %105 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke fastcc void @\"_ZN8smallvec17SmallVec$LT$A$GT$4push17h39287a406bf356daE\"(ptr noalias noundef nonnull align 8 dereferenceable(1328) %99, ptr noalias nocapture noundef nonnull dereferenceable(328) %7)\r\n          to label %109 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke fastcc void @\"_ZN8smallvec17SmallVec$LT$A$GT$4push17h39287a406bf356daE\"(ptr noalias noundef nonnull align 8 dereferenceable(1328) %143, ptr noalias nocapture noundef nonnull dereferenceable(328) %5)\r\n          to label %149 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  %156 = invoke fastcc noundef zeroext i1 @_ZN13futures_timer6native5delay5Delay6_reset17h6935682b885c489fE(ptr noalias noundef nonnull align 8 dereferenceable(8) %151, i64 noundef %153, i32 noundef %155)\r\n          to label %157 unwind label %172\r\nCleanupReturnInst must unwind to an EH block which is not a landingpad.\r\n  cleanupret from %167 unwind label %172\r\nCleanupPadInst not the first non-PHI instruction in the block.\r\n  %175 = cleanuppad within none []\r\nin function _ZN94_$LT$libp2p_identify..handler..Handler$u20$as$u20$libp2p_swarm..handler..ConnectionHandler$GT$19on_connection_event17h8363995df26cfdb2E\r\nLLVM ERROR: Broken function found, compilation aborted!\r\nerror: could not compile `lighthouse`\r\nerror: failed to compile `lighthouse v3.4.0 (C:\\Users\\Michael\\code\\lighthouse\\lighthouse)`, intermediate artifacts can be found at `C:\\Users\\Michael\\code\\lighthouse\\target`\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n<details>\r\n<summary>Error from 1.69.0-nightly (2023-02-06)</summary>\r\n<p>\r\n\r\n```\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke fastcc void @\"_ZN8smallvec17SmallVec$LT$A$GT$4push17h4f3823b6c507c1cfE\"(ptr noalias noundef nonnull align 8 dereferenceable(1328) %26, ptr noalias nocapture noundef nonnull dereferenceable(328) %10)\r\n          to label %32 unwind label %172\r\nCleanupReturnInst must unwind to an EH block which is not a landingpad.\r\n  cleanupret from %47 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke void %95(ptr noundef align 1 %81, ptr noalias noundef nonnull readonly align 8 dereferenceable(128) %3)\r\n          to label %96 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke fastcc void @\"_ZN8smallvec17SmallVec$LT$A$GT$4push17h4f3823b6c507c1cfE\"(ptr noalias noundef nonnull align 8 dereferenceable(1328) %99, ptr noalias nocapture noundef nonnull dereferenceable(328) %8)\r\n          to label %105 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke fastcc void @\"_ZN8smallvec17SmallVec$LT$A$GT$4push17h4f3823b6c507c1cfE\"(ptr noalias noundef nonnull align 8 dereferenceable(1328) %99, ptr noalias nocapture noundef nonnull dereferenceable(328) %7)\r\n          to label %109 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  invoke fastcc void @\"_ZN8smallvec17SmallVec$LT$A$GT$4push17h4f3823b6c507c1cfE\"(ptr noalias noundef nonnull align 8 dereferenceable(1328) %143, ptr noalias nocapture noundef nonnull dereferenceable(328) %5)\r\n          to label %149 unwind label %172\r\nThe unwind destination does not have an exception handling instruction!\r\n  %156 = invoke fastcc noundef zeroext i1 @_ZN13futures_timer6native5delay5Delay6_reset17h6558842eb872485aE(ptr noalias noundef nonnull align 8 dereferenceable(8) %151, i64 noundef %153, i32 noundef %155)\r\n          to label %157 unwind label %172\r\nCleanupReturnInst must unwind to an EH block which is not a landingpad.\r\n  cleanupret from %167 unwind label %172\r\nCleanupPadInst not the first non-PHI instruction in the block.\r\n  %175 = cleanuppad within none []\r\nin function _ZN94_$LT$libp2p_identify..handler..Handler$u20$as$u20$libp2p_swarm..handler..ConnectionHandler$GT$19on_connection_event17hd239e1ec01457673E\r\nLLVM ERROR: Broken function found, compilation aborted!\r\nerror: could not compile `lighthouse`\r\nerror: failed to compile `lighthouse v3.4.0 (C:\\Users\\Michael\\code\\lighthouse\\lighthouse)`, intermediate artifacts can be found at `C:\\Users\\Michael\\code\\lighthouse\\target`\r\n```\r\n\r\n</p>\r\n</details>", "closed_by": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/107781/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/107781/timeline", "performed_via_github_app": null, "state_reason": "completed"}