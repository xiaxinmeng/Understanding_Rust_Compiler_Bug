{"url": "https://api.github.com/repos/rust-lang/rust/issues/89955", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/89955/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/89955/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/89955/events", "html_url": "https://github.com/rust-lang/rust/issues/89955", "id": 1028113176, "node_id": "I_kwDOAAsO6M49R8MY", "number": 89955, "title": "I/O safety breaks existing code", "user": {"login": "sunfishcode", "id": 4503403, "node_id": "MDQ6VXNlcjQ1MDM0MDM=", "avatar_url": "https://avatars.githubusercontent.com/u/4503403?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sunfishcode", "html_url": "https://github.com/sunfishcode", "followers_url": "https://api.github.com/users/sunfishcode/followers", "following_url": "https://api.github.com/users/sunfishcode/following{/other_user}", "gists_url": "https://api.github.com/users/sunfishcode/gists{/gist_id}", "starred_url": "https://api.github.com/users/sunfishcode/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sunfishcode/subscriptions", "organizations_url": "https://api.github.com/users/sunfishcode/orgs", "repos_url": "https://api.github.com/users/sunfishcode/repos", "events_url": "https://api.github.com/users/sunfishcode/events{/privacy}", "received_events_url": "https://api.github.com/users/sunfishcode/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": {"login": "sunfishcode", "id": 4503403, "node_id": "MDQ6VXNlcjQ1MDM0MDM=", "avatar_url": "https://avatars.githubusercontent.com/u/4503403?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sunfishcode", "html_url": "https://github.com/sunfishcode", "followers_url": "https://api.github.com/users/sunfishcode/followers", "following_url": "https://api.github.com/users/sunfishcode/following{/other_user}", "gists_url": "https://api.github.com/users/sunfishcode/gists{/gist_id}", "starred_url": "https://api.github.com/users/sunfishcode/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sunfishcode/subscriptions", "organizations_url": "https://api.github.com/users/sunfishcode/orgs", "repos_url": "https://api.github.com/users/sunfishcode/repos", "events_url": "https://api.github.com/users/sunfishcode/events{/privacy}", "received_events_url": "https://api.github.com/users/sunfishcode/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "sunfishcode", "id": 4503403, "node_id": "MDQ6VXNlcjQ1MDM0MDM=", "avatar_url": "https://avatars.githubusercontent.com/u/4503403?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sunfishcode", "html_url": "https://github.com/sunfishcode", "followers_url": "https://api.github.com/users/sunfishcode/followers", "following_url": "https://api.github.com/users/sunfishcode/following{/other_user}", "gists_url": "https://api.github.com/users/sunfishcode/gists{/gist_id}", "starred_url": "https://api.github.com/users/sunfishcode/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sunfishcode/subscriptions", "organizations_url": "https://api.github.com/users/sunfishcode/orgs", "repos_url": "https://api.github.com/users/sunfishcode/repos", "events_url": "https://api.github.com/users/sunfishcode/events{/privacy}", "received_events_url": "https://api.github.com/users/sunfishcode/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2021-10-16T18:11:30Z", "updated_at": "2021-10-23T15:45:29Z", "closed_at": "2021-10-23T15:45:29Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "As reported [here](https://github.com/rust-lang/rust/pull/87329#issuecomment-943618902), the [I/O safety feature](https://github.com/rust-lang/rust/issues/87074) introduces a breaking change.\r\n\r\nReduced standalone testcase ([playground link](https://play.rust-lang.org/?version=nightly&mode=debug&edition=2018&gist=22674235d5fca847231ac9829b942293)):\r\n```rust\r\nuse std::os::unix::io::FromRawFd;\r\nuse std::fs::File;\r\n\r\npub fn create_fd<F: FromRawFd>() -> F {\r\n    todo!()\r\n}\r\n\r\nfn main() {\r\n    let _f = File::from(create_fd());\r\n}\r\n```\r\n```\r\nerror[E0283]: type annotations needed\r\n   --> src/main.rs:9:14\r\n    |\r\n9   |     let _f = File::from(create_fd());\r\n    |              ^^^^^^^^^^ cannot infer type for type parameter `T` declared on the trait `From`\r\n    |\r\n    = note: cannot satisfy `File: From<_>`\r\nnote: required by `from`\r\n   --> /.../lib/rustlib/src/rust/library/core/src/convert/mod.rs:371:5\r\n    |\r\n371 |     fn from(_: T) -> Self;\r\n    |     ^^^^^^^^^^^^^^^^^^^^^^\r\n```\r\nIt's possible to change the code to avoid the error, for example by changing the `let _f = ...` line to either of:\r\n```rust\r\n    let _f = create_fd::<File>();\r\n    let _f: File = create_fd(); \r\n```\r\nor, once I/O safety is stabilized, by changing `create_fd` to return `OwnedFd` instead of `F: FromRawFd`. The reporter also reported that they've already fixed their own code. Nevertheless, it is breakage observed in real-world code.\r\n\r\nThe problem is caused by I/O safety adding an `impl From<OwnedFd> for File`. We added these `From` impls as an alternative to adding a new `FromFd` trait. However, this means that `File` now has multiple `From` impls for types that implement `AsRawFd`, so one can no longer do `File::from(create_fd())` where `create_fd` is defined like `fn create_fd<F: FromRawFd>() -> F`, because it's now ambiguous which type it should use for `F`.\r\n\r\nSo the questions here are:\r\n - Is this breakage severe enough to block stabilization for I/O safety?\r\n - If so, is there a way to fix it other than going back to adding a `FromFd` trait?\r\n", "closed_by": {"login": "sunfishcode", "id": 4503403, "node_id": "MDQ6VXNlcjQ1MDM0MDM=", "avatar_url": "https://avatars.githubusercontent.com/u/4503403?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sunfishcode", "html_url": "https://github.com/sunfishcode", "followers_url": "https://api.github.com/users/sunfishcode/followers", "following_url": "https://api.github.com/users/sunfishcode/following{/other_user}", "gists_url": "https://api.github.com/users/sunfishcode/gists{/gist_id}", "starred_url": "https://api.github.com/users/sunfishcode/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sunfishcode/subscriptions", "organizations_url": "https://api.github.com/users/sunfishcode/orgs", "repos_url": "https://api.github.com/users/sunfishcode/repos", "events_url": "https://api.github.com/users/sunfishcode/events{/privacy}", "received_events_url": "https://api.github.com/users/sunfishcode/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/89955/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/89955/timeline", "performed_via_github_app": null, "state_reason": "completed"}