{"url": "https://api.github.com/repos/rust-lang/rust/issues/103001", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/103001/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/103001/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/103001/events", "html_url": "https://github.com/rust-lang/rust/issues/103001", "id": 1407095759, "node_id": "I_kwDOAAsO6M5T3pPP", "number": 103001, "title": "Synthetic object files disable control flow protection features", "user": {"login": "pcc", "id": 425024, "node_id": "MDQ6VXNlcjQyNTAyNA==", "avatar_url": "https://avatars.githubusercontent.com/u/425024?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcc", "html_url": "https://github.com/pcc", "followers_url": "https://api.github.com/users/pcc/followers", "following_url": "https://api.github.com/users/pcc/following{/other_user}", "gists_url": "https://api.github.com/users/pcc/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcc/subscriptions", "organizations_url": "https://api.github.com/users/pcc/orgs", "repos_url": "https://api.github.com/users/pcc/repos", "events_url": "https://api.github.com/users/pcc/events{/privacy}", "received_events_url": "https://api.github.com/users/pcc/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 122062043, "node_id": "MDU6TGFiZWwxMjIwNjIwNDM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-security", "name": "A-security", "color": "f7e101", "default": false, "description": "Area: Security related issues (example: address space layout randomization)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 4574755208, "node_id": "LA_kwDOAAsO6M8AAAABEK05iA", "url": "https://api.github.com/repos/rust-lang/rust/labels/PG-exploit-mitigations", "name": "PG-exploit-mitigations", "color": "c2e0c6", "default": false, "description": "Project group: exploit mitigations"}], "state": "closed", "locked": false, "assignee": {"login": "cchiw", "id": 1305366, "node_id": "MDQ6VXNlcjEzMDUzNjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1305366?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cchiw", "html_url": "https://github.com/cchiw", "followers_url": "https://api.github.com/users/cchiw/followers", "following_url": "https://api.github.com/users/cchiw/following{/other_user}", "gists_url": "https://api.github.com/users/cchiw/gists{/gist_id}", "starred_url": "https://api.github.com/users/cchiw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cchiw/subscriptions", "organizations_url": "https://api.github.com/users/cchiw/orgs", "repos_url": "https://api.github.com/users/cchiw/repos", "events_url": "https://api.github.com/users/cchiw/events{/privacy}", "received_events_url": "https://api.github.com/users/cchiw/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "cchiw", "id": 1305366, "node_id": "MDQ6VXNlcjEzMDUzNjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1305366?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cchiw", "html_url": "https://github.com/cchiw", "followers_url": "https://api.github.com/users/cchiw/followers", "following_url": "https://api.github.com/users/cchiw/following{/other_user}", "gists_url": "https://api.github.com/users/cchiw/gists{/gist_id}", "starred_url": "https://api.github.com/users/cchiw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cchiw/subscriptions", "organizations_url": "https://api.github.com/users/cchiw/orgs", "repos_url": "https://api.github.com/users/cchiw/repos", "events_url": "https://api.github.com/users/cchiw/events{/privacy}", "received_events_url": "https://api.github.com/users/cchiw/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2022-10-13T03:48:51Z", "updated_at": "2023-05-09T11:07:31Z", "closed_at": "2023-05-09T11:07:31Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I noticed that the synthetic object files added in #95604 will disable the IBT (on x86, enabled by `-Z cf-protection=branch`) and BTI (on AArch64, enabled by `-Z branch-protection=bti`) features because the object files are missing `.note.gnu.property` sections indicating that the object file is compatible with those features. Normally, if an object file is missing a `.note.gnu.property` section, the linker will disable all such features, on the assumption that the object file is not compatible.\n\nThis issue is reproducible on the master branch (slightly awkwardly because many distros don't ship IBT-enabled `*crt*.o` files, and neither is it enabled in Rust's standard library by default):\n```\nRUSTFLAGS_NOT_BOOTSTRAP='-Zcf-protection=branch' python3 x.py build  --target x86_64-unknown-linux-gnu --stage 1\nrustup toolchain link stage1 build/x86_64-unknown-linux-gnu/stage1\n```\nIn another directory:\n```\n> cat hello.rs\nfn main() {\n    println!(\"hello world\");\n}\n> rustc +stage1 -Z cf-protection=branch hello.rs -C link-args='-nostartfiles'\n> readelf -nW hello\n\nDisplaying notes found in: .note.gnu.build-id\n  Owner                Data size \tDescription\n  GNU                  0x00000014\tNT_GNU_BUILD_ID (unique build ID bitstring)\t    Build ID: 9bc8182397b263d79d29c83448350ec033a6f66b\n```\nAfter commenting out the line of code that adds `symbols.o` to the link:\n```\ndiff --git a/compiler/rustc_codegen_ssa/src/back/link.rs b/compiler/rustc_codegen_ssa/src/back/link.rs\nindex 95e72184ff0..ed314db6772 100644\n--- a/compiler/rustc_codegen_ssa/src/back/link.rs\n+++ b/compiler/rustc_codegen_ssa/src/back/link.rs\n@@ -1795,7 +1795,7 @@ fn add_linked_symbol_object(\n     if let Err(e) = result {\n         sess.fatal(&format!(\"failed to write {}: {}\", path.display(), e));\n     }\n-    cmd.add_object(&path);\n+    //cmd.add_object(&path);\n }\n \n /// Add object files containing code from the current crate.\n```\nthe binary has the correct property note:\n```\nDisplaying notes found in: .note.gnu.property\n  Owner                Data size \tDescription\n  GNU                  0x00000010\tNT_GNU_PROPERTY_TYPE_0\t      Properties: x86 feature: IBT\n\nDisplaying notes found in: .note.gnu.build-id\n  Owner                Data size \tDescription\n  GNU                  0x00000014\tNT_GNU_BUILD_ID (unique build ID bitstring)\t    Build ID: fb555c532955966767702c5af52844dbcc9a386c\n```\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"cchiw\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/103001/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/103001/timeline", "performed_via_github_app": null, "state_reason": "completed"}