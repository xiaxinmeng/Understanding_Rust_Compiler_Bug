{"url": "https://api.github.com/repos/rust-lang/rust/issues/46138", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/46138/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/46138/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/46138/events", "html_url": "https://github.com/rust-lang/rust/issues/46138", "id": 275521756, "node_id": "MDU6SXNzdWUyNzU1MjE3NTY=", "number": 46138, "title": "Using system allocator does not seem to have worked since nightly-2017-07-06", "user": {"login": "cswindle", "id": 16157454, "node_id": "MDQ6VXNlcjE2MTU3NDU0", "avatar_url": "https://avatars.githubusercontent.com/u/16157454?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cswindle", "html_url": "https://github.com/cswindle", "followers_url": "https://api.github.com/users/cswindle/followers", "following_url": "https://api.github.com/users/cswindle/following{/other_user}", "gists_url": "https://api.github.com/users/cswindle/gists{/gist_id}", "starred_url": "https://api.github.com/users/cswindle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cswindle/subscriptions", "organizations_url": "https://api.github.com/users/cswindle/orgs", "repos_url": "https://api.github.com/users/cswindle/repos", "events_url": "https://api.github.com/users/cswindle/events{/privacy}", "received_events_url": "https://api.github.com/users/cswindle/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-11-20T22:31:36Z", "updated_at": "2017-11-20T22:45:26Z", "closed_at": "2017-11-20T22:45:26Z", "author_association": "NONE", "active_lock_reason": null, "body": "I am trying to track down a memory leak in a crate that we developed and have found that we are unable to use valgrind with rust binaries using alloc_system. Having done some binary chopping it looks to have been broken since nightly-2017-07-06.\r\n\r\n[memory-leak.zip](https://github.com/rust-lang/rust/files/1489346/memory-leak.zip) has a memory leak in it on purpose, below is what I would expect the output to be when run using valgrind:\r\n\r\n```\r\n[memory-leak]$ rustup default nightly-2017-07-06\r\ninfo: using existing install for 'nightly-2017-07-06-x86_64-unknown-linux-gnu'\r\ninfo: default toolchain set to 'nightly-2017-07-06-x86_64-unknown-linux-gnu'\r\n\r\n  nightly-2017-07-06-x86_64-unknown-linux-gnu unchanged - rustc 1.20.0-nightly (3610a70ce 2017-07-05)\r\n\r\n[memory-leak]$ cargo build\r\n    Finished dev [unoptimized + debuginfo] target(s) in 0.0 secs\r\n[memory-leak]$ valgrind target/debug/memory-leak\r\n==16672== Memcheck, a memory error detector\r\n==16672== Copyright (C) 2002-2015, and GNU GPL'd, by Julian Seward et al.\r\n==16672== Using Valgrind-3.11.0 and LibVEX; rerun with -h for copyright info\r\n==16672== Command: target/debug/memory-leak\r\n==16672==\r\n4\r\n==16672==\r\n==16672== HEAP SUMMARY:\r\n==16672==     in use at exit: 257 bytes in 7 blocks\r\n==16672==   total heap usage: 22 allocs, 15 frees, 2,541 bytes allocated\r\n==16672==\r\n==16672== LEAK SUMMARY:\r\n==16672==    definitely lost: 4 bytes in 1 blocks\r\n==16672==    indirectly lost: 0 bytes in 0 blocks\r\n==16672==      possibly lost: 0 bytes in 0 blocks\r\n==16672==    still reachable: 253 bytes in 6 blocks\r\n==16672==         suppressed: 0 bytes in 0 blocks\r\n==16672== Rerun with --leak-check=full to see details of leaked memory\r\n==16672==\r\n==16672== For counts of detected and suppressed errors, rerun with: -v\r\n==16672== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)\r\n```\r\n\r\nHowever with any later versions of rust I get the following indicating that there are no memory leaks (even though there obviously are):\r\n\r\n```\r\n[memory-leak]$ rustup default nightly-2017-07-07\r\ninfo: using existing install for 'nightly-2017-07-07-x86_64-unknown-linux-gnu'\r\ninfo: default toolchain set to 'nightly-2017-07-07-x86_64-unknown-linux-gnu'\r\n\r\n  nightly-2017-07-07-x86_64-unknown-linux-gnu unchanged - rustc 1.20.0-nightly (696412de7 2017-07-06)\r\n[memory-leak]$ cargo build\r\n    Finished dev [unoptimized + debuginfo] target(s) in 0.0 secs\r\n[memory-leak]$ valgrind target/debug/memory-leak\r\n==16644== Memcheck, a memory error detector\r\n==16644== Copyright (C) 2002-2015, and GNU GPL'd, by Julian Seward et al.\r\n==16644== Using Valgrind-3.11.0 and LibVEX; rerun with -h for copyright info\r\n==16644== Command: target/debug/memory-leak\r\n==16644==\r\n4\r\n==16644==\r\n==16644== HEAP SUMMARY:\r\n==16644==     in use at exit: 0 bytes in 0 blocks\r\n==16644==   total heap usage: 4 allocs, 4 frees, 960 bytes allocated\r\n==16644==\r\n==16644== All heap blocks were freed -- no leaks are possible\r\n==16644==\r\n==16644== For counts of detected and suppressed errors, rerun with: -v\r\n==16644== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)\r\n```\r\n\r\nWas there a change in the way that we should switch to the system allocator, or has this just been broken for a fair amount of time?", "closed_by": {"login": "cswindle", "id": 16157454, "node_id": "MDQ6VXNlcjE2MTU3NDU0", "avatar_url": "https://avatars.githubusercontent.com/u/16157454?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cswindle", "html_url": "https://github.com/cswindle", "followers_url": "https://api.github.com/users/cswindle/followers", "following_url": "https://api.github.com/users/cswindle/following{/other_user}", "gists_url": "https://api.github.com/users/cswindle/gists{/gist_id}", "starred_url": "https://api.github.com/users/cswindle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cswindle/subscriptions", "organizations_url": "https://api.github.com/users/cswindle/orgs", "repos_url": "https://api.github.com/users/cswindle/repos", "events_url": "https://api.github.com/users/cswindle/events{/privacy}", "received_events_url": "https://api.github.com/users/cswindle/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/46138/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/46138/timeline", "performed_via_github_app": null, "state_reason": "completed"}