{"url": "https://api.github.com/repos/rust-lang/rust/issues/48207", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/48207/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/48207/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/48207/events", "html_url": "https://github.com/rust-lang/rust/issues/48207", "id": 297084407, "node_id": "MDU6SXNzdWUyOTcwODQ0MDc=", "number": 48207, "title": "NEON instructions presents in jemalloc for Armv7 android", "user": {"login": "kali", "id": 53657, "node_id": "MDQ6VXNlcjUzNjU3", "avatar_url": "https://avatars.githubusercontent.com/u/53657?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kali", "html_url": "https://github.com/kali", "followers_url": "https://api.github.com/users/kali/followers", "following_url": "https://api.github.com/users/kali/following{/other_user}", "gists_url": "https://api.github.com/users/kali/gists{/gist_id}", "starred_url": "https://api.github.com/users/kali/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kali/subscriptions", "organizations_url": "https://api.github.com/users/kali/orgs", "repos_url": "https://api.github.com/users/kali/repos", "events_url": "https://api.github.com/users/kali/events{/privacy}", "received_events_url": "https://api.github.com/users/kali/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 55301954, "node_id": "MDU6TGFiZWw1NTMwMTk1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-Arm", "name": "O-Arm", "color": "6e6ec0", "default": false, "description": "Target: 32-bit Arm processors (armv6, armv7, thumb...), including 64-bit Arm in AArch32 state"}, {"id": 325438536, "node_id": "MDU6TGFiZWwzMjU0Mzg1MzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-bootstrap", "name": "T-bootstrap", "color": "bfd4f2", "default": false, "description": "Relevant to the bootstrap subteam: Rust's build system (x.py and src/bootstrap)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-02-14T12:50:36Z", "updated_at": "2018-11-03T15:08:06Z", "closed_at": "2018-11-03T15:08:06Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Armv7 android spec do not ensure NEON support, even if most actual devices have it. The simulator does not support the extensions.\r\n\r\nWhen running rust executable in the android emulator, jemalloc triggers Invalid instructions errors as its code contains vmov.i32 (among others) instructions.\r\n\r\n```\r\n  64cdc:    0a0000c6     beq    64ffc <je_tcache_boot+0x3d4>\r\n  64ce0:    e59f1394     ldr    r1, [pc, #916]    ; 6507c <je_tcache_boot+0x454>\r\n  64ce4:    f2c12055     vmov.i32    q9, #21    ; 0x00000015\r\n  64ce8:    f3c44058     vmov.i32    q10, #200    ; 0x000000c8\r\n  64cec:    e3a07000     mov    r7, #0\r\n  64cf0:    f2c16054     vmov.i32    q11, #20    ; 0x00000014\r\n  64cf4:    e3a050c8     mov    r5, #200    ; 0xc8\r\n  64cf8:    e79f1001     ldr    r1, [pc, r1]\r\n  64cfc:    e2812080     add    r2, r1, #128    ; 0x80\r\n  64d00:    e2813e16     add    r3, r1, #352    ; 0x160\r\n```\r\n\r\nThis issue is only visible when 1/ running a rust binary (as in, not a library) and 2/ on the simulator or one of the very rare devices that do not actually have  support.\r\n\r\nto reproduce:\r\n```\r\navdmanager create avd -n test -k \"system-images;android-21;google_apis;armeabi-v7a\"\r\n$ANDROID_SDK_ROOT/emulator/emulator @test\r\nTC=path/to/toolchain\r\necho \"fn main(){}\" | rustc -Clinker=$TC/bin/arm-linux-androideabi-gcc --target armv7-linux-androideabi -o foo -\r\n$ANDROID_SDK_ROOT/platform-tools/adb push foo /data/local/tmp/foo\r\n$ANDROID_SDK_ROOT/platform-tools/adb shell /data/local/tmp/foo\r\n```\r\n\r\nadb logcat should point to a tombstone...\r\n\r\n```\r\nbacktrace:\r\n    #00 pc 0003e5b4  /data/local/tmp/foo\r\n    #01 pc 000292d8  /data/local/tmp/foo\r\n```\r\n\r\ninvalid op:\r\n```\r\n$TC/bin/arm-linux-androideabi-objdump -d foo | grep 3e5b4\r\n   3e5b4:\tf2c12055 \tvmov.i32\tq9, #21\t; 0x00000015\r\n```\r\n\r\nWe know for sure that this code comes from jemalloc, but we suspect at last backtrace contains some NEON instructions has well. (we grepped vmov in objdump output, and some functions (like read_attribute) containing them come from backtrace.", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/48207/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/48207/timeline", "performed_via_github_app": null, "state_reason": "completed"}