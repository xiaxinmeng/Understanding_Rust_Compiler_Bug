{"url": "https://api.github.com/repos/rust-lang/rust/issues/81918", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/81918/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/81918/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/81918/events", "html_url": "https://github.com/rust-lang/rust/issues/81918", "id": 804482943, "node_id": "MDU6SXNzdWU4MDQ0ODI5NDM=", "number": 81918, "title": "\"do not use `optimized_mir` for constants\" panic when generating MIR cfg", "user": {"login": "osa1", "id": 448274, "node_id": "MDQ6VXNlcjQ0ODI3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/448274?v=4", "gravatar_id": "", "url": "https://api.github.com/users/osa1", "html_url": "https://github.com/osa1", "followers_url": "https://api.github.com/users/osa1/followers", "following_url": "https://api.github.com/users/osa1/following{/other_user}", "gists_url": "https://api.github.com/users/osa1/gists{/gist_id}", "starred_url": "https://api.github.com/users/osa1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/osa1/subscriptions", "organizations_url": "https://api.github.com/users/osa1/orgs", "repos_url": "https://api.github.com/users/osa1/repos", "events_url": "https://api.github.com/users/osa1/events{/privacy}", "received_events_url": "https://api.github.com/users/osa1/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 256133398, "node_id": "MDU6TGFiZWwyNTYxMzMzOTg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-mir", "name": "A-mir", "color": "f7e101", "default": false, "description": "Area: Mid-level IR (MIR) - https://blog.rust-lang.org/2016/04/19/MIR.html"}, {"id": 1927601458, "node_id": "MDU6TGFiZWwxOTI3NjAxNDU4", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-mir-opt", "name": "A-mir-opt", "color": "f7e101", "default": false, "description": "Area: MIR optimizations"}], "state": "closed", "locked": false, "assignee": {"login": "osa1", "id": 448274, "node_id": "MDQ6VXNlcjQ0ODI3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/448274?v=4", "gravatar_id": "", "url": "https://api.github.com/users/osa1", "html_url": "https://github.com/osa1", "followers_url": "https://api.github.com/users/osa1/followers", "following_url": "https://api.github.com/users/osa1/following{/other_user}", "gists_url": "https://api.github.com/users/osa1/gists{/gist_id}", "starred_url": "https://api.github.com/users/osa1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/osa1/subscriptions", "organizations_url": "https://api.github.com/users/osa1/orgs", "repos_url": "https://api.github.com/users/osa1/repos", "events_url": "https://api.github.com/users/osa1/events{/privacy}", "received_events_url": "https://api.github.com/users/osa1/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "osa1", "id": 448274, "node_id": "MDQ6VXNlcjQ0ODI3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/448274?v=4", "gravatar_id": "", "url": "https://api.github.com/users/osa1", "html_url": "https://github.com/osa1", "followers_url": "https://api.github.com/users/osa1/followers", "following_url": "https://api.github.com/users/osa1/following{/other_user}", "gists_url": "https://api.github.com/users/osa1/gists{/gist_id}", "starred_url": "https://api.github.com/users/osa1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/osa1/subscriptions", "organizations_url": "https://api.github.com/users/osa1/orgs", "repos_url": "https://api.github.com/users/osa1/repos", "events_url": "https://api.github.com/users/osa1/events{/privacy}", "received_events_url": "https://api.github.com/users/osa1/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 5, "created_at": "2021-02-09T11:54:09Z", "updated_at": "2021-02-23T20:10:01Z", "closed_at": "2021-02-23T20:10:01Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The working example in #72956 builds fine, but if I add `-Zunpretty=mir-cfg` it panics. Repro:\r\n\r\n```rust\r\nuse std::ops::Index;\r\n\r\nstruct Banana(*mut ());\r\nunsafe impl Send for Banana {}\r\n\r\nimpl Banana {\r\n    fn new() -> &'static mut Banana {\r\n        static mut BANANA: Banana = Banana(std::ptr::null_mut());\r\n        unsafe { &mut BANANA }\r\n    }\r\n}\r\n\r\nstruct Peach<'a>(&'a mut Banana);\r\n\r\nimpl<'a> std::ops::Index<usize> for Peach<'a> {\r\n    type Output = ();\r\n    fn index(&self, idx: usize) -> &() {\r\n        &()\r\n    }\r\n}\r\n\r\nasync fn baz(v: &()) {}\r\n\r\nasync fn bar() -> () {\r\n    let peach = Peach(Banana::new());\r\n    let r: &() = &*std::ops::Index::index(&peach, 0);\r\n    baz(r).await;\r\n    peach.index(0);\r\n}\r\n\r\nfn assert_send<T: Send>(_: T) {}\r\n\r\npub fn main() {\r\n    assert_send(bar())\r\n}\r\n```\r\n\r\nIt builds fine:\r\n\r\n```\r\n$ rustc +stage1 test_works.rs --edition=2018\r\nwarning: unused variable: `v`\r\n  --> test_works.rs:22:14\r\n   |\r\n22 | async fn baz(v: &()) {}\r\n   |              ^ help: if this is intentional, prefix it with an underscore: `_v`\r\n   |\r\n   = note: `#[warn(unused_variables)]` on by default\r\n\r\nwarning: unused variable: `idx`\r\n  --> test_works.rs:17:21\r\n   |\r\n17 |     fn index(&self, idx: usize) -> &() {\r\n   |                     ^^^ help: if this is intentional, prefix it with an underscore: `_idx`\r\n\r\nwarning: 2 warnings emitted\r\n```\r\n\r\nPanics with `-Zunpretty=mir-cfg`:\r\n\r\n```\r\n$ rustc +stage1 test_works.rs --edition=2018 -Zunpretty=mir-cfg\r\nwarning: unused variable: `v`\r\n  --> test_works.rs:22:14\r\n   |\r\n22 | async fn baz(v: &()) {}\r\n   |              ^ help: if this is intentional, prefix it with an underscore: `_v`\r\n   |\r\n   = note: `#[warn(unused_variables)]` on by default\r\n\r\nwarning: unused variable: `idx`\r\n  --> test_works.rs:17:21\r\n   |\r\n17 |     fn index(&self, idx: usize) -> &() {\r\n   |                     ^^^ help: if this is intentional, prefix it with an underscore: `_idx`\r\n\r\nthread 'rustc' panicked at 'do not use `optimized_mir` for constants: Static(Mut)', compiler/rustc_mir/src/transform/mod.rs:579:24\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\r\n\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&template=ice.md\r\n\r\nnote: rustc 1.52.0-dev running on x86_64-unknown-linux-gnu\r\n\r\nnote: compiler flags: -Z unpretty=mir-cfg\r\n\r\nquery stack during panic:\r\n#0 [optimized_mir] optimizing MIR for `Banana::new::BANANA`\r\nend of query stack\r\nwarning: 2 warnings emitted\r\n```\r\n\r\n<details>\r\n\r\n<summary>Backtrace</summary>\r\n\r\n```\r\n   0: rust_begin_unwind\r\n             at /home/omer/rust/rust/library/std/src/panicking.rs:493:5\r\n   1: std::panicking::begin_panic_fmt\r\n             at /home/omer/rust/rust/library/std/src/panicking.rs:435:5\r\n   2: rustc_mir::transform::inner_optimized_mir\r\n             at /home/omer/rust/rust/compiler/rustc_mir/src/transform/mod.rs:579:24\r\n   3: rustc_mir::transform::optimized_mir\r\n             at /home/omer/rust/rust/compiler/rustc_mir/src/transform/mod.rs:561:21\r\n   4: rustc_middle::ty::query::<impl rustc_query_system::query::config::QueryAccessors<rustc_middle::ty::context::TyCtxt> for rustc_middle::ty::query::queries::optimized_mir>::compute\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/query/plumbing.rs:377:17\r\n   5: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task_impl\r\n             at /home/omer/rust/rust/compiler/rustc_query_system/src/dep_graph/graph.rs:363:14\r\n   6: rustc_query_system::query::plumbing::force_query_with_job::{{closure}}::{{closure}}\r\n   7: rustc_middle::ty::query::plumbing::<impl rustc_query_system::query::QueryContext for rustc_middle::ty::context::TyCtxt>::start_query::{{closure}}::{{closure}}::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/query/plumbing.rs:73:74\r\n   8: stacker::maybe_grow\r\n             at /home/omer/.cargo/registry/src/github.com-1ecc6299db9ec823/stacker-0.1.12/src/lib.rs:55:9\r\n   9: rustc_data_structures::stack::ensure_sufficient_stack\r\n             at /home/omer/rust/rust/compiler/rustc_data_structures/src/stack.rs:16:5\r\n  10: rustc_middle::ty::query::plumbing::<impl rustc_query_system::query::QueryContext for rustc_middle::ty::context::TyCtxt>::start_query::{{closure}}::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/query/plumbing.rs:73:17\r\n  11: rustc_middle::ty::context::tls::enter_context::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/context.rs:1712:50\r\n  12: rustc_middle::ty::context::tls::set_tlv\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/context.rs:1696:9\r\n  13: rustc_middle::ty::context::tls::enter_context\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/context.rs:1712:9\r\n  14: rustc_middle::ty::query::plumbing::<impl rustc_query_system::query::QueryContext for rustc_middle::ty::context::TyCtxt>::start_query::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/query/plumbing.rs:72:13\r\n  15: rustc_middle::ty::context::tls::with_related_context::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/context.rs:1756:13\r\n  16: rustc_middle::ty::context::tls::with_context::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/context.rs:1740:40\r\n  17: rustc_middle::ty::context::tls::with_context_opt\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/context.rs:1729:22\r\n  18: rustc_middle::ty::context::tls::with_context\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/context.rs:1740:9\r\n  19: rustc_middle::ty::context::tls::with_related_context\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/context.rs:1753:9\r\n  20: rustc_middle::ty::query::plumbing::<impl rustc_query_system::query::QueryContext for rustc_middle::ty::context::TyCtxt>::start_query\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/query/plumbing.rs:61:9\r\n  21: rustc_query_system::query::plumbing::force_query_with_job::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_query_system/src/query/plumbing.rs:598:9\r\n  22: rustc_query_system::query::plumbing::with_diagnostics\r\n             at /home/omer/rust/rust/compiler/rustc_query_system/src/query/plumbing.rs:303:18\r\n  23: rustc_query_system::query::plumbing::force_query_with_job\r\n             at /home/omer/rust/rust/compiler/rustc_query_system/src/query/plumbing.rs:597:51\r\n  24: rustc_query_system::query::plumbing::try_execute_query\r\n             at /home/omer/rust/rust/compiler/rustc_query_system/src/query/plumbing.rs:427:16\r\n  25: rustc_query_system::query::plumbing::get_query_impl::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_query_system/src/query/plumbing.rs:645:23\r\n  26: <rustc_query_system::query::caches::DefaultCache<K,V> as rustc_query_system::query::caches::QueryCache>::lookup\r\n             at /home/omer/rust/rust/compiler/rustc_query_system/src/query/caches.rs:114:79\r\n  27: rustc_query_system::query::plumbing::try_get_cached\r\n             at /home/omer/rust/rust/compiler/rustc_query_system/src/query/plumbing.rs:380:5\r\n  28: rustc_query_system::query::plumbing::get_query_impl\r\n             at /home/omer/rust/rust/compiler/rustc_query_system/src/query/plumbing.rs:637:5\r\n  29: rustc_query_system::query::plumbing::get_query\r\n             at /home/omer/rust/rust/compiler/rustc_query_system/src/query/plumbing.rs:739:5\r\n  30: rustc_middle::ty::query::TyCtxtAt::optimized_mir\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/query/plumbing.rs:487:17\r\n  31: rustc_middle::ty::query::<impl rustc_middle::ty::context::TyCtxt>::optimized_mir\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/query/plumbing.rs:448:17\r\n  32: rustc_mir::util::graphviz::write_mir_graphviz\r\n             at /home/omer/rust/rust/compiler/rustc_mir/src/util/graphviz.rs:25:21\r\n  33: rustc_driver::pretty::print_with_analysis\r\n             at /home/omer/rust/rust/compiler/rustc_driver/src/pretty.rs:499:26\r\n  34: rustc_driver::pretty::print_after_hir_lowering\r\n             at /home/omer/rust/rust/compiler/rustc_driver/src/pretty.rs:431:22\r\n  35: rustc_driver::run_compiler::{{closure}}::{{closure}}::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_driver/src/lib.rs:349:25\r\n  36: rustc_interface::passes::QueryContext::enter::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_interface/src/passes.rs:749:42\r\n  37: rustc_middle::ty::context::tls::enter_context::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/context.rs:1712:50\r\n  38: rustc_middle::ty::context::tls::set_tlv\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/context.rs:1696:9\r\n  39: rustc_middle::ty::context::tls::enter_context\r\n             at /home/omer/rust/rust/compiler/rustc_middle/src/ty/context.rs:1712:9\r\n  40: rustc_interface::passes::QueryContext::enter\r\n             at /home/omer/rust/rust/compiler/rustc_interface/src/passes.rs:749:9\r\n  41: rustc_driver::run_compiler::{{closure}}::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_driver/src/lib.rs:347:21\r\n  42: rustc_interface::queries::<impl rustc_interface::interface::Compiler>::enter\r\n             at /home/omer/rust/rust/compiler/rustc_interface/src/queries.rs:418:19\r\n  43: rustc_driver::run_compiler::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_driver/src/lib.rs:341:22\r\n  44: rustc_interface::interface::create_compiler_and_run::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_interface/src/interface.rs:197:13\r\n  45: rustc_span::with_source_map\r\n             at /home/omer/rust/rust/compiler/rustc_span/src/lib.rs:789:5\r\n  46: rustc_interface::interface::create_compiler_and_run\r\n             at /home/omer/rust/rust/compiler/rustc_interface/src/interface.rs:191:5\r\n  47: rustc_interface::interface::run_compiler::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_interface/src/interface.rs:213:12\r\n  48: rustc_interface::util::setup_callbacks_and_run_in_thread_pool_with_globals::{{closure}}::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_interface/src/util.rs:152:13\r\n  49: scoped_tls::ScopedKey<T>::set\r\n             at /home/omer/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-1.0.0/src/lib.rs:137:9\r\n  50: rustc_span::with_session_globals\r\n             at /home/omer/rust/rust/compiler/rustc_span/src/lib.rs:105:5\r\n  51: rustc_interface::util::setup_callbacks_and_run_in_thread_pool_with_globals::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_interface/src/util.rs:150:9\r\n  52: rustc_interface::util::scoped_thread::{{closure}}\r\n             at /home/omer/rust/rust/compiler/rustc_interface/src/util.rs:125:24\r\n```\r\n\r\n</details>\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"osa1\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/81918/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/81918/timeline", "performed_via_github_app": null, "state_reason": "completed"}