{"url": "https://api.github.com/repos/rust-lang/rust/issues/112061", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/112061/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/112061/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/112061/events", "html_url": "https://github.com/rust-lang/rust/issues/112061", "id": 1730699093, "node_id": "I_kwDOAAsO6M5nKF9V", "number": 112061, "title": "Misoptimisation of complex control flow only under low `mir-opt-level`", "user": {"login": "cbeuw", "id": 7034308, "node_id": "MDQ6VXNlcjcwMzQzMDg=", "avatar_url": "https://avatars.githubusercontent.com/u/7034308?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cbeuw", "html_url": "https://github.com/cbeuw", "followers_url": "https://api.github.com/users/cbeuw/followers", "following_url": "https://api.github.com/users/cbeuw/following{/other_user}", "gists_url": "https://api.github.com/users/cbeuw/gists{/gist_id}", "starred_url": "https://api.github.com/users/cbeuw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cbeuw/subscriptions", "organizations_url": "https://api.github.com/users/cbeuw/orgs", "repos_url": "https://api.github.com/users/cbeuw/repos", "events_url": "https://api.github.com/users/cbeuw/events{/privacy}", "received_events_url": "https://api.github.com/users/cbeuw/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 203429200, "node_id": "MDU6TGFiZWwyMDM0MjkyMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-high", "name": "P-high", "color": "eb6420", "default": false, "description": "High priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}], "state": "closed", "locked": false, "assignee": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 18, "created_at": "2023-05-29T12:44:17Z", "updated_at": "2023-06-06T13:18:35Z", "closed_at": "2023-06-06T13:18:35Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Apologies for the not-very-readable reproduction. It was generated by a fuzzer and this is the best I can minimise it to.\n```rust\nuse std::ptr;\npub fn print_var(v: u8) {\n    println!(\"{v}\");\n}\npub unsafe fn fn12_rs() -> ([u128; 7], *mut i8, *mut bool) {\n    let mut v2: bool = false;\n    let mut v8: u64 = 0;\n    let mut v9: usize = 0;\n    let mut v12: *mut u8 = ptr::null_mut();\n    let mut v17: *mut bool = ptr::null_mut();\n    let mut v20: [u8; 8] = Default::default();\n    let mut v21: [u8; 8] = Default::default();\n    let mut v31: (bool, u8, usize, f32) = Default::default();\n    let mut v33: ([u128; 7], *mut i8, *mut bool) = ([0; 7], ptr::null_mut(), ptr::null_mut());\n    let mut v39: (usize, [u128; 7], ([u32; 6], usize, *mut [u32; 6]), [u32; 2]) =\n        (0, [0; 7], ([0; 6], 0, ptr::null_mut()), [0; 2]);\n    let mut ret: ([u128; 7], *mut i8, *mut bool) = ([0; 7], ptr::null_mut(), ptr::null_mut());\n    ret.2 = core::ptr::addr_of_mut!(v2);\n    'l0: loop {\n        v12 = core::ptr::addr_of_mut!(v20[v9]);\n        v20 = [197_u8; 8];\n        v9 = 2_usize;\n        'l1: loop {\n            match *v12 {\n                197 => {\n                    // Taken\n                    v8 = 13978819448286864680_u64;\n                    v33.2 = ret.2;\n                    match v39.0 {\n                        0 => {\n                            // Taken\n                            'l2: loop {\n                                v20 = [11_u8; 8]; // What LLVM with low mir-opt prints\n                                (*v12) = 22; // What Miri prints\n                                'l3: loop {\n                                    v21 = v20;\n                                    match v8 {\n                                        13978819448286864680 => {\n                                            // Taken\n                                            v39.2 .0 = [2262110980_u32; 6];\n                                            v8 = !13152832795211590855_u64;\n                                            v39.0 = 6;\n                                            v17 = v33.2;\n                                            v33.2 = core::ptr::addr_of_mut!(v31.0);\n                                            v31.1 = *v12;\n                                            (*v17) = true;\n                                            v20 = v21;\n                                            match v39.0 {\n                                                6 => {\n                                                    // Taken\n                                                    print_var(v31.1);\n                                                }\n                                                0 => continue 'l2,\n                                                _ => return ret,\n                                            }\n                                        }\n                                        _ => continue 'l0,\n                                    }\n                                }\n                            }\n                        }\n                        _ => return ret,\n                    }\n                }\n                4 => {\n                    v12 = core::ptr::addr_of_mut!(v20[v9]);\n                }\n                _ => return ret,\n            }\n        }\n    }\n}\npub fn main() {\n    unsafe {\n        fn12_rs();\n    }\n}\n```\n\nThe program has no UB under `-Zmiri-tree-borrows`, and Miri prints 22, this is also the result with `-Zmir-opt-level>=2 -Copt-level=3`\n```console\n% rustc -Zmir-opt-level=2 -Copt-level=3 minimised.rs && ./minimised\n22\n```\n\nVery strangely, if you drop `mir-opt-level` to 0 or 1, the result becomes 11 which is wrong.\n```console\n% rustc -Zmir-opt-level=1 -Copt-level=3 minimised.rs && ./minimised\n11\n```\n\nReproducible on both Apple Silicon macOS and x86_64 Linux\n```console\nrustc 1.71.0-nightly (a2b1646c5 2023-05-25)\nbinary: rustc\ncommit-hash: a2b1646c597329d0a25efa3889b66650f65de1de\ncommit-date: 2023-05-25\nhost: aarch64-apple-darwin\nrelease: 1.71.0-nightly\nLLVM version: 16.0.4\n```\n\n```console\nrustc 1.71.0-nightly (a2b1646c5 2023-05-25)\nbinary: rustc\ncommit-hash: a2b1646c597329d0a25efa3889b66650f65de1de\ncommit-date: 2023-05-25\nhost: x86_64-unknown-linux-gnu\nrelease: 1.71.0-nightly\nLLVM version: 16.0.4\n```\n\ncc @RalfJung  @nikic \n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"nikic\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/112061/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/112061/timeline", "performed_via_github_app": null, "state_reason": "completed"}