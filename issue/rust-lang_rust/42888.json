{"url": "https://api.github.com/repos/rust-lang/rust/issues/42888", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/42888/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/42888/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/42888/events", "html_url": "https://github.com/rust-lang/rust/issues/42888", "id": 238348550, "node_id": "MDU6SXNzdWUyMzgzNDg1NTA=", "number": 42888, "title": "llvm.x86.aesni.aeskeygenassist intrinsic produces LLVM error", "user": {"login": "newpavlov", "id": 329626, "node_id": "MDQ6VXNlcjMyOTYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/329626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/newpavlov", "html_url": "https://github.com/newpavlov", "followers_url": "https://api.github.com/users/newpavlov/followers", "following_url": "https://api.github.com/users/newpavlov/following{/other_user}", "gists_url": "https://api.github.com/users/newpavlov/gists{/gist_id}", "starred_url": "https://api.github.com/users/newpavlov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/newpavlov/subscriptions", "organizations_url": "https://api.github.com/users/newpavlov/orgs", "repos_url": "https://api.github.com/users/newpavlov/repos", "events_url": "https://api.github.com/users/newpavlov/events{/privacy}", "received_events_url": "https://api.github.com/users/newpavlov/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-06-24T23:05:13Z", "updated_at": "2017-06-25T09:45:19Z", "closed_at": "2017-06-25T09:45:19Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Playing with AES-NI LLVM intrinsics I've encountered the following issue. Here is code for reproducing it:\r\n\r\n```Rust\r\n#![feature(link_llvm_intrinsics)]\r\n#![feature(repr_simd)]\r\n#![feature(simd_ffi)]\r\n#![allow(improper_ctypes)]\r\n\r\n#[allow(non_camel_case_types)]\r\n#[repr(simd)]\r\npub struct i64x2(i64, i64);\r\n\r\nextern {\r\n    #[link_name = \"llvm.x86.aesni.aesenc\"]\r\n    fn llvm_aesenc(a: i64x2, b: i64x2) -> i64x2;\r\n\r\n    #[link_name = \"llvm.x86.aesni.aeskeygenassist\"]\r\n    fn llvm_aeskeygenassist(a: i64x2, b: i8) -> i64x2;\r\n}\r\n\r\npub fn aesenc(a: i64x2, b: i64x2) -> i64x2 {\r\n    unsafe { llvm_aesenc(a, b) }\r\n}\r\n\r\npub fn aeskeygenassist(a: i64x2, b: i8) -> i64x2 {\r\n    unsafe { llvm_aeskeygenassist(a, b) }\r\n}\r\n\r\n\r\nfn main() {\r\n    let r = aesenc(i64x2(1, 0), i64x2(2, 1));\r\n    println!(\"{} {}\", r.0, r.1);\r\n\r\n    let r = aeskeygenassist(i64x2(42, 0), 1);\r\n    println!(\"{} {}\", r.0, r.1);\r\n}\r\n```\r\n\r\nTrying to compile it with the `rustc -C target-feature=+aes aes.rs` results in `LLVM ERROR: Cannot select: intrinsic %llvm.x86.aesni.aeskeygenassist` while `llvm.x86.aesni.aesenc` and other AES-NI intrinsics work without problems.\r\n\r\nCode compiled with the last nightly `rustc 1.20.0-nightly (229d0d326 2017-06-23)` and issue reproduced on different CPUs.\r\n\r\nUPD: Error originates from [here](https://github.com/rust-lang/llvm/blob/rust-llvm-2017-04-13/test/LTO/X86/attrs.ll). My guess, this test is written incorrectly or badly interacts with Rust compiler, but I am not familiar with LLVM internals to fix this issue apart from deleting this file altogether.\r\nUPD2: Compiling with `opt-level=1` or higher does not produce this error, but for crate compilation it does not matter.", "closed_by": {"login": "newpavlov", "id": 329626, "node_id": "MDQ6VXNlcjMyOTYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/329626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/newpavlov", "html_url": "https://github.com/newpavlov", "followers_url": "https://api.github.com/users/newpavlov/followers", "following_url": "https://api.github.com/users/newpavlov/following{/other_user}", "gists_url": "https://api.github.com/users/newpavlov/gists{/gist_id}", "starred_url": "https://api.github.com/users/newpavlov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/newpavlov/subscriptions", "organizations_url": "https://api.github.com/users/newpavlov/orgs", "repos_url": "https://api.github.com/users/newpavlov/repos", "events_url": "https://api.github.com/users/newpavlov/events{/privacy}", "received_events_url": "https://api.github.com/users/newpavlov/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/42888/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/42888/timeline", "performed_via_github_app": null, "state_reason": "completed"}