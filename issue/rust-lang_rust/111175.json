{"url": "https://api.github.com/repos/rust-lang/rust/issues/111175", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/111175/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/111175/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/111175/events", "html_url": "https://github.com/rust-lang/rust/issues/111175", "id": 1695327384, "node_id": "I_kwDOAAsO6M5lDKSY", "number": 111175, "title": "unsized_fn_params allows some unsized locals, hitting unsound alloca codegen path", "user": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 256133398, "node_id": "MDU6TGFiZWwyNTYxMzMzOTg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-mir", "name": "A-mir", "color": "f7e101", "default": false, "description": "Area: Mid-level IR (MIR) - https://blog.rust-lang.org/2016/04/19/MIR.html"}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}, {"id": 2464527098, "node_id": "MDU6TGFiZWwyNDY0NTI3MDk4", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-unsized_fn_params", "name": "F-unsized_fn_params", "color": "f9c0cc", "default": false, "description": "`#![feature(unsized_fn_params)]`"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2023-05-04T06:16:00Z", "updated_at": "2023-05-23T06:31:19Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "Found in https://github.com/rust-lang/miri/issues/2872: this code\r\n```rust\r\n#![feature(core_intrinsics, unsized_fn_params)]\r\nuse std::intrinsics;\r\n\r\npub fn forget_unsized(t: [i32]) {\r\n    intrinsics::forget(t)\r\n}\r\n```\r\nwith `-Zmir-opt-level=0` generates this LLVM IR\r\n```\r\ndefine void @_ZN4test14forget_unsized17h6fbb3409c8556ed4E(ptr %0, i64 %1) unnamed_addr #0 {\r\nstart:\r\n  %_2 = alloca { ptr, i64 }, align 8\r\n  %t = alloca { ptr, i64 }, align 8\r\n  %2 = getelementptr inbounds { ptr, i64 }, ptr %t, i32 0, i32 0\r\n  store ptr %0, ptr %2, align 8\r\n  %3 = getelementptr inbounds { ptr, i64 }, ptr %t, i32 0, i32 1\r\n  store i64 %1, ptr %3, align 8\r\n  %4 = getelementptr inbounds { ptr, i64 }, ptr %t, i32 0, i32 0\r\n  %5 = load ptr, ptr %4, align 8, !noundef !2\r\n  %6 = getelementptr inbounds { ptr, i64 }, ptr %t, i32 0, i32 1\r\n  %7 = load i64, ptr %6, align 8, !noundef !2\r\n  %8 = mul nsw i64 %7, 4\r\n  %9 = alloca i8, i64 %8, align 16\r\n  call void @llvm.memcpy.p0.p0.i64(ptr align 16 %9, ptr align 1 %5, i64 %8, i1 false)\r\n  %10 = getelementptr inbounds { ptr, i64 }, ptr %_2, i32 0, i32 0\r\n  store ptr %9, ptr %10, align 8\r\n  %11 = getelementptr inbounds { ptr, i64 }, ptr %_2, i32 0, i32 1\r\n  store i64 %7, ptr %11, align 8\r\n  ret void\r\n}\r\n```\r\nNotice the `alloca`. This is bad! Our alloca code path is unsound (it does not properly account for alignment); the point of the `unsized_fn_params` feature gate (separate from `unsized_locals`) was to avoid hitting that code path.\r\n\r\nI repeat my stance that we should remove the unsound alloca code path (effectively de-imlementing unsized locals) to ensure this can never happen.\r\n\r\nWe don't have a MIR building ping group AFAIK, so Cc @rust-lang/wg-mir-opt I guess.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/111175/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/111175/timeline", "performed_via_github_app": null, "state_reason": null}