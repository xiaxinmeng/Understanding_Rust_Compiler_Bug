{"url": "https://api.github.com/repos/rust-lang/rust/issues/28129", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/28129/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/28129/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/28129/events", "html_url": "https://github.com/rust-lang/rust/issues/28129", "id": 104099188, "node_id": "MDU6SXNzdWUxMDQwOTkxODg=", "number": 28129, "title": "TLS destructors on the main thread are a little sketchy", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 43009118, "node_id": "MDU6TGFiZWw0MzAwOTExOA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-destructors", "name": "A-destructors", "color": "f7e101", "default": false, "description": "Area: destructors (Drop, ..)"}, {"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}, {"id": 632886930, "node_id": "MDU6TGFiZWw2MzI4ODY5MzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-thread-locals", "name": "A-thread-locals", "color": "f7e101", "default": false, "description": "Area: Thread local storage (TLS)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 10, "created_at": "2015-08-31T17:46:56Z", "updated_at": "2020-04-29T12:04:02Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "There are some platforms where TLS destructors are run when the main thread exits, there are some platforms where this does not happen, and there are some platforms where things just go crazy. For example, testing this program:\r\n\r\n``` rust\r\nstruct Foo;\r\n\r\nimpl Drop for Foo {\r\n    fn drop(&mut self) {\r\n        println!(\"wut\");\r\n    }\r\n}\r\n\r\nthread_local!(static FOO: Foo = Foo);\r\n\r\nfn main() {\r\n    FOO.with(|_| {});\r\n}\r\n```\r\n- Linux ELF TLS - appears to work\r\n- Linux pthread destructors - appear to not work (#19776)\r\n- OSX - ~~appears to call destructors, but the program above specifically causes some form of memory corrupting, triggering an assert in malloc~~ fixed by https://github.com/rust-lang/rust/pull/57655\r\n- Windows GNU/MSVC - appears to not work. We're [listening for `DLL_PROCESS_DETACH`](https://github.com/rust-lang/rust/blob/6d6bf81b33abf3c8e200532b5f6f9e72ba540e92/src/libstd/sys/windows/thread_local.rs#L246) but for some reason we're not getting that notification.\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/28129/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/28129/timeline", "performed_via_github_app": null, "state_reason": null}