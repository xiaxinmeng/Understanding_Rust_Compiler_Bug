{"url": "https://api.github.com/repos/rust-lang/rust/issues/23036", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/23036/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/23036/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/23036/events", "html_url": "https://github.com/rust-lang/rust/issues/23036", "id": 59848455, "node_id": "MDU6SXNzdWU1OTg0ODQ1NQ==", "number": 23036, "title": "HashMap with Path key crashes rustc", "user": {"login": "dextero", "id": 1735012, "node_id": "MDQ6VXNlcjE3MzUwMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1735012?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dextero", "html_url": "https://github.com/dextero", "followers_url": "https://api.github.com/users/dextero/followers", "following_url": "https://api.github.com/users/dextero/following{/other_user}", "gists_url": "https://api.github.com/users/dextero/gists{/gist_id}", "starred_url": "https://api.github.com/users/dextero/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dextero/subscriptions", "organizations_url": "https://api.github.com/users/dextero/orgs", "repos_url": "https://api.github.com/users/dextero/repos", "events_url": "https://api.github.com/users/dextero/events{/privacy}", "received_events_url": "https://api.github.com/users/dextero/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 46741598, "node_id": "MDU6TGFiZWw0Njc0MTU5OA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-test", "name": "E-needs-test", "color": "02e10c", "default": false, "description": "Call for participation: writing correctness tests"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2015-03-04T19:29:00Z", "updated_at": "2015-09-16T05:48:56Z", "closed_at": "2015-09-16T05:48:56Z", "author_association": "NONE", "active_lock_reason": null, "body": "Hello,\n\nLately I've been experimenting with Rust, and it seems I accidentally managed to crash `rustc`. Trying to compile following snippet:\n\n``` .rust\n#![feature(path)]\nuse std::collections::HashMap;\nuse std::path::Path;\n\nfn main() {\n    let mut map = HashMap::new();\n    map.insert(Path::new(\"a\"), 0);\n    map.get(Path::new(\"a\"));\n}\n```\n\n... causes an assertion fail:\n\n```\n$ RUST_BACKTRACE=1 rustc --verbose src/main.rs\nrustc: /home/rustbuild/src/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/llvm/lib/IR/Instructions.cpp:1083: void llvm::StoreInst::AssertOK(): Assertion `getOperand(0)->getType() == cast<PointerType>(getOperand(1)->getType())->getElementType() && \"Ptr must be a pointer to Val type!\"' failed.\n[1]    30171 abort (core dumped)  rustc --verbose src/main.rs\n```\n\nSpecifying an explicit variable type prevents crashing. Such code:\n\n``` .rust\n#![feature(path)]\nuse std::collections::HashMap;\nuse std::path::Path;\n\nfn main() {\n    let mut map: HashMap<Path, i32> = HashMap::new();\n    map.insert(Path::new(\"a\"), 0);\n    map.get(Path::new(\"a\"));\n}\n```\n\n... produces an compile-time error as expected:\n\n```\n$ rustc --verbose src/main.rs\nsrc/main.rs:6:18: 6:36 error: the trait `core::marker::Sized` is not implemented for the type `[u8]` [E0277]\nsrc/main.rs:6     let mut map: HashMap<Path, i32> = HashMap::new();\n                               ^~~~~~~~~~~~~~~~~~\nsrc/main.rs:6:18: 6:36 note: `[u8]` does not have a constant size known at compile-time\nsrc/main.rs:6     let mut map: HashMap<Path, i32> = HashMap::new();\n                               ^~~~~~~~~~~~~~~~~~\nsrc/main.rs:7:9: 7:34 error: type `std::collections::hash::map::HashMap<std::path::Path, i32>` does not implement any method in scope named `insert`\nsrc/main.rs:7     map.insert(Path::new(\"a\"), 0);\n                      ^~~~~~~~~~~~~~~~~~~~~~~~~\nsrc/main.rs:8:9: 8:28 error: type `std::collections::hash::map::HashMap<std::path::Path, i32>` does not implement any method in scope named `get`\nsrc/main.rs:8     map.get(Path::new(\"a\"));\n                      ^~~~~~~~~~~~~~~~~~~\nerror: aborting due to 3 previous errors\n```\n\nThe `[u8]` in the error message is quite surprising, though - it's not entirely clear what's really going on without looking at the `libstd` code. I would rather expect to see a `Path` there.\n## Meta\n\nBoth snippets were tested on 64-bit Ubuntu 14.04 and compiled with two versions of `rustc` (the behavior is exactly the same for both):\n\n```\n$ rustc --version --verbose\nrustc 1.0.0-dev (522d09dfe 2015-02-19) (built 2015-03-04)\nbinary: rustc\ncommit-hash: 522d09dfecbeca1595f25ac58c6d0178bbd21d7d\ncommit-date: 2015-02-19\nbuild-date: 2015-03-04\nhost: x86_64-unknown-linux-gnu\nrelease: 1.0.0-dev\n```\n\n```\n$ rustc --version --verbose\nrustc 1.0.0-nightly (fed12499e 2015-03-03) (built 2015-03-04)\nbinary: rustc\ncommit-hash: fed12499e7d91f9cdfba5833e34d20e8fd19b898\ncommit-date: 2015-03-03\nbuild-date: 2015-03-04\nhost: x86_64-unknown-linux-gnu\nrelease: 1.0.0-nightly\n```\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/23036/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/23036/timeline", "performed_via_github_app": null, "state_reason": "completed"}