{"url": "https://api.github.com/repos/rust-lang/rust/issues/94599", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/94599/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/94599/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/94599/events", "html_url": "https://github.com/rust-lang/rust/issues/94599", "id": 1159424252, "node_id": "I_kwDOAAsO6M5FG2j8", "number": 94599, "title": "Format macro causes panic if it is inside closure which result is passed into a function that accepts less args.", "user": {"login": "M1ngXU", "id": 91617361, "node_id": "U_kgDOBXX4UQ", "avatar_url": "https://avatars.githubusercontent.com/u/91617361?v=4", "gravatar_id": "", "url": "https://api.github.com/users/M1ngXU", "html_url": "https://github.com/M1ngXU", "followers_url": "https://api.github.com/users/M1ngXU/followers", "following_url": "https://api.github.com/users/M1ngXU/following{/other_user}", "gists_url": "https://api.github.com/users/M1ngXU/gists{/gist_id}", "starred_url": "https://api.github.com/users/M1ngXU/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/M1ngXU/subscriptions", "organizations_url": "https://api.github.com/users/M1ngXU/orgs", "repos_url": "https://api.github.com/users/M1ngXU/repos", "events_url": "https://api.github.com/users/M1ngXU/events{/privacy}", "received_events_url": "https://api.github.com/users/M1ngXU/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1615551553, "node_id": "MDU6TGFiZWwxNjE1NTUxNTUz", "url": "https://api.github.com/repos/rust-lang/rust/labels/glacier", "name": "glacier", "color": "a5e2ff", "default": false, "description": "ICE tracked in rust-lang/glacier"}], "state": "closed", "locked": false, "assignee": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2022-03-04T09:20:27Z", "updated_at": "2022-03-07T09:49:11Z", "closed_at": "2022-03-07T09:49:11Z", "author_association": "NONE", "active_lock_reason": null, "body": "If using format inside a closure (e.g. in iter functions) and the returning String is passed into a function that takes less args, rustc panics.\r\n\r\n### Code\r\n\r\n```Rust\r\n(||{})(format!(\"{}\", (||format!(\"{}\", \"s\"))()));\r\n```\r\nMinimized code snippet: https://github.com/rust-lang/rust/issues/94599#issuecomment-1059665300\r\n\r\n\r\n### Meta\r\nversion: 1.60.0-beta.2 and 1.61.0-nightly\r\n\r\n### Error output\r\n\r\n```\r\nthread 'rustc' panicked at 'Box<dyn Any>', /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/compiler/rustc_errors/src/lib.rs:1106:9\r\nstack backtrace:\r\n   0:     0x7f0a839f682c - std::backtrace_rs::backtrace::libunwind::trace::hf059f7d696f3ddd0\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/std/src/../../backtrace/src/backtrace/libunwind.rs:93:5\r\n   1:     0x7f0a839f682c - std::backtrace_rs::backtrace::trace_unsynchronized::h686db7ceab9bfd1a\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/std/src/../../backtrace/src/backtrace/mod.rs:66:5\r\n   2:     0x7f0a839f682c - std::sys_common::backtrace::_print_fmt::he4aca9613e5c3637\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/std/src/sys_common/backtrace.rs:66:5\r\n   3:     0x7f0a839f682c - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::h080145eaebef7a38\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/std/src/sys_common/backtrace.rs:45:22\r\n   4:     0x7f0a83a562cc - core::fmt::write::hb73cfe8a4b8d71a9\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/core/src/fmt/mod.rs:1190:17\r\n   5:     0x7f0a839e6aa8 - std::io::Write::write_fmt::h44625064880463d0\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/std/src/io/mod.rs:1657:15\r\n   6:     0x7f0a839fa7f7 - std::sys_common::backtrace::_print::h750dbecb76b2ec9e\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/std/src/sys_common/backtrace.rs:48:5\r\n   7:     0x7f0a839fa7f7 - std::sys_common::backtrace::print::hd7b9c9e26624b8b6\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/std/src/sys_common/backtrace.rs:35:9\r\n   8:     0x7f0a839fa7f7 - std::panicking::default_hook::{{closure}}::hcb767bb9dd055c7f\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/std/src/panicking.rs:295:22\r\n   9:     0x7f0a839fa4bf - std::panicking::default_hook::h5c8de2745bf115a6\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/std/src/panicking.rs:314:9\r\n  10:     0x7f0a84186551 - rustc_driver[691b9c2a58b062eb]::DEFAULT_HOOK::{closure#0}::{closure#0}\r\n  11:     0x7f0a839fb0c5 - std::panicking::rust_panic_with_hook::heddcebbadb156565\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/std/src/panicking.rs:702:17\r\n  12:     0x7f0a844c0181 - std[6a13073971966f88]::panicking::begin_panic::<rustc_errors[a9175c9762cc5fd5]::ExplicitBug>::{closure#0}\r\n  13:     0x7f0a844bfc66 - std[6a13073971966f88]::sys_common::backtrace::__rust_end_short_backtrace::<std[6a13073971966f88]::panicking::begin_panic<rustc_errors[a9175c9762cc5fd5]::ExplicitBug>::{closure#0}, !>\r\n  14:     0x7f0a844c00cf - std[6a13073971966f88]::panicking::begin_panic::<rustc_errors[a9175c9762cc5fd5]::ExplicitBug>\r\n  15:     0x7f0a844ebcad - std[6a13073971966f88]::panic::panic_any::<rustc_errors[a9175c9762cc5fd5]::ExplicitBug>\r\n  16:     0x7f0a844e3d08 - <rustc_errors[a9175c9762cc5fd5]::HandlerInner>::span_bug::<rustc_span[6989153e7236b61f]::span_encoding::Span>\r\n  17:     0x7f0a844e3a00 - <rustc_errors[a9175c9762cc5fd5]::Handler>::span_bug::<rustc_span[6989153e7236b61f]::span_encoding::Span>\r\n  18:     0x7f0a8451f3a2 - rustc_middle[5e82cfb5c9ea2479]::ty::context::tls::with_opt::<rustc_middle[5e82cfb5c9ea2479]::util::bug::opt_span_bug_fmt<rustc_span[6989153e7236b61f]::span_encoding::Span>::{closure#0}, ()>\r\n  19:     0x7f0a8451f960 - rustc_middle[5e82cfb5c9ea2479]::util::bug::opt_span_bug_fmt::<rustc_span[6989153e7236b61f]::span_encoding::Span>\r\n  20:     0x7f0a8451f92c - rustc_middle[5e82cfb5c9ea2479]::util::bug::span_bug_fmt::<rustc_span[6989153e7236b61f]::span_encoding::Span>\r\n  21:     0x7f0a8561e629 - <rustc_typeck[e808157a81a43890]::check::writeback::WritebackCx as rustc_hir[b06bc1d5472ce31]::intravisit::Visitor>::visit_local\r\n  22:     0x7f0a8561b98f - <rustc_typeck[e808157a81a43890]::check::writeback::WritebackCx as rustc_hir[b06bc1d5472ce31]::intravisit::Visitor>::visit_expr\r\n  23:     0x7f0a8561a99c - <rustc_typeck[e808157a81a43890]::check::writeback::WritebackCx as rustc_hir[b06bc1d5472ce31]::intravisit::Visitor>::visit_expr\r\n  24:     0x7f0a85619e02 - <rustc_typeck[e808157a81a43890]::check::writeback::WritebackCx as rustc_hir[b06bc1d5472ce31]::intravisit::Visitor>::visit_expr\r\n  25:     0x7f0a85619e25 - <rustc_typeck[e808157a81a43890]::check::writeback::WritebackCx as rustc_hir[b06bc1d5472ce31]::intravisit::Visitor>::visit_expr\r\n  26:     0x7f0a8561b96e - <rustc_typeck[e808157a81a43890]::check::writeback::WritebackCx as rustc_hir[b06bc1d5472ce31]::intravisit::Visitor>::visit_expr\r\n  27:     0x7f0a85554271 - <rustc_typeck[e808157a81a43890]::check::fn_ctxt::FnCtxt>::resolve_type_vars_in_body\r\n  28:     0x7f0a855d0fe9 - <rustc_infer[f86b6e99fd53383b]::infer::InferCtxtBuilder>::enter::<&rustc_middle[5e82cfb5c9ea2479]::ty::context::TypeckResults, <rustc_typeck[e808157a81a43890]::check::inherited::InheritedBuilder>::enter<rustc_typeck[e808157a81a43890]::check::typeck_with_fallback<rustc_typeck[e808157a81a43890]::check::typeck::{closure#0}>::{closure#1}, &rustc_middle[5e82cfb5c9ea2479]::ty::context::TypeckResults>::{closure#0}>\r\n  29:     0x7f0a855abbc3 - rustc_typeck[e808157a81a43890]::check::typeck\r\n  30:     0x7f0a85a4b685 - rustc_query_system[832e6358829a14ea]::query::plumbing::try_execute_query::<rustc_query_impl[36da0ccdccd1cc1e]::plumbing::QueryCtxt, rustc_query_system[832e6358829a14ea]::query::caches::DefaultCache<rustc_span[6989153e7236b61f]::def_id::LocalDefId, &rustc_middle[5e82cfb5c9ea2479]::ty::context::TypeckResults>>\r\n  31:     0x7f0a85aaa67c - <rustc_query_impl[36da0ccdccd1cc1e]::Queries as rustc_middle[5e82cfb5c9ea2479]::ty::query::QueryEngine>::typeck\r\n  32:     0x7f0a855abd92 - rustc_typeck[e808157a81a43890]::check::typeck\r\n  33:     0x7f0a85a4b685 - rustc_query_system[832e6358829a14ea]::query::plumbing::try_execute_query::<rustc_query_impl[36da0ccdccd1cc1e]::plumbing::QueryCtxt, rustc_query_system[832e6358829a14ea]::query::caches::DefaultCache<rustc_span[6989153e7236b61f]::def_id::LocalDefId, &rustc_middle[5e82cfb5c9ea2479]::ty::context::TypeckResults>>\r\n  34:     0x7f0a85aaa67c - <rustc_query_impl[36da0ccdccd1cc1e]::Queries as rustc_middle[5e82cfb5c9ea2479]::ty::query::QueryEngine>::typeck\r\n  35:     0x7f0a8560d73a - <rustc_middle[5e82cfb5c9ea2479]::hir::map::Map>::par_body_owners::<rustc_typeck[e808157a81a43890]::check::typeck_item_bodies::{closure#0}>\r\n  36:     0x7f0a8628715c - rustc_typeck[e808157a81a43890]::check::typeck_item_bodies\r\n  37:     0x7f0a864bb954 - rustc_query_system[832e6358829a14ea]::query::plumbing::try_execute_query::<rustc_query_impl[36da0ccdccd1cc1e]::plumbing::QueryCtxt, rustc_query_system[832e6358829a14ea]::query::caches::DefaultCache<(), ()>>\r\n  38:     0x7f0a864e3548 - rustc_query_system[832e6358829a14ea]::query::plumbing::get_query::<rustc_query_impl[36da0ccdccd1cc1e]::queries::typeck_item_bodies, rustc_query_impl[36da0ccdccd1cc1e]::plumbing::QueryCtxt>\r\n  39:     0x7f0a8628b649 - <rustc_session[9ca8810e328b55b5]::session::Session>::time::<(), rustc_typeck[e808157a81a43890]::check_crate::{closure#7}>\r\n  40:     0x7f0a8627fb43 - rustc_typeck[e808157a81a43890]::check_crate\r\n  41:     0x7f0a8601b587 - rustc_interface[9aa301a3811405e2]::passes::analysis\r\n  42:     0x7f0a864b2383 - rustc_query_system[832e6358829a14ea]::query::plumbing::try_execute_query::<rustc_query_impl[36da0ccdccd1cc1e]::plumbing::QueryCtxt, rustc_query_system[832e6358829a14ea]::query::caches::DefaultCache<(), core[64c76e218c955efd]::result::Result<(), rustc_errors[a9175c9762cc5fd5]::ErrorReported>>>\r\n  43:     0x7f0a864f12e5 - rustc_query_system[832e6358829a14ea]::query::plumbing::get_query::<rustc_query_impl[36da0ccdccd1cc1e]::queries::analysis, rustc_query_impl[36da0ccdccd1cc1e]::plumbing::QueryCtxt>\r\n  44:     0x7f0a85ff9cc8 - <rustc_interface[9aa301a3811405e2]::passes::QueryContext>::enter::<rustc_driver[691b9c2a58b062eb]::run_compiler::{closure#1}::{closure#2}::{closure#3}, core[64c76e218c955efd]::result::Result<(), rustc_errors[a9175c9762cc5fd5]::ErrorReported>>\r\n  45:     0x7f0a85fe8094 - rustc_interface[9aa301a3811405e2]::interface::create_compiler_and_run::<core[64c76e218c955efd]::result::Result<(), rustc_errors[a9175c9762cc5fd5]::ErrorReported>, rustc_driver[691b9c2a58b062eb]::run_compiler::{closure#1}>\r\n  46:     0x7f0a85fcd734 - std[6a13073971966f88]::sys_common::backtrace::__rust_begin_short_backtrace::<rustc_interface[9aa301a3811405e2]::util::run_in_thread_pool_with_globals<rustc_interface[9aa301a3811405e2]::interface::run_compiler<core[64c76e218c955efd]::result::Result<(), rustc_errors[a9175c9762cc5fd5]::ErrorReported>, rustc_driver[691b9c2a58b062eb]::run_compiler::{closure#1}>::{closure#0}, core[64c76e218c955efd]::result::Result<(), rustc_errors[a9175c9762cc5fd5]::ErrorReported>>::{closure#0}, core[64c76e218c955efd]::result::Result<(), rustc_errors[a9175c9762cc5fd5]::ErrorReported>>\r\n  47:     0x7f0a86000a99 - <<std[6a13073971966f88]::thread::Builder>::spawn_unchecked_<rustc_interface[9aa301a3811405e2]::util::run_in_thread_pool_with_globals<rustc_interface[9aa301a3811405e2]::interface::run_compiler<core[64c76e218c955efd]::result::Result<(), rustc_errors[a9175c9762cc5fd5]::ErrorReported>, rustc_driver[691b9c2a58b062eb]::run_compiler::{closure#1}>::{closure#0}, core[64c76e218c955efd]::result::Result<(), rustc_errors[a9175c9762cc5fd5]::ErrorReported>>::{closure#0}, core[64c76e218c955efd]::result::Result<(), rustc_errors[a9175c9762cc5fd5]::ErrorReported>>::{closure#1} as core[64c76e218c955efd]::ops::function::FnOnce<()>>::call_once::{shim:vtable#0}\r\n  48:     0x7f0a83a06bb3 - <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once::h47f7423189df9269\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/alloc/src/boxed.rs:1854:9\r\n  49:     0x7f0a83a06bb3 - <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once::h7e8094f66f114b55\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/alloc/src/boxed.rs:1854:9\r\n  50:     0x7f0a83a06bb3 - std::sys::unix::thread::Thread::new::thread_start::h928d5beb8b5b03f1\r\n                               at /rustc/c1d075a4592e1f9aef1f13e960cea0b03d2ad025/library/std/src/sys/unix/thread.rs:108:17\r\n  51:     0x7f0a8393a609 - start_thread\r\n  52:     0x7f0a83853163 - clone\r\n  53:                0x0 - <unknown>\r\n\r\n```\r\n\r\nquery:\r\n```\r\n#0 [typeck] type-checking `main`\r\n#1 [typeck] type-checking `main::{closure#0}`\r\n#2 [typeck_item_bodies] type-checking all item bodies\r\n#3 [analysis] running analysis passes on this crate\r\n```\r\n\r\n\r\n\r\n\r\n\r\n<!-- TRIAGEBOT_START -->\r\n\r\n<!-- TRIAGEBOT_ASSIGN_START -->\r\n\r\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"compiler-errors\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\r\n\r\n<!-- TRIAGEBOT_ASSIGN_END -->\r\n<!-- TRIAGEBOT_END -->", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/94599/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/94599/timeline", "performed_via_github_app": null, "state_reason": "completed"}