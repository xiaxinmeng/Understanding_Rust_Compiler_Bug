{"url": "https://api.github.com/repos/rust-lang/rust/issues/37045", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/37045/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/37045/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/37045/events", "html_url": "https://github.com/rust-lang/rust/issues/37045", "id": 181849708, "node_id": "MDU6SXNzdWUxODE4NDk3MDg=", "number": 37045, "title": "BufWriter documentation should warn about ignored errors on drop", "user": {"login": "jgallag88", "id": 4139386, "node_id": "MDQ6VXNlcjQxMzkzODY=", "avatar_url": "https://avatars.githubusercontent.com/u/4139386?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jgallag88", "html_url": "https://github.com/jgallag88", "followers_url": "https://api.github.com/users/jgallag88/followers", "following_url": "https://api.github.com/users/jgallag88/following{/other_user}", "gists_url": "https://api.github.com/users/jgallag88/gists{/gist_id}", "starred_url": "https://api.github.com/users/jgallag88/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jgallag88/subscriptions", "organizations_url": "https://api.github.com/users/jgallag88/orgs", "repos_url": "https://api.github.com/users/jgallag88/repos", "events_url": "https://api.github.com/users/jgallag88/events{/privacy}", "received_events_url": "https://api.github.com/users/jgallag88/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2016-10-08T21:26:57Z", "updated_at": "2017-05-14T21:41:03Z", "closed_at": "2017-05-14T21:41:03Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "`BufWriter` calls `flush_buf()` in its destructor, which writes out the contents of its internal buffer to the underlying writer. The destructor ignores any errors that happen when flushing the buffer. This makes it easy to accidentally forget to handle such errors:\n\n``` rust\nuse std::io::BufWriter;\nuse std::io::Result;\nuse std::io::Write;\nuse std::process::{ChildStdin, Command, Stdio};\nuse std::time::Duration;\nuse std::thread;\n\nfn mk_broken_pipe() -> ChildStdin {\n    let child = Command::new(\"true\").stdin(Stdio::piped()).spawn().unwrap();\n    // Wait for child to exit and close it's end of the pipe\n    thread::sleep(Duration::from_secs(1));\n    child.stdin.unwrap() // All writes to this pipe should now fail\n}\n\nfn f1() -> Result<()> {\n    let mut child_stdin = mk_broken_pipe();\n    child_stdin.write_all(b\"Some bytes\")\n}\n\nfn f2() -> Result<()> {\n    let mut child_stdin = BufWriter::new(mk_broken_pipe());\n    child_stdin.write_all(b\"Some bytes\")\n    // Oops, forgot to call flush()\n}\n\nfn f3() -> Result<()> {\n    let mut child_stdin = BufWriter::new(mk_broken_pipe());\n    try!(child_stdin.write_all(b\"Some bytes\"));\n    child_stdin.flush()\n}\n\nfn main() {\n    println!(\"Without BufWriter: {:?}\", f1());\n    println!(\"With BufWriter, but forgot to call flush: {:?}\", f2());\n    println!(\"With BufWriter, with call to flush: {:?}\", f3());\n}\n```\n\nThe code above outputs\n\n```\nWithout BufWriter: Err(Error { repr: Os { code: 32, message: \"Broken pipe\" } })\nWith BufWriter, but forgot to call flush: Ok(())\nWith BufWriter, with call to flush: Err(Error { repr: Os { code: 32, message: \"Broken pipe\" } })\n```\n\nIt's tempting (at least to me) to think of `BufWriter` as preserving the semantics of the underlying writer, while offering possible performance improvements. It doesn't quite though, and it's unfortunately easy to forget to call `flush()`, and to ignore errors when using `BufWriter`, as in function `f2()` above.\n\nIt seems like a warning in the `BufWriter` documentation could be helpful here. Right now it says\n\n> The buffer will be written out when the writer is dropped.\n\nPerhaps it could be changed to something like\n\n> When the writer is dropped, the BufWriter will be flushed and the contents of its buffer will be written out. However, any errors that happen when the writer is dropped will be ignored. Code that wishes to handle such errors must manually call flush() before the writer is dropped.\n\nIf a change along these lines is of interest, I'll make a pull request.\n", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/37045/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/37045/timeline", "performed_via_github_app": null, "state_reason": "completed"}