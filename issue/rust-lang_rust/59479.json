{"url": "https://api.github.com/repos/rust-lang/rust/issues/59479", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/59479/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/59479/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/59479/events", "html_url": "https://github.com/rust-lang/rust/issues/59479", "id": 426355918, "node_id": "MDU6SXNzdWU0MjYzNTU5MTg=", "number": 59479, "title": "Rust generate erroneous debug line information for non-local panic handlers", "user": {"login": "richardwhiuk", "id": 346165, "node_id": "MDQ6VXNlcjM0NjE2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/346165?v=4", "gravatar_id": "", "url": "https://api.github.com/users/richardwhiuk", "html_url": "https://github.com/richardwhiuk", "followers_url": "https://api.github.com/users/richardwhiuk/followers", "following_url": "https://api.github.com/users/richardwhiuk/following{/other_user}", "gists_url": "https://api.github.com/users/richardwhiuk/gists{/gist_id}", "starred_url": "https://api.github.com/users/richardwhiuk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/richardwhiuk/subscriptions", "organizations_url": "https://api.github.com/users/richardwhiuk/orgs", "repos_url": "https://api.github.com/users/richardwhiuk/repos", "events_url": "https://api.github.com/users/richardwhiuk/events{/privacy}", "received_events_url": "https://api.github.com/users/richardwhiuk/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 203130, "node_id": "MDU6TGFiZWwyMDMxMzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-debuginfo", "name": "A-debuginfo", "color": "f7e101", "default": false, "description": "Area: Debugging information in compiled programs (DWARF, PDB, etc.)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 289259951, "node_id": "MDU6TGFiZWwyODkyNTk5NTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-help-wanted", "name": "E-help-wanted", "color": "02E10C", "default": false, "description": "Call for participation: Help is requested to fix this issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2019-03-28T08:17:46Z", "updated_at": "2022-09-19T19:37:45Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "Related to https://github.com/rust-lang/rust/issues/55352, Rustc 1.33 generates incorrect debugging information for panic handlers not in the current crate:\r\n\r\nCompiling:\r\n\r\n```rust\r\n// Taken from https://github.com/rust-lang/rust/issues/55352\r\n\r\npub struct Person {\r\n    pub name: String,\r\n    pub age: u32\r\n}\r\n\r\npub fn get_age() -> u32 {\r\n    42\r\n}\r\n\r\npub fn create_bob() -> Person {\r\n    Person {\r\n        name: \"Bob\".to_string(),\r\n        age: get_age()\r\n    }\r\n}\r\n\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::create_bob;\r\n    use super::get_age;\r\n\r\n    #[test]\r\n    fn test_create_bob() {\r\n        create_bob();\r\n    }\r\n\r\n    #[test]\r\n    fn test_get_age() {\r\n        assert_eq!(get_age(), 42);\r\n    }\r\n}\r\n```\r\n\r\nas `src/lib.rs`, Rust generates a `.debug_lines` section, which contains the following (from `readelf --debug-dump=decodedline`):\r\n\r\n```\r\nCU: /rustc/2aa4c46cfdd726e97360c2734835aa3515e8c858/src/libtest/lib.rs:\r\nFile name                            Line number    Starting address\r\nlib.rs                                       330             0x1e580\r\n\r\nlib.rs                                       331             0x1e587\r\nlib.rs                                         0             0x1e590\r\n\r\n./<::core::macros::assert_eq macros>:[++]\r\n<::core::macros::assert_eq macros>            14             0x1e597\r\n<::core::macros::assert_eq macros>            15             0x1e5a6\r\n<::core::macros::assert_eq macros>            15             0x1e5b0\r\n<::core::macros::assert_eq macros>            16             0x1e5bd\r\n<::core::macros::assert_eq macros>            16             0x1e5c4\r\n<::core::macros::assert_eq macros>            16             0x1e5cc\r\n<::core::macros::assert_eq macros>            16             0x1e5d2\r\n<::core::macros::assert_eq macros>            16             0x1e5d6\r\n<::core::macros::assert_eq macros>             0             0x1e5de\r\n\r\n/rustc/2aa4c46cfdd726e97360c2734835aa3515e8c858/src/libtest/lib.rs:\r\nlib.rs                                       335             0x1e5e5\r\n\r\nsrc/lib.rs:\r\nlib.rs                                         1             0x1e5f2\r\n```\r\n\r\nThis means that the `/rustc/2aa4c46cfdd726e97360c2734835aa3515e8c858/src/libtest/lib.rs` compilation unit points a debug line at line 1 of `src/lib.rs`\r\n\r\nReading through the generated assembly (via `objdump -S -d`)\r\n\r\n```\r\n000000000001e580 <_ZN4test18assert_test_result17haf3989bfec92a9a7E>:\r\n   1e580:       48 81 ec 68 01 00 00    sub    $0x168,%rsp\r\n   1e587:       e8 54 e4 ff ff          callq  1c9e0 <_ZN54_$LT$$LP$$RP$$u20$as$u20$std..process..Termination$GT$6report17h05d35b96322ac0d1E>\r\n   1e58c:       89 44 24 64             mov    %eax,0x64(%rsp)\r\n   1e590:       48 8d 05 25 dd 0a 00    lea    0xadd25(%rip),%rax        # cc2bc <_IO_stdin_used+0xfc>\r\n   1e597:       48 8d 4c 24 64          lea    0x64(%rsp),%rcx\r\n   1e59c:       48 89 4c 24 68          mov    %rcx,0x68(%rsp)\r\n   1e5a1:       48 89 44 24 70          mov    %rax,0x70(%rsp)\r\n   1e5a6:       48 8b 44 24 68          mov    0x68(%rsp),%rax\r\n   1e5ab:       48 89 44 24 78          mov    %rax,0x78(%rsp)\r\n   1e5b0:       48 8b 44 24 70          mov    0x70(%rsp),%rax\r\n   1e5b5:       48 89 84 24 80 00 00    mov    %rax,0x80(%rsp)\r\n   1e5bc:       00 \r\n   1e5bd:       48 8b 44 24 78          mov    0x78(%rsp),%rax\r\n   1e5c2:       8b 10                   mov    (%rax),%edx\r\n   1e5c4:       48 8b 84 24 80 00 00    mov    0x80(%rsp),%rax\r\n   1e5cb:       00 \r\n   1e5cc:       3b 10                   cmp    (%rax),%edx\r\n   1e5ce:       40 0f 94 c6             sete   %sil\r\n   1e5d2:       40 80 f6 ff             xor    $0xff,%sil\r\n   1e5d6:       40 f6 c6 01             test   $0x1,%sil\r\n   1e5da:       75 02                   jne    1e5de <_ZN4test18assert_test_result17haf3989bfec92a9a7E+0x5e>\r\n   1e5dc:       eb 3d                   jmp    1e61b <_ZN4test18assert_test_result17haf3989bfec92a9a7E+0x9b>\r\n   1e5de:       48 8d 35 3b 15 0a 00    lea    0xa153b(%rip),%rsi        # bfb20 <_ZN4core3fmt3num52_$LT$impl$u20$core..fmt..Display$u20$for$u20$i32$GT$3fmt17ha3b2ffd94f72c608E>\r\n   1e5e5:       48 8d 44 24 64          lea    0x64(%rsp),%rax\r\n   1e5ea:       48 89 84 24 40 01 00    mov    %rax,0x140(%rsp)\r\n   1e5f1:       00 \r\n// Taken from https://github.com/rust-lang/rust/issues/55352\r\n   1e5f2:       48 8b 84 24 40 01 00    mov    0x140(%rsp),%rax\r\n```\r\n\r\n`1ef52` is part of the panic handler if a test fails.\r\n\r\nThus it's not possible to cover the code without having a test fail!", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/59479/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/59479/timeline", "performed_via_github_app": null, "state_reason": null}