{"url": "https://api.github.com/repos/rust-lang/rust/issues/36691", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/36691/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/36691/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/36691/events", "html_url": "https://github.com/rust-lang/rust/issues/36691", "id": 179013377, "node_id": "MDU6SXNzdWUxNzkwMTMzNzc=", "number": 36691, "title": "Custom derives: TokenStream::from_str fails if the string contains 'mod foo;'", "user": {"login": "comex", "id": 47517, "node_id": "MDQ6VXNlcjQ3NTE3", "avatar_url": "https://avatars.githubusercontent.com/u/47517?v=4", "gravatar_id": "", "url": "https://api.github.com/users/comex", "html_url": "https://github.com/comex", "followers_url": "https://api.github.com/users/comex/followers", "following_url": "https://api.github.com/users/comex/following{/other_user}", "gists_url": "https://api.github.com/users/comex/gists{/gist_id}", "starred_url": "https://api.github.com/users/comex/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/comex/subscriptions", "organizations_url": "https://api.github.com/users/comex/orgs", "repos_url": "https://api.github.com/users/comex/repos", "events_url": "https://api.github.com/users/comex/events{/privacy}", "received_events_url": "https://api.github.com/users/comex/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 632573348, "node_id": "MDU6TGFiZWw2MzI1NzMzNDg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-macros-2.0", "name": "A-macros-2.0", "color": "f7e101", "default": false, "description": "Area: declarative macros 2.0, https://github.com/rust-lang/rust/issues/39412"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2016-09-24T05:58:39Z", "updated_at": "2021-07-07T03:51:56Z", "closed_at": "2021-07-07T03:51:56Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "It returns the somewhat unhelpful `LexError { _inner: () }`, which is caused by a ModulePathError in the parser.  This happens regardless of whether an appropriately-named Rust file exists.  If a path attribute is present and the path is not absolute, `from_str` still doesn't work, but panics after printing a proper error message rather than returning an error.\n\nIf macros 1.1 is used as intended, this is unlikely to come up.  While the input (the body of a struct or enum) can contain a mod declaration inside a block inside an enum raw value, array length, etc., such declarations will generally already be expanded with the contents of the module file by the time they reach the custom derive - unless they are inside a macro invocation, in which case (if the derive preserves the invocation in its output) `from_str` will only parse it to a `Mac`, and the compiler will successfully deal with it later on, when it expands that macro.  The questionable behavior only comes up if the custom derive either strips out a macro invocation or supplies its own code altogether.\n\n(I ran across this when using macros 1.1 for a rather hackier purpose.)\n\nSimple test case:\n\n``` rust\n#![feature(rustc_macro, rustc_macro_lib)] \nextern crate rustc_macro;\nuse rustc_macro::TokenStream;\nuse std::str::FromStr;\n\n#[rustc_macro_derive(foo)]\npub fn foo(_: TokenStream) -> TokenStream {\n    TokenStream::from_str(\"mod foo;\").unwrap()\n}\n```\n", "closed_by": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/36691/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/36691/timeline", "performed_via_github_app": null, "state_reason": "completed"}