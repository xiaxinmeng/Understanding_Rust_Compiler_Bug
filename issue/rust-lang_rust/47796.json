{"url": "https://api.github.com/repos/rust-lang/rust/issues/47796", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/47796/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/47796/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/47796/events", "html_url": "https://github.com/rust-lang/rust/issues/47796", "id": 292081759, "node_id": "MDU6SXNzdWUyOTIwODE3NTk=", "number": 47796, "title": "derived Clone implementations for many-variant enums are unnecessarily large", "user": {"login": "bholley", "id": 377435, "node_id": "MDQ6VXNlcjM3NzQzNQ==", "avatar_url": "https://avatars.githubusercontent.com/u/377435?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bholley", "html_url": "https://github.com/bholley", "followers_url": "https://api.github.com/users/bholley/followers", "following_url": "https://api.github.com/users/bholley/following{/other_user}", "gists_url": "https://api.github.com/users/bholley/gists{/gist_id}", "starred_url": "https://api.github.com/users/bholley/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bholley/subscriptions", "organizations_url": "https://api.github.com/users/bholley/orgs", "repos_url": "https://api.github.com/users/bholley/repos", "events_url": "https://api.github.com/users/bholley/events{/privacy}", "received_events_url": "https://api.github.com/users/bholley/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 1049491442, "node_id": "MDU6TGFiZWwxMDQ5NDkxNDQy", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-heavy", "name": "I-heavy", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to binary size of generated code."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 18, "created_at": "2018-01-27T02:21:14Z", "updated_at": "2020-04-20T22:38:10Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The derived Clone implementations in Firefox weigh 192k [1], which is a lot.\r\n\r\nOf that 192k, 79k of that is just for PropertyDeclaration::clone. PropertyDeclaration is a very large enum, but most of the variants are simple POD types. Ideally Rust would coalesce those together, and then generate special cases for the types that need it. Unfortunately, it appears that adding a single non-POD variant causes all the cases to be enumerated separately, as seen in the testcase at [2].\r\n\r\nFrom IRC:\r\n\r\n> eddyb\tbholley: yeah I think this is a valid issue\r\n> eddyb:\tif you do generate that sort of \"(partial) identity match\" it's unlikely to have anything else collapse it\r\n> eddyb:\tLLVM might have a pass for switch-discriminant-dependent-values\r\n> eddyb:\tbut it probably has serious limitations in practice\r\n> eddyb:\tbholley: but yeah this is one of those cases where not scattering in the first place is significantly easier than gathering later`\r\n\r\nIdeally we'd do the same for PartialEq, since PropertyDeclaration::eq weighs another 61k.\r\n\r\n[1] nm --print-size --size-sort --radix=d libxul.so | grep \"\\.\\.Clone\" | grep -v Cloned | cut -d \" \" -f 2 | awk '{s+=$1} END {print s}'\r\n[2] https://play.rust-lang.org/?gist=0207af76d2e05acdbed913b7df96aa77&version=stable", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/47796/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/47796/timeline", "performed_via_github_app": null, "state_reason": null}