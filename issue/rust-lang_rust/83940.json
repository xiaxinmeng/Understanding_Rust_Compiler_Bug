{"url": "https://api.github.com/repos/rust-lang/rust/issues/83940", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/83940/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/83940/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/83940/events", "html_url": "https://github.com/rust-lang/rust/issues/83940", "id": 851646836, "node_id": "MDU6SXNzdWU4NTE2NDY4MzY=", "number": 83940, "title": "Compiling std with multivalue feature on wasm32-unknown-unknown target fails", "user": {"login": "protheory8", "id": 59506423, "node_id": "MDQ6VXNlcjU5NTA2NDIz", "avatar_url": "https://avatars.githubusercontent.com/u/59506423?v=4", "gravatar_id": "", "url": "https://api.github.com/users/protheory8", "html_url": "https://github.com/protheory8", "followers_url": "https://api.github.com/users/protheory8/followers", "following_url": "https://api.github.com/users/protheory8/following{/other_user}", "gists_url": "https://api.github.com/users/protheory8/gists{/gist_id}", "starred_url": "https://api.github.com/users/protheory8/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/protheory8/subscriptions", "organizations_url": "https://api.github.com/users/protheory8/orgs", "repos_url": "https://api.github.com/users/protheory8/repos", "events_url": "https://api.github.com/users/protheory8/events{/privacy}", "received_events_url": "https://api.github.com/users/protheory8/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 474645165, "node_id": "MDU6TGFiZWw0NzQ2NDUxNjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-wasm", "name": "O-wasm", "color": "6e6ec0", "default": false, "description": "Target: WASM (WebAssembly), http://webassembly.org/"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2021-04-06T17:34:21Z", "updated_at": "2021-12-15T09:47:47Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I tried this code:\r\n\r\n`src/lib.rs`:\r\n```rust\r\n#[no_mangle]\r\npub extern fn return_two_nums() -> (i32, i32) {\r\n    (0, 1)\r\n}\r\n```\r\nand compiled it with `RUSTFLAGS=\"-C target-feature=+multivalue\" cargo build -Z build-std=std,panic_abort --target=wasm32-unknown-unknown `\r\n\r\nExpected: to compile and link it without any errors\r\n\r\nInstead, this happened: It seems like everything compiles successfully, but linking fails\r\n```\r\n   Compiling wasm32-bug v0.1.0 (/home/protheory8/wasm32-bug)\r\nwarning: `extern` fn uses type `(i32, i32)`, which is not FFI-safe\r\n --> src/lib.rs:2:36\r\n  |\r\n2 | pub extern fn return_two_nums() -> (i32, i32) {\r\n  |                                    ^^^^^^^^^^ not FFI-safe\r\n  |\r\n  = note: `#[warn(improper_ctypes_definitions)]` on by default\r\n  = help: consider using a struct instead\r\n  = note: tuples have unspecified layout\r\n\r\nerror: linking with `rust-lld` failed: exit code: 1\r\n  |\r\n  = note: \"rust-lld\" \"-flavor\" \"wasm\" \"--rsp-quoting=posix\" \"-z\" \"stack-size=1048576\" \"--stack-first\" \"--allow-undefined\" \"--fatal-warnings\" \"--no-demangle\" \"--no-entry\" \"--export-dynamic\" \"-L\" \"/home/protheory8/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib\" \"-L\" \"/home/protheory8/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/self-contained\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/wasm32_bug.71ssxutnzvyhpcu.rcgu.o\" \"-o\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/wasm32_bug.wasm\" \"--export\" \"return_two_nums\" \"--export=__heap_base\" \"--export=__data_end\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/wasm32_bug.4orz6m03gj8b4xnw.rcgu.o\" \"--gc-sections\" \"--no-entry\" \"-O0\" \"-L\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps\" \"-L\" \"/home/protheory8/wasm32-bug/target/debug/deps\" \"-L\" \"/home/protheory8/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libstd-beccc785673c6aeb.rlib\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libpanic_abort-24b0daee374c1553.rlib\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libdlmalloc-dab06be4348a73d4.rlib\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/librustc_demangle-6276c86cadb17429.rlib\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libhashbrown-d06a9c000b1168cb.rlib\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/librustc_std_workspace_alloc-b882333370fd6ce1.rlib\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libunwind-434f7b253a0030e9.rlib\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcfg_if-92ffa7a39869d8ae.rlib\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/liblibc-45e0a57f04e65265.rlib\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/liballoc-0212469e737d53d5.rlib\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/librustc_std_workspace_core-3a74e5752e0920c4.rlib\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcore-efdd6a8e96e2450c.rlib\" \"/home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib\"\r\n  = note: rust-lld: error: function signature mismatch: __udivti3\r\n          >>> defined as (i32, i64, i64, i64, i64) -> void in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcore-efdd6a8e96e2450c.rlib(core-efdd6a8e96e2450c.core.ctsfpwqf-cgu.1.rcgu.o)\r\n          >>> defined as (i64, i64, i64, i64) -> i64 in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib(compiler_builtins-2e9b232f6c0a1e80.compiler_builtins.1oq7nsiy-cgu.4.rcgu.o)\r\n          \r\n          rust-lld: error: function signature mismatch: __ashlti3\r\n          >>> defined as (i32, i64, i64, i32) -> void in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib(compiler_builtins-2e9b232f6c0a1e80.compiler_builtins.1oq7nsiy-cgu.10.rcgu.o)\r\n          >>> defined as (i64, i64, i32) -> i64 in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib(compiler_builtins-2e9b232f6c0a1e80.compiler_builtins.1oq7nsiy-cgu.4.rcgu.o)\r\n          \r\n          rust-lld: error: function signature mismatch: __multi3\r\n          >>> defined as (i32, i64, i64, i64, i64) -> void in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/librustc_demangle-6276c86cadb17429.rlib(rustc_demangle-6276c86cadb17429.rustc_demangle.7ezo834z-cgu.8.rcgu.o)\r\n          >>> defined as (i64, i64, i64, i64) -> i64 in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib(compiler_builtins-2e9b232f6c0a1e80.compiler_builtins.1oq7nsiy-cgu.4.rcgu.o)\r\n          \r\n          rust-lld: error: function signature mismatch: __ashrti3\r\n          >>> defined as (i32, i64, i64, i32) -> void in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib(compiler_builtins-2e9b232f6c0a1e80.compiler_builtins.1oq7nsiy-cgu.10.rcgu.o)\r\n          >>> defined as (i64, i64, i32) -> i64 in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib(compiler_builtins-2e9b232f6c0a1e80.compiler_builtins.1oq7nsiy-cgu.4.rcgu.o)\r\n          \r\n          rust-lld: error: function signature mismatch: __umodti3\r\n          >>> defined as (i32, i64, i64, i64, i64) -> void in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcore-efdd6a8e96e2450c.rlib(core-efdd6a8e96e2450c.core.ctsfpwqf-cgu.1.rcgu.o)\r\n          >>> defined as (i64, i64, i64, i64) -> i64 in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib(compiler_builtins-2e9b232f6c0a1e80.compiler_builtins.1oq7nsiy-cgu.4.rcgu.o)\r\n          \r\n          rust-lld: error: function signature mismatch: __lshrti3\r\n          >>> defined as (i32, i64, i64, i32) -> void in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcore-efdd6a8e96e2450c.rlib(core-efdd6a8e96e2450c.core.ctsfpwqf-cgu.2.rcgu.o)\r\n          >>> defined as (i64, i64, i32) -> i64 in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib(compiler_builtins-2e9b232f6c0a1e80.compiler_builtins.1oq7nsiy-cgu.4.rcgu.o)\r\n          \r\n          rust-lld: error: function signature mismatch: __muloti4\r\n          >>> defined as (i32, i64, i64, i64, i64, i32) -> void in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcore-efdd6a8e96e2450c.rlib(core-efdd6a8e96e2450c.core.ctsfpwqf-cgu.2.rcgu.o)\r\n          >>> defined as (i64, i64, i64, i64, i32) -> i64 in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib(compiler_builtins-2e9b232f6c0a1e80.compiler_builtins.1oq7nsiy-cgu.11.rcgu.o)\r\n          \r\n          rust-lld: error: function signature mismatch: __divti3\r\n          >>> defined as (i32, i64, i64, i64, i64) -> void in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib(compiler_builtins-2e9b232f6c0a1e80.compiler_builtins.1oq7nsiy-cgu.10.rcgu.o)\r\n          >>> defined as (i64, i64, i64, i64) -> i64 in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib(compiler_builtins-2e9b232f6c0a1e80.compiler_builtins.1oq7nsiy-cgu.4.rcgu.o)\r\n          \r\n          rust-lld: error: function signature mismatch: __modti3\r\n          >>> defined as (i32, i64, i64, i64, i64) -> void in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib(compiler_builtins-2e9b232f6c0a1e80.compiler_builtins.1oq7nsiy-cgu.10.rcgu.o)\r\n          >>> defined as (i64, i64, i64, i64) -> i64 in /home/protheory8/wasm32-bug/target/wasm32-unknown-unknown/debug/deps/libcompiler_builtins-2e9b232f6c0a1e80.rlib(compiler_builtins-2e9b232f6c0a1e80.compiler_builtins.1oq7nsiy-cgu.4.rcgu.o)\r\n          \r\n\r\nerror: aborting due to previous error; 1 warning emitted\r\n\r\nerror: could not compile `wasm32-bug`\r\n```\r\n\r\n### Meta\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.53.0-nightly (07e0e2ec2 2021-03-24)\r\nbinary: rustc\r\ncommit-hash: 07e0e2ec268c140e607e1ac7f49f145612d0f597\r\ncommit-date: 2021-03-24\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.53.0-nightly\r\nLLVM version: 12.0.0\r\n```\r\n\r\n`Cargo.toml`:\r\n```toml\r\n[package]\r\nname = \"wasm32-bug\"\r\nversion = \"0.1.0\"\r\nauthors = [\"protheory8\"]\r\nedition = \"2018\"\r\n\r\n[lib]\r\ncrate-type = [\"cdylib\"]\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/83940/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/83940/timeline", "performed_via_github_app": null, "state_reason": null}