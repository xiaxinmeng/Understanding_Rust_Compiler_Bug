{"url": "https://api.github.com/repos/rust-lang/rust/issues/111593", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/111593/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/111593/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/111593/events", "html_url": "https://github.com/rust-lang/rust/issues/111593", "id": 1710018840, "node_id": "I_kwDOAAsO6M5l7NEY", "number": 111593, "title": "Linking a staticlib into shared C library or executable with gcc causes considerbly larger binary than linking into a cdylib or executable with rustc", "user": {"login": "sdroege", "id": 301846, "node_id": "MDQ6VXNlcjMwMTg0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/301846?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sdroege", "html_url": "https://github.com/sdroege", "followers_url": "https://api.github.com/users/sdroege/followers", "following_url": "https://api.github.com/users/sdroege/following{/other_user}", "gists_url": "https://api.github.com/users/sdroege/gists{/gist_id}", "starred_url": "https://api.github.com/users/sdroege/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sdroege/subscriptions", "organizations_url": "https://api.github.com/users/sdroege/orgs", "repos_url": "https://api.github.com/users/sdroege/repos", "events_url": "https://api.github.com/users/sdroege/events{/privacy}", "received_events_url": "https://api.github.com/users/sdroege/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2023-05-15T12:41:31Z", "updated_at": "2023-05-16T18:17:24Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "See https://github.com/sdroege/rust-staticlib-bloat-test for the code. This doesn't use cargo to make the actual compiler invocations clear (the same behaviour can be observed with cargo).\r\n\r\nWith Rust 1.69 and gcc 13.1.1 on Linux x86-64 the following can be observed:\r\n\r\n| | unstripped | stripped (`--strip-all`) |\r\n|-|-|-|\r\n| Rust executable (`my_test`) | 4.1MB | 315kB |\r\n| Rust cdylib (`libstaticlib.so`) | 4.0MB | 290kB |\r\n| gcc executable (`my_staticlib_test`) | 5.2MB (+ 27%) | 1.1MB (+ 355%) |\r\n| gcc shared library (`libmy_staticlib_test_dylib.so`) | 5.6MB (+ 40%) |  1.5MB (+ 517%) |\r\n\r\nThe actual size comes from the enabled overflow checks (`-C debug-assertions=on`) , and thus all the panic and string formatting machinery that is included. However, this should be approximately the same code in either case so that doesn't explain the difference. (Disabling the overflow checks gives a more expected result because the function from the library compiles down to a few instructions) Also note that this compiles with `-C panic=abort` so having the assertion in an `extern \"C\"` function is not UB.\r\n\r\nThe question here now is what exactly the difference between both cases is, and how the `staticlib` case can be improved. Maybe this requires changes in the compiler, maybe this just requires invoking the linker differently (in which case this would be useful to add to the documentation).", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/111593/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/111593/timeline", "performed_via_github_app": null, "state_reason": null}