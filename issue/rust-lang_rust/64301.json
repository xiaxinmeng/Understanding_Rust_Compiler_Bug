{"url": "https://api.github.com/repos/rust-lang/rust/issues/64301", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/64301/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/64301/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/64301/events", "html_url": "https://github.com/rust-lang/rust/issues/64301", "id": 490934364, "node_id": "MDU6SXNzdWU0OTA5MzQzNjQ=", "number": 64301, "title": "Too many `memcpy`s", "user": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 64037154, "node_id": "MDU6TGFiZWw2NDAzNzE1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compiletime", "name": "I-compiletime", "color": "e11d21", "default": false, "description": "Problems and improvements with respect to compile times."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 11, "created_at": "2019-09-09T07:50:31Z", "updated_at": "2019-12-16T22:44:56Z", "closed_at": "2019-12-16T22:44:55Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Cachegrind profiles indicate that the Rust compiler often spends 3-6% of its executed instructions within `memcpy` (specifically `__memcpy_avx_unaligned_erms` on my Linux box), which is pretty incredible.\r\n\r\nI have modified DHAT to track `memcpy`/`memmove` calls and have discovered that a lot are caused by obligation types, such as `PendingPredicateObligations` and `PendingObligations`, which are quite large (160 bytes and 136 bytes respectively on my Linux64 machine).\r\n\r\nFor example, for the `keccak` benchmark, 33% of the copied bytes occur in the `swap` call in the `compress` function:\r\nhttps://github.com/rust-lang/rust/blob/a6624ed9806fe4caa10de5b94e590f71a4a1eab9/src/librustc_data_structures/obligation_forest/mod.rs#L607-L620\r\n\r\nFor `serde`, 11% of the copied bytes occur constructing this vector of obligations:\r\nhttps://github.com/rust-lang/rust/blob/a6624ed9806fe4caa10de5b94e590f71a4a1eab9/src/librustc/ty/wf.rs#L150-L157\r\nand 5% occur appending to this vector of obligations:\r\nhttps://github.com/rust-lang/rust/blob/ac21131f7859836cd3fcb39231c0162fd892d960/src/librustc/traits/project.rs#L570-L574\r\n\r\nIt also looks like some functions such as `FulfillmentContext::register_predicate_obligation()` might be passed a `PredicateObligation` by value (using a `memcpy`) rather than by reference, though I'm not sure about that.\r\n\r\nI have some ideas to shrink these types a little, and improve how they're used, but these changes will be tinkering around the edges. It's possible that more fundamental changes to how the obligation system works could elicit bigger wins.\r\n\r\n", "closed_by": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/64301/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/64301/timeline", "performed_via_github_app": null, "state_reason": "completed"}