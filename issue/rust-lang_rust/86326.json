{"url": "https://api.github.com/repos/rust-lang/rust/issues/86326", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/86326/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/86326/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/86326/events", "html_url": "https://github.com/rust-lang/rust/issues/86326", "id": 921283390, "node_id": "MDU6SXNzdWU5MjEyODMzOTA=", "number": 86326, "title": "[Architecture] There are plenty of cyclic dependencies", "user": {"login": "Geigerkind", "id": 20394212, "node_id": "MDQ6VXNlcjIwMzk0MjEy", "avatar_url": "https://avatars.githubusercontent.com/u/20394212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Geigerkind", "html_url": "https://github.com/Geigerkind", "followers_url": "https://api.github.com/users/Geigerkind/followers", "following_url": "https://api.github.com/users/Geigerkind/following{/other_user}", "gists_url": "https://api.github.com/users/Geigerkind/gists{/gist_id}", "starred_url": "https://api.github.com/users/Geigerkind/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Geigerkind/subscriptions", "organizations_url": "https://api.github.com/users/Geigerkind/orgs", "repos_url": "https://api.github.com/users/Geigerkind/repos", "events_url": "https://api.github.com/users/Geigerkind/events{/privacy}", "received_events_url": "https://api.github.com/users/Geigerkind/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2021-06-15T11:12:29Z", "updated_at": "2021-06-16T13:29:17Z", "closed_at": "2021-06-16T13:29:17Z", "author_association": "NONE", "active_lock_reason": null, "body": "Hi there!\r\nI wrote a static analysis tool and tried it out on the compiler sub projects.\r\nI don't know what kind of architecture you are using in those sub projects, but I could check for module level cyclic dependencies.\r\nThe tool found quite a few cyclic dependencies.\r\n\r\n**How to reproduce it:**\r\n1. Install `cargo-archtest` (https://github.com/Geigerkind/arch_test)\r\n2. Put the appended `architecture.json` file into one of the project roots to the Cargo.toml file\r\n3. Execute `cargo archtest`\r\n\r\n`architecture.json` file content:\r\n```json\r\n{\r\n  \"layer_names\": [\r\n  ],\r\n  \"access_rules\": [\r\n    \"NoModuleCyclicDependencies\"\r\n  ]\r\n}\r\n```\r\nFor convenience I used this shell script:\r\n```sh\r\nfor dir in ./rustc_*/; do\r\n    echo $dir;\r\n    cp ./architecture.json $dir;\r\n    cd $dir;\r\n    cargo archtest;\r\n    cd ..;\r\ndone\r\n```\r\n\r\n**Output of the script (and the cyclic dependencies):**\r\nNote, the tool aborts after it found the first violated case, so there may be more.\r\n```\r\nbash exec_arch_test.sh\r\n./rustc_apfloat/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_arena/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_ast/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/ast.rs\r\n | Accessed:     Use: crate::token::CommentKind@1335..1373\r\n \u2b9f\r\n | File path:    ./src/token.rs\r\n | Accessed:     ImplicitUse: crate::ast::Pat@21972..21975\r\n \u2b9f\r\n./rustc_ast_lowering/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_ast_passes/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_ast_pretty/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_attr/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_builtin_macros/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_codegen_cranelift/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/analyze.rs\r\n | Accessed:     ImplicitUse: crate::abi::returning::can_return_to_ssa_var@1347..1368\r\n \u2b9f\r\n | File path:    ./src/abi/returning.rs\r\n | Accessed:     ImplicitUse: crate::analyze::SsaKind@2172..2179\r\n \u2b9f\r\n./rustc_codegen_llvm/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/context.rs\r\n | Accessed:     ImplicitUse: crate::coverageinfo::CrateCoverageContext@3383..3403\r\n \u2b9f\r\n | File path:    ./src/coverageinfo/mod.rs\r\n | Accessed:     Use: crate::context::CodegenCx@81..105\r\n \u2b9f\r\n./rustc_codegen_ssa/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/base.rs\r\n | Accessed:     Use: crate::common::TypeKind@232..271\r\n \u2b9f\r\n | File path:    ./src/common.rs\r\n | Accessed:     ImplicitUse: crate::base::cast_shift_expr_rhs@3208..3227\r\n \u2b9f\r\n./rustc_data_structures/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_driver/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/lib.rs\r\n | Accessed:     ImplicitUse: crate::pretty::print_after_hir_lowering@11065..11089\r\n \u2b9f\r\n | File path:    ./src/pretty.rs\r\n | Accessed:     Use: crate::abort_on_err@597..616\r\n \u2b9f\r\n./rustc_error_codes/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_errors/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/lib.rs\r\n | Accessed:     ImplicitUse: crate::diagnostic_builder::DiagnosticBuilder@1473..1490\r\n \u2b9f\r\n | File path:    ./src/diagnostic_builder.rs\r\n | Accessed:     Use: crate::diagnostic::DiagnosticId@11..61\r\n \u2b9f\r\n | File path:    ./src/diagnostic.rs\r\n | Accessed:     Use: crate::CodeSuggestion@31..52\r\n \u2b9f\r\n./rustc_expand/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/base.rs\r\n | Accessed:     Use: crate::expand::Invocation@19..50\r\n \u2b9f\r\n | File path:    ./src/expand.rs\r\n | Accessed:     ImplicitUse: crate::base::ExpansionData@11698..11711\r\n \u2b9f\r\n./rustc_feature/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_fs_util/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_graphviz/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_hir/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_hir_pretty/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_incremental/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_index/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_infer/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/infer/mod.rs\r\n | Accessed:     ImplicitUse: crate::infer::type_variable::TypeVariableStorage@5250..5269\r\n \u2b9f\r\n | File path:    ./src/infer/type_variable.rs\r\n | Accessed:     Use: crate::infer::undo_log::InferCtxtUndoLogs@130..161\r\n \u2b9f\r\n | File path:    ./src/infer/undo_log.rs\r\n | Accessed:     Use: crate::infer::InferCtxtInner@261..340\r\n \u2b9f\r\n./rustc_interface/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_lexer/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_lint/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/context.rs\r\n | Accessed:     Use: crate::levels::LintLevelsBuilder@880..912\r\n \u2b9f\r\n | File path:    ./src/levels.rs\r\n | Accessed:     Use: crate::late::unerased_lint_store@58..90\r\n \u2b9f\r\n | File path:    ./src/late.rs\r\n | Accessed:     Use: crate::context::LateContext@861..927\r\n \u2b9f\r\n./rustc_lint_defs/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_llvm/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_macros/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_metadata/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/creader.rs\r\n | Accessed:     Use: crate::locator::CrateError@137..175\r\n \u2b9f\r\n | File path:    ./src/locator.rs\r\n | Accessed:     Use: crate::rmeta::decoder::MetadataBlob@9565..9611\r\n \u2b9f\r\n | File path:    ./src/rmeta/decoder.rs\r\n | Accessed:     Use: crate::creader::CrateMetadataRef@57..89\r\n \u2b9f\r\n./rustc_middle/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/ty/mod.rs\r\n | Accessed:     RePublish: crate::ty::sty::ExistentialPredicate@2546..3114\r\n \u2b9f\r\n | File path:    ./src/ty/sty.rs\r\n | Accessed:     Use: crate::ty::TyS@470..512\r\n \u2b9f\r\n./rustc_mir/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/monomorphize/partitioning/mod.rs\r\n | Accessed:     ImplicitUse: crate::monomorphize::partitioning::default::DefaultPartitioning@7008..7027\r\n \u2b9f\r\n | File path:    ./src/monomorphize/partitioning/default.rs\r\n | Accessed:     Use: crate::monomorphize::partitioning::PreInliningPartitioning@825..915\r\n \u2b9f\r\n./rustc_mir_build/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/build/mod.rs\r\n | Accessed:     Use: crate::build::expr::as_place::PlaceBuilder@22..64\r\n \u2b9f\r\n | File path:    ./src/build/expr/as_place.rs\r\n | Accessed:     Use: crate::build::BlockAnd@157..195\r\n \u2b9f\r\n./rustc_parse/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_parse_format/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_passes/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_plugin_impl/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_privacy/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_query_impl/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_query_system/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/query/mod.rs\r\n | Accessed:     RePublish: crate::query::job::QueryMap@125..201\r\n \u2b9f\r\n | File path:    ./src/query/job.rs\r\n | Accessed:     Use: crate::query::QueryStackFrame@92..123\r\n \u2b9f\r\n./rustc_resolve/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/lib.rs\r\n | Accessed:     Use: crate::macros::MacroRulesScopeRef@2977..3033\r\n \u2b9f\r\n | File path:    ./src/macros.rs\r\n | Accessed:     Use: crate::PathResult@407..489\r\n \u2b9f\r\n./rustc_save_analysis/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/lib.rs\r\n | Accessed:     Use: crate::dump_visitor::DumpVisitor@1168..1193\r\n \u2b9f\r\n | File path:    ./src/dump_visitor.rs\r\n | Accessed:     Use: crate::SaveContext@1538..1651\r\n \u2b9f\r\n./rustc_serialize/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_session/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/config.rs\r\n | Accessed:     ImplicitUse: crate::filesearch::get_or_default_sysroot@72443..72465\r\n \u2b9f\r\n | File path:    ./src/filesearch.rs\r\n | Accessed:     Use: crate::search_paths::SearchPath@114..152\r\n \u2b9f\r\n | File path:    ./src/search_paths.rs\r\n | Accessed:     ImplicitUse: crate::config::ErrorOutputType@1776..1791\r\n \u2b9f\r\n./rustc_span/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/lib.rs\r\n | Accessed:     RePublish: crate::hygiene::DesugaringKind@1367..1434\r\n \u2b9f\r\n | File path:    ./src/hygiene.rs\r\n | Accessed:     Use: crate::ExpnIdCache@1601..1673\r\n \u2b9f\r\n./rustc_symbol_mangling/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_target/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/spec/mod.rs\r\n | Accessed:     Use: crate::spec::crt_objects::CrtObjectsFallback@2061..2093\r\n \u2b9f\r\n | File path:    ./src/spec/crt_objects.rs\r\n | Accessed:     Use: crate::spec::LinkOutputKind@3517..3544\r\n \u2b9f\r\n./rustc_traits/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_trait_selection/\r\nViolated rule: NoModuleCyclicDependencies\r\n | File path:    ./src/traits/mod.rs\r\n | Accessed:     RePublish: crate::traits::coherence::OrphanCheckErr@1302..1333\r\n \u2b9f\r\n | File path:    ./src/traits/coherence.rs\r\n | Accessed:     Use: crate::traits::SkipLeakCheck@422..450\r\n \u2b9f\r\n./rustc_typeck/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_type_ir/\r\n[Ok]: No architecture rules were violated!\r\n./rustc_ty_utils/\r\n[Ok]: No architecture rules were violated!\r\n```\r\n\r\n", "closed_by": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/86326/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/86326/timeline", "performed_via_github_app": null, "state_reason": "completed"}