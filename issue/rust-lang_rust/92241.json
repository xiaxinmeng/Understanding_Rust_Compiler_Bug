{"url": "https://api.github.com/repos/rust-lang/rust/issues/92241", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/92241/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/92241/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/92241/events", "html_url": "https://github.com/rust-lang/rust/issues/92241", "id": 1088111270, "node_id": "I_kwDOAAsO6M5A20Km", "number": 92241, "title": "Alignments > 32 don't work on TLS on macos", "user": {"login": "glandium", "id": 1038527, "node_id": "MDQ6VXNlcjEwMzg1Mjc=", "avatar_url": "https://avatars.githubusercontent.com/u/1038527?v=4", "gravatar_id": "", "url": "https://api.github.com/users/glandium", "html_url": "https://github.com/glandium", "followers_url": "https://api.github.com/users/glandium/followers", "following_url": "https://api.github.com/users/glandium/following{/other_user}", "gists_url": "https://api.github.com/users/glandium/gists{/gist_id}", "starred_url": "https://api.github.com/users/glandium/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/glandium/subscriptions", "organizations_url": "https://api.github.com/users/glandium/orgs", "repos_url": "https://api.github.com/users/glandium/repos", "events_url": "https://api.github.com/users/glandium/events{/privacy}", "received_events_url": "https://api.github.com/users/glandium/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2021-12-24T03:00:53Z", "updated_at": "2021-12-24T09:01:02Z", "closed_at": "2021-12-24T05:29:45Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Edit: this is not what's going on, see https://github.com/rust-lang/rust/issues/92241#issuecomment-1000656624\r\n\r\nOriginal report, for posterity:\r\n<details>\r\n\r\nSTR:\r\n- `cargo new testcase ; cd testcase`\r\n- Take the example code from the [LocalKey documentation](https://doc.rust-lang.org/std/thread/struct.LocalKey.html#examples) (I stopped after the first `FOO.with()`) and stick it in `src/main.rs`.\r\n- cargo build\r\n- Run `otool -l $(grep -l __thread_vars target/debug/deps/*.o)`\r\n- In the output of the above otool command, look for `sectname __thread_vars`. For that section, you'll see `align 2^0 (1)`.\r\n\r\nThe alignment should at least be the alignment for RefCell<u32>, which is 8.\r\n\r\nThis is not causing problems because for some reason ld64 over-aligns the `__thread_vars` section in the final binary. It makes the alignment at 8, and further aligns at 16.\r\nBUT, ld64.lld marks the alignment as 1, and aligns at 8. Which is fine... until you have a thread local variable that uses a value that needs an alignment of 16 and runs instructions that trap if the value is not aligned (this happens in practice when using a ChaCha ThreadRng with AVX2 ; you can be lucky and have the variable aligned by miracle, but that is brittle).\r\n</details>\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.59.0-nightly (c09a9529c 2021-12-23)\r\nbinary: rustc\r\ncommit-hash: c09a9529c51cde41c1101e56049d418edb07bf71\r\ncommit-date: 2021-12-23\r\nhost: x86_64-apple-darwin\r\nrelease: 1.59.0-nightly\r\nLLVM version: 13.0.0\r\n```", "closed_by": {"login": "glandium", "id": 1038527, "node_id": "MDQ6VXNlcjEwMzg1Mjc=", "avatar_url": "https://avatars.githubusercontent.com/u/1038527?v=4", "gravatar_id": "", "url": "https://api.github.com/users/glandium", "html_url": "https://github.com/glandium", "followers_url": "https://api.github.com/users/glandium/followers", "following_url": "https://api.github.com/users/glandium/following{/other_user}", "gists_url": "https://api.github.com/users/glandium/gists{/gist_id}", "starred_url": "https://api.github.com/users/glandium/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/glandium/subscriptions", "organizations_url": "https://api.github.com/users/glandium/orgs", "repos_url": "https://api.github.com/users/glandium/repos", "events_url": "https://api.github.com/users/glandium/events{/privacy}", "received_events_url": "https://api.github.com/users/glandium/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/92241/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/92241/timeline", "performed_via_github_app": null, "state_reason": "completed"}