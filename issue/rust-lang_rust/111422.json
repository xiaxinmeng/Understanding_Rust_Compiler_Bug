{"url": "https://api.github.com/repos/rust-lang/rust/issues/111422", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/111422/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/111422/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/111422/events", "html_url": "https://github.com/rust-lang/rust/issues/111422", "id": 1703306693, "node_id": "I_kwDOAAsO6M5lhmXF", "number": 111422, "title": "Miri reports UB with opt-level 4 in code that should not have UB", "user": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}, {"id": 1927601458, "node_id": "MDU6TGFiZWwxOTI3NjAxNDU4", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-mir-opt", "name": "A-mir-opt", "color": "f7e101", "default": false, "description": "Area: MIR optimizations"}], "state": "closed", "locked": false, "assignee": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2023-05-10T07:38:23Z", "updated_at": "2023-05-12T10:19:22Z", "closed_at": "2023-05-12T10:19:22Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "```\r\n  tests/pass/ptr_raw.rs FAILED:\r\n  command: \"/home/runner/work/miri/miri/target/debug/miri\" \"--error-format=json\" \"-Dwarnings\" \"-Dunused\" \"-Zmiri-tag-gc=1\" \"-O\" \"-Zmir-opt-level=4\" \"-Cdebug-assertions=yes\" \"-Zui-testing\" \"--target\" \"x86_64-unknown-linux-gnu\" \"tests/pass/ptr_raw.rs\" \"--edition\" \"2021\"\r\n  \r\n  Error: no message\r\n  error file=tests/pass/ptr_raw.rs,line=0,title=pass test got exit status: 1, but expected 0::no message\r\n  \r\n  Error: Error: Undefined Behavior: attempting a write access using <2732> at alloc1455[0x0], but that tag does not exist in the borrow stack for this location\r\n  error file=tests/pass/ptr_raw.rs,line=9,title=Unmatched diagnostics::Error: Undefined Behavior: attempting a write access using <2732> at alloc1455[0x0], but that tag does not exist in the borrow stack for this location\r\n  \r\n  pass test got exit status: 1, but expected 0\r\n  \r\n  There were 1 unmatched diagnostics at tests/pass/ptr_raw.rs:9\r\n      Error: Undefined Behavior: attempting a write access using <2732> at alloc1455[0x0], but that tag does not exist in the borrow stack for this location\r\n  \r\n  full stderr:\r\n  warning: Miri does not support optimizations. If you have enabled optimizations by selecting a Cargo profile (such as --release) which changes other profile settings such as whether debug assertions and overflow checks are enabled, those settings are still applied.\r\n  \r\n  warning: You have explicitly enabled MIR optimizations, overriding Miri's default which is to completely disable them. Any optimizations may hide UB that Miri would otherwise detect, and it is not necessarily possible to predict what kind of UB will be missed. If you are enabling optimizations to make Miri run faster, we advise using cfg(miri) to shrink your workload instead. The performance benefit of enabling MIR optimizations is usually marginal at best.\r\n  \r\n  error: Undefined Behavior: attempting a write access using <2732> at alloc1455[0x0], but that tag does not exist in the borrow stack for this location\r\n    --> tests/pass/ptr_raw.rs:9:9\r\n     |\r\n  LL |         *raw = 42;\r\n     |         ^^^^^^^^^\r\n     |         |\r\n     |         attempting a write access using <2732> at alloc1455[0x0], but that tag does not exist in the borrow stack for this location\r\n     |         this error occurs as part of an access at alloc1455[0x0..0x4]\r\n     |\r\n     = help: this indicates a potential bug in the program: it performed an invalid operation, but the Stacked Borrows rules it violated are still experimental\r\n     = help: see https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md for further information\r\n  help: <2732> was created by a Unique retag at offsets [0x0..0x4]\r\n    --> tests/pass/ptr_raw.rs:3:13\r\n     |\r\n  LL |     let x = &mut x;\r\n     |             ^^^^^^\r\n  help: <2732> was later invalidated at offsets [0x0..0x4] by a SharedReadOnly retag\r\n    --> tests/pass/ptr_raw.rs:5:5\r\n     |\r\n  LL |     assert_eq!(*x, 12);\r\n     |     ^^^^^^^^^^^^^^^^^^\r\n     = note: BACKTRACE (of the first span):\r\n     = note: inside `basic_raw` at tests/pass/ptr_raw.rs:9:9: 9:18\r\n  note: inside `main`\r\n    --> tests/pass/ptr_raw.rs:24:5\r\n     |\r\n  LL |     basic_raw();\r\n     |     ^^^^^^^^^^^\r\n     = note: this error originates in the macro `assert_eq` (in Nightly builds, run with -Z macro-backtrace for more info)\r\n  \r\n  note: some details are omitted, run with `MIRIFLAGS=-Zmiri-backtrace=full` for a verbose backtrace\r\n  \r\n  error: aborting due to previous error; 2 warnings emitted\r\n  \r\n  \r\n  \r\n  \r\n  tests/pass/stacked-borrows/stacked-borrows.rs FAILED:\r\n  command: \"/home/runner/work/miri/miri/target/debug/miri\" \"--error-format=json\" \"-Dwarnings\" \"-Dunused\" \"-Zmiri-tag-gc=1\" \"-O\" \"-Zmir-opt-level=4\" \"-Cdebug-assertions=yes\" \"-Zui-testing\" \"--target\" \"x86_64-unknown-linux-gnu\" \"tests/pass/stacked-borrows/stacked-borrows.rs\" \"-Zmiri-retag-fields\" \"--edition\" \"2021\"\r\n  \r\n  Error: no message\r\n  error file=tests/pass/stacked-borrows/stacked-borrows.rs,line=0,title=pass test got exit status: 1, but expected 0::no message\r\n  \r\n  Error: Error: Undefined Behavior: attempting a write access using <2768> at alloc1530[0x0], but that tag does not exist in the borrow stack for this location\r\n  error file=tests/pass/stacked-borrows/stacked-borrows.rs,line=57,title=Unmatched diagnostics::Error: Undefined Behavior: attempting a write access using <2768> at alloc1530[0x0], but that tag does not exist in the borrow stack for this location\r\n  \r\n  pass test got exit status: 1, but expected 0\r\n  \r\n  There were 1 unmatched diagnostics at tests/pass/stacked-borrows/stacked-borrows.rs:57\r\n      Error: Undefined Behavior: attempting a write access using <2768> at alloc1530[0x0], but that tag does not exist in the borrow stack for this location\r\n  \r\n  full stderr:\r\n  warning: Miri does not support optimizations. If you have enabled optimizations by selecting a Cargo profile (such as --release) which changes other profile settings such as whether debug assertions and overflow checks are enabled, those settings are still applied.\r\n  \r\n  warning: You have explicitly enabled MIR optimizations, overriding Miri's default which is to completely disable them. Any optimizations may hide UB that Miri would otherwise detect, and it is not necessarily possible to predict what kind of UB will be missed. If you are enabling optimizations to make Miri run faster, we advise using cfg(miri) to shrink your workload instead. The performance benefit of enabling MIR optimizations is usually marginal at best.\r\n  \r\n  error: Undefined Behavior: attempting a write access using <2768> at alloc1530[0x0], but that tag does not exist in the borrow stack for this location\r\n    --> tests/pass/stacked-borrows/stacked-borrows.rs:57:9\r\n     |\r\n  LL |         *xraw = 4;\r\n     |         ^^^^^^^^^\r\n     |         |\r\n     |         attempting a write access using <2768> at alloc1530[0x0], but that tag does not exist in the borrow stack for this location\r\n     |         this error occurs as part of an access at alloc1530[0x0..0x4]\r\n     |\r\n     = help: this indicates a potential bug in the program: it performed an invalid operation, but the Stacked Borrows rules it violated are still experimental\r\n     = help: see https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md for further information\r\n  help: <2768> was created by a Unique retag at offsets [0x0..0x4]\r\n    --> tests/pass/stacked-borrows/stacked-borrows.rs:52:16\r\n     |\r\n  LL |     let xref = &mut x;\r\n     |                ^^^^^^\r\n  help: <2768> was later invalidated at offsets [0x0..0x4] by a SharedReadOnly retag\r\n    --> tests/pass/stacked-borrows/stacked-borrows.rs:54:16\r\n     |\r\n  LL |     let xshr = &*xref;\r\n     |                ^^^^^^\r\n     = note: BACKTRACE (of the first span):\r\n     = note: inside `mut_raw_then_mut_shr` at tests/pass/stacked-borrows/stacked-borrows.rs:57:9: 57:18\r\n  note: inside `main`\r\n    --> tests/pass/stacked-borrows/stacked-borrows.rs:9:5\r\n     |\r\n  LL |     mut_raw_then_mut_shr();\r\n     |     ^^^^^^^^^^^^^^^^^^^^^^\r\n  \r\n  note: some details are omitted, run with `MIRIFLAGS=-Zmiri-backtrace=full` for a verbose backtrace\r\n  \r\n  error: aborting due to previous error; 2 warnings emitted\r\n  \r\n  \r\n  \r\n  FAILURES:\r\n      tests/pass/ptr_raw.rs\r\n      tests/pass/stacked-borrows/stacked-borrows.rs\r\n```\r\nGiven the timing I would guess this is caused by https://github.com/rust-lang/rust/pull/106285 -- Cc @cjgillot ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/111422/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/111422/timeline", "performed_via_github_app": null, "state_reason": "completed"}