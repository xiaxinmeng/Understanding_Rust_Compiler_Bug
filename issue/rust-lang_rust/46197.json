{"url": "https://api.github.com/repos/rust-lang/rust/issues/46197", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/46197/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/46197/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/46197/events", "html_url": "https://github.com/rust-lang/rust/issues/46197", "id": 276243481, "node_id": "MDU6SXNzdWUyNzYyNDM0ODE=", "number": 46197, "title": "match_default_bindings ICE", "user": {"login": "CAD97", "id": 5992217, "node_id": "MDQ6VXNlcjU5OTIyMTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5992217?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CAD97", "html_url": "https://github.com/CAD97", "followers_url": "https://api.github.com/users/CAD97/followers", "following_url": "https://api.github.com/users/CAD97/following{/other_user}", "gists_url": "https://api.github.com/users/CAD97/gists{/gist_id}", "starred_url": "https://api.github.com/users/CAD97/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CAD97/subscriptions", "organizations_url": "https://api.github.com/users/CAD97/orgs", "repos_url": "https://api.github.com/users/CAD97/repos", "events_url": "https://api.github.com/users/CAD97/events{/privacy}", "received_events_url": "https://api.github.com/users/CAD97/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 867483626, "node_id": "MDU6TGFiZWw4Njc0ODM2MjY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/NLL-fixed-by-NLL", "name": "NLL-fixed-by-NLL", "color": "f799ea", "default": false, "description": "Bugs fixed, but only when NLL is enabled."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2017-11-23T01:03:45Z", "updated_at": "2018-06-07T18:07:20Z", "closed_at": "2018-06-07T18:07:19Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "[playground link](https://play.rust-lang.org/?gist=e427e7f532890a859fc01c7d5ccbf8b8&version=nightly)\r\n\r\n[A bit of history on running into this and trying to make the small reproduction case (Reddit)](https://www.reddit.com/r/rust/comments/7e35kc/a_match_default_bindings_ice_i_cant_reproduce/)\r\n\r\n```rust\r\n#![feature(match_default_bindings)]\r\n#![crate_type=\"lib\"]\r\n\r\nenum StringFragment {\r\n    #[allow(dead_code)]\r\n    String(String),\r\n}\r\n\r\npub struct StringFragments {\r\n    fragments: Vec<StringFragment>,\r\n}\r\n\r\nimpl StringFragments {\r\n    pub fn ice(&mut self) {\r\n        #[allow(unused_variables, unused_mut)]\r\n        match self.fragments.last_mut() {\r\n            Some(StringFragment::String(mut string)) => {}\r\n            _ => {}\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nThe above ICEs on a `cargo build` or `cargo test`, but not a `cargo check`. Changing `fn ice` to have a generic argument (such as `fn ice<D: Default>`) makes `cargo check` ICE as well.\r\n\r\nThis seems to have something to do with the `ref`/`mut` quality of the `string` binding in the `match`. Qualifying `ref mut string` or leaving off both qualifiers works fine (including when the branch has actual code using the `&mut String` and isn't just a stub).\r\n\r\nBacktrace:\r\n\r\n```\r\nnote: rustc 1.23.0-nightly (63739ab7b 2017-11-21) running on x86_64-pc-windows-msvc\r\n\r\nthread 'rustc' panicked at 'called `Result::unwrap()` on an `Err` value: (MoveData { move_paths: [MovePath { lvalue: _0 }, MovePath { lvalue: _1 }, MovePath { first_child: mp8, lvalue: _2 }, MovePath { lvalue: _3 }, MovePath { lvalue: _4 }, MovePath { lvalue: _5 }, MovePath { lvalue: _6 }, MovePath { lvalue: _7 }, MovePath { parent: mp2, first_child: mp9, lvalue: (_2 as Some) }, MovePath { parent: mp8, lvalue: ((_2 as Some).0: &'<empty> mut StringFragment) }], moves: [mp5@bb0[5], mp5@bb1[1], mp3@bb1[2], mp3@bb2[0], mp6@bb8[0], mp6@bb9[0], mp2@bb9[1], mp4@bb9[2]], loc_map: LocationMap { map: [[[], [], [], [], [], [mo0]], [[], [mo1], [mo2]], [[mo3], [], []], [[], []], [[]], [[]], [[]], [[], [], [], []], [[mo4]], [[mo5], [mo6], [mo7], []]] }, path_map: [[], [], [mo6], [mo2, mo3], [mo7], [mo0, mo1], [mo4, mo5], [], [], []], rev_lookup: MovePathLookup { locals: [mp0, mp1, mp2, mp3, mp4, mp5, mp6, mp7], projections: {(mp2, Downcast(std::option::Option, 1)): mp8, (mp8, Field(field[0], AbstractType)): mp9} } }, [IllegalMove { cannot_move_out_of: IllegalMoveOrigin { span: src\\lib.rs:16:41: 16:51, kind: BorrowedContent } }])', src\\libcore\\result.rs:906:4\r\nstack backtrace:\r\n   0:     0x7ff96ba03bb3 - _rdl_shrink_in_place\r\n   1:     0x7ff96ba15173 - std::panicking::Location::column::h71b638b1102d8ec2\r\n   2:     0x7ff96ba14d6b - std::panicking::Location::column::h71b638b1102d8ec2\r\n   3:     0x7ff96ba15745 - std::panicking::rust_panic_with_hook::h86332471201f0504\r\n   4:     0x7ff96ba155d0 - std::panicking::begin_panic_fmt::hcfe94f6ff6902731\r\n   5:     0x7ff96ba154b1 - std::panicking::begin_panic_fmt::hcfe94f6ff6902731\r\n   6:     0x7ff96ba15429 - rust_begin_unwind\r\n   7:     0x7ff96ba2534c - core::panicking::panic_fmt::h24a4546a238be7cd\r\n   8:     0x7ff9663695ab - <&'tcx rustc::ty::TyS<'tcx> as rustc_mir::dataflow::move_paths::abs_domain::Lift>::lift::h26c24aab0cd7f71e\r\n   9:     0x7ff966312974 - <rustc_mir::transform::elaborate_drops::ElaborateDrops as rustc_mir::transform::MirPass>::run_pass::h2bb8d8ca88d9e5d0\r\n  10:     0x7ff9663a916e - <rustc_mir::transform::MirSource as core::fmt::Debug>::fmt::he26a1325d68947ee\r\n  11:     0x7ff9663a357d - rustc_mir::transform::optimized_mir::h40cc8885a4442fd4\r\n  12:     0x7ff94f908f2c - rustc::ty::maps::<impl rustc::ty::maps::queries::optimized_mir<'tcx>>::ensure::h3173ff6543b9bdfd\r\n  13:     0x7ff94fb0ab07 - rustc::dep_graph::graph::DepGraph::in_ignore::h8c023ef9813636cc\r\n  14:     0x7ff94f7cf077 - rustc::util::ppaux::<impl core::fmt::Debug for rustc::ty::adjustment::Adjustment<'tcx>>::fmt::h67cf830736da1c27\r\n  15:     0x7ff94fcc3747 - <rustc::ty::_match::Match<'a, 'gcx, 'tcx> as rustc::ty::relate::TypeRelation<'a, 'gcx, 'tcx>>::tys::he01b853877be8f34\r\n  16:     0x7ff94f908fd6 - rustc::ty::maps::<impl rustc::ty::maps::queries::optimized_mir<'tcx>>::ensure::h3173ff6543b9bdfd\r\n  17:     0x7ff94f909785 - rustc::ty::maps::<impl rustc::ty::maps::queries::optimized_mir<'tcx>>::try_get::h7c0aec52fecd18d5\r\n  18:     0x7ff94fa84f1f - rustc::ty::maps::TyCtxtAt::optimized_mir::h8343d36f33df4668\r\n  19:     0x7ff94fcdb3f4 - rustc::ty::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::instance_mir::h9790ccd9ba9c9c25\r\n  20:     0x7ff98cdd02ae - rustc_trans_utils::collector::collect_crate_translation_items::ha0f6f364e0b9f2de\r\n  21:     0x7ff98cdcf505 - rustc_trans_utils::collector::collect_crate_translation_items::ha0f6f364e0b9f2de\r\n  22:     0x7ff95fff2a43 - <rustc_trans::time_graph::TimelineId as core::fmt::Debug>::fmt::h1b359c509c114fb7\r\n  23:     0x7ff95ff2adad - rustc_trans::base::trans_crate::hc4cd45f03351b78f\r\n  24:     0x7ff94fadf2ce - rustc::dep_graph::graph::DepGraph::in_ignore::h8c023ef9813636cc\r\n  25:     0x7ff94f7fc5a8 - rustc::util::ppaux::<impl core::fmt::Debug for rustc::ty::adjustment::Adjustment<'tcx>>::fmt::h67cf830736da1c27\r\n  26:     0x7ff94fc9cca7 - <rustc::ty::_match::Match<'a, 'gcx, 'tcx> as rustc::ty::relate::TypeRelation<'a, 'gcx, 'tcx>>::tys::he01b853877be8f34\r\n  27:     0x7ff94f9a34f7 - rustc::ty::maps::<impl rustc::ty::maps::queries::collect_and_partition_translation_items<'tcx>>::ensure::hc5d2d7a98a7d9015\r\n  28:     0x7ff94f9a3d56 - rustc::ty::maps::<impl rustc::ty::maps::queries::collect_and_partition_translation_items<'tcx>>::try_get::h559d3f156ba76ac1\r\n  29:     0x7ff94fa8c178 - rustc::ty::maps::TyCtxtAt::collect_and_partition_translation_items::h943415d2dcd98d7d\r\n  30:     0x7ff94fcdedd2 - rustc::ty::maps::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'lcx>>::collect_and_partition_translation_items::h3a36d944c492e2a0\r\n  31:     0x7ff95ff27e50 - rustc_trans::base::trans_crate::hc4cd45f03351b78f\r\n  32:     0x7ff95ffb775a - <rustc_trans::LlvmTransCrate as rustc_trans_utils::trans_crate::TransCrate>::trans_crate::h55c38da8b7c81be6\r\n  33:     0x7ff97ecc78b8 - <rustc_driver::Compilation as core::fmt::Debug>::fmt::h8f7593c47a7a42c2\r\n  34:     0x7ff97ec6594c - rustc_driver::driver::default_provide_extern::h369421b1cc050ae1\r\n  35:     0x7ff97ecb60e3 - <rustc_driver::Compilation as core::fmt::Debug>::fmt::h8f7593c47a7a42c2\r\n  36:     0x7ff97ecb2366 - <rustc_driver::Compilation as core::fmt::Debug>::fmt::h8f7593c47a7a42c2\r\n  37:     0x7ff97ecb3e19 - <rustc_driver::Compilation as core::fmt::Debug>::fmt::h8f7593c47a7a42c2\r\n  38:     0x7ff97ec1a4bc - <rustc_driver::pretty::UserIdentifiedItem as core::fmt::Debug>::fmt::hb25b55ed7fdedd90\r\n  39:     0x7ff97ec5e789 - rustc_driver::driver::compile_input::h6611ae9238b378aa\r\n  40:     0x7ff97eca2b46 - rustc_driver::run_compiler::hdefd8f8859fdcc80\r\n  41:     0x7ff97ebfc07d - <rustc_driver::pretty::UserIdentifiedItem as core::fmt::Debug>::fmt::hb25b55ed7fdedd90\r\n  42:     0x7ff96ba19171 - _rust_maybe_catch_panic\r\n  43:     0x7ff97ec96331 - <rustc_driver::derive_registrar::Finder as rustc::hir::itemlikevisit::ItemLikeVisitor<'v>>::visit_impl_item::h96d7e57ed143e192\r\n  44:     0x7ff96ba1320b - std::sys::imp::thread::Thread::new::h213e202edcaf2262\r\n  45:     0x7ff9b89b1fe3 - BaseThreadInitThunk\r\n```", "closed_by": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/46197/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/46197/timeline", "performed_via_github_app": null, "state_reason": "completed"}