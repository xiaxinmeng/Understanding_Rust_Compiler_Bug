{"url": "https://api.github.com/repos/rust-lang/rust/issues/59324", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/59324/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/59324/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/59324/events", "html_url": "https://github.com/rust-lang/rust/issues/59324", "id": 423448642, "node_id": "MDU6SXNzdWU0MjM0NDg2NDI=", "number": 59324, "title": "ICE: \"could not fully normalize <trait>\" in normalize_erasing_regions.rs", "user": {"login": "fanzeyi", "id": 409951, "node_id": "MDQ6VXNlcjQwOTk1MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/409951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fanzeyi", "html_url": "https://github.com/fanzeyi", "followers_url": "https://api.github.com/users/fanzeyi/followers", "following_url": "https://api.github.com/users/fanzeyi/following{/other_user}", "gists_url": "https://api.github.com/users/fanzeyi/gists{/gist_id}", "starred_url": "https://api.github.com/users/fanzeyi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fanzeyi/subscriptions", "organizations_url": "https://api.github.com/users/fanzeyi/orgs", "repos_url": "https://api.github.com/users/fanzeyi/repos", "events_url": "https://api.github.com/users/fanzeyi/events{/privacy}", "received_events_url": "https://api.github.com/users/fanzeyi/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 149689562, "node_id": "MDU6TGFiZWwxNDk2ODk1NjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-associated-items", "name": "A-associated-items", "color": "f7e101", "default": false, "description": "Area: Associated items such as associated types and consts."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1615551553, "node_id": "MDU6TGFiZWwxNjE1NTUxNTUz", "url": "https://api.github.com/repos/rust-lang/rust/labels/glacier", "name": "glacier", "color": "a5e2ff", "default": false, "description": "ICE tracked in rust-lang/glacier"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2019-03-20T20:07:12Z", "updated_at": "2021-12-01T16:36:10Z", "closed_at": "2021-12-01T16:36:10Z", "author_association": "NONE", "active_lock_reason": null, "body": "Code in question:\r\n\r\n```rust\r\ntrait BufMut {}\r\nstruct Bytes;\r\nstruct BytesMut;\r\n\r\npub trait Future {\r\n    type Item;\r\n}\r\n\r\npub trait Service {\r\n    type Response;\r\n    type Future: Future<Item = Self::Response>;\r\n}\r\n\r\npub trait ThriftService<F>:\r\n    Service<\r\n        Response = FramingEncoded<F>,\r\n        Future = Box<Future<Item = FramingEncodedFinal<F>>>,\r\n    >\r\nwhere\r\n    F: Framing,\r\n{\r\n    fn get_service(\r\n        &self,\r\n    ) -> &Service<\r\n        Response = Self::Response,\r\n        Future = Self::Future,\r\n    >;\r\n}\r\n\r\npub trait BufMutExt: BufMut {\r\n    type Final;\r\n}\r\n\r\nimpl BufMutExt for BytesMut {\r\n    type Final = Bytes;\r\n}\r\n\r\npub type FramingEncoded<F> = <F as Framing>::EncBuf;\r\npub type FramingEncodedFinal<F> = <<F as Framing>::EncBuf as BufMutExt>::Final;\r\n\r\npub trait Framing {\r\n    type EncBuf: BufMut;\r\n}\r\n\r\npub struct SRHeaderTransport;\r\nimpl Framing for SRHeaderTransport {\r\n    type EncBuf = BytesMut;\r\n}\r\n\r\npub type BoxService<H> = Box<\r\n    ThriftService<\r\n            SRHeaderTransport,\r\n            Response = Bytes,\r\n            Future = Box<Future<Item = Bytes>>,\r\n        >,\r\n>;\r\n\r\nfn with_factory<H>(self, factory: BoxService<H>) {}\r\n```\r\n\r\nBacktrace:\r\n\r\n```\r\n\r\nerror: internal compiler error: src/librustc_traits/normalize_erasing_regions.rs:43: could not fully normalize `&dyn ThriftService<F, Future=<Self as Service>::Future, Response=<Self as Service>::Response>`\r\n\r\nthread 'rustc' panicked at 'Box<Any>', src/librustc_errors/lib.rs:588:9\r\nstack backtrace:\r\n   0:        0x10ac060c3 - std::sys::unix::backtrace::tracing::imp::unwind_backtrace::h9a87463918f2aff9\r\n   1:        0x10abfec8c - std::sys_common::backtrace::_print::h54740e69908f9100\r\n   2:        0x10ac02671 - std::panicking::default_hook::{{closure}}::h519f1fd4b67636f1\r\n   3:        0x10ac02377 - std::panicking::default_hook::h5442e3ae9abda811\r\n   4:        0x109372e21 - rustc::util::common::panic_hook::he77624544de4249c\r\n   5:        0x10ac02ed1 - std::panicking::rust_panic_with_hook::h4a3495c63f64f755\r\n   6:        0x10a7d5db0 - std::panicking::begin_panic::h39822d9e7784ad14\r\n   7:        0x10a7d10fd - rustc_errors::Handler::bug::h12485ae4ffb29a65\r\n   8:        0x108f0b315 - rustc::util::bug::opt_span_bug_fmt::{{closure}}::hab4de751350b061f\r\n   9:        0x108f0aa89 - rustc::ty::context::tls::with_opt::{{closure}}::hf9789a4ca7b4602d\r\n  10:        0x108f0a9e8 - rustc::ty::context::tls::with_context_opt::h31a8f07b2eede9b0\r\n  11:        0x108f0aa41 - rustc::ty::context::tls::with_opt::he5de36b9ad0ca1ee\r\n  12:        0x108f0b224 - rustc::util::bug::opt_span_bug_fmt::hc498b6667031b6cf\r\n  13:        0x108f0b171 - rustc::util::bug::bug_fmt::hfd92ab0e6a89baed\r\n  14:        0x107066d1a - rustc::ty::context::GlobalCtxt::enter_local::he69b2fd5601780c2\r\n  15:        0x107082f92 - rustc_traits::normalize_erasing_regions::normalize_ty_after_erasing_regions::heeb9b350e0788a77\r\n  16:        0x108e79413 - rustc::ty::query::__query_compute::normalize_ty_after_erasing_regions::h25ba473c2cbb5f91\r\n  17:        0x1092d33b7 - rustc::ty::query::<impl rustc::ty::query::config::QueryAccessors<'tcx> for rustc::ty::query::queries::normalize_ty_after_erasing_regions<'tcx>>::compute::h2797662c3f7cd8ca\r\n  18:        0x108f8d9d9 - rustc::dep_graph::graph::DepGraph::with_task_impl::hb4afe1ce8de4db34\r\n  19:        0x1091ad643 - rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_get_with::hcbee305efcaa1bba\r\n  20:        0x1090ae382 - rustc::traits::query::normalize_erasing_regions::<impl rustc::ty::context::TyCtxt<'cx, 'tcx, 'tcx>>::normalize_erasing_regions::h8eed36f061225c09\r\n  21:        0x108def9dc - <rustc::ty::layout::LayoutCx<'tcx, rustc::ty::context::TyCtxt<'a, 'tcx, 'tcx>> as rustc_target::abi::LayoutOf>::layout_of::hd36f8200723655af\r\n  22:        0x1090ad061 - rustc::traits::object_safety::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'tcx>>::virtual_call_violation_for_method::{{closure}}::hd2ac69f0d9a1de87\r\n  23:        0x1090acbef - rustc::traits::object_safety::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'tcx>>::virtual_call_violation_for_method::h2a58375166f4e054\r\n  24:        0x1093d92f4 - <&mut I as core::iter::iterator::Iterator>::next::he0bf81af26a02fce\r\n  25:        0x108ecf08f - <core::iter::Filter<I, P> as core::iter::iterator::Iterator>::next::h68285655d9a4baec\r\n  26:        0x108eb1472 - <alloc::vec::Vec<T> as alloc::vec::SpecExtend<T, I>>::from_iter::h5e09d24ca7caf142\r\n  27:        0x1090aaeb9 - rustc::traits::object_safety::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'tcx>>::object_safety_violations_for_trait::h9b70c1ec6104dc4d\r\n  28:        0x108ed21d2 - <core::iter::FlatMap<I, U, F> as core::iter::iterator::Iterator>::next::he27bf259c97aab58\r\n  29:        0x108ecc432 - <alloc::vec::Vec<T> as alloc::vec::SpecExtend<T, I>>::from_iter::heff850c665c480a5\r\n  30:        0x1090aae00 - rustc::traits::object_safety::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'tcx>>::object_safety_violations::h5bb04376b4c7b528\r\n  31:        0x108eff58c - rustc::traits::object_safety::is_object_safe_provider::haa0bdc41c58ad6d1\r\n  32:        0x1092d24ce - rustc::ty::query::<impl rustc::ty::query::config::QueryAccessors<'tcx> for rustc::ty::query::queries::is_object_safe<'tcx>>::compute::h58b2e0228812b227\r\n  33:        0x108f8a3f3 - rustc::dep_graph::graph::DepGraph::with_task_impl::habb294a3f110f69f\r\n  34:        0x109173719 - rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_get_with::ha215776756165dc2\r\n  35:        0x108ee7d89 - <rustc_data_structures::obligation_forest::ObligationForest<O>>::process_obligations::h18e34c1d2183a498\r\n  36:        0x109416998 - <rustc::traits::fulfill::FulfillmentContext<'tcx> as rustc::traits::engine::TraitEngine<'tcx>>::select_where_possible::ha343b6d09c00920f\r\n  37:        0x1094167c9 - <rustc::traits::fulfill::FulfillmentContext<'tcx> as rustc::traits::engine::TraitEngine<'tcx>>::select_all_or_error::h924ffcd70a9300b1\r\n  38:        0x1077faabf - rustc_typeck::check::FnCtxt::select_all_obligations_or_error::h10c087ab0783cfa1\r\n  39:        0x10791984e - rustc::ty::context::GlobalCtxt::enter_local::hef928fdb11480ce7\r\n  40:        0x1076e0c90 - rustc_typeck::check::wfcheck::check_item_well_formed::h3aad6c12ef56eb4e\r\n  41:        0x1092d294e - rustc::ty::query::<impl rustc::ty::query::config::QueryAccessors<'tcx> for rustc::ty::query::queries::check_item_well_formed<'tcx>>::compute::ha06e4513acb77bfd\r\n  42:        0x108f6c0c9 - rustc::dep_graph::graph::DepGraph::with_task_impl::h480b354c98ca5efa\r\n  43:        0x1091dc607 - rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_get_with::hf022e8627d4138c2\r\n  44:        0x10921aebe - rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::ensure_query::hab13579af1de0c0c\r\n  45:        0x10785fe7b - rustc::session::Session::track_errors::h29dcb128525f6054\r\n  46:        0x1076d6029 - rustc::util::common::time::h005ff4051c9b56e1\r\n  47:        0x107888aa9 - rustc_typeck::check_crate::h4e459dc26a3dd042\r\n  48:        0x106dc2eb9 - <std::thread::local::LocalKey<T>>::with::h2d81d3d20e7fbeba\r\n  49:        0x106d5185f - rustc::ty::context::TyCtxt::create_and_enter::hfd77cec70a307209\r\n  50:        0x106df1e4f - rustc_driver::driver::compile_input::h0a81d2a90aae52be\r\n  51:        0x106d6251e - rustc_driver::run_compiler_with_pool::h762933062fd399ae\r\n  52:        0x106d6e2ae - <scoped_tls::ScopedKey<T>>::set::hbad459430e7ff417\r\n  53:        0x106d61488 - rustc_driver::run_compiler::ha1900917d325f169\r\n  54:        0x106d6e46b - <scoped_tls::ScopedKey<T>>::set::hf6e550156f6dc0f3\r\n  55:        0x106dcf78d - std::sys_common::backtrace::__rust_begin_short_backtrace::hb4db181f859dd41a\r\n  56:        0x10ac127ce - __rust_maybe_catch_panic\r\n  57:        0x106de662d - <F as alloc::boxed::FnBox<A>>::call_box::h54bd2886afe0d20a\r\n  58:        0x10ac1171b - std::sys::unix::thread::Thread::new::thread_start::h2ccd51efe09a6d88\r\n  59:     0x7fff7f2bb304 - _pthread_body\r\n  60:     0x7fff7f2be26e - _pthread_start\r\nquery stack during panic:\r\n#0 [normalize_ty_after_erasing_regions] normalizing `ParamEnvAnd { param_env: ParamEnv { caller_bounds: [Binder(TraitPredicate(<Self as ThriftService<F>>)), Binder(TraitPredicate(<F as Framing>)), Binder(TraitPredicate(<F as std::marker::Sized>)), Binder(ProjectionPredicate(ProjectionTy { substs: [Self], item_def_id: DefId(0/0:10 ~ type_resolution[ec0b]::Service[0]::Future[0]) }, std::boxed::Box<(dyn Future<Item=<<F as Framing>::EncBuf as BufMutExt>::Final> + 'static)>)), Binder(ProjectionPredicate(ProjectionTy { substs: [Self], item_def_id: DefId(0/0:9 ~ type_resolution[ec0b]::Service[0]::Response[0]) }, <F as Framing>::EncBuf)), Binder(TraitPredicate(<Self as Service>))], reveal: All, def_id: None }, value: &dyn ThriftService<F, Future=<Self as Service>::Future, Response=<Self as Service>::Response> }`\r\n#1 [is_object_safe] determine object safety of trait `ThriftService`\r\n#2 [check_item_well_formed] processing `with_factory`\r\nend of query stack\r\nerror: aborting due to 8 previous errors\r\n```\r\n\r\nRust Playground (stable): https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=3e221e437eac9599c6914a1b203c7ce4\r\nGodbolt (1.32.0): https://godbolt.org/z/ycFBK7  <- regression here\r\nGodbolt (1.31.0): [https://godbolt.org/z/pMryL_](https://godbolt.org/z/pMryL_)\r\n\r\nThis might be related to #56870.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/59324/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/59324/timeline", "performed_via_github_app": null, "state_reason": "completed"}