{"url": "https://api.github.com/repos/rust-lang/rust/issues/95004", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/95004/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/95004/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/95004/events", "html_url": "https://github.com/rust-lang/rust/issues/95004", "id": 1170988111, "node_id": "I_kwDOAAsO6M5Fy9xP", "number": 95004, "title": "Refactor HIR item-like traversal", "user": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 67766349, "node_id": "MDU6TGFiZWw2Nzc2NjM0OQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-mentor", "name": "E-mentor", "color": "02E10C", "default": false, "description": "Call for participation: This issue has a mentor. Use RustcContributor::new on Zulip for discussion."}, {"id": 256133344, "node_id": "MDU6TGFiZWwyNTYxMzMzNDQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-hir", "name": "A-hir", "color": "f7e101", "default": false, "description": "Area: the High level Intermediate Representation (HIR)"}, {"id": 289259951, "node_id": "MDU6TGFiZWwyODkyNTk5NTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-help-wanted", "name": "E-help-wanted", "color": "02E10C", "default": false, "description": "Call for participation: Help is requested to fix this issue."}, {"id": 419557634, "node_id": "MDU6TGFiZWw0MTk1NTc2MzQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-medium", "name": "E-medium", "color": "02e10c", "default": false, "description": "Call for participation: Experience needed to fix: Medium / intermediate"}], "state": "closed", "locked": false, "assignee": {"login": "kckeiks", "id": 24687641, "node_id": "MDQ6VXNlcjI0Njg3NjQx", "avatar_url": "https://avatars.githubusercontent.com/u/24687641?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kckeiks", "html_url": "https://github.com/kckeiks", "followers_url": "https://api.github.com/users/kckeiks/followers", "following_url": "https://api.github.com/users/kckeiks/following{/other_user}", "gists_url": "https://api.github.com/users/kckeiks/gists{/gist_id}", "starred_url": "https://api.github.com/users/kckeiks/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kckeiks/subscriptions", "organizations_url": "https://api.github.com/users/kckeiks/orgs", "repos_url": "https://api.github.com/users/kckeiks/repos", "events_url": "https://api.github.com/users/kckeiks/events{/privacy}", "received_events_url": "https://api.github.com/users/kckeiks/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "kckeiks", "id": 24687641, "node_id": "MDQ6VXNlcjI0Njg3NjQx", "avatar_url": "https://avatars.githubusercontent.com/u/24687641?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kckeiks", "html_url": "https://github.com/kckeiks", "followers_url": "https://api.github.com/users/kckeiks/followers", "following_url": "https://api.github.com/users/kckeiks/following{/other_user}", "gists_url": "https://api.github.com/users/kckeiks/gists{/gist_id}", "starred_url": "https://api.github.com/users/kckeiks/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kckeiks/subscriptions", "organizations_url": "https://api.github.com/users/kckeiks/orgs", "repos_url": "https://api.github.com/users/kckeiks/repos", "events_url": "https://api.github.com/users/kckeiks/events{/privacy}", "received_events_url": "https://api.github.com/users/kckeiks/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 3, "created_at": "2022-03-16T12:57:54Z", "updated_at": "2022-06-11T22:15:18Z", "closed_at": "2022-06-11T22:15:18Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "HIR is globally traversed using the `tcx.hir().{,par_}visit_all_item_likes{,_in_module}` family of functions. These functions create a lot of dependency edges (they call the `hir_crate` query, or call `hir_owner` for each item-like). These dependencies are not always useful: many use sites only require `item`s, and don't care for impl items, trait items or foreign items.\r\n\r\nThis can be avoided by replacing those functions by a scheme based on `ItemId`s. Actual user will be responsible for calling `tcx.hir().item` to get the HIR. The amount of access to HIR will be further reduced by pre-filtering using `tcx.def_kind` query.\r\n\r\nSteps:\r\n- [x] create a `hir_crate_items` query which traverses `tcx.hir_crate(()).owners` to collect all the ids and return a `rustc_middle::hir::ModuleItems`;\r\n- [x] use `tcx.hir_crate_items` in `tcx.hir().items` to return an iterator of `hir::ItemId`;\r\n- [ ] use `tcx.hir_crate_items` to introduce a `tcx.hir().par_items(impl Fn(hir::ItemId))` to traverse all items in parallel;\r\n- [ ] gradually replace uses of `tcx.hir().{,par_}visit_all_item_likes` with `tcx.hir().par_items` or `tcx.hir().items`;\r\n  when possible, create a fast path using `tcx.def_kind(item_id.def_id)` before calling `tcx.hir().item(item_id)`;\r\n- [ ] introduce `tcx.hir().items_in_module` and `tcx.hir().par_items_in_module` which do the same thing with `tcx.hir_module_items` instead of `tcx.hir_crate_items`;\r\n- [ ] gradually replace uses of `tcx.hir().visit_all_item_likes_in_module` with `tcx.hir().par_items_in_module` or `tcx.hir().items_in_module`;\r\n- [ ] retire `hir::ItemLikeVisitor`.\r\n\r\nThe steps starting with \"gradually\" can be split into several PRs.\r\nI am available on zulip for any question.", "closed_by": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/95004/reactions", "total_count": 4, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 4, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/95004/timeline", "performed_via_github_app": null, "state_reason": "completed"}