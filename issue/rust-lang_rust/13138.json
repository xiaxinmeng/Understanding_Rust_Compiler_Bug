{"url": "https://api.github.com/repos/rust-lang/rust/issues/13138", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/13138/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/13138/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/13138/events", "html_url": "https://github.com/rust-lang/rust/issues/13138", "id": 30163138, "node_id": "MDU6SXNzdWUzMDE2MzEzOA==", "number": 13138, "title": "macro_registrar in a private module is collected as dead code", "user": {"login": "kmcallister", "id": 444997, "node_id": "MDQ6VXNlcjQ0NDk5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/444997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kmcallister", "html_url": "https://github.com/kmcallister", "followers_url": "https://api.github.com/users/kmcallister/followers", "following_url": "https://api.github.com/users/kmcallister/following{/other_user}", "gists_url": "https://api.github.com/users/kmcallister/gists{/gist_id}", "starred_url": "https://api.github.com/users/kmcallister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kmcallister/subscriptions", "organizations_url": "https://api.github.com/users/kmcallister/orgs", "repos_url": "https://api.github.com/users/kmcallister/repos", "events_url": "https://api.github.com/users/kmcallister/events{/privacy}", "received_events_url": "https://api.github.com/users/kmcallister/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235146, "node_id": "MDU6TGFiZWwyMzUxNDY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-syntaxext", "name": "A-syntaxext", "color": "f7e101", "default": false, "description": "Area: Syntax extensions"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2014-03-25T20:55:58Z", "updated_at": "2017-01-03T17:29:43Z", "closed_at": "2017-01-03T17:29:43Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "foo_macros.rs:\n\n``` .rs\n#[crate_type=\"dylib\"];\n\n#[feature(globs, macro_rules, macro_registrar, quote)];\n\nextern crate syntax;\n\nmod bar {\n    use syntax::parse::token;\n    use syntax::ast::{Name, TokenTree};\n    use syntax::codemap::Span;\n    use syntax::ext::base::{SyntaxExtension, BasicMacroExpander, ExtCtxt, NormalTT};\n    use syntax::ext::base::{MacResult, MRExpr};\n\n    #[macro_registrar]\n    pub fn macro_registrar(register: |Name, SyntaxExtension|) {\n        register(token::intern(&\"make_a_1\"),\n            NormalTT(~BasicMacroExpander {\n                expander: expand,\n                span: None\n            },\n            None));\n    }\n\n    fn expand(cx: &mut ExtCtxt, _sp: Span, _tt: &[TokenTree]) -> MacResult {\n        MRExpr(quote_expr!(cx, 1i))\n    }\n}\n```\n\nfoo.rs:\n\n``` .rs\n#[feature(phase)];\n\n#[phase(syntax)]\nextern crate foo_macros;\n\nfn main() {\n    println!(\"Hello, {:d}!\", make_a_1!());\n}\n```\n\nResult:\n\n```\n$ rustc -v\nrustc 0.10-pre (68a4f7d 2014-02-24 12:42:02 -0800)\n\n$ rustc foo_macros.rs\nfoo_macros.rs:15:5: 22:6 warning: code is never used: `macro_registrar`, #[warn(dead_code)] on by default\n\u2026\n\nfoo_macros.rs:24:5: 26:6 warning: code is never used: `expand`, #[warn(dead_code)] on by default\n\u2026\n\n$ rustc -L. foo.rs\nfoo.rs:4:1: 4:25 error: /tmp/libfoo_macros-31eb065f-0.0.so: undefined symbol: _ZN3bar15macro_registrar20hd69499bc51cbcb55taa4v0.0E\nfoo.rs:4 extern crate foo_macros;\n```\n\nHere it's pretty obvious what's going on, but it was more confusing when the module was in a separate file, and I didn't get a dead code warning for whatever reason.\n\nThe symbol does exist in the `.so`, but it's marked as having local linkage.  Changing to `pub mod bar` makes it global and everything works.\n", "closed_by": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/13138/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/13138/timeline", "performed_via_github_app": null, "state_reason": "completed"}