{"url": "https://api.github.com/repos/rust-lang/rust/issues/11683", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/11683/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/11683/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/11683/events", "html_url": "https://github.com/rust-lang/rust/issues/11683", "id": 25908721, "node_id": "MDU6SXNzdWUyNTkwODcyMQ==", "number": 11683, "title": "Fatal runtime error and illegal instruction when compiling with LTO", "user": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2014-01-20T10:03:09Z", "updated_at": "2014-01-22T10:06:21Z", "closed_at": "2014-01-22T10:06:21Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "After reading http://thornydev.blogspot.co.uk/2014/01/chinese-whispers-in-rust.html I tried to compile the example code with -Z lto. The resulting binary crashes with a fatal runtime error.\n\nCode:\n\n``` rust\nstatic N:int = 100000;\n\n//\n// Chinese Whispers in Rust\n// Based on example by Rob Pike\n// in http://www.youtube.com/watch?v=f6kdp27TYZs\n//\nfn main() {\n    let (leftmost_port, leftmost_chan) = Chan::new();\n    let mut leftc: Chan<int> = leftmost_chan;\n    let mut rightp: Port<int>;\n\n    for _ in range(0, N) {\n        let (right_port, right_chan) = Chan::new();\n        rightp = right_port;\n        let c = leftc;\n        let p = rightp;\n        do spawn {\n            whisper(c, p);\n        }\n        leftc = right_chan;\n    }\n    let rightmost_chan = leftc;\n    do spawn {\n        rightmost_chan.send(1);\n    }\n    println!(\"{}\", leftmost_port.recv());\n}\n\nfn whisper(left: Chan<int>, right: Port<int>) {\n    left.send( right.recv() + 1 );\n}\n```\n\nOutput without LTO:\n\n```\n$ ./chinese \n100001\n```\n\nOutput with LTO:\n\n```\n$ ./chinese \n\n\n\nThere are not many persons who know what wonders are opened to them in the\nstories and visions of their youth; for when as children we listen and dream,\nwe think but half-formed thoughts, and when as men we try to remember, we are\ndulled and prosaic with the poison of life. But some of us awake in the night\nwith strange phantasms of enchanted hills and gardens, of fountains that sing\nin the sun, of golden cliffs overhanging murmuring seas, of plains that stretch\ndown to sleeping cities of bronze and stone, and of shadowy companies of heroes\nthat ride caparisoned white horses along the edges of thick forests; and then\nwe know that we have looked back through the ivory gates into that world of\nwonder which was ours before we were wise and unhappy.\n\nfatal runtime error:  assertion failed: !ptr.is_null()\nIllegal instruction\n```\n\nSometimes the error message is printed more than once.\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/11683/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/11683/timeline", "performed_via_github_app": null, "state_reason": "completed"}