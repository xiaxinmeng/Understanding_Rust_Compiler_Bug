{"url": "https://api.github.com/repos/rust-lang/rust/issues/87425", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/87425/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/87425/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/87425/events", "html_url": "https://github.com/rust-lang/rust/issues/87425", "id": 952059416, "node_id": "MDU6SXNzdWU5NTIwNTk0MTY=", "number": 87425, "title": "`implementation of Debug is not general enough` when making async block into `&dyn Future  + Send`", "user": {"login": "Veetaha", "id": 36276403, "node_id": "MDQ6VXNlcjM2Mjc2NDAz", "avatar_url": "https://avatars.githubusercontent.com/u/36276403?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veetaha", "html_url": "https://github.com/Veetaha", "followers_url": "https://api.github.com/users/Veetaha/followers", "following_url": "https://api.github.com/users/Veetaha/following{/other_user}", "gists_url": "https://api.github.com/users/Veetaha/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veetaha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veetaha/subscriptions", "organizations_url": "https://api.github.com/users/Veetaha/orgs", "repos_url": "https://api.github.com/users/Veetaha/repos", "events_url": "https://api.github.com/users/Veetaha/events{/privacy}", "received_events_url": "https://api.github.com/users/Veetaha/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2021-07-24T11:48:04Z", "updated_at": "2021-07-24T11:49:29Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried this code:\r\n\r\n```rust\r\nuse std::{any::Any, fmt, future::Future};\r\n\r\npub trait Foo {\r\n    type Item;\r\n}\r\n\r\nimpl<F, I> Foo for F\r\nwhere\r\n    Self: FnOnce() -> I,\r\n    I: fmt::Debug,\r\n{\r\n    type Item = I;\r\n}\r\n\r\nasync fn foo_item<F: Foo>(_: F) -> F::Item {\r\n    unimplemented!()\r\n}\r\n\r\npub fn foo() {\r\n    let fut = async {\r\n        let callback = || -> Box<dyn Any> { unimplemented!() };\r\n\r\n        // Using plain fn instead of a closure fixes the error, \r\n        // though you obviously can't capture any state...\r\n        // fn callback() -> Box<dyn Any> {\r\n        //     todo!()\r\n        // }\r\n\r\n        foo_item(callback).await;\r\n    };\r\n\r\n    // Removing `+ Send` bound also fixes the error,\r\n    // though at the cost of loosing `Send`ability...\r\n    let fut: &(dyn Future<Output = ()> + Send) = &fut as _;\r\n}\r\n\r\n```\r\n\r\n[Link to playground](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=575b4cb3dfe4136ff5b3388661b96c81)\r\n\r\nI expected to see this compile.\r\n\r\nInstead, this happened:\r\n\r\nI've hit the \"implementation of `Debug` is not general enough\" when trying to make the async block into a trait object with `Send` bound.\r\n\r\n<details>\r\n<summary>Compile error output</summary>\r\n\r\n```\r\n   Compiling playground v0.0.1 (/playground)\r\nerror: implementation of `Debug` is not general enough\r\n  --> src/lib.rs:34:50\r\n   |\r\n34 |     let fut: &(dyn Future<Output = ()> + Send) = &fut as _;\r\n   |                                                  ^^^^ implementation of `Debug` is not general enough\r\n   |\r\n   = note: `(dyn Any + '0)` must implement `Debug`, for any lifetime `'0`...\r\n   = note: ...but `Debug` is actually implemented for the type `(dyn Any + 'static)`\r\n```\r\n\r\n</details>\r\n\r\nOne interesting detail is that this works only with closure syntax, if you use vanilla `fn`, then there is no error, also removing `+ Send` bound on the resulting trait object removes the error.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.53.0 (53cb7b09b 2021-06-17)\r\nbinary: rustc\r\ncommit-hash: 53cb7b09b00cbea8754ffb78e7e3cb521cb8af4b\r\ncommit-date: 2021-06-17\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.53.0\r\nLLVM version: 12.0.1\r\n```\r\n\r\nThis is also reproducible in playground with `beta` and `nightly` channels:\r\n- `1.54.0-beta.3 (2021-07-20 3a5d335d1192975c94fc)`\r\n- `1.55.0-nightly (2021-07-22 027187094ee05011d660)`\r\n\r\n\r\nSorry, I couldn't come up with a more descriptive issue name, if anyone can improve it, I'd be grateful for your edits.\r\n\r\nPotentially related issues:\r\n- https://github.com/rust-lang/rust/issues/71723\r\n- https://github.com/rust-lang/rust/issues/60658", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/87425/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/87425/timeline", "performed_via_github_app": null, "state_reason": null}