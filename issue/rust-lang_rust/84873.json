{"url": "https://api.github.com/repos/rust-lang/rust/issues/84873", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/84873/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/84873/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/84873/events", "html_url": "https://github.com/rust-lang/rust/issues/84873", "id": 874773637, "node_id": "MDU6SXNzdWU4NzQ3NzM2Mzc=", "number": 84873, "title": "Compile time+memory regression between 1.49.0 and 1.50.0", "user": {"login": "olix0r", "id": 240738, "node_id": "MDQ6VXNlcjI0MDczOA==", "avatar_url": "https://avatars.githubusercontent.com/u/240738?v=4", "gravatar_id": "", "url": "https://api.github.com/users/olix0r", "html_url": "https://github.com/olix0r", "followers_url": "https://api.github.com/users/olix0r/followers", "following_url": "https://api.github.com/users/olix0r/following{/other_user}", "gists_url": "https://api.github.com/users/olix0r/gists{/gist_id}", "starred_url": "https://api.github.com/users/olix0r/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/olix0r/subscriptions", "organizations_url": "https://api.github.com/users/olix0r/orgs", "repos_url": "https://api.github.com/users/olix0r/repos", "events_url": "https://api.github.com/users/olix0r/events{/privacy}", "received_events_url": "https://api.github.com/users/olix0r/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 64037154, "node_id": "MDU6TGFiZWw2NDAzNzE1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compiletime", "name": "I-compiletime", "color": "e11d21", "default": false, "description": "Problems and improvements with respect to compile times."}, {"id": 203429200, "node_id": "MDU6TGFiZWwyMDM0MjkyMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-high", "name": "P-high", "color": "eb6420", "default": false, "description": "High priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 630799571, "node_id": "MDU6TGFiZWw2MzA3OTk1NzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compilemem", "name": "I-compilemem", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to memory usage during compilation."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 20, "created_at": "2021-05-03T17:45:24Z", "updated_at": "2022-11-19T23:59:02Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "Our compile times and memory footprint regressed substantially between Rust 1.49.0 and 1.50.0.\r\n\r\nThis regression is a hard blocker for us to be able to upgrade our project from 1.49.0. As this is a severe issue for us, please let us know if there's anything we can do to provide more diagnostics, test changes, etc.\r\n\r\nThis may be related to other recent issues that describe similar behavior:\r\n\r\n* https://github.com/rust-lang/rust/issues/82406\r\n* https://github.com/rust-lang/rust/issues/83911\r\n\r\n### Code\r\n\r\nThis regression is observed on recent versions of the [Linkerd proxy](https://github.com/linkerd/linkerd2-proxy/tree/bba24dcdeda40105615db8d33e3fa04f980cf128). It's known that the proxy can manifest large type signatures, so builds [disable debug symbols by default](https://github.com/linkerd/linkerd2-proxy/blob/bba24dcdeda40105615db8d33e3fa04f980cf128/Cargo.toml#L57-L62)\r\n\r\nThis regression is not obvious with other, smaller projects that we maintain, so I'm unable to provide a smaller repro.\r\n\r\n### Version it worked on\r\n\r\nWith Rust 1.49.0, the binary compiles in a little over two minutes, using a little over 1GB of memory:\r\n\r\n`cargo clean && /usr/bin/time -v cargo +1.49.0 build -p linkerd2-proxy`\r\n```\r\n...\r\n    Finished dev [unoptimized] target(s) in 2m 12s\r\n        Command being timed: \"cargo +1.49.0 build -p linkerd2-proxy\"\r\n        User time (seconds): 326.00\r\n        System time (seconds): 14.55\r\n        Percent of CPU this job got: 256%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 2:12.78\r\n...\r\n        Maximum resident set size (kbytes): 1308088\r\n...\r\n        Exit status: 0\r\n```\r\n\r\n### Version with regression\r\n\r\nUsing Rust 1.50.0, rustc runs for about 40 minutes before exhausting the system's memory:\r\n\r\n`cargo clean && /usr/bin/time -v cargo +1.50.0 build -p linkerd2-proxy`\r\n```\r\n  process didn't exit successfully: `rustc --crate-name linkerd2_proxy --edition=2018 linkerd2-proxy/src/main.rs --error-format=json --json=diagnostic-rendered-ansi --crate-type bin --emit=dep-info,link -C embed-bitcode=no --cfg 'feature=\"default\"' --cfg 'feature=\"multicore\"' --cfg 'feature=\"num_cpus\"' -C metadata=c2caa01c24c285f7 -C extra-filename=-c2caa01c24c285f7 --out-dir /home/ver/b/linkerd2-proxy/target/debug/deps -C incremental=/home/ver/b/linkerd2-proxy/target/debug/incremental -L dependency=/home/ver/b/linkerd2-proxy/target/debug/deps --extern futures=/home/ver/b/linkerd2-proxy/target/debug/deps/libfutures-01f6240a9e4201d3.rlib --extern linkerd_app=/home/ver/b/linkerd2-proxy/target/debug/deps/liblinkerd_app-dd18fcabeef913ae.rlib --extern linkerd_signal=/home/ver/b/linkerd2-proxy/target/debug/deps/liblinkerd_signal-14263c92fcb0fc0b.rlib --extern num_cpus=/home/ver/b/linkerd2-proxy/target/debug/deps/libnum_cpus-74ee144d51bc047e.rlib --extern tokio=/home/ver/b/linkerd2-proxy/target/debug/deps/libtokio-de277ade05efd960.rlib --extern tracing=/home/ver/b/linkerd2-proxy/target/debug/deps/libtracing-03fd6826b817dabe.rlib -L native=/home/ver/b/linkerd2-proxy/target/debug/build/ring-a8b802a4aa425398/out` (signal: 9, SIGKILL: kill)\r\nCommand exited with non-zero status 101\r\n\tCommand being timed: \"cargo +1.50.0 build -p linkerd2-proxy\"\r\n\tUser time (seconds): 2986.18\r\n\tSystem time (seconds): 101.73\r\n\tPercent of CPU this job got: 133%\r\n\tElapsed (wall clock) time (h:mm:ss or m:ss): 38:29.28\r\n...\r\n\tMaximum resident set size (kbytes): 62953524\r\n...\r\n\tExit status: 101\r\n```\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.50.0 (cb75ad5db 2021-02-10)\r\nbinary: rustc\r\ncommit-hash: cb75ad5db02783e8b0222fee363c5f63f7e2cf5b\r\ncommit-date: 2021-02-10\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.50.0\r\n```\r\n\r\nWe see similar behavior with more recent versions of Rust as well, including 1.51.0 and nightly (`cargo 1.53.0-nightly (0ed318d18 2021-04-23)`) as well.\r\n\r\ncc @hawkw, who can provide some more details. I believe we've tested with `lto=off` without any changes in behavior.\r\n\r\n@rustbot modify labels: +regression-from-stable-to-stable -regression-untriaged\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/84873/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/84873/timeline", "performed_via_github_app": null, "state_reason": null}