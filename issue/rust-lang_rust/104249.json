{"url": "https://api.github.com/repos/rust-lang/rust/issues/104249", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/104249/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/104249/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/104249/events", "html_url": "https://github.com/rust-lang/rust/issues/104249", "id": 1444314464, "node_id": "I_kwDOAAsO6M5WFn1g", "number": 104249, "title": "Privacy assertion failure with `staged_api` and duplicated module name", "user": {"login": "jruderman", "id": 692547, "node_id": "MDQ6VXNlcjY5MjU0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/692547?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jruderman", "html_url": "https://github.com/jruderman", "followers_url": "https://api.github.com/users/jruderman/followers", "following_url": "https://api.github.com/users/jruderman/following{/other_user}", "gists_url": "https://api.github.com/users/jruderman/gists{/gist_id}", "starred_url": "https://api.github.com/users/jruderman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jruderman/subscriptions", "organizations_url": "https://api.github.com/users/jruderman/orgs", "repos_url": "https://api.github.com/users/jruderman/repos", "events_url": "https://api.github.com/users/jruderman/events{/privacy}", "received_events_url": "https://api.github.com/users/jruderman/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}], "state": "closed", "locked": false, "assignee": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2022-11-10T17:44:02Z", "updated_at": "2022-11-29T11:48:03Z", "closed_at": "2022-11-25T09:17:29Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Found with a [modified fuzz-rustc](https://github.com/jruderman/fuzz-rustc).\r\n\r\n### Code\r\n\r\n```Rust\r\n#![feature(staged_api)]\r\npub mod a {\r\n}\r\npub mod a {\r\n    pub mod b {\r\n    }\r\n}\r\nfn main(){}\r\n```\r\n\r\n<details><summary>Alternative input with stability attributes</summary>\r\n\r\n```rust\r\n#![feature(staged_api)]\r\n#![stable(feature = \"foo\", since = \"1.0\")]\r\n\r\n#[stable(feature = \"foo\", since = \"1.0\")]\r\npub mod a {\r\n}\r\n#[stable(feature = \"foo\", since = \"1.0\")]\r\npub mod a {\r\n    #[stable(feature = \"foo\", since = \"1.0\")]\r\n    pub mod b {\r\n    }\r\n}\r\nfn main(){}\r\n```\r\n\r\n</details>\r\n\r\n### Error output with debug assertions\r\n\r\n```\r\nerror[E0428]: the name `a` is defined multiple times\r\nerror: internal compiler error: compiler/rustc_middle/src/middle/privacy.rs:171:17: private Restricted(DefId(0:4 ~ perr_n[96e5]::a#1)) > direct Restricted(DefId(0:5 ~ perr_n[96e5]::a#1::b))\r\n```\r\n\r\n<details><summary>Full output including backtrace</summary>\r\n\r\n```\r\nerror[E0428]: the name `a` is defined multiple times\r\n --> perr-n.rs:4:1\r\n  |\r\n2 | pub mod a {\r\n  | --------- previous definition of the module `a` here\r\n3 | }\r\n4 | pub mod a {\r\n  | ^^^^^^^^^ `a` redefined here\r\n  |\r\n  = note: `a` must be defined only once in the type namespace of this module\r\n\r\nerror: internal compiler error: compiler/rustc_middle/src/middle/privacy.rs:171:17: private Restricted(DefId(0:4 ~ perr_n[96e5]::a#1)) > direct Restricted(DefId(0:5 ~ perr_n[96e5]::a#1::b))\r\n --> perr-n.rs:5:5\r\n  |\r\n5 |     pub mod b {\r\n  |     ^^^^^^^^^\r\n\r\nthread 'rustc' panicked at 'Box<dyn Any>', /Users/jruderman/code/rust/compiler/rustc_errors/src/lib.rs:967:33\r\nstack backtrace:\r\n   0:        0x105f67b51 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::hca7435eb862ff36c\r\n   1:        0x106004448 - core::fmt::write::hda6b0e10b55724fb\r\n   2:        0x105f655c8 - std::io::Write::write_fmt::ha9d830225ddca362\r\n   3:        0x105f67942 - std::sys_common::backtrace::print::h1790e63dbe903794\r\n   4:        0x105f91355 - std::panicking::default_hook::{{closure}}::h43af9d0e518d235f\r\n   5:        0x105f91137 - std::panicking::default_hook::h66fe7c7e4fb98f6f\r\n   6:        0x117a99198 - rustc_driver[34272412877c8d7e]::DEFAULT_HOOK::{closure#0}::{closure#0}\r\n   7:        0x105f91a16 - std::panicking::rust_panic_with_hook::h3f2771d8587a6225\r\n   8:        0x11c6f9527 - std[8f57673cc279a434]::panicking::begin_panic::<rustc_errors[baeb4f2523d336bf]::ExplicitBug>::{closure#0}\r\n   9:        0x11c6f9499 - std[8f57673cc279a434]::sys_common::backtrace::__rust_end_short_backtrace::<std[8f57673cc279a434]::panicking::begin_panic<rustc_errors[baeb4f2523d336bf]::ExplicitBug>::{closure#0}, !>\r\n  10:        0x11ccf11a9 - std[8f57673cc279a434]::panicking::begin_panic::<rustc_errors[baeb4f2523d336bf]::ExplicitBug>\r\n  11:        0x11c708769 - std[8f57673cc279a434]::panic::panic_any::<rustc_errors[baeb4f2523d336bf]::ExplicitBug>\r\n  12:        0x11c7086e8 - <rustc_errors[baeb4f2523d336bf]::HandlerInner>::span_bug::<rustc_span[fb729f1b9e5ac969]::span_encoding::Span, &alloc[9c4954bf8315fe26]::string::String>\r\n  13:        0x11c7084f4 - <rustc_errors[baeb4f2523d336bf]::Handler>::span_bug::<rustc_span[fb729f1b9e5ac969]::span_encoding::Span, &alloc[9c4954bf8315fe26]::string::String>\r\n  14:        0x11c79c7d1 - rustc_middle[6f25fe7037d6027b]::ty::context::tls::with_opt::<rustc_middle[6f25fe7037d6027b]::util::bug::opt_span_bug_fmt<rustc_span[fb729f1b9e5ac969]::span_encoding::Span>::{closure#0}, ()>\r\n  15:        0x11c79c841 - rustc_middle[6f25fe7037d6027b]::util::bug::opt_span_bug_fmt::<rustc_span[fb729f1b9e5ac969]::span_encoding::Span>\r\n  16:        0x11cd0285f - rustc_middle[6f25fe7037d6027b]::util::bug::span_bug_fmt::<rustc_span[fb729f1b9e5ac969]::span_encoding::Span>\r\n  17:        0x11c7b780b - <rustc_middle[6f25fe7037d6027b]::middle::privacy::EffectiveVisibilities>::check_invariants\r\n  18:        0x11a5307d5 - rustc_privacy[d2e26e0ea95905a7]::effective_visibilities\r\n  19:        0x11b7be7b0 - rustc_query_system[840d768d15d12085]::query::plumbing::try_execute_query::<rustc_query_impl[c109d582984dd181]::plumbing::QueryCtxt, rustc_query_system[840d768d15d12085]::query::caches::DefaultCache<(), &rustc_middle[6f25fe7037d6027b]::middle::privacy::EffectiveVisibilities>>\r\n  20:        0x11b868c29 - rustc_query_system[840d768d15d12085]::query::plumbing::get_query::<rustc_query_impl[c109d582984dd181]::queries::effective_visibilities, rustc_query_impl[c109d582984dd181]::plumbing::QueryCtxt>\r\n  21:        0x11b593027 - <rustc_query_impl[c109d582984dd181]::Queries as rustc_middle[6f25fe7037d6027b]::ty::query::QueryEngine>::effective_visibilities\r\n  22:        0x11ad6fbe6 - rustc_passes[467a399e7fc15c73]::stability::check_unused_or_stable_features\r\n  23:        0x117be16a7 - <rustc_session[c16dc8859e010203]::session::Session>::time::<(), rustc_interface[e9616f531c09701b]::passes::analysis::{closure#0}::{closure#2}::{closure#0}>\r\n  24:        0x117bfa508 - std[8f57673cc279a434]::panicking::try::<(), core[63810368375d8c35]::panic::unwind_safe::AssertUnwindSafe<rustc_interface[e9616f531c09701b]::passes::analysis::{closure#0}::{closure#2}>>\r\n  25:        0x117be205c - <rustc_session[c16dc8859e010203]::session::Session>::time::<(), rustc_interface[e9616f531c09701b]::passes::analysis::{closure#0}>\r\n  26:        0x117b9a311 - rustc_interface[e9616f531c09701b]::passes::analysis\r\n  27:        0x11b7b61ed - rustc_query_system[840d768d15d12085]::query::plumbing::try_execute_query::<rustc_query_impl[c109d582984dd181]::plumbing::QueryCtxt, rustc_query_system[840d768d15d12085]::query::caches::DefaultCache<(), core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>>>\r\n  28:        0x11b8965d9 - rustc_query_system[840d768d15d12085]::query::plumbing::get_query::<rustc_query_impl[c109d582984dd181]::queries::analysis, rustc_query_impl[c109d582984dd181]::plumbing::QueryCtxt>\r\n  29:        0x11b5647d7 - <rustc_query_impl[c109d582984dd181]::Queries as rustc_middle[6f25fe7037d6027b]::ty::query::QueryEngine>::analysis\r\n  30:        0x117b173f8 - <rustc_interface[e9616f531c09701b]::passes::QueryContext>::enter::<rustc_driver[34272412877c8d7e]::run_compiler::{closure#1}::{closure#2}::{closure#3}, core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>>\r\n  31:        0x117b01308 - <rustc_interface[e9616f531c09701b]::interface::Compiler>::enter::<rustc_driver[34272412877c8d7e]::run_compiler::{closure#1}::{closure#2}, core[63810368375d8c35]::result::Result<core[63810368375d8c35]::option::Option<rustc_interface[e9616f531c09701b]::queries::Linker>, rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>>\r\n  32:        0x117a8729b - rustc_span[fb729f1b9e5ac969]::with_source_map::<core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>, rustc_interface[e9616f531c09701b]::interface::run_compiler<core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>, rustc_driver[34272412877c8d7e]::run_compiler::{closure#1}>::{closure#0}::{closure#1}>\r\n  33:        0x117b0279a - <scoped_tls[a4e3500caacc884c]::ScopedKey<rustc_span[fb729f1b9e5ac969]::SessionGlobals>>::set::<rustc_interface[e9616f531c09701b]::interface::run_compiler<core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>, rustc_driver[34272412877c8d7e]::run_compiler::{closure#1}>::{closure#0}, core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>>\r\n  34:        0x117b065e0 - std[8f57673cc279a434]::sys_common::backtrace::__rust_begin_short_backtrace::<rustc_interface[e9616f531c09701b]::util::run_in_thread_pool_with_globals<rustc_interface[e9616f531c09701b]::interface::run_compiler<core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>, rustc_driver[34272412877c8d7e]::run_compiler::{closure#1}>::{closure#0}, core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>>::{closure#0}::{closure#0}, core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>>\r\n  35:        0x117aea94d - std[8f57673cc279a434]::panicking::try::<core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>, core[63810368375d8c35]::panic::unwind_safe::AssertUnwindSafe<<std[8f57673cc279a434]::thread::Builder>::spawn_unchecked_<rustc_interface[e9616f531c09701b]::util::run_in_thread_pool_with_globals<rustc_interface[e9616f531c09701b]::interface::run_compiler<core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>, rustc_driver[34272412877c8d7e]::run_compiler::{closure#1}>::{closure#0}, core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>>::{closure#0}::{closure#0}, core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>>::{closure#1}::{closure#0}>>\r\n  36:        0x117a91b80 - <<std[8f57673cc279a434]::thread::Builder>::spawn_unchecked_<rustc_interface[e9616f531c09701b]::util::run_in_thread_pool_with_globals<rustc_interface[e9616f531c09701b]::interface::run_compiler<core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>, rustc_driver[34272412877c8d7e]::run_compiler::{closure#1}>::{closure#0}, core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>>::{closure#0}::{closure#0}, core[63810368375d8c35]::result::Result<(), rustc_errors[baeb4f2523d336bf]::ErrorGuaranteed>>::{closure#1} as core[63810368375d8c35]::ops::function::FnOnce<()>>::call_once::{shim:vtable#0}\r\n  37:        0x105f992eb - <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once::h3d6d78cd5f090dbf\r\n  38:        0x105fa0eef - std::sys::unix::thread::Thread::new::thread_start::h54ce6bb2ca11d46f\r\n  39:     0x7ff80d84d4e1 - __pthread_start\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&template=ice.md\r\n\r\nnote: rustc 1.67.0-dev running on x86_64-apple-darwin\r\n\r\nquery stack during panic:\r\n#0 [effective_visibilities] checking effective visibilities\r\n#1 [analysis] running analysis passes on this crate\r\nend of query stack\r\nerror: aborting due to 2 previous errors\r\n\r\nFor more information about this error, try `rustc --explain E0428`.\r\n```\r\n\r\n</details>\r\n\r\n### Regression\r\n\r\nThis is a new assertion, added in 448261a78a35026b3f5e855b705f35c916ecb19b of #103965 (@petrochenkov). I don't know whether this indicates a pre-existing bug.\r\n\r\n### Version\r\n\r\nBuilt stage1 on `x86_64-apple-darwin` at revision 01a6f30324deb8f9c9ec4a70c53690c5d073a244 with `debug-assertions = true`", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/104249/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/104249/timeline", "performed_via_github_app": null, "state_reason": "completed"}