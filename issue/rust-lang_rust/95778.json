{"url": "https://api.github.com/repos/rust-lang/rust/issues/95778", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/95778/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/95778/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/95778/events", "html_url": "https://github.com/rust-lang/rust/issues/95778", "id": 1196469660, "node_id": "I_kwDOAAsO6M5HUK2c", "number": 95778, "title": "Odd macro diagnostic \"no rules expected the token ``\" with empty vis fragment capture", "user": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 132910982, "node_id": "MDU6TGFiZWwxMzI5MTA5ODI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-macros", "name": "A-macros", "color": "f7e101", "default": false, "description": "Area: All kinds of macros (custom derive, macro_rules!, proc macros, ..)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 1596122130, "node_id": "MDU6TGFiZWwxNTk2MTIyMTMw", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-papercut", "name": "D-papercut", "color": "c9f7a3", "default": false, "description": "Diagnostic error that needs small tweaks"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-04-07T19:17:14Z", "updated_at": "2022-04-08T19:29:11Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "When capturing an empty token sequence with a `vis` fragment and failing to further match this capture in following macro invocations rustc emits the `no rules expected the token \\`\\`` message which is confusing given the lack of a token in the error.\r\n\r\nGiven the following code: https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=a6a7515732cc426c68cc418b25b4ed92\r\n\r\n```rust\r\nmacro_rules! makro {\r\n    (()) => {};\r\n    ($vis:vis ,) => {\r\n        makro!(($vis));\r\n    };\r\n}\r\nmakro!(,);\r\n```\r\n\r\nThe current output is:\r\n\r\n```\r\nerror: no rules expected the token ``\r\n --> src/lib.rs:4:17\r\n  |\r\n1 | macro_rules! makro {\r\n  | ------------------ when calling this macro\r\n...\r\n4 |         makro!(($vis));\r\n  |                 ^^^^ no rules expected this token in macro call\r\n...\r\n7 | makro!(,);\r\n  | --------- in this macro invocation\r\n  |\r\n  = note: this error originates in the macro `makro` (in Nightly builds, run with -Z macro-backtrace for more info)\r\n\r\nerror: could not compile `playground` due to previous error\r\n```\r\n\r\nThe error is obviously legitimate, the fragment captures nothing but still gets turned into an opaque thing even though it is empty, which then fails to match any of the macro arms in the recursive calls.\r\n\r\nThe diagnostics weren't written with the possibility of an empty non-repetition capture in mind though, so the error message becomes rather weird in this one scenario.\r\n\r\nI am not sure how to improve on the message here though.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/95778/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/95778/timeline", "performed_via_github_app": null, "state_reason": null}