{"url": "https://api.github.com/repos/rust-lang/rust/issues/54749", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/54749/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/54749/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/54749/events", "html_url": "https://github.com/rust-lang/rust/issues/54749", "id": 365864642, "node_id": "MDU6SXNzdWUzNjU4NjQ2NDI=", "number": 54749, "title": "Is this safe behaviour?", "user": {"login": "faulesocke", "id": 3109602, "node_id": "MDQ6VXNlcjMxMDk2MDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3109602?v=4", "gravatar_id": "", "url": "https://api.github.com/users/faulesocke", "html_url": "https://github.com/faulesocke", "followers_url": "https://api.github.com/users/faulesocke/followers", "following_url": "https://api.github.com/users/faulesocke/following{/other_user}", "gists_url": "https://api.github.com/users/faulesocke/gists{/gist_id}", "starred_url": "https://api.github.com/users/faulesocke/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/faulesocke/subscriptions", "organizations_url": "https://api.github.com/users/faulesocke/orgs", "repos_url": "https://api.github.com/users/faulesocke/repos", "events_url": "https://api.github.com/users/faulesocke/events{/privacy}", "received_events_url": "https://api.github.com/users/faulesocke/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-10-02T12:01:29Z", "updated_at": "2018-10-02T16:07:19Z", "closed_at": "2018-10-02T16:07:19Z", "author_association": "NONE", "active_lock_reason": null, "body": "```rust\r\nstruct Refed;\r\n\r\nimpl Drop for Refed {\r\n    fn drop(&mut self) {\r\n        println!(\"Dropping!\");\r\n    }\r\n}\r\n\r\nstruct Ref<'a>(&'a mut Val, Refed);\r\n\r\n/*impl<'a> Drop for Ref<'a> {\r\n    fn drop(&mut self) {\r\n        println!(\"Dropping!\");\r\n    }\r\n}*/\r\n\r\n#[derive(Debug)]\r\nstruct Val;\r\n\r\nimpl Val {\r\n    fn reference(&mut self) -> Ref {\r\n        Ref(self, Refed)\r\n    }\r\n}\r\n\r\nfn main() {\r\n    let mut v = Val;\r\n    println!(\"First reference\");\r\n    let r1 = v.reference();\r\n    println!(\"Second reference\");\r\n    let r2 = v.reference();\r\n    println!(\"Done\");\r\n\r\n    //println!(\"{:?}\", r1.0);\r\n}\r\n```\r\n\r\nIt looks like two mutable references to the same object are in scope at the same time.\r\n\r\nThe behaviour is \"fixed\" when I uncomment the Drop implementation for Ref. Accessing the first reference after the second is in scope seems to be impossible as well (uncomment println).\r\n\r\nHowever the behaviour feels a little bit whacky, is this really intentional?\r\n\r\nI'm currently writing a safe wrapper around memory mapped files and was using a struct similar to the Ref above in order to statically prevent having multiple mappings for the same file in scope at the same time.\r\n\r\nI wanted to make sure, that only one such mapping can exist at the same time (because memory needs to be flushed which happens in the drop() of the mapping before another mapping can be created) but it seems like Rust's type system does not prevent this.", "closed_by": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/54749/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/54749/timeline", "performed_via_github_app": null, "state_reason": "completed"}