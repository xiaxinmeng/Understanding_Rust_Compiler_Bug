{"url": "https://api.github.com/repos/rust-lang/rust/issues/31529", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/31529/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/31529/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/31529/events", "html_url": "https://github.com/rust-lang/rust/issues/31529", "id": 132596759, "node_id": "MDU6SXNzdWUxMzI1OTY3NTk=", "number": 31529, "title": "tests.mk/runtest.rs splits RUSTFLAGS/host_rustcflags,target_rustcflags inappropriately", "user": {"login": "infinity0", "id": 78398, "node_id": "MDQ6VXNlcjc4Mzk4", "avatar_url": "https://avatars.githubusercontent.com/u/78398?v=4", "gravatar_id": "", "url": "https://api.github.com/users/infinity0", "html_url": "https://github.com/infinity0", "followers_url": "https://api.github.com/users/infinity0/followers", "following_url": "https://api.github.com/users/infinity0/following{/other_user}", "gists_url": "https://api.github.com/users/infinity0/gists{/gist_id}", "starred_url": "https://api.github.com/users/infinity0/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/infinity0/subscriptions", "organizations_url": "https://api.github.com/users/infinity0/orgs", "repos_url": "https://api.github.com/users/infinity0/repos", "events_url": "https://api.github.com/users/infinity0/events{/privacy}", "received_events_url": "https://api.github.com/users/infinity0/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2016-02-10T03:12:00Z", "updated_at": "2017-02-11T00:26:01Z", "closed_at": "2017-02-11T00:26:01Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "edit: **TL;DR:** tests.mk and runtest.rs respectively split `RUSTFLAGS` and `{host,target}_rustcflags` inappropriately; reproduce this in rust upstream (1.8 and earlier) by:\n- test.mk bug: set `RUSTFLAGS=\"-C link-args=\\\"-Wl,-Bsymbolic-functions -Wl,-z,relro\\\"\"` when building tests\n- runtest.rs bug: set `RUSTFLAGS=\"-C link-args='-Wl,-Bsymbolic-functions -Wl,-z,relro'\"` when running tests.\n\n**These are two separate and independent bugs.**\n\n---\n\nHi, I'm having a hard time debugging a build failure and was wondering if anyone could help. We have multiple identical build failures for Ubuntu across different versions of rustc e.g. see [1.5 on amd64-xenial](https://launchpadlibrarian.net/232314146/buildlog_ubuntu-xenial-amd64.rustc_1.5.0+dfsg1-1_BUILDING.txt.gz), [1.8-nightly-20160209 on i386-xenial](https://launchpadlibrarian.net/237257461/buildlog_ubuntu-xenial-i386.rustc_1.8.0~~nightly.20160209+dfsg1-1_BUILDING.txt.gz), [1.8-nightly-20160209 on amd64-xenial](https://launchpadlibrarian.net/237383512/buildlog_ubuntu-xenial-amd64.rustc_1.8.0~~nightly.20160209+dfsg1-1_BUILDING.txt.gz). The packages are based on the [working](https://buildd.debian.org/status/package.php?p=rustc) Debian packages.\n\nThe failure looks related to the command line being run; however they are very similar on Debian and Ubuntu (newlines manually inserted for clarity):\n\n```\n--- debian (from my local testing)\n+++ ubuntu (from the 1.8 amd64-xenial link above)\n@@ -1,41 +1,41 @@\n LD_LIBRARY_PATH=\n  /\u00abBUILDDIR\u00bb/rustc-1.8.0~~nightly.20160209+dfsg1/x86_64-unknown-linux-gnu/stage2/lib:\n  /usr/lib/llvm-3.7/lib:\n  $LD_LIBRARY_PATH\n x86_64-unknown-linux-gnu/stage2/bin/compiletest\n  --compile-lib-path x86_64-unknown-linux-gnu/stage2/lib\n  --run-lib-path x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/lib\n  --rustc-path x86_64-unknown-linux-gnu/stage2/bin/rustc\n  --rustdoc-path x86_64-unknown-linux-gnu/stage2/bin/rustdoc\n  --llvm-bin-path /usr/lib/llvm-3.7/bin\n  --aux-base /\u00abBUILDDIR\u00bb/rustc-1.8.0~~nightly.20160209+dfsg1/src/test/auxiliary/\n  --stage-id stage2-x86_64-unknown-linux-gnu\n  --target x86_64-unknown-linux-gnu\n  --host x86_64-unknown-linux-gnu\n  --python \"/usr/bin/python2.7\"\n- --gdb-version=\"GNU gdb (Debian 7.10-1+b1) 7.10\"\n+ --gdb-version=\"GNU gdb (Ubuntu 7.10.1-0ubuntu1) 7.10.1\"\n  --lldb-version=\"\"\n  --android-cross-path=/opt/ndk_standalone\n  --adb-path=\n  --adb-test-dir=\n- --host-rustcflags \" -C link-args=\"-Wl,-z,relro\" --cfg rtopt -C rpath -O -L x86_64-unknown-linux-gnu/rt\"\n+ --host-rustcflags \" -C link-args=\"-Wl,-Bsymbolic-functions -Wl,-z,relro\" --cfg rtopt -C rpath -O -L x86_64-unknown-linux-gnu/rt\"\n  --lldb-python-dir=\n- --target-rustcflags \" -C link-args=\"-Wl,-z,relro\" --cfg rtopt -C rpath -O -L x86_64-unknown-linux-gnu/rt\"\n+ --target-rustcflags \" -C link-args=\"-Wl,-Bsymbolic-functions -Wl,-z,relro\" --cfg rtopt -C rpath -O -L x86_64-unknown-linux-gnu/rt\"\n  --verbose\n  --valgrind-path \"\"/usr/bin/valgrind\"\n   --error-exitcode=100\n   --fair-sched=try\n   --quiet\n   --soname-synonyms=somalloc=NONE\n   --suppressions=/\u00abBUILDDIR\u00bb/rustc-1.8.0~~nightly.20160209+dfsg1/src/etc/x86.supp\n   --tool=memcheck\n   --leak-check=full\"\n  --force-valgrind\n  --src-base /\u00abBUILDDIR\u00bb/rustc-1.8.0~~nightly.20160209+dfsg1/src/test/rustdoc/\n  --build-base x86_64-unknown-linux-gnu/test/rustdoc/\n  --mode rustdoc\n  --logfile tmp/check-stage2-T-x86_64-unknown-linux-gnu-H-x86_64-unknown-linux-gnu-rustdocck.log &&\n touch -r\n  tmp/check-stage2-T-x86_64-unknown-linux-gnu-H-x86_64-unknown-linux-gnu-rustdocck.ok.start_time\n  tmp/check-stage2-T-x86_64-unknown-linux-gnu-H-x86_64-unknown-linux-gnu-rustdocck.ok &&\n rm tmp/check-stage2-T-x86_64-unknown-linux-gnu-H-x86_64-unknown-linux-gnu-rustdocck.ok.start_time\n```\n\nThe failure on Ubuntu looks like this:\n\n```\nrun rustdocck [i686-unknown-linux-gnu]: i686-unknown-linux-gnu/stage2/bin/compiletest\nthread '<main>' panicked at 'UnrecognizedOption(\"W\")', /\u00abBUILDDIR\u00bb/rustc-1.8.0~~nightly.20160209+dfsg1/src/compiletest/compiletest.rs:101\nstack backtrace:\n   1: 0xf737b154 - sys::backtrace::tracing::imp::write::h59a57150de078a41Btu\n   2: 0xf7383891 - panicking::default_handler::_$u7b$$u7b$closure$u7d$$u7d$::closure.43171\n   3: 0xf7383412 - panicking::default_handler::he7b491197c6c99803Wy\n   4: 0xf7347e85 - sys_common::unwind::begin_unwind_inner::h0ac7a886eb1f5e41qit\n   5: 0xf7348937 - sys_common::unwind::begin_unwind_fmt::h5539aae7d4657c99wht\n   6: 0xf76e23cd - parse_config::hd63e903e447ce232uCd\n   7: 0xf76da65c - main::hcc56979a8470e836GBd\n   8: 0xf7382e8a - sys_common::unwind::try::try_fn::h1480467219455099781\n   9: 0xf7378a57 - __rust_try\n  10: 0xf7382b5c - rt::lang_start::hb58bd81a27354c059Oy\n  11: 0xf76e635d - main\n  12: 0xf710271d - __libc_start_main\n  13: 0xf76d9d10 - <unknown>\n/\u00abBUILDDIR\u00bb/rustc-1.8.0~~nightly.20160209+dfsg1/mk/tests.mk:743: recipe for target 'tmp/check-stage2-T-i686-unknown-linux-gnu-H-i686-unknown-linux-gnu-rustdocck.ok' failed\nmake[2]: *** [tmp/check-stage2-T-i686-unknown-linux-gnu-H-i686-unknown-linux-gnu-rustdocck.ok] Error 101\n```\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/31529/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/31529/timeline", "performed_via_github_app": null, "state_reason": "completed"}