{"url": "https://api.github.com/repos/rust-lang/rust/issues/92013", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/92013/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/92013/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/92013/events", "html_url": "https://github.com/rust-lang/rust/issues/92013", "id": 1082739855, "node_id": "I_kwDOAAsO6M5AiUyP", "number": 92013, "title": "Binary size regression in dylibs", "user": {"login": "Nashenas88", "id": 1673130, "node_id": "MDQ6VXNlcjE2NzMxMzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1673130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nashenas88", "html_url": "https://github.com/Nashenas88", "followers_url": "https://api.github.com/users/Nashenas88/followers", "following_url": "https://api.github.com/users/Nashenas88/following{/other_user}", "gists_url": "https://api.github.com/users/Nashenas88/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nashenas88/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nashenas88/subscriptions", "organizations_url": "https://api.github.com/users/Nashenas88/orgs", "repos_url": "https://api.github.com/users/Nashenas88/repos", "events_url": "https://api.github.com/users/Nashenas88/events{/privacy}", "received_events_url": "https://api.github.com/users/Nashenas88/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 147085028, "node_id": "MDU6TGFiZWwxNDcwODUwMjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-nightly", "name": "regression-from-stable-to-nightly", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to nightly."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2021-12-16T23:51:49Z", "updated_at": "2021-12-20T18:11:12Z", "closed_at": "2021-12-19T20:23:56Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a regression report! \ud83d\udc1b A regression is something that changed between versions of Rust but was not supposed to.\r\n\r\nPlease provide a short summary of the regression, along with any information you feel is relevant to replicate it.\r\n-->\r\n\r\n\r\nThe fuchsia nightly toolchain rolls caught a binary size regression due to commit https://github.com/rust-lang/rust/commit/f9e77f2b460492013cea459221194318b7fd8204\r\n\r\nLimiting to just binary changes in the rust repo, following the instructions here: [https://fuchsia.dev/fuchsia-src/development/build/rust_toolchain?hl=en](https://fuchsia.dev/fuchsia-src/development/build/rust_toolchain?hl=en), we can see that on average the standard library is 3.5 times larger:\r\n<details>\r\n<summary>Click to expand</summary>\r\n\r\n```\r\n $ diff -u <(cd ~/fuchsia-rust-without && du -a | sort -k2) <(cd install/fuchsia-rust && du -a | sort -k2)\r\n--- /proc/self/fd/11    2021-12-16 23:41:12.360226537 +0000\r\n+++ /proc/self/fd/18    2021-12-16 23:41:12.360226537 +0000\r\n@@ -1,12 +1,12 @@\r\n-1135076        .\r\n-100040 ./bin\r\n+1139492        .\r\n+100048 ./bin\r\n 27808  ./bin/cargo\r\n 8312   ./bin/cargo-clippy\r\n 9484   ./bin/cargo-fmt\r\n-10252  ./bin/clippy-driver\r\n+10256  ./bin/clippy-driver\r\n 12     ./bin/rustc\r\n 9928   ./bin/rust-demangler\r\n-13064  ./bin/rustdoc\r\n+13068  ./bin/rustdoc\r\n 21164  ./bin/rustfmt\r\n 4      ./bin/rust-gdb\r\n 4      ./bin/rust-gdbgui\r\n@@ -14,30 +14,26 @@\r\n 20     ./etc\r\n 16     ./etc/bash_completion.d\r\n 12     ./etc/bash_completion.d/cargo\r\n-1026028        ./lib\r\n-38272  ./lib/.build-id\r\n-4932   ./lib/.build-id/1f\r\n-380    ./lib/.build-id/1f/33eefa63da5e0d\r\n-4548   ./lib/.build-id/1f/33eefa63da5e0d.debug\r\n-14044  ./lib/.build-id/52\r\n-1360   ./lib/.build-id/52/119c59550c0d88\r\n-12680  ./lib/.build-id/52/119c59550c0d88.debug\r\n-14304  ./lib/.build-id/c2\r\n-1292   ./lib/.build-id/c2/d10ba0e45111ca\r\n-13008  ./lib/.build-id/c2/d10ba0e45111ca.debug\r\n-4988   ./lib/.build-id/dd\r\n-332    ./lib/.build-id/dd/4b1b684bd04567\r\n-4652   ./lib/.build-id/dd/4b1b684bd04567.debug\r\n+1030436        ./lib\r\n+34908  ./lib/.build-id\r\n+13012  ./lib/.build-id/48\r\n+13008  ./lib/.build-id/48/eb8f061585f3df.debug\r\n+4552   ./lib/.build-id/57\r\n+4548   ./lib/.build-id/57/8eb4ac89ce0ac7.debug\r\n+4656   ./lib/.build-id/ad\r\n+4652   ./lib/.build-id/ad/516bd46661c2b2.debug\r\n+12684  ./lib/.build-id/c3\r\n+12680  ./lib/.build-id/c3/b4a43e34abcca0.debug\r\n 8456   ./libexec\r\n 8452   ./libexec/cargo-credential-1password\r\n-75384  ./lib/libLLVM-13-rust-1.59.0-nightly.so\r\n-120696 ./lib/librustc_driver-8d166f3d4b6e5d80.so\r\n+75380  ./lib/libLLVM-13-rust-1.59.0-nightly.so\r\n+120708 ./lib/librustc_driver-fe9dbf77676f2946.so\r\n 13356  ./lib/libstd-3f5a6058990e33c2.so\r\n 4764   ./lib/libtest-48b5b7c796fdec12.so\r\n 4      ./lib/runtime.json\r\n-773548 ./lib/rustlib\r\n-136060 ./lib/rustlib/aarch64-fuchsia\r\n-136056 ./lib/rustlib/aarch64-fuchsia/lib\r\n+781312 ./lib/rustlib\r\n+139940 ./lib/rustlib/aarch64-fuchsia\r\n+139936 ./lib/rustlib/aarch64-fuchsia/lib\r\n 304    ./lib/rustlib/aarch64-fuchsia/lib/libaddr2line-90c91cd254aac157.rlib\r\n 48     ./lib/rustlib/aarch64-fuchsia/lib/libadler-8684584fc827b6cd.rlib\r\n 5016   ./lib/rustlib/aarch64-fuchsia/lib/liballoc-62373237ba162112.rlib\r\n@@ -60,21 +56,21 @@\r\n 8      ./lib/rustlib/aarch64-fuchsia/lib/librustc_std_workspace_core-7b9c68ff961c0793.rlib\r\n 12     ./lib/rustlib/aarch64-fuchsia/lib/librustc_std_workspace_std-59a7bdc55614e72c.rlib\r\n 26016  ./lib/rustlib/aarch64-fuchsia/lib/libstd-be07c02dc031f481.rlib\r\n-1292   ./lib/rustlib/aarch64-fuchsia/lib/libstd-be07c02dc031f481.so\r\n+4712   ./lib/rustlib/aarch64-fuchsia/lib/libstd-be07c02dc031f481.so\r\n 164    ./lib/rustlib/aarch64-fuchsia/lib/libstd_detect-bbd4c7f2ff882d73.rlib\r\n 12664  ./lib/rustlib/aarch64-fuchsia/lib/libtest-76f50ba48ac29a1e.rlib\r\n-332    ./lib/rustlib/aarch64-fuchsia/lib/libtest-76f50ba48ac29a1e.so\r\n+792    ./lib/rustlib/aarch64-fuchsia/lib/libtest-76f50ba48ac29a1e.so\r\n 148    ./lib/rustlib/aarch64-fuchsia/lib/libunicode_width-0a583143af34670b.rlib\r\n 124    ./lib/rustlib/aarch64-fuchsia/lib/libunwind.a\r\n 52     ./lib/rustlib/aarch64-fuchsia/lib/libunwind-c427f07ef33d9f9d.rlib\r\n-161076 ./lib/rustlib/aarch64-unknown-linux-gnu\r\n-161072 ./lib/rustlib/aarch64-unknown-linux-gnu/lib\r\n+161080 ./lib/rustlib/aarch64-unknown-linux-gnu\r\n+161076 ./lib/rustlib/aarch64-unknown-linux-gnu/lib\r\n 312    ./lib/rustlib/aarch64-unknown-linux-gnu/lib/libaddr2line-37f44d9d37c20730.rlib\r\n 48     ./lib/rustlib/aarch64-unknown-linux-gnu/lib/libadler-2caee81c613175ce.rlib\r\n 5068   ./lib/rustlib/aarch64-unknown-linux-gnu/lib/liballoc-fe7cef42d77d414d.rlib\r\n 12     ./lib/rustlib/aarch64-unknown-linux-gnu/lib/libcfg_if-cf5e4577938aedb7.rlib\r\n 5068   ./lib/rustlib/aarch64-unknown-linux-gnu/lib/libcompiler_builtins-05086e81dbe54bf6.rlib\r\n-51424  ./lib/rustlib/aarch64-unknown-linux-gnu/lib/libcore-b44def38eb7dae47.rlib\r\n+51428  ./lib/rustlib/aarch64-unknown-linux-gnu/lib/libcore-b44def38eb7dae47.rlib\r\n 2120   ./lib/rustlib/aarch64-unknown-linux-gnu/lib/libgetopts-5eeb5287d17a8d26.rlib\r\n 6864   ./lib/rustlib/aarch64-unknown-linux-gnu/lib/libgimli-308bcc12df2355e2.rlib\r\n 1180   ./lib/rustlib/aarch64-unknown-linux-gnu/lib/libhashbrown-1bc7c700b83c21f3.rlib\r\n@@ -1916,14 +1912,14 @@\r\n 8580   ./lib/rustlib/wasm32-unknown-unknown/lib/libtest-530f59db49fb2773.rlib\r\n 144    ./lib/rustlib/wasm32-unknown-unknown/lib/libunicode_width-d6f6eb05caa4b08c.rlib\r\n 8      ./lib/rustlib/wasm32-unknown-unknown/lib/libunwind-0ce2d83679176881.rlib\r\n-141800 ./lib/rustlib/x86_64-fuchsia\r\n-141796 ./lib/rustlib/x86_64-fuchsia/lib\r\n+145680 ./lib/rustlib/x86_64-fuchsia\r\n+145676 ./lib/rustlib/x86_64-fuchsia/lib\r\n 304    ./lib/rustlib/x86_64-fuchsia/lib/libaddr2line-dd556d58a6a98686.rlib\r\n 48     ./lib/rustlib/x86_64-fuchsia/lib/libadler-f331a1913229a0c9.rlib\r\n 4984   ./lib/rustlib/x86_64-fuchsia/lib/liballoc-543c62796e6ba4f7.rlib\r\n 12     ./lib/rustlib/x86_64-fuchsia/lib/libcfg_if-41b6d6da5c5d8f78.rlib\r\n 4496   ./lib/rustlib/x86_64-fuchsia/lib/libcompiler_builtins-a606301fb5da8fdf.rlib\r\n-56820  ./lib/rustlib/x86_64-fuchsia/lib/libcore-da0ced80ec6ab2c8.rlib\r\n+56816  ./lib/rustlib/x86_64-fuchsia/lib/libcore-da0ced80ec6ab2c8.rlib\r\n 1976   ./lib/rustlib/x86_64-fuchsia/lib/libgetopts-e19d8aa129e1788d.rlib\r\n 6828   ./lib/rustlib/x86_64-fuchsia/lib/libgimli-5b1712acc4689b1a.rlib\r\n 1164   ./lib/rustlib/x86_64-fuchsia/lib/libhashbrown-e26bc67a99f1c0d5.rlib\r\n@@ -1940,10 +1936,10 @@\r\n 8      ./lib/rustlib/x86_64-fuchsia/lib/librustc_std_workspace_core-185860a1c4fa1525.rlib\r\n 12     ./lib/rustlib/x86_64-fuchsia/lib/librustc_std_workspace_std-f3d442e17b28bc30.rlib\r\n 25860  ./lib/rustlib/x86_64-fuchsia/lib/libstd-4b0aaefa59d0d7cc.rlib\r\n-1360   ./lib/rustlib/x86_64-fuchsia/lib/libstd-4b0aaefa59d0d7cc.so\r\n+4784   ./lib/rustlib/x86_64-fuchsia/lib/libstd-4b0aaefa59d0d7cc.so\r\n 448    ./lib/rustlib/x86_64-fuchsia/lib/libstd_detect-27929f8c582fe1d2.rlib\r\n 12516  ./lib/rustlib/x86_64-fuchsia/lib/libtest-3f645ae7dc0007c0.rlib\r\n-380    ./lib/rustlib/x86_64-fuchsia/lib/libtest-3f645ae7dc0007c0.so\r\n+840    ./lib/rustlib/x86_64-fuchsia/lib/libtest-3f645ae7dc0007c0.so\r\n 148    ./lib/rustlib/x86_64-fuchsia/lib/libunicode_width-618f3c1ed4dee7a0.rlib\r\n 52     ./lib/rustlib/x86_64-fuchsia/lib/libunwind-6aef5eac0c7d634e.rlib\r\n 136    ./lib/rustlib/x86_64-fuchsia/lib/libunwind.a\r\n ```\r\n </details>\r\n\r\nI'm currently assuming that our setting of `debuginfo-level-std = 2` in the config of fuchsia rust builds is what causes this to be so noticeable.\r\n\r\nThe effect on fuchsia is very noticeable:\r\n```\r\n$ compare-sizes.py ~/elf_sizes.json ~/with_changes_elf_sizes.json\r\n../../../rust/install/fuchsia-rust/lib/rustlib/x86_64-fuchsia/lib/libstd-4b0aaefa59d0d7cc.so: blob = 2,785,280 (84.4%)\r\nobj/build/images/sizes/fuchsia.zbi/bootfs/lib/libstd-4b0aaefa59d0d7cc.so: zbi = 3,506,176 (71.6%)\r\n\r\nTotal differences:\r\nblob: 2785280 of 3301376 (84.4%)\r\nzbi : 3506176 of 4898816 (71.6%)\r\n```\r\n\r\nThe binary size increases on our debug builds are large enough to prevent the binaries from fitting on the devices we're debugging.\r\n\r\nCC @tmandry \r\n@rustbot modify labels: +regression-from-stable-to-nightly -regression-untriaged\r\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/92013/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/92013/timeline", "performed_via_github_app": null, "state_reason": "completed"}