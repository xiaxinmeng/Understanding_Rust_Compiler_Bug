{"url": "https://api.github.com/repos/rust-lang/rust/issues/30228", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/30228/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/30228/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/30228/events", "html_url": "https://github.com/rust-lang/rust/issues/30228", "id": 120599770, "node_id": "MDU6SXNzdWUxMjA1OTk3NzA=", "number": 30228, "title": "Thread locals do not guard against recursive initialization.", "user": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 17, "created_at": "2015-12-06T01:09:50Z", "updated_at": "2015-12-15T17:08:56Z", "closed_at": "2015-12-15T17:08:56Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "``` rust\nuse std::cell::Cell;\nstruct Foo;\nthread_local!(static INIT: Cell<bool> = Cell::new(false));\nthread_local!(static FOO: Foo = Foo::init());\nimpl Foo {\n    fn init() -> Foo {\n        INIT.with(|i| {\n            let init = i.get();\n            i.set(true);\n            if !init {\n                // Trigger recursive initialization, just once.\n                FOO.with(|_| {});\n            }\n        });\n        Foo\n    }\n}\nimpl Drop for Foo {\n    fn drop(&mut self) {\n        FOO.with(|foo| alias_check(self, foo));\n    }\n}\n\nfn alias_check<T>(m: &mut T, r: &T) {\n    println!(\"alias_check({:p}, {:p})\", m, r);\n    if m as *mut _ as usize == r as *const _ as usize {\n        panic!(\"aliasing detected!\");\n    }\n}\n\nfn main() {\n    FOO.with(|_| {});\n}\n```\n\nIn current stable (1.4), beta, and nightly the above snippet [produces aliased references](https://play.rust-lang.org/?gist=49d5aea0af33a8254373&version=stable) instead of triggering library asserts.\n\nCurrently, [libstd assumes there is no value](https://github.com/rust-lang/rust/blob/aad4e5665e81a3ec998b3648d395d0eb99a7500b/src/libstd/thread/local.rs#L229) already in the slot when assigning the one produced by the latest initializer call.\n\nIt should either drop one of the two values (perhaps after putting the TLS slot in \"destructor being called\" mode) or panic, if a multiple initialization condition is detected.\n", "closed_by": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/30228/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/30228/timeline", "performed_via_github_app": null, "state_reason": "completed"}