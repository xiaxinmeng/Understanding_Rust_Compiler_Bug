{"url": "https://api.github.com/repos/rust-lang/rust/issues/48433", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/48433/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/48433/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/48433/events", "html_url": "https://github.com/rust-lang/rust/issues/48433", "id": 299401855, "node_id": "MDU6SXNzdWUyOTk0MDE4NTU=", "number": 48433, "title": "Struct Layout Optimization in Rust 1.18 regressed C ABI", "user": {"login": "CryZe", "id": 1451630, "node_id": "MDQ6VXNlcjE0NTE2MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1451630?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CryZe", "html_url": "https://github.com/CryZe", "followers_url": "https://api.github.com/users/CryZe/followers", "following_url": "https://api.github.com/users/CryZe/following{/other_user}", "gists_url": "https://api.github.com/users/CryZe/gists{/gist_id}", "starred_url": "https://api.github.com/users/CryZe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CryZe/subscriptions", "organizations_url": "https://api.github.com/users/CryZe/orgs", "repos_url": "https://api.github.com/users/CryZe/repos", "events_url": "https://api.github.com/users/CryZe/events{/privacy}", "received_events_url": "https://api.github.com/users/CryZe/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-02-22T15:42:16Z", "updated_at": "2018-06-03T14:44:20Z", "closed_at": "2018-06-03T14:44:19Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "In addition to the general question raised by https://github.com/rust-lang/rust/issues/48426 of whether a pair of floats should use a LLVM vector in the Rust ABI, it seems like the C ABI regressed in Rust 1.18 in this regard too. Before Rust 1.18 it used to actually represent the repr(C) equivalent type as a LLVM vector, but since 1.18 the type gets passed as a double instead and then bitcast to the individual fields inside, completely disabling all the vectorization possible.\r\n\r\nCode:\r\n```rust\r\n#[repr(C)]\r\npub struct Vec2 {\r\n    pub x: f32,\r\n    pub y: f32\r\n}\r\n\r\n#[no_mangle]\r\npub extern \"C\" fn add (a: Vec2, b: Vec2) -> Vec2 {\r\n    Vec2 {\r\n        x: a.x + b.x,\r\n        y: a.y + b.y\r\n    }\r\n}\r\n```\r\n\r\nRust 1.17:\r\n```llvm\r\ndefine <2 x float> @add(<2 x float>, <2 x float>) unnamed_addr #0\r\n```\r\n```asm\r\nadd:\r\n  addps xmm0, xmm1\r\n  ret\r\n```\r\n\r\nRust 1.18:\r\n```llvm\r\ndefine double @add(double, double) unnamed_addr #0\r\n```\r\n```asm\r\nadd:\r\n  movq rax, xmm0\r\n  movd xmm0, eax\r\n  shr rax, 32\r\n  movd xmm2, eax\r\n  movq rax, xmm1\r\n  movd xmm1, eax\r\n  shr rax, 32\r\n  movd xmm3, eax\r\n  addss xmm1, xmm0\r\n  addss xmm3, xmm2\r\n  movss dword ptr [rsp - 8], xmm1\r\n  movss dword ptr [rsp - 4], xmm3\r\n  movsd xmm0, qword ptr [rsp - 8]\r\n  ret\r\n```\r\n\r\nHere's the code on Godbolt compiled with Rust 1.17 and 1.18: https://godbolt.org/g/1iu8n2", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/48433/reactions", "total_count": 5, "+1": 4, "-1": 0, "laugh": 1, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/48433/timeline", "performed_via_github_app": null, "state_reason": "completed"}