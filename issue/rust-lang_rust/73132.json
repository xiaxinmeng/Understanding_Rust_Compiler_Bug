{"url": "https://api.github.com/repos/rust-lang/rust/issues/73132", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/73132/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/73132/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/73132/events", "html_url": "https://github.com/rust-lang/rust/issues/73132", "id": 634572942, "node_id": "MDU6SXNzdWU2MzQ1NzI5NDI=", "number": 73132, "title": "\"x.py dist\" build fails in llvm when DESTDIR is set", "user": {"login": "he32", "id": 1199501, "node_id": "MDQ6VXNlcjExOTk1MDE=", "avatar_url": "https://avatars.githubusercontent.com/u/1199501?v=4", "gravatar_id": "", "url": "https://api.github.com/users/he32", "html_url": "https://github.com/he32", "followers_url": "https://api.github.com/users/he32/followers", "following_url": "https://api.github.com/users/he32/following{/other_user}", "gists_url": "https://api.github.com/users/he32/gists{/gist_id}", "starred_url": "https://api.github.com/users/he32/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/he32/subscriptions", "organizations_url": "https://api.github.com/users/he32/orgs", "repos_url": "https://api.github.com/users/he32/repos", "events_url": "https://api.github.com/users/he32/events{/privacy}", "received_events_url": "https://api.github.com/users/he32/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 325438536, "node_id": "MDU6TGFiZWwzMjU0Mzg1MzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-bootstrap", "name": "T-bootstrap", "color": "bfd4f2", "default": false, "description": "Relevant to the bootstrap subteam: Rust's build system (x.py and src/bootstrap)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2020-06-08T12:38:24Z", "updated_at": "2020-06-08T12:43:37Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "\r\nThis appears to be the underlying reason for issue #71743.\r\nWhen I cross-build, I have to use the \"dist\" x.py target to produce\r\na bootstrap kit, and in my setup, `DESTDIR` is aways set (this is in\r\nNetBSD's packaging system, pkgsrc).  I have reproduced the problem\r\noutside the pkgsrc setup, and it is indeed a non-null `DESTDIR` which\r\ntriggers this issue.\r\n\r\nSuch a build errors out with\r\n\r\n```\r\nDist RLS stage1 (x86_64-unknown-netbsd)\r\nrunning: \"/home/he/src/work/rust/build/x86_64-unknown-netbsd/stage0-tools-bin/fabricate\" \"generate\" \"--product-name=Rust\" \"--rel-manifest-dir=rustlib\" \"--success-message=RLS-ready-to-serve.\" \"--image-dir\" \"/home/he/src/work/rust/build/tmp/dist/rls-image\" \"--work-dir\" \"/home/he/src/work/rust/build/tmp/dist\" \"--output-dir\" \"/home/he/src/work/rust/build/dist\" \"--non-installed-overlay\" \"/home/he/src/work/rust/build/tmp/dist/rls-overlay\" \"--package-name=rls-1.41.0-x86_64-unknown-netbsd\" \"--legacy-manifest-dirs=rustlib,cargo\" \"--component-name=rls-preview\"\r\n        finished in 15.267\r\n  < Rls { compiler: Compiler { stage: 1, host: \"x86_64-unknown-netbsd\" }, target: \"x86_64-unknown-netbsd\" }\r\n  > LlvmTools { target: \"x86_64-unknown-netbsd\" }\r\nDist LlvmTools (x86_64-unknown-netbsd)\r\nthread 'main' panicked at 'Error: File \"/home/he/src/work/rust/build/x86_64-unknown-netbsd/llvm/bin/llvm-nm\" not found!', src/bootstrap/lib.rs:1215:17\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\r\n        finished in 0.022\r\nTraceback (most recent call last):\r\n...\r\n```\r\n\r\nWhen `DESTDIR` is set to `$(pwd)/work/destdir`, `llvm-nm` ends up installed in\r\n`./work/destdir/home/he/src/work/rust/build/x86_64-unknown-netbsd/llvm/bin/llvm-nm`\r\ninstead of what the rest of the build expects (ref. above),\r\n`./work/rust/build/x86_64-unknown-netbsd/llvm/bin/llvm-nm`.\r\nIt's as if some part of the build has already figured out the full pathname to the destination,\r\nand then proceeds to prepend `$DESTDIR` to that absolute path; `$(pwd)`\r\nis `/home/he/src/` in this setup.\r\n\r\nThe question is whether the rust build system ought to clear DESTDIR\r\nfor the build of the internal llvm, at least for the \"build\" phase?\r\n\r\nThe workaround I used is to unset DESTDIR for the build in total, but\r\ndoing so also for the top-level \"build\" target has the unfortunate side-effect that\r\ncargo detects this change when \"install\" time comes, and causes everything\r\nto be re-built.  (I can see a workaround for this issue, though.)\r\n\r\nAs stated in the referenced issue, this problem is not new in 1.43, it also\r\nexists in 1.42 and 1.41.1 -- I did not traverse further back.\r\n\r\nThe bootstrap used for the 1.41.1 build attempt was:\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.40.0 (73528e339 2019-12-16)\r\nbinary: rustc\r\ncommit-hash: 73528e339aae0f17a15ffa49a8ac608f50c6cf14\r\ncommit-date: 2019-12-16\r\nhost: x86_64-unknown-netbsd\r\nrelease: 1.40.0\r\n```\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/73132/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/73132/timeline", "performed_via_github_app": null, "state_reason": null}