{"url": "https://api.github.com/repos/rust-lang/rust/issues/99535", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/99535/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/99535/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/99535/events", "html_url": "https://github.com/rust-lang/rust/issues/99535", "id": 1312084892, "node_id": "I_kwDOAAsO6M5ONNOc", "number": 99535, "title": "Printing io::Error panics if current UNIX locale doesn't use UTF-8 encoding", "user": {"login": "complexspaces", "id": 68570223, "node_id": "MDQ6VXNlcjY4NTcwMjIz", "avatar_url": "https://avatars.githubusercontent.com/u/68570223?v=4", "gravatar_id": "", "url": "https://api.github.com/users/complexspaces", "html_url": "https://github.com/complexspaces", "followers_url": "https://api.github.com/users/complexspaces/followers", "following_url": "https://api.github.com/users/complexspaces/following{/other_user}", "gists_url": "https://api.github.com/users/complexspaces/gists{/gist_id}", "starred_url": "https://api.github.com/users/complexspaces/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/complexspaces/subscriptions", "organizations_url": "https://api.github.com/users/complexspaces/orgs", "repos_url": "https://api.github.com/users/complexspaces/repos", "events_url": "https://api.github.com/users/complexspaces/events{/privacy}", "received_events_url": "https://api.github.com/users/complexspaces/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2635899341, "node_id": "MDU6TGFiZWwyNjM1ODk5MzQx", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-unix", "name": "O-unix", "color": "6e6ec0", "default": false, "description": "Operating system: Unix-like"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2022-07-20T22:59:21Z", "updated_at": "2022-09-25T09:34:11Z", "closed_at": "2022-09-25T09:34:11Z", "author_association": "NONE", "active_lock_reason": null, "body": "I tried this code:\r\n\r\n```rust\r\nfn main() {\r\n    let result = std::fs::create_dir(\"/tmp/does_not_exist/new_dir_name\");\r\n    println!(\"{:?}\", result);\r\n}\r\n```\r\n\r\nWith the test binary built:\r\n```\r\nexport LANG=zh_CN; ./target/debug/binary_name\r\n```\r\n\r\nThis crash was encountered on a \"stock\" Fedora 36 installation. The issue is highly dependent on how your Linux system's locale is configured. It seems that it is up to the distro to configure [which locale encoding set](https://wiki.archlinux.org/title/Localization/Simplified_Chinese#Basic_Chinese_support) is used, in this specific case for Chinese. Given that GB-2312 used to be a mandated standard, it is unsurprising to see it in the wild.\r\n\r\nI expected to see this happen: The error message would be printed in any form.\r\n\r\nInstead, this happened: A panic kills the app and no error is printed.\r\n\r\nAFAICT, this error comes from an assumption that the standard library made to assume all characters returned by `strerror_r` will use UTF-8 encoding: https://github.com/rust-lang/rust/blob/master/library/std/src/sys/unix/os.rs#L113-L130\r\n\r\nIf you look at other larger software projects and how they use `strerror_r`, in this case Chromium and Firefox:\r\n- Chromium [keeps the buffer](https://source.chromium.org/chromium/chromium/src/+/main:base/posix/safe_strerror.cc) as a C-style string.\r\n- Firefox [performs a conversion using the Latin1 encoding](https://searchfox.org/mozilla-central/source/js/src/shell/OSObject.cpp#942-946). The reasoning for doing so is documented to explicitly workaround this case.\r\n\r\nI am not sure what the \"most correct\" solution is for the standard library given that all Rust strings must be UTF-8, but I think that it would be ideal to not crash a thread (or app, depending on the unwind mode) if an end-user has their locale set to something that uses a non-unicode representation.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.61.0 (fe5b13d68 2022-05-18)\r\nbinary: rustc\r\ncommit-hash: fe5b13d681f25ee6474be29d748c65adcd91f69e\r\ncommit-date: 2022-05-18\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.61.0\r\nLLVM version: 14.0.0\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```\r\nthread '<unnamed>' panicked at 'called `Result::unwrap()` on an `Err` value: Utf8Error { valid_up_to: 2, error_len: Some(1) }', library/std/src/sys/unix/os.rs:128:54\r\nstack backtrace:\r\n   0:     0x7f3a4d4c6ac2 - std::backtrace_rs::backtrace::libunwind::trace::h22893a5306c091b4\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/../../backtrace/src/backtrace/libunwind.rs:93:5\r\n   1:     0x7f3a4d4c6ac2 - std::backtrace_rs::backtrace::trace_unsynchronized::h29c3bc6f9e91819d\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/../../backtrace/src/backtrace/mod.rs:66:5\r\n   2:     0x7f3a4d4c6ac2 - std::sys_common::backtrace::_print_fmt::he497d8a0ec903793\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/sys_common/backtrace.rs:66:5\r\n   3:     0x7f3a4d4c6ac2 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::h9c2a9d2774d81873\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/sys_common/backtrace.rs:45:22\r\n   4:     0x7f3a4bc712cc - core::fmt::write::hba4337c43d992f49\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/fmt/mod.rs:1194:17\r\n   5:     0x7f3a4d4c0251 - std::io::Write::write_fmt::heb73de6e02cfabed\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/io/mod.rs:1655:15\r\n   6:     0x7f3a4d4c8755 - std::sys_common::backtrace::_print::h63c8b24acdd8e8ce\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/sys_common/backtrace.rs:48:5\r\n   7:     0x7f3a4d4c8755 - std::sys_common::backtrace::print::h426700d6240cdcc2\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/sys_common/backtrace.rs:35:9\r\n   8:     0x7f3a4d4c8755 - std::panicking::default_hook::{{closure}}::hc9a76eed0b18f82b\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/panicking.rs:295:22\r\n   9:     0x7f3a4d4c84c4 - std::panicking::default_hook::h2e88d02087fae196\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/panicking.rs:314:9\r\n  10:     0x7f3a4c745788 - op_crash_reporting::enable_panic_hook::{{closure}}::{{closure}}::h724bf2747ea56a1c\r\n  11:     0x7f3a4b74882a - op_executor::SenderBuilder<Request>::build::{{closure}}::{{closure}}::hf89d1cadb6419e73\r\n  12:     0x7f3a4d4c8cfb - std::panicking::rust_panic_with_hook::habfdcc2e90f9fd4c\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/panicking.rs:702:17\r\n  13:     0x7f3a4d4c8b34 - std::panicking::begin_panic_handler::{{closure}}::he054b2a83a51d2cd\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/panicking.rs:588:13\r\n  14:     0x7f3a4d4c6fd4 - std::sys_common::backtrace::__rust_end_short_backtrace::ha48b94ab49b30915\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/sys_common/backtrace.rs:138:18\r\n  15:     0x7f3a4d4c889d - rust_begin_unwind\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/panicking.rs:584:5\r\n  16:     0x7f3a4b62b213 - core::panicking::panic_fmt::h366d3a309ae17c94\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/panicking.rs:143:14\r\n  17:     0x7f3a4b62b303 - core::result::unwrap_failed::hddd78f4658ac7d0f\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/result.rs:1785:5\r\n  18:     0x7f3a4d4cbc5e - core::result::Result<T,E>::unwrap::h2ba9400889a980d6\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/result.rs:1078:23\r\n  19:     0x7f3a4d4cbc5e - std::sys::unix::os::error_string::h64fe777d5d9922ad\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/sys/unix/os.rs:128:9\r\n  20:     0x7f3a4d4bcfc2 - std::io::error::<impl core::fmt::Debug for std::io::error::repr_bitpacked::Repr>::fmt::h38748b43fb2fb69c\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/io/error.rs:836:36\r\n  21:     0x7f3a4bc6f28f - core::fmt::builders::DebugTuple::field::{{closure}}::h28f8fba9ff4c5ec8\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/fmt/builders.rs:332:17\r\n  22:     0x7f3a4bc6f28f - core::result::Result<T,E>::and_then::h9a138925c1fad505\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/result.rs:1332:22\r\n  23:     0x7f3a4bc6f28f - core::fmt::builders::DebugTuple::field::h82683a4707af3361\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/fmt/builders.rs:319:23\r\n  24:     0x7f3a4bf53a36 - <notify::error::ErrorKind as core::fmt::Debug>::fmt::hc30b2bf96845208f\r\n  25:     0x7f3a4bc712cc - core::fmt::write::hba4337c43d992f49\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/fmt/mod.rs:1194:17\r\n  26:     0x7f3a4b7420e5 - <op_log::loggable::LogDisplay<T> as core::fmt::Display>::fmt::h8b68bd9486878f91\r\n  27:     0x7f3a4bc712cc - core::fmt::write::hba4337c43d992f49\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/fmt/mod.rs:1194:17\r\n  28:     0x7f3a4bc014c4 - core::fmt::Write::write_fmt::hf11e68ede6b8308a\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/fmt/mod.rs:186:9\r\n  29:     0x7f3a4bc014c4 - alloc::fmt::format::h4114a1f369d70d00\r\n                               at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/alloc/src/fmt.rs:597:5\r\n  30:     0x7f3a4b8b3ef1 - op_log::loggable::result::ResultExt::log_err_msg::h0a38de7e80b960e8\r\n  31:     0x7f3a4ba07dd5 - op_ssh_config::SshConfig::new::h7079eec1183c1f85\r\n  32:     0x7f3a4b7baf5a - op_app::app::App::new::h98a497264aec65bc\r\n  33:     0x7f3a4b9c779a - op_executor::SenderBuilder<Request>::build::he5c713296a344328\r\n  34:     0x7f3a4b846b8b - core_node::init_core::hde82e7bc30331296\r\n  35:     0x7f3a4ba35e1d - neon::types::error::convert_panics::hd03f753ff0e515e2\r\n  36:     0x7f3a4bb8f632 - neon::sys::fun::call_boxed::h21d0cfe35e5836b5\r\n  37:     0x558fa4ad82cb - <unknown>\r\n```\r\n</p>\r\n</details>\r\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/99535/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/99535/timeline", "performed_via_github_app": null, "state_reason": "completed"}