{"url": "https://api.github.com/repos/rust-lang/rust/issues/79857", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/79857/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/79857/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/79857/events", "html_url": "https://github.com/rust-lang/rust/issues/79857", "id": 760432239, "node_id": "MDU6SXNzdWU3NjA0MzIyMzk=", "number": 79857, "title": "Cargo bench eats excessive memory on WSL2 ubuntu", "user": {"login": "kigawas", "id": 4182346, "node_id": "MDQ6VXNlcjQxODIzNDY=", "avatar_url": "https://avatars.githubusercontent.com/u/4182346?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kigawas", "html_url": "https://github.com/kigawas", "followers_url": "https://api.github.com/users/kigawas/followers", "following_url": "https://api.github.com/users/kigawas/following{/other_user}", "gists_url": "https://api.github.com/users/kigawas/gists{/gist_id}", "starred_url": "https://api.github.com/users/kigawas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kigawas/subscriptions", "organizations_url": "https://api.github.com/users/kigawas/orgs", "repos_url": "https://api.github.com/users/kigawas/repos", "events_url": "https://api.github.com/users/kigawas/events{/privacy}", "received_events_url": "https://api.github.com/users/kigawas/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 630799571, "node_id": "MDU6TGFiZWw2MzA3OTk1NzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compilemem", "name": "I-compilemem", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to memory usage during compilation."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 900795185, "node_id": "MDU6TGFiZWw5MDA3OTUxODU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-const-eval", "name": "A-const-eval", "color": "f7e101", "default": false, "description": "Area: constant evaluation (mir interpretation)"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2020-12-09T15:32:57Z", "updated_at": "2020-12-10T16:27:26Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "This issue supersedes https://github.com/rust-lang/cargo/issues/8961\r\n\r\n## TL;DR\r\n\r\nThis can be worked around by setting `CARGO_BUILD_JOBS`.\r\n\r\n## Description\r\n\r\nBriefly, `cargo bench` eats excessive memory on WSL2 with a 10-core 20-thread i9-10900K Intel CPU and 32GB memory, due to:\r\n\r\n1. Since the number of CPUs are 20, there will be 20 `rustc` processes and each process would take more than 2GB memory.\r\n\r\n![image](https://user-images.githubusercontent.com/4182346/101624534-65401480-3a5d-11eb-8b99-82fbce85b0bc.png)\r\n\r\n2. Memory gets drained, `rustc`s get killed.\r\n```\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name simple --edition=2018 bench/simple.rs --error-format=json --json=diagnostic-rendered-ansi --emit=dep-info,link -C opt-level=3 -C embed-bitcode=no --cfg test --cfg 'feature=\"aes-gcm\"' --cfg 'feature=\"pure\"' --cfg 'feature=\"typenum\"' -C metadata=5b7a3f7d5f63fca0 -C extra-filename=-5b7a3f7d5f63fca0 --out-dir /home/ryan/works/rs/eciesrs/target/release/deps -L dependency=/home/ryan/works/rs/eciesrs/target/release/deps --extern aes_gcm=/home/ryan/works/rs/eciesrs/target/release/deps/libaes_gcm-b689cfd45f541159.rlib --extern criterion=/home/ryan/works/rs/eciesrs/target/release/deps/libcriterion-92424be6afcb1e28.rlib --extern ecies=/home/ryan/works/rs/eciesrs/target/release/deps/libecies-b1dd2b46a70a3818.rlib --extern futures_util=/home/ryan/works/rs/eciesrs/target/release/deps/libfutures_util-31a01fcbcefd69d3.rlib --extern hex=/home/ryan/works/rs/eciesrs/target/release/deps/libhex-f0ac4054f3e10cf0.rlib --extern hkdf=/home/ryan/works/rs/eciesrs/target/release/deps/libhkdf-23697e084e864558.rlib --extern secp256k1=/home/ryan/works/rs/eciesrs/target/release/deps/libsecp256k1-97002a720e291605.rlib --extern rand=/home/ryan/works/rs/eciesrs/target/release/deps/librand-db608fc81ec83f78.rlib --extern reqwest=/home/ryan/works/rs/eciesrs/target/release/deps/libreqwest-626df515e3200886.rlib --extern sha2=/home/ryan/works/rs/eciesrs/target/release/deps/libsha2-3f02633d25ddd93e.rlib --extern tokio=/home/ryan/works/rs/eciesrs/target/release/deps/libtokio-a1ca85da5f2e46d4.rlib --extern typenum=/home/ryan/works/rs/eciesrs/target/release/deps/libtypenum-8754dce572e25207.rlib` (signal: 9, SIGKILL: kill)\r\n```\r\n```plaintext\r\n$ dmesg | egrep -i 'killed process'\r\n[ 1600.860772] Killed process 25878 (rustc) total-vm:70450572kB, anon-rss:25802536kB, file-rss:4kB, shmem-rss:0kB\r\n[ 1757.423082] Killed process 26023 (rustc) total-vm:70450572kB, anon-rss:25616460kB, file-rss:0kB, shmem-rss:0kB\r\n[ 2273.824947] Killed process 30194 (rustc) total-vm:70453132kB, anon-rss:25644020kB, file-rss:0kB, shmem-rss:0kB\r\n[ 2620.751454] Killed process 30529 (rustc) total-vm:70483340kB, anon-rss:25640772kB, file-rss:0kB, shmem-rss:0kB\r\n[ 2770.585678] Killed process 30583 (rustc) total-vm:70453132kB, anon-rss:25798272kB, file-rss:0kB, shmem-rss:0kB\r\n[ 3143.114175] Killed process 3061 (rustc) total-vm:74940760kB, anon-rss:25593988kB, file-rss:0kB, shmem-rss:0kB\r\n[ 3408.653964] Killed process 7694 (rustc) total-vm:70429604kB, anon-rss:25772680kB, file-rss:0kB, shmem-rss:0kB\r\n[ 4256.437701] Killed process 14596 (rustc) total-vm:70450468kB, anon-rss:25585988kB, file-rss:0kB, shmem-rss:0kB\r\n[ 9058.139548] Killed process 24291 (rustc) total-vm:70450468kB, anon-rss:25588892kB, file-rss:88kB, shmem-rss:0kB\r\n[ 9408.142325] Killed process 24403 (rustc) total-vm:70450468kB, anon-rss:25622152kB, file-rss:0kB, shmem-rss:0kB\r\n```\r\n\r\n## Other information\r\n\r\n1. All toolchains (stable, beta and nightly) share the same problem by Dec 9, 2020.\r\n2. The bug does not occur on `cargo build` or `cargo test`, with or without `--release`.\r\n\r\n## Steps\r\n1. `git clone https://github.com/ecies/rs.git eciesrs && cd eciesrs` in WSL2 ubuntu shell.\r\n2. `cargo bench --no-default-features --features pure`\r\n3. Watch your memory exploding\r\n\r\n## Possible Solution(s)\r\n\r\nSet `CARGO_BUILD_JOBS` to a lower value.\r\n\r\n## Notes\r\n\r\nOutput of `cargo version`:\r\n\r\n```\r\ncargo 1.48.0 (65cbdd2dc 2020-10-14)\r\ncargo 1.49.0-beta (b9216831a 2020-11-24)\r\ncargo 1.50.0-nightly (63d0fe434 2020-12-02)\r\n```\r\n\r\n## Possibly related issues\r\n\r\n1. https://github.com/rust-lang/rust/issues/51309\r\n1. https://users.rust-lang.org/t/cargo-build-crashes-with-sigkill/50035\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/79857/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/79857/timeline", "performed_via_github_app": null, "state_reason": null}