{"url": "https://api.github.com/repos/rust-lang/rust/issues/72140", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/72140/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/72140/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/72140/events", "html_url": "https://github.com/rust-lang/rust/issues/72140", "id": 616688115, "node_id": "MDU6SXNzdWU2MTY2ODgxMTU=", "number": 72140, "title": "LTO and no_builtins: undefined references to standard Rust symbols errors at link time", "user": {"login": "Deluvi", "id": 33259748, "node_id": "MDQ6VXNlcjMzMjU5NzQ4", "avatar_url": "https://avatars.githubusercontent.com/u/33259748?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Deluvi", "html_url": "https://github.com/Deluvi", "followers_url": "https://api.github.com/users/Deluvi/followers", "following_url": "https://api.github.com/users/Deluvi/following{/other_user}", "gists_url": "https://api.github.com/users/Deluvi/gists{/gist_id}", "starred_url": "https://api.github.com/users/Deluvi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Deluvi/subscriptions", "organizations_url": "https://api.github.com/users/Deluvi/orgs", "repos_url": "https://api.github.com/users/Deluvi/repos", "events_url": "https://api.github.com/users/Deluvi/events{/privacy}", "received_events_url": "https://api.github.com/users/Deluvi/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2020-05-12T14:09:33Z", "updated_at": "2020-05-12T14:23:21Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\nIt seems that depending on a Rust library that has the attribute `#![no_builtins]` prevents the linker to provide the needed symbols to the library.\r\n\r\nI made a repository to demonstrate this issue with a minimal reproduction case: [Deluvi/bug-no-builtins-lto-rust](https://github.com/Deluvi/bug-no-builtins-lto-rust). The instructions to run the example are in the README.\r\n\r\nHere is an example error line (you can find the whole `cargo` output in the \"Error output\" drop down below):\r\n\r\n```\r\n/usr/bin/ld: no_builtins_lib.2derfq4u-cgu.2:(.text._ZN5alloc7raw_vec19RawVec$LT$T$C$A$GT$7reserve17h791963cb9aa36cdbE+0x7f): undefined reference to `__rust_alloc'\r\n```\r\n\r\nIf you want the compilation to work, you can remove the [`#!\\[no_builtins\\] line](https://github.com/Deluvi/bug-no-builtins-lto-rust/blob/38a36ceaa2bed1dfa6a1963c855d92adc4896cbe/no-builtins-lib/src/lib.rs#L1) and the compilation will work just fine.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.43.1 (8d69840ab 2020-05-04)\r\nbinary: rustc\r\ncommit-hash: 8d69840ab92ea7f4d323420088dd8c9775f180cd\r\ncommit-date: 2020-05-04\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.43.1\r\nLLVM version: 9.0\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary>Error output</summary>\r\n<p>\r\n\r\n```\r\ncargo run --release -p no-builtins-bin\r\n   Compiling no-builtins-lib v0.1.0 (/home/deluvi/tests/test-lto/no-builtins-lib)\r\n   Compiling no-builtins-bin v0.1.0 (/home/deluvi/tests/test-lto/no-builtins-bin)\r\nerror: linking with `cc` failed: exit code: 1\r\n  |\r\n  = note: \"cc\" \"-Wl,--as-needed\" \"-Wl,-z,noexecstack\" \"-m64\" \"-L\" \"/home/deluvi/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"/home/deluvi/tests/test-lto/target/release/deps/no_builtins_bin-d28e15586db11f8b.no_builtins_bin.ds5ffvdz-cgu.7.rcgu.o\" \"-o\" \"/home/deluvi/tests/test-lto/target/release/deps/no_builtins_bin-d28e15586db11f8b\" \"-Wl,--gc-sections\" \"-pie\" \"-Wl,-zrelro\" \"-Wl,-znow\" \"-Wl,-O1\" \"-nodefaultlibs\" \"-L\" \"/home/deluvi/tests/test-lto/target/release/deps\" \"-L\" \"/home/deluvi/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-Wl,-Bstatic\" \"/home/deluvi/tests/test-lto/target/release/deps/libno_builtins_lib-cef2adf5c7c12373.rlib\" \"-Wl,--start-group\" \"/tmp/rustcvFiUgJ/libbacktrace_sys-dc606003556dfe9c.rlib\" \"-Wl,--end-group\" \"/home/deluvi/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-2541f1e09df1c67d.rlib\" \"-Wl,-Bdynamic\" \"-ldl\" \"-lrt\" \"-lpthread\" \"-lgcc_s\" \"-lc\" \"-lm\" \"-lrt\" \"-lpthread\" \"-lutil\" \"-lutil\"\r\n  = note: /usr/bin/ld: /home/deluvi/tests/test-lto/target/release/deps/libno_builtins_lib-cef2adf5c7c12373.rlib(no_builtins_lib-cef2adf5c7c12373.no_builtins_lib.2derfq4u-cgu.0.rcgu.o): in function `core::ptr::drop_in_place':\r\n          no_builtins_lib.2derfq4u-cgu.0:(.text._ZN4core3ptr13drop_in_place17h107dbe4e36e3489dE+0x13): undefined reference to `__rust_dealloc'\r\n          /usr/bin/ld: /home/deluvi/tests/test-lto/target/release/deps/libno_builtins_lib-cef2adf5c7c12373.rlib(no_builtins_lib-cef2adf5c7c12373.no_builtins_lib.2derfq4u-cgu.2.rcgu.o): in function `alloc::raw_vec::RawVec<T,A>::reserve':\r\n          no_builtins_lib.2derfq4u-cgu.2:(.text._ZN5alloc7raw_vec19RawVec$LT$T$C$A$GT$7reserve17h791963cb9aa36cdbE+0x58): undefined reference to `__rust_realloc'\r\n          /usr/bin/ld: no_builtins_lib.2derfq4u-cgu.2:(.text._ZN5alloc7raw_vec19RawVec$LT$T$C$A$GT$7reserve17h791963cb9aa36cdbE+0x7f): undefined reference to `__rust_alloc'\r\n          /usr/bin/ld: no_builtins_lib.2derfq4u-cgu.2:(.text._ZN5alloc7raw_vec19RawVec$LT$T$C$A$GT$7reserve17h791963cb9aa36cdbE+0x8f): undefined reference to `__rust_dealloc'\r\n          /usr/bin/ld: no_builtins_lib.2derfq4u-cgu.2:(.text._ZN5alloc7raw_vec19RawVec$LT$T$C$A$GT$7reserve17h791963cb9aa36cdbE+0x98): undefined reference to `core::alloc::Layout::dangling'\r\n          /usr/bin/ld: no_builtins_lib.2derfq4u-cgu.2:(.text._ZN5alloc7raw_vec19RawVec$LT$T$C$A$GT$7reserve17h791963cb9aa36cdbE+0xa8): undefined reference to `core::alloc::Layout::dangling'\r\n          /usr/bin/ld: no_builtins_lib.2derfq4u-cgu.2:(.text._ZN5alloc7raw_vec19RawVec$LT$T$C$A$GT$7reserve17h791963cb9aa36cdbE+0xc4): undefined reference to `alloc::raw_vec::capacity_overflow'\r\n          /usr/bin/ld: no_builtins_lib.2derfq4u-cgu.2:(.text._ZN5alloc7raw_vec19RawVec$LT$T$C$A$GT$7reserve17h791963cb9aa36cdbE+0xd4): undefined reference to `alloc::alloc::handle_alloc_error'\r\n          collect2: error: ld returned 1 exit status\r\n          \r\n\r\nerror: aborting due to previous error\r\n\r\nerror: could not compile `no-builtins-bin`.\r\n```\r\n\r\n</p>\r\n</details>\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/72140/reactions", "total_count": 4, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 1}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/72140/timeline", "performed_via_github_app": null, "state_reason": null}