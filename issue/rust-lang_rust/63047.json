{"url": "https://api.github.com/repos/rust-lang/rust/issues/63047", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/63047/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/63047/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/63047/events", "html_url": "https://github.com/rust-lang/rust/issues/63047", "id": 473660295, "node_id": "MDU6SXNzdWU0NzM2NjAyOTU=", "number": 63047, "title": "-Zprofile and -Clink-dead-code enabled leads to the linking error on macOS", "user": {"login": "svartalf", "id": 1279564, "node_id": "MDQ6VXNlcjEyNzk1NjQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1279564?v=4", "gravatar_id": "", "url": "https://api.github.com/users/svartalf", "html_url": "https://github.com/svartalf", "followers_url": "https://api.github.com/users/svartalf/followers", "following_url": "https://api.github.com/users/svartalf/following{/other_user}", "gists_url": "https://api.github.com/users/svartalf/gists{/gist_id}", "starred_url": "https://api.github.com/users/svartalf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/svartalf/subscriptions", "organizations_url": "https://api.github.com/users/svartalf/orgs", "repos_url": "https://api.github.com/users/svartalf/repos", "events_url": "https://api.github.com/users/svartalf/events{/privacy}", "received_events_url": "https://api.github.com/users/svartalf/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 123111, "node_id": "MDU6TGFiZWwxMjMxMTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-macos", "name": "O-macos", "color": "6e6ec0", "default": false, "description": "Operating system: macOS"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 14, "created_at": "2019-07-27T17:33:38Z", "updated_at": "2021-05-15T22:51:24Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I'm integrating [grcov](https://github.com/mozilla/grcov) and have macOS build failures with a linkage error while both `-Zprofile` and `-Clink-dead-code` flags enabled.\r\n\r\nConsider a cargo project with the following manifest:\r\n```toml\r\n[package]\r\nname = \"foo\"\r\nversion = \"0.1.0\"\r\nauthors = [\"me\"]\r\nedition = \"2018\"\r\n\r\n[dependencies]\r\ncore-foundation = \"0.6.4\"\r\n```\r\n\r\nand the `src/main.rs` file:\r\n```rust\r\nuse core_foundation::dictionary::CFMutableDictionary;\r\nuse core_foundation::number::CFNumber;\r\n\r\nfn main() {\r\n    let mut dict = CFMutableDictionary::new();\r\n    let key = CFNumber::from(1);\r\n    let value = CFNumber::from(2);\r\n    dict.add(&key, &value);\r\n\r\n    dbg!(dict.len());\r\n}\r\n```\r\n\r\nPlain `cargo run` successfully compiles and run the binary (no additional env vars set):\r\n\r\n```\r\n$ cargo run\r\n   Compiling foo v0.1.0 (/Users/apple/Desktop/foo)\r\n    Finished dev [unoptimized + debuginfo] target(s) in 0.41s\r\n     Running `target/debug/foo`\r\n[src/main.rs:10] dict.len() = 1\r\n```\r\n\r\nNow, as described in the `gcov` [readme](https://github.com/mozilla/grcov#grcov-with-travis) I add the necessary flags:\r\n\r\n```\r\n$ cargo clean\r\n$ CARGO_INCREMENTAL=0 RUSTFLAGS=\"-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Zno-landing-pads\" cargo run\r\n   Compiling libc v0.2.60\r\n   Compiling core-foundation-sys v0.6.2\r\n   Compiling core-foundation v0.6.4\r\n   Compiling foo v0.1.0 (/Users/apple/Desktop/foo)\r\nerror: linking with `cc` failed: exit code: 1\r\n  |\r\n  = note: \"cc\" \"-m64\" \"-L\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib\" \"/Users/apple/Desktop/foo/target/debug/deps/foo-43971b11e9fc60ca.foo.ayycu2cz-cgu.0.rcgu.o\" \"-o\" \"/Users/apple/Desktop/foo/target/debug/deps/foo-43971b11e9fc60ca\" \"/Users/apple/Desktop/foo/target/debug/deps/foo-43971b11e9fc60ca.8f4xgbrv4jev7ka.rcgu.o\" \"-nodefaultlibs\" \"-L\" \"/Users/apple/Desktop/foo/target/debug/deps\" \"-L\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libtest-2f2c545f20952714.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libterm-d31c4cfba4ff2a7a.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libgetopts-2b60fe103d1e455e.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libunicode_width-7d268ed1d33eabb7.rlib\" \"/Users/apple/Desktop/foo/target/debug/deps/libcore_foundation-19ef10f3e7242abe.rlib\" \"/Users/apple/Desktop/foo/target/debug/deps/liblibc-5e68c041a34d0eed.rlib\" \"/Users/apple/Desktop/foo/target/debug/deps/libcore_foundation_sys-6d86f6aead90fb35.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libprofiler_builtins-f8dafa01db4dca39.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libstd-292d8bc6470467ba.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libpanic_unwind-912dbe632ba1cbae.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libbacktrace-ba5714b629684fb4.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libbacktrace_sys-eac4a78ff89c6e87.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/librustc_demangle-ef9b06bfe5cc2531.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libhashbrown-3b7d42ffe20649f3.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/librustc_std_workspace_alloc-4ad9bb4642dcbb0e.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libunwind-2705756291291215.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libcfg_if-4b3e65f59d0d2bb7.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/liblibc-654bf98555d844ff.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/liballoc-46c32f2ea46d194a.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/librustc_std_workspace_core-ce3fd965850830d8.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libcore-46c797561289aff0.rlib\" \"/Users/apple/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libcompiler_builtins-974d425bd7750373.rlib\" \"-framework\" \"CoreFoundation\" \"-lSystem\" \"-lresolv\" \"-lc\" \"-lm\"\r\n  = note: Undefined symbols for architecture x86_64:\r\n            \"_CFMutableAttributedStringGetTypeID\", referenced from:\r\n                _$LT$core_foundation..attributed_string..CFMutableAttributedString$u20$as$u20$core_foundation..base..TCFType$GT$::type_id::h9cd95ae9d283ffee in libcore_foundation-19ef10f3e7242abe.rlib(core_foundation-19ef10f3e7242abe.core_foundation.bhl000vu-cgu.0.rcgu.o)\r\n          ld: symbol(s) not found for architecture x86_64\r\n          clang: error: linker command failed with exit code 1 (use -v to see invocation)\r\n```\r\n\r\nWith a `-Clink-dead-code` flag removed from `RUSTFLAGS` build successfully compiles: \r\n\r\n```\r\n$ cargo clean\r\n$ CARGO_INCREMENTAL=0 RUSTFLAGS=\"-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Coverflow-checks=off -Zno-landing-pads\" cargo run\r\n   Compiling libc v0.2.60\r\n   Compiling core-foundation-sys v0.6.2\r\n   Compiling core-foundation v0.6.4\r\n   Compiling foo v0.1.0 (/Users/apple/Desktop/foo)\r\n    Finished dev [unoptimized + debuginfo] target(s) in 3.76s\r\n     Running `target/debug/foo`\r\n[src/main.rs:10] dict.len() = 1\r\n```\r\n\r\nThe same behavior applies to `cargo test` command.\r\n\r\n## Meta\r\n\r\n```\r\n$ rustc --version --verbose\r\nrustc 1.38.0-nightly (a7f28678b 2019-07-23)\r\nbinary: rustc\r\ncommit-hash: a7f28678bbf4e16893bb6a718e427504167a9494\r\ncommit-date: 2019-07-23\r\nhost: x86_64-apple-darwin\r\nrelease: 1.38.0-nightly\r\nLLVM version: 9.0\r\n\r\n$ xcrun --show-sdk-version\r\n10.14.1\r\n\r\n$ sw_vers\r\nProductName:\tMac OS X\r\nProductVersion:\t10.13.6\r\nBuildVersion:\t17G65\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/63047/reactions", "total_count": 6, "+1": 6, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/63047/timeline", "performed_via_github_app": null, "state_reason": null}