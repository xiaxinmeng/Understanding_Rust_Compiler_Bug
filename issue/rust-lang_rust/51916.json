{"url": "https://api.github.com/repos/rust-lang/rust/issues/51916", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/51916/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/51916/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/51916/events", "html_url": "https://github.com/rust-lang/rust/issues/51916", "id": 337114853, "node_id": "MDU6SXNzdWUzMzcxMTQ4NTM=", "number": 51916, "title": "Adding `impl Add<char> for String` breaks code (adding an impl leads to breakage due to deref coercions)", "user": {"login": "LukasKalbertodt", "id": 7419664, "node_id": "MDQ6VXNlcjc0MTk2NjQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7419664?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LukasKalbertodt", "html_url": "https://github.com/LukasKalbertodt", "followers_url": "https://api.github.com/users/LukasKalbertodt/followers", "following_url": "https://api.github.com/users/LukasKalbertodt/following{/other_user}", "gists_url": "https://api.github.com/users/LukasKalbertodt/gists{/gist_id}", "starred_url": "https://api.github.com/users/LukasKalbertodt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LukasKalbertodt/subscriptions", "organizations_url": "https://api.github.com/users/LukasKalbertodt/orgs", "repos_url": "https://api.github.com/users/LukasKalbertodt/repos", "events_url": "https://api.github.com/users/LukasKalbertodt/events{/privacy}", "received_events_url": "https://api.github.com/users/LukasKalbertodt/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 13836860, "node_id": "MDU6TGFiZWwxMzgzNjg2MA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-traits", "name": "A-traits", "color": "f7e101", "default": false, "description": "Area: Trait system"}, {"id": 211668019, "node_id": "MDU6TGFiZWwyMTE2NjgwMTk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-lang", "name": "T-lang", "color": "bfd4f2", "default": false, "description": "Relevant to the language team, which will review and decide on the PR/issue."}, {"id": 604454086, "node_id": "MDU6TGFiZWw2MDQ0NTQwODY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-inference", "name": "A-inference", "color": "f7e101", "default": false, "description": "Area: Type inference"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 800802916, "node_id": "MDU6TGFiZWw4MDA4MDI5MTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-coercions", "name": "A-coercions", "color": "f7e101", "default": false, "description": "Area: implicit and explicit `expr as Type` coercions"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2018-06-29T19:40:25Z", "updated_at": "2022-11-17T17:49:27Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "I just prepared a PR to fix #38784. I wanted to add `Add<char>` and `AddAssign<char>` impls for String. However, this breaks the following code:\r\n\r\n```rust\r\nlet a = String::from(\"a\");\r\nlet b = String::from(\"b\");\r\na + &b;\r\n```\r\n\r\n([Playground](https://play.rust-lang.org/?gist=81fafb1dc39fdad9908b1e730985a589&version=nightly&mode=debug))\r\n\r\nApparently, without `Add<char>`, deref coercion is used to turn `&String` into `&str`. With the additional impl, deref coercion is no more and thus it results in:\r\n\r\n```\r\nerror[E0277]: cannot add `&std::string::String` to `std::string::String`\r\n[...]\r\n     = help: the trait `std::ops::Add<&std::string::String>` is not implemented for `std::string::String`\r\n```\r\n\r\nThis is unexpected, because [RFC 1105](https://github.com/rust-lang/rfcs/blob/master/text/1105-api-evolution.md) says that adding an implementing for a non-fundamental trait is a minor change and thus should not require a major version bump. But if I were to submit a PR which adds `Add<char> for String`, it would probably not be merged, because it breaks a bunch of crates. `a + &b` for `a` and `b` being `String` is widely used.\r\n\r\nI would have expected that either deref coercion wouldn't happen in cases where it influences the trait selection (in order to avoid this breakage) or that deref coercion would still happen if there is more than one `impl`. Since the former is not possible anymore, I think the latter is the solution to this problem.\r\n\r\nThe third option (I can see) would be to change RFC 1105 and amend a section about this special case.\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/51916/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/51916/timeline", "performed_via_github_app": null, "state_reason": null}