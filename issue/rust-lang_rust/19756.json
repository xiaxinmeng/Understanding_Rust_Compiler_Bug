{"url": "https://api.github.com/repos/rust-lang/rust/issues/19756", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/19756/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/19756/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/19756/events", "html_url": "https://github.com/rust-lang/rust/issues/19756", "id": 51739409, "node_id": "MDU6SXNzdWU1MTczOTQwOQ==", "number": 19756, "title": "deriving(Encodable) does not use emit_enum_struct_variant or emit_tuple_struct", "user": {"login": "emk", "id": 36963, "node_id": "MDQ6VXNlcjM2OTYz", "avatar_url": "https://avatars.githubusercontent.com/u/36963?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emk", "html_url": "https://github.com/emk", "followers_url": "https://api.github.com/users/emk/followers", "following_url": "https://api.github.com/users/emk/following{/other_user}", "gists_url": "https://api.github.com/users/emk/gists{/gist_id}", "starred_url": "https://api.github.com/users/emk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emk/subscriptions", "organizations_url": "https://api.github.com/users/emk/orgs", "repos_url": "https://api.github.com/users/emk/repos", "events_url": "https://api.github.com/users/emk/events{/privacy}", "received_events_url": "https://api.github.com/users/emk/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235146, "node_id": "MDU6TGFiZWwyMzUxNDY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-syntaxext", "name": "A-syntaxext", "color": "f7e101", "default": false, "description": "Area: Syntax extensions"}, {"id": 630652267, "node_id": "MDU6TGFiZWw2MzA2NTIyNjc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-feature-request", "name": "C-feature-request", "color": "f5f1fd", "default": false, "description": "Category: A feature request, i.e: not implemented / a PR."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 16, "created_at": "2014-12-11T21:20:33Z", "updated_at": "2017-12-03T01:07:43Z", "closed_at": "2017-12-03T01:07:43Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "This issue is closely related to #17158, but affects the proposed `RustcEncodable` trait which will be stabilized as part of the compiler for Rust 1.0.\n\nCurrently, the code which derives `Encodable` has a few weird design decisions:\n\n**1. Rust always uses `emit_enum_variant` instead of `emit_enum_struct_variant`.**\n\nIf we have a structure `ExEnum` as follows:\n\n``` rust\n#[deriving(Encodable)]\nenum ExEnum { Foo, Bar(f64), Baz{x: f64, y: f64} }\n```\n\n\u2026then both `Bar` and `Baz` will emit code to call `emit_enum_variant`. For example, JSON encoding will yield:\n\n```\n\"Foo\"\n{\"variant\":\"Bar\",\"fields\":[1]}\n{\"variant\":\"Baz\",\"fields\":[1,2]}\n```\n\nThis would probably look a lot nicer with `x:` and `y:` in the `Baz` case.\n\n**2. Rust will always use `emit_struct` instead of `emit_tuple_struct`**\n\n``` rust\n#[deriving(Encodable)]\nstruct ExTupleStruct(f64);\n```\n\nThis will encode to JSON as:\n\n```\n{\"_field0\":1}\n```\n\nThis is particularly unfortunate\u2014the resulting data would look nicer if it went through `emit_tuple_struct` and used some sort of array-based encoding.\n\n**Proposed fixes**\n\nI can see two ways forward:\n- Option 1: Officially drop `emit_enum_struct_variant` and `emit_tuple_struct` and always use `emit_enum_variant` and `emit_struct`.\n- Option 2: Fix the `Encoder` (or the new `RustcEncoder`) to use `emit_enum_struct_variant` and `emit_tuple_struct`.\n\nThe current behavior feels like an oversight, and (2) would allow for finer-grained control over the serialization and nicer JSON. If people agree that this should happen before 1.0, and that (2) is the better design, I'd be interested in tackling this as my first rustc contribution. \n", "closed_by": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/19756/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/19756/timeline", "performed_via_github_app": null, "state_reason": "completed"}