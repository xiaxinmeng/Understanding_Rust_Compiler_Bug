{"url": "https://api.github.com/repos/rust-lang/rust/issues/27878", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/27878/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/27878/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/27878/events", "html_url": "https://github.com/rust-lang/rust/issues/27878", "id": 101630136, "node_id": "MDU6SXNzdWUxMDE2MzAxMzY=", "number": 27878, "title": "Segfault in je_rallocx after pushing new value to Vec<u8> causing it to resize", "user": {"login": "ashleysommer", "id": 402468, "node_id": "MDQ6VXNlcjQwMjQ2OA==", "avatar_url": "https://avatars.githubusercontent.com/u/402468?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ashleysommer", "html_url": "https://github.com/ashleysommer", "followers_url": "https://api.github.com/users/ashleysommer/followers", "following_url": "https://api.github.com/users/ashleysommer/following{/other_user}", "gists_url": "https://api.github.com/users/ashleysommer/gists{/gist_id}", "starred_url": "https://api.github.com/users/ashleysommer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ashleysommer/subscriptions", "organizations_url": "https://api.github.com/users/ashleysommer/orgs", "repos_url": "https://api.github.com/users/ashleysommer/repos", "events_url": "https://api.github.com/users/ashleysommer/events{/privacy}", "received_events_url": "https://api.github.com/users/ashleysommer/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 14, "created_at": "2015-08-18T10:58:52Z", "updated_at": "2015-08-18T14:10:13Z", "closed_at": "2015-08-18T13:59:59Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Im getting this very interesting segfault when using with CStrings in a project Im working on.\n\n```\nProgram received signal SIGSEGV, Segmentation fault.\n0x0000555555574551 in je_rallocx ()\nMissing separate debuginfos, use: dnf debuginfo-install fcgi-2.4.0-28.fc23.x86_64\n(gdb) bt\n#0  0x0000555555574551 in je_rallocx ()\n#1  0x000055555555dfc3 in fcgi::heap::reallocate (ptr=0x5555557af9fc \"REQUEST_METHOD\", old_size=14, size=28, align=1) at ../src/liballoc/heap.rs:71\n#2  0x000055555555de5f in fcgi::raw_vec::RawVec<T>::double (self=0x7fffffffd188) at ../src/liballoc/raw_vec.rs:202\n#3  0x000055555555dbf1 in fcgi::vec::Vec<T>::push (self=0x7fffffffd188, value=0 '\\000') at ../src/libcollections/vec.rs:577\n#4  0x000055555555d8dc in fcgi::DefaultRequest.Request::get_param (self=0x7fffffffd868, name=...) at /home/flubba86/workspace/rust-fcgi/src/lib.rs:153\n#5  0x0000555555559c60 in testcase:main () at src/main.rs:19\n#6  0x000055555556abc5 in rt::unwind::try::try_fn::h5614954417008942540 ()\n#7  0x0000555555568829 in __rust_try ()\n#8  0x000055555556a8b2 in rt::lang_start::ha172a3ce74bb453aK5w ()\n#9  0x000055555555d0f7 in main ()\n```\n\nI am passing a static `&str` with the contents \"REQUEST_METHOD\" to `get_param()` in the fcgi lib. The `get_param()` method converts that to a CString using `CString::new()`. To do that, the rust CString `new()` constructor method first converts the &str into a `Vec<u8>` using `into()`. It then does a `.push(0)` to append a null char, then finally returns a new CString using `into_boxed_slice` on the Vec.\n\nThe error occurs on the `.push(0)` line [here](https://github.com/rust-lang/rust/blob/master/src/libstd/ffi/c_str.rs#L199). The `Vec<u8>` is created with an initial size being the length of the string, and to add the new char it must call `double()` on the Vec to make it bigger. When it does that, the allocator segfaults during the jemalloc reallocation call.\n\nI isolated the issue further by first converting the `&str` to a `Vec<u8>` myself then doing `.push(0)` on it before passing it to the CString constructor. The push() still crashes when reallocating, as seen in the pasted trace above.\n\nI cannot however, create a minimal reproduction of the error. It only does it in this one library. I have tried multiple basic test cases and they all seem to work fine.\n\nI was using a Nightly from Saturday the 15th of August and I just updated to the Current nightly  (18th of August) and it is still the same.\n\nAny suggestions on how I can further debug this? Temporarily, is there any way of creating a CString from a &str without using an intermediate Vec<u8>?\n", "closed_by": {"login": "bluss", "id": 3209739, "node_id": "MDQ6VXNlcjMyMDk3Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bluss", "html_url": "https://github.com/bluss", "followers_url": "https://api.github.com/users/bluss/followers", "following_url": "https://api.github.com/users/bluss/following{/other_user}", "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}", "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bluss/subscriptions", "organizations_url": "https://api.github.com/users/bluss/orgs", "repos_url": "https://api.github.com/users/bluss/repos", "events_url": "https://api.github.com/users/bluss/events{/privacy}", "received_events_url": "https://api.github.com/users/bluss/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/27878/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/27878/timeline", "performed_via_github_app": null, "state_reason": "completed"}