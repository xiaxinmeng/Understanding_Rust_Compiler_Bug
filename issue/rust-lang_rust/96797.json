{"url": "https://api.github.com/repos/rust-lang/rust/issues/96797", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/96797/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/96797/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/96797/events", "html_url": "https://github.com/rust-lang/rust/issues/96797", "id": 1228484989, "node_id": "I_kwDOAAsO6M5JOTF9", "number": 96797, "title": "Functions referenced by `global_asm` merged into other functions by LLVM", "user": {"login": "nbdd0121", "id": 4065244, "node_id": "MDQ6VXNlcjQwNjUyNDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4065244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nbdd0121", "html_url": "https://github.com/nbdd0121", "followers_url": "https://api.github.com/users/nbdd0121/followers", "following_url": "https://api.github.com/users/nbdd0121/following{/other_user}", "gists_url": "https://api.github.com/users/nbdd0121/gists{/gist_id}", "starred_url": "https://api.github.com/users/nbdd0121/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nbdd0121/subscriptions", "organizations_url": "https://api.github.com/users/nbdd0121/orgs", "repos_url": "https://api.github.com/users/nbdd0121/repos", "events_url": "https://api.github.com/users/nbdd0121/events{/privacy}", "received_events_url": "https://api.github.com/users/nbdd0121/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 91598611, "node_id": "MDU6TGFiZWw5MTU5ODYxMQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-inline-assembly", "name": "A-inline-assembly", "color": "f7e101", "default": false, "description": "Area: inline asm!(..)"}, {"id": 2046313052, "node_id": "MDU6TGFiZWwyMDQ2MzEzMDUy", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-asm", "name": "F-asm", "color": "f9c0cc", "default": false, "description": "`#![feature(asm)]` (not `llvm_asm`)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2022-05-07T01:20:19Z", "updated_at": "2022-07-21T16:21:17Z", "closed_at": "2022-07-21T16:21:17Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "```rust\r\n#![feature(asm_sym)]\r\n\r\nuse std::arch::global_asm;\r\n\r\n#[no_mangle]\r\nfn my_func() {}\r\n\r\nglobal_asm!(\"call_foobar: jmp {}\", sym foobar);\r\n\r\nfn foobar() {}\r\n\r\nfn main() {\r\n    extern \"Rust\" {\r\n        fn call_foobar();\r\n    }\r\n    unsafe { call_foobar() };\r\n}\r\n```\r\nThis code will fail to link because `foobar` is merged into `my_func`.\r\n\r\nSince global asms in LLVM can't reference symbols natively, we currently will add the mangled name to the string and pass it to LLVM. To prevent the file being optimized away, we add it to `llvm.compiler.used`.\r\n\r\nA few issues exist:\r\n* `rustc_monomorphize` does not handle these functions specially, and therefore `foobar` above is considered as internal function and have `internal` attribute attached.\r\n* LLVM believes that it is allowed to merge internal functions into an exported function despite present in `llvm.compiler.used`. I think LLVM should be allowed to this because we emit the internal linkage, and from my understanding renaming a local symbol should probably be allowed. @tmiasko argues otherwise and says that `llvm.compiler.used` shouldn't touch the symbol.\r\n* The symbols are added `llvm.compiler.used`, but it wouldn't show up as used in the exported symbol list, so it can still be stripped while doing LTO.\r\n\r\nWe should do the following:\r\n* [ ] Ensure that these functions are not emitted with internal linkage\r\n* [ ] Ensrue that the functions used will be marked as used in `exported_symbols/linked_symbols` and thus reach the linker/LTO.\r\n* [ ] Ask LLVM to clarify the behaviour of combining `llvm.compiler.used` + `internal` .\r\n\r\ncc @Amanieu @tmiasko \r\n@rustbot label: +A-inline-assembly +F-asm\r\n\r\nThis will block #93333", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/96797/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/96797/timeline", "performed_via_github_app": null, "state_reason": "completed"}