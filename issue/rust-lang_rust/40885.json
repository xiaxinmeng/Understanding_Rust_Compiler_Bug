{"url": "https://api.github.com/repos/rust-lang/rust/issues/40885", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/40885/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/40885/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/40885/events", "html_url": "https://github.com/rust-lang/rust/issues/40885", "id": 217736635, "node_id": "MDU6SXNzdWUyMTc3MzY2MzU=", "number": 40885, "title": "Compiler crashes when using object instead of reference to object for input to inline assembly", "user": {"login": "SKTech8462", "id": 26754421, "node_id": "MDQ6VXNlcjI2NzU0NDIx", "avatar_url": "https://avatars.githubusercontent.com/u/26754421?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SKTech8462", "html_url": "https://github.com/SKTech8462", "followers_url": "https://api.github.com/users/SKTech8462/followers", "following_url": "https://api.github.com/users/SKTech8462/following{/other_user}", "gists_url": "https://api.github.com/users/SKTech8462/gists{/gist_id}", "starred_url": "https://api.github.com/users/SKTech8462/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SKTech8462/subscriptions", "organizations_url": "https://api.github.com/users/SKTech8462/orgs", "repos_url": "https://api.github.com/users/SKTech8462/repos", "events_url": "https://api.github.com/users/SKTech8462/events{/privacy}", "received_events_url": "https://api.github.com/users/SKTech8462/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 91598611, "node_id": "MDU6TGFiZWw5MTU5ODYxMQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-inline-assembly", "name": "A-inline-assembly", "color": "f7e101", "default": false, "description": "Area: inline asm!(..)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-03-29T01:09:27Z", "updated_at": "2018-09-24T18:50:28Z", "closed_at": "2018-09-24T18:50:28Z", "author_association": "NONE", "active_lock_reason": null, "body": "Compiler crashes when using object instead of reference to object for input to inline assembly\r\n\r\nRan into this while trying to use Intel's lidt instruction. It takes a single operand (the address to a structure in memory containing the size and location of your new Interrupt Descriptor Table) and loads the new IDT. I had mistakenly given the struct object as an input instead of a reference to the struct object and compiling that inline asm statement caused the compiler to crash.\r\n\r\nHere's the code with the asm! line that crashed the compiler:\r\n```\r\nunsafe fn load(&self) {\r\n    let idtr = IDTR { size: (41*16)-1, offset: ((self as *const IDT) as u64) };\r\n    asm!(\"lidt ($0)\" :: \"r\"(idtr) : \"memory\");\r\n  }\r\n```\r\n\r\n\r\nHere's the fixed code that works:\r\n```\r\nunsafe fn load(&self) {\r\n    let idtr = IDTR { size: (41*16)-1, offset: ((self as *const IDT) as u64) };\r\n    asm!(\"lidt ($0)\" :: \"r\"(&idtr) : \"memory\");\r\n  }\r\n```\r\n\r\n\r\nHere's the error I got:\r\n\r\n```\r\nerror: internal compiler error: /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_trans/mir/operand.rs:83: not immediate: OperandRef(Pair((i16:  %8 = load i16, i16* %6, !dbg !45), (i64:  %9 = load i64, i64* %7, !dbg !45)) @ IDTR)\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n```\r\n\r\n\r\nHere's the backtrace:\r\n```\r\nthread 'rustc' panicked at 'Box<Any>', /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_errors/lib.rs:423\r\nstack backtrace:\r\n   1:     0x7f123b601fbc - std::sys::imp::backtrace::tracing::imp::write::h9c41d2f69e5caabf\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/sys/unix/backtrace/tracing/gcc_s.rs:42\r\n   2:     0x7f123b61043e - std::panicking::default_hook::{{closure}}::h1f61f3c769fffe7a\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:351\r\n   3:     0x7f123b60ffe3 - std::panicking::default_hook::hd5bda4e453dfb4be\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:361\r\n   4:     0x7f123b6108db - std::panicking::rust_panic_with_hook::hffbc74969c7b5d87\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:555\r\n   5:     0x7f1233c819fa - std::panicking::begin_panic::h74ad4f050841c998\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:517\r\n   6:     0x7f1233c968bd - rustc_errors::Handler::bug::h7088c6afc4a008fb\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_errors/lib.rs:423\r\n   7:     0x7f1238987091 - rustc::session::opt_span_bug_fmt::{{closure}}::h8e30a0fda5e6d8ea\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc/session/mod.rs:788\r\n   8:     0x7f1238986eae - rustc::session::opt_span_bug_fmt::h4fd6d943719c63ae\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc/ty/context.rs:1003\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc/session/mod.rs:784\r\n   9:     0x7f1238986b12 - rustc::session::bug_fmt::he01375c3004c5cfe\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc/session/mod.rs:768\r\n  10:     0x7f123ad4e429 - rustc_trans::mir::rvalue::<impl rustc_trans::mir::MirContext<'a, 'tcx>>::trans_rvalue::h7dc15384ecc85210\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_trans/mir/operand.rs:83\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_trans/mir/rvalue.rs:162\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libcore/ops.rs:2706\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libcore/option.rs:383\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libcore/iter/mod.rs:999\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libcollections/vec.rs:1655\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libcollections/vec.rs:1638\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libcollections/vec.rs:1525\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libcore/iter/iterator.rs:1218\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_trans/mir/rvalue.rs:161\r\n  11:     0x7f123ad3a16d - rustc_trans::mir::block::<impl rustc_trans::mir::MirContext<'a, 'tcx>>::trans_block::h31596f784d651219\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_trans/mir/statement.rs:35\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_trans/mir/block.rs:109\r\n  12:     0x7f123ad37cf1 - rustc_trans::mir::trans_mir::h7e5fc59940d6977e\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_trans/mir/mod.rs:337\r\n  13:     0x7f123ad58d77 - rustc_trans::trans_item::TransItem::define::h929f421e720c71df\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_trans/base.rs:596\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_trans/trans_item.rs:88\r\n  14:     0x7f123acdbfcc - rustc_trans::base::trans_crate::h496d157cb52a4b02\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_trans/base.rs:1218\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc/dep_graph/graph.rs:83\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_trans/base.rs:1216\r\n  15:     0x7f123b9c0ffd - rustc_driver::driver::phase_4_translate_to_llvm::h106eb073675c3bee\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/driver.rs:1046\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc/util/common.rs:48\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/driver.rs:1044\r\n  16:     0x7f123b990bad - rustc_driver::driver::compile_input::{{closure}}::hf0a8bd39d338ce94\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/driver.rs:200\r\n  17:     0x7f123b9b4e35 - rustc_driver::driver::phase_3_run_analysis_passes::{{closure}}::haccf5097991f72ff\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/driver.rs:992\r\n  18:     0x7f123b9a44dc - rustc_driver::driver::phase_3_run_analysis_passes::hc8affcb7a7c3c449\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc/ty/context.rs:974\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/thread/local.rs:253\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc/ty/context.rs:971\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc/ty/context.rs:958\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/thread/local.rs:253\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc/ty/context.rs:955\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc/ty/context.rs:733\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/driver.rs:867\r\n  19:     0x7f123b98ebd6 - rustc_driver::driver::compile_input::h44853ffed84a12cb\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/driver.rs:166\r\n  20:     0x7f123b9d5558 - rustc_driver::run_compiler::hdc4bb0fcf7d0917a\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/lib.rs:221\r\n  21:     0x7f123b8e2948 - std::panicking::try::do_call::ha583797d32a865bd\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/lib.rs:1119\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/lib.rs:137\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/lib.rs:1053\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panic.rs:296\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:460\r\n  22:     0x7f123b61975a - __rust_maybe_catch_panic\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libpanic_unwind/lib.rs:98\r\n  23:     0x7f123b90be1b - <F as alloc::boxed::FnBox<A>>::call_box::h6903719257a678be\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:436\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panic.rs:361\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/thread/mod.rs:357\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/liballoc/boxed.rs:605\r\n  24:     0x7f123b60f294 - std::sys::imp::thread::Thread::new::thread_start::h76badbf9b0ecaf58\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/liballoc/boxed.rs:615\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/sys_common/thread.rs:21\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/sys/unix/thread.rs:84\r\n  25:     0x7f123342d0a3 - start_thread\r\n  26:     0x7f123b2c662c - clone\r\n  27:                0x0 - <unknown>\r\n\r\nerror: Could not compile `interrupt_handler`.\r\n```", "closed_by": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/40885/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/40885/timeline", "performed_via_github_app": null, "state_reason": "completed"}