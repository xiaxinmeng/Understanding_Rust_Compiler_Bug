{"url": "https://api.github.com/repos/rust-lang/rust/issues/64629", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/64629/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/64629/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/64629/events", "html_url": "https://github.com/rust-lang/rust/issues/64629", "id": 496261487, "node_id": "MDU6SXNzdWU0OTYyNjE0ODc=", "number": 64629, "title": "Rust should not link sanitizer runtimes unconditionally", "user": {"login": "choller", "id": 1140686, "node_id": "MDQ6VXNlcjExNDA2ODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1140686?v=4", "gravatar_id": "", "url": "https://api.github.com/users/choller", "html_url": "https://github.com/choller", "followers_url": "https://api.github.com/users/choller/followers", "following_url": "https://api.github.com/users/choller/following{/other_user}", "gists_url": "https://api.github.com/users/choller/gists{/gist_id}", "starred_url": "https://api.github.com/users/choller/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/choller/subscriptions", "organizations_url": "https://api.github.com/users/choller/orgs", "repos_url": "https://api.github.com/users/choller/repos", "events_url": "https://api.github.com/users/choller/events{/privacy}", "received_events_url": "https://api.github.com/users/choller/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 630870359, "node_id": "MDU6TGFiZWw2MzA4NzAzNTk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-sanitizers", "name": "A-sanitizers", "color": "f7e101", "default": false, "description": "Area: Sanitizers for correctness and code quality."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2019-09-20T09:58:27Z", "updated_at": "2020-10-23T14:22:46Z", "closed_at": "2020-10-23T14:22:46Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I've noticed today that apparently Rust adds sanitizer runtimes such as the ASan runtime during linking and I found this runtime inside a static archive.\r\n\r\nAs far as I know, these runtimes should not be part of static archives or DSOs, they should only be linked when creating an executable. Adding them to DSOs causes two runtimes to exist when loading the DSO into an ASan binary (we had this problem longer ago in mozilla-central and it was fixed in Clang, see [1]). Adding the runtime to static archives causes linker problems when linking the archive to a C++ binary built with ASan because Clang will add the ASan runtime a second time when linking the executable. For some reason this worked before (maybe if the runtimes used are exactly identical the linker will deduplicate them) but today during building with Rust nightly I got duplicate symbol errors indicating two conflicting ASan RTs.\r\n\r\nFrom what I can tell, Rust should not link these runtimes except if it is producing an executable. The respective code is called here independent of `crate_type`:\r\n\r\nhttps://github.com/rust-lang/rust/blob/ea3ba36f3f4b7f0168a27d23c499efeb2304e2d5/src/librustc_codegen_ssa/back/link.rs#L1376\r\n\r\n\r\n[1] https://github.com/llvm-mirror/clang/blob/7dbdcfcb827c68b0c380de289a2d7526666b8771/lib/Driver/ToolChains/CommonArgs.cpp#L645", "closed_by": {"login": "Dylan-DPC-zz", "id": 12371125, "node_id": "MDQ6VXNlcjEyMzcxMTI1", "avatar_url": "https://avatars.githubusercontent.com/u/12371125?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC-zz", "html_url": "https://github.com/Dylan-DPC-zz", "followers_url": "https://api.github.com/users/Dylan-DPC-zz/followers", "following_url": "https://api.github.com/users/Dylan-DPC-zz/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC-zz/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC-zz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC-zz/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC-zz/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC-zz/repos", "events_url": "https://api.github.com/users/Dylan-DPC-zz/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC-zz/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/64629/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/64629/timeline", "performed_via_github_app": null, "state_reason": "completed"}