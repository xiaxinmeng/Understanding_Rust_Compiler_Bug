{"url": "https://api.github.com/repos/rust-lang/rust/issues/96231", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/96231/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/96231/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/96231/events", "html_url": "https://github.com/rust-lang/rust/issues/96231", "id": 1208982910, "node_id": "I_kwDOAAsO6M5ID51-", "number": 96231, "title": "Array `map` with unexpectedly bad codegen", "user": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2022-04-20T00:03:37Z", "updated_at": "2022-07-10T20:45:57Z", "closed_at": "2022-07-10T20:45:56Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "**Note:** I am aware of #91521 and related issues for this function, and believe that this has a separate cause\r\n\r\nI tried this code:\r\n\r\n```rust\r\npub fn foo<'a>(n: [*const u8; 2]) -> [&'a u8; 2] {\r\n    n.map(|p| unsafe { &*p })\r\n}\r\n```\r\n\r\nAssembly (`rustc -Copt-level=3 -Cdebuginfo=0 --edition 2021`, [godbolt](https://godbolt.org/z/5cPYMnq1Y)):\r\n```rust\r\nexample::foo:\r\n        mov     rax, rdi\r\n        mov     rcx, qword ptr [rsi]\r\n        mov     rdx, qword ptr [rsi + 8]\r\n        test    rdx, rdx\r\n        mov     rsi, rcx\r\n        cmove   rsi, rdx\r\n        test    rcx, rcx\r\n        cmove   rsi, rcx\r\n        mov     qword ptr [rdi], rsi\r\n        mov     qword ptr [rdi + 8], rdx\r\n        ret\r\n```\r\n\r\nThe interesting thing to note here is the comparisons, which should definitely not be there. This problem significantly worsens when you [increase the number of elements](https://godbolt.org/z/8hdbGPMWd). I believe the source of these comparisons is that `map` is implemented via an iterator, which means that we build an `Option<&u8>` at some point. Still though, the LLVM IR:\r\n\r\n<details>\r\n<summary> LLVM IR </summary>\r\n\r\n```llvm\r\ndefine void @_ZN7example3foo17h2b4bd706abe6f6b0E([2 x i8*]* noalias nocapture noundef writeonly sret([2 x i8*]) dereferenceable(16) %0, [2 x i8*]* noalias nocapture noundef readonly dereferenceable(16) %n) unnamed_addr #0 personality i32 (i32, i32, i64, %\"unwind::libunwind::_Unwind_Exception\"*, %\"unwind::libunwind::_Unwind_Context\"*)* @rust_eh_personality {\r\n  %_2.sroa.0.0..sroa_cast = bitcast [2 x i8*]* %n to i64*\r\n  %_2.sroa.0.0.copyload = load i64, i64* %_2.sroa.0.0..sroa_cast, align 8\r\n  %_2.sroa.4.0..sroa_idx2 = getelementptr inbounds [2 x i8*], [2 x i8*]* %n, i64 0, i64 1\r\n  %_2.sroa.4.0..sroa_cast = bitcast i8** %_2.sroa.4.0..sroa_idx2 to i64*\r\n  %_2.sroa.4.0.copyload = load i64, i64* %_2.sroa.4.0..sroa_cast, align 8\r\n  %.not.i.i.i.not.i = icmp eq i64 %_2.sroa.0.0.copyload, 0\r\n  %.not.1.i.i.i.i = icmp eq i64 %_2.sroa.4.0.copyload, 0\r\n  %or.cond.i = select i1 %.not.i.i.i.not.i, i1 true, i1 %.not.1.i.i.i.i\r\n  %1 = inttoptr i64 %_2.sroa.4.0.copyload to i8*\r\n  %2 = inttoptr i64 %_2.sroa.0.0.copyload to {}*\r\n  %_2.sroa.6.0.i.i.i = select i1 %or.cond.i, i8* undef, i8* %1\r\n  %_2.sroa.0.0.i.i.i = select i1 %or.cond.i, {}* null, {}* %2\r\n  %3 = icmp ne {}* %_2.sroa.0.0.i.i.i, null\r\n  tail call void @llvm.assume(i1 %3) #3\r\n  %_4.sroa.0.0..sroa_cast.i.i = bitcast [2 x i8*]* %0 to {}**\r\n  store {}* %_2.sroa.0.0.i.i.i, {}** %_4.sroa.0.0..sroa_cast.i.i, align 8, !alias.scope !2, !noalias !7\r\n  %_4.sroa.4.0..sroa_idx4.i.i = getelementptr inbounds [2 x i8*], [2 x i8*]* %0, i64 0, i64 1\r\n  store i8* %_2.sroa.6.0.i.i.i, i8** %_4.sroa.4.0..sroa_idx4.i.i, align 8, !alias.scope !2, !noalias !7\r\n  ret void\r\n}\r\n```\r\n</details>\r\n\r\nDoes look to have all the information necessary to continue optimizing.\r\n\r\n### Meta\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.62.0-nightly (ec77f2524 2022-04-17)\r\nbinary: rustc\r\ncommit-hash: ec77f252434a532fdb5699ae4f21a3072d211edd\r\ncommit-date: 2022-04-17\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.62.0-nightly\r\nLLVM version: 14.0.0\r\n```\r\n\r\n@rustbot labels +A-llvm +I-slow\r\n", "closed_by": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/96231/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/96231/timeline", "performed_via_github_app": null, "state_reason": "completed"}