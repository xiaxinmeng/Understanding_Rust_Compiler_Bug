{"url": "https://api.github.com/repos/rust-lang/rust/issues/110487", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/110487/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/110487/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/110487/events", "html_url": "https://github.com/rust-lang/rust/issues/110487", "id": 1672740836, "node_id": "I_kwDOAAsO6M5js__k", "number": 110487, "title": "Bad coverage with macro_rules!", "user": {"login": "def-", "id": 2335377, "node_id": "MDQ6VXNlcjIzMzUzNzc=", "avatar_url": "https://avatars.githubusercontent.com/u/2335377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/def-", "html_url": "https://github.com/def-", "followers_url": "https://api.github.com/users/def-/followers", "following_url": "https://api.github.com/users/def-/following{/other_user}", "gists_url": "https://api.github.com/users/def-/gists{/gist_id}", "starred_url": "https://api.github.com/users/def-/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/def-/subscriptions", "organizations_url": "https://api.github.com/users/def-/orgs", "repos_url": "https://api.github.com/users/def-/repos", "events_url": "https://api.github.com/users/def-/events{/privacy}", "received_events_url": "https://api.github.com/users/def-/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2483744621, "node_id": "MDU6TGFiZWwyNDgzNzQ0NjIx", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-code-coverage", "name": "A-code-coverage", "color": "f7e101", "default": false, "description": "Area: Source-based code coverage (-Cinstrument-coverage)"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2023-04-18T09:45:59Z", "updated_at": "2023-04-18T14:29:52Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I tried this code:\r\n\r\n```rust\r\n// Foo\r\n// Foo\r\n// Foo\r\n// Foo\r\n// Foo\r\n// Foo\r\n// Foo\r\n// This is a simple macro named `say_hello`.\r\nmacro_rules! say_hello {\r\n    // `()` indicates that the macro takes no argument.\r\n    () => {\r\n        // The macro will expand into the contents of this block.\r\n        println!(\"Hello!\");\r\n    };\r\n}\r\n\r\nfn main() {\r\n    // This call will expand into `println!(\"Hello\");`\r\n    say_hello!()\r\n}\r\n```\r\nAnd ran: `RUSTFLAGS=\"-C instrument-coverage\" cargo run && rust-profdata merge -sparse -o 1.profdata **/*.profraw && rust-cov show target/debug/deps/coverage_mini-280555d4395f82aa --instr-profile 1.profdata main.rs`\r\nI expected to see say_hello be covered or uncovered, the comments should have no coverage associated.\r\n\r\nInstead, I got this output:\r\n```\r\n    1|      0|// Foo\r\n    2|       |// Foo\r\n    3|       |// Foo\r\n    4|       |// Foo\r\n    5|      0|// Foo\r\n    6|      0|// Foo\r\n    7|      0|// Foo\r\n    8|       |// This is a simple macro named `say_hello`.\r\n    9|       |macro_rules! say_hello {\r\n   10|       |    // `()` indicates that the macro takes no argument.\r\n   11|       |    () => {\r\n   12|       |        // The macro will expand into the contents of this block.\r\n   13|      0|        println!(\"Hello!\");\r\n   14|      0|    };\r\n   15|      0|}\r\n   16|      0|\r\n   17|       |fn main() {\r\n   18|       |    // This call will expand into `println!(\"Hello\");`\r\n   19|       |    say_hello!()\r\n   20|       |}\r\n```\r\nSo it seems that the coverage information gets confused by the macro and now considers the comments as somehow executable. The main function isn't even shown as coverable anymore.\r\n\r\nThe displayed blocks make no sense as well:\r\n\r\n![Screenshot 2023-04-18 at 11 45 22](https://user-images.githubusercontent.com/2335377/232739130-48fbbdae-630d-4ef6-9502-9a8e806b249a.png)\r\n\r\n### Meta\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.71.0-nightly (7908a1d65 2023-04-17)\r\nbinary: rustc\r\ncommit-hash: 7908a1d65496b88626e4b7c193c81d777005d6f3\r\ncommit-date: 2023-04-17\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.71.0-nightly\r\nLLVM version: 16.0.2\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/110487/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/110487/timeline", "performed_via_github_app": null, "state_reason": null}