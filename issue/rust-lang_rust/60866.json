{"url": "https://api.github.com/repos/rust-lang/rust/issues/60866", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/60866/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/60866/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/60866/events", "html_url": "https://github.com/rust-lang/rust/issues/60866", "id": 444690960, "node_id": "MDU6SXNzdWU0NDQ2OTA5NjA=", "number": 60866, "title": "__imp___xxx is found in rust lib, however __imp__xxx is wanted when compiling my rust project", "user": {"login": "chandde", "id": 3334913, "node_id": "MDQ6VXNlcjMzMzQ5MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/3334913?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chandde", "html_url": "https://github.com/chandde", "followers_url": "https://api.github.com/users/chandde/followers", "following_url": "https://api.github.com/users/chandde/following{/other_user}", "gists_url": "https://api.github.com/users/chandde/gists{/gist_id}", "starred_url": "https://api.github.com/users/chandde/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chandde/subscriptions", "organizations_url": "https://api.github.com/users/chandde/orgs", "repos_url": "https://api.github.com/users/chandde/repos", "events_url": "https://api.github.com/users/chandde/events{/privacy}", "received_events_url": "https://api.github.com/users/chandde/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2019-05-15T23:39:32Z", "updated_at": "2019-05-16T23:34:55Z", "closed_at": "2019-05-16T23:34:55Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Hello\r\n\r\nI was trying to build rustc target for thumbv7a-pc-windows-msvc locally, with a patch to compiler-builtins from this PR https://github.com/rust-lang-nursery/compiler-builtins/pull/293, also hacked panic_unwind for thumbv7a similar to what we have for aarch64, https://github.com/rust-lang/rust/blob/master/src/libtest/lib.rs#L45, and I was able to build the target thumbv7a-pc-windows-msvc successfully, with below build command,\r\n`c:\\python27\\python.exe x.py build --host x86_64-pc-windows-msvc --build x86_64-pc-windows-msvc --target thumbv7a-pc-windows-msvc --verbose`\r\n\r\nAfter the build I tried to use my private tool chain to build some other rust projects, e.g. [iotedged-eventlog-messages](https://github.com/Azure/iotedge/tree/master/edgelet/iotedged-eventlog-messages), I received below build errors. I used a few different ways to merge artifacts from different stages\r\n1. use only stage1, does not even recognize thumbv7a\r\n2. copy stage2 over stage1, overwrite anything with same name that exists in stage1, I got below error\r\n3. the other way of #2, same error.\r\n\r\n```\r\n   Compiling iotedged-eventlog-messages v0.1.0 (D:\\git\\iotedge\\edgelet\\iotedged-eventlog-messages)\r\n     Running `rustc --edition=2018 --crate-name iotedged_eventlog_messages iotedged-eventlog-messages\\src\\lib.rs --color always --crate-type cdylib --emit=dep-info,link -C opt-level=3 -C metadata=7b3a2d69b8dc278f --out-dir D:\\git\\iotedge\\edgelet\\target\\thumbv7a-pc-windows-msvc\\release\\deps --target thumbv7a-pc-windows-msvc -L dependency=D:\\git\\iotedge\\edgelet\\target\\thumbv7a-pc-windows-msvc\\release\\deps -L dependency=D:\\git\\iotedge\\edgelet\\target\\release\\deps -L all=D:\\git\\iotedge\\edgelet\\target\\thumbv7a-pc-windows-msvc\\release\\build\\iotedged-eventlog-messages-7acc25993b93c4f2\\out -l event_messages.res`\r\nerror: linking with `link.exe` failed: exit code: 1120\r\n  |\r\n  = note: \"C:\\\\Program Files (x86)\\\\Microsoft Visual Studio\\\\2017\\\\Enterprise\\\\VC\\\\Tools\\\\MSVC\\\\14.16.27023\\\\bin\\\\HostX64\\\\arm\\\\link.exe\" \"/NOLOGO\" \"/NXCOMPAT\" \"/OPT:NOLBR\" \"/LIBPATH:E:\\\\rustc\\\\mixed2\\\\lib\\\\rustlib\\\\thumbv7a-pc-windows-msvc\\\\lib\" \"D:\\\\git\\\\iotedge\\\\edgelet\\\\target\\\\thumbv7a-pc-windows-msvc\\\\release\\\\deps\\\\iotedged_eventlog_messages.iotedged_eventlog_messages.cr16zstb-cgu.0.rcgu.o\" \"/OUT:D:\\\\git\\\\iotedge\\\\edgelet\\\\target\\\\thumbv7a-pc-windows-msvc\\\\release\\\\deps\\\\iotedged_eventlog_messages.dll\" \"/DEF:C:\\\\Users\\\\chandde\\\\AppData\\\\Local\\\\Temp\\\\rustcLXLSml\\\\lib.def\" \"D:\\\\git\\\\iotedge\\\\edgelet\\\\target\\\\thumbv7a-pc-windows-msvc\\\\release\\\\deps\\\\iotedged_eventlog_messages.28a4ogesychbfxh1.rcgu.o\" \"/OPT:REF,ICF\" \"/DEBUG\" \"/LIBPATH:D:\\\\git\\\\iotedge\\\\edgelet\\\\target\\\\thumbv7a-pc-windows-msvc\\\\release\\\\deps\" \"/LIBPATH:D:\\\\git\\\\iotedge\\\\edgelet\\\\target\\\\release\\\\deps\" \"/LIBPATH:D:\\\\git\\\\iotedge\\\\edgelet\\\\target\\\\thumbv7a-pc-windows-msvc\\\\release\\\\build\\\\iotedged-eventlog-messages-7acc25993b93c4f2\\\\out\" \"/LIBPATH:E:\\\\rustc\\\\mixed2\\\\lib\\\\rustlib\\\\thumbv7a-pc-windows-msvc\\\\lib\" \"event_messages.res.lib\" \"E:\\\\rustc\\\\mixed2\\\\lib\\\\rustlib\\\\thumbv7a-pc-windows-msvc\\\\lib\\\\libstd-67da064321eabc9f.rlib\" \"E:\\\\rustc\\\\mixed2\\\\lib\\\\rustlib\\\\thumbv7a-pc-windows-msvc\\\\lib\\\\libpanic_abort-9adb8660ecc33a7a.rlib\" \"E:\\\\rustc\\\\mixed2\\\\lib\\\\rustlib\\\\thumbv7a-pc-windows-msvc\\\\lib\\\\librustc_demangle-df85f75ef53673fc.rlib\" \"E:\\\\rustc\\\\mixed2\\\\lib\\\\rustlib\\\\thumbv7a-pc-windows-msvc\\\\lib\\\\libhashbrown-9bd3a3fbf8f3ed5e.rlib\" \"E:\\\\rustc\\\\mixed2\\\\lib\\\\rustlib\\\\thumbv7a-pc-windows-msvc\\\\lib\\\\librustc_std_workspace_alloc-edfd9642cc94109d.rlib\" \"E:\\\\rustc\\\\mixed2\\\\lib\\\\rustlib\\\\thumbv7a-pc-windows-msvc\\\\lib\\\\libunwind-3ac22205e93ddd40.rlib\" \"E:\\\\rustc\\\\mixed2\\\\lib\\\\rustlib\\\\thumbv7a-pc-windows-msvc\\\\lib\\\\liblibc-1287bf1fe4191b4b.rlib\" \"E:\\\\rustc\\\\mixed2\\\\lib\\\\rustlib\\\\thumbv7a-pc-windows-msvc\\\\lib\\\\liballoc-822d54421becb1c7.rlib\" \"E:\\\\rustc\\\\mixed2\\\\lib\\\\rustlib\\\\thumbv7a-pc-windows-msvc\\\\lib\\\\librustc_std_workspace_core-d51e26897332c0c9.rlib\" \"E:\\\\rustc\\\\mixed2\\\\lib\\\\rustlib\\\\thumbv7a-pc-windows-msvc\\\\lib\\\\libcore-1fdb51d4e6dfea00.rlib\" \"E:\\\\rustc\\\\mixed2\\\\lib\\\\rustlib\\\\thumbv7a-pc-windows-msvc\\\\lib\\\\libcompiler_builtins-32eb33d96a637274.rlib\" \"advapi32.lib\" \"ws2_32.lib\" \"userenv.lib\" \"msvcrt.lib\" \"/DLL\" \"/IMPLIB:D:\\\\git\\\\iotedge\\\\edgelet\\\\target\\\\thumbv7a-pc-windows-msvc\\\\release\\\\deps\\\\iotedged_eventlog_messages.dll.lib\"\r\n  = note:    Creating library D:\\git\\iotedge\\edgelet\\target\\thumbv7a-pc-windows-msvc\\release\\deps\\iotedged_eventlog_messages.dll.lib and object D:\\git\\iotedge\\edgelet\\target\\thumbv7a-pc-windows-msvc\\release\\deps\\iotedged_eventlog_messages.dll.exp\r\n          libstd-67da064321eabc9f.rlib(std-67da064321eabc9f.std.38mh430v-cgu.5.rcgu.o) : error LNK2019: unresolved external symbol __imp__ZN5alloc11collections5btree4node15EMPTY_ROOT_NODE17h486b4088caeaa846E referenced in function _ZN3std3sys7windows7process7Command3new17hc990fb56302414eaE\r\n          libstd-67da064321eabc9f.rlib(std-67da064321eabc9f.std.38mh430v-cgu.12.rcgu.o) : error LNK2001: unresolved external symbol __imp__ZN5alloc11collections5btree4node15EMPTY_ROOT_NODE17h486b4088caeaa846E\r\n          libstd-67da064321eabc9f.rlib(std-67da064321eabc9f.std.38mh430v-cgu.14.rcgu.o) : error LNK2001: unresolved external symbol __imp__ZN5alloc11collections5btree4node15EMPTY_ROOT_NODE17h486b4088caeaa846E\r\n          libstd-67da064321eabc9f.rlib(std-67da064321eabc9f.std.38mh430v-cgu.0.rcgu.o) : error LNK2001: unresolved external symbol __imp__ZN5alloc11collections5btree4node15EMPTY_ROOT_NODE17h486b4088caeaa846E\r\n          D:\\git\\iotedge\\edgelet\\target\\thumbv7a-pc-windows-msvc\\release\\deps\\iotedged_eventlog_messages.dll : fatal error LNK1120: 1 unresolved externals\r\n\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: Could not compile `iotedged-eventlog-messages`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --edition=2018 --crate-name iotedged_eventlog_messages iotedged-eventlog-messages\\src\\lib.rs --color always --crate-type cdylib --emit=dep-info,link -C opt-level=3 -C metadata=7b3a2d69b8dc278f --out-dir D:\\git\\iotedge\\edgelet\\target\\thumbv7a-pc-windows-msvc\\release\\deps --target thumbv7a-pc-windows-msvc -L dependency=D:\\git\\iotedge\\edgelet\\target\\thumbv7a-pc-windows-msvc\\release\\deps -L dependency=D:\\git\\iotedge\\edgelet\\target\\release\\deps -L all=D:\\git\\iotedge\\edgelet\\target\\thumbv7a-pc-windows-msvc\\release\\build\\iotedged-eventlog-messages-7acc25993b93c4f2\\out -l event_messages.res` (exit code: 1)\r\n```\r\n\r\nI did some rough check in the thumbv7a liballoc library, interestingly, the name mangling for EMPTY_ROOT_NODE is different than most of others. The symbol wanted is `__imp__ZN5alloc11collections5btree4node15EMPTY_ROOT_NODE17h486b4088caeaa846E`, however the one that I have in the thumbv7a lib is `__imp___ZN5alloc11collections5btree4node15EMPTY_ROOT_NODE17h486b4088caeaa846E`, note there are 2 underscores in the wanted symbol and 3 underscores in the actual symbol. that's because I have this symbol `_ZN5alloc11collections5btree4node15EMPTY_ROOT_NODE17h486b4088caeaa846E` which already starts with an underscore\r\n\r\nLooking at other symbols in the same lib, none of them start with a single underscore, e,g, `anon.6bd877021c225a724ec59609200b96d6.6.llvm.13430696783672607638` and `__imp__anon.6bd877021c225a724ec59609200b96d6.2.llvm.13430696783672607638`.\r\n\r\nI have no idea why the toolchain is looking for `__imp__` for EMPTY_ROOT_NODE instead of looking for `__imp___`\r\n\r\nThoughts? \r\n", "closed_by": {"login": "chandde", "id": 3334913, "node_id": "MDQ6VXNlcjMzMzQ5MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/3334913?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chandde", "html_url": "https://github.com/chandde", "followers_url": "https://api.github.com/users/chandde/followers", "following_url": "https://api.github.com/users/chandde/following{/other_user}", "gists_url": "https://api.github.com/users/chandde/gists{/gist_id}", "starred_url": "https://api.github.com/users/chandde/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chandde/subscriptions", "organizations_url": "https://api.github.com/users/chandde/orgs", "repos_url": "https://api.github.com/users/chandde/repos", "events_url": "https://api.github.com/users/chandde/events{/privacy}", "received_events_url": "https://api.github.com/users/chandde/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/60866/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/60866/timeline", "performed_via_github_app": null, "state_reason": "completed"}