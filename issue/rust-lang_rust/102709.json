{"url": "https://api.github.com/repos/rust-lang/rust/issues/102709", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/102709/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/102709/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/102709/events", "html_url": "https://github.com/rust-lang/rust/issues/102709", "id": 1397870160, "node_id": "I_kwDOAAsO6M5TUc5Q", "number": 102709, "title": "Undesirable auto-vectorization on a simple for-loop", "user": {"login": "Nugine", "id": 30099658, "node_id": "MDQ6VXNlcjMwMDk5NjU4", "avatar_url": "https://avatars.githubusercontent.com/u/30099658?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nugine", "html_url": "https://github.com/Nugine", "followers_url": "https://api.github.com/users/Nugine/followers", "following_url": "https://api.github.com/users/Nugine/following{/other_user}", "gists_url": "https://api.github.com/users/Nugine/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nugine/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nugine/subscriptions", "organizations_url": "https://api.github.com/users/Nugine/orgs", "repos_url": "https://api.github.com/users/Nugine/repos", "events_url": "https://api.github.com/users/Nugine/events{/privacy}", "received_events_url": "https://api.github.com/users/Nugine/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1049491442, "node_id": "MDU6TGFiZWwxMDQ5NDkxNDQy", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-heavy", "name": "I-heavy", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to binary size of generated code."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2022-10-05T14:17:16Z", "updated_at": "2022-10-16T10:11:09Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried this code:\r\n\r\n<https://rust.godbolt.org/z/5dE9h9G3T>\r\n\r\nCompiler flags: `-C opt-level=3 -C target-feature=+avx2`\r\n\r\n```rust\r\npub fn check(data: &[u8], lut: &[u8; 256]) -> bool {\r\n    let mut flag = 0;\r\n    for &x in data {\r\n        flag |= lut[x as usize];\r\n    }\r\n    flag != 0xff\r\n}\r\n```\r\n\r\nI expected to see this happen: The function should be compiled to a small scalar loop.\r\n\r\nInstead, this happened: \r\n\r\n<details><summary><strong>Huge ASM</strong></summary>\r\n<p>\r\n\r\n```asm\r\n        movzx   ecx, byte ptr [r9 + rax - 63]\r\n        movzx   ecx, byte ptr [rdx + rcx]\r\n        vmovd   xmm4, ecx\r\n        movzx   ecx, byte ptr [r9 + rax - 62]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 1\r\n        movzx   ecx, byte ptr [r9 + rax - 47]\r\n        movzx   ecx, byte ptr [rdx + rcx]\r\n        vmovd   xmm5, ecx\r\n        movzx   ecx, byte ptr [r9 + rax - 46]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 1\r\n        movzx   ecx, byte ptr [r9 + rax - 31]\r\n        movzx   ecx, byte ptr [rdx + rcx]\r\n        vmovd   xmm6, ecx\r\n        movzx   ecx, byte ptr [r9 + rax - 30]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 1\r\n        movzx   ecx, byte ptr [r9 + rax - 15]\r\n        movzx   ecx, byte ptr [rdx + rcx]\r\n        vmovd   xmm7, ecx\r\n        movzx   ecx, byte ptr [r9 + rax - 14]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 1\r\n        movzx   ecx, byte ptr [r9 + rax - 61]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 2\r\n        movzx   ecx, byte ptr [r9 + rax - 45]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 2\r\n        movzx   ecx, byte ptr [r9 + rax - 29]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 2\r\n        movzx   ecx, byte ptr [r9 + rax - 13]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 2\r\n        movzx   ecx, byte ptr [r9 + rax - 60]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 3\r\n        movzx   ecx, byte ptr [r9 + rax - 44]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 3\r\n        movzx   ecx, byte ptr [r9 + rax - 28]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 3\r\n        movzx   ecx, byte ptr [r9 + rax - 12]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 3\r\n        movzx   ecx, byte ptr [r9 + rax - 59]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 4\r\n        movzx   ecx, byte ptr [r9 + rax - 43]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 4\r\n        movzx   ecx, byte ptr [r9 + rax - 27]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 4\r\n        movzx   ecx, byte ptr [r9 + rax - 11]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 4\r\n        movzx   ecx, byte ptr [r9 + rax - 58]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 5\r\n        movzx   ecx, byte ptr [r9 + rax - 42]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 5\r\n        movzx   ecx, byte ptr [r9 + rax - 26]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 5\r\n        movzx   ecx, byte ptr [r9 + rax - 10]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 5\r\n        movzx   ecx, byte ptr [r9 + rax - 57]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 6\r\n        movzx   ecx, byte ptr [r9 + rax - 41]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 6\r\n        movzx   ecx, byte ptr [r9 + rax - 25]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 6\r\n        movzx   ecx, byte ptr [r9 + rax - 9]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 6\r\n        movzx   ecx, byte ptr [r9 + rax - 56]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 7\r\n        movzx   ecx, byte ptr [r9 + rax - 40]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 7\r\n        movzx   ecx, byte ptr [r9 + rax - 24]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 7\r\n        movzx   ecx, byte ptr [r9 + rax - 8]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 7\r\n        movzx   ecx, byte ptr [r9 + rax - 55]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 8\r\n        movzx   ecx, byte ptr [r9 + rax - 39]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 8\r\n        movzx   ecx, byte ptr [r9 + rax - 23]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 8\r\n        movzx   ecx, byte ptr [r9 + rax - 7]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 8\r\n        movzx   ecx, byte ptr [r9 + rax - 54]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 9\r\n        movzx   ecx, byte ptr [r9 + rax - 38]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 9\r\n        movzx   ecx, byte ptr [r9 + rax - 22]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 9\r\n        movzx   ecx, byte ptr [r9 + rax - 6]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 9\r\n        movzx   ecx, byte ptr [r9 + rax - 53]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 10\r\n        movzx   ecx, byte ptr [r9 + rax - 37]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 10\r\n        movzx   ecx, byte ptr [r9 + rax - 21]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 10\r\n        movzx   ecx, byte ptr [r9 + rax - 5]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 10\r\n        movzx   ecx, byte ptr [r9 + rax - 52]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 11\r\n        movzx   ecx, byte ptr [r9 + rax - 36]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 11\r\n        movzx   ecx, byte ptr [r9 + rax - 20]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 11\r\n        movzx   ecx, byte ptr [r9 + rax - 4]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 11\r\n        movzx   ecx, byte ptr [r9 + rax - 51]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 12\r\n        movzx   ecx, byte ptr [r9 + rax - 35]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 12\r\n        movzx   ecx, byte ptr [r9 + rax - 19]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 12\r\n        movzx   ecx, byte ptr [r9 + rax - 3]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 12\r\n        movzx   ecx, byte ptr [r9 + rax - 50]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 13\r\n        movzx   ecx, byte ptr [r9 + rax - 34]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 13\r\n        movzx   ecx, byte ptr [r9 + rax - 18]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 13\r\n        movzx   ecx, byte ptr [r9 + rax - 2]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 13\r\n        movzx   ecx, byte ptr [r9 + rax - 49]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 14\r\n        movzx   ecx, byte ptr [r9 + rax - 33]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 14\r\n        movzx   ecx, byte ptr [r9 + rax - 17]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 14\r\n        movzx   ecx, byte ptr [r9 + rax - 48]\r\n        vpinsrb xmm4, xmm4, byte ptr [rdx + rcx], 15\r\n        movzx   ecx, byte ptr [r9 + rax - 32]\r\n        vpinsrb xmm5, xmm5, byte ptr [rdx + rcx], 15\r\n        movzx   ecx, byte ptr [r9 + rax - 16]\r\n        vpinsrb xmm6, xmm6, byte ptr [rdx + rcx], 15\r\n        movzx   ecx, byte ptr [r9 + rax - 1]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 14\r\n        movzx   ecx, byte ptr [r9 + rax]\r\n        vpinsrb xmm7, xmm7, byte ptr [rdx + rcx], 15\r\n        vpor    xmm0, xmm4, xmm0\r\n        vpor    xmm1, xmm5, xmm1\r\n        vpor    xmm2, xmm6, xmm2\r\n        vpor    xmm3, xmm7, xmm3\r\n        add     rax, 64\r\n        cmp     r8, rax\r\n        jne     .LBB0_12\r\n        vpor    xmm0, xmm1, xmm0\r\n        vpor    xmm0, xmm2, xmm0\r\n        vpor    xmm0, xmm3, xmm0\r\n        vpshufd xmm1, xmm0, 238\r\n        vpor    xmm0, xmm0, xmm1\r\n        vpshufd xmm1, xmm0, 85\r\n        vpor    xmm0, xmm0, xmm1\r\n        vpsrld  xmm1, xmm0, 16\r\n        vpor    xmm0, xmm0, xmm1\r\n        vpsrlw  xmm1, xmm0, 8\r\n        vpor    xmm0, xmm0, xmm1\r\n        vmovd   ecx, xmm0\r\n        cmp     r8, rsi\r\n        je      .LBB0_9\r\n        test    sil, 56\r\n        je      .LBB0_15\r\n        ...\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.64.0 (a55dd71d5 2022-09-19)\r\nbinary: rustc\r\ncommit-hash: a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52\r\ncommit-date: 2022-09-19\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.64.0\r\nLLVM version: 14.0.6\r\n```\r\n\r\n```\r\nrustc 1.66.0-nightly (01af5040f 2022-10-04)\r\nbinary: rustc\r\ncommit-hash: 01af5040fdada6ef8f1b749cda798d80a8590b2c\r\ncommit-date: 2022-10-04\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.66.0-nightly\r\nLLVM version: 15.0.2\r\n```\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/102709/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/102709/timeline", "performed_via_github_app": null, "state_reason": null}