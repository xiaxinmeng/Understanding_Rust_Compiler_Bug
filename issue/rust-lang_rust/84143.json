{"url": "https://api.github.com/repos/rust-lang/rust/issues/84143", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/84143/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/84143/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/84143/events", "html_url": "https://github.com/rust-lang/rust/issues/84143", "id": 856373140, "node_id": "MDU6SXNzdWU4NTYzNzMxNDA=", "number": 84143, "title": "Make `TokenCursor` cheaper to clone", "user": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 132910982, "node_id": "MDU6TGFiZWwxMzI5MTA5ODI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-macros", "name": "A-macros", "color": "f7e101", "default": false, "description": "Area: All kinds of macros (custom derive, macro_rules!, proc macros, ..)"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2021-04-12T21:25:49Z", "updated_at": "2021-04-12T21:25:49Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "Cloning a `rustc_parse::parser::TokenCursor` is a convenient way to save our current position im the overall token stream. Unfortunately, any code that needs to clone it is very hot, so actually cloning it can easily lead to regressions of several percentage points on rustc-perf.\r\n\r\nFor example, the token collection code goes to a lot of effort to avoid cloning the `TokenCursor` when possible:\r\n\r\nhttps://github.com/rust-lang/rust/blob/d0695c9081b16077d0aed368bccaf437d77ff497/compiler/rustc_parse/src/parser/attr_wrapper.rs#L205-L221\r\n\r\nSpeeding up the cloning of `TokenCursor` would probably give us nice wins on attribute-heavy code.\r\nIn https://github.com/rust-lang/rust/pull/82844, I attempted to make the parser use a 'flattened' list of tokens instead of a `TokenStream`. This would have allowed the cursor to be 'cloned' by just copying the index into the flat stream. Unfortunately, the cost of 'flattening' a `TokenStream` made this a net performance loss.\r\n\r\nSome ideas to try:\r\n* Use an `ArrayVec` instead of a `Vec` for the `stack` field - if the majority of code we parse is not nested very deeply within brackets/braces/parens, this could improve performance. However, I'm not sure how much time is actually being spent allocating an new `Vec`", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/84143/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/84143/timeline", "performed_via_github_app": null, "state_reason": null}