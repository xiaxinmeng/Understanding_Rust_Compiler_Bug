{"url": "https://api.github.com/repos/rust-lang/rust/issues/96140", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/96140/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/96140/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/96140/events", "html_url": "https://github.com/rust-lang/rust/issues/96140", "id": 1206300373, "node_id": "I_kwDOAAsO6M5H5q7V", "number": 96140, "title": "`std::mem::transmute` may mutate result", "user": {"login": "jmeggitt", "id": 5491072, "node_id": "MDQ6VXNlcjU0OTEwNzI=", "avatar_url": "https://avatars.githubusercontent.com/u/5491072?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jmeggitt", "html_url": "https://github.com/jmeggitt", "followers_url": "https://api.github.com/users/jmeggitt/followers", "following_url": "https://api.github.com/users/jmeggitt/following{/other_user}", "gists_url": "https://api.github.com/users/jmeggitt/gists{/gist_id}", "starred_url": "https://api.github.com/users/jmeggitt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jmeggitt/subscriptions", "organizations_url": "https://api.github.com/users/jmeggitt/orgs", "repos_url": "https://api.github.com/users/jmeggitt/repos", "events_url": "https://api.github.com/users/jmeggitt/events{/privacy}", "received_events_url": "https://api.github.com/users/jmeggitt/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2022-04-17T07:04:30Z", "updated_at": "2022-07-23T10:01:20Z", "closed_at": "2022-07-23T10:01:20Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\n### Example Code\r\nDuring some experimenting in the Rust playground, I noticed something strange with the assembly output from `transmute`.\r\n```rust\r\npub unsafe fn foo(x: u8) -> bool {\r\n    ::std::mem::transmute(x)\r\n}\r\n```\r\n[Playground](https://play.rust-lang.org/?version=stable&mode=release&edition=2021&gist=b4b9d5b33c517578d35b2a89935f7347)\r\n### Expected Output\r\n`transmute` should copy the input memory with no mutations. I expected this to put x in the return register and return:\r\n```rust\r\nplayground::foo:\r\n\tmovl\t%edi, %eax\r\n\tretq\r\n```\r\n### Actual Output\r\nHowever the resulting value gets modified in the process producing the following output:\r\n```rust\r\nplayground::foo:\r\n\tmovl\t%edi, %eax\r\n\tandb\t$1, %al\r\n\tretq\r\n```\r\n\r\nNow, I don't have any issue with the compiler choosing any arbitrary approach for representing a `bool` within `std::mem::size_of::<bool>()` bytes. However, I was under the impression that `std::mem::transmute` **never** mutates the underlying data. To quote the  documentation, \"It\u2019s equivalent to C\u2019s `memcpy` under the hood, just like `transmute_copy`.\" At the moment it feels like this contract is not being upheld.\r\n\r\n### Structs\r\nHowever, the bigger issue is `transmute` may or may not apply this adjustment to `bool` fields in structs. This could probably hide some nasty bugs that would be extremely hard to debug. Take for example the code below:\r\n```rust\r\nimpl Bar {\r\n    pub fn from_buffer(buffer: [u8; BAR_SIZE]) -> Self {\r\n        unsafe { ::std::mem::transmute(buffer) }\r\n    }\r\n\r\n    pub fn to_buffer(self) -> [u8; BAR_SIZE] {\r\n        unsafe { ::std::mem::transmute(self) }\r\n    }\r\n}\r\n\r\npub fn main() {\r\n    let buffer: [u8; BAR_SIZE] = [0xFF; BAR_SIZE];\r\n    let identity = Bar::from_buffer(buffer).to_buffer();\r\n    assert_eq!(buffer, identity);\r\n}\r\n```\r\n[(Playground with panic (small `Bar`))](https://play.rust-lang.org/?version=stable&mode=release&edition=2021&gist=b3ad20ed8c860ffe8e741940811d10df) [(Playground no panic (large `Bar`))](https://play.rust-lang.org/?version=stable&mode=release&edition=2021&gist=98599be63061e068f35db4828f145364)\r\nIt is not possible to tell if this code will panic without seeing the contents of `Bar`. The primary factors that determine if a panic occurs seems to be the size of `Bar` and at when in the compilation process `from_buffer`/`to_buffer` are inlined. Small `structs` with less fields are more likely to have their `bool`s adjusted. Depending on which function the `transmute` is in, the compiler may determine that the `transmute`s will cancel out and will not produce an error.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n`rustc --version --verbose`:\r\n```\r\njaspermeggitt@Jaspers-Laptop:~/tmp$ rustc --verbose --version\r\nrustc 1.60.0 (7737e0b5c 2022-04-04)\r\nbinary: rustc\r\ncommit-hash: 7737e0b5c4103216d6fd8cf941b7ab9bdbaace7c\r\ncommit-date: 2022-04-04\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.60.0\r\nLLVM version: 14.0.0\r\njaspermeggitt@Jaspers-Laptop:~/tmp$ rustc +nightly --verbose --version\r\nrustc 1.62.0-nightly (8f36334ca 2022-04-06)\r\nbinary: rustc\r\ncommit-hash: 8f36334ca939a67cce3f37f24953ff6f2d3f3d33\r\ncommit-date: 2022-04-06\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.62.0-nightly\r\nLLVM version: 14.0.0\r\n```", "closed_by": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/96140/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/96140/timeline", "performed_via_github_app": null, "state_reason": "completed"}