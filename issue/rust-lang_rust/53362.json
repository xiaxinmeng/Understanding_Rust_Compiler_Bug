{"url": "https://api.github.com/repos/rust-lang/rust/issues/53362", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/53362/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/53362/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/53362/events", "html_url": "https://github.com/rust-lang/rust/issues/53362", "id": 350547308, "node_id": "MDU6SXNzdWUzNTA1NDczMDg=", "number": 53362, "title": "linker-flavor rustflag is not forwarded to host env linker when cross-compiling", "user": {"login": "Arnavion", "id": 1096010, "node_id": "MDQ6VXNlcjEwOTYwMTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1096010?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Arnavion", "html_url": "https://github.com/Arnavion", "followers_url": "https://api.github.com/users/Arnavion/followers", "following_url": "https://api.github.com/users/Arnavion/following{/other_user}", "gists_url": "https://api.github.com/users/Arnavion/gists{/gist_id}", "starred_url": "https://api.github.com/users/Arnavion/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Arnavion/subscriptions", "organizations_url": "https://api.github.com/users/Arnavion/orgs", "repos_url": "https://api.github.com/users/Arnavion/repos", "events_url": "https://api.github.com/users/Arnavion/events{/privacy}", "received_events_url": "https://api.github.com/users/Arnavion/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 609101895, "node_id": "MDU6TGFiZWw2MDkxMDE4OTU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-cargo", "name": "T-cargo", "color": "bfd4f2", "default": false, "description": "Relevant to the cargo team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-08-14T18:33:45Z", "updated_at": "2018-11-20T07:24:34Z", "closed_at": "2018-11-20T07:24:33Z", "author_association": "NONE", "active_lock_reason": null, "body": "I'm compiling for the `x86_64-unknown-linux-musl` target on a `x86_64-pc-windows-msvc` host, using lld with linker-flavor for the host.\r\n\r\n`.cargo/Config`\r\n\r\n```toml\r\n[target.x86_64-pc-windows-msvc]\r\nlinker = \"rust-lld\"\r\nrustflags = [\"-Z\", \"linker-flavor=lld-link\"]\r\n```\r\n\r\nThis config works for building for the host `x86_64-pc-windows-msvc`. But in the cross-compiling case, build scripts / proc macros that need to be compiled for the host do not forward the `-flavor` parameter to rust-lld. Eg, compiling serde as a dependency fails when building its build script:\r\n\r\n```\r\n  process didn't exit successfully: `rustc --crate-name build_script_build C:\\Users\\Arnavion\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\serde-1.0.71\\build.rs --crate-type bin --emit=dep-info,link -C debuginfo=2 --cfg \"feature=\\\"default\\\"\" --cfg \"feature=\\\"std\\\"\" -C metadata=9aefa54ad2b7fdfb -C extra-filename=-9aefa54ad2b7fdfb --out-dir C:\\Stuff\\Sources\\tpfancontrol-rs\\target\\debug\\build\\serde-9aefa54ad2b7fdfb -C linker=rust-lld -L dependency=C:\\Stuff\\Sources\\tpfancontrol-rs\\target\\debug\\deps --cap-lints allow` (exit code: 1)\r\n\r\nerror: linking with `rust-lld` failed: exit code: 1\r\n  |\r\n  = note: \"rust-lld\" \"/NOLOGO\" \"/NXCOMPAT\" \"/LIBPATH:C:\\\\Users\\\\Arnavion\\\\.rustup\\\\toolchains\\\\nightly-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"/OUT:C:\\\\Stuff\\\\Sources\\\\tpfancontrol-rs\\\\target\\\\debug\\\\build\\\\serde-9aefa54ad2b7fdfb\\\\build_script_build-9aefa54ad2b7fdfb.exe\" [...]\r\n  = note: lld is a generic driver.\r\n          Invoke ld.lld (Unix), ld64.lld (macOS), lld-link (Windows), wasm-lld (WebAssembly) instead\r\n```\r\n\r\nThe `-flavor link` parameter to `rust-lld` is missing, hence the failure.\r\n\r\n---\r\n\r\nA non-cross-compiling build targeting x86_64-pc-windows-msvc correctly has the `linker-flavor` option:\r\n\r\n```\r\nrustc --crate-name build_script_build C:\\Users\\Arnavion\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\serde-1.0.71\\build.rs --crate-type bin --emit=dep-info,link -C debuginfo=2 --cfg \"feature=\\\"default\\\"\" --cfg \"feature=\\\"std\\\"\" -C metadata=9aefa54ad2b7fdfb -C extra-filename=-9aefa54ad2b7fdfb --out-dir C:\\Stuff\\Sources\\k8s-openapi-codegen\\target\\debug\\build\\serde-9aefa54ad2b7fdfb -C linker=rust-lld -L dependency=C:\\Stuff\\Sources\\k8s-openapi-codegen\\target\\debug\\deps --cap-lints allow -Z linker-flavor=lld-link`\r\n```\r\n\r\nwhich translates to the `-flavor` parameter to `rust-lld`:\r\n\r\n```\r\nrust-lld.exe -flavor link /LIBPATH: [...]\r\n```\r\n\r\n---\r\n\r\nAs a workaround, it works to manually symlink `lld-link.exe` to `rust-lld.exe` and change the Cargo config to\r\n\r\n```\r\nlinker = \"lld-link\"\r\nrustflags = []\r\n```\r\n\r\nsince this doesn't need rustflags to be passed down.", "closed_by": {"login": "Arnavion", "id": 1096010, "node_id": "MDQ6VXNlcjEwOTYwMTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1096010?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Arnavion", "html_url": "https://github.com/Arnavion", "followers_url": "https://api.github.com/users/Arnavion/followers", "following_url": "https://api.github.com/users/Arnavion/following{/other_user}", "gists_url": "https://api.github.com/users/Arnavion/gists{/gist_id}", "starred_url": "https://api.github.com/users/Arnavion/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Arnavion/subscriptions", "organizations_url": "https://api.github.com/users/Arnavion/orgs", "repos_url": "https://api.github.com/users/Arnavion/repos", "events_url": "https://api.github.com/users/Arnavion/events{/privacy}", "received_events_url": "https://api.github.com/users/Arnavion/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/53362/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/53362/timeline", "performed_via_github_app": null, "state_reason": "completed"}