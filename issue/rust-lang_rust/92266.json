{"url": "https://api.github.com/repos/rust-lang/rust/issues/92266", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/92266/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/92266/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/92266/events", "html_url": "https://github.com/rust-lang/rust/issues/92266", "id": 1088506587, "node_id": "I_kwDOAAsO6M5A4Urb", "number": 92266, "title": "`HashStable` caching does not take into account `StableHashingContext` settings", "user": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 307747675, "node_id": "MDU6TGFiZWwzMDc3NDc2NzU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-incr-comp", "name": "A-incr-comp", "color": "f7e101", "default": false, "description": "Area: Incremental compilation"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2021-12-24T22:18:36Z", "updated_at": "2022-01-10T03:39:00Z", "closed_at": "2022-01-10T03:39:00Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "In some places, we have `HashStable` implementations that cache a computed `Fingerprint` to avoid re-computing it:\r\n\r\nhttps://github.com/rust-lang/rust/blob/aad4f1039fd5d6bf961ed08eebc6eb69b577f1be/compiler/rustc_middle/src/ty/impls_ty.rs#L14-L22\r\n\r\nhttps://github.com/rust-lang/rust/blob/aad4f1039fd5d6bf961ed08eebc6eb69b577f1be/compiler/rustc_middle/src/ty/adt.rs#L136-L140\r\n\r\nhttps://github.com/rust-lang/rust/blob/aad4f1039fd5d6bf961ed08eebc6eb69b577f1be/compiler/rustc_span/src/hygiene.rs#L164-L166\r\n\r\nHowever, this does not take into account that the `StableHashingContext` may be configured to hash certain things different. Spans can be skipped using `hcx.while_hashing_spans`, and `HirId`s can be skipped using `hcx.with_node_id_hashing_mode`. These settings are not used in the cache key, so we will end up caching using whatever settings are used the first time the structure is hashed. As a result, later uses of `hcx.while_hashing_spans` and `hcx.with_node_id_hashing_mode` may end up using an incorrect cache entry.\r\n\r\nIn particular, we need to ignore spans while computing the legacy symbol hash: https://github.com/rust-lang/rust/blob/aad4f1039fd5d6bf961ed08eebc6eb69b577f1be/compiler/rustc_symbol_mangling/src/legacy.rs#L113-L117\r\n\r\nIf we've already populated one of the caches with a value that included hashed spans, then our symbol hash might actually take spans into account, even though we've explicitly requested that it should not.\r\n\r\nWe need to either include the relevant setting in the cache key, or enforce that we only ever try to hash the structure (e.g. `ExpnData`) with the same settings.\r\n\r\nDiscovered while working on https://github.com/rust-lang/rust/pull/92210", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/92266/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/92266/timeline", "performed_via_github_app": null, "state_reason": "completed"}