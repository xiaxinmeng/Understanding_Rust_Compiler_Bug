{"url": "https://api.github.com/repos/rust-lang/rust/issues/97602", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/97602/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/97602/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/97602/events", "html_url": "https://github.com/rust-lang/rust/issues/97602", "id": 1254470587, "node_id": "I_kwDOAAsO6M5KxbO7", "number": 97602, "title": "Using `-Z build-std-features=panic_immediate_abort` on Linux results in invalid executable.", "user": {"login": "A1-Triard", "id": 8782185, "node_id": "MDQ6VXNlcjg3ODIxODU=", "avatar_url": "https://avatars.githubusercontent.com/u/8782185?v=4", "gravatar_id": "", "url": "https://api.github.com/users/A1-Triard", "html_url": "https://github.com/A1-Triard", "followers_url": "https://api.github.com/users/A1-Triard/followers", "following_url": "https://api.github.com/users/A1-Triard/following{/other_user}", "gists_url": "https://api.github.com/users/A1-Triard/gists{/gist_id}", "starred_url": "https://api.github.com/users/A1-Triard/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/A1-Triard/subscriptions", "organizations_url": "https://api.github.com/users/A1-Triard/orgs", "repos_url": "https://api.github.com/users/A1-Triard/repos", "events_url": "https://api.github.com/users/A1-Triard/events{/privacy}", "received_events_url": "https://api.github.com/users/A1-Triard/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-05-31T22:15:10Z", "updated_at": "2022-06-01T23:11:17Z", "closed_at": "2022-06-01T23:11:17Z", "author_association": "NONE", "active_lock_reason": null, "body": "Cross-compiling windows executable on Linux ends with invalid executable if `-Z build-std-features=panic_immediate_abort` feature is used.\r\n\r\nI have reproduced it with GNU toolchain, and with Wine'd MSVC toolchain. Also I have reproduced it while compiling x32 and x64 targets. And it can be reproduced with `no_std` and ordinary project. But it seems it is not reproducible when windows is a compilation host.\r\n\r\n```rust\r\n#![feature(lang_items)]\r\n#![feature(start)]\r\n#![no_std]\r\n#![windows_subsystem=\"console\"]\r\n\r\n#[lang=\"eh_personality\"] extern fn rust_eh_personality() {}\r\n#[no_mangle] pub extern fn rust_eh_register_frames () {}\r\n#[no_mangle] pub extern fn rust_eh_unregister_frames () {}\r\n\r\n#[cfg(target_env=\"msvc\")]\r\n#[link(name=\"libcmt\")]\r\nextern { }\r\n\r\nuse core::mem::{MaybeUninit, transmute};\r\nuse core::panic::PanicInfo;\r\n\r\nfn exit(exit_code: u8) -> ! {\r\n    unsafe { winapi::um::processthreadsapi::ExitProcess(exit_code as _) };\r\n    loop { }\r\n}\r\n\r\n#[panic_handler]\r\npub extern fn panic(_info: &PanicInfo) -> ! {\r\n    exit(99)\r\n}\r\n\r\n#[start]\r\npub fn main(_argc: isize, _argv: *const *const u8) -> isize {\r\n    let mut buf: [MaybeUninit<u8>; 13] = unsafe { MaybeUninit::uninit().assume_init() };\r\n    (&mut buf[.. 11]).copy_from_slice(unsafe { transmute(&b\"Source12345\"[..]) });\r\n    buf[11].write(b'6');\r\n    buf[12].write(0);\r\n    let buf: [u8; 13] = unsafe { transmute(buf) };\r\n    assert!(buf[5] > 120);\r\n    exit(0)\r\n}\r\n```\r\n\r\nCargo.toml:\r\n\r\n```\r\n[package]\r\nname = \"test_panic_immediate_abort\"\r\nversion = \"0.1.0\"\r\nedition = \"2021\"\r\n\r\n[profile.dev]\r\npanic = \"abort\"\r\n\r\n[profile.release]\r\npanic = \"abort\"\r\n\r\n[dependencies]\r\nwinapi = { version = \"0.3.9\", default-features = false, features = [\"processthreadsapi\"] }\r\n```\r\n\r\nWhen I compile with the following command:\r\n\r\n```\r\n$ cargo +nightly build -Z build-std=core,panic_abort --target=i686-pc-windows-gnu\r\n```\r\n\r\nthe result is correct executable which could be normally executed and ends with error code 1 (as expected).\r\n\r\nBut if I compile the project with the following command:\r\n\r\n```\r\n$ cargo +nightly build -Z build-std=core,panic_abort -Z build-std-features=panic_immediate_abort --target=i686-pc-windows-gnu\r\n```\r\n\r\nthen the result executable is not valid anymore. For example, a try to run it with wine ends with \"Unhandled illegal instruction at address 004019A6 (thread 0024), starting debugger...\" error.", "closed_by": {"login": "A1-Triard", "id": 8782185, "node_id": "MDQ6VXNlcjg3ODIxODU=", "avatar_url": "https://avatars.githubusercontent.com/u/8782185?v=4", "gravatar_id": "", "url": "https://api.github.com/users/A1-Triard", "html_url": "https://github.com/A1-Triard", "followers_url": "https://api.github.com/users/A1-Triard/followers", "following_url": "https://api.github.com/users/A1-Triard/following{/other_user}", "gists_url": "https://api.github.com/users/A1-Triard/gists{/gist_id}", "starred_url": "https://api.github.com/users/A1-Triard/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/A1-Triard/subscriptions", "organizations_url": "https://api.github.com/users/A1-Triard/orgs", "repos_url": "https://api.github.com/users/A1-Triard/repos", "events_url": "https://api.github.com/users/A1-Triard/events{/privacy}", "received_events_url": "https://api.github.com/users/A1-Triard/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/97602/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/97602/timeline", "performed_via_github_app": null, "state_reason": "completed"}