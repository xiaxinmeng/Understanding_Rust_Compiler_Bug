{"url": "https://api.github.com/repos/rust-lang/rust/issues/85839", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/85839/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/85839/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/85839/events", "html_url": "https://github.com/rust-lang/rust/issues/85839", "id": 906871605, "node_id": "MDU6SXNzdWU5MDY4NzE2MDU=", "number": 85839, "title": "Inconsistent behavior without lto on Ubuntu", "user": {"login": "ammkrn", "id": 46387933, "node_id": "MDQ6VXNlcjQ2Mzg3OTMz", "avatar_url": "https://avatars.githubusercontent.com/u/46387933?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ammkrn", "html_url": "https://github.com/ammkrn", "followers_url": "https://api.github.com/users/ammkrn/followers", "following_url": "https://api.github.com/users/ammkrn/following{/other_user}", "gists_url": "https://api.github.com/users/ammkrn/gists{/gist_id}", "starred_url": "https://api.github.com/users/ammkrn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ammkrn/subscriptions", "organizations_url": "https://api.github.com/users/ammkrn/orgs", "repos_url": "https://api.github.com/users/ammkrn/repos", "events_url": "https://api.github.com/users/ammkrn/events{/privacy}", "received_events_url": "https://api.github.com/users/ammkrn/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 14, "created_at": "2021-05-30T20:21:03Z", "updated_at": "2021-10-25T21:46:41Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "### Description\r\nI have a repo that uses an indexmap-backed arena to build a graph. It's written such that looking up a pointer that doesn't actually exist causes a panic. If I build the library and run an example without lto on ubuntu, I will either get a semi-deterministic panic, because the program produces a pointer with an index that's far larger than it should be (it happens in the same function, but produces different backtraces), and when I try to get information about the collection at runtime, I get a segfault. My program is deterministic and contains no unsafe, but relies on indexmap which does have some unsafe code. \r\nThis only happens on ubuntu (see the meta section for compiler/os info), and only with lto off.\r\n\r\nThe repo probably isn't very helpful, but you can find it here: https://github.com/ammkrn/nanoda_lib\r\n\r\n### Meta\r\nI'm observing this behavior on both stable and nightly.\r\n```\r\nrustc 1.52.1 (9bc8c42bb 2021-05-09)\r\nrustc 1.54.0-nightly (b663c0f4f 2021-05-29)\r\n\r\nUbuntu 20.04.2 LTS\r\n```\r\n### Backtrace\r\nI'm getting different backtraces since the error isn't competely deterministic (though it is happening in the same function). The bad integer index is also different:\r\n\r\nFirst:\r\n```\r\nthread 'main' panicked at 'Checked `None`', src/utils.rs:108:46\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/9bc8c42bb2f19e745a63f3445f1ac248fb015e53/library/std/src/panicking.rs:493:5\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/9bc8c42bb2f19e745a63f3445f1ac248fb015e53/library/core/src/panicking.rs:92:14\r\n   2: core::option::expect_failed\r\n             at /rustc/9bc8c42bb2f19e745a63f3445f1ac248fb015e53/library/core/src/option.rs:1321:5\r\n   3: nanoda_lib::env::get_rec_rule_aux\r\n   4: nanoda_lib::env::Declar::get_rec_rule\r\n   5: nanoda_lib::tc::reduce::reduce_ind_rec\r\n   6: nanoda_lib::tc::reduce::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::whnf_core\r\n   7: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n   8: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n   9: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  10: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  11: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  12: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  13: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  14: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  15: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  16: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  17: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  18: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::def_eq\r\n  19: nanoda_lib::tc::eq::args_eq\r\n  20: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::def_eq\r\n  21: nanoda_lib::tc::eq::args_eq\r\n  22: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  23: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::def_eq\r\n  24: nanoda_lib::tc::eq::args_eq\r\n  25: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  26: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::def_eq\r\n  27: nanoda_lib::tc::eq::args_eq\r\n  28: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  29: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::def_eq\r\n  30: nanoda_lib::tc::eq::args_eq\r\n  31: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::def_eq\r\n  32: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  33: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  34: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  35: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  36: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  37: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  38: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  39: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  40: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  41: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  42: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  43: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  44: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  45: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  46: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  47: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  48: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  49: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  50: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  51: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  52: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  53: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  54: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  55: nanoda_lib::env::Declar::check\r\n  56: nanoda_lib::parser::<impl nanoda_lib::utils::Env>::check_loop\r\n  57: nanoda_lib::parser::Parser::parser_loop\r\n  58: debug::main\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n```\r\n\r\nsecond:\r\n```\r\nthread 'main' panicked at 'Checked `None`', src/utils.rs:108:46\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/9bc8c42bb2f19e745a63f3445f1ac248fb015e53/library/std/src/panicking.rs:493:5\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/9bc8c42bb2f19e745a63f3445f1ac248fb015e53/library/core/src/panicking.rs:92:14\r\n   2: core::option::expect_failed\r\n             at /rustc/9bc8c42bb2f19e745a63f3445f1ac248fb015e53/library/core/src/option.rs:1321:5\r\n   3: nanoda_lib::env::get_rec_rule_aux\r\n   4: nanoda_lib::env::Declar::get_rec_rule\r\n   5: nanoda_lib::tc::reduce::reduce_ind_rec\r\n   6: nanoda_lib::tc::reduce::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::whnf_core\r\n   7: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n   8: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n   9: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  10: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  11: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  12: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  13: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  14: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::def_eq\r\n  15: nanoda_lib::tc::eq::args_eq\r\n  16: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::def_eq\r\n  17: nanoda_lib::tc::eq::args_eq\r\n  18: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  19: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::def_eq\r\n  20: nanoda_lib::tc::eq::args_eq\r\n  21: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::delta_step\r\n  22: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::def_eq\r\n  23: nanoda_lib::tc::eq::args_eq\r\n  24: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::def_eq\r\n  25: nanoda_lib::tc::eq::args_eq\r\n  26: nanoda_lib::tc::eq::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::def_eq\r\n  27: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  28: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  29: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  30: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  31: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  32: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  33: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  34: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  35: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  36: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  37: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  38: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  39: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  40: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  41: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  42: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  43: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  44: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer_app\r\n  45: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  46: nanoda_lib::tc::infer::<impl nanoda_lib::utils::Ptr2<core::marker::PhantomData<&nanoda_lib::expr::Expr>>>::infer\r\n  47: nanoda_lib::env::Declar::check\r\n  48: nanoda_lib::parser::<impl nanoda_lib::utils::Env>::check_loop\r\n  49: nanoda_lib::parser::Parser::parser_loop\r\n  50: debug::main\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n\r\n```\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/85839/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/85839/timeline", "performed_via_github_app": null, "state_reason": null}