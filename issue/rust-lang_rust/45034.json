{"url": "https://api.github.com/repos/rust-lang/rust/issues/45034", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/45034/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/45034/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/45034/events", "html_url": "https://github.com/rust-lang/rust/issues/45034", "id": 262961277, "node_id": "MDU6SXNzdWUyNjI5NjEyNzc=", "number": 45034, "title": "-C opt-level=z produces invalid code on i686-pc-windows-msvc", "user": {"login": "neivv", "id": 9514159, "node_id": "MDQ6VXNlcjk1MTQxNTk=", "avatar_url": "https://avatars.githubusercontent.com/u/9514159?v=4", "gravatar_id": "", "url": "https://api.github.com/users/neivv", "html_url": "https://github.com/neivv", "followers_url": "https://api.github.com/users/neivv/followers", "following_url": "https://api.github.com/users/neivv/following{/other_user}", "gists_url": "https://api.github.com/users/neivv/gists{/gist_id}", "starred_url": "https://api.github.com/users/neivv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/neivv/subscriptions", "organizations_url": "https://api.github.com/users/neivv/orgs", "repos_url": "https://api.github.com/users/neivv/repos", "events_url": "https://api.github.com/users/neivv/events{/privacy}", "received_events_url": "https://api.github.com/users/neivv/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 203429200, "node_id": "MDU6TGFiZWwyMDM0MjkyMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-high", "name": "P-high", "color": "eb6420", "default": false, "description": "High priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 10, "created_at": "2017-10-04T23:24:34Z", "updated_at": "2017-11-13T16:50:25Z", "closed_at": "2017-11-13T16:50:25Z", "author_association": "NONE", "active_lock_reason": null, "body": "```rust\r\nfn main() {\r\n    let _vec: Vec<u8> = Vec::new();\r\n    std::fs::create_dir(std::path::Path::new(\"a\")).unwrap();\r\n}\r\n```\r\nWill crash when compiled with `rustc -C opt-level=z main.rs`.\r\n```\r\n> rustup run nightly-i686-pc-windows-msvc rustc --version -v\r\nrustc 1.22.0-nightly (4502e2aa9 2017-10-03)\r\nbinary: rustc\r\ncommit-hash: 4502e2aa9c28d8caa610fc1815fd9c5b5a16e91c\r\ncommit-date: 2017-10-03\r\nhost: i686-pc-windows-msvc\r\nrelease: 1.22.0-nightly\r\nLLVM version: 4.0\r\n```\r\n\r\nThe asm for main is\r\n```asm\r\n__ZN4main4main17h0bca12b325d77113E:\r\nLfunc_begin2:\r\n\tpushl\t%ebp\r\n\tmovl\t%esp, %ebp\r\n\tpushl\t%ebx\r\n\tpushl\t%edi\r\n\tpushl\t%esi\r\n\tandl\t$-8, %esp\r\n\tsubl\t$72, %esp\r\n\tmovl\t%esp, %esi\r\n\tmovl\t%ebp, 48(%esi)\r\n\tleal\t56(%esi), %eax\r\n\tmovl\t%esp, -4(%eax)\r\n\torl\t$-1, 8(%eax)\r\n\tmovl\t$___ehhandler$_ZN4main4main17h0bca12b325d77113E, 4(%eax)\r\n\tmovl\t%fs:0, %ecx\r\n\tmovl\t%ecx, (%eax)\r\n\txorl\t%ecx, %ecx\r\n\tmovl\t%eax, %fs:0\r\n\tandl\t$0, 8(%eax)\r\n\tincl\t%ecx\r\n\tmovl\t%ecx, 12(%esi)\r\n\tandl\t$0, 16(%esi)\r\n\tandl\t$0, 20(%esi)\r\n\tpushl\t%ecx\r\n\tpushl\t$_str.7\r\n\tcalll\t__ZN3std3ffi6os_str85_$LT$impl$u20$core..convert..AsRef$LT$std..ffi..os_str..OsStr$GT$$u20$for$u20$str$GT$6as_ref17h154d386d199535e3E\r\n\tpopl\t%ecx\r\n\tpopl\t%esi\r\n\tmovl\t%eax, 8(%esi)\r\n\tmovl\t%edx, 4(%esi)\r\n\tcalll\t__ZN3std2fs10DirBuilder3new17h2a2d998af5809e7bE\r\n\tmovb\t%al, 24(%esi)\r\n\tpushl\t4(%esi)\r\n\tpushl\t8(%esi)\r\n\tcalll\t__ZN79_$LT$std..path..Path$u20$as$u20$core..convert..AsRef$LT$std..path..Path$GT$$GT$6as_ref17hbd919da430f6c47cE\r\n\tpopl\t%ecx\r\n\tpopl\t%esi\r\n\tpushl\t%edx\r\n\tpushl\t%eax\r\n\tcalll\t__ZN79_$LT$std..path..Path$u20$as$u20$core..convert..AsRef$LT$std..path..Path$GT$$GT$6as_ref17hbd919da430f6c47cE\r\n\tpopl\t%ecx\r\n\tpopl\t%esi\r\n\tleal\t24(%esi), %ecx\r\n\tleal\t36(%esi), %edi\r\n\tpushl\t%edx\r\n\tpushl\t%eax\r\n\tpushl\t%ecx\r\n\tpushl\t%edi\r\n\tcalll\t__ZN3std2fs10DirBuilder7_create17h457ad352f6fc1a89E\r\n\taddl\t$16, %esp\r\n\tcmpl\t$0, 36(%esi)\r\n\tjne\tLBB6_6\r\n\tleal\t12(%esi), %ecx\r\n\tcalll\t__ZN4core3ptr13drop_in_place17h8b2fec8553a09995E\r\n\tmovl\t56(%esi), %eax\r\n\tmovl\t%eax, %fs:0\r\n\tleal\t-12(%ebp), %esp\r\n\tpopl\t%esi\r\n\tpopl\t%edi\r\n\tpopl\t%ebx\r\n\tpopl\t%ebp\r\n\tretl\r\nLBB6_6:\r\n\tmovl\t40(%esi), %eax\r\n\tmovl\t44(%esi), %edx\r\n\tleal\t24(%esi), %ecx\r\n\tmovl\t%edx, 4(%ecx)\r\n\tmovl\t%eax, (%ecx)\r\n\tcalll\t__ZN4core6result13unwrap_failed17h0ccedc4bcd16baddE\r\n\t.def\t \"?dtor$9@?0?_ZN4main4main17h0bca12b325d77113E@4HA\";\r\n\t.scl\t3;\r\n\t.type\t32;\r\n\t.endef\r\n\"?dtor$9@?0?_ZN4main4main17h0bca12b325d77113E@4HA\":\r\nLBB6_9:\r\n\tpushl\t%ebp\r\n\tsubl\t$16, %esp\r\n\tleal\t-68(%ebp), %esi\r\n\tmovl\t48(%esi), %ebp\r\n\tleal\t12(%esi), %ecx\r\n\tcalll\t__ZN4core3ptr13drop_in_place17h8b2fec8553a09995E\r\n\taddl\t$16, %esp\r\n\tpopl\t%ebp\r\n\tretl\r\n```\r\n\r\nSpecifically, the function uses `esi` to store a local variable, but after \r\n`__ZN79_$LT$std..path..Path$u20$as$u20$core..convert..AsRef$LT$std..path..Path$GT$$GT$6as_ref17hbd919da430f6c47cE`\r\n one of the function arguments are popped from stack with `popl %esi`..\r\n\r\nWhen using `-C panic=abort`, or `i686-pc-windows-gnu`, or removing the `_vec`, the code compiles correctly (uses only `popl %ecx`), so the cause may be related to stack unwinding?\r\n\r\nThe issue also doesn't occur with `-C opt-level=s`, which uses one byte larger `addl $8, %esp` instead of two pops.\r\n\r\nNot sure if this happens on x86-64, at least the example works fine as the calling convention won't have to use stack there.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/45034/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/45034/timeline", "performed_via_github_app": null, "state_reason": "completed"}