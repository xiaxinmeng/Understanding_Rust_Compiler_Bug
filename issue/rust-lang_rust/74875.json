{"url": "https://api.github.com/repos/rust-lang/rust/issues/74875", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/74875/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/74875/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/74875/events", "html_url": "https://github.com/rust-lang/rust/issues/74875", "id": 667068214, "node_id": "MDU6SXNzdWU2NjcwNjgyMTQ=", "number": 74875, "title": "Joining thread in thread local storage destructor never returns on Windows", "user": {"login": "emgre", "id": 9339312, "node_id": "MDQ6VXNlcjkzMzkzMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/9339312?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emgre", "html_url": "https://github.com/emgre", "followers_url": "https://api.github.com/users/emgre/followers", "following_url": "https://api.github.com/users/emgre/following{/other_user}", "gists_url": "https://api.github.com/users/emgre/gists{/gist_id}", "starred_url": "https://api.github.com/users/emgre/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emgre/subscriptions", "organizations_url": "https://api.github.com/users/emgre/orgs", "repos_url": "https://api.github.com/users/emgre/repos", "events_url": "https://api.github.com/users/emgre/events{/privacy}", "received_events_url": "https://api.github.com/users/emgre/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}, {"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}, {"id": 632886930, "node_id": "MDU6TGFiZWw2MzI4ODY5MzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-thread-locals", "name": "A-thread-locals", "color": "f7e101", "default": false, "description": "Area: Thread local storage (TLS)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 14, "created_at": "2020-07-28T13:21:12Z", "updated_at": "2021-12-03T10:15:12Z", "closed_at": "2021-12-03T10:15:12Z", "author_association": "NONE", "active_lock_reason": null, "body": "The following code never returns on Windows. The console never prints `Done`, and sometimes the `Start thread` and `End thread` are also not even printed. On Linux, it runs as expected.\r\n\r\n```rust\r\nuse std::thread;\r\nuse std::time::Duration;\r\n\r\nstruct Test {\r\n    thread: Option<thread::JoinHandle<()>>,\r\n}\r\n\r\nimpl Test {\r\n    fn new() -> Self {\r\n        let thread = std::thread::spawn(move || {\r\n            println!(\"Start thread\");\r\n            thread::sleep(Duration::from_millis(500));\r\n            println!(\"End thread\");\r\n        });\r\n\r\n        Self {\r\n            thread: Some(thread),\r\n        }\r\n    }\r\n}\r\n\r\nimpl Drop for Test {\r\n    fn drop(&mut self) {\r\n        if let Some(thread) = self.thread.take() {\r\n            thread.join().unwrap();\r\n        }\r\n    }\r\n}\r\n\r\nfn main() {\r\n    thread_local!(\r\n        static R: Test = Test::new();\r\n    );\r\n\r\n    thread::spawn(|| {\r\n        R.with(|_| {});\r\n    })\r\n    .join()\r\n    .unwrap();\r\n\r\n    println!(\"Done\");\r\n}\r\n\r\n```\r\n\r\n([Playground](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=9859cc3e2a58baa583118162986fd457))\r\n\r\nOutput:\r\n\r\n```\r\nStart thread\r\nEnd thread\r\nDone\r\n\r\n```\r\n\r\nErrors:\r\n\r\n```\r\n   Compiling playground v0.0.1 (/playground)\r\n    Finished dev [unoptimized + debuginfo] target(s) in 1.20s\r\n     Running `target/debug/playground`\r\n\r\n```\r\n\r\nMy guess is that this wizardry is in cause: https://github.com/rust-lang/rust/blob/2c28244cf0fc9868f55070e55b8f332d196eaf3f/library/std/src/sys/windows/thread_local_key.rs#L1-L252", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/74875/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/74875/timeline", "performed_via_github_app": null, "state_reason": "completed"}