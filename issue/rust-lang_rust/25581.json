{"url": "https://api.github.com/repos/rust-lang/rust/issues/25581", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/25581/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/25581/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/25581/events", "html_url": "https://github.com/rust-lang/rust/issues/25581", "id": 77766696, "node_id": "MDU6SXNzdWU3Nzc2NjY5Ng==", "number": 25581, "title": "ICE in LLVM innards when calling an extern fn with a slice", "user": {"login": "geofft", "id": 74644, "node_id": "MDQ6VXNlcjc0NjQ0", "avatar_url": "https://avatars.githubusercontent.com/u/74644?v=4", "gravatar_id": "", "url": "https://api.github.com/users/geofft", "html_url": "https://github.com/geofft", "followers_url": "https://api.github.com/users/geofft/followers", "following_url": "https://api.github.com/users/geofft/following{/other_user}", "gists_url": "https://api.github.com/users/geofft/gists{/gist_id}", "starred_url": "https://api.github.com/users/geofft/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/geofft/subscriptions", "organizations_url": "https://api.github.com/users/geofft/orgs", "repos_url": "https://api.github.com/users/geofft/repos", "events_url": "https://api.github.com/users/geofft/events{/privacy}", "received_events_url": "https://api.github.com/users/geofft/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2015-05-18T18:58:56Z", "updated_at": "2015-05-25T05:21:39Z", "closed_at": "2015-05-23T15:57:52Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I found an [ICE in nightly on playpen](http://is.gd/L25EUH):\n\n``` rust\nextern {\n    fn f(t: &[i32]);\n}\n\nfn main() {\n    unsafe {\n        f(&[0i32]);\n    }\n}\n```\n\n```\nrustc: /home/rustbuild/src/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/llvm/lib/IR/Instructions.cpp:1083: void llvm::StoreInst::AssertOK(): Assertion `getOperand(0)->getType() == cast<PointerType>(getOperand(1)->getType())->getElementType() && \"Ptr must be a pointer to Val type!\"' failed.\nAborted (core dumped)\nplaypen: application terminated with error code 134\n```\n\nYou get a slightly different error on 1.0 stable:\n\n```\nStored value type does not match pointer operand type!\n  store { i32*, i64 }* %arg, [1 x i32]** %__arg\n [1 x i32]*Call parameter type does not match function signature!\n  %1 = load [1 x i32]** %__arg\n { i64, i64 }  call void @f([1 x i32]* %1)\nLLVM ERROR: Broken function found, compilation aborted!\nplaypen: application terminated with error code 1\n```\n\n(There's a [variant of this](http://is.gd/hYhfBZ) using a function taking an `extern fn`, instead of an extern block, to avoid the `unsafe`.)\n\nIf it helps, I got here by tracking down the claim in the [x86-64 SysV ABI (pdf, page 19)](http://www.x86-64.org/documentation/abi.pdf) that if you have a struct with two 8-byte elements, it gets passed as if you just had two separate 8-byte parameters (i.e., in two registers), instead of being passed on the stack as structs usually are. I'm not quite sure if this is related, but the errors imply there might be some confusion here.\n\nI realize that passing Rust-specific objects like slices using the `extern \"C\"` ABI isn't very meaningful, but I figured you might want the ICE report anyway.\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/25581/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/25581/timeline", "performed_via_github_app": null, "state_reason": "completed"}