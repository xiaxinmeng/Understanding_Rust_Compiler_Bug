{"url": "https://api.github.com/repos/rust-lang/rust/issues/84027", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/84027/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/84027/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/84027/events", "html_url": "https://github.com/rust-lang/rust/issues/84027", "id": 854341254, "node_id": "MDU6SXNzdWU4NTQzNDEyNTQ=", "number": 84027, "title": "ICE: index out of bounds: the len is 0 but the index is 0", "user": {"login": "ammkrn", "id": 46387933, "node_id": "MDQ6VXNlcjQ2Mzg3OTMz", "avatar_url": "https://avatars.githubusercontent.com/u/46387933?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ammkrn", "html_url": "https://github.com/ammkrn", "followers_url": "https://api.github.com/users/ammkrn/followers", "following_url": "https://api.github.com/users/ammkrn/following{/other_user}", "gists_url": "https://api.github.com/users/ammkrn/gists{/gist_id}", "starred_url": "https://api.github.com/users/ammkrn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ammkrn/subscriptions", "organizations_url": "https://api.github.com/users/ammkrn/orgs", "repos_url": "https://api.github.com/users/ammkrn/repos", "events_url": "https://api.github.com/users/ammkrn/events{/privacy}", "received_events_url": "https://api.github.com/users/ammkrn/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 307747675, "node_id": "MDU6TGFiZWwzMDc3NDc2NzU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-incr-comp", "name": "A-incr-comp", "color": "f7e101", "default": false, "description": "Area: Incremental compilation"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2021-04-09T09:18:50Z", "updated_at": "2023-05-01T10:25:32Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "Seems related to some other issues dealing with `on_disk_cache.rs`, but especially #83962 which was having trouble creating a MWE.\r\n\r\nTo reproduce:\r\n1. create a new library crate `cargo new --lib bugtest`\r\n2. create a tests folder and a new test file `a.rs`\r\n3. put either a line comment or a block comment in `a.rs` and run `cargo test`\r\n4. remove the comment and run `cargo test` again.\r\n\r\nNightly doesn't seem to have this problem, and if I delete `target` between builds, no error occurs.\r\n\r\n### Code\r\n\r\n```Rust\r\n// src/lib.rs\r\n#[cfg(test)]\r\nmod tests {\r\n    #[test]\r\n    fn it_works() {\r\n        assert_eq!(2 + 2, 4);\r\n    }\r\n}\r\n\r\n// <crate>/tests/a.rs is empty, see note above\r\n```\r\n\r\n\r\n### Meta\r\n`rustc --version --verbose`:\r\n```\r\nustc 1.51.0 (2fd73fabe 2021-03-23)\r\nbinary: rustc\r\ncommit-hash: 2fd73fabe469357a12c2c974c140f67e7cdd76d0\r\ncommit-date: 2021-03-23\r\nhost: x86_64-apple-darwin\r\nrelease: 1.51.0\r\nLLVM version: 11.0.1\r\n```\r\n\r\n### Error output\r\n\r\n```\r\nthread 'rustc' panicked at 'index out of bounds: the len is 0 but the index is 0', compiler/rustc_middle/src/ty/query/on_disk_cache.rs:883:18\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary><strong>Backtrace</strong></summary>\r\n<p>\r\n\r\n```\r\nstack backtrace:\r\n   0:        0x115c04394 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::h18cc31b07c2f1a67\r\n   1:        0x115c6884d - core::fmt::write::h24f8349e8e89c9af\r\n   2:        0x115bf7226 - std::io::Write::write_fmt::hc54d7d6e95b15753\r\n   3:        0x115c08219 - std::panicking::default_hook::{{closure}}::h11b550d560f5cc66\r\n   4:        0x115c07da9 - std::panicking::default_hook::he168e99d1cf91c3c\r\n   5:        0x10df69bb3 - rustc_driver::report_ice::h6aa3867cd8d12595\r\n   6:        0x115c089fe - std::panicking::rust_panic_with_hook::hf87bfc4afef21ea6\r\n   7:        0x115c08505 - std::panicking::begin_panic_handler::{{closure}}::h19ac9cd24a19b238\r\n   8:        0x115c04838 - std::sys_common::backtrace::__rust_end_short_backtrace::h5fc3f41df3517232\r\n   9:        0x115c0846a - _rust_begin_unwind\r\n  10:        0x115c91e4f - core::panicking::panic_fmt::habd0855285375977\r\n  11:        0x115c91e16 - core::panicking::panic_bounds_check::he5e20866df707d5e\r\n  12:        0x111ea633e - rustc_middle::ty::query::on_disk_cache::<impl rustc_serialize::serialize::Decodable<rustc_middle::ty::query::on_disk_cache::CacheDecoder> for rustc_span::span_encoding::Span>::decode::h1e9997ba33fbc3f7\r\n  13:        0x111fcd25c - rustc_middle::mir::_DERIVE_rustc_serialize_Decodable_D_FOR_SourceInfo::<impl rustc_serialize::serialize::Decodable<__D> for rustc_middle::mir::SourceInfo>::decode::haf221a4927ffd30d\r\n  14:        0x111fd5ea6 - rustc_middle::mir::_DERIVE_rustc_serialize_Decodable_D_FOR_Statement::<impl rustc_serialize::serialize::Decodable<__D> for rustc_middle::mir::Statement>::decode::he1d0b173f8ef1a3c\r\n  15:        0x11240b525 - rustc_serialize::serialize::Decoder::read_seq::h01887d60b8f67867\r\n  16:        0x111fd8054 - rustc_middle::mir::_DERIVE_rustc_serialize_Decodable_D_FOR_BasicBlockData::<impl rustc_serialize::serialize::Decodable<__D> for rustc_middle::mir::BasicBlockData>::decode::h2afc8b38166d1a38\r\n  17:        0x112410ea5 - rustc_serialize::serialize::Decoder::read_seq::hb9483adbceaa49e4\r\n  18:        0x111fdb1c6 - rustc_middle::mir::_DERIVE_rustc_serialize_Decodable_D_FOR_Body::<impl rustc_serialize::serialize::Decodable<__D> for rustc_middle::mir::Body>::decode::h985284e2e2ddaad9\r\n  19:        0x112444514 - rustc_middle::ty::query::on_disk_cache::OnDiskCache::try_load_query_result::h6443a34ca18c5fc5\r\n  20:        0x1121610af - rustc_query_system::query::plumbing::load_from_disk_and_cache_in_memory::h35169eb6410a502f\r\n  21:        0x111e5c410 - rustc_data_structures::stack::ensure_sufficient_stack::h8d3b48667ef06544\r\n  22:        0x11205f681 - rustc_query_system::query::plumbing::get_query_impl::h2b4f706333e688e3\r\n  23:        0x11225eaa5 - rustc_middle::ty::<impl rustc_middle::ty::context::TyCtxt>::instance_mir::he0978bb281277c57\r\n  24:        0x110e011ca - rustc_mir::monomorphize::collector::collect_neighbours::h47b37e5990f3afcb\r\n  25:        0x110dfbb05 - rustc_mir::monomorphize::collector::collect_items_rec::hcd74c1707c6ec78f\r\n  26:        0x111102b61 - rustc_session::utils::<impl rustc_session::session::Session>::time::ha1ee399cb3fe0f28\r\n  27:        0x110dfaa07 - rustc_mir::monomorphize::collector::collect_crate_mono_items::h5114ef167d49c1b0\r\n  28:        0x110f0bedf - rustc_mir::monomorphize::partitioning::collect_and_partition_mono_items::h86a5e6b8450fe938\r\n  29:        0x10e2b9ba5 - rustc_middle::ty::query::<impl rustc_query_system::query::config::QueryAccessors<rustc_middle::ty::context::TyCtxt> for rustc_middle::ty::query::queries::collect_and_partition_mono_items>::compute::hdf730f7c751072f9\r\n  30:        0x10e1ea32b - rustc_middle::dep_graph::<impl rustc_query_system::dep_graph::DepKind for rustc_middle::dep_graph::dep_node::DepKind>::with_deps::h05b3be785a67773f\r\n  31:        0x10e344d2d - rustc_query_system::dep_graph::graph::DepGraph<K>::with_task_impl::h7d3bad97b315fab8\r\n  32:        0x10e27ad18 - rustc_data_structures::stack::ensure_sufficient_stack::h430578ba4edcc55b\r\n  33:        0x10e2f93f0 - rustc_query_system::query::plumbing::force_query_with_job::he6798077e257fb76\r\n  34:        0x10e2e416f - rustc_query_system::query::plumbing::get_query_impl::hba4bc5f0e0530e1e\r\n  35:        0x10e2bbb99 - rustc_codegen_ssa::base::codegen_crate::hf174017302958f95\r\n  36:        0x10e31df13 - <rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_ssa::traits::backend::CodegenBackend>::codegen_crate::hfb775c0bdadfb20b\r\n  37:        0x10e12e89f - rustc_interface::passes::QueryContext::enter::hc7070429d8c5bd75\r\n  38:        0x10e16e250 - rustc_interface::queries::Queries::ongoing_codegen::hbf5b16e7a7d51d8b\r\n  39:        0x10df88c9e - rustc_interface::queries::<impl rustc_interface::interface::Compiler>::enter::hec3d8a4aa25044cd\r\n  40:        0x10df6c954 - rustc_span::with_source_map::h615f5706a6fcb422\r\n  41:        0x10df89d44 - rustc_interface::interface::create_compiler_and_run::h58c4a2a7d59da299\r\n  42:        0x10df6da35 - rustc_span::with_session_globals::h64b26cdf111538e9\r\n  43:        0x10df8b9de - std::sys_common::backtrace::__rust_begin_short_backtrace::hc81e03926779116c\r\n  44:        0x10dfb1bc9 - core::ops::function::FnOnce::call_once{{vtable.shim}}::hedc61e08ab686125\r\n  45:        0x115c15c8d - std::sys::unix::thread::Thread::new::thread_start::ha736b2d9de7b4dbc\r\n  46:     0x7fff20643950 - __pthread_start\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/84027/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/84027/timeline", "performed_via_github_app": null, "state_reason": null}