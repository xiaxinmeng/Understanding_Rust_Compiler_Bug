{"url": "https://api.github.com/repos/rust-lang/rust/issues/77576", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/77576/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/77576/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/77576/events", "html_url": "https://github.com/rust-lang/rust/issues/77576", "id": 714958581, "node_id": "MDU6SXNzdWU3MTQ5NTg1ODE=", "number": 77576, "title": "rust-lang/rust CI build failed when generating test file paths exceeding about 260 chars on Windows", "user": {"login": "richkadel", "id": 3827298, "node_id": "MDQ6VXNlcjM4MjcyOTg=", "avatar_url": "https://avatars.githubusercontent.com/u/3827298?v=4", "gravatar_id": "", "url": "https://api.github.com/users/richkadel", "html_url": "https://github.com/richkadel", "followers_url": "https://api.github.com/users/richkadel/followers", "following_url": "https://api.github.com/users/richkadel/following{/other_user}", "gists_url": "https://api.github.com/users/richkadel/gists{/gist_id}", "starred_url": "https://api.github.com/users/richkadel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/richkadel/subscriptions", "organizations_url": "https://api.github.com/users/richkadel/orgs", "repos_url": "https://api.github.com/users/richkadel/repos", "events_url": "https://api.github.com/users/richkadel/events{/privacy}", "received_events_url": "https://api.github.com/users/richkadel/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 120005, "node_id": "MDU6TGFiZWwxMjAwMDU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-testsuite", "name": "A-testsuite", "color": "f7e101", "default": false, "description": "Area: The testsuite used to check the correctness of rustc"}, {"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 325438536, "node_id": "MDU6TGFiZWwzMjU0Mzg1MzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-bootstrap", "name": "T-bootstrap", "color": "bfd4f2", "default": false, "description": "Relevant to the bootstrap subteam: Rust's build system (x.py and src/bootstrap)"}, {"id": 2345380158, "node_id": "MDU6TGFiZWwyMzQ1MzgwMTU4", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-contributor-roadblock", "name": "A-contributor-roadblock", "color": "f7e101", "default": false, "description": "Area: Makes things more difficult for new contributors to rust itself"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2020-10-05T15:49:47Z", "updated_at": "2021-11-02T09:04:43Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "### The problem and a proposed guard to avoid wasting time and resources\r\n\r\nThis bug (panic message shown below) resulted from a combination of components with long names, resulting in mir-dump output that tried to create a file path exceeding Windows' 260 byte (give or take?) max path length limit.\r\n\r\nThe `bors` CI builds for Windows, under both MSVC and mingw/gnu are susceptible to this kind of failure.\r\n\r\nI worked around the problem by abbreviating directory names, rust program file names, and symbols inside the rust program, all of which contributed to the long path name.\r\n\r\nThe error messages produced by Rust and/or Windows (`NotFound`) offer no obvious clue that the problem is the path length. (Thankfully I knew enough to suspect it, but others may not.)\r\n\r\nThis was not caught until I ran the tests under CI, and it happened more than once (at least once under MSVC, which I fixed, and then again under mingw, because I didn't shrink the paths enough the first time.\r\n\r\n1. It is hard to diagnose.\r\n2. It costs the developer a lot of time to find and fix the problem.\r\n3. It wastes CI resources, and backs up the bors queue for others.\r\n\r\nThis is something that could be caught early, during development (even before sending to bors).\r\n\r\nMy recommendation is, when `compiletest` runs a test on any platform (e.g., Linux or MacOS, where this problem does not crop up naturally because they don't have path limits), `compiletest` should check the lengths of all generated files in the `build/<target>/src/test` directory. Strip the directory prefix up through `build`, and if the remaining subpath of any file path is greater than, say, 215 characters, generate an error or warning (something the developer won't miss) that their test is generating paths that may exceed path limits on Windows, and may not pass CI.\r\n\r\nThis should be enough to get the developer to update their tests and avoid the entire problem.\r\n\r\n### Meta\r\n\r\n```\r\n./build/x86_64-unknown-linux-gnu/stage1/bin/rustc --version --verbose\r\nrustc 1.49.0-dev\r\nbinary: rustc\r\ncommit-hash: unknown\r\ncommit-date: unknown\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.49.0-dev\r\nLLVM version: 11.0\r\n```\r\n\r\n### Error output\r\n\r\n(Newlines inserted for readability.)\r\n\r\n```\r\nthread 'rustc' panicked at 'Unexpected error creating MIR spanview HTML file: \r\nCustom { kind: NotFound, error: \"IO error creating MIR dump file: \r\n\\\"D:/a/rust/rust/build/x86_64-pc-windows-gnu/test/run-make-fulldeps/\r\ninstrument-coverage-mir-cov-html-link-dead-code/instrument-coverage-mir-cov-html-link-dead-code/\r\nmir_dump.inner_items\\\\\\\\inner_items.main-InnerTrait-default_trait_func.-------.InstrumentCoverage.0.html\\\";\r\nThe system cannot find the path specified. (os error 3)\" }', \r\ncompiler\\rustc_mir\\src\\transform\\instrument_coverage.rs:613:14```\r\n\r\n\r\n\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/77576/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/77576/timeline", "performed_via_github_app": null, "state_reason": null}