{"url": "https://api.github.com/repos/rust-lang/rust/issues/65290", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/65290/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/65290/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/65290/events", "html_url": "https://github.com/rust-lang/rust/issues/65290", "id": 505562086, "node_id": "MDU6SXNzdWU1MDU1NjIwODY=", "number": 65290, "title": "RISC-V: Inline assembly ecall assumes return value in incorrect register", "user": {"login": "alistair23", "id": 171674, "node_id": "MDQ6VXNlcjE3MTY3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/171674?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alistair23", "html_url": "https://github.com/alistair23", "followers_url": "https://api.github.com/users/alistair23/followers", "following_url": "https://api.github.com/users/alistair23/following{/other_user}", "gists_url": "https://api.github.com/users/alistair23/gists{/gist_id}", "starred_url": "https://api.github.com/users/alistair23/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alistair23/subscriptions", "organizations_url": "https://api.github.com/users/alistair23/orgs", "repos_url": "https://api.github.com/users/alistair23/repos", "events_url": "https://api.github.com/users/alistair23/events{/privacy}", "received_events_url": "https://api.github.com/users/alistair23/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 91598611, "node_id": "MDU6TGFiZWw5MTU5ODYxMQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-inline-assembly", "name": "A-inline-assembly", "color": "f7e101", "default": false, "description": "Area: inline asm!(..)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2019-10-10T23:37:49Z", "updated_at": "2019-10-11T00:41:42Z", "closed_at": "2019-10-11T00:02:07Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The following 32-bit RISC-V Rust code\r\n\r\n```rust\r\npub unsafe fn allow_ptr(major: usize, minor: usize, slice: *mut u8, len: usize) -> isize {\r\n    let res;\r\n    asm!(\"li    a0, 3\r\n          ecall\"\r\n         : \"=r\" (res)\r\n         : \"{x11}\" (major), \"{x12}\" (minor), \"{x13}\" (slice), \"{x14}\" (len)\r\n         : \"memory\"\r\n         : \"volatile\");\r\n    res\r\n}\r\n```\r\nCompiles to this:\r\n```asm\r\npub unsafe fn allow_ptr(major: usize, minor: usize, slice: *mut u8, len: usize) -> isize {\r\n20431596:       7179                    addi    sp,sp,-48\r\n20431598:       d606                    sw      ra,44(sp)\r\n2043159a:       d422                    sw      s0,40(sp)\r\n2043159c:       1800                    addi    s0,sp,48\r\n2043159e:       feb42423                sw      a1,-24(s0)\r\n204315a2:       fea42223                sw      a0,-28(s0)\r\n204315a6:       fec42623                sw      a2,-20(s0)\r\n204315aa:       fed42823                sw      a3,-16(s0)\r\n    let res;\r\n    asm!(\"li    a0, 3\r\n204315ae:       feb42023                sw      a1,-32(s0)\r\n204315b2:       85aa                    mv      a1,a0\r\n204315b4:       fe042503                lw      a0,-32(s0)\r\n204315b8:       fcc42e23                sw      a2,-36(s0)\r\n204315bc:       862a                    mv      a2,a0\r\n204315be:       fdc42703                lw      a4,-36(s0)\r\n204315c2:       fcd42c23                sw      a3,-40(s0)\r\n204315c6:       86ba                    mv      a3,a4\r\n204315c8:       fd842703                lw      a4,-40(s0)\r\n204315cc:       450d                    li      a0,3\r\n204315ce:       00000073                ecall\r\n204315d2:       feb42a23                sw      a1,-12(s0)\r\n         : \"=r\" (res)\r\n         : \"{x11}\" (major), \"{x12}\" (minor), \"{x13}\" (slice), \"{x14}\" (len)\r\n         : \"memory\"\r\n         : \"volatile\");\r\n    res\r\n}\r\n204315d6:       852e                    mv      a0,a1\r\n204315d8:       5422                    lw      s0,40(sp)\r\n204315da:       50b2                    lw      ra,44(sp)\r\n204315dc:       6145                    addi    sp,sp,48\r\n204315de:       8082                    ret\r\n```\r\n\r\nUsing:\r\n\r\n> rustc 1.40.0-nightly (f3c9cece7 2019-10-07)\r\n\r\nAs you can see, the compiled code assumes that the return value of the ecall is saved into a1 (x11). For the RISC-V ABI this is incorrect as the first return value should be saved into a0 [see here](https://github.com/riscv/riscv-elf-psabi-doc/blob/master/riscv-elf.md#-integer-calling-convention).\r\n\r\nChanging the output line to:\r\n\r\n```asm\r\n: \"={x10}\" (res)\r\n```\r\n\r\nfixes the problem.", "closed_by": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/65290/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/65290/timeline", "performed_via_github_app": null, "state_reason": "completed"}