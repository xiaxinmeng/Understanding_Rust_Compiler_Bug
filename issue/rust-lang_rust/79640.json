{"url": "https://api.github.com/repos/rust-lang/rust/issues/79640", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/79640/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/79640/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/79640/events", "html_url": "https://github.com/rust-lang/rust/issues/79640", "id": 755401173, "node_id": "MDU6SXNzdWU3NTU0MDExNzM=", "number": 79640, "title": "Code coverage does not work on armv7-unknown-linux-gnueabihf due to missing `profiler_builtins`", "user": {"login": "FibreFoX", "id": 1042579, "node_id": "MDQ6VXNlcjEwNDI1Nzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1042579?v=4", "gravatar_id": "", "url": "https://api.github.com/users/FibreFoX", "html_url": "https://github.com/FibreFoX", "followers_url": "https://api.github.com/users/FibreFoX/followers", "following_url": "https://api.github.com/users/FibreFoX/following{/other_user}", "gists_url": "https://api.github.com/users/FibreFoX/gists{/gist_id}", "starred_url": "https://api.github.com/users/FibreFoX/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/FibreFoX/subscriptions", "organizations_url": "https://api.github.com/users/FibreFoX/orgs", "repos_url": "https://api.github.com/users/FibreFoX/repos", "events_url": "https://api.github.com/users/FibreFoX/events{/privacy}", "received_events_url": "https://api.github.com/users/FibreFoX/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 55301954, "node_id": "MDU6TGFiZWw1NTMwMTk1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-Arm", "name": "O-Arm", "color": "6e6ec0", "default": false, "description": "Target: 32-bit Arm processors (armv6, armv7, thumb...), including 64-bit Arm in AArch32 state"}, {"id": 2483744621, "node_id": "MDU6TGFiZWwyNDgzNzQ0NjIx", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-code-coverage", "name": "A-code-coverage", "color": "f7e101", "default": false, "description": "Area: Source-based code coverage (-Cinstrument-coverage)"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 11, "created_at": "2020-12-02T16:00:45Z", "updated_at": "2022-07-13T10:29:20Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I am new to the Rust ecosystem, but as part of my own learning curve, I wanted to create a small personal project which includes test coverage executed on my raspberry pi server.\r\n\r\nMy setup contains a self-hosted Gitlab-instance (which runs inside docker) running on a 32-bit based Raspbian on my Raspberry Pi 4 (with 8gb RAM). After some hours of trying to get [grcov](https://github.com/mozilla/grcov) working I tried to reproduce my problems, and found out, that `profiler_builtins` are missing for armv7-unknown-linux-gnueabihf.\r\n\r\nI opened up an issue on the GRCOV-project (https://github.com/mozilla/grcov/issues/508), because I first thought I was missing some important instruction to set up my system. It now seems to me that the package provided via `rustup` does not include the required crates/libs to make it work to have code coverage being analysed.\r\n\r\n\r\n### Steps to reproduce\r\n\r\n* install the docker engine + docker cli (locally on intel/amd-based system; and on a raspberry pi with 32bit operating system)\r\n* create a new project in a new folder `rust-project` containing a normal project (inited via `cargo init`)\r\n```\r\nroot@9c75a90fc396:/# tree ./rust-project\r\n./rust-project\r\n|-- Cargo.lock\r\n|-- Cargo.toml\r\n`-- src\r\n    `-- main.rs\r\n```\r\nContent of `main.rs`:\r\n```\r\nfn main() {\r\n\tprintln!(\"Message: {}\", get_message());\r\n}\r\n\r\nfn get_message() -> &'static str {\r\n\treturn \"Hello, world!\";\r\n}\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n\tuse super::get_message;\r\n\t#[test]\r\n\tfn check_message() {\r\n\t\tassert_eq!(get_message(), \"Hello, world!\");\r\n\t}\r\n}\r\n```\r\n\r\n* create a `Dockerfile` aside of that folder:\r\n\r\n```\r\n# Dockerfile\r\nFROM rust:latest\r\n\r\nARG DEBIAN_FRONTEND=noninteractive\r\n\r\nRUN apt-get update && apt-get install -y lcov\r\nRUN rustup toolchain install nightly\r\nRUN cargo install grcov\r\n\r\nCOPY ./rust-project /rust-project\r\n\r\nWORKDIR /rust-project\r\n```\r\n\r\n* create that container: `docker build -t rust-grcov-raspberry-bug:latest .`\r\n* run container: `docker run --rm -ti rust-grcov-raspberry-bug:latest`\r\n* execute the following inside the container:\r\n```\r\nexport CARGO_INCREMENTAL=0\r\nexport RUSTFLAGS=\"-Zprofile -Ccodegen-units=1 -Copt-level=0 -Clink-dead-code -Coverflow-checks=off -Zpanic_abort_tests -Cpanic=abort\"\r\nexport RUSTDOCFLAGS=\"-Cpanic=abort\"\r\ncargo +nightly test --verbose\r\n```\r\n\r\n### Result on Raspberry Pi 4 (32bit arm)\r\n```\r\nroot@bfbc64ce82c2:/rust-project# cargo +nightly test --verbose\r\n   Compiling rust-project v0.1.0 (/rust-project)\r\n     Running `rustc --crate-name rust_project --edition=2018 src/main.rs --error-format=json --json=diagnostic-rendered-ansi --emit=dep-info,link -C embed-bitcode=no -C debuginfo=2 --test -C metadata=a223de0c0bfa7c21 -C extra-filename=-a223de0c0bfa7c21 --out-dir /rust-project/target/debug/deps -L dependency=/rust-project/target/debug/deps -Zprofile -Ccodegen-units=1 -Copt-level=0 -Clink-dead-code -Coverflow-checks=off -Zpanic_abort_tests -Cpanic=abort`\r\nerror[E0463]: can't find crate for `profiler_builtins`\r\n  |\r\n  = note: the compiler may have been built without the profiler runtime\r\n\r\nerror: aborting due to previous error\r\n\r\nFor more information about this error, try `rustc --explain E0463`.\r\nerror: could not compile `rust-project`\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name rust_project --edition=2018 src/main.rs --error-format=json --json=diagnostic-rendered-ansi --emit=dep-info,link -C embed-bitcode=no -C debuginfo=2 --test -C metadata=a223de0c0bfa7c21 -C extra-filename=-a223de0c0bfa7c21 --out-dir /rust-project/target/debug/deps -L dependency=/rust-project/target/debug/deps -Zprofile -Ccodegen-units=1 -Copt-level=0 -Clink-dead-code -Coverflow-checks=off -Zpanic_abort_tests -Cpanic=abort` (exit code: 1)\r\n\r\nroot@deea46aaee17:/rust-project# rustc --version --verbose\r\nrustc 1.47.0 (18bf6b4f0 2020-10-07)\r\nbinary: rustc\r\ncommit-hash: 18bf6b4f01a6feaf7259ba7cdae58031af1b7b39\r\ncommit-date: 2020-10-07\r\nhost: armv7-unknown-linux-gnueabihf\r\nrelease: 1.47.0\r\nLLVM version: 11.0\r\n\r\nroot@a0589d6db0a9:/rust-project# rustc +nightly --version --verbose\r\nrustc 1.49.0-nightly (b2d115f6d 2020-11-07)\r\nbinary: rustc\r\ncommit-hash: b2d115f6db5172c961dfeb50de15f35784dbc7c9\r\ncommit-date: 2020-11-07\r\nhost: armv7-unknown-linux-gnueabihf\r\nrelease: 1.49.0-nightly\r\n```\r\n\r\n\r\n### Result on local Windows 10 using docker-desktop (64bit amd64)\r\n```\r\nroot@9c75a90fc396:/rust-project# cargo +nightly test --verbose\r\n   Compiling rust-project v0.1.0 (/rust-project)\r\n     Running `rustc --crate-name rust_project --edition=2018 src/main.rs --error-format=json --json=diagnostic-rendered-ansi --emit=dep-info,link -C embed-bitcode=no -C debuginfo=2 --test -C metadata=e2970e522a94ba3c -C extra-filename=-e2970e522a94ba3c --out-dir /rust-project/target/debug/deps -L dependency=/rust-project/target/debug/deps -Zprofile -Ccodegen-units=1 -Copt-level=0 -Clink-dead-code -Coverflow-checks=off -Zpanic_abort_tests -Cpanic=abort`\r\n    Finished test [unoptimized + debuginfo] target(s) in 0.44s\r\n     Running `/rust-project/target/debug/deps/rust_project-e2970e522a94ba3c`\r\n\r\nrunning 1 test\r\ntest tests::check_message ... ok\r\n\r\ntest result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out\r\n\r\nroot@93adfcd192a9:/rust-project# rustc --version --verbose\r\nrustc 1.47.0 (18bf6b4f0 2020-10-07)\r\nbinary: rustc\r\ncommit-hash: 18bf6b4f01a6feaf7259ba7cdae58031af1b7b39\r\ncommit-date: 2020-10-07\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.47.0\r\nLLVM version: 11.0\r\n\r\nroot@93adfcd192a9:/rust-project# rustc +nightly --version --verbose\r\nrustc 1.49.0-nightly (b2d115f6d 2020-11-07)\r\nbinary: rustc\r\ncommit-hash: b2d115f6db5172c961dfeb50de15f35784dbc7c9\r\ncommit-date: 2020-11-07\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.49.0-nightly\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/79640/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/79640/timeline", "performed_via_github_app": null, "state_reason": null}