{"url": "https://api.github.com/repos/rust-lang/rust/issues/58394", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/58394/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/58394/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/58394/events", "html_url": "https://github.com/rust-lang/rust/issues/58394", "id": 409151722, "node_id": "MDU6SXNzdWU0MDkxNTE3MjI=", "number": 58394, "title": "Wrong glibc linked in building crates using proc_macro with linuxbrew", "user": {"login": "dalance", "id": 4331004, "node_id": "MDQ6VXNlcjQzMzEwMDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4331004?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dalance", "html_url": "https://github.com/dalance", "followers_url": "https://api.github.com/users/dalance/followers", "following_url": "https://api.github.com/users/dalance/following{/other_user}", "gists_url": "https://api.github.com/users/dalance/gists{/gist_id}", "starred_url": "https://api.github.com/users/dalance/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dalance/subscriptions", "organizations_url": "https://api.github.com/users/dalance/orgs", "repos_url": "https://api.github.com/users/dalance/repos", "events_url": "https://api.github.com/users/dalance/events{/privacy}", "received_events_url": "https://api.github.com/users/dalance/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2019-02-12T07:09:08Z", "updated_at": "2021-04-02T16:00:51Z", "closed_at": "2019-02-13T23:42:51Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "If the versions of system glibc and linuxbrew glibc are different, building crates using proc_macro (ex. serde_derive, structopt_derive) is failed at Rust 1.32.0.\r\nIn Rust 1.31.1, this issue don't occur.\r\n\r\n## Environment\r\nCentOS Linux release 7.6.1810 (Core)\r\nRust 1.32.0, 1.31.1\r\nSystem glibc: 2.17\r\nlinuxbrew glibc: 2.23\r\n\r\n## Step\r\n\r\n### Source code\r\n\r\nCargo.toml\r\n\r\n```toml\r\n[package]\r\nname = \"temp\"\r\nversion = \"0.1.0\"\r\n\r\n[dependencies]\r\nstructopt    = \"0.2.14\"\r\n```\r\n\r\nsrc/main.rs\r\n\r\n```\r\n#[macro_use]\r\nextern crate structopt;\r\nuse structopt::StructOpt;\r\n\r\n#[derive(Debug, StructOpt)]\r\npub struct Opt {}\r\n\r\nfn main() {\r\n    let _ = Opt::from_args();\r\n    println!(\"Hello, world!\");\r\n}\r\n```\r\n\r\n### Build result\r\n\r\n```\r\n$ rustup override set 1.32.0\r\n$ cargo clean; cargo run\r\n\r\n   Compiling structopt v0.2.14\r\nerror: /lib64/libc.so.6: version `GLIBC_2.18' not found (required by /home/dalance/work/repos/temp/target/debug/deps/libstructopt_derive-cdf0ae629ff7e333.so)\r\n   --> /home/dalance/.cargo/registry/src/github.com-1ecc6299db9ec823/structopt-0.2.14/src/lib.rs:490:1\r\n    |\r\n490 | extern crate structopt_derive;\r\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: Could not compile `structopt`.\r\n```\r\n\r\nThe `ldd` result of `libstructopt_derive....so` is below.\r\nIn this result, linker should search to linuxbrew's glibc, but actually search to system glibc.\r\n\r\n```\r\n$ ldd /home/dalance/work/repos/temp/target/debug/deps/libstructopt_derive-cdf0ae629ff7e333.so\r\n        linux-vdso.so.1 (0x00007fffac483000)\r\n        libdl.so.2 => /home/dalance/.linuxbrew/lib/libdl.so.2 (0x00007f2c95292000)\r\n        librt.so.1 => /home/dalance/.linuxbrew/lib/librt.so.1 (0x00007f2c95288000)\r\n        libpthread.so.0 => /home/dalance/.linuxbrew/lib/libpthread.so.0 (0x00007f2c95268000)\r\n        libgcc_s.so.1 => /home/dalance/.linuxbrew/lib/libgcc_s.so.1 (0x00007f2c95051000)\r\n        libc.so.6 => /home/dalance/.linuxbrew/lib/libc.so.6 (0x00007f2c94eb3000)\r\n        /home/dalance/.linuxbrew/Cellar/glibc/2.23/lib64/ld-linux-x86-64.so.2 (0x00007f2c9566a000)\r\n```\r\n\r\n### Workaround\r\n\r\nIf `.cargo/config` set to below, build is passed at Rust 1.32.0.\r\n\r\n```\r\n[target.x86_64-unknown-linux-gnu]\r\nlinker = \"/usr/bin/cc\"\r\n```\r\n\r\n## Broken revision\r\n\r\nI run `git bisect` from 1.31.1 to 1.32.0. The result is below.\r\n\r\n```\r\n188d2dafcdd4d0dbd54315412503fb8011d716b6 is the first bad commit\r\ncommit 188d2dafcdd4d0dbd54315412503fb8011d716b6\r\nAuthor: Eduard-Mihai Burtescu <edy.burt@gmail.com>\r\nDate:   Thu Apr 26 14:11:08 2018 +0300\r\n\r\n    Statically link proc_macro into proc macros.\r\n\r\n:040000 040000 a218f2092aad86632374db4fc3ba0effe6705d7f b8357a8a11394a8ab0f6e20875802930dd0ecc9f M      src\r\nbisect run success\r\n```\r\n\r\n`git bisect log` is below.\r\n\r\n```\r\n# bad: [9fda7c2237db910e41d6a712e9a2139b352e558b] Auto merge of #57600 - rust-lang:stable-next, r=alexcrichton\r\n# good: [b6c32da9b0481e3e9d737153286b3ff8aa39a22c] Auto merge of #56960 - pietroalbini:gpg-stable, r=pietroalbini\r\ngit bisect start '1.32.0' '1.31.1'\r\n# good: [4bd4e4130ed531a644263db26bf8461704215c77] Auto merge of #54490 - wesleywiser:rewrite_it_in_mir, r=oli-obk\r\ngit bisect good 4bd4e4130ed531a644263db26bf8461704215c77\r\n# good: [6ca7bc0eb8648abc8673a971c85b777a6bc62e16] Rollup merge of #55781 - pnkfelix:issue-54382-more-precise-spans-for-temps-and-their-drops, r=davidtwco\r\ngit bisect good 6ca7bc0eb8648abc8673a971c85b777a6bc62e16\r\n# good: [45e5a856a6551ae1b77fe8c5585e80f886b44b6e] Rollup merge of #56100 - RalfJung:visiting-generators, r=oli-obk\r\ngit bisect good 45e5a856a6551ae1b77fe8c5585e80f886b44b6e\r\n# bad: [fb2b2f5582b9eff3ee5d98ec5c9461847b6f0b2d] Rollup merge of #56367 - alexreg:move-feature-gate-tests-1, r=Centril\r\ngit bisect bad fb2b2f5582b9eff3ee5d98ec5c9461847b6f0b2d\r\n# good: [5d7717360c8f343f70a33455029355f00e39dea2] fix test\r\ngit bisect good 5d7717360c8f343f70a33455029355f00e39dea2\r\n# good: [1fe2085441c5c9afc1523c19c1c1ddbf86bae462] Rollup merge of #56322 - petrochenkov:edlints, r=eddyb\r\ngit bisect good 1fe2085441c5c9afc1523c19c1c1ddbf86bae462\r\n# bad: [b8198da4d2a9e643a9863bf4cddd82d01ebc3f71] Rollup merge of #55821 - ljedrz:cached_key_sorts, r=michaelwoerister\r\ngit bisect bad b8198da4d2a9e643a9863bf4cddd82d01ebc3f71\r\n# good: [67afeef9e472812ba85341114c21289c75790a3e] proc_macro: move to a dependency of libtest.\r\ngit bisect good 67afeef9e472812ba85341114c21289c75790a3e\r\n# bad: [eb2c71cdf2d154a217e155d96474f4988e04a253] bootstrap: don't use libraries from MUSL_ROOT on non-musl targets.\r\ngit bisect bad eb2c71cdf2d154a217e155d96474f4988e04a253\r\n# bad: [fcca22cb4072097fc2cd1ae78ff84c7d59aacda2] tests: move all proc_macro tests from -fulldeps.\r\ngit bisect bad fcca22cb4072097fc2cd1ae78ff84c7d59aacda2\r\n# bad: [d3ab4a74efad266155fcd402c8d159af9e443e3d] tests: remove ignore-stage1 where possible in proc_macro tests.\r\ngit bisect bad d3ab4a74efad266155fcd402c8d159af9e443e3d\r\n# bad: [188d2dafcdd4d0dbd54315412503fb8011d716b6] Statically link proc_macro into proc macros.\r\ngit bisect bad 188d2dafcdd4d0dbd54315412503fb8011d716b6\r\n# first bad commit: [188d2dafcdd4d0dbd54315412503fb8011d716b6] Statically link proc_macro into proc macros.\r\n```\r\n\r\n## Related issue\r\n\r\nThis issue seems to be the same.\r\nhttps://github.com/rust-lang/cargo/issues/6582", "closed_by": {"login": "dalance", "id": 4331004, "node_id": "MDQ6VXNlcjQzMzEwMDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4331004?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dalance", "html_url": "https://github.com/dalance", "followers_url": "https://api.github.com/users/dalance/followers", "following_url": "https://api.github.com/users/dalance/following{/other_user}", "gists_url": "https://api.github.com/users/dalance/gists{/gist_id}", "starred_url": "https://api.github.com/users/dalance/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dalance/subscriptions", "organizations_url": "https://api.github.com/users/dalance/orgs", "repos_url": "https://api.github.com/users/dalance/repos", "events_url": "https://api.github.com/users/dalance/events{/privacy}", "received_events_url": "https://api.github.com/users/dalance/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/58394/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/58394/timeline", "performed_via_github_app": null, "state_reason": "completed"}