{"url": "https://api.github.com/repos/rust-lang/rust/issues/54600", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/54600/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/54600/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/54600/events", "html_url": "https://github.com/rust-lang/rust/issues/54600", "id": 364213613, "node_id": "MDU6SXNzdWUzNjQyMTM2MTM=", "number": 54600, "title": "`impl_trait_in_bindings` fails with `Option<impl Trait>`", "user": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668019, "node_id": "MDU6TGFiZWwyMTE2NjgwMTk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-lang", "name": "T-lang", "color": "bfd4f2", "default": false, "description": "Relevant to the language team, which will review and decide on the PR/issue."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 631673608, "node_id": "MDU6TGFiZWw2MzE2NzM2MDg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-impl-trait", "name": "A-impl-trait", "color": "f7e101", "default": false, "description": "Area: impl Trait. Universally / existentially quantified anonymous types with static dispatch."}, {"id": 1472505091, "node_id": "MDU6TGFiZWwxNDcyNTA1MDkx", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-impl_trait_in_bindings", "name": "F-impl_trait_in_bindings", "color": "f9c0cc", "default": false, "description": "`#![feature(impl_trait_in_bindings)]`"}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 10, "created_at": "2018-09-26T21:12:03Z", "updated_at": "2021-07-23T15:14:52Z", "closed_at": "2021-07-23T15:14:52Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "This example ICEs:\r\n\r\n```rust\r\n#![feature(nll)]\r\n#![feature(impl_trait_in_bindings)]\r\n\r\nuse std::fmt::Debug;\r\n\r\nfn main() {\r\n    let x: Option<impl Debug> = Some(44_u32);\r\n    println!(\"{:?}\", x);\r\n}\r\n```\r\n\r\nThe reason is that the code which chooses when to \"reveal\" opaque types looks only for opaque types at the top level (and, oddly, it does so only if ordinary unification fails; having code that branches based on whether unification succeeded is in general a bad idea, so we should fix that too):\r\n\r\nhttps://github.com/rust-lang/rust/blob/c7df1f530b8a88f471e60e933868e7ddf456974d/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L893-L899\r\n\r\nMore deeply, though, this code is taking a somewhat flawed approach. In particular, it is looking at the results of **inference**, but -- at least presently -- opaque types can end up in the inferred type in one of two ways. (As shown by #54593.) \r\n\r\nFor example, one might have a mixture of opaque types that came from a recursive call (and which ought not to be revealed) and opaque types that the user wrote:\r\n\r\n```rust\r\n#![feature(nll)]\r\n#![feature(impl_trait_in_bindings)]\r\n\r\nuse std::fmt::Debug;\r\n\r\nfn foo() -> impl Copy {\r\n    if false {\r\n        let x: (_, impl Debug) = (foo(), 22);\r\n    }\r\n    ()\r\n}\r\n\r\nfn main() { }\r\n```\r\n\r\nThe correct way to do this, I suspect, is to leverage the user-type annotations that we are tracking for NLL.\r\n\r\ncc @alexreg @cramertj @eddyb ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/54600/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/54600/timeline", "performed_via_github_app": null, "state_reason": "completed"}