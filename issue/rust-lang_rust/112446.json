{"url": "https://api.github.com/repos/rust-lang/rust/issues/112446", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/112446/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/112446/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/112446/events", "html_url": "https://github.com/rust-lang/rust/issues/112446", "id": 1749051796, "node_id": "I_kwDOAAsO6M5oQGmU", "number": 112446, "title": "cargo doesn't transiently pass undefined symbols", "user": {"login": "DrewRidley", "id": 47063089, "node_id": "MDQ6VXNlcjQ3MDYzMDg5", "avatar_url": "https://avatars.githubusercontent.com/u/47063089?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DrewRidley", "html_url": "https://github.com/DrewRidley", "followers_url": "https://api.github.com/users/DrewRidley/followers", "following_url": "https://api.github.com/users/DrewRidley/following{/other_user}", "gists_url": "https://api.github.com/users/DrewRidley/gists{/gist_id}", "starred_url": "https://api.github.com/users/DrewRidley/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DrewRidley/subscriptions", "organizations_url": "https://api.github.com/users/DrewRidley/orgs", "repos_url": "https://api.github.com/users/DrewRidley/repos", "events_url": "https://api.github.com/users/DrewRidley/events{/privacy}", "received_events_url": "https://api.github.com/users/DrewRidley/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 609101895, "node_id": "MDU6TGFiZWw2MDkxMDE4OTU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-cargo", "name": "T-cargo", "color": "bfd4f2", "default": false, "description": "Relevant to the cargo team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2023-06-09T03:34:01Z", "updated_at": "2023-06-09T12:47:20Z", "closed_at": "2023-06-09T12:47:19Z", "author_association": "NONE", "active_lock_reason": null, "body": "Hey all,\r\n\r\nI am compiling a fairly complex library from C# with NativeAOT into a statically linked binary. NativeAOT requires that at link time, a specific argument is included ``_NativeAOT_StaticInitialization``. If I write a FFI crate to interop with this library, and add:\r\n``println!(\"cargo:rustc-link-args=-Wl,-u,_NativeAOT_StaticInitialization\");``\r\nIt seems to work at first glance. I wrote some unit tests to verify this behavior, and the unit tests pass. The undefined symbol is correctly included in the final binary and the NativeAOT code runs as expected.\r\n\r\nUnfortunately, this behavior is not consistent when the same exact unit test is copied into a dependent crate. Adding the original FFI crate as a dependency seems to cause a segmentation fault which is due to the undefined symbol no longer existing in the binary.\r\n\r\nI am not entirely sure how I can help, if it would be of assistance I can provide the specific statically linked library in question for reproduction? I suspect what happens is that when rust compiles the internal unit test, it directly links against the static lib into a binary without an intermediate ``rlib``.\r\n\r\nI was hoping someone could point me in the right direction towards a specific flag I can use here, or another tracking issue for a similar issue?\r\n\r\nAny help or guidance on this matter would be much appreciated.\r\nThanks", "closed_by": {"login": "workingjubilee", "id": 46493976, "node_id": "MDQ6VXNlcjQ2NDkzOTc2", "avatar_url": "https://avatars.githubusercontent.com/u/46493976?v=4", "gravatar_id": "", "url": "https://api.github.com/users/workingjubilee", "html_url": "https://github.com/workingjubilee", "followers_url": "https://api.github.com/users/workingjubilee/followers", "following_url": "https://api.github.com/users/workingjubilee/following{/other_user}", "gists_url": "https://api.github.com/users/workingjubilee/gists{/gist_id}", "starred_url": "https://api.github.com/users/workingjubilee/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/workingjubilee/subscriptions", "organizations_url": "https://api.github.com/users/workingjubilee/orgs", "repos_url": "https://api.github.com/users/workingjubilee/repos", "events_url": "https://api.github.com/users/workingjubilee/events{/privacy}", "received_events_url": "https://api.github.com/users/workingjubilee/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/112446/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/112446/timeline", "performed_via_github_app": null, "state_reason": "not_planned"}