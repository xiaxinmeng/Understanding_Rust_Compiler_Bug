{"url": "https://api.github.com/repos/rust-lang/rust/issues/52462", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/52462/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/52462/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/52462/events", "html_url": "https://github.com/rust-lang/rust/issues/52462", "id": 341991614, "node_id": "MDU6SXNzdWUzNDE5OTE2MTQ=", "number": 52462, "title": "Using const value from trait to construct array produces error", "user": {"login": "Bert-Proesmans", "id": 2027877, "node_id": "MDQ6VXNlcjIwMjc4Nzc=", "avatar_url": "https://avatars.githubusercontent.com/u/2027877?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Bert-Proesmans", "html_url": "https://github.com/Bert-Proesmans", "followers_url": "https://api.github.com/users/Bert-Proesmans/followers", "following_url": "https://api.github.com/users/Bert-Proesmans/following{/other_user}", "gists_url": "https://api.github.com/users/Bert-Proesmans/gists{/gist_id}", "starred_url": "https://api.github.com/users/Bert-Proesmans/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Bert-Proesmans/subscriptions", "organizations_url": "https://api.github.com/users/Bert-Proesmans/orgs", "repos_url": "https://api.github.com/users/Bert-Proesmans/repos", "events_url": "https://api.github.com/users/Bert-Proesmans/events{/privacy}", "received_events_url": "https://api.github.com/users/Bert-Proesmans/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2018-07-17T16:22:15Z", "updated_at": "2018-07-18T12:13:35Z", "closed_at": "2018-07-18T12:13:35Z", "author_association": "NONE", "active_lock_reason": null, "body": "<details>\r\n<summary>Playground code</summary>  \r\n\r\n```rust\r\nuse std::u32::MAX;\r\n\r\ntrait RPCService {\r\n    type Method;\r\n    const MAX_METHODS: usize = 4;\r\n    \r\n    // RPCService::MAX_METHODS -> ERROR\r\n    // Self::MAX_METHODS -> ERROR\r\n    // MAX_METHODS -> ERROR\r\n    fn get_methods() -> [(&'static str, u32); Self::MAX_METHODS];\r\n}\r\n\r\n#[repr(u32)]\r\nenum ConnectMethods {\r\n    Bind = 0,\r\n    Connect = 1,\r\n}\r\n\r\nstruct ConnectService {}\r\nimpl ConnectService {\r\n    pub const METHOD_BIND: ConnectMethods = ConnectMethods::Bind;\r\n    pub const METHOD_CONNECT: ConnectMethods = ConnectMethods::Connect;\r\n}\r\n\r\nimpl RPCService for ConnectService {\r\n    type Method = ConnectMethods;\r\n    \r\n    fn get_methods() -> [(&'static str, u32); Self::MAX_METHODS] {\r\n        [\r\n        (\"Bind\", ConnectMethods::Bind as u32),\r\n        (\"Connect\", ConnectMethods::Connect as u32),\r\n        (\"\", MAX),\r\n        (\"\", MAX),\r\n        ]\r\n    }\r\n}\r\n\r\n\r\nfn main() {\r\n    let bind_id = ConnectService::METHOD_BIND;\r\n}\r\n```\r\n</details>\r\n\r\n([Playground](https://play.rust-lang.org/?gist=47521af8c0670853d7d43bb3652df793&version=nightly&mode=debug&edition=2015))\r\n\r\nErrors:\r\n\r\n```\r\n   Compiling playground v0.0.1 (file:///playground)\r\nerror[E0599]: no associated item named `MAX_METHODS` found for type `Self` in the current scope\r\n  --> src/main.rs:10:47\r\n   |\r\n10 |     fn get_methods() -> [(&'static str, u32); Self::MAX_METHODS];\r\n   |                                               ^^^^^^^^^^^^^^^^^ associated item not found in `Self`\r\n   |\r\n   = help: items from traits can only be used if the trait is implemented and in scope\r\n   = note: the following trait defines an item `MAX_METHODS`, perhaps you need to implement it:\r\n           candidate #1: `RPCService`\r\n\r\nerror: aborting due to previous error\r\n\r\nFor more information about this error, try `rustc --explain E0599`.\r\nerror: Could not compile `playground`.\r\n\r\nTo learn more, run the command again with --verbose.\r\n\r\n```\r\n\r\nLike it shows above, the compiler is confused by the MAX_METHODS item within the trait that declared it. I suppose the trait impl resolves fine, because no error is produced for that span.\r\nWithin my own crate i even get an ICE, but i'm unsure if it's the same error or caused by it. This ICE is what made me build the playground example.\r\n\r\n<details>\r\n<summary>My crate's ICE</summary>  \r\n\r\n```\r\nerror[E0599]: no associated item named `MAX_METHODS` found for type `Self` in the current scope\r\n   --> src\\service.rs:141:47\r\n    |\r\n141 |     fn get_methods() -> [(&'static str, u32); Self::MAX_METHODS];\r\n    |                                               ^^^^^^^^^^^^^^^^^ associated item not found in `Self`\r\n    |\r\n    = help: items from traits can only be used if the trait is implemented and in scope\r\n    = note: the following trait defines an item `MAX_METHODS`, perhaps you need to implement it:\r\n            candidate #1: `service::RPCService`\r\n\r\nerror: internal compiler error: librustc\\traits\\codegen\\mod.rs:63: Encountered ambiguity selecting `Binder(<[type error] as service::RPCService>)` during codegen, presuming due to overflow\r\n\r\nthread 'main' panicked at 'Box<Any>', librustc_errors\\lib.rs:554:9\r\nstack backtrace:\r\n   0: <std::sys::windows::args::Args as core::ops::drop::Drop>::drop\r\n   1: <std::sync::condvar::Condvar as core::ops::drop::Drop>::drop\r\n   2: std::panicking::take_hook\r\n   3: std::panicking::take_hook\r\n   4: <rustc::ty::SymbolName as core::fmt::Display>::fmt\r\n   5: std::panicking::rust_panic_with_hook\r\n   6: <rustc_errors::emitter::ColorConfig as core::fmt::Debug>::fmt\r\n   7: rustc_errors::Handler::bug\r\n   8: rustc::session::config::OutputTypes::values\r\n   9: rustc::ty::context::tls::track_diagnostic\r\n  10: rustc::ty::context::tls::track_diagnostic\r\n  11: rustc::ty::context::tls::track_diagnostic\r\n  12: rustc::session::bug_fmt\r\n  13: rustc::session::bug_fmt\r\n  14: rustc::ty::context::tls::track_diagnostic\r\n  15: rustc::traits::codegen::codegen_fulfill_obligation\r\n  16: rustc::ty::query::on_disk_cache::__ty_decoder_impl::<impl serialize::serialize::Decoder for rustc::ty::query::on_disk_cache::CacheDecoder<'a, 'tcx, 'x>>::read_str\r\n  17: rustc::ty::context::tls::track_diagnostic\r\n  18: rustc::ty::context::tls::track_diagnostic\r\n  19: rustc::dep_graph::graph::DepGraph::assert_ignored\r\n  20: rustc::ty::context::tls::track_diagnostic\r\n  21: rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_print_query_stack\r\n  22: rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_print_query_stack\r\n  23: rustc::ty::instance::Instance::resolve\r\n  24: <rustc_mir::interpret::eval_context::Frame<'mir, 'tcx> as core::cmp::PartialEq>::eq\r\n  25: <rustc_mir::interpret::eval_context::Frame<'mir, 'tcx> as core::cmp::PartialEq>::eq\r\n  26: <&'a rustc_mir::transform::const_prop::ConstPropagator<'a, 'b, 'tcx> as rustc_target::abi::LayoutOf>::layout_of\r\n  27: <rustc_mir::transform::const_prop::ConstPropagator<'b, 'a, 'tcx> as rustc::mir::visit::Visitor<'tcx>>::visit_statement\r\n  28: <rustc_mir::transform::const_prop::ConstProp as rustc_mir::transform::MirPass>::run_pass\r\n  29: <rustc_mir::transform::MirSource as core::fmt::Debug>::fmt\r\n  30: rustc_mir::transform::optimized_mir\r\n  31: rustc::ty::query::on_disk_cache::__ty_decoder_impl::<impl serialize::serialize::Decoder for rustc::ty::query::on_disk_cache::CacheDecoder<'a, 'tcx, 'x>>::read_str\r\n  32: rustc::ty::context::tls::track_diagnostic\r\n  33: rustc::ty::context::tls::track_diagnostic\r\n  34: rustc::dep_graph::graph::DepGraph::assert_ignored\r\n  35: rustc::ty::context::tls::track_diagnostic\r\n  36: rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_print_query_stack\r\n  37: rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_print_query_stack\r\n  38: rustc::ty::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::maybe_optimized_mir\r\n  39: <rustc_mir::interpret::eval_context::Frame<'mir, 'tcx> as core::cmp::PartialEq>::eq\r\n  40: rustc_mir::interpret::const_eval::value_to_const_value\r\n  41: rustc_mir::interpret::const_eval::const_eval_provider\r\n  42: rustc::ty::query::on_disk_cache::__ty_decoder_impl::<impl serialize::serialize::Decoder for rustc::ty::query::on_disk_cache::CacheDecoder<'a, 'tcx, 'x>>::read_str\r\n  43: rustc::ty::context::tls::track_diagnostic\r\n  44: rustc::ty::context::tls::track_diagnostic\r\n  45: rustc::dep_graph::graph::DepGraph::assert_ignored\r\n  46: rustc::ty::context::tls::track_diagnostic\r\n  47: rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_print_query_stack\r\n  48: rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_print_query_stack\r\n  49: <rustc::traits::project::AssociatedTypeNormalizer<'a, 'b, 'gcx, 'tcx> as rustc::ty::fold::TypeFolder<'gcx, 'tcx>>::fold_const\r\n  50: rustc::ty::structural_impls::<impl rustc::ty::context::Lift<'tcx> for rustc::ty::sty::FnSig<'a>>::lift_to_tcx\r\n  51: <rustc::traits::project::AssociatedTypeNormalizer<'a, 'b, 'gcx, 'tcx> as rustc::ty::fold::TypeFolder<'gcx, 'tcx>>::fold_ty\r\n  52: <rustc_typeck::outlives::implicit_infer::InferVisitor<'cx, 'tcx> as rustc::hir::itemlikevisit::ItemLikeVisitor<'tcx>>::visit_item\r\n  53: <rustc_typeck::constrained_type_params::Parameter as core::fmt::Debug>::fmt\r\n  54: <rustc_typeck::outlives::implicit_infer::InferVisitor<'cx, 'tcx> as rustc::hir::itemlikevisit::ItemLikeVisitor<'tcx>>::visit_item\r\n  55: <rustc_typeck::check::method::probe::ProbeScope as core::fmt::Debug>::fmt\r\n  56: <rustc_typeck::collect::has_late_bound_regions::LateBoundRegionsDetector<'a, 'tcx> as rustc::hir::intravisit::Visitor<'tcx>>::visit_lifetime\r\n  57: <rustc_typeck::check::Diverges as core::fmt::Debug>::fmt\r\n  58: <rustc_typeck::check::writeback::Resolver<'cx, 'gcx, 'tcx> as rustc::ty::fold::TypeFolder<'gcx, 'tcx>>::fold_region\r\n  59: <rustc_typeck::check::writeback::Resolver<'cx, 'gcx, 'tcx> as rustc::ty::fold::TypeFolder<'gcx, 'tcx>>::fold_region\r\n  60: rustc::ty::context::tls::track_diagnostic\r\n  61: rustc::ty::context::tls::track_diagnostic\r\n  62: rustc::dep_graph::graph::DepGraph::assert_ignored\r\n  63: rustc::ty::context::tls::track_diagnostic\r\n  64: rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_print_query_stack\r\n  65: rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_print_query_stack\r\n  66: rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_print_query_stack\r\n  67: <rustc_typeck::check::method::probe::ProbeScope as core::fmt::Debug>::fmt\r\n  68: <rustc_typeck::check::autoderef::AutoderefKind as core::fmt::Debug>::fmt\r\n  69: rustc_typeck::check_crate\r\n  70: <humantime::duration::Error as std::error::Error>::cause\r\n  71: <rustc_driver::derive_registrar::Finder as rustc::hir::itemlikevisit::ItemLikeVisitor<'v>>::visit_item\r\n  72: <rustc_driver::Compilation as core::fmt::Debug>::fmt\r\n  73: rustc_driver::driver::compile_input\r\n  74: rustc_driver::run_compiler\r\n  75: rustc_driver::target_features::add_configuration\r\n  76: <humantime::duration::Error as std::error::Error>::cause\r\n  77: _rust_maybe_catch_panic\r\n  78: rustc_driver::profile::dump\r\n  79: rustc_driver::main\r\n  80: <unknown>\r\n  81: std::panicking::update_panic_count\r\n  82: _rust_maybe_catch_panic\r\n  83: std::rt::lang_start_internal\r\n  84: <unknown>\r\n  85: <unknown>\r\n  86: BaseThreadInitThunk\r\n  87: RtlUserThreadStart\r\nquery stack during panic:\r\n#0 [codegen_fulfill_obligation] checking if `service::RPCService` fulfills its obligations\r\n#1 [optimized_mir] processing `<services::bnet::connection_service::ConnectionService as service::RPCService>::get_methods::{{constant}}`\r\n#2 [const_eval] const-evaluating `<services::bnet::connection_service::ConnectionService as service::RPCService>::get_methods::{{constant}}`\r\n#3 [check_impl_item_well_formed] processing `<services::bnet::connection_service::ConnectionService as service::RPCService>::get_methods`\r\nend of query stack\r\nerror: aborting due to 2 previous errors\r\n\r\nFor more information about this error, try `rustc --explain E0599`.\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: rustc 1.29.0-nightly (1ecf6929d 2018-07-16) running on x86_64-pc-windows-msvc\r\n\r\nnote: compiler flags: -C debuginfo=2 -C incremental --crate-type lib\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n\r\nerror: Could not compile `incite`.\r\n\r\nTo learn more, run the command again with --verbose.\r\n ```\r\n\r\n</details>", "closed_by": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/52462/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/52462/timeline", "performed_via_github_app": null, "state_reason": "completed"}