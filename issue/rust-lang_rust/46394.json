{"url": "https://api.github.com/repos/rust-lang/rust/issues/46394", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/46394/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/46394/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/46394/events", "html_url": "https://github.com/rust-lang/rust/issues/46394", "id": 278085980, "node_id": "MDU6SXNzdWUyNzgwODU5ODA=", "number": 46394, "title": "ICE when using associated constant as an array size", "user": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 46741598, "node_id": "MDU6TGFiZWw0Njc0MTU5OA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-test", "name": "E-needs-test", "color": "02e10c", "default": false, "description": "Call for participation: writing correctness tests"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-11-30T11:24:25Z", "updated_at": "2017-11-30T15:44:05Z", "closed_at": "2017-11-30T15:44:05Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "The following code ICEs on stable:\r\n\r\n```Rust\r\ntrait Nat {\r\n    const VALUE: usize;\r\n}\r\n\r\nstruct Zero;\r\n\r\nimpl Nat for Zero {\r\n    const VALUE: usize = 0;\r\n}\r\n\r\nstruct Succ<N>(N);\r\n\r\nimpl<N: Nat> Nat for Succ<N> {\r\n    const VALUE: usize = N::VALUE + 1;\r\n}\r\n\r\nfn main() {\r\n    type A = [u8; Succ::<Succ<Zero>>::VALUE];\r\n    eprintln!(\"::std::mem::size_of::<xs>() = {:?}\", ::std::mem::size_of::<A>());\r\n}\r\n```\r\n\r\n<details>\r\n\r\n```\r\nerror: internal compiler error: /checkout/src/librustc_trans/context.rs:640: failed to get layout for `[u8; <unevaluated[]>]`: the type `[u8; <unevaluated[]>]` has an unknown layout\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: rustc 1.22.1 (05e2e1c41 2017-11-22) running on x86_64-unknown-linux-gnu\r\n\r\nnote: run with `RUST_BACKTRACE=1` for a backtrace\r\n\r\nthread 'rustc' panicked at 'Box<Any>', /checkout/src/librustc_errors/lib.rs:492:8\r\nstack backtrace:\r\n   0:     0x7f3e4c6f3e43 - std::sys::imp::backtrace::tracing::imp::unwind_backtrace::h8ed7485deb8ab958\r\n                               at /checkout/src/libstd/sys/unix/backtrace/tracing/gcc_s.rs:49\r\n   1:     0x7f3e4c6ee590 - std::sys_common::backtrace::_print::h3d4f9ea58578e60f\r\n                               at /checkout/src/libstd/sys_common/backtrace.rs:69\r\n   2:     0x7f3e4c701343 - std::panicking::default_hook::{{closure}}::h0088fe51b67c687c\r\n                               at /checkout/src/libstd/sys_common/backtrace.rs:58\r\n                               at /checkout/src/libstd/panicking.rs:381\r\n   3:     0x7f3e4c70104a - std::panicking::default_hook::hf425c768c5ffbbad\r\n                               at /checkout/src/libstd/panicking.rs:391\r\n   4:     0x7f3e4c701807 - std::panicking::rust_panic_with_hook::h25b934bb4484e9e0\r\n                               at /checkout/src/libstd/panicking.rs:577\r\n   5:     0x7f3e47e438a8 - std::panicking::begin_panic::hb516dde7009d236d\r\n   6:     0x7f3e47e61405 - rustc_errors::Handler::bug::h54cc1d8184cfe898\r\n   7:     0x7f3e49347f80 - rustc::session::opt_span_bug_fmt::{{closure}}::he1ac465da2b81207\r\n   8:     0x7f3e49347c55 - rustc::session::opt_span_bug_fmt::h5974b48e1bbe9aa6\r\n   9:     0x7f3e49347936 - rustc::session::bug_fmt::ha64c971210a59f62\r\n  10:     0x7f3e4a8a9e0b - <&'a rustc_trans::context::SharedCrateContext<'a, 'tcx> as rustc::ty::layout::LayoutTyper<'tcx>>::layout_of::hd874b5e544391a8b\r\n  11:     0x7f3e4a8da7c6 - rustc_trans::mir::constant::MirConstContext::trans::hcdac8daf54d455c0\r\n  12:     0x7f3e4a8da5c8 - rustc_trans::mir::constant::MirConstContext::trans_def::hf76cd48dc83329da\r\n  13:     0x7f3e4a8da893 - rustc_trans::mir::constant::MirConstContext::trans::hcdac8daf54d455c0\r\n  14:     0x7f3e4a8e0187 - rustc_trans::mir::constant::<impl rustc_trans::mir::MirContext<'a, 'tcx>>::trans_constant::h300c9b809c076638\r\n  15:     0x7f3e4a8e3731 - rustc_trans::mir::operand::<impl rustc_trans::mir::MirContext<'a, 'tcx>>::trans_operand::h7418e0c869f6f1ba\r\n  16:     0x7f3e4a8e4f33 - rustc_trans::mir::rvalue::<impl rustc_trans::mir::MirContext<'a, 'tcx>>::trans_rvalue_operand::hf512e3355ec46093\r\n  17:     0x7f3e4a8cf906 - rustc_trans::mir::trans_mir::h2a0b6e1a7a38e7bd\r\n  18:     0x7f3e4a88d8be - rustc_trans::base::trans_instance::h1c470d3104ad2a98\r\n  19:     0x7f3e4a899ea1 - rustc_trans::base::compile_codegen_unit::he7f773e2d7fbe06e\r\n  20:     0x7f3e4958d9b7 - rustc::ty::maps::<impl rustc::ty::maps::queries::compile_codegen_unit<'tcx>>::force::h19824cb5f217305d\r\n  21:     0x7f3e4958e9df - rustc::ty::maps::<impl rustc::ty::maps::queries::compile_codegen_unit<'tcx>>::try_get::hf856a8538a3d36f6\r\n  22:     0x7f3e495a1043 - rustc::ty::maps::TyCtxtAt::compile_codegen_unit::h4ab897227d123c6d\r\n  23:     0x7f3e49598967 - rustc::ty::maps::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'lcx>>::compile_codegen_unit::habecaff1f58fc5b4\r\n  24:     0x7f3e4a890243 - rustc_trans::base::trans_crate::h60046f7f3676a313\r\n  25:     0x7f3e4a8f5fe3 - <rustc_trans::LlvmTransCrate as rustc_trans_utils::trans_crate::TransCrate>::trans_crate::hc216841f6d249410\r\n  26:     0x7f3e4caa60f3 - rustc_driver::driver::compile_input::{{closure}}::h46c1758fee8f92a3\r\n  27:     0x7f3e4ca269b7 - rustc::ty::context::TyCtxt::create_and_enter::h3dad1968772b9cec\r\n  28:     0x7f3e4caa3d4b - rustc_driver::driver::compile_input::h4bf59ac61f928939\r\n  29:     0x7f3e4cabf9fe - rustc_driver::run_compiler::h2a410e29e6088b6b\r\n  30:     0x7f3e4c9de7c7 - std::sys_common::backtrace::__rust_begin_short_backtrace::hb62d9d382e421fd7\r\n  31:     0x7f3e4c73bbdc - __rust_maybe_catch_panic\r\n                               at /checkout/src/libpanic_unwind/lib.rs:99\r\n  32:     0x7f3e4ca17870 - <F as alloc::boxed::FnBox<A>>::call_box::h56ea5c52b2f008af\r\n  33:     0x7f3e4c70020b - std::sys::imp::thread::Thread::new::thread_start::hbaf1b5aa1ca8e3ea\r\n                               at /checkout/src/liballoc/boxed.rs:736\r\n                               at /checkout/src/libstd/sys_common/thread.rs:24\r\n                               at /checkout/src/libstd/sys/unix/thread.rs:90\r\n  34:     0x7f3e475d3233 - start_thread\r\n  35:     0x7f3e4c3cd75e - clone\r\n  36:                0x0 - <unknown>\r\n```\r\n\r\n</details>\r\n\r\nAdditionally, the following code fails to compile with a wrong error message:\r\n\r\n```Rust\r\ntrait Nat {\r\n    const VALUE: usize;\r\n}\r\n\r\nstruct Zero;\r\n\r\nimpl Nat for Zero {\r\n    const VALUE: usize = 0;\r\n}\r\n\r\nstruct Succ<N>(N);\r\n\r\nimpl<N: Nat> Nat for Succ<N> {\r\n    const VALUE: usize = N::VALUE + 1;\r\n}\r\n\r\nstruct S<N: Nat> {\r\n    data: [u8; N::VALUE]\r\n            // ^^^^^^^^ no associated item named `VALUE` found for type `N` in the current scope\r\n}\r\n\r\nfn main() {\r\n}\r\n```\r\n\r\nI understand that this is probably just the expected behavior at the moment, because real const generics are not yet implemented, and this is basically const generics :)", "closed_by": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/46394/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/46394/timeline", "performed_via_github_app": null, "state_reason": "completed"}