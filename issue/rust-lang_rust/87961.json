{"url": "https://api.github.com/repos/rust-lang/rust/issues/87961", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/87961/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/87961/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/87961/events", "html_url": "https://github.com/rust-lang/rust/issues/87961", "id": 968575416, "node_id": "MDU6SXNzdWU5Njg1NzU0MTY=", "number": 87961, "title": "Clarification of compiler diagnostic 'no two closures, even if identical, have the same type'", "user": {"login": "GregAC", "id": 471032, "node_id": "MDQ6VXNlcjQ3MTAzMg==", "avatar_url": "https://avatars.githubusercontent.com/u/471032?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GregAC", "html_url": "https://github.com/GregAC", "followers_url": "https://api.github.com/users/GregAC/followers", "following_url": "https://api.github.com/users/GregAC/following{/other_user}", "gists_url": "https://api.github.com/users/GregAC/gists{/gist_id}", "starred_url": "https://api.github.com/users/GregAC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GregAC/subscriptions", "organizations_url": "https://api.github.com/users/GregAC/orgs", "repos_url": "https://api.github.com/users/GregAC/repos", "events_url": "https://api.github.com/users/GregAC/events{/privacy}", "received_events_url": "https://api.github.com/users/GregAC/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2021-08-12T10:52:13Z", "updated_at": "2022-08-24T13:37:01Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "Consider the following function which returns a closure `impl`\r\n\r\n```rust\r\nfn returns_closure(hmm: bool) -> impl Fn(i32) -> i32 {\r\n    if hmm {\r\n        |x| x + 1\r\n    } else {\r\n        |x| x * 2\r\n    }\r\n}\r\n\r\nfn main() {\r\n    println!(\"{}\", returns_closure(true)(10));\r\n    println!(\"{}\", returns_closure(false)(10));\r\n}\r\n```\r\nhttps://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=5d676e682519cae13533bd1d5c82ebd3\r\n\r\nThis builds and runs providing the following output:\r\n\r\n```\r\n11\r\n20\r\n```\r\n\r\nThis seems reasonable at first glance, however consider a changed version:\r\n```rust\r\nfn returns_closure(hmm: bool, y: u32) -> impl Fn(i32) -> i32 {\r\n    if hmm {\r\n        |x| x + y\r\n    } else {\r\n        |x| x * y\r\n    }\r\n}\r\n\r\nfn main() {\r\n    println!(\"{}\", returns_closure(true, 3)(10));\r\n    println!(\"{}\", returns_closure(false, 4)(10));\r\n}\r\n```\r\nhttps://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=43bdb248873d31bc470b0fc9fb8a2ab3\r\n\r\nThis fails to build with:\r\n\r\n```\r\nerror[E0308]: `if` and `else` have incompatible types\r\n --> src/main.rs:5:9\r\n  |\r\n2 | /     if hmm {\r\n3 | |         |x| x + y\r\n  | |         --------- expected because of this\r\n4 | |     } else {\r\n5 | |         |x| x * y\r\n  | |         ^^^^^^^^^ expected closure, found a different closure\r\n6 | |     }\r\n  | |_____- `if` and `else` have incompatible types\r\n  |\r\n  = note: expected type `[closure@src/main.rs:3:9: 3:18]`\r\n          found closure `[closure@src/main.rs:5:9: 5:18]`\r\n  = note: no two closures, even if identical, have the same type\r\n  = help: consider boxing your closure and/or using it as a trait object\r\n\r\nFor more information about this error, try `rustc --explain E0308`.\r\n```\r\n\r\nThe first example uses two closures and compiles and runs fine, demonstrating we do have two closures of the same type which the output from the second example states cannot happen.\r\n\r\nI suspect what's happening is the first closures don't capture from the environment so are seen as function pointers both with type `fn(i32) -> i32`. So this is just an issue of clarifying the second error message e.g. 'no two closure which capture the environment, even if identical, have the same type'. \r\n\r\nChanging the first example as follows seems to confirm this:\r\n\r\n```rust\r\nfn returns_closure(hmm: bool) -> fn(i32) -> i32 {\r\n    if hmm {\r\n        |x| x + 1\r\n    } else {\r\n        |x| x * 2\r\n    }\r\n}\r\n\r\nfn main() {\r\n    println!(\"{}\", returns_closure(true)(10));\r\n    println!(\"{}\", returns_closure(false)(10));\r\n}\r\n```\r\nhttps://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=c628f6a790b886b7975542a7fd89f734\r\n\r\n(Builds and runs with identical results to the first example)\r\n\r\nFrom reading the rust reference you could say 'closure' inherently means environment capture (i.e. `|x| x + 1` is not a closure), but that conflicts with language used in the rust book so could lead to confusion.\r\n\r\nIf it's intended that closures from the first example should have different types there's something more serious going on with the type inference/checking.\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.56.0-nightly (ccffcafd5 2021-08-11)\r\nbinary: rustc\r\ncommit-hash: ccffcafd55e58f769d4b0efc0064bf65e76998e4\r\ncommit-date: 2021-08-11\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.56.0-nightly\r\nLLVM version: 12.0.1\r\n```\r\n\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/87961/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/87961/timeline", "performed_via_github_app": null, "state_reason": null}