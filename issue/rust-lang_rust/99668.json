{"url": "https://api.github.com/repos/rust-lang/rust/issues/99668", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/99668/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/99668/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/99668/events", "html_url": "https://github.com/rust-lang/rust/issues/99668", "id": 1315889591, "node_id": "I_kwDOAAsO6M5ObuG3", "number": 99668, "title": "How should we expose atomic load/store on targets that don't support full atomics", "user": {"login": "Amanieu", "id": 278509, "node_id": "MDQ6VXNlcjI3ODUwOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/278509?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Amanieu", "html_url": "https://github.com/Amanieu", "followers_url": "https://api.github.com/users/Amanieu/followers", "following_url": "https://api.github.com/users/Amanieu/following{/other_user}", "gists_url": "https://api.github.com/users/Amanieu/gists{/gist_id}", "starred_url": "https://api.github.com/users/Amanieu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Amanieu/subscriptions", "organizations_url": "https://api.github.com/users/Amanieu/orgs", "repos_url": "https://api.github.com/users/Amanieu/repos", "events_url": "https://api.github.com/users/Amanieu/events{/privacy}", "received_events_url": "https://api.github.com/users/Amanieu/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 203429200, "node_id": "MDU6TGFiZWwyMDM0MjkyMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-high", "name": "P-high", "color": "eb6420", "default": false, "description": "High priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 4434017660, "node_id": "LA_kwDOAAsO6M8AAAABCEm9fA", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-atomic", "name": "A-atomic", "color": "f7e101", "default": false, "description": "Area: atomics, barriers, and sync primitives"}, {"id": 4434124801, "node_id": "LA_kwDOAAsO6M8AAAABCEtgAQ", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-bare-metal", "name": "O-bare-metal", "color": "6e6ec0", "default": false, "description": "Target: Rust without an operating system"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 50, "created_at": "2022-07-24T12:07:27Z", "updated_at": "2023-04-23T22:45:49Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "Some embedded targets (`thumbv6m`, `riscv32i`) don't support general atomic operations (`compare_exchange`, `fetch_add`, etc) but do support atomic `load` and `store` operations. We previously supported this on `thumbv6m` (but not `riscv32i`, see #98333) by `cfg`ing out most of the methods on `Atomic*` except for `load` and `store`. However recent changes to LLVM (#99595) cause it to emit calls to libatomic for `load` and `store` (it already does this for the other atomic operations).\r\n\r\nIt seems that LLVM's support for lowering atomic loads and stores on ARM was an accident that is being reverted. However the reason for this revert is that the directly lowered load/store cannot interoperate correctly with the other atomic operations which are lowered to libcalls. This concern doesn't apply to Rust since we don't expose emulated (read: not lock free) atomics, so there is no interoperability concern (except maybe for FFI with C that uses atomics?).\r\n\r\nI see 2 ways we can move forward:\r\n1. Continue supporting atomic load/store on such targets by lowering them in rustc to a volatile load/store. This will avoid breakage in the embeded Rust ecosystem.\r\n2. Remove support for atomic load/store on targets that don't support full atomics. Users are expected to switch to using volatile load/store instead.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/99668/reactions", "total_count": 9, "+1": 9, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/99668/timeline", "performed_via_github_app": null, "state_reason": null}