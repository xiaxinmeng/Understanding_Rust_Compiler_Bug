{"url": "https://api.github.com/repos/rust-lang/rust/issues/57152", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/57152/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/57152/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/57152/events", "html_url": "https://github.com/rust-lang/rust/issues/57152", "id": 394462244, "node_id": "MDU6SXNzdWUzOTQ0NjIyNDQ=", "number": 57152, "title": "wasm32-unknown-unknown: Incorrect codegen", "user": {"login": "BonsaiDen", "id": 124674, "node_id": "MDQ6VXNlcjEyNDY3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/124674?v=4", "gravatar_id": "", "url": "https://api.github.com/users/BonsaiDen", "html_url": "https://github.com/BonsaiDen", "followers_url": "https://api.github.com/users/BonsaiDen/followers", "following_url": "https://api.github.com/users/BonsaiDen/following{/other_user}", "gists_url": "https://api.github.com/users/BonsaiDen/gists{/gist_id}", "starred_url": "https://api.github.com/users/BonsaiDen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/BonsaiDen/subscriptions", "organizations_url": "https://api.github.com/users/BonsaiDen/orgs", "repos_url": "https://api.github.com/users/BonsaiDen/repos", "events_url": "https://api.github.com/users/BonsaiDen/events{/privacy}", "received_events_url": "https://api.github.com/users/BonsaiDen/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}, {"id": 474645165, "node_id": "MDU6TGFiZWw0NzQ2NDUxNjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-wasm", "name": "O-wasm", "color": "6e6ec0", "default": false, "description": "Target: WASM (WebAssembly), http://webassembly.org/"}], "state": "closed", "locked": false, "assignee": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 11, "created_at": "2018-12-27T18:38:31Z", "updated_at": "2019-01-30T20:23:53Z", "closed_at": "2019-01-30T20:23:53Z", "author_association": "NONE", "active_lock_reason": null, "body": "I've tested this with current nightly, beta and stable as well as nightlies all the way back to october (haven't tried anything before that).\r\n\r\nExpected Output: `a: false / t.a: false / both check for: (2 & 1) == 1` (Correct)\r\nActual Output: `a: false / t.a: true / both check for: (2 & 1) == 1` (Incorrect)\r\n\r\nNote: You can plug the code below into the https://github.com/rustwasm/rust-webpack-template for running it.\r\n\r\n```\r\nextern crate wasm_bindgen;\r\nuse wasm_bindgen::prelude::*;\r\n\r\n#[derive(Debug)]\r\nstruct Test {\r\n    a: bool,\r\n    b: bool\r\n}\r\n\r\nimpl Test {\r\n    fn foo(byte: u8) -> String {\r\n\r\n        // 1. This must be infront of the struct initializer - It will evaluate correctly to \"false\"\r\n        let a = (byte & 1) == 1;\r\n\r\n        let t = Test {\r\n            a: (byte & 1) == 1, // 2. This must come before \"b\" - It will incorrectly evaluate to \"true\"\r\n            b: (byte & 2) == 2, // 3. This must be evaluated inside the initializer\r\n        };\r\n\r\n        // 4. This must be called inside the function\r\n        format!(\"a: {} / t.a: {} / both check for: (2 & 1) == 1\", a, t.a)\r\n\r\n    }\r\n\r\n}\r\n\r\n#[wasm_bindgen]\r\nextern \"C\" {\r\n    #[wasm_bindgen(js_namespace = console)]\r\n    fn log(s: &str);\r\n}\r\n\r\n#[wasm_bindgen]\r\npub fn run() {\r\n    log(&Test::foo(2));\r\n}\r\n```\r\n\r\nFor some reason the two different `(byte & 1) == 1` expression generate different results. \r\n\r\n**Note:** Inlining everything by replacing `byte` with `2` produces the correct output.\r\n**Also Note:** In my real program there are more strange things that happen after this like (`for i in vector` not actually iterating over the contents of the vector) but I was unable to reduce those to a test case :( \r\n\r\nFor comparison, here's the same code (just without the WASM stuff) that produces the expected output `a: false / t.a: false / both check for: (2 & 1) == 1` when invoked via a simple `cargo run`:\r\n\r\n```\r\n#[derive(Debug)]\r\nstruct Test {\r\n    a: bool,\r\n    b: bool\r\n}\r\n\r\nimpl Test {\r\n\r\n    fn foo(byte: u8) -> String {\r\n\r\n        // 1. This must be infront of the struct initializer - It will evaluate correctly to \"false\"\r\n        let a = (byte & 1) == 1;\r\n\r\n        let t = Test {\r\n            a: (byte & 1) == 1, // 2. This must come before \"b\" - It will incorrectly evaluate to \"true\"\r\n            b: (byte & 2) == 2, // 3. This must be evaluated inside the initializer\r\n        };\r\n\r\n        // 4. This must be called inside the function\r\n        format!(\"a: {} / t.a: {} / both check for: (2 & 1) == 1\", a, t.a)\r\n\r\n    }\r\n\r\n}\r\n\r\npub fn main() {\r\n    println!(\"{}\", Test::foo(2));\r\n}\r\n```\r\n\r\n\r\n", "closed_by": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/57152/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/57152/timeline", "performed_via_github_app": null, "state_reason": "completed"}