{"url": "https://api.github.com/repos/rust-lang/rust/issues/103678", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/103678/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/103678/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/103678/events", "html_url": "https://github.com/rust-lang/rust/issues/103678", "id": 1426821609, "node_id": "I_kwDOAAsO6M5VC5Hp", "number": 103678, "title": "Linking error when mixing extern crate and dylib with lto enabled", "user": {"login": "Guilucand", "id": 11619058, "node_id": "MDQ6VXNlcjExNjE5MDU4", "avatar_url": "https://avatars.githubusercontent.com/u/11619058?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Guilucand", "html_url": "https://github.com/Guilucand", "followers_url": "https://api.github.com/users/Guilucand/followers", "following_url": "https://api.github.com/users/Guilucand/following{/other_user}", "gists_url": "https://api.github.com/users/Guilucand/gists{/gist_id}", "starred_url": "https://api.github.com/users/Guilucand/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Guilucand/subscriptions", "organizations_url": "https://api.github.com/users/Guilucand/orgs", "repos_url": "https://api.github.com/users/Guilucand/repos", "events_url": "https://api.github.com/users/Guilucand/events{/privacy}", "received_events_url": "https://api.github.com/users/Guilucand/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-10-28T07:32:54Z", "updated_at": "2022-10-28T07:32:54Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\nHi, I created a minimal example at:\r\n[https://github.com/Guilucand/rust-linking-bug](url)\r\n\r\nThe repository consists in a workspace with a binary (bin1) and three libraries:\r\n- lib1 is a dependency of both bin1 and lib2, and exports a single function called only by bin1\r\n- lib2 is a dependency of bin1, and imports lib1 and lib3_dylib (lib1 with `extern crate lib1;`) and exports a function called by bin1\r\n- lib3_dylib is an empty dylib type crate \r\n\r\nThe bug happens only when the code is compiled in release mode with thin or fat lto.\r\nThe bug does not happen if the lib3_dylib crate-type is not a dylib or if either line 4 or 7 of libs/lib2/src/lib.rs is commented.\r\n\r\nTo me, the problem seems a strange interaction between the dylib and the extern crate statement. \r\n\r\nI expected to see this happen: code compiles successfully\r\n\r\nInstead, this happened:\r\n<details><summary>Compiler output</summary>\r\n<p>\r\n\r\n```\r\ncargo clean && cargo +nightly run --release --bin bin1\r\n   Compiling lib1 v0.1.0 (/rust-linking-bug/libs/lib1)\r\n   Compiling lib3_dylib v0.1.0 (/rust-linking-bug/libs/lib3_dylib)\r\n   Compiling lib2 v0.1.0 (/rust-linking-bug/libs/lib2)\r\nwarning: unused import: `lib3_dylib::*`\r\n --> libs/lib2/src/lib.rs:7:5\r\n  |\r\n7 | use lib3_dylib::*;\r\n  |     ^^^^^^^^^^^^^\r\n  |\r\n  = note: `#[warn(unused_imports)]` on by default\r\n\r\nwarning: `lib2` (lib) generated 1 warning\r\n   Compiling bin1 v0.1.0 (/rust-linking-bug/bin1)\r\nerror: linking with `cc` failed: exit status: 1\r\n  |\r\n  = note: \"cc\" \"-m64\" \"/tmp/rustcj63qcl/symbols.o\" \"/rust-linking-bug/target/release/deps/bin1-21b67fa9867c6b5f.bin1.885c23bf-cgu.0.rcgu.o\" \"-Wl,--as-needed\" \"-L\" \"/rust-linking-bug/target/release/deps\" \"-L\" \"/<home>/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-L\" \"/rust-linking-bug/target/release/deps\" \"-llib3_dylib\" \"-L\" \"/<home>/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-lstd-de75e80c43801b1c\" \"-Wl,-Bstatic\" \"/<home>/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-b7c79d85cf21a511.rlib\" \"-Wl,-Bdynamic\" \"-lgcc_s\" \"-lutil\" \"-lrt\" \"-lpthread\" \"-lm\" \"-ldl\" \"-lc\" \"-Wl,--eh-frame-hdr\" \"-Wl,-znoexecstack\" \"-L\" \"/<home>/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-o\" \"/rust-linking-bug/target/release/deps/bin1-21b67fa9867c6b5f\" \"-Wl,--gc-sections\" \"-pie\" \"-Wl,-zrelro,-znow\" \"-Wl,-O1\" \"-nodefaultlibs\"\r\n  = note: /usr/bin/ld: /rust-linking-bug/target/release/deps/bin1-21b67fa9867c6b5f.bin1.885c23bf-cgu.0.rcgu.o: in function `bin1::main':\r\n          bin1.885c23bf-cgu.0:(.text._ZN4bin14main17h9514d892359a2ce5E+0x4): undefined reference to `lib1::lib1_function'\r\n          collect2: error: ld returned 1 exit status\r\n          \r\n  = note: some `extern` functions couldn't be found; some native libraries may need to be installed or have their path specified\r\n  = note: use the `-l` flag to specify native libraries to link\r\n  = note: use the `cargo:rustc-link-lib` directive to specify the native libraries to link with Cargo (see https://doc.rust-lang.org/cargo/reference/build-scripts.html#cargorustc-link-libkindname)\r\n\r\nerror: could not compile `bin1` due to previous error\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.66.0-nightly (0da281b60 2022-10-27)\r\nbinary: rustc\r\ncommit-hash: 0da281b6068a7d889ae89a9bd8991284cc9b7535\r\ncommit-date: 2022-10-27\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.66.0-nightly\r\nLLVM version: 15.0.2\r\n```\r\nand\r\n```\r\nrustc 1.64.0 (a55dd71d5 2022-09-19)\r\nbinary: rustc\r\ncommit-hash: a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52\r\ncommit-date: 2022-09-19\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.64.0\r\nLLVM version: 14.0.6\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/103678/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/103678/timeline", "performed_via_github_app": null, "state_reason": null}