{"url": "https://api.github.com/repos/rust-lang/rust/issues/86897", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/86897/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/86897/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/86897/events", "html_url": "https://github.com/rust-lang/rust/issues/86897", "id": 937396598, "node_id": "MDU6SXNzdWU5MzczOTY1OTg=", "number": 86897, "title": "E0493 emitted without drop when destructuring", "user": {"login": "CAD97", "id": 5992217, "node_id": "MDQ6VXNlcjU5OTIyMTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5992217?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CAD97", "html_url": "https://github.com/CAD97", "followers_url": "https://api.github.com/users/CAD97/followers", "following_url": "https://api.github.com/users/CAD97/following{/other_user}", "gists_url": "https://api.github.com/users/CAD97/gists{/gist_id}", "starred_url": "https://api.github.com/users/CAD97/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CAD97/subscriptions", "organizations_url": "https://api.github.com/users/CAD97/orgs", "repos_url": "https://api.github.com/users/CAD97/repos", "events_url": "https://api.github.com/users/CAD97/events{/privacy}", "received_events_url": "https://api.github.com/users/CAD97/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 43009118, "node_id": "MDU6TGFiZWw0MzAwOTExOA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-destructors", "name": "A-destructors", "color": "f7e101", "default": false, "description": "Area: destructors (Drop, ..)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 268744493, "node_id": "MDU6TGFiZWwyNjg3NDQ0OTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-const-fn", "name": "A-const-fn", "color": "f7e101", "default": false, "description": "Area: const fn foo(..) {..}. Pure functions which can be applied at compile time."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-07-05T22:38:42Z", "updated_at": "2022-01-02T05:02:26Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Given the following code: <!-- Please provide a link to play.rust-lang.org -->\r\n\r\n```rust\r\npub struct Wrap(String);\r\n\r\nimpl Wrap {\r\n    pub const fn into_inner(self) -> String {\r\n        self.0\r\n    }\r\n}\r\n```\r\n\r\nThe current output is:\r\n\r\n```\r\nerror[E0493]: destructors cannot be evaluated at compile-time\r\n --> src/lib.rs:4:29\r\n  |\r\n4 |     pub const fn into_inner(self) -> String {\r\n  |                             ^^^^ constant functions cannot evaluate destructors\r\n5 |         self.0\r\n6 |     }\r\n  |     - value is dropped here\r\n```\r\n\r\nThis error is clearly wrong: `self` is not dropped, as it's been moved out of. In fact, no destructors are run, so this _should_ be able to compile. If it shouldn't compile, the error should be changed to not be incorrect.\r\n\r\nThis seems to be an issue in the drop suppression when moving out field-wise; using e.g. `mem::forget` works to suppress the destructor and allow the function to compile. I was unable to trick the compiler to accept the function with `ManuallyDrop`, as extracting the wrapped value requires manifesting a wrapper again, which triggers E0493 \"destructors cannot be evaluated at compile-time\".\r\n\r\n@rustbot label: +A-const-fn +A-destructors", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/86897/reactions", "total_count": 5, "+1": 5, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/86897/timeline", "performed_via_github_app": null, "state_reason": null}