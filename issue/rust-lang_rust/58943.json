{"url": "https://api.github.com/repos/rust-lang/rust/issues/58943", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/58943/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/58943/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/58943/events", "html_url": "https://github.com/rust-lang/rust/issues/58943", "id": 417384809, "node_id": "MDU6SXNzdWU0MTczODQ4MDk=", "number": 58943, "title": "Memory not freed on container of allocated objects on recent compilers", "user": {"login": "qpincon", "id": 10002904, "node_id": "MDQ6VXNlcjEwMDAyOTA0", "avatar_url": "https://avatars.githubusercontent.com/u/10002904?v=4", "gravatar_id": "", "url": "https://api.github.com/users/qpincon", "html_url": "https://github.com/qpincon", "followers_url": "https://api.github.com/users/qpincon/followers", "following_url": "https://api.github.com/users/qpincon/following{/other_user}", "gists_url": "https://api.github.com/users/qpincon/gists{/gist_id}", "starred_url": "https://api.github.com/users/qpincon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/qpincon/subscriptions", "organizations_url": "https://api.github.com/users/qpincon/orgs", "repos_url": "https://api.github.com/users/qpincon/repos", "events_url": "https://api.github.com/users/qpincon/events{/privacy}", "received_events_url": "https://api.github.com/users/qpincon/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2019-03-05T16:26:51Z", "updated_at": "2019-03-05T17:26:17Z", "closed_at": "2019-03-05T16:55:13Z", "author_association": "NONE", "active_lock_reason": null, "body": "Hello,\r\n\r\nHere is a sample code, simply filling a Vec by Vecs of integer.\r\n\r\n```\r\nfn test() {\r\n\tlet mut vec = Vec::new();\r\n\tfor x in 0..10000000 {\r\n\t\tvec.push(vec![1,2,3,4]);\r\n\t}\r\n\tprintln!(\"{}\", vec.capacity() * vec[0].capacity());\r\n}\r\n\r\nfn main() {\r\n\ttest();\r\n\tstd::thread::sleep(std::time::Duration::from_millis(1000000));\r\n}\r\n```\r\nWith recent versions of rustc (> 1.31), the allocated memory seems to not be freed from the system at the end of the test function, as top displays a memory usage of ~300Mo, which is coherent with the memory used by this sample code.\r\n\r\nWith lower versions of rustc (I used 1.30 and 1.31), this problem does not appear (the process system memory is close to 0, as intended). \r\n\r\nHowever, using the system allocator, the behaviour is the same for all versions : the memory is not available from the system.\r\nCalling twice the test function however does not increase the memory consumption, which probably means that the allocator effectively freed the memory internally, but not from the system.\r\nThe same thing happens if the vector is dropped manually by calling std::mem::drop().\r\n\r\nI am writing a long running process that does a lot of allocations and deallocations at startup, and once initialization is finished I'm looking for a way to release temporary memory to the OS. Is there any low-level mechanism (such as `malloc_trim` in C) that asks/hints the allocator to do that ?\r\n\r\nAny idea of why this happens ? Thank you !", "closed_by": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/58943/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/58943/timeline", "performed_via_github_app": null, "state_reason": "completed"}