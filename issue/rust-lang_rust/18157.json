{"url": "https://api.github.com/repos/rust-lang/rust/issues/18157", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/18157/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/18157/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/18157/events", "html_url": "https://github.com/rust-lang/rust/issues/18157", "id": 46204311, "node_id": "MDU6SXNzdWU0NjIwNDMxMQ==", "number": 18157, "title": "Compiler crashes when wrapping Rust callbacks in C callbacks", "user": {"login": "manuels", "id": 31315, "node_id": "MDQ6VXNlcjMxMzE1", "avatar_url": "https://avatars.githubusercontent.com/u/31315?v=4", "gravatar_id": "", "url": "https://api.github.com/users/manuels", "html_url": "https://github.com/manuels", "followers_url": "https://api.github.com/users/manuels/followers", "following_url": "https://api.github.com/users/manuels/following{/other_user}", "gists_url": "https://api.github.com/users/manuels/gists{/gist_id}", "starred_url": "https://api.github.com/users/manuels/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/manuels/subscriptions", "organizations_url": "https://api.github.com/users/manuels/orgs", "repos_url": "https://api.github.com/users/manuels/repos", "events_url": "https://api.github.com/users/manuels/events{/privacy}", "received_events_url": "https://api.github.com/users/manuels/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2014-10-19T12:38:53Z", "updated_at": "2015-04-22T09:27:08Z", "closed_at": "2015-04-22T09:27:08Z", "author_association": "NONE", "active_lock_reason": null, "body": "I want to implement a Rust interface for libevent (because an external library I want to use depends on it).\nNote that there is an example with working code, code that issues the compiler error and a diff between these two in this gist:\nhttps://gist.github.com/manuels/aaaf1ef5d8a072c19f11\n\nWhen I define a C callback function for a libevent event:\n\n```\nextern \"C\"\nfn printme(ev: *const c_int, flags: c_short, args: *const c_int) {\n    // using this as a libevent callback works just fine\n    println!(\"hello\");\n}\n```\n\nthe code works fine. Note that `args` is a userdefined argument that will be used in the next step.\n\nRelying on callbacks to be defined as \"extern C\" is a bit clumsy, so I'd like to define an \"extern C\" wrapper function that calls the rust callback function:\n\n```\ntype watch_fd_callback_t = fn(*const c_int, c_short);\n\nextern \"C\"\nfn c_watch_fd_callback(ev:*const c_int, type_:c_short, cb: watch_fd_callback_t) {\n    // using this as a libevent callback crashes the compiler.\n    // probably because this \"extern C\" function indirectly \n    // calls the non \"extern C\" function printme() (==cb)\n    cb(ev, type_)\n}\n\nfn printme(ev: *const c_int, flags: i16) {\n    println!(\"hello\");\n}\n```\n\nSo when I use the \"extern C\" wrapper callback `c_watch_fd_callback()` that calls the rust callback `printme()` the compiler crashes with this backtrace:\n\n```\nerror: internal compiler error: unexpected failure\nnote: the compiler hit an unexpected failure path. this is a bug.\nnote: we would appreciate a bug report: http://doc.rust-lang.org/complement-bugreport.html\nnote: run with `RUST_BACKTRACE=1` for a backtrace\ntask 'rustc' failed at 'assertion failed: f.abi == Rust || f.abi == RustCall', /home/rustbuild/src/rust-buildbot/slave/nightly-linux/build/src/librustc/middle/trans/base.rs:2337\n\nstack backtrace:\n   1:     0x7fcf4ff31bf0 - rt::backtrace::imp::write::h37a3af22082b7094FKq\n   2:     0x7fcf4ff34d20 - failure::on_fail::hf01d9f1e1bdb6e5425q\n   3:     0x7fcf5449db30 - unwind::begin_unwind_inner::h2ec64a9d433f6b868yd\n   4:     0x7fcf54ae2f20 - unwind::begin_unwind::h16532647071079331256\n   5:     0x7fcf54f55770 - middle::trans::base::register_fn::habe93b484695cbab1kh\n   6:     0x7fcf54f58680 - middle::trans::base::register_method::hd6b6a60e17289fdea1h\n   7:     0x7fcf54e998e0 - middle::trans::base::get_item_val::h87cb1de1e8e4455aeJh\n   8:     0x7fcf54f53a60 - middle::trans::meth::trans_impl::h061539a782350394U1l\n   9:     0x7fcf54e98400 - middle::trans::base::trans_item::h8e6f687fd31b992bxdh\n  10:     0x7fcf54e98400 - middle::trans::base::trans_item::h8e6f687fd31b992bxdh\n  11:     0x7fcf54f5b030 - middle::trans::base::trans_crate::h1e2bed8778c95c8dkbi\n  12:     0x7fcf553b43b0 - driver::driver::phase_4_translate_to_llvm::hbdeb13ca358e159eD9z\n  13:     0x7fcf553ab450 - driver::driver::compile_input::h8a818e073bdb900cyGz\n  14:     0x7fcf55436950 - driver::run_compiler::h7e400358677f3066StD\n  15:     0x7fcf55436800 - driver::run::closure.145782\n  16:     0x7fcf54b1bb70 - task::TaskBuilder<S>::try_future::closure.103164\n  17:     0x7fcf54b1b950 - task::TaskBuilder<S>::spawn_internal::closure.103135\n  18:     0x7fcf547e8a30 - task::spawn_opts::closure.8464\n  19:     0x7fcf544f7aa0 - rust_try_inner\n  20:     0x7fcf544f7a90 - rust_try\n  21:     0x7fcf5449b3f0 - unwind::try::h0bc5cc5739b8d3c3Qnd\n  22:     0x7fcf5449b270 - task::Task::run::h517e4360aedfbf45uDc\n  23:     0x7fcf547e8770 - task::spawn_opts::closure.8404\n  24:     0x7fcf5449cb40 - thread::thread_start::h43c1915a7e23212cFXc\n  25:     0x7fcf4f2ddfe0 - start_thread\n  26:     0x7fcf5416dbf9 - __clone\n  27:                0x0 - <unknown>\n```\n\nI'm running `Linux 3.16-2-amd64 #1 SMP Debian 3.16.3-2 (2014-09-20) x86_64 GNU/Linux` with `rustc 0.13.0-nightly (222ae8b9b 2014-10-18 00:47:22 +0000)`.\n", "closed_by": {"login": "manuels", "id": 31315, "node_id": "MDQ6VXNlcjMxMzE1", "avatar_url": "https://avatars.githubusercontent.com/u/31315?v=4", "gravatar_id": "", "url": "https://api.github.com/users/manuels", "html_url": "https://github.com/manuels", "followers_url": "https://api.github.com/users/manuels/followers", "following_url": "https://api.github.com/users/manuels/following{/other_user}", "gists_url": "https://api.github.com/users/manuels/gists{/gist_id}", "starred_url": "https://api.github.com/users/manuels/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/manuels/subscriptions", "organizations_url": "https://api.github.com/users/manuels/orgs", "repos_url": "https://api.github.com/users/manuels/repos", "events_url": "https://api.github.com/users/manuels/events{/privacy}", "received_events_url": "https://api.github.com/users/manuels/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/18157/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/18157/timeline", "performed_via_github_app": null, "state_reason": "completed"}