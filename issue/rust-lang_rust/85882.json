{"url": "https://api.github.com/repos/rust-lang/rust/issues/85882", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/85882/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/85882/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/85882/events", "html_url": "https://github.com/rust-lang/rust/issues/85882", "id": 907948163, "node_id": "MDU6SXNzdWU5MDc5NDgxNjM=", "number": 85882, "title": "Extended key value attributes are parsed too eagerly", "user": {"login": "XAMPPRocky", "id": 4464295, "node_id": "MDQ6VXNlcjQ0NjQyOTU=", "avatar_url": "https://avatars.githubusercontent.com/u/4464295?v=4", "gravatar_id": "", "url": "https://api.github.com/users/XAMPPRocky", "html_url": "https://github.com/XAMPPRocky", "followers_url": "https://api.github.com/users/XAMPPRocky/followers", "following_url": "https://api.github.com/users/XAMPPRocky/following{/other_user}", "gists_url": "https://api.github.com/users/XAMPPRocky/gists{/gist_id}", "starred_url": "https://api.github.com/users/XAMPPRocky/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/XAMPPRocky/subscriptions", "organizations_url": "https://api.github.com/users/XAMPPRocky/orgs", "repos_url": "https://api.github.com/users/XAMPPRocky/repos", "events_url": "https://api.github.com/users/XAMPPRocky/events{/privacy}", "received_events_url": "https://api.github.com/users/XAMPPRocky/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2621607661, "node_id": "MDU6TGFiZWwyNjIxNjA3NjYx", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-extended_key_value_attributes", "name": "F-extended_key_value_attributes", "color": "f9c0cc", "default": false, "description": "`#![feature(extended_key_value_attributes)]"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2021-06-01T06:36:29Z", "updated_at": "2021-06-01T10:27:01Z", "closed_at": "2021-06-01T10:27:01Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Consider the following rust code, I would have expected the below to compile on stable today when compiled with `rustc src/lib.rs`, but in fact it fails to compile citing that arbitrary key values are unstable. Which implies that the `include_str!` parsing is being handled ahead of handling the `cfg` predicate. While this specific example won't be an issue when this becomes stable in 1.54.0, but it does point to this feature having some surprising behaviour at the moment, I would have expected the `cfg` predicate on the module to have been evaluated to false and the whole module would be skipped, regardless of what I used on the right hand side of `doc`.\r\n\r\n```rust\r\n#[cfg(feature = \"nightly\")]\r\nmod test {\r\n    #![doc = include_str!(\"README.md\")]\r\n}\r\n```\r\n\r\n```\r\nerror[E0658]: arbitrary expressions in key-value attributes are unstable\r\n --> src/lib.rs:4:14\r\n  |\r\n4 |     #![doc = include_str!(\"README.md\")]\r\n  |              ^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  |\r\n  = note: see issue #78835 <https://github.com/rust-lang/rust/issues/78835> for more information\r\n\r\nerror: aborting due to previous error\r\n```\r\n\r\nThere's a workaround if you're okay with double wrapping the modules, as if you embed it in a declarative macro, it will behave how you expect.\r\n\r\n```rust\r\n#[cfg(feature = \"nightly\")]\r\nmod nightly {\r\n    macro_rules! tests {\r\n        () => {\r\n            #[doc = include_str!(\"README.md\")]\r\n            mod tests {}\r\n        }\r\n    }\r\n\r\n    tests!();\r\n}\r\n```", "closed_by": {"login": "XAMPPRocky", "id": 4464295, "node_id": "MDQ6VXNlcjQ0NjQyOTU=", "avatar_url": "https://avatars.githubusercontent.com/u/4464295?v=4", "gravatar_id": "", "url": "https://api.github.com/users/XAMPPRocky", "html_url": "https://github.com/XAMPPRocky", "followers_url": "https://api.github.com/users/XAMPPRocky/followers", "following_url": "https://api.github.com/users/XAMPPRocky/following{/other_user}", "gists_url": "https://api.github.com/users/XAMPPRocky/gists{/gist_id}", "starred_url": "https://api.github.com/users/XAMPPRocky/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/XAMPPRocky/subscriptions", "organizations_url": "https://api.github.com/users/XAMPPRocky/orgs", "repos_url": "https://api.github.com/users/XAMPPRocky/repos", "events_url": "https://api.github.com/users/XAMPPRocky/events{/privacy}", "received_events_url": "https://api.github.com/users/XAMPPRocky/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/85882/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/85882/timeline", "performed_via_github_app": null, "state_reason": "completed"}