{"url": "https://api.github.com/repos/rust-lang/rust/issues/38241", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/38241/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/38241/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/38241/events", "html_url": "https://github.com/rust-lang/rust/issues/38241", "id": 194356130, "node_id": "MDU6SXNzdWUxOTQzNTYxMzA=", "number": 38241, "title": "Static variables are inlined when optimisations are enabled", "user": {"login": "aidanhs", "id": 1050652, "node_id": "MDQ6VXNlcjEwNTA2NTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1050652?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aidanhs", "html_url": "https://github.com/aidanhs", "followers_url": "https://api.github.com/users/aidanhs/followers", "following_url": "https://api.github.com/users/aidanhs/following{/other_user}", "gists_url": "https://api.github.com/users/aidanhs/gists{/gist_id}", "starred_url": "https://api.github.com/users/aidanhs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aidanhs/subscriptions", "organizations_url": "https://api.github.com/users/aidanhs/orgs", "repos_url": "https://api.github.com/users/aidanhs/repos", "events_url": "https://api.github.com/users/aidanhs/events{/privacy}", "received_events_url": "https://api.github.com/users/aidanhs/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 431251592, "node_id": "MDU6TGFiZWw0MzEyNTE1OTI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-docs", "name": "A-docs", "color": "f7e101", "default": false, "description": "Area: documentation for any part of the project, including the compiler, standard library, and tools"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2016-12-08T14:55:16Z", "updated_at": "2017-08-30T19:28:23Z", "closed_at": "2017-08-30T19:28:23Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Example (`#[start]` is used to slim the assembly):\r\n```\r\n#![feature(start)]\r\n#[no_mangle]\r\npub static ABC: isize = 555;\r\n#[start]\r\nfn start(_argc: isize, _argv: *const *const u8) -> isize {\r\n    ABC+1\r\n}\r\n```\r\nhttps://is.gd/VxMUUu\r\nAsm output from release mode:\r\n```\r\n\t.text\r\n\t.intel_syntax noprefix\r\n\t.file\t\"rust_out.cgu-0.rs\"\r\n\t.section\t.text.main,\"ax\",@progbits\r\n\t.globl\tmain\r\n\t.p2align\t4, 0x90\r\n\t.type\tmain,@function\r\nmain:\r\n\tmov\teax, 556\r\n\tret\r\n.Lfunc_end0:\r\n\t.size\tmain, .Lfunc_end0-main\r\n\r\n\t.type\tABC,@object\r\n\t.section\t.rodata.ABC,\"a\",@progbits\r\n\t.globl\tABC\r\n\t.p2align\t3\r\nABC:\r\n\t.quad\t555\r\n\t.size\tABC, 8\r\n\r\n\r\n\t.section\t\".note.GNU-stack\",\"\",@progbits\r\n```\r\nNote that 556 has been inlined.\r\n\r\nBy comparison, C example using gcc:\r\n```\r\nint ABC = 555;\r\nint main(int argc, char** argv) {\r\n        return ABC+1;\r\n}\r\n```\r\nCompiling to asm:\r\n```\r\n$ gcc -O2 -S x.c && cat x.s\r\n        .file   \"x.c\"\r\n        .section        .text.unlikely,\"ax\",@progbits\r\n.LCOLDB0:\r\n        .section        .text.startup,\"ax\",@progbits\r\n.LHOTB0:\r\n        .p2align 4,,15\r\n        .globl  main\r\n        .type   main, @function\r\nmain:\r\n.LFB0:\r\n        .cfi_startproc\r\n        movl    ABC(%rip), %eax\r\n        addl    $1, %eax\r\n        ret\r\n        .cfi_endproc\r\n.LFE0:\r\n        .size   main, .-main\r\n        .section        .text.unlikely\r\n.LCOLDE0:\r\n        .section        .text.startup\r\n.LHOTE0:\r\n        .globl  ABC\r\n        .data\r\n        .align 4\r\n        .type   ABC, @object\r\n        .size   ABC, 4\r\nABC:\r\n        .long   555\r\n        .ident  \"GCC: (Ubuntu 5.4.0-6ubuntu1~16.04.4) 5.4.0 20160609\"\r\n        .section        .note.GNU-stack,\"\",@progbits\r\n```\r\ni.e. it loads from `ABC` each time (if `ABC` is made `static` in the C example it will inline, which is fine)\r\n\r\nThis is a direct contradiction of https://doc.rust-lang.org/beta/book/const-and-static.html#static\r\n\r\n> Rust provides a \u2018global variable\u2019 sort of facility in static items. They\u2019re similar to constants, but static items aren\u2019t inlined upon use. This means that there is only one instance for each value, and it\u2019s at a fixed location in memory.\r\n\r\nand unhelpful if you want to edit symbol values in the binary after compilation and before running.", "closed_by": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/38241/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/38241/timeline", "performed_via_github_app": null, "state_reason": "completed"}