{"url": "https://api.github.com/repos/rust-lang/rust/issues/37949", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/37949/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/37949/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/37949/events", "html_url": "https://github.com/rust-lang/rust/issues/37949", "id": 191167431, "node_id": "MDU6SXNzdWUxOTExNjc0MzE=", "number": 37949, "title": "Matching on DerefMut prevents mutable borrow", "user": {"login": "jonhoo", "id": 176295, "node_id": "MDQ6VXNlcjE3NjI5NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/176295?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonhoo", "html_url": "https://github.com/jonhoo", "followers_url": "https://api.github.com/users/jonhoo/followers", "following_url": "https://api.github.com/users/jonhoo/following{/other_user}", "gists_url": "https://api.github.com/users/jonhoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonhoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonhoo/subscriptions", "organizations_url": "https://api.github.com/users/jonhoo/orgs", "repos_url": "https://api.github.com/users/jonhoo/repos", "events_url": "https://api.github.com/users/jonhoo/events{/privacy}", "received_events_url": "https://api.github.com/users/jonhoo/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2016-11-23T01:15:50Z", "updated_at": "2017-05-16T15:35:42Z", "closed_at": "2017-05-16T15:35:42Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I've started using `Deref` and `DerefMut` more aggressively to make usage of my code more ergonomic. However, I then ran across a strange compiler error when trying to `match` on a value dereferenced through `DerefMut`. The issue illustrated by the following code.\r\n\r\n```rust\r\nuse std::ops::{Deref, DerefMut};\r\n\r\nenum X {\r\n    A(usize),\r\n    B,\r\n}\r\n\r\nstruct Foo(X);\r\n\r\nimpl Deref for Foo {\r\n    type Target = X;\r\n    fn deref(&self) -> &Self::Target {\r\n        &self.0\r\n    }\r\n}\r\n\r\nimpl DerefMut for Foo {\r\n    fn deref_mut(&mut self) -> &mut Self::Target {\r\n        &mut self.0\r\n    }\r\n}\r\n\r\nstruct Bar(Foo);\r\n\r\nimpl Bar {\r\n    fn baz(&mut self) {\r\n        match *self.0 {\r\n            X::A(ref mut i) => { *i += 1; }\r\n            X::B => { self.fail(); }\r\n        }\r\n    }\r\n\r\n    fn fail(&mut self) {}\r\n}\r\n\r\nfn main() {\r\n    Bar(Foo(X::A(0))).baz();\r\n}\r\n```\r\n\r\n```console\r\n$ rustc test.rs\r\nerror[E0499]: cannot borrow `*self` as mutable more than once at a time\r\n  --> x.rs:34:17\r\n   |\r\n29 |         match *self.inner {\r\n   |                ---------- first mutable borrow occurs here\r\n...\r\n34 |                 self.fail();\r\n   |                 ^^^^ second mutable borrow occurs here\r\n35 |             }\r\n36 |         }\r\n   |         - first borrow ends here\r\n```\r\n\r\nI have been unable to come up with a simpler test case. It is critical that there is another `match` arm that mutably borrows inside the matched value. Furthermore, `DerefMut` seems to be the culprit, as the following compiles fine:\r\n\r\n```rust\r\nenum X {\r\n    A(usize),\r\n    B,\r\n}\r\n\r\nstruct Foo(X);\r\nstruct Bar(Foo);\r\n\r\nimpl Bar {\r\n    fn baz(&mut self) {\r\n        match (self.0).0 {\r\n            X::A(ref mut i) => {\r\n                *i += 1;\r\n            }\r\n            X::B => {\r\n                self.fail();\r\n            }\r\n        }\r\n    }\r\n\r\n    fn fail(&mut self) {}\r\n}\r\n\r\nfn main() {\r\n    Bar(Foo(X::A(0))).baz();\r\n}\r\n```\r\n\r\nIt could be that this is related to the lack of lexical scoping, though by my understanding the code above should work just fine without it (as illustrated by the non-`DerefMut` example code compiling just fine).", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/37949/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/37949/timeline", "performed_via_github_app": null, "state_reason": "completed"}