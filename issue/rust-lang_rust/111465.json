{"url": "https://api.github.com/repos/rust-lang/rust/issues/111465", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/111465/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/111465/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/111465/events", "html_url": "https://github.com/rust-lang/rust/issues/111465", "id": 1705740182, "node_id": "I_kwDOAAsO6M5lq4eW", "number": 111465, "title": "Unhelpful `higher-ranked lifetime error` in non-async context", "user": {"login": "veprolet", "id": 68151557, "node_id": "MDQ6VXNlcjY4MTUxNTU3", "avatar_url": "https://avatars.githubusercontent.com/u/68151557?v=4", "gravatar_id": "", "url": "https://api.github.com/users/veprolet", "html_url": "https://github.com/veprolet", "followers_url": "https://api.github.com/users/veprolet/followers", "following_url": "https://api.github.com/users/veprolet/following{/other_user}", "gists_url": "https://api.github.com/users/veprolet/gists{/gist_id}", "starred_url": "https://api.github.com/users/veprolet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/veprolet/subscriptions", "organizations_url": "https://api.github.com/users/veprolet/orgs", "repos_url": "https://api.github.com/users/veprolet/repos", "events_url": "https://api.github.com/users/veprolet/events{/privacy}", "received_events_url": "https://api.github.com/users/veprolet/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 171502053, "node_id": "MDU6TGFiZWwxNzE1MDIwNTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-borrow-checker", "name": "A-borrow-checker", "color": "f7e101", "default": false, "description": "Area: The borrow checker"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2023-05-11T12:34:40Z", "updated_at": "2023-05-13T19:35:54Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "Here is somewhat minified code producing the unhelpful error message ([playground](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=e6d5ce6267fb80bc4ee27cb0067ec5bc))\r\n```\r\nfn map<F, M, I, X, O>(function: F, mapper: M) -> impl Fn(I) -> O\r\nwhere\r\n    F: Fn(I) -> X,\r\n    M: Fn(X) -> O,\r\n{\r\n    move |input| {\r\n        mapper(function(input))\r\n    }\r\n}\r\n\r\nfn pack<F, O>(function: F) -> impl Fn(&u32) -> ((), O)\r\nwhere\r\n    F: Fn(&u32) -> O,\r\n{\r\n    move |input| {\r\n        ((), function(input))\r\n    }\r\n}\r\n\r\nfn unpack<F, O>(function: F) -> impl Fn(&u32)\r\nwhere\r\n    F: Fn(&u32) -> O,\r\n{\r\n    map(pack(function), |(unit, _)| unit)\r\n}\r\n\r\nfn main() {}\r\n```\r\n\r\nThis code produces the following error message, which is in my opinon quite unhelpful:\r\n```\r\nerror: higher-ranked lifetime error\r\n  --> src/main.rs:24:5\r\n   |\r\n24 |     map(pack(function), |(unit, _)| unit)\r\n   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n```\r\n\r\nI assume the lifetimes in the code desugar into something like this:\r\n```\r\nfn map<F, M, I, X, O>(function: F, mapper: M) -> impl Fn(I) -> O\r\nwhere\r\n    F: Fn(I) -> X,\r\n    M: Fn(X) -> O,\r\n{\r\n    move |input| {\r\n        mapper(function(input))\r\n    }\r\n}\r\n\r\nfn pack<F, O>(function: F) -> impl for<'a> Fn(&'a u32) -> ((), O)\r\nwhere\r\n    for<'b> F: Fn(&'b u32) -> O,\r\n{\r\n    move |input| {\r\n        ((), function(input))\r\n    }\r\n}\r\n\r\nfn unpack<F, O>(function: F) -> impl for<'a> Fn(&'a u32)\r\nwhere\r\n    for<'b> F: Fn(&'b u32) -> O,\r\n{\r\n    map(pack(function), |(unit, _)| unit)\r\n}\r\n\r\nfn main() {}\r\n```\r\n\r\nThis code produces the same error and does seem vaguely incorrect, as I'd expect the two lifetimes to be at least somewhat related. Specifying the lifetimes in almost any other way resolves the error. For example:\r\n```\r\nfn map<F, M, I, X, O>(function: F, mapper: M) -> impl Fn(I) -> O\r\nwhere\r\n    F: Fn(I) -> X,\r\n    M: Fn(X) -> O,\r\n{\r\n    move |input| {\r\n        mapper(function(input))\r\n    }\r\n}\r\n\r\nfn pack<'a, F, O>(function: F) -> impl Fn(&'a u32) -> ((), O)\r\nwhere\r\n    for<'b> F: Fn(&'b u32) -> O,\r\n{\r\n    move |input| {\r\n        ((), function(input))\r\n    }\r\n}\r\n\r\nfn unpack<'a, F, O>(function: F) -> impl Fn(&'a u32)\r\nwhere\r\n    for<'b> F: Fn(&'b u32) -> O,\r\n{\r\n    map(pack(function), |(unit, _)| unit)\r\n}\r\n\r\nfn main() {}\r\n```\r\n\r\nThis issue seems closely related to other issues with this error, such as: #102211, #102870, #99492. This issue is probably a duplicate of those, but I'm submitting a new issue, because all the aforementioned issues deal with complex async types and contexts, and apart from #102870 seem to include at least some helpful info in the error message. Also I don't completely understand the error, so I'm not sure whether it should even occur, which seems to be the main focus of those other issues, but I'm fairly confident the error message could provide more information.\r\n\r\n### Meta\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.69.0 (84c898d65 2023-04-16)\r\nbinary: rustc\r\ncommit-hash: 84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc\r\ncommit-date: 2023-04-16\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.69.0\r\nLLVM version: 15.0.7\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/111465/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/111465/timeline", "performed_via_github_app": null, "state_reason": null}