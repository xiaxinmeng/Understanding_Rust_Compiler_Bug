{"url": "https://api.github.com/repos/rust-lang/rust/issues/26442", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/26442/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/26442/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/26442/events", "html_url": "https://github.com/rust-lang/rust/issues/26442", "id": 89670382, "node_id": "MDU6SXNzdWU4OTY3MDM4Mg==", "number": 26442, "title": "Valgrind shows invalid read/write when using threads", "user": {"login": "jethrogb", "id": 1132307, "node_id": "MDQ6VXNlcjExMzIzMDc=", "avatar_url": "https://avatars.githubusercontent.com/u/1132307?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jethrogb", "html_url": "https://github.com/jethrogb", "followers_url": "https://api.github.com/users/jethrogb/followers", "following_url": "https://api.github.com/users/jethrogb/following{/other_user}", "gists_url": "https://api.github.com/users/jethrogb/gists{/gist_id}", "starred_url": "https://api.github.com/users/jethrogb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jethrogb/subscriptions", "organizations_url": "https://api.github.com/users/jethrogb/orgs", "repos_url": "https://api.github.com/users/jethrogb/repos", "events_url": "https://api.github.com/users/jethrogb/events{/privacy}", "received_events_url": "https://api.github.com/users/jethrogb/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2015-06-19T22:06:32Z", "updated_at": "2015-10-16T19:55:47Z", "closed_at": "2015-10-16T19:55:37Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "``` rust\n// valgrind-test.rs\nextern crate vg;\n\nuse std::thread;\nuse std::sync::{Arc,Mutex};\nuse vg::*;\n\nfn main() {\n    let arc=Arc::new(Mutex::new(()));\n    let mut threads=vec![];\n\n    for _ in 0..1000 {\n        let arc_clone=arc.clone();\n        threads.push(thread::spawn(move||{*arc_clone.lock().unwrap();}));\n    }\n\n    for t in threads.into_iter() {\n        t.join().unwrap();\n    }\n}\n```\n\nRunning like this usually gets me `Invalid read`/`Invalid write` errors within 5 executions:\n\n```\nrustc <(echo) -g --crate-type rlib --crate-name vg --out-dir .\nrustc valgrind-test.rs -g --extern vg=./libvg.rlib\nwhile valgrind --soname-synonyms=somalloc=NONE --redzone-size=64 --freelist-vol=100000000 --error-exitcode=1 ./valgrind-test ; do test ; done\n```\n\nSome particularly interesting errors are at http://pastebin.com/0m346AT5\n\nThe `--soname-synonyms=somalloc=NONE` option is supposed to make valgrind work properly with statically-linked jemalloc.\n\nIt might be my imagination, but it looks like linking to the empty crate significantly increases the chance of Valgrind errors showing up, although not linking this way does not completely eliminate the errors.\n\nTested on Linux with rust-stable, rust-stable with debug build of libstd only, rust-nightly.\n", "closed_by": {"login": "jethrogb", "id": 1132307, "node_id": "MDQ6VXNlcjExMzIzMDc=", "avatar_url": "https://avatars.githubusercontent.com/u/1132307?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jethrogb", "html_url": "https://github.com/jethrogb", "followers_url": "https://api.github.com/users/jethrogb/followers", "following_url": "https://api.github.com/users/jethrogb/following{/other_user}", "gists_url": "https://api.github.com/users/jethrogb/gists{/gist_id}", "starred_url": "https://api.github.com/users/jethrogb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jethrogb/subscriptions", "organizations_url": "https://api.github.com/users/jethrogb/orgs", "repos_url": "https://api.github.com/users/jethrogb/repos", "events_url": "https://api.github.com/users/jethrogb/events{/privacy}", "received_events_url": "https://api.github.com/users/jethrogb/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/26442/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/26442/timeline", "performed_via_github_app": null, "state_reason": "completed"}