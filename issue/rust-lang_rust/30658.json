{"url": "https://api.github.com/repos/rust-lang/rust/issues/30658", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/30658/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/30658/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/30658/events", "html_url": "https://github.com/rust-lang/rust/issues/30658", "id": 124432496, "node_id": "MDU6SXNzdWUxMjQ0MzI0OTY=", "number": 30658, "title": "Compiler bug with cyclic weak references on Windows", "user": {"login": "Mokosha", "id": 885364, "node_id": "MDQ6VXNlcjg4NTM2NA==", "avatar_url": "https://avatars.githubusercontent.com/u/885364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mokosha", "html_url": "https://github.com/Mokosha", "followers_url": "https://api.github.com/users/Mokosha/followers", "following_url": "https://api.github.com/users/Mokosha/following{/other_user}", "gists_url": "https://api.github.com/users/Mokosha/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mokosha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mokosha/subscriptions", "organizations_url": "https://api.github.com/users/Mokosha/orgs", "repos_url": "https://api.github.com/users/Mokosha/repos", "events_url": "https://api.github.com/users/Mokosha/events{/privacy}", "received_events_url": "https://api.github.com/users/Mokosha/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 266005765, "node_id": "MDU6TGFiZWwyNjYwMDU3NjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows-msvc", "name": "O-windows-msvc", "color": "6e6ec0", "default": false, "description": "Toolchain: MSVC, Operating system: Windows"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2015-12-31T04:53:24Z", "updated_at": "2023-01-05T00:54:02Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I've tracked down the following bug on 1.5 stable. It only appears to happen on Windows, as I've tried the same program on Linux x64 without problems:\n\n`test.rs`:\n\n```\nuse std::rc::{Rc, Weak};\n\nstruct SDVertex {\n    start_face: Option<Weak<SDFace>>,\n}\n\nimpl SDVertex {\n    fn new() -> SDVertex {\n        SDVertex {\n            start_face: None,\n        }\n    }\n}\n\nstruct SDFace {\n    v: [Option<Weak<SDVertex>>; 3],\n}\n\nimpl SDFace {\n    fn new() -> SDFace {\n        SDFace {\n            v: [None, None, None],\n        }\n    }\n}\n\nstruct LoopSubdiv;\n\nimpl LoopSubdiv {\n    pub fn test(num_faces: usize) -> Vec<Rc<SDFace>> {\n        // Allocate vertices and faces\n        let mut fs = Vec::with_capacity(num_faces);\n        for _ in 0..num_faces {\n            fs.push(Rc::new(SDFace::new()));\n        }\n\n        fs\n    }\n}\n\nfn main() {\n    println!(\"{:?}\", (LoopSubdiv::test(4).len(), 4));\n}\n```\n\nOn Linux, I get the expected result:\n\n```\n[~/test]$ rustc --version\nrustc 1.4.0 (8ab8581f6 2015-10-27)\n[~/test]$ rustc -o test test.rs\ntest.rs:4:5: 4:37 warning: struct field is never used: `start_face`, #[warn(dead_code)] on by default\ntest.rs:4     start_face: Option<Weak<SDFace>>,\n              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\ntest.rs:8:5: 12:6 warning: method is never used: `new`, #[warn(dead_code)] on by default\ntest.rs: 8     fn new() -> SDVertex {\ntest.rs: 9         SDVertex {\ntest.rs:10             start_face: None,\ntest.rs:11         }\ntest.rs:12     }\ntest.rs:16:5: 16:35 warning: struct field is never used: `v`, #[warn(dead_code)] on by default\ntest.rs:16     v: [Option<Weak<SDVertex>>; 3],\n               ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n[~/test]$ ./test\n(4, 4)\n```\n\nOn Windows, this fails during compilation:\n\n```\n[~/test]$ rustc --version\nrustc 1.5.0 (3d7cd77e4 2015-12-04)\n[~/test]$ rustc -o test test.rs\ntest.rs:4:5: 4:37 warning: struct field is never used: `start_face`, #[warn(dead_code)] on by default\ntest.rs:4     start_face: Option<Weak<SDFace>>,\n              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\ntest.rs:8:5: 12:6 warning: method is never used: `new`, #[warn(dead_code)] on by default\ntest.rs: 8     fn new() -> SDVertex {\ntest.rs: 9         SDVertex {\ntest.rs:10             start_face: None,\ntest.rs:11         }\ntest.rs:12     }\ntest.rs:16:5: 16:35 warning: struct field is never used: `v`, #[warn(dead_code)] on by default\ntest.rs:16     v: [Option<Weak<SDVertex>>; 3],\n               ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\nerror: linking with `link.exe` failed: exit code: 1104\nnote: \"D:\\\\Program Files (x86)\\\\Microsoft Visual Studio 14.0\\\\VC/bin\\\\amd64\\\\link.exe\" \"/LIBPATH:D:\\\\Program Files (x86)\\\\Microsoft Visual Studio 14.0\\\\VC/lib\\\\amd64\" \"/LIBPATH:C:\\\\Program Files (x86)\\\\Windows Kits\\\\10\\\\Lib\\\\10.0.10150.0\\\\ucrt\\\\x64\" \"/LIBPATH:C:\\\\Program Files (x86)\\\\Windows Kits\\\\8.1\\\\Lib\\\\winv6.3\\\\um\\\\x64\" \"/NOLOGO\" \"/NXCOMPAT\" \"/LIBPATH:D:\\\\Program Files\\\\Rust stable 1.5\\\\bin\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"test.0.o\" \"/OUT:test\" \"/OPT:REF,ICF\" \"/DEBUG\" \"/LIBPATH:D:\\\\Program Files\\\\Rust stable 1.5\\\\bin\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"/LIBPATH:D:\\\\path\\\\to\\\\test\\\\.rust\\\\bin\\\\x86_64-pc-windows-msvc\" \"/LIBPATH:D:\\\\path\\\\to\\\\test\\\\bin\\\\x86_64-pc-windows-msvc\" \"D:\\\\Program Files\\\\Rust stable 1.5\\\\bin\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libstd-35c36e89.rlib\" \"D:\\\\Program Files\\\\Rust stable 1.5\\\\bin\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libcollections-35c36e89.rlib\" \"D:\\\\Program Files\\\\Rust stable 1.5\\\\bin\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\librustc_unicode-35c36e89.rlib\" \"D:\\\\Program Files\\\\Rust stable 1.5\\\\bin\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\librand-35c36e89.rlib\" \"D:\\\\Program Files\\\\Rust stable 1.5\\\\bin\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\liballoc-35c36e89.rlib\" \"D:\\\\Program Files\\\\Rust stable 1.5\\\\bin\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\liballoc_system-35c36e89.rlib\" \"D:\\\\Program Files\\\\Rust stable 1.5\\\\bin\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\liblibc-35c36e89.rlib\" \"D:\\\\Program Files\\\\Rust stable 1.5\\\\bin\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libcore-35c36e89.rlib\" \"ws2_32.lib\" \"userenv.lib\" \"advapi32.lib\" \"kernel32.lib\" \"shell32.lib\" \"msvcrt.lib\" \"compiler-rt.lib\"\nnote: LINK : fatal error LNK1104: cannot open file 'test'\n\nerror: aborting due to previous error\n```\n\nI first identified this bug while [writing something as part of my ray tracer](https://github.com/Mokosha/pbrt_rust/blob/3a8692d3e241ada04a970af8947a1298f40bc7b7/src/shape/loopsubdiv.rs#L241). It failed to run a fairly simple unit test using `cargo test`. The result for that was:\n\n```\npanicked at 'arithmetic operation overflowed', ../src/liballoc\\rc.rs:867\n```\n\nHowever, the weird thing is that this only shows up in the library if I change the definition of `SDFace` to\n\n```\nstruct SDFace {\n    v: [Option<Weak<SDVertex>>; 3],\n    f: [Option<Weak<SDFace>>; 3],\n}\n\nimpl SDFace {\n    fn new() -> SDFace {\n        SDFace {\n            v: [None, None, None],\n            f: [None, None, None],\n        }\n    }\n}\n```\n\nThis seems like a bug somewhere, but I don't know where -- if I need to analyze anything additionally, please let me know.\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/30658/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/30658/timeline", "performed_via_github_app": null, "state_reason": null}