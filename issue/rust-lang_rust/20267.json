{"url": "https://api.github.com/repos/rust-lang/rust/issues/20267", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/20267/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/20267/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/20267/events", "html_url": "https://github.com/rust-lang/rust/issues/20267", "id": 52970987, "node_id": "MDU6SXNzdWU1Mjk3MDk4Nw==", "number": 20267, "title": "Conditional compilation based on crate_type", "user": {"login": "BenTheElder", "id": 917931, "node_id": "MDQ6VXNlcjkxNzkzMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/917931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/BenTheElder", "html_url": "https://github.com/BenTheElder", "followers_url": "https://api.github.com/users/BenTheElder/followers", "following_url": "https://api.github.com/users/BenTheElder/following{/other_user}", "gists_url": "https://api.github.com/users/BenTheElder/gists{/gist_id}", "starred_url": "https://api.github.com/users/BenTheElder/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/BenTheElder/subscriptions", "organizations_url": "https://api.github.com/users/BenTheElder/orgs", "repos_url": "https://api.github.com/users/BenTheElder/repos", "events_url": "https://api.github.com/users/BenTheElder/events{/privacy}", "received_events_url": "https://api.github.com/users/BenTheElder/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 116993, "node_id": "MDU6TGFiZWwxMTY5OTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-driver", "name": "A-driver", "color": "f7e101", "default": false, "description": "Area: rustc_driver that ties everything together into the `rustc` compiler"}, {"id": 234948, "node_id": "MDU6TGFiZWwyMzQ5NDg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-attributes", "name": "A-attributes", "color": "f7e101", "default": false, "description": "Area: #[attributes(..)]"}, {"id": 211668019, "node_id": "MDU6TGFiZWwyMTE2NjgwMTk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-lang", "name": "T-lang", "color": "bfd4f2", "default": false, "description": "Relevant to the language team, which will review and decide on the PR/issue."}, {"id": 630652267, "node_id": "MDU6TGFiZWw2MzA2NTIyNjc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-feature-request", "name": "C-feature-request", "color": "f5f1fd", "default": false, "description": "Category: A feature request, i.e: not implemented / a PR."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 19, "created_at": "2014-12-28T02:28:45Z", "updated_at": "2023-01-28T15:03:16Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "Ideally we should be able to do something like this:\nCargo.toml:\n\n```\n.....\n[lib]\npath = \"src/lib.rs\"\ncrate-type = [\"rlib\",\"dylib\"]\n.....\n```\n\nsrc/lib.rs:\n\n```\n....\n#[no_mangle]\n#[cfg(crate_type=\"dylib\")]\npub unsafe extern \"C\" fn .....\n```\n\nTo allow only exporting the c api in the dylib or perhaps in the dylib and static lib and not in the rust code.\nThis would be consistent with being able to build multiple library formats but allow the unsafe c methods to not be exported to rust code.\n\nI checked against: http://doc.rust-lang.org/reference.html#conditional-compilation\nand did some experimentation myself, with no luck.\n\nIf anyone has any better suggestions, I'd love to hear them.\n\nI'm looking to generate very similar rust and c libraries with similar apis where the c library is just a c style wrapper around the rust api, also written in rust. Ideally i'd keep this in a single source and conditionally define the c api's in the dylib for loading from various languages with c ffi's and exclude the c api from the rust lib.\n", "closed_by": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/20267/reactions", "total_count": 16, "+1": 16, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/20267/timeline", "performed_via_github_app": null, "state_reason": null}