{"url": "https://api.github.com/repos/rust-lang/rust-clippy/issues/10124", "repository_url": "https://api.github.com/repos/rust-lang/rust-clippy", "labels_url": "https://api.github.com/repos/rust-lang/rust-clippy/issues/10124/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust-clippy/issues/10124/comments", "events_url": "https://api.github.com/repos/rust-lang/rust-clippy/issues/10124/events", "html_url": "https://github.com/rust-lang/rust-clippy/issues/10124", "id": 1513247092, "node_id": "I_kwDOAZm0i85aMlF0", "number": 10124, "title": "`clippy::await_holding_refcell_ref` appears to assume out-of-scope variables are being held across await points", "user": {"login": "kpozin", "id": 492262, "node_id": "MDQ6VXNlcjQ5MjI2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/492262?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kpozin", "html_url": "https://github.com/kpozin", "followers_url": "https://api.github.com/users/kpozin/followers", "following_url": "https://api.github.com/users/kpozin/following{/other_user}", "gists_url": "https://api.github.com/users/kpozin/gists{/gist_id}", "starred_url": "https://api.github.com/users/kpozin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kpozin/subscriptions", "organizations_url": "https://api.github.com/users/kpozin/orgs", "repos_url": "https://api.github.com/users/kpozin/repos", "events_url": "https://api.github.com/users/kpozin/events{/privacy}", "received_events_url": "https://api.github.com/users/kpozin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 149309557, "node_id": "MDU6TGFiZWwxNDkzMDk1NTc=", "url": "https://api.github.com/repos/rust-lang/rust-clippy/labels/C-bug", "name": "C-bug", "color": "F5F1FD", "default": false, "description": "Category: Clippy is not doing the correct thing"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-12-28T22:04:17Z", "updated_at": "2022-12-28T23:57:56Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "The following code \r\n```rust\r\nuse anyhow::Error;\r\nuse std::cell::RefCell;\r\n\r\npub struct Outer {\r\n    inner: RefCell<Inner>,\r\n}\r\n\r\nimpl Outer {\r\n    pub fn new() -> Self {\r\n        Self {\r\n            inner: RefCell::new(Inner {\r\n                val: 0,\r\n                flag: false,\r\n            }),\r\n        }\r\n    }\r\n}\r\n\r\npub struct Inner {\r\n    val: u32,\r\n    flag: bool,\r\n}\r\n\r\nimpl Inner {\r\n    \r\n    fn val(&self) -> u32 {\r\n        self.val\r\n    }\r\n}\r\n\r\npub async fn do_something() -> Result<(), Error> {\r\n    let outer = Outer::new();\r\n    if let Some(val) = {\r\n        let inner = outer.inner.borrow();\r\n        inner.flag.then(move || inner.val())\r\n    } {\r\n        do_something_else(val).await?;\r\n    }\r\n    Ok(())\r\n}\r\n\r\nasync fn do_something_else(val: u32) -> Result<(), Error> {\r\n    println!(\"{val}\");\r\n    Ok(())\r\n}\r\n```\r\nyields the following unexpected clippy warning:\r\n\r\n```text\r\nwarning: this `RefCell` reference is held across an `await` point\r\n  --> src/lib.rs:37:9\r\n   |\r\n37 |         inner.flag.then(move || inner.val())\r\n   |         ^^^^^\r\n   |\r\n   = help: ensure the reference is dropped before calling `await`\r\nnote: these are all the `await` points this reference is held through\r\n  --> src/lib.rs:35:5\r\n   |\r\n35 | /     if let Some(val) = {\r\n36 | |         let inner = outer.inner.borrow();\r\n37 | |         inner.flag.then(move || inner.val())\r\n38 | |     } {\r\n39 | |         do_something_else(val).await?;\r\n40 | |     }\r\n   | |_____^\r\n   = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#await_holding_refcell_ref\r\n   = note: `#[warn(clippy::await_holding_refcell_ref)]` on by default\r\n```\r\n\r\nThis probably falls under rust-lang/rust#69663.\r\n\r\n\r\n### Playground link\r\n\r\nhttps://play.rust-lang.org/?version=nightly&mode=debug&edition=2021&gist=75f2f97ff4f11d2d957b25df47d61c26\r\n\r\n\r\n### Meta\r\n\r\n```\r\nNightly channel\r\nBuild using the Nightly version: 1.68.0-nightly\r\n\r\n(2022-12-27 92c1937a90e5b6f20fa6)\r\n```\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust-clippy/issues/10124/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust-clippy/issues/10124/timeline", "performed_via_github_app": null, "state_reason": null}