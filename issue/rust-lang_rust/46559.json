{"url": "https://api.github.com/repos/rust-lang/rust/issues/46559", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/46559/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/46559/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/46559/events", "html_url": "https://github.com/rust-lang/rust/issues/46559", "id": 280162988, "node_id": "MDU6SXNzdWUyODAxNjI5ODg=", "number": 46559, "title": "MIR borrowck: mutable use of immutable upvar causes duplicate errors", "user": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 604489711, "node_id": "MDU6TGFiZWw2MDQ0ODk3MTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-NLL", "name": "A-NLL", "color": "f7e101", "default": false, "description": "Area: Non Lexical Lifetimes (NLL)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 867465998, "node_id": "MDU6TGFiZWw4Njc0NjU5OTg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/NLL-diagnostics", "name": "NLL-diagnostics", "color": "f799ea", "default": false, "description": "Working torwads the \"diagnostic parity\" goal"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/rust-lang/rust/milestones/54", "html_url": "https://github.com/rust-lang/rust/milestone/54", "labels_url": "https://api.github.com/repos/rust-lang/rust/milestones/54/labels", "id": 3463305, "node_id": "MDk6TWlsZXN0b25lMzQ2MzMwNQ==", "number": 54, "title": "Rust 2018 RC", "description": "See https://internals.rust-lang.org/t/rust-2018-the-home-stretch/7810", "creator": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 64, "state": "closed", "created_at": "2018-06-29T18:51:29Z", "updated_at": "2020-06-16T05:11:03Z", "due_on": "2018-09-13T07:00:00Z", "closed_at": "2018-11-16T11:06:58Z"}, "comments": 4, "created_at": "2017-12-07T15:06:21Z", "updated_at": "2018-08-06T21:06:45Z", "closed_at": "2018-08-06T21:06:45Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "e.g. the test `compile-fail/unboxed-closures-mutate-upvar`, or this code:\r\n\r\n```Rust\r\nfn main() {\r\n    let x = 0;\r\n    || { &mut x; };\r\n}\r\n```\r\n\r\nCauses a double error with MIR borrowck\r\n```\r\n$ ./build/x86_64-unknown-linux-gnu/stage1/bin/rustc double-error.rs -Z borrowck=compare\r\nerror[E0595]: closure cannot assign to immutable local variable `x` (Ast)\r\n --> double-error.rs:3:5\r\n  |\r\n2 |     let x = 0;\r\n  |         - consider changing this to `mut x`\r\n3 |     || { &mut x; };\r\n  |     ^^ cannot borrow mutably\r\n\r\nerror[E0596]: cannot borrow immutable item `x` as mutable (Mir)\r\n --> double-error.rs:3:5\r\n  |\r\n3 |     || { &mut x; };\r\n  |     ^^^^^^^^^^^^^^ cannot borrow as mutable\r\n\r\nerror[E0596]: cannot borrow immutable item `x` as mutable (Mir)\r\n --> double-error.rs:3:10\r\n  |\r\n3 |     || { &mut x; };\r\n  |          ^^^^^^ cannot borrow as mutable\r\n  |\r\n  = note: Value not mutable causing this error: `x`\r\n\r\nerror: aborting due to 3 previous errors\r\n\r\n```\r\n\r\nThe reason is that the borrow of `x` is inferred as mutable, rather than unique, which means there's an error when *creating* the closure. \r\n\r\nI think the best way to solve this would be to limit borrows of immutable upvars to unique - a mutable borrow can't succeed anyway, so this will only cause errors. We can't change the borrow to be unique, because otherwise AST borrowck will not report an error, but maybe we can do this in MIR construction?", "closed_by": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/46559/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/46559/timeline", "performed_via_github_app": null, "state_reason": "completed"}