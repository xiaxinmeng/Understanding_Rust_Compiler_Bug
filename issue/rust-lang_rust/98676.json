{"url": "https://api.github.com/repos/rust-lang/rust/issues/98676", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/98676/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/98676/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/98676/events", "html_url": "https://github.com/rust-lang/rust/issues/98676", "id": 1288970982, "node_id": "I_kwDOAAsO6M5M1CLm", "number": 98676, "title": "Const associated items behave differently than module const declarations, \"cannot evaluate destructors\" error", "user": {"login": "AaronFriel", "id": 788800, "node_id": "MDQ6VXNlcjc4ODgwMA==", "avatar_url": "https://avatars.githubusercontent.com/u/788800?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AaronFriel", "html_url": "https://github.com/AaronFriel", "followers_url": "https://api.github.com/users/AaronFriel/followers", "following_url": "https://api.github.com/users/AaronFriel/following{/other_user}", "gists_url": "https://api.github.com/users/AaronFriel/gists{/gist_id}", "starred_url": "https://api.github.com/users/AaronFriel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AaronFriel/subscriptions", "organizations_url": "https://api.github.com/users/AaronFriel/orgs", "repos_url": "https://api.github.com/users/AaronFriel/repos", "events_url": "https://api.github.com/users/AaronFriel/events{/privacy}", "received_events_url": "https://api.github.com/users/AaronFriel/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2022-06-29T16:25:08Z", "updated_at": "2022-06-29T16:38:56Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\n[I tried this code (Rust Playground link)](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=1b17588e165e1e8f1a628fa120d0e082)\r\n\r\n```rust\r\nuse std::borrow::Cow;\r\n\r\nstruct T { doesnt_matter: Cow<'static, str> }\r\n\r\nconst FOO: T = T { doesnt_matter: Cow::Borrowed(\"foo\") }; // OK as long as decl is const\r\nconst BAR: T = T { ..FOO }; // OK\r\n\r\ntrait SomeTrait {\r\n  const ASSOC_CONST: T;\r\n}\r\n\r\nimpl SomeTrait for usize {\r\n  const ASSOC_CONST: T = T { ..BAR }; // OK\r\n}\r\n\r\nconst BAZ: T = T { ..usize::ASSOC_CONST }; // ERROR: \"value is dropped here\", \"constants cannot evaluate destructors\"\r\n\r\nconst USIZE_CONST: T = usize::ASSOC_CONST; // OK\r\n\r\nconst BAZ_TAKE_TWO: T = T { ..USIZE_CONST }; // ERROR: \"value is dropped here\", \"constants cannot evaluate destructors\"\r\n```\r\n\r\nI expected to see this happen: the declaration of BAZ and BAZ_TAKE_TWO should work, just as the declaration of BAR and the impl of SomeTrait worked.\r\n\r\nInstead, this happened: compiler error.\r\n\r\nTrait associated constants seem to lack some bit/flag set that denotes that no destructor is required when dropping them. Constants at the module level however can be used just fine.\r\n\r\nThe declaration of `USIZE_CONST` shows that this seems to break referential transparency. That value seems to \"know\" that it is different, in some way, than FOO and BAR, and it cannot be used in the same way as those two constants.\r\n\r\n### Meta\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.61.0 (fe5b13d68 2022-05-18)\r\nbinary: rustc\r\ncommit-hash: fe5b13d681f25ee6474be29d748c65adcd91f69e\r\ncommit-date: 2022-05-18\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.61.0\r\nLLVM version: 14.0.0\r\n```\r\n\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/98676/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/98676/timeline", "performed_via_github_app": null, "state_reason": null}