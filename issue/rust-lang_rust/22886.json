{"url": "https://api.github.com/repos/rust-lang/rust/issues/22886", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/22886/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/22886/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/22886/events", "html_url": "https://github.com/rust-lang/rust/issues/22886", "id": 59322592, "node_id": "MDU6SXNzdWU1OTMyMjU5Mg==", "number": 22886, "title": "Crash from iterator returning borrowed reference", "user": {"login": "tov", "id": 732548, "node_id": "MDQ6VXNlcjczMjU0OA==", "avatar_url": "https://avatars.githubusercontent.com/u/732548?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tov", "html_url": "https://github.com/tov", "followers_url": "https://api.github.com/users/tov/followers", "following_url": "https://api.github.com/users/tov/following{/other_user}", "gists_url": "https://api.github.com/users/tov/gists{/gist_id}", "starred_url": "https://api.github.com/users/tov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tov/subscriptions", "organizations_url": "https://api.github.com/users/tov/orgs", "repos_url": "https://api.github.com/users/tov/repos", "events_url": "https://api.github.com/users/tov/events{/privacy}", "received_events_url": "https://api.github.com/users/tov/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37544, "node_id": "MDU6TGFiZWwzNzU0NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-typesystem", "name": "A-typesystem", "color": "f7e101", "default": false, "description": "Area: The type system"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2015-02-28T03:18:27Z", "updated_at": "2015-06-16T20:16:29Z", "closed_at": "2015-06-16T20:16:21Z", "author_association": "NONE", "active_lock_reason": null, "body": "With an iterator that returns a borrowed reference to its contents, it\u2019s possible to hold the reference longer than the reference is valid. In particular, if the iterator changes its internal state, the new state can be observed via the saved reference. Check it out:\n\n``` rust\nfn crash_please() {\n    let mut iter = Newtype(Some(Box::new(0)));\n    let saved = iter.next().unwrap();\n    println!(\"{}\", saved);\n    iter.0 = None;\n    println!(\"{}\", saved);\n}\n\nstruct Newtype(Option<Box<usize>>);\n\nimpl<'a> Iterator for Newtype {\n    type Item = &'a Box<usize>;\n\n    fn next(&mut self) -> Option<&Box<usize>> {\n        self.0.as_ref()\n    }\n}\n```\n\nThis clearly shouldn\u2019t type check, but it does, and runs, and crashes:\n\n``` sh\n0\nzsh: illegal hardware instruction  target/collect_bug\n```\n\nWhere the type error should be, I\u2019m not sure. It seems like it\u2019s actually a problem with traits. If we change the above code to define `next` in a non-trait impl, then it no longer passes the borrow checker:\n\n``` rust\nimpl<'a> Newtype {\n    fn next(&mut self) -> Option<&Box<usize>> {\n        self.0.as_ref()\n    }\n}\n```\n\nI originally observed this bug when testing an iterator that owns a `String`; at each iteration it modifies the string and then returns a string slice borrowed from it. My non-test code worked fine because it finished with each value from the iterator before calling `next()` again, but the test code collected the iterator into a vector. This meant that all the slices in the vector continued to point to the same buffer, even after it had been modified. So for example, if the strings written to the buffer were `\"aaa\"`, `\"bb\"`, and `\"c\"`, then in the end the vector would contain `\"cba\"`, `\"cb\"`, and `\"b\"`. Creepy.\n## Version\n\nI\u2019m using 1.0.0-alpha still, because I\u2019m teaching a class and we don\u2019t want to follow a moving target, but I confirmed that the Feb. 26 nightly has the same bug.\n\n```\nrustc 1.0.0-alpha (44a287e6e 2015-01-08 17:03:40 -0800)\nbinary: rustc\ncommit-hash: 44a287e6eb22ec3c2a687fc156813577464017f7\ncommit-date: 2015-01-08 17:03:40 -0800\nhost: x86_64-apple-darwin\nrelease: 1.0.0-alpha\n```\n", "closed_by": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/22886/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/22886/timeline", "performed_via_github_app": null, "state_reason": "completed"}