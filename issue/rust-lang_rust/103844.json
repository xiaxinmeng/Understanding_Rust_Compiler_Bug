{"url": "https://api.github.com/repos/rust-lang/rust/issues/103844", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/103844/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/103844/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/103844/events", "html_url": "https://github.com/rust-lang/rust/issues/103844", "id": 1431890528, "node_id": "I_kwDOAAsO6M5VWOpg", "number": 103844, "title": "Query cycle before ast lowered turns into dumpster fire", "user": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-11-01T18:31:36Z", "updated_at": "2022-11-01T19:39:09Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "This is mostly just a rustc developer experience issue that crops up if you accidentally introduce a query cycle before ast lowering completes. After this happened to me a few times, I finally understand what is happening so I figured I should document it.\r\n\r\nIf a query cycle occurs before or during ast lowering, then rustc winds up querying for the HIR while trying to collect info about the cycle to report it, and this leads to another cycle and more panics, which is rather confusing to behold. The root issue is that we try to call the `def_span` and `def_kind` queries in the following places:\r\n\r\nhttps://github.com/rust-lang/rust/blob/e70cbef0c5db81079f4b5643380d6047ccd34a10/compiler/rustc_query_impl/src/plumbing.rs#L319\r\n\r\n(`default_span` is implemented using `def_span` if the key is `DefId` or `LocalDefId`)\r\n\r\nhttps://github.com/rust-lang/rust/blob/e70cbef0c5db81079f4b5643380d6047ccd34a10/compiler/rustc_query_impl/src/plumbing.rs#L326\r\n\r\nSome ideas:\r\n1. Use `source_span` instead of `def_span`\r\n2. Add a way to get `def_span` and/or `def_kind` from AST (probably only for diagnostics cases like this)\r\n3. Add a way to detect if AST has been lowered, and skip those queries if not", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/103844/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/103844/timeline", "performed_via_github_app": null, "state_reason": null}