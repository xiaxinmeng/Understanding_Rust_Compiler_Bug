{"url": "https://api.github.com/repos/rust-lang/rust/issues/68812", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/68812/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/68812/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/68812/events", "html_url": "https://github.com/rust-lang/rust/issues/68812", "id": 559393195, "node_id": "MDU6SXNzdWU1NTkzOTMxOTU=", "number": 68812, "title": "Incorrect code behavior on aarch64", "user": {"login": "berkus", "id": 80306, "node_id": "MDQ6VXNlcjgwMzA2", "avatar_url": "https://avatars.githubusercontent.com/u/80306?v=4", "gravatar_id": "", "url": "https://api.github.com/users/berkus", "html_url": "https://github.com/berkus", "followers_url": "https://api.github.com/users/berkus/followers", "following_url": "https://api.github.com/users/berkus/following{/other_user}", "gists_url": "https://api.github.com/users/berkus/gists{/gist_id}", "starred_url": "https://api.github.com/users/berkus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/berkus/subscriptions", "organizations_url": "https://api.github.com/users/berkus/orgs", "repos_url": "https://api.github.com/users/berkus/repos", "events_url": "https://api.github.com/users/berkus/events{/privacy}", "received_events_url": "https://api.github.com/users/berkus/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}, {"id": 55301954, "node_id": "MDU6TGFiZWw1NTMwMTk1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-Arm", "name": "O-Arm", "color": "6e6ec0", "default": false, "description": "Target: 32-bit Arm processors (armv6, armv7, thumb...), including 64-bit Arm in AArch32 state"}, {"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1359848690, "node_id": "MDU6TGFiZWwxMzU5ODQ4Njkw", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-mcve", "name": "E-needs-mcve", "color": "02e10c", "default": false, "description": "Call for participation: This issue needs a Minimal Complete and Verifiable Example"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 15, "created_at": "2020-02-03T23:19:08Z", "updated_at": "2020-10-13T19:02:24Z", "closed_at": "2020-10-13T19:02:23Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "\r\nThe following code compiles and works correctly on `x86_64`. However, the same code when compiled for `aarch64` with `opt-level = \"s\"` does not work.\r\n\r\nhttps://github.com/berkus/mre-write_to \r\nThe culprit is the function show() in write_to.rs:44\r\n\r\n(one-page version [here](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=6716bf91b5ec219b3e47ee9845817b2f) -- this however is not enough for reproduction)\r\n\r\nWhen used from the same module it correctly generates a &str from buffer slice. When used from another module the resulting str is \"\" (empty).\r\n\r\nThe original code location, where bug is easily reproducible by running `makers test` is [here](https://github.com/metta-systems/vesper/commit/cf277ca6f95bdcd8e2e4792d465864085780dd0f#diff-0223edd1d1e7828c93f97bf9fe0d955eR66-R72)\r\n\r\n(Disclaimer: [custom target file](), should match LLVM layout for aarch64 however; [custom linker script]() for OS kernel)\r\n\r\nThere, marking the function with `#[inline]` makes it work correctly at call sites other than the same module (for example, from [here](https://github.com/metta-systems/vesper/commit/56d70afdba836232a13a603001b1bc5a9232a751#diff-fc33479aa09afcf480bf5414d24a0517R32-R38)). Removing inline modifier makes it produce \"\" (empty) strs. It still works correctly from within the same module (e.g. local unit tests pass).\r\n\r\nChanging `opt-level` from \"s\" to 2 or 3 also fixes the issue.\r\n\r\nReplacing `from_utf8_unchecked` with `from_utf8().unwrap()` causes different behavior. Now opt-levels 2 and \"s\" produce empty strs while opt-level 3 works as intended.\r\n\r\nIt looks like code generation bug to me.\r\n\r\n$ rustc --version\r\nrustc 1.42.0-nightly (cd1ef390e 2020-01-31)\r\n\r\nReady to provide more information or test possible fixes.", "closed_by": {"login": "berkus", "id": 80306, "node_id": "MDQ6VXNlcjgwMzA2", "avatar_url": "https://avatars.githubusercontent.com/u/80306?v=4", "gravatar_id": "", "url": "https://api.github.com/users/berkus", "html_url": "https://github.com/berkus", "followers_url": "https://api.github.com/users/berkus/followers", "following_url": "https://api.github.com/users/berkus/following{/other_user}", "gists_url": "https://api.github.com/users/berkus/gists{/gist_id}", "starred_url": "https://api.github.com/users/berkus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/berkus/subscriptions", "organizations_url": "https://api.github.com/users/berkus/orgs", "repos_url": "https://api.github.com/users/berkus/repos", "events_url": "https://api.github.com/users/berkus/events{/privacy}", "received_events_url": "https://api.github.com/users/berkus/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/68812/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/68812/timeline", "performed_via_github_app": null, "state_reason": "completed"}