{"url": "https://api.github.com/repos/rust-lang/rust/issues/47086", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/47086/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/47086/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/47086/events", "html_url": "https://github.com/rust-lang/rust/issues/47086", "id": 285242571, "node_id": "MDU6SXNzdWUyODUyNDI1NzE=", "number": 47086, "title": "OSX compilation with debuginfo isn't deterministic", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123111, "node_id": "MDU6TGFiZWwxMjMxMTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-macos", "name": "O-macos", "color": "6e6ec0", "default": false, "description": "Operating system: macOS"}, {"id": 203130, "node_id": "MDU6TGFiZWwyMDMxMzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-debuginfo", "name": "A-debuginfo", "color": "f7e101", "default": false, "description": "Area: Debugging information in compiled programs (DWARF, PDB, etc.)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1508600909, "node_id": "MDU6TGFiZWwxNTA4NjAwOTA5", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-reproducibility", "name": "A-reproducibility", "color": "f7e101", "default": false, "description": "Area: Reproducible / Deterministic builds"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 12, "created_at": "2017-12-31T06:23:15Z", "updated_at": "2020-05-26T20:58:48Z", "closed_at": "2020-05-26T20:58:48Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "This is an issue extracted from https://github.com/rust-lang/rust/issues/47066#issuecomment-354562944 which is caused by an issue that any OSX compilation with debuginfo ends up being nondeterministic. Specifically (currently known at least) the source of nondeterminism is that an mtime for an object file winds up in the final binary. \r\n\r\nIt turns out this isn't really our fault (unfortunately that makes it harder to fix!). This can be reproduced with just C and a linker:\r\n\r\n```\r\n# Compile an object file with a symbol in it\r\n$ echo 'void foo() {}' > foo.c\r\n$ cc -g foo.c -o foo.o -c\r\n\r\n# Link that object to a shared library, take a look at the output\r\n$ cc foo.o -m64 -dynamiclib -o libfoo.dylib -Wl,-dylib\r\n$ md5 libfoo.dylib\r\nMD5 (libfoo.dylib) = e60e735b7c919c19259daddd04a625c8\r\n\r\n# update the timestamp on the object file\r\n$ sleep 1\r\n$ touch foo.o\r\n\r\n# now link the same way we did above\r\n$ cc foo.o -m64 -dynamiclib -o libfoo.dylib -Wl,-dylib\r\n$ md5 libfoo.dylib\r\nMD5 (libfoo.dylib) = 9754a78562696bbe5912efd9fc892a83\r\n```\r\n\r\nHere we're using the exact same object file (with two timestamps) and we're seeing different linked artifacts.\r\n\r\nThis is a source of bugs in programs that expect rustc to be deterministic (aka #47066 as was originally stated) and is something that we as rustc should probably fix.\r\n\r\nUnfortunately I don't really know of a fix for this myself. I'd be tempted to take a big hammer to the problem and deterministically set all mtime fields for objects going into the linker to a known fixed value, but that unfortunately doesn't fix the determinism for C code (whose objects we don't control) and also is probably too big of a hammer (if a build system uses the mtime of the object to control rebuilds it'd get mixed up).\r\n\r\nWe could also use something like `goblin` and reach in to the specific field and remove the actual data. I found it in a symbol section with the `N_OSO` type (described in various documents online too apparently). We may be able to postprocess all output artifacts on OSX to maybe just zero out these fields unconditionally (or set them to something like May 15, 2015), although I'm not actually sure if this would be easy to do.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/47086/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/47086/timeline", "performed_via_github_app": null, "state_reason": "completed"}