{"url": "https://api.github.com/repos/rust-lang/rust/issues/41107", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/41107/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/41107/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/41107/events", "html_url": "https://github.com/rust-lang/rust/issues/41107", "id": 219834771, "node_id": "MDU6SXNzdWUyMTk4MzQ3NzE=", "number": 41107, "title": "Unexpected Compiler Panic", "user": {"login": "isaacg1", "id": 8034059, "node_id": "MDQ6VXNlcjgwMzQwNTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8034059?v=4", "gravatar_id": "", "url": "https://api.github.com/users/isaacg1", "html_url": "https://github.com/isaacg1", "followers_url": "https://api.github.com/users/isaacg1/followers", "following_url": "https://api.github.com/users/isaacg1/following{/other_user}", "gists_url": "https://api.github.com/users/isaacg1/gists{/gist_id}", "starred_url": "https://api.github.com/users/isaacg1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/isaacg1/subscriptions", "organizations_url": "https://api.github.com/users/isaacg1/orgs", "repos_url": "https://api.github.com/users/isaacg1/repos", "events_url": "https://api.github.com/users/isaacg1/events{/privacy}", "received_events_url": "https://api.github.com/users/isaacg1/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2017-04-06T09:17:35Z", "updated_at": "2017-04-06T09:39:02Z", "closed_at": "2017-04-06T09:36:50Z", "author_association": "NONE", "active_lock_reason": null, "body": "I was running my code, which I didn't expect to compile, and got a compiler panic, so I'm posting it here. Apologies that it's not a minimal test case.\r\n\r\nI tried this code:\r\n\r\n```\r\n#![allow(dead_code)]\r\nextern crate termios;\r\nextern crate libc;\r\n\r\nuse std::io::{self, Read, Write};\r\nuse std::os::raw::c_int;\r\n\r\nuse termios::*;\r\n\r\n/*** utility ***/\r\n\r\nconst STDIN: c_int = 1;\r\nconst STDOUT: c_int = 2;\r\n\r\nfn ctrl_key(k: char) -> u8 {\r\n    k as u8 & 0x1f\r\n}\r\n\r\n/*** data ***/\r\n\r\n\r\nstruct EditorConfig {\r\n    orig_termios: Termios,\r\n    screen_rows: usize,\r\n    screen_cols: usize,\r\n}\r\n\r\nimpl EditorConfig {\r\n    fn new(orig_termios: Termios) -> EditorConfig {\r\n        let mut ws = libc::winsize { \r\n            ws_row: 0,\r\n            ws_col: 0,\r\n            ws_xpixel: 0,\r\n            ws_ypixel: 0,\r\n        };\r\n        let res = libc::ioctl(STDOUT, libc::TIOCGWINSZ, &mut ws);\r\n        if res == 1 || ws.ws_col == 0 {\r\n            panic!(\"Editor config failed.\");\r\n        } else {\r\n            EditorConfig {\r\n                orig_termios = orig_termios,\r\n                screen_rows = ws.ws_row,\r\n                screen_cols = wc.ws_col,\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n/*** terminal ***/\r\nfn enable_raw_mode() -> io::Result<Termios> {\r\n    let orig_termios = Termios::from_fd(STDIN)?;\r\n\r\n    let mut termios = orig_termios.clone();\r\n\r\n    termios.c_cflag |= CS8;\r\n    termios.c_iflag &= !(BRKINT | ICRNL | INPCK | ISTRIP | IXON);\r\n    termios.c_lflag &= !(ECHO | ICANON | IEXTEN | ISIG);\r\n    termios.c_oflag &= !(OPOST);\r\n    termios.c_cc[VMIN] = 0; // Return on any characters read;\r\n    termios.c_cc[VTIME] = 1; //Wait for 0.1 seconds.\r\n\r\n    tcsetattr(STDIN, TCSAFLUSH, &mut termios)?;\r\n\r\n    Ok(orig_termios)\r\n}\r\n\r\nfn restore_orig_mode(editor_config: &mut EditorConfig) -> io::Result<()> {\r\n    tcsetattr(STDIN, TCSAFLUSH, &mut editor_config.orig_termios)\r\n}\r\n\r\nfn editor_read_key() -> u8 {\r\n    let mut buffer: [u8; 1] = [0];\r\n    loop {\r\n        match io::stdin().read(&mut buffer) {\r\n            Ok(0) => (),\r\n            Ok(_) => return buffer[0],\r\n            Err(e) => panic!(\"Read failure: {}\", e),\r\n        };\r\n    }\r\n}\r\n\r\n/*** output ***/\r\n\r\nfn editor_draw_rows() {\r\n    for _ in 0..24 {\r\n        println!(\"~\\r\");\r\n    }\r\n}\r\n\r\nfn editor_refresh_screen() {\r\n    print!(\"\\x1b[2J\");\r\n    print!(\"\\x1b[H\");\r\n\r\n    editor_draw_rows();\r\n\r\n    print!(\"\\x1b[H\");\r\n    io::stdout().flush().unwrap();\r\n}\r\n\r\n/*** input ***/\r\nfn editor_process_keypress() -> bool {\r\n    let c: u8 = editor_read_key();\r\n\r\n    if c == ctrl_key('q') {\r\n        false\r\n    } else {\r\n        true\r\n    }\r\n}\r\n\r\n/*** init ***/\r\n\r\nfn main() {\r\n    let orig_termios = match enable_raw_mode() {\r\n        Ok(t) => t,\r\n        Err(e) => panic!(\"Enabling raw mode failed with {}\", e),\r\n    };\r\n\r\n    let mut editor_config: EditorConfig = EditorConfig { orig_termios: orig_termios };\r\n    \r\n    println!(\"Type text, CTRL-q to exit.\\r\");\r\n    loop {\r\n        editor_refresh_screen();\r\n        let to_continue = editor_process_keypress();\r\n        if !to_continue { break } \r\n    }\r\n    \r\n    match restore_orig_mode(&mut editor_config) {\r\n        Ok(()) => (),\r\n        Err(e) => panic!(\"Disabling raw mode failed with {}\", e),\r\n    };\r\n}\r\n```\r\nI ran this using `cargo check`, with the Cargo.toml file:\r\n\r\n```\r\n[package]\r\nname = \"text\"\r\nversion = \"0.1.0\"\r\nauthors = [\"Isaac Grosof <isaacg@mit.edu>\"]\r\n\r\n[dependencies]\r\ntermios = \"0.2\"\r\nioctl-rs = \"0.1.5\"\r\n```\r\n\r\nI expected to see this happen: A compiler error\r\n\r\nInstead, this happened: The compiler unexpectedly panicked, and told me that this was a bug.\r\n\r\n## Meta\r\n\r\n`rustc --version --verbose`\r\n\r\nrustc 1.15.0-nightly (71c06a56a 2016-12-18)\r\nbinary: rustc\r\ncommit-hash: 71c06a56a120a0d5e3b224105ee3e6754f83e5fa\r\ncommit-date: 2016-12-18\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.15.0-nightly\r\nLLVM version: 3.9\r\n\r\n`cargo --version`\r\ncargo 0.16.0-nightly (ddb5c32 2016-12-16)\r\n\r\nBacktrace:\r\n\r\n`RUST_BACKTRACE=1 cargo check 2> log.txt`\r\n\r\n```\r\n   Compiling text v0.1.0 (file:///home/isaac/prog/rust/text)\r\nerror: expected one of `,` or `}`, found `=`\r\n  --> src/main.rs:40:30\r\n   |\r\n40 |                 orig_termios = orig_termios,\r\n   |                              ^\r\n\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: run with `RUST_BACKTRACE=1` for a backtrace\r\n\r\nthread 'rustc' panicked at 'called `Option::unwrap()` on a `None` value', /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libcore/option.rs:323\r\nstack backtrace:\r\n   1:     0x7f034cdad38a - std::sys::imp::backtrace::tracing::imp::write::h0d1aacfb8fc693ac\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/sys/unix/backtrace/tracing/gcc_s.rs:42\r\n   2:     0x7f034cdbb6ff - std::panicking::default_hook::{{closure}}::hff87359baf5754d0\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:349\r\n   3:     0x7f034cdbb29d - std::panicking::default_hook::h936f17ca3b2b98dc\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:359\r\n   4:     0x7f034cdbbba7 - std::panicking::rust_panic_with_hook::he9c830ab830c7944\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:553\r\n   5:     0x7f034cdbba34 - std::panicking::begin_panic::hbd10b7f500042f98\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:515\r\n   6:     0x7f034cdbb959 - std::panicking::begin_panic_fmt::h49583ddd44614a0d\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:499\r\n   7:     0x7f034cdbb8e7 - rust_begin_unwind\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:475\r\n   8:     0x7f034cdf71cd - core::panicking::panic_fmt::h3b787d0ceafd7204\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libcore/panicking.rs:69\r\n   9:     0x7f034cdf7104 - core::panicking::panic::h57808c0fa90ee3ee\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libcore/panicking.rs:49\r\n  10:     0x7f034b2b51bb - rustc_metadata::creader::CrateLoader::resolve_crate::h42bbaa7ad477c08e\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libcore/macros.rs:21\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_metadata/creader.rs:229\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_metadata/cstore.rs:148\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_metadata/creader.rs:192\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_metadata/creader.rs:344\r\n  11:     0x7f034b2bc564 - <rustc_metadata::creader::CrateLoader<'a> as rustc::middle::cstore::CrateLoader>::process_item::h27e3d871efa8103e\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_metadata/creader.rs:1021\r\n  12:     0x7f034c52a1d0 - <rustc_resolve::build_reduced_graph::BuildReducedGraphVisitor<'a, 'b> as syntax::visit::Visitor<'a>>::visit_item::h34d3157f6c27082e\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_resolve/build_reduced_graph.rs:236\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_resolve/build_reduced_graph.rs:708\r\n  13:     0x7f034c52ca4e - <rustc_resolve::build_reduced_graph::BuildReducedGraphVisitor<'a, 'b> as syntax::visit::Visitor<'a>>::visit_item::h34d3157f6c27082e\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libsyntax/visit.rs:140\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libsyntax/visit.rs:59\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libsyntax/visit.rs:258\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_resolve/build_reduced_graph.rs:709\r\n  14:     0x7f034c52236f - rustc_resolve::macros::<impl syntax::ext::base::Resolver for rustc_resolve::Resolver<'a>>::visit_expansion::h256af8786c8e8cc7\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libsyntax/ext/expand.rs:94\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_resolve/macros.rs:136\r\n  15:     0x7f0345e7259e - syntax::ext::expand::MacroExpander::collect_invocations::h3b6970f712e5246a\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libsyntax/ext/expand.rs:323\r\n  16:     0x7f0345e71002 - syntax::ext::expand::MacroExpander::expand::he915f7737e57b90c\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libsyntax/ext/expand.rs:225\r\n  17:     0x7f0345e708d7 - syntax::ext::expand::MacroExpander::expand_crate::h46f2fa9a3b1ebe5a\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libsyntax/ext/expand.rs:209\r\n  18:     0x7f034d13193f - rustc_driver::driver::phase_2_configure_and_expand::{{closure}}::h0ad68d726f9b2568\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/driver.rs:681\r\n  19:     0x7f034d12a4c4 - rustc_driver::driver::phase_2_configure_and_expand::h2cc6ba3ed8dbd9ea\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc/util/common.rs:34\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/driver.rs:644\r\n  20:     0x7f034d12395e - rustc_driver::driver::compile_input::hc9da7de451d406ba\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/driver.rs:120\r\n  21:     0x7f034d16ab47 - rustc_driver::run_compiler::h408af14fa24a33a5\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/lib.rs:221\r\n  22:     0x7f034d0889e8 - std::panicking::try::do_call::h2c149962956958c1\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/lib.rs:1117\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/lib.rs:137\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/librustc_driver/lib.rs:1051\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panic.rs:295\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:458\r\n  23:     0x7f034cdc43ca - __rust_maybe_catch_panic\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libpanic_unwind/lib.rs:98\r\n  24:     0x7f034d0aa328 - <F as alloc::boxed::FnBox<A>>::call_box::hf839c55097f480b2\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panicking.rs:434\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/panic.rs:351\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/thread/mod.rs:287\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/liballoc/boxed.rs:605\r\n  25:     0x7f034cdba564 - std::sys::imp::thread::Thread::new::thread_start::h1fa04983ba2271d0\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/liballoc/boxed.rs:615\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/sys_common/thread.rs:21\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/src/libstd/sys/unix/thread.rs:84\r\n  26:     0x7f0344fc2183 - start_thread\r\n  27:     0x7f034ca6f37c - clone\r\n  28:                0x0 - <unknown>\r\n\r\nerror: Could not compile `text`.\r\n\r\nTo learn more, run the command again with --verbose.\r\n```", "closed_by": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/41107/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/41107/timeline", "performed_via_github_app": null, "state_reason": "completed"}