{"url": "https://api.github.com/repos/rust-lang/rust/issues/40713", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/40713/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/40713/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/40713/events", "html_url": "https://github.com/rust-lang/rust/issues/40713", "id": 215872016, "node_id": "MDU6SXNzdWUyMTU4NzIwMTY=", "number": 40713, "title": "Switch `run-make` tests from Makefiles to rust", "user": {"login": "TimNN", "id": 1178249, "node_id": "MDQ6VXNlcjExNzgyNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/1178249?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TimNN", "html_url": "https://github.com/TimNN", "followers_url": "https://api.github.com/users/TimNN/followers", "following_url": "https://api.github.com/users/TimNN/following{/other_user}", "gists_url": "https://api.github.com/users/TimNN/gists{/gist_id}", "starred_url": "https://api.github.com/users/TimNN/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TimNN/subscriptions", "organizations_url": "https://api.github.com/users/TimNN/orgs", "repos_url": "https://api.github.com/users/TimNN/repos", "events_url": "https://api.github.com/users/TimNN/events{/privacy}", "received_events_url": "https://api.github.com/users/TimNN/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 120005, "node_id": "MDU6TGFiZWwxMjAwMDU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-testsuite", "name": "A-testsuite", "color": "f7e101", "default": false, "description": "Area: The testsuite used to check the correctness of rustc"}, {"id": 234876, "node_id": "MDU6TGFiZWwyMzQ4NzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-hard", "name": "E-hard", "color": "02e10c", "default": false, "description": "Call for participation: Experience needed to fix: Hard / a lot"}, {"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 67766349, "node_id": "MDU6TGFiZWw2Nzc2NjM0OQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-mentor", "name": "E-mentor", "color": "02E10C", "default": false, "description": "Call for participation: This issue has a mentor. Use RustcContributor::new on Zulip for discussion."}, {"id": 289259951, "node_id": "MDU6TGFiZWwyODkyNTk5NTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-help-wanted", "name": "E-help-wanted", "color": "02E10C", "default": false, "description": "Call for participation: Help is requested to fix this issue."}, {"id": 325438536, "node_id": "MDU6TGFiZWwzMjU0Mzg1MzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-bootstrap", "name": "T-bootstrap", "color": "bfd4f2", "default": false, "description": "Relevant to the bootstrap subteam: Rust's build system (x.py and src/bootstrap)"}, {"id": 593503757, "node_id": "MDU6TGFiZWw1OTM1MDM3NTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-infra", "name": "T-infra", "color": "bfd4f2", "default": false, "description": "Relevant to the infrastructure team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2017-03-21T20:44:34Z", "updated_at": "2023-03-30T12:01:53Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Rust currently has a suite of [`run-make`](https://github.com/rust-lang/rust/tree/master/src/test/run-make) tests, which generally test specific `rustc` invocations or behaviour,  or require external tools (eg. `grep` or `nm`).\r\n\r\nThe goal of this issue is to rewrite these `run-make` tests, which are currently written as Makefiles, in rust to a) get rid of the dependency on external tools such as `make` and b) make them more accessible to rust contributors by not requiring arcane knowledge of the `make` tool.\r\n\r\nThe transition will require at least the following steps:\r\n\r\n* [ ] Survey the existing `run-make` tests with regard to what they actually do / which programs they use (and how). I assume the programs will likely fall into one of three categories:\r\n    * Rust tools (`rustc`, `rustdoc`)\r\n    * Utilities easily replaceable by rust code, eg. `grep`\r\n    * Complex utilities, eg. `nm`, which cannot be easily rewritten in rust\r\n* [ ] Design and (partially) implement a support library, which makes the actions identified above easily possible. For example I imagine a test should look something like this:\r\n    ```rust\r\n    extern crate support;\r\n    \r\n    fn main() {\r\n        let s = support::init();\r\n        \r\n        let lib = s.rustc().compile(\"file1.rs\").output_rlib();\r\n        \r\n        assert!(s.nm(lib).filter_lines(\"some_symbol\").count() == 2);\r\n    }\r\n    ```\r\n* [ ] Add a new mode to [`compile-test`](https://github.com/rust-lang/rust/tree/master/src/tools/compiletest), maybe `run-rmake`, which runs the new rust-based `run-make` tests. This will either include compiling the support library, or receiving the support library from a previous build stage.\r\n* [ ] Start porting the actual `run-make` tests, which may involve adding additional functionality to the support library. At that time this issue, or another, will track the state of all the existing tests and include some detailed instruction to allow people to easily contributing by porting one of the existing tests.\r\n\r\n---\r\n\r\nThere are some open questions:\r\n\r\n* Should the support library allow execution of arbitrary commands? Limiting commands to only those explicitly added to the support library would mean that there is a single place which lists the external tools we depend on.\r\n* Is the proposed integration with `compiletest` the correct choice? For example the support library itself may have external dependencies  (maybe `regex` or `gcc-rs`) which means we should probably use cargo to compile the actual tests. At which point it may be worth considering if `compile-test` is needed at all or if cargo is enough (Have the support library in `src/lib.rs`,  the new `run-make` tests in `tests/*.rs` and auxiliary files in subdirectories of `tests/` named after the main test file).\r\n\r\n---\r\n\r\nIf anyone wants to get involved in the process, please leave a comment on this issue or ping me on IRC.\r\n\r\n---\r\n\r\n<details><summary>Original Issue Description</summary>\r\n\r\nBased on a short experiment, it looks like rust on msvc only has five build dependencies: Visual Studio, Git, Python, CMake and make, where make is only used for the `run-make` tests as far as I can tell.\r\n\r\nOf those five, the first four are easily installable natively on windows, whereas make wasn't as straight forward to installe when I tried and required msys2 / mingw.\r\n\r\nThe questions the are:\r\n\r\n* Is there any interest in performing such a conversion?\r\n* If so, then which language should those tests be migrated to? Python or Rust seem like the logical choices.\r\n* How should the switch happen? We'll probably want some kind of incremental strategy, since there are quite a few `run-make` tests.\r\n\r\n</details>", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/40713/reactions", "total_count": 5, "+1": 5, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/40713/timeline", "performed_via_github_app": null, "state_reason": null}