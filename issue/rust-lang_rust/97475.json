{"url": "https://api.github.com/repos/rust-lang/rust/issues/97475", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/97475/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/97475/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/97475/events", "html_url": "https://github.com/rust-lang/rust/issues/97475", "id": 1251486843, "node_id": "I_kwDOAAsO6M5KmCx7", "number": 97475, "title": "rustc drops `move`-d function pointer on m1 mac, result in bus error 10 (intel mac works)", "user": {"login": "kdy1", "id": 29931815, "node_id": "MDQ6VXNlcjI5OTMxODE1", "avatar_url": "https://avatars.githubusercontent.com/u/29931815?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kdy1", "html_url": "https://github.com/kdy1", "followers_url": "https://api.github.com/users/kdy1/followers", "following_url": "https://api.github.com/users/kdy1/following{/other_user}", "gists_url": "https://api.github.com/users/kdy1/gists{/gist_id}", "starred_url": "https://api.github.com/users/kdy1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kdy1/subscriptions", "organizations_url": "https://api.github.com/users/kdy1/orgs", "repos_url": "https://api.github.com/users/kdy1/repos", "events_url": "https://api.github.com/users/kdy1/events{/privacy}", "received_events_url": "https://api.github.com/users/kdy1/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2022-05-28T06:00:59Z", "updated_at": "2022-05-28T06:06:46Z", "closed_at": "2022-05-28T06:06:46Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "\r\nI tried this code:\r\n\r\n```rust\r\npub fn new(\r\n        env: &napi::Env,\r\n        f: &JsFunction,\r\n        map_to_js: fn(&Env, I) -> napi::Result<JsUnknown>,\r\n        map_result: fn(&Env, JsUnknown) -> O,\r\n    ) -> napi::Result<Self> {\r\n        Ok(Self {\r\n            f: env.create_threadsafe_function(\r\n                f,\r\n                0,\r\n                move |cx: ThreadSafeCallContext<(I, oneshot::Sender<O>)>| {\r\n                    dbg!(&cx.value.0);\r\n                    let ext = cx\r\n                        .env\r\n                        .create_external(Some(cx.value.1), None)?\r\n                        .into_unknown();\r\n\r\n                    dbg!(&cx.value.0);\r\n\r\n                    // TODO: map_to_js seems like erroring, maybe related to move\r\n\r\n                    let arg = map_to_js(&cx.env, cx.value.0)?.into_unknown();\r\n\r\n                    dbg!(\"after map_to_js\");\r\n                    Ok(vec![arg, ext])\r\n                },\r\n                move |mut cx: ThreadSafeResultContext<Vec<JsUnknown>>| {\r\n                    let sender = unsafe { cx.return_value.remove(1).cast::<JsExternal>() };\r\n                    let unknown = cx.return_value.remove(0);\r\n\r\n                    let output = map_result(&cx.env, unknown);\r\n                    let sender = cx\r\n                        .env\r\n                        .get_value_external::<Option<oneshot::Sender<O>>>(&sender)\r\n                        .unwrap()\r\n                        .take();\r\n                    if let Some(sender) = sender {\r\n                        sender.send(output);\r\n                    }\r\n                },\r\n            )?,\r\n        })\r\n    }\r\n\r\n```\r\n\r\nI expected to see this happen: \r\n\r\n - `dbg!(\"after map_to_js\");` to be executed\r\n\r\n\r\nInstead, this happened: *explanation*\r\n\r\n```\r\n[crates/swcpack_node_interop/src/helper.rs:73] &input = \"files\"\r\n[crates/swcpack_node_interop/src/helper.rs:37] &cx.value.0 = \"files\"\r\n[crates/swcpack_node_interop/src/helper.rs:43] &cx.value.0 = \"files\"\r\n/bin/sh: line 1: 84261 Bus error: 10           RUST_LOG=trace node scripts/swcpack/test.mjs\r\n```\r\n\r\n# Steps to reproduce\r\n\r\nhttps://github.com/kdy1/swc/tree/rustc-error-m1-bus-error\r\n\r\n1. `git clone https://github.com/kdy1/swc.git -b rustc-error-m1-bus-error`\r\n2. `cd ./swc`\r\n3. `yarn`\r\n4. `yarn test-swcpack`\r\n\r\n## m1 mac\r\n\r\n```\r\n[crates/swcpack_node_interop/src/helper.rs:73] &input = \"files\"\r\n[crates/swcpack_node_interop/src/helper.rs:37] &cx.value.0 = \"files\"\r\n[crates/swcpack_node_interop/src/helper.rs:43] &cx.value.0 = \"files\"\r\n/bin/sh: line 1: 84261 Bus error: 10           RUST_LOG=trace node scripts/swcpack/test.mjs\r\n```\r\n\r\n## intel mac\r\n\r\n```\r\n[crates/swcpack_node_interop/src/helper.rs:73] &input = \"files\"\r\n[crates/swcpack_node_interop/src/helper.rs:37] &cx.value.0 = \"files\"\r\n[crates/swcpack_node_interop/src/helper.rs:43] &cx.value.0 = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:84] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:85] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:86] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:87] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:88] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:89] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:90] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:91] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:92] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:93] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:94] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:95] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:98] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:99] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:100] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:101] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:102] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:103] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:104] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:105] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:106] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:107] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:108] &v = \"files\"\r\n[crates/swcpack_node_interop/src/lib.rs:109] &v = \"files\"\r\n[crates/swcpack_node_interop/src/helper.rs:49] \"after map_to_js\" = \"after map_to_js\"\r\nPanic: PanicInfo { payload: Any { .. }, message: Some(convert threadsafe js callback return value error: Error { status: InvalidArg, reason: \"Given napi value is not an array\", maybe_raw: 0x0 }), location: Location { file: \"/Users/kdy1/.cargo/git/checkouts/napi-rs-884773b642dd0d46/c69bf50/crates/napi/src/threadsafe_function.rs\", line: 428, col: 14 }, can_unwind: true }\r\n```\r\n\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.62.0-nightly (90ca44752 2022-04-11)\r\nbinary: rustc\r\ncommit-hash: 90ca44752a79dd414d9a0ccf7a74533a99080988\r\ncommit-date: 2022-04-11\r\nhost: aarch64-apple-darwin\r\nrelease: 1.62.0-nightly\r\nLLVM version: 14.0.0\r\n```\r\n\r\nI have `rust-toolchain` and it's `nightly-2022-04-12`.\r\n\r\n\r\n<details><summary>No backtrace, as it aborts</summary>\r\n<p>\r\n\r\n```\r\n<backtrace>\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n\r\n\r\n", "closed_by": {"login": "kdy1", "id": 29931815, "node_id": "MDQ6VXNlcjI5OTMxODE1", "avatar_url": "https://avatars.githubusercontent.com/u/29931815?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kdy1", "html_url": "https://github.com/kdy1", "followers_url": "https://api.github.com/users/kdy1/followers", "following_url": "https://api.github.com/users/kdy1/following{/other_user}", "gists_url": "https://api.github.com/users/kdy1/gists{/gist_id}", "starred_url": "https://api.github.com/users/kdy1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kdy1/subscriptions", "organizations_url": "https://api.github.com/users/kdy1/orgs", "repos_url": "https://api.github.com/users/kdy1/repos", "events_url": "https://api.github.com/users/kdy1/events{/privacy}", "received_events_url": "https://api.github.com/users/kdy1/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/97475/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/97475/timeline", "performed_via_github_app": null, "state_reason": "not_planned"}