{"url": "https://api.github.com/repos/rust-lang/rust/issues/41244", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/41244/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/41244/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/41244/events", "html_url": "https://github.com/rust-lang/rust/issues/41244", "id": 221165714, "node_id": "MDU6SXNzdWUyMjExNjU3MTQ=", "number": 41244, "title": "internal compiler error: unexpected panic using attributes", "user": {"login": "qorost", "id": 16805801, "node_id": "MDQ6VXNlcjE2ODA1ODAx", "avatar_url": "https://avatars.githubusercontent.com/u/16805801?v=4", "gravatar_id": "", "url": "https://api.github.com/users/qorost", "html_url": "https://github.com/qorost", "followers_url": "https://api.github.com/users/qorost/followers", "following_url": "https://api.github.com/users/qorost/following{/other_user}", "gists_url": "https://api.github.com/users/qorost/gists{/gist_id}", "starred_url": "https://api.github.com/users/qorost/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/qorost/subscriptions", "organizations_url": "https://api.github.com/users/qorost/orgs", "repos_url": "https://api.github.com/users/qorost/repos", "events_url": "https://api.github.com/users/qorost/events{/privacy}", "received_events_url": "https://api.github.com/users/qorost/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-04-12T06:41:31Z", "updated_at": "2022-08-07T20:41:34Z", "closed_at": "2022-08-07T20:41:34Z", "author_association": "NONE", "active_lock_reason": null, "body": "The compiler failed when using a self defined attribute (compiler plugin), the code is as below:\r\n\r\nThe source code to use it\r\n```\r\n#![feature(plugin)]\r\n#![feature(custom_attribute)]\r\n#![plugin(myplugin)]\r\n\r\n#[check]\r\nfn main() {\r\n    let x = hello_AA!();\r\n    println!(\"x.x = {}\",x.x);\r\n}\r\n```\r\n\r\nThe source code of the plugin code (built successfully)\r\n```\r\n#![crate_type = \"dylib\"]\r\n#![feature(plugin_registrar, quote, rustc_private,debug)]\r\n#![feature(box_syntax, rustc_private)]\r\n\r\n#![allow(dead_code)]\r\n#![allow(unused_imports)]\r\nextern crate syntax;\r\n#[macro_use]\r\nextern crate rustc;\r\nextern crate rustc_plugin;\r\nextern crate syntax_pos;\r\n\r\nuse syntax::ast::{self, StructField, Unsafety};\r\nuse syntax::codemap::DUMMY_SP;\r\nuse syntax::ext::base::*;\r\nuse syntax::ext::quote::rt::ToTokens;\r\nuse syntax::parse::{self, token};\r\nuse syntax::ptr::P;\r\nuse syntax::symbol::Symbol;\r\nuse syntax::tokenstream::TokenTree;\r\nuse syntax_pos::Span;\r\nuse rustc_plugin::Registry;\r\n\r\n\r\n//for fold\r\nuse syntax::codemap::{BytePos, Spanned};\r\nuse std::fmt::{self, Display, Formatter};\r\nuse syntax::fold::{self, Folder};\r\nuse syntax::ext::build::AstBuilder;\r\nuse syntax::ast::{BinOpKind, Block, Expr, ExprKind, Item, ItemKind, Lit,\r\n                  LitKind, Mac, MetaItem, MetaItemKind, NestedMetaItemKind,\r\n                  Path, PathSegment, Stmt, StmtKind, UnOp,FnDecl};\r\nuse syntax::util::small_vector::SmallVector;\r\n\r\nstruct Refchecker<'a, 'cx: 'a> {\r\n    cx: &'a mut ExtCtxt<'cx>,\r\n    left: bool, //tell if the expr is in the left of the statment\r\n}\r\n\r\nimpl<'a,'cx> Folder for Refchecker<'a, 'cx> {\r\n}\r\n\r\n#[plugin_registrar]\r\npub fn plugin_registrar(reg: &mut Registry) {\r\n    #[cfg(feature = \"debugmyplugin\")]\r\n    println!(\"DEBUG: IN the plugin_registrar expand_checkderef\");\r\n    reg.register_syntax_extension(\r\n        Symbol::intern(\"check\"),\r\n        // FIXME (#22405): Replace `Box::new` with `box` here when/if possible.\r\n        //MultiModifier(Box::new(expand_newcheckderef)));\r\n        MultiModifier(Box::new(|cx: &mut ExtCtxt, _span: Span, mi: &MetaItem, a: Annotatable| {\r\n           let mut checker = &mut Refchecker {\r\n                cx: cx,\r\n                left: false,\r\n            };\r\n            match a {\r\n                Annotatable::Item(i) => Annotatable::Item (\r\n                    checker.fold_item(i).expect_one(\"expected exactly one item\")),\r\n                Annotatable::TraitItem(i) => Annotatable::TraitItem (\r\n                    i.map(|i| checker.fold_trait_item(i).expect_one(\"expected exactly one item\"))),\r\n                Annotatable::ImplItem(i) => Annotatable::ImplItem(\r\n                    i.map(|i| checker.fold_impl_item(i).expect_one(\"expected exactly one item\"))),\r\n            }\r\n        })));\r\n}\r\n```\r\n\r\nThe error mesage:\r\n```\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nthread 'rustc' panicked at 'fold_mac disabled by default', /checkout/src/libsyntax/fold.rs:180\r\nnote: Run with `RUST_BACKTRACE=1` for a backtrace.\r\n```\r\n\r\nbacktrace\r\n```\r\nthread 'rustc' panicked at 'fold_mac disabled by default', /checkout/src/libsyntax/fold.rs:180\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\nstack backtrace:\r\n   0: syntax::fold::Folder::fold_mac\r\n             at ./<panic macros>:3\r\n   1: syntax::fold::noop_fold_expr\r\n             at /checkout/src/libsyntax/fold.rs:1256\r\n   2: syntax::fold::Folder::fold_expr::{{closure}}\r\n             at /checkout/src/libsyntax/fold.rs:112\r\n   3: <syntax::ptr::P<T>>::map\r\n             at /checkout/src/libsyntax/ptr.rs:88\r\n   4: syntax::fold::Folder::fold_expr\r\n             at /checkout/src/libsyntax/fold.rs:112\r\n   5: syntax::fold::noop_fold_local::{{closure}}::{{closure}}\r\n             at /checkout/src/libsyntax/fold.rs:482\r\n   6: <core::option::Option<T>>::map\r\n             at /checkout/src/libcore/option.rs:392\r\n   7: syntax::fold::noop_fold_local::{{closure}}\r\n             at /checkout/src/libsyntax/fold.rs:482\r\n   8: <syntax::ptr::P<T>>::map\r\n             at /checkout/src/libsyntax/ptr.rs:88\r\n   9: syntax::fold::noop_fold_local\r\n             at /checkout/src/libsyntax/fold.rs:478\r\n  10: syntax::fold::Folder::fold_local\r\n             at /checkout/src/libsyntax/fold.rs:176\r\n  11: syntax::fold::noop_fold_stmt_kind\r\n             at /checkout/src/libsyntax/fold.rs:1299\r\n  12: syntax::fold::noop_fold_stmt\r\n             at /checkout/src/libsyntax/fold.rs:1292\r\n  13: syntax::fold::Folder::fold_stmt\r\n             at /checkout/src/libsyntax/fold.rs:100\r\n  14: syntax::fold::noop_fold_block::{{closure}}::{{closure}}\r\n             at /checkout/src/libsyntax/fold.rs:844\r\n  15: <collections::vec::Vec<T> as syntax::util::move_map::MoveMap<T>>::move_flat_map\r\n             at /checkout/src/libsyntax/util/move_map.rs:40\r\n  16: syntax::fold::noop_fold_block::{{closure}}\r\n             at /checkout/src/libsyntax/fold.rs:844\r\n  17: <syntax::ptr::P<T>>::map\r\n             at /checkout/src/libsyntax/ptr.rs:88\r\n  18: syntax::fold::noop_fold_block\r\n             at /checkout/src/libsyntax/fold.rs:842\r\n  19: syntax::fold::Folder::fold_block\r\n             at /checkout/src/libsyntax/fold.rs:96\r\n  20: syntax::fold::noop_fold_item_kind\r\n             at /checkout/src/libsyntax/fold.rs:865\r\n  21: syntax::fold::Folder::fold_item_kind\r\n             at /checkout/src/libsyntax/fold.rs:80\r\n  22: syntax::fold::noop_fold_item_simple\r\n             at /checkout/src/libsyntax/fold.rs:1013\r\n  23: syntax::fold::Folder::fold_item_simple\r\n             at /checkout/src/libsyntax/fold.rs:72\r\n  24: syntax::fold::noop_fold_item::{{closure}}\r\n             at /checkout/src/libsyntax/fold.rs:1002\r\n  25: <syntax::ptr::P<T>>::map\r\n             at /checkout/src/libsyntax/ptr.rs:88\r\n  26: syntax::fold::noop_fold_item\r\n             at /checkout/src/libsyntax/fold.rs:1002\r\n  27: syntax::fold::Folder::fold_item\r\n             at /checkout/src/libsyntax/fold.rs:68\r\n  28: myplugin::plugin_registrar::{{closure}}\r\n             at ./myplugin/src/lib.rs:83\r\n  29: <F as syntax::ext::base::MultiItemModifier>::expand\r\n             at /checkout/src/libsyntax/ext/base.rs:143\r\n  30: syntax::ext::expand::MacroExpander::expand_invoc\r\n  31: syntax::ext::expand::MacroExpander::expand\r\n  32: syntax::ext::expand::MacroExpander::expand_crate\r\n  33: rustc_driver::driver::phase_2_configure_and_expand::{{closure}}\r\n  34: rustc_driver::driver::phase_2_configure_and_expand\r\n  35: rustc_driver::driver::compile_input\r\n  36: rustc_driver::run_compiler\r\n  37: std::panicking::try::do_call\r\n  38: __rust_maybe_catch_panic\r\n             at /checkout/src/libpanic_unwind/lib.rs:98\r\n  39: <F as alloc::boxed::FnBox<A>>::call_box\r\n  40: std::sys::imp::thread::Thread::new::thread_start\r\n             at /checkout/src/liballoc/boxed.rs:650\r\n             at /checkout/src/libstd/sys_common/thread.rs:21\r\n             at /checkout/src/libstd/sys/unix/thread.rs:84\r\n  41: start_thread\r\n  42: clone\r\n\r\nerror: Could not compile `macro_compiler_conflicts`.\r\n```\r\n\r\nRunning on:\r\nrustc 1.18.0-nightly (c58c928e6 2017-04-11)\r\n\r\nSystem\r\n```\r\nNo LSB modules are available.\r\nDistributor ID:\tUbuntu\r\nDescription:\tUbuntu 16.04.2 LTS\r\nRelease:\t16.04\r\nCodename:\txenial\r\n```\r\n", "closed_by": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/41244/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/41244/timeline", "performed_via_github_app": null, "state_reason": "completed"}