{"url": "https://api.github.com/repos/rust-lang/rust/issues/44471", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/44471/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/44471/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/44471/events", "html_url": "https://github.com/rust-lang/rust/issues/44471", "id": 256472360, "node_id": "MDU6SXNzdWUyNTY0NzIzNjA=", "number": 44471, "title": "Possible codegen bug leading to segfaults introduced in 1.20.0", "user": {"login": "dennis-hamester", "id": 2039492, "node_id": "MDQ6VXNlcjIwMzk0OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/2039492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dennis-hamester", "html_url": "https://github.com/dennis-hamester", "followers_url": "https://api.github.com/users/dennis-hamester/followers", "following_url": "https://api.github.com/users/dennis-hamester/following{/other_user}", "gists_url": "https://api.github.com/users/dennis-hamester/gists{/gist_id}", "starred_url": "https://api.github.com/users/dennis-hamester/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dennis-hamester/subscriptions", "organizations_url": "https://api.github.com/users/dennis-hamester/orgs", "repos_url": "https://api.github.com/users/dennis-hamester/repos", "events_url": "https://api.github.com/users/dennis-hamester/events{/privacy}", "received_events_url": "https://api.github.com/users/dennis-hamester/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2017-09-09T23:14:42Z", "updated_at": "2017-09-10T00:29:08Z", "closed_at": "2017-09-10T00:29:08Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The following program works fine with `rustc 1.19.0 (0ade33941 2017-07-17)` but segfaults with `rustc 1.20.0 (f3d6973f4 2017-08-27)` if compiled with optimizations and debug symbols (`rustc -g -O`). I have tested this only on Linux x86_64. The current master branch (as of commit 18366f4e8aaec1d46282cf0a6e0fe1a0ab202530) is still affected.\r\n\r\n```rust\r\n// Compile with: rustc -g -O\r\n// Without -g, the program panics instead in\r\n// std::sys_common::thread_info::set\r\n\r\nstruct A {\r\n    a1: unsafe extern fn(),\r\n    a2: (),\r\n}\r\n\r\nimpl A {\r\n    fn new() -> Self {\r\n        A {\r\n            a1: unsafe { ::std::mem::transmute(0usize) },\r\n            a2: (),\r\n        }\r\n    }\r\n}\r\n\r\nfn main() {\r\n    A::new();\r\n}\r\n```\r\n\r\nThe segfault happens in `core::mem::zeroed::<libc::unix::notbsd::linux::other::b64::x86_64::pthread_attr_t>()`. At least, that's the last stack frame.\r\n\r\nA bisect leads to ecf62e4cdcbe9fe59e2e1280739d15953cc0e500 as the first bad commit. I further bisected llvm to the commit rust-lang/llvm@7d1c3d4881647e53d0e317e21f3b31349120062f which was introduced in the merge commit rust-lang/llvm@a5ef0696d7c103006d3cb1f4263bad0ca13adca8.\r\n\r\nReverting all commits of that merge (rust-lang/llvm@a5ef0696d7c103006d3cb1f4263bad0ca13adca8) on the rust master branch fixes the problems.\r\n\r\nI think this is some kind of codegen bug in llvm. Unfortunately, I'm not at all familiar with the llvm codebase (or rust's codebase for that matter) to understand what's causing this. The generated code for the snippet above seems to be correct with and without rust-lang/llvm@a5ef0696d7c103006d3cb1f4263bad0ca13adca8. I haven't looked at the code generated for `libcore` yet.", "closed_by": {"login": "dennis-hamester", "id": 2039492, "node_id": "MDQ6VXNlcjIwMzk0OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/2039492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dennis-hamester", "html_url": "https://github.com/dennis-hamester", "followers_url": "https://api.github.com/users/dennis-hamester/followers", "following_url": "https://api.github.com/users/dennis-hamester/following{/other_user}", "gists_url": "https://api.github.com/users/dennis-hamester/gists{/gist_id}", "starred_url": "https://api.github.com/users/dennis-hamester/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dennis-hamester/subscriptions", "organizations_url": "https://api.github.com/users/dennis-hamester/orgs", "repos_url": "https://api.github.com/users/dennis-hamester/repos", "events_url": "https://api.github.com/users/dennis-hamester/events{/privacy}", "received_events_url": "https://api.github.com/users/dennis-hamester/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/44471/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/44471/timeline", "performed_via_github_app": null, "state_reason": "completed"}