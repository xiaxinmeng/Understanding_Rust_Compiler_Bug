{"url": "https://api.github.com/repos/rust-lang/rust/issues/92511", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/92511/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/92511/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/92511/events", "html_url": "https://github.com/rust-lang/rust/issues/92511", "id": 1092265012, "node_id": "I_kwDOAAsO6M5BGqQ0", "number": 92511, "title": "Array copy const fn is surprisingly slow", "user": {"login": "nico-abram", "id": 24706838, "node_id": "MDQ6VXNlcjI0NzA2ODM4", "avatar_url": "https://avatars.githubusercontent.com/u/24706838?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nico-abram", "html_url": "https://github.com/nico-abram", "followers_url": "https://api.github.com/users/nico-abram/followers", "following_url": "https://api.github.com/users/nico-abram/following{/other_user}", "gists_url": "https://api.github.com/users/nico-abram/gists{/gist_id}", "starred_url": "https://api.github.com/users/nico-abram/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nico-abram/subscriptions", "organizations_url": "https://api.github.com/users/nico-abram/orgs", "repos_url": "https://api.github.com/users/nico-abram/repos", "events_url": "https://api.github.com/users/nico-abram/events{/privacy}", "received_events_url": "https://api.github.com/users/nico-abram/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 3425147156, "node_id": "LA_kwDOAAsO6M7MJ5kU", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-array", "name": "A-array", "color": "f7e101", "default": false, "description": "Area: [T; N]"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2022-01-03T06:46:35Z", "updated_at": "2023-03-07T05:29:42Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The following program is surprisingly slow, taking over 10 seconds to compile on my machine, even with `-Zmir-opt-level=3`\r\n```rs\r\n#![feature(const_eval_limit)]\r\n#![const_eval_limit = \"10000000\"]\r\nfn main() {\r\n    const MB: usize = 1024 * 1024;\r\n    const L: usize = MB;\r\n    const DATA: [u8; L] = [3; L];\r\n    const TEST: [u8; L] = test(&DATA);\r\n\r\n    const fn test(data: &[u8]) -> [u8; L] {\r\n        let mut ret = [0u8; L];\r\n        let mut i = 0;\r\n        loop {\r\n            if i >= data.len() {\r\n                break;\r\n            }\r\n            ret[i] = data[i];\r\n            i = i + 1;\r\n        }\r\n        ret\r\n    }\r\n    println!(\"{}\", TEST[1024]);\r\n}\r\n```\r\n\r\nI wrote a const fn bmp parser and when I tried using it on a 6mb 1080x1920 image it made cargo check take 10+ minutes, and it is mostly copying an array element by element. I wrote this small sample for which I think the problem is basically the same. The full thing is here if anyone wants to look at it https://gist.github.com/nico-abram/21087e54d21883fd2d72eeee55675d6a\r\n\r\nThe following version using `ptr::copy_nonoverlapping` is *much* faster, taking under 2 seconds on my machine for a 7 MiB array.\r\n```rs\r\n#![feature(const_mut_refs)]\r\n#![feature(const_intrinsic_copy)]\r\nfn main() {\r\n    const MB: usize = 1024 * 1024;\r\n    const L: usize = 7 * MB;\r\n    const DATA: [u8; L] = [3; L];\r\n    const TEST: [u8; L] = test(&DATA);\r\n\r\n    const fn test(data: &[u8]) -> [u8; L] {\r\n        let mut ret = [0u8; L];\r\n        unsafe { std::ptr::copy_nonoverlapping(data.as_ptr(), &mut ret as *mut _, data.len()) };\r\n        ret\r\n    }\r\n    println!(\"{}\", TEST[1024]);\r\n}\r\n```\r\n\r\nnightly version used: rustc 1.59.0-nightly (f8abed9ed 2021-12-26)", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/92511/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/92511/timeline", "performed_via_github_app": null, "state_reason": null}