{"url": "https://api.github.com/repos/rust-lang/rust/issues/71504", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/71504/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/71504/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/71504/events", "html_url": "https://github.com/rust-lang/rust/issues/71504", "id": 606204328, "node_id": "MDU6SXNzdWU2MDYyMDQzMjg=", "number": 71504, "title": "rust-analyser segfault with lto=thin, linker=lld-link", "user": {"login": "Speedy37", "id": 5376197, "node_id": "MDQ6VXNlcjUzNzYxOTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5376197?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Speedy37", "html_url": "https://github.com/Speedy37", "followers_url": "https://api.github.com/users/Speedy37/followers", "following_url": "https://api.github.com/users/Speedy37/following{/other_user}", "gists_url": "https://api.github.com/users/Speedy37/gists{/gist_id}", "starred_url": "https://api.github.com/users/Speedy37/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Speedy37/subscriptions", "organizations_url": "https://api.github.com/users/Speedy37/orgs", "repos_url": "https://api.github.com/users/Speedy37/repos", "events_url": "https://api.github.com/users/Speedy37/events{/privacy}", "received_events_url": "https://api.github.com/users/Speedy37/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 203429200, "node_id": "MDU6TGFiZWwyMDM0MjkyMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-high", "name": "P-high", "color": "eb6420", "default": false, "description": "High priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1359848690, "node_id": "MDU6TGFiZWwxMzU5ODQ4Njkw", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-mcve", "name": "E-needs-mcve", "color": "02e10c", "default": false, "description": "Call for participation: This issue needs a Minimal Complete and Verifiable Example"}, {"id": 1568663381, "node_id": "MDU6TGFiZWwxNTY4NjYzMzgx", "url": "https://api.github.com/repos/rust-lang/rust/labels/ICEBreaker-LLVM", "name": "ICEBreaker-LLVM", "color": "74cc28", "default": false, "description": "Bugs identified for the LLVM ICE-breaker group"}, {"id": 1791937891, "node_id": "MDU6TGFiZWwxNzkxOTM3ODkx", "url": "https://api.github.com/repos/rust-lang/rust/labels/ICEBreaker-Cleanup-Crew", "name": "ICEBreaker-Cleanup-Crew", "color": "74cc28", "default": false, "description": "Helping to \"clean up\" bugs with minimal examples and bisections"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 23, "created_at": "2020-04-24T10:16:57Z", "updated_at": "2020-11-26T22:27:32Z", "closed_at": "2020-11-26T12:49:57Z", "author_association": "NONE", "active_lock_reason": null, "body": "I was having fun compiling rust-analyser for maximizing performance on my machine.\r\n\r\nCompiling commit ec645f2d75d2939a2f64959019dd916750f1ec00 of rust-analyser with lto=fat seems to work as expected.\r\n\r\nBut this configuration on windows:\r\n\r\n```toml\r\n[profile.release]\r\nlto = \"thin\"\r\n#incremental = true\r\ndebug = 0 # set this to 1 or 2 to get more useful backtraces in debugger\r\n```\r\n\r\nResult in rust-analyser segfaut:\r\n\r\n```\r\nAccess violation executing location 0x0000000100785A4D.\r\n```\r\n\r\n### Meta\r\n\r\n```\r\nrustc 1.43.0 (4fb7144ed 2020-04-20)\r\nbinary: rustc\r\ncommit-hash: 4fb7144ed159f94491249e86d5bbd033b5d60550\r\ncommit-date: 2020-04-20\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.43.0\r\nLLVM version: 9.0\r\n```\r\n\r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```\r\n>\trust-analyzer.exe!_ZN7globset8pathutil9file_name17h08d0f1900ad67247E\u001e()\tUnknown\tNon-user code. Symbols loaded.\r\n \trust-analyzer.exe!_ZN7globset7GlobSet8is_match17hf1cf9a1f69ce8dd2E\u001e()\tUnknown\tNon-user code. Symbols loaded.\r\n \trust-analyzer.exe!_ZN77_$LT$rust_analyzer..vfs_glob..RustPackageFilter$u20$as$u20$ra_vfs..Filter$GT$11include_dir17ha6495721bf18fe0eE\u001e()\tUnknown\tNon-user code. Symbols loaded.\r\n \trust-analyzer.exe!_ZN6ra_vfs5roots16to_relative_path17hb9707874d497bdc4E\u001e()\tUnknown\tNon-user code. Symbols loaded.\r\n \trust-analyzer.exe!_ZN106_$LT$core..iter..adapters..chain..Chain$LT$A$C$B$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$8try_fold17hac44483bd652ee40E\u001e()\tUnknown\tNon-user code. Symbols loaded.\r\n \trust-analyzer.exe!_ZN108_$LT$walkdir..FilterEntry$LT$walkdir..IntoIter$C$P$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$4next17ha136f9b20c380477E\u001e()\tUnknown\tNon-user code. Symbols loaded.\r\n \trust-analyzer.exe!_ZN6ra_vfs2io13handle_change17h8a81e482afc2c09bE\u001e()\tUnknown\tNon-user code. Symbols loaded.\r\n \trust-analyzer.exe!_ZN6ra_vfs2io10watch_root17h425c73dcf2ce2dd1E\u001e()\tUnknown\tNon-user code. Symbols loaded.\r\n \trust-analyzer.exe!_ZN3std10sys_common9backtrace28__rust_begin_short_backtrace17hb0fd61dddb6f5a20E.llvm.14564221459209632736\u001e()\tUnknown\tNon-user code. Symbols loaded.\r\n \trust-analyzer.exe!_ZN4core3mem4drop17hab46961f8567a42bE.llvm.1531302937598756963\u001e()\tUnknown\tNon-user code. Symbols loaded.\r\n \trust-analyzer.exe!alloc::boxed::{{impl}}::call_once<(),FnOnce<()>>() Line 1017\tUnknown\tSymbols loaded.\r\n \t[Inline Frame] rust-analyzer.exe!alloc::boxed::{{impl}}::call_once() Line 1017\tUnknown\tSymbols loaded.\r\n \t[Inline Frame] rust-analyzer.exe!std::sys_common::thread::start_thread() Line 13\tUnknown\tSymbols loaded.\r\n \trust-analyzer.exe!std::sys::windows::thread::{{impl}}::new::thread_start() Line 51\tUnknown\tSymbols loaded.\r\n\r\n```\r\n</p>\r\n</details>\r\n\r\n\r\n<details><summary>Frame 0 Assembly</summary>\r\n<p>\r\n\r\n```\r\n_ZN7globset8pathutil9file_name17h08d0f1900ad67247E:\r\n00007FF66A5D76B0  push        rbp  \r\n00007FF66A5D76B1  push        r15  \r\n00007FF66A5D76B3  push        r14  \r\n00007FF66A5D76B5  push        r12  \r\n00007FF66A5D76B7  push        rsi  \r\n00007FF66A5D76B8  push        rdi  \r\n00007FF66A5D76B9  push        rbx  \r\n00007FF66A5D76BA  sub         rsp,60h  \r\n00007FF66A5D76BE  lea         rbp,[rsp+60h]  \r\n00007FF66A5D76C3  mov         qword ptr [rbp-8],0FFFFFFFFFFFFFFFEh  \r\n00007FF66A5D76CB  mov         r12,rcx  \r\n00007FF66A5D76CE  mov         rsi,qword ptr [rdx]  \r\n00007FF66A5D76D1  mov         rdi,qword ptr [rdx+10h]  \r\n00007FF66A5D76D5  cmp         rsi,1  \r\n00007FF66A5D76D9  mov         rbx,qword ptr [rdx+18h]  \r\n00007FF66A5D76DD  mov         r8,rdi  \r\n00007FF66A5D76E0  cmove       r8,rbx  \r\n00007FF66A5D76E4  test        r8,r8  \r\n00007FF66A5D76E7  je          _ZN7globset8pathutil9file_name17h08d0f1900ad67247E+45h (07FF66A5D76F5h)  \r\n00007FF66A5D76E9  mov         r15,qword ptr [rdx+8]  \r\n00007FF66A5D76ED  cmp         byte ptr [r8+r15-1],2Eh  \r\n00007FF66A5D76F3  jne         _ZN7globset8pathutil9file_name17h08d0f1900ad67247E+52h (07FF66A5D7702h)  \r\n00007FF66A5D76F5  mov         qword ptr [r12],2  \r\n00007FF66A5D76FD  jmp         _ZN7globset8pathutil9file_name17h08d0f1900ad67247E+14Fh (07FF66A5D77FFh)  \r\n00007FF66A5D7702  mov         rax,qword ptr [__imp__ZN6memchr3x867memrchr2FN17h7699f2e42a7ae581E (07FF66BBC73B0h)]  \r\n00007FF66A5D7709  mov         rax,qword ptr [rax]  \r\n00007FF66A5D770C  mov         cl,2Fh  \r\n00007FF66A5D770E  mov         rdx,r15  \r\n00007FF66A5D7711  call        rax <<< rax is garbage\r\n00007FF66A5D7713  mov         r14,rdx  \r\n00007FF66A5D7716  add         r14,1  \r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n\r\n<details><summary>Frame 0 Registers</summary>\r\n<p>\r\n\r\n```\r\nRBX\u00a0=\u00a000000238EB8D2FE0\r\nRSI\u00a0=\u00a00000000000000000\r\nRDI\u00a0=\u00a00000000000000005\r\nR12\u00a0=\u00a0000000C631DFE620 \r\nR13\u00a0=\u00a0000000C631DFE790\r\nR14\u00a0=\u00a00000000000000008\r\nR15\u00a0=\u00a000000238EB8D2FE0\r\nRIP\u00a0=\u00a000007FF66A5D7713\r\nRSP\u00a0=\u00a0000000C631DFE540 \r\nRBP\u00a0=\u00a0000000C631DFE5A0 \r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n\r\nSo this function seams to be miss compiled:\r\n\r\nhttps://github.com/BurntSushi/ripgrep/blob/a2e6aec7a4d9382941932245e8854f0ae5703a5e/crates/globset/src/pathutil.rs#L9\r\n\r\n```rust\r\npub fn file_name<'a>(path: &Cow<'a, [u8]>) -> Option<Cow<'a, [u8]>> {\r\n    if path.is_empty() {\r\n        return None;\r\n    } else if path.last_byte() == Some(b'.') {\r\n        return None;\r\n    }\r\n    let last_slash = path.rfind_byte(b'/').map(|i| i + 1).unwrap_or(0);\r\n    Some(match *path {\r\n        Cow::Borrowed(path) => Cow::Borrowed(&path[last_slash..]),\r\n        Cow::Owned(ref path) => {\r\n            let mut path = path.clone();\r\n            path.drain_bytes(..last_slash);\r\n            Cow::Owned(path)\r\n        }\r\n    })\r\n}\r\n```\r\n\r\nIn particular this line:\r\n\r\n```rust\r\nlet last_slash = path.rfind_byte(b'/').map(|i| i + 1).unwrap_or(0);\r\n```\r\n\r\n```\r\n00007FF66A5D7702  mov         rax,qword ptr [__imp__ZN6memchr3x867memrchr2FN17h7699f2e42a7ae581E (07FF66BBC73B0h)]  \r\n00007FF66A5D7709  mov         rax,qword ptr [rax]\r\n00007FF66A5D770C  mov         cl,2Fh  \r\n00007FF66A5D770E  mov         rdx,r15  \r\n00007FF66A5D7711  call        rax <<< rax is garbage\r\n```", "closed_by": {"login": "Gankra", "id": 1136864, "node_id": "MDQ6VXNlcjExMzY4NjQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Gankra", "html_url": "https://github.com/Gankra", "followers_url": "https://api.github.com/users/Gankra/followers", "following_url": "https://api.github.com/users/Gankra/following{/other_user}", "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}", "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions", "organizations_url": "https://api.github.com/users/Gankra/orgs", "repos_url": "https://api.github.com/users/Gankra/repos", "events_url": "https://api.github.com/users/Gankra/events{/privacy}", "received_events_url": "https://api.github.com/users/Gankra/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/71504/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/71504/timeline", "performed_via_github_app": null, "state_reason": "completed"}