{"url": "https://api.github.com/repos/rust-lang/rust/issues/99886", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/99886/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/99886/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/99886/events", "html_url": "https://github.com/rust-lang/rust/issues/99886", "id": 1321747525, "node_id": "I_kwDOAAsO6M5OyERF", "number": 99886, "title": "segfault when compiling with address sanitizer and debug variable locations", "user": {"login": "mikebenfield", "id": 543755, "node_id": "MDQ6VXNlcjU0Mzc1NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/543755?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mikebenfield", "html_url": "https://github.com/mikebenfield", "followers_url": "https://api.github.com/users/mikebenfield/followers", "following_url": "https://api.github.com/users/mikebenfield/following{/other_user}", "gists_url": "https://api.github.com/users/mikebenfield/gists{/gist_id}", "starred_url": "https://api.github.com/users/mikebenfield/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mikebenfield/subscriptions", "organizations_url": "https://api.github.com/users/mikebenfield/orgs", "repos_url": "https://api.github.com/users/mikebenfield/repos", "events_url": "https://api.github.com/users/mikebenfield/events{/privacy}", "received_events_url": "https://api.github.com/users/mikebenfield/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2022-07-29T04:32:43Z", "updated_at": "2022-08-06T21:58:30Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "In the crate `rustc-demangle-capi` version 0.1.0\r\n(`wget https://crates.io.api/v1/crates/rustc-demangle-capi/0.1.0/download`)\r\n\r\nI do this\r\n\r\n```\r\n$ RUSTFLAGS=\"-Cpasses=sancov-module -Cllvm-args=-sanitizer-coverage-level=4 -Cllvm-args=-sanitizer-coverage-inline-8bit-counters -Cllvm-args=-sanitizer-coverage-trace-compares -Cllvm-args=-sanitizer-coverage-pc-table -Cllvm-args=-sanitizer-coverage-trace-divs -Cllvm-args=-sanitizer-coverage-trace-geps -Cllvm-args=-sanitizer-coverage-prune-blocks=0 -Clink-arg=-Wl,--no-gc-sections -Cdebuginfo=2  -Zsanitizer=address -Copt-level=3 -Cllvm-args=-experimental-debug-variable-locations=1\" cargo build\r\n```\r\n\r\nI get a segfault:\r\n```\r\nerror: could not compile `rustc-demangle`\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name rustc_demangle /usr/local/google/home/mbenfield/.cargo/registry/src/github.com-1ecc6299db9ec823/rustc-demangle-0.1.21/src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts,future-incompat --crate-type lib --emit=dep-info,metadata,link -C embed-bitcode=no -C debuginfo=2 -C metadata=5d383c335f8e8ef8 -C extra-filename=-5d383c335f8e8ef8 --out-dir /usr/local/google/home/mbenfield/Current/rust-segfault/rustc-demangle-capi-0.1.0/target/debug/deps -L dependency=/usr/local/google/home/mbenfield/Current/rust-segfault/rustc-demangle-capi-0.1.0/target/debug/deps --cap-lints allow -Cpasses=sancov-module -Cllvm-args=-sanitizer-coverage-level=4 -Cllvm-args=-sanitizer-coverage-inline-8bit-counters -Cllvm-args=-sanitizer-coverage-trace-compares -Cllvm-args=-sanitizer-coverage-pc-table -Cllvm-args=-sanitizer-coverage-trace-divs -Cllvm-args=-sanitizer-coverage-trace-geps -Cllvm-args=-sanitizer-coverage-prune-blocks=0 -Clink-arg=-Wl,--no-gc-sections -Cdebuginfo=2 -Zsanitizer=address -Zallow-features=sanitizer,backtrace -Copt-level=3 -Cllvm-args=-experimental-debug-variable-locations=1` (signal: 11, SIGSEGV: invalid memory reference)\r\n  ```\r\n\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.64.0-nightly (38b72154d 2022-07-11)\r\nbinary: rustc\r\ncommit-hash: 38b72154ded23847cd08a796d0c6708b5efac265\r\ncommit-date: 2022-07-11\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.64.0-nightly\r\nLLVM version: 14.0.6\r\n```\r\n\r\nNote that `-experimental-debug-variable-locations=1` is now the default on x86-64 (since [this LLVM commit](https://reviews.llvm.org/rG6e03a68b776dc06826dacbdab26d24a90bb2173b), which is in Rust's LLVM repo since around 1.61), so that option doesn't actually have to be present. If we turn it off with `-Cllvm-args=-experimental-debug-variable-locations=0` no segfault happens.\r\n\r\nI suppose this is likely actually an LLVM problem, but I only have an illustration of the bug in Rust code. \r\n\r\nI have another crate which also causes `rustc` to segfault when using the same options, but it's a big thing with lots of dependencies, so I'm illustrating the problem with `rustc-demangle-capi`. ", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/99886/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/99886/timeline", "performed_via_github_app": null, "state_reason": null}