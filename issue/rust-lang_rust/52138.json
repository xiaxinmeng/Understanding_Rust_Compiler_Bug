{"url": "https://api.github.com/repos/rust-lang/rust/issues/52138", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/52138/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/52138/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/52138/events", "html_url": "https://github.com/rust-lang/rust/issues/52138", "id": 339164705, "node_id": "MDU6SXNzdWUzMzkxNjQ3MDU=", "number": 52138, "title": "Unloading Rust-made SOs can lead to segfaults in host program", "user": {"login": "SoniEx2", "id": 1779619, "node_id": "MDQ6VXNlcjE3Nzk2MTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1779619?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SoniEx2", "html_url": "https://github.com/SoniEx2", "followers_url": "https://api.github.com/users/SoniEx2/followers", "following_url": "https://api.github.com/users/SoniEx2/following{/other_user}", "gists_url": "https://api.github.com/users/SoniEx2/gists{/gist_id}", "starred_url": "https://api.github.com/users/SoniEx2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SoniEx2/subscriptions", "organizations_url": "https://api.github.com/users/SoniEx2/orgs", "repos_url": "https://api.github.com/users/SoniEx2/repos", "events_url": "https://api.github.com/users/SoniEx2/events{/privacy}", "received_events_url": "https://api.github.com/users/SoniEx2/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 12, "created_at": "2018-07-07T18:10:44Z", "updated_at": "2018-10-28T16:48:24Z", "closed_at": "2018-10-28T16:48:24Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Steps to reproduce:\r\n\r\n1. Have two versions of `libplugin_written_in_rust.so` (rust always adds that \"lib\" prefix for some reason)\r\n2. Load one of them\r\n3. Unload it\r\n4. Load the other\r\n5. ???\r\n6. Segfault\r\n\r\nI don't seem to get the crashes if I have two different plugins under different names.\r\n\r\nThis is an issue for the `hexchat-plugin` crate, and (probably) anything that lets you write plugins in Rust. (rlua? I haven't entirely tested this)\r\n\r\n(No, this isn't an issue with hexchat's module system. Hexchat's module system is basically just dlopen and dlclose, at least on Linux.)\r\n\r\n(No, this shouldn't be dismissed as \"unsafe and dangerous\"/\"unsupported\", because if you have heap-allocated globals in your rust code, all you're gonna get is some memory/resource leaks, which aren't considered unsafe. This really shouldn't be segfaulting.)\r\n\r\n```\r\n$ rustc --version --verbose\r\nrustc 1.27.0\r\nbinary: rustc\r\ncommit-hash: unknown\r\ncommit-date: unknown\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.27.0\r\nLLVM version: 6.0\r\n```\r\n\r\n(Note: this has been a thing for a while, it's not new in 1.27.0.)\r\n\r\nOther (important?) things to note:\r\n\r\n- Only happens if code is changed. Changing strings doesn't seem to trigger the issue (or I was just very (un)lucky). (but maybe optimizations can have an effect, for example dead code elimination based on a constant?)\r\n- Happens in both debug and release builds.", "closed_by": {"login": "SoniEx2", "id": 1779619, "node_id": "MDQ6VXNlcjE3Nzk2MTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1779619?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SoniEx2", "html_url": "https://github.com/SoniEx2", "followers_url": "https://api.github.com/users/SoniEx2/followers", "following_url": "https://api.github.com/users/SoniEx2/following{/other_user}", "gists_url": "https://api.github.com/users/SoniEx2/gists{/gist_id}", "starred_url": "https://api.github.com/users/SoniEx2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SoniEx2/subscriptions", "organizations_url": "https://api.github.com/users/SoniEx2/orgs", "repos_url": "https://api.github.com/users/SoniEx2/repos", "events_url": "https://api.github.com/users/SoniEx2/events{/privacy}", "received_events_url": "https://api.github.com/users/SoniEx2/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/52138/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/52138/timeline", "performed_via_github_app": null, "state_reason": "completed"}