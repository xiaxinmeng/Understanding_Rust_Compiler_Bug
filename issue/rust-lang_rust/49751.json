{"url": "https://api.github.com/repos/rust-lang/rust/issues/49751", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/49751/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/49751/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/49751/events", "html_url": "https://github.com/rust-lang/rust/issues/49751", "id": 312164653, "node_id": "MDU6SXNzdWUzMTIxNjQ2NTM=", "number": 49751, "title": "In 1.25.0, running the rustc tests on a ryzen gets invalid opcodes and eventual reboot", "user": {"login": "zarniwhoop73", "id": 8324892, "node_id": "MDQ6VXNlcjgzMjQ4OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/8324892?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zarniwhoop73", "html_url": "https://github.com/zarniwhoop73", "followers_url": "https://api.github.com/users/zarniwhoop73/followers", "following_url": "https://api.github.com/users/zarniwhoop73/following{/other_user}", "gists_url": "https://api.github.com/users/zarniwhoop73/gists{/gist_id}", "starred_url": "https://api.github.com/users/zarniwhoop73/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zarniwhoop73/subscriptions", "organizations_url": "https://api.github.com/users/zarniwhoop73/orgs", "repos_url": "https://api.github.com/users/zarniwhoop73/repos", "events_url": "https://api.github.com/users/zarniwhoop73/events{/privacy}", "received_events_url": "https://api.github.com/users/zarniwhoop73/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 120005, "node_id": "MDU6TGFiZWwxMjAwMDU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-testsuite", "name": "A-testsuite", "color": "f7e101", "default": false, "description": "Area: The testsuite used to check the correctness of rustc"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 23, "created_at": "2018-04-07T02:53:38Z", "updated_at": "2019-01-23T22:00:44Z", "closed_at": "2019-01-23T10:52:32Z", "author_association": "NONE", "active_lock_reason": null, "body": "I build from source, and I 'm now using a Ryzen 1300X. Before I got that I had stopped running the tests in rustc because they take so long and the results were known. But I'd been using 1.22.1 and for firefox-60 I'll need something newer, so I built 1.25.0. In fact I built it several times, and installed in /opt (I had had weird scripting issues with 1.23 which I never got to the bottom of, but 1.24 on another machine seemed fine). Then I used that to build ff-59.0.2, which I am now running, and a couple of test builds of ff-60b9 with different settings.\r\n\r\nEverything looked good, so I decided to install in /usr and to run the tests before installing. This is with the shipped llvm, I built the basic system a week before 6.0 was released. But when I came back to the machine after running the tests, it had rebooted. In my syslog was\r\n\r\n``Apr  6 04:44:05 origin kernel: [32318.734501] traps: backtrace.stage[3292] trap invalid opcode ip:7f770d540498 sp:7fff8a04b2f0 error:0 in libstd-23815cc482a70678.so[7f770d4e6000+155000]\r\nApr  6 04:44:05 origin kernel: [32318.761267] traps: backtrace.stage[3305] trap invalid opcode ip:7f2a670f3498 sp:7ffdf2cd6060 error:0 in libstd-23815cc482a70678.so[7f2a67099000+155000]\r\nApr  6 04:47:48 origin kernel: [32541.823158] segfault-no-out[16965]: segfault at 0 ip 000055fd937ceb69 sp 00007fff8f94f100 error 6 in segfault-no-out-of-stack.stage2-x86_64-unknown-linux-gnu[55fd937cb000+5000]\r\nApr  6 04:47:55 origin kernel: [32548.615545] signal-exit-sta[17770]: segfault at 1 ip 000055cc448b9efc sp 00007fff3879c310 error 6 in signal-exit-status.stage2-x86_64-unknown-linux-gnu[55cc448b7000+4000]\r\nApr  6 04:47:58 origin kernel: [32551.276777] traps: simd-target-fea[18051] trap invalid opcode ip:562ab9dfc89c sp:7fff6be1eb50\r\nerror:0 in simd-target-feature-mixup.stage2-x86_64-unknown-linux-gnu[562ab9df9000+7000]\r\n\r\nIn case it was a weird one-off problem, I retried and got a similar result. On ryzen, a few instructions which were present in previous micro-architectures such as Kaveri are no longer present, but binaries built for older AMD machines do work - so I figured a non-ryzen instruction had crept in. But how to get rid of it ?\r\n\r\nIf (with 1.22.1 currently in /usr) I use\r\n``rustc -C target-cpu=help\r\n\r\nit tells me target-cpu=native will use znver1 which should be fine. But I cannot manage to get it to avoid the invalid instructions (although as I said, without running the tests all seems fine).\r\n\r\nThe results from google were ambiguous (maybe things have changed over time), but I tried:\r\n\r\nexport RUSTC_FLAGS='-C target-cpu=native'\r\nand =x86-64\r\nand =skylake (I would expect that to fail earlier, so it suggested that envvar was not recognized)\r\nwhich all trapped and segfaulted early in the tests (I was attentive and interrupted the builds instead of letting it carry on and reboot)\r\n\r\nThen I tried, in config.toml\r\n\r\n[build]\r\nrustflags = \"-C  target-cpu=native\"\r\n\r\nwhich was very quickly spat out as an unknown field.\r\n\r\nThen I tried\r\n\r\nexport RUSTFLAGS='-C target-cpu=native'\r\nand =x86-64 and =amdfam10 : all trapped and segfaulted\r\n\r\nsimilarly\r\nexport CARGO_BUILD_RUSTFLAGS='-C target-cpu=native'\r\nand =x86-64 and =amdfam10\r\n\r\nThis is \"disappointing\". NB - using RUST_BACKTRACE=1 didn't give me any information about what had generated the invalid opcode.", "closed_by": {"login": "zarniwhoop73", "id": 8324892, "node_id": "MDQ6VXNlcjgzMjQ4OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/8324892?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zarniwhoop73", "html_url": "https://github.com/zarniwhoop73", "followers_url": "https://api.github.com/users/zarniwhoop73/followers", "following_url": "https://api.github.com/users/zarniwhoop73/following{/other_user}", "gists_url": "https://api.github.com/users/zarniwhoop73/gists{/gist_id}", "starred_url": "https://api.github.com/users/zarniwhoop73/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zarniwhoop73/subscriptions", "organizations_url": "https://api.github.com/users/zarniwhoop73/orgs", "repos_url": "https://api.github.com/users/zarniwhoop73/repos", "events_url": "https://api.github.com/users/zarniwhoop73/events{/privacy}", "received_events_url": "https://api.github.com/users/zarniwhoop73/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/49751/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/49751/timeline", "performed_via_github_app": null, "state_reason": "completed"}