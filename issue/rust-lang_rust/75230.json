{"url": "https://api.github.com/repos/rust-lang/rust/issues/75230", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/75230/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/75230/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/75230/events", "html_url": "https://github.com/rust-lang/rust/issues/75230", "id": 674607754, "node_id": "MDU6SXNzdWU2NzQ2MDc3NTQ=", "number": 75230, "title": "SIGILL in rustc_mir::interpret::intrinsics::numeric_intrinsic (clrldi) on PowerPC", "user": {"login": "clehner", "id": 95347, "node_id": "MDQ6VXNlcjk1MzQ3", "avatar_url": "https://avatars.githubusercontent.com/u/95347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/clehner", "html_url": "https://github.com/clehner", "followers_url": "https://api.github.com/users/clehner/followers", "following_url": "https://api.github.com/users/clehner/following{/other_user}", "gists_url": "https://api.github.com/users/clehner/gists{/gist_id}", "starred_url": "https://api.github.com/users/clehner/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/clehner/subscriptions", "organizations_url": "https://api.github.com/users/clehner/orgs", "repos_url": "https://api.github.com/users/clehner/repos", "events_url": "https://api.github.com/users/clehner/events{/privacy}", "received_events_url": "https://api.github.com/users/clehner/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 100522, "node_id": "MDU6TGFiZWwxMDA1MjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-crash", "name": "I-crash", "color": "e10c02", "default": false, "description": "Issue: The compiler crashes (SIGSEGV, SIGABRT, etc). Use I-ICE instead when the compiler panics."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 515028847, "node_id": "MDU6TGFiZWw1MTUwMjg4NDc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-PowerPC", "name": "O-PowerPC", "color": "6e6ec0", "default": false, "description": "Target: PowerPC processors"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 900795185, "node_id": "MDU6TGFiZWw5MDA3OTUxODU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-const-eval", "name": "A-const-eval", "color": "f7e101", "default": false, "description": "Area: constant evaluation (mir interpretation)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2020-08-06T21:19:33Z", "updated_at": "2022-01-21T16:26:11Z", "closed_at": "2022-01-21T16:26:10Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Hello,\r\n\r\nI am unable to compile tokio due to rustc exiting with SIGILL. It appears to be related to the CPU instruction `clrldi` in the function `numeric_intrinsic` in file `src/librustc_mir/interpret/intrinsics.rs`.\r\n\r\n### Meta\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.45.2 (d3fb005a3 2020-07-31)\r\nbinary: rustc\r\ncommit-hash: d3fb005a39e62501b8b0b356166e515ae24e2e54\r\ncommit-date: 2020-07-31\r\nhost: powerpc-unknown-linux-gnu\r\nrelease: 1.45.2\r\nLLVM version: 10.0\r\n```\r\n`grep cpu /proc/cpuinfo`:\r\n```\r\ncpu             : 7447A, altivec supported\r\n```\r\n\r\nI get this error with rustup's stable and beta toolchain on powerpc-unknown-linux-gnu, and also with Debian's rust toolchain, and with Void Linux PPC's, including on `powerpc-unknown-linux-musl`.\r\n\r\nI was not able to try rustup nightly, as when running `rustup toolchain install nightly` I got `info: skipping nightly which is missing installed component 'rustfmt-preview'`.\r\n\r\n### Error output\r\n```\r\n   Compiling tokio v0.2.22 (/home/cel/src/tokio/tokio)\r\nerror: could not compile `tokio`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name tokio --edition=2018 tokio/src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts --crate-type lib --emit=dep-info,metadata,link -Cembed-bitcode=no -C debuginfo=2 --cfg 'feature=\"blocking\"' --cfg 'feature=\"default\"' --cfg 'feature=\"dns\"' --cfg 'feature=\"fnv\"' --cfg 'feature=\"fs\"' --cfg 'feature=\"full\"' --cfg 'feature=\"futures-core\"' --cfg 'feature=\"io-driver\"' --cfg 'feature=\"io-std\"' --cfg 'feature=\"io-util\"' --cfg 'feature=\"iovec\"' --cfg 'feature=\"lazy_static\"' --cfg 'feature=\"libc\"' --cfg 'feature=\"macros\"' --cfg 'feature=\"memchr\"' --cfg 'feature=\"mio\"' --cfg 'feature=\"mio-named-pipes\"' --cfg 'feature=\"mio-uds\"' --cfg 'feature=\"net\"' --cfg 'feature=\"num_cpus\"' --cfg 'feature=\"process\"' --cfg 'feature=\"rt-core\"' --cfg 'feature=\"rt-threaded\"' --cfg 'feature=\"rt-util\"' --cfg 'feature=\"signal\"' --cfg 'feature=\"signal-hook-registry\"' --cfg 'feature=\"slab\"' --cfg 'feature=\"stream\"' --cfg 'feature=\"sync\"' --cfg 'feature=\"tcp\"' --cfg 'feature=\"test-util\"' --cfg 'feature=\"time\"' --cfg 'feature=\"tokio-macros\"' --cfg 'feature=\"tracing\"' --cfg 'feature=\"udp\"' --cfg 'feature=\"uds\"' --cfg 'feature=\"winapi\"' -C metadata=08dab97d397860a2 -C extra-filename=-08dab97d397860a2 --out-dir /home/cel/src/tokio/target/debug/deps -C incremental=/home/cel/src/tokio/target/debug/incremental -L dependency=/home/cel/src/tokio/target/debug/deps --extern bytes=/home/cel/src/tokio/target/debug/deps/libbytes-4b2202b10ad67305.rmeta --extern fnv=/home/cel/src/tokio/target/debug/deps/libfnv-1754423c35fa008e.rmeta --extern futures_core=/home/cel/src/tokio/target/debug/deps/libfutures_core-6507ace98878c6bd.rmeta --extern iovec=/home/cel/src/tokio/target/debug/deps/libiovec-342737630c45e272.rmeta --extern lazy_static=/home/cel/src/tokio/target/debug/deps/liblazy_static-a690edb05f51f41d.rmeta --extern libc=/home/cel/src/tokio/target/debug/deps/liblibc-b134b680340e5c64.rmeta --extern memchr=/home/cel/src/tokio/target/debug/deps/libmemchr-bf061ca7ec9f529d.rmeta --extern mio=/home/cel/src/tokio/target/debug/deps/libmio-9cbaf42048a214a9.rmeta --extern mio_uds=/home/cel/src/tokio/target/debug/deps/libmio_uds-1544eb43ac6c2533.rmeta --extern num_cpus=/home/cel/src/tokio/target/debug/deps/libnum_cpus-cf39b45a61cfde3a.rmeta --extern pin_project_lite=/home/cel/src/tokio/target/debug/deps/libpin_project_lite-ffe24d9f1571d112.rmeta --extern signal_hook_registry=/home/cel/src/tokio/target/debug/deps/libsignal_hook_registry-d843b58b1eb785b2.rmeta --extern slab=/home/cel/src/tokio/target/debug/deps/libslab-3bd396479209cd59.rmeta --extern tokio_macros=/home/cel/src/tokio/target/debug/deps/libtokio_macros-e69ccd503f052212.so --extern tracing=/home/cel/src/tokio/target/debug/deps/libtracing-19e259a6042cfe5b.rmeta` (signal: 4, SIGILL: illegal instruction)\r\n```\r\n\r\n<details><summary><strong>Backtrace (rust-gdb)</strong></summary>\r\n<p>\r\n\r\n```\r\n#0  0xb46af05c in rustc_mir::interpret::intrinsics::numeric_intrinsic ()\r\n   from /home/cel/.rustup/toolchains/stable-powerpc-unknown-linux-gnu/bin/../lib/librustc_driver-ed8e197347198f78.so\r\n#1  0xb44b28f4 in rustc_mir::interpret::intrinsics::<impl rustc_mir::interpret::eval_context::InterpCx<M>>::emulate_intrinsic ()\r\n   from /home/cel/.rustup/toolchains/stable-powerpc-unknown-linux-gnu/bin/../lib/librustc_driver-ed8e197347198f78.so\r\n#2  0xb42dd150 in <rustc_mir::const_eval::machine::CompileTimeInterpreter as rustc_mir::interpret::machine::Machine>::call_intrinsic ()\r\n   from /home/cel/.rustup/toolchains/stable-powerpc-unknown-linux-gnu/bin/../lib/librustc_driver-ed8e197347198f78.so\r\n#3  0xb44f4d44 in rustc_mir::interpret::terminator::<impl rustc_mir::interpret::eval_context::InterpCx<M>>::eval_fn_call ()\r\n   from /home/cel/.rustup/toolchains/stable-powerpc-unknown-linux-gnu/bin/../lib/librustc_driver-ed8e197347198f78.so\r\n#4  0xb44e4544 in rustc_mir::interpret::step::<impl rustc_mir::interpret::eval_context::InterpCx<M>>::run ()\r\n   from /home/cel/.rustup/toolchains/stable-powerpc-unknown-linux-gnu/bin/../lib/librustc_driver-ed8e197347198f78.so\r\n#5  0xb414de2c in rustc_mir::const_eval::eval_queries::const_eval_raw_provider\r\n    ()\r\n   from /home/cel/.rustup/toolchains/stable-powerpc-unknown-linux-gnu/bin/../lib/librustc_driver-ed8e197347198f78.so\r\n#6  0xb410fe34 in rustc_middle::ty::query::<impl rustc_query_system::query::config::QueryAccessors<rustc_middle::ty::context::TyCtxt> for rustc_middle::ty::query::queries::const_eval_raw>::compute ()\r\n   from /home/cel/.rustup/toolchains/stable-powerpc-unknown-linux-gnu/bin/../lib/librustc_driver-ed8e197347198f78.so\r\n#7  0xb4308208 in rustc_middle::dep_graph::<impl rustc_query_system::dep_graph::DepKind for rustc_middle::dep_graph::dep_node::DepKind>::with_deps ()\r\n   from /home/cel/.rustup/toolchains/stable-powerpc-unknown-linux-gnu/bin/../lib/librustc_driver-ed8e197347198f78.so\r\n#8  0xb446da48 in rustc_query_system::dep_graph::graph::DepGraph<K>::with_task_impl ()\r\n   from /home/cel/.rustup/toolchains/stable-powerpc-unknown-linux-gnu/bin/../lib/librustc_driver-ed8e197347198f78.so\r\n#9  0xb451e7b8 in rustc_data_structures::stack::ensure_sufficient_stack ()\r\n   from /home/cel/.rustup/toolchains/stable-powerpc-unknown-linux-gnu/bin/../lib/librustc_driver-ed8e197347198f78.so\r\n#10 0xb43db9c8 in rustc_query_system::query::plumbing::get_query_impl ()\r\n   from /home/cel/.rustup/toolchains/stable-powerpc-unknown-linux-gnu/bin/../lib/librustc_driver-ed8e197347198f78.so\r\n[279 additional stack levels omitted]\r\n```\r\nDisassembling the function:\r\n```\r\n...\r\n   0xb46af038 <+1744>:  rotlwi  r0,r9,24\r\n   0xb46af03c <+1748>:  rlwimi  r12,r10,8,24,31\r\n   0xb46af040 <+1752>:  rotlwi  r10,r7,24\r\n   0xb46af044 <+1756>:  rlwimi  r25,r8,8,8,15\r\n   0xb46af048 <+1760>:  rlwimi  r0,r9,8,8,15\r\n   0xb46af04c <+1764>:  rlwimi  r10,r7,8,8,15\r\n   0xb46af050 <+1768>:  rlwimi  r0,r9,8,24,31\r\n   0xb46af054 <+1772>:  rlwimi  r10,r7,8,24,31\r\n   0xb46af058 <+1776>:  rlwimi  r25,r8,8,24,31\r\n=> 0xb46af05c <+1780>:  clrldi  r11,r0,32\r\n   0xb46af060 <+1784>:  clrldi  r8,r12,32\r\n   0xb46af064 <+1788>:  clrldi  r9,r10,32\r\n   0xb46af068 <+1792>:  clrldi  r7,r25,32\r\n   0xb46af06c <+1796>:  or.     r3,r6,r3\r\n   0xb46af070 <+1800>:  stw     r8,60(r1)\r\n   0xb46af074 <+1804>:  stw     r7,56(r1)\r\n   0xb46af078 <+1808>:  stw     r9,64(r1)\r\n   0xb46af07c <+1812>:  stw     r11,68(r1)\r\n   0xb46af080 <+1816>:  beq     0xb46af13c <_ZN9rustc_mir9interpret10intrinsics17numeric_intrinsic17h9c3bde9c1f9dc4c9E+2004>\r\n   0xb46af084 <+1820>:  neg     r3,r6\r\n   0xb46af088 <+1824>:  andi.   r3,r3,120\r\n   0xb46af08c <+1828>:  li      r6,-1\r\n...\r\n```\r\nAs shown above, gdb shows the current instruction is `clrldi r11,r0,32`.\r\n`info all-registers` shows the values of these registers:\r\n```\r\nr0             0xf8000000          4160749568\r\nr11            0x0                 0\r\n```\r\n</p>\r\n</details>\r\n\r\nEdit:\r\n`PPC_Vers202_Book1_public.pdf` (PowerPC User Instruction Set Architecture) says that `clrldi Rx,Ry,32` means \"clear the high-order 32 bits of register Ry and place the result into register Rx\".\r\nIt seems to stand for \"Clear Left Rotate Left Doubleword Immediate\". It is an extended mnemonic for `rldicl` (\"Rotate Left Doubleword Immediate then Clear left\").", "closed_by": {"login": "clehner", "id": 95347, "node_id": "MDQ6VXNlcjk1MzQ3", "avatar_url": "https://avatars.githubusercontent.com/u/95347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/clehner", "html_url": "https://github.com/clehner", "followers_url": "https://api.github.com/users/clehner/followers", "following_url": "https://api.github.com/users/clehner/following{/other_user}", "gists_url": "https://api.github.com/users/clehner/gists{/gist_id}", "starred_url": "https://api.github.com/users/clehner/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/clehner/subscriptions", "organizations_url": "https://api.github.com/users/clehner/orgs", "repos_url": "https://api.github.com/users/clehner/repos", "events_url": "https://api.github.com/users/clehner/events{/privacy}", "received_events_url": "https://api.github.com/users/clehner/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/75230/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/75230/timeline", "performed_via_github_app": null, "state_reason": "completed"}