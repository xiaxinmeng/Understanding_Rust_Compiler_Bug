{"url": "https://api.github.com/repos/rust-lang/rust/issues/99432", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/99432/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/99432/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/99432/events", "html_url": "https://github.com/rust-lang/rust/issues/99432", "id": 1308370788, "node_id": "I_kwDOAAsO6M5N_Cdk", "number": 99432, "title": "rustc `master` has a flaky failure when compiled against LLVM `main`", "user": {"login": "durin42", "id": 20269, "node_id": "MDQ6VXNlcjIwMjY5", "avatar_url": "https://avatars.githubusercontent.com/u/20269?v=4", "gravatar_id": "", "url": "https://api.github.com/users/durin42", "html_url": "https://github.com/durin42", "followers_url": "https://api.github.com/users/durin42/followers", "following_url": "https://api.github.com/users/durin42/following{/other_user}", "gists_url": "https://api.github.com/users/durin42/gists{/gist_id}", "starred_url": "https://api.github.com/users/durin42/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/durin42/subscriptions", "organizations_url": "https://api.github.com/users/durin42/orgs", "repos_url": "https://api.github.com/users/durin42/repos", "events_url": "https://api.github.com/users/durin42/events{/privacy}", "received_events_url": "https://api.github.com/users/durin42/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 3, "created_at": "2022-07-18T18:43:12Z", "updated_at": "2022-07-29T04:23:05Z", "closed_at": "2022-07-29T04:23:05Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "LLVM commit [ede600377cb6df1bef71f070130d8cfe734cc5b7](https://github.com/llvm/llvm-project/commit/ede600377cb6df1bef71f070130d8cfe734cc5b7) moved some stuff from being `ManagedStatic` to just thread-local static, and it seems we're not correctly blocking on LLVM threads being complete. If I apply this:\r\n\r\n```diff\r\ndiff --git a/compiler/rustc_driver/src/lib.rs b/compiler/rustc_driver/src/lib.rs\r\nindex b71cdad718a..96f34c9ec3b 100644\r\n--- a/compiler/rustc_driver/src/lib.rs\r\n+++ b/compiler/rustc_driver/src/lib.rs\r\n@@ -1336,6 +1336,10 @@ pub fn main() -> ! {\r\n         let end_rss = get_resident_set_size();\r\n         print_time_passes_entry(\"total\", start_time.elapsed(), start_rss, end_rss);\r\n     }\r\n-\r\n-    process::exit(exit_code)\r\n+    if 1 == 200 {\r\n+        process::exit(exit_code)\r\n+    }\r\n+    unsafe {\r\n+    libc::_exit(exit_code)\r\n+    }\r\n }\r\n```\r\n\r\nthen I no longer see the failure in 10,000 attempts, which [always looks like this when it happens](https://buildkite.com/llvm-project/rust-llvm-integrate-prototype/builds/11871#0181e78f-2ce6-4ee3-8508-21556f4f7ef4):\r\n```\r\n---- [ui] src/test/ui/cmse-nonsecure/cmse-nonsecure-call/params-on-stack.rs stdout ----\r\n\u00a0\r\nerror: Error: expected failure status (Some(1)) but received status Some(101).\r\nstatus: exit status: 101\r\ncommand: \"/var/lib/buildkite-agent/builds/rust-llvm-integrate/llvm-project/rust-llvm-integrate-prototype/build/x86_64-unknown-linux-gnu/stage1/bin/rustc\" \"/var/lib/buildkite-agent/builds/rust-llvm-integrate/llvm-project/rust-llvm-integrate-prototype/src/test/ui/cmse-nonsecure/cmse-nonsecure-call/params-on-stack.rs\" \"-Zthreads=1\" \"--error-format\" \"json\" \"--json\" \"future-incompat\" \"-Ccodegen-units=1\" \"-Zui-testing\" \"-Zdeduplicate-diagnostics=no\" \"-Cstrip=debuginfo\" \"-C\" \"prefer-dynamic\" \"--out-dir\" \"/var/lib/buildkite-agent/builds/rust-llvm-integrate/llvm-project/rust-llvm-integrate-prototype/build/x86_64-unknown-linux-gnu/test/ui/cmse-nonsecure/cmse-nonsecure-call/params-on-stack\" \"-A\" \"unused\" \"-Crpath\" \"-Cdebuginfo=0\" \"-Lnative=/var/lib/buildkite-agent/builds/rust-llvm-integrate/llvm-project/rust-llvm-integrate-prototype/build/x86_64-unknown-linux-gnu/native/rust-test-helpers\" \"-Clinker=/usr/bin/clang-13\" \"--target\" \"thumbv8m.main-none-eabi\" \"--crate-type\" \"lib\" \"-L\" \"/var/lib/buildkite-agent/builds/rust-llvm-integrate/llvm-project/rust-llvm-integrate-prototype/build/x86_64-unknown-linux-gnu/test/ui/cmse-nonsecure/cmse-nonsecure-call/params-on-stack/auxiliary\"\r\nstdout: none\r\n--- stderr -------------------------------\r\nerror: <unknown>:0:0: in function test i32 (i32, i32, i32, i32, i32): call to non-secure function would require passing arguments on stack\r\n\u00a0\r\nerror: aborting due to previous error\r\n\u00a0\r\nLLVM ERROR: Do not know how to split the result of this operator!\r\n------------------------------------------\r\n\u00a0\r\n\u00a0\r\n\u00a0\r\nfailures:\r\n[ui] src/test/ui/cmse-nonsecure/cmse-nonsecure-call/params-on-stack.rs\r\n```\r\n\r\nOn our CI VM (which is fairly small) this appears to happen roughly a third or half the time. On my workstation it's less than 1% of the time, best guess about 0.3% of the time, so 10k runs is necessary to reliably see the issue.\r\n\r\nI'll hopefully have time to fix this in the near future, but wanted to record this ASAP so we don't forget when the LLVM upgrade is due.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/99432/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/99432/timeline", "performed_via_github_app": null, "state_reason": "completed"}