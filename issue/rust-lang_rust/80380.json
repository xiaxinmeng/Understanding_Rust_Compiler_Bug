{"url": "https://api.github.com/repos/rust-lang/rust/issues/80380", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/80380/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/80380/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/80380/events", "html_url": "https://github.com/rust-lang/rust/issues/80380", "id": 774886811, "node_id": "MDU6SXNzdWU3NzQ4ODY4MTE=", "number": 80380, "title": "Suboptimal diagnostic if const eval error site is in a different crate", "user": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 900795185, "node_id": "MDU6TGFiZWw5MDA3OTUxODU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-const-eval", "name": "A-const-eval", "color": "f7e101", "default": false, "description": "Area: constant evaluation (mir interpretation)"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2020-12-26T14:46:12Z", "updated_at": "2020-12-26T21:42:40Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "We currently produce fun diagnostics like\r\n\r\n```\r\nerror: any use of this value will cause an error\r\n  --> $SRC_DIR/core/src/intrinsics.rs:LL:COL\r\n   |\r\nLL |     unsafe { copy_nonoverlapping(src, dst, count) }\r\n   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n   |              |\r\n   |              memory access failed: pointer must be in-bounds at offset 8, but is outside bounds of alloc6 which has size 4\r\n   |              inside `copy_nonoverlapping::<u32>` at $SRC_DIR/core/src/intrinsics.rs:LL:COL\r\n   |              inside `std::ptr::read::<u32>` at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\r\n   |              inside `ptr::mut_ptr::<impl *mut u32>::read` at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\r\n   |              inside `_MUT_READ` at $DIR/out_of_bounds_read.rs:15:37\r\n   | \r\n  ::: $DIR/out_of_bounds_read.rs:15:5\r\n   |\r\nLL |     const _MUT_READ: u32 = unsafe { (PAST_END_PTR as *mut u32).read() };\r\n   |     --------------------------------------------------------------------\r\n```\r\n\r\nWhich I have multiple problems with (all of which are my fault :stuck_out_tongue:)\r\n\r\n1. the main message only makes sense when you realize this is a lint\r\n2. the diagnostic points to another crate's internals as the main span\r\n3. the local crate's span is pointing at the entire item, instead of the useful span that we have (last element in the stack trace)\r\n\r\nI think we should adjust the diagnostic to report on the site in the currently compiling crate while still mentioning the backtrace in full, so something like \r\n\r\n```\r\nerror: memory access failed: pointer must be in-bounds at offset 8, but is outside bounds of alloc6 which has size \r\n  --> $SRC_DIR/core/src/intrinsics.rs:LL:COL\r\n   |\r\nLL |     const _MUT_READ: u32 = unsafe { (PAST_END_PTR as *mut u32).read() };\r\n   |                                                               ^^^^^^^ in function call here\r\n   |     \r\nLL |     unsafe { copy_nonoverlapping(src, dst, count) }\r\n   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ failure in external crate here\r\n   |              inside `copy_nonoverlapping::<u32>` at $SRC_DIR/core/src/intrinsics.rs:LL:COL\r\n   |              inside `std::ptr::read::<u32>` at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\r\n   |              inside `ptr::mut_ptr::<impl *mut u32>::read` at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\r\n   |              inside `_MUT_READ` at $DIR/out_of_bounds_read.rs:15:37\r\n```\r\n\r\ncc @rust-lang/wg-diagnostics @rust-lang/wg-const-eval ", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/80380/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/80380/timeline", "performed_via_github_app": null, "state_reason": null}