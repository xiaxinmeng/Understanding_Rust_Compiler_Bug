{"url": "https://api.github.com/repos/rust-lang/rust/issues/64126", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/64126/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/64126/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/64126/events", "html_url": "https://github.com/rust-lang/rust/issues/64126", "id": 488556321, "node_id": "MDU6SXNzdWU0ODg1NTYzMjE=", "number": 64126, "title": "faults and weird behavior on armv5te", "user": {"login": "M1cha", "id": 878458, "node_id": "MDQ6VXNlcjg3ODQ1OA==", "avatar_url": "https://avatars.githubusercontent.com/u/878458?v=4", "gravatar_id": "", "url": "https://api.github.com/users/M1cha", "html_url": "https://github.com/M1cha", "followers_url": "https://api.github.com/users/M1cha/followers", "following_url": "https://api.github.com/users/M1cha/following{/other_user}", "gists_url": "https://api.github.com/users/M1cha/gists{/gist_id}", "starred_url": "https://api.github.com/users/M1cha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/M1cha/subscriptions", "organizations_url": "https://api.github.com/users/M1cha/orgs", "repos_url": "https://api.github.com/users/M1cha/repos", "events_url": "https://api.github.com/users/M1cha/events{/privacy}", "received_events_url": "https://api.github.com/users/M1cha/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 55301954, "node_id": "MDU6TGFiZWw1NTMwMTk1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-Arm", "name": "O-Arm", "color": "6e6ec0", "default": false, "description": "Target: 32-bit Arm processors (armv6, armv7, thumb...), including 64-bit Arm in AArch32 state"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2019-09-03T11:46:03Z", "updated_at": "2022-11-01T14:21:57Z", "closed_at": "2020-03-21T13:39:43Z", "author_association": "NONE", "active_lock_reason": null, "body": "I'm trying to use rust binaries on an armv5te gateway using yocto(thud, meta-atmel).\r\nDepending on the configuration(rust-version, target-flags, lto, optimization) I have anything from a (luckily) working binary over wrong logic-level behavior to segmentation faults.\r\nDuring runtime, these problems are deterministic and are introduced during compile-time.\r\n\r\nI've uploaded a minmial example of one of these symptoms for you to be able to reproduce the problem: https://github.com/M1cha/rust_armfault/tree/arcswap\r\nconfig:\r\n- rustup's stable toolchain(`stable-x86_64-unknown-linux-gnu`, `rustc 1.31.1 (b6c32da9b 2018-12-18)`)\r\n- arm-unknown-linux-gnueabi toolchain built by crosstools-ng `1:1.24.0.r6.gafaf7b9a-1`\r\n- the following `~/.cargo/config`\r\n```\r\n[target.armv5te-unknown-linux-gnueabi]\r\nlinker = \"arm-linux-gnueabi-gcc\"\r\n```\r\n- build command: `cargo build --release --target armv5te-unknown-linux-gnueabi`\r\n\r\nThis specific fault only occurs with LTO enabled, during optimization levels 2 and 3.\r\nTo be clear, unless I'm fighting multiple bugs at once, this bug is **NOT** caused by LTO, it just happens to occur in that config. I have other symptoms which occur without LTO and optimization level 1, but I can't reproduce them outside of my yocto environment.(e.g. a segfault during `regex::Regex::new`).\r\n\r\nThis is the call-stack during the fault:\r\n```\r\n#0  0xffff0fc0 in ?? ()\r\n#1  0x00457d68 in compiler_builtins::arm_linux::__kuser_cmpxchg ()\r\n    at rustc/compiler_builtins_shim/../../libcompiler_builtins/src/arm_linux.rs:8\r\n#2  compiler_builtins::arm_linux::atomic_cmpxchg ()\r\n    at rustc/compiler_builtins_shim/../../libcompiler_builtins/src/arm_linux.rs:85\r\n#3  __sync_val_compare_and_swap_4 () at rustc/compiler_builtins_shim/../../libcompiler_builtins/src/arm_linux.rs:103\r\n#4  0x00403ab0 in <arc_swap::ArcSwapAny<T, S>>::wait_for_readers ()\r\n#5  0x004169e4 in armfault::main ()\r\n#6  0x00416a94 in std::rt::lang_start::{{closure}} ()\r\n#7  0x00416498 in main ()\r\n```\r\n\r\nregisters:\r\n```\r\nr0             0x0                 0\r\nr1             0x0                 0\r\nr2             0x45acdc            4566236\r\nr3             0x0                 0\r\nr4             0x0                 0\r\nr5             0x0                 0\r\nr6             0x45acdc            4566236\r\nr7             0xffff0fc0          4294905792\r\nr8             0x474100            4669696\r\nr9             0x4740c4            4669636\r\nr10            0xbefffb20          3204447008\r\nr11            0x0                 0\r\nr12            0x473ee4            4669156\r\nsp             0xbefffae0          0xbefffae0\r\nlr             0x457d68            4554088\r\npc             0xffff0fc0          0xffff0fc0\r\ncpsr           0x60000010          1610612752\r\n```\r\nuser_debug kernel log:\r\n```\r\narmfault: unhandled page fault (11) at 0x0045acdc, code 0x81f\r\npgd = 6ca4b731\r\n[0045acdc] *pgd=25d04831, *pte=2406d18f, *ppte=2406daae\r\nCPU: 0 PID: 28225 Comm: armfault Not tainted 4.19.61-yocto-standard #1\r\nHardware name: Atmel AT91SAM9\r\nPC is at _einittext+0x3f902c00/0xffe43ce8\r\nLR is at 0x457d68\r\npc : [<ffff0fc0>]    lr : [<00457d68>]    psr: 60000010\r\nsp : befffae0  ip : 00473ee4  fp : 00000000\r\nr10: befffb20  r9 : 004740c4  r8 : 00474100\r\nr7 : ffff0fc0  r6 : 0045acdc  r5 : 00000000  r4 : 00000000\r\nr3 : 00000000  r2 : 0045acdc  r1 : 00000000  r0 : 00000000\r\nFlags: nZCv  IRQs on  FIQs on  Mode USER_32  ISA ARM  Segment user\r\nControl: 0005317f  Table: 25fa4000  DAC: 00000055\r\nCPU: 0 PID: 28225 Comm: armfault Not tainted 4.19.61-yocto-standard #1\r\nHardware name: Atmel AT91SAM9\r\n[<c000faf0>] (unwind_backtrace) from [<c000d248>] (show_stack+0x10/0x14)\r\n[<c000d248>] (show_stack) from [<c000fe3c>] (__do_user_fault+0x94/0xf0)\r\n[<c000fe3c>] (__do_user_fault) from [<c001015c>] (do_page_fault+0x250/0x284)\r\n[<c001015c>] (do_page_fault) from [<c0010304>] (do_DataAbort+0x48/0xe8)\r\n[<c0010304>] (do_DataAbort) from [<c0009d0c>] (__dabt_usr+0x4c/0x60)\r\nException stack(0xc5c79fb0 to 0xc5c79ff8)\r\n9fa0:                                     00000000 00000000 0045acdc 00000000\r\n9fc0: 00000000 00000000 0045acdc ffff0fc0 00474100 004740c4 befffb20 00000000\r\n9fe0: 00473ee4 befffae0 00457d68 ffff0fc0 60000010 ffffffff\r\n\r\nProgram received signal SIGSEGV, Segmentation fault.\r\n```\r\n\r\ninstructions at pc, pc+4, pc+8:\r\n```\r\n(gdb) x/i $pc\r\n=> 0xffff0fc0:  ldr     r3, [r2]\r\n(gdb) x/i $pc + 4\r\n   0xffff0fc4:  subs    r3, r3, r0\r\n(gdb) x/i $pc + 8\r\n   0xffff0fc8:  streq   r1, [r2]\r\n```\r\nAt first glance this looks like a fault-on-read but due to how `__kuser_cmpxchg` is implemented it actually faults at the write(0xffff0fc8), then jumps back to 0xffff0fc0 and then informs gdb via ptrace.\r\nThe address it tries to write to is `0x45acdc` which maps to `0x5acdc` inside the elf binary.\r\nThis area is part of the rodata section:\r\n`[15] .rodata           PROGBITS        0005ab80 05ab80 00616c 00   A  0   0 64`\r\nThere's no symbol at that location though.\r\n\r\nI hope that this helps you to track down the bug because this keeps me from using rust on this architecture.", "closed_by": {"login": "Amanieu", "id": 278509, "node_id": "MDQ6VXNlcjI3ODUwOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/278509?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Amanieu", "html_url": "https://github.com/Amanieu", "followers_url": "https://api.github.com/users/Amanieu/followers", "following_url": "https://api.github.com/users/Amanieu/following{/other_user}", "gists_url": "https://api.github.com/users/Amanieu/gists{/gist_id}", "starred_url": "https://api.github.com/users/Amanieu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Amanieu/subscriptions", "organizations_url": "https://api.github.com/users/Amanieu/orgs", "repos_url": "https://api.github.com/users/Amanieu/repos", "events_url": "https://api.github.com/users/Amanieu/events{/privacy}", "received_events_url": "https://api.github.com/users/Amanieu/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/64126/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/64126/timeline", "performed_via_github_app": null, "state_reason": "completed"}