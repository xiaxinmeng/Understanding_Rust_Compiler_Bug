{"url": "https://api.github.com/repos/rust-lang/rust/issues/97930", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/97930/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/97930/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/97930/events", "html_url": "https://github.com/rust-lang/rust/issues/97930", "id": 1266647946, "node_id": "I_kwDOAAsO6M5Lf4OK", "number": 97930, "title": "Confusing error message when future borrows value that is moved into map() closure ", "user": {"login": "Storyyeller", "id": 999674, "node_id": "MDQ6VXNlcjk5OTY3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/999674?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Storyyeller", "html_url": "https://github.com/Storyyeller", "followers_url": "https://api.github.com/users/Storyyeller/followers", "following_url": "https://api.github.com/users/Storyyeller/following{/other_user}", "gists_url": "https://api.github.com/users/Storyyeller/gists{/gist_id}", "starred_url": "https://api.github.com/users/Storyyeller/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Storyyeller/subscriptions", "organizations_url": "https://api.github.com/users/Storyyeller/orgs", "repos_url": "https://api.github.com/users/Storyyeller/repos", "events_url": "https://api.github.com/users/Storyyeller/events{/privacy}", "received_events_url": "https://api.github.com/users/Storyyeller/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-06-09T20:54:50Z", "updated_at": "2022-07-04T08:09:53Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "When you call an async function on a borrowed function and then map() the resulting future with a closure that moves the borrowed value, the result is a confusing error message.\r\n\r\nIt took me a while to realize that even though the closure is _executed_ after the future completes, it is _constructed_ before the future runs. This is especially counter-intuitive because the equivalent non-async code works just fine (e.g. if foo returned an `Option<usize>` instead of a future).  \r\n\r\n\r\nPlayground link: https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=722ef38b9da0cc17c7945e0379d266d7\r\n\r\nGiven the following code:\r\n\r\n```rust\r\nuse futures::FutureExt;\r\n\r\nasync fn foo(s: &str) -> usize {\r\n    s.len()\r\n}\r\n\r\nfn bar() {\r\n    let s = \"\".to_string();\r\n    foo(&s).map(|len| (s, len));\r\n}\r\n```\r\n\r\nThe current output is:\r\n\r\n```\r\nerror[[E0505]](https://doc.rust-lang.org/stable/error-index.html#E0505): cannot move out of `s` because it is borrowed\r\n --> src/lib.rs:9:17\r\n  |\r\n9 |     foo(&s).map(|len| (s, len));\r\n  |         --  --- ^^^^^  - move occurs due to use in closure\r\n  |         |   |   |\r\n  |         |   |   move out of `s` occurs here\r\n  |         |   borrow later used by call\r\n  |         borrow of `s` occurs here\r\n```\r\n\r\n<!-- The following is not always necessary. -->\r\nIdeally the output should look like:\r\n\r\nExplain that the map() closure is constructed before the future completes and suggest changing the code to something like this:\r\n```\r\n    async move {\r\n        let len = foo(&s).await;\r\n        (s, len);\r\n    };\r\n```\r\n\r\n<!--\r\nIf the problem is not self-explanatory, please provide a rationale for the\r\nchange.\r\n-->\r\n\r\n<!--\r\nIf dramatically different output is caused by small changes, consider also\r\nadding them here.\r\n\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions. The output might also be\r\ndifferent depending on the Edition.\r\n-->\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/97930/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/97930/timeline", "performed_via_github_app": null, "state_reason": null}