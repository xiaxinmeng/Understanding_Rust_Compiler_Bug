{"url": "https://api.github.com/repos/rust-lang/rust/issues/49336", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/49336/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/49336/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/49336/events", "html_url": "https://github.com/rust-lang/rust/issues/49336", "id": 308281068, "node_id": "MDU6SXNzdWUzMDgyODEwNjg=", "number": 49336, "title": "Possible miscompilation in >= 1.24.0", "user": {"login": "bheisler", "id": 1616938, "node_id": "MDQ6VXNlcjE2MTY5Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1616938?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bheisler", "html_url": "https://github.com/bheisler", "followers_url": "https://api.github.com/users/bheisler/followers", "following_url": "https://api.github.com/users/bheisler/following{/other_user}", "gists_url": "https://api.github.com/users/bheisler/gists{/gist_id}", "starred_url": "https://api.github.com/users/bheisler/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bheisler/subscriptions", "organizations_url": "https://api.github.com/users/bheisler/orgs", "repos_url": "https://api.github.com/users/bheisler/repos", "events_url": "https://api.github.com/users/bheisler/events{/privacy}", "received_events_url": "https://api.github.com/users/bheisler/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 203429200, "node_id": "MDU6TGFiZWwyMDM0MjkyMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-high", "name": "P-high", "color": "eb6420", "default": false, "description": "High priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 15, "created_at": "2018-03-24T17:13:52Z", "updated_at": "2018-04-10T13:15:48Z", "closed_at": "2018-04-10T13:15:48Z", "author_association": "NONE", "active_lock_reason": null, "body": "A user reported this to Criterion.rs - https://github.com/japaric/criterion.rs/issues/133\r\n\r\nThe short version is this - when the user's test crate's benchmarks are run on 1.24.0 or newer, Criterion.rs calculates some values incorrectly even though the code looks correct to me. They claim to have reproduced this behavior on Arch Linux, Windows and Raspbian. I have only been able to confirm it on Windows. Each of us has confirmed this behavior on multiple machines.\r\n\r\nI was initially reluctant to call this a miscompilation, but when I started investigating it, any change I made caused the bug to stop happening - inserting println's, or even pushing values into a vector and printing them later caused the bug to disappear. Eventually I tried simply adding a call to `test::black_box`, which should have no observable effect on the code except to inhibit certain compiler optimizations. That also caused the bug to stop occurring. It may still be a bug in my code, but if so I can't find it.\r\n\r\nI've tried to create a minimal test case, but was unsuccessful. This bug is quite fragile.\r\n\r\nSteps to reproduce:\r\n* Clone https://github.com/mbillingr/criterion-test.rs\r\n* Edit the Cargo.toml file to disable the default features for `criterion` (this isn't necessary but will save some compilation time)\r\n* With `1.23.0-x86_64-pc-windows-msvc`, run `cargo bench --bench my_benchmark -- --verbose`.\r\n  * Criterion.rs will run two benchmarks and report two iteration counts. The second should be significantly smaller than the first - this is the desired behavior. For example:\r\n```\r\nBenchmarking fib 1: Collecting 100 samples in estimated 1.0000 s (2469702500 iterations)\r\n...\r\nBenchmarking fib 2: Collecting 100 samples in estimated 1.0000 s (132784700 iterations)\r\n```\r\n* Switch to 1.24.1 and run the benchmark command again. Note that this time, the second iteration count is roughly the same as the first (this is the unexpected behavior):\r\n```\r\nBenchmarking fib 1: Collecting 100 samples in estimated 1.0000 s (2518899600 iterations)\r\n...\r\nBenchmarking fib 2: Collecting 100 samples in estimated 1.0000 s (2514900000 iterations)\r\n```\r\n* Optional: Switch to a nightly compiler and verify that the unexpected behavior persists. Clone the `rustc_fix` branch of https://github.com/japaric/criterion.rs and modify the Cargo.toml file of `criterion-test.rs` to use that instead. This patch merely enables the `test` feature/crate and inserts one call to `test::black_box` in `routine.rs:warm_up`. Verify that the expected behavior is restored.", "closed_by": {"login": "bheisler", "id": 1616938, "node_id": "MDQ6VXNlcjE2MTY5Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1616938?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bheisler", "html_url": "https://github.com/bheisler", "followers_url": "https://api.github.com/users/bheisler/followers", "following_url": "https://api.github.com/users/bheisler/following{/other_user}", "gists_url": "https://api.github.com/users/bheisler/gists{/gist_id}", "starred_url": "https://api.github.com/users/bheisler/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bheisler/subscriptions", "organizations_url": "https://api.github.com/users/bheisler/orgs", "repos_url": "https://api.github.com/users/bheisler/repos", "events_url": "https://api.github.com/users/bheisler/events{/privacy}", "received_events_url": "https://api.github.com/users/bheisler/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/49336/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/49336/timeline", "performed_via_github_app": null, "state_reason": "completed"}