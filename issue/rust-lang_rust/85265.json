{"url": "https://api.github.com/repos/rust-lang/rust/issues/85265", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/85265/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/85265/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/85265/events", "html_url": "https://github.com/rust-lang/rust/issues/85265", "id": 891201275, "node_id": "MDU6SXNzdWU4OTEyMDEyNzU=", "number": 85265, "title": "Basic vectorization performance regression from 1.48.0 onwards", "user": {"login": "shampoofactory", "id": 56542103, "node_id": "MDQ6VXNlcjU2NTQyMTAz", "avatar_url": "https://avatars.githubusercontent.com/u/56542103?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shampoofactory", "html_url": "https://github.com/shampoofactory", "followers_url": "https://api.github.com/users/shampoofactory/followers", "following_url": "https://api.github.com/users/shampoofactory/following{/other_user}", "gists_url": "https://api.github.com/users/shampoofactory/gists{/gist_id}", "starred_url": "https://api.github.com/users/shampoofactory/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shampoofactory/subscriptions", "organizations_url": "https://api.github.com/users/shampoofactory/orgs", "repos_url": "https://api.github.com/users/shampoofactory/repos", "events_url": "https://api.github.com/users/shampoofactory/events{/privacy}", "received_events_url": "https://api.github.com/users/shampoofactory/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}, {"id": 203429200, "node_id": "MDU6TGFiZWwyMDM0MjkyMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-high", "name": "P-high", "color": "eb6420", "default": false, "description": "High priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 18, "created_at": "2021-05-13T16:51:09Z", "updated_at": "2022-03-04T18:34:57Z", "closed_at": "2022-03-04T18:34:56Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Hi all. The compiler output for the test cases below is efficiently handled in 1.47. However, it has since been progressively unraveling into something quite awkward. This trend occurs on both x64 and ARM targets. All examples are compiled with `-C opt-level=3  -C lto=fat -C codegen-units=1`.\r\n\r\n### Code\r\n\r\n```rust\r\npub fn case_1(a: [f32; 4], b: [f32; 4]) -> [f32; 4] {\r\n    [\r\n        a[0] + b[0],\r\n        a[1] + b[1],\r\n        a[2] + b[2],\r\n        a[3] + b[3],\r\n    ]\r\n}\r\n\r\npub fn case_2(a: [f32; 4], b: [f32; 4]) -> [f32; 4] {\r\n    let mut c = [0.0; 4];\r\n    for i in 0..4 {\r\n        c[i] = a[i] + b[i];\r\n    }\r\n    c\r\n}\r\n```\r\n\r\n### 1.47.0 - Ok\r\n\r\nhttps://rust.godbolt.org/z/33WhfM3n8\r\n\r\n```asm\r\nexample::case_1:\r\n        mov     rax, rdi\r\n        vmovups xmm0, xmmword ptr [rsi]\r\n        vaddps  xmm0, xmm0, xmmword ptr [rdx]\r\n        vmovups xmmword ptr [rdi], xmm0\r\n        ret\r\n\r\nexample::case_2:\r\n        mov     rax, rdi\r\n        vmovups xmm0, xmmword ptr [rsi]\r\n        vaddps  xmm0, xmm0, xmmword ptr [rdx]\r\n        vmovups xmmword ptr [rdi], xmm0\r\n        ret\r\n```\r\n\r\n### 1.48.0 - Regression case_1\r\n\r\nhttps://rust.godbolt.org/z/bqEre5dx5\r\n\r\n```asm\r\nexample::case_1:\r\n        vmovss  xmm0, dword ptr [rdi]\r\n        vaddss  xmm0, xmm0, dword ptr [rsi]\r\n        vmovss  xmm1, dword ptr [rdi + 4]\r\n        vaddss  xmm1, xmm1, dword ptr [rsi + 4]\r\n        vmovsd  xmm2, qword ptr [rdi + 8]\r\n        vmovsd  xmm3, qword ptr [rsi + 8]\r\n        vaddps  xmm2, xmm2, xmm3\r\n        vmovd   eax, xmm0\r\n        vmovd   ecx, xmm1\r\n        vextractps      esi, xmm2, 0\r\n        vextractps      edx, xmm2, 1\r\n        shl     rdx, 32\r\n        or      rdx, rsi\r\n        shl     rcx, 32\r\n        or      rax, rcx\r\n        ret\r\n\r\nexample::case_2:\r\n        vmovups xmm0, xmmword ptr [rdi]\r\n        vaddps  xmm0, xmm0, xmmword ptr [rsi]\r\n        vmovq   rax, xmm0\r\n        vpextrq rdx, xmm0, 1\r\n        ret\r\n```\r\n\r\n### 1.50.0 - Regression case_1 and case_2\r\n\r\nhttps://rust.godbolt.org/z/Pj399ezPq\r\n\r\n```asm\r\nexample::case_1:\r\n        vmovd   xmm0, esi\r\n        shr     rsi, 32\r\n        vmovd   xmm1, edi\r\n        shr     rdi, 32\r\n        vpinsrd xmm1, xmm1, edi, 1\r\n        vmovd   xmm2, esi\r\n        vmovd   xmm3, edx\r\n        shr     rdx, 32\r\n        vpinsrd xmm3, xmm3, edx, 1\r\n        vaddps  xmm1, xmm1, xmm3\r\n        vmovd   xmm3, ecx\r\n        shr     rcx, 32\r\n        vaddss  xmm0, xmm0, xmm3\r\n        vmovd   xmm3, ecx\r\n        vaddss  xmm2, xmm2, xmm3\r\n        vmovd   edx, xmm0\r\n        vmovd   eax, xmm2\r\n        shl     rax, 32\r\n        or      rdx, rax\r\n        vxorps  xmm0, xmm0, xmm0\r\n        vblendps        xmm0, xmm1, xmm0, 2\r\n        vmovq   rcx, xmm0\r\n        vmovshdup       xmm0, xmm1\r\n        vmovq   rax, xmm0\r\n        shl     rax, 32\r\n        or      rax, rcx\r\n        ret\r\n\r\nexample::case_2:\r\n        vmovq   xmm0, rcx\r\n        vmovq   xmm1, rdx\r\n        vpunpcklqdq     xmm0, xmm1, xmm0\r\n        vmovq   xmm1, rsi\r\n        vmovq   xmm2, rdi\r\n        vpunpcklqdq     xmm1, xmm2, xmm1\r\n        vaddps  xmm0, xmm1, xmm0\r\n        vmovq   rax, xmm0\r\n        vpextrq rdx, xmm0, 1\r\n        ret\r\n```\r\n\r\n### 1.52.0 - Further regression case_2\r\n\r\nhttps://rust.godbolt.org/z/KsvbW5vhW\r\n\r\n```asm\r\nexample::case_1:\r\n        vmovd   xmm0, esi\r\n        shr     rsi, 32\r\n        vmovd   xmm1, edi\r\n        shr     rdi, 32\r\n        vpinsrd xmm1, xmm1, edi, 1\r\n        vmovd   xmm2, esi\r\n        vmovd   xmm3, edx\r\n        shr     rdx, 32\r\n        vpinsrd xmm3, xmm3, edx, 1\r\n        vaddps  xmm1, xmm1, xmm3\r\n        vmovd   xmm3, ecx\r\n        shr     rcx, 32\r\n        vaddss  xmm0, xmm0, xmm3\r\n        vmovd   xmm3, ecx\r\n        vaddss  xmm2, xmm2, xmm3\r\n        vmovd   edx, xmm0\r\n        vmovd   eax, xmm2\r\n        shl     rax, 32\r\n        or      rdx, rax\r\n        vxorps  xmm0, xmm0, xmm0\r\n        vblendps        xmm0, xmm0, xmm1, 1\r\n        vmovq   rcx, xmm0\r\n        vmovshdup       xmm0, xmm1\r\n        vmovq   rax, xmm0\r\n        shl     rax, 32\r\n        or      rax, rcx\r\n        ret\r\n\r\nexample::case_2:\r\n        mov     rax, rsi\r\n        shld    rax, rdi, 32\r\n        vmovd   xmm0, esi\r\n        shr     rsi, 32\r\n        vmovq   xmm1, rax\r\n        vmovq   xmm2, rsi\r\n        vpunpckldq      xmm1, xmm2, xmm1\r\n        vmovd   xmm2, ecx\r\n        vaddss  xmm0, xmm0, xmm2\r\n        vmovd   xmm2, edx\r\n        shrd    rdx, rcx, 32\r\n        shr     rcx, 32\r\n        vmovq   xmm3, rdx\r\n        vmovq   xmm4, rcx\r\n        vpunpckldq      xmm3, xmm4, xmm3\r\n        vmovd   xmm4, edi\r\n        vaddps  xmm1, xmm1, xmm3\r\n        vaddps  xmm2, xmm2, xmm4\r\n        vextractps      eax, xmm2, 0\r\n        vmovd   ecx, xmm0\r\n        vextractps      edx, xmm1, 0\r\n        vextractps      esi, xmm1, 1\r\n        shl     rsi, 32\r\n        shl     rdx, 32\r\n        or      rdx, rcx\r\n        or      rax, rsi\r\n        ret\r\n```", "closed_by": {"login": "workingjubilee", "id": 46493976, "node_id": "MDQ6VXNlcjQ2NDkzOTc2", "avatar_url": "https://avatars.githubusercontent.com/u/46493976?v=4", "gravatar_id": "", "url": "https://api.github.com/users/workingjubilee", "html_url": "https://github.com/workingjubilee", "followers_url": "https://api.github.com/users/workingjubilee/followers", "following_url": "https://api.github.com/users/workingjubilee/following{/other_user}", "gists_url": "https://api.github.com/users/workingjubilee/gists{/gist_id}", "starred_url": "https://api.github.com/users/workingjubilee/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/workingjubilee/subscriptions", "organizations_url": "https://api.github.com/users/workingjubilee/orgs", "repos_url": "https://api.github.com/users/workingjubilee/repos", "events_url": "https://api.github.com/users/workingjubilee/events{/privacy}", "received_events_url": "https://api.github.com/users/workingjubilee/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/85265/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/85265/timeline", "performed_via_github_app": null, "state_reason": "completed"}