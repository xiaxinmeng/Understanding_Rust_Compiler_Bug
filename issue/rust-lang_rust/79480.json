{"url": "https://api.github.com/repos/rust-lang/rust/issues/79480", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/79480/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/79480/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/79480/events", "html_url": "https://github.com/rust-lang/rust/issues/79480", "id": 752499729, "node_id": "MDU6SXNzdWU3NTI0OTk3Mjk=", "number": 79480, "title": "BufReader reads limited by the size of the internal buffer", "user": {"login": "K0bin", "id": 1131720, "node_id": "MDQ6VXNlcjExMzE3MjA=", "avatar_url": "https://avatars.githubusercontent.com/u/1131720?v=4", "gravatar_id": "", "url": "https://api.github.com/users/K0bin", "html_url": "https://github.com/K0bin", "followers_url": "https://api.github.com/users/K0bin/followers", "following_url": "https://api.github.com/users/K0bin/following{/other_user}", "gists_url": "https://api.github.com/users/K0bin/gists{/gist_id}", "starred_url": "https://api.github.com/users/K0bin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/K0bin/subscriptions", "organizations_url": "https://api.github.com/users/K0bin/orgs", "repos_url": "https://api.github.com/users/K0bin/repos", "events_url": "https://api.github.com/users/K0bin/events{/privacy}", "received_events_url": "https://api.github.com/users/K0bin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}, {"id": 2238437210, "node_id": "MDU6TGFiZWwyMjM4NDM3MjEw", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-io", "name": "A-io", "color": "f7e101", "default": false, "description": "Area: std::io, std::fs, std::net and std::path"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2020-11-27T23:06:12Z", "updated_at": "2020-12-01T20:00:34Z", "closed_at": "2020-12-01T20:00:34Z", "author_association": "NONE", "active_lock_reason": null, "body": "When using a BufReader it is not possible to read more data in one call than what can fit into the internal buffer unless that buffer is empty.\r\n\r\nI tried this code:\r\n\r\n```rust\r\nlet file = File::open(\"PATH TO BIG FILE\").unwrap();\r\nlet mut reader = BufReader::new(file);\r\nlet mut ignore = vec![0u8; 2];\r\nreader.read(&mut ignore);\r\nlet mut buffer = vec![0u8; 12525];\r\nlet read = reader.read(&mut buffer).unwrap();\r\nprintln!(\"expected: {}, got {}\", buffer.len(), read);\r\n```\r\n\r\nI expected to see this happen: I would expect the BufReader to read 12525 bytes as both my buffer is big enough and the reader is more than that number of bytes away from the end of the file.\r\n\r\nInstead, this happened: The BufReader only reads 8190 bytes.\r\nInterestingly, the bug doesn't occur if I don't do that initial read. Making the BufReader discard its internal buffer (with #68559) also works around the issue.\r\n\r\nI think [this line](https://github.com/rust-lang/rust/blob/master/library/std/src/io/buffered/bufreader.rs#L262) is incorrect\r\nand should discard the buffer whenever it's trying to read more data than can be fit in remainder of the current buffer.\r\n\r\n### Meta\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.46.0 (04488afe3 2020-08-24)\r\nbinary: rustc\r\ncommit-hash: 04488afe34512aa4c33566eb16d8c912a3ae04f9\r\ncommit-date: 2020-08-24\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.46.0\r\nLLVM version: 10.0\r\n```\r\n\r\nI can also reproduce it with nightly.\r\n```\r\nrustc 1.49.0-nightly (98edd1fbf 2020-10-06)\r\nbinary: rustc\r\ncommit-hash: 98edd1fbf8a68977a2a7c1312eb1ebff80515a92\r\ncommit-date: 2020-10-06\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.49.0-nightly\r\nLLVM version: 11.0\r\n```\r\n", "closed_by": {"login": "K0bin", "id": 1131720, "node_id": "MDQ6VXNlcjExMzE3MjA=", "avatar_url": "https://avatars.githubusercontent.com/u/1131720?v=4", "gravatar_id": "", "url": "https://api.github.com/users/K0bin", "html_url": "https://github.com/K0bin", "followers_url": "https://api.github.com/users/K0bin/followers", "following_url": "https://api.github.com/users/K0bin/following{/other_user}", "gists_url": "https://api.github.com/users/K0bin/gists{/gist_id}", "starred_url": "https://api.github.com/users/K0bin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/K0bin/subscriptions", "organizations_url": "https://api.github.com/users/K0bin/orgs", "repos_url": "https://api.github.com/users/K0bin/repos", "events_url": "https://api.github.com/users/K0bin/events{/privacy}", "received_events_url": "https://api.github.com/users/K0bin/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/79480/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/79480/timeline", "performed_via_github_app": null, "state_reason": "completed"}