{"url": "https://api.github.com/repos/rust-lang/rust/issues/82400", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/82400/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/82400/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/82400/events", "html_url": "https://github.com/rust-lang/rust/issues/82400", "id": 813492955, "node_id": "MDU6SXNzdWU4MTM0OTI5NTU=", "number": 82400, "title": "Accepting Incoming TCP Connections fails on Android", "user": {"login": "wngr", "id": 7816612, "node_id": "MDQ6VXNlcjc4MTY2MTI=", "avatar_url": "https://avatars.githubusercontent.com/u/7816612?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wngr", "html_url": "https://github.com/wngr", "followers_url": "https://api.github.com/users/wngr/followers", "following_url": "https://api.github.com/users/wngr/following{/other_user}", "gists_url": "https://api.github.com/users/wngr/gists{/gist_id}", "starred_url": "https://api.github.com/users/wngr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wngr/subscriptions", "organizations_url": "https://api.github.com/users/wngr/orgs", "repos_url": "https://api.github.com/users/wngr/repos", "events_url": "https://api.github.com/users/wngr/events{/privacy}", "received_events_url": "https://api.github.com/users/wngr/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 25141820, "node_id": "MDU6TGFiZWwyNTE0MTgyMA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-android", "name": "O-android", "color": "6e6ec0", "default": false, "description": "Operating system: Android"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/rust-lang/rust/milestones/76", "html_url": "https://github.com/rust-lang/rust/milestone/76", "labels_url": "https://api.github.com/repos/rust-lang/rust/milestones/76/labels", "id": 5945776, "node_id": "MDk6TWlsZXN0b25lNTk0NTc3Ng==", "number": 76, "title": "1.49.0", "description": "", "creator": {"login": "rustbot", "id": 47979223, "node_id": "MDQ6VXNlcjQ3OTc5MjIz", "avatar_url": "https://avatars.githubusercontent.com/u/47979223?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rustbot", "html_url": "https://github.com/rustbot", "followers_url": "https://api.github.com/users/rustbot/followers", "following_url": "https://api.github.com/users/rustbot/following{/other_user}", "gists_url": "https://api.github.com/users/rustbot/gists{/gist_id}", "starred_url": "https://api.github.com/users/rustbot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rustbot/subscriptions", "organizations_url": "https://api.github.com/users/rustbot/orgs", "repos_url": "https://api.github.com/users/rustbot/repos", "events_url": "https://api.github.com/users/rustbot/events{/privacy}", "received_events_url": "https://api.github.com/users/rustbot/received_events", "type": "User", "site_admin": false}, "open_issues": 1, "closed_issues": 726, "state": "closed", "created_at": "2020-10-03T04:26:42Z", "updated_at": "2022-12-20T17:09:17Z", "due_on": "2020-12-31T08:00:00Z", "closed_at": "2020-12-31T14:50:57Z"}, "comments": 18, "created_at": "2021-02-22T13:17:22Z", "updated_at": "2021-03-09T12:29:04Z", "closed_at": "2021-03-09T12:29:04Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a regression report! \ud83d\udc1b A regression is something that changed between versions of Rust but was not supposed to.\r\n\r\nPlease provide a short summary of the regression, along with any information you feel is relevant to replicate it.\r\n-->\r\n\r\nStarting with Android Oreo (8), Android started using a seccomp based filter approach to syscalls, explicitly allowing syscalls, see https://android-developers.googleblog.com/2017/07/seccomp-filter-in-android-o.html.\r\nhttps://android.googlesource.com/platform/bionic.git/+/master/libc/SYSCALLS.TXT enumerates the allowed syscalls.\r\nThis means, that dispatching a generic syscall mechanism as introduced with this PR #78572 will result in a panic.\r\n\r\nOn top of that, I found that older versions of Android, such as Android 6, will return `Function not implemented (os error 38)` for this syscall.\r\n**My tests showed that this only happens on x86, although I can't explain why.**\r\n\r\nAs there's no way to detect the target android API level, the safest way would probably be to always use the `accept` syscall, and remove the special handling of the `accept4` syscall. This could also be just guarded for x86 -- but would be happy to get an explanation on why it's only on that architecture (see https://github.com/tokio-rs/mio/pull/1446).\r\n\r\nI have tested this with both real devices as well as Android emulators.\r\n\r\n### Code\r\n\r\nI tried this code:\r\n\r\n```rust\r\nuse std::net::TcpListener;\r\n\r\nlet listener = TcpListener::bind(\"0.0.0.0:8080\").unwrap();\r\nmatch listener.accept() {\r\n    Ok((_socket, addr)) => println!(\"new client: {:?}\", addr),\r\n    Err(e) => println!(\"couldn't get client: {:?}\", e),\r\n}\r\n```\r\n\r\nand poked it with `telnet <android_host> 8080`.\r\n\r\nI expected to see this happen: `accept` returns `Ok(_)`\r\n\r\nInstead, this happened:\r\n* Android >= 8.0: panic because of seccomp\r\n```\r\n02-22 13:14:23.287  6015  6041 F my.app.DEBUG: Build fingerprint: 'Android/sdk_phone_x86/generic_x86:10/QPP6.190730.005.B1/5775370:userdebug/test-keys'\r\n02-22 13:14:23.287  6015  6041 F my.app.DEBUG: Revision: '0'\r\n02-22 13:14:23.287  6015  6041 F my.app.DEBUG: ABI: 'x86'\r\n02-22 13:14:23.288  6015  6041 F my.app.DEBUG: Timestamp: 2021-02-22 13:14:23+0000\r\n02-22 13:14:23.288  6015  6041 F my.app.DEBUG: pid: 6015, tid: 6057, name: tokio-runtime-w  >>> my.app:background_services <<<\r\n02-22 13:14:23.288  6015  6041 F my.app.DEBUG: uid: 10103\r\n02-22 13:14:23.288  6015  6041 F my.app.DEBUG: signal 31 (SIGSYS), code 1 (SYS_SECCOMP), fault addr --------\r\n02-22 13:14:23.288  6015  6041 F my.app.DEBUG: Cause: seccomp prevented call to disallowed x86 system call 364\r\n02-22 13:14:23.289  6015  6041 F my.app.DEBUG: Abort message: 'Fatal signal 31 (SIGSYS), code 1 (SYS_SECCOMP) in tid 4784 (tokio-runtime-w), pid 4735 (ground_services)'\r\n02-22 13:14:23.289  6015  6041 F my.app.DEBUG: eax 0000016c  ebx 0000003f  ecx bfccfdb0  edx bfccfd6c\r\n02-22 13:14:23.289  6015  6041 F my.app.DEBUG: edi eae65c34  esi 00080000\r\n02-22 13:14:23.289  6015  6041 F my.app.DEBUG: ebp bfccfd88  esp bfccfd18  eip ee70cad9\r\n\r\n\r\n```\r\n* Android < 8.0: strace output\r\n```\r\n[pid 10918] syscall_364(0x34, 0x9d5c9cf8, 0x9d5c9ca0, 0x80800, 0x9fda9dc8, 0x9fda9dc8 <unfinished ...>\r\n[pid 10918] <... syscall_364 resumed> ) = -1 (errno 38)\r\n```\r\nWhich translate to _Function not implemented_.\r\n\r\n### Version it worked on\r\n\r\n<!--\r\nProvide the most recent version this worked on, for example:\r\n\r\nIt most recently worked on: Rust 1.47\r\n-->\r\n\r\nIt most recently worked on: Rust 1.48\r\n\r\n### Version with regression\r\n\r\n<!--\r\nProvide the version you are using that has the regression.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\n rustc --version --verbose\r\nrustc 1.49.0 (e1884a8e3 2020-12-29)\r\nbinary: rustc\r\ncommit-hash: e1884a8e3c3e813aada8254edfa120e85bf5ffca\r\ncommit-date: 2020-12-29\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.49.0\r\n\r\n```\r\n\r\n<!--\r\nDid the compiler crash? If so, please provide a backtrace.\r\n-->\r\n\r\n### Backtrace\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```\r\n<backtrace>\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n<!--\r\nIf you know when this regression occurred, please add a line like below, replacing `{channel}` with one of stable, beta, or nightly.\r\n\r\n@rustbot modify labels: +regression-from-stable-to-{channel} -regression-untriaged\r\n-->\r\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/82400/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/82400/timeline", "performed_via_github_app": null, "state_reason": "completed"}