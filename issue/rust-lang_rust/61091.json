{"url": "https://api.github.com/repos/rust-lang/rust/issues/61091", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/61091/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/61091/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/61091/events", "html_url": "https://github.com/rust-lang/rust/issues/61091", "id": 447807544, "node_id": "MDU6SXNzdWU0NDc4MDc1NDQ=", "number": 61091, "title": "NetBSD can no longer cross-compile rust since 1.34.2", "user": {"login": "he32", "id": 1199501, "node_id": "MDQ6VXNlcjExOTk1MDE=", "avatar_url": "https://avatars.githubusercontent.com/u/1199501?v=4", "gravatar_id": "", "url": "https://api.github.com/users/he32", "html_url": "https://github.com/he32", "followers_url": "https://api.github.com/users/he32/followers", "following_url": "https://api.github.com/users/he32/following{/other_user}", "gists_url": "https://api.github.com/users/he32/gists{/gist_id}", "starred_url": "https://api.github.com/users/he32/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/he32/subscriptions", "organizations_url": "https://api.github.com/users/he32/orgs", "repos_url": "https://api.github.com/users/he32/repos", "events_url": "https://api.github.com/users/he32/events{/privacy}", "received_events_url": "https://api.github.com/users/he32/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 311417590, "node_id": "MDU6TGFiZWwzMTE0MTc1OTA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-netbsd", "name": "O-netbsd", "color": "6e6ec0", "default": false, "description": "Operating system: NetBSD"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2019-05-23T18:22:26Z", "updated_at": "2019-05-29T11:48:41Z", "closed_at": "2019-05-29T11:48:41Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I'm trying to maintain a package for `rust` in NetBSD's pkgsrc collection.\r\nI'm habitually cross-building the NetBSD armv7, sparc64, powerpc and i386 targets\r\ncross-built from NetBSD/amd64 8.0.\r\n\r\nThe last successful cross-build I managed to do was of 1.34.0.\r\nThe package itself has been upgraded to 1.34.2, and native builds on\r\ni386 (i686), amd64 and powerpc all manage to complete their builds.\r\nHowever, cross-builds from NetBSD/amd64 now all fail with a similar error\r\nto this:\r\n\r\n```\r\nrunning: \"/usr/pkgsrc/lang/rust/work/rust-bootstrap/bin/cargo\" \"rustdoc\" \"--target\" \"aarch64-unknown-netbsd\" \"-j\" \"4\" \"--release\" \"--frozen\" \"--features\" \"panic-unwind backtrace\" \"--manifest-path\" \"/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/src/libstd/Cargo.toml\" \"-Z\" \"unstable-options\" \"-p\" \"alloc\" \"--\" \"--markdown-css\" \"rust.css\" \"--markdown-no-toc\" \"--generate-redirect-pages\" \"--resource-suffix\" \"1.34.2\" \"--index-page\" \"/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/src/doc/index.md\"\r\n    Checking core v0.0.0 (/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/src/libcore)\r\n    Checking rustc-std-workspace-core v1.0.0 (/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/src/tools/rustc-std-workspace-core)\r\n    Checking compiler_builtins v0.1.5\r\n Documenting alloc v0.0.0 (/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/src/liballoc)\r\nShared object \"librustc_driver-54494e763183ca55.so\" not found\r\nerror: Could not document `alloc`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/build/bootstrap/debug/rustdoc --edition=2018 --crate-name alloc src/liballoc/lib.rs --target aarch64-unknown-netbsd -o /usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/build/x86_64-unknown-netbsd/stage1-std/aarch64-unknown-netbsd/doc --markdown-css rust.css --markdown-no-toc --generate-redirect-pages --resource-suffix 1.34.2 --index-page /usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/src/doc/index.md -L dependency=/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/build/x86_64-unknown-netbsd/stage1-std/aarch64-unknown-netbsd/release/deps -L dependency=/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/build/x86_64-unknown-netbsd/stage1-std/release/deps --extern compiler_builtins=/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/build/x86_64-unknown-netbsd/stage1-std/aarch64-unknown-netbsd/release/deps/libcompiler_builtins-2b037972dda02c94.rmeta --extern core=/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/build/x86_64-unknown-netbsd/stage1-std/aarch64-unknown-netbsd/release/deps/libcore-706ad47e00fa2bec.rmeta` (exit code: 1)\r\n\r\n\r\ncommand did not execute successfully: \"/usr/pkgsrc/lang/rust/work/rust-bootstrap/bin/cargo\" \"rustdoc\" \"--target\" \"aarch64-unknown-netbsd\" \"-j\" \"4\" \"--release\" \"--frozen\" \"--features\" \"panic-unwind backtrace\" \"--manifest-path\" \"/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/src/libstd/Cargo.toml\" \"-Z\" \"unstable-options\" \"-p\" \"alloc\" \"--\" \"--markdown-css\" \"rust.css\" \"--markdown-no-toc\" \"--generate-redirect-pages\" \"--resource-suffix\" \"1.34.2\" \"--index-page\" \"/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/src/doc/index.md\"\r\nexpected success, got: exit code: 101\r\n```\r\n\r\nIt makes no difference whether I'm using a bootstrap from 1.33.0 or 1.34.0 to start off the build.\r\n\r\nLooking at the build tree, I find `librustc_driver-54494e763183ca55.so` sitting in 2-3 directories, but apparently whatever executable or library is trying to use it can't find it:\r\n\r\n```\r\nd3: {30} find work -name librustc_driver-54494e763183ca55.so\r\nwork/rustc-1.34.2-src/build/x86_64-unknown-netbsd/stage1/lib/rustlib/x86_64-unknown-netbsd/lib/librustc_driver-54494e763183ca55.so\r\nwork/rustc-1.34.2-src/build/x86_64-unknown-netbsd/stage1-rustc/x86_64-unknown-netbsd/release/deps/librustc_driver-54494e763183ca55.so\r\nwork/rustc-1.34.2-src/build/x86_64-unknown-netbsd/stage2/lib/librustc_driver-54494e763183ca55.so\r\nd3: {31} \r\n```\r\n\r\nDoing a syscall trace reveals it's indeed `rustdoc` which searches for this library, and it tries a few different locations (via LD_LIBRARY_PATH? -- anyway, they're all failing):\r\n\r\n```\r\n/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/build/x86_64-unknown-netbsd/stage1/lib/librustc_driver-54494e763183ca55.so\r\n/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/build/x86_64-unknown-netbsd/stage1-std/aarch64-unknown-netbsd/release/deps/librustc_driver-54494e763183ca55.so\r\n/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/build/x86_64-unknown-netbsd/stage1-std/aarch64-unknown-netbsd/release/librustc_driver-54494e763183ca55.so\r\n/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/build/x86_64-unknown-netbsd/stage1/lib/rustlib/aarch64-unknown-netbsd/lib/librustc_driver-54494e763183ca55.so\r\n/usr/pkgsrc/lang/rust/work/rust-bootstrap/lib/librustc_driver-54494e763183ca55.so\r\n/usr/pkg/lib/librustc_driver-54494e763183ca55.so\r\n/usr/lib/librustc_driver-54494e763183ca55.so\r\n```\r\n\r\nIt appears `rustdoc` is doing `dlopen()` itself, because ldd on  `/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/build/bootstrap/debug/rustdoc` doesn't imply it's linked with that library:\r\n\r\n```\r\nd3: {28} ldd /usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/build/bootstrap/debug/rustdoc\r\n/usr/pkgsrc/lang/rust/work/rustc-1.34.2-src/build/bootstrap/debug/rustdoc:\r\n        -lpthread.1 => /usr/lib/libpthread.so.1\r\n        -lc.12 => /usr/lib/libc.so.12\r\n        -lgcc_s.1 => /usr/lib/libgcc_s.so.1\r\n        -lm.0 => /usr/lib/libm.so.0\r\nd3: {29} \r\n```\r\n\r\nThe RPATH of the built `rustdoc` (yes, NetBSD has a \"working\" RPATH) only includes the location it's going to use eventually (`/usr/pkg/lib`), and not any of the build dirs, but they're probably pointed to with `LD_LIBRARY_PATH`.\r\n\r\nI've looked over the diff between 1.34.0 and 1.34.2, and can't fathom what of those changes might trigger this observed difference in behaviour.  The diff between 1.33.0 and 1.34.0 is another matter (quite a bit larger to get a handle on).\r\n\r\nI'm receptive to hints suggesting what might be going on here.\r\n\r\nHave any of you managed to cross-build rust using 1.34.2 sources on other systems?\r\n", "closed_by": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/61091/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/61091/timeline", "performed_via_github_app": null, "state_reason": "completed"}