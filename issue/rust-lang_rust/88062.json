{"url": "https://api.github.com/repos/rust-lang/rust/issues/88062", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/88062/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/88062/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/88062/events", "html_url": "https://github.com/rust-lang/rust/issues/88062", "id": 971203012, "node_id": "MDU6SXNzdWU5NzEyMDMwMTI=", "number": 88062, "title": "Recursive Closure Fixed-Point Support or Error Message", "user": {"login": "0x182d4454fb211940", "id": 73496429, "node_id": "MDQ6VXNlcjczNDk2NDI5", "avatar_url": "https://avatars.githubusercontent.com/u/73496429?v=4", "gravatar_id": "", "url": "https://api.github.com/users/0x182d4454fb211940", "html_url": "https://github.com/0x182d4454fb211940", "followers_url": "https://api.github.com/users/0x182d4454fb211940/followers", "following_url": "https://api.github.com/users/0x182d4454fb211940/following{/other_user}", "gists_url": "https://api.github.com/users/0x182d4454fb211940/gists{/gist_id}", "starred_url": "https://api.github.com/users/0x182d4454fb211940/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/0x182d4454fb211940/subscriptions", "organizations_url": "https://api.github.com/users/0x182d4454fb211940/orgs", "repos_url": "https://api.github.com/users/0x182d4454fb211940/repos", "events_url": "https://api.github.com/users/0x182d4454fb211940/events{/privacy}", "received_events_url": "https://api.github.com/users/0x182d4454fb211940/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2021-08-15T19:06:04Z", "updated_at": "2021-08-15T20:13:59Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I tried this code (reduced from something in real code):\r\n\r\n```rust\r\nfn bar<F: Fn()>(f: F) {\r\n    bar(|| ());\r\n}\r\n\r\nfn main() {\r\n    bar(|| ());\r\n}\r\n```\r\n\r\nI expected this to work, but the compiler says: (note: line numbers are inaccurate)\r\n```\r\nerror: reached the recursion limit while instantiating `bar::<[closure@src/main.rs:18:9: 18:14]>`\r\n  --> src/main.rs:18:5\r\n   |\r\n18 |     bar(|| ());\r\n   |     ^^^^^^^^^^\r\n   |\r\nnote: `bar` defined here\r\n  --> src/main.rs:17:1\r\n   |\r\n17 | fn bar<F: Fn()>(f: F) {\r\n   | ^^^^^^^^^^^^^^^^^^^^^\r\n```\r\n\r\nAfter some reflection, I think I see the issue. When creating `bar::<main's closure>`, the complier \"writes\":\r\n\r\n```rust \r\nstruct MainClosure;\r\n\r\nfn bar_MAIN_CLOSURE(f: MainClosure) {\r\n    bar::<bar_MAIN_CLOSURE's closure>::(ClosureOfBarMainClosure);\r\n}\r\n```\r\n\r\nWhich then causes the compiler to instantiate this function, for which the closure is different again. So, it has to repeat this process, until it hits the recursion limit.\r\n\r\nI'm wondering if it's possible to identify the \"fixed point\", and intervene with something like:\r\n\r\n```rust\r\nstruct ClosureOfBarMainClosure;\r\n\r\nfn bar_CLOSURE_OF_bar_MAIN_CLOSURE(f: ClosureOfBarMainClosure) {\r\n    bar_CLOSURE_OF_bar_MAIN_CLOSURE(ClosureOfBarMainClosure);\r\n}\r\n\r\nstruct MainClosure;\r\n\r\nfn bar_MAIN_CLOSURE(f: MainClosure) {\r\n    bar_CLOSURE_OF_bar_MAIN_CLOSURE(ClosureOfBarMainClosure);\r\n}\r\n```\r\n\r\nThough I have no idea what would have to happen to get this to be implemented, so it might not be possible/pheasable/worth it. If not, I think it would make sense to have an error message with this, and a `rustc --explain` for it, as when I first encountered this I was quite confused.\r\n\r\nIn any case, the following (analogous to what I'm using now) replacement worked:\r\n\r\n```rust\r\nfn bar_fixed_point() -> impl Fn() {\r\n    || ()\r\n}\r\n\r\nfn bar<F: Fn()>(f: F) {\r\n    bar(bar_fixed_point());\r\n}\r\n\r\nfn main() {\r\n    bar(|| ());\r\n}\r\n```\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.56.0-nightly (5a19ffe1c 2021-08-13)\r\nbinary: rustc\r\ncommit-hash: 5a19ffe1c2b99d9e09706cc286aad1ec0868eddb\r\ncommit-date: 2021-08-13\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.56.0-nightly\r\nLLVM version: 12.0.1\r\n```\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/88062/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/88062/timeline", "performed_via_github_app": null, "state_reason": null}