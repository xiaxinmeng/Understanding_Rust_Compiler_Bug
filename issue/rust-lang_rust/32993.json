{"url": "https://api.github.com/repos/rust-lang/rust/issues/32993", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/32993/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/32993/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/32993/events", "html_url": "https://github.com/rust-lang/rust/issues/32993", "id": 148705693, "node_id": "MDU6SXNzdWUxNDg3MDU2OTM=", "number": 32993, "title": "liballoc_system's unix __rust_reallocate doesn't handle allocation failures for over-aligned types", "user": {"login": "froydnj", "id": 151096, "node_id": "MDQ6VXNlcjE1MTA5Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/151096?v=4", "gravatar_id": "", "url": "https://api.github.com/users/froydnj", "html_url": "https://github.com/froydnj", "followers_url": "https://api.github.com/users/froydnj/followers", "following_url": "https://api.github.com/users/froydnj/following{/other_user}", "gists_url": "https://api.github.com/users/froydnj/gists{/gist_id}", "starred_url": "https://api.github.com/users/froydnj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/froydnj/subscriptions", "organizations_url": "https://api.github.com/users/froydnj/orgs", "repos_url": "https://api.github.com/users/froydnj/repos", "events_url": "https://api.github.com/users/froydnj/events{/privacy}", "received_events_url": "https://api.github.com/users/froydnj/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2016-04-15T16:25:24Z", "updated_at": "2016-04-16T00:05:50Z", "closed_at": "2016-04-16T00:05:50Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The Unix implementation of `__rust_reallocate` in `liballoc_system` boils down to:\n\n``` rust\n    pub unsafe fn reallocate(ptr: *mut u8, old_size: usize, size: usize, align: usize) -> *mut u8 {\n        if align <= MIN_ALIGN {\n            libc::realloc(ptr as *mut libc::c_void, size as libc::size_t) as *mut u8\n        } else {\n            let new_ptr = allocate(size, align);\n            ptr::copy(ptr, new_ptr, cmp::min(size, old_size));\n            deallocate(ptr, old_size, align);\n            new_ptr\n        }\n    }\n```\n\nThe `else` branch of the conditional doesn't properly handle the case where `allocate` fails.  For comparison's sake, the Windows implementation says:\n\n``` rust\n    pub unsafe fn reallocate(ptr: *mut u8, _old_size: usize, size: usize, align: usize) -> *mut u8 {\n        if align <= MIN_ALIGN {\n            HeapReAlloc(GetProcessHeap(), 0, ptr as LPVOID, size as SIZE_T) as *mut u8\n        } else {\n            let header = get_header(ptr);\n            let new = HeapReAlloc(GetProcessHeap(),\n                                  0,\n                                  header.0 as LPVOID,\n                                  (size + align) as SIZE_T) as *mut u8;\n            if new.is_null() {\n                return new;\n            }\n            align_ptr(new, align)\n        }\n    }\n```\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/32993/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/32993/timeline", "performed_via_github_app": null, "state_reason": "completed"}