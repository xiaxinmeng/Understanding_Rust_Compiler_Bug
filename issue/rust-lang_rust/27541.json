{"url": "https://api.github.com/repos/rust-lang/rust/issues/27541", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/27541/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/27541/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/27541/events", "html_url": "https://github.com/rust-lang/rust/issues/27541", "id": 99269694, "node_id": "MDU6SXNzdWU5OTI2OTY5NA==", "number": 27541, "title": "Rust does not dynamically export functions in Android shared library", "user": {"login": "FuegoFro", "id": 463696, "node_id": "MDQ6VXNlcjQ2MzY5Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/463696?v=4", "gravatar_id": "", "url": "https://api.github.com/users/FuegoFro", "html_url": "https://github.com/FuegoFro", "followers_url": "https://api.github.com/users/FuegoFro/followers", "following_url": "https://api.github.com/users/FuegoFro/following{/other_user}", "gists_url": "https://api.github.com/users/FuegoFro/gists{/gist_id}", "starred_url": "https://api.github.com/users/FuegoFro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/FuegoFro/subscriptions", "organizations_url": "https://api.github.com/users/FuegoFro/orgs", "repos_url": "https://api.github.com/users/FuegoFro/repos", "events_url": "https://api.github.com/users/FuegoFro/events{/privacy}", "received_events_url": "https://api.github.com/users/FuegoFro/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 25141820, "node_id": "MDU6TGFiZWwyNTE0MTgyMA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-android", "name": "O-android", "color": "6e6ec0", "default": false, "description": "Operating system: Android"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2015-08-05T18:35:40Z", "updated_at": "2017-05-16T16:52:04Z", "closed_at": "2017-05-16T16:52:04Z", "author_association": "NONE", "active_lock_reason": null, "body": "I've been trying to compile Rust for Android and call exported JNI functions directly from Java, without a C++ shim in between. I found that if I marked a function as `#[no_mangle] pub extern \"C\"` it would show up in the symbol table just like JNI exported functions in C++, but it wasn't in the _dynamic_ symbol table. That is to say, when running `arm-linux-androideabi-nm` on the `.so` produced by Rust, the symbol was there, but when running the same command with the `-D` flag, the symbol wasn't there. Since Java looks up its JNI calls dynamically, this meant that it couldn't find the functions I was referencing.\n\nI was able to get around this by setting my linker to a wrapper script around `arm-linux-androideabi-gcc` which also passed in the additional `-Wl,--export-dynamic` flag. This solved the issue and allowed Android to find the functions. This is kind of a pain and, more importantly, only fixes the issue for me. It'd be great if, when compiling for Android, Rust automatically dynamically exported all `extern` functions. Alternatively, I could imagine some directive similar to `#[no_mangle]` that specifies that a function should be exported dynamically. Rust could use the `--Wl,--dynamic-list=` flag when invoking the linker to specify which functions should be exported dynamically.\n\nI'd be happy to create a sample project which demonstrates the problem if that would be useful for diagnosing it.\n\nI looked through the existing bugs and didn't see anything that described this exactly, but #10356 looked like it might be exhibiting the same problems.\n\nOnly somewhat relatedly, the deprecated [wiki](https://github.com/rust-lang/rust-wiki-backup/blob/master/Doc-building-for-android.md) for how to get Rust to compile for Android was a) quite hard to find and b) super useful. Is there a reason that has been deprecated? Is there a place to put this information (about the dynamic exports) such that other people will be able to find it easily if they're also trying to use Rust with Android's JNI?\n", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/27541/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/27541/timeline", "performed_via_github_app": null, "state_reason": "completed"}