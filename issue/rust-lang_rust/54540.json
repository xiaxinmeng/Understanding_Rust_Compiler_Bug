{"url": "https://api.github.com/repos/rust-lang/rust/issues/54540", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/54540/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/54540/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/54540/events", "html_url": "https://github.com/rust-lang/rust/issues/54540", "id": 363304673, "node_id": "MDU6SXNzdWUzNjMzMDQ2NzM=", "number": 54540, "title": "Exponential compile-time and type_length_limit blowup when nesting closure wrappers", "user": {"login": "vorner", "id": 11783500, "node_id": "MDQ6VXNlcjExNzgzNTAw", "avatar_url": "https://avatars.githubusercontent.com/u/11783500?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vorner", "html_url": "https://github.com/vorner", "followers_url": "https://api.github.com/users/vorner/followers", "following_url": "https://api.github.com/users/vorner/following{/other_user}", "gists_url": "https://api.github.com/users/vorner/gists{/gist_id}", "starred_url": "https://api.github.com/users/vorner/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vorner/subscriptions", "organizations_url": "https://api.github.com/users/vorner/orgs", "repos_url": "https://api.github.com/users/vorner/repos", "events_url": "https://api.github.com/users/vorner/events{/privacy}", "received_events_url": "https://api.github.com/users/vorner/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 64037154, "node_id": "MDU6TGFiZWw2NDAzNzE1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compiletime", "name": "I-compiletime", "color": "e11d21", "default": false, "description": "Problems and improvements with respect to compile times."}, {"id": 122406831, "node_id": "MDU6TGFiZWwxMjI0MDY4MzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-closures", "name": "A-closures", "color": "f7e101", "default": false, "description": "Area: closures (`|args| { .. }`)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 25, "created_at": "2018-09-24T20:19:48Z", "updated_at": "2021-03-12T18:19:04Z", "closed_at": "2021-03-12T18:18:29Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I think this is better explained by a code snippet:\r\n\r\n```rust\r\n#![recursion_limit=\"128\"]\r\n#![type_length_limit=\"67108864\"]\r\n\r\nfn main() {\r\n    let s = S19::default();\r\n    s.call_me((), &|()| ());\r\n}\r\n\r\ntrait CallMe<T: Copy> {\r\n    fn call_me<F: Fn(T)>(&self, t: T, f: &F);\r\n}\r\n\r\nimpl<T: Copy> CallMe<T> for () {\r\n    fn call_me<F: Fn(T)>(&self, _: T, _: &F) {}\r\n}\r\n\r\n#[derive(Default, Debug)]\r\nstruct S<T>(T, T);\r\n\r\nimpl<T: Copy, P: CallMe<T>> CallMe<T> for S<P> {\r\n    fn call_me<F: Fn(T)>(&self, t: T, f: &F) {\r\n        let wrapped = |t: _| {\r\n            f(t);\r\n        };\r\n        self.0.call_me(t, &wrapped);\r\n        self.1.call_me(t, &wrapped);\r\n    }\r\n}\r\n\r\ntype S0 = S<()>;\r\ntype S1 = S<S0>;\r\ntype S2 = S<S1>;\r\ntype S3 = S<S2>;\r\ntype S4 = S<S3>;\r\ntype S5 = S<S4>;\r\ntype S6 = S<S5>;\r\ntype S7 = S<S6>;\r\ntype S8 = S<S7>;\r\ntype S9 = S<S8>;\r\ntype S10 = S<S9>;\r\ntype S11 = S<S10>;\r\ntype S12 = S<S11>;\r\ntype S13 = S<S12>;\r\ntype S14 = S<S13>;\r\ntype S15 = S<S14>;\r\ntype S16 = S<S15>;\r\ntype S17 = S<S16>;\r\ntype S18 = S<S17>;\r\ntype S19 = S<S18>;\r\n```\r\n\r\nWhat it does is it creates a closure on each level, that wraps another received closure. With the number of levels the compile time and the needed `type_length_limit` grows exponentially.\r\n\r\nHowever, if I change the two calls to:\r\n\r\n```rust\r\nself.0.call_me(t, &f);\r\nself.1.call_me(t, &f);\r\n```\r\n\r\nthen the blow-up goes away and it compiles almost instantaneously (I tried it up to 120 levels, without increasing the type length limit), so nesting the `S` structures like this is OK. But if I change only one of the calls (or even remove it) and leave just one call to the wrapper, the blowup is still there. However, there seems to be nothing around the wrapper that should make it exponential \u2012 it's contains just one call to the wrapped f, has no captures, and if I look at the code, I still count only one distinct closure on each level.\r\n\r\nThe times I've measured with different number of levels:\r\n\r\n```\r\n11: 0.5\r\n12: 0.74\r\n13: 0.97\r\n14: 1.56\r\n15: 2.66\r\n16: 5.02\r\n17: 9.16\r\n18: 18.50\r\n19: 37.72\r\n```\r\n\r\nThis is happening both on stable and nightly:\r\n\r\n```\r\nrustc 1.30.0-nightly (63c75d375 2018-09-21)\r\nbinary: rustc\r\ncommit-hash: 63c75d375d76d0bcc586f9cb5520ced24bc58450\r\ncommit-date: 2018-09-21\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.30.0-nightly\r\nLLVM version: 8.0\r\n```\r\n\r\n@ishitatsuyuki mentioned at IRC that he would want to have a look.", "closed_by": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/54540/reactions", "total_count": 17, "+1": 17, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/54540/timeline", "performed_via_github_app": null, "state_reason": "completed"}