{"url": "https://api.github.com/repos/rust-lang/rust/issues/104442", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/104442/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/104442/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/104442/events", "html_url": "https://github.com/rust-lang/rust/issues/104442", "id": 1449672270, "node_id": "I_kwDOAAsO6M5WaD5O", "number": 104442, "title": "Dropped non-sync value reported as living until the end of scope", "user": {"login": "axos88", "id": 1281218, "node_id": "MDQ6VXNlcjEyODEyMTg=", "avatar_url": "https://avatars.githubusercontent.com/u/1281218?v=4", "gravatar_id": "", "url": "https://api.github.com/users/axos88", "html_url": "https://github.com/axos88", "followers_url": "https://api.github.com/users/axos88/followers", "following_url": "https://api.github.com/users/axos88/following{/other_user}", "gists_url": "https://api.github.com/users/axos88/gists{/gist_id}", "starred_url": "https://api.github.com/users/axos88/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/axos88/subscriptions", "organizations_url": "https://api.github.com/users/axos88/orgs", "repos_url": "https://api.github.com/users/axos88/repos", "events_url": "https://api.github.com/users/axos88/events{/privacy}", "received_events_url": "https://api.github.com/users/axos88/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2022-11-15T12:04:04Z", "updated_at": "2022-11-25T17:15:57Z", "closed_at": "2022-11-25T17:15:57Z", "author_association": "NONE", "active_lock_reason": null, "body": "        mem::drop(ipptr);\r\n        mem::drop(iphdr);\r\n\r\nI tried this code:\r\n\r\n```rust\r\n\r\n#[derive(Debug)]\r\n#[repr(packed)]\r\n//\r\nstruct IpHeader {\r\n    version_and_header_len: u8,\r\n    tos: u8,\r\n    tot_len: [u8; 2],\r\n    identification: [u8; 2],\r\n    flags_fragment_offset: [u8; 2],\r\n    ttl: u8,\r\n    protocol: u8,\r\n    checksum: [u8; 2],\r\n    source_address: [u8; 4],\r\n    destination_address: [u8; 4]\r\n}\r\n\r\n    pub async fn read(&mut self) -> Result<Vec<u8>, std::io::Error> {\r\n        let mut packet = Vec::with_capacity(1500);\r\n\r\n        if AsyncReadExt::take(&mut self.tcp, 20).read_to_end(&mut packet).await? < 20 {\r\n            Err(std::io::Error::new(ErrorKind::InvalidInput, \"IP Packet header too short\"))?\r\n        };\r\n\r\n        info!(\"HDR = {:X?}\", packet);\r\n\r\n        let ipptr = packet.as_ptr() as *const IpHeader;\r\n\r\n        let iphdr: &IpHeader = unsafe { &*ipptr };\r\n\r\n        info!(\"IP HDR [{}] = {:X?}\", mem::size_of_val(iphdr), iphdr);\r\n\r\n        let tot_len: u64 = iphdr.tot_len[0] as u64 * 256 + iphdr.tot_len[1] as u64;\r\n\r\n        mem::drop(ipptr);\r\n        mem::drop(iphdr);\r\n\r\n        if AsyncReadExt::take(&mut self.tcp, tot_len - 20).read_to_end(&mut packet).await? < tot_len - 20 {\r\n            Err(std::io::Error::new(ErrorKind::InvalidInput, \"IP Packet data too short\"))?\r\n        }\r\n\r\n        info!(\"FULL PACKET = {:X?}\", packet);\r\n\r\n        packet.shrink_to_fit();\r\n\r\n        return Ok(packet);\r\n    }\r\n```\r\n\r\nI expected to see this happen: *compiles*, the futurue should be `Send`, as the pointer is dropped before the call to await\r\n\r\nInstead, this happened: \r\n\r\n```\r\nerror: future cannot be sent between threads safely\r\n   --> src/main.rs:18:22\r\n    |\r\n18  |           tokio::spawn(async move {\r\n    |  ______________________^\r\n19  | |             handshake(&mut socket).await;\r\n20  | |             process(socket).await;\r\n21  | |         });\r\n    | |_________^ future created by async block is not `Send`\r\n    |\r\n    = help: within `impl Future<Output = ()>`, the trait `Send` is not implemented for `*const IpHeader`\r\nnote: future is not `Send` as this value is used across an await\r\n   --> src/packet_stream.rs:53:84\r\n    |\r\n42  |         let ipptr = packet.as_ptr() as *const IpHeader;\r\n    |             ----- has type `*const IpHeader` which is not `Send`\r\n...\r\n53  |         if AsyncReadExt::take(&mut self.tcp, tot_len - 20).read_to_end(&mut packet).await? < (tot_len - 20) as usize {\r\n    |                                                                                    ^^^^^^ await occurs here, with `ipptr` maybe used later\r\n...\r\n62  |     }\r\n    |     - `ipptr` is later dropped here\r\nnote: required by a bound in `tokio::spawn`\r\n   --> /home/akos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.21.2/src/task/spawn.rs:127:21\r\n    |\r\n127 |         T: Future + Send + 'static,\r\n    |                     ^^^^ required by this bound in `tokio::spawn`\r\n\r\n\r\n```\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.66.0-nightly (57f097ea2 2022-10-01)\r\nbinary: rustc\r\ncommit-hash: 57f097ea25f2c05f424fc9b9dc50dbd6d399845c\r\ncommit-date: 2022-10-01\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.66.0-nightly\r\nLLVM version: 15.0.2\r\n```\r\n\r\n</p>\r\n</details>\r\n", "closed_by": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/104442/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/104442/timeline", "performed_via_github_app": null, "state_reason": "completed"}