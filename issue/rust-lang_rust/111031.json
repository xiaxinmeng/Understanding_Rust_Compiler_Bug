{"url": "https://api.github.com/repos/rust-lang/rust/issues/111031", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/111031/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/111031/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/111031/events", "html_url": "https://github.com/rust-lang/rust/issues/111031", "id": 1690073720, "node_id": "I_kwDOAAsO6M5kvHp4", "number": 111031, "title": "DefId does not have a \"def_span\" for async function in separate package", "user": {"login": "undefinedvalue", "id": 5945229, "node_id": "MDQ6VXNlcjU5NDUyMjk=", "avatar_url": "https://avatars.githubusercontent.com/u/5945229?v=4", "gravatar_id": "", "url": "https://api.github.com/users/undefinedvalue", "html_url": "https://github.com/undefinedvalue", "followers_url": "https://api.github.com/users/undefinedvalue/followers", "following_url": "https://api.github.com/users/undefinedvalue/following{/other_user}", "gists_url": "https://api.github.com/users/undefinedvalue/gists{/gist_id}", "starred_url": "https://api.github.com/users/undefinedvalue/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/undefinedvalue/subscriptions", "organizations_url": "https://api.github.com/users/undefinedvalue/orgs", "repos_url": "https://api.github.com/users/undefinedvalue/repos", "events_url": "https://api.github.com/users/undefinedvalue/events{/privacy}", "received_events_url": "https://api.github.com/users/undefinedvalue/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 0, "created_at": "2023-04-30T20:37:51Z", "updated_at": "2023-05-04T16:54:50Z", "closed_at": "2023-05-04T16:54:50Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for finding an Internal Compiler Error! \ud83e\uddca  If possible, try to provide\r\na minimal verifiable example. You can read \"Rust Bug Minimization Patterns\" for\r\nhow to create smaller examples.\r\nhttp://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/\r\n-->\r\n\r\nI'm getting a `DefId does not have a \"def_span\"` ICE under when calling an async method for a trait defined in another package when using the qualified method syntax. It works if the trait is defined in the same package as main and it also works if using standard method syntax.\r\n\r\nThis happens on the most recent nightly compiler as of this posting.\r\n\r\nThis seems similar to but distinct from https://github.com/rust-lang/rust/issues/110206.\r\n\r\n### Code\r\nA minimal example with the following files exists at https://github.com/undefinedvalue/asynctest\r\n\r\nIn lib.rs of a package named \"asynclib\":\r\n```Rust\r\n#![allow(incomplete_features)]\r\n#![feature(async_fn_in_trait)]\r\n\r\npub trait SomeTrait {\r\n    async fn doasync(&mut self);\r\n}\r\n```\r\n\r\nIn main.rs of a package that depends on the \"asynclib\":\r\n```Rust\r\n#![allow(incomplete_features)]\r\n#![feature(async_fn_in_trait)]\r\n\r\nfn main() {\r\n    asynclib::SomeTrait::doasync(&mut Foo);\r\n}\r\n\r\nstruct Foo;\r\n\r\nimpl asynclib::SomeTrait for Foo {\r\n    async fn doasync(&mut self) {\r\n    }\r\n}\r\n```\r\n\r\nNote: It works if instead `main()` is this:\r\n```Rust\r\nuse asynclib::SomeTrait;\r\nFoo.doasync();\r\n```\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.71.0-nightly (87b1f891e 2023-04-29)\r\nbinary: rustc\r\ncommit-hash: 87b1f891ea76713462cfc5a15137a8fe2b24ecc2\r\ncommit-date: 2023-04-29\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.71.0-nightly\r\nLLVM version: 16.0.2\r\n```\r\n\r\n### Error output\r\n\r\n```\r\nthread 'rustc' panicked at 'DefId(20:6 ~ asynclib[e66f]::SomeTrait::doasync::{opaque#0}) does not have a \"def_span\"', compiler/rustc_metadata/src/rmeta/decoder/cstore_impl.rs:205:1\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary><strong>Backtrace</strong></summary>\r\n<p>\r\n\r\n```\r\n   Compiling asyncmain v0.0.0 (/home/anna/workspace/asynctest/asyncmain)\r\nthread 'rustc' panicked at 'DefId(20:6 ~ asynclib[e66f]::SomeTrait::doasync::{opaque#0}) does not have a \"def_span\"', compiler/rustc_metadata/src/rmeta/decoder/cstore_impl.rs:205:1\r\nstack backtrace:\r\n   0:     0x7fba39169331 - std::backtrace_rs::backtrace::libunwind::trace::h8355d489046eea9f\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/std/src/../../backtrace/src/backtrace/libunwind.rs:93:5\r\n   1:     0x7fba39169331 - std::backtrace_rs::backtrace::trace_unsynchronized::h5224130277357a26\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/std/src/../../backtrace/src/backtrace/mod.rs:66:5\r\n   2:     0x7fba39169331 - std::sys_common::backtrace::_print_fmt::hecc97c6ada6b37c5\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/std/src/sys_common/backtrace.rs:65:5\r\n   3:     0x7fba39169331 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::ha40fb82141ca69c7\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/std/src/sys_common/backtrace.rs:44:22\r\n   4:     0x7fba391c9f1f - core::fmt::rt::Argument::fmt::h3abab6d788a756e3\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/core/src/fmt/rt.rs:138:9\r\n   5:     0x7fba391c9f1f - core::fmt::write::h0d9c37369cab45ae\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/core/src/fmt/mod.rs:1094:21\r\n   6:     0x7fba3915c4a1 - std::io::Write::write_fmt::h48802cd26188edd4\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/std/src/io/mod.rs:1712:15\r\n   7:     0x7fba39169145 - std::sys_common::backtrace::_print::hd06dedc75707c8aa\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/std/src/sys_common/backtrace.rs:47:5\r\n   8:     0x7fba39169145 - std::sys_common::backtrace::print::he87158405a814203\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/std/src/sys_common/backtrace.rs:34:9\r\n   9:     0x7fba3916bc87 - std::panicking::default_hook::{{closure}}::hed443a04a4ae9143\r\n  10:     0x7fba3916ba74 - std::panicking::default_hook::hcb7845fe9b5159b6\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/std/src/panicking.rs:288:9\r\n  11:     0x7fba3c3ec015 - rustc_driver_impl[738786893c5490bf]::DEFAULT_HOOK::{closure#0}::{closure#0}\r\n  12:     0x7fba3916c3a7 - <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call::h1480dd017092d509\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/alloc/src/boxed.rs:1976:9\r\n  13:     0x7fba3916c3a7 - std::panicking::rust_panic_with_hook::he4834f7686de7b98\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/std/src/panicking.rs:695:13\r\n  14:     0x7fba3916c127 - std::panicking::begin_panic_handler::{{closure}}::ha2d182560a0fb060\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/std/src/panicking.rs:582:13\r\n  15:     0x7fba39169776 - std::sys_common::backtrace::__rust_end_short_backtrace::h2df9d74a88462a94\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/std/src/sys_common/backtrace.rs:150:18\r\n  16:     0x7fba3916be92 - rust_begin_unwind\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/std/src/panicking.rs:578:5\r\n  17:     0x7fba391c61c3 - core::panicking::panic_fmt::hdf51123d3e5c1099\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/core/src/panicking.rs:67:14\r\n  18:     0x7fba3c828e82 - rustc_metadata[ae0e66a2a2c113fb]::rmeta::decoder::cstore_impl::provide_extern::def_span::{closure#2}\r\n  19:     0x7fba3bd25f26 - rustc_metadata[ae0e66a2a2c113fb]::rmeta::decoder::cstore_impl::provide_extern::def_span\r\n  20:     0x7fba3acb60ed - rustc_query_system[34a9c542073df]::query::plumbing::try_execute_query::<rustc_query_impl[5c8c89bc676e7b7e]::queries::def_span, rustc_query_impl[5c8c89bc676e7b7e]::plumbing::QueryCtxt>\r\n  21:     0x7fba3acb396a - <rustc_query_impl[5c8c89bc676e7b7e]::Queries as rustc_middle[4a9d2aea1650cf38]::ty::query::QueryEngine>::def_span\r\n  22:     0x7fba3a9deefa - <rustc_infer[5d7b6307277651b3]::infer::InferCtxt>::infer_projection\r\n  23:     0x7fba3a9c990c - rustc_trait_selection[87bbd939b3c90e9c]::traits::project::normalize_projection_type\r\n  24:     0x7fba3a9c7365 - <rustc_trait_selection[87bbd939b3c90e9c]::traits::project::AssocTypeNormalizer as rustc_type_ir[1d3e9495482829d7]::fold::TypeFolder<rustc_middle[4a9d2aea1650cf38]::ty::context::TyCtxt>>::fold_ty\r\n  25:     0x7fba3a5d99db - <rustc_infer[5d7b6307277651b3]::infer::at::At as rustc_trait_selection[87bbd939b3c90e9c]::traits::project::NormalizeExt>::normalize::<rustc_middle[4a9d2aea1650cf38]::ty::sty::FnSig>\r\n  26:     0x7fba3a5be187 - <rustc_hir_typeck[e3c70be22799a2fb]::fn_ctxt::FnCtxt>::check_call\r\n  27:     0x7fba3aa8e99a - <rustc_hir_typeck[e3c70be22799a2fb]::fn_ctxt::FnCtxt>::check_expr_with_expectation_and_args\r\n  28:     0x7fba3aae463b - <rustc_hir_typeck[e3c70be22799a2fb]::fn_ctxt::FnCtxt>::check_block_with_expected\r\n  29:     0x7fba3aa8ef24 - <rustc_hir_typeck[e3c70be22799a2fb]::fn_ctxt::FnCtxt>::check_expr_with_expectation_and_args\r\n  30:     0x7fba3ac67d86 - <rustc_hir_typeck[e3c70be22799a2fb]::fn_ctxt::FnCtxt>::check_return_expr\r\n  31:     0x7fba3ac5f51e - rustc_hir_typeck[e3c70be22799a2fb]::check::check_fn\r\n  32:     0x7fba3ac484ea - rustc_hir_typeck[e3c70be22799a2fb]::typeck\r\n  33:     0x7fba3ac3d9c9 - rustc_query_system[34a9c542073df]::query::plumbing::try_execute_query::<rustc_query_impl[5c8c89bc676e7b7e]::queries::typeck, rustc_query_impl[5c8c89bc676e7b7e]::plumbing::QueryCtxt>\r\n  34:     0x7fba3bcfa05a - rustc_hir_typeck[e3c70be22799a2fb]::used_trait_imports\r\n  35:     0x7fba3b022aac - rustc_query_system[34a9c542073df]::query::plumbing::try_execute_query::<rustc_query_impl[5c8c89bc676e7b7e]::queries::used_trait_imports, rustc_query_impl[5c8c89bc676e7b7e]::plumbing::QueryCtxt>\r\n  36:     0x7fba3b8648d3 - rustc_hir_analysis[505c17fd5083e6d3]::check_crate\r\n  37:     0x7fba3b8576fe - rustc_interface[1da25c7cb643f6df]::passes::analysis\r\n  38:     0x7fba3bb68cef - rustc_query_system[34a9c542073df]::query::plumbing::try_execute_query::<rustc_query_impl[5c8c89bc676e7b7e]::queries::analysis, rustc_query_impl[5c8c89bc676e7b7e]::plumbing::QueryCtxt>\r\n  39:     0x7fba3bb68820 - <rustc_query_impl[5c8c89bc676e7b7e]::Queries as rustc_middle[4a9d2aea1650cf38]::ty::query::QueryEngine>::analysis\r\n  40:     0x7fba3b60d86a - <rustc_middle[4a9d2aea1650cf38]::ty::context::GlobalCtxt>::enter::<rustc_driver_impl[738786893c5490bf]::run_compiler::{closure#1}::{closure#2}::{closure#4}, core[af2acebbc2b23591]::result::Result<(), rustc_span[8cddaddefb760954]::ErrorGuaranteed>>\r\n  41:     0x7fba3b60cb6a - <rustc_interface[1da25c7cb643f6df]::interface::Compiler>::enter::<rustc_driver_impl[738786893c5490bf]::run_compiler::{closure#1}::{closure#2}, core[af2acebbc2b23591]::result::Result<core[af2acebbc2b23591]::option::Option<rustc_interface[1da25c7cb643f6df]::queries::Linker>, rustc_span[8cddaddefb760954]::ErrorGuaranteed>>\r\n  42:     0x7fba3b60abc1 - rustc_span[8cddaddefb760954]::set_source_map::<core[af2acebbc2b23591]::result::Result<(), rustc_span[8cddaddefb760954]::ErrorGuaranteed>, rustc_interface[1da25c7cb643f6df]::interface::run_compiler<core[af2acebbc2b23591]::result::Result<(), rustc_span[8cddaddefb760954]::ErrorGuaranteed>, rustc_driver_impl[738786893c5490bf]::run_compiler::{closure#1}>::{closure#0}::{closure#0}>\r\n  43:     0x7fba3b60a267 - std[b167bfecd85c8427]::sys_common::backtrace::__rust_begin_short_backtrace::<rustc_interface[1da25c7cb643f6df]::util::run_in_thread_pool_with_globals<rustc_interface[1da25c7cb643f6df]::interface::run_compiler<core[af2acebbc2b23591]::result::Result<(), rustc_span[8cddaddefb760954]::ErrorGuaranteed>, rustc_driver_impl[738786893c5490bf]::run_compiler::{closure#1}>::{closure#0}, core[af2acebbc2b23591]::result::Result<(), rustc_span[8cddaddefb760954]::ErrorGuaranteed>>::{closure#0}::{closure#0}, core[af2acebbc2b23591]::result::Result<(), rustc_span[8cddaddefb760954]::ErrorGuaranteed>>\r\n  44:     0x7fba3b609b85 - <<std[b167bfecd85c8427]::thread::Builder>::spawn_unchecked_<rustc_interface[1da25c7cb643f6df]::util::run_in_thread_pool_with_globals<rustc_interface[1da25c7cb643f6df]::interface::run_compiler<core[af2acebbc2b23591]::result::Result<(), rustc_span[8cddaddefb760954]::ErrorGuaranteed>, rustc_driver_impl[738786893c5490bf]::run_compiler::{closure#1}>::{closure#0}, core[af2acebbc2b23591]::result::Result<(), rustc_span[8cddaddefb760954]::ErrorGuaranteed>>::{closure#0}::{closure#0}, core[af2acebbc2b23591]::result::Result<(), rustc_span[8cddaddefb760954]::ErrorGuaranteed>>::{closure#1} as core[af2acebbc2b23591]::ops::function::FnOnce<()>>::call_once::{shim:vtable#0}\r\n  45:     0x7fba391768c5 - <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once::ha80838fe840f5c99\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/alloc/src/boxed.rs:1962:9\r\n  46:     0x7fba391768c5 - <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once::hb7b8292ae0f012c1\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/alloc/src/boxed.rs:1962:9\r\n  47:     0x7fba391768c5 - std::sys::unix::thread::Thread::new::thread_start::h64b218fd2c840776\r\n                               at /rustc/87b1f891ea76713462cfc5a15137a8fe2b24ecc2/library/std/src/sys/unix/thread.rs:108:17\r\n  48:     0x7fba38e90402 - start_thread\r\n                               at ./nptl/pthread_create.c:442:8\r\n  49:     0x7fba38f1f590 - __GI___clone3\r\n                               at ./misc/../sysdeps/unix/sysv/linux/x86_64/clone3.S:81\r\n  50:                0x0 - <unknown>\r\n\r\nerror: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&template=ice.md\r\n\r\nnote: rustc 1.71.0-nightly (87b1f891e 2023-04-29) running on x86_64-unknown-linux-gnu\r\n\r\nnote: compiler flags: --crate-type bin -C embed-bitcode=no -C debuginfo=2 -C incremental=[REDACTED]\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n\r\nquery stack during panic:\r\n#0 [def_span] looking up span for `asynclib::SomeTrait::doasync::{opaque#0}`\r\n#1 [typeck] type-checking `main`\r\n#2 [used_trait_imports] finding used_trait_imports `main`\r\n#3 [analysis] running analysis passes on this crate\r\nend of query stack\r\nerror: could not compile `asyncmain` (bin \"asyncmain\")\r\n```\r\n\r\n</p>\r\n</details>\r\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/111031/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/111031/timeline", "performed_via_github_app": null, "state_reason": "completed"}