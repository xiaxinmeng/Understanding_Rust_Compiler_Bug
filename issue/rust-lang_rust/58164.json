{"url": "https://api.github.com/repos/rust-lang/rust/issues/58164", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/58164/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/58164/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/58164/events", "html_url": "https://github.com/rust-lang/rust/issues/58164", "id": 406463116, "node_id": "MDU6SXNzdWU0MDY0NjMxMTY=", "number": 58164, "title": "Runtime stack overflow that does not make any sense", "user": {"login": "shisoft", "id": 3405885, "node_id": "MDQ6VXNlcjM0MDU4ODU=", "avatar_url": "https://avatars.githubusercontent.com/u/3405885?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shisoft", "html_url": "https://github.com/shisoft", "followers_url": "https://api.github.com/users/shisoft/followers", "following_url": "https://api.github.com/users/shisoft/following{/other_user}", "gists_url": "https://api.github.com/users/shisoft/gists{/gist_id}", "starred_url": "https://api.github.com/users/shisoft/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shisoft/subscriptions", "organizations_url": "https://api.github.com/users/shisoft/orgs", "repos_url": "https://api.github.com/users/shisoft/repos", "events_url": "https://api.github.com/users/shisoft/events{/privacy}", "received_events_url": "https://api.github.com/users/shisoft/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2019-02-04T18:37:52Z", "updated_at": "2019-02-05T19:08:26Z", "closed_at": "2019-02-05T19:08:26Z", "author_association": "NONE", "active_lock_reason": null, "body": "I am developing a B+ plus tree which its page size is controlled by generic typing arrays. \r\n\r\nBefore I put it on large scale, I did tried to write tests and it works. When I tried to set the page size as large as `240000`. I got stack overflow error. I have nailed the problem to one function and [write a test](https://github.com/ShisoftResearch/Nebuchadnezzar/blob/d7d554e33a3f75097ceb05a3e19c0aa3239173f3/src/index/btree/test.rs#L728) for it but the behaviour looks strange to me. The test code, which is:\r\n```\r\nconst LARGE_PAGE_SIZE: usize = 240000;\r\nstruct LargeKeySlice {\r\n    inner: [EntryKey; LARGE_PAGE_SIZE]\r\n}\r\ntype LargePtrSlice = [NodeCellRef; LARGE_PAGE_SIZE + 1];\r\ntype LargeLevelBPlusTree = BPlusTree<LargeKeySlice, LargePtrSlice>;\r\n\r\n#[test]\r\n#[should_panic]\r\nfn large_page() {\r\n    // this test should panic but not stack overflow\r\n    env_logger::init();\r\n    debug!(\"testing\");\r\n    ExtNode::<LargeKeySlice, LargePtrSlice>::new(Id::rand(), smallvec!(0));\r\n}\r\n```\r\nIt have a `debug` macro which will print `testing` before the `new` function to be invoked. The test case actually overflows stack without printing `testing`. If we replace the `new` function with `panic!()`, it will pass the test with `testing` been printed. The most interesting part is, if we [clear the `new` function](https://github.com/ShisoftResearch/Nebuchadnezzar/blob/d7d554e33a3f75097ceb05a3e19c0aa3239173f3/src/index/btree/external.rs#L74) and make an explicit panic, it still overflow stack.\r\n\r\nIf we decrease `LARGE_PAGE_SIZE` to `24000`, the test case will panic without overflow stack, which is exactly what I expected. This problem does not seems like my problem for the `new` function have not been invoked during the stack overflow.\r\n\r\nBecause I have no clue about how this happened, I was unable to replicate this issue on playground. As far as my attempt, [this](https://play.rust-lang.org/?version=nightly&mode=debug&edition=2018&gist=ae1851641df60ced060b6d4a160f14d9) works without stack overflow\r\n\r\nFeel free to [checkout](https://github.com/ShisoftResearch/Nebuchadnezzar/tree/feature/lsm-indexed) and play around by \r\n`cargo test --package neb --lib index::btree::test::large_page -- --nocapture`\r\n\r\n### Error\r\n```\r\nthread 'main' has overflowed its stack\r\nfatal runtime error: stack overflow\r\nerror: process didn't exit successfully: `/Users/shisoft/Documents/OSS Projects/Nebuchadnezzar/target/debug/deps/neb-96fd92871c91115d 'index::lsmtree::test::insertions' --nocapture --test-threads=1` (signal: 6, SIGABRT: process abort signal)\r\n\r\n```\r\n\r\n### Rust Version\r\n`rustc 1.34.0-nightly (f6fac4225 2019-02-03)`", "closed_by": {"login": "shisoft", "id": 3405885, "node_id": "MDQ6VXNlcjM0MDU4ODU=", "avatar_url": "https://avatars.githubusercontent.com/u/3405885?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shisoft", "html_url": "https://github.com/shisoft", "followers_url": "https://api.github.com/users/shisoft/followers", "following_url": "https://api.github.com/users/shisoft/following{/other_user}", "gists_url": "https://api.github.com/users/shisoft/gists{/gist_id}", "starred_url": "https://api.github.com/users/shisoft/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shisoft/subscriptions", "organizations_url": "https://api.github.com/users/shisoft/orgs", "repos_url": "https://api.github.com/users/shisoft/repos", "events_url": "https://api.github.com/users/shisoft/events{/privacy}", "received_events_url": "https://api.github.com/users/shisoft/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/58164/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/58164/timeline", "performed_via_github_app": null, "state_reason": "completed"}