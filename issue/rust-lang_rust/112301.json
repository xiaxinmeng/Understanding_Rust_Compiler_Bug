{"url": "https://api.github.com/repos/rust-lang/rust/issues/112301", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/112301/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/112301/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/112301/events", "html_url": "https://github.com/rust-lang/rust/issues/112301", "id": 1741147718, "node_id": "I_kwDOAAsO6M5nx85G", "number": 112301, "title": "Const evaluation can fail during `cargo build` but not `cargo check`", "user": {"login": "joshlf", "id": 1046063, "node_id": "MDQ6VXNlcjEwNDYwNjM=", "avatar_url": "https://avatars.githubusercontent.com/u/1046063?v=4", "gravatar_id": "", "url": "https://api.github.com/users/joshlf", "html_url": "https://github.com/joshlf", "followers_url": "https://api.github.com/users/joshlf/followers", "following_url": "https://api.github.com/users/joshlf/following{/other_user}", "gists_url": "https://api.github.com/users/joshlf/gists{/gist_id}", "starred_url": "https://api.github.com/users/joshlf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/joshlf/subscriptions", "organizations_url": "https://api.github.com/users/joshlf/orgs", "repos_url": "https://api.github.com/users/joshlf/repos", "events_url": "https://api.github.com/users/joshlf/events{/privacy}", "received_events_url": "https://api.github.com/users/joshlf/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2023-06-05T07:23:28Z", "updated_at": "2023-06-05T08:32:40Z", "closed_at": "2023-06-05T08:32:39Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I have the following code:\r\n\r\n```rust\r\ntrait Foo {\r\n    const FOO: ();\r\n}\r\n\r\nimpl Foo for () {\r\n    const FOO: () = unimplemented!();\r\n}\r\n\r\npub fn foo() {\r\n    let _: () = <() as Foo>::FOO;\r\n}\r\n```\r\n\r\nRunning `cargo check` succeeds, while `cargo build` fails:\r\n\r\n```\r\n$ cargo build\r\n   Compiling check-panicking-const v0.1.0 (.../check-panicking-const)\r\nerror[E0080]: evaluation of constant value failed\r\n --> src/lib.rs:6:21\r\n  |\r\n6 |     const FOO: () = unimplemented!();\r\n  |                     ^^^^^^^^^^^^^^^^ the evaluated program panicked at 'not implemented', src/lib.rs:6:21\r\n  |\r\n  = note: this error originates in the macro `unimplemented` (in Nightly builds, run with -Z macro-backtrace for more info)\r\n\r\nnote: erroneous constant used\r\n  --> src/lib.rs:10:17\r\n   |\r\n10 |     let _: () = <() as Foo>::FOO;\r\n   |                 ^^^^^^^^^^^^^^^^\r\n\r\nFor more information about this error, try `rustc --explain E0080`.\r\nerror: could not compile `check-panicking-const` (lib) due to previous error\r\n```\r\n\r\nI would expect `cargo build` and `cargo check` to exhibit the same behavior.\r\n\r\nThis has practical implications. For example, I'm working on implementing [this technique](https://github.com/google/zerocopy/pull/183#discussion_r1208678157) in zerocopy, which intentionally generates panicking constants when an unsound transmutation is attempted. The behavior mismatch between `cargo check` and `cargo build` means that unsound transmutes _appear_ to compile until the user runs `cargo build`. For users who primarily use `cargo check` during development (I am included in this group), this can result in spending a lot of time going down a path that will end up with a dead end.\r\n\r\nThis is an instance of https://github.com/rust-lang/rust/issues/70923.\r\n\r\n## Version\r\n\r\n```\r\n$ cargo --version\r\ncargo 1.72.0-nightly (b0fa79679 2023-06-03)\r\n```", "closed_by": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/112301/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/112301/timeline", "performed_via_github_app": null, "state_reason": "not_planned"}