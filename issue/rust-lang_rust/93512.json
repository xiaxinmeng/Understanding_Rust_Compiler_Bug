{"url": "https://api.github.com/repos/rust-lang/rust/issues/93512", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/93512/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/93512/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/93512/events", "html_url": "https://github.com/rust-lang/rust/issues/93512", "id": 1119815210, "node_id": "I_kwDOAAsO6M5CvwYq", "number": 93512, "title": "Can't run `cargo test ---offline` with optional dependency", "user": {"login": "maximecb", "id": 713766, "node_id": "MDQ6VXNlcjcxMzc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/713766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/maximecb", "html_url": "https://github.com/maximecb", "followers_url": "https://api.github.com/users/maximecb/followers", "following_url": "https://api.github.com/users/maximecb/following{/other_user}", "gists_url": "https://api.github.com/users/maximecb/gists{/gist_id}", "starred_url": "https://api.github.com/users/maximecb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/maximecb/subscriptions", "organizations_url": "https://api.github.com/users/maximecb/orgs", "repos_url": "https://api.github.com/users/maximecb/repos", "events_url": "https://api.github.com/users/maximecb/events{/privacy}", "received_events_url": "https://api.github.com/users/maximecb/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2022-01-31T19:02:21Z", "updated_at": "2022-01-31T20:44:54Z", "closed_at": "2022-01-31T20:44:54Z", "author_association": "NONE", "active_lock_reason": null, "body": "We have a situation where we'd really like for our Rust project to be able to build completely offline without accessing `crates.io`. We'd also like to be able to run `cargo test --offline` in our GitHub CI workflows. Unfortunately, this doesn't work. We have one single dependency on the `capstone` library which is clearly marked as optional, and even with the `--offline` flag, we get this error:\r\n\r\n```\r\nRun cargo test --offline\r\nerror: no matching package named `capstone` found\r\nlocation searched: registry `crates-io`\r\nrequired by package `yjit v0.1.0 (/home/runner/work/ruby/ruby/yjit)`\r\nAs a reminder, you're using offline mode (--offline) which can sometimes cause surprising resolution failures, if this error is too confusing you may wish to retry without the offline flag.\r\n```\r\n\r\nIMO this is clearly a bug. It violates user intuition as to how the `--offline` switch should behave. The error message even recommends just... Not using the offline switch because it might be too confusing (!?). Well, you're right, it is confusing. The dependency is optional, and we haven't enabled the feature requiring it. Therefore there should be no need to fetch said dependency. It really should be that simple.\r\n\r\nI also tried\r\n- Removing `Cargo.lock` (doesn't help)\r\n- `cargo test --locked --offline` (doesn't help)\r\n\r\nLinking the `Cargo.toml` file for the project in case someone can spot something wrong with our setup: https://github.com/Shopify/ruby/blob/70fee18c9947ab50b93ec0018f0d6cf4c6c2772f/yjit/Cargo.toml", "closed_by": {"login": "maximecb", "id": 713766, "node_id": "MDQ6VXNlcjcxMzc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/713766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/maximecb", "html_url": "https://github.com/maximecb", "followers_url": "https://api.github.com/users/maximecb/followers", "following_url": "https://api.github.com/users/maximecb/following{/other_user}", "gists_url": "https://api.github.com/users/maximecb/gists{/gist_id}", "starred_url": "https://api.github.com/users/maximecb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/maximecb/subscriptions", "organizations_url": "https://api.github.com/users/maximecb/orgs", "repos_url": "https://api.github.com/users/maximecb/repos", "events_url": "https://api.github.com/users/maximecb/events{/privacy}", "received_events_url": "https://api.github.com/users/maximecb/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/93512/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/93512/timeline", "performed_via_github_app": null, "state_reason": "completed"}