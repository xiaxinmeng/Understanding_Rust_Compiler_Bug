{"url": "https://api.github.com/repos/rust-lang/rust/issues/68148", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/68148/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/68148/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/68148/events", "html_url": "https://github.com/rust-lang/rust/issues/68148", "id": 548538111, "node_id": "MDU6SXNzdWU1NDg1MzgxMTE=", "number": 68148, "title": "Exporting a function with the same name as a function in libc emits incorrect assembly", "user": {"login": "lineaar", "id": 35309223, "node_id": "MDQ6VXNlcjM1MzA5MjIz", "avatar_url": "https://avatars.githubusercontent.com/u/35309223?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lineaar", "html_url": "https://github.com/lineaar", "followers_url": "https://api.github.com/users/lineaar/followers", "following_url": "https://api.github.com/users/lineaar/following{/other_user}", "gists_url": "https://api.github.com/users/lineaar/gists{/gist_id}", "starred_url": "https://api.github.com/users/lineaar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lineaar/subscriptions", "organizations_url": "https://api.github.com/users/lineaar/orgs", "repos_url": "https://api.github.com/users/lineaar/repos", "events_url": "https://api.github.com/users/lineaar/events{/privacy}", "received_events_url": "https://api.github.com/users/lineaar/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2020-01-12T08:24:12Z", "updated_at": "2020-01-12T12:47:50Z", "closed_at": "2020-01-12T12:47:06Z", "author_association": "NONE", "active_lock_reason": null, "body": "```rust\r\ntype flt = f64;\r\n\r\n#[no_mangle]\r\npub extern \"C\" fn atan2(xx: flt, xy: flt, yx: flt, yy: flt) -> flt {\r\n    let f = xx * yy + xy * yx;\r\n    f.atan2(xx * yx + yx * yy)\r\n}\r\n```\r\n```python\r\nfrom ctypes import cdll, c_double as flt\r\n\r\nlib = cdll.LoadLibrary(\"./libname.so\")\r\natan2 = lib.atan2\r\natan2.argtypes = [flt, flt, flt, flt]\r\natan2.restype = flt\r\n\r\nr = 0.0\r\nfor x in range(1000):\r\n    for y in range(1000):\r\n        r += atan2(flt(x), flt(y), flt(y), flt(x))\r\n\r\nprint(r)\r\n```\r\nCompiling the rust code with `rustc name.rs --crate-type cdylib -Copt-level=x` where `x` in [1, 2, 3] generates interesting assembly (https://rust.godbolt.org/z/a-32AR).\r\n\r\nWith `x`=0, a correct answer is computed.\r\nWith `x`=1, a wrong answer is computed.\r\nWith `x` in [2, 3], an infinite loop is emitted.\r\n\r\nThe issue stems from the fact that the name of the exported function and libc's `atan2` collide. This is reproduceable from rustc 1.12.0 to current nightly.\r\n\r\nTo avoid the issue one can rename the exported function to avoid the collision or use `f32` since that calls `atan2f` or use `&f64` for the inputs with byref in Python.", "closed_by": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/68148/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/68148/timeline", "performed_via_github_app": null, "state_reason": "completed"}