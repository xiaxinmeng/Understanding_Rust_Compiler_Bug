{"url": "https://api.github.com/repos/rust-lang/rust/issues/21812", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/21812/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/21812/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/21812/events", "html_url": "https://github.com/rust-lang/rust/issues/21812", "id": 56130553, "node_id": "MDU6SXNzdWU1NjEzMDU1Mw==", "number": 21812, "title": "Variadic argument extern functions accept non-repr(C) structs", "user": {"login": "solson", "id": 26806, "node_id": "MDQ6VXNlcjI2ODA2", "avatar_url": "https://avatars.githubusercontent.com/u/26806?v=4", "gravatar_id": "", "url": "https://api.github.com/users/solson", "html_url": "https://github.com/solson", "followers_url": "https://api.github.com/users/solson/followers", "following_url": "https://api.github.com/users/solson/following{/other_user}", "gists_url": "https://api.github.com/users/solson/gists{/gist_id}", "starred_url": "https://api.github.com/users/solson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/solson/subscriptions", "organizations_url": "https://api.github.com/users/solson/orgs", "repos_url": "https://api.github.com/users/solson/repos", "events_url": "https://api.github.com/users/solson/events{/privacy}", "received_events_url": "https://api.github.com/users/solson/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235137, "node_id": "MDU6TGFiZWwyMzUxMzc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-lint", "name": "A-lint", "color": "f7e101", "default": false, "description": "Area: Lints (warnings about flaws in source code) such as unused_mut."}, {"id": 45472092, "node_id": "MDU6TGFiZWw0NTQ3MjA5Mg==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-ffi", "name": "A-ffi", "color": "f7e101", "default": false, "description": "Area: Foreign Function Interface (FFI)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2015-01-31T16:41:11Z", "updated_at": "2020-01-08T14:20:44Z", "closed_at": "2016-02-11T20:12:49Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Rust wisely tells us to cast `u8` and `u16` to `c_int` (aka `u32`) and `f32` to `c_double` (aka `f64`) when passing values of these types in variadic argument lists, since C expects this kind of type promotion to occur for varargs. But one can get around this and accidentally break things by wrapping the type in a newtype-style struct:\n\n``` rust\nextern crate libc;\nuse libc::{c_char, c_int, c_double};\n\nextern {\n    fn printf(fmt: *const c_char, ...) -> c_int;\n}\n\nfn main() {\n    let x: f32 = 1f32 / 2f32;\n    let fmt = b\"1 / 2 = %f\\n\\0\".as_ptr() as *mut c_char;\n    struct Oops(f32);\n    unsafe {\n        // printf(fmt, x); // error: can't pass an f32 to variadic function, cast to c_double\n        printf(fmt, x as c_double); // 1 / 2 = 0.500000\n        printf(fmt, Oops(x));       // 1 / 2 = 0.000000 (wrong!)\n    }\n}\n```\n\nThe existing checks can be found [here](https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/mod.rs#L2365-L2388).\n\nEDIT: Rust ought to warn about passing a non-`repr(C)` function as in this example.\n", "closed_by": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/21812/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/21812/timeline", "performed_via_github_app": null, "state_reason": "completed"}