{"url": "https://api.github.com/repos/rust-lang/rust/issues/90394", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/90394/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/90394/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/90394/events", "html_url": "https://github.com/rust-lang/rust/issues/90394", "id": 1039373223, "node_id": "I_kwDOAAsO6M4985On", "number": 90394, "title": "Suboptimal code generated to compare slice on risc-v", "user": {"login": "eduardosm", "id": 761151, "node_id": "MDQ6VXNlcjc2MTE1MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/761151?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eduardosm", "html_url": "https://github.com/eduardosm", "followers_url": "https://api.github.com/users/eduardosm/followers", "following_url": "https://api.github.com/users/eduardosm/following{/other_user}", "gists_url": "https://api.github.com/users/eduardosm/gists{/gist_id}", "starred_url": "https://api.github.com/users/eduardosm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eduardosm/subscriptions", "organizations_url": "https://api.github.com/users/eduardosm/orgs", "repos_url": "https://api.github.com/users/eduardosm/repos", "events_url": "https://api.github.com/users/eduardosm/events{/privacy}", "received_events_url": "https://api.github.com/users/eduardosm/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-10-29T09:34:25Z", "updated_at": "2022-04-15T14:16:01Z", "closed_at": "2022-04-15T14:16:00Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried this code:\r\n\r\n```rust\r\npub fn f(x: &[u32]) -> bool {\r\n    x == [0]\r\n}\r\n```\r\n\r\nhttps://godbolt.org/z/8sqdcq6Mq\r\n\r\nI expected to see this happen:\r\n\r\nThe `[u32]` is four-byte aligned, so it should read it's first value with just a single instruction:\r\n```\r\nf:\r\n        addi    a2, zero, 1\r\n        bne     a1, a2, .LBB0_2\r\n        lw      a0, 0(a0)\r\n        seqz    a0, a0\r\n        ret\r\n.LBB0_2:\r\n        mv      a0, zero\r\n        ret\r\n\r\n```\r\n\r\nInstead, this happened:\r\n\r\nFour bytes are read and then composed into a 32-bit word, as if it was doing an unaligned read:\r\n```\r\nf:\r\n        addi    a2, zero, 1\r\n        bne     a1, a2, .LBB0_2\r\n        lbu     a1, 1(a0)\r\n        lbu     a2, 0(a0)\r\n        lb      a3, 3(a0)\r\n        lbu     a0, 2(a0)\r\n        slli    a1, a1, 8\r\n        or      a1, a1, a2\r\n        slli    a2, a3, 8\r\n        or      a0, a0, a2\r\n        slli    a0, a0, 16\r\n        or      a0, a0, a1\r\n        seqz    a0, a0\r\n        ret\r\n.LBB0_2:\r\n        mv      a0, zero\r\n        ret\r\n```\r\n\r\nImplementing the operation this way will produce more optimal code:\r\n```rust\r\npub fn f(x: &[u32]) -> bool {\r\n    x.len() == 1 && x[0] == 0\r\n}\r\n```\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n1.56 and nightly", "closed_by": {"login": "eduardosm", "id": 761151, "node_id": "MDQ6VXNlcjc2MTE1MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/761151?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eduardosm", "html_url": "https://github.com/eduardosm", "followers_url": "https://api.github.com/users/eduardosm/followers", "following_url": "https://api.github.com/users/eduardosm/following{/other_user}", "gists_url": "https://api.github.com/users/eduardosm/gists{/gist_id}", "starred_url": "https://api.github.com/users/eduardosm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eduardosm/subscriptions", "organizations_url": "https://api.github.com/users/eduardosm/orgs", "repos_url": "https://api.github.com/users/eduardosm/repos", "events_url": "https://api.github.com/users/eduardosm/events{/privacy}", "received_events_url": "https://api.github.com/users/eduardosm/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/90394/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/90394/timeline", "performed_via_github_app": null, "state_reason": "completed"}