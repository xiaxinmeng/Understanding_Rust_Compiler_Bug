{"url": "https://api.github.com/repos/rust-lang/rust/issues/17454", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/17454/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/17454/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/17454/events", "html_url": "https://github.com/rust-lang/rust/issues/17454", "id": 43549111, "node_id": "MDU6SXNzdWU0MzU0OTExMQ==", "number": 17454, "title": "error: internal compiler error: get_unique_type_id_of_type() - unexpected type: closure, ty_unboxed_closure", "user": {"login": "emk", "id": 36963, "node_id": "MDQ6VXNlcjM2OTYz", "avatar_url": "https://avatars.githubusercontent.com/u/36963?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emk", "html_url": "https://github.com/emk", "followers_url": "https://api.github.com/users/emk/followers", "following_url": "https://api.github.com/users/emk/following{/other_user}", "gists_url": "https://api.github.com/users/emk/gists{/gist_id}", "starred_url": "https://api.github.com/users/emk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emk/subscriptions", "organizations_url": "https://api.github.com/users/emk/orgs", "repos_url": "https://api.github.com/users/emk/repos", "events_url": "https://api.github.com/users/emk/events{/privacy}", "received_events_url": "https://api.github.com/users/emk/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2014-09-22T20:39:01Z", "updated_at": "2014-09-22T21:05:51Z", "closed_at": "2014-09-22T21:02:34Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "It's September 22, and I just download today's compiler using `rustup.sh`. I tried to compile this modified version of rust-replace-map, using `FnOnce`:\n\n``` rust\n#![feature(unboxed_closures, overloaded_calls)]\n\n//! Exposes `replace_map`, for replacing values at mutable memory locations.\n\nuse std::ptr;\n\n/// Replace the value at a mutable memory location with the value\n/// produced by the passed in closure.\n///\n/// Does not create an intermediate value, so is more efficient and\n/// ergonomic in cases where producing a value to pass to mem::replace\n/// is hard.\npub fn replace_map<'a, T, F>(src: &mut T, prod: F)\nwhere F: FnOnce(T) -> T {\n    // Read the value, pass it to prod, then write-over src.\n    //\n    // Safe because the value originally behind src is dropped\n    // inside of prod and is then immediately written over.\n    unsafe { *src = prod(ptr::read(src as *mut T as *const T)); }\n}\n\n#[test] fn test_works() {\n    let mut a = 7u;\n    let b = &mut a;\n\n    replace_map(b, |: x: uint| x * 2);\n    assert_eq!(*b, 14u);\n}\n```\n\n\u2026and got:\n\n```\nerror: internal compiler error: get_unique_type_id_of_type() - unexpected type: closure, ty_unboxed_closure(syntax::ast::DefId{krate: 0u32, node: 67u32}, ReScope(64u32))\nnote: the compiler hit an unexpected failure path. this is a bug.\nnote: we would appreciate a bug report: http://doc.rust-lang.org/complement-bugreport.html\nnote: run with `RUST_BACKTRACE=1` for a backtrace\ntask 'rustc' failed at 'Box<Any>', /home/rustbuild/src/rust-buildbot/slave/nightly-linux/build/src/libsyntax/diagnostic.rs:169\n\nstack backtrace:\n   1:     0x7ff33e8faf00 - rt::backtrace::imp::write::hb40e767174eadc9blLq\n   2:     0x7ff33e8fe0c0 - failure::on_fail::hab6209505fea7a58N6q\n   3:     0x7ff34300df80 - unwind::begin_unwind_inner::h3a7e8417aad82c7eMTd\n   4:     0x7ff33f6a8450 - unwind::begin_unwind::h2392538768877619269\n   5:     0x7ff33f6a8bc0 - diagnostic::Handler::bug::hbcf500f6b0a7b557wjF\n   6:     0x7ff343660780 - driver::session::Session::bug::h0f635b08aa66c6feeQx\n   7:     0x7ff343b05fa0 - middle::trans::debuginfo::TypeMap::get_unique_type_id_of_type::h233deb54704247ccivp\n   8:     0x7ff343b0f6d0 - middle::trans::debuginfo::type_metadata::hb53e934b117efcaftOr\n   9:     0x7ff343ab60a0 - middle::trans::debuginfo::create_function_debug_context::h7fc6b788d4b1d265rfq\n  10:     0x7ff343a2fe60 - middle::trans::base::new_fn_ctxt::h611243317f012711AFe\n  11:     0x7ff343aba2b0 - middle::trans::base::trans_closure::hd7b21130af57d114T6e\n  12:     0x7ff343a00cf0 - middle::trans::base::trans_fn::hba6c6098eff914846hf\n  13:     0x7ff343a013d0 - middle::trans::monomorphize::monomorphic_fn::h111314500f9ac8aadtY\n  14:     0x7ff343a383a0 - middle::trans::callee::trans_fn_ref_with_substs::h927366ab2c3f6092XP1\n  15:     0x7ff343a35cf0 - middle::trans::callee::trans_fn_ref::h6176864c3298571axE1\n  16:     0x7ff343a3db50 - middle::trans::callee::trans_call::closure.123725\n  17:     0x7ff343a16130 - middle::trans::callee::trans_call_inner::ha373276fc0d46583Fb2\n  18:     0x7ff343a3d8b0 - middle::trans::callee::trans_call::ha3d5b5ce354777b1051\n  19:     0x7ff343a4c630 - middle::trans::expr::trans_rvalue_dps_unadjusted::hf457bf80e76e66462i4\n  20:     0x7ff343a0e5c0 - middle::trans::expr::trans_into::ha20572ab8748555eMV2\n  21:     0x7ff343a0d9c0 - middle::trans::controlflow::trans_stmt_semi::h5634a3e832fd1190x3Y\n  22:     0x7ff343a0d0e0 - middle::trans::controlflow::trans_stmt::h669538f418e4814fuZY\n  23:     0x7ff343a0ea90 - middle::trans::controlflow::trans_block::h98e6c8ac340121b9q4Y\n  24:     0x7ff343aba2b0 - middle::trans::base::trans_closure::hd7b21130af57d114T6e\n  25:     0x7ff343a00cf0 - middle::trans::base::trans_fn::hba6c6098eff914846hf\n  26:     0x7ff3439fe110 - middle::trans::base::trans_item::h13a70584bb385db8fBf\n  27:     0x7ff343ac5510 - middle::trans::base::trans_crate::he94a02318e5d0e54kzg\n  28:     0x7ff343ee6b90 - driver::driver::phase_4_translate_to_llvm::hfa5c9eb34e10ce6cchx\n  29:     0x7ff343eddf50 - driver::driver::compile_input::h644c4bcdb8d4fa416Nw\n  30:     0x7ff343f5fe40 - driver::run_compiler::hd9154f69e0f25652kFA\n  31:     0x7ff343f5fd20 - driver::main_args::closure.146572\n  32:     0x7ff34368fe70 - task::TaskBuilder<S>::try_future::closure.101814\n  33:     0x7ff34368fc60 - task::TaskBuilder<S>::spawn_internal::closure.101785\n  34:     0x7ff34335d540 - task::spawn_opts::closure.8457\n  35:     0x7ff343064390 - rust_try_inner\n  36:     0x7ff343064380 - rust_try\n  37:     0x7ff34300b580 - unwind::try::haa9a6e4d3a3bf10cuId\n  38:     0x7ff34300b3e0 - task::Task::run::h18e39631c20de002cYc\n  39:     0x7ff34335d2b0 - task::spawn_opts::closure.8397\n  40:     0x7ff34300cfd0 - thread::thread_start::hfdbefd9910b77f41rid\n  41:     0x7ff33dcabdc0 - start_thread\n  42:                0x0 - <unknown>\n```\n", "closed_by": {"login": "emk", "id": 36963, "node_id": "MDQ6VXNlcjM2OTYz", "avatar_url": "https://avatars.githubusercontent.com/u/36963?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emk", "html_url": "https://github.com/emk", "followers_url": "https://api.github.com/users/emk/followers", "following_url": "https://api.github.com/users/emk/following{/other_user}", "gists_url": "https://api.github.com/users/emk/gists{/gist_id}", "starred_url": "https://api.github.com/users/emk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emk/subscriptions", "organizations_url": "https://api.github.com/users/emk/orgs", "repos_url": "https://api.github.com/users/emk/repos", "events_url": "https://api.github.com/users/emk/events{/privacy}", "received_events_url": "https://api.github.com/users/emk/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/17454/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/17454/timeline", "performed_via_github_app": null, "state_reason": "completed"}