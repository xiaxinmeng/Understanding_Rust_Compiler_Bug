{"url": "https://api.github.com/repos/rust-lang/rust/issues/57258", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/57258/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/57258/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/57258/events", "html_url": "https://github.com/rust-lang/rust/issues/57258", "id": 395159662, "node_id": "MDU6SXNzdWUzOTUxNTk2NjI=", "number": 57258, "title": "Unused symbol breaks Profiled Guided Optimization (PGO)", "user": {"login": "robsmith11", "id": 22622548, "node_id": "MDQ6VXNlcjIyNjIyNTQ4", "avatar_url": "https://avatars.githubusercontent.com/u/22622548?v=4", "gravatar_id": "", "url": "https://api.github.com/users/robsmith11", "html_url": "https://github.com/robsmith11", "followers_url": "https://api.github.com/users/robsmith11/followers", "following_url": "https://api.github.com/users/robsmith11/following{/other_user}", "gists_url": "https://api.github.com/users/robsmith11/gists{/gist_id}", "starred_url": "https://api.github.com/users/robsmith11/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/robsmith11/subscriptions", "organizations_url": "https://api.github.com/users/robsmith11/orgs", "repos_url": "https://api.github.com/users/robsmith11/repos", "events_url": "https://api.github.com/users/robsmith11/events{/privacy}", "received_events_url": "https://api.github.com/users/robsmith11/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2019-01-02T06:33:42Z", "updated_at": "2022-03-23T02:07:18Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "My crate is structured to build both a `bin` and a `dylib` that is loaded by a 3rd-party program.  The stand-alone `bin` part doesn't actually use any of the external symbols, so despite it sharing code with the `lib` part, it runs fine without the symbols being defined.\r\n\r\nHowever, when I turn on PGO, these undefined symbols cause linking errors.  My expectation is that if my crate works without PGO, it should work with PGO enabled, but maybe that's incorrect?\r\n\r\nMy actual crate gets these undefined symbols from here:\r\nhttps://github.com/robsmith11/krust/blob/master/src/kbindings.rs#L483\r\n\r\nBut this minimal example reproduces the problem:\r\n```\r\nfn main() {\r\n}\r\n\r\nextern \"C\" {\r\n    pub fn f();\r\n}\r\n\r\n#[no_mangle]\r\npub extern fn g() {\r\n    unsafe { f(); }\r\n}\r\n```\r\n```\r\n$ RUSTFLAGS=\"-Z pgo-gen=/tmp/prof.data\" cargo run --release \r\n    Compiling play v0.1.0 (/home/me/e/code/play)\r\nerror: linking with `cc` failed: exit code: 1\r\n  |\r\n  = note: \"cc\" \"-Wl,--as-needed\" \"-Wl,-z,noexecstack\" \"-m64\" \"-L\" \"/home/me/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"/tmp/target_play/release/deps/play-e890b10933e5432f.play.1uu11z5v-cgu.0.rcgu.o\" \"-o\" \"/tmp/target_play/release/deps/play-e890b10933e5432f\" \"-Wl,--gc-sections\" \"-pie\" \"-Wl,-zrelro\" \"-Wl,-znow\" \"-Wl,-O1\" \"-nodefaultlibs\" \"-L\" \"/tmp/target_play/release/deps\" \"-L\" \"/home/me/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-Wl,-Bstatic\" \"/tmp/rustcvLfVyu/libprofiler_builtins-4ecfbf392fb1b2b9.rlib\" \"-Wl,--start-group\" \"/tmp/rustcvLfVyu/libstd-4f6a41fe25da1d4f.rlib\" \"-Wl,--end-group\" \"/home/me/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-cd088bc8787919ee.rlib\" \"-Wl,-Bdynamic\" \"-ldl\" \"-lrt\" \"-lpthread\" \"-lgcc_s\" \"-lc\" \"-lm\" \"-lrt\" \"-lpthread\" \"-lutil\" \"-lutil\" \"-u\" \"__llvm_profile_runtime\"\r\n  = note: /usr/bin/ld: /tmp/target_play/release/deps/play-e890b10933e5432f.play.1uu11z5v-cgu.0.rcgu.o: in function `g':\r\n          play.1uu11z5v-cgu.0:(.text.g+0xa): undefined reference to `f'\r\n          collect2: error: ld returned 1 exit status\r\n```\r\n\r\nEDIT:\r\nNot sure whether it's relevant, but removing the `#[no_mangle]` makes it work with PGO.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/57258/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/57258/timeline", "performed_via_github_app": null, "state_reason": null}