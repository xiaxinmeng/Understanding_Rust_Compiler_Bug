{"url": "https://api.github.com/repos/rust-lang/rust/issues/53814", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/53814/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/53814/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/53814/events", "html_url": "https://github.com/rust-lang/rust/issues/53814", "id": 355416815, "node_id": "MDU6SXNzdWUzNTU0MTY4MTU=", "number": 53814, "title": "Panic within a panic causes illegal instruction SIGILL", "user": {"login": "sunjay", "id": 530939, "node_id": "MDQ6VXNlcjUzMDkzOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/530939?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sunjay", "html_url": "https://github.com/sunjay", "followers_url": "https://api.github.com/users/sunjay/followers", "following_url": "https://api.github.com/users/sunjay/following{/other_user}", "gists_url": "https://api.github.com/users/sunjay/gists{/gist_id}", "starred_url": "https://api.github.com/users/sunjay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sunjay/subscriptions", "organizations_url": "https://api.github.com/users/sunjay/orgs", "repos_url": "https://api.github.com/users/sunjay/repos", "events_url": "https://api.github.com/users/sunjay/events{/privacy}", "received_events_url": "https://api.github.com/users/sunjay/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-08-30T04:08:10Z", "updated_at": "2018-08-30T04:37:13Z", "closed_at": "2018-08-30T04:37:13Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "**See first comment for an even smaller example of the issue. Thanks @mgattozzi for the insight that led to that!**\r\n\r\nI was integrating `NonZeroU8` into some code when I ran into an illegal instruction error that looks like this:\r\n\r\n```\r\nthread panicked while panicking. aborting.\r\nerror: process didn't exit successfully: `/path/to/my/project/target/debug/deps/xxxx-b71130afded4f9e4` (signal: 4, SIGILL: illegal instruction)\r\n```\r\n\r\nI spent a really long time trying to narrow this down and I got down to the following contrived example: ([Rust Playground](https://play.rust-lang.org/?gist=31a05c7ad8fb3f4ae38491962cdcc0e8&version=stable&mode=debug&edition=2015))\r\n\r\n```rust\r\nuse std::{\r\n    fmt,\r\n    num::NonZeroU8,\r\n};\r\n\r\npub struct Foo;\r\n\r\nimpl fmt::Display for Foo {\r\n    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\r\n        write!(f, \"{}\", NonZeroU8::new(0).unwrap())\r\n    }\r\n}\r\n\r\n#[test]\r\nfn something() {\r\n    panic!(\"{}\", Foo);\r\n}\r\n```\r\n\r\nThis probably looks like super weird code that no one would ever write, but this started from some real code I promise. :laughing: \r\n\r\nThe key part of this code is:\r\n\r\n```rust\r\nNonZeroU8::new(0).unwrap()\r\n```\r\n\r\nThe illegal instruction error occurs whenever that `0` is any value less than or equal to zero. You may be asking yourself \"How do you make a u8 literal less than zero?\" Well you don't. Rust protects you from that. The thing that Rust doesn't protect you from is this: ([Rust Playground](https://play.rust-lang.org/?gist=16f18c4f48ee1f843c783621f5ed6b27&version=stable&mode=debug&edition=2015))\r\n\r\n```rust\r\nlet y = 3;\r\nlet x = 2 - y;\r\nwrite!(f, \"{}\", NonZeroU8::new(x).unwrap())\r\n```\r\n\r\nThe variable `x` will be `-1` and the code will produce the same illegal instruction error.\r\n\r\nSome weird things to note about this:\r\n\r\n* It seems to work when run with `cargo run`. The failure is on `cargo test`.\r\n* I haven't figured out how to recreate this without the impl of `Display`. Inlining does NOT produce the error:\r\n\r\n```rust\r\n// No illegal instructions for this code!\r\nuse std::num::NonZeroU8;\r\n\r\n#[test]\r\nfn something() {\r\n    panic!(\"{}\", NonZeroU8::new(0).unwrap());\r\n}\r\n```", "closed_by": {"login": "sunjay", "id": 530939, "node_id": "MDQ6VXNlcjUzMDkzOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/530939?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sunjay", "html_url": "https://github.com/sunjay", "followers_url": "https://api.github.com/users/sunjay/followers", "following_url": "https://api.github.com/users/sunjay/following{/other_user}", "gists_url": "https://api.github.com/users/sunjay/gists{/gist_id}", "starred_url": "https://api.github.com/users/sunjay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sunjay/subscriptions", "organizations_url": "https://api.github.com/users/sunjay/orgs", "repos_url": "https://api.github.com/users/sunjay/repos", "events_url": "https://api.github.com/users/sunjay/events{/privacy}", "received_events_url": "https://api.github.com/users/sunjay/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/53814/reactions", "total_count": 4, "+1": 4, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/53814/timeline", "performed_via_github_app": null, "state_reason": "completed"}