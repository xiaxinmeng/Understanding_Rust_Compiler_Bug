{"url": "https://api.github.com/repos/rust-lang/rust/issues/27940", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/27940/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/27940/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/27940/events", "html_url": "https://github.com/rust-lang/rust/issues/27940", "id": 102508930, "node_id": "MDU6SXNzdWUxMDI1MDg5MzA=", "number": 27940, "title": "from_raw_parts needs an equivalent for dynamically-sized structs", "user": {"login": "geofft", "id": 74644, "node_id": "MDQ6VXNlcjc0NjQ0", "avatar_url": "https://avatars.githubusercontent.com/u/74644?v=4", "gravatar_id": "", "url": "https://api.github.com/users/geofft", "html_url": "https://github.com/geofft", "followers_url": "https://api.github.com/users/geofft/followers", "following_url": "https://api.github.com/users/geofft/following{/other_user}", "gists_url": "https://api.github.com/users/geofft/gists{/gist_id}", "starred_url": "https://api.github.com/users/geofft/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/geofft/subscriptions", "organizations_url": "https://api.github.com/users/geofft/orgs", "repos_url": "https://api.github.com/users/geofft/repos", "events_url": "https://api.github.com/users/geofft/events{/privacy}", "received_events_url": "https://api.github.com/users/geofft/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668019, "node_id": "MDU6TGFiZWwyMTE2NjgwMTk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-lang", "name": "T-lang", "color": "bfd4f2", "default": false, "description": "Relevant to the language team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2015-08-22T06:38:26Z", "updated_at": "2017-03-24T19:19:37Z", "closed_at": "2017-03-08T17:38:36Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "There's no good way to generate a non-raw pointer to a struct with a DST in tail position, which would handy for some FFI use cases involving flexible array members and the like. You can fake it in stable Rust, but only by abusing `transmute`:\n\n``` rust\nstruct PascalString<T: ?Sized> {\n    length: u8,\n    body: T,\n}\n\nunsafe fn parse_pascal_string<'a>(s: *const u8) -> &'a PascalString<[u8]> {\n    let length = std::ptr::read(s);\n    std::mem::transmute(std::slice::from_raw_parts(s, length as usize))\n}\n\nfn main() {\n    let x = b\"\\x05Hello world\";\n    let y = unsafe { parse_pascal_string(x.as_ptr()) };\n    println!(\"{}\", std::str::from_utf8(&y.body).unwrap());\n}\n```\n\nThis [works fine](http://is.gd/3Cx8kr) in stable Rust, but the `transmute` from `&[u8]` to `&PascalString<[u8]>` is pretty bogus (the `&[u8]` is pretty meaningless). What I'm doing is assuming that the representation of a fat pointer to a dynamically-sized struct looks like the representation of a slice, and that the length field is the length of the dynamically-sized tail element. To be fair, this is rule `Fat-Struct` from @nikomatsakis' [DST blog post](http://smallcultfollowing.com/babysteps/blog/2014/01/05/dst-take-5/), but I'm not sure I should be reading that as a stability promise, let alone an ABI stability promise.\n\nAn `unsafe fn from_raw_parts<T: ?Sized>(p: *const T, len: usize) -> &'a T` explicitly for fat struct pointers (as opposed to `std::slice::from_raw_parts`, which returns `&'a [T]`), with rules on what `p` and `len` should be and what `T`s are valid (`!Sized`, for starters), would probably solve this. IMO stating those rules in doc instead of in the function type is fine, since it's no worse than stating rules about the returned lifetime in `std::slice::from_raw_parts` in doc. This is an unsafe function, after all.\n", "closed_by": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/27940/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/27940/timeline", "performed_via_github_app": null, "state_reason": "completed"}