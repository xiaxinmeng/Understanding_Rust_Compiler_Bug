{"url": "https://api.github.com/repos/rust-lang/rust/issues/39838", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/39838/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/39838/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/39838/events", "html_url": "https://github.com/rust-lang/rust/issues/39838", "id": 207719977, "node_id": "MDU6SXNzdWUyMDc3MTk5Nzc=", "number": 39838, "title": "debuginfo-gdb test failures", "user": {"login": "amboar", "id": 526481, "node_id": "MDQ6VXNlcjUyNjQ4MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/526481?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amboar", "html_url": "https://github.com/amboar", "followers_url": "https://api.github.com/users/amboar/followers", "following_url": "https://api.github.com/users/amboar/following{/other_user}", "gists_url": "https://api.github.com/users/amboar/gists{/gist_id}", "starred_url": "https://api.github.com/users/amboar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amboar/subscriptions", "organizations_url": "https://api.github.com/users/amboar/orgs", "repos_url": "https://api.github.com/users/amboar/repos", "events_url": "https://api.github.com/users/amboar/events{/privacy}", "received_events_url": "https://api.github.com/users/amboar/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 120005, "node_id": "MDU6TGFiZWwxMjAwMDU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-testsuite", "name": "A-testsuite", "color": "f7e101", "default": false, "description": "Area: The testsuite used to check the correctness of rustc"}, {"id": 203130, "node_id": "MDU6TGFiZWwyMDMxMzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-debuginfo", "name": "A-debuginfo", "color": "f7e101", "default": false, "description": "Area: Debugging information in compiled programs (DWARF, PDB, etc.)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2017-02-15T06:33:45Z", "updated_at": "2017-06-20T01:16:13Z", "closed_at": "2017-06-20T01:16:13Z", "author_association": "NONE", "active_lock_reason": null, "body": "Recently I started looking at issues with the Rust test suite on powerpc64le as part of an effort to package Rust for Debian on POWER. I'm using rust-lang/rust@81bd2675eaf96396e363d63aa068b0a462ec5a6d as the basis for my testing, which contains the resolution for #39522, but I still see a large number of failures. I'm testing on Ubuntu Yakkety (16.10), both on powerpc64le and x86_64.\r\n\r\nI made a couple of comments on #39522, but I have created a new issue to track my problem as I don't want to hijack a closed issue.\r\n\r\nOn Ubuntu Yakkety with a clean build of rust at 81bd2675eaf96396e363d63aa068b0a462ec5a6d, invoking `./x.py test src/test/debuginfo/` gives me the output [gdb-ubuntu-rust-debuginfo.txt](https://github.com/rust-lang/rust/files/776150/gdb-ubuntu-rust-debuginfo.txt), which has the summary `test result: FAILED. 54 passed; 40 failed; 13 ignored; 0 measured`.\r\n\r\nYakkety's `gdb` reports:\r\n\r\n```\r\n$ /usr/bin/gdb --version\r\nGNU gdb (Ubuntu 7.11.90.20161005-0ubuntu1) 7.11.90.20161005-git\r\n```\r\n\r\nGiven the issues with different `gdb` versions as outlined in #39522, I figured I'd try building gdb from the tip of binutils-gdb master, which at the time was commit 10ddfe62f8979cfe380b07c4f827e72681cc612a:\r\n\r\n```\r\n$ /usr/local/bin/gdb --version\r\nGNU gdb (GDB) 7.12.50.20170213-git\r\n```\r\n\r\nThis was built with `./configure --with-python=python3`, as is done for Ubuntu (though with many more configure options in Ubuntu's case).\r\n\r\nUsing my own gdb build I get the output [gdb-master-rust-debuginfo.txt](https://github.com/rust-lang/rust/files/776158/gdb-master-rust-debuginfo.txt) and a result summary of `test result: FAILED. 53 passed; 51 failed; 3 ignored; 0 measured`. Presumably the tests ignored by the patch for #39522 with gdb 7.11.90 are now functional as we have 10 less tests ignored.\r\n\r\nHowever, the plot thickened before I realised that Ubuntu built gdb with Python support, as building a gdb with `./configure && make` gave me a binary that passed many more debuginfo tests. After jumping through several hoops I found I could simulate a lack of Python support in gdb by breaking a part of the Rust source tree with `mv -f src/etc/debugger_pretty_printers_common.py{,.disabled} && touch src/etc/debugger_pretty_printers_common.py`. With this configuration, for both the stock Ubuntu gdb and my custom build, I now get the following logs:\r\n\r\n[gdb-ubuntu-rust-debuginfo-no-pp.txt](https://github.com/rust-lang/rust/files/776171/gdb-ubuntu-rust-debuginfo-no-pp.txt)\r\n```\r\ntest result: FAILED. 90 passed; 4 failed; 13 ignored; 0 measured\r\n```\r\n\r\n[gdb-master-rust-debuginfo-no-pp.txt](https://github.com/rust-lang/rust/files/776172/gdb-master-rust-debuginfo-no-pp.txt): \r\n```\r\ntest result: FAILED. 98 passed; 6 failed; 3 ignored; 0 measured\r\n```\r\n\r\nThis means one of two things\r\n\r\n1. The `gdbr-check` annotations in the tests are out of sync with the pretty printer scripts, and the tests are expecting the wrong output. If this is the case, I have a commit at amboar/rust@67bffe3c91237b99de636109d1a54c8fdbb5451c which makes the expectations match the output. This commit was mechanically generated and the script used is included in the commit message.\r\n2. Alternatively, gdb is loading the pretty printer scripts when it shouldn't be, and this is negatively affecting the test results.\r\n\r\nMiscellaneous testing gotchas:\r\n\r\n1. Rust caches the test results and won't re-run tests that succeeded previous: need to `rm -rf ./build/x86_64-unknown-linux-gnu/test/debuginfo/*`\r\n2. Changing the gdb invoked by the test suite: Use `sed -ri '/CFG_GDB/s|/usr/bin/gdb|/usr/local/bin/gdb|' config.mk`, and switch the search and replace patterns around as necessary\r\n3. Build gdb with Python support", "closed_by": {"login": "amboar", "id": 526481, "node_id": "MDQ6VXNlcjUyNjQ4MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/526481?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amboar", "html_url": "https://github.com/amboar", "followers_url": "https://api.github.com/users/amboar/followers", "following_url": "https://api.github.com/users/amboar/following{/other_user}", "gists_url": "https://api.github.com/users/amboar/gists{/gist_id}", "starred_url": "https://api.github.com/users/amboar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amboar/subscriptions", "organizations_url": "https://api.github.com/users/amboar/orgs", "repos_url": "https://api.github.com/users/amboar/repos", "events_url": "https://api.github.com/users/amboar/events{/privacy}", "received_events_url": "https://api.github.com/users/amboar/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/39838/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/39838/timeline", "performed_via_github_app": null, "state_reason": "completed"}