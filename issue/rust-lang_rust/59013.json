{"url": "https://api.github.com/repos/rust-lang/rust/issues/59013", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/59013/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/59013/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/59013/events", "html_url": "https://github.com/rust-lang/rust/issues/59013", "id": 418750191, "node_id": "MDU6SXNzdWU0MTg3NTAxOTE=", "number": 59013, "title": "Weird error span for a mix of proc macro attributes", "user": {"login": "nox", "id": 123095, "node_id": "MDQ6VXNlcjEyMzA5NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/123095?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nox", "html_url": "https://github.com/nox", "followers_url": "https://api.github.com/users/nox/followers", "following_url": "https://api.github.com/users/nox/following{/other_user}", "gists_url": "https://api.github.com/users/nox/gists{/gist_id}", "starred_url": "https://api.github.com/users/nox/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nox/subscriptions", "organizations_url": "https://api.github.com/users/nox/orgs", "repos_url": "https://api.github.com/users/nox/repos", "events_url": "https://api.github.com/users/nox/events{/privacy}", "received_events_url": "https://api.github.com/users/nox/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 132910982, "node_id": "MDU6TGFiZWwxMzI5MTA5ODI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-macros", "name": "A-macros", "color": "f7e101", "default": false, "description": "Area: All kinds of macros (custom derive, macro_rules!, proc macros, ..)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1359848690, "node_id": "MDU6TGFiZWwxMzU5ODQ4Njkw", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-mcve", "name": "E-needs-mcve", "color": "02e10c", "default": false, "description": "Call for participation: This issue needs a Minimal Complete and Verifiable Example"}, {"id": 1624891239, "node_id": "MDU6TGFiZWwxNjI0ODkxMjM5", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-incorrect", "name": "D-incorrect", "color": "c9f7a3", "default": false, "description": "A diagnostic that is giving misleading or incorrect information"}, {"id": 2079070889, "node_id": "MDU6TGFiZWwyMDc5MDcwODg5", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-proc-macros", "name": "A-proc-macros", "color": "f7e101", "default": false, "description": "Area: Procedural macros"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2019-03-08T11:33:03Z", "updated_at": "2023-03-15T19:49:34Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "In [Servo](https://github.com/servo/servo), we have a `proc_macro_attribute` named `dom_struct` which [emits](https://github.com/servo/servo/blob/ac3c002138cb2b2ebeaf840436d7022d4bb72ffc/components/dom_struct/lib.rs#L18-L22) a bunch of other attributes on the types it adorns, among which a `derive` attribute. `Node`, being itself a DOM struct, obviously [uses](https://github.com/servo/servo/blob/ac3c002138cb2b2ebeaf840436d7022d4bb72ffc/components/script/dom/node.rs#L98) it.\r\n\r\nIn the process of making use of [`inert`](https://github.com/nox/inert), I added an `#[inert::neutralize]` attribute on `Node` but I put it after `#[dom_struct]`, so rustc emitted an \"macro attributes must be placed before `#[derive]`\" error as it should, so far so good.\r\n\r\n```rust\r\n#[dom_struct]\r\n#[inert::neutralize(as pub unsafe InertNode)] // ERROR: macro attributes must be placed before `#[derive]`\r\npub struct Node {\r\n    ...\r\n}\r\n```\r\n\r\nThe problem is that the span itself of the error is completely wrong:\r\n\r\n```\r\nerror: macro attributes must be placed before `#[derive]`\r\n  --> components/script/lib.rs:1:1\r\n   |\r\n1  | / /* This Source Code Form is subject to the terms of the Mozilla Public\r\n2  | |  * License, v. 2.0. If a copy of the MPL was not distributed with this\r\n3  | |  * file, You can obtain one at https://mozilla.org/MPL/2.0/. */\r\n4  | |\r\n...  |\r\n97 | | use crate::dom::bindings::proxyhandler;\r\n98 | | use crate::serviceworker_manager::ServiceWorkerManager;\r\n   | |_____________^\r\n```\r\n\r\nMost notably, `use crate::serviceworker_manager::ServiceWorkerManager;` is [line 56](https://github.com/servo/servo/blob/ac3c002138cb2b2ebeaf840436d7022d4bb72ffc/components/script/dom/node.rs#L56) in that file.\r\n\r\nThings that should be kept in mind while trying to debug that is that I don't use `quote_spanned!` for this [specific kind](https://github.com/nox/inert/blob/76bdf377e8054e710de975f36eeb677bc49bfd6b/derive/src/lib.rs#L180-L209) of `inert::neutralize` attribute, but `dom_struct` itself does [weird things](https://github.com/servo/servo/blob/ac3c002138cb2b2ebeaf840436d7022d4bb72ffc/components/dom_struct/lib.rs#L24-L25) because of #46489, but I really don't know if the wrong span is related to that bug.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/59013/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/59013/timeline", "performed_via_github_app": null, "state_reason": null}