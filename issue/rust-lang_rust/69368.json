{"url": "https://api.github.com/repos/rust-lang/rust/issues/69368", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/69368/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/69368/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/69368/events", "html_url": "https://github.com/rust-lang/rust/issues/69368", "id": 569308666, "node_id": "MDU6SXNzdWU1NjkzMDg2NjY=", "number": 69368, "title": "Undefined reference to weak lang items when compilation contains many codegen units ", "user": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2020-02-22T09:28:20Z", "updated_at": "2020-03-04T11:06:27Z", "closed_at": "2020-03-04T11:06:27Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Compiling following under some circumstances result in undefined references to `rust_oom`:\r\n\r\n```rust\r\nuse std::alloc::{GlobalAlloc, System, Layout};\r\n\r\n#[global_allocator]\r\nstatic GLOBAL: Allocator = Allocator;\r\n\r\nstruct Allocator;\r\n\r\nunsafe impl GlobalAlloc for Allocator {\r\n    unsafe fn alloc(&self, layout: Layout) -> *mut u8 { \r\n        System.alloc(layout)\r\n    }\r\n    unsafe fn dealloc(&self, ptr: *mut u8, layout: Layout) {\r\n        System.dealloc(ptr, layout)\r\n    }\r\n}\r\n\r\nfn main() {}\r\n```\r\n\r\n```shell\r\n$ cargo -Zbuild-std test --target x86_64-unknown-linux-gnu\r\n...\r\nerror: linking with `cc` failed: exit code: 1\r\n  |\r\n  = note: /usr/bin/ld: /.../target/x86_64-unknown-linux-gnu/debug/deps/liballoc-6e5029e924b1689e.rlib(alloc-6e5029e924b1689e.2h1lbzecyhyarcje.rcgu.o): in function `alloc::alloc::handle_alloc_error':\r\n          /.../.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/liballoc/alloc.rs:246: undefined reference to `rust_oom'\r\n```\r\n\r\nThis linking issue occurs only under for some codegen partitioning but not the\r\nothers. Reproducing it requires controlling the options that influence the\r\nnumber of codegen units. I can reproduce it with either `incremental = true`,\r\nor `incremental = false` combined with `codegen-units = 200`.\r\n\r\nThe weak lang items introduce cyclic dependencies between crates. For example,\r\nthe alloc crate depends on oom lang item which is defined in std. When linking\r\nthe std comes first, and it may so happen that object file that contains\r\n`rust_oom` definition is not used and omitted (this suggest why large number of\r\ncodegen units is necessary to reproduce the issue), and subsequently alloc\r\ncrate will fail to link.\r\n\r\nThe [linking code][0] tries to account for cyclic dependencies using\r\nstart-group and end-group, but as far as I can see it based on assumption that\r\nweak lang items dependencies are always reversed, which no longer holds true.\r\n\r\n[0]: https://github.com/rust-lang/rust/blob/87e494c4cdf3f4f39d25ca008173f80688b8eb3d/src/librustc_codegen_ssa/back/link.rs#L1496-L1537\r\n", "closed_by": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/69368/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/69368/timeline", "performed_via_github_app": null, "state_reason": "completed"}