{"url": "https://api.github.com/repos/rust-lang/rust/issues/50178", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/50178/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/50178/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/50178/events", "html_url": "https://github.com/rust-lang/rust/issues/50178", "id": 316784996, "node_id": "MDU6SXNzdWUzMTY3ODQ5OTY=", "number": 50178, "title": "Rerast incremental compilation - already existing DepNode error", "user": {"login": "kornelski", "id": 72159, "node_id": "MDQ6VXNlcjcyMTU5", "avatar_url": "https://avatars.githubusercontent.com/u/72159?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kornelski", "html_url": "https://github.com/kornelski", "followers_url": "https://api.github.com/users/kornelski/followers", "following_url": "https://api.github.com/users/kornelski/following{/other_user}", "gists_url": "https://api.github.com/users/kornelski/gists{/gist_id}", "starred_url": "https://api.github.com/users/kornelski/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kornelski/subscriptions", "organizations_url": "https://api.github.com/users/kornelski/orgs", "repos_url": "https://api.github.com/users/kornelski/repos", "events_url": "https://api.github.com/users/kornelski/events{/privacy}", "received_events_url": "https://api.github.com/users/kornelski/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-04-23T12:11:19Z", "updated_at": "2018-04-24T14:30:59Z", "closed_at": "2018-04-24T14:30:59Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "https://github.com/google/rerast/issues/17#issuecomment-383504608\r\n\r\n[Rerast](https://github.com/google/rerast) (version 4928293ed19d3a3a8e5fd70aedd63a4526cdda79, because later commit disabled incremental compilation) panics:\r\n\r\n<pre>\r\nthread 'main' panicked at 'Forcing query with already existing DepNode.\r\n\r\nquery-key: ParamEnvAnd { param_env: ParamEnv { caller_bounds: Slice([]), reveal: UserFacing }, value: unsafe extern \"rust-intrinsic\" fn(*const std::os::raw::c_void) -> extern \"system\" fn(u32, i32, *mut i32) {std::intrinsics::transmute::<*const std::os::raw::c_void, extern \"system\" fn(u32, i32, *mut i32)>} }\r\ndep-node: IsCopy(7cbec90d2168a3bd-88dbb5e68c554118)', librustc/ty/maps/mod.rs:97:1\r\nstack backtrace:\r\n[\u2026] at libstd/panicking.rs:347\r\n7: rustc::ty::maps::<impl rustc::ty::maps::queries::is_copy_raw<'tcx>>::force_with_lock\r\n8: rustc::ty::maps::<impl rustc::ty::maps::queries::is_copy_raw<'tcx>>::try_get\r\n9: rustc::ty::maps::TyCtxtAt::is_copy_raw\r\n10: rustc::middle::mem_categorization::MemCategorizationContext::type_moves_by_default\r\n11: rustc::middle::expr_use_visitor::ExprUseVisitor::consume_expr\r\n12: rustc::middle::expr_use_visitor::ExprUseVisitor::walk_expr\r\n13: rustc::middle::expr_use_visitor::ExprUseVisitor::walk_expr\r\n14: rustc::middle::expr_use_visitor::ExprUseVisitor::walk_expr\r\n15: <rustc_passes::rvalue_promotion::CheckCrateVisitor<'a, 'tcx> as rustc::hir::intravisit::Visitor<'tcx>>::visit_nested_body\r\n16: rustc_passes::rvalue_promotion::rvalue_promotable_map\r\n17: rustc::dep_graph::graph::DepGraph::with_task_impl\r\n18: rustc::ty::context::tls::with_related_context\r\n19: rustc::ty::maps::<impl rustc::ty::maps::queries::rvalue_promotable_map<'tcx>>::force_with_lock\r\n20: rustc::ty::maps::<impl rustc::ty::maps::queries::rvalue_promotable_map<'tcx>>::try_get\r\n21: rustc::ty::maps::TyCtxtAt::rvalue_promotable_map\r\n22: rustc::ty::maps::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'lcx>>::rvalue_promotable_map\r\n23: rustc_passes::rvalue_promotion::const_is_rvalue_promotable_to_static\r\n24: rustc::dep_graph::graph::DepGraph::with_task_impl\r\n25: rustc::ty::context::tls::with_related_context\r\n26: rustc::ty::maps::<impl rustc::ty::maps::queries::const_is_rvalue_promotable_to_static<'tcx>>::force_with_lock\r\n27: rustc::ty::maps::<impl rustc::ty::maps::queries::const_is_rvalue_promotable_to_static<'tcx>>::try_get\r\n28: rustc::ty::maps::TyCtxtAt::const_is_rvalue_promotable_to_static\r\n29: rustc::ty::maps::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'lcx>>::const_is_rvalue_promotable_to_static\r\n30: rustc_passes::rvalue_promotion::check_crate\r\n31: rustc::ty::context::tls::enter_context\r\n32: std::thread::local::LocalKey::with\r\n33: rustc::ty::context::TyCtxt::create_and_enter\r\n34: rustc_driver::driver::compile_input\r\n35: rustc_driver::run_compiler_impl\r\n36: syntax::with_globals\r\n37: rustc_driver::run_compiler\r\n</pre> \r\n\r\nTo reproduce:\r\n\r\n```sh\r\ncargo +nightly install --force --git https://github.com/google/rerast.git --rev 4928293ed19d3a3a8e5fd70aedd63a4526cdda79\r\ngit clone https://github.com/tomaka/glutin; \r\ncd glutin\r\ngit checkout a5a51e3ddcfd2677e757d89bb63d750b99fab7fc\r\n```\r\n\r\nmake file `rule.rs` with:\r\n\r\n```rust\r\nfn rule1<T,E,X: From<E>>(r: Result<T,E>) -> Result<T,X> {\r\n    replace!(try!(r) => r?);\r\n    unreachable!()\r\n}\r\n```\r\n\r\nrun\r\n\r\n```sh\r\ncargo +nightly rerast --rules_file=rule.rs --force --verbose\r\n```", "closed_by": {"login": "kornelski", "id": 72159, "node_id": "MDQ6VXNlcjcyMTU5", "avatar_url": "https://avatars.githubusercontent.com/u/72159?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kornelski", "html_url": "https://github.com/kornelski", "followers_url": "https://api.github.com/users/kornelski/followers", "following_url": "https://api.github.com/users/kornelski/following{/other_user}", "gists_url": "https://api.github.com/users/kornelski/gists{/gist_id}", "starred_url": "https://api.github.com/users/kornelski/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kornelski/subscriptions", "organizations_url": "https://api.github.com/users/kornelski/orgs", "repos_url": "https://api.github.com/users/kornelski/repos", "events_url": "https://api.github.com/users/kornelski/events{/privacy}", "received_events_url": "https://api.github.com/users/kornelski/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/50178/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/50178/timeline", "performed_via_github_app": null, "state_reason": "completed"}