{"url": "https://api.github.com/repos/rust-lang/rust/issues/26755", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/26755/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/26755/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/26755/events", "html_url": "https://github.com/rust-lang/rust/issues/26755", "id": 92826171, "node_id": "MDU6SXNzdWU5MjgyNjE3MQ==", "number": 26755, "title": "The inner span for an empty module should point to the module's file", "user": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 27424086, "node_id": "MDU6TGFiZWwyNzQyNDA4Ng==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-parser", "name": "A-parser", "color": "f7e101", "default": false, "description": "Area: The parsing of Rust source code to an AST."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2015-07-03T08:53:19Z", "updated_at": "2015-07-21T11:33:04Z", "closed_at": "2015-07-21T11:33:04Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Assume you have `mod foo` where foo.rs is an empty file. There will be an `ItemMod` for the module and it's `inner` span will be a dummy span. It would be more useful if that span could be a zero-length span pointing into foo.rs's `FileMap`. (This is possible with a PR which should land soon). This would be useful since it gives tools an easy to deal with empty modules, at the moment they have to do all kinds of hacks to handle them.\n\nI experimented a bit with this, but I couldn't get it to work. Here is what I found:\n\nThe parser for the outer file will create a new parser to parse foo.rs, that will wrap a TTReader which has a single `Eof` token. The TTReader is created by running a StringReader over foo.rs (a StringReader being pretty much Rust's lexer). I believe, although I haven't confirmed, that for an empty file, that Eof token comes from `syntax::ext::tt::transcribe::tt_next_token` (line 217 today). However, there we don't have the `FileMap`.\n\nMy attempt to fix this was to check the result in `syntax::parse::filemap_to_parser`, if the token of the parser is `Eof` and the span is `DUMMY_SP`, then I replaced the span with the zero_length span at the `end_pos` of the `FileMap`. This broke sub-module lookup in the parser (which surprised me), the parser's `span` field was incorrect (one module too far out). At this stage I decided to give up.\n", "closed_by": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/26755/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/26755/timeline", "performed_via_github_app": null, "state_reason": "completed"}