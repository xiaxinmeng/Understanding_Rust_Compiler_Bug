{"url": "https://api.github.com/repos/rust-lang/rust/issues/112767", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/112767/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/112767/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/112767/events", "html_url": "https://github.com/rust-lang/rust/issues/112767", "id": 1762304841, "node_id": "I_kwDOAAsO6M5pCqNJ", "number": 112767, "title": "Miscompilation: wrong branch taken on x86_64", "user": {"login": "cbeuw", "id": 7034308, "node_id": "MDQ6VXNlcjcwMzQzMDg=", "avatar_url": "https://avatars.githubusercontent.com/u/7034308?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cbeuw", "html_url": "https://github.com/cbeuw", "followers_url": "https://api.github.com/users/cbeuw/followers", "following_url": "https://api.github.com/users/cbeuw/following{/other_user}", "gists_url": "https://api.github.com/users/cbeuw/gists{/gist_id}", "starred_url": "https://api.github.com/users/cbeuw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cbeuw/subscriptions", "organizations_url": "https://api.github.com/users/cbeuw/orgs", "repos_url": "https://api.github.com/users/cbeuw/repos", "events_url": "https://api.github.com/users/cbeuw/events{/privacy}", "received_events_url": "https://api.github.com/users/cbeuw/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}, {"id": 1966910227, "node_id": "MDU6TGFiZWwxOTY2OTEwMjI3", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-prioritize", "name": "I-prioritize", "color": "e10c02", "default": false, "description": "Indicates that prioritization has been requested for this issue"}, {"id": 2242906716, "node_id": "MDU6TGFiZWwyMjQyOTA2NzE2", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-raw-pointers", "name": "A-raw-pointers", "color": "f7e101", "default": false, "description": "Area: raw pointers, MaybeUninit, NonNull"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2023-06-18T13:41:59Z", "updated_at": "2023-06-18T14:34:15Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Fuzzer generated code then minimised\r\n\r\n```rust\r\nuse std::ptr;\r\n\r\npub fn dump_var(\r\n    f: usize,\r\n    var0: usize,\r\n    val0: i32,\r\n    var1: usize,\r\n    val1: i32,\r\n    var2: usize,\r\n    val2: i32,\r\n    var3: usize,\r\n    val3: i32,\r\n) {\r\n    println!(\"fn{f}:_{var0} = {val0}, _{var1} = {val1}, _{var2} = {val2}, _{var3} = {val3}\");\r\n}\r\n\r\nunsafe fn fn2(mut _2: *mut i32) {\r\n    println!(\"entering fn2\");\r\n    let mut np: *mut i128 = ptr::null_mut();\r\n    let mut npp = ptr::addr_of_mut!(np);\r\n    let mut byte: u8 = 0;\r\n    let byte_ptr = ptr::addr_of_mut!(byte);\r\n    let mut discr: i128 = 0;\r\n    let mut _16 = ptr::addr_of_mut!(discr);\r\n    *_16 = 19769033156256055278156766228563896803_i128;\r\n    fn3(npp, byte_ptr, [0; 4], _2, 0, *_16);\r\n    loop {\r\n        npp = ptr::addr_of_mut!(_16);\r\n        match discr {\r\n            3 => {\r\n                discr = 0;\r\n                fn3(npp, byte_ptr, [0; 4], _2, *_16, *_16);\r\n            }\r\n            _ => return,\r\n        }\r\n    }\r\n}\r\n\r\npub unsafe fn fn3(\r\n    mut _5: *mut *mut i128,\r\n    byte_ptr: *mut u8,\r\n    mut _7: [i64; 4],\r\n    mut _8: *mut i32,\r\n    mut _9: i128,\r\n    mut big_num: i128,\r\n) {\r\n    println!(\"entering fn3\");\r\n    (*_5) = ptr::addr_of_mut!(big_num);\r\n    *byte_ptr = 0;\r\n    fn4(big_num, *_8, _5, _9, *_5);\r\n    _7 = [0; 4];\r\n}\r\n\r\npub unsafe fn fn4(\r\n    big_num: i128,\r\n    mut _7: i32,\r\n    mut _8: *mut *mut i128,\r\n    mut _12: i128,\r\n    mut _13: *mut i128,\r\n) {\r\n    println!(\"entering fn4\");\r\n    (*_13) = 0; // This cannot change big_num as it was passed by value\r\n    match big_num {\r\n        19769033156256055278156766228563896803 => {\r\n            println!(\"right branch\");\r\n            (*_8) = ptr::addr_of_mut!(_12);\r\n            fn5(_7)\r\n        }\r\n        _ => {\r\n            println!(\"wrong branch\");\r\n            return;\r\n        }\r\n    }\r\n}\r\n\r\npub fn fn5(mut _1: i32) {\r\n    println!(\"entering fn5\");\r\n    dump_var(5, 1, _1, 0, 0, 0, 0, 0, 0);\r\n}\r\n\r\npub fn main() {\r\n    let mut _6: i32 = 0;\r\n    let _16 = ptr::addr_of_mut!(_6);\r\n    unsafe { fn2(_16) }\r\n}\r\n```\r\n\r\nMiri reports no UB under either aliasing model, and it should print \r\n```console\r\nentering fn2\r\nentering fn3\r\nentering fn4\r\nright branch\r\nentering fn5\r\nfn5:_1 = 0, _0 = 0, _0 = 0, _0 = 0\r\n```\r\n\r\nWith `-Zmir-opt-level=0 -Copt-level>=2`, it takes the wrong branch in `fn4` and doesn't call `fn5`.\r\n```console\r\n$ rustc -Zmir-opt-level=0 -Copt-level=2 repro.rs && ./repro\r\nentering fn2\r\nentering fn3\r\nentering fn4\r\nwrong branch\r\n```\r\n\r\nOnly reproducible on `x86_64`, not `aarch64`\r\n\r\n```console\r\nrustc 1.72.0-nightly (3b2073f07 2023-06-17)\r\nbinary: rustc\r\ncommit-hash: 3b2073f0762cff4d3d625bb10017e0ce4e7abe50\r\ncommit-date: 2023-06-17\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.72.0-nightly\r\nLLVM version: 16.0.5\r\n```\r\n\r\ncc @nikic ", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/112767/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/112767/timeline", "performed_via_github_app": null, "state_reason": null}