{"url": "https://api.github.com/repos/rust-lang/rust/issues/91968", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/91968/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/91968/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/91968/events", "html_url": "https://github.com/rust-lang/rust/issues/91968", "id": 1081151735, "node_id": "I_kwDOAAsO6M5AcRD3", "number": 91968, "title": "Undefined reference to __tsan_init when using thread sanitizer", "user": {"login": "NobodyXu", "id": 30436523, "node_id": "MDQ6VXNlcjMwNDM2NTIz", "avatar_url": "https://avatars.githubusercontent.com/u/30436523?v=4", "gravatar_id": "", "url": "https://api.github.com/users/NobodyXu", "html_url": "https://github.com/NobodyXu", "followers_url": "https://api.github.com/users/NobodyXu/followers", "following_url": "https://api.github.com/users/NobodyXu/following{/other_user}", "gists_url": "https://api.github.com/users/NobodyXu/gists{/gist_id}", "starred_url": "https://api.github.com/users/NobodyXu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/NobodyXu/subscriptions", "organizations_url": "https://api.github.com/users/NobodyXu/orgs", "repos_url": "https://api.github.com/users/NobodyXu/repos", "events_url": "https://api.github.com/users/NobodyXu/events{/privacy}", "received_events_url": "https://api.github.com/users/NobodyXu/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2021-12-15T05:56:24Z", "updated_at": "2021-12-16T00:08:38Z", "closed_at": "2021-12-16T00:08:38Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "### Problem\r\n\r\nI am trying to use thread sanitizer in [my fork of triomphe](https://github.com/NobodyXu/triomphe) and it has link errors when trying to use thread sanitizer, complaining that a lot of symbols started with `__tsan_` is not found.\r\n\r\nHere is the [log](https://github.com/NobodyXu/triomphe/runs/4530192026?check_suite_focus=true) for the errors (it also failed on my computer).\r\n\r\nLooking at the command used in linking, it seems that `rustc` didn't enable thread sanitizer using `-fsanitize=thread`.\r\n\r\n```\r\n  = note: \"cc\" \"-m64\" \"/tmp/rustdoctestbg4CHc/rust_out.rust_out.1376475e-cgu.0.rcgu.o\" \"/tmp/rustdoctestbg4CHc/rust_out.3oi7hjnjienb8flc.rcgu.o\" \"-Wl,--as-needed\" \"-L\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps\" \"-L\" \"/home/runner/work/triomphe/triomphe/target/debug/deps\" \"-L\" \"/home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-Wl,-Bstatic\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libtriomphe-4868d43b5964945c.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libstable_deref_trait-62193f8fb5c13074.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libserde-d532e61b9a54ea8f.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libmemoffset-793678c9d116a3a9.rlib\" \"-Wl,--start-group\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libstd-e6aec2a875c401ae.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libpanic_unwind-27978ec139b8e8b6.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libminiz_oxide-7ac06f911a3d6b26.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libadler-587439a6ae9f9fae.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libobject-a68a19d2fe64c521.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libmemchr-862919f7416845ee.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libaddr2line-61bd6bdfa82e83a2.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libgimli-3bf1af53ac54ff93.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libstd_detect-c4183b6f70b69172.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/librustc_demangle-fae3b074d6cde041.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libhashbrown-c7328df30f706e1c.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/librustc_std_workspace_alloc-ee176d63441f1d9c.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libunwind-b48f6fd7afb5ff65.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libcfg_if-124043d27ba65b25.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/liblibc-26e5cdbe255d5639.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/liballoc-496de79ccc19be0a.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/librustc_std_workspace_core-56980bdf30abc751.rlib\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libcore-a7bb8f77359f7f7d.rlib\" \"-Wl,--end-group\" \"/home/runner/work/triomphe/triomphe/target/x86_64-unknown-linux-gnu/debug/deps/libcompiler_builtins-6fe0500162851140.rlib\" \"-Wl,-Bdynamic\" \"-lgcc_s\" \"-lutil\" \"-lrt\" \"-lpthread\" \"-lm\" \"-ldl\" \"-lc\" \"-Wl,--eh-frame-hdr\" \"-Wl,-znoexecstack\" \"-L\" \"/home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-o\" \"/tmp/rustdoctestbg4CHc/rust_out\" \"-Wl,--gc-sections\" \"-pie\" \"-Wl,-zrelro,-znow\" \"-nodefaultlibs\"\r\n```\r\n\r\n### Steps\r\n\r\n1. `git clone https://github.com/NobodyXu/triomphe`\r\n2. `RUSTFLAGS='-Zsanitizer=thread' cargo +nightly test -Z build-std --target --target $(uname -m)-unknown-linux-gnu  -- --nocapture`\r\n\r\n### Possible Solution(s)\r\n\r\n_No response_\r\n\r\n### Notes\r\n\r\n_No response_\r\n\r\n### Version\r\n\r\nrustc on my laptop:\r\n\r\n```text\r\nrustc 1.59.0-nightly (404c8471a 2021-12-14)\r\nbinary: rustc\r\ncommit-hash: 404c8471aba60c2d837fa728e7c729a0f52d5830\r\ncommit-date: 2021-12-14\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.59.0-nightly\r\nLLVM version: 13.0.0\r\n```\r\n", "closed_by": {"login": "NobodyXu", "id": 30436523, "node_id": "MDQ6VXNlcjMwNDM2NTIz", "avatar_url": "https://avatars.githubusercontent.com/u/30436523?v=4", "gravatar_id": "", "url": "https://api.github.com/users/NobodyXu", "html_url": "https://github.com/NobodyXu", "followers_url": "https://api.github.com/users/NobodyXu/followers", "following_url": "https://api.github.com/users/NobodyXu/following{/other_user}", "gists_url": "https://api.github.com/users/NobodyXu/gists{/gist_id}", "starred_url": "https://api.github.com/users/NobodyXu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/NobodyXu/subscriptions", "organizations_url": "https://api.github.com/users/NobodyXu/orgs", "repos_url": "https://api.github.com/users/NobodyXu/repos", "events_url": "https://api.github.com/users/NobodyXu/events{/privacy}", "received_events_url": "https://api.github.com/users/NobodyXu/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/91968/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/91968/timeline", "performed_via_github_app": null, "state_reason": "completed"}