{"url": "https://api.github.com/repos/rust-lang/rust/issues/63384", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/63384/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/63384/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/63384/events", "html_url": "https://github.com/rust-lang/rust/issues/63384", "id": 478576288, "node_id": "MDU6SXNzdWU0Nzg1NzYyODg=", "number": 63384, "title": "Unnecessary mul when multiplying u128 by small number", "user": {"login": "tspiteri", "id": 18604588, "node_id": "MDQ6VXNlcjE4NjA0NTg4", "avatar_url": "https://avatars.githubusercontent.com/u/18604588?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tspiteri", "html_url": "https://github.com/tspiteri", "followers_url": "https://api.github.com/users/tspiteri/followers", "following_url": "https://api.github.com/users/tspiteri/following{/other_user}", "gists_url": "https://api.github.com/users/tspiteri/gists{/gist_id}", "starred_url": "https://api.github.com/users/tspiteri/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tspiteri/subscriptions", "organizations_url": "https://api.github.com/users/tspiteri/orgs", "repos_url": "https://api.github.com/users/tspiteri/repos", "events_url": "https://api.github.com/users/tspiteri/events{/privacy}", "received_events_url": "https://api.github.com/users/tspiteri/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 3, "created_at": "2019-08-08T16:34:35Z", "updated_at": "2020-05-23T18:46:36Z", "closed_at": "2020-05-23T18:46:35Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "For this function\r\n```rust\r\npub fn mul_u128_10(a: u128) -> (u8, u128) {\r\n    let (a_hi, a_lo) = (a >> 64, a & !(!0 << 64));\r\n    let (ten_a_hi, ten_a_lo) = (a_hi * 10, a_lo * 10);\r\n    let (wrapped, overflow) = (ten_a_hi << 64).overflowing_add(ten_a_lo);\r\n    ((ten_a_hi >> 64) as u8 + u8::from(overflow), wrapped)\r\n}\r\n```\r\nI would expect there to be two 64-bit multiplications, but I'm getting three, with one of them having a zero operand.\r\n```asm\r\ntry::mul_u128_10:\r\n mov     ecx, 10\r\n mov     rax, rsi\r\n mul     rcx\r\n mov     r10, rdx\r\n mov     rax, rdi\r\n mul     rcx\r\n mov     r9, rax\r\n mov     r8, rdx\r\n xor     ecx, ecx    ; set rcx to 0\r\n mov     rax, rsi\r\n mul     rcx         ; rdx:rax = rax \u00d7 rcx = rax \u00d7 0\r\n mov     rdi, rax\r\n lea     rax, [rsi, +, 4*rsi]\r\n lea     rcx, [rdx, +, 2*rax]\r\n add     rdi, r9\r\n adc     rcx, r8\r\n adc     r10b, 0\r\n mov     eax, r10d\r\n mov     rdx, rdi\r\n ret\r\n```\r\nI can work around this by writing\r\n```rust\r\npub fn mul_u128_10_workaround(a: u128) -> (u8, u128) {\r\n    let (a_hi, a_lo) = (a >> 64, a & !(!0 << 64));\r\n    let (ten_a_hi, ten_a_lo) = (a_hi * 10, a_lo * 10);\r\n    let (hi_hi, hi_lo) = ((ten_a_hi >> 64) as u64, ten_a_hi as u64);\r\n    let (lo_hi, lo_lo) = ((ten_a_lo >> 64) as u64, ten_a_lo as u64);\r\n    let (wrapped, overflow) = hi_lo.overflowing_add(lo_hi);\r\n    (\r\n        hi_hi as u8 + u8::from(overflow),\r\n        ((wrapped as u128) << 64) | (lo_lo as u128),\r\n    )\r\n}\r\n```\r\nwhich produces\r\n```asm\r\ntry::mul_u128_10_workaround:\r\n mov     rax, rsi\r\n mov     ecx, 10\r\n mul     rcx\r\n mov     rsi, rdx\r\n mov     r8, rax\r\n mov     rax, rdi\r\n mul     rcx\r\n mov     rdi, rax\r\n mov     rcx, rdx\r\n add     rcx, r8\r\n adc     sil, 0\r\n mov     eax, esi\r\n mov     rdx, rdi\r\n ret\r\n```\r\n\r\n**Edit:** Changed code above to remove an overflow, which did not affect this but could be distracting.\r\n\r\nI\u2019m guessing this is an LLVM issue in the end.\r\n```\r\n$ rustc --version --verbose\r\nrustc 1.36.0 (a53f9df32 2019-07-03)\r\nbinary: rustc\r\ncommit-hash: a53f9df32fbb0b5f4382caaad8f1a46f36ea887c\r\ncommit-date: 2019-07-03\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.36.0\r\nLLVM version: 8.0\r\n```", "closed_by": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/63384/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/63384/timeline", "performed_via_github_app": null, "state_reason": "completed"}