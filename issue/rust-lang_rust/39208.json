{"url": "https://api.github.com/repos/rust-lang/rust/issues/39208", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/39208/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/39208/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/39208/events", "html_url": "https://github.com/rust-lang/rust/issues/39208", "id": 202195205, "node_id": "MDU6SXNzdWUyMDIxOTUyMDU=", "number": 39208, "title": "\"serialize dep graph\" with CARGO_INCREMENTAL=1 takes 26 minutes and 18 GB RSS", "user": {"login": "SimonSapin", "id": 291359, "node_id": "MDQ6VXNlcjI5MTM1OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/291359?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SimonSapin", "html_url": "https://github.com/SimonSapin", "followers_url": "https://api.github.com/users/SimonSapin/followers", "following_url": "https://api.github.com/users/SimonSapin/following{/other_user}", "gists_url": "https://api.github.com/users/SimonSapin/gists{/gist_id}", "starred_url": "https://api.github.com/users/SimonSapin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SimonSapin/subscriptions", "organizations_url": "https://api.github.com/users/SimonSapin/orgs", "repos_url": "https://api.github.com/users/SimonSapin/repos", "events_url": "https://api.github.com/users/SimonSapin/events{/privacy}", "received_events_url": "https://api.github.com/users/SimonSapin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 307747675, "node_id": "MDU6TGFiZWwzMDc3NDc2NzU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-incr-comp", "name": "A-incr-comp", "color": "f7e101", "default": false, "description": "Area: Incremental compilation"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/rust-lang/rust/milestones/31", "html_url": "https://github.com/rust-lang/rust/milestone/31", "labels_url": "https://api.github.com/repos/rust-lang/rust/milestones/31/labels", "id": 2090457, "node_id": "MDk6TWlsZXN0b25lMjA5MDQ1Nw==", "number": 31, "title": "Incremental compilation across crates", "description": "After [the incremental beta](https://github.com/rust-lang/rust/milestone/30), another important step is to have the ability to reuse code across crates. In fact, the basic infrastructure for this exists already, but we need to make test cases representing the scenarios we expect and then fix the bugs that prevent those testcases from achieving the reuse we expect.", "creator": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 4, "state": "closed", "created_at": "2016-10-24T19:51:37Z", "updated_at": "2020-01-09T12:05:24Z", "due_on": null, "closed_at": "2017-03-06T18:08:51Z"}, "comments": 11, "created_at": "2017-01-20T17:18:04Z", "updated_at": "2017-02-22T22:22:02Z", "closed_at": "2017-02-06T12:31:53Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Building Servo with `CARGO_INCREMENTAL=1`, the `script` crate takes an unusually long time to build and uses a lot of RAM. Here is an extract of the output of `-Z time-passes`:\r\n\r\n```\r\ntime: 0.224; rss: 122MB\tparsing\r\n[\u2026]\r\ntime: 1.328; rss: 2689MB\tMIR optimisations\r\n  time: 0.296; rss: 2784MB\twrite metadata\r\n  time: 2.442; rss: 2871MB\ttranslation item collection\r\n  time: 0.717; rss: 2897MB\tcodegen unit partitioning\r\n  time: 0.608; rss: 10324MB\tinternalize symbols\r\ntime: 78.431; rss: 10325MB\ttranslation\r\ntime: 0.000; rss: 10325MB\tassert dep graph\r\ntime: 1603.681; rss: 10048MB\tserialize dep graph\r\n  time: 0.000; rss: 8851MB\tllvm function passes [2]\r\n  [\u2026]\r\n  time: 12.903; rss: 9397MB\tcodegen passes [42]\r\ntime: 51.898; rss: 9394MB\tLLVM passes\r\ntime: 0.000; rss: 9394MB\tserialize work products\r\ntime: 9.727; rss: 1411MB\tlinking\r\n```\r\n\r\nMost of the time (over 26 minutes) is spent in \"serialize dep graph\". During that time, RSS memory usage slowly grows from ~10 GB to ~18 GB. It goes back down to ~10 GB before the end of this pass.\r\n\r\nFor comparison, this is the same crate without `CARGO_INCREMENTAL=1` (but with `-C codegen-units=4`):\r\n\r\n```\r\ntime: 0.204; rss: 118MB\tparsing\r\n[\u2026]\r\ntime: 1.278; rss: 2093MB\tMIR optimisations\r\n  time: 0.279; rss: 2185MB\twrite metadata\r\n  time: 2.365; rss: 2269MB\ttranslation item collection\r\n  time: 0.987; rss: 2295MB\tcodegen unit partitioning\r\n  time: 0.582; rss: 4633MB\tinternalize symbols\r\ntime: 33.135; rss: 4633MB\ttranslation\r\ntime: 0.000; rss: 4633MB\tassert dep graph\r\ntime: 0.000; rss: 4633MB\tserialize dep graph\r\n  time: 0.904; rss: 3123MB\tllvm function passes [3]\r\n  [\u2026]\r\n  time: 30.495; rss: 3369MB\tcodegen passes [0]\r\ntime: 34.953; rss: 3369MB\tLLVM passes\r\ntime: 0.000; rss: 3369MB\tserialize work products\r\ntime: 2.195; rss: 468MB\tlinking\r\n    Finished dev [unoptimized + debuginfo] target(s) in 101.86 secs\r\n```\r\n\r\nCC @mw, @nikomatsakis @michaelwoerister ", "closed_by": {"login": "SimonSapin", "id": 291359, "node_id": "MDQ6VXNlcjI5MTM1OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/291359?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SimonSapin", "html_url": "https://github.com/SimonSapin", "followers_url": "https://api.github.com/users/SimonSapin/followers", "following_url": "https://api.github.com/users/SimonSapin/following{/other_user}", "gists_url": "https://api.github.com/users/SimonSapin/gists{/gist_id}", "starred_url": "https://api.github.com/users/SimonSapin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SimonSapin/subscriptions", "organizations_url": "https://api.github.com/users/SimonSapin/orgs", "repos_url": "https://api.github.com/users/SimonSapin/repos", "events_url": "https://api.github.com/users/SimonSapin/events{/privacy}", "received_events_url": "https://api.github.com/users/SimonSapin/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/39208/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/39208/timeline", "performed_via_github_app": null, "state_reason": "completed"}