{"url": "https://api.github.com/repos/rust-lang/rust/issues/31885", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/31885/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/31885/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/31885/events", "html_url": "https://github.com/rust-lang/rust/issues/31885", "id": 136356869, "node_id": "MDU6SXNzdWUxMzYzNTY4Njk=", "number": 31885, "title": "MADV_DONTNEED causing lots of minor page faults", "user": {"login": "keeperofdakeys", "id": 141626, "node_id": "MDQ6VXNlcjE0MTYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/141626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/keeperofdakeys", "html_url": "https://github.com/keeperofdakeys", "followers_url": "https://api.github.com/users/keeperofdakeys/followers", "following_url": "https://api.github.com/users/keeperofdakeys/following{/other_user}", "gists_url": "https://api.github.com/users/keeperofdakeys/gists{/gist_id}", "starred_url": "https://api.github.com/users/keeperofdakeys/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/keeperofdakeys/subscriptions", "organizations_url": "https://api.github.com/users/keeperofdakeys/orgs", "repos_url": "https://api.github.com/users/keeperofdakeys/repos", "events_url": "https://api.github.com/users/keeperofdakeys/events{/privacy}", "received_events_url": "https://api.github.com/users/keeperofdakeys/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2016-02-25T11:14:16Z", "updated_at": "2016-04-08T13:44:27Z", "closed_at": "2016-04-08T13:44:27Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I've got a [program](https://github.com/keeperofdakeys/Process-Query) that is experiencing lots minor of page faults (>12000 in >100 ms runtime), doubling its runtime. I suspect the issue is because of excessive madvise(..., ..., MADV_DONTNEED) calls. The following excerpts from perf stat, strace output, and perf trace output show the evidence. The behaviour occurs on a nightly from one week ago, and the current stable. However I can't replicate this on an older beta I have (rustc 1.7.0-beta.3), where no such madvise calls, or minor page faults occur.\n\nI can't find any madvise calls in the rust source code, so I'm a bit stumped in how to further investigate this issue.\n\nperf stat output:\n\n```\n         32.770167      task-clock (msec)         #    0.446 CPUs utilized          \n                 4      context-switches          #    0.122 K/sec                  \n                 0      cpu-migrations            #    0.000 K/sec                  \n            12,904      page-faults               #    0.394 M/sec                  \n       104,812,609      cycles                    #    3.198 GHz                    \n   <not supported>      stalled-cycles-frontend  \n   <not supported>      stalled-cycles-backend   \n       128,721,915      instructions              #    1.23  insns per cycle        \n        25,328,091      branches                  #  772.901 M/sec                  \n           182,971      branch-misses             #    0.72% of all branches        \n\n       0.073417400 seconds time elapsed\n```\n\nstrace output:\n\n```\nmadvise(0x7fb41ec6c000, 65536, MADV_DONTNEED) = 0\nopen(\"/proc/19/stat\", O_RDONLY|O_CLOEXEC) = 4\nioctl(4, FIOCLEX)                       = 0\nread(4, \"19 (ksoftirqd/3) S 2 0 0 0 -1 69\"..., 65536) = 155\nread(4, \"\", 65536)                      = 0\nclose(4)                                = 0\nmadvise(0x7fb41ec6c000, 65536, MADV_DONTNEED) = 0\nopen(\"/proc/19/status\", O_RDONLY|O_CLOEXEC) = 4\nioctl(4, FIOCLEX)                       = 0\nread(4, \"Name:\\tksoftirqd/3\\nState:\\tS (slee\"..., 65536) = 606\nread(4, \"\", 65536)                      = 0\nclose(4)                                = 0\nmadvise(0x7fb41ec6c000, 65536, MADV_DONTNEED) = 0\nopen(\"/proc/19/cmdline\", O_RDONLY|O_CLOEXEC) = 4\nioctl(4, FIOCLEX)                       = 0\nread(4, \"\", 65536)                      = 0\nclose(4)                                = 0\n```\n\nperf trace output:\n\n```\n    12.150 ( 0.003 ms): psq/11143 read(arg0: 4, arg1: 140038575144960, arg2: 65536, arg3: 140038578897296, arg4: 0, arg5: 7976) = 155\n    12.153 ( 0.001 ms): psq/11143 read(arg0: 4, arg1: 140038575144960, arg2: 65536, arg3: 140038578897296, arg4: 0, arg5: 0) = 0\n    12.155 ( 0.001 ms): psq/11143 close(arg0: 4, arg1: 256, arg2: 140731978476463, arg3: 140038578897296, arg4: 0, arg5: 0) = 0\n    12.160 ( 0.004 ms): psq/11143 madvise(arg0: 140038575144960, arg1: 65536, arg2: 4, arg3: -4194304, arg4: 140038574702592, arg5: 140731978474016) = 0\n    12.166 ( 0.002 ms): psq/11143 open(arg0: 140038575052128, arg1: 524288, arg2: 438, arg3: 140731978478280, arg4: 0, arg5: 0) = 4\n    12.168 ( 0.001 ms): psq/11143 ioctl(arg0: 4, arg1: 21585, arg2: 438, arg3: 140731978478280, arg4: 0, arg5: 0) = 0\n    12.170 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x12e] => //anon@0x7f5d4586c000 (d.)\n    12.171 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4586d000 (d.)\n    12.173 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4586e000 (d.)\n    12.174 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4586f000 (d.)\n    12.176 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45870000 (d.)\n    12.177 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45871000 (d.)\n    12.179 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45872000 (d.)\n    12.180 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45873000 (d.)\n    12.182 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45874000 (d.)\n    12.183 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45875000 (d.)\n    12.185 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45876000 (d.)\n    12.186 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45877000 (d.)\n    12.188 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45878000 (d.)\n    12.189 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45879000 (d.)\n    12.191 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4587a000 (d.)\n    12.193 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4587b000 (d.)\n    12.200 ( 0.007 ms): psq/11143 read(arg0: 4, arg1: 140038575144960, arg2: 65536, arg3: 8, arg4: 2097865012304223517, arg5: 768) = 612\n    12.212 ( 0.001 ms): psq/11143 read(arg0: 4, arg1: 140038575144960, arg2: 65536, arg3: 6, arg4: 26, arg5: -7900185713307138509) = 0\n    12.214 ( 0.001 ms): psq/11143 close(arg0: 4, arg1: 0, arg2: 0, arg3: 6, arg4: 2097865012304223517, arg5: -7900185713307138509) = 0\n    12.219 ( 0.003 ms): psq/11143 madvise(arg0: 140038575144960, arg1: 65536, arg2: 4, arg3: -4194304, arg4: 140038574702592, arg5: 140731978467840) = 0\n    12.226 ( 0.003 ms): psq/11143 open(arg0: 140038575052256, arg1: 524288, arg2: 438, arg3: 140731978477464, arg4: 0, arg5: 0) = 4\n    12.228 ( 0.001 ms): psq/11143 ioctl(arg0: 4, arg1: 21585, arg2: 438, arg3: 140731978477464, arg4: 0, arg5: 0) = 0\n    12.229 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x12e] => //anon@0x7f5d4586c000 (d.)\n    12.231 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4586d000 (d.)\n    12.232 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4586e000 (d.)\n    12.234 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4586f000 (d.)\n    12.235 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45870000 (d.)\n    12.237 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45871000 (d.)\n    12.238 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45872000 (d.)\n    12.240 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45873000 (d.)\n    12.242 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45874000 (d.)\n    12.243 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45875000 (d.)\n    12.245 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45876000 (d.)\n    12.246 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45877000 (d.)\n    12.248 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45878000 (d.)\n    12.249 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45879000 (d.)\n    12.251 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4587a000 (d.)\n    12.253 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4587b000 (d.)\n    12.255 ( 0.001 ms): psq/11143 read(arg0: 4, arg1: 140038575144960, arg2: 65536, arg3: 140038578897296, arg4: 0, arg5: 7976) = 0\n    12.256 ( 0.001 ms): psq/11143 close(arg0: 4, arg1: 65536, arg2: 0, arg3: 140038578897296, arg4: 0, arg5: 7976) = 0\n    12.261 ( 0.003 ms): psq/11143 madvise(arg0: 140038575144960, arg1: 65536, arg2: 4, arg3: -4194304, arg4: 140038574702592, arg5: 140731978474016) = 0\n    12.267 ( 0.003 ms): psq/11143 open(arg0: 140038574969424, arg1: 524288, arg2: 438, arg3: 0, arg4: 0, arg5: 0) = 4\n    12.269 ( 0.001 ms): psq/11143 ioctl(arg0: 4, arg1: 21585, arg2: 438, arg3: 0, arg4: 0, arg5: 0      ) = 0\n    12.270 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x12e] => //anon@0x7f5d4586c000 (d.)\n    12.272 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4586d000 (d.)\n    12.273 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4586e000 (d.)\n    12.275 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4586f000 (d.)\n    12.276 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45870000 (d.)\n    12.278 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45871000 (d.)\n    12.279 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45872000 (d.)\n    12.281 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45873000 (d.)\n    12.282 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45874000 (d.)\n    12.284 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45875000 (d.)\n    12.285 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45876000 (d.)\n    12.287 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45877000 (d.)\n    12.288 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45878000 (d.)\n    12.290 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d45879000 (d.)\n    12.292 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4587a000 (d.)\n    12.293 ( 0.000 ms): psq/11143 minfault [/lib64/libc-2.22.so@__memset_avx2+0x188] => //anon@0x7f5d4587b000 (d.)\n```\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/31885/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/31885/timeline", "performed_via_github_app": null, "state_reason": "completed"}