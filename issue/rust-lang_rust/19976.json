{"url": "https://api.github.com/repos/rust-lang/rust/issues/19976", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/19976/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/19976/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/19976/events", "html_url": "https://github.com/rust-lang/rust/issues/19976", "id": 52342148, "node_id": "MDU6SXNzdWU1MjM0MjE0OA==", "number": 19976, "title": "ICE in rematch_impl during attempt at double dispatch", "user": {"login": "stuglaser", "id": 1527117, "node_id": "MDQ6VXNlcjE1MjcxMTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1527117?v=4", "gravatar_id": "", "url": "https://api.github.com/users/stuglaser", "html_url": "https://github.com/stuglaser", "followers_url": "https://api.github.com/users/stuglaser/followers", "following_url": "https://api.github.com/users/stuglaser/following{/other_user}", "gists_url": "https://api.github.com/users/stuglaser/gists{/gist_id}", "starred_url": "https://api.github.com/users/stuglaser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/stuglaser/subscriptions", "organizations_url": "https://api.github.com/users/stuglaser/orgs", "repos_url": "https://api.github.com/users/stuglaser/repos", "events_url": "https://api.github.com/users/stuglaser/events{/privacy}", "received_events_url": "https://api.github.com/users/stuglaser/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2014-12-18T09:35:00Z", "updated_at": "2015-05-12T20:47:24Z", "closed_at": "2015-05-12T20:47:24Z", "author_association": "NONE", "active_lock_reason": null, "body": "I came across this failure while trying to implement double dispatch.  Here's the reduced code to reproduce it:\n\n```\npub trait MatBase {\n    // Base method for double dispatch.\n    // Performs: MatBase * f32\n    fn mul_scalar(&self, scalar: &f32) -> Mat {\n        Mat::new()\n    }\n\n    // Base method for double dispatch.\n    // Performs: MatBase * MatBase\n    fn mul_mat<T:MatBase>(&self, rhs: &T) -> Mat {\n        Mat::new()\n    }        \n}\n\n\npub struct Mat {\n    pub r: uint,\n}\n\nimpl Mat {\n    pub fn new() -> Mat {\n        Mat {r: 0}\n    }\n}\n\nimpl MatBase for Mat {\n}\n\nimpl<T:MatBase, U: LMulMatBase> Mul<U, Mat> for T {\n    fn mul(&self, rhs: &U) -> Mat {\n        rhs.lmul_matbase(self)\n    }\n}\n\n// Trait for double dispatch.  Called for `MatBase * X`\ntrait LMulMatBase {\n    fn lmul_matbase<T:MatBase>(&self, &T) -> Mat;\n}\n\nimpl LMulMatBase for f32 {\n    fn lmul_matbase<T:MatBase>(&self, rhs: &T) -> Mat {\n        rhs.mul_scalar(self)\n    }\n}\n\nimpl<U:MatBase> LMulMatBase for U {\n    fn lmul_matbase<T:MatBase>(&self, rhs: &T) -> Mat {\n        rhs.mul_mat(self)\n    }\n}\n\n\npub fn generate_ice() {\n    let v = Mat::new();\n\n    // ICE\n    let foo = v * 2.0;\n    let bar = v * 2;\n}\n\nfn main() {\n}\n```\n\nProduces...\n\n```\nice.rs:31:5: 33:6 error: method `mul` has an incompatible type for trait: expected type parameter, found &-ptr [E0053]\nice.rs:31     fn mul(&self, rhs: &U) -> Mat {\nice.rs:32         rhs.lmul_matbase(self)\nice.rs:33     }\nerror: internal compiler error: Impl DefId { krate: 0, node: 104 }:f32.LMulMatBase was matchable against Obligation(trait_ref=<_ : LMulMatBase>,depth=1) but now is not\nnote: the compiler unexpectedly panicked. this is a bug.\nnote: we would appreciate a bug report: http://doc.rust-lang.org/complement-bugreport.html\nnote: run with `RUST_BACKTRACE=1` for a backtrace\ntask 'rustc' panicked at 'Box<Any>', /home/rustbuild/src/rust-buildbot/slave/nightly-linux/build/src/libsyntax/diagnostic.rs:188\n\nstack backtrace:\n   1:     0x7f7baf436c60 - rt::backtrace::imp::write::hb0dcc4a5fc17fd0bFUx\n   2:     0x7f7baf43a030 - failure::on_fail::hcd3ce97bacbef1b03ly\n   3:     0x7f7baf07a790 - unwind::begin_unwind_inner::h670ccdf2c60477f7aNc\n   4:     0x7f7bac76e010 - unwind::begin_unwind::h18115787115103468845\n   5:     0x7f7bac76e8c0 - diagnostic::Handler::bug::h266854e4787d0d95KHF\n   6:     0x7f7bad6be650 - middle::traits::select::SelectionContext<'cx, 'tcx>::rematch_impl::h85fa8dd1c7168e08QsZ\n   7:     0x7f7bad6b22b0 - middle::traits::select::SelectionContext<'cx, 'tcx>::confirm_candidate::h73c92f23e4b19127mZY\n   8:     0x7f7bad6ac800 - middle::traits::select::SelectionContext<'cx, 'tcx>::select::h1f6b87c67ed6992dTyX\n   9:     0x7f7bad6a6360 - middle::traits::fulfill::FulfillmentContext<'tcx>::select::h1c32dca2315fb0adjYW\n  10:     0x7f7bad5261b0 - middle::traits::fulfill::FulfillmentContext<'tcx>::select_all_or_error::hfb69502c35931f954UW\n  11:     0x7f7bae5eec70 - check::vtable::select_all_fcx_obligations_or_error::ha9d04af899db1229Ceb\n  12:     0x7f7bae6c6430 - check::check_bare_fn::h3e6a0e77e248363agck\n  13:     0x7f7bae6bdfc0 - check::check_item::h2b10ccbb63916a23Gvk\n  14:     0x7f7bae915d50 - check_crate::unboxed_closure.42746\n  15:     0x7f7bae910a60 - check_crate::h0d4db076e0bb3313fZy\n  16:     0x7f7baf88a8b0 - driver::phase_3_run_analysis_passes::h86f5117df0f02e2eEta\n  17:     0x7f7baf86dc50 - driver::compile_input::h024b52963d907b7crba\n  18:     0x7f7bafa21c90 - run_compiler::h028a909c6b8b5e8fAYb\n  19:     0x7f7bafa188d0 - thunk::F.Invoke<A, R>::invoke::h18183104788496625744\n  20:     0x7f7baf40f010 - thunk::F.Invoke<A, R>::invoke::h2541757334713289964\n  21:     0x7f7baf078f00 - task::Task::spawn_thunk::closure.5783\n  22:     0x7f7baf0d7a70 - rust_try_inner\n  23:     0x7f7baf0d7a60 - rust_try\n  24:     0x7f7baf079010 - unwind::try::h558067038ea79d14rCc\n  25:     0x7f7baf078da0 - task::Task::run::h0a756e41b4d98f97sNb\n  26:     0x7f7baf078510 - thunk::F.Invoke<A, R>::invoke::h14009063998732615525\n  27:     0x7f7baf079e60 - thread::thread_start::h3654652a3d324e1eM4b\n  28:     0x7f7ba9bd30c0 - start_thread\n  29:     0x7f7baed3dec9 - __clone\n  30:                0x0 - <unknown>\n```\n\nWith rust version:\n\n```\nrustc 0.13.0-nightly (42deaa5e4 2014-12-16 17:51:23 +0000)\nbinary: rustc\ncommit-hash: 42deaa5e42c0b8a9e305aa5de5d6953b24b77aca\ncommit-date: 2014-12-16 17:51:23 +0000\nhost: x86_64-unknown-linux-gnu\nrelease: 0.13.0-nightly\n```\n\nThis might be a duplicate of https://github.com/rust-lang/rust/issues/18623 , but I'm not positive.\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/19976/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/19976/timeline", "performed_via_github_app": null, "state_reason": "completed"}