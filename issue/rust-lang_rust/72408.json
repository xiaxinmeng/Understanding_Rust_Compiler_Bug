{"url": "https://api.github.com/repos/rust-lang/rust/issues/72408", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/72408/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/72408/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/72408/events", "html_url": "https://github.com/rust-lang/rust/issues/72408", "id": 622188554, "node_id": "MDU6SXNzdWU2MjIxODg1NTQ=", "number": 72408, "title": "Nested closures result in exponential compilation time increase", "user": {"login": "VFLashM", "id": 3723853, "node_id": "MDQ6VXNlcjM3MjM4NTM=", "avatar_url": "https://avatars.githubusercontent.com/u/3723853?v=4", "gravatar_id": "", "url": "https://api.github.com/users/VFLashM", "html_url": "https://github.com/VFLashM", "followers_url": "https://api.github.com/users/VFLashM/followers", "following_url": "https://api.github.com/users/VFLashM/following{/other_user}", "gists_url": "https://api.github.com/users/VFLashM/gists{/gist_id}", "starred_url": "https://api.github.com/users/VFLashM/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/VFLashM/subscriptions", "organizations_url": "https://api.github.com/users/VFLashM/orgs", "repos_url": "https://api.github.com/users/VFLashM/repos", "events_url": "https://api.github.com/users/VFLashM/events{/privacy}", "received_events_url": "https://api.github.com/users/VFLashM/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 64037154, "node_id": "MDU6TGFiZWw2NDAzNzE1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compiletime", "name": "I-compiletime", "color": "e11d21", "default": false, "description": "Problems and improvements with respect to compile times."}, {"id": 122406831, "node_id": "MDU6TGFiZWwxMjI0MDY4MzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-closures", "name": "A-closures", "color": "f7e101", "default": false, "description": "Area: closures (`|args| { .. }`)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2020-05-21T01:47:24Z", "updated_at": "2020-09-18T16:22:23Z", "closed_at": "2020-09-18T16:22:23Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Closures include captured types twice in a type tree.\r\n\r\nWrapping one closure with another leads to doubling the amount of types in the type tree.\r\n\r\nWith nested closures compile time increases exponentially and it's extremely easy to break the compiler. Obviously it's even easier if each level captures more than one closure.\r\n\r\nI think I have a fix for this one ready, about to push it.\r\n\r\nI tried this code:\r\n\r\n```rust\r\nfn dup<F: Fn(i32) -> i32>(f: F) -> impl Fn(i32) -> i32 {\r\n    move |a| f(2*a)\r\n}\r\n\r\nfn main() {\r\n    let f = |a| a;\r\n\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n\r\n    // Compiler dies around here if it tries\r\n    // to walk the tree exhaustively.\r\n\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n    let f = dup(f);\r\n\r\n    println!(\"Hello {}\", f(1));\r\n}\r\n```\r\n\r\nI expected to see this happen: no error.\r\n\r\nInstead, this happened:\r\n\r\n```\r\nerror: reached the type-length limit while instantiating `dup::<[closure@src/main.rs:2:5: ...rs:6:13: 6:18]]]]]]]]]]]]]]]]]]>`\r\n --> src/main.rs:1:1\r\n  |\r\n1 | / fn dup<F: Fn(i32) -> i32>(f: F) -> impl Fn(i32) -> i32 {\r\n2 | |     move |a| f(2*a)\r\n3 | | }\r\n  | |_^\r\n  |\r\n  = note: consider adding a `#![type_length_limit=\"1835001\"]` attribute to your crate\r\n```\r\n\r\n### Meta\r\n\r\nI tried it both on stable and nightly rust:\r\n\r\n```\r\n$ rustc --version --verbose\r\nrustc 1.45.0-nightly (7ebd87a7a 2020-05-08)\r\nbinary: rustc\r\ncommit-hash: 7ebd87a7a1e0e21767422e115c9455ef6e6d4bee\r\ncommit-date: 2020-05-08\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.45.0-nightly\r\nLLVM version: 9.0\r\n```\r\n\r\n```\r\n$ rustc --version --verbose\r\nrustc 1.43.0 (4fb7144ed 2020-04-20)\r\nbinary: rustc\r\ncommit-hash: 4fb7144ed159f94491249e86d5bbd033b5d60550\r\ncommit-date: 2020-04-20\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.43.0\r\nLLVM version: 9.0\r\n```\r\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/72408/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/72408/timeline", "performed_via_github_app": null, "state_reason": "completed"}