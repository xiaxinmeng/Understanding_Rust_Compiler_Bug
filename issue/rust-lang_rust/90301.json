{"url": "https://api.github.com/repos/rust-lang/rust/issues/90301", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/90301/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/90301/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/90301/events", "html_url": "https://github.com/rust-lang/rust/issues/90301", "id": 1035919322, "node_id": "I_kwDOAAsO6M49vt_a", "number": 90301, "title": "reproducible builds broken in rustc 1.56.0 due to LLVM 13 update", "user": {"login": "Fuuzetsu", "id": 893115, "node_id": "MDQ6VXNlcjg5MzExNQ==", "avatar_url": "https://avatars.githubusercontent.com/u/893115?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Fuuzetsu", "html_url": "https://github.com/Fuuzetsu", "followers_url": "https://api.github.com/users/Fuuzetsu/followers", "following_url": "https://api.github.com/users/Fuuzetsu/following{/other_user}", "gists_url": "https://api.github.com/users/Fuuzetsu/gists{/gist_id}", "starred_url": "https://api.github.com/users/Fuuzetsu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Fuuzetsu/subscriptions", "organizations_url": "https://api.github.com/users/Fuuzetsu/orgs", "repos_url": "https://api.github.com/users/Fuuzetsu/repos", "events_url": "https://api.github.com/users/Fuuzetsu/events{/privacy}", "received_events_url": "https://api.github.com/users/Fuuzetsu/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1508600909, "node_id": "MDU6TGFiZWwxNTA4NjAwOTA5", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-reproducibility", "name": "A-reproducibility", "color": "f7e101", "default": false, "description": "Area: Reproducible / Deterministic builds"}], "state": "closed", "locked": false, "assignee": {"login": "yanok", "id": 468850, "node_id": "MDQ6VXNlcjQ2ODg1MA==", "avatar_url": "https://avatars.githubusercontent.com/u/468850?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yanok", "html_url": "https://github.com/yanok", "followers_url": "https://api.github.com/users/yanok/followers", "following_url": "https://api.github.com/users/yanok/following{/other_user}", "gists_url": "https://api.github.com/users/yanok/gists{/gist_id}", "starred_url": "https://api.github.com/users/yanok/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yanok/subscriptions", "organizations_url": "https://api.github.com/users/yanok/orgs", "repos_url": "https://api.github.com/users/yanok/repos", "events_url": "https://api.github.com/users/yanok/events{/privacy}", "received_events_url": "https://api.github.com/users/yanok/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "yanok", "id": 468850, "node_id": "MDQ6VXNlcjQ2ODg1MA==", "avatar_url": "https://avatars.githubusercontent.com/u/468850?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yanok", "html_url": "https://github.com/yanok", "followers_url": "https://api.github.com/users/yanok/followers", "following_url": "https://api.github.com/users/yanok/following{/other_user}", "gists_url": "https://api.github.com/users/yanok/gists{/gist_id}", "starred_url": "https://api.github.com/users/yanok/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yanok/subscriptions", "organizations_url": "https://api.github.com/users/yanok/orgs", "repos_url": "https://api.github.com/users/yanok/repos", "events_url": "https://api.github.com/users/yanok/events{/privacy}", "received_events_url": "https://api.github.com/users/yanok/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 22, "created_at": "2021-10-26T07:09:11Z", "updated_at": "2021-12-07T02:49:35Z", "closed_at": "2021-11-10T15:53:20Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI attach a tarball with a small reproducer (few dependencies from crates.io, lock file, empty lib.rs).\r\n\r\n[repro.tar.gz](https://github.com/rust-lang/rust/files/7415819/repro.tar.gz)\r\n\r\nNow run this using rustc 1.56.0:\r\n```console\r\nfor i in $(seq 1 10); do cargo clean &&  cargo build --release --quiet && sha256sum target/release/deps/libpalette_derive-*.so; done\r\n```\r\nI expect the sha256sum to be the same for the libpalette so file but it's often different.\r\n\r\nThis breaks any binary caches, similarly to what #89904 did but _that_ ticket turned out to be a problem with the crate.\r\n\r\nThis time it seems problem with `rustc` itself (or rather LLVM: stay tuned): 1.55.0 produces same binary/crate hash on every build.\r\n\r\nNote that in Cargo.toml there's:\r\n```toml\r\n[profile.release]\r\ndebug = true\r\n```\r\n\r\nWithout this, the issue does not present itself. This perhaps makes it look similar to #89911 or #45397 but I think it's different. As far as I saw, it didn't produce a difference in ordering of symbols in the resulting `.so` though I may be mistaken. Please feel free to close as duplicate if you deem it to be the same issue.\r\n\r\nI have ran with `RUSTC_LOG=debug` and after careful sifting through few GiB of output, I found the differences seem to start in `rustc_codegen_ssa`.\r\n\r\nI have bisected `rustc` itself and ran it on our original code which exhibited the problem. I started the bisect at common merge point with 1.55.0 though the problem turned out well into the 1.56.0 release:\r\n\r\n```console\r\n$ git bisect good\r\ndb002a06ae9154a35d410550bc5132df883d7baa is the first bad commit\r\ncommit db002a06ae9154a35d410550bc5132df883d7baa\r\nMerge: e7f7fe462a5 306259c6459\r\nAuthor: bors <bors@rust-lang.org>\r\nDate:   Sat Aug 21 09:25:28 2021 +0000\r\n\r\n    Auto merge of #87570 - nikic:llvm-13, r=nagisa\r\n    \r\n    Upgrade to LLVM 13\r\n    \r\n    Work in progress update to LLVM 13. Main changes:\r\n    \r\n     * InlineAsm diagnostics reported using SrcMgr diagnostic kind are now handled. Previously these used a separate diag handler.\r\n     * Codegen tests are updated for additional attributes.\r\n     * Some data layouts have changed.\r\n     * Switch `#[used]` attribute from `llvm.used` to `llvm.compiler.used` to avoid SHF_GNU_RETAIN flag introduced in https://reviews.llvm.org/D97448, which appears to trigger a bug in older versions of gold.\r\n     * Set `LLVM_INCLUDE_TESTS=OFF` to avoid Python 3.6 requirement.\r\n    \r\n    Upstream issues:\r\n    \r\n     * ~~https://bugs.llvm.org/show_bug.cgi?id=51210 (InlineAsm diagnostic reporting for module asm)~~ Fixed by https://github.com/llvm/llvm-project/commit/1558bb80c01b695ce12642527cbfccf16cf54ece.\r\n     * ~~https://bugs.llvm.org/show_bug.cgi?id=51476 (Miscompile on AArch64 due to incorrect comparison elimination)~~ Fixed by https://github.com/llvm/llvm-project/commit/81b106584f2baf33e09be2362c35c1bf2f6bfe94.\r\n     * https://bugs.llvm.org/show_bug.cgi?id=51207 (Can't set custom section flags anymore). Problematic change reverted in our fork, https://reviews.llvm.org/D107216 posted for upstream revert.\r\n     * https://bugs.llvm.org/show_bug.cgi?id=51211 (Regression in codegen for #83623). This is an optimization regression that we may likely have to eat for this release. The fix for #83623 was based on an incorrect premise, and this needs to be properly addressed in the MergeICmps pass.\r\n    \r\n    The [compile-time impact](https://perf.rust-lang.org/compare.html?start=ef9549b6c0efb7525c9b012148689c8d070f9bc0&end=0983094463497eec22d550dad25576a894687002) is mixed, but quite positive as LLVM upgrades go.\r\n    \r\n    The LLVM 13 final release is scheduled for Sep 21st. The current nightly is scheduled for stable release on Oct 21st.\r\n    \r\n    r? `@ghost`\r\n\r\n .gitmodules                                        |  2 +-\r\n compiler/rustc_codegen_llvm/src/back/write.rs      | 43 +---------\r\n compiler/rustc_codegen_llvm/src/base.rs            |  8 +-\r\n compiler/rustc_codegen_llvm/src/consts.rs          | 15 +++-\r\n compiler/rustc_codegen_llvm/src/context.rs         | 55 +++++++++----\r\n compiler/rustc_codegen_llvm/src/lib.rs             |  2 +-\r\n compiler/rustc_codegen_llvm/src/llvm/diagnostic.rs | 94 +++++++++++++++++-----\r\n compiler/rustc_codegen_llvm/src/llvm/ffi.rs        |  7 +-\r\n compiler/rustc_codegen_ssa/src/traits/misc.rs      |  2 +\r\n compiler/rustc_codegen_ssa/src/traits/statics.rs   | 18 ++---\r\n compiler/rustc_feature/src/accepted.rs             |  2 +-\r\n compiler/rustc_llvm/llvm-wrapper/RustWrapper.cpp   | 20 ++++-\r\n .../src/spec/powerpc64_unknown_linux_gnu.rs        |  2 +-\r\n .../src/spec/powerpc64_unknown_linux_musl.rs       |  2 +-\r\n .../rustc_target/src/spec/powerpc64_wrs_vxworks.rs |  2 +-\r\n .../src/spec/powerpc64le_unknown_linux_gnu.rs      |  2 +-\r\n .../src/spec/powerpc64le_unknown_linux_musl.rs     |  2 +-\r\n .../src/spec/wasm32_unknown_emscripten.rs          |  2 +-\r\n .../src/spec/wasm32_unknown_unknown.rs             |  2 +-\r\n compiler/rustc_target/src/spec/wasm32_wasi.rs      |  2 +-\r\n .../src/spec/wasm64_unknown_unknown.rs             |  2 +-\r\n src/bootstrap/native.rs                            |  1 +\r\n src/llvm-project                                   |  2 +-\r\n src/test/codegen/array-equality.rs                 |  4 +-\r\n src/test/codegen/issue-83623-SIMD-PartialEq.rs     | 46 -----------\r\n src/test/codegen/repeat-trusted-len.rs             |  2 +-\r\n .../run-make-fulldeps/coverage-llvmir/Makefile     |  2 -\r\n .../coverage-llvmir/filecheck.testprog.txt         | 18 ++---\r\n src/test/ui/llvm-asm/issue-69092.rs                |  4 +-\r\n src/test/ui/llvm-asm/issue-69092.stderr            |  4 +-\r\n 30 files changed, 201 insertions(+), 168 deletions(-)\r\n delete mode 100644 src/test/codegen/issue-83623-SIMD-PartialEq.rs\r\n\r\n```\r\n\r\ncc @nikic who did the update\r\n\r\n### Meta\r\n`rustc --version --verbose`:\r\n```\r\n$ rustc --version --verbose\r\nrustc 1.56.0 (09c42c458 2021-10-18)\r\nbinary: rustc\r\ncommit-hash: 09c42c45858d5f3aedfa670698275303a3d19afa\r\ncommit-date: 2021-10-18\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.56.0\r\nLLVM version: 13.0.0\r\n```\r\n\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"yanok\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/90301/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/90301/timeline", "performed_via_github_app": null, "state_reason": "completed"}