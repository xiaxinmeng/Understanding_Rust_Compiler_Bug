{"url": "https://api.github.com/repos/rust-lang/rust/issues/111471", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/111471/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/111471/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/111471/events", "html_url": "https://github.com/rust-lang/rust/issues/111471", "id": 1706111446, "node_id": "I_kwDOAAsO6M5lsTHW", "number": 111471, "title": "SIGILL when compiling `asm!(\"global.get <number>\")` for wasm32-unknown-unknown", "user": {"login": "oxalica", "id": 14816024, "node_id": "MDQ6VXNlcjE0ODE2MDI0", "avatar_url": "https://avatars.githubusercontent.com/u/14816024?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oxalica", "html_url": "https://github.com/oxalica", "followers_url": "https://api.github.com/users/oxalica/followers", "following_url": "https://api.github.com/users/oxalica/following{/other_user}", "gists_url": "https://api.github.com/users/oxalica/gists{/gist_id}", "starred_url": "https://api.github.com/users/oxalica/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oxalica/subscriptions", "organizations_url": "https://api.github.com/users/oxalica/orgs", "repos_url": "https://api.github.com/users/oxalica/repos", "events_url": "https://api.github.com/users/oxalica/events{/privacy}", "received_events_url": "https://api.github.com/users/oxalica/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 91598611, "node_id": "MDU6TGFiZWw5MTU5ODYxMQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-inline-assembly", "name": "A-inline-assembly", "color": "f7e101", "default": false, "description": "Area: inline asm!(..)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2023-05-11T15:57:07Z", "updated_at": "2023-05-12T02:25:21Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for finding an Internal Compiler Error! \ud83e\uddca  If possible, try to provide\r\na minimal verifiable example. You can read \"Rust Bug Minimization Patterns\" for\r\nhow to create smaller examples.\r\nhttp://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/\r\n-->\r\n\r\n### Code\r\n\r\nTypically, `global.get` should follow a global symbol name. But when erroneously given a number argument, rustc crashes with SIGILL inside LLVM instead of reporting an error.\r\n\r\nCompile following code with `cargo build --target wasm32-unknown-unknown -Zbuild-std=core`:\r\n\r\n```Rust\r\n#![feature(asm_experimental_arch)]\r\n#![no_std]\r\n\r\n#[panic_handler]\r\nfn panic_handler(_: &core::panic::PanicInfo) -> ! {\r\n    loop {}\r\n}\r\n\r\n#[no_mangle]\r\npub unsafe fn get_global() -> i64 {\r\n    let ret;\r\n    core::arch::asm!(\"global.get 0\", \"local.set {0}\", out(local) ret);\r\n    ret\r\n}\r\n```\r\n\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.71.0-nightly (2f6bc5d25 2023-05-09)\r\nbinary: rustc\r\ncommit-hash: 2f6bc5d259e7ab25ddfdd33de53b892770218918\r\ncommit-date: 2023-05-09\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.71.0-nightly\r\nLLVM version: 16.0.2\r\n```\r\n\r\n### Error output\r\n\r\n```\r\n     Running `CARGO=/nix/store/x4f0gnx06nmck3i92d0ms3hnv1bvham2-cargo-1.71.0-nightly-2023-05-01-x86_64-unknown-linux-gnu/bin/cargo CARGO_CRATE_NAME=wasm_test CARGO_MANIFEST_DIR=/home/oxa/tmp/wasm CARGO_PKG_AUTHORS='' CARGO_PKG_DESCRIPTION='' CARGO_PKG_HOMEPAGE='' CARGO_PKG_LICENSE='' CARGO_PKG_LICENSE_FILE='' CARGO_PKG_NAME=wasm-test CARGO_PKG_README='' CARGO_PKG_REPOSITORY='' CARGO_PKG_RUST_VERSION='' CARGO_PKG_VERSION=0.0.0 CARGO_PKG_VERSION_MAJOR=0 CARGO_PKG_VERSION_MINOR=0 CARGO_PKG_VERSION_PATCH=0 CARGO_PKG_VERSION_PRE='' CARGO_PRIMARY_PACKAGE=1 LD_LIBRARY_PATH='/home/oxa/tmp/wasm/target/release/deps:/nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib' rustc --crate-name wasm_test --edition=2021 src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts,future-incompat --diagnostic-width=127 --crate-type cdylib --emit=dep-info,link -C opt-level=3 -C lto=fat -Clink-args=--export=ggg -C metadata=679f59027eb6f945 --out-dir /home/oxa/tmp/wasm/target/wasm64-unknown-unknown/release/deps --target wasm64-unknown-unknown -L dependency=/home/oxa/tmp/wasm/target/wasm64-unknown-unknown/release/deps -L dependency=/home/oxa/tmp/wasm/target/release/deps --extern 'noprelude:compiler_builtins=/home/oxa/tmp/wasm/target/wasm64-unknown-unknown/release/deps/libcompiler_builtins-14d6a13e4c7e4b92.rlib' --extern 'noprelude:core=/home/oxa/tmp/wasm/target/wasm64-unknown-unknown/release/deps/libcore-18b0356a8dc182fe.rlib' -Z unstable-options`\r\nerror: could not compile `wasm-test` (lib)\r\n\r\nCaused by:\r\n  process didn't exit successfully: `CARGO=/nix/store/x4f0gnx06nmck3i92d0ms3hnv1bvham2-cargo-1.71.0-nightly-2023-05-01-x86_64-unknown-linux-gnu/bin/cargo CARGO_CRATE_NAME=wasm_test CARGO_MANIFEST_DIR=/home/oxa/tmp/wasm CARGO_PKG_AUTHORS='' CARGO_PKG_DESCRIPTION='' CARGO_PKG_HOMEPAGE='' CARGO_PKG_LICENSE='' CARGO_PKG_LICENSE_FILE='' CARGO_PKG_NAME=wasm-test CARGO_PKG_README='' CARGO_PKG_REPOSITORY='' CARGO_PKG_RUST_VERSION='' CARGO_PKG_VERSION=0.0.0 CARGO_PKG_VERSION_MAJOR=0 CARGO_PKG_VERSION_MINOR=0 CARGO_PKG_VERSION_PATCH=0 CARGO_PKG_VERSION_PRE='' CARGO_PRIMARY_PACKAGE=1 LD_LIBRARY_PATH='/home/oxa/tmp/wasm/target/release/deps:/nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib' rustc --crate-name wasm_test --edition=2021 src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts,future-incompat --diagnostic-width=127 --crate-type cdylib --emit=dep-info,link -C opt-level=3 -C lto=fat -Clink-args=--export=ggg -C metadata=679f59027eb6f945 --out-dir /home/oxa/tmp/wasm/target/wasm64-unknown-unknown/release/deps --target wasm64-unknown-unknown -L dependency=/home/oxa/tmp/wasm/target/wasm64-unknown-unknown/release/deps -L dependency=/home/oxa/tmp/wasm/target/release/deps --extern 'noprelude:compiler_builtins=/home/oxa/tmp/wasm/target/wasm64-unknown-unknown/release/deps/libcompiler_builtins-14d6a13e4c7e4b92.rlib' --extern 'noprelude:core=/home/oxa/tmp/wasm/target/wasm64-unknown-unknown/release/deps/libcore-18b0356a8dc182fe.rlib' -Z unstable-options` (signal: 4, SIGILL: illegal instruction)\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary><strong>Backtrace</strong></summary>\r\n<p>\r\n\r\n```\r\n#0  0x00007ffff2522a3a in (anonymous namespace)::WebAssemblyMCCodeEmitter::encodeInstruction(llvm::MCInst const&, llvm::raw_ostream&, llvm::SmallVectorImpl<llvm::MCFixup>&, llvm::MCSubtargetInfo const&) const ()\r\n   from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/libLLVM-16-rust-1.71.0-nightly.so\r\n#1  0x00007ffff1940adc in llvm::MCWasmStreamer::emitInstToData(llvm::MCInst const&, llvm::MCSubtargetInfo const&) () from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/libLLVM-16-rust-1.71.0-nightly.so\r\n#2  0x00007ffff0bc4d26 in llvm::MCObjectStreamer::emitInstruction(llvm::MCInst const&, llvm::MCSubtargetInfo const&) [clone .cold.0] ()\r\n   from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/libLLVM-16-rust-1.71.0-nightly.so\r\n#3  0x00007ffff251ba4e in (anonymous namespace)::WebAssemblyAsmParser::MatchAndEmitInstruction(llvm::SMLoc, unsigned int&, llvm::SmallVectorImpl<std::unique_ptr<llvm::MCParsedAsmOperand, std::default_delete<llvm::MCParsedAsmOperand> > >&, llvm::MCStreamer&, unsigned long&, bool) () from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/libLLVM-16-rust-1.71.0-nightly.so\r\n#4  0x00007ffff06b12ee in (anonymous namespace)::AsmParser::parseAndMatchAndEmitTargetInstruction((anonymous namespace)::ParseStatementInfo&, llvm::StringRef, llvm::AsmToken, llvm::SMLoc) ()\r\n   from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/libLLVM-16-rust-1.71.0-nightly.so\r\n#5  0x00007ffff06b0d3f in (anonymous namespace)::AsmParser::parseStatement((anonymous namespace)::ParseStatementInfo&, llvm::MCAsmParserSemaCallback*) ()\r\n   from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/libLLVM-16-rust-1.71.0-nightly.so\r\n#6  0x00007ffff063cb76 in (anonymous namespace)::AsmParser::Run(bool, bool) [clone .llvm.10166338383570117828] () from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/libLLVM-16-rust-1.71.0-nightly.so\r\n#7  0x00007ffff05bd4a9 in llvm::AsmPrinter::emitInlineAsm(llvm::StringRef, llvm::MCSubtargetInfo const&, llvm::MCTargetOptions const&, llvm::MDNode const*, llvm::InlineAsm::AsmDialect) const ()\r\n   from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/libLLVM-16-rust-1.71.0-nightly.so\r\n#8  0x00007ffff05bcb20 in llvm::AsmPrinter::emitInlineAsm(llvm::MachineInstr const*) const () from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/libLLVM-16-rust-1.71.0-nightly.so\r\n#9  0x00007ffff018c174 in llvm::AsmPrinter::emitFunctionBody() () from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/libLLVM-16-rust-1.71.0-nightly.so\r\n#10 0x00007ffff24dd83f in llvm::WebAssemblyAsmPrinter::runOnMachineFunction(llvm::MachineFunction&) () from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/libLLVM-16-rust-1.71.0-nightly.so\r\n#11 0x00007ffff023ac41 in llvm::FPPassManager::runOnModule(llvm::Module&) () from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/libLLVM-16-rust-1.71.0-nightly.so\r\n#12 0x00007ffff0115c6d in llvm::legacy::PassManagerImpl::run(llvm::Module&) () from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/libLLVM-16-rust-1.71.0-nightly.so\r\n#13 0x00007ffff60fb816 in LLVMRustWriteOutputFile () from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/librustc_driver-d7843847813d1387.so\r\n#14 0x00007ffff60fb228 in rustc_codegen_llvm[268f5a08f5351377]::back::write::write_output_file () from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/librustc_driver-d7843847813d1387.so\r\n#15 0x00007ffff60f92e2 in rustc_codegen_llvm[268f5a08f5351377]::back::write::codegen () from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/librustc_driver-d7843847813d1387.so\r\n#16 0x00007ffff60b2e46 in rustc_codegen_ssa[8edfcb7c9bad7299]::back::write::finish_intra_module_work::<rustc_codegen_llvm[268f5a08f5351377]::LlvmCodegenBackend> ()\r\n   from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/librustc_driver-d7843847813d1387.so\r\n#17 0x00007ffff60b2223 in rustc_codegen_ssa[8edfcb7c9bad7299]::back::write::execute_work_item::<rustc_codegen_llvm[268f5a08f5351377]::LlvmCodegenBackend> ()\r\n   from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/librustc_driver-d7843847813d1387.so\r\n#18 0x00007ffff60b0a24 in std[468ab6db55de55b5]::sys_common::backtrace::__rust_begin_short_backtrace::<<rustc_codegen_llvm[268f5a08f5351377]::LlvmCodegenBackend as rustc_codegen_ssa[8edfcb7c9bad7299]::traits::backend::ExtraBackendMethods>::spawn_named_thread<rustc_codegen_ssa[8edfcb7c9bad7299]::back::write::spawn_work<rustc_codegen_llvm[268f5a08f5351377]::LlvmCodegenBackend>::{closure#0}, ()>::{closure#0}, ()> ()\r\n   from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/librustc_driver-d7843847813d1387.so\r\n#19 0x00007ffff60827d6 in <<std[468ab6db55de55b5]::thread::Builder>::spawn_unchecked_<<rustc_codegen_llvm[268f5a08f5351377]::LlvmCodegenBackend as rustc_codegen_ssa[8edfcb7c9bad7299]::traits::backend::ExtraBackendMethods>::spawn_named_thread<rustc_codegen_ssa[8edfcb7c9bad7299]::back::write::spawn_work<rustc_codegen_llvm[268f5a08f5351377]::LlvmCodegenBackend>::{closure#0}, ()>::{closure#0}, ()>::{closure#1} as core[b1830eda9a6e2491]::ops::function::FnOnce<()>>::call_once::{shim:vtable#0} ()\r\n   from /nix/store/5zi26l69yxmivmfrmczi38h25ig8zw90-rust-minimal-1.71.0-nightly-2023-05-01/lib/librustc_driver-d7843847813d1387.so\r\n#20 0x00007ffff39258c5 in alloc::boxed::{impl#47}::call_once<(), dyn core::ops::function::FnOnce<(), Output=()>, alloc::alloc::Global> () at library/alloc/src/boxed.rs:1985\r\n#21 alloc::boxed::{impl#47}::call_once<(), alloc::boxed::Box<dyn core::ops::function::FnOnce<(), Output=()>, alloc::alloc::Global>, alloc::alloc::Global> () at library/alloc/src/boxed.rs:1985\r\n#22 std::sys::unix::thread::{impl#2}::new::thread_start () at library/std/src/sys/unix/thread.rs:108\r\n#23 0x00007ffff36c0e24 in start_thread () from /nix/store/0z5kcds7b6qmm373s3b5w9ykvqbgw87i-glibc-2.37-8/lib/libc.so.6\r\n#24 0x00007ffff37429b0 in clone3 () from /nix/store/0z5kcds7b6qmm373s3b5w9ykvqbgw87i-glibc-2.37-8/lib/libc.so.6\r\n```\r\n\r\n</p>\r\n</details>\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/111471/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/111471/timeline", "performed_via_github_app": null, "state_reason": null}