{"url": "https://api.github.com/repos/rust-lang/rust/issues/48582", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/48582/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/48582/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/48582/events", "html_url": "https://github.com/rust-lang/rust/issues/48582", "id": 300618980, "node_id": "MDU6SXNzdWUzMDA2MTg5ODA=", "number": 48582, "title": "ICE: index out of bounds with rls and span generated by proc-macro attribute", "user": {"login": "kdy1", "id": 29931815, "node_id": "MDQ6VXNlcjI5OTMxODE1", "avatar_url": "https://avatars.githubusercontent.com/u/29931815?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kdy1", "html_url": "https://github.com/kdy1", "followers_url": "https://api.github.com/users/kdy1/followers", "following_url": "https://api.github.com/users/kdy1/following{/other_user}", "gists_url": "https://api.github.com/users/kdy1/gists{/gist_id}", "starred_url": "https://api.github.com/users/kdy1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kdy1/subscriptions", "organizations_url": "https://api.github.com/users/kdy1/orgs", "repos_url": "https://api.github.com/users/kdy1/repos", "events_url": "https://api.github.com/users/kdy1/events{/privacy}", "received_events_url": "https://api.github.com/users/kdy1/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 632573348, "node_id": "MDU6TGFiZWw2MzI1NzMzNDg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-macros-2.0", "name": "A-macros-2.0", "color": "f7e101", "default": false, "description": "Area: declarative macros 2.0, https://github.com/rust-lang/rust/issues/39412"}, {"id": 632925329, "node_id": "MDU6TGFiZWw2MzI5MjUzMjk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-rls", "name": "A-rls", "color": "f7e101", "default": false, "description": "Area: Rust Language Server (RLS)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2018-02-27T12:56:53Z", "updated_at": "2020-03-13T15:24:23Z", "closed_at": "2020-03-13T15:24:23Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "`#[parser]` is a simple hack to make macro partially unhygienic.\r\nIt prepends self to macro arguments.\r\nGiven\r\n```rust\r\n#[parser]\r\nimpl Parser {\r\n  pub fn parse_XX(&mut self) -> PResult<XX> {\r\n    cur!();\r\n    bump!();\r\n    eat!('a');\r\n  }\r\n}\r\n\r\n```\r\nprints\r\n```rust\r\nimpl Parser {\r\n  pub fn parse_XX(&mut self) -> PResult<XX> {\r\n    cur!(self);\r\n    bump!(self);\r\n    eat!(self, 'a');\r\n  }\r\n}\r\n```\r\n\r\n`cargo check` or `build` does not have any problem with it but rls is broken.\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n## `rls --cli`\r\nNote: You have to run this twice to get stack trace. See https://github.com/rust-lang-nursery/rls/issues/738 \r\n\r\n```\r\n$ RUST_BACKTRACE=full RUST_LOG=debug CARGO_INCREMENTAL=1 rls --cli\r\n# Omitted useless log messages\r\n\r\n DEBUG 2018-02-27T12:29:27Z: cargo::ops::cargo_rustc::fingerprint: write fingerprint: /mnt/c/Users/kdy/Documents/projects/swc/ecmascript/parser/target/rls/debug/.fingerprint/swc_macros-d557c2bb15f46f82/lib-swc_macros-d557c2bb15f46f82\r\n INFO 2018-02-27T12:29:27Z: cargo::ops::cargo_rustc::job_queue: end: swc_macros v0.1.0 (file:///mnt/c/Users/kdy/Documents/projects/swc/macros) => Target(lib)/Profile(check) => Host\r\n INFO 2018-02-27T12:29:27Z: cargo::ops::cargo_rustc::job_queue: start: swc_ecma_ast v0.1.0 (file:///mnt/c/Users/kdy/Documents/projects/swc/ecmascript/ast) => Target(lib)/Profile(check) => Host\r\nthread 'rustc' panicked at 'index out of bounds: the len is 71658 but the index is 71776', /checkout/src/liballoc/vec.rs:1536:10\r\nstack backtrace:\r\n   0:     0x7f9dc374aff3 - std::sys::unix::backtrace::tracing::imp::unwind_backtrace::h92c858273beca9db\r\n                               at libstd/sys/unix/backtrace/tracing/gcc_s.rs:49\r\n   1:     0x7f9dc3742534 - std::sys_common::backtrace::_print::h6cb1e7663c70c510\r\n                               at libstd/sys_common/backtrace.rs:71\r\n   2:     0x7f9dc3747c7d - std::panicking::default_hook::{{closure}}::h46fa0787be3918b6\r\n                               at libstd/sys_common/backtrace.rs:59\r\n                               at libstd/panicking.rs:206\r\n   3:     0x7f9dc3747979 - std::panicking::default_hook::h7dddf112a45a90f8\r\n                               at libstd/panicking.rs:222\r\n   4:     0x7f9dc4685a5d - core::ops::function::Fn::call::h3cb97c4162eec9f6\r\n   5:     0x7f9dc3748119 - std::panicking::rust_panic_with_hook::h42848144b6747469\r\n                               at libstd/panicking.rs:401\r\n   6:     0x7f9dc3747f02 - std::panicking::begin_panic_fmt::h14c37c5e3685a2bb\r\n                               at libstd/panicking.rs:347\r\n   7:     0x7f9dc3747e32 - rust_begin_unwind\r\n                               at libstd/panicking.rs:323\r\n   8:     0x7f9dc37acf60 - core::panicking::panic_fmt::h073d1a33c55ca52f\r\n                               at libcore/panicking.rs:71\r\n   9:     0x7f9dc37acf03 - core::panicking::panic_bounds_check::he6e885ab6d60a660\r\n                               at libcore/panicking.rs:58\r\n  10:     0x7f9dc482fb60 - rustc::dep_graph::graph::DepGraph::node_color::hd92c76e4d9e87791\r\n  11:     0x7f9dc49f5fc3 - rustc::ty::maps::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::try_mark_green_and_read::h5ae1aac390c36966\r\n  12:     0x7f9dc4bd59f8 - rustc::ty::maps::<impl rustc::ty::maps::queries::exported_symbols<'tcx>>::try_get::he412a88851c0b7de\r\n  13:     0x7f9dc4c04ec3 - rustc::ty::maps::TyCtxtAt::exported_symbols::h7e7735f415e36778\r\n  14:     0x7f9dc4bfdf8e - rustc::ty::maps::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'lcx>>::exported_symbols::h95796b0982d4ffc5\r\n  15:     0x7f9db1aa0850 - rustc_trans::back::write::start_async_translation::h830084af12a98a14\r\n  16:     0x7f9db1abdd85 - rustc_trans::base::trans_crate::h738847f13ac11d6b\r\n  17:     0x7f9db1b1ac07 - <rustc_trans::LlvmTransCrate as rustc_trans_utils::trans_crate::TransCrate>::trans_crate::he1547238cf95100e\r\n  18:     0x7f9dc534e782 - rustc_driver::driver::phase_4_translate_to_llvm::h4e2ec031fd084a01\r\n  19:     0x7f9dc534770e - rustc_driver::driver::compile_input::{{closure}}::he9f831ecdaf7dbd7\r\n  20:     0x7f9dc52e1c24 - rustc::ty::context::TyCtxt::create_and_enter::hc45b3a73dd46ae96\r\n  21:     0x7f9dc534573e - rustc_driver::driver::compile_input::h60b5346f3903c44c\r\n  22:     0x7f9dc5361e8a - rustc_driver::run_compiler::h606ede5b4fb41a6e\r\n  23:     0x7f9dc5abca3e - std::sys_common::backtrace::__rust_begin_short_backtrace::hd309709ee10a0577\r\n  24:     0x7f9dc5acc7a6 - std::panicking::try::do_call::hd26d704d41061070\r\n  25:     0x7f9dc3760bde - __rust_maybe_catch_panic\r\n                               at libpanic_unwind/lib.rs:102\r\n  26:     0x7f9dc5b37492 - <F as alloc::boxed::FnBox<A>>::call_box::h606d90f3d1f8ac56\r\n  27:     0x7f9dc3757f9b - std::sys::unix::thread::Thread::new::thread_start::h15b68dbc19e967f4\r\n                               at /checkout/src/liballoc/boxed.rs:793\r\n                               at libstd/sys_common/thread.rs:24\r\n                               at libstd/sys/unix/thread.rs:90\r\n  28:     0x7f9dc30a76b9 - start_thread\r\n  29:     0x7f9dc2bb741c - clone\r\n  30:                0x0 - <unknown>\r\n\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: rustc 1.26.0-nightly (bedbad611 2018-02-26) running on x86_64-unknown-linux-gnu\r\n\r\n```", "closed_by": {"login": "kdy1", "id": 29931815, "node_id": "MDQ6VXNlcjI5OTMxODE1", "avatar_url": "https://avatars.githubusercontent.com/u/29931815?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kdy1", "html_url": "https://github.com/kdy1", "followers_url": "https://api.github.com/users/kdy1/followers", "following_url": "https://api.github.com/users/kdy1/following{/other_user}", "gists_url": "https://api.github.com/users/kdy1/gists{/gist_id}", "starred_url": "https://api.github.com/users/kdy1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kdy1/subscriptions", "organizations_url": "https://api.github.com/users/kdy1/orgs", "repos_url": "https://api.github.com/users/kdy1/repos", "events_url": "https://api.github.com/users/kdy1/events{/privacy}", "received_events_url": "https://api.github.com/users/kdy1/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/48582/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/48582/timeline", "performed_via_github_app": null, "state_reason": "completed"}