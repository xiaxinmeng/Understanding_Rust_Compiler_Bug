{"url": "https://api.github.com/repos/rust-lang/rust/issues/9993", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/9993/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/9993/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/9993/events", "html_url": "https://github.com/rust-lang/rust/issues/9993", "id": 21311340, "node_id": "MDU6SXNzdWUyMTMxMTM0MA==", "number": 9993, "title": "debuginfo: Assertion in ValueHandleBase::ValueIsDeleted() when using -O", "user": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 203130, "node_id": "MDU6TGFiZWwyMDMxMzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-debuginfo", "name": "A-debuginfo", "color": "f7e101", "default": false, "description": "Area: Debugging information in compiled programs (DWARF, PDB, etc.)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2013-10-21T12:17:49Z", "updated_at": "2014-07-02T12:34:51Z", "closed_at": "2014-07-02T12:34:51Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Sometimes when enabling debug info and optimizations at the same time, _rustc_ dies with an assertion in the LLVM method `ValueHandleBase::ValueIsDeleted()`:\n\n```\nWhile deleting: metadata %\nAn asserting value handle still pointed to this value!\nUNREACHABLE executed at /home/sc/projects/rust/rust/src/llvm/lib/IR/Value.cpp:632!\n```\n\nThis is one the major issues keeping debug info from being end-user ready (see https://github.com/mozilla/rust/issues/9770).\n\nI was already able to identify the cause for the assertion:\nThe failure itself says that a value handle still points to the metadata node that is currently being deleted. This leaked handle is created in LLVM's `DwarfDebug::collectDeadVariables()` on a path that is only hit with optimizations activated. That's why the assertion is never triggered when compiling something without the `-O` flag.\n\nThe memory leak occurs because the method cannot handle duplicate entries in the list of subprograms in the compile unit. This is a bug in LLVM: http://llvm.org/bugs/show_bug.cgi?id=16017\nIt's not clear yet how it will be fixed exactly.\n\nBut the issue should also be tackled on our side: That LLVM reacts with a memory leak to invalid input is unfortunate but it's still us that generate the invalid input. The main issue here is that some functions are translated more than once (see issue https://github.com/mozilla/rust/issues/7349) and thus they are also added to the debug info function list more than once.\n\nI think the best way to fix this issue is to fix #7349. This way we don't have to wait for LLVM to take care of their side. Also, the folks at LLVM might decide to just assert on invalid input, so we have take care of this anyway.\n", "closed_by": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/9993/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/9993/timeline", "performed_via_github_app": null, "state_reason": "completed"}