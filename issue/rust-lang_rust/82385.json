{"url": "https://api.github.com/repos/rust-lang/rust/issues/82385", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/82385/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/82385/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/82385/events", "html_url": "https://github.com/rust-lang/rust/issues/82385", "id": 813093974, "node_id": "MDU6SXNzdWU4MTMwOTM5NzQ=", "number": 82385, "title": "Changing rustfmt from submod to subtree", "user": {"login": "calebcartwright", "id": 13042488, "node_id": "MDQ6VXNlcjEzMDQyNDg4", "avatar_url": "https://avatars.githubusercontent.com/u/13042488?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebcartwright", "html_url": "https://github.com/calebcartwright", "followers_url": "https://api.github.com/users/calebcartwright/followers", "following_url": "https://api.github.com/users/calebcartwright/following{/other_user}", "gists_url": "https://api.github.com/users/calebcartwright/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebcartwright/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebcartwright/subscriptions", "organizations_url": "https://api.github.com/users/calebcartwright/orgs", "repos_url": "https://api.github.com/users/calebcartwright/repos", "events_url": "https://api.github.com/users/calebcartwright/events{/privacy}", "received_events_url": "https://api.github.com/users/calebcartwright/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 2255065215, "node_id": "MDU6TGFiZWwyMjU1MDY1MjE1", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-rustfmt", "name": "A-rustfmt", "color": "f7e101", "default": false, "description": "Area: Rustfmt"}, {"id": 2352122097, "node_id": "MDU6TGFiZWwyMzUyMTIyMDk3", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-discussion", "name": "C-discussion", "color": "f5f1fd", "default": false, "description": "Category: Discussion or questions that doesn't represent real issues."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 11, "created_at": "2021-02-22T04:14:23Z", "updated_at": "2021-05-15T17:37:18Z", "closed_at": "2021-05-15T17:37:18Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "rustfmt is currently a submodule in this repository, but there's been ongoing discussion and experimentation for a while now to investigate the possibility of switching rustfmt to a subtree in a similar vein as #70651 (additional background/motivation at the bottom of the issue description)\r\n\r\nThanks to @jyn514, the bulk of the changes that would be needed for this conversion have been identified (e.g. #82208), but there's a number of items in my mind that would still need to be resolved/answered before we could proceed. Opening this issue to facilitate those discussions separately from the PR given the quantity of folks that would get notified there.\r\n\r\nA non-exhuastive list of questions/steps that I think would need to be discussed before converting:\r\n\r\n### rust-side\r\n\r\n- would `x.py fmt` continue to use an older/pinned nightly or use the rustfmt version in tree?\r\n- would any additional CI checks be necessary or helpful? For example within the rust-lang/rustfmt repo our CI has some functional-like tests that run the updated rustfmt version against different repositories (it's very easy to make seemingly innocuous changes in rustfmt that result in different formatting being emitted)\r\n- any updates needed to the rustc dev guide? For example I'd imagine the [submod section in the conributing intro](https://rustc-dev-guide.rust-lang.org/contributing.html#external-dependencies-submodules) should be updated prior to the conversion or at least very shortly after\r\n- ~~hooking into high-five config to notify rustfmt team (or at least @calebcartwright) on changes to src/tools/rustfmt~~ (done https://github.com/rust-lang/highfive/pull/311)\r\n\r\n### rustfmt-side\r\n\r\n- change default branch (current default branch in rust-lang/rustfmt is set to a previously planned but subsequently indefinitely postponed 2.0 version of rustfmt for reasons I won't go into here)\r\n    - I don't have access to change this currently\r\n- update documentation for contributors\r\n- CI review/updates (we currently have a job that runs with the beta toolchain)\r\n\r\n\r\n### general thoughts/questions\r\n\r\n- switching rustfmt to a subtree will add overhead to compiler contributors. is this acceptable?\r\n- will PRs that modify rustfmt in rust-lang/rust (outside fixes/adjustments required due to rustc mod changes) be rejected? E.g. if someone opens a PR here to add a new config option\r\n   - I assume this is the case but want to be explicit about it, as changes to rustfmt made in rust-lang/rust that bypassed the rustfmt team would be rather problematic IMO\r\n- how easily would we be able to revert back to a submodule should the need arise?\r\n- what should the sync frequency be? 2 weeks?\r\n- I need to educate myself on the process for sync, if conflicts are possible/how best to resolve, etc.\r\n\r\n\r\n### background/motivation\r\nrustfmt is heavily reliant on internal rustc mods (particularly rustc_parse, rustc_ast, and rustc_span) and this is unlikely to change for the foreseeable future. rustfmt currently consumes these via the auto publish crates which ends up being the root cause of several challenges (many discussed in #82208), notably the frequent and often extended broken toolstate on nightly.\r\n\r\nThe thinking is that switching to a subtree would greatly reduce the toolstate issues and associated fallout. Additionally, the other benefit in leveraging the knowledge and expertise of the compiler contributors to apply rustc mod changes in the rustfmt codebase is that it would help the rustfmt development process, since the rustfmt team would no longer have to retroactively apply large batches of rustc mod changes themselves.\r\n\r\nIt's worth noting that rustfmt is also published to crates.io (though admittedly not for a long time, as I don't have access to that either). Switching rustfmt to a subtree would of course result in no longer being able to publish rustfmt directly to crates.io, however, we would still have the option of utilizing and extending the existing rustc auto publish process to continue publishing rustfmt to crates.io just like the other rustc mods\r\n\r\ncc @jyn514 @Manishearth @Mark-Simulacrum ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/82385/reactions", "total_count": 3, "+1": 0, "-1": 0, "laugh": 0, "hooray": 1, "confused": 0, "heart": 2, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/82385/timeline", "performed_via_github_app": null, "state_reason": "completed"}