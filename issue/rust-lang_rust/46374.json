{"url": "https://api.github.com/repos/rust-lang/rust/issues/46374", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/46374/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/46374/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/46374/events", "html_url": "https://github.com/rust-lang/rust/issues/46374", "id": 277854025, "node_id": "MDU6SXNzdWUyNzc4NTQwMjU=", "number": 46374, "title": "ThinLTO exposes too many symbols", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-11-29T18:08:59Z", "updated_at": "2017-12-03T00:55:03Z", "closed_at": "2017-12-03T00:55:03Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "For example given this code:\r\n\r\n```rust\r\npub mod a {                 \r\n    static mut A: i32 = 0;  \r\n    pub fn foo() -> i32 {   \r\n        unsafe { A }        \r\n    }                       \r\n                            \r\n    pub fn set_foo(a: i32) {\r\n        unsafe { A = a; }   \r\n    }                       \r\n}                           \r\n                            \r\npub mod b {                 \r\n    pub fn bar() {}         \r\n}                           \r\n```\r\n\r\nLet's compile without ThinLTO and take a look at the symbols:\r\n\r\n```\r\n$ rustc +nightly -C codegen-units=8 foo.rs --crate-type lib\r\n$ readelf -s libfoo.rlib\r\nFile: libfoo.rlib(foo.foo0.rcgu.o)\r\n\r\nSymbol table '.symtab' contains 8 entries:\r\n   Num:    Value          Size Type    Bind   Vis      Ndx Name\r\n     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND \r\n     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS foo0-8787f43e282added3762\r\n     2: 0000000000000000     4 OBJECT  LOCAL  DEFAULT    7 _ZN3foo1a1A17h6d4d0e10f3b\r\n     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 \r\n     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 \r\n     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    7 \r\n     6: 0000000000000000     7 FUNC    GLOBAL DEFAULT    3 _ZN3foo1a3foo17hb1e13e720\r\n     7: 0000000000000000     7 FUNC    GLOBAL DEFAULT    5 _ZN3foo1a7set_foo17h5e0b4\r\n\r\nFile: libfoo.rlib(foo.foo1.rcgu.o)\r\n\r\nSymbol table '.symtab' contains 4 entries:\r\n   Num:    Value          Size Type    Bind   Vis      Ndx Name\r\n     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND \r\n     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS foo1-8787f43e282added3762\r\n     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 \r\n     3: 0000000000000000     1 FUNC    GLOBAL DEFAULT    3 _ZN3foo1b3bar17h8ae358bf9\r\n\r\nFile: libfoo.rlib(rust.metadata.bin)\r\nreadelf: Error: Not an ELF file - it has the wrong magic bytes at the start\r\n\r\nFile: libfoo.rlib(foo.foo0.rcgu.bytecode.encoded)\r\nreadelf: Error: Not an ELF file - it has the wrong magic bytes at the start\r\n\r\nFile: libfoo.rlib(foo.foo1.rcgu.bytecode.encoded)\r\nreadelf: Error: Not an ELF file - it has the wrong magic bytes at the start\r\n```\r\n\r\nHere we're particularly interested in `ZN3foo1a1A17h6d4d0e10f3b`, the `a::A` constant from above. As expected this is `LOCAL` and `DEFAULT`, notably not exported from the object file as it's still internalized.\r\n\r\nLet's instead compile with ThinLTO: \r\n\r\n```\r\n$ rustc +nightly -C codegen-units=8 foo.rs --crate-type lib -Z thinlto\r\n$ readelf -s libfoo.rlib\r\nreadelf: Error: Not an ELF file - it has the wrong magic bytes at the start\r\nreadelf: Error: Not an ELF file - it has the wrong magic bytes at the start\r\nreadelf: Error: Not an ELF file - it has the wrong magic bytes at the start\r\n\r\nFile: libfoo.rlib(foo.foo0-8787f43e282added376259c1adb08b80.rs.rcgu.o)\r\n\r\nSymbol table '.symtab' contains 7 entries:\r\n   Num:    Value          Size Type    Bind   Vis      Ndx Name\r\n     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND \r\n     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS foo0-8787f43e282added3762\r\n     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 \r\n     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 \r\n     4: 0000000000000000     4 OBJECT  GLOBAL HIDDEN     7 _ZN3foo1a1A17h6d4d0e10f3b\r\n     5: 0000000000000000     7 FUNC    GLOBAL DEFAULT    3 _ZN3foo1a3foo17hb1e13e720\r\n     6: 0000000000000000     7 FUNC    GLOBAL DEFAULT    5 _ZN3foo1a7set_foo17h5e0b4\r\n\r\nFile: libfoo.rlib(foo.foo1-8787f43e282added376259c1adb08b80.rs.rcgu.o)\r\n\r\nSymbol table '.symtab' contains 4 entries:\r\n   Num:    Value          Size Type    Bind   Vis      Ndx Name\r\n     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND \r\n     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS foo1-8787f43e282added3762\r\n     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 \r\n     3: 0000000000000000     1 FUNC    GLOBAL DEFAULT    3 _ZN3foo1b3bar17h8ae358bf9\r\n\r\nFile: libfoo.rlib(rust.metadata.bin)\r\n\r\nFile: libfoo.rlib(foo.foo0-8787f43e282added376259c1adb08b80.rs.rcgu.bytecode.encoded)\r\n\r\nFile: libfoo.rlib(foo.foo1-8787f43e282added376259c1adb08b80.rs.rcgu.bytecode.encoded)\r\n```\r\n\r\nOh dear! Our `_ZN3foo1a1A17h6d4d0e10f3b` symbol has been promoted to `GLOBAL` and `HIDDEN`. That's not good! This symbol, `a::A`, should stay internalized even when compiling with ThinLTO", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/46374/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/46374/timeline", "performed_via_github_app": null, "state_reason": "completed"}