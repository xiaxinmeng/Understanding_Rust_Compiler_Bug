{"url": "https://api.github.com/repos/rust-lang/rust/issues/18086", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/18086/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/18086/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/18086/events", "html_url": "https://github.com/rust-lang/rust/issues/18086", "id": 45954195, "node_id": "MDU6SXNzdWU0NTk1NDE5NQ==", "number": 18086, "title": "Call to Rust extern \"fastcall\" function does not follow GNU/Clang fastcall convention", "user": {"login": "rprichard", "id": 1572855, "node_id": "MDQ6VXNlcjE1NzI4NTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1572855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rprichard", "html_url": "https://github.com/rprichard", "followers_url": "https://api.github.com/users/rprichard/followers", "following_url": "https://api.github.com/users/rprichard/following{/other_user}", "gists_url": "https://api.github.com/users/rprichard/gists{/gist_id}", "starred_url": "https://api.github.com/users/rprichard/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rprichard/subscriptions", "organizations_url": "https://api.github.com/users/rprichard/orgs", "repos_url": "https://api.github.com/users/rprichard/repos", "events_url": "https://api.github.com/users/rprichard/events{/privacy}", "received_events_url": "https://api.github.com/users/rprichard/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2014-10-16T06:52:47Z", "updated_at": "2017-03-09T19:09:53Z", "closed_at": "2016-12-26T20:09:58Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "For a call to an extern \"fastcall\" function on 32-bit Linux, rustc passes arguments via the stack instead of via registers, and it doesn't pop the arguments from the stack after the call.  I was expecting rustc to follow the GNU/Clang \"fastcall\" convention (http://en.wikipedia.org/wiki/X86_calling_conventions#fastcall).  Instead, it seems to be following something like the \"stdcall\" convention.\n\nTest case:\n\n```\ncat > fastcall_callee.c << EOF\n#include <stdio.h>\nvoid callee(int x, int y) __attribute__((fastcall));\nvoid callee(int x, int y) {\n    printf(\"%d %d\\n\", x, y);\n}\nEOF\n\ncat > fastcall_good_caller.c << EOF\nvoid callee(int x, int y) __attribute__((fastcall));\nvoid good_caller() {\n    callee(7, 11);\n    callee(17, 19);\n}\nEOF\n\ncat > fastcall_caller.rs << EOF\nextern crate libc;\n#[link(name = \"fastcall_callee\")]\nextern \"fastcall\" {\n    fn callee(x: libc::c_int, y: libc::c_int);\n}\npub fn main() {\n    unsafe {\n        callee(7, 11);\n        callee(17, 19);\n    }\n}\nEOF\n\nclang -m32 fastcall_callee.c -c -O2\nrm -f libfastcall_callee.a\nar rf libfastcall_callee.a fastcall_callee.o\n\nexport LD_LIBRARY_PATH=$PWD/rust-nightly-i686-unknown-linux-gnu/lib\nrust-nightly-i686-unknown-linux-gnu/bin/rustc fastcall_caller.rs -L . -O\n\n./fastcall_caller\n```\n\nOutput:\n\n```\n-159272960 -7321680\n0 -7323132\nSegmentation fault (core dumped)\n```\n\nHere's the assembly output from main (with some stuff elided):\n\n```\n_ZN4main20h75001e02b331b561raaE:\n    cmpl    %gs:48, %esp\n    ja  .LBB0_2\n    pushl   $0\n    pushl   $12\n    calll   __morestack\n    retl\n.LBB0_2:\n    pushl   %ebx\n    subl    $8, %esp\n    calll   .L0$pb\n.L0$pb:\n    popl    %ebx\n.Ltmp3:\n    addl    $_GLOBAL_OFFSET_TABLE_+(.Ltmp3-.L0$pb), %ebx\n    movl    $11, 4(%esp)\n    movl    $7, (%esp)\n    calll   callee@PLT\n    subl    $8, %esp\n    movl    $19, 4(%esp)\n    movl    $17, (%esp)\n    calll   callee@PLT\n    popl    %ebx\n    retl\n```\n\nI compiled both `fastcall_good_caller.c` and `fastcall_caller.rs` to LLVM IR, and the difference seems to be an `inreg` keyword.  Clang outputs it, but Rust doesn't.\n\nfastcall_good_caller.ll:\n\n```\n; Function Attrs: nounwind\ndefine void @good_caller() #0 {\n  tail call x86_fastcallcc void @callee(i32 inreg 7, i32 inreg 11) #2\n  tail call x86_fastcallcc void @callee(i32 inreg 17, i32 inreg 19) #2\n  ret void\n}\n\nattributes #0 = { nounwind \"less-precise-fpmad\"=\"false\" \"no-frame-pointer-elim\"=\"false\" \"no-infs-fp-math\"=\"false\" \"no-nans-fp-math\"=\"false\" \"stack-protector-buffer-size\"=\"8\" \"unsafe-fp-math\"=\"false\" \"use-soft-float\"=\"false\" }\nattributes #2 = { nounwind }\n```\n\nfastcall_caller.ll:\n\n```\n; Function Attrs: uwtable\ndefine internal void @_ZN4main20h75001e02b331b561raaE() unnamed_addr #1 {\nentry-block:\n  tail call x86_fastcallcc void @callee(i32 7, i32 11)\n  tail call x86_fastcallcc void @callee(i32 17, i32 19)\n  ret void\n}\n\nattributes #1 = { uwtable \"split-stack\" }\n```\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/18086/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/18086/timeline", "performed_via_github_app": null, "state_reason": "completed"}