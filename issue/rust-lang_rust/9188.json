{"url": "https://api.github.com/repos/rust-lang/rust/issues/9188", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/9188/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/9188/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/9188/events", "html_url": "https://github.com/rust-lang/rust/issues/9188", "id": 19492085, "node_id": "MDU6SXNzdWUxOTQ5MjA4NQ==", "number": 9188, "title": "Inner statics all have the same symbol name", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2013-09-14T06:57:55Z", "updated_at": "2013-09-16T10:55:47Z", "closed_at": "2013-09-16T10:55:47Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Turns out this is not only inconvenient, but also a serious problem.\n\n``` rust\n// bar.rs\npub fn foo<T>() -> &'static int {\n    if false {               \n        static a: int = 4;       \n        return &a;               \n    } else {                     \n        static a: int = 5;       \n        return &a;               \n    }                            \n}                                \n\npub fn bar() -> &'static int {   \n    foo::<int>()                 \n}                                \n```\n\n``` rust\n// foo.rs\nextern mod bar;                 \n\nfn main() {                     \n    let a = bar::bar();         \n    let b = bar::foo::<int>();\n    println!(\"{} {}\", *a, *b);  \n}                               \n```\n\n```\n$ rustc --lib bar.rs\nwarning: missing crate link meta `name`, using `bar` as default\nwarning: missing crate link meta `vers`, using `0.0` as default\nwarning: no debug symbols in executable (-arch x86_64)\n$ rustc foo.rs -L.\nwarning: no debug symbols in executable (-arch x86_64)\n$ ./foo\n5 4\n```\n\nHere's what's happening (to the best of my knowledge):\n1. When compiling `bar.rs`, the same symbol name, N, is generated for both statics. LLVM will silently rename the second to N1, so we have N = 4, N1 = 5. Note that both statics are walked through because this is a generic function, meaning that we still walk the statics to emit them into this crate (may have to do that for inner functions as well).\n2. The function `bar` is resolved in-crate, and because the symbol names have already been generated, `N1` will be returned (5).\n3. When compiling `foo.rs`, the function `bar::foo` is again instantiated, but this time we have our clever optimization which ignores the first block of the `if` statement, hence only _one_ of the statics is translated. In this case, it's declared with the name N.\n4. When linking is done, the version of `bar::foo` in `bar` returns N1, and the version of `bar::foo` in `foo` returns N, hence the difference.\n\nThere's a lot of things going wrong here, and I'm not entirely sure why, but I think that this would all be fixed if inner statics had different symbol names (no silent renamings from LLVM).\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/9188/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/9188/timeline", "performed_via_github_app": null, "state_reason": "completed"}