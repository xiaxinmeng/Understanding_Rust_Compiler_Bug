{"url": "https://api.github.com/repos/rust-lang/rust/issues/105762", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/105762/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/105762/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/105762/events", "html_url": "https://github.com/rust-lang/rust/issues/105762", "id": 1499090299, "node_id": "I_kwDOAAsO6M5ZWk17", "number": 105762, "title": "Cannot subtract dates before UNIX_EPOCH when targeting wasm32", "user": {"login": "heaths", "id": 1532486, "node_id": "MDQ6VXNlcjE1MzI0ODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1532486?v=4", "gravatar_id": "", "url": "https://api.github.com/users/heaths", "html_url": "https://github.com/heaths", "followers_url": "https://api.github.com/users/heaths/followers", "following_url": "https://api.github.com/users/heaths/following{/other_user}", "gists_url": "https://api.github.com/users/heaths/gists{/gist_id}", "starred_url": "https://api.github.com/users/heaths/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/heaths/subscriptions", "organizations_url": "https://api.github.com/users/heaths/orgs", "repos_url": "https://api.github.com/users/heaths/repos", "events_url": "https://api.github.com/users/heaths/events{/privacy}", "received_events_url": "https://api.github.com/users/heaths/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 474645165, "node_id": "MDU6TGFiZWw0NzQ2NDUxNjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-wasm", "name": "O-wasm", "color": "6e6ec0", "default": false, "description": "Target: WASM (WebAssembly), http://webassembly.org/"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": {"login": "heaths", "id": 1532486, "node_id": "MDQ6VXNlcjE1MzI0ODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1532486?v=4", "gravatar_id": "", "url": "https://api.github.com/users/heaths", "html_url": "https://github.com/heaths", "followers_url": "https://api.github.com/users/heaths/followers", "following_url": "https://api.github.com/users/heaths/following{/other_user}", "gists_url": "https://api.github.com/users/heaths/gists{/gist_id}", "starred_url": "https://api.github.com/users/heaths/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/heaths/subscriptions", "organizations_url": "https://api.github.com/users/heaths/orgs", "repos_url": "https://api.github.com/users/heaths/repos", "events_url": "https://api.github.com/users/heaths/events{/privacy}", "received_events_url": "https://api.github.com/users/heaths/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "heaths", "id": 1532486, "node_id": "MDQ6VXNlcjE1MzI0ODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1532486?v=4", "gravatar_id": "", "url": "https://api.github.com/users/heaths", "html_url": "https://github.com/heaths", "followers_url": "https://api.github.com/users/heaths/followers", "following_url": "https://api.github.com/users/heaths/following{/other_user}", "gists_url": "https://api.github.com/users/heaths/gists{/gist_id}", "starred_url": "https://api.github.com/users/heaths/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/heaths/subscriptions", "organizations_url": "https://api.github.com/users/heaths/orgs", "repos_url": "https://api.github.com/users/heaths/repos", "events_url": "https://api.github.com/users/heaths/events{/privacy}", "received_events_url": "https://api.github.com/users/heaths/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 11, "created_at": "2022-12-15T21:10:46Z", "updated_at": "2023-01-18T06:53:58Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I'm using a crate that calculates the Windows epoch (1601-01-01T00:00:00Z) from the `UNIX_EPOCH` (1970-01-01T00:00:00Z) but it panics when targeting wasm32-unknown-unknown because of a `checked_sub` against `u64`. This appears to be because, for wasm32 (references \"unsupported\" sources up a level in the source tree), `SystemTime` is a newtype of `Duration`, which uses unsigned integers. On (most?) other platforms, `SystemTime` is a `Timespec` which uses signed integers; thus, any arithmetic on said fields can produce negative results, which is desirable.\n\nGiven `Duration` represents a span of time instead of an absolute time like `SystemTime`, shouldn't any `SystemTime` use signed integers representing absolute time?\n\nI tried this code:\n\n```rust\n/// Returns the epoch used for Windows `FILETIME` values.\nfn filetime_epoch() -> SystemTime {\n    // The epoch used by CFB files is Jan 1, 1601 UTC, which we can calculate\n    // from the Unix epoch constant, which is Jan 1, 1970 UTC.\n    UNIX_EPOCH - Duration::from_secs(11644473600)\n}\n```\n\nI expected a `SystemTime` representing 1601-01-01T00:00:00.\n\nInstead, a panic occurred in `<std::time::SystemTime as core::ops::arith::Sub<core::time::Duration>>::sub`:\n\n```rust\nfn sub(self, rhs: Duration) -> Duration {\n    self.checked_sub(rhs).expect(\"overflow when subtracting durations\")\n}\n```\n\n### Meta\n\n`rustc --version --verbose`:\n```\nrustc 1.64.0 (a55dd71d5 2022-09-19)\nbinary: rustc\ncommit-hash: a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52\ncommit-date: 2022-09-19\nhost: x86_64-unknown-linux-gnu\nrelease: 1.64.0\nLLVM version: 14.0.6\n```\n\n<details><summary>WASM backtrace</summary>\n<p>\n<code>wasm-pack</code> or something in the toolchain seems to ignore <code>RUST_BACKTRACE</code> but the browser is generating it's own, which I hope is helpful:\n\n```\n$core::option::expect_failed::ha758e0d1c5165b94 | @ | 7516d5d\u2026\u2026odule.wasm:0x1318da\n$<std::time::SystemTime as core::ops::arith::Sub<core::time::Duration>>::sub::h47beefa3c5880621 | @ | 7516d5d\u2026\u2026odule.wasm:0x10e7c0\n$msi::internal::time::filetime_epoch::h319c0984523cb136 | @ | 7516d5d\u2026.module.wasm:0xf247e\n$msi::internal::time::system_time_from_filetime::hb7b59f8afe76e03c\n```\n</p>\n</details>\n\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"heaths\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/105762/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/105762/timeline", "performed_via_github_app": null, "state_reason": null}