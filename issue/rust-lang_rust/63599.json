{"url": "https://api.github.com/repos/rust-lang/rust/issues/63599", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/63599/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/63599/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/63599/events", "html_url": "https://github.com/rust-lang/rust/issues/63599", "id": 481217522, "node_id": "MDU6SXNzdWU0ODEyMTc1MjI=", "number": 63599, "title": "Stabilize RFC 2451, re-rebalance coherence", "user": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668019, "node_id": "MDU6TGFiZWwyMTE2NjgwMTk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-lang", "name": "T-lang", "color": "bfd4f2", "default": false, "description": "Relevant to the language team, which will review and decide on the PR/issue."}, {"id": 919710011, "node_id": "MDU6TGFiZWw5MTk3MTAwMTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/disposition-merge", "name": "disposition-merge", "color": "008800", "default": false, "description": "This issue / PR is in PFCP or FCP with a disposition to merge it."}, {"id": 923282386, "node_id": "MDU6TGFiZWw5MjMyODIzODY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/finished-final-comment-period", "name": "finished-final-comment-period", "color": "f9e189", "default": false, "description": "The final comment period is finished for this PR / Issue."}, {"id": 1553045546, "node_id": "MDU6TGFiZWwxNTUzMDQ1NTQ2", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-re_rebalance_coherence", "name": "F-re_rebalance_coherence", "color": "f9c0cc", "default": false, "description": "`#![feature(re_rebalance_coherence)]`"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 13, "created_at": "2019-08-15T15:53:36Z", "updated_at": "2019-11-13T17:36:50Z", "closed_at": "2019-11-09T09:33:17Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "# Stabilization Proposal\r\n\r\nI am writing to propose we stabilize the implementation of [RFC 2451], \"re-rebalancing coherence\" ([tracking issue]).\r\n\r\n[RFC 2451]: https://rust-lang.github.io/rfcs/2451-re-rebalancing-coherence.html\r\n[tracking issue]: https://github.com/rust-lang/rust/issues/55437\r\n\r\n## Brief Summary\r\n\r\nThe RFC modifies the coherence rules. It used to be that, when implementing a non-local trait, if Ti was the first \"local type\", then all type parameters were forbidden before that point. In practice, that meant that this impl was illegal:\r\n\r\n```rust\r\nstruct Local;\r\n\r\nimpl<T> Foreign<Local> for Vec<T> { }\r\n//              ^^^^^          ^\r\n//              |              type parameter\r\n//              first local type\r\n```\r\n\r\nThe RFC lightly generalizes these rules. In particular, type parameters are now allowed before Ti, but *only* if they are **covered**, defined in the RFC as:\r\n\r\n> Covered Type: A type which appears as a parameter to another type. For example, `T` is uncovered, but the `T` in `Vec<T>` is covered. This is only relevant for type parameters.\r\n\r\nThis means that the impl above is now legal, because the type`T` is covered by `Vec`. Note that an impl like the following would still be illegal:\r\n\r\n```rust\r\nstruct Local;\r\n\r\nimpl<T> Foreign<Local> for T { }\r\n//              ^^^^^      ^\r\n//              |          type parameter (uncovered)\r\n//              first local type\r\n```\r\n\r\nIt is considered a (semver) breaking change for parent crates to add impls with uncovered type parameters (this was already the case even with the old rules, I believe). Therefore, this generalization of the rules cannot permit a conflict between the parent crate and a child crate. ([See RFC for a more detailed argument.](https://rust-lang.github.io/rfcs/2451-re-rebalancing-coherence.html#concrete-orphan-rules))\r\n\r\n(NB: I've elided details of `#[fundamental]` in this summary, see the RFC for full details.)\r\n\r\n## Changes since the RFC was approved\r\n\r\nNone\r\n\r\n## Test cases\r\n\r\nThis section describes the patterns covered by new tests added for this RFC, or tests that seemed relevant to this RFC, with links to the test files.\r\n\r\n- `impl<T> Foreign<Local> for Foreign<T, Foreign>` -- [re-rebalance-coherence.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/re-rebalance-coherence.rs#L11), [re-rebalance-coherence-rpass.rs](https://github.com/rust-lang/rust/blob/master/src/test/ui/coherence/re-rebalance-coherence-rpass.rs#L12) (these appear to be duplicate tests)\r\n- `impl<T> Foreign for Foreign<T, Local<T>>` -- [coherence-cow.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/coherence-cow.rs#L18), [coherence-cow.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/coherence-cow.rs#L23)\r\n- `impl<T,U> Foreign for Foreign<T, Local<U>>` -- [coherence-cow.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/coherence-cow.rs#L28), [coherence-pair-covered-uncovered.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/coherence-lone-type-parameter.rs#L9)\r\n- `impl<T> Foreign<Local> for T` -- [coherence-bigint-param.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/coherence-bigint-param.rs#L11)\r\n- `impl Foreign for Local<T>` -- [coherence-covered-type-parameter.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/coherence-covered-type-parameter.rs#L15), [coherence-iterator-vec.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/coherence-iterator-vec.rs#L15)\r\n- `impl<T> Foreign<T> for Foreign` -- [coherence-all-remote.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/coherence-all-remote.rs#L9)\r\n- `impl Foreign<Local> for Foreign` -- [coherence-bigint-int.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/coherence-bigint-int.rs#L14), [coherence-bigint-vecint.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/coherence-bigint-vecint.rs#L14)\r\n- `impl<T> Foreign for T` -- [coherence-cross-crate-conflict.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/coherence-cross-crate-conflict.rs#L12), [coherence-lone-type-parameter.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/coherence-lone-type-parameter.rs#L9)\r\n- `impl Foreign for Foreign<Local>` -- [coherence-vec-local.rs](https://github.com/rust-lang/rust/blob/1cdcea920e56a5d0587307a4c9cf8fff5c77c4bc/src/test/ui/coherence/coherence-vec-local.rs#L14)\r\n- `impl<T> Foreign<Foreign<T>, Local> for Foreign<T>` -- in https://github.com/rust-lang/rust/pull/64414\r\n- `impl<T> Foreign<Local> for Fundamental<T>` -- in https://github.com/rust-lang/rust/pull/64414\r\n\r\n## Missing items\r\n\r\n- [ ] Open PR against the reference, updating documentation\r\n- [x] Fix https://github.com/rust-lang/rust/issues/64412\r\n- [ ] Add more tests for fundamental patterns -- we did not by any means tile the space", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/63599/reactions", "total_count": 23, "+1": 8, "-1": 0, "laugh": 0, "hooray": 15, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/63599/timeline", "performed_via_github_app": null, "state_reason": "completed"}