{"url": "https://api.github.com/repos/rust-lang/rust/issues/24427", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/24427/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/24427/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/24427/events", "html_url": "https://github.com/rust-lang/rust/issues/24427", "id": 68465432, "node_id": "MDU6SXNzdWU2ODQ2NTQzMg==", "number": 24427, "title": "Calls from C to Rust get miscompiled on Windows 64", "user": {"login": "vosen", "id": 1206376, "node_id": "MDQ6VXNlcjEyMDYzNzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1206376?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vosen", "html_url": "https://github.com/vosen", "followers_url": "https://api.github.com/users/vosen/followers", "following_url": "https://api.github.com/users/vosen/following{/other_user}", "gists_url": "https://api.github.com/users/vosen/gists{/gist_id}", "starred_url": "https://api.github.com/users/vosen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vosen/subscriptions", "organizations_url": "https://api.github.com/users/vosen/orgs", "repos_url": "https://api.github.com/users/vosen/repos", "events_url": "https://api.github.com/users/vosen/events{/privacy}", "received_events_url": "https://api.github.com/users/vosen/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2015-04-14T18:41:34Z", "updated_at": "2016-04-08T19:39:24Z", "closed_at": "2016-04-08T19:39:24Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Rust code:\n\n```\n#[repr(C)]\npub struct Data {\n    bar: u64,\n    baz: u64,\n}\n\n#[no_mangle]\npub extern fn foo(a1: Data,\n                  a2: Data,\n                  a3: Data,\n                  a4: Data,\n                  a5: Data) {\n    println!(\"{:}\", a1.bar);\n    println!(\"{:}\", a2.bar);\n    println!(\"{:}\", a3.bar);\n    println!(\"{:}\", a4.bar);\n    println!(\"{:}\", a5.bar);\n}\n\n\nextern {\n    fn c_main();\n}\n\nfn main() {\n    unsafe { c_main() };\n}\n```\n\nC code:\n\n```\n#include <stdint.h>\n\ntypedef struct data {\n    uint64_t bar;\n    uint64_t baz;\n} data;\nvoid foo(data a1,\n         data a2,\n         data a3,\n         data a4,\n         data a5);\n\nvoid c_main(void) {\n    data a1;\n    a1.bar = 1;\n    data a2;\n    a2.bar = 2;\n    data a3;\n    a3.bar = 3;\n    data a4;\n    a4.bar = 4;\n    data a5;\n    a5.bar = 5;\n    foo(a1, a2, a3, a4, a5);\n}\n```\n\nExpected output:\n\n```\n1\n2\n3\n4\n5\n```\n\nActual output:\n\n```\n1\n2\n3\n4\n2357776\n```\n\nI couldn't reproduce it with larger number of smaller arguments (eg. passing ten u64s), couldn't reproduce it on 32 bits either. Changing debug/optimization options has no effect.\nWorks correctly when calling C from C (eg. using [this code](https://gist.github.com/vosen/baa3e405b5dffb38e4fd)).\nIt originally manifested on another 64 bit machine, but I don't have access to it at the moment, though I can get its enviroment too.\n\nLLVM IR: [here](https://gist.github.com/vosen/d7ca397f801b0d312087)\nAssembly: [here](https://gist.github.com/vosen/d7ca397f801b0d312087)\nGcc version: 4.9.2 x86_64-pc-msys ([verbose output](https://gist.github.com/vosen/cedf23cc22b9701edb8a))\nRust version:\n\n```\nrustc 1.0.0-nightly (6790b0e51 2015-04-11) (built 2015-04-12)\nbinary: rustc\ncommit-hash: 6790b0e51967b1487728d155e0800a1ed03a30d3\ncommit-date: 2015-04-11\nbuild-date: 2015-04-12\nhost: x86_64-pc-windows-gnu\nrelease: 1.0.0-nightly\n```\n\nCompiled and ran with `gcc main.c -c -o libcmain.a && rustc main.rs -l cmain -L. && main.exe`\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/24427/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/24427/timeline", "performed_via_github_app": null, "state_reason": "completed"}