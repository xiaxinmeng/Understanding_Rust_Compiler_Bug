{"url": "https://api.github.com/repos/rust-lang/rust/issues/31872", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/31872/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/31872/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/31872/events", "html_url": "https://github.com/rust-lang/rust/issues/31872", "id": 136210982, "node_id": "MDU6SXNzdWUxMzYyMTA5ODI=", "number": 31872, "title": "Destructuring irrefutable enums with ref inside match causes a panic", "user": {"login": "mkroman", "id": 173308, "node_id": "MDQ6VXNlcjE3MzMwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/173308?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mkroman", "html_url": "https://github.com/mkroman", "followers_url": "https://api.github.com/users/mkroman/followers", "following_url": "https://api.github.com/users/mkroman/following{/other_user}", "gists_url": "https://api.github.com/users/mkroman/gists{/gist_id}", "starred_url": "https://api.github.com/users/mkroman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mkroman/subscriptions", "organizations_url": "https://api.github.com/users/mkroman/orgs", "repos_url": "https://api.github.com/users/mkroman/repos", "events_url": "https://api.github.com/users/mkroman/events{/privacy}", "received_events_url": "https://api.github.com/users/mkroman/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2016-02-24T22:42:41Z", "updated_at": "2016-03-14T16:43:57Z", "closed_at": "2016-03-14T16:43:57Z", "author_association": "NONE", "active_lock_reason": null, "body": "When destructuring an irrefutable enum inside a destructured match pattern with references, the compiler crashes. I tried replicating the case with as little code as possible, but it seems to only happen when I use the enum from the `irc` crate.\n\nThis is the code I managed to narrow it down to:\n\n``` rust\nextern crate irc;\n\nuse irc::client::data::command::Command;\n\npub enum Event<'a> {\n    Command(&'a str, Vec<&'a str>)\n}\n\nstruct Plugin;\n\nimpl Plugin {\n    fn process(&self, command: Command, event: Event) {\n        match event {\n            Event::Command(ref cmd, ref args) => {\n                let Command::PRIVMSG(ref target, ref msg) = command; // <--\n            }\n        }\n    }\n}\n\nfn main() {\n    let plugin = Plugin;\n    let event = Event::Command(\"hello\", vec![\"world\"]);\n    let cmd = Command::PRIVMSG(\"foo\".to_string(), \"bar\".to_string());\n\n    plugin.process(cmd, event);\n}\n```\n\nNote that it is destructuring from the `command` argument to the `process` function, and not the destructured reference `cmd`.\n\nI expected `cmd` and `args` to both be references to the types in the `Event::Command` enum, and expected `target` and `msg` to be `&str`s referencing the `String`s defined in the `Command::PRIVMSG` enum type in [the `irc` crate](https://aatxe.github.io/irc/irc/client/data/command/enum.Command.html).\n\nInstead, the compiler panics with the following error:\n\n```\nerror: internal compiler error: unexpected panic\nnote: the compiler unexpectedly panicked. this is a bug.\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\nnote: run with `RUST_BACKTRACE=1` for a backtrace\nthread 'rustc' panicked at 'assertion failed: `(left == right)` (left: `64`, right: `1`)', ../src/librustc/middle/check_match.rs:1051\nnote: Run with `RUST_BACKTRACE=1` for a backtrace.\n\nCould not compile `plugins`.\n```\n## Meta\n### Rust version:\n\nrustc 1.8.0-nightly (c8fc4817d 2016-02-22)\nbinary: rustc\ncommit-hash: c8fc4817dcbf50690aba1fc8bd4db336aff2dbc6\ncommit-date: 2016-02-22\nhost: x86_64-unknown-linux-gnu\nrelease: 1.8.0-nightly\n### Backtrace:\n\n```\n   Compiling compiler-crash v0.1.0 (file:///home/mk/Projects/Rust/compiler-crash)\n     Running `rustc src/main.rs --crate-name compiler_crash --crate-type bin -g --out-dir /home/mk/Projects/Rust/compiler-crash/target/debug --emit=dep-info,link -L dependency=/home/mk/Projects/Rust/compiler-crash/target/debug -L dependency=/home/mk/Projects/Rust/compiler-crash/target/debug/deps --extern irc=/home/mk/Projects/Rust/compiler-crash/target/debug/deps/libirc-cc59e736e2ba9456.rlib -L native=/home/mk/Projects/Rust/compiler-crash/target/debug/build/openssl-09576f2f9776fa80/out -L native=/home/mk/Projects/Rust/compiler-crash/target/debug/build/openssl-sys-extras-52d5315fb71d3c6d/out -L native=/usr/lib`\nerror: internal compiler error: unexpected panic\nnote: the compiler unexpectedly panicked. this is a bug.\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\nthread 'rustc' panicked at 'assertion failed: `(left == right)` (left: `64`, right: `1`)', ../src/librustc/middle/check_match.rs:1051\nstack backtrace:\n   1:     0x7f0f59186340 - sys::backtrace::tracing::imp::write::h2bb24970c1600d4fNyu\n   2:     0x7f0f5918f6ab - panicking::default_handler::_$u7b$$u7b$closure$u7d$$u7d$::closure.43727\n   3:     0x7f0f5918f203 - panicking::default_handler::hb760707c7feda3cdbez\n   4:     0x7f0f59157d7c - sys_common::unwind::begin_unwind_inner::h78583c314295e3926mt\n   5:     0x7f0f59158818 - sys_common::unwind::begin_unwind_fmt::h903be369b05a3ccccmt\n   6:     0x7f0f564371d8 - middle::check_match::check_irrefutable::h8d1ba0bed3fbea2aQ4j\n   7:     0x7f0f56407f42 - middle::check_match::check_local::h2d216d4e5ead2573K2j\n   8:     0x7f0f56405571 - middle::check_match::check_expr::h52b2bafd753fd3e2ESi\n   9:     0x7f0f5640a3b1 - intravisit::walk_arm::h17326268766873259457\n  10:     0x7f0f5640529e - middle::check_match::check_expr::h52b2bafd753fd3e2ESi\n  11:     0x7f0f564081ba - middle::check_match::check_fn::h082db3cfa9cb9bc8A3j\n  12:     0x7f0f5640919d - middle::check_match::check_crate::hc28c1fe732f94679kSi\n  13:     0x7f0f596ad42e - driver::phase_3_run_analysis_passes::_$u7b$$u7b$closure$u7d$$u7d$::closure.28446\n  14:     0x7f0f596aa1e5 - middle::ty::context::ctxt<'tcx>::create_and_enter::h6911830796927350595\n  15:     0x7f0f596a6d3f - driver::phase_3_run_analysis_passes::h10607465921210735652\n  16:     0x7f0f596785b5 - driver::compile_input::h9417f7071f41b0b1Bca\n  17:     0x7f0f59668907 - run_compiler::h1d04446f72d95b52HOc\n  18:     0x7f0f596660b1 - sys_common::unwind::try::try_fn::h2224149726337910613\n  19:     0x7f0f59183d9b - __rust_try\n  20:     0x7f0f5917c34d - sys_common::unwind::inner_try::hdfdf33e7068c9cb28jt\n  21:     0x7f0f59666900 - boxed::F.FnBox<A>::call_box::h8331008289514682961\n  22:     0x7f0f5918dc79 - sys::thread::Thread::new::thread_start::h1272204999bddc95vby\n  23:     0x7f0f518c5423 - start_thread\n  24:     0x7f0f58e05cbc - clone\n  25:                0x0 - <unknown>\n\nCould not compile `compiler-crash`.\n\nCaused by:\n  Process didn't exit successfully: `rustc src/main.rs --crate-name compiler_crash --crate-type bin -g --out-dir /home/mk/Projects/Rust/compiler-crash/target/debug --emit=dep-info,link -L dependency=/home/mk/Projects/Rust/compiler-crash/target/debug -L dependency=/home/mk/Projects/Rust/compiler-crash/target/debug/deps --extern irc=/home/mk/Projects/Rust/compiler-crash/target/debug/deps/libirc-cc59e736e2ba9456.rlib -L native=/home/mk/Projects/Rust/compiler-crash/target/debug/build/openssl-09576f2f9776fa80/out -L native=/home/mk/Projects/Rust/compiler-crash/target/debug/build/openssl-sys-extras-52d5315fb71d3c6d/out -L native=/usr/lib` (exit code: 101)\n```\n### Repository\n\nI uploaded the code as a repository, with `Cargo.lock` for easier replication.\nhttps://github.com/mkroman/compiler-crash\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/31872/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/31872/timeline", "performed_via_github_app": null, "state_reason": "completed"}