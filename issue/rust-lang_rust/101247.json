{"url": "https://api.github.com/repos/rust-lang/rust/issues/101247", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/101247/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/101247/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/101247/events", "html_url": "https://github.com/rust-lang/rust/issues/101247", "id": 1357612883, "node_id": "I_kwDOAAsO6M5Q64dT", "number": 101247, "title": "[Mac M2 pro] Seg faults on multiple libraries", "user": {"login": "shirshak55", "id": 8097377, "node_id": "MDQ6VXNlcjgwOTczNzc=", "avatar_url": "https://avatars.githubusercontent.com/u/8097377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shirshak55", "html_url": "https://github.com/shirshak55", "followers_url": "https://api.github.com/users/shirshak55/followers", "following_url": "https://api.github.com/users/shirshak55/following{/other_user}", "gists_url": "https://api.github.com/users/shirshak55/gists{/gist_id}", "starred_url": "https://api.github.com/users/shirshak55/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shirshak55/subscriptions", "organizations_url": "https://api.github.com/users/shirshak55/orgs", "repos_url": "https://api.github.com/users/shirshak55/repos", "events_url": "https://api.github.com/users/shirshak55/events{/privacy}", "received_events_url": "https://api.github.com/users/shirshak55/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123111, "node_id": "MDU6TGFiZWwxMjMxMTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-macos", "name": "O-macos", "color": "6e6ec0", "default": false, "description": "Operating system: macOS"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 3940166907, "node_id": "LA_kwDOAAsO6M7q2iz7", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-AArch64", "name": "O-AArch64", "color": "6e6ec0", "default": false, "description": "Armv8-A or later processors in AArch64 mode"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2022-08-31T16:56:11Z", "updated_at": "2022-09-14T04:03:22Z", "closed_at": "2022-09-14T04:03:05Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I am currently using m2 and have issues with multiple libraries like Tokio / Cargo what-features. It segfaults which means I am unable to use a rust compiler in my m2 pro 13inch 24 GB ram. I initially thought it was a crate issue, but I think it is a problem with rust in general and is related to formatted-related things.\r\n\r\n\r\nThis doesn't seg fault\r\n\r\nCargo.toml\r\n```\r\n[dependencies]\r\ntokio = { version = \"1.20.1\", features = [\"rt-multi-thread\",\"macros\"] }\r\n```\r\n\r\nmain.rs\r\n```\r\n#[tokio::main]\r\nasync fn main() {\r\n    println!(\"Hello, world!\");\r\n}\r\n\r\n```\r\n\r\nIf I add process feature to tokio it segfaults\r\n\r\n```\r\n[dependencies]\r\ntokio = { version = \"1.20.1\", features = [\"rt-multi-thread\",\"macros\",\"process\"] }\r\n```\r\n\r\nRunning from lldb, I don't know why I don't get symbols but it shows the following output\r\n\r\n\r\n```\r\nlldb target/debug/delete_it\r\n(lldb) target create \"target/debug/delete_it\"\r\nCurrent executable set to '/Users/quantum/Desktop/projects/internal/delete_it/target/debug/delete_it' (arm64).\r\n(lldb) run\r\nProcess 14100 launched: '/Users/quantum/Desktop/projects/internal/delete_it/target/debug/delete_it' (arm64)\r\nProcess 14100 stopped\r\n* thread #1, name = 'main', queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x22)\r\n    frame #0: 0x0000000100151a78 delete_it`ltmp0 + 1380136\r\ndelete_it`core::fmt::Formatter::debug_struct::h8fffffccd422503e:\r\n->  0x100151a78 <+20>: ldr    x0, [x0, #0x20]\r\n    0x100151a7c <+24>: ldr    x8, [x19, #0x28]\r\n    0x100151a80 <+28>: ldr    x8, [x8, #0x18]\r\n    0x100151a84 <+32>: blr    x8\r\nTarget 0: (delete_it) stopped.\r\n(lldb)\r\n```\r\n\r\nI guess there is some issue with core::fmt::Formatter::debug_struct. I don't know the internals of rust so, I can't speak anything else.\r\n\r\n\r\nNow lets run through Address sanitizer\r\n\r\n```\r\n\r\nexport RUSTFLAGS=-Zsanitizer=address\r\ncargo run\r\n   Compiling proc-macro2 v1.0.43\r\n   Compiling libc v0.2.132\r\n   Compiling unicode-ident v1.0.3\r\n   Compiling quote v1.0.21\r\n   Compiling syn v1.0.99\r\n   Compiling log v0.4.17\r\n   Compiling cfg-if v1.0.0\r\n   Compiling autocfg v1.1.0\r\n   Compiling pin-project-lite v0.2.9\r\n   Compiling once_cell v1.13.1\r\n   Compiling bytes v1.2.1\r\n   Compiling tokio v1.20.1\r\n   Compiling mio v0.8.4\r\n   Compiling signal-hook-registry v1.4.0\r\n   Compiling num_cpus v1.13.1\r\n   Compiling tokio-macros v1.8.0\r\n==14297==ERROR: Interceptors are not working. This may be because AddressSanitizer is loaded too late (e.g. via dlopen). Please launch the executable with:\r\nDYLD_INSERT_LIBRARIES=/Users/quantum/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/lib/librustc-nightly_rt.asan.dylib\r\n\"interceptors not installed\" && 0\r\nerror: could not compile `tokio`\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name tokio --edition=2018 /Users/quantum/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.20.1/src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts,future-incompat --crate-type lib --emit=dep-info,metadata,link -C embed-bitcode=no -C split-debuginfo=unpacked -C debuginfo=2 --cfg 'feature=\"bytes\"' --cfg 'feature=\"default\"' --cfg 'feature=\"libc\"' --cfg 'feature=\"macros\"' --cfg 'feature=\"mio\"' --cfg 'feature=\"num_cpus\"' --cfg 'feature=\"once_cell\"' --cfg 'feature=\"process\"' --cfg 'feature=\"rt\"' --cfg 'feature=\"rt-multi-thread\"' --cfg 'feature=\"signal-hook-registry\"' --cfg 'feature=\"tokio-macros\"' -C metadata=710b81268173b05b -C extra-filename=-710b81268173b05b --out-dir /Users/quantum/Desktop/projects/internal/delete_it/target/debug/deps -C linker=clang -L dependency=/Users/quantum/Desktop/projects/internal/delete_it/target/debug/deps --extern bytes=/Users/quantum/Desktop/projects/internal/delete_it/target/debug/deps/libbytes-6024d303b245d77d.rmeta --extern libc=/Users/quantum/Desktop/projects/internal/delete_it/target/debug/deps/liblibc-5666b5f002ccdb48.rmeta --extern mio=/Users/quantum/Desktop/projects/internal/delete_it/target/debug/deps/libmio-fc00bad52878b24f.rmeta --extern num_cpus=/Users/quantum/Desktop/projects/internal/delete_it/target/debug/deps/libnum_cpus-8f0a3df89f175e22.rmeta --extern once_cell=/Users/quantum/Desktop/projects/internal/delete_it/target/debug/deps/libonce_cell-5abf2d33226eb8d4.rmeta --extern pin_project_lite=/Users/quantum/Desktop/projects/internal/delete_it/target/debug/deps/libpin_project_lite-b7768fffd0c2e379.rmeta --extern signal_hook_registry=/Users/quantum/Desktop/projects/internal/delete_it/target/debug/deps/libsignal_hook_registry-d655ad958efd2a8c.rmeta --extern tokio_macros=/Users/quantum/Desktop/projects/internal/delete_it/target/debug/deps/libtokio_macros-14d631be2357c11b.dylib --cap-lints allow -Zsanitizer=address` (signal: 6, SIGABRT: process abort signal)\r\n```\r\n\r\nShows some errors. I tried `export DYLD_INSERT_LIBRARIES=/Users/quantum/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/lib/librustc-nightly_rt.asan.dylib` but as expected it also doesn't work.\r\n\r\nLastly, I tried with `cargo run -Zbuild-std --target aarch64-apple-darwin`\r\n\r\n\r\n\r\n```\r\ncargo run -Zbuild-std --target aarch64-apple-darwin\r\n   Compiling compiler_builtins v0.1.79\r\n   Compiling core v0.0.0 (/Users/quantum/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/src/rust/library/core)\r\n   Compiling libc v0.2.131\r\n   Compiling cc v1.0.73\r\n   Compiling memchr v2.5.0\r\n   Compiling std v0.0.0 (/Users/quantum/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/src/rust/library/std)\r\n   Compiling libc v0.2.132\r\n   Compiling proc-macro2 v1.0.43\r\n   Compiling quote v1.0.21\r\n   Compiling unicode-ident v1.0.3\r\n   Compiling log v0.4.17\r\n   Compiling syn v1.0.99\r\n   Compiling autocfg v1.1.0\r\n   Compiling tokio v1.20.1\r\n   Compiling unwind v0.0.0 (/Users/quantum/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/src/rust/library/unwind)\r\n   Compiling tokio-macros v1.8.0\r\n   Compiling rustc-std-workspace-core v1.99.0 (/Users/quantum/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/src/rust/library/rustc-std-workspace-core)\r\n   Compiling alloc v0.0.0 (/Users/quantum/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/src/rust/library/alloc)\r\n   Compiling cfg-if v0.1.10\r\n   Compiling adler v0.2.3\r\n   Compiling rustc-demangle v0.1.21\r\n   Compiling rustc-std-workspace-alloc v1.99.0 (/Users/quantum/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/src/rust/library/rustc-std-workspace-alloc)\r\n   Compiling panic_abort v0.0.0 (/Users/quantum/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/src/rust/library/panic_abort)\r\n   Compiling panic_unwind v0.0.0 (/Users/quantum/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/src/rust/library/panic_unwind)\r\n   Compiling gimli v0.25.0\r\n   Compiling object v0.26.2\r\n   Compiling std_detect v0.1.5 (/Users/quantum/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/src/rust/library/stdarch/crates/std_detect)\r\n   Compiling miniz_oxide v0.4.0\r\n   Compiling hashbrown v0.12.3\r\n   Compiling addr2line v0.16.0\r\n   Compiling proc_macro v0.0.0 (/Users/quantum/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/src/rust/library/proc_macro)\r\n   Compiling cfg-if v1.0.0\r\n   Compiling bytes v1.2.1\r\n   Compiling pin-project-lite v0.2.9\r\n   Compiling once_cell v1.13.1\r\n   Compiling signal-hook-registry v1.4.0\r\n   Compiling num_cpus v1.13.1\r\n   Compiling mio v0.8.4\r\n   Compiling delete_it v0.1.0 (/Users/quantum/Desktop/projects/internal/delete_it)\r\n    Finished dev [unoptimized + debuginfo] target(s) in 12.67s\r\n     Running `target/aarch64-apple-darwin/debug/delete_it`\r\nHello, world!\r\n```\r\n\r\nIt works. So, what is the problem? Are the binaries provided by rustup not good?\r\n\r\nThanks.", "closed_by": {"login": "shirshak55", "id": 8097377, "node_id": "MDQ6VXNlcjgwOTczNzc=", "avatar_url": "https://avatars.githubusercontent.com/u/8097377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shirshak55", "html_url": "https://github.com/shirshak55", "followers_url": "https://api.github.com/users/shirshak55/followers", "following_url": "https://api.github.com/users/shirshak55/following{/other_user}", "gists_url": "https://api.github.com/users/shirshak55/gists{/gist_id}", "starred_url": "https://api.github.com/users/shirshak55/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shirshak55/subscriptions", "organizations_url": "https://api.github.com/users/shirshak55/orgs", "repos_url": "https://api.github.com/users/shirshak55/repos", "events_url": "https://api.github.com/users/shirshak55/events{/privacy}", "received_events_url": "https://api.github.com/users/shirshak55/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/101247/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/101247/timeline", "performed_via_github_app": null, "state_reason": "completed"}