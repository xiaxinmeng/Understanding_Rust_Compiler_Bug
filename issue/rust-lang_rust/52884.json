{"url": "https://api.github.com/repos/rust-lang/rust/issues/52884", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/52884/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/52884/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/52884/events", "html_url": "https://github.com/rust-lang/rust/issues/52884", "id": 345964459, "node_id": "MDU6SXNzdWUzNDU5NjQ0NTk=", "number": 52884, "title": "Compiler segfaults when compiling the vte crate for aarch64", "user": {"login": "cramertj", "id": 5963049, "node_id": "MDQ6VXNlcjU5NjMwNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/5963049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cramertj", "html_url": "https://github.com/cramertj", "followers_url": "https://api.github.com/users/cramertj/followers", "following_url": "https://api.github.com/users/cramertj/following{/other_user}", "gists_url": "https://api.github.com/users/cramertj/gists{/gist_id}", "starred_url": "https://api.github.com/users/cramertj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cramertj/subscriptions", "organizations_url": "https://api.github.com/users/cramertj/orgs", "repos_url": "https://api.github.com/users/cramertj/repos", "events_url": "https://api.github.com/users/cramertj/events{/privacy}", "received_events_url": "https://api.github.com/users/cramertj/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 100522, "node_id": "MDU6TGFiZWwxMDA1MjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-crash", "name": "I-crash", "color": "e10c02", "default": false, "description": "Issue: The compiler crashes (SIGSEGV, SIGABRT, etc). Use I-ICE instead when the compiler panics."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2018-07-30T22:42:25Z", "updated_at": "2018-08-31T07:48:15Z", "closed_at": "2018-08-31T07:48:15Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Only reproduces when doing a debug build of rustc for the aarch64-fuchsia target, the aarch64-unknown-linux-gnu target, and presumably others. rustc produces no output, but returns a failure status code. Building with cargo just says \"compiling vte v0.3.2... error: could not compile `vte`\". The log and backtrace can be found [here](https://gist.github.com/cramertj/c7eec7d3e70a38fd11662b2a409dd5ec).\r\n\r\nTo reproduce, run [this command](https://gist.github.com/cramertj/787210f21dc05cddd88d9590cdfce246), which calls [this script](https://fuchsia.googlesource.com/build/+/master/rust/compile_3p_crates.py), which attempts to compile [this crate](https://fuchsia.googlesource.com/third_party/rust-crates/+/master/rustc_deps/Cargo.toml) inside of a fuchsia checkout.\r\n\r\nCompiling with `cargo build -v` shows that there's a SIGSEGV being triggered:\r\n\r\n```\r\nCaused by:\r\n  process didn't exit successfully: `/usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/bin/rustc --crate-name vte vendor/vte/src/lib.rs --color always --crate-type lib --emit=dep-info,link -C debuginfo=2 -C metadata=7dbc2e4c2a7c8274 -C extra-filename=-7dbc2e4c2a7c8274 --out-dir /usr/local/google/home/cramertj/src/fuchsia/out/arm64/rust_third_party/aarch64-fuchsia/debug/deps --target aarch64-fuchsia -C linker=/usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/clang/bin/clang -L dependency=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/rust_third_party/aarch64-fuchsia/debug/deps -L dependency=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/rust_third_party/debug/deps --extern utf8parse=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/rust_third_party/aarch64-fuchsia/debug/deps/libutf8parse-f80c351b97daf887.rlib --cap-lints allow -Clink-arg=--target=aarch64-fuchsia -Copt-level=0 -Clink-arg=--sysroot=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/sdks/zircon_sysroot/arch/arm64/sysroot -Lnative=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/arm64-shared` (signal: 11, SIGSEGV: invalid memory reference)\r\n\r\n```\r\n\r\nRunning this rustc command directly shows rustc failing with a segmentation fault:\r\n```\r\n/usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/bin/rustc --crate-name vte vendor/vte/src/lib.rs --color always --crate-type lib --emit=dep-info,link -C debuginfo=2 -C metadata=7dbc2e4c2a7c8274 -C extra-filename=-7dbc2e4c2a7c8274 --out-dir /usr/local/google/home/cramertj/src/fuchsia/out/arm64/rust_third_party/aarch64-fuchsia/debug/deps --target aarch64-fuchsia -C linker=/usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/clang/bin/clang -L dependency=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/rust_third_party/aarch64-fuchsia/debug/deps -L dependency=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/rust_third_party/debug/deps --extern utf8parse=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/rust_third_party/aarch64-fuchsia/debug/deps/libutf8parse-f80c351b97daf887.rlib --cap-lints allow -Clink-arg=--target=aarch64-fuchsia -Copt-level=0 -Clink-arg=--sysroot=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/sdks/zircon_sysroot/arch/arm64/sysroot -Lnative=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/arm64-shared\r\n[1]    141780 segmentation fault   --crate-name vte vendor/vte/src/lib.rs --color always --crate-type lib  -C \r\n```\r\n\r\nRunning inside gdb gives\r\n\r\n```\r\nStarting program: /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/bin/rustc --crate-name vte vendor/vte/src/lib.rs --color always --crate-type lib --emit=dep-info,link -C debuginfo=2 -C metadata=7dbc2e4c2a7c8274 -C extra-filename=-7dbc2e4c2a7c8274 --out-dir /usr/local/google/home/cramertj/src/fuchsia/out/arm64/rust_third_party/aarch64-fuchsia/debug/deps --target aarch64-fuchsia -C linker=/usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/clang/bin/clang -L dependency=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/rust_third_party/aarch64-fuchsia/debug/deps -L dependency=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/rust_third_party/debug/deps --extern utf8parse=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/rust_third_party/aarch64-fuchsia/debug/deps/libutf8parse-f80c351b97daf887.rlib --cap-lints allow -Clink-arg=--target=aarch64-fuchsia -Copt-level=0 -Clink-arg=--sysroot=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/sdks/zircon_sysroot/arch/arm64/sysroot -Lnative=/usr/local/google/home/cramertj/src/fuchsia/out/arm64/arm64-shared\r\nDwarf Error: wrong version in compilation unit header (is 0, should be 2, 3, or 4) [in module /usr/lib/debug/.build-id/ef/9474f02d7f7a3959b6dae0afe8e6acee1ac5ba.debug]\r\nDwarf Error: wrong version in compilation unit header (is 0, should be 2, 3, or 4) [in module /usr/lib/debug/.build-id/7b/5f153d3f24f886129354bf9e6a32d01607e87a.debug]\r\nDwarf Error: wrong version in compilation unit header (is 0, should be 2, 3, or 4) [in module /usr/lib/debug/.build-id/18/ad48fb80336dd6554ce9d61ecb3ccb7f6befa3.debug]\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\r\nDwarf Error: wrong version in compilation unit header (is 0, should be 2, 3, or 4) [in module /usr/lib/debug/.build-id/cb/88f1fe155855433a969d01f052923b299701b8.debug]\r\nDwarf Error: wrong version in compilation unit header (is 0, should be 2, 3, or 4) [in module /usr/lib/debug/.build-id/45/2d8247a2b64710d413dfc84b6d7c8924aca427.debug]\r\n[New Thread 0x7fffe9bff700 (LWP 148074)]\r\n[New Thread 0x7fffea1ff700 (LWP 148073)]\r\n[New Thread 0x7fffea9fe700 (LWP 148071)]\r\n[New Thread 0x7fffeabff700 (LWP 148070)]\r\n\r\nProgram received signal SIGSEGV, Segmentation fault.\r\n[Switching to Thread 0x7fffe9bff700 (LWP 148074)]\r\n0x00007fffee25db31 in llvm::AArch64RegisterBankInfo::getInstrMapping(llvm::MachineInstr const&) const ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n\r\n```\r\n\r\nThat's a failure in [llvm::AArch64RegisterBankInfo::getInstrMapping](https://github.com/llvm-mirror/llvm/blob/4604874612fa292ab4c49f96aedefdf8be1ff27e/lib/Target/AArch64/AArch64RegisterBankInfo.cpp#L441).\r\n\r\nBacktrace:\r\n```\r\n#0  0x00007fffee25db31 in llvm::AArch64RegisterBankInfo::getInstrMapping(llvm::MachineInstr const&) const ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#1  0x00007fffee2a95ab in llvm::RegBankSelect::assignInstr(llvm::MachineInstr&) ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#2  0x00007fffee2a985b in llvm::RegBankSelect::runOnMachineFunction(llvm::MachineFunction&) ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#3  0x00007fffee64c5e1 in llvm::MachineFunctionPass::runOnFunction(llvm::Function&) ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#4  0x00007fffef025b8a in llvm::FPPassManager::runOnFunction(llvm::Function&) ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#5  0x00007fffef025c33 in llvm::FPPassManager::runOnModule(llvm::Module&) ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#6  0x00007fffef02649c in llvm::legacy::PassManagerImpl::run(llvm::Module&) ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#7  0x00007fffedbe035e in LLVMRustWriteOutputFile ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#8  0x00007fffeda9602a in rustc_codegen_llvm::back::write::write_output_file::hc1598394e3dc1211 ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#9  0x00007fffeda887fd in rustc_codegen_llvm::back::write::codegen::_$u7b$$u7b$closure$u7d$$u7d$::hd52935e011270cea ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#10 0x00007fffeda84088 in rustc::util::common::time_ext::h95d6f9755793118d ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#11 0x00007fffeda98317 in rustc_codegen_llvm::back::write::codegen::hb3c2e05dc727551f ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#12 0x00007fffeda9f5c0 in rustc_codegen_llvm::back::write::execute_work_item::hbe07d0cf915f5ac7 ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#13 0x00007fffeda6ce7e in std::sys_common::backtrace::__rust_begin_short_backtrace::h1bfae061eb41ee5c ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#14 0x00007fffeda8fdb8 in std::panicking::try::do_call::hdd25355d6215f15f ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#15 0x00007ffff76ae00a in __rust_maybe_catch_panic ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/bin/../lib/libstd-5fd27a9c989d76ae.so\r\n#16 0x00007fffeda7b581 in _$LT$F$u20$as$u20$alloc..boxed..FnBox$LT$A$GT$$GT$::call_box::h2db209aaa27400ee ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n#17 0x00007ffff76760ab in std::sys_common::thread::start_thread::hb5e82cfc8bd3d75e ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/bin/../lib/libstd-5fd27a9c989d76ae.so\r\n#18 0x00007ffff7672336 in std::sys::unix::thread::Thread::new::thread_start::h4be83cd1b9373083 ()\r\n   from /usr/local/google/home/cramertj/src/fuchsia/buildtools/linux-x64/rust/bin/../lib/libstd-5fd27a9c989d76ae.so\r\n#19 0x00007ffff1946494 in start_thread (arg=0x7fffe9bff700) at pthread_create.c:333\r\n#20 0x00007ffff7365a8f in clone () from /lib/x86_64-linux-gnu/libc.so.6\r\n```\r\n\r\nThis error does not occur on revision 8acec1, so  the LLVM 7 upgrade (https://github.com/rust-lang/rust/pull/51966) might be at fault here (cc @alexcrichton).\r\n\r\nEdit: Confirmed-- I bisected this locally to the LLVM 7 upgrade (Fuchsia compiles fine before, compiler segfaults after).", "closed_by": {"login": "cramertj", "id": 5963049, "node_id": "MDQ6VXNlcjU5NjMwNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/5963049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cramertj", "html_url": "https://github.com/cramertj", "followers_url": "https://api.github.com/users/cramertj/followers", "following_url": "https://api.github.com/users/cramertj/following{/other_user}", "gists_url": "https://api.github.com/users/cramertj/gists{/gist_id}", "starred_url": "https://api.github.com/users/cramertj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cramertj/subscriptions", "organizations_url": "https://api.github.com/users/cramertj/orgs", "repos_url": "https://api.github.com/users/cramertj/repos", "events_url": "https://api.github.com/users/cramertj/events{/privacy}", "received_events_url": "https://api.github.com/users/cramertj/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/52884/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/52884/timeline", "performed_via_github_app": null, "state_reason": "completed"}