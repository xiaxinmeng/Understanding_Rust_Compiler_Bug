{"url": "https://api.github.com/repos/rust-lang/rust/issues/22250", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/22250/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/22250/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/22250/events", "html_url": "https://github.com/rust-lang/rust/issues/22250", "id": 57541004, "node_id": "MDU6SXNzdWU1NzU0MTAwNA==", "number": 22250, "title": "Process cfg_attr during expansion", "user": {"login": "kmcallister", "id": 444997, "node_id": "MDQ6VXNlcjQ0NDk5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/444997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kmcallister", "html_url": "https://github.com/kmcallister", "followers_url": "https://api.github.com/users/kmcallister/followers", "following_url": "https://api.github.com/users/kmcallister/following{/other_user}", "gists_url": "https://api.github.com/users/kmcallister/gists{/gist_id}", "starred_url": "https://api.github.com/users/kmcallister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kmcallister/subscriptions", "organizations_url": "https://api.github.com/users/kmcallister/orgs", "repos_url": "https://api.github.com/users/kmcallister/repos", "events_url": "https://api.github.com/users/kmcallister/events{/privacy}", "received_events_url": "https://api.github.com/users/kmcallister/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235146, "node_id": "MDU6TGFiZWwyMzUxNDY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-syntaxext", "name": "A-syntaxext", "color": "f7e101", "default": false, "description": "Area: Syntax extensions"}, {"id": 132910982, "node_id": "MDU6TGFiZWwxMzI5MTA5ODI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-macros", "name": "A-macros", "color": "f7e101", "default": false, "description": "Area: All kinds of macros (custom derive, macro_rules!, proc macros, ..)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 15, "created_at": "2015-02-13T00:17:48Z", "updated_at": "2016-09-13T20:43:25Z", "closed_at": "2016-09-13T20:43:25Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "``` rust\nmacro_rules! borked {\n    () => {\n        #[derive(Debug)] pub struct Good;\n        #[cfg_attr(not(test), derive(Debug))] pub struct Bad;\n    }\n}\n\nborked!();\n\nfn main() {\n    println!(\"{:?}\", Good);\n    println!(\"{:?}\", Bad);\n}\n```\n\nproduces\n\n```\nfoo.rs:12:22: 12:25 error: the trait `core::fmt::Show` is not implemented for the type `Bad` [E0277]  \nfoo.rs:12     println!(\"{:?}\", Bad);  \n                               ^~~  \n```\n\nI think what happens is the following:\n- The first cfg stripping pass runs.  At this point the macro body is just a token tree, and there's no way for cfg stripping to work out what `# [ cfg_attr ( not ( test ) ...` means.\n- Syntax expansion runs.  The macro emits two items.  One has a `derive` attribute, which matches a `Decorator` in the syntax environment, so that extension also runs.  There's no extension named `cfg_attr` so that attribute has no effect on expansion.\n- The post-expansion cfg stripping pass runs.  The second attribute turns into `#[derive(Debug)]` but not in time for syntax expansion to notice it.\n\nPreviously, `cfg_attr` _was_ a syntax extension, which had numerous drawbacks, but handled this case correctly.\n\nThe somewhat obvious fix is to re-run `cfg_attr` processing on the AST subtree produced by every macro expansion, but I'd like to think about this more.  I'd also like to know whether it's something people often run into in practice.\n\nWas [mentioned](https://github.com/rust-lang/rust/issues/19372#issuecomment-74131263) on #19372.  cc @sfackler, @SergioBenitez\n", "closed_by": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/22250/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/22250/timeline", "performed_via_github_app": null, "state_reason": "completed"}