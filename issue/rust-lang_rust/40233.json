{"url": "https://api.github.com/repos/rust-lang/rust/issues/40233", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/40233/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/40233/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/40233/events", "html_url": "https://github.com/rust-lang/rust/issues/40233", "id": 211689006, "node_id": "MDU6SXNzdWUyMTE2ODkwMDY=", "number": 40233, "title": "Unexpected behaviour dereferencing raw pointers, using alternative constructor", "user": {"login": "jaheba", "id": 133732, "node_id": "MDQ6VXNlcjEzMzczMg==", "avatar_url": "https://avatars.githubusercontent.com/u/133732?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jaheba", "html_url": "https://github.com/jaheba", "followers_url": "https://api.github.com/users/jaheba/followers", "following_url": "https://api.github.com/users/jaheba/following{/other_user}", "gists_url": "https://api.github.com/users/jaheba/gists{/gist_id}", "starred_url": "https://api.github.com/users/jaheba/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jaheba/subscriptions", "organizations_url": "https://api.github.com/users/jaheba/orgs", "repos_url": "https://api.github.com/users/jaheba/repos", "events_url": "https://api.github.com/users/jaheba/events{/privacy}", "received_events_url": "https://api.github.com/users/jaheba/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2017-03-03T13:34:57Z", "updated_at": "2017-03-03T13:56:35Z", "closed_at": "2017-03-03T13:56:35Z", "author_association": "NONE", "active_lock_reason": null, "body": "\r\nI've implemented a `List`, where stored items reference the list they are stored in:\r\n\r\n```rust\r\nstruct Item {\r\n    list: *mut List,\r\n}\r\n\r\nstruct List {\r\n    values: Vec<Item>,\r\n}\r\n\r\n// Items can access List\r\nimpl Item {\r\n    fn get_len(&self) -> usize {\r\n        unsafe {\r\n            (*self.list).values.len()\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nList has two constructors, one which just creates an empty list, and the other creates a list with an initial value:\r\n\r\n```rust\r\nimpl List {\r\n    fn new() -> Self {\r\n        List { values: Vec::new() }\r\n    }\r\n\r\n    fn with_first() -> Self {\r\n        let mut list = List::new();\r\n        list.push();\r\n        list\r\n    }\r\n\r\n    fn push(&mut self) -> &Item {\r\n        let item = Item::new(self);\r\n        self.values.push(item);\r\n        &self.values.last().unwrap()\r\n    }\r\n}\r\n```\r\n\r\nHowever, calling `with_first` causes some unexpected behaviour:\r\n\r\n```rust\r\nfn main() {\r\n    // works\r\n    let mut list = List::new();\r\n    list.push();\r\n    assert_eq!(list.values[0].get_len(), 1);\r\n\r\n    // not so much\r\n    let list = List::with_first();\r\n    assert_eq!(list.values[0].get_len(), 1);\r\n}\r\n```\r\n\r\n```\r\n$ rustc raw_pointers.rs && ./raw_pointers\r\nthread 'main' panicked at 'assertion failed: `(left == right)` (left: `140734777189792`, right: `1`)', raw_pointers.rs:49\r\nnote: Run with `RUST_BACKTRACE=1` for a backtrace.\r\n```\r\n\r\nFull example can be found [here](https://gist.github.com/jaheba/0fbde0562b60112943e5dc75560ccd60).\r\n\r\nTested on OS X with nightly and stable.", "closed_by": {"login": "jaheba", "id": 133732, "node_id": "MDQ6VXNlcjEzMzczMg==", "avatar_url": "https://avatars.githubusercontent.com/u/133732?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jaheba", "html_url": "https://github.com/jaheba", "followers_url": "https://api.github.com/users/jaheba/followers", "following_url": "https://api.github.com/users/jaheba/following{/other_user}", "gists_url": "https://api.github.com/users/jaheba/gists{/gist_id}", "starred_url": "https://api.github.com/users/jaheba/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jaheba/subscriptions", "organizations_url": "https://api.github.com/users/jaheba/orgs", "repos_url": "https://api.github.com/users/jaheba/repos", "events_url": "https://api.github.com/users/jaheba/events{/privacy}", "received_events_url": "https://api.github.com/users/jaheba/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/40233/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/40233/timeline", "performed_via_github_app": null, "state_reason": "completed"}