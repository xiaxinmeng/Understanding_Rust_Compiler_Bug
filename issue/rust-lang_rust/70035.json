{"url": "https://api.github.com/repos/rust-lang/rust/issues/70035", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/70035/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/70035/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/70035/events", "html_url": "https://github.com/rust-lang/rust/issues/70035", "id": 581959572, "node_id": "MDU6SXNzdWU1ODE5NTk1NzI=", "number": 70035, "title": "OOM (huge memory usage) during release compilation with include_str of 100MB", "user": {"login": "oberien", "id": 4820508, "node_id": "MDQ6VXNlcjQ4MjA1MDg=", "avatar_url": "https://avatars.githubusercontent.com/u/4820508?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oberien", "html_url": "https://github.com/oberien", "followers_url": "https://api.github.com/users/oberien/followers", "following_url": "https://api.github.com/users/oberien/following{/other_user}", "gists_url": "https://api.github.com/users/oberien/gists{/gist_id}", "starred_url": "https://api.github.com/users/oberien/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oberien/subscriptions", "organizations_url": "https://api.github.com/users/oberien/orgs", "repos_url": "https://api.github.com/users/oberien/repos", "events_url": "https://api.github.com/users/oberien/events{/privacy}", "received_events_url": "https://api.github.com/users/oberien/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 630799571, "node_id": "MDU6TGFiZWw2MzA3OTk1NzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compilemem", "name": "I-compilemem", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to memory usage during compilation."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1791937891, "node_id": "MDU6TGFiZWwxNzkxOTM3ODkx", "url": "https://api.github.com/repos/rust-lang/rust/labels/ICEBreaker-Cleanup-Crew", "name": "ICEBreaker-Cleanup-Crew", "color": "74cc28", "default": false, "description": "Helping to \"clean up\" bugs with minimal examples and bisections"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2020-03-16T02:57:19Z", "updated_at": "2020-03-19T00:07:37Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "When compiling a project of mine, my PC with 32GB of RAM went OOM. I reduced the problem to the following code:\r\n\r\n```rust\r\nuse std::collections::HashMap;\r\n\r\nstatic TESTDATA: &str = include_str!(\"../testdata\");\r\n\r\nfn parse_testdata() -> HashMap<(), ()> {\r\n    let mut map = HashMap::new();\r\n    for line in TESTDATA.lines() {\r\n    }\r\n    map\r\n}\r\n\r\npub fn do_stuff() {\r\n    let (tx, _) = std::sync::mpsc::channel();\r\n    let testdata = parse_testdata();\r\n    tx.send(vec![0]).unwrap();\r\n}\r\n\r\nfn main() {\r\n    do_stuff();\r\n}\r\n\r\n```\r\n\r\nCompiling this code with `/usr/bin/time -v cargo build --release` shows a maximum resident RAM usage of 16GB if testdata is generated with `python -c \"print('foo bar baz qux 1337 42\\n' * 4_500_000)\" > testdata` (103MB). In debug mode, only 1.3GB RAM are used. It doesn't matter if edition is 2018 or not.\r\n\r\nHere are some different testdata sizes with their compilation memory usage:\r\n\r\npython generation | size | RAM | comment\r\n--- | --- | --- | ---\r\n`'foo bar baz qux 1337 42\\n' * 4_500_000` | 103MB | 16GB | file structure similar to my real-world use-case\r\n`'foo bar baz qux 1337 42 ' * 4_500_000` | 103MB | 16GB | newlines don't matter\r\n`'a' * 100*1024*1024` | 100MB | 15.7GB | we can reduce this to simple file size\r\n`'a' * 80*1024*1024` | 80MB | 14GB\r\n`'a' * 50*1024*1024` | 50MB | 8GB\r\n`'a' * 25*1024*1024` | 25MB | 3.9GB\r\n`'a' * 10*1024*1024` | 10MB | 1.9GB\r\n`'a' * 1*1024*1024` | 1MB | 256MB\r\n\r\nIf anything in the code is changed, the problem gets slightly better. Here is the RAM usage after some small changes for 100MB (for comparison, `include_str` just with a hello-world requires 670MB):\r\n* use a `Vec` instead of the `HashMap`: 2.5GB\r\n* create the HashMap at the end of of the `parse_testdata` function: 6GB\r\n* inline the `parse_testdata` function manually: 6GB\r\n* make `parse_testdata` not return anything and remove the HashMap from the function: 2.5GB\r\n* send `()` instead of `vec![0]`: 6GB\r\n* remove the channel creation and sending into it: 4.4GB\r\n* don't call `do_stuff`: 672MB\r\n\r\n### Meta\r\n\r\n`uname -a`: `Linux 5.5.4-arch1-1-vfio #1 SMP PREEMPT Wed, 19 Feb 2020 15:49:02 +0000 x86_64 GNU/Linux` (Archlinux)\r\n\r\nTested on (always testing with 100MB):\r\n* current stable: `rustc 1.42.0 (b8cedc004 2020-03-09)`: 16GB\r\n* current nightly: `rustc 1.43.0-nightly (45ebd5808 2020-03-15)`: 16GB\r\n* `rustc 1.41.1 (f3e1a954d 2020-02-24)`: 16GB\r\n* `rustc 1.41.0 (5e1a79984 2020-01-27)`: 16GB\r\n* `rustc 1.40.0 (73528e339 2019-12-16)`: 2.5GB\r\n* `rustc 1.39.0 (4560ea788 2019-11-04)`: 2.5GB\r\n* `rustc 1.38.0 (625451e37 2019-09-23)`: 6GB\r\n* `rustc 1.35.0 (3c235d560 2019-05-20)`: 6GB\r\n* `rustc 1.34.0 (91856ed52 2019-04-10)`: 6GB\r\n* `rustc 1.32.0 (9fda7c223 2019-01-16)`: 8GB\r\n* `rustc 1.30.0 (da5f414c2 2018-10-24)`: 5GB\r\n", "closed_by": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/70035/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/70035/timeline", "performed_via_github_app": null, "state_reason": null}