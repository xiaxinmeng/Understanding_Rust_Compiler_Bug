{"url": "https://api.github.com/repos/rust-lang/rust/issues/64447", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/64447/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/64447/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/64447/events", "html_url": "https://github.com/rust-lang/rust/issues/64447", "id": 493594910, "node_id": "MDU6SXNzdWU0OTM1OTQ5MTA=", "number": 64447, "title": "`EmitterWriter::get_max_line_num` works incorrectly", "user": {"login": "AnthonyMikh", "id": 19252795, "node_id": "MDQ6VXNlcjE5MjUyNzk1", "avatar_url": "https://avatars.githubusercontent.com/u/19252795?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AnthonyMikh", "html_url": "https://github.com/AnthonyMikh", "followers_url": "https://api.github.com/users/AnthonyMikh/followers", "following_url": "https://api.github.com/users/AnthonyMikh/following{/other_user}", "gists_url": "https://api.github.com/users/AnthonyMikh/gists{/gist_id}", "starred_url": "https://api.github.com/users/AnthonyMikh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AnthonyMikh/subscriptions", "organizations_url": "https://api.github.com/users/AnthonyMikh/orgs", "repos_url": "https://api.github.com/users/AnthonyMikh/repos", "events_url": "https://api.github.com/users/AnthonyMikh/events{/privacy}", "received_events_url": "https://api.github.com/users/AnthonyMikh/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2019-09-14T07:31:50Z", "updated_at": "2019-09-25T18:34:21Z", "closed_at": "2019-09-25T18:34:20Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "**TL;DR:** [`EmitterWriter::get_max_line_num`](https://github.com/rust-lang/rust/blob/master/src/librustc_errors/emitter.rs#L1037) unconditionally returns `self.get_multispan_max_line_num(span)` no matter what is contained in `children`.\r\n\r\nLonger explanation: let's take a look at the code of method (it's rather short):\r\n```rust\r\n    fn get_max_line_num(&mut self, span: &MultiSpan, children: &[SubDiagnostic]) -> usize {\r\n        let mut max = 0;\r\n\r\n        let primary = self.get_multispan_max_line_num(span);\r\n        max = if primary > max { primary } else { max };\r\n\r\n        for sub in children {\r\n            let sub_result = self.get_multispan_max_line_num(&sub.span);\r\n            max = if sub_result > max { primary } else { max };\r\n        }\r\n        max\r\n    }\r\n```\r\nHere `self.get_multispan_max_line_num(span)` returns a plain `usize`. Firstly, since `0` is the smallest possible value of `usize`, the first three lines can be rewritten without changing the meaning as\r\n```rust\r\nlet primary = self.get_multispan_max_line_num(span);\r\nlet mut max = primary;\r\n```\r\nSo after executing these lines `max == primary`. Secondly, in the loop `if` compares `sub_result` with `max` but assigns either `max` or `primary`. If `max == primary` in the beginning of iteration, then this also holds in the end of iteration. Since this preposition holds before executing the loop, it also holds after executing the loop, so the whole method just returns `primary`, QED.\r\n\r\nErroneous code was introduced in 71ec2867e3c4cc448cb64890daffd1d5ffbe353b. \r\n\r\nUnfortunately, I'm not familliar enough with the code to propose the correct fix.", "closed_by": {"login": "AnthonyMikh", "id": 19252795, "node_id": "MDQ6VXNlcjE5MjUyNzk1", "avatar_url": "https://avatars.githubusercontent.com/u/19252795?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AnthonyMikh", "html_url": "https://github.com/AnthonyMikh", "followers_url": "https://api.github.com/users/AnthonyMikh/followers", "following_url": "https://api.github.com/users/AnthonyMikh/following{/other_user}", "gists_url": "https://api.github.com/users/AnthonyMikh/gists{/gist_id}", "starred_url": "https://api.github.com/users/AnthonyMikh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AnthonyMikh/subscriptions", "organizations_url": "https://api.github.com/users/AnthonyMikh/orgs", "repos_url": "https://api.github.com/users/AnthonyMikh/repos", "events_url": "https://api.github.com/users/AnthonyMikh/events{/privacy}", "received_events_url": "https://api.github.com/users/AnthonyMikh/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/64447/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/64447/timeline", "performed_via_github_app": null, "state_reason": "completed"}