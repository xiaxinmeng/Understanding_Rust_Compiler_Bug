{"url": "https://api.github.com/repos/rust-lang/rust/issues/36283", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/36283/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/36283/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/36283/events", "html_url": "https://github.com/rust-lang/rust/issues/36283", "id": 175078481, "node_id": "MDU6SXNzdWUxNzUwNzg0ODE=", "number": 36283, "title": "Performance regression in pattern matching", "user": {"login": "pmarcelll", "id": 1909968, "node_id": "MDQ6VXNlcjE5MDk5Njg=", "avatar_url": "https://avatars.githubusercontent.com/u/1909968?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmarcelll", "html_url": "https://github.com/pmarcelll", "followers_url": "https://api.github.com/users/pmarcelll/followers", "following_url": "https://api.github.com/users/pmarcelll/following{/other_user}", "gists_url": "https://api.github.com/users/pmarcelll/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmarcelll/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmarcelll/subscriptions", "organizations_url": "https://api.github.com/users/pmarcelll/orgs", "repos_url": "https://api.github.com/users/pmarcelll/repos", "events_url": "https://api.github.com/users/pmarcelll/events{/privacy}", "received_events_url": "https://api.github.com/users/pmarcelll/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 32, "created_at": "2016-09-05T14:04:44Z", "updated_at": "2018-12-30T09:58:40Z", "closed_at": "2018-12-29T23:08:10Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I discovered the cause of a fairly big performance regression (from ~22s to ~29s in a specific benchmark) in my small BF interpreter and I succesfully minified the code:\n\n``` rust\n#[derive(Clone, Copy)]\nenum Inner {\n    A,\n    B,\n    C,\n}\n\nenum Outer {\n    X(u32),\n    Y(Inner)\n}\n\n#[inline(never)]\nfn print(x: &Outer) {\n    match *x {\n        Outer::X(num) => println!(\"{:?}\", num),\n        // Replace this...\n        Outer::Y(i) => {\n            match i {\n                Inner::A => println!(\"A\"),\n                Inner::B => println!(\"B\"),\n                Inner::C => println!(\"C\"),\n            }\n        }\n        // ...with this\n        // Outer::Y(ref i) => {\n        //     match *i {\n        //         Inner::A => println!(\"A\"),\n        //         Inner::B => println!(\"B\"),\n        //         Inner::C => println!(\"C\"),\n        //     }\n        // }\n    }\n}\n\nfn main(){\n    let x = Outer::Y(Inner::B);\n\n    print(&x);\n}\n```\n\nOn stable, both version of this code compiles to the exact same binary (and also on 1.9.0 and 1.10.0, both old-trans and MIR on each version respectively). On beta and nightly, the commented out code becomes slower. My understanding is that this should compile to the same binary, so this is incorrect behavior.\n\nThe last correct version is `rustc 1.12.0-nightly (7333c4ac2 2016-07-31)`, right before the update to LLVM 3.9.\n\nEDIT: I noticed that the minified example does compile to the same binary (I somehow got confused) so I added the `#[inline(never)]`.\n", "closed_by": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/36283/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/36283/timeline", "performed_via_github_app": null, "state_reason": "completed"}