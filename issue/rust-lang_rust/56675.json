{"url": "https://api.github.com/repos/rust-lang/rust/issues/56675", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/56675/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/56675/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/56675/events", "html_url": "https://github.com/rust-lang/rust/issues/56675", "id": 389311553, "node_id": "MDU6SXNzdWUzODkzMTE1NTM=", "number": 56675, "title": "Musl pipe2 missing", "user": {"login": "adrian-budau", "id": 1350273, "node_id": "MDQ6VXNlcjEzNTAyNzM=", "avatar_url": "https://avatars.githubusercontent.com/u/1350273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/adrian-budau", "html_url": "https://github.com/adrian-budau", "followers_url": "https://api.github.com/users/adrian-budau/followers", "following_url": "https://api.github.com/users/adrian-budau/following{/other_user}", "gists_url": "https://api.github.com/users/adrian-budau/gists{/gist_id}", "starred_url": "https://api.github.com/users/adrian-budau/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/adrian-budau/subscriptions", "organizations_url": "https://api.github.com/users/adrian-budau/orgs", "repos_url": "https://api.github.com/users/adrian-budau/repos", "events_url": "https://api.github.com/users/adrian-budau/events{/privacy}", "received_events_url": "https://api.github.com/users/adrian-budau/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2018-12-10T13:54:12Z", "updated_at": "2018-12-21T23:01:09Z", "closed_at": "2018-12-21T23:01:09Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Sorry for the cryptic title, didn't knew exactly what to put there. On musl targets (well `x86_64-unknown-linux-musl` and `arm-unknown-linux-musleabi`(hf)) for some reason pipe2 is not used (even on kernels that support it). Pipe2 is important to protect against race condition when multiple threads run external commands.\r\n\r\nThe following is an example that due to this bug will deadlock on the musl targets listed above (and probably all linux musl ones).\r\n\r\nhttps://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=f004af72249cff12f048b4ba16fc4d6e\r\n\r\nRunning with strace proves that pipe2 is not used, and that instead the fallback is:\r\n\r\n```\r\n[pid 11648] pipe( <unfinished ...>                                                                  \r\n[pid 11647] ioctl(9, FIOCLEX <unfinished ...>                                                                                                                                                                     \r\n[pid 11648] <... pipe resumed> [11, 12]) = 0                                                                                                                                                                       \r\n[pid 11647] <... ioctl resumed> )       = 0                                                                            \r\n[pid 11648] ioctl(11, FIOCLEX <unfinished ...>                                                         \r\n[pid 11647] ioctl(10, FIOCLEX <unfinished ...>   \r\n```\r\n\r\nvs the `x86_64-unknown-linux-gnu` target:\r\n\r\n```\r\n[pid  2128] pipe2( <unfinished ...>                                                                                                                                                                               \r\n[pid  2127] pipe2( <unfinished ...>                                                                                                                                                                               \r\n[pid  2128] <... pipe2 resumed> [6, 7], O_CLOEXEC) = 0                                                                                                                                                            \r\n[pid  2127] <... pipe2 resumed> [8, 9], O_CLOEXEC) = 0                \r\n```\r\n\r\nVersions affected:\r\n- 1.30.1\r\n- 1.31.0 - Current stable\r\n- rustc 1.32.0-nightly (4a45578bc 2018-12-07)\r\n\r\nLater Edit:\r\nJust to be clear, if I compile a C file with the same musl toolchain that rust uses pipe2 works, so it's not a bug in Musl (or doesn't look like one to me).", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/56675/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/56675/timeline", "performed_via_github_app": null, "state_reason": "completed"}