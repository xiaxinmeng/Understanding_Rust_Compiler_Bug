{"url": "https://api.github.com/repos/rust-lang/rust/issues/3213", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/3213/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/3213/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/3213/events", "html_url": "https://github.com/rust-lang/rust/issues/3213", "id": 6278877, "node_id": "MDU6SXNzdWU2Mjc4ODc3", "number": 3213, "title": "Investigate avoiding lifecycle_lock traffic in task::unkillable()", "user": {"login": "bblum", "id": 1820515, "node_id": "MDQ6VXNlcjE4MjA1MTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1820515?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bblum", "html_url": "https://github.com/bblum", "followers_url": "https://api.github.com/users/bblum/followers", "following_url": "https://api.github.com/users/bblum/following{/other_user}", "gists_url": "https://api.github.com/users/bblum/gists{/gist_id}", "starred_url": "https://api.github.com/users/bblum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bblum/subscriptions", "organizations_url": "https://api.github.com/users/bblum/orgs", "repos_url": "https://api.github.com/users/bblum/repos", "events_url": "https://api.github.com/users/bblum/events{/privacy}", "received_events_url": "https://api.github.com/users/bblum/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 36953, "node_id": "MDU6TGFiZWwzNjk1Mw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-runtime", "name": "A-runtime", "color": "f7e101", "default": false, "description": "Area: std's runtime and \"pre-main\" init for handling backtraces, unwinds, stack overflows"}, {"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2012-08-17T00:12:12Z", "updated_at": "2014-06-16T21:56:43Z", "closed_at": "2012-08-21T22:03:52Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "`task::unkillable` is used a bunch in task, some in sync, and I suspect it really should be used in other places where we have unsafe code, like pipes.\n\nCurrently it hammers on lifecycle_lock every time:\n\n```\nvoid rust_task::inhibit_kill() {\n    scoped_lock with(lifecycle_lock);\n    disallow_kill++;\n}\nvoid rust_task::allow_kill() {\n    scoped_lock with(lifecycle_lock);\n    disallow_kill--;\n}\n```\n\nThe reason is to protect it from racing a killer (this code is approximate):\n\n```\nvoid rust_task::kill() {\n    scoped_lock with(lifecycle_lock);\n    killed = true;\n    if (blocked && disallow_kill == 0) {\n        // Point A\n        punt_awake();\n    }\n}\n```\n\nIf we just removed the lock in inhibit_kill, the race could be that at point A, the unkillable task increments its flag and promptly goes to sleep, only to get punted awake from what it thought was an unkillable sleep.\n\nIf we removed the lock in allow_kill, the race would be that the killer sees the task is not killable, and at point A it then becomes killable and goes to sleep, but the killer doesn't punt it awake, and it blocks forever.\n\nI believe the following version should be safe (though not helgrind-clean), and reduce traffic on lifecycle_lock:\n\n```\nvoid rust_task::inhibit_kill() {\n    disallow_kill++;\n    if (killed) {\n        scoped_lock with(lifecycle_lock);\n    }\n}\nvoid rust_task::allow_kill() {\n    disallow_kill--;\n    if (killed) {\n        scoped_lock with(lifecycle_lock);\n    }\n}\n```\n\nTry this and see what it does to task and sync performance. This is pretty fragile code (i.e. might start racing if something changes elsewhere), so only actually use it if it's a clear win.\n", "closed_by": {"login": "bblum", "id": 1820515, "node_id": "MDQ6VXNlcjE4MjA1MTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1820515?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bblum", "html_url": "https://github.com/bblum", "followers_url": "https://api.github.com/users/bblum/followers", "following_url": "https://api.github.com/users/bblum/following{/other_user}", "gists_url": "https://api.github.com/users/bblum/gists{/gist_id}", "starred_url": "https://api.github.com/users/bblum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bblum/subscriptions", "organizations_url": "https://api.github.com/users/bblum/orgs", "repos_url": "https://api.github.com/users/bblum/repos", "events_url": "https://api.github.com/users/bblum/events{/privacy}", "received_events_url": "https://api.github.com/users/bblum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/3213/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/3213/timeline", "performed_via_github_app": null, "state_reason": "completed"}