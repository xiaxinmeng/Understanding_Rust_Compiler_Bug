{"url": "https://api.github.com/repos/rust-lang/rust/issues/12802", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/12802/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/12802/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/12802/events", "html_url": "https://github.com/rust-lang/rust/issues/12802", "id": 29073667, "node_id": "MDU6SXNzdWUyOTA3MzY2Nw==", "number": 12802, "title": "Failling assertion in oneshot abort_selection with native threads.", "user": {"login": "ghost", "id": 10137, "node_id": "MDQ6VXNlcjEwMTM3", "avatar_url": "https://avatars.githubusercontent.com/u/10137?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ghost", "html_url": "https://github.com/ghost", "followers_url": "https://api.github.com/users/ghost/followers", "following_url": "https://api.github.com/users/ghost/following{/other_user}", "gists_url": "https://api.github.com/users/ghost/gists{/gist_id}", "starred_url": "https://api.github.com/users/ghost/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ghost/subscriptions", "organizations_url": "https://api.github.com/users/ghost/orgs", "repos_url": "https://api.github.com/users/ghost/repos", "events_url": "https://api.github.com/users/ghost/events{/privacy}", "received_events_url": "https://api.github.com/users/ghost/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2014-03-10T05:34:26Z", "updated_at": "2014-03-12T23:17:10Z", "closed_at": "2014-03-12T23:17:10Z", "author_association": "NONE", "active_lock_reason": null, "body": "The exact assert I am seeing fail is:\n\n```\ntask '<unnamed>' failed at 'assertion failed: self.data.is_none()', /build/buildd/rust-nightly-201403090405~e1681df~precise/src/libstd/comm/oneshot.rs:346\n```\n\nIf a task waits on a select and one of the channels is new (still in OneShot mode), and that channel is sent two messages before the other task is scheduled. This assertion will be triggered.\n\nCode to reproduce:\n\n``` rust\nextern crate native;\n\nuse std::io::timer::Timer;\nuse std::comm::{Chan, Select};\n\n#[start]\nfn start(argc: int, argv: **u8) -> int {\n    native::start(argc, argv, main)\n}\n\nfn select_task(p: &Port<()>)\n{\n    let mut timer = Timer::new().unwrap();\n\n    timer.sleep(25);\n\n    let select = Select::new();\n    let mut handle = select.handle(p);\n    unsafe {handle.add()};\n\n    let _ = select.wait();\n    return;\n}\n\nfn main()\n{\n    let mut timer = Timer::new().unwrap();\n\n    let (p, c) = Chan::new();\n    spawn(proc() {\n        select_task(&p)\n    });\n\n    timer.sleep(50);\n    c.send(());\n    c.send(());\n}\n```\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/12802/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/12802/timeline", "performed_via_github_app": null, "state_reason": "completed"}