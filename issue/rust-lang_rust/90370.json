{"url": "https://api.github.com/repos/rust-lang/rust/issues/90370", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/90370/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/90370/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/90370/events", "html_url": "https://github.com/rust-lang/rust/issues/90370", "id": 1038237442, "node_id": "I_kwDOAAsO6M494j8C", "number": 90370, "title": "Static lifetime deduced for constant, but not for return values of const fn", "user": {"login": "hniksic", "id": 1078190, "node_id": "MDQ6VXNlcjEwNzgxOTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1078190?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hniksic", "html_url": "https://github.com/hniksic", "followers_url": "https://api.github.com/users/hniksic/followers", "following_url": "https://api.github.com/users/hniksic/following{/other_user}", "gists_url": "https://api.github.com/users/hniksic/gists{/gist_id}", "starred_url": "https://api.github.com/users/hniksic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hniksic/subscriptions", "organizations_url": "https://api.github.com/users/hniksic/orgs", "repos_url": "https://api.github.com/users/hniksic/repos", "events_url": "https://api.github.com/users/hniksic/events{/privacy}", "received_events_url": "https://api.github.com/users/hniksic/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2021-10-28T08:30:35Z", "updated_at": "2021-11-03T15:27:41Z", "closed_at": "2021-11-03T15:26:26Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "In rust borrowed constants have static lifetimes, even if the constants are simple literals in the middle of a function. For example, this compiles:\r\n\r\n```rust\r\nfn assert_static(_r: &'static u32) {}\r\nfn main() {\r\n    assert_static(&1); // compiles\r\n}\r\n```\r\n\r\nThis works even in more involved situations, such as when the \"literal\" is a macro-generated array of structs whose fields are literals. (That's my actual use case, but I'll refer to the simple case of just having a `u32` for simplicity.)\r\n\r\nThe problem is that it no longer works if the value is returned by a `const fn`:\r\n\r\n```rust\r\nconst fn inc(n: u32) -> u32 {\r\n    n + 1\r\n}\r\n\r\nfn assert_static(_r: &'static u32) {}\r\n\r\nfn main() {\r\n    assert_static(&1);\r\n    assert_static(&inc(1)) // doesn't compile\r\n}\r\n```\r\n[Playground](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=8c37fab93f623134ef82f97f9dfaeca6)\r\n\r\n```\r\nerror[E0716]: temporary value dropped while borrowed\r\n  --> src/main.rs:9:20\r\n   |\r\n9  |     assert_static(&inc(1)) // doesn't compile\r\n   |     ---------------^^^^^^-\r\n   |     |              |\r\n   |     |              creates a temporary which is freed while still in use\r\n   |     argument requires that borrow lasts for `'static`\r\n10 | }\r\n```\r\n\r\nI would expect (or rather wish) for the latter code to compile since the former did. Note that, since `const` and `static` are `static`, it is possible to work around it by creating an explicit `const` or `static` inbetween. For example, all of these compile:\r\n\r\n```rust\r\nfn main() {\r\n    assert_static(&1);\r\n    {\r\n        const TMP: u32 = inc(1);\r\n        assert_static(&TMP);\r\n    }\r\n    {\r\n        static TMP: u32 = inc(1);\r\n        assert_static(&TMP);\r\n    }\r\n    assert_static({\r\n        const TMP: u32 = inc(1);\r\n        &TMP\r\n    });\r\n    assert_static({\r\n        static TMP: u32 = inc(1);\r\n        &TMP\r\n    });\r\n}\r\n```\r\n[Playground](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=f732893f3304164ab41c8134f8024d15)\r\n\r\nWhile a workaround is available, it is not always obvious. Also it would be much nicer not to have to introduce all the temporary constants/statics, especially in code that calls several different const fns.", "closed_by": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/90370/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 1}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/90370/timeline", "performed_via_github_app": null, "state_reason": "completed"}