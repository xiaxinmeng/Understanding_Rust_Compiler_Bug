{"url": "https://api.github.com/repos/rust-lang/rust/issues/84667", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/84667/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/84667/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/84667/events", "html_url": "https://github.com/rust-lang/rust/issues/84667", "id": 870210322, "node_id": "MDU6SXNzdWU4NzAyMTAzMjI=", "number": 84667, "title": "In latest nightly observing a to-be returned variable changes its value.", "user": {"login": "JAicewizard", "id": 19241481, "node_id": "MDQ6VXNlcjE5MjQxNDgx", "avatar_url": "https://avatars.githubusercontent.com/u/19241481?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JAicewizard", "html_url": "https://github.com/JAicewizard", "followers_url": "https://api.github.com/users/JAicewizard/followers", "following_url": "https://api.github.com/users/JAicewizard/following{/other_user}", "gists_url": "https://api.github.com/users/JAicewizard/gists{/gist_id}", "starred_url": "https://api.github.com/users/JAicewizard/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JAicewizard/subscriptions", "organizations_url": "https://api.github.com/users/JAicewizard/orgs", "repos_url": "https://api.github.com/users/JAicewizard/repos", "events_url": "https://api.github.com/users/JAicewizard/events{/privacy}", "received_events_url": "https://api.github.com/users/JAicewizard/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252628, "node_id": "MDU6TGFiZWwyNjIyNTI2Mjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-beta", "name": "regression-from-stable-to-beta", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to beta."}, {"id": 1359848690, "node_id": "MDU6TGFiZWwxMzU5ODQ4Njkw", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-mcve", "name": "E-needs-mcve", "color": "02e10c", "default": false, "description": "Call for participation: This issue needs a Minimal Complete and Verifiable Example"}], "state": "closed", "locked": false, "assignee": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}], "milestone": {"url": "https://api.github.com/repos/rust-lang/rust/milestones/80", "html_url": "https://github.com/rust-lang/rust/milestone/80", "labels_url": "https://api.github.com/repos/rust-lang/rust/milestones/80/labels", "id": 6400252, "node_id": "MDk6TWlsZXN0b25lNjQwMDI1Mg==", "number": 80, "title": "1.52.0", "description": null, "creator": {"login": "rustbot", "id": 47979223, "node_id": "MDQ6VXNlcjQ3OTc5MjIz", "avatar_url": "https://avatars.githubusercontent.com/u/47979223?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rustbot", "html_url": "https://github.com/rustbot", "followers_url": "https://api.github.com/users/rustbot/followers", "following_url": "https://api.github.com/users/rustbot/following{/other_user}", "gists_url": "https://api.github.com/users/rustbot/gists{/gist_id}", "starred_url": "https://api.github.com/users/rustbot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rustbot/subscriptions", "organizations_url": "https://api.github.com/users/rustbot/orgs", "repos_url": "https://api.github.com/users/rustbot/repos", "events_url": "https://api.github.com/users/rustbot/events{/privacy}", "received_events_url": "https://api.github.com/users/rustbot/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 718, "state": "closed", "created_at": "2021-02-06T10:46:56Z", "updated_at": "2021-08-22T13:10:51Z", "due_on": null, "closed_at": "2021-05-22T17:10:30Z"}, "comments": 15, "created_at": "2021-04-28T18:02:25Z", "updated_at": "2022-09-23T16:44:09Z", "closed_at": "2021-05-04T14:40:41Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a regression report! \ud83d\udc1b A regression is something that changed between versions of Rust but was not supposed to.\r\n\r\nPlease provide a short summary of the regression, along with any information you feel is relevant to replicate it.\r\n-->\r\n\r\n### Code\r\n\r\nI have not been able to reproduce this with pure c code. I found this while working with cgo+rust, and managed to make a small-ish reproducible setup.\r\nI tried this code:\r\n\r\nlib.rs\r\n```rust\r\nuse softposit::{P32, P16};\r\n\r\n#[no_mangle] pub extern \"C\" fn positdiv32(a: u32, b:u32) -> u32{\r\n    let a = P32::from_bits(a);\r\n    let b = P32::from_bits(b);\r\n    let c = a/b;\r\n    let x = c.to_bits();\r\n    // if x >> 31 == 0{\r\n    //     print!(\"hey!\\n\");  \r\n    // }\r\n    // print!(\"{:}\\n\",x);\r\n    x\r\n}\r\n```\r\ntoml file\r\n```toml\r\n[package]\r\nname = \"positrs\"\r\nversion = \"0.1.0\"\r\nauthors = [\"jaap aarts <jaap.aarts1@gmail.com>\"]\r\nedition = \"2018\"\r\n\r\n[lib]\r\ncrate-type = [\"cdylib\"]\r\n\r\n[dependencies]\r\nsoftposit = \"0.3.9\"\r\n```\r\npositrs.h\r\n```c\r\n#include <stdarg.h>\r\n#include <stdbool.h>\r\n#include <stdint.h>\r\n#include <stdlib.h>\r\n\r\nuint32_t positdiv32(uint32_t a, uint32_t b);\r\n```\r\nc file\r\n```c\r\n#include <stdio.h>\r\n#include <stdint.h>\r\n#include \"positrs.h\"\r\n\r\nvoid binprintf(uint32_t v)\r\n{\r\n    unsigned int mask=1<<((sizeof(int)<<3)-1);\r\n    while(mask) {\r\n        printf(\"%d\", (v&mask ? 1 : 0));\r\n        mask >>= 1;\r\n    }\r\n}\r\n\r\nvoid main(){\r\n\tuint32_t a = 0b11000100001110111011110011001000;\r\n\tuint32_t b = 0b01011111011001010011000111110001;\r\n\tuint32_t c = positdiv32(a,b);\r\n\tbinprintf(c);\r\n}\r\n\r\n```\r\nrun \r\n```\r\ncargo build --release\r\ncp target/release/libpositrs.so .\r\ngcc -g main.c -o call_rust -L. -lpositrs\r\nLD_LIBRARY_PATH=. ./call_rust\r\n```\r\nAnd you will see that this prints `00011110000111010100101001000110\u23ce`\r\nThis is (to me) clearly wrong since dividing a negative number with a positive number should be a negative number, and this is a positive number.\r\nSo I tried to print the variable in rust, see where it went wrong...\r\n\r\nUncomment the `printf!(...)` line and run the following commands\r\n```\r\ncargo build --release\r\ncp target/release/libpositrs.so .\r\nLD_LIBRARY_PATH=. ./call_rust\r\n```\r\nand this luckely prints the exact same binary value....\r\n```\r\n3789731258\r\n11100001111000101011010110111010\u23ce\r\n```\r\noh.\r\n\r\nsomehow adding the print statement changes the return value of the function when exported to C.\r\nThe second one is correct, the first is not.\r\n\r\nI also tried just observing x, without actually printing it, using the `if` statement above the `print!` and it had the same result as the `print!`\r\n\r\nI expected to see this happen:\r\n\r\nI expected the value to be the same no-matter what if the value is being observed, and this to be the correct value of `0b11100001111000101011010110111010`\r\n\r\nInstead, this happened: *explanation*\r\n\r\nInstead I got the wrong number after updating to the latest nightly.\r\n\r\n### Version it worked on\r\n\r\nCurrently I know for sure it works on `rustc 1.52.0-beta.6 (f97769a2b 2021-04-27)`\r\nIt also previously worked on nightly, but I dont think I can see the version history.\r\n\r\n### Version with regression\r\n\r\ncurrent broken nightly version: `rustc 1.53.0-nightly (42816d61e 2021-04-24)`\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.52.0-beta.6 (f97769a2b 2021-04-27)\r\nbinary: rustc\r\ncommit-hash: f97769a2b7bc5a6b3d8f7140613cf26352f2b518\r\ncommit-date: 2021-04-27\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.52.0-beta.6\r\nLLVM version: 12.0.0\r\n```\r\n\r\nThe compiler did not crash.", "closed_by": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/84667/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/84667/timeline", "performed_via_github_app": null, "state_reason": "completed"}