{"url": "https://api.github.com/repos/rust-lang/rust/issues/34324", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/34324/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/34324/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/34324/events", "html_url": "https://github.com/rust-lang/rust/issues/34324", "id": 160881250, "node_id": "MDU6SXNzdWUxNjA4ODEyNTA=", "number": 34324, "title": "rustc: Unbounded memory growth when missing `use`", "user": {"login": "Jake-Shadle", "id": 2316028, "node_id": "MDQ6VXNlcjIzMTYwMjg=", "avatar_url": "https://avatars.githubusercontent.com/u/2316028?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jake-Shadle", "html_url": "https://github.com/Jake-Shadle", "followers_url": "https://api.github.com/users/Jake-Shadle/followers", "following_url": "https://api.github.com/users/Jake-Shadle/following{/other_user}", "gists_url": "https://api.github.com/users/Jake-Shadle/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jake-Shadle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jake-Shadle/subscriptions", "organizations_url": "https://api.github.com/users/Jake-Shadle/orgs", "repos_url": "https://api.github.com/users/Jake-Shadle/repos", "events_url": "https://api.github.com/users/Jake-Shadle/events{/privacy}", "received_events_url": "https://api.github.com/users/Jake-Shadle/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": {"login": "jseyfried", "id": 8652869, "node_id": "MDQ6VXNlcjg2NTI4Njk=", "avatar_url": "https://avatars.githubusercontent.com/u/8652869?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jseyfried", "html_url": "https://github.com/jseyfried", "followers_url": "https://api.github.com/users/jseyfried/followers", "following_url": "https://api.github.com/users/jseyfried/following{/other_user}", "gists_url": "https://api.github.com/users/jseyfried/gists{/gist_id}", "starred_url": "https://api.github.com/users/jseyfried/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jseyfried/subscriptions", "organizations_url": "https://api.github.com/users/jseyfried/orgs", "repos_url": "https://api.github.com/users/jseyfried/repos", "events_url": "https://api.github.com/users/jseyfried/events{/privacy}", "received_events_url": "https://api.github.com/users/jseyfried/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "jseyfried", "id": 8652869, "node_id": "MDQ6VXNlcjg2NTI4Njk=", "avatar_url": "https://avatars.githubusercontent.com/u/8652869?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jseyfried", "html_url": "https://github.com/jseyfried", "followers_url": "https://api.github.com/users/jseyfried/followers", "following_url": "https://api.github.com/users/jseyfried/following{/other_user}", "gists_url": "https://api.github.com/users/jseyfried/gists{/gist_id}", "starred_url": "https://api.github.com/users/jseyfried/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jseyfried/subscriptions", "organizations_url": "https://api.github.com/users/jseyfried/orgs", "repos_url": "https://api.github.com/users/jseyfried/repos", "events_url": "https://api.github.com/users/jseyfried/events{/privacy}", "received_events_url": "https://api.github.com/users/jseyfried/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 6, "created_at": "2016-06-17T12:52:01Z", "updated_at": "2016-12-25T21:29:41Z", "closed_at": "2016-12-25T21:29:41Z", "author_association": "NONE", "active_lock_reason": null, "body": "It seems that there is a problem related to missing use statements that occurs once a dependent library becomes large enough, or possibly it has enough transitive dependencies, but this is just conjecture as I was not able to find a repro for this issue on a smaller scale.\n\nI have created a [single repo](https://github.com/Jake-Shadle/rust_repro) that includes all of the code required to repro this issue, but basically the short of the problem is encapsulated in a very small amount of code. \n\n``` rust\nextern crate dbobject;\n\n// Uncommenting this line to import the type will compile successfully as it should\n//use dbobject::types::Sha1;\n\nstruct StructWithTypeInsideDbObject {\n    key: Sha1,\n}\n\nfn main() {\n    println!(\"Hello, world!\");\n}\n```\n\nI expected this to happen:\n\n``` text\nsrc\\main.rs:4:7: 4:11 error: type name `Sha1` is undefined or not in scope [E0412]\nsrc\\main.rs:4   key: Sha1\n                     ^~~~\nsrc\\main.rs:4:7: 4:11 help: run `rustc --explain E0412` to see a detailed explanation\nsrc\\main.rs:4:7: 4:11 help: you can import several candidates into scope (`use ...;`):\nsrc\\main.rs:4:7: 4:11 help:   `dbobject::types::Sha1`\n```\n\nInstead, this happened:\nrustc consumes ever increasing amounts of memory while maxing out a CPU core, until it is eventually killed by the OS.\n\n![image](https://cloud.githubusercontent.com/assets/2316028/16150235/3fa10f8a-3496-11e6-973d-722fd32830f5.png)\n\n![image](https://cloud.githubusercontent.com/assets/2316028/16150273/6dd99b4c-3496-11e6-9312-a7537666f1ae.png)\n## Meta\n\n`rustc --version --verbose`:\n\n``` text\nrustc 1.9.0 (e4e8b6668 2016-05-18)\nbinary: rustc\ncommit-hash: e4e8b666850a763fdf1c3c2c142856ab51e32779\ncommit-date: 2016-05-18\nhost: x86_64-pc-windows-msvc\nrelease: 1.9.0\n```\n\n``` text\nrustc 1.9.0 (e4e8b6668 2016-05-18)\nbinary: rustc\ncommit-hash: e4e8b666850a763fdf1c3c2c142856ab51e32779\ncommit-date: 2016-05-18\nhost: x86_64-unknown-linux-gnu\nrelease: 1.9.0\n```\n\nMore notes:\n- I have tested this on Ubuntu x86_64, Windows x86_64 (gnu and msvc), on 1.8, 1.9, and 1.11 nightly (from a ~week ago)\n- The crate type with the missing `use` can be either `lib` or `bin`\n- One assumption I had was that the problem was due to name resolution looking in transitive dependencies, in this example, there is a `Sha1` type in both `dbobject` as well as `rust-crypto`, but using a type that only exists in `dbobject` such as `Null` still exhibits the same problem.\n\nBacktrace (captured at a random time as the compiler was running):\n\n``` text\n#0  0x00007f7cf98cd1cd in collections::slice::hack::to_vec::h1c0cc52b8aed0cc3\n    ()\n   from /home/jake/.multirust/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_resolve-d16b8f0e.so\n#1  0x00007f7cf98bd768 in rustc_resolve::Resolver::resolve_type::hefe358d1579d4388 ()\n   from /home/jake/.multirust/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_resolve-d16b8f0e.so\n#2  0x00007f7cf98cc905 in rustc::hir::intravisit::walk_item::h4d0fd788646d76e7\n    ()\n   from /home/jake/.multirust/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_resolve-d16b8f0e.so\n#3  0x00007f7cf98b79e7 in _$LT$Resolver$LT$$u27$a$C$$u20$$u27$tcx$GT$$u20$as$u20$rustc..hir..intravisit..Visitor$LT$$u27$v$GT$$GT$::visit_item::h3eb5e028bdb089d8 ()\n   from /home/jake/.multirust/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_resolve-d16b8f0e.so\n#4  0x00007f7cf98e39eb in rustc_resolve::resolve_crate::h8dee150c90a64334 ()\n   from /home/jake/.multirust/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_resolve-d16b8f0e.so\n#5  0x00007f7cfe7b15d3 in rustc_driver::driver::phase_3_run_analysis_passes::h83da042ec4b8ea10 ()\n   from /home/jake/.multirust/toolchains/stable-x86_64-unknown-linux-gnu/lib/lib---Type <return> to continue, or q <return> to quit---\nrustc_driver-d16b8f0e.so\n#6  0x00007f7cfe785fa0 in rustc_driver::driver::compile_input::h6491aaddd9e61258 ()\n   from /home/jake/.multirust/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_driver-d16b8f0e.so\n#7  0x00007f7cfe76c4e5 in rustc_driver::run_compiler::h80b2ba5e4d787c5f ()\n   from /home/jake/.multirust/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_driver-d16b8f0e.so\n#8  0x00007f7cfe769942 in std::sys_common::unwind::try::try_fn::h34e27823ddd1d5e9 ()\n   from /home/jake/.multirust/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_driver-d16b8f0e.so\n#9  0x00007f7cfe264d0c in __rust_try ()\n   from /home/jake/.multirust/toolchains/stable-x86_64-unknown-linux-gnu/lib/libstd-d16b8f0e.so\n#10 0x00007f7cfe264c9e in std::sys_common::unwind::inner_try::h9eebd8dc83f388a6\n    ()\n   from /home/jake/.multirust/toolchains/stable-x86_64-unknown-linux-gnu/lib/libstd-d16b8f0e.so\n#11 0x00007f7cfe76a18b in _$LT$F$u20$as$u20$std..boxed..FnBox$LT$A$GT$$GT$::call_box::h3d5d78986dfac5b2 ()\n   from /home/jake/.multirust/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_driver-d16b8f0e.so\n---Type <return> to continue, or q <return> to quit---\n#12 0x00007f7cfe272e05 in std::sys::thread::Thread::new::thread_start::h471ad90789353b5b ()\n   from /home/jake/.multirust/toolchains/stable-x86_64-unknown-linux-gnu/lib/libstd-d16b8f0e.so\n#13 0x00007f7cf6c316fa in start_thread (arg=0x7f7cf4fff700)\n    at pthread_create.c:333\n#14 0x00007f7cfdec8b5d in clone ()\n    at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109\n```\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/34324/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/34324/timeline", "performed_via_github_app": null, "state_reason": "completed"}