{"url": "https://api.github.com/repos/rust-lang/rust/issues/1910", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/1910/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/1910/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/1910/events", "html_url": "https://github.com/rust-lang/rust/issues/1910", "id": 3431665, "node_id": "MDU6SXNzdWUzNDMxNjY1", "number": 1910, "title": "iface methods with generic ret types that get bound to unit ret to undef memory", "user": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2012-02-29T05:39:55Z", "updated_at": "2014-06-16T21:56:30Z", "closed_at": "2012-03-01T14:01:39Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "In this test case:\n\n```\nenum deser = uint;\n\niface reader {\n    fn read_vec_elt<T:copy>(f: fn() -> T) -> T;\n}\n\nimpl of reader for deser {\n    fn read_vec_elt<T:copy>(f: fn() -> T) -> T {\n        f()\n    }\n}\n\nfn read_to_vec<D:reader, T:copy>(self: D, f: fn() -> T) -> [T] {\n    let v = [];\n    self.read_vec_elt() {|| v += [f()] }\n    v\n}\n\nfn main() {\n    let x = deser(1u);\n    assert [22u] == read_to_vec(x) {|| 22u };\n}\n```\n\nThe call to `self.read_vec_elt()` which occurs in `read_to_vec()` gets compiled down to some LLVM code like:\n\n```\n  invoke void %40([1 x i8*]* %3, i1* undef, { i64, %tydesc*, i8*, i8*, i8 }* %41, %tydesc* @tydesc1, { void (i1*, { i64, %tydesc*, i8*, i8*, i8 }*)*, { i64, %tydesc*, i8*, i8*, i8 }* }* %8)\n          to label %54 unwind label %55\n```\n\nIn particular, the second argument to this call (in this case, that is the destination ptr) is `i1* undef`.  As a result, the return value of `()` gets written into random memory. This leads to crashes on some systems, in particular Ubuntu.  This same bug is causing `block-arg.rs` to fail under testing (though not on the bots nor on macs etc).\n\nThis problem only seems to occur if the call is to an iface method.  If you change the type of `self` to be `deser` or some other concrete type, the problem goes away.  I presume this is some sort of interaction between the typing of iface methods vs those of other callees, because right now the code tries to get smart and avoid allocating space for the return value if the return type is unit... but in this case, that logic is not working.\n", "closed_by": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/1910/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/1910/timeline", "performed_via_github_app": null, "state_reason": "completed"}