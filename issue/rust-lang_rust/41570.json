{"url": "https://api.github.com/repos/rust-lang/rust/issues/41570", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/41570/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/41570/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/41570/events", "html_url": "https://github.com/rust-lang/rust/issues/41570", "id": 224629830, "node_id": "MDU6SXNzdWUyMjQ2Mjk4MzA=", "number": 41570, "title": "No way to refresh DNS information leading to indefinite network failures", "user": {"login": "jonhoo", "id": 176295, "node_id": "MDQ6VXNlcjE3NjI5NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/176295?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonhoo", "html_url": "https://github.com/jonhoo", "followers_url": "https://api.github.com/users/jonhoo/followers", "following_url": "https://api.github.com/users/jonhoo/following{/other_user}", "gists_url": "https://api.github.com/users/jonhoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonhoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonhoo/subscriptions", "organizations_url": "https://api.github.com/users/jonhoo/orgs", "repos_url": "https://api.github.com/users/jonhoo/repos", "events_url": "https://api.github.com/users/jonhoo/events{/privacy}", "received_events_url": "https://api.github.com/users/jonhoo/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 10, "created_at": "2017-04-26T23:41:50Z", "updated_at": "2017-09-04T11:16:36Z", "closed_at": "2017-05-06T01:46:43Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Consider the following simple network client:\r\n\r\n```rust\r\nfn main() {\r\n    use std::thread;\r\n    use std::time::Duration;\r\n    use std::net::TcpStream;\r\n\r\n    loop {\r\n        match TcpStream::connect(\"google.com:80\") {\r\n            Ok(_) => {\r\n                println!(\"connected\");\r\n                break;\r\n            }\r\n            Err(e) => {\r\n                println!(\"failed: {:?}\", e);\r\n            }\r\n        }\r\n        thread::sleep(Duration::from_secs(1));\r\n    }\r\n}\r\n```\r\n\r\nThis works fine if you run it while your internet connection is up and running. However, if you kill your network connection, it (obviously) does not. What is interesting is if you launch the program while your internet is offline (and crucially, while `/etc/resolv.conf` does not contain any nameservers), and then connect to the internet again. I would *expect* the program to eventually say \"connected\", however this is not the case.\r\n\r\nThis had me puzzle for a while, until I stumbled on [this old issue](https://developer.pidgin.im/ticket/2825) on the Pidgin bug tracker. It turns out that the set of nameservers available when the program is *started* is cached, and is never automatically re-read. Instead, [`res_init`](https://linux.die.net/man/3/res_init) must be called manually to refresh the nameserver list. Unfortunately, as far as I can tell, there is no way in Rust to call `res_init`, and thus the above program simply cannot be made to work in the presence of network failures.\r\n\r\nIt's not entirely clear what the \"right\" fix here is: we could simply providing a way to call `res_init`, or we could do something more fancy like a special `connect_uncached` that does it for you. Regardless, this seems like a fairly unfortunate shortcoming..", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/41570/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/41570/timeline", "performed_via_github_app": null, "state_reason": "completed"}