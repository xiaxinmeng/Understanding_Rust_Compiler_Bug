{"url": "https://api.github.com/repos/rust-lang/rust/issues/92782", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/92782/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/92782/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/92782/events", "html_url": "https://github.com/rust-lang/rust/issues/92782", "id": 1099577794, "node_id": "I_kwDOAAsO6M5BijnC", "number": 92782, "title": "ICE while compiling rust-analyzer's ide_assists crate", "user": {"login": "siebenmann", "id": 865382, "node_id": "MDQ6VXNlcjg2NTM4Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/865382?v=4", "gravatar_id": "", "url": "https://api.github.com/users/siebenmann", "html_url": "https://github.com/siebenmann", "followers_url": "https://api.github.com/users/siebenmann/followers", "following_url": "https://api.github.com/users/siebenmann/following{/other_user}", "gists_url": "https://api.github.com/users/siebenmann/gists{/gist_id}", "starred_url": "https://api.github.com/users/siebenmann/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/siebenmann/subscriptions", "organizations_url": "https://api.github.com/users/siebenmann/orgs", "repos_url": "https://api.github.com/users/siebenmann/repos", "events_url": "https://api.github.com/users/siebenmann/events{/privacy}", "received_events_url": "https://api.github.com/users/siebenmann/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2022-01-11T20:14:27Z", "updated_at": "2022-01-11T20:22:07Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "### Code\r\n\r\nI am doing `cargo xtask install --server` on [rust-analyzer](https://github.com/rust-analyzer/rust-analyzer) at the current git tip, which right now `git describe --tags` calls 2022-01-10-16-g54782428a. This ICE also happens at the 2022-01-10 tag. It appears to happen while building ` ide_assists`. I appear to get several ICEs in a row, either from multiple threads or from multiple crates being built at once and all hitting the problem. Since this is easily reproduced, I'm including only the first one.\r\n\r\nThis happens both on Ubuntu 20.04 with an official Rust build obtained through rustup, and on Fedora 34 with Fedora's rust 1.57.0. I have reported the output from Ubuntu with the official Rust/rustup build since I suspect that's more directly useful to you.\r\n\r\n### Meta\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.57.0 (f1edd0429 2021-11-29)\r\nbinary: rustc\r\ncommit-hash: f1edd0429582dd29cccacaf50fd134b05593bd9c\r\ncommit-date: 2021-11-29\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.57.0\r\nLLVM version: 13.0.0\r\n```\r\n\r\n### Error output\r\n\r\n```\r\n   Compiling ide_assists v0.0.0 (/h/281/cks/sys/GIT/rust-analyzer/crates/ide_assists)\r\nthread 'rustc' panicked at 'called `Option::unwrap()` on a `None` value', compiler/rustc_metadata/src/rmeta/def_path_hash_map.rs:18:85\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\r\n\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&template=ice.md\r\n\r\nnote: rustc 1.57.0 (f1edd0429 2021-11-29) running on x86_64-unknown-linux-gnu\r\n\r\nnote: compiler flags: -C opt-level=3 -C embed-bitcode=no -C debuginfo=0 -C incremental --crate-type lib\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n\r\nquery stack during panic:\r\n#0 [analysis] running analysis passes on this crate\r\nend of query stack\r\n\r\n```\r\n\r\n<details><summary><strong>Backtrace</strong></summary>\r\n<p>\r\n\r\n```\r\n   Compiling ide_assists v0.0.0 (/h/281/cks/sys/GIT/rust-analyzer/crates/ide_assists)\r\nthread 'rustc' panicked at 'called `Option::unwrap()` on a `None` value', compiler/rustc_metadata/src/rmeta/def_path_hash_map.rs:18:85\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/f1edd0429582dd29cccacaf50fd134b05593bd9c/library/std/src/panicking.rs:517:5\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/f1edd0429582dd29cccacaf50fd134b05593bd9c/library/core/src/panicking.rs:100:14\r\n   2: core::panicking::panic\r\n             at /rustc/f1edd0429582dd29cccacaf50fd134b05593bd9c/library/core/src/panicking.rs:50:5\r\n   3: rustc_metadata::rmeta::decoder::cstore_impl::<impl rustc_session::cstore::CrateStore for rustc_metadata::creader::CStore>::def_path_hash_to_def_id\r\n   4: <rustc_query_impl::on_disk_cache::OnDiskCache as rustc_middle::ty::context::OnDiskCache>::def_path_hash_to_def_id\r\n   5: rustc_middle::dep_graph::dep_node::<impl rustc_query_system::dep_graph::dep_node::DepNodeParams<rustc_middle::ty::context::TyCtxt> for rustc_span::def_id::DefId>::recover\r\n   6: rustc_query_system::query::plumbing::force_query\r\n   7: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n   8: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n   9: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n  10: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n  11: rustc_query_system::dep_graph::graph::DepGraph<K>::try_mark_previous_green\r\n  12: rustc_query_system::query::plumbing::ensure_must_run\r\n  13: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::mir_borrowck\r\n  14: <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n  15: rustc_data_structures::sync::par_for_each_in\r\n  16: rustc_interface::passes::analysis\r\n  17: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task\r\n  18: rustc_data_structures::stack::ensure_sufficient_stack\r\n  19: rustc_query_system::query::plumbing::try_execute_query\r\n  20: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::analysis\r\n  21: rustc_interface::passes::QueryContext::enter\r\n  22: rustc_interface::queries::<impl rustc_interface::interface::Compiler>::enter\r\n  23: rustc_span::with_source_map\r\n  24: scoped_tls::ScopedKey<T>::set\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&template=ice.md\r\n\r\nnote: rustc 1.57.0 (f1edd0429 2021-11-29) running on x86_64-unknown-linux-gnu\r\n\r\nnote: compiler flags: -C opt-level=3 -C embed-bitcode=no -C debuginfo=0 -C incremental --crate-type lib\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n\r\nquery stack during panic:\r\n#0 [analysis] running analysis passes on this crate\r\nend of query stack\r\n\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/92782/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/92782/timeline", "performed_via_github_app": null, "state_reason": null}