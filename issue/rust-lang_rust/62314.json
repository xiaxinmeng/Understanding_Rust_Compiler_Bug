{"url": "https://api.github.com/repos/rust-lang/rust/issues/62314", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/62314/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/62314/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/62314/events", "html_url": "https://github.com/rust-lang/rust/issues/62314", "id": 463383201, "node_id": "MDU6SXNzdWU0NjMzODMyMDE=", "number": 62314, "title": "stdlib incorrectly handles O_PATH", "user": {"login": "cyphar", "id": 2888411, "node_id": "MDQ6VXNlcjI4ODg0MTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2888411?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cyphar", "html_url": "https://github.com/cyphar", "followers_url": "https://api.github.com/users/cyphar/followers", "following_url": "https://api.github.com/users/cyphar/following{/other_user}", "gists_url": "https://api.github.com/users/cyphar/gists{/gist_id}", "starred_url": "https://api.github.com/users/cyphar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cyphar/subscriptions", "organizations_url": "https://api.github.com/users/cyphar/orgs", "repos_url": "https://api.github.com/users/cyphar/repos", "events_url": "https://api.github.com/users/cyphar/events{/privacy}", "received_events_url": "https://api.github.com/users/cyphar/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2019-07-02T18:51:53Z", "updated_at": "2022-06-09T13:13:47Z", "closed_at": "2019-07-11T08:13:24Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "There are several bugs here, but they all stem from the same problem -- the stdlib doesn't handle `O_PATH` correctly in a few places.\r\n\r\n## `O_PATH` requires you to set an extra (unused) mode. ##\r\n\r\n`O_PATH` causes most other flags to be ignored, so requiring a mode is a little bit weird. Really, `O_PATH` should probably be handled as another `OpenOptions` mode.\r\n\r\n```rust\r\nlet file = OpenOptions::new().custom_flags(libc::O_PATH).open(\".\")?; // gives EINVAL\r\n```\r\n\r\nThis one can be worked around pretty trivially (though it is a bit silly in my view), but unfortunately that's when you hit the next issue:\r\n\r\n## Rust uses `ioctl(FIOCLEX)` to set close-on-exec. ##\r\n\r\nThis doesn't work with `O_PATH` because `O_PATH` file descriptors have `empty_fops` which means that all `ioctl(2)`s on them fail (this is a security feature).\r\n\r\nRust proactively sets close-on-exec in many different places, which means that any method that ends up triggering an `FIOCLEX` gives a spurrious `EBADF`. The most obvious problem is with `File::try_clone()` but I'm sure there are plenty of other examples:\r\n\r\n```rust\r\nlet file = OpenOptions::new().read(true).custom_flags(libc::O_PATH).open(\".\")?;\r\nlet new_file = file.try_clone()?; // gives EBADF\r\n```\r\n\r\nRust really should use `fcntl(F_SETFD)` because `ioctl(2)`s are blocked on all `O_PATH` descriptors (while `fcntl` works without issue).", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/62314/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/62314/timeline", "performed_via_github_app": null, "state_reason": "completed"}