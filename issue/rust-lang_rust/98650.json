{"url": "https://api.github.com/repos/rust-lang/rust/issues/98650", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/98650/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/98650/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/98650/events", "html_url": "https://github.com/rust-lang/rust/issues/98650", "id": 1288030623, "node_id": "I_kwDOAAsO6M5Mxcmf", "number": 98650, "title": "`py ./x.py` no longer works on Windows", "user": {"login": "CAD97", "id": 5992217, "node_id": "MDQ6VXNlcjU5OTIyMTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5992217?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CAD97", "html_url": "https://github.com/CAD97", "followers_url": "https://api.github.com/users/CAD97/followers", "following_url": "https://api.github.com/users/CAD97/following{/other_user}", "gists_url": "https://api.github.com/users/CAD97/gists{/gist_id}", "starred_url": "https://api.github.com/users/CAD97/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CAD97/subscriptions", "organizations_url": "https://api.github.com/users/CAD97/orgs", "repos_url": "https://api.github.com/users/CAD97/repos", "events_url": "https://api.github.com/users/CAD97/events{/privacy}", "received_events_url": "https://api.github.com/users/CAD97/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 147085028, "node_id": "MDU6TGFiZWwxNDcwODUwMjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-nightly", "name": "regression-from-stable-to-nightly", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to nightly."}, {"id": 325438536, "node_id": "MDU6TGFiZWwzMjU0Mzg1MzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-bootstrap", "name": "T-bootstrap", "color": "bfd4f2", "default": false, "description": "Relevant to the bootstrap subteam: Rust's build system (x.py and src/bootstrap)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/rust-lang/rust/milestones/95", "html_url": "https://github.com/rust-lang/rust/milestone/95", "labels_url": "https://api.github.com/repos/rust-lang/rust/milestones/95/labels", "id": 8127235, "node_id": "MI_kwDOAAsO6M4AfAMD", "number": 95, "title": "1.64.0", "description": null, "creator": {"login": "rustbot", "id": 47979223, "node_id": "MDQ6VXNlcjQ3OTc5MjIz", "avatar_url": "https://avatars.githubusercontent.com/u/47979223?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rustbot", "html_url": "https://github.com/rustbot", "followers_url": "https://api.github.com/users/rustbot/followers", "following_url": "https://api.github.com/users/rustbot/following{/other_user}", "gists_url": "https://api.github.com/users/rustbot/gists{/gist_id}", "starred_url": "https://api.github.com/users/rustbot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rustbot/subscriptions", "organizations_url": "https://api.github.com/users/rustbot/orgs", "repos_url": "https://api.github.com/users/rustbot/repos", "events_url": "https://api.github.com/users/rustbot/events{/privacy}", "received_events_url": "https://api.github.com/users/rustbot/received_events", "type": "User", "site_admin": false}, "open_issues": 2, "closed_issues": 857, "state": "closed", "created_at": "2022-06-25T02:07:59Z", "updated_at": "2022-11-09T16:13:06Z", "due_on": null, "closed_at": "2022-10-03T13:56:33Z"}, "comments": 25, "created_at": "2022-06-29T00:18:21Z", "updated_at": "2022-08-13T03:07:44Z", "closed_at": "2022-08-12T00:12:45Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "### Workaround for Windows developers\r\n\r\nPut the following as `py.ini` in `%LOCALAPPDATA%`:\r\n\r\n```ini\r\n[commands]\r\nbash=python\r\n```\r\n\r\nThis will make `py` interpret the `#!/usr/bin/env bash` shebang as running `python`.\r\n\r\nYou can also put `py.ini` alongside `py.exe`. This is likely `C:\\Windows`; you can find it with `where py`<sub>cmd</sub> or `Get-Command py`<sub>pwsh</sub>.\r\n\r\nAlternatively, run `x.py` with `py -3` to explicitly select to use the default Python 3 version rather than looking at the shebang. You should also be able to set `ftype Python.File=\"C:\\Windows\\py.exe\" \"-3\" \"%L\" %*` so `./x.py`  will use `py -3` to run.\r\n\r\nTo debug, set `$env:PYLAUNCH_DEBUG=1`<sub>pwsh</sub>/`set PYLAUNCH_DEBUG=1`<sub>cmd</sub>.\r\n\r\n-----\r\n\r\n### Issue description\r\n\r\n#98474 added a `#!/usr/bin/env bash` shebang line to `x.py` to allow `./x.py` to work on unixy platforms with `python3` but not `python` (the previous shebang line was `#!/usr/bin/env python`).\r\n\r\nThis means that `x.py` no longer works on Windows machines which run python via the `py` Python Launcher for Windows, as `py` tries to interpret the shebang line (in order to use the correct python version) and ends up instead trying to run `/usr/bin/env`, which obviously doesn't exist on a Windows machine. Explicitly asking for a specific version from `py` (e.g. by running `py -3` for the latest 3.x version) will successfully run the script, as then `py` ignores the shebang line.\r\n\r\nIn theory this is [an upstream bug](https://github.com/python/cpython/issues/94399); `py` should not be trying to run something that isn't python. In practice, though, this is how most Windows users will be launching python, as this is the launcher set up to handle `.py` files when installing python from the official installer from the website or [`Python.Python.3`](https://winget.run/pkg/Python/Python.3) in winget. (The msstore python which the default-installed `python` and `python3` shims point to reportedly do not install the `py` launcher.) Additionally, this worked fine previously, and only broke with #98474.\r\n\r\nhttps://github.com/rust-lang/rust/issues/71818#issuecomment-1069175579 reports that `#!/usr/bin/env python` didn't work on Windows; I believe this is due to the order of events used in the described testing. [@Walther](https://github.com/Walther) first installed the msstore python. They then uninstalled the msstore python and installed the official python distribution, with \"add python 3.10 to PATH\" *unchecked*, reporting it to be unchecked by default. However, it was my experience that the official distribution *did* add python to the path by default; I suspect that the reason it didn't work for Walther was because (parts of) the msstore python was still in PATH, and the installer did not want to overwrite an existing installation. With my installation, a `python` and `python3` shebang both work, and a `python2` shebang results in a \"Requested Python version (2) is not installed\".\r\n\r\nChanging the shebang to `python3` has previously been delayed due to concerns about Windows compatibility. The specific situation seems to be this:\r\n\r\n- When python is handled through the `py.exe` launcher (i.e. the shell uses the `ftype` registered handler), all python [virtual commands](https://docs.python.org/3/using/windows.html#shebang-lines) will seamlessly work on Windows.\r\n- However, when using a MSYS-like shell (e.g. Git Bash) which directly interprets shebangs, it will try to run the `python3` program, which most likely does not exist on a Windows machine. (E.g. in my winget install of `Python.Python.3`, I have `python.exe` and `python3.dll` in path, but no `python3.exe`.)", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/98650/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/98650/timeline", "performed_via_github_app": null, "state_reason": "completed"}