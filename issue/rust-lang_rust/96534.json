{"url": "https://api.github.com/repos/rust-lang/rust/issues/96534", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/96534/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/96534/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/96534/events", "html_url": "https://github.com/rust-lang/rust/issues/96534", "id": 1219363716, "node_id": "I_kwDOAAsO6M5IrgOE", "number": 96534, "title": "raw-dylib feature does not support all cases for stdcall functions on i686-pc-windows-*", "user": {"login": "ricobbe", "id": 30275542, "node_id": "MDQ6VXNlcjMwMjc1NTQy", "avatar_url": "https://avatars.githubusercontent.com/u/30275542?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ricobbe", "html_url": "https://github.com/ricobbe", "followers_url": "https://api.github.com/users/ricobbe/followers", "following_url": "https://api.github.com/users/ricobbe/following{/other_user}", "gists_url": "https://api.github.com/users/ricobbe/gists{/gist_id}", "starred_url": "https://api.github.com/users/ricobbe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ricobbe/subscriptions", "organizations_url": "https://api.github.com/users/ricobbe/orgs", "repos_url": "https://api.github.com/users/ricobbe/repos", "events_url": "https://api.github.com/users/ricobbe/events{/privacy}", "received_events_url": "https://api.github.com/users/ricobbe/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1522404967, "node_id": "MDU6TGFiZWwxNTIyNDA0OTY3", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-raw_dylib", "name": "F-raw_dylib", "color": "f9c0cc", "default": false, "description": "`#![feature(raw_dylib)]`"}], "state": "closed", "locked": false, "assignee": {"login": "dpaoliello", "id": 10580822, "node_id": "MDQ6VXNlcjEwNTgwODIy", "avatar_url": "https://avatars.githubusercontent.com/u/10580822?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dpaoliello", "html_url": "https://github.com/dpaoliello", "followers_url": "https://api.github.com/users/dpaoliello/followers", "following_url": "https://api.github.com/users/dpaoliello/following{/other_user}", "gists_url": "https://api.github.com/users/dpaoliello/gists{/gist_id}", "starred_url": "https://api.github.com/users/dpaoliello/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dpaoliello/subscriptions", "organizations_url": "https://api.github.com/users/dpaoliello/orgs", "repos_url": "https://api.github.com/users/dpaoliello/repos", "events_url": "https://api.github.com/users/dpaoliello/events{/privacy}", "received_events_url": "https://api.github.com/users/dpaoliello/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "dpaoliello", "id": 10580822, "node_id": "MDQ6VXNlcjEwNTgwODIy", "avatar_url": "https://avatars.githubusercontent.com/u/10580822?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dpaoliello", "html_url": "https://github.com/dpaoliello", "followers_url": "https://api.github.com/users/dpaoliello/followers", "following_url": "https://api.github.com/users/dpaoliello/following{/other_user}", "gists_url": "https://api.github.com/users/dpaoliello/gists{/gist_id}", "starred_url": "https://api.github.com/users/dpaoliello/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dpaoliello/subscriptions", "organizations_url": "https://api.github.com/users/dpaoliello/orgs", "repos_url": "https://api.github.com/users/dpaoliello/repos", "events_url": "https://api.github.com/users/dpaoliello/events{/privacy}", "received_events_url": "https://api.github.com/users/dpaoliello/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2022-04-28T22:10:29Z", "updated_at": "2022-08-27T06:12:25Z", "closed_at": "2022-08-27T06:12:25Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Contrary to our original expectations, when an i686 DLL exports a stdcall function, the function's name can appear in the library's export table in one of several different ways.  I don't know if this list is exhaustive, but I've seen the following variations:\n* `_exported_function@8` (i.e., with leading underscore and trailing argument-list size)\n* `exported_function@8` (trailing size only)\n* `exported_function` (exactly as it appears in the defining source file)\nWhich form the symbols take appears to depend on how the DLL is linked.  This is another facet of the problem that I don't fully understand, but one variable appears to be whether the function is defined with `__declspec(dllexport)` or the function is marked for export in a .DEF file provided to the linker invocation that creates the .DLL file.\n\nTo successfully link against such a DLL, the import library has to match not only the name of the symbol as it appears in the exporting DLL, but also the reference to the name (usually of the form `__imp_exported_function@8`, at least with rustc/LLVM) by which the importing library/image refers to it.\n\nIn an earlier attempt to solve this problem, we did notice that the three variants of the symbol name in the list above correspond to 3 of the 4 possible values of the IMPORT_NAME_TYPE enum defined in the [PE-COFF spec](https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#import-name-type), and I created an [earlier proposal](https://github.com/rust-lang/compiler-team/issues/495) for adding a new attribute to specify the IMPORT_NAME_TYPE, but this turns out not to work.  In particular, an earlier attempt on my part to have rustc supply the function names to LLVM with the decoration specified by the user doesn't work: specifying `NAME_TYPE_UNDECORATE` (intended to be the 3rd case above) resulted in an error when attempting to link the .rlib: the symbol `__imp__exported_function@8` was not found.  To reproduce, run src/test/run-make/raw-dylib-import-name type from the [import-name-time branch](https://github.com/ricobbe/rust/tree/import-library-test) of my fork of rustc.\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"dpaoliello\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/96534/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/96534/timeline", "performed_via_github_app": null, "state_reason": "completed"}