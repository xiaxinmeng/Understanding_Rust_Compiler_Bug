{"url": "https://api.github.com/repos/rust-lang/rust/issues/87630", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/87630/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/87630/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/87630/events", "html_url": "https://github.com/rust-lang/rust/issues/87630", "id": 956860357, "node_id": "MDU6SXNzdWU5NTY4NjAzNTc=", "number": 87630, "title": "Renaming of feature can cause unexpected behavior", "user": {"login": "ralpha", "id": 2608639, "node_id": "MDQ6VXNlcjI2MDg2Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/2608639?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ralpha", "html_url": "https://github.com/ralpha", "followers_url": "https://api.github.com/users/ralpha/followers", "following_url": "https://api.github.com/users/ralpha/following{/other_user}", "gists_url": "https://api.github.com/users/ralpha/gists{/gist_id}", "starred_url": "https://api.github.com/users/ralpha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ralpha/subscriptions", "organizations_url": "https://api.github.com/users/ralpha/orgs", "repos_url": "https://api.github.com/users/ralpha/repos", "events_url": "https://api.github.com/users/ralpha/events{/privacy}", "received_events_url": "https://api.github.com/users/ralpha/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2021-07-30T15:41:51Z", "updated_at": "2021-07-30T16:00:06Z", "closed_at": "2021-07-30T15:43:37Z", "author_association": "NONE", "active_lock_reason": null, "body": "Renaming of a feature can cause behavior changes if name is also used for an optional dependency.\r\nThis will not trigger any warnings or errors from the compiler.\r\n\r\nI'll set up 2 parts here, before crate change and after crate change.\r\n\r\n## Before create change\r\nCode example:\r\nMy crate `my_crate/Cargo.toml` file has this section:\r\n```toml\r\n[dependencies]\r\nsome_crate = { version = \"0.1.0\", features = [\"old_feature_name\"] }\r\n```\r\n\r\nThe other crate `some_crate/Cargo.toml`:\r\n```toml\r\n[features]\r\nold_feature_name = [\"old_feature_name\"]\r\n\r\n[dependencies]\r\nold_feature_name = { version = \"0.2.0\", optional = true }\r\n```\r\nAnd `some_crate/src/lib.rs`:\r\n```rust\r\nfn enable_important_feature() {\r\n    println!(\"Important feature is enabled\");\r\n}\r\n\r\nfn main() {\r\n    #[cfg(feature = \"old_feature_name\")]\r\n    enable_important_feature();\r\n}\r\n```\r\nThis will print `Important feature is enabled` as expected, no problems yet.\r\n\r\n## After create change\r\nNow the feature is renamed from `old_feature_name` to `new_feature_name`.\r\n\r\nI did not know about the feature change so my file did not change:\r\n(Note: I might had to check this, but lets say this change was not documented and/or was not manually checked when updating versions. I don't think this is an unreasonable assumption.)\r\n`my_crate/Cargo.toml`:\r\n```toml\r\n[dependencies]\r\nsome_crate = { version = \"0.2.0\", features = [\"old_feature_name\"] }\r\n```\r\n\r\n`some_crate/Cargo.toml`:\r\n```toml\r\n[features]\r\nnew_feature_name = [\"old_feature_name\"]\r\n\r\n[dependencies]\r\nold_feature_name = { version = \"0.2.0\", optional = true }\r\n```\r\n`some_crate/src/lib.rs`:\r\n```rust\r\nfn enable_important_feature() {\r\n    println!(\"Important feature is enabled\");\r\n}\r\n\r\nfn main() {\r\n    #[cfg(feature = \"new_feature_name\")]\r\n    enable_important_feature();\r\n}\r\n```\r\n\r\nThis will not trigger any compiler warnings/errors because although feature does not exists, an optional create with that name does exists.\r\nThis, as you might expect, will not print anything. (As this is currently intended this way by the compiler)\r\n\r\n## Solution\r\nThis is currently the only \"reasonable\" solution I can think of. Because other changes might have much bigger complications.\r\n\r\nChange the crate to also redirect the old feature to the new feature:\r\n`some_crate/Cargo.toml`:\r\n```toml\r\n[features]\r\nnew_feature_name = [\"old_feature_name\"]\r\n# Make change backwards compatible with old feature\r\n# The optional dependency also needs to be enabled\r\n# This depends on: https://github.com/rust-lang/rfcs/pull/3143 (should be merged soon in stable)\r\n# For old rust version see: https://blog.turbo.fish/cargo-features/\r\nold_feature_name = [\"new_feature_name\", \"dep:old_feature_name\"]\r\n\r\n[dependencies]\r\nold_feature_name = { version = \"0.2.0\", optional = true }\r\n```\r\n\r\nI don't think there are changes in the compiler itself that can reasonably fix this, but this at least record the problem and a way to solve it.\r\n\r\nI'll close this issue so it can be used to track future people that have this problem.", "closed_by": {"login": "ralpha", "id": 2608639, "node_id": "MDQ6VXNlcjI2MDg2Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/2608639?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ralpha", "html_url": "https://github.com/ralpha", "followers_url": "https://api.github.com/users/ralpha/followers", "following_url": "https://api.github.com/users/ralpha/following{/other_user}", "gists_url": "https://api.github.com/users/ralpha/gists{/gist_id}", "starred_url": "https://api.github.com/users/ralpha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ralpha/subscriptions", "organizations_url": "https://api.github.com/users/ralpha/orgs", "repos_url": "https://api.github.com/users/ralpha/repos", "events_url": "https://api.github.com/users/ralpha/events{/privacy}", "received_events_url": "https://api.github.com/users/ralpha/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/87630/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/87630/timeline", "performed_via_github_app": null, "state_reason": "completed"}