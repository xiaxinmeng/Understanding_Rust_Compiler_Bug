{"url": "https://api.github.com/repos/rust-lang/rust/issues/49853", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/49853/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/49853/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/49853/events", "html_url": "https://github.com/rust-lang/rust/issues/49853", "id": 313085474, "node_id": "MDU6SXNzdWUzMTMwODU0NzQ=", "number": 49853, "title": "rustc 1.25.0 panics with \"Cannot allocate memory\" while building Firefox 59 for Manjaro Linux i686 within Docker build container", "user": {"login": "jonathonf", "id": 559369, "node_id": "MDQ6VXNlcjU1OTM2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/559369?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonathonf", "html_url": "https://github.com/jonathonf", "followers_url": "https://api.github.com/users/jonathonf/followers", "following_url": "https://api.github.com/users/jonathonf/following{/other_user}", "gists_url": "https://api.github.com/users/jonathonf/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonathonf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonathonf/subscriptions", "organizations_url": "https://api.github.com/users/jonathonf/orgs", "repos_url": "https://api.github.com/users/jonathonf/repos", "events_url": "https://api.github.com/users/jonathonf/events{/privacy}", "received_events_url": "https://api.github.com/users/jonathonf/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 630799571, "node_id": "MDU6TGFiZWw2MzA3OTk1NzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compilemem", "name": "I-compilemem", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to memory usage during compilation."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2018-04-10T20:54:32Z", "updated_at": "2019-11-21T00:27:20Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "## Summary\r\n\r\nWhile trying to build Firefox 59.0.2 for i686 under a Manjaro Linux (Arch-like) Docker-based build container, `rustc` panics with \"Cannot allocate memory\" while compiling the `gkrust` crate.\r\n\r\nI'm reporting because the backtrace asked me to. :)\r\n\r\n## Details\r\n\r\nOn first look this would appear to be `rustc` trying to allocate more than ~3GB RAM during the LTO step as seen https://bugzilla.mozilla.org/show_bug.cgi?id=1417268#c13, and a similar thing last occurred with rustc 1.22 (https://bbs.archlinux32.org/viewtopic.php?id=643). \r\n\r\nMonitoring RAM usage during the failing compilation step appears to show it remaining fairly constant at ~1.3GB RES for a \"long\" period (~50% time before failure), jumping to ~1.5GB RES, then jumping again to 1.7GB and 2.0GB (~80% TBF), before finally (~95% TBF) rapidly increasing in ~100MB steps and panicking somewhere around ~3GB RES.\r\n\r\nI am able to successfully build 64-bit Firefox 59.0.2, as well as both 32- and 64-bit Firefox ESR 52.7.3 with the same build container setup, so it looks to be something specific between i686 `rustc` and FF 59's use of the `gkrust` crate.\r\n\r\nI have not set any resource limits for Docker.\r\n\r\n## Steps which might reproduce\r\n\r\n```\r\ngit clone https://github.com/jonathonf/manjaro-32-build.git\r\nmkdir firefox && cd $_\r\ncurl -L -f \"https://git.archlinux.org/svntogit/packages.git/snapshot/packages/firefox.tar.gz\" -o - | bsdtar --strip-components 3 --include=\"*/firefox/trunk/\" -xvf -\r\n../manjaro-32-build/run.sh\r\n```\r\n\r\n## Failing command with flags\r\n\r\n/usr/bin/rustc --crate-name gkrust lib.rs --color always --crate-type staticlib --emit=dep-info,link -C opt-level=2 -C panic=abort -C lto --cfg feature=\"bindgen\" --cfg feature=\"cubeb-remoting\" --cfg feature=\"cubeb_pulse_rust\" --cfg feature=\"gkrust-shared\" --cfg feature=\"no-static-ideograph-encoder-tables\" --cfg feature=\"servo\" --cfg feature=\"simd-accel\" -C metadata=651646389c08113e -C extra-filename=-651646389c08113e --out-dir /build/src/mozilla-unified/obj-i686-pc-linux-gnu/toolkit/library/i686-unknown-linux-gnu/release/deps --target i686-unknown-linux-gnu -C linker=/build/src/mozilla-unified/build/cargo-linker -L dependency=/build/src/mozilla-unified/obj-i686-pc-linux-gnu/toolkit/library/i686-unknown-linux-gnu/release/deps -L dependency=/build/src/mozilla-unified/obj-i686-pc-linux-gnu/toolkit/library/release/deps --extern gkrust_shared=/build/src/mozilla-unified/obj-i686-pc-linux-gnu/toolkit/library/i686-unknown-linux-gnu/release/deps/libgkrust_shared-f2bb0c738944c0f6.rlib -C opt-level=2 -C debuginfo=2\r\n\r\n\r\n## Backtrace\r\n\r\n```\r\n 8:40.67    Compiling gkrust v0.1.0 (file:///build/src/mozilla-unified/toolkit/library/rust)\r\n35:17.52 thread 'rustc' panicked at 'called `Result::unwrap()` on an `Err` value: Custom { kind: Other, error: StringError(\"Cannot allocate memory\") }', libcore/result.rs:945:5\r\n35:17.53 stack backtrace:\r\n35:17.71    0: 0xf747766a - rust_metadata_std_ae049937c58eac2695c432bfa6d5d39f\r\n35:17.71    1: 0xf746f0fb - rust_metadata_std_ae049937c58eac2695c432bfa6d5d39f\r\n35:17.71    2: 0xf7474224 - rust_metadata_std_ae049937c58eac2695c432bfa6d5d39f\r\n35:17.71    3: 0xf7473f4f - rust_metadata_std_ae049937c58eac2695c432bfa6d5d39f\r\n35:17.71    4: 0xf74746a1 - std::panicking::rust_panic_with_hook::hb8beb8efb6b91903\r\n35:17.71    5: 0xf7474515 - rust_metadata_std_ae049937c58eac2695c432bfa6d5d39f\r\n35:17.71    6: 0xf7474496 - std::panicking::begin_panic_fmt::he4dfe7a67e7c0076\r\n35:17.71    7: 0xf74743fb - rust_begin_unwind\r\n35:17.71    8: 0xf74e226e - core::panicking::panic_fmt::he2c3b98e9730a002\r\n35:17.71    9: 0xf04c7497 - <unknown>\r\n35:17.71   10: 0xf04f5667 - <unknown>\r\n35:17.71   11: 0xf04f4320 - <unknown>\r\n35:17.71   12: 0xf0593809 - <unknown>\r\n35:17.71   13: 0xf05912b1 - <rustc_trans::LlvmTransCrate as rustc_trans_utils::trans_crate::TransCrate>::join_trans_and_link::hd108c8a9e5d89c4d\r\n35:17.71   14: 0xf762d843 - rustc_driver::driver::compile_input::hd9c20dd67b35c276\r\n35:17.71   15: 0xf764a9b5 - rustc_driver::run_compiler::h2b965134b6c46ea8\r\n35:17.71   16: 0xf756d933 - rust_metadata_rustc_driver_9af17ad1a24b9c2356fb6a6c6e5db9d5\r\n35:17.71   17: 0xf748bdd2 - __rust_maybe_catch_panic\r\n35:17.71   18: 0xf75a7b93 - <unknown>\r\n35:17.71   19: 0xf7482bfa - rust_metadata_std_ae049937c58eac2695c432bfa6d5d39f\r\n35:17.71   20: 0xf5854e55 - start_thread\r\n35:17.71   21: 0xf73366b5 - __GI___clone\r\n35:17.71   22:        0x0 - <unknown>\r\n35:17.75 \r\n35:17.75 error: internal compiler error: unexpected panic\r\n35:17.75 \r\n35:17.75 note: the compiler unexpectedly panicked. this is a bug.\r\n35:17.75 \r\n35:17.75 note: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n35:17.75 \r\n35:17.75 note: rustc 1.25.0 running on i686-unknown-linux-gnu\r\n35:17.75 \r\n35:17.94 error: Could not compile `gkrust`.\r\n35:17.94 \r\n35:17.94 To learn more, run the command again with --verbose.\r\n35:17.94 make[4]: *** [/build/src/mozilla-unified/config/rules.mk:972: force-cargo-library-build] Error 101\r\n35:17.94 make[3]: *** [/build/src/mozilla-unified/config/recurse.mk:73: toolkit/library/rust/target] Error 2\r\n35:17.94 make[2]: *** [/build/src/mozilla-unified/config/recurse.mk:33: compile] Error 2\r\n35:17.94 make[1]: *** [/build/src/mozilla-unified/config/rules.mk:434: default] Error 2\r\n35:17.94 make: *** [client.mk:168: build] Error 2\r\n35:17.97 0 compiler warnings present.\r\n35:18.04 Failed to parse ccache stats output: stats zero time                     Thu Apr  5 15:52:33 2018\r\n35:18.04 Notification center failed: Install notify-send (usually part of the libnotify package) to get a notification when the build finishes.\r\n```\r\n\r\n## `rustc --version --verbose`\r\n\r\n```\r\nrustc 1.25.0\r\nbinary: rustc\r\ncommit-hash: unknown\r\ncommit-date: unknown\r\nhost: i686-unknown-linux-gnu\r\nrelease: 1.25.0\r\nLLVM version: 6.0\r\n```\r\n\r\n## Packaging files\r\nrustc: https://www.archlinux.org/packages/community/x86_64/rust/\r\nfirefox: https://www.archlinux.org/packages/extra/x86_64/firefox/", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/49853/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/49853/timeline", "performed_via_github_app": null, "state_reason": null}