{"url": "https://api.github.com/repos/rust-lang/rust/issues/45038", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/45038/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/45038/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/45038/events", "html_url": "https://github.com/rust-lang/rust/issues/45038", "id": 262981571, "node_id": "MDU6SXNzdWUyNjI5ODE1NzE=", "number": 45038, "title": "rustdoc hangs on FreeBSD during trivial doctest", "user": {"login": "asomers", "id": 129721, "node_id": "MDQ6VXNlcjEyOTcyMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/129721?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asomers", "html_url": "https://github.com/asomers", "followers_url": "https://api.github.com/users/asomers/followers", "following_url": "https://api.github.com/users/asomers/following{/other_user}", "gists_url": "https://api.github.com/users/asomers/gists{/gist_id}", "starred_url": "https://api.github.com/users/asomers/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asomers/subscriptions", "organizations_url": "https://api.github.com/users/asomers/orgs", "repos_url": "https://api.github.com/users/asomers/repos", "events_url": "https://api.github.com/users/asomers/events{/privacy}", "received_events_url": "https://api.github.com/users/asomers/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 203738, "node_id": "MDU6TGFiZWwyMDM3Mzg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-rustdoc", "name": "T-rustdoc", "color": "bfd4f2", "default": false, "description": "Relevant to the rustdoc team, which will review and decide on the PR/issue."}, {"id": 311417404, "node_id": "MDU6TGFiZWwzMTE0MTc0MDQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-freebsd", "name": "O-freebsd", "color": "6e6ec0", "default": false, "description": "Operating system: FreeBSD"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-10-05T01:46:15Z", "updated_at": "2018-03-28T22:44:36Z", "closed_at": "2018-03-28T22:44:36Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Doc tests frequently hang on FreeBSD.  I've seen it happen on multiple crates, and I can easily reproduce it with a trivial crate that contains only one function that does nothing at all.  I've seen the hang in multiple versions of rustc, and on FreeBSD 11.0 and 12.0.  In my experience, it reproduces most readily with rustc 1.20.0 in a FreeBSD 11.0 jail on a 12.0 host.\r\n\r\nHere is the command that hangs:\r\n/home/somers/.rustup/toolchains/stable-x86_64-unknown-freebsd/bin/rustdoc --test /usr/home/somers/src/rust/empty/src/lib.rs --crate-name empty -L dependency=/usr/home/somers/src/rust/empty/target/debug/deps --extern empty=/usr/home/somers/src/rust/empty/target/debug/deps/libempty-4345db73e18fa324.rlib\r\n\r\nThat command has 8 threads, and most are blocking in `umtx_op_wait`, which indicates some kind of pthread call.  Here are the full kernel stack traces:\r\n> procstat -kk 20619\r\n  PID    TID COMM                TDNAME              KSTACK                       \r\n20619 101660 rustdoc             -                   mi_switch+0xf4 sleepq_catch_signals+0x462 sleepq_timedwait_sig+0x14 _sleep+0x205 umtxq_sleep+0x145 do_wait+0x444 __umtx_op_wait_uint_private+0x53 amd64_syscall+0xa59 Xfast_syscall+0xfb \r\n20619 101661 rustdoc             src/lib.rs - foo (l mi_switch+0xf4 sleepq_catch_signals+0x462 sleepq_wait_sig+0xf _sleep+0x22a umtxq_sleep+0x145 do_wait+0x444 __umtx_op_wait+0x4d amd64_syscall+0xa59 Xfast_syscall+0xfb \r\n20619 101662 rustdoc             rustc               mi_switch+0xf4 sleepq_catch_signals+0x462 sleepq_wait_sig+0xf _sleep+0x22a umtxq_sleep+0x145 do_wait+0x444 __umtx_op_wait_uint_private+0x53 amd64_syscall+0xa59 Xfast_syscall+0xfb \r\n20619 101663 rustdoc             -                   mi_switch+0xf4 sleepq_catch_signals+0x462 sleepq_wait_sig+0xf _sleep+0x22a umtxq_sleep+0x145 do_wait+0x444 __umtx_op_wait_uint_private+0x53 amd64_syscall+0xa59 Xfast_syscall+0xfb \r\n20619 101664 rustdoc             -                   mi_switch+0xf4 sleepq_catch_signals+0x462 sleepq_wait_sig+0xf _sleep+0x22a umtxq_sleep+0x145 do_wait+0x444 __umtx_op_wait_uint_private+0x53 amd64_syscall+0xa59 Xfast_syscall+0xfb \r\n20619 101665 rustdoc             -                   mi_switch+0xf4 sleepq_catch_signals+0x462 sleepq_wait_sig+0xf _sleep+0x22a umtxq_sleep+0x145 do_lock_umutex+0x757 __umtx_op_wait_umutex+0x48 amd64_syscall+0xa59 Xfast_syscall+0xfb \r\n20619 102121 rustdoc             -                   mi_switch+0xf4 sleepq_catch_signals+0x462 sleepq_wait_sig+0xf _sleep+0x22a umtxq_sleep+0x145 do_wait+0x444 __umtx_op_wait+0x4d amd64_syscall+0xa59 Xfast_syscall+0xfb \r\nsomers@threonine ~> 20619 101660 rustdoc             -                   mi_switch+0xf4 sleepq_catch_signals+0x462 sleepq_timedwait_sig+0x14 _sleep+0x205 umtxq_sleep+0x145 do_wait+0x444 __umtx_op_wait_uint_private+0x53 amd64_syscall+0xa59 Xfast_syscall+0xfb\r\n\r\nI've seen a similar bug that was caused by a unit tests which forked, then exited through the standard test harness in the child process.  Such a thing is unsafe in threaded code.  I suspect that rustdoc may be doing the same thing, because ktrace shows 7 `fork`s but only 1 `execve`.\r\n[empty_crate.tar.gz](https://github.com/rust-lang/rust/files/1357824/empty_crate.tar.gz)\r\n", "closed_by": {"login": "asomers", "id": 129721, "node_id": "MDQ6VXNlcjEyOTcyMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/129721?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asomers", "html_url": "https://github.com/asomers", "followers_url": "https://api.github.com/users/asomers/followers", "following_url": "https://api.github.com/users/asomers/following{/other_user}", "gists_url": "https://api.github.com/users/asomers/gists{/gist_id}", "starred_url": "https://api.github.com/users/asomers/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asomers/subscriptions", "organizations_url": "https://api.github.com/users/asomers/orgs", "repos_url": "https://api.github.com/users/asomers/repos", "events_url": "https://api.github.com/users/asomers/events{/privacy}", "received_events_url": "https://api.github.com/users/asomers/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/45038/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/45038/timeline", "performed_via_github_app": null, "state_reason": "completed"}