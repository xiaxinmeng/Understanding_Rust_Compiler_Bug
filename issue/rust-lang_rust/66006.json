{"url": "https://api.github.com/repos/rust-lang/rust/issues/66006", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/66006/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/66006/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/66006/events", "html_url": "https://github.com/rust-lang/rust/issues/66006", "id": 515675895, "node_id": "MDU6SXNzdWU1MTU2NzU4OTU=", "number": 66006, "title": "depfile generated by rustc includes contains the depfile itself", "user": {"login": "petrhosek", "id": 283696, "node_id": "MDQ6VXNlcjI4MzY5Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/283696?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrhosek", "html_url": "https://github.com/petrhosek", "followers_url": "https://api.github.com/users/petrhosek/followers", "following_url": "https://api.github.com/users/petrhosek/following{/other_user}", "gists_url": "https://api.github.com/users/petrhosek/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrhosek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrhosek/subscriptions", "organizations_url": "https://api.github.com/users/petrhosek/orgs", "repos_url": "https://api.github.com/users/petrhosek/repos", "events_url": "https://api.github.com/users/petrhosek/events{/privacy}", "received_events_url": "https://api.github.com/users/petrhosek/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2019-10-31T19:09:16Z", "updated_at": "2019-12-06T19:04:41Z", "closed_at": "2019-12-06T19:04:41Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "`rustc` generates depfiles that have the following shape:\r\n```\r\nhost_x64/exe.unstripped/cmc: ../../src/sys/cmc/src/main.rs ../../src/sys/cmc/src/cml.rs ../../src/sys/cmc/src/compile.rs ../../src/sys/cmc/src/format.rs ../../src/sys/cmc/src/merge.rs ../../src/sys/cmc/src/opts.rs ../../src/sys/cmc/src/validate.rs\r\n\r\nhost_x64/exe.unstripped/cmc.d: ../../src/sys/cmc/src/main.rs ../../src/sys/cmc/src/cml.rs ../../src/sys/cmc/src/compile.rs ../../src/sys/cmc/src/format.rs ../../src/sys/cmc/src/merge.rs ../../src/sys/cmc/src/opts.rs ../../src/sys/cmc/src/validate.rs\r\n\r\n../../src/sys/cmc/src/main.rs:\r\n../../src/sys/cmc/src/cml.rs:\r\n../../src/sys/cmc/src/compile.rs:\r\n../../src/sys/cmc/src/format.rs:\r\n../../src/sys/cmc/src/merge.rs:\r\n../../src/sys/cmc/src/opts.rs:\r\n../../src/sys/cmc/src/validate.rs:\r\n```\r\n\r\nWhen invoking `rustc` from Ninja, it causes Ninja to rebuild the target on every invocation: Ninja consumes and deletes the `cmc.d` depfile (unless `-d keepdepfile` is specified) and process its content, recording `cmc.d` as an additional output of the rule that produced it. On the next invocation, Ninja notices that the `cmc.d` file is missing forcing a rebuild of that rule. `rustc` generates a new depfile, Ninja consumes and deletes it and so on which means that this process never converges.\r\n\r\nI don't think `rustc` should be including the depfile itself in the generated depfile. I'm not aware of any other tool that would do that, and tools that consume depfiles such as Ninja cannot handle this.", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/66006/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/66006/timeline", "performed_via_github_app": null, "state_reason": "completed"}