{"url": "https://api.github.com/repos/rust-lang/rust/issues/76597", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/76597/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/76597/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/76597/events", "html_url": "https://github.com/rust-lang/rust/issues/76597", "id": 699073093, "node_id": "MDU6SXNzdWU2OTkwNzMwOTM=", "number": 76597, "title": "Rustc memory exhaustion when formatting short code suggestion", "user": {"login": "ad-anssi", "id": 45487748, "node_id": "MDQ6VXNlcjQ1NDg3NzQ4", "avatar_url": "https://avatars.githubusercontent.com/u/45487748?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ad-anssi", "html_url": "https://github.com/ad-anssi", "followers_url": "https://api.github.com/users/ad-anssi/followers", "following_url": "https://api.github.com/users/ad-anssi/following{/other_user}", "gists_url": "https://api.github.com/users/ad-anssi/gists{/gist_id}", "starred_url": "https://api.github.com/users/ad-anssi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ad-anssi/subscriptions", "organizations_url": "https://api.github.com/users/ad-anssi/orgs", "repos_url": "https://api.github.com/users/ad-anssi/repos", "events_url": "https://api.github.com/users/ad-anssi/events{/privacy}", "received_events_url": "https://api.github.com/users/ad-anssi/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 630799571, "node_id": "MDU6TGFiZWw2MzA3OTk1NzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compilemem", "name": "I-compilemem", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to memory usage during compilation."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1168029555, "node_id": "MDU6TGFiZWwxMTY4MDI5NTU1", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-hang", "name": "I-hang", "color": "e10c02", "default": false, "description": "Issue: The compiler never terminates, due to infinite loops, deadlock, livelock, etc."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 12, "created_at": "2020-09-11T09:19:21Z", "updated_at": "2020-09-14T20:56:52Z", "closed_at": "2020-09-14T20:41:40Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "### Code\r\n\r\n```Rust\r\nfn f(\r\n                                     x: u8\r\n                                     y: u8,\r\n) {}\r\n\r\nfn main() {}\r\n```\r\n\r\n\r\n### Meta\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.48.0-dev\r\nbinary: rustc\r\ncommit-hash: 94b4de0e0793c8921d30e0fb886be712d17db6e5\r\ncommit-date: Fri Sep 11 02:35:01 2020 +0000\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.48.0-dev\r\nLLVM version: 11.0\r\n```\r\n\r\nStable channel seems to be also affected from version 1.46.\r\nThe bug is reproducible in [rust playground](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&code=fn%20f(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3A%20u8%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3A%20u8%2C%0A)%20%7B%7D%0A%0Afn%20main()%20%7B%7D).\r\n\r\n### Error output\r\n\r\nWhen trying to compile this code with `rustc`, nothing is displayed, and memory exhaustion happens, leading to either SIGABRT if user virtual memory is (u)limited, or memory swapping and eventually freezing the machine.\r\nOne would have expected syntax error as follows:\r\n\r\n```\r\nerror: expected one of `!`, `(`, `)`, `+`, `,`, `::`, or `<`, found `y`\r\n --> ../bug.rs:3:38\r\n  |\r\n2 |   ...                   x: u8\r\n  |                              - expected one of 7 possible tokens\r\n  |  ____________________________|\r\n  | |\r\n3 | | ...                   y: u8,\r\n| | |                       ^ unexpected token\r\n| | |_\r\n  |   help: missing `,`\r\n\r\nerror: aborting due to previous error\r\n```\r\n\r\n### Analysis\r\n\r\n<details><summary><strong>Backtrace</strong></summary>\r\n<p>\r\nHere is a gdb backtrace after SIGABRT:\r\n\r\n```#0  __GI_raise (sig=sig@entry=0x6) at ../sysdeps/unix/sysv/linux/raise.c:50\r\n#1  0x00007fffefd52535 in __GI_abort () at abort.c:79\r\n#2  0x00007fffeff8ad47 in std::sys::unix::abort_internal ()\r\n#3  0x00007fffeffac946 in std::process::abort ()\r\n#4  0x00007fffeffb16ce in rust_oom ()\r\n#5  0x00007ffff0018f27 in alloc::alloc::handle_alloc_error ()\r\n#6  0x00007ffff57cde5b in alloc::raw_vec::RawVec<T,A>::reserve ()\r\n#7  0x00007ffff579fdf3 in rustc_errors::styled_buffer::StyledBuffer::putc ()\r\n#8  0x00007ffff57af21b in rustc_errors::emitter::EmitterWriter::emit_message_default ()\r\n#9  0x00007ffff57aa3ac in <rustc_errors::emitter::EmitterWriter as rustc_errors::emitter::Emitter>::emit_diagnostic ()\r\n#10 0x00007ffff57a698b in rustc_errors::HandlerInner::emit_diagnostic ()\r\n#11 0x00007ffff57a658b in rustc_errors::Handler::emit_diagnostic ()\r\n#12 0x00007ffff57b69e4 in rustc_errors::diagnostic_builder::DiagnosticBuilder::emit ()\r\n#13 0x00007ffff4bbb03c in rustc_parse::parser::Parser::parse_paren_comma_seq ()\r\n#14 0x00007ffff4c0ed9e in rustc_parse::parser::item::<impl rustc_parse::parser::Parser>::parse_fn_decl ()\r\n#15 0x00007ffff4c032b5 in rustc_parse::parser::item::<impl rustc_parse::parser::Parser>::parse_item_kind ()\r\n#16 0x00007ffff4c0253d in rustc_parse::parser::item::<impl rustc_parse::parser::Parser>::parse_item_common_ ()\r\n#17 0x00007ffff4c02035 in rustc_parse::parser::item::<impl rustc_parse::parser::Parser>::parse_item_common ()\r\n#18 0x00007ffff4c01def in rustc_parse::parser::item::<impl rustc_parse::parser::Parser>::parse_item ()\r\n#19 0x00007ffff4c0183a in rustc_parse::parser::item::<impl rustc_parse::parser::Parser>::parse_mod ()\r\n#20 0x00007ffff4c015e5 in rustc_parse::parser::item::<impl rustc_parse::parser::Parser>::parse_crate_mod ()\r\n#21 0x00007ffff4baa8cd in rustc_parse::parse_crate_from_file ()\r\n#22 0x00007ffff0bb717d in rustc_session::utils::<impl rustc_session::session::Session>::time ()\r\n#23 0x00007ffff0adad51 in rustc_interface::passes::parse ()\r\n#24 0x00007ffff0b94e0a in rustc_interface::queries::Query<T>::compute ()\r\n#25 0x00007ffff0ae4544 in rustc_interface::queries::Queries::parse ()\r\n#26 0x00007ffff09e2ef8 in rustc_interface::queries::<impl rustc_interface::interface::Compiler>::enter ()\r\n#27 0x00007ffff09b4530 in rustc_span::with_source_map ()\r\n#28 0x00007ffff09e3c95 in rustc_interface::interface::create_compiler_and_run ()\r\n#29 0x00007ffff09d51e1 in scoped_tls::ScopedKey<T>::set ()\r\n#30 0x00007ffff09b4c37 in rustc_span::with_session_globals ()\r\n#31 0x00007ffff09b2aa1 in std::sys_common::backtrace::__rust_begin_short_backtrace ()\r\n#32 0x00007ffff09a9476 in std::panicking::try ()\r\n#33 0x00007ffff096a4fe in core::ops::function::FnOnce::call_once{{vtable-shim}} ()\r\n#34 0x00007fffeff92788 in <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once ()\r\n#35 0x00007fffeff86b4a in std::sys::unix::thread::Thread::new::thread_start ()\r\n#36 0x00007fffefce5fb7 in start_thread (arg=<optimized out>) at pthread_create.c:486\r\n#37 0x00007fffefe271af in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n<details><summary><strong>Finding regression</strong></summary>\r\n<p>\r\n\r\nAfter `ulimit -v 8000000`, we used `cargo-bisect-rustc` with the following script:\r\n\r\n```sh\r\n#!/bin/sh\r\n\r\n! cargo build 2>&1 | grep \"SIGABRT\"\r\n```\r\n\r\nHere is the execution result:\r\n\r\n```\r\n[...]\r\ninstalling nightly-2020-07-07\r\nstd for x86_64-unknown-linux-gnu: 16.03 MB / 16.03 MB [==========================================] 100.00 % 14.01 MB/s testing...\r\nRESULT: nightly-2020-07-07, ===> No\r\nuninstalling nightly-2020-07-07\r\n\r\ninstalling nightly-2020-07-08\r\nstd for x86_64-unknown-linux-gnu: 16.02 MB / 16.02 MB [==========================================] 100.00 % 13.87 MB/s testing...\r\nRESULT: nightly-2020-07-08, ===> Yes\r\nuninstalling nightly-2020-07-08\r\n\r\nsearched toolchains nightly-2020-01-02 through nightly-2020-09-10\r\n\r\n\r\n********************************************************************************\r\nRegression in nightly-2020-07-08\r\n********************************************************************************\r\n\r\nfetching https://static.rust-lang.org/dist/2020-07-07/channel-rust-nightly-git-commit-hash.txt\r\nnightly manifest 2020-07-07: 40 B / 40 B [======================================================] 100.00 % 521.03 KB/s converted 2020-07-07 to 0c03aee8b81185d65b5821518661c30ecdb42de5\r\nfetching https://static.rust-lang.org/dist/2020-07-08/channel-rust-nightly-git-commit-hash.txt\r\nnightly manifest 2020-07-08: 40 B / 40 B [======================================================] 100.00 % 585.71 KB/s converted 2020-07-08 to 8ac1525e091d3db28e67adcbbd6db1e1deaa37fb\r\nlooking for regression commit between 2020-07-07 and 2020-07-08\r\nopening existing repository at \"rust.git\"\r\nrefreshing repository\r\nfetching (via local git) commits from 0c03aee8b81185d65b5821518661c30ecdb42de5 to 8ac1525e091d3db28e67adcbbd6db1e1deaa37fb\r\nopening existing repository at \"rust.git\"\r\nrefreshing repository\r\nlooking up first commit\r\nlooking up second commit\r\nchecking that commits are by bors and thus have ci artifacts...\r\nfinding bors merge commits\r\nfound 6 bors merge commits in the specified range\r\n  commit[0] 2020-07-05UTC: Auto merge of #74073 - Manishearth:rollup-faqo9lx, r=Manishearth\r\n  commit[1] 2020-07-06UTC: Auto merge of #73978 - Mark-Simulacrum:shrink-paramenv, r=nnethercote\r\n  commit[2] 2020-07-07UTC: Auto merge of #74117 - Manishearth:rollup-ds7z0kx, r=Manishearth\r\n  commit[3] 2020-07-07UTC: Auto merge of #73562 - poliorcetics:e0432-to-edition2018, r=GuillaumeGomez\r\n  commit[4] 2020-07-07UTC: Auto merge of #74059 - RalfJung:miri-uninit-validation, r=oli-obk\r\n  commit[5] 2020-07-07UTC: Auto merge of #74006 - euclio:sys-unix-static-mut, r=oli-obk\r\nvalidated commits found, specifying toolchains\r\n\r\ninstalling 0c03aee8b81185d65b5821518661c30ecdb42de5\r\nstd for x86_64-unknown-linux-gnu: 16.03 MB / 16.03 MB [===========================================] 100.00 % 5.26 MB/s testing...\r\nRESULT: 0c03aee8b81185d65b5821518661c30ecdb42de5, ===> No\r\nuninstalling 0c03aee8b81185d65b5821518661c30ecdb42de5\r\n\r\ninstalling 8ac1525e091d3db28e67adcbbd6db1e1deaa37fb\r\nstd for x86_64-unknown-linux-gnu: 16.02 MB / 16.02 MB [===========================================] 100.00 % 4.22 MB/s testing...\r\nRESULT: 8ac1525e091d3db28e67adcbbd6db1e1deaa37fb, ===> Yes\r\nuninstalling 8ac1525e091d3db28e67adcbbd6db1e1deaa37fb\r\n\r\ninstalling 70f9d23b916f2db7da711aa4a0317a218997ba42\r\nstd for x86_64-unknown-linux-gnu: 16.01 MB / 16.01 MB [===========================================] 100.00 % 5.46 MB/s testing...\r\nRESULT: 70f9d23b916f2db7da711aa4a0317a218997ba42, ===> Yes\r\nuninstalling 70f9d23b916f2db7da711aa4a0317a218997ba42\r\n\r\ninstalling 8981dbbc36f1575b0a417b6849767bde29e7c6b4\r\nstd for x86_64-unknown-linux-gnu: 16.02 MB / 16.02 MB [===================================================================================================================================================================] 100.00 % 5.25 MB/s testing...\r\nRESULT: 8981dbbc36f1575b0a417b6849767bde29e7c6b4, ===> No\r\nuninstalling 8981dbbc36f1575b0a417b6849767bde29e7c6b4\r\n\r\nsearched toolchains 0c03aee8b81185d65b5821518661c30ecdb42de5 through 8ac1525e091d3db28e67adcbbd6db1e1deaa37fb\r\n\r\n\r\n********************************************************************************\r\nRegression in 70f9d23b916f2db7da711aa4a0317a218997ba42\r\n********************************************************************************\r\n\r\n==================================================================================\r\n= Please file this regression report on the rust-lang/rust GitHub repository     =\r\n=        New issue: https://github.com/rust-lang/rust/issues/new                 =\r\n=     Known issues: https://github.com/rust-lang/rust/issues                     =\r\n= Copy and paste the text below into the issue report thread.  Thanks!           =\r\n==================================================================================\r\n\r\nsearched nightlies: from nightly-2020-01-02 to nightly-2020-09-10\r\nregressed nightly: nightly-2020-07-08\r\nsearched commits: from https://github.com/rust-lang/rust/commit/0c03aee8b81185d65b5821518661c30ecdb42de5 to https://github.com/rust-lang/rust/commit/8ac1525e091d3db28e67adcbbd6db1e1deaa37fb\r\nregressed commit: https://github.com/rust-lang/rust/commit/70f9d23b916f2db7da711aa4a0317a218997ba42\r\n\r\nbisected with <a href='https://github.com/rust-lang/cargo-bisect-rustc'>cargo-bisect-rustc</a> v0.5.2\r\n\r\nHost triple: x86_64-unknown-linux-gnu\r\nReproduce with:\r\n\r\ncargo bisect-rustc --start=2020-01-02 --script=./script.sh \r\n\r\n```\r\n\r\n</details>\r\n\r\nThe bug was introduced when auditting hidden/short code suggestions #73953 with the change of the span used when reporting a `missing ','` suggestion (https://github.com/rust-lang/rust/pull/73953/files#diff-da8eccd50b4abe306482925ebf6e6a90R702).\r\n\r\nAfter further investigation, we found that the problem resides in the construction of the error message, in the module `rustc_errors`. When applying left margin shift in the function `FileWithAnnotatedLines::render_source_line`, the column number can wrap over usize ([emitter.rs#962](https://github.com/rust-lang/rust/blob/master/compiler/rustc_errors/src/emitter.rs#L962)), thus the function [draw_range](https://github.com/rust-lang/rust/blob/master/compiler/rustc_errors/src/emitter.rs#L1943) tries to `putc` way too many '_' chars into the `StyledBuffer`.\r\n\r\nA fix would be to `saturating_sub` when computing column number (in emitter.rs, at line 962, and also at lines 969 and 970), in the same way it is already done at different points of the same function.\r\nFor completion, further inspection of the multispan data would be required to check whether they are correct.\r\n\r\n\r\n_Aur\u00e9lien Deharbe_ and _Vincent Dagonneau_", "closed_by": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/76597/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/76597/timeline", "performed_via_github_app": null, "state_reason": "completed"}