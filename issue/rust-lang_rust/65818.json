{"url": "https://api.github.com/repos/rust-lang/rust/issues/65818", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/65818/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/65818/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/65818/events", "html_url": "https://github.com/rust-lang/rust/issues/65818", "id": 512587860, "node_id": "MDU6SXNzdWU1MTI1ODc4NjA=", "number": 65818, "title": "Using `include_bytes!` on large binary blobs compiles more slowly than expected", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 64037154, "node_id": "MDU6TGFiZWw2NDAzNzE1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compiletime", "name": "I-compiletime", "color": "e11d21", "default": false, "description": "Problems and improvements with respect to compile times."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 10, "created_at": "2019-10-25T15:44:03Z", "updated_at": "2023-01-07T14:27:54Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "I've been playing around recently with compiling a crate that simply contains:\r\n\r\n```rust\r\npub const BYTES: &[u8] = include_bytes!(\"large-binary-blob\");\r\n```\r\n\r\nand I've been surprised that the compile time of this crate is pretty nontrivial!\r\n\r\nFor example this crate:\r\n\r\n```rust\r\npub const BYTES: &[u8] = &[];\r\n```\r\n\r\ntakes 0.060 seconds to compile on nightly for me. If a multi-megabyte binary (such as `cargo` itself) is included:\r\n\r\n```rust\r\npub const BYTES: &[u8] = include_bytes!(\"/path/to/.cargo/bin/cargo\");\r\n```\r\n\r\nthis crate takes 0.729 seconds to compile!\r\n\r\nThere appear to be at least two major sources of slowdown:\r\n\r\n1. In the [expansion of `include_bytes!`](https://github.com/rust-lang/rust/blob/770b9e3012bd58bdf6046d328dabfd57df163eb6/src/libsyntax_ext/source_util.rs#L171) the [`expr_lit` function](https://github.com/rust-lang/rust/blob/770b9e3012bd58bdf6046d328dabfd57df163eb6/src/libsyntax_expand/build.rs#L322-L325) calls [`from_lit_kind`](https://github.com/rust-lang/rust/blob/770b9e3012bd58bdf6046d328dabfd57df163eb6/src/libsyntax/parse/literal.rs#L215-L217) which calls [`to_lit_token`](https://github.com/rust-lang/rust/blob/770b9e3012bd58bdf6046d328dabfd57df163eb6/src/libsyntax/parse/literal.rs#L145-L149) that runs an operation per-byte, which is pretty expensive for multi-megabyte files.\r\n2. Later in compilation while emitting metadata when we're [processing constants](https://github.com/rust-lang/rust/blob/770b9e3012bd58bdf6046d328dabfd57df163eb6/src/librustc_metadata/encoder.rs#L1074-L1077) we'll end up [pretty printing them](https://github.com/rust-lang/rust/blob/770b9e3012bd58bdf6046d328dabfd57df163eb6/src/librustc_metadata/encoder.rs#L1059) and pretty printing the byte string literal for a multi-megabyte file takes quite some time!\r\n\r\nThere may be a few other sources of slowdown, but ideally usage of `include_bytes!` and large byte blobs in general should never iterate over the bytes and perform expensive operations, but rather the bytes should just be transferred as a whole in various contexts if absolutely necessary.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/65818/reactions", "total_count": 15, "+1": 15, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/65818/timeline", "performed_via_github_app": null, "state_reason": null}