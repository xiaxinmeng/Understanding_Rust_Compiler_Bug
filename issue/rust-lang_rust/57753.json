{"url": "https://api.github.com/repos/rust-lang/rust/issues/57753", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/57753/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/57753/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/57753/events", "html_url": "https://github.com/rust-lang/rust/issues/57753", "id": 400982223, "node_id": "MDU6SXNzdWU0MDA5ODIyMjM=", "number": 57753, "title": "Impl Drop for a global_allocator silently fails", "user": {"login": "sheredom", "id": 611171, "node_id": "MDQ6VXNlcjYxMTE3MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/611171?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sheredom", "html_url": "https://github.com/sheredom", "followers_url": "https://api.github.com/users/sheredom/followers", "following_url": "https://api.github.com/users/sheredom/following{/other_user}", "gists_url": "https://api.github.com/users/sheredom/gists{/gist_id}", "starred_url": "https://api.github.com/users/sheredom/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sheredom/subscriptions", "organizations_url": "https://api.github.com/users/sheredom/orgs", "repos_url": "https://api.github.com/users/sheredom/repos", "events_url": "https://api.github.com/users/sheredom/events{/privacy}", "received_events_url": "https://api.github.com/users/sheredom/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2019-01-19T10:19:40Z", "updated_at": "2019-01-19T20:02:07Z", "closed_at": "2019-01-19T20:02:07Z", "author_association": "NONE", "active_lock_reason": null, "body": "I've been experimenting with the GlobalAlloc API and came across a perhaps interesting failure:\r\n\r\n```\r\nextern crate libc;\r\n\r\nuse std::alloc::{GlobalAlloc, Layout};\r\n\r\npub struct TestAllocator;\r\n\r\nunsafe impl Sync for TestAllocator {}\r\n\r\nimpl Drop for TestAllocator {\r\n    fn drop(&mut self) {\r\n        panic!(\"Never hit!\"); // No compile time warning, no runtime panic!\r\n    }\r\n}\r\n\r\nunsafe impl GlobalAlloc for TestAllocator {\r\n    unsafe fn alloc(&self, layout: Layout) -> *mut u8 { libc::memalign(layout.align(), layout.size()) as *mut u8 }\r\n    unsafe fn dealloc(&self, ptr: *mut u8, _layout: Layout) { libc::free(ptr as *mut libc::c_void); }\r\n}\r\n\r\n#[global_allocator]\r\nstatic A: TestAllocator = TestAllocator;\r\n```\r\n\r\nI am new enough to rust that I thought I could add a drop method to a static - which I think is not expected to be supported. But the compiler didn't error to tell me that implementing Drop wasn't supported, and I spent quite a bit of time trying to work out why lldb wasn't hitting the breakpoint in my drop method!\r\n\r\nWould it be possible to make the compiler error here? Or at least warn the user that the drop method will never be called?\r\n\r\nLink to the playground https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=2b5b2fc9ea97526cb0c14d5341e9a78d", "closed_by": {"login": "sfackler", "id": 1455697, "node_id": "MDQ6VXNlcjE0NTU2OTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1455697?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sfackler", "html_url": "https://github.com/sfackler", "followers_url": "https://api.github.com/users/sfackler/followers", "following_url": "https://api.github.com/users/sfackler/following{/other_user}", "gists_url": "https://api.github.com/users/sfackler/gists{/gist_id}", "starred_url": "https://api.github.com/users/sfackler/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sfackler/subscriptions", "organizations_url": "https://api.github.com/users/sfackler/orgs", "repos_url": "https://api.github.com/users/sfackler/repos", "events_url": "https://api.github.com/users/sfackler/events{/privacy}", "received_events_url": "https://api.github.com/users/sfackler/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/57753/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/57753/timeline", "performed_via_github_app": null, "state_reason": "completed"}