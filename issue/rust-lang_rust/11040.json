{"url": "https://api.github.com/repos/rust-lang/rust/issues/11040", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/11040/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/11040/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/11040/events", "html_url": "https://github.com/rust-lang/rust/issues/11040", "id": 24467578, "node_id": "MDU6SXNzdWUyNDQ2NzU3OA==", "number": 11040, "title": "C func returning `Option<extern fn>` is not immediate on 32-bit linux", "user": {"login": "lilyball", "id": 714, "node_id": "MDQ6VXNlcjcxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lilyball", "html_url": "https://github.com/lilyball", "followers_url": "https://api.github.com/users/lilyball/followers", "following_url": "https://api.github.com/users/lilyball/following{/other_user}", "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}", "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions", "organizations_url": "https://api.github.com/users/lilyball/orgs", "repos_url": "https://api.github.com/users/lilyball/repos", "events_url": "https://api.github.com/users/lilyball/events{/privacy}", "received_events_url": "https://api.github.com/users/lilyball/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2013-12-18T03:31:13Z", "updated_at": "2014-05-19T18:50:31Z", "closed_at": "2014-05-18T09:46:32Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Calls to a C function declared as returning `Option<extern fn>` are correctly immediate on 64-bit darwin, but are not immediate on 32-bit linux. I'm assuming the bit width is the issue here, not the platform.\n\nGiven that functions are non-nullable, and the only way to declare a nullable function is with `Option<extern fn>`, this seems like a rather serious problem. The only way to declare a C function returning a nullable function in the presence of this bug is to declare it as returning an arbitrary raw pointer and wrap it in another function that casts it.\n\nIncidentally, this is not an issue with the null-pointer optimization. `size_of()` reports that both `extern fn` and `Option<extern fn>` are `4` on 32-bit linux, as expected.\n## Example\n### Source\n\nfoo_c.c:\n\n```\n#include <stdio.h>\n\ntypedef void (*voidfunc)(void);\n\nvoidfunc foo(int x) {\n    printf(\"foo: x=%d\\n\", x);\n    return NULL;\n}\n```\n\nfoo_rust.rs:\n\n```\nuse std::libc;\n\nextern {\n    pub fn foo(x: libc::c_int) -> Option<extern \"C\" fn()>;\n}\n\nfn main() {\n    unsafe { println!(\"{:?}\", foo(3)); }\n}\n```\n\nMakefile:\n\n```\nfoo: foo_c.o foo_rust.rs\n    rustc -o foo --link-args foo_c.o foo_rust.rs\n```\n### Results\n\n64-bit Darwin:\n\n```\n> ./foo\nfoo: x=3\nNone\n```\n\n32-bit Linux:\n\n```\n> ./foo\nfoo: x=-1220505408\nNone\nSegmentation fault (core dumped)\n```\n\n---\n\nFWIW, the version of rustc on both platforms is slightly different. The 32-bit Linux platform is using Hans J\u00f8rgen Hoel's [rust-nightly](https://launchpad.net/~hansjorg/+archive/rust) package, which is almost a day old at 000cda6. 64-bit Darwin is using a newer version of master, at bf30a213. However, I don't see any changes in the newer version that look obviously related.\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/11040/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/11040/timeline", "performed_via_github_app": null, "state_reason": "completed"}