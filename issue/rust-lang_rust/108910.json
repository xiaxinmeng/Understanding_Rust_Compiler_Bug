{"url": "https://api.github.com/repos/rust-lang/rust/issues/108910", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/108910/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/108910/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/108910/events", "html_url": "https://github.com/rust-lang/rust/issues/108910", "id": 1615543718, "node_id": "I_kwDOAAsO6M5gSz2m", "number": 108910, "title": "Linker invocation for wasm32-unknown-unknown incompatibly changed between 1.66.1 and 1.67.1", "user": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 474645165, "node_id": "MDU6TGFiZWw0NzQ2NDUxNjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-wasm", "name": "O-wasm", "color": "6e6ec0", "default": false, "description": "Target: WASM (WebAssembly), http://webassembly.org/"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2023-03-08T16:16:42Z", "updated_at": "2023-03-09T16:24:09Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "I ran this sequence of commands via `rustup` to install 1.66.1 and 1.67.1, as well as the target support for wasm32-unknown-unknown for each, and then tried to compile a `cdylib` for wasm32-unknown-unknown while *also overriding the linker*.\r\n\r\n```\r\n% rustup update 1.66.1\r\n[...]\r\n% rustup update 1.67.1\r\n[...]\r\n% rustup target add --toolchain 1.66.1 wasm32-unknown-unknown\r\n[...]\r\n% rustup target add --toolchain 1.67.1 wasm32-unknown-unknown\r\n[...]\r\n% echo > /tmp/hello.rs\r\n% rustc +1.66.1 /tmp/hello.rs --crate-type cdylib --target wasm32-unknown-unknown -C linker=clang && echo success\r\nsuccess\r\n% rustc +1.67.1 /tmp/hello.rs --crate-type cdylib --target wasm32-unknown-unknown -C linker=clang\r\nerror: linking with `clang` failed: exit status: 1\r\n  |\r\n  = note: \"clang\" \"-Wl,-z\" \"-Wl,stack-size=1048576\" \"-Wl,--stack-first\" \"-Wl,--allow-undefined\" \"-Wl,--fatal-warnings\" \"-Wl,--no-demangle\" \"--target=wasm32-unknown-unknown\" \"-Wl,--no-entry\" \"hello.hello.4592d75c-cgu.0.rcgu.o\" \"hello.395fat3noigyayzs.rcgu.o\" \"-L\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/libstd-4cc67ecdd38ec816.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/libpanic_abort-d7aed05895fd3acd.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/libdlmalloc-d614b689e44911c3.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/librustc_demangle-b67bdb405beac3e8.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/libstd_detect-d35bb83dee339ae2.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/libhashbrown-a91c75972ec9987b.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/libminiz_oxide-cebf340576826f4d.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/libadler-1dfefb8109e16570.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/librustc_std_workspace_alloc-fb56ca5e4fa7e885.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/libunwind-7758a353f6e6c303.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/libcfg_if-9fa968ba9e6d4f22.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/liblibc-6769bef7a67a1976.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/liballoc-5ef00dd564498f26.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/librustc_std_workspace_core-a025c7699298bef7.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/libcore-028eb657858f49ce.rlib\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/libcompiler_builtins-f9be42f11058bb31.rlib\" \"-L\" \"/home/pnkfelix/.rustup/toolchains/1.67.1-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib\" \"-o\" \"hello.wasm\" \"-Wl,--gc-sections\" \"-shared\" \"-nodefaultlibs\"\r\n  = note: clang: warning: argument unused during compilation: '-shared' [-Wunused-command-line-argument]\r\n          wasm-ld-14: error: cannot open crt1.o: No such file or directory\r\n          clang: error: linker command failed with exit code 1 (use -v to see invocation)\r\n\r\n```\r\n\r\nI expected to see this happen: a command sequence that worked under 1.66.1 to continue working under 1.67.1\r\n\r\nInstead, this happened: A linker failure that is somewhat inscrutable to a layperson.\r\n\r\n----\r\n\r\nNote: There *is* a relatively easy workaround available. Under 1.66.1  when passing `-C linker=clang`, the linker invocation also included the argument `-nostartfiles`. For some reason, that argument has gone away under 1.67.1 with this invocation sequence, but one can re-add it manually by passing `-C link-arg=-nostartfiles` into `rustc`.\r\n\r\nThe questions I have are:\r\n 1. Why did this change between 1.66 and 1.67? Was it an expected change in behavior? (Why is this change good? Its not noted in the release notes that I saw.)\r\n 2. Should we bring back the old behavior, at least in a limited set of cases?\r\n 3. Is there a different invocation our users should be using when they override the linker, e.g. perhaps they should be using `-C linker-flavor=xxx` to tell `rustc` that it needs to pass along parameters compatible with using `clang` as a linker? (But if that is the case, I do not see `clang` listed as one of the available values for `linker-flavor`)\r\n 4. Should we start investing in *post-processing* the linker-errors from `rustc` itself -- and still spit out those linker errors (because in the general case, the user *is* going to need to see them in order to make sense of what to do in reaction), but potentially also provide hints as to things to look into (e.g. in this case, maybe the `crt1.o` in the error could be used as a hint to look at the `-nostartfiles` option as something to pass to the linker).\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/108910/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/108910/timeline", "performed_via_github_app": null, "state_reason": null}