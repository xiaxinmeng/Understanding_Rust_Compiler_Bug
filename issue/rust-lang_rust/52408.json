{"url": "https://api.github.com/repos/rust-lang/rust/issues/52408", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/52408/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/52408/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/52408/events", "html_url": "https://github.com/rust-lang/rust/issues/52408", "id": 341351907, "node_id": "MDU6SXNzdWUzNDEzNTE5MDc=", "number": 52408, "title": "rustc panic", "user": {"login": "d653", "id": 1157896, "node_id": "MDQ6VXNlcjExNTc4OTY=", "avatar_url": "https://avatars.githubusercontent.com/u/1157896?v=4", "gravatar_id": "", "url": "https://api.github.com/users/d653", "html_url": "https://github.com/d653", "followers_url": "https://api.github.com/users/d653/followers", "following_url": "https://api.github.com/users/d653/following{/other_user}", "gists_url": "https://api.github.com/users/d653/gists{/gist_id}", "starred_url": "https://api.github.com/users/d653/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/d653/subscriptions", "organizations_url": "https://api.github.com/users/d653/orgs", "repos_url": "https://api.github.com/users/d653/repos", "events_url": "https://api.github.com/users/d653/events{/privacy}", "received_events_url": "https://api.github.com/users/d653/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-07-15T21:00:11Z", "updated_at": "2018-07-15T21:03:28Z", "closed_at": "2018-07-15T21:03:28Z", "author_association": "NONE", "active_lock_reason": null, "body": "The code that triggers the bug is divided in two crates, if I try to merge the code to a single crate then it compiles without a panic.\r\n\r\nCargo.toml\r\n```\r\n[package]\r\nname = \"bug\"\r\nversion = \"0.3.0\"\r\nauthors = [\"...\"]\r\n\r\n[dependencies]\r\ntokio-core = \"^0.1\"\r\nbug2 = { path = \"../bug2\" }\r\n```\r\nmain.rs\r\n```\r\nextern crate tokio_core;\r\nextern crate bug2;\r\nuse tokio_core::reactor::Core;\r\nfn main() {\r\n    bug2::test(\"aaa\", Core::new().unwrap().handle());\r\n}\r\n```\r\n\r\n\r\nCargo.toml\r\n```\r\n[package]\r\nname = \"bug2\"\r\nversion = \"0.1.0\"\r\nauthors = [\"...\"]\r\n\r\n[dependencies]\r\nfutures = \"^0.1\"\r\ntokio-core = \"^0.1\"\r\n\r\n```\r\n\r\nlib.rs\r\n```\r\nextern crate futures;\r\nextern crate tokio_core;\r\n\r\nuse futures::stream::Stream;\r\nuse futures::sync::mpsc;\r\nuse tokio_core::reactor::Handle;\r\nuse futures::Future;\r\n\r\n\r\nfn f2(_ : &Handle){\r\n}\r\n\r\n\r\nfn f1(receiver: mpsc::UnboundedReceiver<()>, handle : Handle) -> impl Future<Item=(),Error=()> {\r\n    receiver.map(move |_|{\r\n        f2(&handle);\r\n    }).for_each(|_|Ok(()))\r\n}\r\n\r\n\r\npub fn test<T: AsRef<str>>(_: T, handle: Handle) {\r\n    handle.spawn(f1(mpsc::unbounded().1,handle.clone()));\r\n}\r\n```\r\n\r\nResult:\r\n```\r\n$ RUST_BACKTRACE=full cargo build \r\n   Compiling libc v0.2.42\r\n   Compiling nodrop v0.1.12                                                                                           \r\n   Compiling cfg-if v0.1.4                                                                                            \r\n   Compiling scopeguard v0.3.3                                                                                        \r\n   Compiling byteorder v1.2.3                                                                                         \r\n   Compiling lazy_static v1.0.2                                                                                       \r\n   Compiling memoffset v0.2.1                                                                                         \r\n   Compiling futures v0.1.23                                                                                          \r\n   Compiling lazycell v0.6.0                                                                                          \r\n   Compiling slab v0.4.0                                                                                              \r\n   Compiling scoped-tls v0.1.2                                                                                        \r\n   Compiling arrayvec v0.4.7                                                                                          \r\n   Compiling crossbeam-utils v0.3.2                                                                                   \r\n   Compiling log v0.4.3                                                                                               \r\n   Compiling iovec v0.1.2                                                                                             \r\n   Compiling net2 v0.2.33                                                                                             \r\n   Compiling rand v0.4.2                                                                                              \r\n   Compiling num_cpus v1.8.0                                                                                          \r\n   Compiling bytes v0.4.8                                                                                             \r\n   Compiling crossbeam-epoch v0.4.3                                                                                   \r\n   Compiling mio v0.6.15                                                                                              \r\n   Compiling crossbeam-deque v0.3.1                                                                                   \r\n   Compiling tokio-executor v0.1.2                                                                                    \r\n   Compiling tokio-io v0.1.7                                                                                          \r\n   Compiling tokio-threadpool v0.1.5                                                                                  \r\n   Compiling tokio-timer v0.2.4                                                                                       \r\n   Compiling tokio-codec v0.1.0                                                                                       \r\n   Compiling tokio-reactor v0.1.2                                                                                     \r\n   Compiling tokio-fs v0.1.2                                                                                          \r\n   Compiling tokio-tcp v0.1.0                                                                                         \r\n   Compiling tokio-udp v0.1.1                                                                                         \r\n   Compiling tokio v0.1.7                                                                                             \r\n   Compiling tokio-core v0.1.17                                                                                       \r\n   Compiling bug2 v0.1.0 (file:///home/me/sources/antistorm/bug2)                                                     \r\n   Compiling bug v0.3.0 (file:///home/me/sources/antistorm/bug)                                                       \r\nerror: internal compiler error: librustc_mir/monomorphize/collector.rs:760: Cannot create local mono-item for DefId(43/0:9 ~ bug2[df2b]::f2[0])\r\n\r\nthread 'main' panicked at 'Box<Any>', librustc_errors/lib.rs:554:9\r\nstack backtrace:\r\n   0:     0x7f06ef7e044e - std::sys::unix::backtrace::tracing::imp::unwind_backtrace::hd6c46a9a697d3bb0\r\n                               at libstd/sys/unix/backtrace/tracing/gcc_s.rs:49\r\n   1:     0x7f06ef7b7d36 - std::sys_common::backtrace::print::hb45c2623ee574a87\r\n                               at libstd/sys_common/backtrace.rs:71\r\n                               at libstd/sys_common/backtrace.rs:59\r\n   2:     0x7f06ef7e947d - std::panicking::default_hook::{{closure}}::h07311e63483c372f\r\n                               at libstd/panicking.rs:211\r\n   3:     0x7f06ef7e91f0 - std::panicking::default_hook::h028233b8c65b3bae\r\n                               at libstd/panicking.rs:227\r\n   4:     0x7f06ebe83395 - rustc::util::common::panic_hook::hf2c45cd370f93067\r\n   5:     0x7f06ef7e9b43 - std::panicking::rust_panic_with_hook::haf5fc7b5dee91fb6\r\n                               at libstd/panicking.rs:479\r\n   6:     0x7f06eac56f3e - std::panicking::begin_panic::h7d35788894d6c658\r\n   7:     0x7f06eac52811 - rustc_errors::Handler::bug::heb8a9758863e3156\r\n   8:     0x7f06ebae270c - rustc::session::opt_span_bug_fmt::{{closure}}::h5382608adf0a2b3b\r\n   9:     0x7f06ebb9bf59 - rustc::ty::context::tls::with_opt::{{closure}}::h977b3c480aed1c06\r\n  10:     0x7f06ebae35df - rustc::ty::context::tls::with_context_opt::hab811a2b405ba06e\r\n  11:     0x7f06ebb9b9f6 - rustc::ty::context::tls::with_opt::h9dbcf2abf5eccedf\r\n  12:     0x7f06eba311b4 - rustc::session::opt_span_bug_fmt::h8a2450256e82837a\r\n  13:     0x7f06eba31126 - rustc::session::bug_fmt::he893b82c41367e01\r\n  14:     0x7f06ec8d99b9 - rustc_mir::monomorphize::collector::should_monomorphize_locally::h61f3fc7939397156\r\n  15:     0x7f06ec8d9634 - rustc_mir::monomorphize::collector::visit_instance_use::ha5b4c96d3a4a65ef\r\n  16:     0x7f06ec8d9602 - rustc_mir::monomorphize::collector::visit_fn_use::h0faca38b45594912\r\n  17:     0x7f06ec8d910c - <rustc_mir::monomorphize::collector::MirNeighborCollector<'a, 'tcx> as rustc::mir::visit::Visitor<'tcx>>::visit_terminator_kind::h2c72726e7afc51de\r\n  18:     0x7f06ec8d7ac1 - rustc_mir::monomorphize::collector::collect_items_rec::h0f4189260a5f2b34\r\n  19:     0x7f06ec8d80f9 - rustc_mir::monomorphize::collector::collect_items_rec::h0f4189260a5f2b34\r\n  20:     0x7f06ec8d80f9 - rustc_mir::monomorphize::collector::collect_items_rec::h0f4189260a5f2b34\r\n  21:     0x7f06ec8d80f9 - rustc_mir::monomorphize::collector::collect_items_rec::h0f4189260a5f2b34\r\n  22:     0x7f06ec8d80f9 - rustc_mir::monomorphize::collector::collect_items_rec::h0f4189260a5f2b34\r\n  23:     0x7f06ec8d80f9 - rustc_mir::monomorphize::collector::collect_items_rec::h0f4189260a5f2b34\r\n  24:     0x7f06ec8d80f9 - rustc_mir::monomorphize::collector::collect_items_rec::h0f4189260a5f2b34\r\n  25:     0x7f06ec8d80f9 - rustc_mir::monomorphize::collector::collect_items_rec::h0f4189260a5f2b34\r\n  26:     0x7f06ecb351b0 - rustc_mir::monomorphize::collector::collect_crate_mono_items::{{closure}}::hfe149b0b8cb481eb\r\n  27:     0x7f06ecb0d8c4 - rustc::util::common::time::hf897241d402a4e9e\r\n  28:     0x7f06ec8d5ce0 - rustc_mir::monomorphize::collector::collect_crate_mono_items::h64944a52b0a9edc3\r\n  29:     0x7f06e54f7276 - rustc::util::common::time::h0d7f9f0f8494d94e\r\n  30:     0x7f06e55b0f94 - rustc_codegen_llvm::base::collect_and_partition_mono_items::h7a7c84af63c01538\r\n  31:     0x7f06ebb9dae8 - rustc::ty::query::<impl rustc::ty::query::config::QueryAccessors<'tcx> for rustc::ty::query::queries::collect_and_partition_mono_items<'tcx>>::compute::h4cdf9fe96888402e\r\n  32:     0x7f06ebb165e4 - rustc::ty::context::tls::with_context::hc07a3cde95f6473f\r\n  33:     0x7f06eb96641e - rustc::dep_graph::graph::DepGraph::with_task_impl::h144e93e8e7db8c82\r\n  34:     0x7f06ebb435db - rustc::ty::context::tls::with_related_context::h3c918fef702c76f1\r\n  35:     0x7f06ebc92377 - rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::force_query_with_job::h9845e745f16d383c\r\n  36:     0x7f06ebd5dbd9 - rustc::ty::query::plumbing::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::get_query::ha0bb465fedd5ab61\r\n  37:     0x7f06e55b9820 - <rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_utils::codegen_backend::CodegenBackend>::codegen_crate::h050f6f9fdd741ee2\r\n  38:     0x7f06efb92131 - rustc::util::common::time::hf3bdbd3076e65138\r\n  39:     0x7f06efb8627c - rustc_driver::driver::phase_4_codegen::h6d218d66ccc5b3b1\r\n  40:     0x7f06efb42e38 - rustc_driver::driver::compile_input::{{closure}}::h3ae3822eda7126fa\r\n  41:     0x7f06efb3e3c9 - rustc::ty::context::tls::enter_context::h172e3a71948cf3e8\r\n  42:     0x7f06efbcab7a - <std::thread::local::LocalKey<T>>::with::hbc082df5ff4b92fe\r\n  43:     0x7f06efc3cbbd - rustc::ty::context::TyCtxt::create_and_enter::h140543bc115628f6\r\n  44:     0x7f06efb7fd7c - rustc_driver::driver::compile_input::h77799d53c7077f32\r\n  45:     0x7f06efc0a2c0 - rustc_driver::run_compiler_with_pool::hf70f7dd371076d1f\r\n  46:     0x7f06efb45e7c - <scoped_tls::ScopedKey<T>>::set::hea0904c0d7dcea9c\r\n  47:     0x7f06efb45b71 - <scoped_tls::ScopedKey<T>>::set::h2f59f8491f17e599\r\n  48:     0x7f06efba120a - syntax::with_globals::hb4d6561660afb38b\r\n  49:     0x7f06efb445f2 - <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once::h51855e0168324012\r\n  50:     0x7f06ef7f69b9 - __rust_maybe_catch_panic\r\n                               at libpanic_unwind/lib.rs:106\r\n  51:     0x7f06efc07754 - rustc_driver::run::hfad78015aa66f902\r\n  52:     0x7f06efc16eea - rustc_driver::main::hc68ca44052c5c3d1\r\n  53:     0x5572bc845b52 - std::rt::lang_start::{{closure}}::h169c2960103a293d\r\n  54:     0x7f06ef7e9582 - std::panicking::try::do_call::h4ae9a4c7ba6e1e81\r\n                               at libstd/rt.rs:59\r\n                               at libstd/panicking.rs:310\r\n  55:     0x7f06ef7f69b9 - __rust_maybe_catch_panic\r\n                               at libpanic_unwind/lib.rs:106\r\n  56:     0x7f06ef7cbca5 - std::rt::lang_start_internal::hea52cc5b4fec6cb8\r\n                               at libstd/panicking.rs:289\r\n                               at libstd/panic.rs:392\r\n                               at libstd/rt.rs:58\r\n  57:     0x5572bc845bb3 - main\r\n  58:     0x7f06ef3c2f29 - __libc_start_main\r\n  59:     0x5572bc845a38 - <unknown>\r\nquery stack during panic:\r\n#0 [collect_and_partition_mono_items] collect_and_partition_mono_items\r\nend of query stack\r\nerror: aborting due to previous error\r\n\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: rustc 1.29.0-nightly (254f8796b 2018-07-13) running on x86_64-unknown-linux-gnu\r\n\r\nnote: compiler flags: -C debuginfo=2 -C incremental --crate-type bin\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n\r\nerror: Could not compile `bug`.                                                                                       \r\n\r\nTo learn more, run the command again with --verbose.\r\n```\r\n\r\n\r\n", "closed_by": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/52408/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/52408/timeline", "performed_via_github_app": null, "state_reason": "completed"}