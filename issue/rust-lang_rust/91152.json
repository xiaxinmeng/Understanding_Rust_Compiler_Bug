{"url": "https://api.github.com/repos/rust-lang/rust/issues/91152", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/91152/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/91152/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/91152/events", "html_url": "https://github.com/rust-lang/rust/issues/91152", "id": 1060862944, "node_id": "I_kwDOAAsO6M4_O3vg", "number": 91152, "title": "Copying multiple large files results in `assertion failed: (left == right)` in kernel_copy.rs:592", "user": {"login": "archer884", "id": 679494, "node_id": "MDQ6VXNlcjY3OTQ5NA==", "avatar_url": "https://avatars.githubusercontent.com/u/679494?v=4", "gravatar_id": "", "url": "https://api.github.com/users/archer884", "html_url": "https://github.com/archer884", "followers_url": "https://api.github.com/users/archer884/followers", "following_url": "https://api.github.com/users/archer884/following{/other_user}", "gists_url": "https://api.github.com/users/archer884/gists{/gist_id}", "starred_url": "https://api.github.com/users/archer884/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/archer884/subscriptions", "organizations_url": "https://api.github.com/users/archer884/orgs", "repos_url": "https://api.github.com/users/archer884/repos", "events_url": "https://api.github.com/users/archer884/events{/privacy}", "received_events_url": "https://api.github.com/users/archer884/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2021-11-23T05:53:19Z", "updated_at": "2021-11-23T23:48:54Z", "closed_at": "2021-11-23T23:48:54Z", "author_association": "NONE", "active_lock_reason": null, "body": "I tried this code:\r\n\r\n```rust\r\nfn copy_file(path: &Path, target: &str) -> io::Result<()> {\r\n    let mut reader = File::open(path)?;\r\n    let mut writer = File::create(make_target_path(path, target))?;\r\n\r\n    io::copy(&mut reader, &mut writer)?;\r\n\r\n    Ok(())\r\n}\r\n```\r\n\r\nI expected the copy operation to succeed (that is, to return `Ok(())`) or to fail (that is, to return `Err(BUY A BETTER HARD DRIVE!)`. What happens instead is a panic thrown from line 592 of kernel_copy.rs. Before I changed from the default mount options to something else, this happened pretty much every time I tried to copy multiple large files from a Linux laptop to a Linux server on my network.\r\n\r\nThe server in question has a BTRFS volume. That volume was mounted on the laptop by the Gnome shell--er, that is, just whatever Gnome does to mount shares it finds on the network. Because it gets mounted at something obscene, like `/this/path/takes/forever/to/type1000/100/volumename`, I added a symlink to allow access via `~/share` in my home directory. (I only mention this because I already discovered that a symlink renders something like `fs::copy` unworkable, so.... /shrug)\r\n\r\nAnyway, looks like the code in kernel_copy 1) encounters an error, 2) attempts to fall back to user space copy instead of using the fancy kernel copy routine, and 3) panics upon realizing that some data has already been written. I reckon there's some kind of reason for it, but I was still surprised that this is a panic instead of just, \"Whoops. We encountered an error.\"\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.56.1 (59eed8a2a 2021-11-01)\r\nbinary: rustc\r\ncommit-hash: 59eed8a2aac0230a8b53e89d4e99d55912ba6b35\r\ncommit-date: 2021-11-01\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.56.1\r\nLLVM version: 13.0.0\r\n```", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/91152/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/91152/timeline", "performed_via_github_app": null, "state_reason": "completed"}