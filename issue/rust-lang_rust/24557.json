{"url": "https://api.github.com/repos/rust-lang/rust/issues/24557", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/24557/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/24557/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/24557/events", "html_url": "https://github.com/rust-lang/rust/issues/24557", "id": 69323299, "node_id": "MDU6SXNzdWU2OTMyMzI5OQ==", "number": 24557, "title": "Float printing and/or parsing is inaccurate", "user": {"login": "hanna-kruppe", "id": 2311707, "node_id": "MDQ6VXNlcjIzMTE3MDc=", "avatar_url": "https://avatars.githubusercontent.com/u/2311707?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hanna-kruppe", "html_url": "https://github.com/hanna-kruppe", "followers_url": "https://api.github.com/users/hanna-kruppe/followers", "following_url": "https://api.github.com/users/hanna-kruppe/following{/other_user}", "gists_url": "https://api.github.com/users/hanna-kruppe/gists{/gist_id}", "starred_url": "https://api.github.com/users/hanna-kruppe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hanna-kruppe/subscriptions", "organizations_url": "https://api.github.com/users/hanna-kruppe/orgs", "repos_url": "https://api.github.com/users/hanna-kruppe/repos", "events_url": "https://api.github.com/users/hanna-kruppe/events{/privacy}", "received_events_url": "https://api.github.com/users/hanna-kruppe/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 23, "created_at": "2015-04-18T16:16:46Z", "updated_at": "2015-08-13T16:09:24Z", "closed_at": "2015-08-13T16:09:24Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "This example program produces a frighteningly large amount of numbers that, without even leaving the save haven of `[0.0; 1.0)`, change when printed out and read back in:\n\n``` rust\n#![feature(rand)]\n\nuse std::rand::{Rng, thread_rng};\n\nconst N: u32 = 30;\n\nfn main() {\n    let mut r = thread_rng();\n    let mut errors = 0;\n    for i in 0..N {\n        let x0 = r.next_f64();\n        let x1 = format!(\"{:.17}\", x0).parse().unwrap();\n        if x0 != x1 {\n            //println!(\"{:.17} {:.17} {:e}\", x0, x1, x0 - x1);\n            errors += 1;\n        }\n    }\n    println!(\"Found {} non-round trip-safe numbers among {} random numbers\", errors, N);\n}\n```\n\nNot all numbers fail to round trip, but in all my trials a majority did. The error is in the order of 1e-16 (much more, around 1e-6, for the default `{}` formatting) for all outputs I looked at, but that is more than IEEE-754 permits (it requires correct round trips when 17 decimal digits are printed) and certainly more than users should be forced to endure. Perfect round tripping is possible, useful, and important --- it's just a pain to implement.\n\nI have recently worked my way through float formatting, and at the very least it _looks_ pretty naive (as in, code and comments read as if the authors didn't care at all about rounding error, or were entirely unaware that it's a thing). I also just skimmed over the `FromStr` implementation and it looks a bit smarter, but since there is no reference to any paper and it doesn't use bignums I have doubts about its accuracy as well.\n\nMany numbers reach a fixed point after one round trip, but there are also numbers which take hundreds, thousands, or even more round trips before they settle down --- if they settle down at all (some cycle). The largest I found was almost nine million round trips, which is almost absurd. For obvious reasons, the error changing (presumably, growing) over time is even worse than a one-time inaccurate rounding. [Here's the program](https://gist.github.com/rkruppe/c132f3232c32b8b45c06) I used to find those.\n\nFor the formatting side of things, I also filed #24556 \n\nI know less about the parsing side of things. The topic seems to get less attention in general, but I found a [paper by William Clinger](http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.45.4152&rep=rep1&type=pdf) which seems promising.\n\ncc @rprichard\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/24557/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/24557/timeline", "performed_via_github_app": null, "state_reason": "completed"}