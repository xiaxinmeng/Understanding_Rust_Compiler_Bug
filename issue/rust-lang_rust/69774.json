{"url": "https://api.github.com/repos/rust-lang/rust/issues/69774", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/69774/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/69774/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/69774/events", "html_url": "https://github.com/rust-lang/rust/issues/69774", "id": 576922422, "node_id": "MDU6SXNzdWU1NzY5MjI0MjI=", "number": 69774, "title": "[libs] Add `TcpStream::keepalive` and `TcpStream::set_keepalive`", "user": {"login": "yoshuawuyts", "id": 2467194, "node_id": "MDQ6VXNlcjI0NjcxOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2467194?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yoshuawuyts", "html_url": "https://github.com/yoshuawuyts", "followers_url": "https://api.github.com/users/yoshuawuyts/followers", "following_url": "https://api.github.com/users/yoshuawuyts/following{/other_user}", "gists_url": "https://api.github.com/users/yoshuawuyts/gists{/gist_id}", "starred_url": "https://api.github.com/users/yoshuawuyts/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yoshuawuyts/subscriptions", "organizations_url": "https://api.github.com/users/yoshuawuyts/orgs", "repos_url": "https://api.github.com/users/yoshuawuyts/repos", "events_url": "https://api.github.com/users/yoshuawuyts/events{/privacy}", "received_events_url": "https://api.github.com/users/yoshuawuyts/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}, {"id": 630652267, "node_id": "MDU6TGFiZWw2MzA2NTIyNjc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-feature-request", "name": "C-feature-request", "color": "f5f1fd", "default": false, "description": "Category: A feature request, i.e: not implemented / a PR."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2020-03-06T13:12:29Z", "updated_at": "2023-04-21T12:48:28Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "Today [an issue was filed](https://github.com/async-rs/async-std/issues/718) in `async-std` asking how to set the `SO_KEEPALIVE` option on our `TcpStream`. Because we've only implemented methods that are available in `std` as well, we never added these methods. But I think there's a strong case to add these methods to `std::net::TcpStream`.\r\n\r\n`TcpStream` already supports lots of control methods natively including: `set_read_timeout`, `set_write_timeout`, `set_ttl`, and `set_nodelay`. `set_keepalive` would be a method along the same lines providing a convenient way to set yet another low-level option. And there's a clear need for it: at least 3 other low-level TCP related libraries expose `keepalive` and `set_keepalive` (see the \"Prior Art\" section for more on this).\r\n\r\n## Implementation\r\n\r\nThe implementation can probably entirely copied from [`net2::TcpStreamExt`](https://docs.rs/net2/0.2.33/net2/trait.TcpStreamExt.html#tymethod.keepalive). Unlike some of the other methods in that genre, these methods can operate entirely on an already instantiated socket.\r\n\r\nAlso between all existing implementations that I've found, there's consensus that the shape of the methods should be as follows:\r\n\r\n```rust\r\nimpl TcpStream {\r\n    fn set_keepalive(&self, keepalive: Option<Duration>) -> Result<()>;\r\n    fn keepalive(&self) -> Result<Option<Duration>>;\r\n}\r\n```\r\n\r\n## Prior Art\r\n- [`net2::TcpStreamExt`](https://docs.rs/net2/0.2.33/net2/trait.TcpStreamExt.html#tymethod.keepalive) exposes both `keepalive` and `set_keepalive`.\r\n- [`tokio::net::TcpStream`](https://docs.rs/tokio/0.2.13/tokio/net/struct.TcpStream.html#method.keepalive) exposes both `keepalive` and `set_keepalive`.\r\n- [`socket2::Socket`](https://docs.rs/socket2/0.3.11/socket2/struct.Socket.html#method.set_keepalive) exposes both `keepalive` and `set_keepalive`.\r\n\r\n## Prior Discussion\r\n\r\nI couldn't find any references to `TcpStream::{keepalive,set_keepalive}` directly but https://github.com/rust-lang/rust/issues/27773 seems to touch on the general topic. Also https://github.com/rust-lang/rust/pull/28339 introduced many of the socket controls mentioned earlier, but doesn't seem to mention `keepalive` either.\r\n\r\n---\r\n\r\n__edit:__ I've since found https://github.com/rust-lang/rust/pull/31945#issuecomment-189784913 and https://github.com/rust-lang/rust/pull/24594 which mention `TcpStream::keepalive`. In particular https://github.com/rust-lang/rust/pull/31945#issuecomment-189784913 mentions:\r\n\r\n> We should probably split the keepalive functionality into two methods to mirror how things work, (...) but that should be worked out in the net2 crate.\r\n\r\nDiscussion seems to have been started in https://github.com/rust-lang-nursery/net2-rs/issues/29, but hasn't progressed since 2016.\r\n\r\n## Drawbacks\r\n\r\nI don't think there are any. Back in 2015 it seems these methods weren't added as part of Rust 1.0 because the libs team wanted to be cautious of what to include. But I think in the years since it's proven to be a useful addition that's seen a lot of use throughout the ecosystem, and now might be a good time to consider adding these to `std`.", "closed_by": {"login": "yoshuawuyts", "id": 2467194, "node_id": "MDQ6VXNlcjI0NjcxOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2467194?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yoshuawuyts", "html_url": "https://github.com/yoshuawuyts", "followers_url": "https://api.github.com/users/yoshuawuyts/followers", "following_url": "https://api.github.com/users/yoshuawuyts/following{/other_user}", "gists_url": "https://api.github.com/users/yoshuawuyts/gists{/gist_id}", "starred_url": "https://api.github.com/users/yoshuawuyts/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yoshuawuyts/subscriptions", "organizations_url": "https://api.github.com/users/yoshuawuyts/orgs", "repos_url": "https://api.github.com/users/yoshuawuyts/repos", "events_url": "https://api.github.com/users/yoshuawuyts/events{/privacy}", "received_events_url": "https://api.github.com/users/yoshuawuyts/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/69774/reactions", "total_count": 21, "+1": 21, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/69774/timeline", "performed_via_github_app": null, "state_reason": null}