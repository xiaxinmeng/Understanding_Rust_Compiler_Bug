{"url": "https://api.github.com/repos/rust-lang/rust/issues/32887", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/32887/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/32887/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/32887/events", "html_url": "https://github.com/rust-lang/rust/issues/32887", "id": 147543671, "node_id": "MDU6SXNzdWUxNDc1NDM2NzE=", "number": 32887, "title": "don't make intra-crate calls to exported functions go through the PLT or similar", "user": {"login": "froydnj", "id": 151096, "node_id": "MDQ6VXNlcjE1MTA5Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/151096?v=4", "gravatar_id": "", "url": "https://api.github.com/users/froydnj", "html_url": "https://github.com/froydnj", "followers_url": "https://api.github.com/users/froydnj/followers", "following_url": "https://api.github.com/users/froydnj/following{/other_user}", "gists_url": "https://api.github.com/users/froydnj/gists{/gist_id}", "starred_url": "https://api.github.com/users/froydnj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/froydnj/subscriptions", "organizations_url": "https://api.github.com/users/froydnj/orgs", "repos_url": "https://api.github.com/users/froydnj/repos", "events_url": "https://api.github.com/users/froydnj/events{/privacy}", "received_events_url": "https://api.github.com/users/froydnj/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2016-04-11T20:21:07Z", "updated_at": "2017-05-15T12:36:18Z", "closed_at": "2017-05-15T12:36:18Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Apologies for the mouthful of an issue title.  Here's some example Rust for the issue at hand:\n\n``` rust\npub struct Ex {\n    d: u32\n}\n\npub fn call(x: &Ex)\n{\n    call_with_flags(x, 0)\n}\n\npub fn call_with_flags(x: &Ex, flags: u32)\n{\n    println!(\"d: {}, flags: {}\", x.d, flags)\n}\n```\n\nCompiling this with `rustc -O -C inline-threshold=0` results in the following on x86-64 Linux (the use of `-C inline-threshold=0` is a bit artificial, but I've seen the same sort of issue when disassembling `std`, which presumably doesn't modify `inline-threshold`):\n\n```\n0000000000000000 <plt::call::h4fbe4633d0f48375>:\n   0:   31 f6                   xor    %esi,%esi\n   2:   e9 00 00 00 00          jmpq   7 <plt::call::h4fbe4633d0f48375+0x7>\n            3: R_X86_64_PLT32   plt::call_with_flags::he191eb6ceb0f1f21-0x4\n```\n\nThat `R_X86_64_PLT32` relocation is going to get resolved to a call into the PLT, which introduces a small amount of overhead on every call, in addition to taking up unneeded space with the PLT entry and the function pointer in the GOT.  It would be better to use a `R_X86_64_PC32` relocation there, which will get turned into a direct jump at link time.  `glibc` uses this technique to great effect so that all intra-libc calls (except for a few things like `malloc`, etc.) don't go through the PLT.\n\nFolks might want the ability to override public functions of a crate via `LD_PRELOAD` or similar, but doing so seems a little tricky with the current name mangling scheme.  Perhaps a `-C` option could be added?\n", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/32887/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/32887/timeline", "performed_via_github_app": null, "state_reason": "completed"}