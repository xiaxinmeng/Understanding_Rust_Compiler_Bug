{"url": "https://api.github.com/repos/rust-lang/rust/issues/78840", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/78840/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/78840/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/78840/events", "html_url": "https://github.com/rust-lang/rust/issues/78840", "id": 738281994, "node_id": "MDU6SXNzdWU3MzgyODE5OTQ=", "number": 78840, "title": "#[track_caller] does nothing on async fns", "user": {"login": "ghost", "id": 10137, "node_id": "MDQ6VXNlcjEwMTM3", "avatar_url": "https://avatars.githubusercontent.com/u/10137?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ghost", "html_url": "https://github.com/ghost", "followers_url": "https://api.github.com/users/ghost/followers", "following_url": "https://api.github.com/users/ghost/following{/other_user}", "gists_url": "https://api.github.com/users/ghost/gists{/gist_id}", "starred_url": "https://api.github.com/users/ghost/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ghost/subscriptions", "organizations_url": "https://api.github.com/users/ghost/orgs", "repos_url": "https://api.github.com/users/ghost/repos", "events_url": "https://api.github.com/users/ghost/events{/privacy}", "received_events_url": "https://api.github.com/users/ghost/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234948, "node_id": "MDU6TGFiZWwyMzQ5NDg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-attributes", "name": "A-attributes", "color": "f7e101", "default": false, "description": "Area: #[attributes(..)]"}, {"id": 630652267, "node_id": "MDU6TGFiZWw2MzA2NTIyNjc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-feature-request", "name": "C-feature-request", "color": "f5f1fd", "default": false, "description": "Category: A feature request, i.e: not implemented / a PR."}, {"id": 1049510487, "node_id": "MDU6TGFiZWwxMDQ5NTEwNDg3", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-async-await", "name": "A-async-await", "color": "f7e101", "default": false, "description": "Area: Async & Await"}, {"id": 1259720434, "node_id": "MDU6TGFiZWwxMjU5NzIwNDM0", "url": "https://api.github.com/repos/rust-lang/rust/labels/AsyncAwait-Polish", "name": "AsyncAwait-Polish", "color": "d4c5f9", "default": false, "description": "Async-await issues that are part of the \"polish\" area"}, {"id": 1259721467, "node_id": "MDU6TGFiZWwxMjU5NzIxNDY3", "url": "https://api.github.com/repos/rust-lang/rust/labels/AsyncAwait-Triaged", "name": "AsyncAwait-Triaged", "color": "d4c5f9", "default": false, "description": "Async-await issues that have been triaged during a working group meeting."}, {"id": 1606844895, "node_id": "MDU6TGFiZWwxNjA2ODQ0ODk1", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-track_caller", "name": "F-track_caller", "color": "f9c0cc", "default": false, "description": "`#![feature(track_caller)]`"}], "state": "closed", "locked": false, "assignee": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 7, "created_at": "2020-11-07T17:20:26Z", "updated_at": "2022-11-17T16:47:45Z", "closed_at": "2022-11-17T16:47:45Z", "author_association": "NONE", "active_lock_reason": null, "body": "I tried:\r\n```rust\r\n#[track_caller]\r\nasync fn panic() -> ! {\r\n    panic!();\r\n}\r\n\r\nfn main() {\r\n    futures::executor::block_on(async { panic().await });\r\n}\r\n```\r\nI expected the seventh line to be the panic location, but I got this:\r\n```\r\nthread 'main' panicked at 'explicit panic', src/main.rs:3:5\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\r\n```\r\n<details>\r\n<summary>With <code>RUST_BACKTRACE=1</code></summary>\r\n\r\n```\r\nthread 'main' panicked at 'explicit panic', src/main.rs:3:5\r\nstack backtrace:\r\n   0: std::panicking::begin_panic\r\n             at /rustc/a601302ff0217b91589b5a7310a8a23adb843fdc/library/std/src/panicking.rs:521:12\r\n   1: playground::panic::{{closure}}\r\n             at ./src/main.rs:3:5\r\n   2: <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/a601302ff0217b91589b5a7310a8a23adb843fdc/library/core/src/future/mod.rs:80:19\r\n   3: playground::main::{{closure}}\r\n             at ./src/main.rs:7:41\r\n   4: <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/a601302ff0217b91589b5a7310a8a23adb843fdc/library/core/src/future/mod.rs:80:19\r\n   5: futures_executor::local_pool::block_on::{{closure}}\r\n             at ./.cargo/registry/src/github.com-1ecc6299db9ec823/futures-executor-0.3.6/src/local_pool.rs:317:23\r\n   6: futures_executor::local_pool::run_executor::{{closure}}\r\n             at ./.cargo/registry/src/github.com-1ecc6299db9ec823/futures-executor-0.3.6/src/local_pool.rs:87:37\r\n   7: std::thread::local::LocalKey<T>::try_with\r\n             at /rustc/a601302ff0217b91589b5a7310a8a23adb843fdc/library/std/src/thread/local.rs:272:16\r\n   8: std::thread::local::LocalKey<T>::with\r\n             at /rustc/a601302ff0217b91589b5a7310a8a23adb843fdc/library/std/src/thread/local.rs:248:9\r\n   9: futures_executor::local_pool::run_executor\r\n             at ./.cargo/registry/src/github.com-1ecc6299db9ec823/futures-executor-0.3.6/src/local_pool.rs:83:5\r\n  10: futures_executor::local_pool::block_on\r\n             at ./.cargo/registry/src/github.com-1ecc6299db9ec823/futures-executor-0.3.6/src/local_pool.rs:317:5\r\n  11: playground::main\r\n             at ./src/main.rs:7:5\r\n  12: core::ops::function::FnOnce::call_once\r\n             at /rustc/a601302ff0217b91589b5a7310a8a23adb843fdc/library/core/src/ops/function.rs:227:5\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n```\r\n</details>\r\n\r\n[Playground](https://play.rust-lang.org/?version=nightly&mode=debug&edition=2018&code=%23%5Btrack_caller%5D%0Aasync%20fn%20panic()%20-%3E%20!%20%7B%0A%20%20%20%20panic!()%3B%0A%7D%0A%0Afn%20main()%20%7B%0A%20%20%20%20futures%3A%3Aexecutor%3A%3Ablock_on(async%20%7B%20panic().await%20%7D)%3B%0A%7D%0A) (tried using nightly 2020-11-06 a601302ff0217b91589b)\r\n\r\nI can achieve the result I expected by implementing a `Future` manually:\r\n```rust\r\n#![feature(never_type)]\r\n\r\nuse std::{\r\n    future::Future,\r\n    pin::Pin,\r\n    task::{Context, Poll},\r\n};\r\n\r\nstruct Panic;\r\n\r\nimpl Future for Panic {\r\n    type Output = !;\r\n\r\n    #[track_caller]\r\n    fn poll(self: Pin<&mut Self>, _: &mut Context<'_>) -> Poll<Self::Output> {\r\n        panic!()\r\n    }\r\n}\r\n\r\nfn main() {\r\n    futures::executor::block_on(async { Panic.await });\r\n}\r\n```\r\nOutput:\r\n```\r\nthread 'main' panicked at 'explicit panic', src/main.rs:21:41\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\r\n```\r\n[Playground](https://play.rust-lang.org/?version=nightly&mode=debug&edition=2018&code=%23!%5Bfeature(never_type)%5D%0A%0Ause%20std%3A%3A%7B%0A%20%20%20%20future%3A%3AFuture%2C%0A%20%20%20%20pin%3A%3APin%2C%0A%20%20%20%20task%3A%3A%7BContext%2C%20Poll%7D%2C%0A%7D%3B%0A%0Astruct%20Panic%3B%0A%0Aimpl%20Future%20for%20Panic%20%7B%0A%20%20%20%20type%20Output%20%3D%20!%3B%0A%0A%20%20%20%20%23%5Btrack_caller%5D%0A%20%20%20%20fn%20poll(self%3A%20Pin%3C%26mut%20Self%3E%2C%20_%3A%20%26mut%20Context%3C%27_%3E)%20-%3E%20Poll%3CSelf%3A%3AOutput%3E%20%7B%0A%20%20%20%20%20%20%20%20panic!()%0A%20%20%20%20%7D%0A%7D%0A%0Afn%20main()%20%7B%0A%20%20%20%20futures%3A%3Aexecutor%3A%3Ablock_on(async%20%7B%20Panic.await%20%7D)%3B%0A%7D%0A)\r\n\r\nI noticed that (in the backtrace) the compiler generated a closure (`Generator`?) for the `async fn`, so #74042 may be related.\r\n\r\n@rustbot modify labels: A-async-await A-attributes", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/78840/reactions", "total_count": 7, "+1": 7, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/78840/timeline", "performed_via_github_app": null, "state_reason": "completed"}