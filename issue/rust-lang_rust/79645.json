{"url": "https://api.github.com/repos/rust-lang/rust/issues/79645", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/79645/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/79645/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/79645/events", "html_url": "https://github.com/rust-lang/rust/issues/79645", "id": 755600455, "node_id": "MDU6SXNzdWU3NTU2MDA0NTU=", "number": 79645, "title": "Nightly - LLVM code coverage - Issue with generating code coverage when using Prometheus crate", "user": {"login": "BenChand", "id": 3618457, "node_id": "MDQ6VXNlcjM2MTg0NTc=", "avatar_url": "https://avatars.githubusercontent.com/u/3618457?v=4", "gravatar_id": "", "url": "https://api.github.com/users/BenChand", "html_url": "https://github.com/BenChand", "followers_url": "https://api.github.com/users/BenChand/followers", "following_url": "https://api.github.com/users/BenChand/following{/other_user}", "gists_url": "https://api.github.com/users/BenChand/gists{/gist_id}", "starred_url": "https://api.github.com/users/BenChand/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/BenChand/subscriptions", "organizations_url": "https://api.github.com/users/BenChand/orgs", "repos_url": "https://api.github.com/users/BenChand/repos", "events_url": "https://api.github.com/users/BenChand/events{/privacy}", "received_events_url": "https://api.github.com/users/BenChand/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}, {"id": 2483744621, "node_id": "MDU6TGFiZWwyNDgzNzQ0NjIx", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-code-coverage", "name": "A-code-coverage", "color": "f7e101", "default": false, "description": "Area: Source-based code coverage (-Cinstrument-coverage)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 13, "created_at": "2020-12-02T20:50:19Z", "updated_at": "2022-01-25T14:00:35Z", "closed_at": "2020-12-09T19:30:37Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI've been encountering a problem with generating code coverage for a project that uses the crate prometheus, specifically versions 0.9 onwards. Using these versions of the prometheus crate results in the error Failed to load coverage: Truncated coverage data when attempting to build the final coverage report. I've attempted to generalize the problem into a small test project here:\r\n\r\nhttps://github.com/BenChand/prometheus-code-cov\r\n\r\nI'm currently using nightly-2020-11-25. I've also listed 3 ways that I am able to get code coverage working in that example project when I change parts related to the prometheus crate.\r\n\r\nI've tried with these versions of LLVM:\r\n\r\n11.0.0-rust-1.50.0-nightly\r\n11.0.1\r\n\r\nExpected:\r\n\r\n```\r\n$ rm *.prof*\r\n$ cargo clean\r\n$ RUSTFLAGS=\"-Z instrument-coverage\" LLVM_PROFILE_FILE=\"cargo-%m.profraw\" cargo +nightly-2020-11-25 test --tests\r\n$ cargo +nightly-2020-11-25 profdata -- merge -sparse *.profraw -o out.profdata\r\n$ cargo cov -- report --instr-profile=./out.profdata target/debug/deps/prometheus_code_cov-24bcfe5d001389f5\r\n...\r\nsrc/lib.rs                                                                                                                12                 8    33.33%           6                 2    66.67%          24                 9    62.50%\r\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\nTOTAL    \r\n```\r\n\r\nInstead, this happened:\r\n\r\n```\r\n$ rm *.prof*\r\n$ cargo clean\r\n$ RUSTFLAGS=\"-Z instrument-coverage\" LLVM_PROFILE_FILE=\"cargo-%m.profraw\" cargo +nightly-2020-11-25 test --tests\r\n...\r\n     Running target/debug/deps/prometheus_code_cov-24bcfe5d001389f5\r\n\r\nrunning 1 test\r\ntest tests::it_returns_1 ... ok\r\n...\r\n$ cargo +nightly-2020-11-25 profdata -- merge -sparse *.profraw -o out.profdata\r\n$ cargo cov -- report --instr-profile=./out.profdata target/debug/deps/prometheus_code_cov-24bcfe5d001389f5\r\nerror: target/debug/deps/prometheus_code_cov-24bcfe5d001389f5: Failed to load coverage: Truncated coverage data\r\n\r\n```\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\nRust version: `nightly-2020-11-25`\r\n\r\n@richkadel ", "closed_by": {"login": "BenChand", "id": 3618457, "node_id": "MDQ6VXNlcjM2MTg0NTc=", "avatar_url": "https://avatars.githubusercontent.com/u/3618457?v=4", "gravatar_id": "", "url": "https://api.github.com/users/BenChand", "html_url": "https://github.com/BenChand", "followers_url": "https://api.github.com/users/BenChand/followers", "following_url": "https://api.github.com/users/BenChand/following{/other_user}", "gists_url": "https://api.github.com/users/BenChand/gists{/gist_id}", "starred_url": "https://api.github.com/users/BenChand/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/BenChand/subscriptions", "organizations_url": "https://api.github.com/users/BenChand/orgs", "repos_url": "https://api.github.com/users/BenChand/repos", "events_url": "https://api.github.com/users/BenChand/events{/privacy}", "received_events_url": "https://api.github.com/users/BenChand/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/79645/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/79645/timeline", "performed_via_github_app": null, "state_reason": "completed"}