{"url": "https://api.github.com/repos/rust-lang/rust/issues/100932", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/100932/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/100932/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/100932/events", "html_url": "https://github.com/rust-lang/rust/issues/100932", "id": 1348629518, "node_id": "I_kwDOAAsO6M5QYnQO", "number": 100932, "title": "Box::new copies generated Future unless call is wrapped", "user": {"login": "jkarneges", "id": 521953, "node_id": "MDQ6VXNlcjUyMTk1Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/521953?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jkarneges", "html_url": "https://github.com/jkarneges", "followers_url": "https://api.github.com/users/jkarneges/followers", "following_url": "https://api.github.com/users/jkarneges/following{/other_user}", "gists_url": "https://api.github.com/users/jkarneges/gists{/gist_id}", "starred_url": "https://api.github.com/users/jkarneges/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jkarneges/subscriptions", "organizations_url": "https://api.github.com/users/jkarneges/orgs", "repos_url": "https://api.github.com/users/jkarneges/repos", "events_url": "https://api.github.com/users/jkarneges/events{/privacy}", "received_events_url": "https://api.github.com/users/jkarneges/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1944310735, "node_id": "MDU6TGFiZWwxOTQ0MzEwNzM1", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-layout", "name": "A-layout", "color": "f7e101", "default": false, "description": "Area: Memory layout of types"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 14, "created_at": "2022-08-23T22:54:27Z", "updated_at": "2022-11-03T17:47:43Z", "closed_at": "2022-11-03T17:47:43Z", "author_association": "NONE", "active_lock_reason": null, "body": "Sometimes boxing a generated Future causes the value to be (unnecessarily?) copied. This can be worked around by wrapping the call to `Box::new`.\r\n\r\nCode:\r\n\r\n```rust\r\nuse std::future::ready;\r\nuse std::mem;\r\n\r\nstruct Foo {}\r\n\r\nimpl Drop for Foo {\r\n    fn drop(&mut self) {\r\n        println!(\"foo\");\r\n    }\r\n}\r\n\r\nasync fn func1() {\r\n    let _f = Foo {};\r\n    let mut buf = [0u8; 16_384];\r\n    buf[0] = 42;\r\n    ready(()).await;\r\n    println!(\"{}\", buf[0]);\r\n}\r\n\r\nfn _box_new<T>(x: T) -> Box<T> {\r\n    Box::new(x)\r\n}\r\n\r\nfn take<T>(v: T) {\r\n    println!(\"{}\", mem::size_of_val(&v));\r\n}\r\n\r\nfn main() {\r\n    take(Box::new(func1()));\r\n    //take(_box_new(func1()));\r\n}\r\n```\r\n\r\nAsm contains a ~16k memcpy:\r\n\r\n```\r\n$ rustc -O --edition 2021 --emit asm boxcopybug.rs && grep -B 3 memcpy boxcopybug.s\r\n        leaq    32(%rsp), %rsi\r\n        movl    $16386, %edx\r\n        movq    %rax, %rdi\r\n        callq   *memcpy@GOTPCREL(%rip)\r\n```\r\n\r\nIn main, if you comment out the first line and uncomment the second, the memcpy goes away, even though the code is nearly identical. I'd expect both ways to compile down the same.\r\n\r\n`Box::pin` is similarly affected.\r\n\r\nThe behavior is present in the latest stable and nightly.\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.63.0 (4b91a6ea7 2022-08-08)\r\nbinary: rustc\r\ncommit-hash: 4b91a6ea7258a947e59c6522cd5898e7c0a6a88f\r\ncommit-date: 2022-08-08\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.63.0\r\nLLVM version: 14.0.5\r\n```", "closed_by": {"login": "jkarneges", "id": 521953, "node_id": "MDQ6VXNlcjUyMTk1Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/521953?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jkarneges", "html_url": "https://github.com/jkarneges", "followers_url": "https://api.github.com/users/jkarneges/followers", "following_url": "https://api.github.com/users/jkarneges/following{/other_user}", "gists_url": "https://api.github.com/users/jkarneges/gists{/gist_id}", "starred_url": "https://api.github.com/users/jkarneges/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jkarneges/subscriptions", "organizations_url": "https://api.github.com/users/jkarneges/orgs", "repos_url": "https://api.github.com/users/jkarneges/repos", "events_url": "https://api.github.com/users/jkarneges/events{/privacy}", "received_events_url": "https://api.github.com/users/jkarneges/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/100932/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/100932/timeline", "performed_via_github_app": null, "state_reason": "completed"}