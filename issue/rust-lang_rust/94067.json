{"url": "https://api.github.com/repos/rust-lang/rust/issues/94067", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/94067/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/94067/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/94067/events", "html_url": "https://github.com/rust-lang/rust/issues/94067", "id": 1140681257, "node_id": "I_kwDOAAsO6M5D_Wop", "number": 94067, "title": "MIR generation for generators considers any borrowed or assigned value as live across yield points", "user": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 171502053, "node_id": "MDU6TGFiZWwxNzE1MDIwNTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-borrow-checker", "name": "A-borrow-checker", "color": "f7e101", "default": false, "description": "Area: The borrow checker"}, {"id": 256133398, "node_id": "MDU6TGFiZWwyNTYxMzMzOTg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-mir", "name": "A-mir", "color": "f7e101", "default": false, "description": "Area: Mid-level IR (MIR) - https://blog.rust-lang.org/2016/04/19/MIR.html"}, {"id": 679846574, "node_id": "MDU6TGFiZWw2Nzk4NDY1NzQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-generators", "name": "A-generators", "color": "f7e101", "default": false, "description": "Area: Generators"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2022-02-16T23:10:42Z", "updated_at": "2023-04-26T04:16:05Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Consider an example such as this:\r\n\r\n```rust\r\nimpl Agent {\r\n    async fn handle(&mut self) {\r\n        let mut info = self.info_result.clone();\r\n        info.node = None;\r\n        let element = parse_info(info);\r\n        let _ = send_element(element).await;\r\n    }\r\n}\r\n\r\nfn parse_info(_: Info) -> Element { ... }\r\n\r\nfn foo(agent: Agent) {\r\n    assert_send(agent.handle());\r\n    //~^ cannot be sent between threads safely\r\n}\r\n```\r\n\r\nLet's assume `info` is `!Send`. The future returned from `handle` is currently `!Send` as well, because the MIR generation for the generator considers `info` to be live across the await point, despite the fact that `info` is consumed by `parse_info`. The reason is because the generator step [explicitly considers any borrowed local as live across the suspend point](https://cs.github.com/rust-lang/rust/blob/e646f3d2a9541952310778288854943678738ea9/compiler/rustc_mir_transform/src/generator.rs?q=locals_live_across_suspend_points++#L512).\r\n\r\nWith the more precise drop tracking in the type checker, it would be nice not to have to capture these at the MIR level. Currently drop tracking has to be more conservative than necessary in order to match the MIR behavior.\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/94067/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/94067/timeline", "performed_via_github_app": null, "state_reason": null}