{"url": "https://api.github.com/repos/rust-lang/rust/issues/53826", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/53826/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/53826/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/53826/events", "html_url": "https://github.com/rust-lang/rust/issues/53826", "id": 355636970, "node_id": "MDU6SXNzdWUzNTU2MzY5NzA=", "number": 53826, "title": "Refactor `validate_scalar` to take advantage of type information", "user": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 67766349, "node_id": "MDU6TGFiZWw2Nzc2NjM0OQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-mentor", "name": "E-mentor", "color": "02E10C", "default": false, "description": "Call for participation: This issue has a mentor. Use RustcContributor::new on Zulip for discussion."}, {"id": 900795185, "node_id": "MDU6TGFiZWw5MDA3OTUxODU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-const-eval", "name": "A-const-eval", "color": "f7e101", "default": false, "description": "Area: constant evaluation (mir interpretation)"}], "state": "closed", "locked": false, "assignee": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 7, "created_at": "2018-08-30T15:26:12Z", "updated_at": "2018-10-09T19:58:06Z", "closed_at": "2018-10-09T19:58:06Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Currently we have no way of detecting that\r\n\r\n```rust\r\n#![feature(const_raw_ptr_deref)]\r\n\r\nconst X: &i32 = unsafe { &*(8 as *const i32) };\r\n\r\nfn main() {}\r\n```\r\n\r\nis UB (an integer is not a valid safe address at compile-time as you can safely dereference it in another constant and then you'd get an error and UB if done at runtime.\r\n\r\nThe basic idea is to take the function at https://github.com/rust-lang/rust/blob/0e98621e69890d67d906a436a68436d03a3edb89/src/librustc_mir/interpret/validity.rs#L99 and split it into two parts\r\n\r\n* `validate_scalar_by_type` which first matches on the scalar's type and then decides how to operate on it\r\n    * the existing match should basically be pulled out and the correctness checks happen after one knows which type one is operating on\r\n    * new arm: `ty::Ref` can just use `to_ptr()` on the value and convert the error into a `validation_failure!` error (see how this is done elsewhere in the same file)\r\n        * do the pointer recursion only here\r\n* `validate_scalar_by_layout` which pretty much does everything else that the current `validate_scalar` does, minus the type checks and pointer recursion.\r\n* run `validate_scalar_by_layout` on *every* scalar (maybe [here?](https://github.com/rust-lang/rust/blob/0e98621e69890d67d906a436a68436d03a3edb89/src/librustc_mir/interpret/validity.rs#L252)), and not [just on leaf fields](https://github.com/rust-lang/rust/blob/0e98621e69890d67d906a436a68436d03a3edb89/src/librustc_mir/interpret/validity.rs#L286). This is necessary to catch `const FOO: NonZeroU8 = unsafe { NonZeroU8::new_unchecked(0) };` because right now we're just checking the field of `NonZeroU8`, which is `u8` and thus fine to be `0`.\r\n\r\ncc @RalfJung ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/53826/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/53826/timeline", "performed_via_github_app": null, "state_reason": "completed"}