{"url": "https://api.github.com/repos/rust-lang/rust/issues/85547", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/85547/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/85547/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/85547/events", "html_url": "https://github.com/rust-lang/rust/issues/85547", "id": 898033991, "node_id": "MDU6SXNzdWU4OTgwMzM5OTE=", "number": 85547, "title": "Generating documentation using fabricate fails during copy stage on Windows due to long destination paths", "user": {"login": "grossag", "id": 15199848, "node_id": "MDQ6VXNlcjE1MTk5ODQ4", "avatar_url": "https://avatars.githubusercontent.com/u/15199848?v=4", "gravatar_id": "", "url": "https://api.github.com/users/grossag", "html_url": "https://github.com/grossag", "followers_url": "https://api.github.com/users/grossag/followers", "following_url": "https://api.github.com/users/grossag/following{/other_user}", "gists_url": "https://api.github.com/users/grossag/gists{/gist_id}", "starred_url": "https://api.github.com/users/grossag/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/grossag/subscriptions", "organizations_url": "https://api.github.com/users/grossag/orgs", "repos_url": "https://api.github.com/users/grossag/repos", "events_url": "https://api.github.com/users/grossag/events{/privacy}", "received_events_url": "https://api.github.com/users/grossag/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 325438536, "node_id": "MDU6TGFiZWwzMjU0Mzg1MzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-bootstrap", "name": "T-bootstrap", "color": "bfd4f2", "default": false, "description": "Relevant to the bootstrap subteam: Rust's build system (x.py and src/bootstrap)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-05-21T13:15:43Z", "updated_at": "2023-04-27T03:48:07Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I am working on upgrading my company's build of rust from 1.41 to 1.52.1. I am finding that the Windows build is failing because fabricate is failing to copy a file.\r\n\r\nBuild root is: C:\\dev\\cayman_rust\\build\\w\r\n\r\nCommand output is:\r\n\r\n```\r\n08:39:38.450 python     INFO         Dist rustc-dev-1.52.1-dev-x86_64-pc-windows-msvc\r\n08:39:38.450 python     INFO         running: \"C:\\\\dev\\\\cayman_rust\\\\build\\\\w\\\\build\\\\x86_64-pc-windows-msvc\\\\stage0-tools-bin\\\\fabricate.exe\" \"generate\" \"--image-dir\" \"C:\\\\dev\\\\cayman_rust\\\\build\\\\w\\\\build\\\\tmp\\\\tarball\\\\rustc-dev\\\\x86_64-pc-windows-msvc\\\\image\" \"--component-name=rustc-dev\" \"--rel-manifest-dir=rustlib\" \"--legacy-manifest-dirs=rustlib,cargo\" \"--product-name=Rust\" \"--success-message=rustc-dev installed.\" \"--package-name=rustc-dev-1.52.1-dev-x86_64-pc-windows-msvc\" \"--non-installed-overlay\" \"C:\\\\dev\\\\cayman_rust\\\\build\\\\w\\\\build\\\\tmp\\\\tarball\\\\rustc-dev\\\\x86_64-pc-windows-msvc\\\\overlay\" \"--output-dir\" \"C:\\\\dev\\\\cayman_rust\\\\build\\\\w\\\\build\\\\dist\" \"--work-dir\" \"C:\\\\dev\\\\cayman_rust\\\\build\\\\w\\\\build\\\\tmp\\\\tarball\\\\rustc-dev\\\\x86_64-pc-windows-msvc\"\r\n08:39:38.825 python     INFO         Error: failed to generate installer\r\n08:39:38.825 python     INFO\r\n08:39:38.826 python     INFO         Caused by:\r\n08:39:38.826 python     INFO             0: failed to copy 'C:\\dev\\cayman_rust\\build\\w\\build\\tmp\\tarball\\rustc-dev\\x86_64-pc-windows-msvc\\image\\lib\\rustlib\\rustc-src\\rust\\compiler\\rustc_codegen_cranelift\\crate_patches\\0001-compiler-builtins-Remove-rotate_left-from-Int.patch' to 'C:\\dev\\cayman_rust\\build\\w\\build\\tmp\\tarball\\rustc-dev\\x86_64-pc-windows-msvc\\rustc-dev-1.52.1-dev-x86_64-pc-windows-msvc\\rustc-dev\\lib\\rustlib\\rustc-src\\rust\\compiler\\rustc_codegen_cranelift\\crate_patches\\0001-compiler-builtins-Remove-rotate_left-from-Int.patch'\r\n08:39:38.827 python     INFO             1: The system cannot find the path specified. (os error 3)\r\n```\r\n\r\nThe root cause is that the destination file name is longer than the Windows 260-character maximum path limit. This can be worked around in Windows using the methods in https://docs.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation?tabs=cmd which are both:\r\n1. Set a registry value on Win10 1607 or later (I have done this).\r\n2. Add a manifest entry to the process stating that it is long-path aware.\r\n\r\nI confirmed that the code that fails calls std::fs::copy which calls CopyFileExW. CopyFileExW is documented to be exempt from long path restrictions if the above two steps are followed. However, fabricate.exe does not have the manifest entry listed in #2.\r\n\r\nAs a result, I believe that the fix for this is to embed a manifest entry in fabricate.exe that has the following contents:\r\n\r\n```\r\n<application xmlns=\"urn:schemas-microsoft-com:asm.v3\">\r\n    <windowsSettings xmlns:ws2=\"http://schemas.microsoft.com/SMI/2016/WindowsSettings\">\r\n        <ws2:longPathAware>true</ws2:longPathAware>\r\n    </windowsSettings>\r\n</application>\r\n```\r\n\r\nI traced the build code to src/bootstrap/tool.rs but then couldn't find a good way to embed a manifest.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/85547/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/85547/timeline", "performed_via_github_app": null, "state_reason": null}