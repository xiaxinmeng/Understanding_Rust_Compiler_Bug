{"url": "https://api.github.com/repos/rust-lang/rust/issues/25155", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/25155/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/25155/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/25155/events", "html_url": "https://github.com/rust-lang/rust/issues/25155", "id": 73679257, "node_id": "MDU6SXNzdWU3MzY3OTI1Nw==", "number": 25155, "title": "libc's struct Stat is defined incorrectly on 64-bit FreeBSD", "user": {"login": "aidancully", "id": 503301, "node_id": "MDQ6VXNlcjUwMzMwMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/503301?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aidancully", "html_url": "https://github.com/aidancully", "followers_url": "https://api.github.com/users/aidancully/followers", "following_url": "https://api.github.com/users/aidancully/following{/other_user}", "gists_url": "https://api.github.com/users/aidancully/gists{/gist_id}", "starred_url": "https://api.github.com/users/aidancully/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aidancully/subscriptions", "organizations_url": "https://api.github.com/users/aidancully/orgs", "repos_url": "https://api.github.com/users/aidancully/repos", "events_url": "https://api.github.com/users/aidancully/events{/privacy}", "received_events_url": "https://api.github.com/users/aidancully/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2015-05-06T17:06:29Z", "updated_at": "2015-07-29T13:11:39Z", "closed_at": "2015-07-29T13:11:39Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "blksize_t on 64-bit FreeBSD is 32 bits, not 64.\n\n``` C\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <stdio.h>\n#include <stddef.h>\n\n#define pr_field_offset(field) \\\n  do { printf(# field \": %d\\n\", offsetof(struct stat, field)); } while (0)\n\nint main(int argc, char *argv[])\n{\n  printf(\"%d\\n\", sizeof(struct stat));\n  pr_field_offset(st_dev);\n  pr_field_offset(st_size);\n  pr_field_offset(st_blocks);\n  pr_field_offset(st_blksize);\n  pr_field_offset(st_flags);\n  pr_field_offset(st_gen);\n  pr_field_offset(st_birthtim);\n  return 0;\n}\n```\n\non FreeBSD x86_64 yields:\n\n```\n120\nst_dev: 0\nst_size: 72\nst_blocks: 80\nst_blksize: 88\nst_flags: 92\nst_gen: 96\nst_birthtim: 104\n```\n\n``` rust\n#![feature(libc)]\nextern crate libc;\n\nmacro_rules! containerof_field_offset {\n    ($container:ty : $field:ident) => (unsafe {\n        &(*(0usize as *const $container)).$field as *const _ as usize\n    })\n}\nmacro_rules! pr_field_offsets {\n  ( $( $field:ident ),* ) => (unsafe {\n    $(\n      println!(\"{}: {}\", stringify!($field), containerof_field_offset!(libc::stat : $field));\n    )*\n  })\n}\n\nfn main() {\n  println!(\"{}\", std::mem::size_of::<libc::stat>());\n  pr_field_offsets!(st_dev, st_ino, st_mode, st_nlink, st_uid, st_gid, st_rdev, st_atime, st_atime_nsec);\n  pr_field_offsets!(st_atime, st_atime_nsec, st_mtime, st_mtime_nsec, st_ctime, st_ctime_nsec);\n  pr_field_offsets!(st_size, st_blocks, st_blksize, st_flags, st_gen, st_lspare, st_birthtime, st_birthtime_nsec);\n  pr_field_offsets!(__unused);\n}\n```\n\nyields:\n\n```\n$ ./test\n136\nst_dev: 0\nst_ino: 4\nst_mode: 8\nst_nlink: 10\nst_uid: 12\nst_gid: 16\nst_rdev: 20\nst_atime: 24\nst_atime_nsec: 32\nst_atime: 24\nst_atime_nsec: 32\nst_mtime: 40\nst_mtime_nsec: 48\nst_ctime: 56\nst_ctime_nsec: 64\nst_size: 72\nst_blocks: 80\nst_blksize: 88\nst_flags: 96\nst_gen: 100\nst_lspare: 104\nst_birthtime: 112\nst_birthtime_nsec: 120\n__unused: 128\n```\n\nI tracked this down to the `blksize_t` type definition, which is unconditionally 32-bit on FreeBSD (see [here](https://svnweb.freebsd.org/base/release/10.1.0/sys/sys/_types.h?revision=274417&view=markup), noting this line:\n\n``` C\ntypedef __uint32_t      __blksize_t;    /* file block size */\n```\n\nthis is unconditionally the definition of `__blksize_t` on FreeBSD - whether on 32-bit or 64-bit platform.)\n", "closed_by": {"login": "dhuseby", "id": 5017470, "node_id": "MDQ6VXNlcjUwMTc0NzA=", "avatar_url": "https://avatars.githubusercontent.com/u/5017470?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dhuseby", "html_url": "https://github.com/dhuseby", "followers_url": "https://api.github.com/users/dhuseby/followers", "following_url": "https://api.github.com/users/dhuseby/following{/other_user}", "gists_url": "https://api.github.com/users/dhuseby/gists{/gist_id}", "starred_url": "https://api.github.com/users/dhuseby/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dhuseby/subscriptions", "organizations_url": "https://api.github.com/users/dhuseby/orgs", "repos_url": "https://api.github.com/users/dhuseby/repos", "events_url": "https://api.github.com/users/dhuseby/events{/privacy}", "received_events_url": "https://api.github.com/users/dhuseby/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/25155/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/25155/timeline", "performed_via_github_app": null, "state_reason": "completed"}