{"url": "https://api.github.com/repos/rust-lang/rust/issues/98201", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/98201/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/98201/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/98201/events", "html_url": "https://github.com/rust-lang/rust/issues/98201", "id": 1275115390, "node_id": "I_kwDOAAsO6M5MALd-", "number": 98201, "title": "compiler suggestions lead to more buggy code", "user": {"login": "ragdollfun", "id": 68953298, "node_id": "MDQ6VXNlcjY4OTUzMjk4", "avatar_url": "https://avatars.githubusercontent.com/u/68953298?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ragdollfun", "html_url": "https://github.com/ragdollfun", "followers_url": "https://api.github.com/users/ragdollfun/followers", "following_url": "https://api.github.com/users/ragdollfun/following{/other_user}", "gists_url": "https://api.github.com/users/ragdollfun/gists{/gist_id}", "starred_url": "https://api.github.com/users/ragdollfun/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ragdollfun/subscriptions", "organizations_url": "https://api.github.com/users/ragdollfun/orgs", "repos_url": "https://api.github.com/users/ragdollfun/repos", "events_url": "https://api.github.com/users/ragdollfun/events{/privacy}", "received_events_url": "https://api.github.com/users/ragdollfun/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 122406831, "node_id": "MDU6TGFiZWwxMjI0MDY4MzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-closures", "name": "A-closures", "color": "f7e101", "default": false, "description": "Area: closures (`|args| { .. }`)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1183099971, "node_id": "MDU6TGFiZWwxMTgzMDk5OTcx", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-suggestion-diagnostics", "name": "A-suggestion-diagnostics", "color": "f7e101", "default": false, "description": "Area: suggestions generated by the compiler applied by cargo fix"}, {"id": 1596299768, "node_id": "MDU6TGFiZWwxNTk2Mjk5NzY4", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-invalid-suggestion", "name": "D-invalid-suggestion", "color": "c9f7a3", "default": false, "description": "A structured suggestion resulting in incorrect code"}, {"id": 1624891239, "node_id": "MDU6TGFiZWwxNjI0ODkxMjM5", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-incorrect", "name": "D-incorrect", "color": "c9f7a3", "default": false, "description": "A diagnostic that is giving misleading or incorrect information"}], "state": "open", "locked": false, "assignee": {"login": "Ezrashaw", "id": 38062690, "node_id": "MDQ6VXNlcjM4MDYyNjkw", "avatar_url": "https://avatars.githubusercontent.com/u/38062690?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Ezrashaw", "html_url": "https://github.com/Ezrashaw", "followers_url": "https://api.github.com/users/Ezrashaw/followers", "following_url": "https://api.github.com/users/Ezrashaw/following{/other_user}", "gists_url": "https://api.github.com/users/Ezrashaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/Ezrashaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Ezrashaw/subscriptions", "organizations_url": "https://api.github.com/users/Ezrashaw/orgs", "repos_url": "https://api.github.com/users/Ezrashaw/repos", "events_url": "https://api.github.com/users/Ezrashaw/events{/privacy}", "received_events_url": "https://api.github.com/users/Ezrashaw/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "Ezrashaw", "id": 38062690, "node_id": "MDQ6VXNlcjM4MDYyNjkw", "avatar_url": "https://avatars.githubusercontent.com/u/38062690?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Ezrashaw", "html_url": "https://github.com/Ezrashaw", "followers_url": "https://api.github.com/users/Ezrashaw/followers", "following_url": "https://api.github.com/users/Ezrashaw/following{/other_user}", "gists_url": "https://api.github.com/users/Ezrashaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/Ezrashaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Ezrashaw/subscriptions", "organizations_url": "https://api.github.com/users/Ezrashaw/orgs", "repos_url": "https://api.github.com/users/Ezrashaw/repos", "events_url": "https://api.github.com/users/Ezrashaw/events{/privacy}", "received_events_url": "https://api.github.com/users/Ezrashaw/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2022-06-17T14:42:27Z", "updated_at": "2023-01-09T06:12:41Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "<!--\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\nalong with any information you feel relevant to replicating the bug.\n-->\n\nHello everyone !\n\nBefore I start, this bug report concerns the suggestions the compiler gives when code fails to compile and what happens when we blindly follow them, which is something someone new to the language or new to programming in general might be led to do.\n\nI tried this code:\n\n```rust\nfn iterator_array_fill<F, T, const N: usize>(a: &mut [T; N], a0: &T, f: F)\nwhere\n    T: Copy,\n    F: Fn(T) -> T {\n    let mut i: usize = 0;\n    for value in std::iter::successors(\n        Some(a0),\n        |x| Some(f(x))\n    ).take(N) {\n        a[i] = value;\n        i += 1;\n    }\n}\n\nfn main() {\n    const N: usize = 10;\n    let a0: f64 = 0.5;\n\n    let mut a = [0_f64; N];\n    iterator_array_fill(&mut a, &a0, |x| x * (1.0 - x));\n\n    println!(\"{:?}\", a);\n}\n```\n\nThis one doesn't compile and the right way to make it work is the following:\n\n```rust\nfn iterator_array_fill<F, T, const N: usize>(a: &mut [T; N], a0: &T, f: F)\nwhere\n    T: Copy,\n    F: Fn(T) -> T {\n    let mut i: usize = 0;\n    for value in std::iter::successors(\n        Some(*a0), // <-- HERE!\n        |x| Some(f(*x)) // <-- AND HERE!\n    ).take(N) {\n        a[i] = value;\n        i += 1;\n    }\n}\n\nfn main() {\n    const N: usize = 10;\n    let a0: f64 = 0.5;\n\n    let mut a = [0_f64; N];\n    iterator_array_fill(&mut a, &a0, |x| x * (1.0 - x));\n\n    println!(\"{:?}\", a);\n}\n```\n\nThe following is the error message output for the first code example:\n```\n> cargo run\n   Compiling bug_fill_array_with_iter v0.1.0\nerror[E0308]: mismatched types\n --> src\\main.rs:8:20\n  |\n1 | fn iterator_array_fill<F, T, const N: usize>(a: &mut [T; N], a0: &T, f: F)\n  |                           - this type parameter\n...\n8 |         |x| Some(f(x)) // works: |x| Some(f(*x))\n  |                    ^ expected type parameter `T`, found `&&T`\n  |\n  = note: expected type parameter `T`\n                  found reference `&&T`\nhelp: consider dereferencing the borrow\n  |\n8 |         |x| Some(f(**x)) // works: |x| Some(f(*x))\n  |                    ++\n\nerror[E0308]: mismatched types\n --> src\\main.rs:8:18\n  |\n1 | fn iterator_array_fill<F, T, const N: usize>(a: &mut [T; N], a0: &T, f: F)\n  |                           - this type parameter\n...\n8 |         |x| Some(f(x)) // works: |x| Some(f(*x))\n  |                  ^^^^\n  |                  |\n  |                  expected `&T`, found type parameter `T`\n  |                  help: consider borrowing here: `&f(x)`\n  |\n  = note:   expected reference `&T`\n          found type parameter `T`\n\nerror[E0308]: mismatched types\n  --> src\\main.rs:10:16\n   |\n1  | fn iterator_array_fill<F, T, const N: usize>(a: &mut [T; N], a0: &T, f: F)\n   |                           - this type parameter\n...\n10 |         a[i] = value;\n   |         ----   ^^^^^ expected type parameter `T`, found `&T`\n   |         |\n   |         expected due to the type of this binding\n   |\n   = note: expected type parameter `T`\n                   found reference `&T`\nhelp: consider dereferencing the borrow\n   |\n10 |         a[i] = *value;\n   |                +\n\nFor more information about this error, try `rustc --explain E0308`.\nerror: could not compile `bug_fill_array_with_iter` due to 3 previous errors\n```\n\nImplementing these suggestions leads to the following code:\n\n```rust\nfn iterator_array_fill<F, T, const N: usize>(a: &mut [T; N], a0: &T, f: F)\nwhere\n    T: Copy,\n    F: Fn(T) -> T {\n    let mut i: usize = 0;\n    for value in std::iter::successors(\n        Some(a0), // no changes even suggested\n        |x| Some(&f(**x)) // bad suggestions\n    ).take(N) {\n        a[i] = *value; // bad suggestion\n        i += 1;\n    }\n}\n\nfn main() {\n    const N: usize = 10;\n    let a0: f64 = 0.5;\n\n    let mut a = [0_f64; N];\n    iterator_array_fill(&mut a, &a0, |x| x * (1.0 - x));\n\n    println!(\"{:?}\", a);\n}\n```\n\nWhich gives the following compilation error:\n```\n> cargo run\n   Compiling bug_fill_array_with_iter v0.1.0\nerror[E0515]: cannot return value referencing temporary value\n --> src\\main.rs:8:13\n  |\n8 |         |x| Some(&f(**x)) // works: |x| Some(f(*x))\n  |             ^^^^^^------^\n  |             |     |\n  |             |     temporary value created here\n  |             returns a value referencing data owned by the current function\n\nFor more information about this error, try `rustc --explain E0515`.\nerror: could not compile `bug_fill_array_with_iter` due to previous error\n```\n\nFor which rustc doesn't even bother giving any suggestions. This is a very frustrating behavior for beginners and could potentially lead to people giving up on the language.\n\n\n`rustc --version --verbose`:\n```\n<version>\nrustc 1.61.0 (fe5b13d68 2022-05-18)\nbinary: rustc\ncommit-hash: fe5b13d681f25ee6474be29d748c65adcd91f69e\ncommit-date: 2022-05-18\nhost: x86_64-pc-windows-msvc\nrelease: 1.61.0\nLLVM version: 14.0.0\n```\n\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"Ezrashaw\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/98201/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/98201/timeline", "performed_via_github_app": null, "state_reason": null}