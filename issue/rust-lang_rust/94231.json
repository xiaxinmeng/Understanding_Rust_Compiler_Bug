{"url": "https://api.github.com/repos/rust-lang/rust/issues/94231", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/94231/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/94231/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/94231/events", "html_url": "https://github.com/rust-lang/rust/issues/94231", "id": 1146252358, "node_id": "I_kwDOAAsO6M5EUmxG", "number": 94231, "title": "Stacked borrows fails on `{ChunksMut,ChunksExactMut}::__iterator_get_unchecked()`", "user": {"login": "andylizi", "id": 12008103, "node_id": "MDQ6VXNlcjEyMDA4MTAz", "avatar_url": "https://avatars.githubusercontent.com/u/12008103?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andylizi", "html_url": "https://github.com/andylizi", "followers_url": "https://api.github.com/users/andylizi/followers", "following_url": "https://api.github.com/users/andylizi/following{/other_user}", "gists_url": "https://api.github.com/users/andylizi/gists{/gist_id}", "starred_url": "https://api.github.com/users/andylizi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andylizi/subscriptions", "organizations_url": "https://api.github.com/users/andylizi/orgs", "repos_url": "https://api.github.com/users/andylizi/repos", "events_url": "https://api.github.com/users/andylizi/events{/privacy}", "received_events_url": "https://api.github.com/users/andylizi/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2022-02-21T08:09:10Z", "updated_at": "2022-07-27T21:26:19Z", "closed_at": "2022-07-27T21:26:19Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "### Description\r\n\r\n```rust\r\nfn main() {\r\n    let mut arr1 = [0u8; 64];\r\n    let arr2 = [0u8; 64];\r\n    let mut iter = arr1.chunks_mut(8).zip(arr2.chunks(8));\r\n    while let Some((chunk1, chunk2)) = iter.next() {\r\n        dbg!(chunk2[0]);\r\n        dbg!(chunk1[0]);\r\n        iter.next();\r\n        dbg!(chunk2[0]);\r\n        dbg!(chunk1[0]);  // error here\r\n    }\r\n}\r\n```\r\n\r\nRunning this code in Miri will produce the following output:\r\n\r\n```\r\n[src\\main.rs:6] chunk2[0] = 0\r\n[src\\main.rs:7] chunk1[0] = 0\r\n[src\\main.rs:9] chunk2[0] = 0\r\nerror: Undefined Behavior: no item granting read access to tag <1832> at alloc906 found in borrow stack.\r\n  --> src\\main.rs:10:9\r\n   |\r\n10 |         dbg!(chunk1[0]);  // error here\r\n   |         ^^^^^^^^^^^^^^^ no item granting read access to tag <1832> at alloc906 found in borrow stack.\r\n   |\r\n   = help: this indicates a potential bug in the program: it performed an invalid operation, but the rules it violated are still experimental\r\n   = help: see https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md for further information\r\n```\r\n\r\n<details>\r\n<summary>\r\n\r\nWith `-Zmiri-track-pointer-tag=1832,1585,12319`\r\n\r\n</summary>\r\n\r\n```\r\nnote: tracking was triggered\r\n    --> \\library\\core\\src\\slice\\iter.rs:1564:19\r\n     |\r\n1564 |         Self { v: slice, chunk_size: size }\r\n     |                   ^^^^^ created tag 1585\r\n     |\r\n     = note: inside `std::slice::ChunksMut::<u8>::new` at \\library\\core\\src\\slice\\iter.rs:1564:19\r\n     = note: inside `core::slice::<impl [u8]>::chunks_mut` at \\library\\core\\src\\slice\\mod.rs:828:9\r\nnote: inside `main` at src\\main.rs:4:20\r\n    --> src\\main.rs:4:20\r\n     |\r\n4    |     let mut iter = arr1.chunks_mut(8).zip(arr2.chunks(8));\r\n     |                    ^^^^^^^^^^^^^^^^^^\r\n\r\nnote: tracking was triggered\r\n --> src\\main.rs:5:21\r\n  |\r\n5 |     while let Some((chunk1, chunk2)) = iter.next() {\r\n  |                     ^^^^^^ created tag 1832\r\n  |\r\n  = note: inside `main` at src\\main.rs:5:21\r\n\r\n[src\\main.rs:6] chunk2[0] = 0\r\n[src\\main.rs:7] chunk1[0] = 0\r\n\r\nnote: tracking was triggered\r\n    --> \\library\\core\\src\\slice\\iter.rs:1641:32\r\n     |\r\n1641 |             let len = cmp::min(self.v.len().unchecked_sub(start), self.chunk_size);\r\n     |                                ^^^^^^^^^^^^ popped tracked tag for item [Unique for <1832>] due to Read access for <1585>\r\n     |\r\n     = note: inside `<std::slice::ChunksMut<u8> as std::iter::Iterator>::__iterator_get_unchecked` at \\library\\core\\src\\slice\\iter.rs:1641:32\r\n     = note: inside `<std::iter::Zip<std::slice::ChunksMut<u8>, std::slice::Chunks<u8>> as std::iter::adapters::zip::ZipImpl<std::slice::ChunksMut<u8>, std::slice::Chunks<u8>>>::next` at \\library\\core\\src\\iter\\adapters\\zip.rs:278:23\r\n     = note: inside `<std::iter::Zip<std::slice::ChunksMut<u8>, std::slice::Chunks<u8>> as std::iter::Iterator>::next` at \\library\\core\\src\\iter\\adapters\\zip.rs:84:9\r\n    --> \\library\\core\\src\\slice\\iter.rs:1642:32\r\n     |\r\n1642 |             from_raw_parts_mut(self.v.as_mut_ptr().add(start), len)\r\n     |                                ^^^^^^^^^^^^^^^^^^^ created tag 12319\r\n     |\r\n     = note: inside `<std::slice::ChunksMut<u8> as std::iter::Iterator>::__iterator_get_unchecked` at \\library\\core\\src\\slice\\iter.rs:1642:32\r\n    --> \\library\\core\\src\\slice\\mod.rs:483:5\r\n      |\r\n  483 | /     pub const fn as_mut_ptr(&mut self) -> *mut T {\r\n  484 | |         self as *mut [T] as *mut T\r\n  485 | |     }\r\n      | |_____^ popped tracked tag for item [Disabled for <1832>] due to Write access for <12319>\r\n      |\r\n      = note: inside `core::slice::<impl [u8]>::as_mut_ptr` at \\library\\core\\src\\slice\\mod.rs:483:5\r\n      = note: inside `<std::slice::ChunksMut<u8> as std::iter::Iterator>::__iterator_get_unchecked` at \\library\\core\\src\\slice\\iter.rs:1642:32\r\n     note: inside `main` at src\\main.rs:8:9\r\n    --> src\\main.rs:8:9\r\n     |\r\n8    |         iter.next();\r\n     |         ^^^^^^^^^^^\r\n     = note\r\n\r\n[src\\main.rs:9] chunk2[0] = 0\r\n\r\nerror: Undefined Behavior: no item granting read access to tag <1832> at alloc906 found in borrow stack.\r\n  --> src\\main.rs:10:9\r\n   |\r\n10 |         dbg!(chunk1[0]);  // error here\r\n   |         ^^^^^^^^^^^^^^^ no item granting read access to tag <1832> at alloc906 found in borrow stack.\r\n   |\r\n   = help: this indicates a potential bug in the program: it performed an invalid operation, but the rules it violated are still experimental\r\n   = help: see https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md for further information\r\n```\r\n\r\n</details>\r\n\r\nA few things to note here:\r\n\r\n1. Access to the mutable chunk will fail. For example `arr1.chunks(8).zip(arr2.chunks_mut(8))` will fail on `chunk2[0]` instead.\r\n2. `zip()` is required. This is probably due to `Zip` uses `__iterator_get_unchecked()` internally rather than `next()`.\r\n3. `chunks_mut()` and `chunks_exact_mut()` can both reproduce.\r\n4. `array_chunks_mut()` can't reproduce.\r\n\r\n### Environment\r\n\r\n```\r\n$ rustc --version --verbose\r\nrustc 1.61.0-nightly (45e2c2881 2022-02-20)\r\nbinary: rustc\r\ncommit-hash: 45e2c2881d11324d610815bfff097e25c412199e\r\ncommit-date: 2022-02-20\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.61.0-nightly\r\nLLVM version: 14.0.0\r\n\r\n$ cargo miri --version\r\nmiri 0.1.0 (0db4090 2022-02-12)\r\n```", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/94231/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/94231/timeline", "performed_via_github_app": null, "state_reason": "completed"}