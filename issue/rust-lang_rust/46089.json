{"url": "https://api.github.com/repos/rust-lang/rust/issues/46089", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/46089/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/46089/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/46089/events", "html_url": "https://github.com/rust-lang/rust/issues/46089", "id": 275123507, "node_id": "MDU6SXNzdWUyNzUxMjM1MDc=", "number": 46089, "title": "Option containing heap drop types in static mut acts strangley", "user": {"login": "Ryan1729", "id": 2133026, "node_id": "MDQ6VXNlcjIxMzMwMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2133026?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Ryan1729", "html_url": "https://github.com/Ryan1729", "followers_url": "https://api.github.com/users/Ryan1729/followers", "following_url": "https://api.github.com/users/Ryan1729/following{/other_user}", "gists_url": "https://api.github.com/users/Ryan1729/gists{/gist_id}", "starred_url": "https://api.github.com/users/Ryan1729/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Ryan1729/subscriptions", "organizations_url": "https://api.github.com/users/Ryan1729/orgs", "repos_url": "https://api.github.com/users/Ryan1729/repos", "events_url": "https://api.github.com/users/Ryan1729/events{/privacy}", "received_events_url": "https://api.github.com/users/Ryan1729/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2017-11-19T01:16:37Z", "updated_at": "2017-11-19T09:54:34Z", "closed_at": "2017-11-19T03:55:20Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The following code use the recently stabilized, (but not in the current stable release yet,) feature [`drop_types_in_const`](https://github.com/rust-lang/rust/pull/44456), so it needs a recent nightly version to be compiled.\r\n\r\n```rust\r\nstruct Foo {\r\n    bar: String,\r\n}\r\n\r\nstatic mut FOO: Option<Foo> = None;\r\n\r\nfn main() {\r\n    unsafe {\r\n        FOO = Some(std::mem::zeroed());\r\n    }\r\n    if let Some(_) = unsafe { FOO.as_mut() } {\r\n        println!(\"Some(Foo)\");\r\n    } else {\r\n        println!(\"None\");\r\n    }\r\n}\r\n```\r\n\r\nThis prints out \"None\", instead of the expected \"Some(Foo)\". However, if I change `FOO = Some(std::mem::zeroed());` to `FOO = Some(std::mem::uninitialized());` then it prints \"Some(Foo)\", (at least on my system, but that could clearly be just \"luck\".) The assignment also works as expected if I explicitly initialize `FOO`, that is, something like `FOO = Some(\"Hello World!\".to_string());`, or if I use a non-drop type. If I use a different built-in drop type than `String`, like `Vec<u32>` or `Box<u32>` then it still prints \"None\". However, if I define my own stack-allocated drop type like so:\r\n\r\n```rust\r\nstruct Baz{\r\n    qux: u32\r\n}\r\n\r\nimpl Drop for Baz {\r\n    fn drop(&mut self) {}\r\n}\r\n```\r\n\r\nand make `bar` an zeroed instance of that type then it prints \"Some(Foo)\".\r\n", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/46089/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/46089/timeline", "performed_via_github_app": null, "state_reason": "completed"}