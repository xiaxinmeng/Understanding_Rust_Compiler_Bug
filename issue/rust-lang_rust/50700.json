{"url": "https://api.github.com/repos/rust-lang/rust/issues/50700", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/50700/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/50700/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/50700/events", "html_url": "https://github.com/rust-lang/rust/issues/50700", "id": 322547885, "node_id": "MDU6SXNzdWUzMjI1NDc4ODU=", "number": 50700, "title": "Tokens in an attribute macro receive wrong spacing", "user": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 632573348, "node_id": "MDU6TGFiZWw2MzI1NzMzNDg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-macros-2.0", "name": "A-macros-2.0", "color": "f7e101", "default": false, "description": "Area: declarative macros 2.0, https://github.com/rust-lang/rust/issues/39412"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-05-12T22:35:13Z", "updated_at": "2018-05-22T06:54:48Z", "closed_at": "2018-05-22T06:54:48Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Originally reported by @CodeSandwich as https://github.com/dtolnay/syn/issues/425.\r\n\r\nWe are seeing a functionlike procedural macro invocation `m![< -]` receive the expected spacing (Alone for both tokens) but preprocessing the same input with an attribute macro `#[attribute] m![< -]` receives incorrect spacing -- Joint for the `<` token even though it is followed by whitespace. Strangely using parentheses appears to fix the spacing so that `#[attribute] m!(< -)` correctly has Alone for both tokens.\r\n\r\n### Repro script\r\n\r\n```sh\r\n#!/bin/sh\r\n\r\ncargo new --lib repro\r\ncargo new --lib repro_macros\r\n\r\necho >repro/src/main.rs '\r\n#![feature(proc_macro)]\r\n\r\nextern crate repro_macros;\r\nuse repro_macros::{tokens, nothing};\r\n\r\n// alone + alone\r\ntokens![< -];\r\n\r\n// joint + alone\r\n#[nothing]\r\nasdf![< -];\r\n\r\n// alone + alone\r\n#[nothing]\r\nasdf!(< -);\r\n\r\nfn main() {}\r\n'\r\n\r\necho >>repro/Cargo.toml '\r\nrepro_macros = { path = \"../repro_macros\" }\r\n'\r\n\r\necho >repro_macros/src/lib.rs '\r\n#![feature(proc_macro)]\r\n\r\nextern crate proc_macro;\r\nuse proc_macro::TokenStream;\r\n\r\n#[proc_macro]\r\npub fn tokens(input: TokenStream) -> TokenStream {\r\n    println!(\"{:#?}\", input);\r\n    TokenStream::empty()\r\n}\r\n\r\n#[proc_macro_attribute]\r\npub fn nothing(_: TokenStream, input: TokenStream) -> TokenStream {\r\n    println!(\"{:#?}\", input);\r\n    TokenStream::empty()\r\n}\r\n'\r\n\r\necho >>repro_macros/Cargo.toml '\r\n[lib]\r\nproc-macro = true\r\n'\r\n\r\ncargo build --manifest-path repro/Cargo.toml\r\n```\r\n\r\n<details><summary>Output</summary>\r\n\r\n```\r\nTokenStream [\r\n    Op {\r\n        op: '<',\r\n        spacing: Alone,\r\n        span: #0 bytes(116..117)\r\n    },\r\n    Op {\r\n        op: '-',\r\n        spacing: Alone,\r\n        span: #0 bytes(118..119)\r\n    }\r\n]\r\nTokenStream [\r\n    Term {\r\n        sym: asdf,\r\n        span: #0 bytes(7615976..7615980)\r\n    },\r\n    Op {\r\n        op: '!',\r\n        spacing: Alone,\r\n        span: #0 bytes(0..0)\r\n    },\r\n    Group {\r\n        delimiter: Parenthesis,\r\n        stream: TokenStream [\r\n            Op {\r\n                op: '<',\r\n                spacing: Joint,\r\n                span: #0 bytes(0..0)\r\n            },\r\n            Op {\r\n                op: '-',\r\n                spacing: Alone,\r\n                span: #0 bytes(0..0)\r\n            }\r\n        ],\r\n        span: #0 bytes(0..0)\r\n    },\r\n    Op {\r\n        op: ';',\r\n        spacing: Alone,\r\n        span: #0 bytes(0..0)\r\n    }\r\n]\r\nTokenStream [\r\n    Term {\r\n        sym: asdf,\r\n        span: #0 bytes(192..196)\r\n    },\r\n    Op {\r\n        op: '!',\r\n        spacing: Alone,\r\n        span: #0 bytes(196..197)\r\n    },\r\n    Group {\r\n        delimiter: Parenthesis,\r\n        stream: TokenStream [\r\n            Op {\r\n                op: '<',\r\n                spacing: Alone,\r\n                span: #0 bytes(198..199)\r\n            },\r\n            Op {\r\n                op: '-',\r\n                spacing: Alone,\r\n                span: #0 bytes(200..201)\r\n            }\r\n        ],\r\n        span: #0 bytes(197..202)\r\n    },\r\n    Op {\r\n        op: ';',\r\n        spacing: Alone,\r\n        span: #0 bytes(202..203)\r\n    }\r\n]\r\n```\r\n</details>\r\n\r\n<br>\r\n\r\n@alexcrichton ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/50700/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/50700/timeline", "performed_via_github_app": null, "state_reason": "completed"}