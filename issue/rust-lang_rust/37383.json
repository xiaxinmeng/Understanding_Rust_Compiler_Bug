{"url": "https://api.github.com/repos/rust-lang/rust/issues/37383", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/37383/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/37383/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/37383/events", "html_url": "https://github.com/rust-lang/rust/issues/37383", "id": 184977169, "node_id": "MDU6SXNzdWUxODQ5NzcxNjk=", "number": 37383, "title": "Document work-around for move closures and mutable bindings...", "user": {"login": "GordonBGood", "id": 10696269, "node_id": "MDQ6VXNlcjEwNjk2MjY5", "avatar_url": "https://avatars.githubusercontent.com/u/10696269?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GordonBGood", "html_url": "https://github.com/GordonBGood", "followers_url": "https://api.github.com/users/GordonBGood/followers", "following_url": "https://api.github.com/users/GordonBGood/following{/other_user}", "gists_url": "https://api.github.com/users/GordonBGood/gists{/gist_id}", "starred_url": "https://api.github.com/users/GordonBGood/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GordonBGood/subscriptions", "organizations_url": "https://api.github.com/users/GordonBGood/orgs", "repos_url": "https://api.github.com/users/GordonBGood/repos", "events_url": "https://api.github.com/users/GordonBGood/events{/privacy}", "received_events_url": "https://api.github.com/users/GordonBGood/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 431251592, "node_id": "MDU6TGFiZWw0MzEyNTE1OTI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-docs", "name": "A-docs", "color": "f7e101", "default": false, "description": "Area: documentation for any part of the project, including the compiler, standard library, and tools"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2016-10-24T23:02:34Z", "updated_at": "2017-03-23T17:16:34Z", "closed_at": "2017-03-23T17:16:34Z", "author_association": "NONE", "active_lock_reason": null, "body": "In the Book Section 4.23 Closures, the \"move closures\" portion demonstrates clearly how mutability is not transferred back to the captured mutable variable.  However, nowhere easily accessible is it explained that there is a work around for this by making the binding a `Rc<RefCell<T>>` instead of a `mut T`, thereby giving it internal mutability instead of external (a requirement of using Rc which contents would otherwise be treated as immutable) and thus allowing both the external binding and the binding captured by the closure to refer to and change the same data since that is what `Rc` does - wrap a reference to data in a reference-counted structure stored on the heap.\r\n\r\nThe following example if added would demonstrate this:\r\n\r\n```\r\nuse std::rc::Rc;\r\nuse std::cell::RefCell;\r\n\r\nlet num = Rc::new(RefCell::new(5));\r\n\r\nlet num_copy = num.clone();\r\nlet add_num = move |x: i32| *num_copy.borrow_mut() += x;\r\n\r\nadd_num(5);\r\n\r\nassert_eq!(10, *num.borrow());\r\n```\r\n\r\nIt should be mentioned that `Cell` can be used instead of `RefCell` if the data type is `Copy`able as it is here for the primitive type and perhaps that also could be demonstrated using `get()` and `set()` instead of `borrow()`, `borrow_mut`, and the reference operator `*`\r\n\r\nIt should also be mentioned that for multi-threaded use `Arc` needs to be used instead of `Rc` and that the  data needs to be protected by `Mutex`'es or `RWLock`'s when necessary to prevent reading of partially updated data.\r\n\r\nThis allows one to implement algorithms requiring recursive variables where the current or the future (for use in thunks) values of the data are used in further calculations.\r\n\r\nI spent quite a few hours in research before coming up with this trick, but now realize that others already know how to do this; I think it should be generally immediately known.\r\n", "closed_by": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/37383/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/37383/timeline", "performed_via_github_app": null, "state_reason": "completed"}