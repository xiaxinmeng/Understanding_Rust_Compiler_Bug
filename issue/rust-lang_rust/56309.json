{"url": "https://api.github.com/repos/rust-lang/rust/issues/56309", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/56309/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/56309/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/56309/events", "html_url": "https://github.com/rust-lang/rust/issues/56309", "id": 385250970, "node_id": "MDU6SXNzdWUzODUyNTA5NzA=", "number": 56309, "title": "rust-lld links WebAssembly imports during compilation", "user": {"login": "PiotrSikora", "id": 190297, "node_id": "MDQ6VXNlcjE5MDI5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/190297?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PiotrSikora", "html_url": "https://github.com/PiotrSikora", "followers_url": "https://api.github.com/users/PiotrSikora/followers", "following_url": "https://api.github.com/users/PiotrSikora/following{/other_user}", "gists_url": "https://api.github.com/users/PiotrSikora/gists{/gist_id}", "starred_url": "https://api.github.com/users/PiotrSikora/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PiotrSikora/subscriptions", "organizations_url": "https://api.github.com/users/PiotrSikora/orgs", "repos_url": "https://api.github.com/users/PiotrSikora/repos", "events_url": "https://api.github.com/users/PiotrSikora/events{/privacy}", "received_events_url": "https://api.github.com/users/PiotrSikora/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 474645165, "node_id": "MDU6TGFiZWw0NzQ2NDUxNjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-wasm", "name": "O-wasm", "color": "6e6ec0", "default": false, "description": "Target: WASM (WebAssembly), http://webassembly.org/"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-11-28T12:43:23Z", "updated_at": "2019-12-20T19:43:06Z", "closed_at": "2019-12-20T19:43:06Z", "author_association": "NONE", "active_lock_reason": null, "body": "It appears that `rust-lld` links WebAssembly imports during compilation, even though they should be only imported at runtime.\r\n\r\n### Code\r\n```\r\n#[link(wasm_import_module = \"test\")]\r\nextern \"C\" {\r\n    fn log(message_data: u32, message_size: u32);\r\n}\r\n\r\n#[no_mangle]\r\npub fn main() {\r\n    let message = \"Hello, world!\";\r\n    unsafe {\r\n        log(message.as_ptr() as u32, message.len() as u32);\r\n    }\r\n}\r\n```\r\n\r\n### Cargo (stable)\r\nBuild succeeds:\r\n```\r\n$ cargo build --target=wasm32-unknown-unknown --release --verbose\r\n   Compiling wasm-log v0.0.1 (/home/piotrsikora/wasm-log)\r\n     Running `rustc --crate-name wasm_log src/lib.rs --color always --crate-type cdylib --emit=dep-info,link -C opt-level=3 -C panic=abort -C lto -C metadata=974cbcc98065209d --out-dir /home/piotrsikora/wasm-log/target/wasm32-unknown-unknown/release/deps --target wasm32-unknown-unknown -L dependency=/home/piotrsikora/wasm-log/target/wasm32-unknown-unknown/release/deps -L dependency=/home/piotrsikora/wasm-log/target/release/deps`\r\n    Finished release [optimized] target(s) in 0.49s\r\n```\r\nbut there are no imports in the compiled WASM module:\r\n```\r\n$ wasm-dis target/wasm32-unknown-unknown/release/wasm_log.wasm | grep import\r\n<empty>\r\n```\r\nand it actually inlines _some_ `log()` function (probably from `compiler-builtins`).\r\n\r\n### Cargo (nightly)\r\nBuild fails due to a conflict between WebAssembly import (`test.log`) and `compiler-builtins`'s `log()`:\r\n```\r\n$ cargo +nightly build --target=wasm32-unknown-unknown --release --verbose\r\n   Compiling wasm-log v0.0.1 (/home/piotrsikora/wasm-log)\r\n     Running `rustc --crate-name wasm_log src/lib.rs --color always --crate-type cdylib --emit=dep-info,link -C opt-level=3 -C panic=abort -C lto -C metadata=974cbcc98065209d --out-dir /home/piotrsikora/wasm-log/target/wasm32-unknown-unknown/release/deps --target wasm32-unknown-unknown -L dependency=/home/piotrsikora/wasm-log/target/wasm32-unknown-unknown/release/deps -L dependency=/home/piotrsikora/wasm-log/target/release/deps`\r\nerror: linking with `rust-lld` failed: exit code: 1\r\n  |\r\n  = note: \"rust-lld\" \"-flavor\" \"wasm\" \"-L\" \"/home/piotrsikora/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib\" \"/home/piotrsikora/wasm-log/target/wasm32-unknown-unknown/release/deps/wasm_log.wasm_log.ch5ijyk4-cgu.0.rcgu.o\" \"-o\" \"/home/piotrsikora/wasm-log/target/wasm32-unknown-unknown/release/deps/wasm_log.wasm\" \"--export\" \"main\" \"--gc-sections\" \"-O3\" \"-L\" \"/home/piotrsikora/wasm-log/target/wasm32-unknown-unknown/release/deps\" \"-L\" \"/home/piotrsikora/wasm-log/target/release/deps\" \"-L\" \"/home/piotrsikora/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib\" \"/home/piotrsikora/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/libcompiler_builtins-e275954395f12431.rlib\" \"--no-threads\" \"-z\" \"stack-size=1048576\" \"--stack-first\" \"--allow-undefined\" \"--no-entry\" \"--export-table\" \"--fatal-warnings\"\r\n  = note: rust-lld: error: function signature mismatch: log\r\n          >>> defined as (I32, I32) -> void in /home/piotrsikora/wasm-log/target/wasm32-unknown-unknown/release/deps/wasm_log.wasm_log.ch5ijyk4-cgu.0.rcgu.o\r\n          >>> defined as (F64) -> F64 in /home/piotrsikora/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/wasm32-unknown-unknown/lib/libcompiler_builtins-e275954395f12431.rlib(compiler_builtins-e275954395f12431.compiler_builtins.2709pw9r-cgu.0.rcgu.o)\r\n\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: Could not compile `wasm-log`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name wasm_log src/lib.rs --color always --crate-type cdylib --emit=dep-info,link -C opt-level=3 -C panic=abort -C lto -C metadata=974cbcc98065209d --out-dir /home/piotrsikora/wasm-log/target/wasm32-unknown-unknown/release/deps --target wasm32-unknown-unknown -L dependency=/home/piotrsikora/wasm-log/target/wasm32-unknown-unknown/release/deps -L dependency=/home/piotrsikora/wasm-log/target/release/deps` (exit code: 1)\r\n```\r\n\r\n### Workaround\r\nSimply changing the function name, either directly or by using `#[link_name = \"xlog\"]`, to avoid the conflict works around the issue, but that's obviously far from perfect.\r\n```\r\n#[link(wasm_import_module = \"test\")]\r\nextern \"C\" {\r\n    #[link_name = \"xlog\"]\r\n    fn log(message_data: u32, message_size: u32);\r\n}\r\n\r\n#[no_mangle]\r\npub fn main() {\r\n    let message = \"Hello, world!\";\r\n    unsafe {\r\n        log(message.as_ptr() as u32, message.len() as u32);\r\n    }\r\n}\r\n```\r\n```\r\n$ cargo +nightly build --target=wasm32-unknown-unknown --release --verbose\r\n   Compiling wasm-log v0.0.1 (/home/piotrsikora/wasm-log)\r\n     Running `rustc --crate-name wasm_log src/lib.rs --color always --crate-type cdylib --emit=dep-info,link -C opt-level=3 -C panic=abort -C lto -C metadata=974cbcc98065209d --out-dir /home/piotrsikora/wasm-log/target/wasm32-unknown-unknown/release/deps --target wasm32-unknown-unknown -L dependency=/home/piotrsikora/wasm-log/target/wasm32-unknown-unknown/release/deps -L dependency=/home/piotrsikora/wasm-log/target/release/deps`\r\n    Finished release [optimized] target(s) in 0.36s\r\n```\r\n```\r\n$ wasm-dis target/wasm32-unknown-unknown/release/wasm_log.wasm | grep import\r\n (import \"test\" \"xlog\" (func $xlog (param i32 i32)))\r\n```\r\n\r\n### Version info\r\n```\r\n$ rustc --version --verbose\r\nrustc 1.30.1 (1433507eb 2018-11-07)\r\nbinary: rustc\r\ncommit-hash: 1433507eba7d1a114e4c6f27ae0e1a74f60f20de\r\ncommit-date: 2018-11-07\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.30.1\r\nLLVM version: 8.0\r\n```\r\n```\r\n$ rustc +nightly --version --verbose\r\nrustc 1.32.0-nightly (6acbb5b65 2018-11-25)\r\nbinary: rustc\r\ncommit-hash: 6acbb5b65c06d82c867a94c54ce51dab4707ac61\r\ncommit-date: 2018-11-25\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.32.0-nightly\r\nLLVM version: 8.0\r\n```", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/56309/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/56309/timeline", "performed_via_github_app": null, "state_reason": "completed"}