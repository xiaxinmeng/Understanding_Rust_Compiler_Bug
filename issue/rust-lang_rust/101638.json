{"url": "https://api.github.com/repos/rust-lang/rust/issues/101638", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/101638/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/101638/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/101638/events", "html_url": "https://github.com/rust-lang/rust/issues/101638", "id": 1368470136, "node_id": "I_kwDOAAsO6M5RkTJ4", "number": 101638, "title": "Codegen: outlined function inhibits optimizations on arrays", "user": {"login": "Ben-Lichtman", "id": 15235153, "node_id": "MDQ6VXNlcjE1MjM1MTUz", "avatar_url": "https://avatars.githubusercontent.com/u/15235153?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Ben-Lichtman", "html_url": "https://github.com/Ben-Lichtman", "followers_url": "https://api.github.com/users/Ben-Lichtman/followers", "following_url": "https://api.github.com/users/Ben-Lichtman/following{/other_user}", "gists_url": "https://api.github.com/users/Ben-Lichtman/gists{/gist_id}", "starred_url": "https://api.github.com/users/Ben-Lichtman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Ben-Lichtman/subscriptions", "organizations_url": "https://api.github.com/users/Ben-Lichtman/orgs", "repos_url": "https://api.github.com/users/Ben-Lichtman/repos", "events_url": "https://api.github.com/users/Ben-Lichtman/events{/privacy}", "received_events_url": "https://api.github.com/users/Ben-Lichtman/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2022-09-10T02:58:50Z", "updated_at": "2023-04-05T17:33:58Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried this code:\r\n\r\n```rust\r\n#![feature(bench_black_box)]\r\n\r\npub fn example() {\r\n    // 2 arrays are allocated on the stack (1024 bytes)\r\n    let mut a = [0u8; 512];\r\n    outlined_memset(&mut a, 1);\r\n    let a = a; // memcpy happens here\r\n    takes_array(&a);\r\n}\r\n\r\n#[inline(never)]\r\npub fn outlined_memset(dest: &mut [u8], value: u8) {\r\n\tdest.fill(value);\r\n}\r\n\r\npub fn takes_array(a: &[u8]) {\r\n    std::hint::black_box(a);\r\n}\r\n```\r\n\r\nI expected to see this happen:\r\nThe line `let a = a;` should be optimized away into nothing (or potentially even more could be optimized away).\r\n\r\nInstead, this happened:\r\nSpace for a second array is allocated on the stack and a memcpy is used to move one array into the other despite them being identical\r\n\r\nThe memcpy goes away if the outlined function is allowed to inline, or if the line containing the move is removed.\r\n\r\n[godbolt link](https://godbolt.org/z/MrM1o7MEx)\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.65.0-nightly (1d37ed661 2022-09-09)\r\nbinary: rustc\r\ncommit-hash: 1d37ed661a6922e7a167609b8cd7eb31e972b19b\r\ncommit-date: 2022-09-09\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.65.0-nightly\r\nLLVM version: 15.0.0\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/101638/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/101638/timeline", "performed_via_github_app": null, "state_reason": null}