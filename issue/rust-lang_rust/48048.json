{"url": "https://api.github.com/repos/rust-lang/rust/issues/48048", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/48048/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/48048/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/48048/events", "html_url": "https://github.com/rust-lang/rust/issues/48048", "id": 295059270, "node_id": "MDU6SXNzdWUyOTUwNTkyNzA=", "number": 48048, "title": "Broken MIR with generators", "user": {"login": "raviqqe", "id": 9584358, "node_id": "MDQ6VXNlcjk1ODQzNTg=", "avatar_url": "https://avatars.githubusercontent.com/u/9584358?v=4", "gravatar_id": "", "url": "https://api.github.com/users/raviqqe", "html_url": "https://github.com/raviqqe", "followers_url": "https://api.github.com/users/raviqqe/followers", "following_url": "https://api.github.com/users/raviqqe/following{/other_user}", "gists_url": "https://api.github.com/users/raviqqe/gists{/gist_id}", "starred_url": "https://api.github.com/users/raviqqe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/raviqqe/subscriptions", "organizations_url": "https://api.github.com/users/raviqqe/orgs", "repos_url": "https://api.github.com/users/raviqqe/repos", "events_url": "https://api.github.com/users/raviqqe/events{/privacy}", "received_events_url": "https://api.github.com/users/raviqqe/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 679846574, "node_id": "MDU6TGFiZWw2Nzk4NDY1NzQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-generators", "name": "A-generators", "color": "f7e101", "default": false, "description": "Area: Generators"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-02-07T09:14:13Z", "updated_at": "2018-02-10T22:40:47Z", "closed_at": "2018-02-10T22:40:47Z", "author_association": "NONE", "active_lock_reason": null, "body": "Similar to #44184 but I'm not sure if they have the same cause or not.\r\n\r\n```rust\r\n#![feature(generators)]\r\n\r\nfn main() {\r\n    let x = (|_| {},);\r\n\r\n    || {\r\n        let x = x;\r\n\r\n        x.0({\r\n            yield;\r\n        });\r\n    };\r\n}\r\n```\r\n\r\nBuild log:\r\n\r\n```\r\n> RUST_BACKTRACE=full cargo build               \r\n   Compiling rust-async-await-examples v0.1.0 (file:///home/raviqqe/src/github.com/raviqqe/rust-async-await-examples)\r\nerror: internal compiler error: librustc_mir/transform/generator.rs:495: Broken MIR: generator contains type &[closure@src/main.rs:4:14: 4:20] in MIR, but typeck only knows about {([closure@src/main.rs:4:14\r\n: 4:20],), ()}                                                                                                                                \r\n  --> src/main.rs:6:5                                                                                   \r\n   |                                                                                                                                             \r\n6  | /     || {                                                     \r\n7  | |         let x = x;                                                                                                     \r\n8  | |                                                                               \r\n9  | |         x.0({                                                                  \r\n10 | |             yield;                                                         \r\n11 | |         });                                                       \r\n12 | |     };                                                   \r\n   | |_____^                                                                                  \r\n                                           \r\nthread 'rustc' panicked at 'Box<Any>', librustc_errors/lib.rs:482:9\r\nstack backtrace:                                                             \r\n   0: 0xb0df70b3 - std::sys::unix::backtrace::tracing::imp::unwind_backtrace::h0e675f09d0ea6efb\r\n                       at libstd/sys/unix/backtrace/tracing/gcc_s.rs:49\r\n   1: 0xb0dee0d7 - std::sys_common::backtrace::_print::hab188ab7e2264fa5\r\n                       at libstd/sys_common/backtrace.rs:71\r\n   2: 0xb0df3b63 - std::panicking::default_hook::{{closure}}::h6de89401c7cfba88\r\n                       at libstd/sys_common/backtrace.rs:59\r\n                       at libstd/panicking.rs:380\r\n   3: 0xb0df37a3 - std::panicking::default_hook::h77c5e57344ea1784                                               \r\n                       at libstd/panicking.rs:396\r\n   4: 0xb0df402b - std::panicking::rust_panic_with_hook::h25665bb68f9c33fc                \r\n                       at libstd/panicking.rs:576\r\n   5: 0xb03f0eff - std::panicking::begin_panic::hf4ea98dd652225c7\r\n   6: 0xb03eb53b - rustc_errors::Handler::span_bug::he0e663394c58146e\r\n   7: 0xb042ddc3 - rustc::session::opt_span_bug_fmt::{{closure}}::haf4055a290286ee8\r\n   8: 0xb042dc97 - rustc::session::span_bug_fmt::hee67d12eca98dbd4\r\n   9: 0xb0531463 - <rustc_mir::transform::generator::StateTransform as rustc_mir::transform::MirPass>::run_pass::had9d05b7ba1db7f2\r\n  10: 0xb058f9c7 - rustc_mir::transform::optimized_mir::{{closure}}::h7ce2e52ae25ea6aa\r\n  11: 0xb053a543 - rustc_mir::transform::optimized_mir::h445785565316d102\r\n  12: 0xafe5977b - rustc::dep_graph::graph::DepGraph::with_task_impl::h3a29a7f629570871\r\n  13: 0xb010f97b - rustc::ty::maps::<impl rustc::ty::maps::queries::optimized_mir<'tcx>>::force::h7b56c39bb8303000\r\n  14: 0xb01100bf - rustc::ty::maps::<impl rustc::ty::maps::queries::optimized_mir<'tcx>>::try_get::h5633b7bfd050e56c\r\n  15: 0xb01f8aa3 - rustc::ty::maps::TyCtxtAt::optimized_mir::h25db50b902f2c8d6\r\n  16: 0xb01f618f - rustc::ty::maps::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'lcx>>::optimized_mir::h5882e75dd3b20368\r\n  17: 0xb0500c2b - rustc_mir::shim::make_shim::hc8d2a6409593d7a0\r\n  18: 0xafe6959b - rustc::dep_graph::graph::DepGraph::with_task_impl::h978a41a5ecd39563\r\n  19: 0xb013917b - rustc::ty::maps::<impl rustc::ty::maps::queries::mir_shims<'tcx>>::force::hb539e45b421eb998\r\n  20: 0xb0139a37 - rustc::ty::maps::<impl rustc::ty::maps::queries::mir_shims<'tcx>>::try_get::h89de7c175fc7a084\r\n  21: 0xb01f9a77 - rustc::ty::maps::TyCtxtAt::mir_shims::hfd281ebae9f5e7f2\r\n  22: 0xb0073247 - rustc::ty::<impl rustc::ty::context::TyCtxt<'a, 'gcx, 'tcx>>::instance_mir::h3beb5ac11f8f3252\r\n  23: 0xb057eb9b - rustc_mir::monomorphize::collector::collect_items_rec::hedb90edba41840ef\r\n  24: 0xb057f6f7 - rustc_mir::monomorphize::collector::collect_items_rec::hedb90edba41840ef\r\n  25: 0xb057d8a3 - rustc_mir::monomorphize::collector::collect_crate_mono_items::h6c068d30b04615ad\r\n  26: 0xac0f2bcb - rustc_trans::base::collect_and_partition_translation_items::he0b50da974cf616b\r\n  27: 0xafe53203 - rustc::dep_graph::graph::DepGraph::with_task_impl::h175249ac280b602a\r\n  28: 0xb01d60a3 - rustc::ty::maps::<impl rustc::ty::maps::queries::collect_and_partition_translation_items<'tcx>>::force::hc7f3cedff79b2e40\r\n  29: 0xb01d687f - rustc::ty::maps::<impl rustc::ty::maps::queries::collect_and_partition_translation_items<'tcx>>::try_get::hc14bee7a47d847cc\r\n  30: 0xb01fdb47 - rustc::ty::maps::TyCtxtAt::collect_and_partition_translation_items::hfe44aa4a7c757c20\r\n  31: 0xb01f725b - rustc::ty::maps::<impl rustc::ty::context::TyCtxt<'a, 'tcx, 'lcx>>::collect_and_partition_translation_items::h3b09465602c4412e\r\n  32: 0xac0ef0d3 - rustc_trans::base::trans_crate::h7d2492fa073d403b\r\n  33: 0xac14bb93 - <rustc_trans::LlvmTransCrate as rustc_trans_utils::trans_crate::TransCrate>::trans_crate::h0375a1b8d27d3d45\r\n  34: 0xb0f788cb - rustc_driver::driver::phase_4_translate_to_llvm::h1ef6b9e392ff1ffb\r\n  35: 0xb0f73133 - rustc_driver::driver::compile_input::{{closure}}::h0c654196b84b4f55\r\n  36: 0xb0f08637 - rustc::ty::context::TyCtxt::create_and_enter::h93711c24bd13b118\r\n  37: 0xb0f71833 - rustc_driver::driver::compile_input::hd3b772952eb5ec6d\r\n  38: 0xb0f88f4f - rustc_driver::run_compiler::hfc7537ef811b8b4e\r\n  39: 0xb0ebf447 - std::sys_common::backtrace::__rust_begin_short_backtrace::h12654191a5e25e74\r\n  40: 0xb0e085ef - __rust_maybe_catch_panic\r\n                       at libpanic_unwind/lib.rs:102\r\n  41: 0xb0ef5327 - <F as alloc::boxed::FnBox<A>>::call_box::h0c2113b4a6bfc4a2\r\n  42: 0xb0e01bb7 - std::sys::unix::thread::Thread::new::thread_start::hb2b6d7bbaa9b84de\r\n                       at /checkout/src/liballoc/boxed.rs:798\r\n                       at libstd/sys_common/thread.rs:24\r\n                       at libstd/sys/unix/thread.rs:90\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: rustc 1.25.0-nightly (29c8276ce 2018-02-07) running on armv7-unknown-linux-gnueabihf\r\n\r\nerror: Could not compile `rust-async-await-examples`.\r\n\r\nTo learn more, run the command again with --verbose.\r\n```\r\n\r\n## Workaround\r\n\r\nDefine a temporary variable explicitly.\r\n\r\n```rust\r\n#![feature(generators)]\r\n\r\nfn main() {\r\n    let x = (|_| {},);\r\n\r\n    || {\r\n        let x = x;\r\n\r\n        let f = x.0;\r\n\r\n        f({\r\n            yield;\r\n        });\r\n    };\r\n}\r\n```\r\n\r\n## Meta\r\n\r\n### `rustc --version --verbose`\r\n\r\n```\r\nrustc 1.25.0-nightly (29c8276ce 2018-02-07)\r\nbinary: rustc\r\ncommit-hash: 29c8276cee4a0eab7e0634ff25c6b47bd9f87c6c\r\ncommit-date: 2018-02-07\r\nhost: armv7-unknown-linux-gnueabihf\r\nrelease: 1.25.0-nightly\r\nLLVM version: 4.0\r\n```\r\n\r\n### `cat /etc/os-release`\r\n\r\n```\r\nNAME=\"Ubuntu\"\r\nVERSION=\"16.04.3 LTS (Xenial Xerus)\"\r\nID=ubuntu\r\nID_LIKE=debian\r\nPRETTY_NAME=\"Ubuntu 16.04.3 LTS\"\r\nVERSION_ID=\"16.04\"\r\nHOME_URL=\"http://www.ubuntu.com/\"\r\nSUPPORT_URL=\"http://help.ubuntu.com/\"\r\nBUG_REPORT_URL=\"http://bugs.launchpad.net/ubuntu/\"\r\nVERSION_CODENAME=xenial\r\nUBUNTU_CODENAME=xenial\r\n```\r\n\r\n### `uname -a`\r\n\r\n```\r\nLinux localhost 3.14.0 #1 SMP PREEMPT Mon Jan 8 23:10:11 PST 2018 armv7l GNU/Linux\r\n```", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/48048/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/48048/timeline", "performed_via_github_app": null, "state_reason": "completed"}