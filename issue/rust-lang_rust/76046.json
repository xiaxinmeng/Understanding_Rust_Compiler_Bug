{"url": "https://api.github.com/repos/rust-lang/rust/issues/76046", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/76046/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/76046/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/76046/events", "html_url": "https://github.com/rust-lang/rust/issues/76046", "id": 688417120, "node_id": "MDU6SXNzdWU2ODg0MTcxMjA=", "number": 76046, "title": "Removing `StringReader::retokenize`", "user": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37234, "node_id": "MDU6TGFiZWwzNzIzNA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-cleanup", "name": "C-cleanup", "color": "f5f1fd", "default": false, "description": "Category: PRs that clean code up or issues documenting cleanup."}, {"id": 27424086, "node_id": "MDU6TGFiZWwyNzQyNDA4Ng==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-parser", "name": "A-parser", "color": "f7e101", "default": false, "description": "Area: The parsing of Rust source code to an AST."}, {"id": 632580625, "node_id": "MDU6TGFiZWw2MzI1ODA2MjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-save-analysis", "name": "A-save-analysis", "color": "f7e101", "default": false, "description": "Area: saving results of analyses such as inference and borrowck results to a file."}], "state": "closed", "locked": false, "assignee": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 1, "created_at": "2020-08-29T00:16:55Z", "updated_at": "2020-08-30T02:36:25Z", "closed_at": "2020-08-30T02:36:25Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "`StringReader` contains a `retokenize` function, which allows to to, well, retokenize existing span:\r\n\r\nhttps://github.com/rust-lang/rust/blob/d006f5734f49625c34d6fc33bf6b9967243abca8/src/librustc_parse/lexer/mod.rs#L73-L88\r\n\r\nThere's only caller of this function:\r\n\r\nhttps://github.com/rust-lang/rust/blob/d006f5734f49625c34d6fc33bf6b9967243abca8/src/librustc_save_analysis/span_utils.rs#L46-L61\r\n\r\nAnd there's only one caller of that caller:\r\n\r\nhttps://github.com/rust-lang/rust/blob/d006f5734f49625c34d6fc33bf6b9967243abca8/src/librustc_save_analysis/dump_visitor.rs#L1202-L1212\r\n\r\nIn other words, the only reason why we need `StringReader::retokenize` is to get the span of `*` from `hir::Use` which happens to be a glob import. \r\n\r\n(\r\nrls needs to know the span of `*` to implement \"replace `use foo::*` with explicit list of imported items\" code action. This was the first demoed code action and is still [the only one](https://github.com/rust-lang/rls/blob/fe46c95c3f01fbdaca36bdf70739d32062c1f53a/rls/src/actions/requests.rs#L615-L617) that is implemented\r\n)\r\n\r\nI'd like to remove the `retokenize` function, as it is one of the few remaining things that requires `StringReader` to be public, and as it is very much a hack anyway. \r\n\r\nAdditionally, I believe I've broken this function accidently a while ago: https://github.com/rust-lang/rust/commit/395ee0b79f23b90593b01dd0a78451b8c93b0aa6#diff-d06ad31c547d2d94c8b8770006977767L69. Rather than retokenizing a span, it retokenized file from the begining until the end of the span (whcih, as uses are usually on top, worked correctly most of the times by accident).\r\n\r\nWhat would be the best way to fix this? \r\n\r\n* Add `*` span to `hir::Use` -- this seem to be the \"proper\" solution here\r\n* Move hack's implementation to where it belongs: in `librutc_save_analysis`, just fetch the text of the file and look for `*`, using `rustc_lexer` or maybe just `.rfind('*')`\r\n* Remove the deglog functionlity from RLS? I don't like this option as it handicaps the RLS before we formally decided to deprecated it. But I don't completely disregard it either, as, as a whole, it seems to be a full-stack one off hack penetrating every layer of abstraction. \r\n\r\n@petrochenkov @Xanewok WDYT? ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/76046/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/76046/timeline", "performed_via_github_app": null, "state_reason": "completed"}