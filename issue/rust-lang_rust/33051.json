{"url": "https://api.github.com/repos/rust-lang/rust/issues/33051", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/33051/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/33051/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/33051/events", "html_url": "https://github.com/rust-lang/rust/issues/33051", "id": 148951329, "node_id": "MDU6SXNzdWUxNDg5NTEzMjk=", "number": 33051, "title": "ICE when Attempting to Use an Unimportable Method in the Serde `deserializes_with` Attribute", "user": {"login": "indiv0", "id": 641547, "node_id": "MDQ6VXNlcjY0MTU0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/641547?v=4", "gravatar_id": "", "url": "https://api.github.com/users/indiv0", "html_url": "https://github.com/indiv0", "followers_url": "https://api.github.com/users/indiv0/followers", "following_url": "https://api.github.com/users/indiv0/following{/other_user}", "gists_url": "https://api.github.com/users/indiv0/gists{/gist_id}", "starred_url": "https://api.github.com/users/indiv0/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/indiv0/subscriptions", "organizations_url": "https://api.github.com/users/indiv0/orgs", "repos_url": "https://api.github.com/users/indiv0/repos", "events_url": "https://api.github.com/users/indiv0/events{/privacy}", "received_events_url": "https://api.github.com/users/indiv0/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2016-04-17T13:31:22Z", "updated_at": "2017-05-23T15:27:19Z", "closed_at": "2017-05-23T15:27:18Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "When attempting to compile a project utilizing the `deserialize_with` field annotation macro of [`Serde`](https://github.com/serde-rs/serde) with the annotation trying to use a function which is `not directly importable`, rustc panics.\n\nThis is the code that causes the issue:\n\n`src/lib.rs`:\n\n``` rust\n#![feature(custom_derive, plugin)]\n#![plugin(serde_macros)]\n\nextern crate serde;\nextern crate serde_json;\n\nuse serde::{Deserialize, Deserializer, Error as SerdeError};\nuse serde::de::Visitor;\n\nuse ShapeName::deserialize_shape_name;\n\n#[derive(Debug, Deserialize)]\npub struct MyStruct {\n    #[serde(deserialize_with=\"deserialize_shape_name\")]\n    pub shape: String,\n}\n\npub trait ShapeName: Sized {\n    fn deserialize_shape_name<D>(deserializer: &mut D) -> Result<Self, D::Error>\n        where D: Deserializer;\n}\n\nimpl ShapeName for String {\n    fn deserialize_shape_name<D>(deserializer: &mut D) -> Result<String, D::Error>\n        where D: Deserializer,\n    {\n        String::deserialize(deserializer)\n    }\n}\n```\n\n`Cargo.toml`:\n\n``` rust\n[package]\nname = \"ice_example\"\nversion = \"0.1.0\"\n\n[dependencies]\nserde = \"0.7.0\"\nserde_json = \"0.7.0\"\nserde_macros = \"0.7.2\"\n```\n\nNote that the correct code for this scenario would be:\n\n``` rust\n#![feature(custom_derive, plugin)]\n#![plugin(serde_macros)]\n\nextern crate serde;\nextern crate serde_json;\n\nuse serde::{Deserialize, Deserializer, Error as SerdeError};\nuse serde::de::Visitor;\n\n// use ShapeName::deserialize_shape_name; // This line is unnecessary\n\n#[derive(Debug, Deserialize)]\npub struct MyStruct {\n    #[serde(deserialize_with=\"ShapeName::deserialize_shape_name\")] // The struct must be specified as well\n    pub shape: String,\n}\n\npub trait ShapeName: Sized {\n    fn deserialize_shape_name<D>(deserializer: &mut D) -> Result<Self, D::Error>\n        where D: Deserializer;\n}\n\nimpl ShapeName for String {\n    fn deserialize_shape_name<D>(deserializer: &mut D) -> Result<String, D::Error>\n        where D: Deserializer,\n    {\n        String::deserialize(deserializer)\n    }\n}\n```\n\nI expected to see this happen:\n\nThe \"`deserialize_shapes_map` is not directly importable\" is expected since I'm trying to import a method, but the ICE should not be occuring.\n\nSo the above code should just fail to compile with a \"`deserialize_shapes_map` is not directly importable\" error.\n\nThis happened instead:\n\nWhen compiling the code, it threw the expected \"`deserialize_shapes_map` is not directly importable\" error but also gave the following ICE:\n\n``` sh\nerror: internal compiler error: unexpected panic\nnote: the compiler unexpectedly panicked. this is a bug.\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\nnote: run with `RUST_BACKTRACE=1` for a backtrace\nthread 'rustc' panicked at 'UFCS sugared method missing Self', ../src/libcore/option.rs:700\n```\n## Meta\n\n`rustc --version --verbose`:\n\nrustc 1.10.0-nightly (2174bd97c 2016-04-14)\nbinary: rustc\ncommit-hash: 2174bd97c1458d89a87eb2b614135d7ad68d6f18\ncommit-date: 2016-04-14\nhost: x86_64-unknown-linux-gnu\nrelease: 1.10.0-nightly\n\nBacktrace:\n\n``` sh\n\u2500\u2500\u2500 cargo build --verbose                                                                                                                                                                     \n       Fresh aster v0.15.0\n       Fresh quasi v0.9.0\n       Fresh quasi_codegen v0.9.0\n       Fresh num-traits v0.1.32\n       Fresh quasi_macros v0.9.0\n       Fresh num-integer v0.1.32\n       Fresh serde v0.7.0\n       Fresh num-iter v0.1.32\n       Fresh serde_codegen v0.7.2\n       Fresh num v0.1.32\n       Fresh serde_macros v0.7.2\n       Fresh serde_json v0.7.0\n   Compiling ice_example v0.1.0 (file:///home/indiv0/src/rust/ice_example)\n     Running `rustc src/lib.rs --crate-name ice_example --crate-type lib -g --out-dir /home/indiv0/src/rust/ice_example/target/debug --emit=dep-info,link -L dependency=/home/indiv0/src/rust/ice_example/target/debug -L dependency=/home/indiv0/src/rust/ice_example/target/debug/deps --extern serde=/home/indiv0/src/rust/ice_example/target/debug/deps/libserde-3a777b14c091f0d1.rlib --extern serde_json=/home/indiv0/src/rust/ice_example/target/debug/deps/libserde_json-6edc82d6f60f8983.rlib --extern serde_macros=/home/indiv0/src/rust/ice_example/target/debug/deps/libserde_macros-eba2c386ff2377e8.so`\nsrc/lib.rs:10:5: 10:38 error: `deserialize_shape_name` is not directly importable [E0253]\nsrc/lib.rs:10 use ShapeName::deserialize_shape_name;\n                  ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\nsrc/lib.rs:10:5: 10:38 help: run `rustc --explain E0253` to see a detailed explanation\nerror: internal compiler error: unexpected panic\nnote: the compiler unexpectedly panicked. this is a bug.\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\nnote: run with `RUST_BACKTRACE=1` for a backtrace\nthread 'rustc' panicked at 'UFCS sugared method missing Self', ../src/libcore/option.rs:700\nstack backtrace:\n   1:     0x7ff7464f6600 - std::sys::backtrace::tracing::imp::write::h9fb600083204ae7f\n   2:     0x7ff746503d4b - std::panicking::default_hook::_$u7b$$u7b$closure$u7d$$u7d$::hca543c34f11229ac\n   3:     0x7ff7465038ec - std::panicking::default_hook::hc2c969e7453d080c\n   4:     0x7ff7464c88bf - std::sys_common::unwind::begin_unwind_inner::h30e12d15ce2b2e25\n   5:     0x7ff7464ca9a8 - std::sys_common::unwind::begin_unwind_fmt::hb2de8a9968d38523\n   6:     0x7ff7464f3e11 - rust_begin_unwind\n   7:     0x7ff74654d7cf - core::panicking::panic_fmt::h257ceb0aa351d801\n   8:     0x7ff74656d6f4 - core::option::expect_failed::h2d57a5644f345e0b\n   9:     0x7ff740c814d0 - rustc_typeck::check::instantiate_path::h0028f01e0d6c28a1\n  10:     0x7ff740c7ade6 - rustc_typeck::check::check_expr_with_expectation_and_lvalue_pref::hdaa9a3d5d214eeb7\n  11:     0x7ff740c8d67a - rustc_typeck::check::callee::check_call::h581c68eea83787eb\n  12:     0x7ff740c7671e - rustc_typeck::check::check_expr_with_expectation_and_lvalue_pref::hdaa9a3d5d214eeb7\n  13:     0x7ff740c87828 - rustc_typeck::check::_match::check_match::he7382d310f6a62c7\n  14:     0x7ff740c75ba1 - rustc_typeck::check::check_expr_with_expectation_and_lvalue_pref::hdaa9a3d5d214eeb7\n  15:     0x7ff740cad6aa - rustc_typeck::check::check_decl_initializer::h4a842ce5ee3d42ee\n  16:     0x7ff740cad771 - rustc_typeck::check::check_decl_local::h85cb2e43d704995a\n  17:     0x7ff740cada61 - rustc_typeck::check::check_stmt::h7b32d7406e628d2a\n  18:     0x7ff740c547c8 - rustc_typeck::check::check_block_with_expected::hc05ff1e7fff64a1e\n  19:     0x7ff740c4c459 - rustc_typeck::check::check_fn::hb43882d54094ac4a\n  20:     0x7ff740c49d0c - rustc_typeck::check::check_bare_fn::h7e4c2ad58d1814dd\n  21:     0x7ff740c5904f - rustc_typeck::check::check_method_body::h7863cacbf117e455\n  22:     0x7ff740c44d3e - rustc_typeck::check::check_item_body::h7ffec660fc242796\n  23:     0x7ff740c3cab1 - rustc_typeck::check::check_item_bodies::ha729008a2e67410e\n  24:     0x7ff740c3401f - rustc_typeck::check_crate::hb08ba31a6a5f65b5\n  25:     0x7ff746a52a60 - rustc_driver::driver::phase_3_run_analysis_passes::_$u7b$$u7b$closure$u7d$$u7d$::h5a042a091cd7658c\n  26:     0x7ff746a50c6b - rustc::ty::context::TyCtxt::create_and_enter::h3f9051bcccbd93e4\n  27:     0x7ff746a4d71e - rustc_driver::driver::phase_3_run_analysis_passes::h9c723484c588a35b\n  28:     0x7ff746a1ff7f - rustc_driver::driver::compile_input::h0629572e6f316b31\n  29:     0x7ff746a064e4 - rustc_driver::run_compiler::h8902aebf8b1849a8\n  30:     0x7ff746a03941 - std::sys_common::unwind::try::try_fn::h4c74456035d0fcc7\n  31:     0x7ff7464f3d9b - __rust_try\n  32:     0x7ff7464f3d2d - std::sys_common::unwind::inner_try::h47a4d9cd4a369dcd\n  33:     0x7ff746a0418a - _<F as std..boxed..FnBox<A>>::call_box::h27f542a39f1d61ef\n  34:     0x7ff746501ee4 - std::sys::thread::Thread::new::thread_start::h6f266e069bf4ec2b\n  35:     0x7ff73e384423 - start_thread\n  36:     0x7ff746160cbc - clone\n  37:                0x0 - <unknown>\n\nerror: Could not compile `ice_example`.\n\nCaused by:\n  Process didn't exit successfully: `rustc src/lib.rs --crate-name ice_example --crate-type lib -g --out-dir /home/indiv0/src/rust/ice_example/target/debug --emit=dep-info,link -L dependency=/home/indiv0/src/rust/ice_example/target/debug -L dependency=/home/indiv0/src/rust/ice_example/target/debug/deps --extern serde=/home/indiv0/src/rust/ice_example/target/debug/deps/libserde-3a777b14c091f0d1.rlib --extern serde_json=/home/indiv0/src/rust/ice_example/target/debug/deps/libserde_json-6edc82d6f60f8983.rlib --extern serde_macros=/home/indiv0/src/rust/ice_example/target/debug/deps/libserde_macros-eba2c386ff2377e8.so` (exit code: 101)\n```\n", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/33051/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/33051/timeline", "performed_via_github_app": null, "state_reason": "completed"}