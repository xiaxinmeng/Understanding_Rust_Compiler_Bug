{"url": "https://api.github.com/repos/rust-lang/rust/issues/56191", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/56191/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/56191/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/56191/events", "html_url": "https://github.com/rust-lang/rust/issues/56191", "id": 383953596, "node_id": "MDU6SXNzdWUzODM5NTM1OTY=", "number": 56191, "title": "Weird copy happening during initialization", "user": {"login": "jrmuizel", "id": 332653, "node_id": "MDQ6VXNlcjMzMjY1Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/332653?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jrmuizel", "html_url": "https://github.com/jrmuizel", "followers_url": "https://api.github.com/users/jrmuizel/followers", "following_url": "https://api.github.com/users/jrmuizel/following{/other_user}", "gists_url": "https://api.github.com/users/jrmuizel/gists{/gist_id}", "starred_url": "https://api.github.com/users/jrmuizel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jrmuizel/subscriptions", "organizations_url": "https://api.github.com/users/jrmuizel/orgs", "repos_url": "https://api.github.com/users/jrmuizel/repos", "events_url": "https://api.github.com/users/jrmuizel/events{/privacy}", "received_events_url": "https://api.github.com/users/jrmuizel/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}], "state": "closed", "locked": false, "assignee": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 14, "created_at": "2018-11-24T02:56:54Z", "updated_at": "2019-01-27T17:47:14Z", "closed_at": "2019-01-27T17:47:14Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "This code:\r\n```rust\r\n#[inline(never)]\r\npub fn do_ants() {\r\n    do_item(&Outer {\r\n                item: SpecificDisplayItem2::PopStackingContext,\r\n                info: LayoutPrimitiveInfo2::new(),\r\n            });\r\n}\r\n\r\n#[derive(Copy, Clone)]\r\npub struct LayoutPrimitiveInfo2 {\r\n    pub rect: [f32; 7],\r\n    pub is_backface_visible: u16,\r\n}\r\n\r\nimpl LayoutPrimitiveInfo2 {\r\n    fn new() -> Self {\r\n        Self {\r\n            rect: [0.; 7],\r\n            is_backface_visible:0,\r\n        }\r\n    }\r\n}\r\n\r\npub enum SpecificDisplayItem2 {\r\n    PopStackingContext,\r\n    Other([f64; 22]),\r\n}\r\n\r\nstruct Outer {\r\n    item: SpecificDisplayItem2,\r\n    info: LayoutPrimitiveInfo2\r\n}\r\n\r\nfn do_item(di: &Outer) { unsafe { ext(di) } }\r\nextern {\r\n    fn ext(di: &Outer);\r\n}\r\n```\r\n\r\ncompiles to\r\n```asm\r\nbad_pop_stacking_context::do_ants:\r\n mov     rbp, rsp\r\n sub     rsp, 256\r\n xorps   xmm0, xmm0\r\n movaps  xmmword, ptr, [rbp, -, 32], xmm0\r\n mov     qword, ptr, [rbp, -, 10], 0\r\n mov     qword, ptr, [rbp, -, 16], 0\r\n mov     qword, ptr, [rbp, -, 248], 0\r\n mov     rax, qword, ptr, [rbp, -, 32]\r\n mov     rcx, qword, ptr, [rbp, -, 24]\r\n mov     qword, ptr, [rbp, -, 64], rax\r\n mov     qword, ptr, [rbp, -, 56], rcx\r\n mov     rax, qword, ptr, [rbp, -, 16]\r\n mov     qword, ptr, [rbp, -, 48], rax\r\n mov     rax, qword, ptr, [rbp, -, 8]\r\n mov     qword, ptr, [rbp, -, 40], rax\r\n lea     rdi, [rbp, -, 248]\r\n call    _ext\r\n add     rsp, 256\r\n pop     rbp\r\n ret\r\n```\r\nWhen the u16 is changed to a u32 we get the saner:\r\n\r\n```asm\r\nbad_pop_stacking_context::do_ants:\r\n mov     rbp, rsp\r\n sub     rsp, 224\r\n mov     qword, ptr, [rbp, -, 216], 0\r\n mov     qword, ptr, [rbp, -, 8], 0\r\n mov     qword, ptr, [rbp, -, 16], 0\r\n mov     qword, ptr, [rbp, -, 24], 0\r\n mov     qword, ptr, [rbp, -, 32], 0\r\n lea     rdi, [rbp, -, 216]\r\n call    _ext\r\n add     rsp, 224\r\n pop     rbp\r\n ret\r\n```\r\n\r\n\r\n\r\n", "closed_by": {"login": "jrmuizel", "id": 332653, "node_id": "MDQ6VXNlcjMzMjY1Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/332653?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jrmuizel", "html_url": "https://github.com/jrmuizel", "followers_url": "https://api.github.com/users/jrmuizel/followers", "following_url": "https://api.github.com/users/jrmuizel/following{/other_user}", "gists_url": "https://api.github.com/users/jrmuizel/gists{/gist_id}", "starred_url": "https://api.github.com/users/jrmuizel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jrmuizel/subscriptions", "organizations_url": "https://api.github.com/users/jrmuizel/orgs", "repos_url": "https://api.github.com/users/jrmuizel/repos", "events_url": "https://api.github.com/users/jrmuizel/events{/privacy}", "received_events_url": "https://api.github.com/users/jrmuizel/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/56191/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/56191/timeline", "performed_via_github_app": null, "state_reason": "completed"}