{"url": "https://api.github.com/repos/rust-lang/rust/issues/47135", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/47135/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/47135/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/47135/events", "html_url": "https://github.com/rust-lang/rust/issues/47135", "id": 285522247, "node_id": "MDU6SXNzdWUyODU1MjIyNDc=", "number": 47135, "title": "Reproducible builds regression in nightly", "user": {"login": "kpcyrd", "id": 7763184, "node_id": "MDQ6VXNlcjc3NjMxODQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7763184?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kpcyrd", "html_url": "https://github.com/kpcyrd", "followers_url": "https://api.github.com/users/kpcyrd/followers", "following_url": "https://api.github.com/users/kpcyrd/following{/other_user}", "gists_url": "https://api.github.com/users/kpcyrd/gists{/gist_id}", "starred_url": "https://api.github.com/users/kpcyrd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kpcyrd/subscriptions", "organizations_url": "https://api.github.com/users/kpcyrd/orgs", "repos_url": "https://api.github.com/users/kpcyrd/repos", "events_url": "https://api.github.com/users/kpcyrd/events{/privacy}", "received_events_url": "https://api.github.com/users/kpcyrd/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 147085028, "node_id": "MDU6TGFiZWwxNDcwODUwMjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-nightly", "name": "regression-from-stable-to-nightly", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to nightly."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 13, "created_at": "2018-01-02T19:56:55Z", "updated_at": "2018-05-09T01:27:27Z", "closed_at": "2018-02-20T02:35:16Z", "author_association": "NONE", "active_lock_reason": null, "body": "hello,\r\n\r\nI'm running a CI system with reprotest to ensure the binaries built from the project are reproducible and verifiable. This system started to fail between 2017-12-19 and 2017-12-26:\r\n\r\nBuild 193, 2017-12-19T00:56:25Z, e6446ad65d193e0155ac02d58f338f9136182267, https://travis-ci.org/kpcyrd/sniffglue/jobs/318377138\r\nBuild 196, 2017-12-26T01:20:33Z, e6446ad65d193e0155ac02d58f338f9136182267, https://travis-ci.org/kpcyrd/sniffglue/jobs/321613070\r\n\r\nI assume this is a regression in rust nightly, I can reproduce the test failure locally with a current rust nightly. My tests pass when switching from nightly to stable (with some magic to access `-Zremap-path-prefix-{from,to}`.\r\n\r\nMy testsuite looks like this:\r\n```\r\n#!/bin/sh\r\nset -xue\r\n\r\n# tested with rustc 1.22.1 and cargo 0.23.0\r\n\r\n# by default, the build folder is located in /tmp, which is a tmpfs. The target/ folder\r\n# can become quite large, causing the build to fail if we don't have enough RAM.\r\nexport TMPDIR=\"$HOME/tmp/repro-test\"\r\nmkdir -p \"$TMPDIR\"\r\n\r\nreprotest -vv --vary=-time,-domain_host --source-pattern 'Cargo.* src/' '\r\n    RUSTC_BOOTSTRAP=1 CARGO_HOME=\"$PWD/.cargo\" RUSTUP_HOME='\"$HOME/.rustup\"' \\\r\n        RUSTFLAGS=\"-Zremap-path-prefix-from=$HOME -Zremap-path-prefix-to=/remap-home -Zremap-path-prefix-from=$PWD -Zremap-path-prefix-to=/remap-pwd\" \\\r\n        cargo build --release --verbose' \\\r\n    target/release/sniffglue\r\n```\r\n\r\nYou can run this yourself using:\r\n```\r\ngit clone https://github.com/kpcyrd/sniffglue.git\r\ncd sniffglue\r\ndocker build -t reprotest-sniffglue -f docs/Dockerfile.reprotest .\r\ndocker run --privileged reprotest-sniffglue ci/reprotest.sh\r\n```\r\n\r\nThe full diffoscope report is quite large, the gist looks like this:\r\n```\r\nINFO:reprotest:build successful, copying artifacts\r\nINFO:reprotest:copying /root/tmp/repro-test/reprotest.QwImZ4/artifacts-experiment-1/ back from virtual server's /root/tmp/repro-test/tmp29t413le/experiment-1\r\nINFO:reprotest:Running diffoscope: ['diffoscope', '--exclude-directory-metadata', '/root/tmp/repro-test/tmp29t413le/control', '/root/tmp/repro-test/tmp29t413le/experiment-1']\r\n--- /root/tmp/repro-test/tmp29t413le/control\r\n+++ /root/tmp/repro-test/tmp29t413le/experiment-1\r\n\u251c\u2500\u2500 source-root\r\n\u2502 \u251c\u2500\u2500 target\r\n\u2502 \u2502 \u251c\u2500\u2500 release\r\n\u2502 \u2502 \u2502 \u251c\u2500\u2500 sniffglue\r\n\u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500 readelf --wide --file-header {}\r\n\u2502 \u2502 \u2502 \u2502 \u2502 @@ -6,15 +6,15 @@\r\n\u2502 \u2502 \u2502 \u2502 \u2502    OS/ABI:                            UNIX - System V\r\n\u2502 \u2502 \u2502 \u2502 \u2502    ABI Version:                       0\r\n\u2502 \u2502 \u2502 \u2502 \u2502    Type:                              DYN (Shared object file)\r\n\u2502 \u2502 \u2502 \u2502 \u2502    Machine:                           Advanced Micro Devices X86-64\r\n\u2502 \u2502 \u2502 \u2502 \u2502    Version:                           0x1\r\n\u2502 \u2502 \u2502 \u2502 \u2502    Entry point address:               0x15410\r\n\u2502 \u2502 \u2502 \u2502 \u2502    Start of program headers:          64 (bytes into file)\r\n\u2502 \u2502 \u2502 \u2502 \u2502 -  Start of section headers:          7624168 (bytes into file)\r\n\u2502 \u2502 \u2502 \u2502 \u2502 +  Start of section headers:          7624176 (bytes into file)\r\n\u2502 \u2502 \u2502 \u2502 \u2502    Flags:                             0x0\r\n\u2502 \u2502 \u2502 \u2502 \u2502    Size of this header:               64 (bytes)\r\n\u2502 \u2502 \u2502 \u2502 \u2502    Size of program headers:           56 (bytes)\r\n\u2502 \u2502 \u2502 \u2502 \u2502    Number of program headers:         10\r\n\u2502 \u2502 \u2502 \u2502 \u2502    Size of section headers:           64 (bytes)\r\n\u2502 \u2502 \u2502 \u2502 \u2502    Number of section headers:         44\r\n\u2502 \u2502 \u2502 \u2502 \u2502    Section header string table index: 43\r\n\u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500 readelf --wide --sections {}\r\n\u2502 \u2502 \u2502 \u2502 \u2502 @@ -1,8 +1,8 @@\r\n\u2502 \u2502 \u2502 \u2502 \u2502 -There are 44 section headers, starting at offset 0x7455e8:\r\n\u2502 \u2502 \u2502 \u2502 \u2502 +There are 44 section headers, starting at offset 0x7455f0:\r\n\u2502 \u2502 \u2502 \u2502 \u2502  \r\n\u2502 \u2502 \u2502 \u2502 \u2502  Section Headers:\r\n\u2502 \u2502 \u2502 \u2502 \u2502    [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al\r\n\u2502 \u2502 \u2502 \u2502 \u2502    [ 0]                   NULL            0000000000000000 000000 000000 00      0   0  0\r\n\u2502 \u2502 \u2502 \u2502 \u2502    [ 1] .interp           PROGBITS        0000000000000270 000270 00001c 00   A  0   0  1\r\n\u2502 \u2502 \u2502 \u2502 \u2502    [ 2] .note.ABI-tag     NOTE            000000000000028c 00028c 000020 00   A  0   0  4\r\n\u2502 \u2502 \u2502 \u2502 \u2502    [ 3] .note.gnu.build-id NOTE            00000000000002ac 0002ac 000024 00   A  0   0  4\r\n\u2502 \u2502 \u2502 \u2502 \u2502 @@ -40,14 +40,14 @@\r\n\u2502 \u2502 \u2502 \u2502 \u2502    [35] .debug_str        PROGBITS        0000000000000000 4704b8 0e5241 01  MS  0   0  1\r\n\u2502 \u2502 \u2502 \u2502 \u2502    [36] .debug_loc        PROGBITS        0000000000000000 5556f9 0c881e 00      0   0  1\r\n\u2502 \u2502 \u2502 \u2502 \u2502    [37] .debug_macinfo    PROGBITS        0000000000000000 61df17 000041 00      0   0  1\r\n\u2502 \u2502 \u2502 \u2502 \u2502    [38] .debug_pubtypes   PROGBITS        0000000000000000 61df58 02223b 00      0   0  1\r\n\u2502 \u2502 \u2502 \u2502 \u2502    [39] .debug_ranges     PROGBITS        0000000000000000 640193 07ef50 00      0   0  1\r\n\u2502 \u2502 \u2502 \u2502 \u2502    [40] .debug_macro      PROGBITS        0000000000000000 6bf0e3 013d65 00      0   0  1\r\n\u2502 \u2502 \u2502 \u2502 \u2502    [41] .symtab           SYMTAB          0000000000000000 6d2e48 02fee0 18     42 5529  8\r\n\u2502 \u2502 \u2502 \u2502 \u2502 -  [42] .strtab           STRTAB          0000000000000000 702d28 0426f8 00      0   0  1\r\n\u2502 \u2502 \u2502 \u2502 \u2502 -  [43] .shstrtab         STRTAB          0000000000000000 745420 0001c6 00      0   0  1\r\n\u2502 \u2502 \u2502 \u2502 \u2502 +  [42] .strtab           STRTAB          0000000000000000 702d28 042702 00      0   0  1\r\n\u2502 \u2502 \u2502 \u2502 \u2502 +  [43] .shstrtab         STRTAB          0000000000000000 74542a 0001c6 00      0   0  1\r\n\u2502 \u2502 \u2502 \u2502 \u2502  Key to Flags:\r\n\u2502 \u2502 \u2502 \u2502 \u2502    W (write), A (alloc), X (execute), M (merge), S (strings), I (info),\r\n\u2502 \u2502 \u2502 \u2502 \u2502    L (link order), O (extra OS processing required), G (group), T (TLS),\r\n\u2502 \u2502 \u2502 \u2502 \u2502    C (compressed), x (unknown), o (OS specific), E (exclude),\r\n\u2502 \u2502 \u2502 \u2502 \u2502    l (large), p (processor specific)\r\n\u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500 readelf --wide --symbols {}\r\n\u2502 \u2502 \u2502 \u2502 \u2502 @@ -5676,183 +5676,183 @@\r\n\u2502 \u2502 \u2502 \u2502 \u2502    5523: 000000000017d284   320 FUNC    LOCAL  DEFAULT   14 backtrace_dwarf_add\r\n\u2502 \u2502 \u2502 \u2502 \u2502    5524: 00000000001af930   104 FUNC    LOCAL  DEFAULT   14 je_malloc_tsd_boot1\r\n\u2502 \u2502 \u2502 \u2502 \u2502    5525: 0000000000197b50   132 FUNC    LOCAL  DEFAULT   14 je_chunk_boot\r\n\u2502 \u2502 \u2502 \u2502 \u2502    5526: 000000000019fc30    12 FUNC    LOCAL  DEFAULT   14 je_ctl_prefork\r\n\u2502 \u2502 \u2502 \u2502 \u2502    5527: 0000000000453958     0 OBJECT  LOCAL  DEFAULT   24 _DYNAMIC\r\n\u2502 \u2502 \u2502 \u2502 \u2502    5528: 0000000000177d0d    92 FUNC    LOCAL  DEFAULT   14 backtrace_release_view\r\n\u2502 \u2502 \u2502 \u2502 \u2502    5529: 000000000011c3f0  2038 FUNC    GLOBAL DEFAULT   14 _ZN5regex3dfa3Fsm12cached_state17hb554e8bfc5200e27E\r\n\u2502 \u2502 \u2502 \u2502 \u2502 -  5530: 00000000000bb960    30 FUNC    GLOBAL HIDDEN    14 _ZN4core3ptr13drop_in_place17hf44fe1997133c74dE.llvm.57E7137B\r\n\u2502 \u2502 \u2502 \u2502 \u2502 -  5531: 00000000000cb740    14 FUNC    GLOBAL DEFAULT   14 _ZN147_$LT$clap..args..arg_builder..option..OptBuilder$LT$$u27$n$C$$u20$$u27$e$GT$$u20$as$u20$clap..args..any_arg..AnyArg$LT$$u27$n$C$$u20$$u27$e$GT$$GT$8max_vals17h3d6e1bfec0acc71aE\r\n\u2502 \u2502 \u2502 \u2502 \u2502 -  5532: 000000000011a720   711 FUNC    GLOBAL HIDDEN    14 _ZN5regex8literals15LiteralSearcher3new17ha6ddbdce121a0edaE.llvm.FC380A3B\r\n\u2502 \u2502 \u2502 \u2502 \u2502 -  5533: 000000000012ad70   283 FUNC    GLOBAL HIDDEN    14 _ZN49_$LT$alloc..raw_vec..RawVec$LT$T$C$$u20$A$GT$$GT$7reserve17hda1b026b7e50ce87E\r\n\u2502 \u2502 \u2502 \u2502 \u2502 -  5534: 0000000000128f30    48 FUNC    GLOBAL HIDDEN    14 _ZN4core3ptr13drop_in_place17h277abafcc961cdd0E.llvm.DA02C37B\r\n\u2502 \u2502 \u2502 \u2502 \u2502 -  5535: 0000000000026130  1464 FUNC    GLOBAL HIDDEN    14 _ZN49_$LT$std..sync..mpsc..stream..Packet$LT$T$GT$$GT$4recv17hf720d50b94f350d7E\r\n\u2502 \u2502 \u2502 \u2502 \u2502 -  5536: 00000000000e2e50   433 FUNC    GLOBAL HIDDEN    14 _ZN65_$LT$clap..fmt..Format$LT$T$GT$$u20$as$u20$core..fmt..Display$GT$3fmt17hd3283ea0c9e52cdaE\r\n\u2502 \u2502 \u2502 \u2502 \u2502 -  5537: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND seccomp_load\r\n\u2502 \u2502 \u2502 \u2502 \u2502 -  5538: 000000000044b270    48 OBJECT  GLOBAL HIDDEN    23 vtable.o.llvm.FE355FBC\r\n[...]\r\n```\r\n\r\ncc: @infinity0 ", "closed_by": {"login": "kpcyrd", "id": 7763184, "node_id": "MDQ6VXNlcjc3NjMxODQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7763184?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kpcyrd", "html_url": "https://github.com/kpcyrd", "followers_url": "https://api.github.com/users/kpcyrd/followers", "following_url": "https://api.github.com/users/kpcyrd/following{/other_user}", "gists_url": "https://api.github.com/users/kpcyrd/gists{/gist_id}", "starred_url": "https://api.github.com/users/kpcyrd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kpcyrd/subscriptions", "organizations_url": "https://api.github.com/users/kpcyrd/orgs", "repos_url": "https://api.github.com/users/kpcyrd/repos", "events_url": "https://api.github.com/users/kpcyrd/events{/privacy}", "received_events_url": "https://api.github.com/users/kpcyrd/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/47135/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/47135/timeline", "performed_via_github_app": null, "state_reason": "completed"}