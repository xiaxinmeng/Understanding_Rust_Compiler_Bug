{"url": "https://api.github.com/repos/rust-lang/rust/issues/74820", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/74820/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/74820/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/74820/events", "html_url": "https://github.com/rust-lang/rust/issues/74820", "id": 666224010, "node_id": "MDU6SXNzdWU2NjYyMjQwMTA=", "number": 74820, "title": "libtest panics when running `should_panic` tests under QEMU armv7 ", "user": {"login": "rossmacarthur", "id": 17109887, "node_id": "MDQ6VXNlcjE3MTA5ODg3", "avatar_url": "https://avatars.githubusercontent.com/u/17109887?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rossmacarthur", "html_url": "https://github.com/rossmacarthur", "followers_url": "https://api.github.com/users/rossmacarthur/followers", "following_url": "https://api.github.com/users/rossmacarthur/following{/other_user}", "gists_url": "https://api.github.com/users/rossmacarthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/rossmacarthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rossmacarthur/subscriptions", "organizations_url": "https://api.github.com/users/rossmacarthur/orgs", "repos_url": "https://api.github.com/users/rossmacarthur/repos", "events_url": "https://api.github.com/users/rossmacarthur/events{/privacy}", "received_events_url": "https://api.github.com/users/rossmacarthur/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 55301954, "node_id": "MDU6TGFiZWw1NTMwMTk1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-Arm", "name": "O-Arm", "color": "6e6ec0", "default": false, "description": "Target: 32-bit Arm processors (armv6, armv7, thumb...), including 64-bit Arm in AArch32 state"}, {"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 630810559, "node_id": "MDU6TGFiZWw2MzA4MTA1NTk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-libtest", "name": "A-libtest", "color": "f7e101", "default": false, "description": "Area: #[test] related"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1791937891, "node_id": "MDU6TGFiZWwxNzkxOTM3ODkx", "url": "https://api.github.com/repos/rust-lang/rust/labels/ICEBreaker-Cleanup-Crew", "name": "ICEBreaker-Cleanup-Crew", "color": "74cc28", "default": false, "description": "Helping to \"clean up\" bugs with minimal examples and bisections"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 22, "created_at": "2020-07-27T11:33:43Z", "updated_at": "2020-10-28T08:56:15Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "This currently works on `stable` but now fails on `beta` and `nightly`.\r\n\r\nI tried this code:\r\n\r\n```rust\r\n// lib.rs\r\n#[cfg(test)]\r\nmod tests {\r\n    #[test]\r\n    #[should_panic]\r\n    fn it_works() {\r\n        panic!(\"this test should pass\");\r\n    }\r\n}\r\n```\r\n\r\nAnd used `cross v0.2.1` to test it\r\n\r\n```\r\n$ cross -v +beta test --target armv7-unknown-linux-musleabihf\r\n+ \"rustc\" \"--print\" \"sysroot\"\r\n+ \"rustup\" \"toolchain\" \"list\"\r\n+ \"rustup\" \"target\" \"list\" \"--toolchain\" \"beta-x86_64-unknown-linux-gnu\"\r\n+ \"rustup\" \"component\" \"list\" \"--toolchain\" \"beta-x86_64-unknown-linux-gnu\"\r\n+ \"/usr/bin/docker\" \"run\" \"--userns\" \"host\" \"-e\" \"RUST_BACKTRACE\" \"-e\" \"PKG_CONFIG_ALLOW_CROSS=1\" \"--rm\" \"--user\" \"1000:1000\" \"-e\" \"XARGO_HOME=/xargo\" \"-e\" \"CARGO_HOME=/cargo\" \"-e\" \"CARGO_TARGET_DIR=/target\" \"-e\" \"USER=ross\" \"-e\" \"CROSS_RUNNER=\" \"-v\" \"/home/ross/.xargo:/xargo:Z\" \"-v\" \"/home/ross/.cargo:/cargo:Z\" \"-v\" \"/cargo/bin\" \"-v\" \"/home/ross/arm-test:/project:Z\" \"-v\" \"/home/ross/.rustup/toolchains/beta-x86_64-unknown-linux-gnu:/rust:Z,ro\" \"-v\" \"/home/ross/arm-test/target:/target:Z\" \"-w\" \"/project\" \"-i\" \"-t\" \"rustembedded/cross:armv7-unknown-linux-musleabihf-0.2.1\" \"sh\" \"-c\" \"PATH=$PATH:/rust/bin cargo -v test --target armv7-unknown-linux-musleabihf\"\r\n       Fresh arm-test v0.1.0 (/project)\r\n    Finished test [unoptimized + debuginfo] target(s) in 0.01s\r\n     Running `qemu-arm /target/armv7-unknown-linux-musleabihf/debug/deps/arm_test-6cdb46f45d2b6f28`\r\n\r\nrunning 1 test\r\ntest tests::it_works ... thread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: \"PoisonError { inner: .. }\"', src/libtest/lib.rs:556:30\r\nerror: test failed, to rerun pass '--lib'\r\n```\r\n\r\nI expected to see this happen: the test should pass and libtest should not panic.\r\n\r\n### Meta\r\n\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.46.0-beta.2 (6f959902b 2020-07-23)\r\nbinary: rustc\r\ncommit-hash: 6f959902b3103c49ca981fbc01871589c3498489\r\ncommit-date: 2020-07-23\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.46.0-beta.2\r\nLLVM version: 10.0\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```\r\n$ RUST_BACKTRACE=full cross -v +beta test --target armv7-unknown-linux-musleabihf\r\n+ \"rustc\" \"--print\" \"sysroot\"\r\n+ \"rustup\" \"toolchain\" \"list\"\r\n+ \"rustup\" \"target\" \"list\" \"--toolchain\" \"beta-x86_64-unknown-linux-gnu\"\r\n+ \"rustup\" \"component\" \"list\" \"--toolchain\" \"beta-x86_64-unknown-linux-gnu\"\r\n+ \"/usr/bin/docker\" \"run\" \"--userns\" \"host\" \"-e\" \"RUST_BACKTRACE\" \"-e\" \"PKG_CONFIG_ALLOW_CROSS=1\" \"--rm\" \"--user\" \"1000:1000\" \"-e\" \"XARGO_HOME=/xargo\" \"-e\" \"CARGO_HOME=/cargo\" \"-e\" \"CARGO_TARGET_DIR=/target\" \"-e\" \"USER=ross\" \"-e\" \"CROSS_RUNNER=\" \"-v\" \"/home/ross/.xargo:/xargo:Z\" \"-v\" \"/home/ross/.cargo:/cargo:Z\" \"-v\" \"/cargo/bin\" \"-v\" \"/home/ross/arm-test:/project:Z\" \"-v\" \"/home/ross/.rustup/toolchains/beta-x86_64-unknown-linux-gnu:/rust:Z,ro\" \"-v\" \"/home/ross/arm-test/target:/target:Z\" \"-w\" \"/project\" \"-i\" \"-t\" \"rustembedded/cross:armv7-unknown-linux-musleabihf-0.2.1\" \"sh\" \"-c\" \"PATH=$PATH:/rust/bin cargo -v test --target armv7-unknown-linux-musleabihf\"\r\n       Fresh arm-test v0.1.0 (/project)\r\n    Finished test [unoptimized + debuginfo] target(s) in 0.01s\r\n     Running `qemu-arm /target/armv7-unknown-linux-musleabihf/debug/deps/arm_test-6cdb46f45d2b6f28`\r\n\r\nrunning 1 test\r\ntest tests::it_works ... thread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: \"PoisonError { inner: .. }\"', src/libtest/lib.rs:556:30\r\nstack backtrace:\r\n   0:    0x580b4 - backtrace::backtrace::libunwind::trace::hd40b4f69fe271ed9\r\n                       at /cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.46/src/backtrace/libunwind.rs:86\r\n   1:    0x580b4 - backtrace::backtrace::trace_unsynchronized::h3ca9a364f54e964e\r\n                       at /cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.46/src/backtrace/mod.rs:66\r\n   2:    0x580b4 - std::sys_common::backtrace::_print_fmt::h982a8ae6b5f29f65\r\n                       at src/libstd/sys_common/backtrace.rs:78\r\n   3:    0x580b4 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::he8ccdc84a58ecc98\r\n                       at src/libstd/sys_common/backtrace.rs:59\r\n   4:    0x83040 - core::fmt::write::h23f93faacadec7cc\r\n                       at src/libcore/fmt/mod.rs:1076\r\n   5:    0x54940 - std::io::Write::write_fmt::haf0f338c5ed7de5f\r\n                       at src/libstd/io/mod.rs:1537\r\n   6:    0x5a88c - std::sys_common::backtrace::_print::h5683bffede5f926f\r\n                       at src/libstd/sys_common/backtrace.rs:62\r\n   7:    0x5a88c - std::sys_common::backtrace::print::h208a071bf789b7b7\r\n                       at src/libstd/sys_common/backtrace.rs:49\r\n   8:    0x5a88c - std::panicking::default_hook::{{closure}}::had93821ac17882da\r\n                       at src/libstd/panicking.rs:198\r\n   9:    0x5a558 - std::panicking::default_hook::ha27fdf8351cfa2f3\r\n                       at src/libstd/panicking.rs:217\r\n  10:    0x5af6c - std::panicking::rust_panic_with_hook::h5e82ec4b73107927\r\n                       at src/libstd/panicking.rs:526\r\n  11:    0x5ab6c - rust_begin_unwind\r\n                       at src/libstd/panicking.rs:437\r\n  12:    0x8170c - core::panicking::panic_fmt::h47be891d82598e44\r\n                       at src/libcore/panicking.rs:85\r\n  13:    0x81564 - core::option::expect_none_failed::h565bc8e7856c8fe7\r\n                       at src/libcore/option.rs:1269\r\n  14:    0x36e2c - core::result::Result<T,E>::unwrap::h916cdda944865138\r\n                       at /rustc/6f959902b3103c49ca981fbc01871589c3498489/src/libcore/result.rs:1005\r\n  15:    0x36e2c - test::run_test_in_process::h3c269a8ac50a2dd7\r\n                       at src/libtest/lib.rs:556\r\n  16:    0x36e2c - test::run_test::run_test_inner::{{closure}}::h15296ff2652b597f\r\n                       at src/libtest/lib.rs:450\r\n  17:    0x36424 - test::run_test::run_test_inner::hc9172a5fcccfeb6e\r\n                       at src/libtest/lib.rs:475\r\n  18:    0x34dd0 - test::run_test::h12bd73b7e259bc25\r\n                       at src/libtest/lib.rs:505\r\n  19:    0x264b4 - test::run_tests::ha1fdb36c7355f908\r\n                       at src/libtest/lib.rs:284\r\n  20:    0x264b4 - test::console::run_tests_console::he1caf03003813d3d\r\n                       at src/libtest/console.rs:280\r\n  21:    0x31b74 - test::test_main::hb716c54c676c2e08\r\n                       at src/libtest/lib.rs:120\r\n  22:    0x32c3c - test::test_main_static::hb9dfb706262f665b\r\n                       at src/libtest/lib.rs:139\r\n  23:    0x11970 - arm_test::main::he46c7a1e35416fc1\r\n  24:    0x10f1c - std::rt::lang_start::{{closure}}::h250b51295a1aa3ab\r\n                       at /rustc/6f959902b3103c49ca981fbc01871589c3498489/src/libstd/rt.rs:67\r\n  25:    0x5b260 - std::rt::lang_start_internal::{{closure}}::h81f1dae74b28fcfc\r\n                       at src/libstd/rt.rs:52\r\n  26:    0x5b260 - std::panicking::try::do_call::ha6d54a9d8c9a8b73\r\n                       at src/libstd/panicking.rs:348\r\n  27:    0x5b260 - std::panicking::try::h018fe3feda747ef2\r\n                       at src/libstd/panicking.rs:325\r\n  28:    0x5b260 - std::panic::catch_unwind::hbcb5f8582e976c82\r\n                       at src/libstd/panic.rs:394\r\n  29:    0x5b260 - std::rt::lang_start_internal::h504aede73e26a7ed\r\n                       at src/libstd/rt.rs:51\r\n  30:    0x10ef0 - std::rt::lang_start::h5abd88271e1cf6f0\r\n                       at /rustc/6f959902b3103c49ca981fbc01871589c3498489/src/libstd/rt.rs:67\r\n  31:    0x119b8 - main\r\nerror: test failed, to rerun pass '--lib'\r\n```\r\n\r\n</p>\r\n</details>\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/74820/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/74820/timeline", "performed_via_github_app": null, "state_reason": null}