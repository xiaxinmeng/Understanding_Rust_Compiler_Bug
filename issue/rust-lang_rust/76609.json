{"url": "https://api.github.com/repos/rust-lang/rust/issues/76609", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/76609/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/76609/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/76609/events", "html_url": "https://github.com/rust-lang/rust/issues/76609", "id": 699682070, "node_id": "MDU6SXNzdWU2OTk2ODIwNzA=", "number": 76609, "title": "Unclear diagnostics for async callback that takes a reference", "user": {"login": "panstromek", "id": 25121817, "node_id": "MDQ6VXNlcjI1MTIxODE3", "avatar_url": "https://avatars.githubusercontent.com/u/25121817?v=4", "gravatar_id": "", "url": "https://api.github.com/users/panstromek", "html_url": "https://github.com/panstromek", "followers_url": "https://api.github.com/users/panstromek/followers", "following_url": "https://api.github.com/users/panstromek/following{/other_user}", "gists_url": "https://api.github.com/users/panstromek/gists{/gist_id}", "starred_url": "https://api.github.com/users/panstromek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/panstromek/subscriptions", "organizations_url": "https://api.github.com/users/panstromek/orgs", "repos_url": "https://api.github.com/users/panstromek/repos", "events_url": "https://api.github.com/users/panstromek/events{/privacy}", "received_events_url": "https://api.github.com/users/panstromek/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 1775993, "node_id": "MDU6TGFiZWwxNzc1OTkz", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-lifetimes", "name": "A-lifetimes", "color": "f7e101", "default": false, "description": "Area: lifetime related"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 1049510487, "node_id": "MDU6TGFiZWwxMDQ5NTEwNDg3", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-async-await", "name": "A-async-await", "color": "f7e101", "default": false, "description": "Area: Async & Await"}, {"id": 1259721467, "node_id": "MDU6TGFiZWwxMjU5NzIxNDY3", "url": "https://api.github.com/repos/rust-lang/rust/labels/AsyncAwait-Triaged", "name": "AsyncAwait-Triaged", "color": "d4c5f9", "default": false, "description": "Async-await issues that have been triaged during a working group meeting."}, {"id": 1596121013, "node_id": "MDU6TGFiZWwxNTk2MTIxMDEz", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-confusing", "name": "D-confusing", "color": "c9f7a3", "default": false, "description": "Confusing diagnostic error that should be reworked"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2020-09-11T19:42:55Z", "updated_at": "2020-09-16T00:27:22Z", "closed_at": "2020-09-16T00:27:22Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "This code..\r\n\r\n```rust\r\npub async fn foo() {\r\n    wrapper(callback).await\r\n}\r\n\r\npub async fn callback(buf: &mut [u8]) {}\r\n\r\npub async fn wrapper< Fun, Fut>(cb: Fun)\r\n    where\r\n        Fun: Fn(& mut [u8]) -> Fut ,\r\n        Fut: Future<Output=()>\r\n{\r\n    let mut buf = [8; 8];\r\n    cb(&mut buf).await\r\n}\r\n```\r\n...triggers this diagnostic:\r\n\r\n```\r\nerror: implementation of `std::ops::FnOnce` is not general enough\r\n   --> tests/src/main.rs:8:5\r\n    |\r\n8   |       wrapper(callback).await\r\n    |       ^^^^^^^ implementation of `std::ops::FnOnce` is not general enough\r\n    | \r\n   ::: /home/matyas/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:219:1\r\n    |\r\n219 | / pub trait FnOnce<Args> {\r\n220 | |     /// The returned type after the call operator is used.\r\n221 | |     #[lang = \"fn_once_output\"]\r\n222 | |     #[stable(feature = \"fn_once_output\", since = \"1.12.0\")]\r\n...   |\r\n227 | |     extern \"rust-call\" fn call_once(self, args: Args) -> Self::Output;\r\n228 | | }\r\n    | |_- trait `std::ops::FnOnce` defined here\r\n    |\r\n    = note: `std::ops::FnOnce<(&'0 mut [u8],)>` would have to be implemented for the type `for<'_> fn(&mut [u8]) -> impl std::future::Future {callback}`, for some specific lifetime `'0`...\r\n    = note: ...but `std::ops::FnOnce<(&mut [u8],)>` is actually implemented for the type `for<'_> fn(&mut [u8]) -> impl std::future::Future {callback}`\r\n\r\n```\r\nand it's completely unclear to me how to fix it. Well, obviously the problem is that the callback takes a reference, but even that took me some time to realize (longer than I'd like to admit). In the end I just removed it and did it differently.\r\n\r\nThis code came from refactoring of some non-async code, so I for some time I didn't realize that I was doing something fishy. I don't have much experience with async rust, so I don't know if this is even possible to fix while still keeping the reference there (maybe with some clever bounds?). If not, it should probably suggest you to rewrite it to not use that reference.\r\n", "closed_by": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/76609/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/76609/timeline", "performed_via_github_app": null, "state_reason": "completed"}