{"url": "https://api.github.com/repos/rust-lang/rust/issues/81391", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/81391/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/81391/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/81391/events", "html_url": "https://github.com/rust-lang/rust/issues/81391", "id": 793657190, "node_id": "MDU6SXNzdWU3OTM2NTcxOTA=", "number": 81391, "title": "Tracking Issue for the C-cmse-nonsecure-call ABI", "user": {"login": "hug-dev", "id": 29229160, "node_id": "MDQ6VXNlcjI5MjI5MTYw", "avatar_url": "https://avatars.githubusercontent.com/u/29229160?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hug-dev", "html_url": "https://github.com/hug-dev", "followers_url": "https://api.github.com/users/hug-dev/followers", "following_url": "https://api.github.com/users/hug-dev/following{/other_user}", "gists_url": "https://api.github.com/users/hug-dev/gists{/gist_id}", "starred_url": "https://api.github.com/users/hug-dev/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hug-dev/subscriptions", "organizations_url": "https://api.github.com/users/hug-dev/orgs", "repos_url": "https://api.github.com/users/hug-dev/repos", "events_url": "https://api.github.com/users/hug-dev/events{/privacy}", "received_events_url": "https://api.github.com/users/hug-dev/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 55301954, "node_id": "MDU6TGFiZWw1NTMwMTk1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-Arm", "name": "O-Arm", "color": "6e6ec0", "default": false, "description": "Target: 32-bit Arm processors (armv6, armv7, thumb...), including 64-bit Arm in AArch32 state"}, {"id": 650846969, "node_id": "MDU6TGFiZWw2NTA4NDY5Njk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-tracking-issue", "name": "C-tracking-issue", "color": "f5f1fd", "default": false, "description": "Category: A tracking issue for an RFC or an unstable feature."}, {"id": 880020421, "node_id": "MDU6TGFiZWw4ODAwMjA0MjE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/WG-embedded", "name": "WG-embedded", "color": "c2e0c6", "default": false, "description": "Of interest to the embedded Working Group"}, {"id": 2687030356, "node_id": "MDU6TGFiZWwyNjg3MDMwMzU2", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-abi_c_cmse_nonsecure_call", "name": "F-abi_c_cmse_nonsecure_call", "color": "f9c0cc", "default": false, "description": "`#![feature(abi_c_cmse_nonsecure_call)]`"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2021-01-25T19:20:56Z", "updated_at": "2021-01-30T15:50:11Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "This is a tracking issue for the PR #81346.\r\nThe feature gate for the issue is `#![feature(abi_c_cmse_nonsecure_call)]`.\r\n\r\n## Description\r\n\r\nThe [TrustZone-M feature](https://developer.arm.com/documentation/100690/latest/) is available for targets with the Armv8-M architecture profile (`thumbv8m` in their target name).\r\nLLVM, the Rust compiler and the linker are providing [support](https://developer.arm.com/documentation/ecm0359818/latest/) for the TrustZone-M feature.\r\n\r\nOne of the things provided, with this unstable feature, is the `C-cmse-nonsecure-call` function ABI. This ABI is used on function pointers to non-secure code to mark a non-secure function call (see [section 5.5](https://developer.arm.com/documentation/ecm0359818/latest/) for details).\r\n\r\nWith this ABI, the compiler will do the following to perform the call:\r\n* save registers needed after the call to Secure memory\r\n* clear all registers that might contain confidential information\r\n* clear the Least Significant Bit of the function address\r\n* branches using the BLXNS instruction\r\n\r\nTo avoid using the non-secure stack, the compiler will constrain the number and type of parameters/return value.\r\n\r\nThe `extern \"C-cmse-nonsecure-call\"` ABI is otherwise equivalent to the `extern \"C\"` ABI.\r\n\r\n## Example\r\n\r\n``` rust,ignore\r\n#![no_std]\r\n#![feature(abi_c_cmse_nonsecure_call)]\r\n\r\n#[no_mangle]\r\npub fn call_nonsecure_function(addr: usize) -> u32 {\r\n    let non_secure_function =\r\n        unsafe { core::mem::transmute::<usize, extern \"C-cmse-nonsecure-call\" fn() -> u32>(addr) };\r\n    non_secure_function()\r\n}\r\n```\r\n\r\n``` text\r\n$ rustc --emit asm --crate-type lib --target thumbv8m.main-none-eabi function.rs\r\n\r\ncall_nonsecure_function:\r\n        .fnstart\r\n        .save   {r7, lr}\r\n        push    {r7, lr}\r\n        .setfp  r7, sp\r\n        mov     r7, sp\r\n        .pad    #16\r\n        sub     sp, #16\r\n        str     r0, [sp, #12]\r\n        ldr     r0, [sp, #12]\r\n        str     r0, [sp, #8]\r\n        b       .LBB0_1\r\n.LBB0_1:\r\n        ldr     r0, [sp, #8]\r\n        push.w  {r4, r5, r6, r7, r8, r9, r10, r11}\r\n        bic     r0, r0, #1\r\n        mov     r1, r0\r\n        mov     r2, r0\r\n        mov     r3, r0\r\n        mov     r4, r0\r\n        mov     r5, r0\r\n        mov     r6, r0\r\n        mov     r7, r0\r\n        mov     r8, r0\r\n        mov     r9, r0\r\n        mov     r10, r0\r\n        mov     r11, r0\r\n        mov     r12, r0\r\n        msr     apsr_nzcvq, r0\r\n        blxns   r0\r\n        pop.w   {r4, r5, r6, r7, r8, r9, r10, r11}\r\n        str     r0, [sp, #4]\r\n        b       .LBB0_2\r\n.LBB0_2:\r\n        ldr     r0, [sp, #4]\r\n        add     sp, #16\r\n        pop     {r7, pc}\r\n```\r\n\r\n## Steps\r\n\r\n* [ ] Initial implementation: #81346\r\n* [ ] ABI compliance should be checked by rustc instead of LLVM: #81347", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/81391/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/81391/timeline", "performed_via_github_app": null, "state_reason": null}