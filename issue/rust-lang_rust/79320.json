{"url": "https://api.github.com/repos/rust-lang/rust/issues/79320", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/79320/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/79320/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/79320/events", "html_url": "https://github.com/rust-lang/rust/issues/79320", "id": 748362465, "node_id": "MDU6SXNzdWU3NDgzNjI0NjU=", "number": 79320, "title": "Documentation for mem::forget implies that it may invalidate raw pointers to heap allocations", "user": {"login": "fleabitdev", "id": 65809749, "node_id": "MDQ6VXNlcjY1ODA5NzQ5", "avatar_url": "https://avatars.githubusercontent.com/u/65809749?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fleabitdev", "html_url": "https://github.com/fleabitdev", "followers_url": "https://api.github.com/users/fleabitdev/followers", "following_url": "https://api.github.com/users/fleabitdev/following{/other_user}", "gists_url": "https://api.github.com/users/fleabitdev/gists{/gist_id}", "starred_url": "https://api.github.com/users/fleabitdev/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fleabitdev/subscriptions", "organizations_url": "https://api.github.com/users/fleabitdev/orgs", "repos_url": "https://api.github.com/users/fleabitdev/repos", "events_url": "https://api.github.com/users/fleabitdev/events{/privacy}", "received_events_url": "https://api.github.com/users/fleabitdev/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 431251592, "node_id": "MDU6TGFiZWw0MzEyNTE1OTI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-docs", "name": "A-docs", "color": "f7e101", "default": false, "description": "Area: documentation for any part of the project, including the compiler, standard library, and tools"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2020-11-22T22:10:32Z", "updated_at": "2022-03-07T15:42:22Z", "closed_at": "2022-03-07T15:42:22Z", "author_association": "NONE", "active_lock_reason": null, "body": "The doc comment for `mem::forget` currently reads:\r\n\r\n> Any resources the value manages, such as heap memory or a file handle, will linger forever in an unreachable state. However, it does not guarantee that pointers to this memory will remain valid.\r\n\r\nThe second sentence was introduced in #53503, with this rationale:\r\n\r\n> it's not obvious `mem::forget` does not guarantee leaking of memory: memory of stack-allocated objects and values partially moved out of `Box` will still be freed\r\n\r\nIn other words, it's intended to be a warning about these two footguns:\r\n\r\n```rust\r\nlet byte = 42_u8;\r\nlet raw_ptr = &byte as *const u8;\r\nstd::mem::forget(byte);\r\nlet forty_two = unsafe { *raw_ptr };\r\n\r\nlet raw_ptr;\r\n{\r\n    let boxed_byte = Box::new(42u8);\r\n    raw_ptr = &*boxed_byte as *const u8;\r\n    std::mem::forget(*boxed_byte);\r\n}\r\nlet forty_two = unsafe { *raw_ptr };\r\n```\r\n\r\nTo me, the current language is too broad. It implies that heap allocations owned by a value passed to `mem::forget` may be invalidated. For example, it implies that the following code is unsound:\r\n\r\n```rust\r\nlet s = format!(\"example\");\r\nlet s_ptr = s.as_ptr();\r\nstd::mem::forget(s);\r\nlet lowercase_e = unsafe { *s_ptr };\r\n```\r\n\r\nOpening an issue rather than a PR because I'm not sure how best to rephrase this.\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":null}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/79320/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/79320/timeline", "performed_via_github_app": null, "state_reason": "completed"}