{"url": "https://api.github.com/repos/rust-lang/rust/issues/99669", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/99669/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/99669/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/99669/events", "html_url": "https://github.com/rust-lang/rust/issues/99669", "id": 1315890976, "node_id": "I_kwDOAAsO6M5Obucg", "number": 99669, "title": "Investigate mutating the AST during late resolution", "user": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234876, "node_id": "MDU6TGFiZWwyMzQ4NzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-hard", "name": "E-hard", "color": "02e10c", "default": false, "description": "Call for participation: Experience needed to fix: Hard / a lot"}, {"id": 239393, "node_id": "MDU6TGFiZWwyMzkzOTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-resolve", "name": "A-resolve", "color": "f7e101", "default": false, "description": "Area: Path resolution"}, {"id": 67766349, "node_id": "MDU6TGFiZWw2Nzc2NjM0OQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-mentor", "name": "E-mentor", "color": "02E10C", "default": false, "description": "Call for participation: This issue has a mentor. Use RustcContributor::new on Zulip for discussion."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 256133344, "node_id": "MDU6TGFiZWwyNTYxMzMzNDQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-hir", "name": "A-hir", "color": "f7e101", "default": false, "description": "Area: the High level Intermediate Representation (HIR)"}, {"id": 289259951, "node_id": "MDU6TGFiZWwyODkyNTk5NTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-help-wanted", "name": "E-help-wanted", "color": "02E10C", "default": false, "description": "Call for participation: Help is requested to fix this issue."}], "state": "open", "locked": false, "assignee": {"login": "jon-chuang", "id": 9093549, "node_id": "MDQ6VXNlcjkwOTM1NDk=", "avatar_url": "https://avatars.githubusercontent.com/u/9093549?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jon-chuang", "html_url": "https://github.com/jon-chuang", "followers_url": "https://api.github.com/users/jon-chuang/followers", "following_url": "https://api.github.com/users/jon-chuang/following{/other_user}", "gists_url": "https://api.github.com/users/jon-chuang/gists{/gist_id}", "starred_url": "https://api.github.com/users/jon-chuang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jon-chuang/subscriptions", "organizations_url": "https://api.github.com/users/jon-chuang/orgs", "repos_url": "https://api.github.com/users/jon-chuang/repos", "events_url": "https://api.github.com/users/jon-chuang/events{/privacy}", "received_events_url": "https://api.github.com/users/jon-chuang/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "jon-chuang", "id": 9093549, "node_id": "MDQ6VXNlcjkwOTM1NDk=", "avatar_url": "https://avatars.githubusercontent.com/u/9093549?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jon-chuang", "html_url": "https://github.com/jon-chuang", "followers_url": "https://api.github.com/users/jon-chuang/followers", "following_url": "https://api.github.com/users/jon-chuang/following{/other_user}", "gists_url": "https://api.github.com/users/jon-chuang/gists{/gist_id}", "starred_url": "https://api.github.com/users/jon-chuang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jon-chuang/subscriptions", "organizations_url": "https://api.github.com/users/jon-chuang/orgs", "repos_url": "https://api.github.com/users/jon-chuang/repos", "events_url": "https://api.github.com/users/jon-chuang/events{/privacy}", "received_events_url": "https://api.github.com/users/jon-chuang/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 6, "created_at": "2022-07-24T12:13:17Z", "updated_at": "2023-04-05T17:33:41Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Late name resolution happens on the AST and is responsible for finding which definition each name in the AST points to, be it a type, trait expression, pattern, lifetime or label.  The name \"late\" means that this resolution happens after all macros have been expanded, in opposition to \"early\" resolution which resolves macros.  The corresponding code lives in `rustc_resolve::late`.\n\nThe results of this late resolution are stored in tables, and used by HIR lowering to directly embed the information in HIR.\n\nLater, lowering reinterprets some of the AST where the syntax is ambiguous.  For instance, lowering is responsible for making bare trait objects explicit: interpreting types of the form `T` with `dyn T` when resolution finds that `T` is a trait.  Lowering also introduces implicit lifetime parameters for lifetime elision.  The corresponding code lives in `rustc_ast_lowering`.\n\nThis re-interpretation of the AST needs to closely mirror what resolution is doing.  Mismatches can cause bugs, like AST and HIR disagreeing on how to resolve lifetimes in the `dyn T` discussed above.\n\nThe objective of this project is to have this resolution-based desugaring in only one place.  We would like to have late resolution modify the AST to directly perform these transformations, and remove them from lowering.\n\nAt the same time, lowering also performs its own transformations, like transforming `impl Trait` to generic parameters or opaque types.  Those transformations should stay in lowering for the time being.  Rule of thumb: if the transformation inspects resolutions, it should go in resolution, if it's purely syntactic it can stay in lowering.\n\nSteps:\n- [ ] Refactor the visitor in `rustc_resolve::late` by an AST `MutVisitor`.  `MutVisitor` is designed for macro expansions, so it may lack some methods to make resolution practical.  There can be design work here, so feel free to suggest new methods / a different `MutVisitor` trait / ...\n- [ ] Desugar type-relative paths during resolution.   The current code in lowering is in `rustc_ast_lowering::path`, and aims to transform `a::b::c::d` to `<a::b::c>::d` when `a::b::c` can be resolved to a type and `::d` cannot (for instance because it is a trait method).  See `rustc_resolve::late::smart_resolve_path` and associated methods.\n- [ ] Desugar bare trait object during late resolution when the path is actually a trait.  See `rustc_resolve::late::visit_ty`.\n\nPlease contact me on zulip (cjgillot) for any questions.\n\nNote: this project is a large body of work, with possibly many changes to the resolution code.  The point is to simplify the lowering code.  If this simplification goal is not reached, or if the perf impact is prohibitive, we may end-up not merging the modifications, and instead document why.\nTo be merged, the PR will probably require a major change proposal.  I will take care of this proposal once the perspectives become a bit clear.\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"jon-chuang\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/99669/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/99669/timeline", "performed_via_github_app": null, "state_reason": null}