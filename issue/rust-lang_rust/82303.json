{"url": "https://api.github.com/repos/rust-lang/rust/issues/82303", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/82303/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/82303/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/82303/events", "html_url": "https://github.com/rust-lang/rust/issues/82303", "id": 812362001, "node_id": "MDU6SXNzdWU4MTIzNjIwMDE=", "number": 82303, "title": "Zip's __iterator_get_unchecked doesn't preserve side-effects", "user": {"login": "SkiFire13", "id": 9020423, "node_id": "MDQ6VXNlcjkwMjA0MjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9020423?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SkiFire13", "html_url": "https://github.com/SkiFire13", "followers_url": "https://api.github.com/users/SkiFire13/followers", "following_url": "https://api.github.com/users/SkiFire13/following{/other_user}", "gists_url": "https://api.github.com/users/SkiFire13/gists{/gist_id}", "starred_url": "https://api.github.com/users/SkiFire13/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SkiFire13/subscriptions", "organizations_url": "https://api.github.com/users/SkiFire13/orgs", "repos_url": "https://api.github.com/users/SkiFire13/repos", "events_url": "https://api.github.com/users/SkiFire13/events{/privacy}", "received_events_url": "https://api.github.com/users/SkiFire13/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2021-02-19T21:25:46Z", "updated_at": "2023-05-09T09:50:38Z", "closed_at": "2023-05-09T09:50:38Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I tried this code:\r\n\r\n```rust\r\nfn main() {\r\n    let a = vec![String::new(), String::new()];\r\n    let b = [()];\r\n    \r\n    let mut counter = 0;\r\n    \r\n    a.into_iter() \r\n        .map(|i| {\r\n            counter += 1;\r\n            i\r\n        })\r\n        .zip(&b)\r\n        .zip(&b)\r\n        .for_each(drop);\r\n        \r\n    assert_eq!(counter, 2);\r\n    \r\n    let a = vec![String::new(), String::new()];\r\n    let b = [()];\r\n    \r\n    let mut counter = 0;\r\n    \r\n    a.iter()\r\n        .map(|i| {\r\n            counter += 1;\r\n            i\r\n        })\r\n        .zip(&b)\r\n        .zip(&b)\r\n        .for_each(drop);\r\n        \r\n    assert_eq!(counter, 2); // this fails, even though it succeed in the non-specialized version\r\n}\r\n```\r\n\r\n[Playground link](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=ea8aba7edc1f116ef5bf2bac4056464c)\r\n\r\nI would expect the two iterators to behave the same, so either both asserts fail (actually the first should stop the program) or neither of them. Instead, the second iterator doesn't preserve side-effects. causing the second assert (and only that one) to fail.\r\n\r\nI don't think there's a way to solve this without completly changing the `TrustedRandomAccess` trait to use some type level trickery to replace `may_have_side_effect`. I wonder if there's even a point to keep the simulated side effects in the specialized `ZipImpl::next` if it doesn't cover all cases.", "closed_by": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/82303/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/82303/timeline", "performed_via_github_app": null, "state_reason": "not_planned"}