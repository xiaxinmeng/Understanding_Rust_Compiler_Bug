{"url": "https://api.github.com/repos/rust-lang/rust/issues/69327", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/69327/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/69327/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/69327/events", "html_url": "https://github.com/rust-lang/rust/issues/69327", "id": 568570218, "node_id": "MDU6SXNzdWU1Njg1NzAyMTg=", "number": 69327, "title": " rustc 1.43.0-nightly (7760cd0fb 2020-02-19) static builds on alpine throw compiler error on building any orjson/maturin", "user": {"login": "autumnjolitz", "id": 270476, "node_id": "MDQ6VXNlcjI3MDQ3Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/270476?v=4", "gravatar_id": "", "url": "https://api.github.com/users/autumnjolitz", "html_url": "https://github.com/autumnjolitz", "followers_url": "https://api.github.com/users/autumnjolitz/followers", "following_url": "https://api.github.com/users/autumnjolitz/following{/other_user}", "gists_url": "https://api.github.com/users/autumnjolitz/gists{/gist_id}", "starred_url": "https://api.github.com/users/autumnjolitz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/autumnjolitz/subscriptions", "organizations_url": "https://api.github.com/users/autumnjolitz/orgs", "repos_url": "https://api.github.com/users/autumnjolitz/repos", "events_url": "https://api.github.com/users/autumnjolitz/events{/privacy}", "received_events_url": "https://api.github.com/users/autumnjolitz/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2020-02-20T21:01:12Z", "updated_at": "2020-02-20T21:59:06Z", "closed_at": "2020-02-20T21:59:06Z", "author_association": "NONE", "active_lock_reason": null, "body": "Rust compiler states this is a bug and should be reported, so I'm listening to the compiler \ud83d\ude02 \r\n\r\nI use orjson in an alpine environment for fast json parsing in python. Unfortunately, the latest release and its dependencies have learned how to provoke a bug in rustc! \ud83d\ude2e \r\n\r\nOutput:\r\n\r\n```\r\nBuilding wheels for collected packages: orjson\r\n  Created temporary directory: /tmp/pip-wheel-puew_nt4\r\n  Destination directory: /tmp/pip-wheel-puew_nt4\r\n  Building wheel for orjson (PEP 517): started\r\n  Running command /usr/local/bin/python3 /usr/local/lib/python3.7/site-packages/pip/_vendor/pep517/_in_process.py build_wheel /tmp/tmp7cas0fmw\r\n     Compiling proc-macro2 v1.0.8\r\n     Compiling unicode-xid v0.2.0\r\n     Compiling syn v1.0.14\r\n     Compiling cfg-if v0.1.10\r\n     Compiling ryu v1.0.2\r\n     Compiling libc v0.2.66\r\n     Compiling serde v1.0.104\r\n     Compiling memchr v2.3.2\r\n     Compiling typenum v1.11.2\r\n     Compiling getrandom v0.1.14\r\n     Compiling lazy_static v1.4.0\r\n     Compiling autocfg v1.0.0\r\n     Compiling regex-syntax v0.6.14\r\n     Compiling itoa v0.4.5\r\n     Compiling bitflags v1.2.1\r\n     Compiling byteorder v1.3.4\r\n     Compiling lexical-core v0.7.4\r\n     Compiling unindent v0.1.5\r\n     Compiling ppv-lite86 v0.2.6\r\n     Compiling version_check v0.9.1\r\n     Compiling scopeguard v1.1.0\r\n     Compiling packed_simd v0.3.3\r\n     Compiling smallvec v1.2.0\r\n     Compiling encoding_rs v0.8.22\r\n     Compiling arrayvec v0.5.1\r\n     Compiling stable_deref_trait v1.1.1\r\n     Compiling static_assertions v1.1.0\r\n     Compiling heapless v0.5.3\r\n     Compiling rand_core v0.4.2\r\n     Compiling associative-cache v1.0.1\r\n     Compiling inlinable_string v0.1.11\r\n     Compiling thread_local v1.0.1\r\n     Compiling lock_api v0.3.3\r\n     Compiling wyhash v0.3.0\r\n     Compiling c2-chacha v0.2.3\r\n     Compiling num-traits v0.2.11\r\n     Compiling aho-corasick v0.7.8\r\n     Compiling hash32 v0.1.1\r\n     Compiling quote v1.0.2\r\n     Compiling parking_lot_core v0.7.0\r\n     Compiling rand_core v0.5.1\r\n     Compiling generic-array v0.12.3\r\n     Compiling generic-array v0.13.2\r\n     Compiling parking_lot v0.10.0\r\n     Compiling rand_chacha v0.2.1\r\n     Compiling regex v1.3.4\r\n     Compiling as-slice v0.1.3\r\n     Compiling rand v0.7.3\r\n     Compiling pyo3-derive-backend v0.9.0-alpha.1\r\n  thread 'rustc' panicked at 'Box<Any>', <::std::macros::panic macros>:2:4\r\n  stack backtrace:\r\n     0: backtrace::backtrace::libunwind::trace\r\n               at /cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.44/src/backtrace/libunwind.rs:86\r\n     1: backtrace::backtrace::trace_unsynchronized\r\n               at /cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.44/src/backtrace/mod.rs:66\r\n     2: std::sys_common::backtrace::_print_fmt\r\n               at src/libstd/sys_common/backtrace.rs:78\r\n     3: <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt\r\n               at src/libstd/sys_common/backtrace.rs:59\r\n     4: core::fmt::write\r\n               at src/libcore/fmt/mod.rs:1052\r\n     5: std::io::Write::write_fmt\r\n               at src/libstd/io/mod.rs:1428\r\n     6: std::sys_common::backtrace::_print\r\n               at src/libstd/sys_common/backtrace.rs:62\r\n     7: std::sys_common::backtrace::print\r\n               at src/libstd/sys_common/backtrace.rs:49\r\n     8: std::panicking::default_hook::{{closure}}\r\n               at src/libstd/panicking.rs:204\r\n     9: std::panicking::default_hook\r\n               at src/libstd/panicking.rs:224\r\n    10: rustc_driver::report_ice\r\n    11: std::panicking::rust_panic_with_hook\r\n               at src/libstd/panicking.rs:474\r\n    12: std::panicking::begin_panic\r\n    13: rustc_errors::HandlerInner::span_bug\r\n    14: rustc_errors::Handler::span_bug\r\n    15: rustc::util::bug::opt_span_bug_fmt::{{closure}}\r\n    16: rustc::ty::context::tls::with_opt::{{closure}}\r\n    17: rustc::ty::context::tls::with_opt\r\n    18: rustc::util::bug::opt_span_bug_fmt\r\n    19: rustc::util::bug::span_bug_fmt\r\n    20: <core::iter::adapters::Map<I,F> as core::iter::traits::iterator::Iterator>::fold\r\n    21: rustc_codegen_ssa::mir::block::<impl rustc_codegen_ssa::mir::FunctionCx<Bx>>::codegen_call_terminator\r\n    22: rustc_codegen_ssa::mir::block::<impl rustc_codegen_ssa::mir::FunctionCx<Bx>>::codegen_block\r\n    23: rustc_codegen_ssa::base::codegen_instance\r\n    24: <rustc::mir::mono::MonoItem as rustc_codegen_ssa::mono_item::MonoItemExt>::define\r\n    25: rustc_codegen_llvm::base::compile_codegen_unit::module_codegen\r\n    26: rustc::dep_graph::graph::DepGraph::with_task\r\n    27: rustc_codegen_llvm::base::compile_codegen_unit\r\n    28: rustc_codegen_ssa::base::codegen_crate\r\n    29: <rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_utils::codegen_backend::CodegenBackend>::codegen_crate\r\n    30: rustc_session::utils::<impl rustc_session::session::Session>::time\r\n    31: rustc_interface::passes::QueryContext::enter\r\n    32: rustc_interface::queries::Queries::ongoing_codegen\r\n    33: rustc_interface::interface::run_compiler_in_existing_thread_pool\r\n    34: scoped_tls::ScopedKey<T>::set\r\n    35: syntax::attr::with_globals\r\n  note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n\r\n  note: the compiler unexpectedly panicked. this is a bug.\r\n\r\n  note: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\n  note: rustc 1.43.0-nightly (7760cd0fb 2020-02-19) running on x86_64-unknown-linux-musl\r\n\r\n  note: compiler flags: -C opt-level=3 -C panic=abort -C codegen-units=1 -C target-feature=-crt-static --crate-type lib\r\n\r\n  note: some of the compiler flags provided by cargo are hidden\r\n\r\n  query stack during panic:\r\n  end of query stack\r\n  error: could not compile `encoding_rs`.\r\n\r\n  To learn more, run the command again with --verbose.\r\n  warning: build failed, waiting for other jobs to finish...\r\n  error: build failed\r\n  \ud83d\udca5 maturin failed\r\n    Caused by: Failed to build a native library through cargo\r\n    Caused by: Cargo build finished with \"exit code: 101\": `cargo rustc --message-format json --manifest-path Cargo.toml --lib --release -- -Zmutable-noalias -C target-feature=+sse2 -C link-arg=-s`\r\n  Running `maturin pep517 build-wheel -i python --manylinux=off --rustc-extra-args=-Zmutable-noalias -C target-feature=+sse2 --strip=on`\r\n  Error: Command '['maturin', 'pep517', 'build-wheel', '-i', 'python', '--manylinux=off', '--rustc-extra-args=-Zmutable-noalias -C target-feature=+sse2', '--strip=on']' returned non-zero exit status 1.\r\n  Building wheel for orjson (PEP 517): finished with status 'error'\r\n  ERROR: Failed building wheel for orjson\r\n```\r\n\r\nHere's how I caused it (I use osx as a main development machine so all my linux builds are through docker \ud83d\ude43\r\n\r\nDockerfile:\r\n```\r\nFROM python:3.7-alpine\r\nENV PIP_NO_CACHE_DIR=off \\\r\n    PIP_DISABLE_PIP_VERSION_CHECK=on \\\r\n    RUSTUP_HOME=/usr/local \\\r\n    CARGO_HOME=/usr/local \\\r\n    RUSTFLAGS=\"-C target-feature=-crt-static\" \\\r\n    RUST_BACKTRACE=1\r\nRUN apk add --no-cache build-base libffi-dev openssl-dev curl && \\\r\n    (curl https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path) && rustup install nightly && rustup default nightly && \\\r\n    python3 -m ensurepip && \\\r\n    pip3 install --upgrade pip setuptools wheel && \\\r\n    if [[ ! -e /usr/bin/python ]]; then ln -sf /usr/bin/python3 /usr/bin/python; fi\r\nRUN python3 -m pip install --verbose orjson\r\n```\r\n\r\nTrigger the build via: `docker build -f Dockerfile .` and watch it explode\r\n\r\nJust tried an earlier orjson. Same error \ud83d\ude33 ", "closed_by": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/69327/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/69327/timeline", "performed_via_github_app": null, "state_reason": "completed"}