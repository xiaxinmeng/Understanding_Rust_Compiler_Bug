{"url": "https://api.github.com/repos/rust-lang/rust/issues/3674", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/3674/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/3674/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/3674/events", "html_url": "https://github.com/rust-lang/rust/issues/3674", "id": 7396437, "node_id": "MDU6SXNzdWU3Mzk2NDM3", "number": 3674, "title": "Crash \"free(): invalid pointer\" in sock.read() in a separate task", "user": {"login": "ttaubert", "id": 300895, "node_id": "MDQ6VXNlcjMwMDg5NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/300895?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ttaubert", "html_url": "https://github.com/ttaubert", "followers_url": "https://api.github.com/users/ttaubert/followers", "following_url": "https://api.github.com/users/ttaubert/following{/other_user}", "gists_url": "https://api.github.com/users/ttaubert/gists{/gist_id}", "starred_url": "https://api.github.com/users/ttaubert/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ttaubert/subscriptions", "organizations_url": "https://api.github.com/users/ttaubert/orgs", "repos_url": "https://api.github.com/users/ttaubert/repos", "events_url": "https://api.github.com/users/ttaubert/events{/privacy}", "received_events_url": "https://api.github.com/users/ttaubert/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 100522, "node_id": "MDU6TGFiZWwxMDA1MjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-crash", "name": "I-crash", "color": "e10c02", "default": false, "description": "Issue: The compiler crashes (SIGSEGV, SIGABRT, etc). Use I-ICE instead when the compiler panics."}, {"id": 9695584, "node_id": "MDU6TGFiZWw5Njk1NTg0", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-concurrency", "name": "A-concurrency", "color": "f7e101", "default": false, "description": "Area: Concurrency related issues."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 11, "created_at": "2012-10-06T11:53:19Z", "updated_at": "2013-05-29T19:11:18Z", "closed_at": "2013-05-29T19:11:18Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I compiled a little tcp listener example that spawns tasks per connection. The sock.read() call fails when it receives data - just use telnet to connect, type something and hit enter:\n\n``` rust\nextern mod std;\n\nuse std::uv;\nuse std::net::{ip, tcp};\n\nfn main() {\n  let iotask = uv::global_loop::get();\n  let addr = ip::v4::parse_addr(\"127.0.0.1\");\n\n  tcp::listen(addr, 4000u, 128u, iotask,\n    |kill_ch| {\n      #info(\"server is listening\");\n    },\n\n    |new_conn, kill_ch| {\n      let port = comm::Port::<()>();\n      let chan = port.chan();\n\n      do task::spawn_sched(task::ManualThreads(1u)) {\n        let accept_result = tcp::accept(new_conn);\n        chan.send(());\n\n        if accept_result.is_err() {\n          let err_data = result::unwrap_err(accept_result);\n          kill_ch.send(Some(err_data));\n        } else {\n          let sock = result::unwrap(accept_result);\n          let read_result = sock.read(0);\n          if read_result.is_ok() {\n            io::println(\"success\");\n          } else {\n            kill_ch.send(None);\n          }\n        }\n      }\n\n      chan.recv();\n    }\n  );\n}\n```\n\nThis used to work with Rust 0.3 but crashes now with the following message:\n\n```\n*** glibc detected *** ./test: free(): invalid pointer: 0x00007f94c41027a8 ***\n======= Backtrace: =========\n/lib/x86_64-linux-gnu/libc.so.6(+0x7ec96)[0x7f94cd920c96]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so(+0x36e6d)[0x7f94cdeade6d]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so(upcall_call_shim_on_c_stack+0x87)[0x7f94cde97cd7]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/libstd-4782a756585a81-0.4.so(+0x63210)[0x7f94cdf44210]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so(+0x36e6d)[0x7f94cdeade6d]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so(upcall_call_shim_on_rust_stack+0xcf)[0x7f94cde97fff]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/libstd-4782a756585a81-0.4.so(+0x60a95)[0x7f94cdf41a95]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so(+0x3af77)[0x7f94cdeb1f77]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so(+0x4099f)[0x7f94cdeb799f]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so(+0x458b8)[0x7f94cdebc8b8]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so(+0x37d12)[0x7f94cdeaed12]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so(+0x36e6d)[0x7f94cdeade6d]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so(upcall_call_shim_on_c_stack+0x87)[0x7f94cde97cd7]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/libstd-4782a756585a81-0.4.so(+0x78b6e)[0x7f94cdf59b6e]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/libstd-4782a756585a81-0.4.so(+0x7ea0e)[0x7f94cdf5fa0e]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/libstd-4782a756585a81-0.4.so(+0xe8710)[0x7f94cdfc9710]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/libcore-c3ca5d77d81b46c1-0.4.so(_ZN7private11weaken_task17_a2f0b02d17df416d3_04E+0xd2)[0x7f94ce150fe2]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/libstd-4782a756585a81-0.4.so(+0x7e4b9)[0x7f94cdf5f4b9]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/libcore-c3ca5d77d81b46c1-0.4.so(+0x76322)[0x7f94ce136322]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/libcore-c3ca5d77d81b46c1-0.4.so(+0xb6000)[0x7f94ce176000]\n/home/tim/workspace/rust-memcached/../../../../usr/local/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so(_Z18task_start_wrapperP10spawn_args+0x24)[0x7f94cde960e4]\n```\n", "closed_by": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/3674/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/3674/timeline", "performed_via_github_app": null, "state_reason": "completed"}