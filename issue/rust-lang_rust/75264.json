{"url": "https://api.github.com/repos/rust-lang/rust/issues/75264", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/75264/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/75264/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/75264/events", "html_url": "https://github.com/rust-lang/rust/issues/75264", "id": 675171184, "node_id": "MDU6SXNzdWU2NzUxNzExODQ=", "number": 75264, "title": "Performance: `Layout::align()` can assume, that the alignment is a power of two", "user": {"login": "TimDiekmann", "id": 21277928, "node_id": "MDQ6VXNlcjIxMjc3OTI4", "avatar_url": "https://avatars.githubusercontent.com/u/21277928?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TimDiekmann", "html_url": "https://github.com/TimDiekmann", "followers_url": "https://api.github.com/users/TimDiekmann/followers", "following_url": "https://api.github.com/users/TimDiekmann/following{/other_user}", "gists_url": "https://api.github.com/users/TimDiekmann/gists{/gist_id}", "starred_url": "https://api.github.com/users/TimDiekmann/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TimDiekmann/subscriptions", "organizations_url": "https://api.github.com/users/TimDiekmann/orgs", "repos_url": "https://api.github.com/users/TimDiekmann/repos", "events_url": "https://api.github.com/users/TimDiekmann/events{/privacy}", "received_events_url": "https://api.github.com/users/TimDiekmann/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 129836139, "node_id": "MDU6TGFiZWwxMjk4MzYxMzk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-allocators", "name": "A-allocators", "color": "f7e101", "default": false, "description": "Area: Custom and system allocators"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2020-08-07T17:43:52Z", "updated_at": "2020-08-08T06:45:32Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "An alignment is guaranteed to be a power of two. However without intrinsics it's not possible to use this guarantee when constructing a new `Layout` from an old one only changing the size. For testing I used the following code:\r\n\r\n```rust\r\npub fn dynamic_slow(layout: Layout, size: usize) -> Result<Layout, LayoutErr>{\r\n    let align = layout.align();\r\n    Layout::from_size_align(size, align)\r\n}\r\n\r\npub fn dynamic_fast(layout: Layout, size: usize) -> Result<Layout, LayoutErr>{\r\n    let align = layout.align();\r\n    unsafe { core::intrinsics::assume(align.is_power_of_two()); }\r\n    Layout::from_size_align(size, align)\r\n}\r\n\r\npub fn static_slow() -> Result<Layout, LayoutErr> {\r\n    dynamic_slow(Layout::new::<u32>(), 12)\r\n}\r\n\r\npub fn static_fast() -> Result<Layout, LayoutErr> {\r\n    dynamic_fast(Layout::new::<u32>(), 12)\r\n}\r\n```\r\n\r\n`dynamic_fast` assumes, that the alignment returned from `Layout` is a power of two. This results in [this assembly](https://godbolt.org/z/crEqz5):\r\n\r\n```asm\r\nexample::dynamic_slow:\r\n        lea     rax, [rsi - 1]\r\n        mov     r8, rsi\r\n        neg     r8\r\n        xor     ecx, ecx\r\n        test    rsi, rax\r\n        mov     rdi, rsi\r\n        cmovne  rdi, rcx\r\n        test    rsi, rsi\r\n        cmove   rdi, rsi\r\n        mov     rax, rdx\r\n        cmp     r8, rdx\r\n        cmovae  rcx, rdi\r\n        mov     rdx, rcx\r\n        ret\r\n\r\nexample::dynamic_fast:\r\n        mov     rax, rdx\r\n        mov     rcx, rsi\r\n        neg     rcx\r\n        xor     edx, edx\r\n        cmp     rcx, rax\r\n        cmovae  rdx, rsi\r\n        ret\r\n\r\nexample::static_slow:\r\n        mov     eax, 12\r\n        mov     edx, 4\r\n        ret\r\n\r\nexample::static_fast:\r\n        mov     eax, 12\r\n        mov     edx, 4\r\n        ret\r\n```\r\n\r\nWhile in the static case, this does not matter, the dynamic case don't have to check `align.is_power_of_two()`.\r\n\r\nNormally, I would create a pull request, which adds the intrinsic to `Layout::align()`, but `core::intrinsics::assume` is not available in `const fn`s.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/75264/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/75264/timeline", "performed_via_github_app": null, "state_reason": null}