{"url": "https://api.github.com/repos/rust-lang/rust/issues/37823", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/37823/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/37823/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/37823/events", "html_url": "https://github.com/rust-lang/rust/issues/37823", "id": 189969025, "node_id": "MDU6SXNzdWUxODk5NjkwMjU=", "number": 37823, "title": "MIPS host bootstrap: compiler_rt stack overflows", "user": {"login": "xen0n", "id": 1175567, "node_id": "MDQ6VXNlcjExNzU1Njc=", "avatar_url": "https://avatars.githubusercontent.com/u/1175567?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xen0n", "html_url": "https://github.com/xen0n", "followers_url": "https://api.github.com/users/xen0n/followers", "following_url": "https://api.github.com/users/xen0n/following{/other_user}", "gists_url": "https://api.github.com/users/xen0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/xen0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xen0n/subscriptions", "organizations_url": "https://api.github.com/users/xen0n/orgs", "repos_url": "https://api.github.com/users/xen0n/repos", "events_url": "https://api.github.com/users/xen0n/events{/privacy}", "received_events_url": "https://api.github.com/users/xen0n/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 11, "created_at": "2016-11-17T08:01:32Z", "updated_at": "2016-11-24T06:26:51Z", "closed_at": "2016-11-24T06:26:51Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The cross-compiled MIPS host compilers are fine, but stage1 immediately segfaults when asked to do just about anything:\r\n\r\n```rust\r\n// x.rs\r\nfn main() {\r\n}\r\n```\r\n\r\n```\r\n$ ./build/mips64el-unknown-linux-gnuabi64/stage1/bin/rustc ./x.rs\r\n\r\nthread 'rustc' has overflowed its stack\r\nfatal runtime error: stack overflow\r\n[1]    3433 IOT instruction (core dumped)  ./build/mips64el-unknown-linux-gnuabi64/stage1/bin/rustc ./x.rs\r\n```\r\n\r\n```\r\n(gdb) r ./x.rs\r\nStarting program: /opt/store/src/rust/build/mips64el-unknown-linux-gnuabi64/stage1/bin/rustc ./x.rs\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib64/libthread_db.so.1\".\r\n[New Thread 0xfff353ef10 (LWP 3476)]\r\n\r\nThread 2 \"rustc\" received signal SIGSEGV, Segmentation fault.\r\n[Switching to Thread 0xfff353ef10 (LWP 3476)]\r\n0x000000fff57198b8 in __ctzdi2 () from /opt/store/src/rust/build/mips64el-unknown-linux-gnuabi64/stage1/bin/../lib/../lib/librustc_llvm-d0f44aedc4c18d77.so\r\n(gdb) disas\r\nDump of assembler code for function __ctzdi2:\r\n   0x000000fff57198b0 <+0>:     daddiu  sp,sp,-32\r\n   0x000000fff57198b4 <+4>:     sll     v0,a0,0x0\r\n=> 0x000000fff57198b8 <+8>:     sd      s0,8(sp)\r\n   0x000000fff57198bc <+12>:    sltiu   s0,v0,1\r\n   0x000000fff57198c0 <+16>:    sd      gp,16(sp)\r\n   0x000000fff57198c4 <+20>:    dnegu   s0,s0\r\n   0x000000fff57198c8 <+24>:    lui     gp,0x96\r\n   0x000000fff57198cc <+28>:    nor     a1,zero,s0\r\n   0x000000fff57198d0 <+32>:    daddu   gp,gp,t9\r\n   0x000000fff57198d4 <+36>:    dsra32  a0,a0,0x0\r\n   0x000000fff57198d8 <+40>:    and     v1,a0,s0\r\n   0x000000fff57198dc <+44>:    daddiu  gp,gp,18760\r\n   0x000000fff57198e0 <+48>:    and     a0,a1,v0\r\n   0x000000fff57198e4 <+52>:    ld      t9,-32584(gp)\r\n   0x000000fff57198e8 <+56>:    or      a0,v1,a0\r\n   0x000000fff57198ec <+60>:    dsll32  a0,a0,0x0\r\n   0x000000fff57198f0 <+64>:    sd      ra,24(sp)\r\n   0x000000fff57198f4 <+68>:    bal     0xfff57198b0 <__ctzdi2>\r\n   0x000000fff57198f8 <+72>:    dsrl32  a0,a0,0x0\r\n   0x000000fff57198fc <+76>:    ld      ra,24(sp)\r\n   0x000000fff5719900 <+80>:    andi    s0,s0,0x20\r\n   0x000000fff5719904 <+84>:    addu    v0,v0,s0\r\n   0x000000fff5719908 <+88>:    ld      gp,16(sp)\r\n   0x000000fff571990c <+92>:    ld      s0,8(sp)\r\n   0x000000fff5719910 <+96>:    jr      ra\r\n   0x000000fff5719914 <+100>:   daddiu  sp,sp,32\r\nEnd of assembler dump.\r\n```\r\n\r\nNotice the recursion, which is obviously wrong, and non-existent on stage0:\r\n\r\n```\r\n$ ar x ../../../nightly/2016-11-14/lib/rustlib/mips64el-unknown-linux-gnuabi64/lib/libcompiler_builtins-e428224f6caf212a.rlib\r\n$ objdump -d ctzdi2.o\r\nctzdi2.o:     file format elf64-tradlittlemips\r\n\r\n\r\nDisassembly of section .text.__ctzdi2:\r\n\r\n0000000000000000 <__ctzdi2>:\r\n   0:   00041800        sll     v1,a0,0x0\r\n   4:   2c650001        sltiu   a1,v1,1\r\n   8:   0005282f        dnegu   a1,a1\r\n   c:   0004203f        dsra32  a0,a0,0x0\r\n  10:   0065200a        movz    a0,v1,a1\r\n  14:   00041023        negu    v0,a0\r\n  18:   00822024        and     a0,a0,v0\r\n  1c:   70842020        clz     a0,a0\r\n  20:   2402001f        li      v0,31\r\n  24:   00441023        subu    v0,v0,a0\r\n  28:   30a50020        andi    a1,a1,0x20\r\n  2c:   03e00008        jr      ra\r\n  30:   00a21021        addu    v0,a1,v0\r\n  34:   00000000        nop\r\n```\r\n\r\nThis is [LLVM bug 11663](https://llvm.org/bugs/show_bug.cgi?format=multiple&id=11663). Maybe we should incorporate the workaround there as well.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/37823/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/37823/timeline", "performed_via_github_app": null, "state_reason": "completed"}