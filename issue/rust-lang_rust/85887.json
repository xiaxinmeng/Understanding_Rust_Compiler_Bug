{"url": "https://api.github.com/repos/rust-lang/rust/issues/85887", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/85887/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/85887/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/85887/events", "html_url": "https://github.com/rust-lang/rust/issues/85887", "id": 908121947, "node_id": "MDU6SXNzdWU5MDgxMjE5NDc=", "number": 85887, "title": "Internal Compiler Error while compiling a special diesel change", "user": {"login": "weiznich", "id": 1674512, "node_id": "MDQ6VXNlcjE2NzQ1MTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1674512?v=4", "gravatar_id": "", "url": "https://api.github.com/users/weiznich", "html_url": "https://github.com/weiznich", "followers_url": "https://api.github.com/users/weiznich/followers", "following_url": "https://api.github.com/users/weiznich/following{/other_user}", "gists_url": "https://api.github.com/users/weiznich/gists{/gist_id}", "starred_url": "https://api.github.com/users/weiznich/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/weiznich/subscriptions", "organizations_url": "https://api.github.com/users/weiznich/orgs", "repos_url": "https://api.github.com/users/weiznich/repos", "events_url": "https://api.github.com/users/weiznich/events{/privacy}", "received_events_url": "https://api.github.com/users/weiznich/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1359848690, "node_id": "MDU6TGFiZWwxMzU5ODQ4Njkw", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-mcve", "name": "E-needs-mcve", "color": "02e10c", "default": false, "description": "Call for participation: This issue needs a Minimal Complete and Verifiable Example"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-06-01T09:59:10Z", "updated_at": "2021-07-01T20:33:32Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for finding an Internal Compiler Error! \ud83e\uddca  If possible, try to provide\r\na minimal verifiable example. You can read \"Rust Bug Minimization Patterns\" for\r\nhow to create smaller examples.\r\n\r\nhttp://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/\r\n\r\n-->\r\n\r\n### Code\r\n\r\nWhile working on diesel rustc crashed. I've uploaded my current local version here: https://github.com/weiznich/diesel/commit/062572ee329243b1c01460adcdf55f1a112e92f8. I'm happy to provide some guidiance about what could be relevant for minimization, but I unfortunally do not have the time to do that by myself.\r\n\r\nSteps to reproduce:\r\n1. Clone the repository and checkout the corresponding commit\r\n2. `cd /path/to/cloned/diesel/diesel_tests`\r\n3. `cargo test --no-default-features --features \"postgres\"\r\n\r\nWhile the error message seems to suggest that this is releated to incremental compilation, this happen for me for clean builds. The target directory mentioned in the warning message above the crash is writeable and compilations generally work fine using this directory.\r\n\r\n\r\n### Meta\r\nI can reproduce this error for the following rustc versions:\r\n\r\n```\r\nrustc 1.48.0 (7eac88abb 2020-11-16)\r\nrustc 1.52.1 (9bc8c42bb 2021-05-09)\r\nrustc 1.54.0-nightly (657bc0188 2021-05-31)\r\n```\r\n\r\n\r\n### Error output\r\n\r\n```\r\nRUST_BACKTRACE=1 cargo +nightly test --no-default-features --features=\"postgres\"\r\n   Compiling diesel v2.0.0 (/home/weiznich/Dokumente/rust/diesel/diesel)\r\nwarning: missing documentation for a trait\r\n   --> diesel/src/connection/mod.rs:28:1\r\n    |\r\n28  | pub trait IterableConnection<'a, DB: Backend> {\r\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    |\r\nnote: the lint level is defined here\r\n   --> diesel/src/lib.rs:102:5\r\n    |\r\n102 |     missing_docs\r\n    |     ^^^^^^^^^^^^\r\n\r\nwarning: missing documentation for an associated type\r\n  --> diesel/src/connection/mod.rs:29:5\r\n   |\r\n29 |     type Cursor: Iterator<Item = QueryResult<Self::Row>>;\r\n   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\nwarning: missing documentation for an associated type\r\n  --> diesel/src/connection/mod.rs:30:5\r\n   |\r\n30 |     type Row: crate::row::Row<'a, DB>;\r\n   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\nwarning: type does not implement `Debug`; consider adding `#[derive(Debug)]` or a manual implementation\r\n   --> diesel/src/query_dsl/load_dsl.rs:68:1\r\n    |\r\n68  | / pub struct LoadIter<'a, U, C, ST, DB> {\r\n69  | |     cursor: C,\r\n70  | |     _marker: std::marker::PhantomData<&'a (ST, U, DB)>,\r\n71  | | }\r\n    | |_^\r\n    |\r\nnote: the lint level is defined here\r\n   --> diesel/src/lib.rs:100:5\r\n    |\r\n100 |     missing_debug_implementations,\r\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\nwarning: type does not implement `Debug`; consider adding `#[derive(Debug)]` or a manual implementation\r\n  --> diesel/src/pg/connection/cursor.rs:8:1\r\n   |\r\n8  | / pub struct Cursor<'a> {\r\n9  | |     current_row: usize,\r\n10 | |     db_result: Rc<PgResult<'a>>,\r\n11 | | }\r\n   | |_^\r\n\r\nwarning: type does not implement `Debug`; consider adding `#[derive(Debug)]` or a manual implementation\r\n  --> diesel/src/pg/connection/result.rs:15:1\r\n   |\r\n15 | / pub struct PgResult<'a> {\r\n16 | |     internal_result: RawResult,\r\n17 | |     column_count: usize,\r\n18 | |     row_count: usize,\r\n19 | |     _marker: PhantomData<&'a super::PgConnection>\r\n20 | | }\r\n   | |_^\r\n\r\nwarning: type does not implement `Debug`; consider adding `#[derive(Debug)]` or a manual implementation\r\n  --> diesel/src/pg/connection/row.rs:7:1\r\n   |\r\n7  | / pub struct PgRow<'a> {\r\n8  | |     db_result: Rc<PgResult<'a>>,\r\n9  | |     row_idx: usize,\r\n10 | | }\r\n   | |_^\r\n\r\nwarning: type does not implement `Debug`; consider adding `#[derive(Debug)]` or a manual implementation\r\n  --> diesel/src/pg/connection/row.rs:59:1\r\n   |\r\n59 | / pub struct PgField<'a> {\r\n60 | |     db_result: Rc<PgResult<'a>>,\r\n61 | |     row_idx: usize,\r\n62 | |     col_idx: usize,\r\n63 | | }\r\n   | |_^\r\n\r\n   Compiling diesel_migrations v2.0.0 (/home/weiznich/Dokumente/rust/diesel/diesel_migrations)\r\nwarning: Error finalizing incremental compilation session directory `/home/weiznich/Dokumente/rust/shared_target/debug/incremental/diesel-3rkg3lwwyoug5/s-fz54zikf9w-1bya14u-working`: No such file or directory (os error 2)\r\n\r\nwarning: 9 warnings emitted\r\n\r\nerror: internal compiler error: Encountered errors `[FulfillmentError(Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [expression::sql_literal::SqlLiteral<sql_types::Text>, ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:5182 ~ diesel[f7a1]::query_dsl::load_dsl::{impl#4}::'a), 'a) }), pg::connection::PgConnection, std::string::String], item_def_id: DefId(0:5132 ~ diesel[f7a1]::query_dsl::load_dsl::LoadQueryRet::Ret) }, query_dsl::load_dsl::LoadIter<'a, std::string::String, <pg::connection::PgConnection as connection::IterableConnection<'a, pg::backend::Pg>>::Cursor, sql_types::Text, pg::backend::Pg>), [Region(BrNamed(DefId(0:5182 ~ diesel[f7a1]::query_dsl::load_dsl::{impl#4}::'a), 'a))]), depth=1),MismatchedProjectionTypes(Sorts(ExpectedFound { expected: pg::connection::cursor::Cursor<'_>, found: <pg::connection::PgConnection as connection::IterableConnection<'a, pg::backend::Pg>>::Cursor })))]` resolving bounds after type-checking\r\n  |\r\n  = note: delayed at compiler/rustc_trait_selection/src/traits/codegen.rs:124:24\r\n\r\nerror: internal compiler error: Encountered errors `[FulfillmentError(Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [query_builder::select_statement::SelectStatement<query_source::joins::JoinOn<query_source::joins::Join<pg::metadata_lookup::pg_type::table, pg::metadata_lookup::pg_namespace::table, query_source::joins::Inner>, expression::grouped::Grouped<expression::operators::Eq<expression::nullable::Nullable<pg::metadata_lookup::pg_type::columns::typnamespace>, expression::nullable::Nullable<pg::metadata_lookup::pg_namespace::columns::oid>>>>, query_builder::select_clause::SelectClause<(pg::metadata_lookup::pg_type::columns::oid, pg::metadata_lookup::pg_type::columns::typarray)>, query_builder::distinct_clause::NoDistinctClause, query_builder::where_clause::WhereClause<expression::grouped::Grouped<expression::operators::And<expression::grouped::Grouped<expression::operators::Eq<pg::metadata_lookup::pg_type::columns::typname, expression::bound::Bound<sql_types::Text, &str>>>, expression::grouped::Grouped<expression::operators::Or<expression::grouped::Grouped<expression::operators::Eq<pg::metadata_lookup::pg_namespace::columns::nspname, pg::expression::array_comparison::Any<expression::bound::Bound<pg::types::sql_types::Array<sql_types::Text>, std::vec::Vec<&str>>>>>, expression::grouped::Grouped<expression::operators::Eq<pg::metadata_lookup::pg_namespace::columns::oid, pg::metadata_lookup::pg_my_temp_schema::pg_my_temp_schema>>>>>>>, query_builder::order_clause::NoOrderClause, query_builder::limit_offset_clause::LimitOffsetClause<query_builder::limit_clause::LimitClause<expression::bound::Bound<sql_types::BigInt, i64>>, query_builder::offset_clause::NoOffsetClause>>, ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:5182 ~ diesel[f7a1]::query_dsl::load_dsl::{impl#4}::'a), 'a) }), pg::connection::PgConnection, pg::backend::InnerPgTypeMetadata], item_def_id: DefId(0:5132 ~ diesel[f7a1]::query_dsl::load_dsl::LoadQueryRet::Ret) }, query_dsl::load_dsl::LoadIter<'a, pg::backend::InnerPgTypeMetadata, <pg::connection::PgConnection as connection::IterableConnection<'a, pg::backend::Pg>>::Cursor, (pg::types::sql_types::Oid, pg::types::sql_types::Oid), pg::backend::Pg>), [Region(BrNamed(DefId(0:5182 ~ diesel[f7a1]::query_dsl::load_dsl::{impl#4}::'a), 'a))]), depth=1),MismatchedProjectionTypes(Sorts(ExpectedFound { expected: pg::connection::cursor::Cursor<'_>, found: <pg::connection::PgConnection as connection::IterableConnection<'a, pg::backend::Pg>>::Cursor })))]` resolving bounds after type-checking\r\n  |\r\n  = note: delayed at compiler/rustc_trait_selection/src/traits/codegen.rs:124:24\r\n\r\nerror: internal compiler error: Encountered errors `[FulfillmentError(Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [query_builder::select_statement::SelectStatement<query_source::joins::JoinOn<query_source::joins::Join<pg::metadata_lookup::pg_type::table, pg::metadata_lookup::pg_namespace::table, query_source::joins::Inner>, expression::grouped::Grouped<expression::operators::Eq<expression::nullable::Nullable<pg::metadata_lookup::pg_type::columns::typnamespace>, expression::nullable::Nullable<pg::metadata_lookup::pg_namespace::columns::oid>>>>, query_builder::select_clause::SelectClause<(pg::metadata_lookup::pg_type::columns::oid, pg::metadata_lookup::pg_type::columns::typarray)>, query_builder::distinct_clause::NoDistinctClause, query_builder::where_clause::WhereClause<expression::grouped::Grouped<expression::operators::And<expression::grouped::Grouped<expression::operators::Eq<pg::metadata_lookup::pg_type::columns::typname, expression::bound::Bound<sql_types::Text, &str>>>, expression::grouped::Grouped<expression::operators::Eq<pg::metadata_lookup::pg_namespace::columns::nspname, pg::expression::array_comparison::Any<expression::bound::Bound<pg::types::sql_types::Array<sql_types::Text>, std::vec::Vec<&str>>>>>>>>, query_builder::order_clause::NoOrderClause, query_builder::limit_offset_clause::LimitOffsetClause<query_builder::limit_clause::LimitClause<expression::bound::Bound<sql_types::BigInt, i64>>, query_builder::offset_clause::NoOffsetClause>>, ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:5182 ~ diesel[f7a1]::query_dsl::load_dsl::{impl#4}::'a), 'a) }), pg::connection::PgConnection, pg::backend::InnerPgTypeMetadata], item_def_id: DefId(0:5132 ~ diesel[f7a1]::query_dsl::load_dsl::LoadQueryRet::Ret) }, query_dsl::load_dsl::LoadIter<'a, pg::backend::InnerPgTypeMetadata, <pg::connection::PgConnection as connection::IterableConnection<'a, pg::backend::Pg>>::Cursor, (pg::types::sql_types::Oid, pg::types::sql_types::Oid), pg::backend::Pg>), [Region(BrNamed(DefId(0:5182 ~ diesel[f7a1]::query_dsl::load_dsl::{impl#4}::'a), 'a))]), depth=1),MismatchedProjectionTypes(Sorts(ExpectedFound { expected: pg::connection::cursor::Cursor<'_>, found: <pg::connection::PgConnection as connection::IterableConnection<'a, pg::backend::Pg>>::Cursor })))]` resolving bounds after type-checking\r\n  |\r\n  = note: delayed at compiler/rustc_trait_selection/src/traits/codegen.rs:124:24\r\n\r\nthread 'rustc' panicked at 'no errors encountered even though `delay_span_bug` issued', compiler/rustc_errors/src/lib.rs:1021:13\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/657bc01888e6297257655585f9c475a0801db6d2/library/std/src/panicking.rs:515:5\r\n   1: std::panicking::begin_panic_fmt\r\n             at /rustc/657bc01888e6297257655585f9c475a0801db6d2/library/std/src/panicking.rs:457:5\r\n   2: rustc_errors::HandlerInner::flush_delayed\r\n   3: <rustc_errors::HandlerInner as core::ops::drop::Drop>::drop\r\n   4: core::ptr::drop_in_place<rustc_session::parse::ParseSess>\r\n   5: <alloc::rc::Rc<T> as core::ops::drop::Drop>::drop\r\n   6: core::ptr::drop_in_place<rustc_interface::interface::Compiler>\r\n   7: rustc_span::with_source_map\r\n   8: scoped_tls::ScopedKey<T>::set\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&template=ice.md\r\n\r\nnote: rustc 1.54.0-nightly (657bc0188 2021-05-31) running on x86_64-unknown-linux-gnu\r\n\r\nnote: compiler flags: -C embed-bitcode=no -C debuginfo=2 -C incremental -C link-args=-fuse-ld=lld -C link-arg=-fuse-ld=lld --crate-type lib\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n\r\nquery stack during panic:\r\nend of query stack\r\nerror: could not compile `diesel`\r\n```\r\n\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/85887/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/85887/timeline", "performed_via_github_app": null, "state_reason": null}