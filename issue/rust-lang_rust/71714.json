{"url": "https://api.github.com/repos/rust-lang/rust/issues/71714", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/71714/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/71714/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/71714/events", "html_url": "https://github.com/rust-lang/rust/issues/71714", "id": 610242594, "node_id": "MDU6SXNzdWU2MTAyNDI1OTQ=", "number": 71714, "title": "Use of tempfile for lib.def leads to non-reproducible PDBs", "user": {"login": "nikhilm", "id": 78682, "node_id": "MDQ6VXNlcjc4Njgy", "avatar_url": "https://avatars.githubusercontent.com/u/78682?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikhilm", "html_url": "https://github.com/nikhilm", "followers_url": "https://api.github.com/users/nikhilm/followers", "following_url": "https://api.github.com/users/nikhilm/following{/other_user}", "gists_url": "https://api.github.com/users/nikhilm/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikhilm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikhilm/subscriptions", "organizations_url": "https://api.github.com/users/nikhilm/orgs", "repos_url": "https://api.github.com/users/nikhilm/repos", "events_url": "https://api.github.com/users/nikhilm/events{/privacy}", "received_events_url": "https://api.github.com/users/nikhilm/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 203130, "node_id": "MDU6TGFiZWwyMDMxMzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-debuginfo", "name": "A-debuginfo", "color": "f7e101", "default": false, "description": "Area: Debugging information in compiled programs (DWARF, PDB, etc.)"}, {"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 266005765, "node_id": "MDU6TGFiZWwyNjYwMDU3NjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows-msvc", "name": "O-windows-msvc", "color": "6e6ec0", "default": false, "description": "Toolchain: MSVC, Operating system: Windows"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1508600909, "node_id": "MDU6TGFiZWwxNTA4NjAwOTA5", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-reproducibility", "name": "A-reproducibility", "color": "f7e101", "default": false, "description": "Area: Reproducible / Deterministic builds"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2020-04-30T17:04:35Z", "updated_at": "2023-06-19T14:38:34Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I've been working with a rust code base that we are trying to use a shared cache for (Bazel FWIW). As part of that I've been looking at truly bit-identical build outputs for a given set of inputs.\r\n\r\nThere are plenty of problems with PDB files on Windows (which contain debug info) because they tend to encode absolute paths to the object files and other resources they were created from. I've managed to eliminate most of these by using deterministic build directories across all machines, and using tempdir's that are a hash of something unique. There is just one more bit that I can't control directly, which is this use of `tmpdir.join(\"lib.def\")` https://github.com/rust-lang/rust/blob/0862458dad90a0d80827e22e3f86e33add6d847c/src/librustc_codegen_ssa/back/linker.rs#L720. This ends up putting a few random characters in the path that throws off the PDB.\r\n\r\nI'm not entirely sure what a good solution will look like. I'm not familiar enough with compiler internals to know if some deterministic location based on some unique values can be used, or alternatively if this can be exposed as a compiler option.\r\n\r\nI tried this code:\r\nI can't share our internal code, but build something like serde_derive on windows and look for the proc macro dll. there should be a pdb next to it.\r\nNext, you'll want to use `ducible` https://github.com/jasonwhite/ducible/ to remove a few other sources of non-determinism like timestamps.\r\n\r\n```\r\nducible <dll> <pdb>\r\n```\r\n\r\nI expected to see this happen: Each clean build results in the same DLL and PDB (sha256 or similar).\r\n\r\nInstead, this happened: the DLL is identical but the PDBs are not. Use something like https://www.cjmweb.net/vbindiff/ to spot the differences and the only one i noticed was this path to lib.def.\r\n\r\n\r\n### Meta\r\n\r\n(also exists in latest master based on code inspection).\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.42.0-nightly (212b2c7da 2020-01-30)\r\nbinary: rustc\r\ncommit-hash: 212b2c7da87f3086af535b33a9ca6b5242f2d5a7\r\ncommit-date: 2020-01-30\r\nhost: i686-pc-windows-msvc\r\nrelease: 1.42.0-nightly\r\nLLVM version: 9.0\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/71714/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/71714/timeline", "performed_via_github_app": null, "state_reason": null}