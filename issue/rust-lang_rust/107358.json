{"url": "https://api.github.com/repos/rust-lang/rust/issues/107358", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/107358/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/107358/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/107358/events", "html_url": "https://github.com/rust-lang/rust/issues/107358", "id": 1559579793, "node_id": "I_kwDOAAsO6M5c9UyR", "number": 107358, "title": "Runtime stackoverflow after updating to Rust 1.67", "user": {"login": "Jasperav", "id": 20363565, "node_id": "MDQ6VXNlcjIwMzYzNTY1", "avatar_url": "https://avatars.githubusercontent.com/u/20363565?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jasperav", "html_url": "https://github.com/Jasperav", "followers_url": "https://api.github.com/users/Jasperav/followers", "following_url": "https://api.github.com/users/Jasperav/following{/other_user}", "gists_url": "https://api.github.com/users/Jasperav/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jasperav/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jasperav/subscriptions", "organizations_url": "https://api.github.com/users/Jasperav/orgs", "repos_url": "https://api.github.com/users/Jasperav/repos", "events_url": "https://api.github.com/users/Jasperav/events{/privacy}", "received_events_url": "https://api.github.com/users/Jasperav/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1359848690, "node_id": "MDU6TGFiZWwxMzU5ODQ4Njkw", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-mcve", "name": "E-needs-mcve", "color": "02e10c", "default": false, "description": "Call for participation: This issue needs a Minimal Complete and Verifiable Example"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2023-01-27T11:15:17Z", "updated_at": "2023-06-08T19:51:06Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI have a server running on Rust 1.66 which works fine. I upgraded to Rust 1.67 and I see stackoverflows. I had the exact same issue described here: https://users.rust-lang.org/t/rust-1-59-and-1-61-nightly-breaks-rust-1-58-code-due-to-stackoverflow-with-tracing/72313/2 a long time ago. Sadly, no matter what stack size I use (I tried **100** MiB while Rust 1.66 worked fine on **5** MiB), I get the overflow error. \r\n\r\nNote that I get the overflow error currently on a `tokio::test`, I don't know if the server itself will run fine, but I am not going to try that with failing tests.\r\n\r\nI tried changing the `tokio::test` to a regular `test` block, and wrapped everything in an async closure with a custom tokio runtime with a **100** MiB thread stack size. It still gives the exact same error.\r\n\r\nI literally didn't changed any line of code. I just upgraded 1.66 to 1.67.\r\nI can not give you a production path. The failure happens on a closed source program. \r\n\r\nThis is the error I get:\r\n\r\n```\r\nthread 'batches::conversation_direct_events::test::test' has overflowed its stack\r\nfatal runtime error: stack overflow\r\nerror: test failed, to rerun pass `--bin batch_jobs`\r\n\r\nCaused by:\r\n  process didn't exit successfully: `/Users/x/CLionProjects/x/target/debug/deps/batch_jobs-93e1992dd7d2e2dc --format=json --test-threads=1 -Z unstable-options --show-output` (signal: 6, SIGABRT: process abort signal)\r\nerror: 1 target failed:\r\n    `--bin batch_jobs`\r\n\r\nProcess finished with exit code 101\r\n```\r\n\r\nI have this in my env already: `RUST_BACKTRACE=1`\r\n\r\nI can run the server in Debug modus in CLion. This is a screenshot:\r\n![ACB8B6FF-0BB2-4670-85B6-D58906482BD8](https://user-images.githubusercontent.com/20363565/215073254-04ed3495-97ad-420e-be5b-c11d36f1f7b6.jpeg)\r\n\r\nI can provide more information if needed.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\njaspervisser@MacStudanJasper x % rustc --version --verbose\r\nrustc 1.67.0 (fc594f156 2023-01-24)\r\nbinary: rustc\r\ncommit-hash: fc594f15669680fa70d255faec3ca3fb507c3405\r\ncommit-date: 2023-01-24\r\nhost: aarch64-apple-darwin\r\nrelease: 1.67.0\r\nLLVM version: 15.0.6\r\n```\r\n\r\n</details>\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/107358/reactions", "total_count": 4, "+1": 4, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/107358/timeline", "performed_via_github_app": null, "state_reason": null}