{"url": "https://api.github.com/repos/rust-lang/rust/issues/29694", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/29694/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/29694/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/29694/events", "html_url": "https://github.com/rust-lang/rust/issues/29694", "id": 115741096, "node_id": "MDU6SXNzdWUxMTU3NDEwOTY=", "number": 29694, "title": "Rust fails to build with custom llvm", "user": {"login": "andrewrynhard", "id": 3383143, "node_id": "MDQ6VXNlcjMzODMxNDM=", "avatar_url": "https://avatars.githubusercontent.com/u/3383143?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andrewrynhard", "html_url": "https://github.com/andrewrynhard", "followers_url": "https://api.github.com/users/andrewrynhard/followers", "following_url": "https://api.github.com/users/andrewrynhard/following{/other_user}", "gists_url": "https://api.github.com/users/andrewrynhard/gists{/gist_id}", "starred_url": "https://api.github.com/users/andrewrynhard/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andrewrynhard/subscriptions", "organizations_url": "https://api.github.com/users/andrewrynhard/orgs", "repos_url": "https://api.github.com/users/andrewrynhard/repos", "events_url": "https://api.github.com/users/andrewrynhard/events{/privacy}", "received_events_url": "https://api.github.com/users/andrewrynhard/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2015-11-08T16:05:33Z", "updated_at": "2017-01-02T12:57:21Z", "closed_at": "2017-01-02T12:57:21Z", "author_association": "NONE", "active_lock_reason": null, "body": "I am getting the following error when compiling for `darwin` with [nix](https://github.com/NixOS/nixpkgs/tree/master/pkgs/development/compilers/rustc):\n\n```\nerror: linking with `cc` failed: exit code: 1\nnote: \"cc\" \"-m64\" \"-L\" \"/private/var/folders/5d/pqjr3mqj0gqclvqx29wxzhfr0000gn/T/nix-build-rustc-1.4.0.drv-4/rustc-1.4.0-src.tar.gz/x86_64-apple-darwin/stage0/lib/rustlib/x86_64-apple-darwin/lib\" \"x86_64-apple-darwin/stage0/lib/rustlib/x86_64-apple-darwin/lib/rustc_llvm-1bf6e69c.0.o\" \"-o\" \"x86_64-apple-darwin/stage0/lib/rustlib/x86_64-apple-darwin/lib/librustc_llvm-1bf6e69c.dylib\" \"x86_64-apple-darwin/stage0/lib/rustlib/x86_64-apple-darwin/lib/rustc_llvm-1bf6e69c.metadata.o\" \"-Wl,-dead_strip\" \"-nodefaultlibs\" \"-L\" \"/private/var/folders/5d/pqjr3mqj0gqclvqx29wxzhfr0000gn/T/nix-build-rustc-1.4.0.drv-4/rustc-1.4.0-src.tar.gz/x86_64-apple-darwin/stage0/lib/rustlib/x86_64-apple-darwin/lib\" \"-l\" \"std-1bf6e69c\" \"-L\" \"x86_64-apple-darwin/rt\" \"-L\" \"/nix/store/lzpl4l44nrcn3k1d9yl48jwhcylb71c6-llvm-3.7.0/lib\" \"-L\" \"/private/var/folders/5d/pqjr3mqj0gqclvqx29wxzhfr0000gn/T/nix-build-rustc-1.4.0.drv-4/rustc-1.4.0-src.tar.gz/x86_64-apple-darwin/stage0/lib/rustlib/x86_64-apple-darwin/lib\" \"-L\" \"/private/var/folders/5d/pqjr3mqj0gqclvqx29wxzhfr0000gn/T/nix-build-rustc-1.4.0.drv-4/rustc-1.4.0-src.tar.gz/.rust/lib/x86_64-apple-darwin\" \"-L\" \"/private/var/folders/5d/pqjr3mqj0gqclvqx29wxzhfr0000gn/T/nix-build-rustc-1.4.0.drv-4/rustc-1.4.0-src.tar.gz/lib/x86_64-apple-darwin\" \"-Wl,-force_load,x86_64-apple-darwin/rt/librustllvm.a\" \"-l\" \"LLVMInterpreter\" \"-l\" \"LLVMMCJIT\" \"-l\" \"LLVMExecutionEngine\" \"-l\" \"LLVMRuntimeDyld\" \"-l\" \"LLVMAsmParser\" \"-l\" \"LLVMLinker\" \"-l\" \"LLVMBitWriter\" \"-l\" \"LLVMipo\" \"-l\" \"LLVMVectorize\" \"-l\" \"LLVMPowerPCDisassembler\" \"-l\" \"LLVMPowerPCCodeGen\" \"-l\" \"LLVMPowerPCAsmParser\" \"-l\" \"LLVMPowerPCDesc\" \"-l\" \"LLVMPowerPCInfo\" \"-l\" \"LLVMPowerPCAsmPrinter\" \"-l\" \"LLVMMipsDisassembler\" \"-l\" \"LLVMMipsCodeGen\" \"-l\" \"LLVMMipsAsmParser\" \"-l\" \"LLVMMipsDesc\" \"-l\" \"LLVMMipsInfo\" \"-l\" \"LLVMMipsAsmPrinter\" \"-l\" \"LLVMAArch64Disassembler\" \"-l\" \"LLVMAArch64CodeGen\" \"-l\" \"LLVMAArch64AsmParser\" \"-l\" \"LLVMAArch64Desc\" \"-l\" \"LLVMAArch64Info\" \"-l\" \"LLVMAArch64AsmPrinter\" \"-l\" \"LLVMAArch64Utils\" \"-l\" \"LLVMARMDisassembler\" \"-l\" \"LLVMARMCodeGen\" \"-l\" \"LLVMARMAsmParser\" \"-l\" \"LLVMARMDesc\" \"-l\" \"LLVMARMInfo\" \"-l\" \"LLVMARMAsmPrinter\" \"-l\" \"LLVMX86Disassembler\" \"-l\" \"LLVMX86AsmParser\" \"-l\" \"LLVMX86CodeGen\" \"-l\" \"LLVMSelectionDAG\" \"-l\" \"LLVMAsmPrinter\" \"-l\" \"LLVMCodeGen\" \"-l\" \"LLVMTarget\" \"-l\" \"LLVMScalarOpts\" \"-l\" \"LLVMProfileData\" \"-l\" \"LLVMInstCombine\" \"-l\" \"LLVMInstrumentation\" \"-l\" \"LLVMTransformUtils\" \"-l\" \"LLVMipa\" \"-l\" \"LLVMAnalysis\" \"-l\" \"LLVMX86Desc\" \"-l\" \"LLVMObject\" \"-l\" \"LLVMMCParser\" \"-l\" \"LLVMBitReader\" \"-l\" \"LLVMMCDisassembler\" \"-l\" \"LLVMX86Info\" \"-l\" \"LLVMX86AsmPrinter\" \"-l\" \"LLVMMC\" \"-l\" \"LLVMX86Utils\" \"-l\" \"LLVMCore\" \"-l\" \"LLVMSupport\" \"-l\" \"ncurses\" \"-l\" \"pthread\" \"-l\" \"z\" \"-l\" \"m\" \"-l\" \"c++\" \"-l\" \"System\" \"-l\" \"c\" \"-l\" \"m\" \"-dynamiclib\" \"-Wl,-dylib\" \"-Wl,-install_name,@rpath/librustc_llvm-1bf6e69c.dylib\" \"-Wl,-rpath,@loader_path/\" \"-Wl,-rpath,/usr/local/lib/rustlib/x86_64-apple-darwin/lib\" \"-l\" \"compiler-rt\"\nnote: ld: warning: directory not found for option '-L/private/var/folders/5d/pqjr3mqj0gqclvqx29wxzhfr0000gn/T/nix-build-rustc-1.4.0.drv-4/rustc-1.4.0-src.tar.gz/.rust/lib/x86_64-apple-darwin'\nld: warning: directory not found for option '-L/private/var/folders/5d/pqjr3mqj0gqclvqx29wxzhfr0000gn/T/nix-build-rustc-1.4.0.drv-4/rustc-1.4.0-src.tar.gz/lib/x86_64-apple-darwin'\nUndefined symbols for architecture x86_64:\n  \"_ffi_type_double\", referenced from:\n      llvm::Interpreter::callExternalFunction(llvm::Function*, llvm::ArrayRef<llvm::GenericValue>) in libLLVMInterpreter.a(ExternalFunctions.cpp.o)\n  \"_ffi_type_pointer\", referenced from:\n      llvm::Interpreter::callExternalFunction(llvm::Function*, llvm::ArrayRef<llvm::GenericValue>) in libLLVMInterpreter.a(ExternalFunctions.cpp.o)\n  \"_ffi_type_sint16\", referenced from:\n      llvm::Interpreter::callExternalFunction(llvm::Function*, llvm::ArrayRef<llvm::GenericValue>) in libLLVMInterpreter.a(ExternalFunctions.cpp.o)\n  \"_ffi_type_void\", referenced from:\n      llvm::Interpreter::callExternalFunction(llvm::Function*, llvm::ArrayRef<llvm::GenericValue>) in libLLVMInterpreter.a(ExternalFunctions.cpp.o)\n  \"_ffi_type_sint64\", referenced from:\n      llvm::Interpreter::callExternalFunction(llvm::Function*, llvm::ArrayRef<llvm::GenericValue>) in libLLVMInterpreter.a(ExternalFunctions.cpp.o)\n  \"_ffi_prep_cif\", referenced from:\n      llvm::Interpreter::callExternalFunction(llvm::Function*, llvm::ArrayRef<llvm::GenericValue>) in libLLVMInterpreter.a(ExternalFunctions.cpp.o)\n  \"_ffi_type_sint32\", referenced from:\n      llvm::Interpreter::callExternalFunction(llvm::Function*, llvm::ArrayRef<llvm::GenericValue>) in libLLVMInterpreter.a(ExternalFunctions.cpp.o)\n  \"_ffi_type_sint8\", referenced from:\n      llvm::Interpreter::callExternalFunction(llvm::Function*, llvm::ArrayRef<llvm::GenericValue>) in libLLVMInterpreter.a(ExternalFunctions.cpp.o)\n  \"_ffi_type_float\", referenced from:\n      llvm::Interpreter::callExternalFunction(llvm::Function*, llvm::ArrayRef<llvm::GenericValue>) in libLLVMInterpreter.a(ExternalFunctions.cpp.o)\n  \"_ffi_call\", referenced from:\n      llvm::Interpreter::callExternalFunction(llvm::Function*, llvm::ArrayRef<llvm::GenericValue>) in libLLVMInterpreter.a(ExternalFunctions.cpp.o)\nld: symbol(s) not found for architecture x86_64\nclang-3.6: error: linker command failed with exit code 1 (use -v to see invocation)\n\nerror: aborting due to previous error\n/private/var/folders/5d/pqjr3mqj0gqclvqx29wxzhfr0000gn/T/nix-build-rustc-1.4.0.drv-4/rustc-1.4.0-src.tar.gz/mk/target.mk:164: recipe for target 'x86_64-apple-darwin/stage0/lib/rustlib/x86_64-apple-darwin/lib/stamp.rustc_llvm' failed\nmake: *** [x86_64-apple-darwin/stage0/lib/rustlib/x86_64-apple-darwin/lib/stamp.rustc_llvm] Error 101\nmake: *** Waiting for unfinished jobs....\nnote: keeping build directory \u2018/private/var/folders/5d/pqjr3mqj0gqclvqx29wxzhfr0000gn/T/nix-build-rustc-1.4.0.drv-4\u2019\nbuilder for \u2018/nix/store/akqi1g0783qpf18gjn463a13xc8iz4wd-rustc-1.4.0.drv\u2019 failed with exit code 2\ncannot build derivation \u2018/nix/store/bhz2vwccya3mc0zxjvjpapzclk6dj3x9-rust-env.drv\u2019: 1 dependencies couldn't be built\nerror: build of \u2018/nix/store/bhz2vwccya3mc0zxjvjpapzclk6dj3x9-rust-env.drv\u2019 failed\n```\n\nHere are the flags used to build rust:\n\n```\nconfigure flags: --prefix=/nix/store/0jjmq3629x5b7q5x88xaah83y59rc2q2-rustc-1.4.0 --release-channel=stable --enable-local-rust --local-rust-root=$snapshot --enable-rpath --default-linker=/nix/store/2bf6xr0v5mxlfx0lawgk6lcnw5dibk1a-clang-wrapper-3.6.2/bin/cc --default-ar=/nix/store/chh2vjk1i08fhfrmj2da38b0akcl1sgs-cctools-binutils-darwin/bin/ar --enable-clang --llvm-root=/nix/store/lzpl4l44nrcn3k1d9yl48jwhcylb71c6-llvm-3.7.0 --datadir=/nix/store/0jjmq3629x5b7q5x88xaah83y59rc2q2-rustc-1.4.0/share --infodir=/nix/store/0jjmq3629x5b7q5x88xaah83y59rc2q2-rustc-1.4.0/share/info\n```\n\nIs this an issue related to `LD_LIBRARY_PATH` and/or `LIBRARY_PATH`? My understanding is that nix uses a custom llvm. Has anyone built rust without the apple provided llvm?\n", "closed_by": {"login": "sanxiyn", "id": 45249, "node_id": "MDQ6VXNlcjQ1MjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/45249?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sanxiyn", "html_url": "https://github.com/sanxiyn", "followers_url": "https://api.github.com/users/sanxiyn/followers", "following_url": "https://api.github.com/users/sanxiyn/following{/other_user}", "gists_url": "https://api.github.com/users/sanxiyn/gists{/gist_id}", "starred_url": "https://api.github.com/users/sanxiyn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sanxiyn/subscriptions", "organizations_url": "https://api.github.com/users/sanxiyn/orgs", "repos_url": "https://api.github.com/users/sanxiyn/repos", "events_url": "https://api.github.com/users/sanxiyn/events{/privacy}", "received_events_url": "https://api.github.com/users/sanxiyn/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/29694/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/29694/timeline", "performed_via_github_app": null, "state_reason": "completed"}