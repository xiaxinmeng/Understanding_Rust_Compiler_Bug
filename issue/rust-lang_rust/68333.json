{"url": "https://api.github.com/repos/rust-lang/rust/issues/68333", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/68333/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/68333/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/68333/events", "html_url": "https://github.com/rust-lang/rust/issues/68333", "id": 551732652, "node_id": "MDU6SXNzdWU1NTE3MzI2NTI=", "number": 68333, "title": "--pretty=expanded fails after calling cbindgen in cdylib crate", "user": {"login": "cwfitzgerald", "id": 7861353, "node_id": "MDQ6VXNlcjc4NjEzNTM=", "avatar_url": "https://avatars.githubusercontent.com/u/7861353?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cwfitzgerald", "html_url": "https://github.com/cwfitzgerald", "followers_url": "https://api.github.com/users/cwfitzgerald/followers", "following_url": "https://api.github.com/users/cwfitzgerald/following{/other_user}", "gists_url": "https://api.github.com/users/cwfitzgerald/gists{/gist_id}", "starred_url": "https://api.github.com/users/cwfitzgerald/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cwfitzgerald/subscriptions", "organizations_url": "https://api.github.com/users/cwfitzgerald/orgs", "repos_url": "https://api.github.com/users/cwfitzgerald/repos", "events_url": "https://api.github.com/users/cwfitzgerald/events{/privacy}", "received_events_url": "https://api.github.com/users/cwfitzgerald/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108435, "node_id": "MDU6TGFiZWwxMDg0MzU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-pretty", "name": "A-pretty", "color": "f7e101", "default": false, "description": "Area: Pretty printing."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2020-01-18T07:09:17Z", "updated_at": "2020-01-18T11:41:38Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "# Preface\r\n\r\nThis one is a bit of a doozy and I can't tell if it's a rustc issue or a cbindgen issue or both, so I'm going to cross-report them so both projects can be aware.\r\n\r\nI don't have a minimal reproduction, but it is easily reproducible in my repo.\r\n\r\nRepo: https://github.com/BVE-Reborn/bve-reborn\r\nWorking Commit: [`52b3ec6`](https://github.com/BVE-Reborn/bve-reborn/commit/52b3ec6c232198e7585909f20404b9ee5323bdab)\r\nFailing Commit: [`7799c04`](https://github.com/BVE-Reborn/bve-reborn/commit/7799c04340edefcd52c51023e1271c0bb67d5ad1)\r\n\r\nThe only difference is the addition of the crate type of `cdylib`. (`rlib` is there, but it reproduces on my next commit which removed it)\r\n\r\n# System Info\r\n\r\n`Xubuntu 18.04`\r\n\r\nRust and Cargo locked to `nightly-2020-01-16`\r\nrustc: `rustc 1.42.0-nightly (3291ae339 2020-01-15)`\r\ncargo: `cargo 1.42.0-nightly (ad3dbe10e 2020-01-13)`\r\n\r\nCBindgen latest, compiled on the same nightly toolchain:\r\n`cbindgen 0.12.2`\r\n\r\n# Repro\r\n\r\nThe rustc command is the exact command cbindgen runs to get macro expanded data.\r\n\r\nThis all takes place in the root of my repo.\r\n\r\n```\r\ncargo build\r\ncargo rustc --lib --manifest-path bve-native/Cargo.toml  -p \"bve-native:0.0.0-Placeholder\" \"--verbose\" -- -Z unstable-options --pretty=expanded \r\n```\r\n\r\nBoth succeed as expected. However if you call cbindgen it fails, and the rustc no longer outputs anything at all.\r\n\r\n```\r\n# Succeeds\r\ncargo build\r\n\r\n# Fails citing an issue with compiling\r\n# Occasionally must be run twice\r\ncbindgen bve-native/ -c bve-native/cbindgen.toml -v\r\n\r\n# Returns zero, but outputs nothing.\r\ncargo rustc --lib --manifest-path bve-native/Cargo.toml  -p \"bve-native:0.0.0-Placeholder\" \"--verbose\" -- -Z unstable-options --pretty=expanded \r\n# You can call ^ as many times as you want, it will always fail\r\n```\r\n\r\nThe problem goes away when you `cargo clean` and reappears by running cbindgen again.\r\n\r\n# Comments\r\n\r\nI have no idea what or who is causing this issue.\r\n\r\nI feel like even if cbindgen is ultimately the \"cause\" of the bug, the expansion shouldn't be able to fail and not output anything without erroring (and returning `!= 0`) in some way.\r\n\r\n# Notes:\r\n\r\nPossibly relevant cbindgen code: https://github.com/eqrion/cbindgen/blob/master/src/bindgen/cargo/cargo_expand.rs#L129\r\ncbindgen issue: https://github.com/eqrion/cbindgen/issues/457\r\n\r\nThanks!", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/68333/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/68333/timeline", "performed_via_github_app": null, "state_reason": null}