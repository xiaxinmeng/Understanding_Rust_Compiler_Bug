{"url": "https://api.github.com/repos/rust-lang/rust/issues/47596", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/47596/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/47596/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/47596/events", "html_url": "https://github.com/rust-lang/rust/issues/47596", "id": 290052186, "node_id": "MDU6SXNzdWUyOTAwNTIxODY=", "number": 47596, "title": "NLL: isolate borrowck\u00a0errors in Servo dependencies", "user": {"login": "SimonSapin", "id": 291359, "node_id": "MDQ6VXNlcjI5MTM1OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/291359?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SimonSapin", "html_url": "https://github.com/SimonSapin", "followers_url": "https://api.github.com/users/SimonSapin/followers", "following_url": "https://api.github.com/users/SimonSapin/following{/other_user}", "gists_url": "https://api.github.com/users/SimonSapin/gists{/gist_id}", "starred_url": "https://api.github.com/users/SimonSapin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SimonSapin/subscriptions", "organizations_url": "https://api.github.com/users/SimonSapin/orgs", "repos_url": "https://api.github.com/users/SimonSapin/repos", "events_url": "https://api.github.com/users/SimonSapin/events{/privacy}", "received_events_url": "https://api.github.com/users/SimonSapin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 36996, "node_id": "MDU6TGFiZWwzNjk5Ng==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-easy", "name": "E-easy", "color": "02e10c", "default": false, "description": "Call for participation: Experience needed to fix: Easy / not much (good first issue)"}, {"id": 67766349, "node_id": "MDU6TGFiZWw2Nzc2NjM0OQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-mentor", "name": "E-mentor", "color": "02E10C", "default": false, "description": "Call for participation: This issue has a mentor. Use RustcContributor::new on Zulip for discussion."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 604489711, "node_id": "MDU6TGFiZWw2MDQ0ODk3MTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-NLL", "name": "A-NLL", "color": "f7e101", "default": false, "description": "Area: Non Lexical Lifetimes (NLL)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/rust-lang/rust/milestones/43", "html_url": "https://github.com/rust-lang/rust/milestone/43", "labels_url": "https://api.github.com/repos/rust-lang/rust/milestones/43/labels", "id": 3013598, "node_id": "MDk6TWlsZXN0b25lMzAxMzU5OA==", "number": 43, "title": "NLL: Valid code works", "description": "Fix all known ICEs or other cases where code that *ought* to compile does not", "creator": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 35, "state": "closed", "created_at": "2018-01-04T19:14:20Z", "updated_at": "2018-07-24T14:22:10Z", "due_on": null, "closed_at": "2018-03-14T20:40:48Z"}, "comments": 12, "created_at": "2018-01-19T17:33:41Z", "updated_at": "2018-02-01T20:49:44Z", "closed_at": "2018-02-01T20:49:43Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "**UPDATE by @nikomatsakis:** In the original issue below, @SimonSapin found several issues when building servo. The goal now is to isolate those issues into standalone test cases and investigate them. [Mentoring instructions for doing that isolation can be found here.](https://github.com/rust-lang/rust/issues/47596#issuecomment-360083294)\r\n\r\nThe list of tests to be isolated is:\r\n\r\n- [x] url-1.6.0 -- isolated to #47703 by @Aaron1011 !\r\n- [x] getopts-0.2.14 -- isolated to https://github.com/rust-lang/rust/issues/47707 by @lqd\r\n- [x] atomic_refcell-0.1.0 -- isolated also to #47703 by @lqd \r\n- [x] mozjs-0.1.10 -- isolated to https://github.com/rust-lang/rust/issues/47722 by @lqd\r\n\r\n<details>\r\n<summary>Original issue report</summary>\r\n\r\nHow I got these results:\r\n\r\n* Check out https://github.com/servo/servo/commit/726a1854b08b7809dbe31fa57c186de39bd5ca42 (currently master)\r\n* Run `cargo +nightly-2018-01-19 build`, see that it finishes successfull\r\n* Run `RUST_BACKTRACE=1 RUSTFLAGS=-Znll cargo +nightly-2018-01-19 build -j100 -v` repeatedly (because when one crate fails Cargo stops building more crates) until the output stabilizes. This results in three borrow-checking errors below, and one ICE filed separately at https://github.com/rust-lang/rust/issues/47598.\r\n\r\nThe relevant code is from crates.io, so easier steps to reproduce might be to build the same crate outside of Servo. And these errors would probably be caught by crater, so they might be already known.\r\n\r\n```rust\r\nerror[E0597]: `*orig.value` does not live long enough\r\n   --> /home/simon/.cargo/registry/src/github.com-1ecc6299db9ec823/atomic_refcell-0.1.0/src/lib.rs:309:22\r\n    |\r\n309 |             value: f(orig.value),\r\n    |                      ^^^^^^^^^^ borrowed value does not live long enough\r\n...\r\n312 |     }\r\n    |      - borrowed value only lives until here\r\n    |\r\n    = note: borrowed value must be valid for lifetime '_#3r...\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: Could not compile `atomic_refcell`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name atomic_refcell /home/simon/.cargo/registry/src/github.com-1ecc6299db9ec823/atomic_refcell-0.1.0/src/lib.rs --crate-type lib --emit=dep-info,link -C debuginfo=2 -C metadata=2c09db59a67c03f8 -C extra-filename=-2c09db59a67c03f8 --out-dir /home/simon/servo/target/debug/deps -L dependency=/home/simon/servo/target/debug/deps --cap-lints allow -Znll` (exit code: 101)\r\nwarning: build failed, waiting for other jobs to finish...\r\n```\r\n```rust\r\nerror[E0503]: cannot use `state` because it was mutably borrowed\r\n    --> /home/simon/.cargo/registry/src/github.com-1ecc6299db9ec823/getopts-0.2.14/src/lib.rs:1008:33\r\n     |\r\n955  |       let mut machine = |cont: &mut bool, (i, c): (usize, char)| {\r\n     |  _______________________-\r\n956  | |         let whitespace = if c.is_whitespace() { Ws }       else { Cr };\r\n957  | |         let limit      = if (i - slice_start + 1) <= lim  { UnderLim } else { OverLim };\r\n958  | |\r\n...    |\r\n1002 | |         *cont\r\n1003 | |     };\r\n     | |_____- borrow of `state` occurs here\r\n...\r\n1008 |       while cont && match state { B | C => true, A => false } {\r\n     |                                   ^ use of borrowed `state`\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: Could not compile `getopts`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name getopts /home/simon/.cargo/registry/src/github.com-1ecc6299db9ec823/getopts-0.2.14/src/lib.rs --crate-type lib --emit=dep-info,link -C debuginfo=2 -C metadata=3a72542378e72657 -C extra-filename=-3a72542378e72657 --out-dir /home/simon/servo/target/debug/deps -L dependency=/home/simon/servo/target/debug/deps --cap-lints allow -Znll` (exit code: 101)\r\nwarning: build failed, waiting for other jobs to finish...\r\n```\r\n```rust\r\nerror[E0597]: `*self.url` does not live long enough\r\n   --> /home/simon/.cargo/registry/src/github.com-1ecc6299db9ec823/url-1.6.0/src/form_urlencoded.rs:261:40\r\n    |\r\n261 |     fn finish(self) -> &'a mut ::Url { self.url }\r\n    |                                        ^^^^^^^^  - borrowed value only lives until here\r\n    |                                        |\r\n    |                                        borrowed value does not live long enough\r\n    |\r\n    = note: borrowed value must be valid for lifetime '_#3r...\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: Could not compile `url`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name url /home/simon/.cargo/registry/src/github.com-1ecc6299db9ec823/url-1.6.0/src/lib.rs --crate-type lib --emit=dep-info,link -C debuginfo=2 -C metadata=d10e0ca03d0b9ab8 -C extra-filename=-d10e0ca03d0b9ab8 --out-dir /home/simon/servo/target/debug/deps -L dependency=/home/simon/servo/target/debug/deps --extern idna=/home/simon/servo/target/debug/deps/libidna-ee1a4ff6e79abeee.rlib --extern matches=/home/simon/servo/target/debug/deps/libmatches-41f6731261a42312.rlib --extern percent_encoding=/home/simon/servo/target/debug/deps/libpercent_encoding-5b0f452077b83df8.rlib --cap-lints allow -Znll` (exit code: 101)\r\n```\r\n```rust\r\nerror[E0506]: cannot assign to `*self.stackTop` because it is borrowed\r\n   --> /home/simon/.cargo/registry/src/github.com-1ecc6299db9ec823/mozjs-0.1.10/src/rust.rs:524:9\r\n    |\r\n524 |         *self.stackTop = self;\r\n    |         ^^^^^^^^^^^^^^^^^----\r\n    |         |                |\r\n    |         |                borrow of `*self.stackTop` occurs here\r\n    |         assignment to borrowed `*self.stackTop` occurs here\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: Could not compile `mozjs`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name mozjs /home/simon/.cargo/registry/src/github.com-1ecc6299db9ec823/mozjs-0.1.10/src/lib.rs --crate-type lib --emit=dep-info,link -C debuginfo=2 --cfg feature=\"mozjs_sys\" --cfg feature=\"promises\" -C metadata=8e35027187093d35 -C extra-filename=-8e35027187093d35 --out-dir /home/simon/servo/target/debug/deps -L dependency=/home/simon/servo/target/debug/deps --extern libc=/home/simon/servo/target/debug/deps/liblibc-b118c84ee3630a2a.rlib --extern mozjs_sys=/home/simon/servo/target/debug/deps/libmozjs_sys-d53c511cbe7b3779.rlib --extern lazy_static=/home/simon/servo/target/debug/deps/liblazy_static-72140f6120427c36.rlib --extern log=/home/simon/servo/target/debug/deps/liblog-ae6a67986025a716.rlib --extern num_traits=/home/simon/servo/target/debug/deps/libnum_traits-e126d3e7dde5d2ac.rlib --cap-lints allow -Znll -L native=/home/simon/servo/target/debug/build/mozjs-fe9b4a432325640f/out/lib -l static=jsglue -L native=/home/simon/servo/target/debug/build/mozjs_sys-8afe9ad964841801/out/js/src -L native=/usr/lib/x86_64-linux-gnu` (exit code: 101)\r\n```\r\n\r\n</details>", "closed_by": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/47596/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/47596/timeline", "performed_via_github_app": null, "state_reason": "completed"}