{"url": "https://api.github.com/repos/rust-lang/rust/issues/87336", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/87336/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/87336/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/87336/events", "html_url": "https://github.com/rust-lang/rust/issues/87336", "id": 949282374, "node_id": "MDU6SXNzdWU5NDkyODIzNzQ=", "number": 87336, "title": "extern build bug?", "user": {"login": "shanliu", "id": 2927231, "node_id": "MDQ6VXNlcjI5MjcyMzE=", "avatar_url": "https://avatars.githubusercontent.com/u/2927231?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shanliu", "html_url": "https://github.com/shanliu", "followers_url": "https://api.github.com/users/shanliu/followers", "following_url": "https://api.github.com/users/shanliu/following{/other_user}", "gists_url": "https://api.github.com/users/shanliu/gists{/gist_id}", "starred_url": "https://api.github.com/users/shanliu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shanliu/subscriptions", "organizations_url": "https://api.github.com/users/shanliu/orgs", "repos_url": "https://api.github.com/users/shanliu/repos", "events_url": "https://api.github.com/users/shanliu/events{/privacy}", "received_events_url": "https://api.github.com/users/shanliu/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2021-07-21T03:19:20Z", "updated_at": "2021-07-21T05:01:50Z", "closed_at": "2021-07-21T05:01:50Z", "author_association": "NONE", "active_lock_reason": null, "body": "`rustc 1.55.0-nightly (b41936b92 2021-07-20)`\r\n\r\n`rustc 1.53.0 (53cb7b09b 2021-06-17)`\r\n\r\n> src/lib.rs\r\n\r\n```rust\r\nextern \"C\" {\r\n    pub fn myout(a: ::std::os::raw::c_int) -> ::std::os::raw::c_int;\r\n}\r\n#[no_mangle]\r\nfn aaa(){\r\n    let b;\r\n    unsafe{\r\n        b=myout(1);\r\n    }\r\n    println!(\"{}\",b);\r\n}\r\n```\r\n\r\n> src/main.rs\r\n\r\n```rust\r\nextern \"C\" {\r\n    pub fn myout(a: ::std::os::raw::c_int) -> ::std::os::raw::c_int;\r\n}\r\nfn main(){\r\n    let b;\r\n    unsafe{\r\n        b=myout(1);\r\n    }\r\n    println!(\"{}\",b);\r\n}\r\n```\r\n\r\n> src/mytest.c\r\n\r\n```c\r\n#include \"mytest.h\"\r\nint myout(int a){\r\n    return a+11;\r\n}\r\n\r\n```\r\n\r\n> src/mytest.h\r\n\r\n```h\r\nint myout(int a);\r\n```\r\n\r\n> build.rs\r\n\r\n```rust\r\nuse std::env;\r\nuse std::path::{Path};\r\nfn main(){\r\n    let pwd_dir = env::var(\"CARGO_MANIFEST_DIR\").unwrap();\r\n    let path =Path::new(&*pwd_dir).join(\"src\");\r\n    println!(\"cargo:rustc-link-search=native={}\", path.to_str().unwrap());\r\n    println!(\"cargo:rustc-link-lib=dylib=myout\");//\u4f1a\u5728c_src\u4e2d\u627elibadd.so\r\n}\r\n```\r\n\r\n\r\n\r\n>  gcc -shared -fPIC -o src/mytest.so src/mytest.o\r\n>  gcc -shared -fPIC -o libmyout.so mytest.o\r\n>  cargo build // build fail , miss -lmyout\r\n```\r\n\"cc\" \"-m64\" \"/mnt/d/Desktop/untitled/target/debug/deps/untitled-cd51abe66c2140e6.1f6fien0knlijr62.rcgu.o\" \"/mnt/d/Desktop/untitled/target/debug/deps/untitled-cd51abe66c2140e6.22t19gtao78kvw64.rcgu.o\" \"/mnt/d/Desktop/unti\r\ntled/target/debug/deps/untitled-cd51abe66c2140e6.262mj3ots4nalgkm.rcgu.o\" \"/mnt/d/Desktop/untitled/target/debug/deps/untitled-cd51abe66c2140e6.26hy4qtl2ysbelk6.rcgu.o\" \"/mnt/d/Desktop/untitled/target/debug/deps/untitled-cd51abe66c\r\n2140e6.2w8b41ixmv6j0nc0.rcgu.o\" \"/mnt/d/Desktop/untitled/target/debug/deps/untitled-cd51abe66c2140e6.30cm0prqt47k9ngs.rcgu.o\" \"/mnt/d/Desktop/untitled/target/debug/deps/untitled-cd51abe66c2140e6.3idj0fmgr1ud8qow.rcgu.o\" \"/mnt/d/De\r\nsktop/untitled/target/debug/deps/untitled-cd51abe66c2140e6.4ikhcshmjtexw50.rcgu.o\" \"/mnt/d/Desktop/untitled/target/debug/deps/untitled-cd51abe66c2140e6.4k1xwkp493bxtzzt.rcgu.o\" \"/mnt/d/Desktop/untitled/target/debug/deps/untitled-c\r\nd51abe66c2140e6.4who7xiblzykr68z.rcgu.o\" \"/mnt/d/Desktop/untitled/target/debug/deps/untitled-cd51abe66c2140e6.u6v5qwtbw0m414g.rcgu.o\" \"/mnt/d/Desktop/untitled/target/debug/deps/untitled-cd51abe66c2140e6.1jlt25cac1dtrcij.rcgu.o\" \"-\r\nWl,--as-needed\" \"-L\" \"/mnt/d/Desktop/untitled/target/debug/deps\" \"-L\" \"/mnt/d/Desktop/untitled/src\" \"-L\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-Wl,--start-group\" \"-Wl\r\n,-Bstatic\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd-5becbaf25ad2a50b.rlib\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-lin\r\nux-gnu/lib/libpanic_unwind-7844336a8d098646.rlib\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libminiz_oxide-7127a1c767cb98d1.rlib\" \"/root/.rustup/toolchains/nightly-x86_64-u\r\nnknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libadler-c72ca5aacce64249.rlib\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libobject-2ac1d71be94d6228.rlib\" \"/root/\r\n.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libaddr2line-cd4296d7404d4cbe.rlib\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/l\r\nibgimli-11db42eccd7ae972.rlib\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd_detect-a015c7fe85c3b961.rlib\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib\r\n/rustlib/x86_64-unknown-linux-gnu/lib/librustc_demangle-8ea1b48568623f0e.rlib\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libhashbrown-f0aec3b282d7ed95.rlib\" \"/root/.rustup/\r\ntoolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc_std_workspace_alloc-dceae87aa8a6ad0d.rlib\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-g\r\nnu/lib/libunwind-78058d5e8cce12b1.rlib\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcfg_if-ba64d0c8ec67560c.rlib\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gn\r\nu/lib/rustlib/x86_64-unknown-linux-gnu/lib/liblibc-0e91863ffbec5148.rlib\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/liballoc-dff5cf0bc269cd5d.rlib\" \"/root/.rustup/toolchain\r\ns/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc_std_workspace_core-52d5241975807511.rlib\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/lib\r\ncore-9924c22ae1efcf66.rlib\" \"-Wl,--end-group\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-68e6d6b4795e50f8.rlib\" \"-Wl,-Bdynamic\" \"-lgcc_s\" \"-lutil\" \"-lrt\r\n\" \"-lpthread\" \"-lm\" \"-ldl\" \"-lc\" \"-Wl,--eh-frame-hdr\" \"-Wl,-znoexecstack\" \"-L\" \"/root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-o\" \"/mnt/d/Desktop/untitled/target/debug/deps/un\r\ntitled-cd51abe66c2140e6\" \"-Wl,--gc-sections\" \"-pie\" \"-Wl,-zrelro\" \"-Wl,-znow\" \"-nodefaultlibs\"\r\n  = note: /usr/bin/ld: /mnt/d/Desktop/untitled/target/debug/deps/untitled-cd51abe66c2140e6.30cm0prqt47k9ngs.rcgu.o: in function `untitled::main':\r\n          /mnt/d/Desktop/untitled/src/main.rs:7: undefined reference to `myout'\r\n          collect2: error: ld returned 1 exit status\r\n  = help: some `extern` functions couldn't be found; some native libraries may need to be installed or have their path specified\r\n```\r\n\r\n>  mv src/main.rs src/mainbak.rs && cargo build // build success\r\n>  mv src/mainbak.rs src/main.rs && mv src/lib.rs src/libbak.rs && cargo build // build success\r\n\r\n> bug ? how fix?\r\n", "closed_by": {"login": "shanliu", "id": 2927231, "node_id": "MDQ6VXNlcjI5MjcyMzE=", "avatar_url": "https://avatars.githubusercontent.com/u/2927231?v=4", "gravatar_id": "", "url": "https://api.github.com/users/shanliu", "html_url": "https://github.com/shanliu", "followers_url": "https://api.github.com/users/shanliu/followers", "following_url": "https://api.github.com/users/shanliu/following{/other_user}", "gists_url": "https://api.github.com/users/shanliu/gists{/gist_id}", "starred_url": "https://api.github.com/users/shanliu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/shanliu/subscriptions", "organizations_url": "https://api.github.com/users/shanliu/orgs", "repos_url": "https://api.github.com/users/shanliu/repos", "events_url": "https://api.github.com/users/shanliu/events{/privacy}", "received_events_url": "https://api.github.com/users/shanliu/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/87336/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/87336/timeline", "performed_via_github_app": null, "state_reason": "completed"}