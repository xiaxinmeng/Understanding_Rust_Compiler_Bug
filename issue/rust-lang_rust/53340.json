{"url": "https://api.github.com/repos/rust-lang/rust/issues/53340", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/53340/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/53340/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/53340/events", "html_url": "https://github.com/rust-lang/rust/issues/53340", "id": 350367391, "node_id": "MDU6SXNzdWUzNTAzNjczOTE=", "number": 53340, "title": "Performance regression in tight loop since rust 1.25", "user": {"login": "pedrocr", "id": 246322, "node_id": "MDQ6VXNlcjI0NjMyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/246322?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pedrocr", "html_url": "https://github.com/pedrocr", "followers_url": "https://api.github.com/users/pedrocr/followers", "following_url": "https://api.github.com/users/pedrocr/following{/other_user}", "gists_url": "https://api.github.com/users/pedrocr/gists{/gist_id}", "starred_url": "https://api.github.com/users/pedrocr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pedrocr/subscriptions", "organizations_url": "https://api.github.com/users/pedrocr/orgs", "repos_url": "https://api.github.com/users/pedrocr/repos", "events_url": "https://api.github.com/users/pedrocr/events{/privacy}", "received_events_url": "https://api.github.com/users/pedrocr/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 32, "created_at": "2018-08-14T10:22:20Z", "updated_at": "2023-01-05T18:38:29Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I've finally gotten around to doing some proper benchmarking of rust versions for my crate:\r\n\r\nhttp://chimper.org/rawloader-rustc-benchmarks/\r\n\r\nAs can be seen in the graph on that page there's a general performance improvement over time but there are some very negative outliers. Most (maybe all) of them seem to be very simple loops that decode packed formats. Since rust 1.25 those are seeing 30-40% degradations in performance. I've extracted a minimal test case that shows the issue:\r\n\r\n```rust\r\nfn decode_12le(buf: &[u8], width: usize, height: usize) -> Vec<u16> {\r\n  let mut out: Vec<u16> = vec![0; width*height];\r\n\r\n  for (row, line) in out.chunks_mut(width).enumerate() {\r\n    let inb = &buf[(row*width*12/8)..];\r\n\r\n    for (o, i) in line.chunks_mut(2).zip(inb.chunks(3)) {\r\n      let g1: u16 = i[0] as u16;\r\n      let g2: u16 = i[1] as u16;\r\n      let g3: u16 = i[2] as u16;\r\n\r\n      o[0] = ((g2 & 0x0f) << 8) | g1;\r\n      o[1] = (g3 << 4) | (g2 >> 4);\r\n    }\r\n  }\r\n  out\r\n}\r\n\r\nfn main() {\r\n  let width = 5000;\r\n  let height = 4000;\r\n\r\n  let buffer: Vec<u8> = vec![0; width*height*12/8];\r\n  \r\n  for _ in 0..100 {\r\n    decode_12le(&buffer, width, height);\r\n  }\r\n}\r\n```\r\n\r\nHere's a test run on my machine:\r\n\r\n```sh\r\n$ rustc +1.24.0 -C opt-level=3 bench_decode.rs \r\n$ time ./bench_decode \r\n\r\nreal\t0m4.817s\r\nuser\t0m3.581s\r\nsys\t0m1.236s\r\n$ rustc +1.25.0 -C opt-level=3 bench_decode.rs \r\n$ time ./bench_decode \r\n\r\nreal\t0m6.263s\r\nuser\t0m5.067s\r\nsys\t0m1.196s\r\n```", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/53340/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/53340/timeline", "performed_via_github_app": null, "state_reason": "reopened"}