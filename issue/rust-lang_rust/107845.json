{"url": "https://api.github.com/repos/rust-lang/rust/issues/107845", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/107845/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/107845/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/107845/events", "html_url": "https://github.com/rust-lang/rust/issues/107845", "id": 1577807476, "node_id": "I_kwDOAAsO6M5eC250", "number": 107845, "title": "Features required for dependencies influenced by build-dependencies.", "user": {"login": "WorksButNotTested", "id": 62701594, "node_id": "MDQ6VXNlcjYyNzAxNTk0", "avatar_url": "https://avatars.githubusercontent.com/u/62701594?v=4", "gravatar_id": "", "url": "https://api.github.com/users/WorksButNotTested", "html_url": "https://github.com/WorksButNotTested", "followers_url": "https://api.github.com/users/WorksButNotTested/followers", "following_url": "https://api.github.com/users/WorksButNotTested/following{/other_user}", "gists_url": "https://api.github.com/users/WorksButNotTested/gists{/gist_id}", "starred_url": "https://api.github.com/users/WorksButNotTested/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/WorksButNotTested/subscriptions", "organizations_url": "https://api.github.com/users/WorksButNotTested/orgs", "repos_url": "https://api.github.com/users/WorksButNotTested/repos", "events_url": "https://api.github.com/users/WorksButNotTested/events{/privacy}", "received_events_url": "https://api.github.com/users/WorksButNotTested/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 609101895, "node_id": "MDU6TGFiZWw2MDkxMDE4OTU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-cargo", "name": "T-cargo", "color": "bfd4f2", "default": false, "description": "Relevant to the cargo team, which will review and decide on the PR/issue."}, {"id": 2352122097, "node_id": "MDU6TGFiZWwyMzUyMTIyMDk3", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-discussion", "name": "C-discussion", "color": "f5f1fd", "default": false, "description": "Category: Discussion or questions that doesn't represent real issues."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2023-02-09T12:27:38Z", "updated_at": "2023-04-26T13:17:29Z", "closed_at": "2023-04-26T13:17:29Z", "author_association": "NONE", "active_lock_reason": null, "body": "I am trying to build a `#![no_std]` crate, but encountering the following error from the linker...\r\n\r\n```\r\nerror: the `#[alloc_error_handler]` in this crate conflicts with allocation error handler in: std\r\n\r\nerror[E0152]: found duplicate lang item `panic_impl`\r\n  --> test/src/lib.rs:23:1\r\n   |\r\n23 | fn panic(info: &PanicInfo) -> ! {\r\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n   |\r\n   = note: the lang item is first defined in crate `std` (which `memchr` depends on)\r\n   = note: first definition in `std` loaded from /root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/armv7-unknown-linux-gnueabihf/lib/libstd-bca906efb5fb081f.so, /root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/armv7-unknown-linux-gnueabihf/lib/libstd-bca906efb5fb081f.rlib\r\n   = note: second definition in the local crate (`test2`)\r\n\r\nerror[E0152]: found duplicate lang item `eh_personality`\r\n  --> test/src/lib.rs:30:1\r\n   |\r\n30 | extern \"C\" fn rust_eh_personality() {\r\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n   |\r\n   = note: the lang item is first defined in crate `std` (which `memchr` depends on)\r\n   = note: first definition in `std` loaded from /root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/armv7-unknown-linux-gnueabihf/lib/libstd-bca906efb5fb081f.so, /root/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/armv7-unknown-linux-gnueabihf/lib/libstd-bca906efb5fb081f.rlib\r\n   = note: second definition in the local crate (`test2`)\r\n\r\nFor more information about this error, try `rustc --explain E0152`.\r\nerror: could not compile `test2` due to 3 previous errors\r\n[cargo-make] ERROR - Error while executing command, exit code: 101\r\n[cargo-make] WARN - Build Failed.\r\n```\r\nEven though my crate is `no_std`, the linker is seemingly trying to link `std` nonetheless (indeed if I comment out my implementations of the above functions in my crate, it links sucessfully). However, if a crate is marked `no_std`, you wouldn't expect the std crate to be linked in no matter what, so this seems pretty odd? \r\n\r\nAnyway, I then investigate the dependencies for my crate to see where `memchr` is being included as a dependency. So as expected, it is included by `cstr_core` from my `Cargo.toml`. But also as a build dependency from `bindgen`.\r\n\r\n```\r\ncstr_core = {version = \"0.2.6\", features = [\"alloc\"], default-features = false }\r\n```\r\n\r\n```\r\ncargo tree --no-dedupe -p test2 -i memchr --target armv7-unknown-linux-gnueabihf -f \"{p} # {f}\"\r\n\r\nmemchr v2.5.0 # std\r\n\u2514\u2500\u2500 nom v7.1.3 # alloc,std\r\n   \u2514\u2500\u2500 cexpr v0.6.0 # \r\n      \u2514\u2500\u2500 bindgen v0.63.0 # default,log,logging,runtime,which,which-rustfmt\r\n            [build-dependencies]            \r\n            \u2514\u2500\u2500 test2 v0.1.0 (/home/share/git/test2/test2)\r\n\r\nmemchr v2.5.0 # std\r\n\u2514\u2500\u2500 cstr_core v0.2.6 # alloc\r\n   \u2514\u2500\u2500 test2 v0.1.0 (/home/share/git/test2/test2) \r\n``` \r\nHowever, `cstr_core` should not include the `std` feature of memchr (e.g. the `std` feature should be required only at build time and not needed to be linked into the resulting binary). A similar project also linked against `cstr_core`, but without using `bindgen` shows no such depdendency?\r\n\r\n```\r\ncargo tree --no-dedupe -p test -i memchr --target armv7-unknown-linux-gnueabihf -f \"{p} # {f}\"\r\n\r\nmemchr v2.5.0 # \r\n\u2514\u2500\u2500 cstr_core v0.2.6 # alloc\r\n    \u2514\u2500\u2500 test1 v0.1.0 (/home/share/git/test/test)\r\n```\r\nHave I mis-understood something?\r\n\r\n```\r\n$ rustc --version\r\nrustc 1.68.0-nightly (c7572670a 2023-01-03)\r\n$ cargo --version\r\ncargo 1.68.0-nightly (2381cbdb4 2022-12-23)\r\n```\r\n", "closed_by": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/107845/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/107845/timeline", "performed_via_github_app": null, "state_reason": "not_planned"}