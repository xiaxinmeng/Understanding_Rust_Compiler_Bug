{"url": "https://api.github.com/repos/rust-lang/rust/issues/11004", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/11004/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/11004/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/11004/events", "html_url": "https://github.com/rust-lang/rust/issues/11004", "id": 24366480, "node_id": "MDU6SXNzdWUyNDM2NjQ4MA==", "number": 11004, "title": "Improve error message for deref field on native ptr", "user": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2013-12-16T17:52:35Z", "updated_at": "2016-08-18T11:36:48Z", "closed_at": "2016-08-18T11:36:48Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "On the `~T` and `&T` pointer types, we support auto-deref as necessary, desugaring expressions like `a.f` to `(*a).f`, `(**a).f`, `(***a).f`, etc.\n\nWe do not perform such auto-deref on the native unsafe `*T`.\n\nThat's okay with me; if you are writing unsafe code, it makes some sense that you should have to think more carefully about each level of deference you are performing.\n\nBut I think we could do better on the error message you get when you write code that is expecting that sort of auto-deref:\n\n``` rust\nstruct A { x: int, y: f64 }\n\n#[cfg(not(works))]\nunsafe fn access(n:*A) -> (int, f64) {\n    let x : int = n.x;\n    let y : f64 = n.y;\n    (x, y)\n}\n\n#[cfg(works)]\nunsafe fn access(n:*A) -> (int, f64) {\n    let x : int = (*n).x;\n    let y : f64 = (*n).y;\n    (x, y)\n}\n\nfn main() {\n    use std::cast;\n    let a :  A = A { x: 3, y: 3.14 };\n    let p : &A = &a;\n    let (x,y) = unsafe {\n        let n : *A = cast::transmute(p);\n        access(n)\n    };\n    println!(\"x: {}, y: {}\", x, y);\n}\n```\n\nrustc interaction:\n\n```\n% rustc /tmp/a.rs\n/tmp/a.rs:5:18: 5:21 error: attempted access of field `x` on type `*A`, \n                     but no field with that name was found\n/tmp/a.rs:5     let x : int = n.x;\n                              ^~~\n/tmp/a.rs:6:18: 6:21 error: attempted access of field `y` on type `*A`, \n                     but no field with that name was found\n/tmp/a.rs:6     let y : f64 = n.y;\n                              ^~~\nerror: aborting due to 2 previous errors\ntask 'rustc' failed at 'explicit failure', \n  /Users/fklock/Dev/Mozilla/rust.git/src/libsyntax/diagnostic.rs:102\ntask '<main>' failed at 'explicit failure', \n  /Users/fklock/Dev/Mozilla/rust.git/src/librustc/lib.rs:391\n```\n\n(I'm just thinking something along the lines of an extra sentence that says \"note: `*A` is a native pointer; perhaps you need to deref with `(*expr).field`)\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/11004/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/11004/timeline", "performed_via_github_app": null, "state_reason": "completed"}