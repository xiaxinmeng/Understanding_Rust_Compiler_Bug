{"url": "https://api.github.com/repos/rust-lang/rust/issues/91158", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/91158/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/91158/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/91158/events", "html_url": "https://github.com/rust-lang/rust/issues/91158", "id": 1061540023, "node_id": "I_kwDOAAsO6M4_RdC3", "number": 91158, "title": "Compiler builtin calls imported function when compiling with `-Z build-std` for wasm", "user": {"login": "athei", "id": 2580396, "node_id": "MDQ6VXNlcjI1ODAzOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/2580396?v=4", "gravatar_id": "", "url": "https://api.github.com/users/athei", "html_url": "https://github.com/athei", "followers_url": "https://api.github.com/users/athei/followers", "following_url": "https://api.github.com/users/athei/following{/other_user}", "gists_url": "https://api.github.com/users/athei/gists{/gist_id}", "starred_url": "https://api.github.com/users/athei/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/athei/subscriptions", "organizations_url": "https://api.github.com/users/athei/orgs", "repos_url": "https://api.github.com/users/athei/repos", "events_url": "https://api.github.com/users/athei/events{/privacy}", "received_events_url": "https://api.github.com/users/athei/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 5257912668, "node_id": "LA_kwDOAAsO6M8AAAABOWVhXA", "url": "https://api.github.com/repos/rust-lang/rust/labels/-Zbuild-std", "name": "-Zbuild-std", "color": "382EF0", "default": false, "description": ""}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2021-11-23T17:25:42Z", "updated_at": "2023-03-13T00:53:16Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "[This is a minimal reproducer](https://github.com/athei/mult-panic) for a bug where the compiler inserts a call to a non-existent\r\npanic function. The following things need to be true to reproduce the bug:\r\n\r\n* target must be wasm32-unknown-unknown\r\n* overflow checks must be enabled\r\n* link time optimization must be enabled\r\n* core must be recompiled using `-Z build-std`\r\n* The compiler needs to insert a call to `memcpy`\r\n\r\nThe non existent imported function will be then called by the overflow checks in the\r\n`memcpy` compiler intrinsic.\r\n\r\n[I reported this error before](https://github.com/rust-lang/rust/issues/78744) and also added a regression test but this error is slightly different and hence the regression test didn't catch it.\r\n\r\n## Steps to reproduce\r\n\r\nClone the reproducer repo and run the following:\r\n\r\n```shell\r\ncargo +nightly build --release --target wasm32-unknown-unknown -Z build-std\r\nwasm2wat target/wasm32-unknown-unknown/release/mult_panic.wasm | less\r\n```\r\n\r\nI tested these steps with `rustc 1.58.0-nightly (936f2600b 2021-11-22)`. Version `2021-11-17` and\r\nless seem to be unaffected. Therefore the first version to have this bug is `2021-11-18`.\r\n\r\nIf you inspect the resulting wasm file you see that it imports some none existing panic function:\r\n\r\n```wat\r\n(import \"env\" \"_ZN4core9panicking5panic17h80a3410ec4f43255E\" (func $_ZN4core9panicking5panic17h80a3410ec4f43255E (type 0)))\r\n```\r\n\r\nThis function is called from the compiler intrinsic on integer overflow. If either lto or\r\ninteger overflow is disabled, the error goes away.\r\n\r\nIt seems that recompiling libcore with `overflow-checks = true` is at the root of this problem. I wonder if that is even a good idea but I see no way to have this option to only apply to my own crate and not to `-Z build-std`.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/91158/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/91158/timeline", "performed_via_github_app": null, "state_reason": null}