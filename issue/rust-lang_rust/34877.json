{"url": "https://api.github.com/repos/rust-lang/rust/issues/34877", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/34877/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/34877/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/34877/events", "html_url": "https://github.com/rust-lang/rust/issues/34877", "id": 165957682, "node_id": "MDU6SXNzdWUxNjU5NTc2ODI=", "number": 34877, "title": "large stack arrays cause segfaults in safe code (even with ulimit unlimited)", "user": {"login": "m4b", "id": 1920204, "node_id": "MDQ6VXNlcjE5MjAyMDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1920204?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m4b", "html_url": "https://github.com/m4b", "followers_url": "https://api.github.com/users/m4b/followers", "following_url": "https://api.github.com/users/m4b/following{/other_user}", "gists_url": "https://api.github.com/users/m4b/gists{/gist_id}", "starred_url": "https://api.github.com/users/m4b/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m4b/subscriptions", "organizations_url": "https://api.github.com/users/m4b/orgs", "repos_url": "https://api.github.com/users/m4b/repos", "events_url": "https://api.github.com/users/m4b/events{/privacy}", "received_events_url": "https://api.github.com/users/m4b/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 100522, "node_id": "MDU6TGFiZWwxMDA1MjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-crash", "name": "I-crash", "color": "e10c02", "default": false, "description": "Issue: The compiler crashes (SIGSEGV, SIGABRT, etc). Use I-ICE instead when the compiler panics."}, {"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 14, "created_at": "2016-07-17T02:59:12Z", "updated_at": "2017-08-25T16:29:51Z", "closed_at": "2017-08-25T16:29:51Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Note, first make sure to set `ulimit -s unlimited` before running the program below.\n\nSomething like the following has problems with bad ASM stack offsets/accesses being generated due to 32-bit overflow.\n\nLooks like this is something known in LLVM: https://groups.google.com/forum/#!topic/llvm-dev/g4sF46a47_w\n\nThis also only seems to cause segfaults in `--release` mode\n\nNote however, it's not entirely clear how to easily get a directly heap allocated, large fixed size array without resorting to unsafe, box syntax, or using the vec hack.\n\nI suspect this will come up often as a result, since many people and beginners will attempt to stack allocate a large object only to have it segfault.\n\nVarious values can be tweaked to make it not segfault in release or debug, in an entirely unintuitive way, which lends the language a less user friendly feeling, along with violating the principle of least surprise in many cases, imho.\n\n``` rust\n#![feature(box_syntax)]\n\nuse std::ops::Index;\nuse std::ops::IndexMut;\nuse std::boxed::Box;\n\n// causes problems\n//const SIZE: usize = 1300;\nconst SIZE: usize = 1255;\nconst BOUND: usize = SIZE;\npub const ARR_SIZE: usize = SIZE * SIZE * BOUND;\n\nstruct Arr {\n    arr: [[[u8; SIZE]; SIZE]; BOUND]\n}\n\nimpl Arr {\n    pub fn create () -> Arr {\n        let x = [0u8; SIZE];\n        let y = [x; SIZE];\n        let z = [y; BOUND];\n// won't cause problems in release\n//        Arr { arr: [[[1u8; SIZE]; SIZE]; SIZE] }\n        Arr { arr: z }\n    }\n}\n\nimpl Index<usize> for Arr {\n    type Output = [[u8; SIZE]; SIZE];\n\n    fn index(&self, _index: usize) -> &Self::Output {\n        &self.arr[_index]\n    }\n}\n\nimpl IndexMut<usize> for Arr {\n    fn index_mut(&mut self, _index: usize) -> &mut [[u8; SIZE]; SIZE] {\n        &mut self.arr[_index]\n    }\n}\n\nfn main() {\n// let mut arr = box Arr::create();\n    let mut arr = Arr::create();\n\n    for i in 0..BOUND {\n        for j in 0..SIZE {\n            for k in 0..SIZE {\n                arr[i][j][k] = (i+j+k) as u8;\n            }\n        }\n    }\n/*\n    for i in 0..SIZE {\n        for j in 0..SIZE {\n            for k in 0..SIZE {\n                println!(\"{}\", arr[i][j][k])\n            }\n        }\n    }\n*/\n    println!(\"res: {}\", arr[1][0][0]);\n    println!(\"res: {}\", arr[1][SIZE-1][SIZE-1]);\n    println!(\"res: {}\", arr[1][SIZE-1][SIZE-1]);\n}\n```\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/34877/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/34877/timeline", "performed_via_github_app": null, "state_reason": "completed"}