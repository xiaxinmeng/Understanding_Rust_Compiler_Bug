{"url": "https://api.github.com/repos/rust-lang/rust/issues/106864", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/106864/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/106864/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/106864/events", "html_url": "https://github.com/rust-lang/rust/issues/106864", "id": 1533357855, "node_id": "I_kwDOAAsO6M5bZS8f", "number": 106864, "title": "no_std + liballoc can not compile with os based toolchain caused by eh_personality required", "user": {"login": "gngshn", "id": 7463638, "node_id": "MDQ6VXNlcjc0NjM2Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/7463638?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gngshn", "html_url": "https://github.com/gngshn", "followers_url": "https://api.github.com/users/gngshn/followers", "following_url": "https://api.github.com/users/gngshn/following{/other_user}", "gists_url": "https://api.github.com/users/gngshn/gists{/gist_id}", "starred_url": "https://api.github.com/users/gngshn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gngshn/subscriptions", "organizations_url": "https://api.github.com/users/gngshn/orgs", "repos_url": "https://api.github.com/users/gngshn/repos", "events_url": "https://api.github.com/users/gngshn/events{/privacy}", "received_events_url": "https://api.github.com/users/gngshn/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 31, "created_at": "2023-01-14T16:49:26Z", "updated_at": "2023-01-20T04:45:18Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\n\r\n\r\nUpdate at 2023-01-20\r\n\r\nThe previous test that met the expected conditions was actually just a case of not testing enough to get the linker's GC optimizations out of the way. The problem is now updated to the fact that in the case of `default_alloc_error_handler `merged, the OS-based toolchain cannot compile the no_std + liballoc crate without using the unstable build-std feature, and the error shows up as a missing `rust_eh_ personality` dependency. Using OS-based toolchain to compile no_std + liballoc is intended to compile small binaries for tiny embedded linux.\r\n\r\n---\r\n\r\nI tried this code:\r\n\r\n```rust\r\n#![no_std]\r\n#![no_main]\r\n\r\nextern crate alloc;\r\n\r\nuse alloc::{boxed::Box, vec};\r\nuse libc_alloc::LibcAlloc;\r\nuse libc_print::std_name::println;\r\n\r\n#[global_allocator]\r\nstatic GLOBAL_ALLOC: LibcAlloc = LibcAlloc;\r\n\r\n#[panic_handler]\r\nfn panic(_: &core::panic::PanicInfo) -> ! {\r\n    unsafe {\r\n        libc::abort();\r\n    }\r\n}\r\n\r\n#[no_mangle]\r\npub extern \"C\" fn main() -> i32 {\r\n    println!(\"hello world!\");\r\n    let test1 = vec![1, 2, 3];\r\n    for v in test1 {\r\n        println!(\"{v}\")\r\n    }\r\n    let test2 = Box::new(10);\r\n    println!(\"{test2}\");\r\n    0\r\n}\r\n```\r\n\r\nI expected to see this happen: This code build and run perfectly with panic=abort and non nightly features in nightly rust, and when rust 1.68 is comming, we can build this in stable rust.\r\nWe use no_std + liballoc to build small linux app in embedded linux, in production, we need stable rust.\r\n\r\nInstead, this happened: The latest rust nightly can not build this code again(nightly-2022-12-29 is okay), it failed with this link error:\r\n```\r\n\"_rust_eh_personality\", referenced from:\r\n                core::panicking::panic_nounwind_fmt::hdc7b70c1a43a8935 in libcore-d0a8c087921eb265.rlib(core-d0a8c087921eb265.core.5d748034-cgu.0.rcgu.o)\r\n```\r\nthis seem caused by [#106045](https://github.com/rust-lang/rust/pull/106045)\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.68.0-nightly (0b90256ad 2023-01-13)\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```\r\n$ RUST_BACKTRACE=1 cargo build\r\n   Compiling libc v0.2.139\r\n   Compiling libc_alloc v1.0.4\r\n   Compiling libc-print v0.1.20\r\n   Compiling core_alloc v0.1.0 (/Users/gngshn/develop/rust/core_alloc)\r\nerror: linking with `cc` failed: exit status: 1\r\n  |\r\n  = note: LC_ALL=\"C\" PATH=\"/Users/gngshn/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/bin:/usr/local/opt/coreutils/libexec/gnubin:/usr/local/bin:/System/Cryptexes/App/usr/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Users/gngshn/.cargo/bin:/usr/local/sbin:/Users/gngshn/.local/bin:/Users/gngshn/.local/go/bin:/usr/local/opt/fzf/bin\" VSLANG=\"1033\" ZERO_AR_DATE=\"1\" \"cc\" \"-arch\" \"x86_64\" \"-m64\" \"/var/folders/q6/qjg_84cs7m33457bzpwyj89c0000gn/T/rustc8tgW18/symbols.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.1e17zqd3jy504d2a.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.1eijle777i9sq0pk.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.1fe54lcf0ayzfo9i.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.1gkto627j4tsu01c.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.1krvpfd8926axeg1.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.1regfi20mw4f4nr0.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.1ymh0vbbid03fxd7.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.20xrjwb4wnpodfwk.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.236beanv78eknhkk.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.2604lu66786wcvm8.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.2e5d7pgn1zhe8xd1.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.2jkx96ov7p0k0svd.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.2mziia6eks3r7iri.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.2qq6ma07ep3fkrie.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.3bavlu7c0u97zdy1.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.3gw933f5fvrbyrdu.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.3nynhhrqjy01lq2w.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.3qhxpnb40mit3m4e.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.3u938251jwm9ry7f.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.3ze778jtnc4j14s2.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.4415dzizekl18aax.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.45ocggxfjsa6x3p.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.4ddbu8w29d6lkeu5.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.4ijt1knocvq1kql3.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.4rlcr2h5yovnam8y.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.4z4w04hvu0o9i9c6.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.5517fkyk2vfortv2.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.jfxexxow8wjy8dn.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.qqacfrqsjnmg87k.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.wk4sxdt5nszlnfu.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.zgclkfsy9t3hh6v.rcgu.o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4.16he8t3edhiz7wic.rcgu.o\" \"-L\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps\" \"-L\" \"/Users/gngshn/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/liblibc_print-f9cd8051d3145ecd.rlib\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/liblibc-064686b452655b71.rlib\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/liblibc_alloc-0c85c4bf859b14f8.rlib\" \"/Users/gngshn/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/liballoc-c6fc9abf4e398cbb.rlib\" \"/Users/gngshn/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/librustc_std_workspace_core-1bf2f523c1bee03d.rlib\" \"/Users/gngshn/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libcore-d0a8c087921eb265.rlib\" \"/Users/gngshn/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libcompiler_builtins-19bcb300462f8eea.rlib\" \"-lc\" \"-lm\" \"-liconv\" \"-L\" \"/Users/gngshn/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib\" \"-o\" \"/Users/gngshn/develop/rust/core_alloc/target/debug/deps/core_alloc-0238da2e10db5da4\" \"-Wl,-dead_strip\" \"-nodefaultlibs\"\r\n  = note: Undefined symbols for architecture x86_64:\r\n            \"_rust_eh_personality\", referenced from:\r\n                core::panicking::panic_nounwind_fmt::hdc7b70c1a43a8935 in libcore-d0a8c087921eb265.rlib(core-d0a8c087921eb265.core.5d748034-cgu.0.rcgu.o)\r\n          ld: symbol(s) not found for architecture x86_64\r\n          clang: error: linker command failed with exit code 1 (use -v to see invocation)\r\n\r\n\r\nerror: could not compile `core_alloc` due to previous error\r\n```\r\n\r\n</p>\r\n</details>", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/106864/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/106864/timeline", "performed_via_github_app": null, "state_reason": null}