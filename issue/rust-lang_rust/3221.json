{"url": "https://api.github.com/repos/rust-lang/rust/issues/3221", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/3221/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/3221/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/3221/events", "html_url": "https://github.com/rust-lang/rust/issues/3221", "id": 6303033, "node_id": "MDU6SXNzdWU2MzAzMDMz", "number": 3221, "title": "vtable resolution does not take place for calls that are not statically resolved", "user": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37544, "node_id": "MDU6TGFiZWwzNzU0NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-typesystem", "name": "A-typesystem", "color": "f7e101", "default": false, "description": "Area: The type system"}, {"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2012-08-18T04:35:02Z", "updated_at": "2014-06-16T21:56:30Z", "closed_at": "2012-08-20T20:40:30Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Vtable resolution ignores calls to methods on type parameters or traits.  If the methods themselves take bounded type parameters, this leads to ICEs in trans because the requisite information is not found.\n\nConsider this example:\n\n```\ntrait TraitA {\n    fn method_a() -> int;\n}\n\ntrait TraitB {\n    fn gimme_an_a<A: TraitA>(a: A) -> int;\n}\n\nimpl int: TraitB {\n    fn gimme_an_a<A: TraitA>(a: A) -> int {\n        a.method_a() + self\n    }\n}\n\nfn call_it<B: TraitB>(b: B)  -> int {\n    let y = 4u;\n    b.gimme_an_a(y)\n}\n\nfn main() {\n    let x = 3i;\n    assert call_it(x) == 22;\n}\n```\n\nHere, the `call_it()` function should not compile, because `gimme_an_a()` demands a type which implements the interface `TraitA`---of which there are no implementations!  Still it compiles.  Bad.  \n\nThe relevant code is in `rustc::middle::typeck::check::vtable::resolve_expr()`, which ignores all cases other than `method_static`:\n\n```\n      ast::expr_field(*) | ast::expr_binary(*) |\n      ast::expr_unary(*) | ast::expr_assign_op(*) |\n      ast::expr_index(*) => {\n        match cx.method_map.find(ex.id) {\n          some({origin: method_static(did), _}) => {\n            let bounds = ty::lookup_item_type(cx.tcx, did).bounds;\n            if has_trait_bounds(*bounds) {\n                let callee_id = match ex.node {\n                  ast::expr_field(_, _, _) => ex.id,\n                  _ => ex.callee_id\n                };\n                let substs = fcx.node_ty_substs(callee_id);\n                cx.vtable_map.insert(\n                    callee_id,\n                    lookup_vtables(fcx, ex, bounds,\n                                   &substs, false));\n            }\n          }\n          _ => ()\n        }\n      }\n```\n", "closed_by": {"login": "msullivan", "id": 340349, "node_id": "MDQ6VXNlcjM0MDM0OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/340349?v=4", "gravatar_id": "", "url": "https://api.github.com/users/msullivan", "html_url": "https://github.com/msullivan", "followers_url": "https://api.github.com/users/msullivan/followers", "following_url": "https://api.github.com/users/msullivan/following{/other_user}", "gists_url": "https://api.github.com/users/msullivan/gists{/gist_id}", "starred_url": "https://api.github.com/users/msullivan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/msullivan/subscriptions", "organizations_url": "https://api.github.com/users/msullivan/orgs", "repos_url": "https://api.github.com/users/msullivan/repos", "events_url": "https://api.github.com/users/msullivan/events{/privacy}", "received_events_url": "https://api.github.com/users/msullivan/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/3221/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/3221/timeline", "performed_via_github_app": null, "state_reason": "completed"}