{"url": "https://api.github.com/repos/rust-lang/rust/issues/84981", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/84981/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/84981/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/84981/events", "html_url": "https://github.com/rust-lang/rust/issues/84981", "id": 877346019, "node_id": "MDU6SXNzdWU4NzczNDYwMTk=", "number": 84981, "title": "TLS leaks when running as a Windows DLL that is repeatedly loaded/unloaded", "user": {"login": "pdix0n", "id": 83759282, "node_id": "MDQ6VXNlcjgzNzU5Mjgy", "avatar_url": "https://avatars.githubusercontent.com/u/83759282?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pdix0n", "html_url": "https://github.com/pdix0n", "followers_url": "https://api.github.com/users/pdix0n/followers", "following_url": "https://api.github.com/users/pdix0n/following{/other_user}", "gists_url": "https://api.github.com/users/pdix0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/pdix0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pdix0n/subscriptions", "organizations_url": "https://api.github.com/users/pdix0n/orgs", "repos_url": "https://api.github.com/users/pdix0n/repos", "events_url": "https://api.github.com/users/pdix0n/events{/privacy}", "received_events_url": "https://api.github.com/users/pdix0n/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2021-05-06T10:25:48Z", "updated_at": "2021-10-13T10:51:21Z", "closed_at": "2021-10-13T06:13:47Z", "author_association": "NONE", "active_lock_reason": null, "body": "Hi. I'm trying to run Rust on Windows and I'm running into this hang/deadlock when my DLL is repeatedly loaded, export is called, and then DLL unloaded.\r\n\r\nMy Rust code is as follows:\r\n\r\n```rust\r\n#![cfg(windows)]\r\n\r\nuse winapi::shared::minwindef::*;\r\n\r\n#[no_mangle]\r\n#[allow(non_snake_case, unused_variables)]\r\nextern \"system\" fn DllMain(dll_module: HINSTANCE, call_reason: DWORD, reserved: LPVOID) -> BOOL {\r\n\r\n    const DLL_PROCESS_ATTACH: DWORD = 1;\r\n    const DLL_PROCESS_DETACH: DWORD = 0;\r\n\r\n    match call_reason {\r\n        DLL_PROCESS_ATTACH => (),\r\n        DLL_PROCESS_DETACH => (),\r\n        _ => ()\r\n    }\r\n    TRUE\r\n}\r\n\r\n#[no_mangle]\r\n#[allow(non_snake_case, unused_variables)]\r\nextern \"stdcall\" fn MyFunc() {\r\n    println!(\"spawning rust thread\");\r\n    let th = std::thread::spawn(|| {\r\n        println!(\"hello from Rust thread\");\r\n    });\r\n    println!(\"joining rust thread: {:?}\", th.thread().id());\r\n    th.join().unwrap();\r\n}\r\n```\r\nWith the following Cargo.toml:\r\n\r\n```\r\n[package]\r\nname = \"MyDLL\"\r\nversion = \"0.1.0\"\r\nauthors = [\"pdix0n <pdix0n>\"]\r\nedition = \"2018\"\r\n\r\n[lib]\r\ncrate-type = [\"cdylib\"]\r\n\r\n[dependencies]\r\nwinapi = { version = \"0.3\", features = [\"minwindef\"] }\r\n```\r\n\r\nFor loading my DLL I use the following code in C:\r\n\r\n```c\r\n#include <stdio.h>\r\n#include <Windows.h>\r\n\r\nint main(int argc, char **argv)\r\n{\r\n\tif (argc < 1) {\r\n\t\treturn 1;\r\n\t}\r\n\r\n\tchar *dllPath = argv[1];\r\n\r\n\tfor (int i = 0; ; i++) {\r\n\r\n\t\tHMODULE h = LoadLibraryA(dllPath);\r\n\t\tif (!h) {\r\n\t\t\tprintf(\"LoadLibrary failed\\n\");\r\n\t\t\tbreak;\r\n\t\t}\r\n\r\n\t\ttypedef VOID (__stdcall *MyFuncFN)(VOID);\r\n\t\tMyFuncFN MyFunc = (MyFuncFN)GetProcAddress(h, \"MyFunc\");\r\n\t\tif (!MyFunc) {\r\n\t\t\tprintf(\"GetProcAddress failed\\n\");\r\n\t\t\tgoto LOOP;\r\n\t\t}\r\n\r\n\t\tprintf(\"[%d] Running MyFunc\\n\", i);\r\n\t\tMyFunc();\r\n\r\nLOOP:\r\n\t\tFreeLibrary(h);\r\n\t}\r\n\tsystem(\"pause\");\r\n    return 0;\r\n}\r\n```\r\n\r\nI expected that this will never hang. But after the loop has run for 1085 iterations, looks like Rust will hang trying to join the thread spawned by the standard library.\r\n\r\nI'm building both in 32-bit mode with MSVC (both C and Rust), and have tested both stable and nightly. Am I doing something wrong?", "closed_by": {"login": "pdix0n", "id": 83759282, "node_id": "MDQ6VXNlcjgzNzU5Mjgy", "avatar_url": "https://avatars.githubusercontent.com/u/83759282?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pdix0n", "html_url": "https://github.com/pdix0n", "followers_url": "https://api.github.com/users/pdix0n/followers", "following_url": "https://api.github.com/users/pdix0n/following{/other_user}", "gists_url": "https://api.github.com/users/pdix0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/pdix0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pdix0n/subscriptions", "organizations_url": "https://api.github.com/users/pdix0n/orgs", "repos_url": "https://api.github.com/users/pdix0n/repos", "events_url": "https://api.github.com/users/pdix0n/events{/privacy}", "received_events_url": "https://api.github.com/users/pdix0n/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/84981/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/84981/timeline", "performed_via_github_app": null, "state_reason": "completed"}