{"url": "https://api.github.com/repos/rust-lang/rust/issues/44911", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/44911/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/44911/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/44911/events", "html_url": "https://github.com/rust-lang/rust/issues/44911", "id": 261488655, "node_id": "MDU6SXNzdWUyNjE0ODg2NTU=", "number": 44911, "title": "OSRng initialization crash on Windows", "user": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}, {"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 17, "created_at": "2017-09-28T23:14:53Z", "updated_at": "2021-12-07T17:05:16Z", "closed_at": "2021-12-07T17:05:16Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Firefox is getting a rare but recurring crash on Windows due to OsRng failing to initialize.\r\n\r\nThe bug is being tracked [here](https://bugzilla.mozilla.org/show_bug.cgi?id=1385971), and you can see the crash reports [here](https://crash-stats.mozilla.com/signature/?signature=core%3A%3Aresult%3A%3Aunwrap_failed%3CT%3E%20%7C%20std%3A%3Acollections%3A%3Ahash%3A%3Amap%3A%3A%7B%7Bimpl%7D%7D%3A%3Anew%3A%3AKEYS%3A%3A__init&date=%3E%3D2017-09-21T22%3A48%3A00.000Z&date=%3C2017-09-28T22%3A48%3A00.000Z&_columns=moz_crash_reason&_sort=-date&page=1#summary)\r\n\r\nSince the crash message isn't public on that page, just to give an idea, these are the kinds of crash reasons we have:\r\n\r\n - `failed to create an OS RNG: Error { repr: Os { code: 127, message: \"OS Error 127 (FormatMessageW() returned error 15100)\" } }` (15100 is `ERROR_MUI_FILE_NOT_FOUND`, i.e. it's unable to find the strings file to return the translated error message)\r\n - `failed to create an OS RNG: Error { repr: Os { code: 127, message: \"OS Error 127 (FormatMessageW() returned error 5)\" } }` (5 is `ERROR_ACCESS_DENIED`, so the translation string file is)\r\n - `failed to create an OS RNG: Error { repr: Os { code: -2146893801, message: \"Provider type not defined.\" } }`\r\n   - `failed to create an OS RNG: Error { repr: Os { code: -2146893801, message: \"Tipo de proveedor no definido.\" } }` and basically the same thing in different languages\r\n - `failed to create an OS RNG: Error { repr: Os { code: -2146893818, message: \"Invalid Signature.\" } }`\r\n\r\nThe FormatMessage errors are not a problem, they just mean that the formatter was unable to figure out what the error message was -- if we hit that we're erroring out already.\r\n\r\n\r\nThe actual OS error seems to mostly be error code 127 (`ERROR_PROC_NOT_FOUND`). I believe `-2146893801` is also one of these with some extra flags set. This is concerning; it doesn't seem like this should _happen_, because we are only feeding known system crypto provider (`PROV_RSA_FULL`) to `CryptAcquireContextA`. I'm unsure what the \"invalid signature\" error is about.\r\n\r\nThis might just be system DLLs being broken, but it's occurring regularly enough (we have a almost thousand crash reports) that we're having to work around it by disabling RandomState on systems where this doesn't work (which we can do because we've already forked HashMap for fallible allocations). Furthermore, Firefox code uses `CryptAcquireContext` and `CryptGenRandom` in a bunch of places and those don't seem to be particularly crashy.\r\n\r\nWe should see if this is an issue on our side, or perhaps make OsRng (or perhaps just `RandomState`'s initializer?) more resilient to this (perhaps with a more expensive fallback?).\r\n", "closed_by": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/44911/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/44911/timeline", "performed_via_github_app": null, "state_reason": "completed"}