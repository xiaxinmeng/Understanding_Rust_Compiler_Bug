{"url": "https://api.github.com/repos/rust-lang/rust/issues/51373", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/51373/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/51373/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/51373/events", "html_url": "https://github.com/rust-lang/rust/issues/51373", "id": 329543692, "node_id": "MDU6SXNzdWUzMjk1NDM2OTI=", "number": 51373, "title": "Unexpected behaviour change when forgetting an element during an iteration vs. iterating again and forgetting", "user": {"login": "jdm", "id": 27658, "node_id": "MDQ6VXNlcjI3NjU4", "avatar_url": "https://avatars.githubusercontent.com/u/27658?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jdm", "html_url": "https://github.com/jdm", "followers_url": "https://api.github.com/users/jdm/followers", "following_url": "https://api.github.com/users/jdm/following{/other_user}", "gists_url": "https://api.github.com/users/jdm/gists{/gist_id}", "starred_url": "https://api.github.com/users/jdm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jdm/subscriptions", "organizations_url": "https://api.github.com/users/jdm/orgs", "repos_url": "https://api.github.com/users/jdm/repos", "events_url": "https://api.github.com/users/jdm/events{/privacy}", "received_events_url": "https://api.github.com/users/jdm/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 147085028, "node_id": "MDU6TGFiZWwxNDcwODUwMjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-nightly", "name": "regression-from-stable-to-nightly", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to nightly."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-06-05T16:58:21Z", "updated_at": "2018-06-05T17:39:11Z", "closed_at": "2018-06-05T16:59:19Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I have an automated test for ipc-channel that demonstrates a regression in rustc. The change that exposes it is this:\r\n```diff\r\ndiff --git a/src/platform/macos/mod.rs b/src/platform/macos/mod.rs\r\nindex 693496e..78dca7e 100644\r\n--- a/src/platform/macos/mod.rs\r\n+++ b/src/platform/macos/mod.rs\r\n@@ -457,16 +457,18 @@ impl OsIpcSender {\r\n\r\n             let mut shared_memory_descriptor_dest =\r\n                 port_descriptor_dest as *mut mach_msg_ool_descriptor_t;\r\n-            for shared_memory_region in shared_memory_regions.into_iter() {\r\n+            for shared_memory_region in shared_memory_regions.iter() {\r\n                 (*shared_memory_descriptor_dest).address =\r\n                     shared_memory_region.as_ptr() as *const c_void as *mut c_void;\r\n                 (*shared_memory_descriptor_dest).size = shared_memory_region.len() as u32;\r\n                 (*shared_memory_descriptor_dest).deallocate = 1;\r\n                 (*shared_memory_descriptor_dest).copy = MACH_MSG_VIRTUAL_COPY as u8;\r\n                 (*shared_memory_descriptor_dest).type_ = MACH_MSG_OOL_DESCRIPTOR;\r\n-                mem::forget(shared_memory_region);\r\n                 shared_memory_descriptor_dest = shared_memory_descriptor_dest.offset(1);\r\n             }\r\n+            for shared_memory_region in shared_memory_regions {\r\n+                mem::forget(shared_memory_region);\r\n+            }\r\n\r\n             let os_result = mach_sys::mach_msg(message as *mut _,\r\n                                                MACH_SEND_MSG,\r\ndiff --git a/src/test.rs b/src/test.rs\r\n```\r\nThe behaviour before and after the change should be identical, yet the automated test that exercises this starts panicking between the 2-10 and 2-11 rustc nightlies when run in release mode.\r\n\r\nTo reproduce the problem, clone [this branch](https://github.com/servo/ipc-channel/tree/mac-ool-rustc-bug) and run `cargo +nightly-2018-02-10 test --release rustc_bug`, then compare it against `cargo +nightly-2018-02-11 test --release rustc_bug`.\r\n\r\nThe regression range for this is https://github.com/rust-lang/rust/compare/3bcda48a3...45fba43b3.", "closed_by": {"login": "jdm", "id": 27658, "node_id": "MDQ6VXNlcjI3NjU4", "avatar_url": "https://avatars.githubusercontent.com/u/27658?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jdm", "html_url": "https://github.com/jdm", "followers_url": "https://api.github.com/users/jdm/followers", "following_url": "https://api.github.com/users/jdm/following{/other_user}", "gists_url": "https://api.github.com/users/jdm/gists{/gist_id}", "starred_url": "https://api.github.com/users/jdm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jdm/subscriptions", "organizations_url": "https://api.github.com/users/jdm/orgs", "repos_url": "https://api.github.com/users/jdm/repos", "events_url": "https://api.github.com/users/jdm/events{/privacy}", "received_events_url": "https://api.github.com/users/jdm/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/51373/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/51373/timeline", "performed_via_github_app": null, "state_reason": "completed"}