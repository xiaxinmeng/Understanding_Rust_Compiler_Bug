{"url": "https://api.github.com/repos/rust-lang/rust/issues/37418", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/37418/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/37418/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/37418/events", "html_url": "https://github.com/rust-lang/rust/issues/37418", "id": 185424503, "node_id": "MDU6SXNzdWUxODU0MjQ1MDM=", "number": 37418, "title": "Reference outlives the value it points to (segfault)", "user": {"login": "benschulz", "id": 10342420, "node_id": "MDQ6VXNlcjEwMzQyNDIw", "avatar_url": "https://avatars.githubusercontent.com/u/10342420?v=4", "gravatar_id": "", "url": "https://api.github.com/users/benschulz", "html_url": "https://github.com/benschulz", "followers_url": "https://api.github.com/users/benschulz/followers", "following_url": "https://api.github.com/users/benschulz/following{/other_user}", "gists_url": "https://api.github.com/users/benschulz/gists{/gist_id}", "starred_url": "https://api.github.com/users/benschulz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/benschulz/subscriptions", "organizations_url": "https://api.github.com/users/benschulz/orgs", "repos_url": "https://api.github.com/users/benschulz/repos", "events_url": "https://api.github.com/users/benschulz/events{/privacy}", "received_events_url": "https://api.github.com/users/benschulz/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2016-10-26T15:16:49Z", "updated_at": "2016-10-26T18:14:03Z", "closed_at": "2016-10-26T16:42:00Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "A is value referenced both outside as well as inside a closure _and_ the closure is boxed and (indirectly) returned. A segfault is raised when the closure is eventually invoked and the reference dereferenced.\n\n**I tried this code**:\n\nI failed to create an SSCEE for the bug, however, I originally stumbled over the behaviour [here](https://github.com/benschulz/object-store-rs/blob/7d6ecea8a1700de2c9dfe8ebb148e58c7265cac7/src/ops/write_blob.rs#L23). Semantically the code contains the same error as the following code.\n\n```\nfn foo() -> Box<Fn() -> usize> {\n    let x = 0;\n    Box::new(|| x)\n}\n\nfn main() {\n    foo()();\n}\n```\n\n**I expected to see this happen**: The compiler should force me to mark the closure as move and resolve the resulting errors as it [does](https://is.gd/10vcTo) with the small example given above.\n\n**Instead, this happened**: The code compiles as is and segfaults when the test is run (simply via `cargo test`ing the repo). The segfault happens when dereferencing [`expected_key2`](https://github.com/benschulz/object-store-rs/blob/7d6ecea8a1700de2c9dfe8ebb148e58c7265cac7/src/ops/write_blob.rs#L26) inside the closure. It does not occur when marking the closure as `move` and passing `&*expected_key` instead of `&*expected_key2` to [`store.write_blob`](https://github.com/benschulz/object-store-rs/blob/7d6ecea8a1700de2c9dfe8ebb148e58c7265cac7/src/ops/write_blob.rs#L22).\n## Meta\n\n`rustc --version --verbose`:\nrustc 1.12.1 (d4f39402a 2016-10-19)\nbinary: rustc\ncommit-hash: d4f39402a0c2c2b94ec0375cd7f7f6d7918113cd\ncommit-date: 2016-10-19\nhost: x86_64-unknown-linux-gnu\nrelease: 1.12.1\n\n**Backtrace** (from gdb):\n\n```\n#0  0x000055555558cbd9 in object_store::ops::write_blob::WriteBlob::new::_$u7b$$u7b$closure$u7d$$u7d$::_$u7b$$u7b$closure$u7d$$u7d$::h729166bb3b5a29fc ()\n#1  0x000055555558d773 in _$LT$futures..then..Then$LT$A$C$$u20$B$C$$u20$F$GT$$u20$as$u20$futures..Future$GT$::poll::_$u7b$$u7b$closure$u7d$$u7d$::h3985deb15ce38518 ()\n#2  0x0000555555580a22 in {{inlined-root}}::poll<object_store::hash::verify::Verify<std::io::cursor::Cursor<collections::string::String>, std::fs::File, object_store::hash::Sha256Hasher, object_store::hash::Sha256Hash>,futures::done::Done<(), std::io::error::Error>,closure,closure> (self=0x7ffff5e5b068, f=...)\n    at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.2/src/chain.rs:38\n#3  0x0000555555588afc in {{inlined-root}}::poll<object_store::hash::verify::Verify<std::io::cursor::Cursor<collections::string::String>, std::fs::File, object_store::hash::Sha256Hasher, object_store::hash::Sha256Hash>,futures::done::Done<(), std::io::error::Error>,closure> (self=0x7ffff5e5b068)\n    at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.2/src/then.rs:31\n#4  0x00005555555673b0 in {{inlined-root}}::poll<closure,futures::then::Then<object_store::hash::verify::Verify<std::io::cursor::Cursor<collections::string::String>, std::fs::File, object_store::hash::Sha256Hasher, object_store::hash::Sha256Hash>, futures::done::Done<(), std::io::error::Error>, closure>,(),std::io::error::Error> (self=0x7ffff5e5b000)\n    at /home/benshu/git-repos/object-store-rs/src/intermediate_path.rs:52\n#5  0x00005555555867c0 in {{inlined-root}}::poll<object_store::blob::Blob,object_store::intermediate_path::IntermediatePath<closure, futures::then::Then<object_store::hash::verify::Verify<std::io::cursor::Cursor<collections::string::String>, std::fs::File, object_store::hash::Sha256Hasher, object_store::hash::Sha256Hash>, futures::done::Done<(), std::io::error::Error>, closure>>,closure> (self=0x7ffff5e5b000) at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.2/src/map.rs:29\n#6  0x0000555555587279 in {{inlined-root}}::poll<std::io::error::Error,futures::map::Map<object_store::intermediate_path::IntermediatePath<closure, futures::then::Then<object_store::hash::verify::Verify<std::io::cursor::Cursor<collections::string::String>, std::fs::File, object_store::hash::Sha256Hasher, object_store::hash::Sha256Hash>, futures::done::Done<(), std::io::error::Error>, closure>>, closure>,closure> (self=0x7ffff5e5b000) at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.2/src/map_err.rs:29\n#7  0x0000555555576e61 in {{inlined-root}}::poll<Future> (self=0x7ffff5e3f030) at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.2/src/lib.rs:231\n#8  0x00005555555be8a1 in {{inlined-root}}::poll<Future> (self=0x7ffff63fe830) at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.2/src/lib.rs:231\n#9  0x00005555555cad9c in object_store::ops::write_blob::{{impl}}::poll (self=0x7ffff63fe830) at /home/benshu/git-repos/object-store-rs/src/ops/write_blob.rs:53\n#10 0x00005555555811f8 in {{inlined-root}}::poll<object_store::ops::write_blob::WriteBlob,object_store::ops::write_tree::WriteTree,closure,closure> (self=0x7ffff63fe828, f=...)\n    at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.2/src/chain.rs:25\n#11 0x0000555555589efc in {{inlined-root}}::poll<object_store::ops::write_blob::WriteBlob,object_store::ops::write_tree::WriteTree,closure> (self=0x7ffff63fe828)\n    at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.2/src/and_then.rs:31\n#12 0x0000555555586b00 in {{inlined-root}}::poll<(),futures::and_then::AndThen<object_store::ops::write_blob::WriteBlob, object_store::ops::write_tree::WriteTree, closure>,closure> (\n    self=0x7ffff63fe828) at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.2/src/map.rs:29\n#13 0x00005555555874b8 in {{inlined-root}}::poll<(),futures::map::Map<futures::and_then::AndThen<object_store::ops::write_blob::WriteBlob, object_store::ops::write_tree::WriteTree, closure>, closure>,closure> (self=0x7ffff63fe828) at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.2/src/map_err.rs:29\n#14 0x000055555558d145 in _$LT$futures..task..Spawn$LT$F$GT$$GT$::poll_future::_$u7b$$u7b$closure$u7d$$u7d$::h3e038fa9311180df ()\n    at /buildslave/rust-buildbot/slave/stable-dist-rustc-linux/build/obj/../src/libstd/collections/hash/table.rs:1040\n#15 0x000055555558d187 in _$LT$futures..task..Spawn$LT$T$GT$$GT$::enter::_$u7b$$u7b$closure$u7d$$u7d$::hb84cd279a381c4af ()\n    at /buildslave/rust-buildbot/slave/stable-dist-rustc-linux/build/obj/../src/libstd/collections/hash/table.rs:1040\n#16 0x000055555558d2a1 in futures::task::set::_$u7b$$u7b$closure$u7d$$u7d$::h9de1fc90a64552d1 ()\n    at /buildslave/rust-buildbot/slave/stable-dist-rustc-linux/build/obj/../src/libstd/collections/hash/table.rs:1040\n#17 0x0000555555574071 in {{inlined-root}}::with<core::cell::Cell<(*const futures::task::Task, *const core::cell::RefCell<std::collections::hash::map::HashMap<core::any::TypeId, Box<Opaque>, core::hash::BuildHasherDefault<futures::task::data::IdHasher>>>)>,closure,core::result::Result<futures::poll::Async<()>, ()>> (\n    self=0x5555558dbb50 <futures::task::CURRENT_TASK::h4df43acd7ab31fdb>, f=...) at /buildslave/rust-buildbot/slave/stable-dist-rustc-linux/build/obj/../src/libstd/thread/local.rs:245\n#18 0x0000555555587f9b in {{inlined-root}}::set<closure,core::result::Result<futures::poll::Async<()>, ()>> (task=0x7ffff63fdd08, data=0x7ffff63fe860, f=...)\n    at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.2/src/task/mod.rs:72\n#19 0x0000555555571bab in {{inlined-root}}::enter<futures::map_err::MapErr<futures::map::Map<futures::and_then::AndThen<object_store::ops::write_blob::WriteBlob, object_store::ops::write_tree::WriteTree, closure>, closure>, closure>,closure,core::result::Result<futures::poll::Async<()>, ()>> (self=0x7ffff63fe828, unpark=..., f=...)\n    at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.2/src/task/mod.rs:304\n#20 0x0000555555571a1b in {{inlined-root}}::poll_future<futures::map_err::MapErr<futures::map::Map<futures::and_then::AndThen<object_store::ops::write_blob::WriteBlob, object_store::ops::write_tree::WriteTree, closure>, closure>, closure>> (self=0x7ffff63fe828, unpark=...) at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.2/src/task/mod.rs:217\n---Type <return> to continue, or q <return> to quit---\n#21 0x000055555558c688 in tokio_core::reactor::Core::run::_$u7b$$u7b$closure$u7d$$u7d$::hfb022cd8bb9d6df8 ()\n    at /buildslave/rust-buildbot/slave/stable-dist-rustc-linux/build/obj/../src/libstd/collections/hash/table.rs:1040\n#22 0x000055555560908a in tokio_core::reactor::{{impl}}::_run::{{closure}} () at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-core-0.1.0/src/reactor/mod.rs:232\n#23 0x00005555555efb3f in {{inlined-root}}::set<tokio_core::reactor::Core,closure,bool> (self=0x5555558db7f0 <tokio_core::reactor::CURRENT_LOOP::hb69805ae44045245>, t=0x7ffff63feb50, f=...)\n    at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-0.1.0/src/lib.rs:135\n#24 0x00005555556040a1 in tokio_core::reactor::Core::_run (self=0x7ffff63feb50, done=...)\n    at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-core-0.1.0/src/reactor/mod.rs:232\n#25 0x0000555555568e64 in {{inlined-root}}::run<futures::map_err::MapErr<futures::map::Map<futures::and_then::AndThen<object_store::ops::write_blob::WriteBlob, object_store::ops::write_tree::WriteTree, closure>, closure>, closure>> (self=0x7ffff63feb50, f=...) at /home/benshu/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-core-0.1.0/src/reactor/mod.rs:217\n#26 0x000055555558c25a in foo::write_object () at /home/benshu/git-repos/object-store-rs/tests/foo.rs:34\n#27 0x000055555559802c in _$LT$F$u20$as$u20$alloc..boxed..FnBox$LT$A$GT$$GT$::call_box::hf1def207a373fb3f ()\n#28 0x0000555555590340 in std::panicking::try::do_call::h9297bd73d4296b2b ()\n#29 0x0000555555646f07 in __rust_maybe_catch_panic ()\n#30 0x0000555555597a5b in _$LT$F$u20$as$u20$alloc..boxed..FnBox$LT$A$GT$$GT$::call_box::hb675dcf15ec220c3 ()\n#31 0x000055555563d2e3 in std::sys::thread::Thread::new::thread_start::h57f688c224d4fa4d ()\n#32 0x00007ffff79c0454 in start_thread () from /usr/lib/libpthread.so.0\n#33 0x00007ffff74ec7df in clone () from /usr/lib/libc.so.6\n```\n", "closed_by": {"login": "benschulz", "id": 10342420, "node_id": "MDQ6VXNlcjEwMzQyNDIw", "avatar_url": "https://avatars.githubusercontent.com/u/10342420?v=4", "gravatar_id": "", "url": "https://api.github.com/users/benschulz", "html_url": "https://github.com/benschulz", "followers_url": "https://api.github.com/users/benschulz/followers", "following_url": "https://api.github.com/users/benschulz/following{/other_user}", "gists_url": "https://api.github.com/users/benschulz/gists{/gist_id}", "starred_url": "https://api.github.com/users/benschulz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/benschulz/subscriptions", "organizations_url": "https://api.github.com/users/benschulz/orgs", "repos_url": "https://api.github.com/users/benschulz/repos", "events_url": "https://api.github.com/users/benschulz/events{/privacy}", "received_events_url": "https://api.github.com/users/benschulz/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/37418/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/37418/timeline", "performed_via_github_app": null, "state_reason": "completed"}