{"url": "https://api.github.com/repos/rust-lang/rust/issues/24880", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/24880/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/24880/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/24880/events", "html_url": "https://github.com/rust-lang/rust/issues/24880", "id": 71459016, "node_id": "MDU6SXNzdWU3MTQ1OTAxNg==", "number": 24880, "title": "arc::get_mut/Arc::make_unique are racy", "user": {"login": "talchas", "id": 3578697, "node_id": "MDQ6VXNlcjM1Nzg2OTc=", "avatar_url": "https://avatars.githubusercontent.com/u/3578697?v=4", "gravatar_id": "", "url": "https://api.github.com/users/talchas", "html_url": "https://github.com/talchas", "followers_url": "https://api.github.com/users/talchas/followers", "following_url": "https://api.github.com/users/talchas/following{/other_user}", "gists_url": "https://api.github.com/users/talchas/gists{/gist_id}", "starred_url": "https://api.github.com/users/talchas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/talchas/subscriptions", "organizations_url": "https://api.github.com/users/talchas/orgs", "repos_url": "https://api.github.com/users/talchas/repos", "events_url": "https://api.github.com/users/talchas/events{/privacy}", "received_events_url": "https://api.github.com/users/talchas/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9695584, "node_id": "MDU6TGFiZWw5Njk1NTg0", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-concurrency", "name": "A-concurrency", "color": "f7e101", "default": false, "description": "Area: Concurrency related issues."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 20, "created_at": "2015-04-28T02:30:41Z", "updated_at": "2015-07-03T02:32:31Z", "closed_at": "2015-07-03T02:32:31Z", "author_association": "NONE", "active_lock_reason": null, "body": "Both of these essentially check that `inner().strong == 1 && inner().weak == 1` to check that `&mut self` is the only reference to the Arc's data. However in between the checks a Weak pointer could be promoted and the Weak pointer dropped, resulting in both checks succeeding. Adding an additional strong check afterwards won't help as the second strong pointer could then be demoted again.\n\nI don't see an obvious way without a two-word atomic read or a generation counter or something of that sort. On 64-bit splitting an atomic64 into two 32-bit sections /might/ be ok, but on 32-bit only allowing 16 bits of refcount seems bad. (There might be something with using a high bit as a lock bit or such?)\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/24880/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/24880/timeline", "performed_via_github_app": null, "state_reason": "completed"}