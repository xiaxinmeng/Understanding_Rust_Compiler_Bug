{"url": "https://api.github.com/repos/rust-lang/rust/issues/61717", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/61717/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/61717/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/61717/events", "html_url": "https://github.com/rust-lang/rust/issues/61717", "id": 454144438, "node_id": "MDU6SXNzdWU0NTQxNDQ0Mzg=", "number": 61717, "title": "stage2 compiler crash on `x.py test`", "user": {"login": "koalatux", "id": 973758, "node_id": "MDQ6VXNlcjk3Mzc1OA==", "avatar_url": "https://avatars.githubusercontent.com/u/973758?v=4", "gravatar_id": "", "url": "https://api.github.com/users/koalatux", "html_url": "https://github.com/koalatux", "followers_url": "https://api.github.com/users/koalatux/followers", "following_url": "https://api.github.com/users/koalatux/following{/other_user}", "gists_url": "https://api.github.com/users/koalatux/gists{/gist_id}", "starred_url": "https://api.github.com/users/koalatux/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/koalatux/subscriptions", "organizations_url": "https://api.github.com/users/koalatux/orgs", "repos_url": "https://api.github.com/users/koalatux/repos", "events_url": "https://api.github.com/users/koalatux/events{/privacy}", "received_events_url": "https://api.github.com/users/koalatux/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 100522, "node_id": "MDU6TGFiZWwxMDA1MjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-crash", "name": "I-crash", "color": "e10c02", "default": false, "description": "Issue: The compiler crashes (SIGSEGV, SIGABRT, etc). Use I-ICE instead when the compiler panics."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2019-06-10T12:24:44Z", "updated_at": "2019-06-11T16:54:51Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "`x.py build` works successfully, but `x.py test` fails. I also tried clearing ~/.ccache.\r\n\r\nThe last commit in master when I tried was 5d4aef605502f670f774cdd7d9a4e00d9d6bf148\r\n\r\nThe system is a Debian stretch amd64 in a KVM VM and the host CPU is an AMD EPYC 7301.\r\n\r\nThe error output is always a bit different on each run.\r\n\r\n<details>\r\n<summary>config.toml</summary>\r\n\r\n```toml\r\n[llvm]\r\nassertions = true\r\nccache = true\r\n[build]\r\n[install]\r\n[rust]\r\ncodegen-units = 0\r\ndebug-assertions = true\r\ndebuginfo-level = 2\r\ndebuginfo-level-tools = 0\r\n[target.x86_64-unknown-linux-gnu]\r\n[dist]\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary>Relevant part of the build log</summary>\r\n\r\n```\r\nBuilding stage0 tool linkchecker (x86_64-unknown-linux-gnu)\r\n   Compiling linkchecker v0.1.0 (/home/adi/src/rust/src/tools/linkchecker)\r\n    Finished release [optimized] target(s) in 2.26s\r\n        finished in 9.734\r\nTesting error-index stage2\r\ndoc tests for: /home/adi/src/rust/build/x86_64-unknown-linux-gnu/test/error-index.md\r\n        finished in 27.134\r\nCheck compiletest suite=run-make-fulldeps mode=run-make (x86_64-unknown-linux-gnu -> x86_64-unknown-linux-gnu)\r\n\r\nrunning 200 tests\r\niii.........................................................i....................................... 100/200\r\niiii........i..........iiii.iii...........................*** Error in `/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/bin/rustc': double free or corruption (fasttop): 0x00007f0ce004c720 ***\r\n======= Backtrace: =========\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x70bfb)[0x7f0cf2697bfb]\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x76fc6)[0x7f0cf269dfc6]\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x7780e)[0x7f0cf269e80e]\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x35940)[0x7f0cf265c940]\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x3599a)[0x7f0cf265c99a]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(+0xaf655b)[0x7f0cdb84755b]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(_ZN4llvm18report_fatal_errorERKNS_5TwineEb+0x6b)[0x7f0cdd9874db]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(+0x2c36618)[0x7f0cdd987618]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(+0xd38d22)[0x7f0cdba89d22]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(_ZN4llvm12X86Subtarget31initializeSubtargetDependenciesENS_9StringRefES1_+0x9)[0x7f0cdba89d39]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(_ZN4llvm12X86SubtargetC1ERKNS_6TripleENS_9StringRefES4_RKNS_16X86TargetMachineEjjj+0x59e)[0x7f0cdba8a2de]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(_ZNK4llvm16X86TargetMachine16getSubtargetImplERKNS_8FunctionE+0x55a)[0x7f0cdba90aaa]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(+0x1d8fbd7)[0x7f0cdcae0bd7]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(_ZN4llvm13FPPassManager13runOnFunctionERNS_8FunctionE+0x2e1)[0x7f0cdd6e5f71]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(_ZN4llvm13FPPassManager11runOnModuleERNS_6ModuleE+0x44)[0x7f0cdd6e6144]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(_ZN4llvm6legacy15PassManagerImpl3runERNS_6ModuleE+0x309)[0x7f0cdd6e6c09]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(LLVMRustWriteOutputFile+0x1e9)[0x7f0cdb846d19]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(+0x992ddc)[0x7f0cdb6e3ddc]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(+0x8fc12d)[0x7f0cdb64d12d]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(+0x8f2d8c)[0x7f0cdb643d8c]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(+0x99602f)[0x7f0cdb6e702f]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(+0x910201)[0x7f0cdb661201]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(+0x8d5198)[0x7f0cdb626198]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(+0x8c6ce4)[0x7f0cdb617ce4]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/libstd-807fd5ae8e228c76.so(__rust_maybe_catch_panic+0x1a)[0x7f0cf2a5d9fa]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(+0x8c6c47)[0x7f0cdb617c47]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so(+0x8c724d)[0x7f0cdb61824d]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/libstd-807fd5ae8e228c76.so(rust_metadata_std_755857fa678bc28c55e9cb70643b5265+0x5461f)[0x7f0cf2a1a61f]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/libstd-807fd5ae8e228c76.so(rust_metadata_std_755857fa678bc28c55e9cb70643b5265+0x60a00)[0x7f0cf2a26a00]\r\n/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/libstd-807fd5ae8e228c76.so(rust_metadata_std_755857fa678bc28c55e9cb70643b5265+0x581a6)[0x7f0cf2a1e1a6]\r\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x74a4)[0x7f0ced6434a4]\r\n/lib/x86_64-linux-gnu/libc.so.6(clone+0x3f)[0x7f0cf270fd0f]\r\n======= Memory map: ========\r\n55fc3873b000-55fc3873c000 r-xp 00000000 fe:01 6161687                    /home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/bin/rustc\r\n55fc3893b000-55fc3893c000 r--p 00000000 fe:01 6161687                    /home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/bin/rustc\r\n55fc3893c000-55fc3893d000 rw-p 00001000 fe:01 6161687                    /home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/bin/rustc\r\n55fc3957d000-55fc3959e000 rw-p 00000000 00:00 0                          [heap]\r\n7f0cb4000000-7f0cb4021000 rw-p 00000000 00:00 0\r\n7f0cb4021000-7f0cb8000000 ---p 00000000 00:00 0\r\n7f0cb8000000-7f0cb8021000 rw-p 00000000 00:00 0\r\n7f0cb8021000-7f0cbc000000 ---p 00000000 00:00 0\r\n7f0cbc000000-7f0cbc021000 rw-p 00000000 00:00 0\r\n7f0cbc021000-7f0cc4000000 ---p 00000000 00:00 0\r\n7f0cc4000000-7f0cc4032000 rw-p 00000000 00:00 0\r\n7f0cc4032000-7f0cc8000000 ---p 00000000 00:00 0\r\n7f0cc8000000-7f0cc8021000 rw-p 00000000 00:00 0\r\n7f0cc8021000-7f0ccc000000 ---p 00000000 00:00 0\r\n7f0ccc000000-7f0ccc021000 rw-p 000.F.......i................................ 200/200\r\n\r\nfailures:\r\n\r\n---- [run-make] run-make-fulldeps/target-cpu-native stdout ----\r\n\r\nerror: make failed\r\nstatus: exit code: 2\r\ncommand: \"make\"\r\nstdout:\r\n------------------------------------------\r\nLD_LIBRARY_PATH=\"/home/adi/src/rust/build/x86_64-unknown-linux-gnu/test/run-make-fulldeps/target-cpu-native/target-cpu-native:/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib:/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage0-bootstrap-tools/x86_64-unknown-linux-gnu/release/deps:/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage0/lib\" '/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/bin/rustc' --out-dir /home/adi/src/rust/build/x86_64-unknown-linux-gnu/test/run-make-fulldeps/target-cpu-native/target-cpu-native -L /home/adi/src/rust/build/x86_64-unknown-linux-gnu/test/run-make-fulldeps/target-cpu-native/target-cpu-native  foo.rs -C target-cpu=native 2>&1 | tee /home/adi/src/rust/build/x86_64-unknown-linux-gnu/test/run-make-fulldeps/target-cpu-native/target-cpu-native/out.log\r\nLLVM ERROR: LLVM ERROR: 64-bit code requested on a subtarget that doesn't support it!64-bit code requested on a subtarget that doesn't support it!\r\n\r\nLD_LIBRARY_PATH=\"/home/adi/src/rust/build/x86_64-unknown-linux-gnu/test/run-make-fulldeps/target-cpu-native/target-cpu-native:/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/lib:/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage0-bootstrap-tools/x86_64-unknown-linux-gnu/release/deps:/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage0/lib\" /home/adi/src/rust/build/x86_64-unknown-linux-gnu/test/run-make-fulldeps/target-cpu-native/target-cpu-native/foo\r\nMakefile:19: recipe for target '/home/adi/src/rust/build/x86_64-unknown-linux-gnu/test/run-make-fulldeps/target-cpu-native/target-cpu-native/out.log' failed\r\n\r\n------------------------------------------\r\nstderr:\r\n------------------------------------------\r\n/bin/sh: 1: /home/adi/src/rust/build/x86_64-unknown-linux-gnu/test/run-make-fulldeps/target-cpu-native/target-cpu-native/foo: not found\r\nmake: *** [/home/adi/src/rust/build/x86_64-unknown-linux-gnu/test/run-make-fulldeps/target-cpu-native/target-cpu-native/out.log] Error 127\r\n\r\n------------------------------------------\r\n\r\n\r\n\r\nfailures:\r\n    [run-make] run-make-fulldeps/target-cpu-native\r\n\r\ntest result: FAILED. 182 passed; 1 failed; 17 ignored; 0 measured; 0 filtered out\r\n\r\nthread 'main' panicked at 'Some tests failed', src/tools/compiletest/src/main.rs:521:22\r\nnote: Run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\r\n\r\n\r\ncommand did not execute successfully: \"/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage0-tools-bin/compiletest\" \"--compile-lib-path\" \"/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib\" \"--run-lib-path\" \"/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"--rustc-path\" \"/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/bin/rustc\" \"--rustdoc-path\" \"/home/adi/src/rust/build/x86_64-unknown-linux-gnu/stage2/bin/rustdoc\" \"--src-base\" \"/home/adi/src/rust/src/test/run-make-fulldeps\" \"--build-base\" \"/home/adi/src/rust/build/x86_64-unknown-linux-gnu/test/run-make-fulldeps\" \"--stage-id\" \"stage2-x86_64-unknown-linux-gnu\" \"--mode\" \"run-make\" \"--target\" \"x86_64-unknown-linux-gnu\" \"--host\" \"x86_64-unknown-linux-gnu\" \"--llvm-filecheck\" \"/home/adi/src/rust/build/x86_64-unknown-linux-gnu/llvm/build/bin/FileCheck\" \"--host-rustcflags\" \"-Crpath -O -Cdebuginfo=0 -Zunstable-options  -Lnative=/home/adi/src/rust/build/x86_64-unknown-linux-gnu/native/rust-test-helpers\" \"--target-rustcflags\" \"-Crpath -O -Cdebuginfo=0 -Zunstable-options  -Lnative=/home/adi/src/rust/build/x86_64-unknown-linux-gnu/native/rust-test-helpers\" \"--docck-python\" \"/usr/bin/python2.7\" \"--lldb-python\" \"/usr/bin/python2.7\" \"--quiet\" \"--llvm-version\" \"8.0.0-rust-1.37.0-dev-788592fb2\\n\" \"--cc\" \"cc\" \"--cxx\" \"c++\" \"--cflags\" \"-ffunction-sections -fdata-sections -fPIC -m64\" \"--llvm-components\" \"aarch64 aarch64asmparser aarch64asmprinter aarch64codegen aarch64desc aarch64disassembler aarch64info aarch64utils aggressiveinstcombine all all-targets analysis arm armasmparser armasmprinter armcodegen armdesc armdisassembler arminfo armutils asmparser asmprinter binaryformat bitreader bitwriter codegen core coroutines coverage debuginfocodeview debuginfodwarf debuginfomsf debuginfopdb demangle dlltooldriver engine executionengine fuzzmutate globalisel gtest gtest_main hexagon hexagonasmparser hexagoncodegen hexagondesc hexagondisassembler hexagoninfo instcombine instrumentation interpreter ipo irreader libdriver lineeditor linker lto mc mca mcdisassembler mcjit mcparser mips mipsasmparser mipsasmprinter mipscodegen mipsdesc mipsdisassembler mipsinfo mirparser msp430 msp430asmparser msp430asmprinter msp430codegen msp430desc msp430disassembler msp430info native nativecodegen nvptx nvptxasmprinter nvptxcodegen nvptxdesc nvptxinfo objcarcopts object objectyaml option optremarks orcjit passes powerpc powerpcasmparser powerpcasmprinter powerpccodegen powerpcdesc powerpcdisassembler powerpcinfo profiledata riscv riscvasmparser riscvasmprinter riscvcodegen riscvdesc riscvdisassembler riscvinfo riscvutils runtimedyld scalaropts selectiondag sparc sparcasmparser sparcasmprinter sparccodegen sparcdesc sparcdisassembler sparcinfo support symbolize systemz systemzasmparser systemzasmprinter systemzcodegen systemzdesc systemzdisassembler systemzinfo tablegen target testingsupport textapi transformutils vectorize webassembly webassemblyasmparser webassemblyasmprinter webassemblycodegen webassemblydesc webassemblydisassembler webassemblyinfo windowsmanifest x86 x86asmparser x86asmprinter x86codegen x86desc x86disassembler x86info x86utils xray\" \"--llvm-cxxflags\" \"-I/home/adi/src/rust/src/llvm-project/llvm/include -I/home/adi/src/rust/build/x86_64-unknown-linux-gnu/llvm/build/include -std=c++11  -fno-exceptions -fno-rtti -D_GNU_SOURCE -D_DEBUG -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS\" \"--ar\" \"ar\" \"--llvm-bin-dir\" \"/home/adi/src/rust/build/x86_64-unknown-linux-gnu/llvm/build/bin\" \"--adb-path\" \"adb\" \"--adb-test-dir\" \"/data/tmp/work\" \"--android-cross-path\" \"\"\r\nexpected success, got: exit code: 101\r\n\r\n\r\nfailed to run: /home/adi/src/rust/build/bootstrap/debug/bootstrap test\r\nBuild completed unsuccessfully in 0:29:16\r\n```\r\n</details>\r\n\r\n```\r\n./rustc --print target-cpus | grep native\r\n    native         - Select the CPU of the current host (currently athlon-xp).\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/61717/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/61717/timeline", "performed_via_github_app": null, "state_reason": null}