{"url": "https://api.github.com/repos/rust-lang/rust/issues/108151", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/108151/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/108151/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/108151/events", "html_url": "https://github.com/rust-lang/rust/issues/108151", "id": 1588656379, "node_id": "I_kwDOAAsO6M5esPj7", "number": 108151, "title": "Extra RPIT bound leads to TAIT cycle error E0391", "user": {"login": "QuineDot", "id": 75067664, "node_id": "MDQ6VXNlcjc1MDY3NjY0", "avatar_url": "https://avatars.githubusercontent.com/u/75067664?v=4", "gravatar_id": "", "url": "https://api.github.com/users/QuineDot", "html_url": "https://github.com/QuineDot", "followers_url": "https://api.github.com/users/QuineDot/followers", "following_url": "https://api.github.com/users/QuineDot/following{/other_user}", "gists_url": "https://api.github.com/users/QuineDot/gists{/gist_id}", "starred_url": "https://api.github.com/users/QuineDot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/QuineDot/subscriptions", "organizations_url": "https://api.github.com/users/QuineDot/orgs", "repos_url": "https://api.github.com/users/QuineDot/repos", "events_url": "https://api.github.com/users/QuineDot/events{/privacy}", "received_events_url": "https://api.github.com/users/QuineDot/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2023-02-17T02:25:25Z", "updated_at": "2023-02-21T23:26:19Z", "closed_at": "2023-02-21T23:26:19Z", "author_association": "NONE", "active_lock_reason": null, "body": "[I tried this code:](https://play.rust-lang.org/?version=nightly&mode=debug&edition=2021&gist=57d7191b413db6f1d705e62e9d4ec5f9)\r\n\r\n```rust\r\n#![feature(type_alias_impl_trait)]\r\n\r\n// Motivation for having a TAIT: Need to convey that the iterator's item type\r\n// is the same as the other associated type in `-> impl SelfReferencingAssocs`\r\npub trait Trait {}\r\npub trait SelfReferencingAssocs {\r\n    type NotAlwaysNameable: Trait;\r\n    type Iter: Iterator<Item = Self::NotAlwaysNameable>;\r\n}\r\n\r\npub type Alias = impl Trait;\r\nimpl Trait for () {}\r\nimpl SelfReferencingAssocs for () {\r\n    type NotAlwaysNameable = Alias;\r\n    type Iter = std::vec::IntoIter<Self::NotAlwaysNameable>;\r\n}\r\n\r\nfn _some_defining_use() -> Alias {}\r\n\r\npub fn f()\r\n-> impl SelfReferencingAssocs<\r\n    NotAlwaysNameable = Alias,\r\n    Iter = impl Send + Iterator<Item = Alias>,\r\n>\r\n{\r\n}\r\n```\r\n\r\nI expected to see this happen: [compiles like it does if you remove `Send`:](https://play.rust-lang.org/?version=nightly&mode=debug&edition=2021&gist=58598b4ba1dc66c7b097d5923f4cf4fa)\r\n```diff\r\n pub fn f()\r\n -> impl SelfReferencingAssocs<\r\n     NotAlwaysNameable = Alias,\r\n-    Iter = impl Send + Iterator<Item = Alias>,\r\n+    Iter = impl Iterator<Item = Alias>,\r\n >\r\n```\r\n\r\nInstead, this happened:\r\n```rust\r\nerror[[E0391]](https://doc.rust-lang.org/nightly/error_codes/E0391.html): cycle detected when computing type of `Alias::{opaque#0}`\r\n  --> src/lib.rs:11:18\r\n   |\r\n11 | pub type Alias = impl Trait;\r\n   |                  ^^^^^^^^^^\r\n   |\r\nnote: ...which requires type-checking `f`...\r\n  --> src/lib.rs:21:4\r\n   |\r\n21 |   -> impl SelfReferencingAssocs<\r\n   |  ____^\r\n22 | |     NotAlwaysNameable = Alias,\r\n23 | |     Iter = impl Send + Iterator<Item = Alias>,\r\n24 | | >\r\n   | |_^\r\n   = note: ...which requires evaluating trait selection obligation `<() as SelfReferencingAssocs>::Iter == f::{opaque#0}::{opaque#0}`...\r\n   = note: ...which again requires computing type of `Alias::{opaque#0}`, completing the cycle\r\nnote: cycle used when checking item types in top-level module\r\n  --> src/lib.rs:1:1\r\n   |\r\n1  | / #![feature(type_alias_impl_trait)]\r\n2  | |\r\n3  | | // Motivation for having a TAIT: Need to convey that the iterator's item type\r\n4  | | // is the same as the other associated type in `-> impl SelfReferencingAssocs`\r\n...  |\r\n25 | | {\r\n26 | | }\r\n   | |_^\r\n```\r\n\r\n### Additional notes\r\n\r\nA workaround is [to isolate the defining use.](https://play.rust-lang.org/?version=nightly&mode=debug&edition=2021&gist=03adc9daec1e6fa482a76af35d5da529)  Perhaps this deserves a diagnostic issue to suggest such isolation in the face of cycle errors?\r\n\r\n[Motivated by this URLO thread.](https://users.rust-lang.org/t/complicated-associated-types-and-impl-trait-in-return-position/89411)  Note how [*not* unifying the two associated types](https://play.rust-lang.org/?version=nightly&mode=debug&edition=2021&gist=8e29505fb47f89c315cb90ebecce7688) leads to an [`opaque_hidden_inferred_bound` lint warning.](https://github.com/rust-lang/rust/pull/102568)  (The lint is not necessarily satisfiable on stable and I've encouraged the poster to file a separate issue about that.)\r\n\r\n### Meta\r\n\r\nPlayground nightly `1.69.0-nightly (2023-02-15 2d14db321b043ffc579a)`\r\n\r\n@rustbot +labels A-impl-trait F-type_alias_impl-trait requires-nightly", "closed_by": {"login": "QuineDot", "id": 75067664, "node_id": "MDQ6VXNlcjc1MDY3NjY0", "avatar_url": "https://avatars.githubusercontent.com/u/75067664?v=4", "gravatar_id": "", "url": "https://api.github.com/users/QuineDot", "html_url": "https://github.com/QuineDot", "followers_url": "https://api.github.com/users/QuineDot/followers", "following_url": "https://api.github.com/users/QuineDot/following{/other_user}", "gists_url": "https://api.github.com/users/QuineDot/gists{/gist_id}", "starred_url": "https://api.github.com/users/QuineDot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/QuineDot/subscriptions", "organizations_url": "https://api.github.com/users/QuineDot/orgs", "repos_url": "https://api.github.com/users/QuineDot/repos", "events_url": "https://api.github.com/users/QuineDot/events{/privacy}", "received_events_url": "https://api.github.com/users/QuineDot/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/108151/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/108151/timeline", "performed_via_github_app": null, "state_reason": "not_planned"}