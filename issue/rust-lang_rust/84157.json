{"url": "https://api.github.com/repos/rust-lang/rust/issues/84157", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/84157/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/84157/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/84157/events", "html_url": "https://github.com/rust-lang/rust/issues/84157", "id": 856963990, "node_id": "MDU6SXNzdWU4NTY5NjM5OTA=", "number": 84157, "title": "Presence of Homebrew GCC breaks `cargo test`", "user": {"login": "bifurcation", "id": 75597, "node_id": "MDQ6VXNlcjc1NTk3", "avatar_url": "https://avatars.githubusercontent.com/u/75597?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bifurcation", "html_url": "https://github.com/bifurcation", "followers_url": "https://api.github.com/users/bifurcation/followers", "following_url": "https://api.github.com/users/bifurcation/following{/other_user}", "gists_url": "https://api.github.com/users/bifurcation/gists{/gist_id}", "starred_url": "https://api.github.com/users/bifurcation/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bifurcation/subscriptions", "organizations_url": "https://api.github.com/users/bifurcation/orgs", "repos_url": "https://api.github.com/users/bifurcation/repos", "events_url": "https://api.github.com/users/bifurcation/events{/privacy}", "received_events_url": "https://api.github.com/users/bifurcation/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2021-04-13T13:29:30Z", "updated_at": "2021-11-05T22:58:03Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "### Code\r\n\r\nStandard library crate (`cargo init --lib`) with the following `lib.rs`:\r\n\r\n```Rust\r\n#[cfg(test)]\r\nmod tests {\r\n    #[test]\r\n    fn it_dont_work() {\r\n        assert!(false);\r\n    }\r\n}\r\n```\r\n\r\n### Meta\r\n\r\nThe problem occurs with either of the following two configurations (possibly others; have not tested):\r\n\r\n```\r\nrustc 1.51.0 (2fd73fabe 2021-03-23)\r\nbinary: rustc\r\ncommit-hash: 2fd73fabe469357a12c2c974c140f67e7cdd76d0\r\ncommit-date: 2021-03-23\r\nhost: x86_64-apple-darwin\r\nrelease: 1.51.0\r\nLLVM version: 11.0.1\r\n```\r\n\r\n```\r\nrustc 1.53.0-nightly (07e0e2ec2 2021-03-24)\r\nbinary: rustc\r\ncommit-hash: 07e0e2ec268c140e607e1ac7f49f145612d0f597\r\ncommit-date: 2021-03-24\r\nhost: x86_64-apple-darwin\r\nrelease: 1.53.0-nightly\r\nLLVM version: 12.0.0\r\n```\r\n\r\n### Error output\r\n\r\n```\r\n$ RUST_BACKTRACE=1 cargo test\r\n    Finished test [unoptimized + debuginfo] target(s) in 0.06s\r\n     Running target/debug/deps/spike-5de77501aaf7a6ed\r\n\r\nrunning 1 test\r\nfatal runtime error: failed to initiate panic, error 5\r\nerror: test failed, to rerun pass '--lib'\r\n\r\nCaused by:\r\n  process didn't exit successfully: `/Users/richbarn/Projects/libsrtp/spike/target/debug/deps/spike-5de77501aaf7a6ed` (signal: 6, SIGABRT: process abort signal)\r\n```\r\n\r\nlldb backtrace to user code (not including stack frames for standard cargo test functions):\r\n```\r\n(lldb) target create \"target/debug/deps/spike-5de77501aaf7a6ed\"\r\nCurrent executable set to 'target/debug/deps/spike-5de77501aaf7a6ed' (x86_64).\r\n(lldb) r\r\nProcess 24589 launched: '/Users/richbarn/Projects/libsrtp/spike/target/debug/deps/spike-5de77501aaf7a6ed' (x86_64)\r\n\r\nrunning 1 test\r\nfatal runtime error: failed to initiate panic, error 5\r\nProcess 24589 stopped\r\n* thread #2, name = 'tests::it_dont_work', stop reason = signal SIGABRT\r\n    frame #0: 0x00007fff751232c2 libsystem_kernel.dylib`__pthread_kill + 10\r\nlibsystem_kernel.dylib`__pthread_kill:\r\n->  0x7fff751232c2 <+10>: jae    0x7fff751232cc            ; <+20>\r\n    0x7fff751232c4 <+12>: movq   %rax, %rdi\r\n    0x7fff751232c7 <+15>: jmp    0x7fff7511d453            ; cerror_nocancel\r\n    0x7fff751232cc <+20>: retq   \r\nTarget 0: (spike-5de77501aaf7a6ed) stopped.\r\n(lldb) bt\r\nerror: need to add support for DW_TAG_base_type '()' encoded with DW_ATE = 0x7, bit_size = 0\r\n* thread #2, name = 'tests::it_dont_work', stop reason = signal SIGABRT\r\n  * frame #0: 0x00007fff751232c2 libsystem_kernel.dylib`__pthread_kill + 10\r\n    frame #1: 0x00007fff751debf1 libsystem_pthread.dylib`pthread_kill + 284\r\n    frame #2: 0x00007fff7508d6a6 libsystem_c.dylib`abort + 127\r\n    frame #3: 0x000000010006deb9 spike-5de77501aaf7a6ed`std::sys::unix::abort_internal::h474f6875a409fb7e at mod.rs:237:14 [opt]\r\n    frame #4: 0x0000000100066e50 spike-5de77501aaf7a6ed`std::sys_common::util::abort::hc95123744d370ee8 at util.rs:19:5 [opt]\r\n    frame #5: 0x0000000100068053 spike-5de77501aaf7a6ed`rust_panic at panicking.rs:642:5 [opt]\r\n    frame #6: 0x0000000100067fbf spike-5de77501aaf7a6ed`std::panicking::rust_panic_with_hook::hf87bfc4afef21ea6 at panicking.rs:610:5 [opt]\r\n    frame #7: 0x0000000100067a69 spike-5de77501aaf7a6ed`std::panicking::begin_panic_handler::_$u7b$$u7b$closure$u7d$$u7d$::h19ac9cd24a19b238 at panicking.rs:495:13 [opt]\r\n    frame #8: 0x0000000100065e68 spike-5de77501aaf7a6ed`std::sys_common::backtrace::__rust_end_short_backtrace::h5fc3f41df3517232 at backtrace.rs:141:18 [opt]\r\n    frame #9: 0x00000001000679fa spike-5de77501aaf7a6ed`rust_begin_unwind at panicking.rs:493:5 [opt]\r\n    frame #10: 0x0000000100089e8f spike-5de77501aaf7a6ed`core::panicking::panic_fmt::habd0855285375977 at panicking.rs:92:14 [opt]\r\n    frame #11: 0x0000000100089de7 spike-5de77501aaf7a6ed`core::panicking::panic::hfa08580418a71d7f at panicking.rs:50:5 [opt]\r\n    frame #12: 0x0000000100001d1c spike-5de77501aaf7a6ed`spike::tests::it_dont_work::h962cb450ad780f79 at lib.rs:5:9\r\n    frame #13: 0x0000000100001aa1 spike-5de77501aaf7a6ed`spike::tests::it_dont_work::_$u7b$$u7b$closure$u7d$$u7d$::he85084a41ca471d9((null)=0x000070000f8c3750) at lib.rs:4:5\r\n```\r\n\r\n### Details\r\n\r\nThis is on a development MacBook running macOS 10.14.6 Mojave.  On a different MacBook (running Big Sur), `cargo test` produces correct output (showing a test failure), but the binary produced on the bad MacBook still aborts, showing the following error:\r\n\r\n```\r\n$ ./spike\r\n\r\nrunning 1 test\r\nfatal runtime error: failed to initiate panic, error 5\r\nAbort trap: 6\r\n```\r\n\r\nThis seems to indicate that the error is in the toolchain, not the runtime.  \"error 5\" is _URC_END_OF_STACK from libunwind.\r\n\r\nPossibly related: #35599\r\n\r\n\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/84157/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/84157/timeline", "performed_via_github_app": null, "state_reason": null}