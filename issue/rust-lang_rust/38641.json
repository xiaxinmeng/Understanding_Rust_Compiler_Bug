{"url": "https://api.github.com/repos/rust-lang/rust/issues/38641", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/38641/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/38641/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/38641/events", "html_url": "https://github.com/rust-lang/rust/issues/38641", "id": 197760018, "node_id": "MDU6SXNzdWUxOTc3NjAwMTg=", "number": 38641, "title": "rustc: assertion failiure in llvm when defining __CxxFrameHandler3", "user": {"login": "JoNil", "id": 840235, "node_id": "MDQ6VXNlcjg0MDIzNQ==", "avatar_url": "https://avatars.githubusercontent.com/u/840235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JoNil", "html_url": "https://github.com/JoNil", "followers_url": "https://api.github.com/users/JoNil/followers", "following_url": "https://api.github.com/users/JoNil/following{/other_user}", "gists_url": "https://api.github.com/users/JoNil/gists{/gist_id}", "starred_url": "https://api.github.com/users/JoNil/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JoNil/subscriptions", "organizations_url": "https://api.github.com/users/JoNil/orgs", "repos_url": "https://api.github.com/users/JoNil/repos", "events_url": "https://api.github.com/users/JoNil/events{/privacy}", "received_events_url": "https://api.github.com/users/JoNil/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 36953, "node_id": "MDU6TGFiZWwzNjk1Mw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-runtime", "name": "A-runtime", "color": "f7e101", "default": false, "description": "Area: std's runtime and \"pre-main\" init for handling backtraces, unwinds, stack overflows"}, {"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2016-12-27T21:26:42Z", "updated_at": "2020-10-10T17:43:57Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I'm building a 64k demo on windows so i'm building without std and without libc. When writing some code a reference to `__CxxFrameHandler3` is emitted even though i'm building with `panic=abort`. I suspect this is because libcore is built with unwinding. In release builds the symbol `__CxxFrameHandler3`  is optimized away so the program links successfully. If i try to define `__CxxFrameHandler3` i get an assertion failure in llvm.\r\n\r\nI tried this code:\r\n\r\nBuild with ```rustc --crate-type bin -C panic=abort main.rs```\r\n\r\n```Rust\r\n#![feature(lang_items)]\r\n#![feature(link_args)]\r\n\r\n#![no_std]\r\n#![no_main]\r\n\r\n#[link_args = \"/SUBSYSTEM:WINDOWS\"]\r\nextern \"C\" {}\r\n\r\n#[no_mangle]\r\npub extern \"system\" fn __CxxFrameHandler3(_: *mut u8, _: *mut u8, _: *mut u8, _: *mut u8) -> i32 { 0 }\r\n\r\n#[no_mangle]\r\npub extern \"system\" fn WinMainCRTStartup() {\r\n\r\n    for _ in 0..1 {}\r\n}\r\n\r\n#[lang = \"panic_fmt\"]\r\n#[no_mangle]\r\npub extern \"C\" fn rust_begin_panic(_: core::fmt::Arguments, _: &'static str, _: u32) -> ! { loop {} }\r\n```\r\n\r\nI expected to see this happen:\r\nPreferably the symbol `__CxxFrameHandler3` would not be emitted. But being able to define it without a crash is ok as well.\r\n\r\nInstead, this happened:\r\nThe symbol `__CxxFrameHandler3` is emitted and when i try to define it i get a crash. \r\n\r\nCurrent workaround is to pass `/FORCE` to the linker to ignore the unresolved symbol.\r\n\r\n## Meta\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.15.0-nightly (71c06a56a 2016-12-18)\r\nbinary: rustc\r\ncommit-hash: 71c06a56a120a0d5e3b224105ee3e6754f83e5fa\r\ncommit-date: 2016-12-18\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.15.0-nightly\r\nLLVM version: 3.9\r\n```\r\n\r\n## Output from rustc\r\n`Assertion failed: isa<X>(Val) && \"cast<Ty>() argument of incompatible type!\", file C:\\bot\\slave\\nightly-dist-rustc-win-msvc-64\\build\\src\\llvm\\include\\llvm/Support/Casting.h, line 237`\r\n\r\n## Backtrace\r\n```msvcr120.dll!abort() Line 88\r\nmsvcr120.dll!_wassert(const wchar_t * expr, const wchar_t * filename, unsigned int lineno) Line 142\r\nrustc_llvm-039c192262ead9ec.dll!00007ff969b9b87c()\r\nrustc_trans-ba0c504011b26d52.dll!00007ff970296ccb()\r\nrustc_trans-ba0c504011b26d52.dll!00007ff97026d1b4()\r\nrustc_trans-ba0c504011b26d52.dll!00007ff9702b673b()\r\nrustc_trans-ba0c504011b26d52.dll!00007ff9702debd2()\r\nrustc_trans-ba0c504011b26d52.dll!00007ff97023b9fd()\r\nrustc_driver-9b39ebb875ea3d3d.dll!00007ff9754b8383()\r\nrustc_driver-9b39ebb875ea3d3d.dll!00007ff97548a519()\r\nrustc_driver-9b39ebb875ea3d3d.dll!00007ff9754b5580()\r\nrustc_driver-9b39ebb875ea3d3d.dll!00007ff975404ec9()\r\nrustc_driver-9b39ebb875ea3d3d.dll!00007ff975486553()\r\nrustc_driver-9b39ebb875ea3d3d.dll!00007ff9754d6f77()\r\nrustc_driver-9b39ebb875ea3d3d.dll!00007ff9753bd69f()\r\nstd-efe4996faa4fd772.dll!00007ff974114612()\r\nrustc_driver-9b39ebb875ea3d3d.dll!00007ff9753e6bc5()\r\nstd-efe4996faa4fd772.dll!00007ff97410c2ff()\r\n```\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/38641/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/38641/timeline", "performed_via_github_app": null, "state_reason": null}