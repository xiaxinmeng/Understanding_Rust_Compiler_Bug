{"url": "https://api.github.com/repos/rust-lang/rust/issues/49260", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/49260/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/49260/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/49260/events", "html_url": "https://github.com/rust-lang/rust/issues/49260", "id": 307547599, "node_id": "MDU6SXNzdWUzMDc1NDc1OTk=", "number": 49260, "title": "Serious binary size regression on ARMv7-M on nightly-2018-02-11", "user": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2018-03-22T08:32:05Z", "updated_at": "2018-03-22T12:25:08Z", "closed_at": "2018-03-22T12:25:08Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "### STR\r\n\r\n``` console\r\n$ git clone https://github.com/japaric/stable-embedded-rust\r\n\r\n$ cd stable-embedded-rust\r\n\r\n$ git checkout 7cc87cff95b2d90b5cab258d912cf4692130312f\r\n```\r\n\r\n- `nightly-2018-02-11` or newer\r\n\r\n``` console\r\n$ rustc -V\r\nrustc 1.26.0-nightly (75af15ee6 2018-03-20)\r\n\r\n$ # NOTE you need to have {gcc,libnewlib}-arm-none-eabi installed\r\n$ xargo build --example minimal --target thumbv7m-none-eabi\r\n$ xargo build --example minimal --target thumbv7m-none-eabi --release\r\n\r\n$ arm-none-eabi-size target/thumbv7m-none-eabi/{debug,release}/examples/minimal\r\n   text    data     bss     dec     hex filename\r\n    530       0       0     530     212 target/thumbv7m-none-eabi/debug/examples/minimal\r\n    662       0       0     662     296 target/thumbv7m-none-eabi/release/examples/minimal\r\n\r\n$ xargo rustc --example minimal --target thumbv7m-none-eabi --release -- -C lto\r\n   text    data     bss     dec     hex filename\r\n   1114       0       0    1114     45a target/thumbv7m-none-eabi/release/examples/minimal\r\n```\r\n\r\n- `nightly-2018-02-10`\r\n\r\n``` console\r\n$ rustc -V\r\nrustc 1.25.0-nightly (3bcda48a3 2018-02-09)\r\n\r\n$ # NOTE you need to have {gcc,libnewlib}-arm-none-eabi installed\r\n$ xargo build --example minimal --target thumbv7m-none-eabi\r\n$ xargo build --example minimal --target thumbv7m-none-eabi --release\r\n\r\n$ arm-none-eabi-size target/thumbv7m-none-eabi/{debug,release}/examples/minimal\r\n   text    data     bss     dec     hex filename\r\n    530       0       0     530     212 target/thumbv7m-none-eabi/debug/examples/minimal\r\n    160       0       0     160      a0 target/thumbv7m-none-eabi/release/examples/minimal\r\n\r\n$ xargo rustc --example minimal --target thumbv7m-none-eabi --release -- -C lto\r\n\r\n$ arm-none-eabi-size target/thumbv7m-none-eabi/release/examples/minimal\r\n   text    data     bss     dec     hex filename\r\n    130       0       0     130      82 target/thumbv7m-none-eabi/release/examples/minimal\r\n```\r\n\r\n\r\nBasically as of nightly-2018-02-11 dev profile is better than release profile and that's better than\r\ncompiling with LTO ...\r\n\r\nAlso, in this case, today's LTO produces a 1 KB (756%) bigger binary that using LTO on\r\n`nightly-2018-02-10` . On a more real world example I see a 2.4 KB (21%) increase in binary size.\r\n\r\n### LLVM?\r\n\r\nOne notorious difference between `nightly-2018-02-10` and newer nightlies is that\r\n`nightly-2018-02-10` is using LLVM 4 and everything newer than that is using LLVM 6. However, I\r\ndon't think LLVM is fully to blame: today's rustc produces much more LLVM IR than it did on\r\n2018-02-10.\r\n\r\n``` console\r\n$ # nightly-2018-02-10\r\n$ xargo rustc --example minimal --target thumbv7m-none-eabi --release -- -C lto --emit=llvm-ir\r\n$ wc $(find -name '*.ll')\r\n  72  393 2748 ./target/thumbv7m-none-eabi/release/examples/minimal-dd6a4842433c97ae.ll\r\n\r\n\r\n$ # nightly-2018-03-20\r\n$ xargo rustc --example minimal --target thumbv7m-none-eabi --release -- -C lto --emit=llvm-ir\r\n$ wc $(find -name '*.ll')\r\n  707  5942 34041 ./target/thumbv7m-none-eabi/release/examples/minimal-52848323be89f9be.ll\r\n```\r\n\r\n[IR files for reference][gist].\r\n\r\n[gist]: https://gist.github.com/japaric/e168c412b57bedeea9fd361317c73ccc\r\n\r\n### thinLTO / parallel codegen?\r\n\r\nThe problem doesn't seem to be caused by thinLTO or parallel codegen either. I tried this with both\r\n`nightly-2018-02-11` and `nightly-2018-03-20`:\r\n\r\n``` console\r\n$ tail Cargo.toml\r\n[profile.release]\r\ncodegen-units = 1\r\nincremental = false\r\n\r\n$ cat .cargo/config\r\n[target.thumbv7m-none-eabi]\r\nrunner = \"arm-none-eabi-gdb\" # Not required; just used for testing\r\nrustflags = [\r\n  \"-Z\", \"thinlto=no\", # <- NEW!\r\n  \"-C\", \"link-arg=-Tlink.x\",\r\n  \"-C\", \"link-arg=-nostartfiles\",\r\n  \"-C\", \"link-arg=-march=armv7-m\",\r\n  \"-C\", \"link-arg=-mthumb\",\r\n]\r\n```\r\n\r\nIt got slightly better but it's not on parity with `nightly-2018-02-10`\r\n\r\n``` console\r\n$ # nightly-2018-02-11\r\n$ xargo rustc --example minimal --target thumbv7m-none-eabi --release -- -C lto\r\n\r\n$ arm-none-eabi-size target/thumbv7m-none-eabi/release/examples/minimal\r\n   text    data     bss     dec     hex filename\r\n    598       0       0     598     256 target/thumbv7m-none-eabi/release/examples/minimal\r\n\r\n\r\n$ # nightly-2018-03-20\r\n$ xargo rustc --example minimal --target thumbv7m-none-eabi --release -- -C lto\r\n\r\n$ arm-none-eabi-size target/thumbv7m-none-eabi/release/examples/minimal\r\n   text    data     bss     dec     hex filename\r\n    598       0       0     598     256 target/thumbv7m-none-eabi/release/examples/minimal\r\n```\r\n\r\n### ARMv6-M\r\n\r\nAlso none of this seems to affect ARMv6-M.\r\n\r\n``` console\r\n$ # nightly-2018-03-20\r\n$ xargo rustc --example minimal --target thumbv6m-none-eabi --release -- -C lto\r\n\r\n$ arm-none-eabi-size target/thumbv6m-none-eabi/release/examples/minimal\r\n   text    data     bss     dec     hex filename\r\n    112       0       0     112      70 target/thumbv6m-none-eabi/release/examples/minimal\r\n```\r\n\r\nThis is with the `.cargo/config` and `Cargo.toml` stuff undone.\r\n\r\n---\r\n\r\ncc @alexcrichton @nagisa any clue about what could be going wrong here?", "closed_by": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/49260/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/49260/timeline", "performed_via_github_app": null, "state_reason": "completed"}