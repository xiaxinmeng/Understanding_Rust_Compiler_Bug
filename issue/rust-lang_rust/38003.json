{"url": "https://api.github.com/repos/rust-lang/rust/issues/38003", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/38003/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/38003/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/38003/events", "html_url": "https://github.com/rust-lang/rust/issues/38003", "id": 191746949, "node_id": "MDU6SXNzdWUxOTE3NDY5NDk=", "number": 38003, "title": "Decrease HashMap Load Factor", "user": {"login": "pssalmeida", "id": 2972421, "node_id": "MDQ6VXNlcjI5NzI0MjE=", "avatar_url": "https://avatars.githubusercontent.com/u/2972421?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pssalmeida", "html_url": "https://github.com/pssalmeida", "followers_url": "https://api.github.com/users/pssalmeida/followers", "following_url": "https://api.github.com/users/pssalmeida/following{/other_user}", "gists_url": "https://api.github.com/users/pssalmeida/gists{/gist_id}", "starred_url": "https://api.github.com/users/pssalmeida/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pssalmeida/subscriptions", "organizations_url": "https://api.github.com/users/pssalmeida/orgs", "repos_url": "https://api.github.com/users/pssalmeida/repos", "events_url": "https://api.github.com/users/pssalmeida/events{/privacy}", "received_events_url": "https://api.github.com/users/pssalmeida/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 178802147, "node_id": "MDU6TGFiZWwxNzg4MDIxNDc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-needs-decision", "name": "I-needs-decision", "color": "e11d21", "default": false, "description": "Issues in need of decision."}, {"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}, {"id": 630652267, "node_id": "MDU6TGFiZWw2MzA2NTIyNjc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-feature-request", "name": "C-feature-request", "color": "f5f1fd", "default": false, "description": "Category: A feature request, i.e: not implemented / a PR."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 34, "created_at": "2016-11-25T17:43:29Z", "updated_at": "2019-11-08T16:33:31Z", "closed_at": "2019-11-08T16:33:31Z", "author_association": "NONE", "active_lock_reason": null, "body": "Currently HashMap uses a load factor of approximately 0.9. While this is appropriate for reads (get), as Robin Hood Hashing gives a low distance from the starting point with very low, effectively fixed variance, such is not the case for writes (insert).\r\n\r\nWhen writing over an occupied bucked, it will incur a displacement involving reads and writes over several buckets, either for the new value or the values already in the map. Not only this number is larger than for reads, but also has an increasing variance, quickly becoming very large as load approaches 1.\r\n\r\nFor a load factor *a*:  (**UPDATED**, previous lookup values were for random probing)\r\n\r\n* the average number of probes in a read is ~~1/a*ln(1/1-a))~~ (1+1/(1-a))/2\r\n* the average number of written buckets in a write is 1/(1-a)\r\n* the probability of writing no more than *k* buckets in a write is 1 - a^k\r\n\r\nIn a table, the average buckets written, the 95th percentile buckets written, and the average buckets probed in a get, for different load factors:\r\n\r\na | Avg W | 95% W | Avg R\r\n--- | ------ | ------- | ------\r\n0.500 | 2 | 4.3 | ~~1.39~~ 1.5\r\n0.666 | 3 | 7.4 | ~~1.65~~ 2.0\r\n0.750 | 4 | 10.4 | ~~1.84~~ 2.5\r\n0.800 | 5 | 13.4 | ~~2.01~~ 3.0\r\n0.833 | 6 | 16.4 | ~~2.15~~ 3.5\r\n0.857 | 7 | 19.4 | ~~2.27~~ 4.0\r\n0.875 | 8 | 22.4 | ~~2.38~~ 4.5\r\n0.888 | 9 | 25.4 | ~~2.47~~ 5.0\r\n0.900 | 10 | 28.4 | ~~2.56~~ 5.5\r\n0.950 | 20 | 58.4 | ~~3.15~~ 10.5\r\n0.990 | 100 | 298.1 | ~~4.65~~ 50.5\r\n\r\nIt can be seen that for *a* = 0.9, the average probes when reading is just ~~2.56~~ 5.5, but the average number of buckets written when inserting is 10 and the 95th percentile is 28 buckets. For deletes it will not be much better when doing the backwards shift, as most keys will be displaced from their origin (the very low variance behaviour or RH).\r\n\r\nWhile for many cases, the average over the map lifetime may not be much impacted, if it happens that a map is being operated near capacity, with elements constantly being inserted and others removed, e.g., when implementing an LRU cache, the number of buckets (re)written per insert (and also per delete) will be manifestly higher than desired.\r\n\r\nWhile the exact load factor choice can be argued about, it seems that 0.9 is manifestly too high. Going from 0.9 to 0.8 would have a 12.5% memory overhead, while going from 0.8 to 0.9 doubles the average number of buckets written when inserting, and more than doubles the 95th percentile. Therefore, a load factor around 0.8 seems more reasonable.\r\n", "closed_by": {"login": "Amanieu", "id": 278509, "node_id": "MDQ6VXNlcjI3ODUwOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/278509?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Amanieu", "html_url": "https://github.com/Amanieu", "followers_url": "https://api.github.com/users/Amanieu/followers", "following_url": "https://api.github.com/users/Amanieu/following{/other_user}", "gists_url": "https://api.github.com/users/Amanieu/gists{/gist_id}", "starred_url": "https://api.github.com/users/Amanieu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Amanieu/subscriptions", "organizations_url": "https://api.github.com/users/Amanieu/orgs", "repos_url": "https://api.github.com/users/Amanieu/repos", "events_url": "https://api.github.com/users/Amanieu/events{/privacy}", "received_events_url": "https://api.github.com/users/Amanieu/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/38003/reactions", "total_count": 2, "+1": 1, "-1": 0, "laugh": 0, "hooray": 1, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/38003/timeline", "performed_via_github_app": null, "state_reason": "completed"}