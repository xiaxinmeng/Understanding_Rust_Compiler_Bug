{"url": "https://api.github.com/repos/rust-lang/rust/issues/34786", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/34786/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/34786/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/34786/events", "html_url": "https://github.com/rust-lang/rust/issues/34786", "id": 165136394, "node_id": "MDU6SXNzdWUxNjUxMzYzOTQ=", "number": 34786, "title": "Use only one personality function instead of 2 on Unix", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2016-07-12T17:38:23Z", "updated_at": "2016-07-30T07:08:30Z", "closed_at": "2016-07-30T07:08:30Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Right now we have two personality functions:\n- `rust_eh_personality`\n- `rust_eh_personality_catch`\n\nThe rationale is described in length [here](https://github.com/rust-lang/rust/blob/3085ec78487712ed77a506d9cba8d69cd3a44684/src/libpanic_unwind/gcc.rs#L11), but the gist is that we're currently \"too lazy\" to parse DWARF metadata, so we use `rust_eh_personality` for \"all Rust functions in the world\" and `rust_eh_personality_catch` for the one function allowed to catch a panic. The former personality simply runs all cleanups, and the latter personality simply catches all Rust exceptions.\n\nThis split makes it easy for us to define, but when a personality is run it should also have access to DWARF metadata about the call site it's running for. This metadata _should_ indicate whether it's intended to catch or not, so we should in theory be able to read out the DWARF metadata and figure out what to do, allowing us to have one personality function instead of two.\n\nThe major downside of having two personality functions is that LLVM is unable to inline two functions that have different personalities. This unfortunately means that `catch_unwind` can have [performance problems](https://github.com/rust-lang/rust/issues/34727) if we don't inline enough. We're currently using zero-cost exceptions on Unix, but what we're actually doing unfortunately isn't zero cost!\n\nThis is only one piece of the puzzle towards fixing the [performance issues mentioned](https://github.com/rust-lang/rust/issues/34727), but it's an important one!\n\ncc @vadimcn \n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/34786/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/34786/timeline", "performed_via_github_app": null, "state_reason": "completed"}