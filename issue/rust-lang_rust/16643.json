{"url": "https://api.github.com/repos/rust-lang/rust/issues/16643", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/16643/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/16643/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/16643/events", "html_url": "https://github.com/rust-lang/rust/issues/16643", "id": 40764647, "node_id": "MDU6SXNzdWU0MDc2NDY0Nw==", "number": 16643, "title": "ICE: TypeParameterDef lookup failure in tc_ty", "user": {"login": "kmcallister", "id": 444997, "node_id": "MDQ6VXNlcjQ0NDk5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/444997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kmcallister", "html_url": "https://github.com/kmcallister", "followers_url": "https://api.github.com/users/kmcallister/followers", "following_url": "https://api.github.com/users/kmcallister/following{/other_user}", "gists_url": "https://api.github.com/users/kmcallister/gists{/gist_id}", "starred_url": "https://api.github.com/users/kmcallister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kmcallister/subscriptions", "organizations_url": "https://api.github.com/users/kmcallister/orgs", "repos_url": "https://api.github.com/users/kmcallister/repos", "events_url": "https://api.github.com/users/kmcallister/events{/privacy}", "received_events_url": "https://api.github.com/users/kmcallister/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2014-08-21T01:29:51Z", "updated_at": "2014-08-28T22:05:41Z", "closed_at": "2014-08-26T06:21:20Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Extracted from an issue I encountered upgrading [html5ever](https://github.com/kmcallister/html5ever) to Rust master.\n\n`foo.rs`:\n\n``` rust\n#![crate_type=\"lib\"]\n\npub trait TokenSink {\n    fn process_token(&self, token: ());\n}\n\npub struct TreeBuilder<Handle> {\n    pub open_elems: Vec<Handle>,\n}\n\nimpl<Handle> TokenSink for TreeBuilder<Handle> {\n    fn process_token(&self, token: ()) {\n        match token {\n            _ => for x in self.open_elems.iter() { },\n        }\n    }\n}\n```\n\n`bar.rs`:\n\n``` rust\nextern crate foo;\n\nuse foo::{TreeBuilder, TokenSink};\n\nfn main() {\n    let tb: TreeBuilder<uint> = TreeBuilder {\n        open_elems: vec!(),\n    };\n    tb.process_token(());\n}\n```\n\nIt seems like more or less every part of this code is necessary to hit the bug. Here's the result:\n\n```\n$ rustc -v\nrustc 0.12.0-pre (e11cb5bba 2014-08-20 16:25:53 +0000)\n\n$ rustc foo.rs\n\n$ RUST_BACKTRACE=1 rustc -L. bar.rs\nerror: internal compiler error: unexpected failure\nnote: the compiler hit an unexpected failure path. this is a bug.\nnote: we would appreciate a bug report: http://doc.rust-lang.org/complement-bugreport.html\nnote: run with `RUST_BACKTRACE=1` for a backtrace\ntask 'rustc' failed at 'TypeParameterDef lookup failed for ParamTy { space: TypeSpace, idx: 0, def_id: DefId { krate: 0, node: 598 } }', /home/keegan/rust/src/librustc/middle/ty.rs:2294\n\nstack backtrace:\n   1:     0x7f12658b8a20 - rt::backtrace::imp::write::hd65c9804462fb8dcpxr\n   2:     0x7f12658bb3e0 - failure::on_fail::hb34a0faf07b986176Sr\n   3:     0x7f126a2ed030 - unwind::begin_unwind_inner::hfc98b793f314ea06pie\n   4:     0x7f126a2ecb30 - unwind::begin_unwind_fmt::he2958ada65c1d41fPfe\n   5:     0x7f126b53a670 - middle::ty::type_contents::tc_ty::h98abbbfc60a7d554waG\n   6:     0x7f126b53a670 - middle::ty::type_contents::tc_ty::h98abbbfc60a7d554waG\n   7:     0x7f126af18a50 - middle::ty::type_contents::h1b7aa404dfcb34d1r9F\n   8:     0x7f126ae63e00 - middle::ty::type_moves_by_default::h8602de8843dbf54dcrG\n   9:     0x7f126ada8ac0 - middle::expr_use_visitor::copy_or_move::h0d63d7bcb9e1b5295zv\n  10:     0x7f126b417b50 - middle::expr_use_visitor::ExprUseVisitor<'d, 't, TYPER>::walk_pat::closure.118640\n  11:     0x7f126b412d60 - middle::mem_categorization::MemCategorizationContext<'t, TYPER>::cat_pattern::h1612630838218560840\n  12:     0x7f126b4127b0 - middle::expr_use_visitor::ExprUseVisitor<'d, 't, TYPER>::walk_pat::h17289765959183890288\n  13:     0x7f126b4059c0 - middle::expr_use_visitor::ExprUseVisitor<'d, 't, TYPER>::walk_expr::h18108696973096423772\n  14:     0x7f126b405430 - middle::trans::_match::is_discr_reassigned::ha03b6a6c6923b1b8MQh\n  15:     0x7f126b41ab90 - middle::trans::_match::create_bindings_map::h5a49a20efb57c753jUh\n  16:     0x7f126b4216e0 - middle::trans::_match::trans_match_inner::closure.118687\n  17:     0x7f126b420630 - iter::Map<'a, A, B, T>::do_map::h4328457525798762931\n  18:     0x7f126b4205c0 - iter::Map<'a, A, B, T>.Iterator<B>::next::h14044686831652860284\n  19:     0x7f126b420570 - iter::ByRef<'a, T>.Iterator<A>::next::h7270709296560143036\n  20:     0x7f126b420100 - vec::Vec<T>.FromIterator<T>::from_iter::h13079317938292968767\n  21:     0x7f126b4200a0 - iter::Iterator::collect::h10157566076738839025\n  22:     0x7f126b404a90 - middle::trans::_match::trans_match_inner::h3199dcbd82cb2abfAXh\n  23:     0x7f126b2df4c0 - middle::trans::_match::trans_match::h1d773729c0952ac6XPh\n  24:     0x7f126b2c5b40 - middle::trans::expr::trans_rvalue_dps_unadjusted::h68c42f27e53f341euG3\n  25:     0x7f126b2610c0 - middle::trans::expr::trans_into::h02f395bc1df027d3QL2\n  26:     0x7f126b2617e0 - middle::trans::controlflow::trans_block::h05731a7862534d438MY\n  27:     0x7f126b3b30f0 - middle::trans::base::trans_closure::h761f159ac0f5b1d5Zve\n  28:     0x7f126b24a4a0 - middle::trans::base::trans_fn::h7f652b8e491f5fceNIe\n  29:     0x7f126b24ad10 - middle::trans::monomorphize::monomorphic_fn::h444eefff2433fcd158X\n  30:     0x7f126b2a3ed0 - middle::trans::callee::trans_fn_ref_with_vtables::hbc4955abe0c5e25axp1\n  31:     0x7f126b2a15b0 - middle::trans::callee::trans_fn_ref::h8cbdc53077e7d865za1\n  32:     0x7f126b273f50 - middle::trans::meth::trans_method_callee::hd255bf18a4fec4edJhk\n  33:     0x7f126b2b0d00 - middle::trans::callee::trans_method_call::closure.115194\n  34:     0x7f126b271930 - middle::trans::callee::trans_call_inner::h3d3ba09198f29bc9nR1\n  35:     0x7f126b2b05a0 - middle::trans::callee::trans_method_call::h20b5c2a1e6f706d1BM1\n  36:     0x7f126b2c5b40 - middle::trans::expr::trans_rvalue_dps_unadjusted::h68c42f27e53f341euG3\n  37:     0x7f126b2610c0 - middle::trans::expr::trans_into::h02f395bc1df027d3QL2\n  38:     0x7f126b2601f0 - middle::trans::controlflow::trans_stmt_semi::h4399908e9bfb4a53eMY\n  39:     0x7f126b25ee40 - middle::trans::controlflow::trans_stmt::h814b238e9dbd031fXHY\n  40:     0x7f126b2617e0 - middle::trans::controlflow::trans_block::h05731a7862534d438MY\n  41:     0x7f126b3b30f0 - middle::trans::base::trans_closure::h761f159ac0f5b1d5Zve\n  42:     0x7f126b24a4a0 - middle::trans::base::trans_fn::h7f652b8e491f5fceNIe\n  43:     0x7f126b246590 - middle::trans::base::trans_item::h9c3deb60b9a1469bO1e\n  44:     0x7f126b3c0b10 - middle::trans::base::trans_mod::hdc94d62cb0c66b22X5e\n  45:     0x7f126b3d3920 - middle::trans::base::trans_crate::h2bbe93d38696f05f2Wf\n  46:     0x7f126bc77620 - driver::driver::phase_4_translate_to_llvm::closure.136750\n  47:     0x7f126bc76fc0 - util::common::time::h4601779646530965728\n  48:     0x7f126bbb8380 - driver::driver::phase_4_translate_to_llvm::hcbbe57487cf47912Y1z\n  49:     0x7f126bbb2860 - driver::driver::compile_input::hd5ac6510c8591e16pEz\n  50:     0x7f126bcbc170 - driver::run_compiler::hfb28193ee56e89e2jcD\n  51:     0x7f126bcbc040 - driver::main_args::closure.137687\n  52:     0x7f126bcee7f0 - task::TaskBuilder<S>::try_future::closure.138848\n  53:     0x7f126bcee3a0 - task::TaskBuilder<S>::spawn_internal::closure.138825\n  54:     0x7f126a715d90 - task::spawn_opts::closure.8331\n  55:     0x7f126a2ec3a0 - unwind::try::try_fn::__rust_abi\n  56:     0x7f126a2ebdd0 - unwind::try::try_fn::hd559f7a319afd50b38d\n  57:     0x7f126a3a63d0 - rust_try_inner\n  58:     0x7f126a3a63c0 - rust_try\n  59:     0x7f126a2e6250 - unwind::try::ha1bfe3bb2c20efd2F6d\n  60:     0x7f126a2e5d50 - task::Task::run::hd76056204f6bfc11Zcd\n  61:     0x7f126a7159c0 - task::spawn_opts::closure.8277\n  62:     0x7f126a2ea4f0 - thread::thread_start::__rust_abi\n  63:     0x7f126a2ea4e0 - thread::thread_start::hc1291c833034ff64LBd\n  64:     0x7f1264b53fe0 - start_thread\n  65:     0x7f1269fa0019 - __clone\n  66:                0x0 - <unknown>\n```\n\n(This has my modifications to give a marginally more useful error message.)\n\nThe failure happens when [looking up a type parameter `DefId`](https://github.com/rust-lang/rust/blob/e11cb5bba745ea0f661ee87c8e7550c2f33e0e44/src/librustc/middle/ty.rs#L2292) when handling the `ty_param` case.\n\nWhat I actually get building `html5ever` is a failure of the preceding assertion regarding crate IDs.  I didn't find a small reproducer for that assertion failure, but this bug is likely to be related.\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/16643/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/16643/timeline", "performed_via_github_app": null, "state_reason": "completed"}