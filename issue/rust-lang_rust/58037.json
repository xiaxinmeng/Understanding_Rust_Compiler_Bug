{"url": "https://api.github.com/repos/rust-lang/rust/issues/58037", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/58037/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/58037/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/58037/events", "html_url": "https://github.com/rust-lang/rust/issues/58037", "id": 405503053, "node_id": "MDU6SXNzdWU0MDU1MDMwNTM=", "number": 58037, "title": "Inconsistencies when exporting dynamic symbols from executables", "user": {"login": "acfoltzer", "id": 205266, "node_id": "MDQ6VXNlcjIwNTI2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/205266?v=4", "gravatar_id": "", "url": "https://api.github.com/users/acfoltzer", "html_url": "https://github.com/acfoltzer", "followers_url": "https://api.github.com/users/acfoltzer/followers", "following_url": "https://api.github.com/users/acfoltzer/following{/other_user}", "gists_url": "https://api.github.com/users/acfoltzer/gists{/gist_id}", "starred_url": "https://api.github.com/users/acfoltzer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/acfoltzer/subscriptions", "organizations_url": "https://api.github.com/users/acfoltzer/orgs", "repos_url": "https://api.github.com/users/acfoltzer/repos", "events_url": "https://api.github.com/users/acfoltzer/events{/privacy}", "received_events_url": "https://api.github.com/users/acfoltzer/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 45472092, "node_id": "MDU6TGFiZWw0NTQ3MjA5Mg==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-ffi", "name": "A-ffi", "color": "f7e101", "default": false, "description": "Area: Foreign Function Interface (FFI)"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2019-02-01T00:38:59Z", "updated_at": "2020-05-19T18:31:28Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I'm working on a project that uses dynamic loading with callbacks back into the Rust executable. Now that the project is big enough to require some of these callbacks to be defined in separate crates, I'm finding the behavior of when a symbol is exported or not to be very inconsistent.\r\n\r\nI've tried to shrink the issue by creating a repo that contains several variants that do and don't work. The README describes the variations in more detail: https://github.com/acfoltzer/exported-symbol-example\r\n\r\nThe upshot is that based on #54451, I would expect that any `#[no_mangle]` definitions in both the executable crate and any dependencies to be exported from the final executable, assuming `--export-dynamic` is used for the final link step.\r\n\r\nInstead, the exported `#[no_mangle]` callbacks are eliminated from the final executable in many situations. It's not as simple as whether the callbacks are used/reachable directly from `main`, but also seems to be influenced by the use of trait objects that happen to share a module with the callbacks. This doesn't seem like the intended behavior.\r\n\r\n## Meta\r\nReproducible on nightly and stable:\r\n\r\n```\r\n% rustc --version --verbose\r\nrustc 1.32.0 (9fda7c223 2019-01-16)\r\nbinary: rustc\r\ncommit-hash: 9fda7c2237db910e41d6a712e9a2139b352e558b\r\ncommit-date: 2019-01-16\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.32.0\r\nLLVM version: 8.0\r\n```\r\n```\r\n%rustc --version --verbose\r\nrustc 1.34.0-nightly (c1c3c4e95 2019-01-29)\r\nbinary: rustc\r\ncommit-hash: c1c3c4e95b69dfeaca5c5db6c622d7f90ad30a54\r\ncommit-date: 2019-01-29\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.34.0-nightly\r\nLLVM version: 8.0\r\n```\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/58037/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/58037/timeline", "performed_via_github_app": null, "state_reason": null}