{"url": "https://api.github.com/repos/rust-lang/rust/issues/86068", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/86068/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/86068/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/86068/events", "html_url": "https://github.com/rust-lang/rust/issues/86068", "id": 912904990, "node_id": "MDU6SXNzdWU5MTI5MDQ5OTA=", "number": 86068, "title": "`impl Trait` in return position with lifetimes and `const_evaluatable_checked` gives ICE", "user": {"login": "iliakonnov", "id": 9402179, "node_id": "MDQ6VXNlcjk0MDIxNzk=", "avatar_url": "https://avatars.githubusercontent.com/u/9402179?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iliakonnov", "html_url": "https://github.com/iliakonnov", "followers_url": "https://api.github.com/users/iliakonnov/followers", "following_url": "https://api.github.com/users/iliakonnov/following{/other_user}", "gists_url": "https://api.github.com/users/iliakonnov/gists{/gist_id}", "starred_url": "https://api.github.com/users/iliakonnov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iliakonnov/subscriptions", "organizations_url": "https://api.github.com/users/iliakonnov/orgs", "repos_url": "https://api.github.com/users/iliakonnov/repos", "events_url": "https://api.github.com/users/iliakonnov/events{/privacy}", "received_events_url": "https://api.github.com/users/iliakonnov/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 307747675, "node_id": "MDU6TGFiZWwzMDc3NDc2NzU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-incr-comp", "name": "A-incr-comp", "color": "f7e101", "default": false, "description": "Area: Incremental compilation"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1282665911, "node_id": "MDU6TGFiZWwxMjgyNjY1OTEx", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-const-generics", "name": "A-const-generics", "color": "f7e101", "default": false, "description": "Area: const generics (parameters and arguments)"}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}, {"id": 1486687397, "node_id": "MDU6TGFiZWwxNDg2Njg3Mzk3", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-const_generics", "name": "F-const_generics", "color": "f9c0cc", "default": false, "description": "`#![feature(const_generics)]`"}, {"id": 2341291797, "node_id": "MDU6TGFiZWwyMzQxMjkxNzk3", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-generic_const_exprs", "name": "F-generic_const_exprs", "color": "f9c0cc", "default": false, "description": "`#![feature(generic_const_exprs)]`"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2021-06-06T17:54:47Z", "updated_at": "2021-06-06T18:10:01Z", "closed_at": "2021-06-06T18:10:01Z", "author_association": "NONE", "active_lock_reason": null, "body": "I did some experiments and found that reproducing ICE requires two things:\r\n1. Incremental compilation enabled: `-C incremental`. I believe that's why it compiles well at [playground](https://play.rust-lang.org/?version=nightly&mode=debug&edition=2018&gist=eb0ef160e474a80b3e7b912b76ddb3e2).\r\n2. Both `const_generics` and `const_evaluatable_checked` must be present. Otherwise, it just compiles well.\r\n\r\nI've tried to reduce it by specifying concrete type or removing lifetimes or const generics, but had no luck. So that's why title is so long.\r\n\r\n### Code\r\n\r\nCompile with cargo or use `rustc ./ice.rs --crate-type lib -C incremental=something`\r\n\r\n```Rust\r\n#![feature(const_generics)]\r\n#![feature(const_evaluatable_checked)]\r\n\r\ntrait SomeTrait {}    \r\n\r\nstruct SomeStruct<const S: bool>;     \r\n\r\nimpl<const S: bool> SomeTrait for SomeStruct<S> {}\r\n\r\nfn func<'a>() -> impl 'a + SomeTrait\r\n{\r\n    SomeStruct::<{true}>\r\n}\r\n```\r\n\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.54.0-nightly (6c2dd251b 2021-06-05)\r\nbinary: rustc\r\ncommit-hash: 6c2dd251bbff03c7a3092d43fb5b637eca0810e3\r\ncommit-date: 2021-06-05\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.54.0-nightly\r\nLLVM version: 12.0.1\r\n```\r\n\r\n### Error output\r\n\r\n```\r\nerror: internal compiler error: compiler/rustc_middle/src/ich/impls_ty.rs:94:17: StableHasher: unexpected region '_#0r\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary><strong>Backtrace</strong></summary>\r\n<p>\r\n\r\n```\r\nerror: internal compiler error: compiler/rustc_middle/src/ich/impls_ty.rs:94:17: StableHasher: unexpected region '_#0r\r\n\r\nthread 'rustc' panicked at 'Box<Any>', compiler/rustc_errors/src/lib.rs:1007:9\r\nstack backtrace:\r\n   0: std::panicking::begin_panic\r\n   1: std::panic::panic_any\r\n   2: rustc_errors::HandlerInner::bug\r\n   3: rustc_errors::Handler::bug\r\n   4: rustc_middle::ty::context::tls::with_opt\r\n   5: rustc_middle::util::bug::opt_span_bug_fmt\r\n   6: rustc_middle::util::bug::bug_fmt\r\n   7: rustc_middle::ich::impls_ty::<impl rustc_data_structures::stable_hasher::HashStable<rustc_middle::ich::hcx::StableHashingContext> for rustc_middle::ty::sty::RegionKind>::hash_stable\r\n   8: std::thread::local::LocalKey<T>::with\r\n   9: <(T1,T2) as rustc_data_structures::stable_hasher::HashStable<CTX>>::hash_stable\r\n  10: <T as rustc_query_system::dep_graph::dep_node::DepNodeParams<Ctxt>>::to_fingerprint\r\n  11: rustc_query_system::dep_graph::dep_node::DepNode<K>::construct\r\n  12: rustc_query_system::query::plumbing::get_query_impl\r\n  13: rustc_query_system::query::plumbing::get_query\r\n  14: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::try_unify_abstract_consts\r\n  15: rustc_trait_selection::traits::fulfill::FulfillProcessor::progress_changed_obligations\r\n  16: rustc_data_structures::obligation_forest::ObligationForest<O>::process_obligations\r\n  17: <rustc_trait_selection::traits::fulfill::FulfillmentContext as rustc_infer::traits::engine::TraitEngine>::select_where_possible\r\n  18: rustc_infer::infer::canonical::query_response::<impl rustc_infer::infer::InferCtxt>::make_canonicalized_query_response\r\n  19: <rustc_infer::infer::InferCtxtBuilder as rustc_trait_selection::infer::InferCtxtBuilderExt>::enter_canonical_trait_query\r\n  20: rustc_traits::type_op::type_op_ascribe_user_type\r\n  21: rustc_query_impl::<impl rustc_query_system::query::config::QueryAccessors<rustc_query_impl::plumbing::QueryCtxt> for rustc_query_impl::queries::type_op_ascribe_user_type>::compute\r\n  22: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task_impl\r\n  23: rustc_data_structures::stack::ensure_sufficient_stack\r\n  24: rustc_query_system::query::plumbing::get_query_impl\r\n  25: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::type_op_ascribe_user_type\r\n  26: rustc_trait_selection::traits::query::type_op::ascribe_user_type::<impl rustc_trait_selection::traits::query::type_op::QueryTypeOp for rustc_middle::traits::query::type_op::AscribeUserType>::perform_query\r\n  27: rustc_trait_selection::traits::query::type_op::QueryTypeOp::fully_perform_into\r\n  28: <rustc_middle::ty::ParamEnvAnd<Q> as rustc_trait_selection::traits::query::type_op::TypeOp>::fully_perform\r\n  29: rustc_mir::borrow_check::type_check::type_check\r\n  30: rustc_mir::borrow_check::nll::compute_regions\r\n  31: rustc_mir::borrow_check::do_mir_borrowck\r\n  32: rustc_infer::infer::InferCtxtBuilder::enter\r\n  33: rustc_mir::borrow_check::mir_borrowck\r\n  34: core::ops::function::FnOnce::call_once\r\n  35: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task_impl\r\n  36: rustc_data_structures::stack::ensure_sufficient_stack\r\n  37: rustc_query_system::query::plumbing::force_query_with_job\r\n  38: rustc_query_system::query::plumbing::get_query_impl\r\n  39: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::mir_borrowck\r\n  40: rustc_typeck::collect::type_of::type_of\r\n  41: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task_impl\r\n  42: rustc_data_structures::stack::ensure_sufficient_stack\r\n  43: rustc_query_system::query::plumbing::force_query_with_job\r\n  44: rustc_query_system::query::plumbing::get_query_impl\r\n  45: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::type_of\r\n  46: rustc_typeck::check::check::check_item_type\r\n  47: rustc_middle::hir::map::Map::visit_item_likes_in_module\r\n  48: rustc_typeck::check::check::check_mod_item_types\r\n  49: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task_impl\r\n  50: rustc_data_structures::stack::ensure_sufficient_stack\r\n  51: rustc_query_system::query::plumbing::force_query_with_job\r\n  52: rustc_query_system::query::plumbing::get_query_impl\r\n  53: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::check_mod_item_types\r\n  54: rustc_session::utils::<impl rustc_session::session::Session>::time\r\n  55: rustc_typeck::check_crate\r\n  56: rustc_interface::passes::analysis\r\n  57: rustc_middle::dep_graph::<impl rustc_query_system::dep_graph::DepKind for rustc_middle::dep_graph::dep_node::DepKind>::with_deps\r\n  58: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task_impl\r\n  59: rustc_query_system::dep_graph::graph::DepGraph<K>::with_eval_always_task\r\n  60: rustc_data_structures::stack::ensure_sufficient_stack\r\n  61: rustc_query_system::query::plumbing::force_query_with_job\r\n  62: rustc_query_system::query::plumbing::get_query_impl\r\n  63: <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::analysis\r\n  64: rustc_interface::passes::QueryContext::enter\r\n  65: rustc_span::with_session_globals\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&template=ice.md\r\n\r\nnote: rustc 1.54.0-nightly (6c2dd251b 2021-06-05) running on x86_64-unknown-linux-gnu\r\n\r\nnote: compiler flags: -C incremental --crate-type lib\r\n\r\nquery stack during panic:\r\n#0 [type_op_ascribe_user_type] evaluating `type_op_ascribe_user_type` `Canonical { max_universe: U0, variables: [CanonicalVarInfo { kind: Region(U0) }, CanonicalVarInfo { kind: Region(U0) }], value: ParamEnvAnd { param_env: ParamEnv { caller_bounds: [], reveal: UserFacing }, value: AscribeUserType { mir_ty: SomeStruct<{}>, def_id: DefId(0:5 ~ foo[cf51]::SomeStruct::{constructor#0}), user_substs: UserSubsts { substs: [Const { ty: (), val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:12 ~ foo[cf51]::func::{constant#0}), const_param_did: Some(DefId(0:6 ~ foo[cf51]::SomeStruct::S)) }, substs: [ReLateBound(DebruijnIndex(0), BoundRegion { var: 1, kind: BrAnon(1) })], promoted: None }) }], user_self_ty: None } } } }`\r\n#1 [mir_borrowck] borrow-checking `func`\r\n#2 [type_of] computing type of `func::{opaque#0}`\r\n#3 [check_mod_item_types] checking item types in top-level module\r\n#4 [analysis] running analysis passes on this crate\r\nend of query stack\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n@rustbot label +F-const_generics +F-const_evaluatable_checked +requires-nightly +A-const-generics +A-incr-comp", "closed_by": {"login": "iliakonnov", "id": 9402179, "node_id": "MDQ6VXNlcjk0MDIxNzk=", "avatar_url": "https://avatars.githubusercontent.com/u/9402179?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iliakonnov", "html_url": "https://github.com/iliakonnov", "followers_url": "https://api.github.com/users/iliakonnov/followers", "following_url": "https://api.github.com/users/iliakonnov/following{/other_user}", "gists_url": "https://api.github.com/users/iliakonnov/gists{/gist_id}", "starred_url": "https://api.github.com/users/iliakonnov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iliakonnov/subscriptions", "organizations_url": "https://api.github.com/users/iliakonnov/orgs", "repos_url": "https://api.github.com/users/iliakonnov/repos", "events_url": "https://api.github.com/users/iliakonnov/events{/privacy}", "received_events_url": "https://api.github.com/users/iliakonnov/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/86068/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/86068/timeline", "performed_via_github_app": null, "state_reason": "completed"}