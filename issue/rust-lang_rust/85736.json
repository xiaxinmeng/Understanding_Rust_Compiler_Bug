{"url": "https://api.github.com/repos/rust-lang/rust/issues/85736", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/85736/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/85736/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/85736/events", "html_url": "https://github.com/rust-lang/rust/issues/85736", "id": 903212233, "node_id": "MDU6SXNzdWU5MDMyMTIyMzM=", "number": 85736, "title": "Regression: undefined symbol `__atomic_load_4` on risvc32imac-unknown-none-elf", "user": {"login": "xobs", "id": 238325, "node_id": "MDQ6VXNlcjIzODMyNQ==", "avatar_url": "https://avatars.githubusercontent.com/u/238325?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xobs", "html_url": "https://github.com/xobs", "followers_url": "https://api.github.com/users/xobs/followers", "following_url": "https://api.github.com/users/xobs/following{/other_user}", "gists_url": "https://api.github.com/users/xobs/gists{/gist_id}", "starred_url": "https://api.github.com/users/xobs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xobs/subscriptions", "organizations_url": "https://api.github.com/users/xobs/orgs", "repos_url": "https://api.github.com/users/xobs/repos", "events_url": "https://api.github.com/users/xobs/events{/privacy}", "received_events_url": "https://api.github.com/users/xobs/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1210355734, "node_id": "MDU6TGFiZWwxMjEwMzU1NzM0", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-riscv", "name": "O-riscv", "color": "6e6ec0", "default": false, "description": "Target: RISC-V architecture"}, {"id": 1791937891, "node_id": "MDU6TGFiZWwxNzkxOTM3ODkx", "url": "https://api.github.com/repos/rust-lang/rust/labels/ICEBreaker-Cleanup-Crew", "name": "ICEBreaker-Cleanup-Crew", "color": "74cc28", "default": false, "description": "Helping to \"clean up\" bugs with minimal examples and bisections"}, {"id": 2459791492, "node_id": "MDU6TGFiZWwyNDU5NzkxNDky", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-lto", "name": "A-lto", "color": "f7e101", "default": false, "description": "Area: Link Time Optimization"}, {"id": 4434017660, "node_id": "LA_kwDOAAsO6M8AAAABCEm9fA", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-atomic", "name": "A-atomic", "color": "f7e101", "default": false, "description": "Area: atomics, barriers, and sync primitives"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2021-05-27T04:52:19Z", "updated_at": "2022-08-17T06:39:53Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "### Description\r\n\r\nWhen building for `riscv32imac-unknown-none-elf`, `rustc` is occasionally generating calls to `__atomic_load_4`. This symbol doesn't appear to exist, even though atomics are supported on this platform. Furthermore, I'm not sure if atomics are used anywhere in this codepath -- `log` is the only crate in the dependency tree that I haven't verified.\r\n\r\nThis works fine if I target `riscv32i-unknown-none-elf`, which disables atomic generation.\r\n\r\nFurthermore, this builds fine if I use rustc `1.51`, however it fails with rustc `1.52.1`.\r\n\r\n### Background\r\n\r\nI'm trying to work with the crate `gdbstub` to integrate it into a kernel running on baremetal RISC-V. The target is `riscv32imac-unknown-none-elf`, which has atomics. For some reason, the compiler is generating calls to `__atomic_load_4`, which doesn't exist.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.52.1 (9bc8c42bb 2021-05-09)\r\nbinary: rustc\r\ncommit-hash: 9bc8c42bb2f19e745a63f3445f1ac248fb015e53\r\ncommit-date: 2021-05-09\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.52.1\r\nLLVM version: 12.0.0\r\n```\r\n\r\n<details><summary>rustc 1.51</summary>\r\n<p>\r\n\r\n```\r\nuser@Cuboid:/mnt/d/Code/Xous/Core/kernel$ cargo +1.51 build --target riscv32imac-unknown-none-elf\r\nwarning: unused variable: `gdb_interrupt`\r\n   --> src/debug.rs:168:13\r\n    |\r\n168 |             gdb_interrupt: GdbInterrupt<'_>,\r\n    |             ^^^^^^^^^^^^^ help: if this is intentional, prefix it with an underscore: `_gdb_interrupt`\r\n    |\r\n    = note: `#[warn(unused_variables)]` on by default\r\n\r\nwarning: unused variable: `register_thread`\r\n   --> src/debug.rs:257:13\r\n    |\r\n257 |             register_thread: &mut dyn FnMut(Tid),\r\n    |             ^^^^^^^^^^^^^^^ help: if this is intentional, prefix it with an underscore: `_register_thread`\r\n\r\nwarning: field is never read: `pid`\r\n   --> src/debug.rs:136:9\r\n    |\r\n136 |         pid: Option<xous_kernel::PID>,\r\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    |\r\n    = note: `#[warn(dead_code)]` on by default\r\n\r\nwarning: field is never read: `tid`\r\n   --> src/debug.rs:137:9\r\n    |\r\n137 |         tid: Option<xous_kernel::TID>,\r\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\nwarning: field is never read: `thread_mask`\r\n   --> src/debug.rs:138:9\r\n    |\r\n138 |         thread_mask: usize,\r\n    |         ^^^^^^^^^^^^^^^^^^\r\n\r\nwarning: variant is never constructed: `Debug`\r\n  --> src/services.rs:61:5\r\n   |\r\n61 |     Debug(usize),\r\n   |     ^^^^^^^^^^^^\r\n\r\nwarning: 6 warnings emitted\r\n\r\n    Finished dev [unoptimized + debuginfo] target(s) in 0.76s\r\nuser@Cuboid:/mnt/d/Code/Xous/Core/kernel$\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n<details><summary>rustc 1.52.1</summary>\r\n<p>\r\n\r\n```\r\nuser@Cuboid:/mnt/d/Code/Xous/Core/kernel$ cargo +stable build --target riscv32imac-unknown-none-elf\r\n   Compiling kernel v0.8.2 (/mnt/d/Code/Xous/Core/kernel)\r\nwarning: unused variable: `gdb_interrupt`\r\n   --> src/debug.rs:168:13\r\n    |\r\n168 |             gdb_interrupt: GdbInterrupt<'_>,\r\n    |             ^^^^^^^^^^^^^ help: if this is intentional, prefix it with an underscore: `_gdb_interrupt`\r\n    |\r\n    = note: `#[warn(unused_variables)]` on by default\r\n\r\nwarning: unused variable: `register_thread`\r\n   --> src/debug.rs:257:13\r\n    |\r\n257 |             register_thread: &mut dyn FnMut(Tid),\r\n    |             ^^^^^^^^^^^^^^^ help: if this is intentional, prefix it with an underscore: `_register_thread`\r\n\r\nwarning: field is never read: `pid`\r\n   --> src/debug.rs:136:9\r\n    |\r\n136 |         pid: Option<xous_kernel::PID>,\r\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    |\r\n    = note: `#[warn(dead_code)]` on by default\r\n\r\nwarning: field is never read: `tid`\r\n   --> src/debug.rs:137:9\r\n    |\r\n137 |         tid: Option<xous_kernel::TID>,\r\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\nwarning: field is never read: `thread_mask`\r\n   --> src/debug.rs:138:9\r\n    |\r\n138 |         thread_mask: usize,\r\n    |         ^^^^^^^^^^^^^^^^^^\r\n\r\nwarning: variant is never constructed: `Debug`\r\n  --> src/services.rs:61:5\r\n   |\r\n61 |     Debug(usize),\r\n   |     ^^^^^^^^^^^^\r\n\r\nerror: linking with `rust-lld` failed: exit code: 1\r\n  |\r\n  = note: \"rust-lld\" \"-flavor\" \"gnu\" \"-plugin-opt=O0\" \"-plugin-opt=mcpu=generic-rv32\" \"-L\" \"/home/user/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/riscv32imac-unknown-none-elf/lib\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.0.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.1.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.10.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.11.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.12.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.13.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.14.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.15.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.2.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.3.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.4.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.5.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.6.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.7.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.8.rcgu.o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61.kernel.2tnp50fl-cgu.9.rcgu.o\" \"-o\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/kernel-a49a1beda364ba61\" \"--gc-sections\" \"-L\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps\" \"-L\" \"/mnt/d/Code/Xous/Core/kernel/target/debug/deps\" \"-L\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/build/kernel-b2cf221a795a62c2/out\" \"-L\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/build/kernel-b2cf221a795a62c2/out\" \"-L\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/build/riscv-4ccdf2c7a1922587/out\" \"-L\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/build/xous-1a7daf4c65ecd197/out\" \"-L\" \"/home/user/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/riscv32imac-unknown-none-elf/lib\" \"-Bstatic\" \"--whole-archive\" \"-lkernel\" \"--no-whole-archive\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/libgdbstub_arch-56fd0be17381d6a4.rlib\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/libxous-39428ed2b3a43c31.rlib\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/libriscv-be84ff84a45e1b85.rlib\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/libbit_field-e83fefc77bfd4655.rlib\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/libbare_metal-4609200987315921.rlib\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/libgdbstub-517875492397d3c0.rlib\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/libcfg_if-5e47378e83c91cff.rlib\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/libnum_traits-34dfc229d6370397.rlib\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/libmanaged-9d0d80e606c7b727.rlib\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/liblog-4269a8ed40a0932a.rlib\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/libcfg_if-2c07cfa8a1d4ab2f.rlib\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/libutralib-18b768caf3ee14fc.rlib\" \"/mnt/d/Code/Xous/Core/kernel/target/riscv32imac-unknown-none-elf/debug/deps/libbitflags-46bd593bb6538427.rlib\" \"/home/user/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/riscv32imac-unknown-none-elf/lib/librustc_std_workspace_core-525cd988d4e88ede.rlib\" \"/home/user/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/riscv32imac-unknown-none-elf/lib/libcore-d1be523e2bc04c86.rlib\" \"/home/user/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/riscv32imac-unknown-none-elf/lib/libcompiler_builtins-f400fa914b91ce44.rlib\" \"-Tlink.x\" \"-Bdynamic\"\r\n  = note: rust-lld: error: undefined symbol: __atomic_load_4\r\n          >>> referenced by atomic.rs:0 (/home/user/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/sync/atomic.rs:0)\r\n          >>>               lto.tmp:(core::sync::atomic::AtomicUsize::load::h0594e1bc6e9a0e87)\r\n          >>> referenced by atomic.rs:0 (/home/user/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/sync/atomic.rs:0)\r\n          >>>               lto.tmp:(core::sync::atomic::atomic_load::h507cc031d576ee38)\r\n\r\n\r\nerror: aborting due to previous error; 6 warnings emitted\r\n\r\nerror: could not compile `kernel`\r\n\r\nTo learn more, run the command again with --verbose.\r\nuser@Cuboid:/mnt/d/Code/Xous/Core/kernel$\r\n```\r\n\r\n</p>\r\n</details>", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/85736/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/85736/timeline", "performed_via_github_app": null, "state_reason": null}