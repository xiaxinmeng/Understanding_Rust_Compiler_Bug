{"url": "https://api.github.com/repos/rust-lang/rust/issues/103773", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/103773/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/103773/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/103773/events", "html_url": "https://github.com/rust-lang/rust/issues/103773", "id": 1428986571, "node_id": "I_kwDOAAsO6M5VLJrL", "number": 103773, "title": "AVX512VAES on AMD EPYC gives `LLVM ERROR: Do not know how to split the result of this operator `", "user": {"login": "SchrodingerZhu", "id": 20108837, "node_id": "MDQ6VXNlcjIwMTA4ODM3", "avatar_url": "https://avatars.githubusercontent.com/u/20108837?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SchrodingerZhu", "html_url": "https://github.com/SchrodingerZhu", "followers_url": "https://api.github.com/users/SchrodingerZhu/followers", "following_url": "https://api.github.com/users/SchrodingerZhu/following{/other_user}", "gists_url": "https://api.github.com/users/SchrodingerZhu/gists{/gist_id}", "starred_url": "https://api.github.com/users/SchrodingerZhu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SchrodingerZhu/subscriptions", "organizations_url": "https://api.github.com/users/SchrodingerZhu/orgs", "repos_url": "https://api.github.com/users/SchrodingerZhu/repos", "events_url": "https://api.github.com/users/SchrodingerZhu/events{/privacy}", "received_events_url": "https://api.github.com/users/SchrodingerZhu/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 5223550385, "node_id": "LA_kwDOAAsO6M8AAAABN1kNsQ", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-target-feature", "name": "A-target-feature", "color": "f7e101", "default": false, "description": "Area: Enabling/disabling target features like AVX, Neon, etc."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2022-10-30T19:16:35Z", "updated_at": "2023-04-05T17:34:03Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried this code:\r\n\r\nhttps://github.com/tkaitchuck/aHash/compare/master...SchrodingerZhu:aHash:master\r\n\r\nI tried to run test with \r\n```bash\r\ncargo test  --release --features=vaes\r\n```\r\nUnfortunately, I got\r\n```\r\n---- src/random_state.rs - random_state::RandomState::hash_one (line 324) stdout ----\r\nLLVM ERROR: Do not know how to split the result of this operator!\r\n\r\nCouldn't compile the test.\r\n---- src/random_state.rs - random_state::RandomState::hash_one (line 424) stdout ----\r\nLLVM ERROR: Do not know how to split the result of this operator!\r\n\r\nCouldn't compile the test.\r\n---- src/random_state.rs - random_state::RandomState::hash_one (line 414) stdout ----\r\nLLVM ERROR: Do not know how to split the result of this operator!\r\n\r\nCouldn't compile the test.\r\n---- src/random_state.rs - random_state::RandomState::hash_one (line 314) stdout ----\r\nLLVM ERROR: Do not know how to split the result of this operator!\r\n\r\nCouldn't compile the test.\r\n---- src/lib.rs - (line 51) stdout ----\r\nLLVM ERROR: Do not know how to split the result of this operator!\r\n\r\nCouldn't compile the test.\r\n```\r\n\r\nIf I mark the function as `inline(never)`, the problem just gone:\r\nhttps://github.com/SchrodingerZhu/aHash/blob/705d68e0078c932443f71955d9db096a252d686b/src/aes_hash.rs#L136\r\n\r\nMy CPU:\r\n\r\n```\r\nArchitecture:            x86_64\r\n  CPU op-mode(s):        32-bit, 64-bit\r\n  Address sizes:         48 bits physical, 48 bits virtual\r\n  Byte Order:            Little Endian\r\nCPU(s):                  128\r\n  On-line CPU(s) list:   0-127\r\nVendor ID:               AuthenticAMD\r\n  Model name:            AMD EPYC 7773X 64-Core Processor\r\n    CPU family:          25\r\n    Model:               1\r\n    Thread(s) per core:  2\r\n    Core(s) per socket:  64\r\n    Socket(s):           1\r\n    Stepping:            2\r\n    Frequency boost:     enabled\r\n    CPU(s) scaling MHz:  63%\r\n    CPU max MHz:         3527.7339\r\n    CPU min MHz:         1500.0000\r\n    BogoMIPS:            4404.99\r\n    Flags:               fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm constant_tsc rep_good nopl nonstop_tsc cpuid extd_apicid aperfmperf rapl pni pclmulqdq monitor ssse3 \r\n                         fma cx16 pcid sse4_1 sse4_2 movbe popcnt aes xsave avx f16c rdrand lahf_lm cmp_legacy svm extapic cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw ibs skinit wdt tce topoext perfctr_core perfctr_nb bpext perfctr_llc mwaitx cpb cat_l3 cdp_l3 inv\r\n                         pcid_single hw_pstate ssbd mba ibrs ibpb stibp vmmcall fsgsbase bmi1 avx2 smep bmi2 invpcid cqm rdt_a rdseed adx smap clflushopt clwb sha_ni xsaveopt xsavec xgetbv1 xsaves cqm_llc cqm_occup_llc cqm_mbm_total cqm_mbm_local clzero irperf xsaveerptr \r\n                         rdpru wbnoinvd amd_ppin brs arat npt lbrv svm_lock nrip_save tsc_scale vmcb_clean flushbyasid decodeassists pausefilter pfthreshold v_vmsave_vmload vgif v_spec_ctrl umip pku ospke vaes vpclmulqdq rdpid overflow_recov succor smca\r\nVirtualization features: \r\n  Virtualization:        AMD-V\r\nCaches (sum of all):     \r\n  L1d:                   2 MiB (64 instances)\r\n  L1i:                   2 MiB (64 instances)\r\n  L2:                    32 MiB (64 instances)\r\n  L3:                    768 MiB (8 instances)\r\nNUMA:                    \r\n  NUMA node(s):          1\r\n  NUMA node0 CPU(s):     0-127\r\nVulnerabilities:         \r\n  Itlb multihit:         Not affected\r\n  L1tf:                  Not affected\r\n  Mds:                   Not affected\r\n  Meltdown:              Not affected\r\n  Mmio stale data:       Not affected\r\n  Retbleed:              Not affected\r\n  Spec store bypass:     Mitigation; Speculative Store Bypass disabled via prctl\r\n  Spectre v1:            Mitigation; usercopy/swapgs barriers and __user pointer sanitization\r\n  Spectre v2:            Mitigation; Retpolines, IBPB conditional, IBRS_FW, STIBP always-on, RSB filling, PBRSB-eIBRS Not affected\r\n  Srbds:                 Not affected\r\n  Tsx async abort:       Not affected\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/103773/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/103773/timeline", "performed_via_github_app": null, "state_reason": null}