{"url": "https://api.github.com/repos/rust-lang/rust/issues/94742", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/94742/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/94742/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/94742/events", "html_url": "https://github.com/rust-lang/rust/issues/94742", "id": 1162932382, "node_id": "I_kwDOAAsO6M5FUPCe", "number": 94742, "title": "Read::read_buf mutable reference to ReadBuf", "user": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2022-03-08T17:33:02Z", "updated_at": "2023-03-09T17:45:13Z", "closed_at": "2023-03-09T17:45:13Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "cc #78485\r\n\r\nCurrently, `Read::read_buf` takes a `&mut ReadBuf`. That means that a malicious `Read` impl could swap out the buffer for another whereas the intent is that an impl should only write into the buffer. If users rely on properties of the `ReadBuf` to hold for an underlying buffer, then they must check that the ReadBuf has not been changed, otherwise they risk writing code which is unsound (see #https://github.com/rust-lang/rust/issues/93305 for an example. Here copy_to should make this check, but does not). Since this check is not obvious, this is a potential footgun.\r\n\r\nThis was previously discussed on Zulip: https://rust-lang.zulipchat.com/#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature\r\n\r\nNote that this is *not* a soundness issue, however, it makes it easier than it ought to be to write unsound code.\r\n\r\nNote also that this requires an actively malicious impl of Read to be harmful since the lifetime of the ReadBuf means that the impl must use a static (or leaked) ReadBuf and that is extremely unlikely to happen by accident. IMO, this is important because a malicious impl could cause similar errors in many other ways, such as calling `assume_init` on the ReadBuf without in fact initializing the bytes. That does require `unsafe`, but IMO is no easier to audit than swapping out the ReadBuf for another (since every legitimate use of ReadBuf requires unsafe code).\r\n\r\nAnyway, the way to fix this is to have some kind of type `struct ReadBufMut<'a>(&'a mut ReadBuf);` and to use `ReadBufMut` rather than `&mut ReadBuf` in `read_buf`'s signature. The interesting question is exactly how to convert between the two types ergonomically and whether we can design things in such a way that we can expose only one type rather than two.", "closed_by": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/94742/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/94742/timeline", "performed_via_github_app": null, "state_reason": "completed"}