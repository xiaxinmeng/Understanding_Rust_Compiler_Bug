{"url": "https://api.github.com/repos/rust-lang/rust/issues/78150", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/78150/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/78150/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/78150/events", "html_url": "https://github.com/rust-lang/rust/issues/78150", "id": 725743210, "node_id": "MDU6SXNzdWU3MjU3NDMyMTA=", "number": 78150, "title": "Git pre-commit hook for tidy check uses GNU toolchain on windows by default", "user": {"login": "Emerentius", "id": 9992929, "node_id": "MDQ6VXNlcjk5OTI5Mjk=", "avatar_url": "https://avatars.githubusercontent.com/u/9992929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Emerentius", "html_url": "https://github.com/Emerentius", "followers_url": "https://api.github.com/users/Emerentius/followers", "following_url": "https://api.github.com/users/Emerentius/following{/other_user}", "gists_url": "https://api.github.com/users/Emerentius/gists{/gist_id}", "starred_url": "https://api.github.com/users/Emerentius/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Emerentius/subscriptions", "organizations_url": "https://api.github.com/users/Emerentius/orgs", "repos_url": "https://api.github.com/users/Emerentius/repos", "events_url": "https://api.github.com/users/Emerentius/events{/privacy}", "received_events_url": "https://api.github.com/users/Emerentius/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}, {"id": 266005765, "node_id": "MDU6TGFiZWwyNjYwMDU3NjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows-msvc", "name": "O-windows-msvc", "color": "6e6ec0", "default": false, "description": "Toolchain: MSVC, Operating system: Windows"}, {"id": 325438536, "node_id": "MDU6TGFiZWwzMjU0Mzg1MzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-bootstrap", "name": "T-bootstrap", "color": "bfd4f2", "default": false, "description": "Relevant to the bootstrap subteam: Rust's build system (x.py and src/bootstrap)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2020-10-20T16:08:52Z", "updated_at": "2020-11-10T13:24:32Z", "closed_at": "2020-11-10T13:24:32Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "`x.py setup` offers to install a pre-commit hook that runs `x.py test tidy --bless`. Under Windows, when this hook runs and if `build` isn't set in `config.toml`, `x.py` will always try to compile using the GNU toolchain and use GCC's linker which may not be present in which case it fails.\r\n\r\nIt happens when you're using \"Git for Windows\", which is probably the most common way to install git on Windows.\r\n\r\nI can compile rustc with the MSVC toolchain. Running `python x.py test tidy --bless` succeeds when started from a powershell window. It throws the same errors as the git hook when run from a git bash terminal.\r\nI suppose `x.py` can't distinguish git's MinGW environment from a separately installed MinGW? Relevant function in the script that decides the build triple: https://github.com/rust-lang/rust/blob/9832374f6e378971e1a933362cf9781b121bb845/src/bootstrap/bootstrap.py#L190\r\n\r\nI expected to see this happen:\r\nUse the MSVC toolchain to compile and run `tidy`, especially when run from a powershell terminal.\r\n\r\nInstead, this happened:\r\nIt tried to use the GNU toolchain from inside Git's MinGW environment, but GCC doesn't exist so it fails.\r\n\r\n<details><summary>Error</summary>\r\n<p>\r\n\r\n```\r\nPS C:\\Users\\MyUser\\Code\\rust> git commit\r\nRunning pre-commit script 'python C:/Users/MyUser/Code/rust/x.py test tidy --bless'\r\nUpdating only changed submodules\r\nSubmodules updated in 0.04 seconds\r\n   Compiling proc-macro2 v1.0.19\r\n   Compiling winapi-x86_64-pc-windows-gnu v0.4.0\r\n   Compiling winapi v0.3.9\r\n   Compiling syn v1.0.38\r\n   Compiling memchr v2.3.3\r\n   Compiling serde_derive v1.0.115\r\n   Compiling log v0.4.11\r\n   Compiling serde v1.0.115\r\n   Compiling libc v0.2.79\r\n   Compiling ryu v1.0.5\r\n   Compiling serde_json v1.0.57\r\n   Compiling bootstrap v0.0.0 (C:\\Users\\MyUser\\Code\\rust\\src\\bootstrap)\r\n   Compiling proc-macro-error-attr v1.0.4\r\n   Compiling proc-macro-error v1.0.4\r\n   Compiling num-traits v0.2.12\r\n   Compiling crossbeam-utils v0.7.2\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: could not compile `proc-macro-error-attr`\r\n\r\nTo learn more, run the command again with --verbose.\r\nwarning: build failed, waiting for other jobs to finish...\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: linker `x86_64-w64-mingw32-gcc` not found\r\n  |\r\n  = note: Das System kann die angegebene Datei nicht finden. (os error 2)\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: build failed\r\nfailed to run: C:\\Users\\MyUser\\Code\\rust\\build\\x86_64-pc-windows-gnu\\stage0\\bin\\cargo.exe build --manifest-path C:\\Users\\MyUser\\Code\\rust\\src/bootstrap/Cargo.toml\r\nBuild completed unsuccessfully in 0:00:00\r\n```\r\n</p>\r\n</details>\r\n\r\nAs I'm only using MSVC, I can workaround this by setting `[build]\\nbuild = \"x86_64-pc-windows-msvc\"` in `config.toml`.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/78150/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/78150/timeline", "performed_via_github_app": null, "state_reason": "completed"}