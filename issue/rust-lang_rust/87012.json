{"url": "https://api.github.com/repos/rust-lang/rust/issues/87012", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/87012/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/87012/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/87012/events", "html_url": "https://github.com/rust-lang/rust/issues/87012", "id": 941019822, "node_id": "MDU6SXNzdWU5NDEwMTk4MjI=", "number": 87012, "title": "Test suite compilation spends a large amount of time in `evaluate_obligation`", "user": {"login": "patrickfreed", "id": 936020, "node_id": "MDQ6VXNlcjkzNjAyMA==", "avatar_url": "https://avatars.githubusercontent.com/u/936020?v=4", "gravatar_id": "", "url": "https://api.github.com/users/patrickfreed", "html_url": "https://github.com/patrickfreed", "followers_url": "https://api.github.com/users/patrickfreed/followers", "following_url": "https://api.github.com/users/patrickfreed/following{/other_user}", "gists_url": "https://api.github.com/users/patrickfreed/gists{/gist_id}", "starred_url": "https://api.github.com/users/patrickfreed/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/patrickfreed/subscriptions", "organizations_url": "https://api.github.com/users/patrickfreed/orgs", "repos_url": "https://api.github.com/users/patrickfreed/repos", "events_url": "https://api.github.com/users/patrickfreed/events{/privacy}", "received_events_url": "https://api.github.com/users/patrickfreed/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 64037154, "node_id": "MDU6TGFiZWw2NDAzNzE1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compiletime", "name": "I-compiletime", "color": "e11d21", "default": false, "description": "Problems and improvements with respect to compile times."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 19, "created_at": "2021-07-09T19:38:41Z", "updated_at": "2021-12-20T16:32:09Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I originally posted this on the [Rust forums](https://users.rust-lang.org/t/extremely-slow-compile-times-in-test-suite/61842) but was directed here since the cause could be related to a compiler bug.\r\n\r\nI'm looking for some help debugging why the compile times in the [`mongodb`](https://github.com/mongodb/mongo-rust-driver) crate's test suite are much slower than the crate itself. For reference, a single incremental change can take a minute or longer, even when running just `cargo check --tests`. The crate itself compiles quickly--the issue is only with the tests.\r\n\r\nThe output of compiling with `-Zself-profile` indicates that nearly the entire time (~1m) is spent in `evaluate_obligation`, but I can't figure what this implies or how to possibly reduce this.\r\n\r\nA few possible culprits that I've investigated so far:\r\n* the tests make heavy use of `#[cfg_attr(...)]` to conditionally select either `#[tokio::test]` or `#[async_std::test]`. Removing all usages of this and defaulting to just `#[tokio::test]` has an insignificant impact on compile times\r\n* the tests also make heavy use of a function that accepts a closure that returns a future. According to [this thread](https://users.rust-lang.org/t/exponential-type-size-of-async-function/36852/3), such functions can cause type length / compilation time issues, but converting it to a macro that calls a function directly didn't seem to change much. Perhaps that suffers from a similar issue?\r\n* We generate a lot of builders via the `typed-builder` crate. Perhaps using them in the tests leads to long compilation times due to the generated builders having lots of generic parameters.\r\n* [this compiler issue](https://github.com/rust-lang/rust/issues/75992) related to `async` and compilation times, though someone posted their profile output and `evaluate_obligation` is not a factor in it.\r\n* most of our tests are in `src/test` rather than `tests`, not sure if this has any impact\r\n\r\nAnyways, I'm not sure where to go from here, and I was wondering if anyone else has encountered similar issues in the past or knows how I could further debug this to identify the root cause. Thanks!\r\n\r\nHere are the top few results from the self-profile output:\r\n```\r\n+--------------------------------------------------+-----------+-----------------+----------+------------+-----------------------+\r\n| Item                                             | Self time | % of total time | Time     | Item count | Incremental load time |\r\n+--------------------------------------------------+-----------+-----------------+----------+------------+-----------------------+\r\n| evaluate_obligation                              | 58.34s    | 85.300          | 58.39s   | 110480     | 0.00ns                |\r\n+--------------------------------------------------+-----------+-----------------+----------+------------+-----------------------+\r\n| expand_crate                                     | 3.54s     | 5.179           | 3.59s    | 1          | 0.00ns                |\r\n+--------------------------------------------------+-----------+-----------------+----------+------------+-----------------------+\r\n| typeck                                           | 2.74s     | 4.011           | 61.39s   | 1159       | 71.43ms               |\r\n+--------------------------------------------------+-----------+-----------------+----------+------------+-----------------------+\r\n| self_profile_alloc_query_strings                 | 979.78ms  | 1.433           | 980.49ms | 1          | 0.00ns                |\r\n+--------------------------------------------------+-----------+-----------------+----------+------------+-----------------------+\r\n| hir_lowering                                     | 204.80ms  | 0.299           | 204.80ms | 1          | 0.00ns                |\r\n+--------------------------------------------------+-----------+-----------------+----------+------------+-----------------------+\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/87012/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/87012/timeline", "performed_via_github_app": null, "state_reason": null}