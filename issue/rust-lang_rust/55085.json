{"url": "https://api.github.com/repos/rust-lang/rust/issues/55085", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/55085/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/55085/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/55085/events", "html_url": "https://github.com/rust-lang/rust/issues/55085", "id": 370003254, "node_id": "MDU6SXNzdWUzNzAwMDMyNTQ=", "number": 55085, "title": "Two cases of confusing borrow over-extension", "user": {"login": "yuriks", "id": 341401, "node_id": "MDQ6VXNlcjM0MTQwMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/341401?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yuriks", "html_url": "https://github.com/yuriks", "followers_url": "https://api.github.com/users/yuriks/followers", "following_url": "https://api.github.com/users/yuriks/following{/other_user}", "gists_url": "https://api.github.com/users/yuriks/gists{/gist_id}", "starred_url": "https://api.github.com/users/yuriks/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yuriks/subscriptions", "organizations_url": "https://api.github.com/users/yuriks/orgs", "repos_url": "https://api.github.com/users/yuriks/repos", "events_url": "https://api.github.com/users/yuriks/events{/privacy}", "received_events_url": "https://api.github.com/users/yuriks/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 604489711, "node_id": "MDU6TGFiZWw2MDQ0ODk3MTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-NLL", "name": "A-NLL", "color": "f7e101", "default": false, "description": "Area: Non Lexical Lifetimes (NLL)"}, {"id": 867483626, "node_id": "MDU6TGFiZWw4Njc0ODM2MjY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/NLL-fixed-by-NLL", "name": "NLL-fixed-by-NLL", "color": "f799ea", "default": false, "description": "Bugs fixed, but only when NLL is enabled."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2018-10-15T05:23:21Z", "updated_at": "2019-04-22T15:06:13Z", "closed_at": "2019-04-22T15:06:13Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Using rustc nightly 2018-10-13 4699283c5b549d1559c1 (from playpen).\r\n\r\nI found two cases where lifetimes appear to be extended where they shouldn't:\r\n\r\n```rust\r\nuse std::cell::RefCell;\r\nuse std::collections::binary_heap::PeekMut;\r\nuse std::collections::BinaryHeap;\r\n\r\nfn main() {\r\n    let heap: RefCell<BinaryHeap<u32>> = RefCell::new(BinaryHeap::new());\r\n\r\n    let mut heap_ref = heap.borrow_mut();\r\n    let entry = if let Some(entry) = heap_ref.peek_mut() {\r\n        entry\r\n    } else {\r\n        panic!();\r\n    };\r\n    let task = PeekMut::pop(entry);\r\n\r\n    //drop(entry);\r\n\r\n    drop(heap_ref);\r\n    println!(\"We made it {:?}, {:?}\", heap.borrow_mut(), task);\r\n}\r\n```\r\n[Playpen link](https://play.rust-lang.org/?version=nightly&mode=debug&edition=2015&gist=3c877efdbff5cb6e4fdcb9ed6bae6c80)\r\n\r\nWhich gives this error:\r\n\r\n```\r\nerror[E0505]: cannot move out of `heap_ref` because it is borrowed\r\n  --> src/main.rs:18:10\r\n   |\r\n9  |     let entry = if let Some(entry) = heap_ref.peek_mut() {\r\n   |                                      -------- borrow of `heap_ref` occurs here\r\n...\r\n18 |     drop(heap_ref);\r\n   |          ^^^^^^^^ move out of `heap_ref` occurs here\r\n```\r\n\r\nEven though the only thing that could be borrowing `heap_ref` is `entry`, which has already been moved into the `pop()` call.\r\n\r\n---\r\n\r\n```rust\r\nuse std::cell::RefCell;\r\nuse std::collections::binary_heap::PeekMut;\r\nuse std::collections::BinaryHeap;\r\n\r\nfn main() {\r\n    let heap: RefCell<BinaryHeap<u32>> = RefCell::new(BinaryHeap::new());\r\n\r\n    let task = {\r\n        let mut heap_ref = heap.borrow_mut();\r\n        if let Some(entry) = heap_ref.peek_mut() {\r\n            PeekMut::pop(entry)\r\n        } else {\r\n            panic!();\r\n        }\r\n    };\r\n\r\n    println!(\"We made it {:?}, {:?}\", heap.borrow_mut(), task);\r\n}\r\n```\r\n[Playpen link](https://play.rust-lang.org/?version=nightly&mode=debug&edition=2015&gist=203a340e5b9f9a137b1cef1920efb78f)\r\n\r\nWhich gives this error:\r\n\r\n```\r\nerror[E0597]: `heap_ref` does not live long enough\r\n  --> src/main.rs:10:30\r\n   |\r\n10 |         if let Some(entry) = heap_ref.peek_mut() {\r\n   |                              ^^^^^^^^ borrowed value does not live long enough\r\n...\r\n15 |     };\r\n   |     -- borrowed value needs to live until here\r\n   |     |\r\n   |     `heap_ref` dropped here while still borrowed\r\n```\r\n\r\nWhere it's complaining that a borrow needs to live until the same point where it's dropped.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/55085/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/55085/timeline", "performed_via_github_app": null, "state_reason": "completed"}