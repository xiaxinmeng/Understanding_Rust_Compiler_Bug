{"url": "https://api.github.com/repos/rust-lang/rust/issues/94573", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/94573/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/94573/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/94573/events", "html_url": "https://github.com/rust-lang/rust/issues/94573", "id": 1158821763, "node_id": "I_kwDOAAsO6M5FEjeD", "number": 94573, "title": "Poor codegen for string search (i.e., `memchr`) with iterators", "user": {"login": "mcy", "id": 2711945, "node_id": "MDQ6VXNlcjI3MTE5NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2711945?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcy", "html_url": "https://github.com/mcy", "followers_url": "https://api.github.com/users/mcy/followers", "following_url": "https://api.github.com/users/mcy/following{/other_user}", "gists_url": "https://api.github.com/users/mcy/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcy/subscriptions", "organizations_url": "https://api.github.com/users/mcy/orgs", "repos_url": "https://api.github.com/users/mcy/repos", "events_url": "https://api.github.com/users/mcy/events{/privacy}", "received_events_url": "https://api.github.com/users/mcy/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 2352122097, "node_id": "MDU6TGFiZWwyMzUyMTIyMDk3", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-discussion", "name": "C-discussion", "color": "f5f1fd", "default": false, "description": "Category: Discussion or questions that doesn't represent real issues."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2022-03-03T19:35:50Z", "updated_at": "2023-04-09T03:28:30Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "A colleague provided me with [this benchmark](https://quick-bench.com/q/uYm7Wboe6G5KSEsDEXJTtH5oX7M), which compares the following equivalent C++ and Rust:\r\n\r\n```cc\r\nbool HasMoreThanTwoDashes(std::string_view sv) {\r\n    return sv.find_first_of('-', sv.find_first_of('-')+1) != std::string_view::npos;\r\n}\r\n```\r\n\r\n```rust\r\nfn has_more_than_two_dashes(s: &[u8]) -> bool {\r\n  sl.iter().filter(|&&c| c == b'-').count() > 2\r\n}\r\n```\r\n\r\nC++ performs 20x better in the microbenchmark. We haven't tried very hard to figure out why, but our suspicion is that Rust's implementation of `memchr` is worse than the one provided by the system that ran the benchmark. C++ also bails out early, and Rust does not, but that appears not to matter because the dashes are at the far end of the strings.\r\n\r\nWe're not actually sure what CPU quick-bench ran this with, but I can run it on my (icelake, I think) Xeon later. I think the difference in memchr implementations is worth investigating regardless.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/94573/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/94573/timeline", "performed_via_github_app": null, "state_reason": null}