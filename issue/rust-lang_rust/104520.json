{"url": "https://api.github.com/repos/rust-lang/rust/issues/104520", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/104520/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/104520/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/104520/events", "html_url": "https://github.com/rust-lang/rust/issues/104520", "id": 1452873319, "node_id": "I_kwDOAAsO6M5WmRZn", "number": 104520, "title": "rustc 1.65.0 crashes (SIGSEGV) when compiling with --release. Looks like a corner case.", "user": {"login": "rewik", "id": 8614277, "node_id": "MDQ6VXNlcjg2MTQyNzc=", "avatar_url": "https://avatars.githubusercontent.com/u/8614277?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rewik", "html_url": "https://github.com/rewik", "followers_url": "https://api.github.com/users/rewik/followers", "following_url": "https://api.github.com/users/rewik/following{/other_user}", "gists_url": "https://api.github.com/users/rewik/gists{/gist_id}", "starred_url": "https://api.github.com/users/rewik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rewik/subscriptions", "organizations_url": "https://api.github.com/users/rewik/orgs", "repos_url": "https://api.github.com/users/rewik/repos", "events_url": "https://api.github.com/users/rewik/events{/privacy}", "received_events_url": "https://api.github.com/users/rewik/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2022-11-17T07:47:46Z", "updated_at": "2022-12-07T17:30:25Z", "closed_at": "2022-12-07T17:30:24Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for finding an Internal Compiler Error! \ud83e\uddca  If possible, try to provide\r\na minimal verifiable example. You can read \"Rust Bug Minimization Patterns\" for\r\nhow to create smaller examples.\r\n\r\nhttp://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/\r\n\r\n-->\r\nError happens on 1.65.0, only in release mode.\r\nCode below crashes the compiler on cargo test --release\r\n\r\n### Code\r\n\r\n```Rust\r\nuse std::cmp;\r\n\r\nfn main() {\r\n    println!(\"Hello World\");\r\n}\r\n\r\n\r\n// bug is triggered when menu is a tuple with an even number of elements. Tuples with an\r\n// odd numer of elements seem to work fine.\r\n// Tested up to size 8\r\npub struct InternalValue {\r\n    menu: (u8, u8)\r\n}\r\nimpl InternalValue {\r\n    pub fn new(menu: u8) -> InternalValue {\r\n        InternalValue { menu: (menu, 2) }\r\n    }\r\n}\r\n\r\n\r\n#[derive(Debug, Copy, Clone, PartialEq)]\r\npub enum EmulatedSize {\r\n    Reduced,\r\n    Full,\r\n}\r\n// if MAX_PARAMS is 4, 8 or 16 the bug is not triggered\r\nconst MAX_PARAMS:u8 = 3;\r\n// if Reduced and Full are converted to the same value, the bug is no longer triggered\r\nimpl From<EmulatedSize> for u8 {\r\n    fn from(et: EmulatedSize) -> Self {\r\n        match et {\r\n            EmulatedSize::Reduced => MAX_PARAMS-1,\r\n            EmulatedSize::Full => MAX_PARAMS,\r\n        }\r\n    }\r\n}\r\n\r\n\r\npub struct EmulatedComponent {\r\n    values: [InternalValue; MAX_PARAMS as usize],\r\n}\r\nimpl EmulatedComponent {\r\n    pub fn init(id: u8) -> Self {\r\n        EmulatedComponent {\r\n            values: [\r\n                InternalValue::new(id),\r\n                InternalValue::new(id),\r\n                InternalValue::new(id),\r\n            ]\r\n        }\r\n    }\r\n}\r\n\r\n\r\npub struct EmulatedDevice {\r\n    variant: EmulatedSize,\r\n    components: Vec<EmulatedComponent>,\r\n}\r\nimpl EmulatedDevice {\r\n    pub fn init_with_components(i: u8, variant:Option<EmulatedSize>) -> Self {\r\n        let mut components = Vec::with_capacity(8);\r\n\r\n        for x in 0..i {\r\n            components.push(EmulatedComponent::init(x));\r\n        }\r\n\r\n        EmulatedDevice{\r\n            variant: variant.unwrap_or(EmulatedSize::Full),\r\n            components,\r\n        }\r\n    }\r\n\r\n    pub fn to_0xDC(&self, count: u8, first_id: u8) -> Vec<u8> {\r\n        let max_values_per_component: u8 = self.variant.into();\r\n        let first_component = (first_id / max_values_per_component) as usize;\r\n\r\n        let mut no_values_read = 0;\r\n        // commenting out any part of the code in this loop stops the bug from being triggered\r\n        for (curr_id, _) in self.components.iter().enumerate() {\r\n            if curr_id < first_component {\r\n                continue;\r\n            }\r\n            else if count - no_values_read <= 0 {\r\n                break;\r\n            }\r\n\r\n            let first_param_id = if curr_id == first_component { first_id % max_values_per_component } else { 0 };\r\n            let params_to_fetch = cmp::min(max_values_per_component - first_param_id, count - no_values_read);\r\n            // code reading the params removed, didn't affect triggering the bug\r\n\r\n            no_values_read += params_to_fetch;\r\n        }\r\n\r\n        vec![no_values_read, 0x01]\r\n    }\r\n}\r\n\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n\r\n    #[test]\r\n    fn test_cause_compiler_sigsegv_on_release() {\r\n        let device = EmulatedDevice::init_with_components(8, None);\r\n\r\n        let first_id: u8 = 0;\r\n        let count: u8 = 0xFF;\r\n\r\n        let expected: usize = 2;\r\n        let actual: usize = device.to_0xDC(count, first_id).len();\r\n\r\n        assert_eq!(expected, actual);\r\n    }\r\n}\r\n```\r\n\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.65.0 (897e37553 2022-11-02)\r\nbinary: rustc\r\ncommit-hash: 897e37553bba8b42751c67658967889d11ecd120\r\ncommit-date: 2022-11-02\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.65.0\r\nLLVM version: 15.0.0\r\n```\r\n\r\n1.64.0 debug: OK\r\n1.64.0 release: OK\r\n1.65.0 debug: OK\r\n1.65.0 release: SEGMENTATION FAULT\r\n1.66.0-beta.1 debug: OK\r\n1.66.0-beta.1 release: OK\r\n1.67.0-nightly debug: OK\r\n1.67.0-nightly release: OK\r\n\r\n### Error output\r\n\r\n```\r\n   Compiling rustc-1_65_0-sigsegv v0.1.0 (/home/REDACTED/Projects/rustc-1_65_0-sigsegv)\r\nwarning: field `menu` is never read\r\n  --> src/main.rs:11:5\r\n   |\r\n10 | pub struct InternalValue {\r\n   |            ------------- field in this struct\r\n11 |     menu: (u8, u8)\r\n   |     ^^^^\r\n   |\r\n   = note: `#[warn(dead_code)]` on by default\r\n\r\nwarning: field `values` is never read\r\n  --> src/main.rs:42:5\r\n   |\r\n41 | pub struct EmulatedComponent {\r\n   |            ----------------- field in this struct\r\n42 |     values: [InternalValue; MAX_PARAMS as usize],\r\n   |     ^^^^^^\r\n\r\nwarning: method `to_0xDC` should have a snake case name\r\n  --> src/main.rs:79:12\r\n   |\r\n79 |     pub fn to_0xDC(&self, count: u8, first_id: u8) -> Vec<u8> {\r\n   |            ^^^^^^^ help: convert the identifier to snake case: `to_0x_dc`\r\n   |\r\n   = note: `#[warn(non_snake_case)]` on by default\r\n\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_driver-a21dfa8672cc0cdd.so(+0x27d8ea3)[0x7fbadf1d8ea3]\r\n/usr/lib/libc.so.6(+0x38a00)[0x7fbadc6cea00]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(+0x2b55fba)[0x7fbad9d55fba]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(+0x2af197b)[0x7fbad9cf197b]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(_ZN4llvm15InstCombinePass3runERNS_8FunctionERNS_15AnalysisManagerIS1_JEEE+0x308e)[0x7fbad9cecdfe]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(+0x2ae9d5d)[0x7fbad9ce9d5d]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(_ZN4llvm11PassManagerINS_8FunctionENS_15AnalysisManagerIS1_JEEEJEE3runERS1_RS3_+0x52d)[0x7fbad965f24d]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(_ZN4llvm26CGSCCToFunctionPassAdaptor3runERNS_13LazyCallGraph3SCCERNS_15AnalysisManagerIS2_JRS1_EEES5_RNS_17CGSCCUpdateResultE+0x639)[0x7fbada3a35e9]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(+0x31a2f9d)[0x7fbada3a2f9d]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(_ZN4llvm11PassManagerINS_13LazyCallGraph3SCCENS_15AnalysisManagerIS2_JRS1_EEEJS4_RNS_17CGSCCUpdateResultEEE3runERS2_RS5_S4_S7_+0x698)[0x7fbada17c578]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(_ZN4llvm21DevirtSCCRepeatedPass3runERNS_13LazyCallGraph3SCCERNS_15AnalysisManagerIS2_JRS1_EEES5_RNS_17CGSCCUpdateResultE+0x3d8)[0x7fbada179b58]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(_ZN4llvm33ModuleToPostOrderCGSCCPassAdaptor3runERNS_6ModuleERNS_15AnalysisManagerIS1_JEEE+0xc4f)[0x7fbada29d38f]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(+0x309c72d)[0x7fbada29c72d]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(_ZN4llvm11PassManagerINS_6ModuleENS_15AnalysisManagerIS1_JEEEJEE3runERS1_RS3_+0x156)[0x7fbada4490e6]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(_ZN4llvm24ModuleInlinerWrapperPass3runERNS_6ModuleERNS_15AnalysisManagerIS1_JEEE+0x198)[0x7fbada448c18]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(+0x3248a6d)[0x7fbada448a6d]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-15-rust-1.65.0-stable.so(_ZN4llvm11PassManagerINS_6ModuleENS_15AnalysisManagerIS1_JEEEJEE3runERS1_RS3_+0x156)[0x7fbada4490e6]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_driver-a21dfa8672cc0cdd.so(+0x2439341)[0x7fbadee39341]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_driver-a21dfa8672cc0cdd.so(+0x24357ca)[0x7fbadee357ca]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_driver-a21dfa8672cc0cdd.so(+0x2434815)[0x7fbadee34815]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_driver-a21dfa8672cc0cdd.so(+0x225f72b)[0x7fbadec5f72b]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_driver-a21dfa8672cc0cdd.so(+0x225dc38)[0x7fbadec5dc38]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/librustc_driver-a21dfa8672cc0cdd.so(+0x2238738)[0x7fbadec38738]\r\n/home/REDACTED/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libstd-05737cf45bd30456.so(rust_metadata_std_71cb4861428b0c25+0xfe003)[0x7fbadc97b003]\r\n/usr/lib/libc.so.6(+0x868fd)[0x7fbadc71c8fd]\r\n/usr/lib/libc.so.6(+0x108a60)[0x7fbadc79ea60]\r\nwarning: `rustc-1_65_0-sigsegv` (bin \"rustc-1_65_0-sigsegv\" test) generated 3 warnings\r\nerror: could not compile `rustc-1_65_0-sigsegv`; 3 warnings emitted\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name rustc_1_65_0_sigsegv --edition=2021 src/main.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts,future-incompat --emit=dep-info,link -C opt-level=3 -C embed-bitcode=no --test -C metadata=832711d0ff56b38f -C extra-filename=-832711d0ff56b38f --out-dir /home/REDACTED/Documents/Projects/rustc-1_65_0-sigsegv/target/release/deps -L dependency=/home/REDACTED/Documents/Projects/rustc-1_65_0-sigsegv/target/release/deps` (signal: 11, SIGSEGV: invalid memory reference)\r\n```\r\nalso tested on Windows (different machine):\r\n```\r\n   Compiling rustc-1_65_0-sigsegv v0.1.0 (C:\\Users\\REDACTED\\Documents\\Projects\\rustc-1_65_0-sigsegv)\r\nwarning: field `menu` is never read\r\n  --> src\\main.rs:11:5\r\n   |\r\n10 | pub struct InternalValue {\r\n   |            ------------- field in this struct\r\n11 |     menu: (u8, u8)\r\n   |     ^^^^\r\n   |\r\n   = note: `#[warn(dead_code)]` on by default\r\n\r\nwarning: field `values` is never read\r\n  --> src\\main.rs:42:5\r\n   |\r\n41 | pub struct EmulatedComponent {\r\n   |            ----------------- field in this struct\r\n42 |     values: [InternalValue; MAX_PARAMS as usize],\r\n   |     ^^^^^^\r\n\r\nwarning: method `to_0xDC` should have a snake case name\r\n  --> src\\main.rs:79:12\r\n   |\r\n79 |     pub fn to_0xDC(&self, count: u8, first_id: u8) -> Vec<u8> {\r\n   |            ^^^^^^^ help: convert the identifier to snake case: `to_0x_dc`\r\n   |\r\n   = note: `#[warn(non_snake_case)]` on by default\r\n\r\nwarning: `rustc-1_65_0-sigsegv` (bin \"rustc-1_65_0-sigsegv\" test) generated 3 warnings\r\nerror: could not compile `rustc-1_65_0-sigsegv`; 3 warnings emitted\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name rustc_1_65_0_sigsegv --edition=2021 src\\main.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts,future-incompat --emit=dep-info,link -C opt-level=3 -C embed-bitcode=no --test -C metadata=2573ed0a4e436104 -C extra-filename=-2573ed0a4e436104 --out-dir C:\\Users\\REDACTED\\Documents\\Projects\\rustc-1_65_0-sigsegv\\target\\release\\deps -L dependency=C:\\Users\\REDACTED\\Documents\\Projects\\rustc-1_65_0-sigsegv\\target\\release\\deps` (exit code: 0xc0000005, STATUS_ACCESS_VIOLATION)\r\n```\r\n\r\nsetting RUST_BACKTRACE=1 does not change the output, looks like it crash originates somewhere in llvm code.\r\n</p>\r\n</details>\r\n\r\n", "closed_by": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/104520/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/104520/timeline", "performed_via_github_app": null, "state_reason": "completed"}