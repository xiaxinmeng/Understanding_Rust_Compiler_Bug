{"url": "https://api.github.com/repos/rust-lang/rust/issues/66658", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/66658/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/66658/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/66658/events", "html_url": "https://github.com/rust-lang/rust/issues/66658", "id": 527501410, "node_id": "MDU6SXNzdWU1Mjc1MDE0MTA=", "number": 66658, "title": "Infinitely recursive cylic `Deref` impls allow materializing uninitialized structs out of thin air in safe code.", "user": {"login": "slightlyoutofphase", "id": 47403582, "node_id": "MDQ6VXNlcjQ3NDAzNTgy", "avatar_url": "https://avatars.githubusercontent.com/u/47403582?v=4", "gravatar_id": "", "url": "https://api.github.com/users/slightlyoutofphase", "html_url": "https://github.com/slightlyoutofphase", "followers_url": "https://api.github.com/users/slightlyoutofphase/followers", "following_url": "https://api.github.com/users/slightlyoutofphase/following{/other_user}", "gists_url": "https://api.github.com/users/slightlyoutofphase/gists{/gist_id}", "starred_url": "https://api.github.com/users/slightlyoutofphase/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/slightlyoutofphase/subscriptions", "organizations_url": "https://api.github.com/users/slightlyoutofphase/orgs", "repos_url": "https://api.github.com/users/slightlyoutofphase/repos", "events_url": "https://api.github.com/users/slightlyoutofphase/events{/privacy}", "received_events_url": "https://api.github.com/users/slightlyoutofphase/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2019-11-23T03:13:12Z", "updated_at": "2019-11-23T18:57:36Z", "closed_at": "2019-11-23T07:32:20Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Running the following code on the current stable compiler:\r\n\r\n```rust\r\n#![allow(unconditional_recursion)]\r\n\r\nuse std::ops::Deref;\r\n\r\n#[derive(Copy, Clone, Debug)]\r\nstruct Outer<T: Deref<Target = Outer<T>>> {\r\n    inner: T,\r\n    i: i32,\r\n}\r\n\r\nimpl<T: Deref<Target = Outer<T>>> Deref for Outer<T> {\r\n    type Target = T;\r\n\r\n    fn deref(&self) -> &Self::Target {\r\n        &self.inner\r\n    }\r\n}\r\n\r\n#[derive(Copy, Clone, Debug)]\r\nstruct Inner {}\r\n\r\nimpl Deref for Inner {\r\n    type Target = Outer<Inner>;\r\n\r\n    fn deref(&self) -> &Self::Target {\r\n        //Look at which struct we're implementing Deref for,\r\n        //and then read the next line very carefully!\r\n        &self.inner\r\n    }\r\n}\r\n\r\nfn main() {\r\n    let i = Inner {};\r\n    let x = *i;\r\n    println!(\"{:?}\", x);\r\n    let y = **x;\r\n    println!(\"{:?}\", y);\r\n    let z = **y;\r\n    println!(\"{:?}\", z);\r\n}\r\n```\r\nconsistently produces always-slightly-different (in a way that only uninitialized memory usually is) output, such as the following:\r\n\r\n```\r\nOuter { inner: Inner, i: 0 }\r\nOuter { inner: Inner, i: -937669408 }\r\nOuter { inner: Inner, i: 32766 }\r\n```\r\n\r\n[Here's a runnable playground link](https://play.rust-lang.org/?version=stable&mode=release&edition=2018&gist=cea778acc1bd507865fb9c42318388eb) for the sake of convenience, also.\r\n\r\nBeyond everything else, it seems extremely surprising (or at least it was to me) that autoderef kicks in inside of an implementation *of* `Deref` at all, especially while in the process of *taking* a reference. \r\n\r\nI personally would not have expected that program to even typecheck (before I happened to notice it did / would.)", "closed_by": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/66658/reactions", "total_count": 3, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 2}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/66658/timeline", "performed_via_github_app": null, "state_reason": "completed"}