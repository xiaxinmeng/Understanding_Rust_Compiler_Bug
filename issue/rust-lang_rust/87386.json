{"url": "https://api.github.com/repos/rust-lang/rust/issues/87386", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/87386/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/87386/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/87386/events", "html_url": "https://github.com/rust-lang/rust/issues/87386", "id": 951004249, "node_id": "MDU6SXNzdWU5NTEwMDQyNDk=", "number": 87386, "title": "`rustc` panic involving generic contravariant constraint using associated type constrained by `where for` clause", "user": {"login": "tjjfvi", "id": 44031566, "node_id": "MDQ6VXNlcjQ0MDMxNTY2", "avatar_url": "https://avatars.githubusercontent.com/u/44031566?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tjjfvi", "html_url": "https://github.com/tjjfvi", "followers_url": "https://api.github.com/users/tjjfvi/followers", "following_url": "https://api.github.com/users/tjjfvi/following{/other_user}", "gists_url": "https://api.github.com/users/tjjfvi/gists{/gist_id}", "starred_url": "https://api.github.com/users/tjjfvi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tjjfvi/subscriptions", "organizations_url": "https://api.github.com/users/tjjfvi/orgs", "repos_url": "https://api.github.com/users/tjjfvi/repos", "events_url": "https://api.github.com/users/tjjfvi/events{/privacy}", "received_events_url": "https://api.github.com/users/tjjfvi/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2021-07-22T20:00:45Z", "updated_at": "2021-07-24T22:38:48Z", "closed_at": "2021-07-23T13:48:23Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for finding an Internal Compiler Error! \ud83e\uddca  If possible, try to provide\r\na minimal verifiable example. You can read \"Rust Bug Minimization Patterns\" for\r\nhow to create smaller examples.\r\n\r\nhttp://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/\r\n\r\n-->\r\n\r\n### Code\r\n\r\n```Rust\r\n/// Doesn't trigger a statically analyzable panic\r\nmacro_rules! todo {\r\n  () => {\r\n    unsafe { std::mem::transmute_copy::<_, _>(&()) }\r\n  };\r\n}\r\n\r\ntrait Foo<'a> {\r\n  type Value;\r\n}\r\n\r\nimpl<'a> Foo<'a> for u32 {\r\n  type Value = u32;\r\n}\r\n\r\ntrait Bar<F> {\r\n  fn bar(&self, cb: F);\r\n}\r\n\r\nimpl<O, F> Bar<F> for O\r\nwhere\r\n  O: for<'a> Foo<'a>,\r\n  F: FnMut(<O as Foo<'_>>::Value),\r\n{\r\n  fn bar(&self, mut cb: F) {\r\n    let _x: Box<dyn FnMut()> = Box::new(|| cb(todo!())); // <- this coercion seems to be the issue\r\n  }\r\n}\r\n\r\nfn main() {\r\n  0.bar(|_| {});\r\n}\r\n```\r\n\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.52.1 (9bc8c42bb 2021-05-09)\r\nbinary: rustc\r\ncommit-hash: 9bc8c42bb2f19e745a63f3445f1ac248fb015e53\r\ncommit-date: 2021-05-09\r\nhost: x86_64-apple-darwin\r\nrelease: 1.52.1\r\nLLVM version: 12.0.0\r\n```\r\n\r\nI've also checked https://play.rust-lang.org on stable, beta, and nightly, and the panic occurs in all three.\r\n\r\n### Error output\r\n\r\n```\r\nerror: internal compiler error: compiler/rustc_trait_selection/src/traits/codegen.rs:78:17: Encountered error `OutputTypeParameterMismatch(Binder(<[closure@src/main.rs:31:9: 31:15] as std::ops::FnMut<(<u32 as Foo<'_>>::Value,)>>), Binder(<[closure@src/main.rs:31:9: 31:15] as std::ops::FnMut<(u32,)>>), Sorts(ExpectedFound { expected: u32, found: <u32 as Foo<'_>>::Value }))` selecting `Binder(<[closure@src/main.rs:31:9: 31:15] as std::ops::FnMut<(u32,)>>)` during codegen\r\n\r\nthread 'rustc' panicked at 'Box<Any>', /rustc/9bc8c42bb2f19e745a63f3445f1ac248fb015e53/library/std/src/panic.rs:59:5\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary><strong>Backtrace</strong></summary>\r\n<p>\r\n\r\n```\r\nstack backtrace:\r\n   0:        0x108d8c434 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::h80b40bec9b25cdb7\r\n   1:        0x108df077e - core::fmt::write::h367e10cc391177e1\r\n   2:        0x108d7fce6 - std::io::Write::write_fmt::h69f760cf0ceceb64\r\n   3:        0x108d901e9 - std::panicking::default_hook::{{closure}}::h6b461dbc832ae479\r\n   4:        0x108d8fcd0 - std::panicking::default_hook::hf6b37b6d4ff1b717\r\n   5:        0x1015c9058 - rustc_driver::report_ice::hb51af1729852eb71\r\n   6:        0x108d909b8 - std::panicking::rust_panic_with_hook::hcc0074a2cdf70335\r\n   7:        0x1057cf711 - std::panicking::begin_panic::{{closure}}::h9de552659edff14c\r\n   8:        0x1057cf689 - std::sys_common::backtrace::__rust_end_short_backtrace::h8ce3fcb4b4655207\r\n   9:        0x105a86801 - std::panicking::begin_panic::h1d6a787d0b51d1c4\r\n  10:        0x1057bd9a0 - std::panic::panic_any::hdc1d724e6c0b6502\r\n  11:        0x1057c431c - rustc_errors::HandlerInner::bug::hfde960d9d360e049\r\n  12:        0x1057c2147 - rustc_errors::Handler::bug::h19b5c7521664e3b8\r\n  13:        0x10569ffe3 - rustc_middle::util::bug::opt_span_bug_fmt::{{closure}}::h3cecb89853250fee\r\n  14:        0x105698106 - rustc_middle::ty::context::tls::with_opt::{{closure}}::hca6d6b1f7cfbd401\r\n  15:        0x1056980ca - rustc_middle::ty::context::tls::with_opt::h9aebcb541b9fbcf7\r\n  16:        0x10569ff2b - rustc_middle::util::bug::opt_span_bug_fmt::h6e26b5d9065fffa9\r\n  17:        0x105a8004f - rustc_middle::util::bug::bug_fmt::h5ac5e85b53b74869\r\n  18:        0x10525106f - rustc_infer::infer::InferCtxtBuilder::enter::hebdbe0aeb8ffaf40\r\n  19:        0x1052c4ebb - rustc_trait_selection::traits::codegen::codegen_fulfill_obligation::h8f976f38344e8464\r\n  20:        0x10427ca30 - rustc_query_impl::<impl rustc_query_system::query::config::QueryAccessors<rustc_query_impl::plumbing::QueryCtxt> for rustc_query_impl::queries::codegen_fulfill_obligation>::compute::h1f3db9ab2e558f80\r\n  21:        0x104439373 - rustc_query_system::dep_graph::graph::DepGraph<K>::with_task_impl::h0add85b56b74391b\r\n  22:        0x1045292ea - rustc_data_structures::stack::ensure_sufficient_stack::ha08c62efa12fbd1a\r\n  23:        0x1041e472e - rustc_query_system::query::plumbing::force_query_with_job::h97a479547d4410ff\r\n  24:        0x10416aa11 - rustc_query_system::query::plumbing::get_query_impl::hc4b2dcfc978d85ef\r\n  25:        0x1043fd6ea - <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::codegen_fulfill_obligation::h2033ab3fd2d8a9c3\r\n  26:        0x103a08512 - rustc_ty_utils::instance::inner_resolve_instance::hd839a9681f6ba4a7\r\n  27:        0x103a07226 - rustc_ty_utils::instance::resolve_instance::h92522d07b5c97fcd\r\n  28:        0x1042801a8 - rustc_query_impl::<impl rustc_query_system::query::config::QueryAccessors<rustc_query_impl::plumbing::QueryCtxt> for rustc_query_impl::queries::resolve_instance>::compute::hcd7e4115c4979433\r\n  29:        0x104464b93 - rustc_query_system::dep_graph::graph::DepGraph<K>::with_task_impl::hbd7d959ceb4a909b\r\n  30:        0x104516745 - rustc_data_structures::stack::ensure_sufficient_stack::h22125a5a5db4f164\r\n  31:        0x1041da545 - rustc_query_system::query::plumbing::force_query_with_job::h69ec8529e626b820\r\n  32:        0x10414089e - rustc_query_system::query::plumbing::get_query_impl::h6b1a74ed805be5db\r\n  33:        0x1044033ca - <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::resolve_instance::h0af16f4e8f6ba3d9\r\n  34:        0x105602cb8 - rustc_middle::ty::instance::Instance::resolve_opt_const_arg::hc023f1ebe54a04ae\r\n  35:        0x1055f3641 - rustc_middle::ty::instance::Instance::resolve::hd49ebdf607ead8e8\r\n  36:        0x10483bc80 - <rustc_mir::monomorphize::collector::MirNeighborCollector as rustc_middle::mir::visit::Visitor>::visit_terminator::ha0aecf96e86441f8\r\n  37:        0x10483f7c6 - rustc_mir::monomorphize::collector::collect_neighbours::h727ee14214262696\r\n  38:        0x104838588 - rustc_mir::monomorphize::collector::collect_items_rec::hb6ffde2900b60ded\r\n  39:        0x1048387bc - rustc_mir::monomorphize::collector::collect_items_rec::hb6ffde2900b60ded\r\n  40:        0x1048387bc - rustc_mir::monomorphize::collector::collect_items_rec::hb6ffde2900b60ded\r\n  41:        0x10483719b - rustc_mir::monomorphize::collector::collect_crate_mono_items::h3b15e71f9d13d8d0\r\n  42:        0x104b3875c - rustc_mir::monomorphize::partitioning::collect_and_partition_mono_items::h7db8e53eddd83671\r\n  43:        0x10427f5f9 - rustc_query_impl::<impl rustc_query_system::query::config::QueryAccessors<rustc_query_impl::plumbing::QueryCtxt> for rustc_query_impl::queries::collect_and_partition_mono_items>::compute::h32c3bf44e75fe421\r\n  44:        0x104453f92 - rustc_query_system::dep_graph::graph::DepGraph<K>::with_task_impl::h7bfd926750ece29a\r\n  45:        0x104517f8e - rustc_data_structures::stack::ensure_sufficient_stack::h3052e125a301fdff\r\n  46:        0x1041f94b5 - rustc_query_system::query::plumbing::force_query_with_job::hf3a3a3c31e726a68\r\n  47:        0x10413165a - rustc_query_system::query::plumbing::get_query_impl::h5072e7d241cab575\r\n  48:        0x1044018f4 - <rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine>::collect_and_partition_mono_items::he585be757c9851df\r\n  49:        0x101831941 - <rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_ssa::traits::backend::CodegenBackend>::codegen_crate::hc852cedf8aca38c9\r\n  50:        0x1016fc05f - rustc_interface::passes::QueryContext::enter::hb333afeb5acf9798\r\n  51:        0x10170f040 - rustc_interface::queries::Queries::ongoing_codegen::h8c97cc4e774fffa9\r\n  52:        0x1015dec50 - rustc_interface::queries::<impl rustc_interface::interface::Compiler>::enter::h45421e55f990f5e8\r\n  53:        0x1015cb1e1 - rustc_span::with_source_map::h7bf5df439a8d2287\r\n  54:        0x1015dff23 - rustc_interface::interface::create_compiler_and_run::h6aaead704b55a38b\r\n  55:        0x1015d2926 - scoped_tls::ScopedKey<T>::set::h79ff838cdb92d8d9\r\n  56:        0x1015e0b79 - std::sys_common::backtrace::__rust_begin_short_backtrace::h8a9d21235d7a778a\r\n  57:        0x1015fddcd - core::ops::function::FnOnce::call_once{{vtable.shim}}::hd426e7b5e9740ba1\r\n  58:        0x108d9dfad - std::sys::unix::thread::Thread::new::thread_start::h4185c11ff3c2c216\r\n  59:     0x7fff2058c8fc - __pthread_start\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n", "closed_by": {"login": "jackh726", "id": 31162821, "node_id": "MDQ6VXNlcjMxMTYyODIx", "avatar_url": "https://avatars.githubusercontent.com/u/31162821?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jackh726", "html_url": "https://github.com/jackh726", "followers_url": "https://api.github.com/users/jackh726/followers", "following_url": "https://api.github.com/users/jackh726/following{/other_user}", "gists_url": "https://api.github.com/users/jackh726/gists{/gist_id}", "starred_url": "https://api.github.com/users/jackh726/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jackh726/subscriptions", "organizations_url": "https://api.github.com/users/jackh726/orgs", "repos_url": "https://api.github.com/users/jackh726/repos", "events_url": "https://api.github.com/users/jackh726/events{/privacy}", "received_events_url": "https://api.github.com/users/jackh726/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/87386/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/87386/timeline", "performed_via_github_app": null, "state_reason": "completed"}