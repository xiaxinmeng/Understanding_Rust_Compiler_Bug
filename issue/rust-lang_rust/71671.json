{"url": "https://api.github.com/repos/rust-lang/rust/issues/71671", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/71671/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/71671/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/71671/events", "html_url": "https://github.com/rust-lang/rust/issues/71671", "id": 609071598, "node_id": "MDU6SXNzdWU2MDkwNzE1OTg=", "number": 71671, "title": "Why implementation of iterator is not generic enough in async context?", "user": {"login": "Stargateur", "id": 7503742, "node_id": "MDQ6VXNlcjc1MDM3NDI=", "avatar_url": "https://avatars.githubusercontent.com/u/7503742?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Stargateur", "html_url": "https://github.com/Stargateur", "followers_url": "https://api.github.com/users/Stargateur/followers", "following_url": "https://api.github.com/users/Stargateur/following{/other_user}", "gists_url": "https://api.github.com/users/Stargateur/gists{/gist_id}", "starred_url": "https://api.github.com/users/Stargateur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Stargateur/subscriptions", "organizations_url": "https://api.github.com/users/Stargateur/orgs", "repos_url": "https://api.github.com/users/Stargateur/repos", "events_url": "https://api.github.com/users/Stargateur/events{/privacy}", "received_events_url": "https://api.github.com/users/Stargateur/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1049510487, "node_id": "MDU6TGFiZWwxMDQ5NTEwNDg3", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-async-await", "name": "A-async-await", "color": "f7e101", "default": false, "description": "Area: Async & Await"}, {"id": 1259721467, "node_id": "MDU6TGFiZWwxMjU5NzIxNDY3", "url": "https://api.github.com/repos/rust-lang/rust/labels/AsyncAwait-Triaged", "name": "AsyncAwait-Triaged", "color": "d4c5f9", "default": false, "description": "Async-await issues that have been triaged during a working group meeting."}, {"id": 1596121013, "node_id": "MDU6TGFiZWwxNTk2MTIxMDEz", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-confusing", "name": "D-confusing", "color": "c9f7a3", "default": false, "description": "Confusing diagnostic error that should be reworked"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2020-04-29T13:46:23Z", "updated_at": "2022-09-01T09:05:58Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "[Cross posting stackoverflow](https://stackoverflow.com/questions/61491070/why-implementation-of-iterator-is-not-generic-enough-in-async-context) because it's look like a compiler bug/limitation.\r\n\r\n---\r\n\r\nGiven the [following][1] snippet:\r\n\r\n```rust\r\nuse futures::stream::{self, StreamExt};\r\n\r\nasync fn from_bar(bar: &[Vec<&u8>]) {\r\n    let x = bar.iter().flat_map(|i| i.iter().map(|_| async { 42 }));\r\n    let foo: Vec<_> = stream::iter(x).collect().await;\r\n}\r\n\r\n#[tokio::main]\r\nasync fn main() {\r\n    for bar in vec![] {\r\n        tokio::spawn(async {\r\n            from_bar(bar).await;\r\n        });\r\n    }\r\n}\r\n```\r\n\r\nI get the following errors:\r\n\r\n```none\r\nerror[E0308]: mismatched types\r\n  --> src/main.rs:11:9\r\n   |\r\n11 |         tokio::spawn(async {\r\n   |         ^^^^^^^^^^^^ one type is more general than the other\r\n   |\r\n   = note: expected type `std::ops::FnOnce<(&&u8,)>`\r\n              found type `std::ops::FnOnce<(&&u8,)>`\r\n\r\nerror: implementation of `std::iter::Iterator` is not general enough\r\n    --> src/main.rs:11:9\r\n     |\r\n11   |           tokio::spawn(async {\r\n     |           ^^^^^^^^^^^^ implementation of `std::iter::Iterator` is not general enough\r\n     |\r\n     = note: `std::iter::Iterator` would have to be implemented for the type `std::slice::Iter<'0, &u8>`, for any lifetime `'0`...\r\n     = note: ...but `std::iter::Iterator` is actually implemented for the type `std::slice::Iter<'1, &u8>`, for some specific lifetime `'1`\r\n```\r\n\r\nI was expecting no error because the lifetimes seem to be correct to me. Note that removing `main()` or removing the code inside `from_bar()` *both* eliminate the errors. Not only that, the error messages are also very strange. They may be related to [a regression in the compiler][2], though more than that they seem to be in the wrong place ([maybe related][3]).\r\n\r\nVersion `rustc 1.43.0 (4fb7144ed 2020-04-20)`:\r\n\r\n```toml\r\n[dependencies]\r\nfutures = '0.3.1'\r\n\r\n[dependencies.tokio]\r\nversion = '0.2'\r\nfeatures = ['full']\r\n```\r\n\r\n---\r\n\r\nMaybe related https://github.com/rust-lang/rust/issues/64650\r\n\r\n  [1]: https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=bece604aa99c31dc710f5f3129296f1f\r\n  [2]: https://stackoverflow.com/questions/54341465/rust-expected-type-error-prints-mismatched-types-that-are-exactly-the-same/54344401#54344401\r\n  [3]: https://github.com/rust-lang/rust/issues/54326", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/71671/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/71671/timeline", "performed_via_github_app": null, "state_reason": null}