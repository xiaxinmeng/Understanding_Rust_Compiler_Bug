{"url": "https://api.github.com/repos/rust-lang/rust/issues/50506", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/50506/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/50506/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/50506/events", "html_url": "https://github.com/rust-lang/rust/issues/50506", "id": 320835787, "node_id": "MDU6SXNzdWUzMjA4MzU3ODc=", "number": 50506, "title": "#[test] functions are silently excluded when they're defined inside of another function", "user": {"login": "mjbshaw", "id": 1204698, "node_id": "MDQ6VXNlcjEyMDQ2OTg=", "avatar_url": "https://avatars.githubusercontent.com/u/1204698?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mjbshaw", "html_url": "https://github.com/mjbshaw", "followers_url": "https://api.github.com/users/mjbshaw/followers", "following_url": "https://api.github.com/users/mjbshaw/following{/other_user}", "gists_url": "https://api.github.com/users/mjbshaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/mjbshaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mjbshaw/subscriptions", "organizations_url": "https://api.github.com/users/mjbshaw/orgs", "repos_url": "https://api.github.com/users/mjbshaw/repos", "events_url": "https://api.github.com/users/mjbshaw/events{/privacy}", "received_events_url": "https://api.github.com/users/mjbshaw/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-05-07T14:53:59Z", "updated_at": "2018-05-07T20:29:59Z", "closed_at": "2018-05-07T20:29:59Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Consider the following program:\r\n\r\n```rust\r\npub fn main() {\r\n    #[cfg(test)]\r\n    #[test]\r\n    fn it_works() {\r\n        panic!(\"Proof this test doesn't run\");\r\n    }\r\n}\r\n```\r\n\r\nI expect `cargo test` to run the unit test `it_works`. But this doesn't happen. `cargo test` doesn't run any tests:\r\n\r\n```\r\nrunning 0 tests\r\n\r\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out\r\n```\r\n\r\nAdditionally, `rustc` emits no warnings or errors when compiling this. The test is just silently excluded from the executable (verified by running `otool` and grepping for `it_works`).\r\n\r\n`rustc` shouldn't exclude this test from the executable, and `cargo test` should run this test.\r\n\r\nYou might wonder why anyone would add a unit test within a function. My use case is a unit test injected by an attribute macro on a fn within an impl block (the attribute does many things to the function and adds the unit test to verify some parts that can't be validated at compile time).\r\n\r\nTested with `rustc 1.27.0-nightly (91db9dcf3 2018-05-04)` and `cargo 1.27.0-nightly (af3f1cd29 2018-05-03)`.", "closed_by": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/50506/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/50506/timeline", "performed_via_github_app": null, "state_reason": "completed"}