{"url": "https://api.github.com/repos/rust-lang/rust/issues/91442", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/91442/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/91442/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/91442/events", "html_url": "https://github.com/rust-lang/rust/issues/91442", "id": 1069065789, "node_id": "I_kwDOAAsO6M4_uKY9", "number": 91442, "title": "MIPS delay slot codegen issue", "user": {"login": "sajattack", "id": 1562711, "node_id": "MDQ6VXNlcjE1NjI3MTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1562711?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sajattack", "html_url": "https://github.com/sajattack", "followers_url": "https://api.github.com/users/sajattack/followers", "following_url": "https://api.github.com/users/sajattack/following{/other_user}", "gists_url": "https://api.github.com/users/sajattack/gists{/gist_id}", "starred_url": "https://api.github.com/users/sajattack/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sajattack/subscriptions", "organizations_url": "https://api.github.com/users/sajattack/orgs", "repos_url": "https://api.github.com/users/sajattack/repos", "events_url": "https://api.github.com/users/sajattack/events{/privacy}", "received_events_url": "https://api.github.com/users/sajattack/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}, {"id": 106552066, "node_id": "MDU6TGFiZWwxMDY1NTIwNjY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-MIPS", "name": "O-MIPS", "color": "6e6ec0", "default": false, "description": "Target: MIPS processors"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2021-12-02T02:39:05Z", "updated_at": "2021-12-03T04:23:36Z", "closed_at": "2021-12-02T16:44:14Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried this code:\r\n\r\n```rust\r\n#![no_std]\r\n#![no_main]\r\n\r\n#![feature(bench_black_box)]\r\n\r\npsp::module!(\"crash-test\",1,0);\r\n\r\n\r\nfn psp_main() {\r\n    psp::enable_home_button();\r\n    let start_x = core::hint::black_box(942.0);\r\n    let end_x = core::hint::black_box(942.0);\r\n    let start_y = core::hint::black_box(1121.0);\r\n    let end_y = core::hint::black_box(1127.0);\r\n    let dx = end_x - start_x;\r\n    let dy = end_y - start_y;\r\n    let tdx = if dx == 0.0 {\r\n        core::f32::MAX\r\n    } else {\r\n        1.0 / dx\r\n    };\r\n    let tdy = 1.0 / dy;\r\n    psp::dprintln!(\"{}, {}\", tdx, tdy);\r\n}\r\n```\r\n\r\nand compiled with the official tier 3 target, mipsel-sony-psp, the psp crate, and the cargo-psp crate. This should compile for any other mips target by renaming `psp_main` to `main`, removing `#[no_main]`, removing `psp::enable_home_button`, removing `psp::module!` and replacing `psp::dprintln!`with `println!`. I suspect the problem would be the same on other MIPS targets, PSP is MIPS2 ISA.\r\n\r\nI expected to see this happen: The if statement should prevent the case of divide by zero\r\n\r\nInstead, this happened: The division instruction is scheduled in the delay slot of the jump (2b0), rendering the if statement useless. This leads to a floating point exception for dividing by zero.\r\n\r\n```\r\n000001f0 <_ZN10crash_test8psp_main17hbe49ea7b35c4c2efE>:\r\n     1f0:\t27bdffa8 \taddiu\tsp,sp,-88\r\n     1f4:\te7b50054 \tswc1\t$f21,84(sp)\r\n     1f8:\te7b40050 \tswc1\t$f20,80(sp)\r\n     1fc:\tafbf004c \tsw\tra,76(sp)\r\n     200:\t0c006627 \tjal\t1989c <_ZN3psp18enable_home_button17h2bfc525e5943e058E>\r\n     204:\t00000000 \tnop\r\n     208:\t3c01446b \tlui\tat,0x446b\r\n     20c:\t27a20030 \taddiu\tv0,sp,48\r\n     210:\t3c034091 \tlui\tv1,0x4091\r\n     214:\t34218000 \tori\tat,at,0x8000\r\n     218:\t34648400 \tori\ta0,v1,0x8400\r\n     21c:\t34639c00 \tori\tv1,v1,0x9c00\r\n     220:\tafa10030 \tsw\tat,48(sp)\r\n     224:\tc7b40030 \tlwc1\t$f20,48(sp)\r\n     228:\tafa10030 \tsw\tat,48(sp)\r\n     22c:\tafa40034 \tsw\ta0,52(sp)\r\n     230:\tc7b50030 \tlwc1\t$f21,48(sp)\r\n     234:\tafa00030 \tsw\tzero,48(sp)\r\n     238:\t8fa70034 \tlw\ta3,52(sp)\r\n     23c:\t8fa60030 \tlw\ta2,48(sp)\r\n     240:\tafa30034 \tsw\tv1,52(sp)\r\n     244:\tafa00030 \tsw\tzero,48(sp)\r\n     248:\t8fa40030 \tlw\ta0,48(sp)\r\n     24c:\t0c01afad \tjal\t6beb4 <__subdf3>\r\n     250:\t8fa50034 \tlw\ta1,52(sp)\r\n     254:\t00403025 \tmove\ta2,v0\r\n     258:\t00603825 \tmove\ta3,v1\r\n     25c:\t24040000 \tli\ta0,0\r\n     260:\t0c01ae9d \tjal\t6ba74 <__divdf3>\r\n     264:\t3c053ff0 \tlui\ta1,0x3ff0\r\n     268:\t4614a801 \tsub.s\t$f0,$f21,$f20\r\n     26c:\t44800800 \tmtc1\tzero,$f1\r\n     270:\t3c050006 \tlui\ta1,0x6\r\n     274:\t3c010009 \tlui\tat,0x9\r\n     278:\t3c040006 \tlui\ta0,0x6\r\n     27c:\t27a70014 \taddiu\ta3,sp,20\r\n     280:\t27a90018 \taddiu\tt1,sp,24\r\n     284:\t27aa0020 \taddiu\tt2,sp,32\r\n     288:\t240b0002 \tli\tt3,2\r\n     28c:\t2486592c \taddiu\ta2,a0,22828\r\n     290:\t24a556e8 \taddiu\ta1,a1,22248\r\n     294:\t24285c54 \taddiu\tt0,at,23636\r\n     298:\t46010032 \tc.eq.s\t$f0,$f1\r\n     29c:\t45010005 \tbc1t\t2b4 <_ZN10crash_test8psp_main17hbe49ea7b35c4c2efE+0xc4>\r\n     2a0:\t27a40030 \taddiu\ta0,sp,48\r\n     2a4:\t3c010009 \tlui\tat,0x9\r\n     2a8:\tc4215b00 \tlwc1\t$f1,23296(at)\r\n     2ac:\t080000af \tj\t2bc <_ZN10crash_test8psp_main17hbe49ea7b35c4c2efE+0xcc>\r\n     2b0:\t46000803 \tdiv.s\t$f0,$f1,$f0\r\n     2b4:\t3c010009 \tlui\tat,0x9\r\n     2b8:\tc4205bbc \tlwc1\t$f0,23484(at)\r\n     2bc:\tafab0044 \tsw\tt3,68(sp)\r\n     2c0:\tafaa0040 \tsw\tt2,64(sp)\r\n     2c4:\tafab0034 \tsw\tt3,52(sp)\r\n     2c8:\tafa80030 \tsw\tt0,48(sp)\r\n     2cc:\tafa6002c \tsw\ta2,44(sp)\r\n     2d0:\tafa90028 \tsw\tt1,40(sp)\r\n     2d4:\tafa50024 \tsw\ta1,36(sp)\r\n     2d8:\te7a00014 \tswc1\t$f0,20(sp)\r\n     2dc:\tafa3001c \tsw\tv1,28(sp)\r\n     2e0:\tafa20018 \tsw\tv0,24(sp)\r\n     2e4:\tafa70020 \tsw\ta3,32(sp)\r\n     2e8:\t0c0062ac \tjal\t18ab0 <_ZN3psp5debug10print_args17ha66f43044fc9cba7E>\r\n     2ec:\tafa00038 \tsw\tzero,56(sp)\r\n     2f0:\t3c010009 \tlui\tat,0x9\r\n     2f4:\t3c020009 \tlui\tv0,0x9\r\n     2f8:\t27a40030 \taddiu\ta0,sp,48\r\n     2fc:\t24030001 \tli\tv1,1\r\n     300:\t24215c50 \taddiu\tat,at,23632\r\n     304:\t24425c68 \taddiu\tv0,v0,23656\r\n     308:\tafa10040 \tsw\tat,64(sp)\r\n     30c:\tafa30034 \tsw\tv1,52(sp)\r\n     310:\tafa20030 \tsw\tv0,48(sp)\r\n     314:\tafa00044 \tsw\tzero,68(sp)\r\n     318:\t0c0062ac \tjal\t18ab0 <_ZN3psp5debug10print_args17ha66f43044fc9cba7E>\r\n     31c:\tafa00038 \tsw\tzero,56(sp)\r\n     320:\t8fbf004c \tlw\tra,76(sp)\r\n     324:\tc7b40050 \tlwc1\t$f20,80(sp)\r\n     328:\tc7b50054 \tlwc1\t$f21,84(sp)\r\n     32c:\t03e00008 \tjr\tra\r\n     330:\t27bd0058 \taddiu\tsp,sp,88\r\n     334:\t04170001 \t0x4170001\r\n     338:\t04170001 \t0x4170001\r\n     33c:\t04170001 \t0x4170001\r\n```\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.58.0-nightly (936238a92 2021-11-11)\r\nbinary: rustc\r\ncommit-hash: 936238a92b2f9d6e7afe7dda69b4afd903f96399\r\ncommit-date: 2021-11-11\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.58.0-nightly\r\nLLVM version: 13.0.0\r\n```\r\nI used gdb for backtrace since I can't run RUST_BACKTRACE=1 on PSP.\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary>Backtrace</summary>\r\n<p>\r\n\r\n```\r\n(gdb) continue\r\nContinuing.\r\n\r\nProgram received signal SIGFPE, Arithmetic exception.\r\n[Switching to Thread 71772003]\r\n0x0881050c in psp_main () at src/main.rs:17\r\n17\tsrc/main.rs: No such file or directory.\r\n(gdb) bt\r\n#0  0x0881050c in psp_main () at src/main.rs:17\r\n#1  {closure#0} () at /home/paul/.cargo/registry/src/github.com-1ecc6299db9ec823/psp-0.1.6/src/lib.rs:168\r\n#2  do_call<crash_test::__psp_module::module_start::main_thread::{closure#0}, ()> (data=<optimized out>)\r\n    at /home/paul/.cargo/registry/src/github.com-1ecc6299db9ec823/psp-0.1.6/src/panic.rs:190\r\n#3  psp::panic::catch_unwind::hd7cc0a6d600ad95e (f=...) at /home/paul/.cargo/registry/src/github.com-1ecc6299db9ec823/psp-0.1.6/src/panic.rs:170\r\n#4  0x0881061c in crash_test::__psp_module::module_start::main_thread::ha12ba2af7e504b63 (_argc=<optimized out>, _argv=<optimized out>)\r\n    at /home/paul/.cargo/registry/src/github.com-1ecc6299db9ec823/psp-0.1.6/src/lib.rs:167\r\n#5  0x0bebfec0 in ?? ()\r\n```\r\n\r\n```\r\nException - FPU Exception (UZ)\r\nLoad/Start host0:/crash-test.prx UID: 0x0449B23F Name: crash-test\r\nThread ID - 0x0447734B\r\nhost0:/> Th Name   - main_thread\r\nModule ID - 0x0449B23F\r\nMod Name  - crash-test\r\nEPC       - 0x0881050C\r\nCause     - 0x9000003C\r\nBadVAddr  - 0xBE261F31\r\nStatus    - 0x20088613\r\nAddress   - 0x0000050C\r\nzr:0x00000000 at:0x088A0000 v0:0x55555555 v1:0x3FC55555\r\na0:0x0BEBFE78 a1:0x088756E8 a2:0x0887592C a3:0x0BEBFE60\r\nt0:0x088A5C54 t1:0x0BEBFE5C t2:0x0BEBFE68 t3:0x00000002\r\nt4:0x00000000 t5:0x55400000 t6:0x55555555 t7:0x00155555\r\ns0:0xDEADBEEF s1:0xDEADBEEF s2:0xDEADBEEF s3:0xDEADBEEF\r\ns4:0xDEADBEEF s5:0xDEADBEEF s6:0xDEADBEEF s7:0xDEADBEEF\r\nt8:0x00000000 t9:0x00000000 k0:0x0BEBFF00 k1:0x00000000\r\ngp:0x00155555 sp:0x0BEBFE48 fp:0x0BEBFEC0 ra:0x088104C8\r\n0x0881050C: 0x0A204147 'GA .' - j          0x0881051C\r\n```\r\n\r\n</p>\r\n</details>\r\n", "closed_by": {"login": "sajattack", "id": 1562711, "node_id": "MDQ6VXNlcjE1NjI3MTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1562711?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sajattack", "html_url": "https://github.com/sajattack", "followers_url": "https://api.github.com/users/sajattack/followers", "following_url": "https://api.github.com/users/sajattack/following{/other_user}", "gists_url": "https://api.github.com/users/sajattack/gists{/gist_id}", "starred_url": "https://api.github.com/users/sajattack/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sajattack/subscriptions", "organizations_url": "https://api.github.com/users/sajattack/orgs", "repos_url": "https://api.github.com/users/sajattack/repos", "events_url": "https://api.github.com/users/sajattack/events{/privacy}", "received_events_url": "https://api.github.com/users/sajattack/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/91442/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/91442/timeline", "performed_via_github_app": null, "state_reason": "completed"}