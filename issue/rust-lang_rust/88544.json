{"url": "https://api.github.com/repos/rust-lang/rust/issues/88544", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/88544/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/88544/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/88544/events", "html_url": "https://github.com/rust-lang/rust/issues/88544", "id": 984304657, "node_id": "MDU6SXNzdWU5ODQzMDQ2NTc=", "number": 88544, "title": "[crate locator] Specified --extern crate is not appearing in dep-info (with -Zbinary-dep-depinfo)", "user": {"login": "fangism", "id": 607886, "node_id": "MDQ6VXNlcjYwNzg4Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/607886?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fangism", "html_url": "https://github.com/fangism", "followers_url": "https://api.github.com/users/fangism/followers", "following_url": "https://api.github.com/users/fangism/following{/other_user}", "gists_url": "https://api.github.com/users/fangism/gists{/gist_id}", "starred_url": "https://api.github.com/users/fangism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fangism/subscriptions", "organizations_url": "https://api.github.com/users/fangism/orgs", "repos_url": "https://api.github.com/users/fangism/repos", "events_url": "https://api.github.com/users/fangism/events{/privacy}", "received_events_url": "https://api.github.com/users/fangism/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2021-08-31T20:47:27Z", "updated_at": "2021-08-31T20:47:27Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "This is an issue with the `rustc` compiler.  I'll describe what is happening, while we work on providing a minimal test case.  Summary: the dep-info emitted does not reflect `--extern CRATE=LOCATION`.\r\n\r\nWe have code that uses async-trait, that is compiled like so:\r\n\r\n```\r\nrustc \\\r\n--crate-name my_crate \\\r\n--crate-type rlib \\\r\n--emit=dep-info=host_x64-novariant/.../libmy_crate.rlib.d,link \\\r\n-Zbinary-dep-depinfo \\\r\n-Zdep-info-omit-d-target \\\r\n-Ldependency=host_x64 \\\r\n--extern async_trait=host_x64-novariant/libasync_trait-c6b6d222802967e6.so \\\r\n...\r\n```\r\n\r\nThere happens to be two identical copies of libasync_trait-c6b6d222802967e6.so:\r\n\r\n```\r\nhost_x64/libasync_trait-c6b6d222802967e6.so\r\nhost_x64-novariant/libasync_trait-c6b6d222802967e6.so\r\n```\r\n\r\nNo need to concern with what '-novariant' means, think of it as just two directories with different names.\r\n\r\nI **expect** the `libmy_crate.rlib.d` dep-info file to contain `host_x64-novariant/libasync_trait-c6b6d222802967e6.so`, however, it only contains `host_x64/libasync_trait-c6b6d222802967e6.so`.  I expect this because of the comments describing https://github.com/rust-lang/rust/blob/master/compiler/rustc_metadata/src/locator.rs.  Contrary to the description, it chose to use a library it found in a search path, rather than the one given by `--extern`.\r\n\r\nEvidence from `RUSTC_LOG=debug`:\r\nIt looks like `locator` finds multiple candidates for libasync_trait, even when we've specified `--extern`.  The one that is shown in the dep-info file is _not_ from `--extern`.\r\n\r\n```\r\nINFO rustc_metadata::creader resolving dep crate async_trait hash: `e023c8c27a1aa816` extra filename: `-c6b6d222802967e6`\r\nINFO rustc_metadata::creader resolving crate `async_trait`\r\nINFO rustc_metadata::creader falling back to a load\r\nINFO rustc_metadata::locator lib candidate: host_x64-novariant/libasync_trait-c6b6d222802967e6.so\r\nINFO rustc_metadata::locator lib candidate: host_x64/libasync_trait-c6b6d222802967e6.so\r\nINFO rustc_metadata::locator dylib reading metadata from: /usr/local/home/fangism/project/out/default/host_x64-novariant/libasync_trait-c6b6d222802967e6.so\r\nINFO rustc_metadata::locator Rejecting via proc macro: expected false got true\r\nINFO rustc_metadata::locator metadata mismatch\r\nINFO rustc_metadata::locator dylib reading metadata from: /usr/local/home/fangism/project/out/default/host_x64/libasync_trait-c6b6d222802967e6.so\r\nINFO rustc_metadata::locator Rejecting via proc macro: expected false got true\r\nINFO rustc_metadata::locator metadata mismatch\r\nINFO rustc_metadata::locator lib candidate: host_x64-novariant/libasync_trait-c6b6d222802967e6.so\r\nINFO rustc_metadata::locator lib candidate: host_x64/libasync_trait-c6b6d222802967e6.so\r\nINFO rustc_metadata::locator lib candidate: host_x64-novariant/libasync_trait-c6b6d222802967e6.so\r\nINFO rustc_metadata::locator lib candidate: host_x64/libasync_trait-c6b6d222802967e6.so\r\nINFO rustc_metadata::locator dylib reading metadata from: /usr/local/home/fangism/project/out/default/host_x64-novariant/libasync_trait-c6b6d222802967e6.so\r\nINFO rustc_metadata::locator dylib reading metadata from: /usr/local/home/fangism/project/out/default/host_x64/libasync_trait-c6b6d222802967e6.so\r\nINFO rustc_metadata::creader register crate `async_trait` (cnum = 171. private_dep = false)\r\n```\r\n\r\n_Why this matters?_  We consume the .d dep-info file (with `-Zbinary-dep-depinfo`) as a source-of-truth for what files/crates/dylibs are needed for remote building, and upload them.  If this is inaccurate, all bets are off concerning the success of the remote build.  (In the above scenario, failing to upload `host_x64-novariant/libasync_trait-c6b6d222802967e6.so` results in the async trait being un-recognized in the remote build, even though `host_x64/libasync_trait-c6b6d222802967e6.so` is uploaded (identical copy, different path).)\r\n\r\nI suspect this can be reproduced independent of async-trait, that this is really a crate location matter.\r\n\r\n### Meta\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.56.0-nightly (fc24bcead 2021-07-26)\r\nbinary: rustc\r\ncommit-hash: fc24bcead1d401ae061538d011e4a319c4195b56\r\ncommit-date: 2021-07-26\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.56.0-nightly\r\nLLVM version: 12.0.1\r\n```\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/88544/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/88544/timeline", "performed_via_github_app": null, "state_reason": null}