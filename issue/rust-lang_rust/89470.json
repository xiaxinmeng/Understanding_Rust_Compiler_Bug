{"url": "https://api.github.com/repos/rust-lang/rust/issues/89470", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/89470/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/89470/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/89470/events", "html_url": "https://github.com/rust-lang/rust/issues/89470", "id": 1014124408, "node_id": "I_kwDOAAsO6M48ck94", "number": 89470, "title": "Performance pitfall and regression around closures in Rust 2021", "user": {"login": "CryZe", "id": 1451630, "node_id": "MDQ6VXNlcjE0NTE2MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1451630?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CryZe", "html_url": "https://github.com/CryZe", "followers_url": "https://api.github.com/users/CryZe/followers", "following_url": "https://api.github.com/users/CryZe/following{/other_user}", "gists_url": "https://api.github.com/users/CryZe/gists{/gist_id}", "starred_url": "https://api.github.com/users/CryZe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CryZe/subscriptions", "organizations_url": "https://api.github.com/users/CryZe/orgs", "repos_url": "https://api.github.com/users/CryZe/repos", "events_url": "https://api.github.com/users/CryZe/events{/privacy}", "received_events_url": "https://api.github.com/users/CryZe/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 122406831, "node_id": "MDU6TGFiZWwxMjI0MDY4MzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-closures", "name": "A-closures", "color": "f7e101", "default": false, "description": "Area: closures (`|args| { .. }`)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2947369052, "node_id": "MDU6TGFiZWwyOTQ3MzY5MDUy", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-edition-2021", "name": "A-edition-2021", "color": "f7e101", "default": false, "description": "Area: The 2021 edition"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2021-10-02T17:58:16Z", "updated_at": "2021-10-05T08:11:18Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "In Rust 2021 the borrow checker got extended to see through borrow paths when writing closures. I've been wondering how this is implemented, but it seems like it's basically just syntax sugar for individual manual borrows that get moved in. This however leads to worse codegen than when a move closure would've been possible. So you might end up with code that performs worse by accident:\r\n\r\n[Godbolt](https://rust.godbolt.org/z/WzoGG1b6n)\r\n\r\n```rust\r\npub struct Foo {\r\n    x: f32,\r\n    y: f32,\r\n    z: f32,\r\n}\r\n\r\npub fn with_move(bar: &mut Foo) -> impl Fn() -> f32 + '_ {\r\n    move || bar.x + bar.y + bar.z\r\n}\r\n\r\npub fn without_move(bar: &mut Foo) -> impl Fn() -> f32 + '_ {\r\n    || bar.x + bar.y + bar.z\r\n}\r\n```\r\n\r\n```asm\r\nexample::with_move:\r\n        mov     rax, rdi\r\n        ret\r\n\r\nexample::without_move:\r\n        mov     rax, rdi\r\n        lea     rcx, [rsi + 4]\r\n        mov     qword ptr [rdi], rsi\r\n        add     rsi, 8\r\n        mov     qword ptr [rdi + 8], rcx\r\n        mov     qword ptr [rdi + 16], rsi\r\n        ret\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/89470/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/89470/timeline", "performed_via_github_app": null, "state_reason": null}