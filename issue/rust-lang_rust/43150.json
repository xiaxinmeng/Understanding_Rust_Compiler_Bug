{"url": "https://api.github.com/repos/rust-lang/rust/issues/43150", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/43150/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/43150/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/43150/events", "html_url": "https://github.com/rust-lang/rust/issues/43150", "id": 241787324, "node_id": "MDU6SXNzdWUyNDE3ODczMjQ=", "number": 43150, "title": "Suboptimal invoke-related codegen for default trait impls", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2017-07-10T17:26:23Z", "updated_at": "2019-01-08T11:21:59Z", "closed_at": "2017-07-11T10:34:58Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "It looks like default methods in traits will always use `invoke` whereas defined methods will hit the optimization to not use `invoke`:\r\n\r\n```rust\r\n// bar.rs\r\n#![crate_type = \"rlib\"]\r\npub fn bar() {}\r\n```\r\n\r\n\r\n```rust\r\n// foo.rs\r\n#![crate_type = \"rlib\"]\r\nextern crate bar;\r\n\r\npub trait A: Sized {\r\n    fn foo1(self) {\r\n        bar::bar();\r\n    }\r\n    fn foo2(self);\r\n}\r\n\r\nimpl A for i32 {\r\n    fn foo2(self) {\r\n        bar::bar();\r\n    }\r\n}\r\n\r\nfn main() {\r\n    0i32.foo1();\r\n    0i32.foo2();\r\n}\r\n```\r\n\r\n```\r\n$ rustc bar.rs\r\n$ rustc foo.rs -L . --emit llvm-ir\r\n$ cat foo.ll\r\n```\r\n\r\n\r\nwill yield [this IR](https://gist.github.com/alexcrichton/648fb55a7f1a501a5b8b88fb7b8c3d7c#file-foo-ll), notably:\r\n\r\n```llvm\r\n; foo::A::foo1\r\n; Function Attrs: uwtable\r\ndefine internal void @_ZN3foo1A4foo117hcfa03453b669bd94E(i32) unnamed_addr #0 personality i32 (i32, i32, i64, %\"unwind::libunwind::_Unwind_Exception\"*, %\"unwind::libunwind::_Unwind_Context\"*)* @rust_eh_personality {\r\nstart:\r\n  %personalityslot = alloca { i8*, i32 }\r\n; invoke bar::bar\r\n  invoke void @_ZN3bar3bar17h21868f3a4452d05bE()\r\n          to label %bb3 unwind label %cleanup\r\n\r\n; ...\r\n}\r\n\r\n\r\n; <i32 as foo::A>::foo2\r\n; Function Attrs: uwtable\r\ndefine void @\"_ZN30_$LT$i32$u20$as$u20$foo..A$GT$4foo217h68eec0bc305998eeE\"(i32) unnamed_addr #0 {\r\nstart:\r\n; call bar::bar\r\n  call void @_ZN3bar3bar17h21868f3a4452d05bE()\r\n  br label %bb1\r\n\r\nbb1:                                              ; preds = %start\r\n  ret void\r\n}\r\n```\r\n\r\nNote that `<i32 as A>::foo1` uses an `invoke` instruction whereas `<i32 as A>::foo2` does not.\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n", "closed_by": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/43150/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/43150/timeline", "performed_via_github_app": null, "state_reason": "completed"}