{"url": "https://api.github.com/repos/rust-lang/rust/issues/56603", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/56603/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/56603/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/56603/events", "html_url": "https://github.com/rust-lang/rust/issues/56603", "id": 388728122, "node_id": "MDU6SXNzdWUzODg3MjgxMjI=", "number": 56603, "title": "C FFI crate(s) fails to build with system allocator", "user": {"login": "simonrw", "id": 59756, "node_id": "MDQ6VXNlcjU5NzU2", "avatar_url": "https://avatars.githubusercontent.com/u/59756?v=4", "gravatar_id": "", "url": "https://api.github.com/users/simonrw", "html_url": "https://github.com/simonrw", "followers_url": "https://api.github.com/users/simonrw/followers", "following_url": "https://api.github.com/users/simonrw/following{/other_user}", "gists_url": "https://api.github.com/users/simonrw/gists{/gist_id}", "starred_url": "https://api.github.com/users/simonrw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/simonrw/subscriptions", "organizations_url": "https://api.github.com/users/simonrw/orgs", "repos_url": "https://api.github.com/users/simonrw/repos", "events_url": "https://api.github.com/users/simonrw/events{/privacy}", "received_events_url": "https://api.github.com/users/simonrw/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 45472092, "node_id": "MDU6TGFiZWw0NTQ3MjA5Mg==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-ffi", "name": "A-ffi", "color": "f7e101", "default": false, "description": "Area: Foreign Function Interface (FFI)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-12-07T16:37:58Z", "updated_at": "2018-12-21T18:19:37Z", "closed_at": "2018-12-21T18:19:37Z", "author_association": "NONE", "active_lock_reason": null, "body": "## Description\r\n\r\nBy library crashes with memory corruption when using the current beta and nightly (1.32.0). It currently works on stable rust (1.31.0).\r\n\r\nMy [`fitsio`](https://crates.io/crates/fitsio) library and it's companion [`-sys` library](https://crates.io/crates/fitsio-sys) now crash with memory corruption errors when running the tests, on the latest beta and nightly.\r\n\r\nI believe this is caused by the allocator - when switching to the system allocator (using `#[global_allocator]`) and compiling with stable rust, it crashes in the same way. I feel like I read somewhere that 1.32 will change the default allocator for libs.\r\n\r\nI realise that given that this library is primarily C FFI, the chances of the problem being caused by me (or the underlying `cfitsio` library) is quite likely, I want to raise this in case there is a more serious underlying problem. This package has built successfully for a while - the [last successful Travis cron run was October 28th](https://travis-ci.org/mindriot101/rust-fitsio/builds/447562752).  The [next run (a week later on November 4)](https://travis-ci.org/mindriot101/rust-fitsio/builds/450637394) failed despite testing the same commit ([travis builds](https://travis-ci.org/mindriot101/rust-fitsio/builds)).\r\n\r\nThis crashes with the following error:\r\n\r\nLinux (from [travis output](https://travis-ci.org/mindriot101/rust-fitsio/jobs/462588780)):\r\n```\r\nError in `/home/travis/build/mindriot101/rust-fitsio/target/debug/deps/fitsio-2ed35057ce5c73ed': double free or corruption (!prev): 0x0000562fd05cb6a0 ***\r\n*** Error in `/home/travis/build/mindriot101/rust-fitsio/target/debug/deps/fitsio-2ed35057ce5c73ed': corrupted size vs. prev_size: 0x0000562fd05cb690 ***\r\nerror: process didn't exit successfully: `/home/travis/build/mindriot101/rust-fitsio/target/debug/deps/fitsio-2ed35057ce5c73ed` (signal: 11, SIGSEGV: invalid memory reference)\r\n```\r\n\r\nMacos:\r\n```txt\r\nfitsio-594344e52e1114f8(53401,0x7000036cc000) malloc: *** error for object 0x7fcf198015a8: incorrect checksum for freed object - object was probably modified after being freed.\r\n*** set a breakpoint in malloc_error_break to debug\r\nerror: process didn't exit successfully: `/Users/simon/Documents/Development/rust-fitsio/fitsio/target/debug/deps/fitsio-594344e52e1114f8 --test-threads 1` (signal: 6, SIGABRT: process abort signal)\r\n```\r\n\r\n## Meta\r\n\r\nstable (ok):\r\nrustc 1.31.0 (abe02cefd 2018-12-04)\r\nbinary: rustc\r\ncommit-hash: abe02cefd6cd1916df62ad7dc80161bea50b72e8\r\ncommit-date: 2018-12-04\r\nhost: x86_64-apple-darwin\r\nrelease: 1.31.0\r\nLLVM version: 8.0\r\n\r\nbeta (fails):\r\nrustc 1.32.0-beta.1 (eb53c1039 2018-12-05)\r\nbinary: rustc\r\ncommit-hash: eb53c1039300a8bc8f8e4b29659ddc80b1e81b68\r\ncommit-date: 2018-12-05\r\nhost: x86_64-apple-darwin\r\nrelease: 1.32.0-beta.1\r\nLLVM version: 8.0\r\n\r\nnightly (fails):\r\nrustc 1.32.0-nightly (14997d56a 2018-12-05)\r\nbinary: rustc\r\ncommit-hash: 14997d56a550f4aa99fe737593cd2758227afc56\r\ncommit-date: 2018-12-05\r\nhost: x86_64-apple-darwin\r\nrelease: 1.32.0-nightly\r\nLLVM version: 8.0\r\n\r\n## Process to re-create:\r\n\r\nInstall `cfitsio`:\r\n\r\n```sh\r\napt install libcfitsio-dev pkg-config # Debian/Ubuntu\r\npacman -S cfitsio # arch\r\nbrew install --enable-reentrant cfitsio # macos\r\n```\r\n\r\nGet the code\r\n\r\n```sh\r\ngit clone https://github.com/mindriot101/rust-fitsio.git\r\ncd rust-fitsio/fitsio\r\ngit checkout a35d2fa017568b82c102dc9efd8aec948a0bdc92 # the commit I'm working with\r\n```\r\n\r\nRun the tests\r\n\r\n```sh\r\ncargo clean # ensure no leftover files\r\ncargo +stable test -- --test-threads 1  # works\r\ncargo clean # ensure no leftover files\r\ncargo +beta test -- --test-threads 1  # fails\r\ncargo clean # ensure no leftover files\r\ncargo +nightly test -- --test-threads 1  # fails\r\n```\r\n\r\n## Dockerfile to recreate\r\n\r\n```docker\r\nFROM rust:latest\r\n\r\nRUN apt-get update && \\\r\n    apt-get -yq dist-upgrade && \\\r\n    apt-get install -yq --no-install-recommends \\\r\n        libcfitsio-dev \\\r\n        pkg-config \\\r\n        libclang-3.8-dev \\\r\n        build-essential \\ clang \\\r\n        gdb \\\r\n        && \\\r\n    apt-get clean && \\\r\n    rm -rf /var/lib/apt/lists/*\r\n\r\nRUN rustup update && \\\r\n    rustup install stable && \\\r\n    rustup install beta && \\\r\n    rustup install nightly\r\n\r\nRUN mkdir /project && \\\r\n    git clone https://github.com/mindriot101/rust-fitsio.git /project/rust-fitsio\r\n    \r\nWORKDIR \"/project/rust-fitsio/fitsio\"\r\n    \r\nRUN git checkout a35d2fa017568b82c102dc9efd8aec948a0bdc92\r\n\r\nCMD [\"cargo\", \"+nightly\", \"test\", \"--\", \"--test-threads\", \"1\"]\r\n```", "closed_by": {"login": "simonrw", "id": 59756, "node_id": "MDQ6VXNlcjU5NzU2", "avatar_url": "https://avatars.githubusercontent.com/u/59756?v=4", "gravatar_id": "", "url": "https://api.github.com/users/simonrw", "html_url": "https://github.com/simonrw", "followers_url": "https://api.github.com/users/simonrw/followers", "following_url": "https://api.github.com/users/simonrw/following{/other_user}", "gists_url": "https://api.github.com/users/simonrw/gists{/gist_id}", "starred_url": "https://api.github.com/users/simonrw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/simonrw/subscriptions", "organizations_url": "https://api.github.com/users/simonrw/orgs", "repos_url": "https://api.github.com/users/simonrw/repos", "events_url": "https://api.github.com/users/simonrw/events{/privacy}", "received_events_url": "https://api.github.com/users/simonrw/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/56603/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/56603/timeline", "performed_via_github_app": null, "state_reason": "completed"}