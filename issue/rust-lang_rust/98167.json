{"url": "https://api.github.com/repos/rust-lang/rust/issues/98167", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/98167/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/98167/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/98167/events", "html_url": "https://github.com/rust-lang/rust/issues/98167", "id": 1273573859, "node_id": "I_kwDOAAsO6M5L6THj", "number": 98167, "title": "Code generation error on AVR using u16::to_be()", "user": {"login": "mutantbob", "id": 1143535, "node_id": "MDQ6VXNlcjExNDM1MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/1143535?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mutantbob", "html_url": "https://github.com/mutantbob", "followers_url": "https://api.github.com/users/mutantbob/followers", "following_url": "https://api.github.com/users/mutantbob/following{/other_user}", "gists_url": "https://api.github.com/users/mutantbob/gists{/gist_id}", "starred_url": "https://api.github.com/users/mutantbob/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mutantbob/subscriptions", "organizations_url": "https://api.github.com/users/mutantbob/orgs", "repos_url": "https://api.github.com/users/mutantbob/repos", "events_url": "https://api.github.com/users/mutantbob/events{/privacy}", "received_events_url": "https://api.github.com/users/mutantbob/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1884641928, "node_id": "MDU6TGFiZWwxODg0NjQxOTI4", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-AVR", "name": "O-AVR", "color": "6e6ec0", "default": false, "description": "Target: AVR processors (ATtiny, ATmega, etc.)"}], "state": "closed", "locked": false, "assignee": {"login": "Patryk27", "id": 3395477, "node_id": "MDQ6VXNlcjMzOTU0Nzc=", "avatar_url": "https://avatars.githubusercontent.com/u/3395477?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Patryk27", "html_url": "https://github.com/Patryk27", "followers_url": "https://api.github.com/users/Patryk27/followers", "following_url": "https://api.github.com/users/Patryk27/following{/other_user}", "gists_url": "https://api.github.com/users/Patryk27/gists{/gist_id}", "starred_url": "https://api.github.com/users/Patryk27/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Patryk27/subscriptions", "organizations_url": "https://api.github.com/users/Patryk27/orgs", "repos_url": "https://api.github.com/users/Patryk27/repos", "events_url": "https://api.github.com/users/Patryk27/events{/privacy}", "received_events_url": "https://api.github.com/users/Patryk27/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "Patryk27", "id": 3395477, "node_id": "MDQ6VXNlcjMzOTU0Nzc=", "avatar_url": "https://avatars.githubusercontent.com/u/3395477?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Patryk27", "html_url": "https://github.com/Patryk27", "followers_url": "https://api.github.com/users/Patryk27/followers", "following_url": "https://api.github.com/users/Patryk27/following{/other_user}", "gists_url": "https://api.github.com/users/Patryk27/gists{/gist_id}", "starred_url": "https://api.github.com/users/Patryk27/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Patryk27/subscriptions", "organizations_url": "https://api.github.com/users/Patryk27/orgs", "repos_url": "https://api.github.com/users/Patryk27/repos", "events_url": "https://api.github.com/users/Patryk27/events{/privacy}", "received_events_url": "https://api.github.com/users/Patryk27/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 6, "created_at": "2022-06-16T13:33:24Z", "updated_at": "2022-07-08T17:35:18Z", "closed_at": "2022-07-06T15:10:37Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\nalong with any information you feel relevant to replicating the bug.\n-->\n\nI tried this code on AVR (arduino Uno = atmega328p) with opt-level=\"z\":\n\n```rust\nlet pixels = [0xf800u16, 0x07e0, 0x001f];\nlet mut buf = [0u16; 3];\n{\n    let mut i = 0;\n    for pixel in pixels.map(u16::to_be) {\n        buf[i] = pixel;\n        i += 1;\n    }\n    let _ = uwriteln!(serial, \"debug buf {:?} mapped\", buf);\n}\n```\n\nI expected to see this happen: \n`debug buf [248, 57351, 7936] mapped`\n\nInstead, this happened: \n`debug buf [0, 57568, 7967] mapped`\n\nAn alternate code that emits the correct output is\n\n```rust\n    {\n        for (i, pixel) in pixels.iter().enumerate() {\n            buf[i] = pixel.to_be();\n        }\n        let _ = uwriteln!(serial, \"debug buf {:?} enumerate\", buf);\n    }\n```\n\nThis compiler error is corrupting the pixel stream transmitted via SPI to an ST7789 display from an Arduino Uno.  What appears to be happening is that instead of the bytes being swapped, the LSB is being copied to the MSB.  I do not have the expertise to decompile and examine the assembly code.\n\n### Meta\n\n\n`rustc --version --verbose`:\n```\nrustc 1.62.0-nightly (88860d547 2022-05-09)\nbinary: rustc\ncommit-hash: 88860d5474a32f507dde8fba8df35fd2064f11b9\ncommit-date: 2022-05-09\nhost: x86_64-unknown-linux-gnu\nrelease: 1.62.0-nightly\nLLVM version: 14.0.1\n\n```\n\nThe malfunction also occurs with `cargo +nightly`.\n\n`rustc +nightly --version --verbose`\n```\nrustc 1.63.0-nightly (b31f9cc22 2022-06-15)\nbinary: rustc\ncommit-hash: b31f9cc22bcd720b37ddf927afe378108a5b9a54\ncommit-date: 2022-06-15\nhost: x86_64-unknown-linux-gnu\nrelease: 1.63.0-nightly\nLLVM version: 14.0.5\n```\n\nThe full code can be cloned from https://github.com/mutantbob/rust-avr-code-generation-bug\n\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"Patryk27\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/98167/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/98167/timeline", "performed_via_github_app": null, "state_reason": "completed"}