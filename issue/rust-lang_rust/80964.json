{"url": "https://api.github.com/repos/rust-lang/rust/issues/80964", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/80964/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/80964/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/80964/events", "html_url": "https://github.com/rust-lang/rust/issues/80964", "id": 784758996, "node_id": "MDU6SXNzdWU3ODQ3NTg5OTY=", "number": 80964, "title": "Adding struct/variant causes inference error in unrelated code", "user": {"login": "wchargin", "id": 4317806, "node_id": "MDQ6VXNlcjQzMTc4MDY=", "avatar_url": "https://avatars.githubusercontent.com/u/4317806?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wchargin", "html_url": "https://github.com/wchargin", "followers_url": "https://api.github.com/users/wchargin/followers", "following_url": "https://api.github.com/users/wchargin/following{/other_user}", "gists_url": "https://api.github.com/users/wchargin/gists{/gist_id}", "starred_url": "https://api.github.com/users/wchargin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wchargin/subscriptions", "organizations_url": "https://api.github.com/users/wchargin/orgs", "repos_url": "https://api.github.com/users/wchargin/repos", "events_url": "https://api.github.com/users/wchargin/events{/privacy}", "received_events_url": "https://api.github.com/users/wchargin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2021-01-13T03:36:27Z", "updated_at": "2021-01-13T18:28:06Z", "closed_at": "2021-01-13T18:28:05Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I tried this code:\r\n\r\n```rust\r\n//! Stripped-down repro case for a strange bug, wherein adding a new struct or enum variant can\r\n//! surface type inference errors in completely unrelated code, even in different modules.\r\n\r\nmod pb {\r\n    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]\r\n    #[repr(i32)]\r\n    pub enum DataClass {\r\n        Unknown = 0,\r\n        Scalar = 1,\r\n        Tensor = 2,\r\n        BlobSequence = 3,\r\n    }\r\n    #[derive(Clone, PartialEq, ::prost::Message)]\r\n    pub struct SummaryMetadata {\r\n        #[prost(enumeration = \"DataClass\", tag = \"4\")]\r\n        pub data_class: i32,\r\n    }\r\n}\r\n\r\npub fn test() {\r\n    let md = pb::SummaryMetadata::default();\r\n    assert_eq!(md.data_class, pb::DataClass::BlobSequence.into());\r\n}\r\n\r\n// Uncomment this line to create an inference error at line 19:\r\n//pub struct Foo(serde_json::Error);\r\n```\r\n\r\nI expected it to compile, and it does. But when I uncomment the final\r\nline, a new inference error appears on the `assert_eq!` line:\r\n\r\n```\r\nerror[E0282]: type annotations needed\r\n  --> src/lib.rs:22:59\r\n   |\r\n22 |     assert_eq!(md.data_class, pb::DataClass::BlobSequence.into());\r\n   |                               ----------------------------^^^^--\r\n   |                               |                           |\r\n   |                               |                           cannot infer type for type parameter `T` declared on the trait `Into`\r\n   |                               this method call resolves to `T`\r\n```\r\n\r\nBy itself, the inference error seems reasonable enough, and I can just\r\nadd type annotations. But the change has nothing to do with the error.\r\n\r\nThis is a stripped-down example. In my real code, I\u2019m adding a variant\r\nto an existing error enum, and I see two inference errors in entirely\r\nunrelated modules:\r\n\r\n```\r\n$ git diff -U1\r\ndiff --git a/tensorboard/data/server/lib.rs b/tensorboard/data/server/lib.rs\r\nindex f1def3891..357693441 100644\r\n--- a/tensorboard/data/server/lib.rs\r\n+++ b/tensorboard/data/server/lib.rs\r\n@@ -19,2 +19,4 @@ limitations under the License.\r\n \r\n+pub struct Foo(serde_json::Error);\r\n+\r\n pub mod cli;\r\n\r\n$ cargo check --tests\r\nerror[E0282]: type annotations needed\r\n   --> data_compat.rs:456:67\r\n    |\r\n456 |             assert_eq!(md.data_class, pb::DataClass::BlobSequence.into());\r\n    |                                       ----------------------------^^^^--\r\n    |                                       |                           |\r\n    |                                       |                           cannot infer type for type parameter `T` declared on the trait `Into`\r\n    |                                       this method call resolves to `T`\r\n\r\nerror[E0282]: type annotations needed\r\n   --> server.rs:629:37\r\n    |\r\n629 |         assert_eq!(xent_data.value, Vec::new());\r\n    |                                     ^^^^^^^^ cannot infer type for type parameter `T`\r\n```\r\n\r\nCloneable example:\r\n<https://github.com/wchargin/rust-inference-action-at-a-distance>\r\n\r\n### Meta\r\n\r\nCan repro in 1.48.0, 1.49.0-beta, and 2021-01-06 nightly.\r\n\r\n<details>\r\n<summary>cargo/rustc versions</summary>\r\n\r\n```\r\n$ cargo --version --verbose\r\ncargo 1.48.0 (65cbdd2dc 2020-10-14)\r\nrelease: 1.48.0\r\ncommit-hash: 65cbdd2dc0b7e877577474b98b7d071308d0bb6f\r\ncommit-date: 2020-10-14\r\n\r\n$ cargo +beta --version --verbose\r\ncargo 1.49.0-beta (8662ab427 2020-11-12)\r\nrelease: 1.49.0\r\ncommit-hash: 8662ab427a8d6ad8047811cc4d78dbd20dd07699\r\ncommit-date: 2020-11-12\r\n\r\n$ cargo +nightly --version --verbose\r\ncargo 1.51.0-nightly (329895f5b 2021-01-06)\r\nrelease: 1.51.0\r\ncommit-hash: 329895f5b52a358e5d9ecb26215708b5cb31d906\r\ncommit-date: 2021-01-06\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>Cargo.toml</summary>\r\n\r\n```toml\r\n[package]\r\nname = \"inference-action-at-a-distance\"\r\nversion = \"0.1.0\"\r\nedition = \"2018\"\r\n\r\n[dependencies]\r\nprost = \"0.6.1\"\r\nserde_json = \"1.0.59\"\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>Cargo.lock</summary>\r\n\r\n```\r\n# This file is automatically @generated by Cargo.\r\n# It is not intended for manual editing.\r\n[[package]]\r\nname = \"anyhow\"\r\nversion = \"1.0.38\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"afddf7f520a80dbf76e6f50a35bca42a2331ef227a28b3b6dc5c2e2338d114b1\"\r\n\r\n[[package]]\r\nname = \"bytes\"\r\nversion = \"0.5.6\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"0e4cec68f03f32e44924783795810fa50a7035d8c8ebe78580ad7e6c703fba38\"\r\n\r\n[[package]]\r\nname = \"either\"\r\nversion = \"1.6.1\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"e78d4f1cc4ae33bbfc157ed5d5a5ef3bc29227303d595861deb238fcec4e9457\"\r\n\r\n[[package]]\r\nname = \"inference-action-at-a-distance\"\r\nversion = \"0.1.0\"\r\ndependencies = [\r\n \"prost\",\r\n \"serde_json\",\r\n]\r\n\r\n[[package]]\r\nname = \"itertools\"\r\nversion = \"0.8.2\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"f56a2d0bc861f9165be4eb3442afd3c236d8a98afd426f65d92324ae1091a484\"\r\ndependencies = [\r\n \"either\",\r\n]\r\n\r\n[[package]]\r\nname = \"itoa\"\r\nversion = \"0.4.7\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"dd25036021b0de88a0aff6b850051563c6516d0bf53f8638938edbb9de732736\"\r\n\r\n[[package]]\r\nname = \"proc-macro2\"\r\nversion = \"1.0.24\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"1e0704ee1a7e00d7bb417d0770ea303c1bccbabf0ef1667dae92b5967f5f8a71\"\r\ndependencies = [\r\n \"unicode-xid\",\r\n]\r\n\r\n[[package]]\r\nname = \"prost\"\r\nversion = \"0.6.1\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"ce49aefe0a6144a45de32927c77bd2859a5f7677b55f220ae5b744e87389c212\"\r\ndependencies = [\r\n \"bytes\",\r\n \"prost-derive\",\r\n]\r\n\r\n[[package]]\r\nname = \"prost-derive\"\r\nversion = \"0.6.1\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"537aa19b95acde10a12fec4301466386f757403de4cd4e5b4fa78fb5ecb18f72\"\r\ndependencies = [\r\n \"anyhow\",\r\n \"itertools\",\r\n \"proc-macro2\",\r\n \"quote\",\r\n \"syn\",\r\n]\r\n\r\n[[package]]\r\nname = \"quote\"\r\nversion = \"1.0.8\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"991431c3519a3f36861882da93630ce66b52918dcf1b8e2fd66b397fc96f28df\"\r\ndependencies = [\r\n \"proc-macro2\",\r\n]\r\n\r\n[[package]]\r\nname = \"ryu\"\r\nversion = \"1.0.5\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"71d301d4193d031abdd79ff7e3dd721168a9572ef3fe51a1517aba235bd8f86e\"\r\n\r\n[[package]]\r\nname = \"serde\"\r\nversion = \"1.0.119\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"9bdd36f49e35b61d49efd8aa7fc068fd295961fd2286d0b2ee9a4c7a14e99cc3\"\r\n\r\n[[package]]\r\nname = \"serde_json\"\r\nversion = \"1.0.61\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"4fceb2595057b6891a4ee808f70054bd2d12f0e97f1cbb78689b59f676df325a\"\r\ndependencies = [\r\n \"itoa\",\r\n \"ryu\",\r\n \"serde\",\r\n]\r\n\r\n[[package]]\r\nname = \"syn\"\r\nversion = \"1.0.58\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"cc60a3d73ea6594cd712d830cc1f0390fd71542d8c8cd24e70cc54cdfd5e05d5\"\r\ndependencies = [\r\n \"proc-macro2\",\r\n \"quote\",\r\n \"unicode-xid\",\r\n]\r\n\r\n[[package]]\r\nname = \"unicode-xid\"\r\nversion = \"0.2.1\"\r\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\r\nchecksum = \"f7fe0bb3479651439c9112f72b6c505038574c9fbb575ed1bf3b797fa39dd564\"\r\n```\r\n\r\n</details>\r\n", "closed_by": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/80964/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/80964/timeline", "performed_via_github_app": null, "state_reason": "completed"}