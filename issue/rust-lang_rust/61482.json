{"url": "https://api.github.com/repos/rust-lang/rust/issues/61482", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/61482/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/61482/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/61482/events", "html_url": "https://github.com/rust-lang/rust/issues/61482", "id": 451272048, "node_id": "MDU6SXNzdWU0NTEyNzIwNDg=", "number": 61482, "title": "A `rustc`-internal compile error on future and task API", "user": {"login": "luojia65", "id": 40385009, "node_id": "MDQ6VXNlcjQwMzg1MDA5", "avatar_url": "https://avatars.githubusercontent.com/u/40385009?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luojia65", "html_url": "https://github.com/luojia65", "followers_url": "https://api.github.com/users/luojia65/followers", "following_url": "https://api.github.com/users/luojia65/following{/other_user}", "gists_url": "https://api.github.com/users/luojia65/gists{/gist_id}", "starred_url": "https://api.github.com/users/luojia65/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luojia65/subscriptions", "organizations_url": "https://api.github.com/users/luojia65/orgs", "repos_url": "https://api.github.com/users/luojia65/repos", "events_url": "https://api.github.com/users/luojia65/events{/privacy}", "received_events_url": "https://api.github.com/users/luojia65/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 1049510487, "node_id": "MDU6TGFiZWwxMDQ5NTEwNDg3", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-async-await", "name": "A-async-await", "color": "f7e101", "default": false, "description": "Area: Async & Await"}, {"id": 1259721467, "node_id": "MDU6TGFiZWwxMjU5NzIxNDY3", "url": "https://api.github.com/repos/rust-lang/rust/labels/AsyncAwait-Triaged", "name": "AsyncAwait-Triaged", "color": "d4c5f9", "default": false, "description": "Async-await issues that have been triaged during a working group meeting."}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2019-06-03T02:50:50Z", "updated_at": "2020-05-10T15:55:03Z", "closed_at": "2020-05-10T15:55:03Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Today when I tried this piece of code:\r\n```rust\r\n#![feature(async_await, gen_future)]\r\n\r\nuse core::task::Context;\r\nuse core::task::Poll;\r\nuse core::pin::Pin;\r\nuse core::future::Future;\r\nuse std::future::poll_with_tls_context;\r\n\r\nstruct CountdownFuture(u32);\r\n\r\nimpl Future for CountdownFuture {\r\n    type Output = ();\r\n\r\n    fn poll(mut self: Pin<&mut Self>, cx: &mut Context) -> Poll<Self::Output> {\r\n        if self.0 == 0 {\r\n            Poll::Ready(())\r\n        } else {\r\n            self.0 -= 1;\r\n            Poll::Pending\r\n        }\r\n    }\r\n}\r\n\r\nfn main() {\r\n    let mut fut = CountdownFuture(3);\r\n    let pin = Pin::new(&mut fut);\r\n    let res = poll_with_tls_context(pin);\r\n    println!(\"{:?}\", res);\r\n}\r\n```\r\nI expected to see a line of debug formatted output representing a `Poll::Pending` state is set for variable `res`. However, when I execute this piece of code, a compile error occurred:\r\n```\r\n   Finished dev [unoptimized + debuginfo] target(s) in 0.32s\r\n     Running `target\\debug\\test-futures.exe`\r\nthread 'main' panicked at 'TLS Context not set. This is a rustc bug. Please file an issue on https://github.com/rust-lang/rust.', src\\libcore\\option.rs:1036:5\r\nnote: Run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\r\nerror: process didn't exit successfully: `target\\debug\\test-futures.exe` (exit code: 101)\r\n```\r\nAnd with `RUST_BACKTRACE=1`:\r\n```\r\n    Finished dev [unoptimized + debuginfo] target(s) in 0.04s\r\n     Running `target\\debug\\test-futures.exe`\r\nthread 'main' panicked at 'TLS Context not set. This is a rustc bug. Please file an issue on https://github.com/rust-lang/rust.', src\\libcore\\option.rs:1036:5\r\nstack backtrace:\r\n   0: backtrace::backtrace::trace_unsynchronized\r\n             at C:\\Users\\appveyor\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\backtrace-0.3.25\\src\\backtrace\\mod.rs:66\r\n   1: std::sys_common::backtrace::_print\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libstd\\sys_common\\backtrace.rs:47\r\n   2: std::sys_common::backtrace::print\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libstd\\sys_common\\backtrace.rs:36\r\n   3: std::panicking::default_hook::{{closure}}\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libstd\\panicking.rs:197\r\n   4: std::panicking::default_hook\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libstd\\panicking.rs:211\r\n   5: std::panicking::rust_panic_with_hook\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libstd\\panicking.rs:474\r\n   6: std::panicking::continue_panic_fmt\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libstd\\panicking.rs:381\r\n   7: std::panicking::rust_begin_panic\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libstd\\panicking.rs:308\r\n   8: core::panicking::panic_fmt\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libcore\\panicking.rs:85\r\n   9: core::option::expect_failed\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libcore\\option.rs:1036\r\n  10: core::option::Option<core::ptr::non_null::NonNull<core::task::wake::Context>>::expect<core::ptr::non_null::NonNull<core::task::wake::Context>>\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\src\\libcore\\option.rs:314\r\n  11: std::future::get_task_context<closure,core::task::poll::Poll<()>>\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\src\\libstd\\future.rs:95\r\n  12: std::future::poll_with_tls_context<test_futures::CountdownFuture>\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\src\\libstd\\future.rs:114\r\n  13: test_futures::main\r\n             at .\\src\\main.rs:27\r\n  14: std::rt::lang_start::{{closure}}<()>\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\src\\libstd\\rt.rs:64\r\n  15: std::rt::lang_start_internal::{{closure}}\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libstd\\rt.rs:49\r\n  16: std::panicking::try::do_call<closure,i32>\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libstd\\panicking.rs:293\r\n  17: panic_unwind::__rust_maybe_catch_panic\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libpanic_unwind\\lib.rs:85\r\n  18: std::panicking::try\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libstd\\panicking.rs:272\r\n  19: std::panic::catch_unwind\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libstd\\panic.rs:388\r\n  20: std::rt::lang_start_internal\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\/src\\libstd\\rt.rs:48\r\n  21: std::rt::lang_start<()>\r\n             at /rustc/627486af15d222bcba336b12ea92a05237cc9ab1\\src\\libstd\\rt.rs:64\r\n  22: main\r\n  23: invoke_main\r\n             at d:\\agent\\_work\\3\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:78\r\n  24: __scrt_common_main_seh\r\n             at d:\\agent\\_work\\3\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:288\r\n  25: BaseThreadInitThunk\r\n  26: RtlUserThreadStart\r\nerror: process didn't exit successfully: `target\\debug\\test-futures.exe` (exit code: 101)\r\n```\r\nIt seems that there is an internal issue with `rustc` itself. Does anyone met the same problem or similar issues as me? Or is there something wrong with my code? BTW, I doubt that I may need to change a executor function other than `poll_with_tls_context`.\r\nHere's my `rustc` version:\r\n```\r\nPS D:\\RustProjects\\test-futures> rustc -V\r\nrustc 1.37.0-nightly (627486af1 2019-06-02)\r\n```\r\nI'm using `rustc` target `nightly-x86_64-pc-windows-msvc` on Windows 10.", "closed_by": {"login": "csmoe", "id": 35686186, "node_id": "MDQ6VXNlcjM1Njg2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/35686186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/csmoe", "html_url": "https://github.com/csmoe", "followers_url": "https://api.github.com/users/csmoe/followers", "following_url": "https://api.github.com/users/csmoe/following{/other_user}", "gists_url": "https://api.github.com/users/csmoe/gists{/gist_id}", "starred_url": "https://api.github.com/users/csmoe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/csmoe/subscriptions", "organizations_url": "https://api.github.com/users/csmoe/orgs", "repos_url": "https://api.github.com/users/csmoe/repos", "events_url": "https://api.github.com/users/csmoe/events{/privacy}", "received_events_url": "https://api.github.com/users/csmoe/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/61482/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/61482/timeline", "performed_via_github_app": null, "state_reason": "completed"}