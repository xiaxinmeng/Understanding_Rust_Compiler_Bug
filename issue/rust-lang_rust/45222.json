{"url": "https://api.github.com/repos/rust-lang/rust/issues/45222", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/45222/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/45222/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/45222/events", "html_url": "https://github.com/rust-lang/rust/issues/45222", "id": 264765998, "node_id": "MDU6SXNzdWUyNjQ3NjU5OTg=", "number": 45222, "title": "Big performance problem with closed intervals looping", "user": {"login": "leonardo-m", "id": 22328461, "node_id": "MDQ6VXNlcjIyMzI4NDYx", "avatar_url": "https://avatars.githubusercontent.com/u/22328461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/leonardo-m", "html_url": "https://github.com/leonardo-m", "followers_url": "https://api.github.com/users/leonardo-m/followers", "following_url": "https://api.github.com/users/leonardo-m/following{/other_user}", "gists_url": "https://api.github.com/users/leonardo-m/gists{/gist_id}", "starred_url": "https://api.github.com/users/leonardo-m/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/leonardo-m/subscriptions", "organizations_url": "https://api.github.com/users/leonardo-m/orgs", "repos_url": "https://api.github.com/users/leonardo-m/repos", "events_url": "https://api.github.com/users/leonardo-m/events{/privacy}", "received_events_url": "https://api.github.com/users/leonardo-m/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 23, "created_at": "2017-10-11T23:19:26Z", "updated_at": "2021-12-29T08:47:54Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "In my code I've essentially stopped using loops with ... (intervals closed on the right, recently written with the syntax ..=) because they give performance problems. This is a simple example that shows the problem:\r\n\r\n\r\n```rust\r\n#![feature(inclusive_range_syntax)]\r\n#![allow(private_no_mangle_fns)]\r\n\r\n#[inline(never)]\r\n#[no_mangle]\r\nfn foo1(n: u64) -> u64 {\r\n    let mut count = 0;\r\n    for _ in 0 .. n {\r\n        for j in (0 .. n + 1).rev() {\r\n            count += j;\r\n        }\r\n    }\r\n    count\r\n}\r\n\r\n#[inline(never)]\r\n#[no_mangle]\r\nfn foo2(n: u64) -> u64 {\r\n    let mut count = 0;\r\n    for _ in 0 .. n {\r\n        for j in (0 ..= n).rev() {\r\n            count += j;\r\n        }\r\n    }\r\n    count\r\n}\r\n\r\nfn main() {\r\n    let n: u64 = std::env::args().nth(1).unwrap().parse().unwrap();\r\n    let what: u32 = std::env::args().nth(2).unwrap().parse().unwrap();\r\n\r\n    match what {\r\n        1 => println!(\"{}\", foo1(n)),\r\n        2 => println!(\"{}\", foo2(n)),\r\n        _ => panic!(),\r\n    }\r\n}\r\n```\r\n\r\n\r\nCompiled with the last Nightly:\r\n\r\n```\r\nrustc 1.22.0-nightly (d6d711dd8 2017-10-10)\r\nbinary: rustc\r\ncommit-hash: d6d711dd8f7ad5885294b8e1f0009a23dc1f8b1f\r\ncommit-date: 2017-10-10\r\nhost: x86_64-pc-windows-gnu\r\nrelease: 1.22.0-nightly\r\nLLVM version: 4.0\r\n```\r\n\r\n\r\nCompiled with:\r\n`rustc -O test.rs`\r\n\r\nRunning it calling foo1 takes 0.02 seconds:\r\n\r\n```\r\n...>elaps test 100000 1\r\n500005000000000\r\n```\r\n\r\nRunning it calling foo2 takes about 13.65 seconds:\r\n```\r\n\r\n...>elaps test 100000 2\r\n500005000000000\r\n```\r\n\r\n<details><summary>The asm I am seeing using \"--emit asm\"</summary>\r\n\r\n```\r\nfoo1:\r\n\ttestq\t%rcx, %rcx\r\n\tje\t.LBB5_1\r\n\tmovq\t%rcx, %r8\r\n\timulq\t%r8, %r8\r\n\tleaq\t-1(%rcx), %rdx\r\n\tmovq\t%rcx, %rax\r\n\tmulq\t%rdx\r\n\tshldq\t$63, %rax, %rdx\r\n\tsubq\t%rdx, %r8\r\n\tcmpq\t$3, %rcx\r\n\tjbe\t.LBB5_3\r\n\tmovq\t%rcx, %rdx\r\n\tandq\t$-4, %rdx\r\n\tje\t.LBB5_3\r\n\tmovd\t%r8, %xmm0\r\n\tpshufd\t$68, %xmm0, %xmm2\r\n\tleaq\t-4(%rdx), %r9\r\n\tmovl\t%r9d, %eax\r\n\tshrl\t$2, %eax\r\n\tincl\t%eax\r\n\tandq\t$3, %rax\r\n\tje\t.LBB5_8\r\n\tcmpq\t$-1, %rcx\r\n\tpxor\t%xmm0, %xmm0\r\n\tpxor\t%xmm3, %xmm3\r\n\tje\t.LBB5_11\r\n\tmovdqa\t%xmm2, %xmm3\r\n.LBB5_11:\r\n\tnegq\t%rax\r\n\txorl\t%r10d, %r10d\r\n\tpxor\t%xmm1, %xmm1\r\n\t.p2align\t4, 0x90\r\n.LBB5_12:\r\n\tpaddq\t%xmm3, %xmm0\r\n\tpaddq\t%xmm3, %xmm1\r\n\taddq\t$4, %r10\r\n\tincq\t%rax\r\n\tjne\t.LBB5_12\r\n\tjmp\t.LBB5_13\r\n.LBB5_3:\r\n\txorl\t%eax, %eax\r\n\txorl\t%edx, %edx\r\n.LBB5_4:\r\n\txorl\t%r9d, %r9d\r\n\tcmpq\t$-1, %rcx\r\n\tcmoveq\t%r9, %r8\r\n\t.p2align\t4, 0x90\r\n.LBB5_5:\r\n\tincq\t%rdx\r\n\taddq\t%r8, %rax\r\n\tcmpq\t%rcx, %rdx\r\n\tjb\t.LBB5_5\r\n.LBB5_19:\r\n\tretq\r\n.LBB5_1:\r\n\txorl\t%eax, %eax\r\n\tretq\r\n.LBB5_8:\r\n\txorl\t%r10d, %r10d\r\n\tpxor\t%xmm0, %xmm0\r\n\tpxor\t%xmm1, %xmm1\r\n.LBB5_13:\r\n\tcmpq\t$12, %r9\r\n\tjb\t.LBB5_18\r\n\tcmpq\t$-1, %rcx\r\n\tpxor\t%xmm3, %xmm3\r\n\tje\t.LBB5_16\r\n\tmovdqa\t%xmm2, %xmm3\r\n.LBB5_16:\r\n\tmovq\t%rdx, %rax\r\n\tsubq\t%r10, %rax\r\n\t.p2align\t4, 0x90\r\n.LBB5_17:\r\n\tpaddq\t%xmm3, %xmm0\r\n\tpaddq\t%xmm3, %xmm1\r\n\tpaddq\t%xmm3, %xmm0\r\n\tpaddq\t%xmm3, %xmm1\r\n\tpaddq\t%xmm3, %xmm0\r\n\tpaddq\t%xmm3, %xmm1\r\n\tpaddq\t%xmm3, %xmm0\r\n\tpaddq\t%xmm3, %xmm1\r\n\taddq\t$-16, %rax\r\n\tjne\t.LBB5_17\r\n.LBB5_18:\r\n\tpaddq\t%xmm1, %xmm0\r\n\tpshufd\t$78, %xmm0, %xmm1\r\n\tpaddq\t%xmm0, %xmm1\r\n\tmovd\t%xmm1, %rax\r\n\tcmpq\t%rcx, %rdx\r\n\tjne\t.LBB5_4\r\n\tjmp\t.LBB5_19\r\n\r\n\r\n\r\nfoo2:\r\n\tpushq\t%rsi\r\n\tpushq\t%rdi\r\n\tpushq\t%rbx\r\n\ttestq\t%rcx, %rcx\r\n\tje\t.LBB6_1\r\n\ttestb\t$1, %cl\r\n\tjne\t.LBB6_4\r\n\txorl\t%eax, %eax\r\n\txorl\t%r8d, %r8d\r\n\tcmpq\t$1, %rcx\r\n\tjne\t.LBB6_11\r\n\tjmp\t.LBB6_23\r\n.LBB6_1:\r\n\txorl\t%eax, %eax\r\n\tjmp\t.LBB6_23\r\n.LBB6_4:\r\n\txorl\t%r8d, %r8d\r\n\tmovq\t$-1, %r9\r\n\txorl\t%r10d, %r10d\r\n\tmovq\t%rcx, %r11\r\n\txorl\t%eax, %eax\r\n\tjmp\t.LBB6_5\r\n\t.p2align\t4, 0x90\r\n.LBB6_8:\r\n\taddq\t%r11, %rax\r\n\tmovq\t%rdi, %r10\r\n\tmovq\t%rdx, %r11\r\n.LBB6_5:\r\n\tcmpq\t%r11, %r10\r\n\tmovl\t$1, %esi\r\n\tcmovbq\t%r9, %rsi\r\n\tcmoveq\t%r8, %rsi\r\n\ttestq\t%rsi, %rsi\r\n\tmovl\t$1, %edi\r\n\tmovl\t$0, %edx\r\n\tje\t.LBB6_8\r\n\tcmpq\t$-1, %rsi\r\n\tjne\t.LBB6_9\r\n\tleaq\t-1(%r11), %rdx\r\n\tmovq\t%r10, %rdi\r\n\tjmp\t.LBB6_8\r\n.LBB6_9:\r\n\tmovl\t$1, %r8d\r\n\tcmpq\t$1, %rcx\r\n\tje\t.LBB6_23\r\n.LBB6_11:\r\n\txorl\t%r9d, %r9d\r\n\tmovq\t$-1, %r10\r\n\t.p2align\t4, 0x90\r\n.LBB6_12:\r\n\txorl\t%r11d, %r11d\r\n\tmovq\t%rcx, %rdx\r\n\tjmp\t.LBB6_13\r\n\t.p2align\t4, 0x90\r\n.LBB6_16:\r\n\taddq\t%rdx, %rax\r\n\tmovq\t%rbx, %r11\r\n\tmovq\t%rsi, %rdx\r\n.LBB6_13:\r\n\tcmpq\t%rdx, %r11\r\n\tmovl\t$1, %edi\r\n\tcmovbq\t%r10, %rdi\r\n\tcmoveq\t%r9, %rdi\r\n\ttestq\t%rdi, %rdi\r\n\tmovl\t$1, %ebx\r\n\tmovl\t$0, %esi\r\n\tje\t.LBB6_16\r\n\tcmpq\t$-1, %rdi\r\n\tjne\t.LBB6_17\r\n\tleaq\t-1(%rdx), %rsi\r\n\tmovq\t%r11, %rbx\r\n\tjmp\t.LBB6_16\r\n\t.p2align\t4, 0x90\r\n.LBB6_17:\r\n\taddq\t$2, %r8\r\n\txorl\t%r11d, %r11d\r\n\tmovq\t%rcx, %rdx\r\n\tjmp\t.LBB6_18\r\n\t.p2align\t4, 0x90\r\n.LBB6_21:\r\n\taddq\t%rdx, %rax\r\n\tmovq\t%rbx, %r11\r\n\tmovq\t%rsi, %rdx\r\n.LBB6_18:\r\n\tcmpq\t%rdx, %r11\r\n\tmovl\t$1, %edi\r\n\tcmovbq\t%r10, %rdi\r\n\tcmoveq\t%r9, %rdi\r\n\ttestq\t%rdi, %rdi\r\n\tmovl\t$1, %ebx\r\n\tmovl\t$0, %esi\r\n\tje\t.LBB6_21\r\n\tcmpq\t$-1, %rdi\r\n\tjne\t.LBB6_22\r\n\tleaq\t-1(%rdx), %rsi\r\n\tmovq\t%r11, %rbx\r\n\tjmp\t.LBB6_21\r\n\t.p2align\t4, 0x90\r\n.LBB6_22:\r\n\tcmpq\t%rcx, %r8\r\n\tjb\t.LBB6_12\r\n.LBB6_23:\r\n\tpopq\t%rbx\r\n\tpopq\t%rdi\r\n\tpopq\t%rsi\r\n\tretq\r\n```\r\n\r\n</details>", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/45222/reactions", "total_count": 2, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/45222/timeline", "performed_via_github_app": null, "state_reason": null}