{"url": "https://api.github.com/repos/rust-lang/rust/issues/97551", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/97551/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/97551/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/97551/events", "html_url": "https://github.com/rust-lang/rust/issues/97551", "id": 1252729003, "node_id": "I_kwDOAAsO6M5KqyCr", "number": 97551, "title": "cargo test --doc does not respect CARGO_BUILD_JOBS env variable", "user": {"login": "tmpolaczyk", "id": 44604217, "node_id": "MDQ6VXNlcjQ0NjA0MjE3", "avatar_url": "https://avatars.githubusercontent.com/u/44604217?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmpolaczyk", "html_url": "https://github.com/tmpolaczyk", "followers_url": "https://api.github.com/users/tmpolaczyk/followers", "following_url": "https://api.github.com/users/tmpolaczyk/following{/other_user}", "gists_url": "https://api.github.com/users/tmpolaczyk/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmpolaczyk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmpolaczyk/subscriptions", "organizations_url": "https://api.github.com/users/tmpolaczyk/orgs", "repos_url": "https://api.github.com/users/tmpolaczyk/repos", "events_url": "https://api.github.com/users/tmpolaczyk/events{/privacy}", "received_events_url": "https://api.github.com/users/tmpolaczyk/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2022-05-30T13:16:24Z", "updated_at": "2022-05-30T16:18:47Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "I originally reported this issue in the cargo repo: https://github.com/rust-lang/cargo/issues/10702 but I was told that \"this behaviour is controlled by rustdoc\".\r\n\r\n### Problem\r\n\r\nI use a global variable CARGO_BUILD_JOBS=4 because the default configuration results in my machine running out of memory when compiling some rust projects. However recently I noticed that this fails when there are many doc tests in the project, because it looks like all the doc tests are compiled in parallel.\r\n\r\n### Steps\r\n\r\n1. Find some project with many doc tests\r\n2. export CARGO_BUILD_JOBS=1\r\n3. cargo test --doc\r\n4. In a separate terminal, run `pidof rustc` and notice how there are as multiple processes, instead of the expected 1.\r\n5. This results in the tests failing, in my case because the linker is killed because the system has run out of memory.\r\n\r\n### Possible Solution(s)\r\n\r\nIn my opinion the correct behavior is to respect CARGO_BUILD_JOBS when compiling the tests.\r\n\r\nAs a workaround, you can use\r\n\r\n    cargo test -- --test-threads 1\r\n\r\nto limit the number of build jobs to 1, however this also affects normal tests, so running tests will be much slower.\r\n\r\n### Version\r\n\r\n```text\r\ncargo 1.61.0 (a028ae4 2022-04-29)\r\nrelease: 1.61.0\r\ncommit-hash: a028ae42fc1376571de836be702e840ca8e060c2\r\ncommit-date: 2022-04-29\r\nhost: x86_64-unknown-linux-gnu\r\nlibgit2: 1.4.2 (sys:0.14.2 vendored)\r\nlibcurl: 7.80.0-DEV (sys:0.4.51+curl-7.80.0 vendored ssl:OpenSSL/1.1.1m)\r\nos: Ubuntu 22.04 (jammy) [64-bit]\r\n```\r\n\r\n### Comments\r\n\r\n@weihanglo provided helpful [comments](https://github.com/rust-lang/cargo/issues/10702#issuecomment-1138525140):\r\n\r\n> To my understanding, `rustdoc` collects each doctest and compiles them by invoking `rustc` on-the-fly[1](#user-content-fn-1-4d7be28dd20ecdb626e5ea7c5c494700), and that is included as a part of **test fn**[2](#user-content-fn-2-4d7be28dd20ecdb626e5ea7c5c494700), which will be executed by libtest.\r\n> \r\n> That tells us why `build.jobs` (controls cargo-rustc jobserver) doesn't affect parallelism of doctest, but `--test-threads` does (controls parallelism of libtest).\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/97551/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/97551/timeline", "performed_via_github_app": null, "state_reason": null}