{"url": "https://api.github.com/repos/rust-lang/rust/issues/91991", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/91991/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/91991/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/91991/events", "html_url": "https://github.com/rust-lang/rust/issues/91991", "id": 1081762127, "node_id": "I_kwDOAAsO6M5AemFP", "number": 91991, "title": "Broken quote handling when spawning a process from a cmd script.", "user": {"login": "mwu-tow", "id": 1548407, "node_id": "MDQ6VXNlcjE1NDg0MDc=", "avatar_url": "https://avatars.githubusercontent.com/u/1548407?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mwu-tow", "html_url": "https://github.com/mwu-tow", "followers_url": "https://api.github.com/users/mwu-tow/followers", "following_url": "https://api.github.com/users/mwu-tow/following{/other_user}", "gists_url": "https://api.github.com/users/mwu-tow/gists{/gist_id}", "starred_url": "https://api.github.com/users/mwu-tow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mwu-tow/subscriptions", "organizations_url": "https://api.github.com/users/mwu-tow/orgs", "repos_url": "https://api.github.com/users/mwu-tow/repos", "events_url": "https://api.github.com/users/mwu-tow/events{/privacy}", "received_events_url": "https://api.github.com/users/mwu-tow/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}, {"id": 147085028, "node_id": "MDU6TGFiZWwxNDcwODUwMjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-nightly", "name": "regression-from-stable-to-nightly", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to nightly."}, {"id": 203429200, "node_id": "MDU6TGFiZWwyMDM0MjkyMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-high", "name": "P-high", "color": "eb6420", "default": false, "description": "High priority"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2021-12-16T04:35:10Z", "updated_at": "2021-12-23T05:17:45Z", "closed_at": "2021-12-23T05:17:45Z", "author_association": "NONE", "active_lock_reason": null, "body": "\r\n### Code\r\n\r\nI tried this code:\r\n\r\n```rust\r\npub fn greet(script_path: &std::path::Path, name: &str) -> std::io::Result<std::process::ExitStatus> {\r\n    std::process::Command::new(script_path)\r\n        .arg(name)\r\n        .spawn()?\r\n        .wait()\r\n}\r\n\r\npub fn main() -> std::io::Result<()> {\r\n    let script_path = std::env::temp_dir().join(\"hello.cmd\");\r\n    std::fs::write(&script_path, \"@echo Hello, %~1!\")?;\r\n    greet(&script_path, \"world\")?;\r\n    greet(&script_path, \"fellow Rustaceans\")?;\r\n    Ok(())\r\n}\r\n```\r\n\r\nI expected to see this happen:\r\n```\r\nHello, world!\r\nHello, fellow Rustaceans!\r\n```\r\n\r\nInstead, this happened:\r\n```\r\nHello, world!\r\n'C:\\Users\\mwurb\\AppData\\Local\\Temp\\hello.cmd\" \"fellow' is not recognized as an internal or external command,\r\noperable program or batch file.\r\n```\r\n\r\nThis is caused by different quote handling. \r\nThe first (correct) command line for the spawned process (as observed by `procmon`) is:\r\n```\r\nC:\\WINDOWS\\system32\\cmd.exe /c \"\"C:\\Users\\mwurb\\AppData\\Local\\Temp\\hello.cmd\" \"fellow Rustaceans\"\"\r\n```\r\n\r\nThe broken one is:\r\n```\r\nC:\\WINDOWS\\system32\\cmd.exe /c \"C:\\Users\\mwurb\\AppData\\Local\\Temp\\hello.cmd\" \"fellow Rustaceans\"\r\n```\r\n\r\nThe command for `cmd` must be in additional set of quotes, as the first and last one are stripped.\r\nIt works when there are no spaces in the arguments due to the exception rule, see https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/cmd#remarks\r\n\r\n### Version it worked on\r\nStable. It worked up until nightly-2021-11-20\r\n```\r\nrustc 1.58.0-nightly (a77da2d45 2021-11-19)\r\nbinary: rustc\r\ncommit-hash: a77da2d454e6caa227a85b16410b95f93495e7e0\r\ncommit-date: 2021-11-19\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.58.0-nightly\r\nLLVM version: 13.0.0     \r\n```\r\n\r\n### Version with regression\r\nnightly-2021-11-21\r\n```\r\nrustc 1.58.0-nightly (2885c4748 2021-11-20)\r\nbinary: rustc\r\ncommit-hash: 2885c474823637ae69c5967327327a337aebedb2\r\ncommit-date: 2021-11-20\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.58.0-nightly\r\nLLVM version: 13.0.0\r\n```\r\n\r\n@rustbot modify labels: +regression-from-stable-to-nightly -regression-untriaged", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/91991/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/91991/timeline", "performed_via_github_app": null, "state_reason": "completed"}