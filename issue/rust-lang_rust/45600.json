{"url": "https://api.github.com/repos/rust-lang/rust/issues/45600", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/45600/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/45600/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/45600/events", "html_url": "https://github.com/rust-lang/rust/issues/45600", "id": 269354561, "node_id": "MDU6SXNzdWUyNjkzNTQ1NjE=", "number": 45600, "title": "Pattern errors are too imprecise and should be removed in favor of MIR borrowck", "user": {"login": "comex", "id": 47517, "node_id": "MDQ6VXNlcjQ3NTE3", "avatar_url": "https://avatars.githubusercontent.com/u/47517?v=4", "gravatar_id": "", "url": "https://api.github.com/users/comex", "html_url": "https://github.com/comex", "followers_url": "https://api.github.com/users/comex/followers", "following_url": "https://api.github.com/users/comex/following{/other_user}", "gists_url": "https://api.github.com/users/comex/gists{/gist_id}", "starred_url": "https://api.github.com/users/comex/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/comex/subscriptions", "organizations_url": "https://api.github.com/users/comex/orgs", "repos_url": "https://api.github.com/users/comex/repos", "events_url": "https://api.github.com/users/comex/events{/privacy}", "received_events_url": "https://api.github.com/users/comex/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 171502053, "node_id": "MDU6TGFiZWwxNzE1MDIwNTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-borrow-checker", "name": "A-borrow-checker", "color": "f7e101", "default": false, "description": "Area: The borrow checker"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 419557634, "node_id": "MDU6TGFiZWw0MTk1NTc2MzQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-medium", "name": "E-medium", "color": "02e10c", "default": false, "description": "Call for participation: Experience needed to fix: Medium / intermediate"}, {"id": 604489711, "node_id": "MDU6TGFiZWw2MDQ0ODk3MTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-NLL", "name": "A-NLL", "color": "f7e101", "default": false, "description": "Area: Non Lexical Lifetimes (NLL)"}, {"id": 867465703, "node_id": "MDU6TGFiZWw4Njc0NjU3MDM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/NLL-complete", "name": "NLL-complete", "color": "f799ea", "default": false, "description": "Working towards the \"valid code works\" goal"}, {"id": 1795632126, "node_id": "MDU6TGFiZWwxNzk1NjMyMTI2", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-move_ref_pattern", "name": "F-move_ref_pattern", "color": "f9c0cc", "default": false, "description": "`#![feature(move_ref_pattern)]`"}], "state": "closed", "locked": false, "assignee": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 22, "created_at": "2017-10-28T22:21:19Z", "updated_at": "2020-02-09T07:11:54Z", "closed_at": "2020-02-09T07:11:54Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Update by @pnkfelix : \r\n\r\nNLL (aka MIR-borrowck) addresses the first case given in the issue, but not this one:\r\n\r\n```rust\r\nstruct Foo(String, String);\r\nfn x(f: Foo) {\r\n    match f {\r\n        Foo(a, ref b) => {} \r\n    }\r\n}\r\n```\r\n\r\nOriginal bug report follows\r\n\r\n---\r\n\r\nFor this code:\r\n```rust\r\nstruct Foo;\r\nfn main() {\r\n    match Foo {\r\n        x @ Foo if true => x,\r\n        _ => Foo,\r\n    };\r\n}\r\n```\r\n\r\nrustc produces:\r\n```\r\nerror[E0008]: cannot bind by-move into a pattern guard\r\n --> test.rs:4:9\r\n  |\r\n4 |         x @ Foo if true => x,\r\n  |         ^^^^^^^ moves value into pattern guard\r\n```\r\n\r\nThis error comes from `check_legality_of_move_bindings` in `librustc_const_eval/check_match.rs`.\r\n\r\nThe message is at least arguably incorrect: since `x` is not used in the pattern guard, it doesn't make much sense to claim that the code \"moves value into pattern guard\".\r\n\r\nI suppose you could argue that all bindings in a pattern are always moved/copied to the pattern guard, and the fact that this one is unused doesn't matter.  Under that interpretation, it's a matter of improving the error message, and this issue is a dupe of rust-lang/rfcs#684 which seeks to improve that error message in general.\r\n\r\nHowever, I think the code should be allowed, as it's not unsound.  I'm not too familiar with compiler internals, but it seems like once MIR borrow checking is finished, it would catch any actually-unsound moves into pattern guards, and this error could be removed altogether.  Is that correct?\r\n\r\nThe other two errors generated by `check_legality_of_move_bindings` have similar issues:\r\n\r\n1. \"cannot bind by-move with sub-bindings\"\r\n\r\nFor one thing, this error seems to be a subset of a different one from elsewhere in `check_match.rs`, \"pattern bindings are not allowed after an `@`\" - at least, I can't think of any code that would trigger this and not that. (Feel free to let me know what I'm missing.)  But in any case, this is overly conservative.  If we have\r\n```rust\r\nstruct Foo(i32);\r\n```\r\nthen it should be legal to match `x @ Foo(y)` (because `y` is `Copy`).  Again, this seems like something MIR borrowck might be able to handle better, although the frontend might have to make sure the copy comes from the right place (pre- or post-move).\r\n\r\n2. \"cannot bind by-move and by-ref in the same pattern\"\r\n\r\nI don't even know what this error is trying to prevent.  The following works fine even with the existing borrowck (`f` properly becomes a partially moved value):\r\n```rust\r\nstruct Foo(String, String);\r\nfn x(f: Foo) {\r\n    match f {\r\n        Foo(a, _) => {\r\n            let b = &f.1;\r\n        }\r\n    }\r\n}\r\n```\r\nSo what is wrong with putting b into the pattern?\r\n```rust\r\nfn x(f: Foo) {\r\n    match f {\r\n        Foo(a, ref b) => {}\r\n    }\r\n}\r\n```", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/45600/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/45600/timeline", "performed_via_github_app": null, "state_reason": "completed"}