{"url": "https://api.github.com/repos/rust-lang/rust/issues/97814", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/97814/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/97814/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/97814/events", "html_url": "https://github.com/rust-lang/rust/issues/97814", "id": 1262695831, "node_id": "I_kwDOAAsO6M5LQzWX", "number": 97814, "title": "Windows: Dynamically loaded functions may not be loaded before user pre-main initializers", "user": {"login": "ChrisDenton", "id": 4459874, "node_id": "MDQ6VXNlcjQ0NTk4NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChrisDenton", "html_url": "https://github.com/ChrisDenton", "followers_url": "https://api.github.com/users/ChrisDenton/followers", "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}", "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions", "organizations_url": "https://api.github.com/users/ChrisDenton/orgs", "repos_url": "https://api.github.com/users/ChrisDenton/repos", "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}", "received_events_url": "https://api.github.com/users/ChrisDenton/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123109, "node_id": "MDU6TGFiZWwxMjMxMDk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows", "name": "O-windows", "color": "6e6ec0", "default": false, "description": "Operating system: Windows"}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2022-06-07T04:09:51Z", "updated_at": "2022-07-19T18:59:35Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "first reported at https://github.com/estk/log4rs/issues/263 and https://github.com/mmastrac/rust-ctor/issues/219\r\n\r\n## The Problem\r\n\r\nOn Windows, code can run functions before main by using special link sections. Placing function pointers in `.CRT$XCU` allows the runtime to find and call the functions before it calls `main()`. [More info](https://docs.microsoft.com/en-us/cpp/c-runtime-library/crt-initialization?view=msvc-160).\r\n\r\nUser code can take advantage of this to do pre-main initializations. However, the standard library also uses this mechanism to dynamically load some essential functions on startup. This can be a problem because there is no guaranteed order to functions placed in `.CRT$XCU`. So initializers in the std may be run before, after or in between those created by user code. If a user's initializer happens to be run before the initializer that loads an essential function, it will act as though that function failed to load. This can cause errors or a panic.\r\n\r\n## Possible solutions\r\n\r\n* Load delayed imports using C initializers instead of C++ initializers. These C initializers will be run first.\r\n* Use the `.CRT$XCT` section as this will ensure functions run before those in the `.CRT$XCU` section. However, \"the names .CRT$XCT and .CRT$XCV aren't used by either the compiler or the CRT library right now, but there's no guarantee that they'll remain unused in the future\". [Source](https://docs.microsoft.com/en-us/cpp/c-runtime-library/crt-initialization?view=msvc-160#linker-features-for-initialization). I'm not sure it would matter if they were used for something as we don't rely on any features of the C or C++ runtimes when dynamically loading functions.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/97814/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/97814/timeline", "performed_via_github_app": null, "state_reason": null}