{"url": "https://api.github.com/repos/rust-lang/rust/issues/112355", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/112355/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/112355/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/112355/events", "html_url": "https://github.com/rust-lang/rust/issues/112355", "id": 1744361916, "node_id": "I_kwDOAAsO6M5n-Nm8", "number": 112355, "title": "add feature gate to permit measuring memory usage of dyn upcasting", "user": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668019, "node_id": "MDU6TGFiZWwyMTE2NjgwMTk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-lang", "name": "T-lang", "color": "bfd4f2", "default": false, "description": "Relevant to the language team, which will review and decide on the PR/issue."}, {"id": 1648796597, "node_id": "MDU6TGFiZWwxNjQ4Nzk2NTk3", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-trait_upcasting", "name": "F-trait_upcasting", "color": "f9c0cc", "default": false, "description": "`#![feature(trait_upcasting)]`"}], "state": "open", "locked": false, "assignee": {"login": "WaffleLapkin", "id": 38225716, "node_id": "MDQ6VXNlcjM4MjI1NzE2", "avatar_url": "https://avatars.githubusercontent.com/u/38225716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/WaffleLapkin", "html_url": "https://github.com/WaffleLapkin", "followers_url": "https://api.github.com/users/WaffleLapkin/followers", "following_url": "https://api.github.com/users/WaffleLapkin/following{/other_user}", "gists_url": "https://api.github.com/users/WaffleLapkin/gists{/gist_id}", "starred_url": "https://api.github.com/users/WaffleLapkin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/WaffleLapkin/subscriptions", "organizations_url": "https://api.github.com/users/WaffleLapkin/orgs", "repos_url": "https://api.github.com/users/WaffleLapkin/repos", "events_url": "https://api.github.com/users/WaffleLapkin/events{/privacy}", "received_events_url": "https://api.github.com/users/WaffleLapkin/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "WaffleLapkin", "id": 38225716, "node_id": "MDQ6VXNlcjM4MjI1NzE2", "avatar_url": "https://avatars.githubusercontent.com/u/38225716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/WaffleLapkin", "html_url": "https://github.com/WaffleLapkin", "followers_url": "https://api.github.com/users/WaffleLapkin/followers", "following_url": "https://api.github.com/users/WaffleLapkin/following{/other_user}", "gists_url": "https://api.github.com/users/WaffleLapkin/gists{/gist_id}", "starred_url": "https://api.github.com/users/WaffleLapkin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/WaffleLapkin/subscriptions", "organizations_url": "https://api.github.com/users/WaffleLapkin/orgs", "repos_url": "https://api.github.com/users/WaffleLapkin/repos", "events_url": "https://api.github.com/users/WaffleLapkin/events{/privacy}", "received_events_url": "https://api.github.com/users/WaffleLapkin/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2023-06-06T18:19:47Z", "updated_at": "2023-06-15T10:31:19Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "@WaffleLapkin is preparing a PR to permit measuring memory usage of dyn upcasting to help gather data for concerns raised in https://github.com/rust-lang/rust/issues/65991. The lang team is generally in favor of gathering data but we don't want to wait infinitely long. Opening this issue to track this work.\r\n\r\n## Instructions on how to measure trait upcasting effects on your codebase\r\n\r\nYou need a recent nightly compiler \u2014 2023-06-14 or newer.\r\n\r\nIf you are using `cargo`, run `cargo clean && RUSTFLAGS=\"-Zprint-vtable-sizes\" cargo check`. Note that `cargo clean` is required \u2014 without it caching will silence the output. If you are using `rustc` directly pass `-Zprint-vtable-sizes` to it.\r\n\r\nThe output will contain lines like these:\r\n```\r\nprint-vtable-sizes { \"crate_name\": \"num_traits\", \"trait_name\": \"RefNum\", \"entries\": \"23\", \"entries_ignoring_upcasting\": \"13\", \"entries_for_upcasting\": \"10\", \"upcasting_cost_percent\": \"76.92307692307693\" }\r\nprint-vtable-sizes { \"crate_name\": \"num_traits\", \"trait_name\": \"NumAssignOps\", \"entries\": \"12\", \"entries_ignoring_upcasting\": \"8\", \"entries_for_upcasting\": \"4\", \"upcasting_cost_percent\": \"50\" }\r\nprint-vtable-sizes { \"crate_name\": \"num_traits\", \"trait_name\": \"NumOps\", \"entries\": \"12\", \"entries_ignoring_upcasting\": \"8\", \"entries_for_upcasting\": \"4\", \"upcasting_cost_percent\": \"50\" }\r\nprint-vtable-sizes { \"crate_name\": \"num_traits\", \"trait_name\": \"cast::ToPrimitive\", \"entries\": \"17\", \"entries_ignoring_upcasting\": \"17\", \"entries_for_upcasting\": \"0\", \"upcasting_cost_percent\": \"0\" }\r\nprint-vtable-sizes { \"crate_name\": \"num_traits\", \"trait_name\": \"ops::inv::Inv\", \"entries\": \"4\", \"entries_ignoring_upcasting\": \"4\", \"entries_for_upcasting\": \"0\", \"upcasting_cost_percent\": \"0\" }\r\nprint-vtable-sizes { \"crate_name\": \"num_traits\", \"trait_name\": \"ops::mul_add::MulAdd\", \"entries\": \"4\", \"entries_ignoring_upcasting\": \"4\", \"entries_for_upcasting\": \"0\", \"upcasting_cost_percent\": \"0\" }\r\nprint-vtable-sizes { \"crate_name\": \"num_traits\", \"trait_name\": \"ops::mul_add::MulAddAssign\", \"entries\": \"4\", \"entries_ignoring_upcasting\": \"4\", \"entries_for_upcasting\": \"0\", \"upcasting_cost_percent\": \"0\" }\r\nprint-vtable-sizes { \"crate_name\": \"num_traits\", \"trait_name\": \"pow::Pow\", \"entries\": \"4\", \"entries_ignoring_upcasting\": \"4\", \"entries_for_upcasting\": \"0\", \"upcasting_cost_percent\": \"0\" }\r\n```\r\n\r\n`print-vtable-sizes` followed by a json describing vtable sizes. Json will contain the following fields:\r\n- `crate_name` \u2014 name of the crate which defines the traits\r\n- `trait_name` \u2014 path to the trait\r\n- `entries` \u2014 number of entries in a vtable with the current algorithm (i.e. with upcasting)\r\n- `entries_ignoring_upcasting` \u2014 number of entries in a vtable, as-if we did not have trait upcasting\r\n- `entries_for_upcasting` \u2014 number of entries in a vtable needed solely for upcasting (i.e. `entries - entries_ignoring_upcasting`).\r\n- `upcasting_cost_percent` \u2014 cost of having upcasting in % relative to the number of entries without upcasting (i.e. `entries_for_upcasting / entries_ignoring_upcasting * 100%`).\r\n\r\nLines are sorted by `upcasting_cost_percent`, so that the biggest % change is first.\r\n\r\nYou can collect and analyze these stats however your want.\r\n\r\nSome important notes:\r\n1. This includes private traits\r\n2. This includes traits that are not meant to be used as `dyn` and/or vtables of which are never actually instantiated\r\n3. For traits with generics/associated types this can produce slightly misleading stats (only making the change bigger than it actually is) \r\n4. This does not include traits which are not object safe", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/112355/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/112355/timeline", "performed_via_github_app": null, "state_reason": null}