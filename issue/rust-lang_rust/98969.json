{"url": "https://api.github.com/repos/rust-lang/rust/issues/98969", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/98969/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/98969/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/98969/events", "html_url": "https://github.com/rust-lang/rust/issues/98969", "id": 1295209108, "node_id": "I_kwDOAAsO6M5NM1KU", "number": 98969, "title": "Wasm export names cause duplicate symbols failure with libc non-exported names", "user": {"login": "anuraaga", "id": 198344, "node_id": "MDQ6VXNlcjE5ODM0NA==", "avatar_url": "https://avatars.githubusercontent.com/u/198344?v=4", "gravatar_id": "", "url": "https://api.github.com/users/anuraaga", "html_url": "https://github.com/anuraaga", "followers_url": "https://api.github.com/users/anuraaga/followers", "following_url": "https://api.github.com/users/anuraaga/following{/other_user}", "gists_url": "https://api.github.com/users/anuraaga/gists{/gist_id}", "starred_url": "https://api.github.com/users/anuraaga/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/anuraaga/subscriptions", "organizations_url": "https://api.github.com/users/anuraaga/orgs", "repos_url": "https://api.github.com/users/anuraaga/repos", "events_url": "https://api.github.com/users/anuraaga/events{/privacy}", "received_events_url": "https://api.github.com/users/anuraaga/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-07-06T05:59:32Z", "updated_at": "2022-07-06T05:59:32Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried this code:\r\n\r\n```rust\r\n#[cfg_attr(\r\nall(target_arch = \"wasm32\", target_os = \"wasi\"),\r\nexport_name = \"malloc\"\r\n)]\r\n#[no_mangle]\r\nextern \"C\" fn _malloc(len: usize) -> *mut u8 {\r\n    let align = std::mem::align_of::<usize>();\r\n    unsafe {\r\n        let layout = Layout::from_size_align_unchecked(len, align);\r\n        alloc(layout)\r\n    }\r\n}\r\n\r\n#[cfg_attr(\r\nall(target_arch = \"wasm32\", target_os = \"wasi\"),\r\nexport_name = \"free\"\r\n)]\r\n#[no_mangle]\r\nextern \"C\" fn _free(ptr: *mut u8, len: usize) {\r\n    let align = std::mem::align_of::<usize>();\r\n    unsafe {\r\n        let layout = Layout::from_size_align_unchecked(len, align);\r\n        dealloc(ptr, layout);\r\n    }\r\n}\r\n\r\n```\r\n\r\nI expected to see this happen: Building for `wasm32-wasi` works\r\n\r\nInstead, this happened: Build fails with duplicate symbols\r\n\r\n```\r\n  = note: rust-lld: error: duplicate symbol: malloc\r\n          >>> defined in /Users/anuraag/git/wasm-rust/target/wasm32-wasi/debug/deps/libwasm_rust_sdk-aebe23ac30b542fa.rlib(wasm_rust_sdk-aebe23ac30b542fa.r6zw0iop317lob6.rcgu.o)\r\n          >>> defined in /Users/anuraag/.rustup/toolchains/stable-aarch64-apple-darwin/lib/rustlib/wasm32-wasi/lib/self-contained/libc.a(dlmalloc.o)\r\n```\r\n\r\n### Meta\r\n\r\nI can use different names for the functions but it can make the host more complicated when supporting other wasm compilers like TinyGo where the names for allocation functions can't be changed. It would be nice to be able to use these specific names in Rust, and because the libc `malloc` and `free` aren't wasm exports, I don't think there should technically be any duplicate symbol problem, especially with the rust function names being different.\r\n\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.61.0 (fe5b13d68 2022-05-18)\r\nbinary: rustc\r\ncommit-hash: fe5b13d681f25ee6474be29d748c65adcd91f69e\r\ncommit-date: 2022-05-18\r\nhost: aarch64-apple-darwin\r\nrelease: 1.61.0\r\nLLVM version: 14.0.0\r\n```\r\n\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/98969/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/98969/timeline", "performed_via_github_app": null, "state_reason": null}