{"url": "https://api.github.com/repos/rust-lang/rust/issues/106993", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/106993/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/106993/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/106993/events", "html_url": "https://github.com/rust-lang/rust/issues/106993", "id": 1536809266, "node_id": "I_kwDOAAsO6M5bmdky", "number": 106993, "title": "On `-> impl Iterator<Item = Ty>` point at method chains in returned expression where `Item` might have diverged", "user": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234876, "node_id": "MDU6TGFiZWwyMzQ4NzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-hard", "name": "E-hard", "color": "02e10c", "default": false, "description": "Call for participation: Experience needed to fix: Hard / a lot"}, {"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2023-01-17T18:01:59Z", "updated_at": "2023-05-28T15:09:27Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "### Code\n\n```Rust\nfn foo(items: &mut Vec<u8>){\n    items.sort();\n}\n\nfn bar() -> impl Iterator<Item = i32> {\n    let mut x: Vec<Vec<u8>> = vec![\n        vec![0, 2, 1],\n        vec![5, 4, 3],\n    ];\n    x.iter_mut().map(foo)\n}\n\nfn main() {\n    bar();\n}\n```\n\n\n### Current output\n\n```Shell\nerror[E0271]: expected `for<'a> fn(&'a mut Vec<u8>) {foo}` to be a fn item that returns `i32`, but it returns `()`\n --> src/main.rs:5:13\n  |\n5 | fn bar() -> impl Iterator<Item = i32> {\n  |             ^^^^^^^^^^^^^^^^^^^^^^^^^ expected `()`, found `i32`\n  |\n  = note: required for `Map<std::slice::IterMut<'_, Vec<u8>>, for<'a> fn(&'a mut Vec<u8>) {foo}>` to implement `Iterator`\n```\n\n\n### Desired output\n\n```Shell\nerror[E0271]: expected `for<'a> fn(&'a mut Vec<u8>) {foo}` to be a fn item that returns `i32`, but it returns `()`\n  --> src/main.rs:5:13\n   |\nLL | fn bar() -> impl Iterator<Item = i32> {\n   |             ^^^^^^^^^^^^^^^^^^^^^^^^^ expected `()`, found `i32`\n   |\n   = note: required for `Map<std::slice::IterMut<'_, Vec<u8>>, for<'a> fn(&'a mut Vec<u8>) {foo}>` to implement `Iterator`\nnote: the method call chain might not have had the expected associated types\n  --> src/main.rs:10:18\n   |\nLL |       let mut x: Vec<Vec<u8>> = vec![\n   |  _______________________________-\nLL | |         vec![0, 2, 1],\nLL | |         vec![5, 4, 3],\nLL | |     ];\n   | |_____- this expression has type `Vec<Vec<u8>>`\nLL |       x.iter_mut().map(foo)\n   |         ---------- ^^^^^^^^ `Iterator::Item` changed to `()` here\n   |         |\n   |         `Iterator::Item` is `&mut Vec<u8>` here\n```\n\n\n### Rationale and extra context\n\nSimilar to what we do on [method calls](https://play.rust-lang.org/?version=nightly&mode=debug&edition=2021&gist=f35fa021664bf66f625ca943dc972c7c), introduced in https://github.com/rust-lang/rust/pull/105332 and https://github.com/rust-lang/rust/pull/105674:\n\n```\nerror[E0277]: a value of type `Vec<i32>` cannot be built from an iterator over elements of type `()`\n  --> src/main.rs:10:27\n   |\n10 |     x.iter_mut().map(foo).collect::<Vec<i32>>();\n   |                           ^^^^^^^ value of type `Vec<i32>` cannot be built from `std::iter::Iterator<Item=()>`\n   |\n   = help: the trait `FromIterator<()>` is not implemented for `Vec<i32>`\n   = help: the trait `FromIterator<T>` is implemented for `Vec<T>`\nnote: the method call chain might not have had the expected associated types\n  --> src/main.rs:10:18\n   |\n6  |       let mut x: Vec<Vec<u8>> = vec![\n   |  _______________________________-\n7  | |         vec![0, 2, 1],\n8  | |         vec![5, 4, 3],\n9  | |     ];\n   | |_____- this expression has type `Vec<Vec<u8>>`\n10 |       x.iter_mut().map(foo).collect::<Vec<i32>>();\n   |         ---------- ^^^^^^^^ `Iterator::Item` changed to `()` here\n   |         |\n   |         `Iterator::Item` is `&mut Vec<u8>` here\nnote: required by a bound in `collect`\n  --> /rustc/4781233a77e879e49cb5ce3c98d2abba6a6ade7a/library/core/src/iter/traits/iterator.rs:1856:5\n```\n\n### Other cases\n\n_No response_\n\n### Anything else?\n\n_No response_\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"obeis\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/106993/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/106993/timeline", "performed_via_github_app": null, "state_reason": null}