{"url": "https://api.github.com/repos/rust-lang/rust/issues/59220", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/59220/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/59220/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/59220/events", "html_url": "https://github.com/rust-lang/rust/issues/59220", "id": 421706670, "node_id": "MDU6SXNzdWU0MjE3MDY2NzA=", "number": 59220, "title": "format_args! with certain arguments segfaults at run-time on x86_64-unknown-linux-gnux32", "user": {"login": "tormol", "id": 10460821, "node_id": "MDQ6VXNlcjEwNDYwODIx", "avatar_url": "https://avatars.githubusercontent.com/u/10460821?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tormol", "html_url": "https://github.com/tormol", "followers_url": "https://api.github.com/users/tormol/followers", "following_url": "https://api.github.com/users/tormol/following{/other_user}", "gists_url": "https://api.github.com/users/tormol/gists{/gist_id}", "starred_url": "https://api.github.com/users/tormol/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tormol/subscriptions", "organizations_url": "https://api.github.com/users/tormol/orgs", "repos_url": "https://api.github.com/users/tormol/repos", "events_url": "https://api.github.com/users/tormol/events{/privacy}", "received_events_url": "https://api.github.com/users/tormol/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1275174955, "node_id": "MDU6TGFiZWwxMjc1MTc0OTU1", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-x32", "name": "O-x32", "color": "6e6ec0", "default": false, "description": "x32 ABI"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2019-03-15T21:13:54Z", "updated_at": "2021-03-05T11:37:02Z", "closed_at": "2021-03-05T11:37:02Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Trying to display most types causes a segmentation fault at run time when compiled in debug mode for x32 ABI\r\n\r\nExample:\r\n```sh\r\necho 'fn main() { println!(\"{}\", 0); }' | rustc --target x86_64-unknown-linux-gnux32 -\r\n./rust_out\r\nSegmentation fault (core dumped)\r\n```\r\n\r\n* `println!`, `format!` and `format_args!` equally affected, `.to_string()` is not.\r\n* Only happens in debug mode, works fine in release mode.\r\n* Happens with all integer types from `i8` to `u128`, `f32`, `f64`, `bool`, `char` and `fmt::Argument`, but not with references to those types or `str`, `String` and raw pointers.\r\n* Debug and pointer formatting (`\"{:?}\"`, `\"{:#?}\"` and `\"{:p}\"`) are not affect, but all other format traits (`\"{:x}\"`, `\"{:02}\", `\"{:#b}\"`) all result in a segfault.\r\n\r\n<details>\r\n <summary>Debugging attempt & assembly</summary>\r\n\r\nThe segfault happens at the second instruction in main;\r\nhere's what that area looks like with `... --emit asm`:\r\n\r\n```asm\r\n_ZN8rust_out4main17h19287f9e3b324627E:\r\n\t.cfi_startproc\r\n\tsubl\t$72, %esp\r\n\t.cfi_def_cfa_offset 80\r\n\tmovl\t_ZN4core3fmt3num52_$LT$impl$u20$core..fmt..Display$u20$for$u20$i32$GT$3fmt17ha3b2ffd94f72c608E@GOTPCREL, %esi\r\n\tleal\t.L__unnamed_2(%rip), %eax\r\n\tmovl\t%eax, 68(%esp)\r\n\tmovl\t68(%esp), %edi\r\n\tcallq\t_ZN4core3fmt10ArgumentV13new17hfeb1c719432004d8E\r\n\tmovl\t%eax, 28(%esp)\r\n\tmovl\t%edx, 24(%esp)\r\n-- snip\r\n```\r\n\r\nand after disassembling: (`objcopy -dr rust_out | rg -A10 'rust_out.*?main'`\r\n```asm\r\n00002610 <_ZN8rust_out4main17h19287f9e3b324627E>:\r\n    2610:\t83 ec 48             \tsub    $0x48,%esp\r\n    2613:\t8b 34 25 aa 49 22 00 \tmov    0x2249aa,%esi\r\n    261a:\t8d 05 84 9a 01 00    \tlea    0x19a84(%rip),%eax        # 1c0a4 <_fini+0x10>\r\n    2620:\t67 89 44 24 44       \tmov    %eax,0x44(%esp)\r\n    2625:\t67 8b 7c 24 44       \tmov    0x44(%esp),%edi\r\n    262a:\te8 81 fe ff ff       \tcallq  24b0 <_ZN4core3fmt10ArgumentV13new17hfeb1c719432004d8E>\r\n    262f:\t67 89 44 24 1c       \tmov    %eax,0x1c(%esp)\r\n    2634:\t67 89 54 24 18       \tmov    %edx,0x18(%esp)\r\n    2639:\t8d 05 c1 36 22 00    \tlea    0x2236c1(%rip),%eax        # 225d00 <debug_section_names+0x40>\r\n    263f:\t8d 0d 63 9a 01 00    \tlea    0x19a63(%rip),%ecx        # 1c0a8 <_fini+0x14>\r\n-- snip\r\n```\r\n\r\nWith `-O` the compiler emits\r\n```asm\r\n72:_ZN8rust_out4main17h19287f9e3b324627E:\r\n73-\t.cfi_startproc\r\n74-\tsubl\t$40, %esp\r\n75-\t.cfi_def_cfa_offset 48\r\n76-\tleal\t.L__unnamed_2(%rip), %eax\r\n77-\tmovl\t%eax, 8(%esp)\r\n78-\tmovl\t_ZN4core3fmt3num52_$LT$impl$u20$core..fmt..Display$u20$for$u20$i32$GT$3fmt17ha3b2ffd94f72c608E@GOTPCREL(%rip), %eax\r\n79-\tmovl\t%eax, 12(%esp)\r\n80-\tleal\t.L__unnamed_3(%rip), %eax\r\n81-\tmovl\t%eax, 16(%esp)\r\n82-\tmovl\t$2, 20(%esp)\r\n-- snip\r\n```\r\n\r\nFor `println!(\"{:?}\", 0)`:\r\n```asm\r\n314:_ZN8rust_out4main17h19287f9e3b324627E:\r\n315-\t.cfi_startproc\r\n316-\tsubl\t$72, %esp\r\n317-\t.cfi_def_cfa_offset 80\r\n318-\tleal\t.L__unnamed_2(%rip), %eax\r\n319-\tmovl\t%eax, 68(%esp)\r\n320-\tmovl\t68(%esp), %edi\r\n321-\tleal\t_ZN4core3fmt3num50_$LT$impl$u20$core..fmt..Debug$u20$for$u20$i32$GT$3fmt17had225e6626567b7bE(%rip), %esi\r\n322-\tcallq\t_ZN4core3fmt10ArgumentV13new17hfeb1c719432004d8E\r\n323-\tmovl\t%eax, 28(%esp)\r\n324-\tmovl\t%edx, 24(%esp)\r\n-- snip\r\n```\r\n\r\nand for `println!(\"{}\", &0)`\r\n```asm\r\n268:_ZN8rust_out4main17h19287f9e3b324627E:\r\n269-\t.cfi_startproc\r\n270-\tsubl\t$72, %esp\r\n271-\t.cfi_def_cfa_offset 80\r\n272-\tleal\t.L__unnamed_2(%rip), %eax\r\n273-\tmovl\t%eax, 68(%esp)\r\n274-\tmovl\t68(%esp), %edi\r\n275-\tleal\t_ZN44_$LT$$RF$T$u20$as$u20$core..fmt..Display$GT$3fmt17h1aa6d8d315ee6bb6E(%rip), %esi\r\n276-\tcallq\t_ZN4core3fmt10ArgumentV13new17h122dce191cc0b572E\r\n277-\tmovl\t%eax, 28(%esp)\r\n278-\tmovl\t%edx, 24(%esp)\r\n-- snip\r\n```\r\n</details>\r\n\r\n## Meta\r\n```\r\nrustc 1.33.0 (2aa4c46cf 2019-02-28)\r\nbinary: rustc\r\ncommit-hash: 2aa4c46cfdd726e97360c2734835aa3515e8c858\r\ncommit-date: 2019-02-28\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.33.0\r\nLLVM version: 8.0\r\n```", "closed_by": {"login": "sanxiyn", "id": 45249, "node_id": "MDQ6VXNlcjQ1MjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/45249?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sanxiyn", "html_url": "https://github.com/sanxiyn", "followers_url": "https://api.github.com/users/sanxiyn/followers", "following_url": "https://api.github.com/users/sanxiyn/following{/other_user}", "gists_url": "https://api.github.com/users/sanxiyn/gists{/gist_id}", "starred_url": "https://api.github.com/users/sanxiyn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sanxiyn/subscriptions", "organizations_url": "https://api.github.com/users/sanxiyn/orgs", "repos_url": "https://api.github.com/users/sanxiyn/repos", "events_url": "https://api.github.com/users/sanxiyn/events{/privacy}", "received_events_url": "https://api.github.com/users/sanxiyn/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/59220/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/59220/timeline", "performed_via_github_app": null, "state_reason": "completed"}