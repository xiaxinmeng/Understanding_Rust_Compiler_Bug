{"url": "https://api.github.com/repos/rust-lang/rust/issues/63977", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/63977/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/63977/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/63977/events", "html_url": "https://github.com/rust-lang/rust/issues/63977", "id": 486452135, "node_id": "MDU6SXNzdWU0ODY0NTIxMzU=", "number": 63977, "title": "Weird segfault when trying inline asm on macOS in Rust", "user": {"login": "luojia65", "id": 40385009, "node_id": "MDQ6VXNlcjQwMzg1MDA5", "avatar_url": "https://avatars.githubusercontent.com/u/40385009?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luojia65", "html_url": "https://github.com/luojia65", "followers_url": "https://api.github.com/users/luojia65/followers", "following_url": "https://api.github.com/users/luojia65/following{/other_user}", "gists_url": "https://api.github.com/users/luojia65/gists{/gist_id}", "starred_url": "https://api.github.com/users/luojia65/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luojia65/subscriptions", "organizations_url": "https://api.github.com/users/luojia65/orgs", "repos_url": "https://api.github.com/users/luojia65/repos", "events_url": "https://api.github.com/users/luojia65/events{/privacy}", "received_events_url": "https://api.github.com/users/luojia65/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123111, "node_id": "MDU6TGFiZWwxMjMxMTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-macos", "name": "O-macos", "color": "6e6ec0", "default": false, "description": "Operating system: macOS"}, {"id": 91598611, "node_id": "MDU6TGFiZWw5MTU5ODYxMQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-inline-assembly", "name": "A-inline-assembly", "color": "f7e101", "default": false, "description": "Area: inline asm!(..)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2019-08-28T15:25:08Z", "updated_at": "2020-05-23T01:33:52Z", "closed_at": "2020-05-23T01:33:52Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Hello! I tried this piece of code:\r\n```Rust\r\n#![feature(asm)]\r\n\r\nfn main() {\r\n    unsafe { asm!(\"\r\n        xor rax, rax\r\n    .process_loop:  \r\n        nop\r\n        add rax, 1\r\n        cmp rax, 500\r\n        jne .process_loop\r\n    \":\r\n    :\r\n    :\"rax\"\r\n    :\"intel\") };\r\n}\r\n```\r\nOn windows it compiles and runs normally. On my macOS it compiles with no error or warning output, but fired an output `Segmentation fault: 11` when I try to execute the output binary file.\r\nI tried IDA pro on both operating systems. If I compile this code in windows, the IDA gave me normal disassemble output I expected:\r\n![05292521505F9DA99853DC9222386FE8](https://user-images.githubusercontent.com/40385009/63868950-f8307900-c9e9-11e9-8afa-a1edafe36e2f.png)\r\nBut when I compile on macOS (for as default, a Mach-O binary file), it gave me this with weird `nop` lines and a red mark meaning there was something wrong:\r\n![C32586C63ED3FDE98899C2873BED237D](https://user-images.githubusercontent.com/40385009/63869285-7260fd80-c9ea-11e9-9590-63b118f12634.jpg)\r\nWhat can cause this error and is there what I can do to fix this problem? Thanks!\r\n\r\nFYI, my mac is `iMac (Retina 5K, 27-inch, 2017)`.\r\nThe `uname -a` output:\r\n```\r\nmacdeiMac:~ mac$ uname -a\r\nDarwin macdeiMac.local 18.7.0 Darwin Kernel Version 18.7.0: Thu Jun 20 18:42:21 PDT 2019; root:xnu-4903.270.47~4/RELEASE_X86_64 x86_64\r\n```\r\nThe `rustc -V` output:\r\n```\r\nmacdeiMac:~ mac$ rustc -V\r\nrustc 1.38.0-nightly (0b680cfce 2019-07-09)\r\n```\r\nThe `sysctl machdep.cpu` output:\r\n<details>\r\n<summary>Click to expand</summary>\r\n<pre>\r\nmacdeiMac:~ mac$ sysctl machdep.cpu\r\nmachdep.cpu.max_basic: 22\r\nmachdep.cpu.max_ext: 2147483656\r\nmachdep.cpu.vendor: GenuineIntel\r\nmachdep.cpu.brand_string: Intel(R) Core(TM) i5-7500 CPU @ 3.40GHz\r\nmachdep.cpu.family: 6\r\nmachdep.cpu.model: 158\r\nmachdep.cpu.extmodel: 9\r\nmachdep.cpu.extfamily: 0\r\nmachdep.cpu.stepping: 9\r\nmachdep.cpu.feature_bits: 9221960262849657855\r\nmachdep.cpu.leaf7_feature_bits: 43806655 0\r\nmachdep.cpu.leaf7_feature_bits_edx: 2617254912\r\nmachdep.cpu.extfeature_bits: 1241984796928\r\nmachdep.cpu.signature: 591593\r\nmachdep.cpu.brand: 0\r\nmachdep.cpu.features: FPU VME DE PSE TSC MSR PAE MCE CX8 APIC SEP MTRR PGE MCA CMOV PAT PSE36 CLFSH DS ACPI MMX FXSR SSE SSE2 SS HTT TM PBE SSE3 PCLMULQDQ DTES64 MON DSCPL VMX SMX EST TM2 SSSE3 FMA CX16 TPR PDCM SSE4.1 SSE4.2 x2APIC MOVBE POPCNT AES PCID XSAVE OSXSAVE SEGLIM64 TSCTMR AVX1.0 RDRAND F16C\r\nmachdep.cpu.leaf7_features: RDWRFSGS TSC_THREAD_OFFSET SGX BMI1 HLE AVX2 SMEP BMI2 ERMS INVPCID RTM FPU_CSDS MPX RDSEED ADX SMAP CLFSOPT IPT MDCLEAR TSXFA IBRS STIBP L1DF SSBD\r\nmachdep.cpu.extfeatures: SYSCALL XD 1GBPAGE EM64T LAHF LZCNT PREFETCHW RDTSCP TSCI\r\nmachdep.cpu.logical_per_package: 16\r\nmachdep.cpu.cores_per_package: 8\r\nmachdep.cpu.microcode_version: 180\r\nmachdep.cpu.processor_flag: 1\r\nmachdep.cpu.mwait.linesize_min: 64\r\nmachdep.cpu.mwait.linesize_max: 64\r\nmachdep.cpu.mwait.extensions: 3\r\nmachdep.cpu.mwait.sub_Cstates: 1319200\r\nmachdep.cpu.thermal.sensor: 1\r\nmachdep.cpu.thermal.dynamic_acceleration: 1\r\nmachdep.cpu.thermal.invariant_APIC_timer: 1\r\nmachdep.cpu.thermal.thresholds: 2\r\nmachdep.cpu.thermal.ACNT_MCNT: 1\r\nmachdep.cpu.thermal.core_power_limits: 1\r\nmachdep.cpu.thermal.fine_grain_clock_mod: 1\r\nmachdep.cpu.thermal.package_thermal_intr: 1\r\nmachdep.cpu.thermal.hardware_feedback: 0\r\nmachdep.cpu.thermal.energy_policy: 1\r\nmachdep.cpu.xsave.extended_state: 31 832 1088 0\r\nmachdep.cpu.xsave.extended_state1: 15 832 256 0\r\nmachdep.cpu.arch_perf.version: 4\r\nmachdep.cpu.arch_perf.number: 8\r\nmachdep.cpu.arch_perf.width: 48\r\nmachdep.cpu.arch_perf.events_number: 7\r\nmachdep.cpu.arch_perf.events: 0\r\nmachdep.cpu.arch_perf.fixed_number: 3\r\nmachdep.cpu.arch_perf.fixed_width: 48\r\nmachdep.cpu.cache.linesize: 64\r\nmachdep.cpu.cache.L2_associativity: 4\r\nmachdep.cpu.cache.size: 256\r\nmachdep.cpu.tlb.inst.large: 8\r\nmachdep.cpu.tlb.data.small: 64\r\nmachdep.cpu.tlb.data.small_level1: 128\r\nmachdep.cpu.address_bits.physical: 39\r\nmachdep.cpu.address_bits.virtual: 48\r\nmachdep.cpu.core_count: 4\r\nmachdep.cpu.thread_count: 4\r\nmachdep.cpu.tsc_ccc.numerator: 284\r\nmachdep.cpu.tsc_ccc.denominator: 2\r\n</pre>\r\n</details>\r\n", "closed_by": {"login": "Amanieu", "id": 278509, "node_id": "MDQ6VXNlcjI3ODUwOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/278509?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Amanieu", "html_url": "https://github.com/Amanieu", "followers_url": "https://api.github.com/users/Amanieu/followers", "following_url": "https://api.github.com/users/Amanieu/following{/other_user}", "gists_url": "https://api.github.com/users/Amanieu/gists{/gist_id}", "starred_url": "https://api.github.com/users/Amanieu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Amanieu/subscriptions", "organizations_url": "https://api.github.com/users/Amanieu/orgs", "repos_url": "https://api.github.com/users/Amanieu/repos", "events_url": "https://api.github.com/users/Amanieu/events{/privacy}", "received_events_url": "https://api.github.com/users/Amanieu/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/63977/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/63977/timeline", "performed_via_github_app": null, "state_reason": "completed"}