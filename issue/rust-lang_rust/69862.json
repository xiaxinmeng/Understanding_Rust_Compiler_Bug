{"url": "https://api.github.com/repos/rust-lang/rust/issues/69862", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/69862/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/69862/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/69862/events", "html_url": "https://github.com/rust-lang/rust/issues/69862", "id": 578043357, "node_id": "MDU6SXNzdWU1NzgwNDMzNTc=", "number": 69862, "title": "libstd: `File::open` uses `O_CLOEXEC` on platforms where it is unsupported", "user": {"login": "Tyg13", "id": 25281, "node_id": "MDQ6VXNlcjI1Mjgx", "avatar_url": "https://avatars.githubusercontent.com/u/25281?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Tyg13", "html_url": "https://github.com/Tyg13", "followers_url": "https://api.github.com/users/Tyg13/followers", "following_url": "https://api.github.com/users/Tyg13/following{/other_user}", "gists_url": "https://api.github.com/users/Tyg13/gists{/gist_id}", "starred_url": "https://api.github.com/users/Tyg13/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Tyg13/subscriptions", "organizations_url": "https://api.github.com/users/Tyg13/orgs", "repos_url": "https://api.github.com/users/Tyg13/repos", "events_url": "https://api.github.com/users/Tyg13/events{/privacy}", "received_events_url": "https://api.github.com/users/Tyg13/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 123110, "node_id": "MDU6TGFiZWwxMjMxMTA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-linux", "name": "O-linux", "color": "6e6ec0", "default": false, "description": "Operating system: Linux"}, {"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2020-03-09T16:45:01Z", "updated_at": "2020-03-09T22:52:30Z", "closed_at": "2020-03-09T22:49:46Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I was originally trying to install the latest Rust stable on `Linux 2.6.18-8.el5 i686` (CC [rustup#2254](https://github.com/rust-lang/rustup/issues/2254)), and failing when `RUSTUP_HOME` or `CARGO_HOME` were set to my NFS mount (which uses 64 bit inodes).\r\n\r\nThis led me to (erroneously) file a bug with `libc` (CC [libc#1679](https://github.com/rust-lang/libc/issues/1679)), thinking that it was an issue with 64 bit inode support wherein `libc` did not call the 64-bit version of `stat` and friends. This was not the case: running `strace -f rustup update` led me to find this curious sequence of syscalls in the trace output:\r\n\r\n<details>\r\n    <summary>strace.log</summary>\r\n\r\n```\r\n...\r\nopen(\"/usr/share/terminfo/x/xterm\", O_RDONLY|O_LARGEFILE|0x80000) = 3\r\nfcntl64(3, F_GETFD)                     = 0\r\nfcntl64(3, F_SETFD, FD_CLOEXEC)         = 0\r\nread(3, \"\\32\\0010\\0&\\0\\17\\0\\235\\0014\\5xterm|xterm terminal\"..., 8192) = 2472\r\nclose(3)                                = 0\r\ngetcwd(\"/home/LOCAL/tla/build/libc\", 512) = 27\r\nstat64(\"/home/LOCAL/tla/.local/.rustup\", {st_mode=S_IFDIR|0755, st_size=27, ...}) = 0\r\nstat64(\"/home/LOCAL/tla/.local/.rustup/settings.toml\", {st_mode=S_IFREG|0644, st_size=48, ...}) = 0\r\nopen(\"/home/LOCAL/tla/.local/.rustup/settings.toml\", O_RDONLY|O_LARGEFILE|0x80000) = -530\r\n...\r\n```\r\n</details>\r\n\r\nAs you can see: we are passing `0x80000 = O_CLOEXEC` to the `open` call, which leads to an error code when the file in question is on the NFS mount (or perhaps it's a symlink issue -- `/home/LOCAL/tla/.local/` is actually a symlink to a directory on the NFS mount). Reproducing the above sequence of syscalls with a small test program written in C shows that this `open` call only fails when the erroneous `O_CLOEXEC` argument is passed.\r\n\r\nIt is my suspicion that [this line](https://github.com/rust-lang/rust/blob/master/src/libstd/sys/unix/fs.rs#L680) is the culprit. Comments there suggest that passing this flag on systems where it is unsupported (such as mine) will have no effect. I don't know enough about how the `open` syscall works to confirm, but it appears that is not the case with my configuration.", "closed_by": {"login": "Tyg13", "id": 25281, "node_id": "MDQ6VXNlcjI1Mjgx", "avatar_url": "https://avatars.githubusercontent.com/u/25281?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Tyg13", "html_url": "https://github.com/Tyg13", "followers_url": "https://api.github.com/users/Tyg13/followers", "following_url": "https://api.github.com/users/Tyg13/following{/other_user}", "gists_url": "https://api.github.com/users/Tyg13/gists{/gist_id}", "starred_url": "https://api.github.com/users/Tyg13/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Tyg13/subscriptions", "organizations_url": "https://api.github.com/users/Tyg13/orgs", "repos_url": "https://api.github.com/users/Tyg13/repos", "events_url": "https://api.github.com/users/Tyg13/events{/privacy}", "received_events_url": "https://api.github.com/users/Tyg13/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/69862/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/69862/timeline", "performed_via_github_app": null, "state_reason": "completed"}