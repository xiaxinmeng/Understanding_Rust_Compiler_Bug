{"url": "https://api.github.com/repos/rust-lang/rust/issues/74393", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/74393/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/74393/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/74393/events", "html_url": "https://github.com/rust-lang/rust/issues/74393", "id": 658172986, "node_id": "MDU6SXNzdWU2NTgxNzI5ODY=", "number": 74393, "title": "cc long double targeting wasm32-wasi links incorrectly", "user": {"login": "TjeuKayim", "id": 15987676, "node_id": "MDQ6VXNlcjE1OTg3Njc2", "avatar_url": "https://avatars.githubusercontent.com/u/15987676?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TjeuKayim", "html_url": "https://github.com/TjeuKayim", "followers_url": "https://api.github.com/users/TjeuKayim/followers", "following_url": "https://api.github.com/users/TjeuKayim/following{/other_user}", "gists_url": "https://api.github.com/users/TjeuKayim/gists{/gist_id}", "starred_url": "https://api.github.com/users/TjeuKayim/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TjeuKayim/subscriptions", "organizations_url": "https://api.github.com/users/TjeuKayim/orgs", "repos_url": "https://api.github.com/users/TjeuKayim/repos", "events_url": "https://api.github.com/users/TjeuKayim/events{/privacy}", "received_events_url": "https://api.github.com/users/TjeuKayim/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 474645165, "node_id": "MDU6TGFiZWw0NzQ2NDUxNjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-wasm", "name": "O-wasm", "color": "6e6ec0", "default": false, "description": "Target: WASM (WebAssembly), http://webassembly.org/"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2020-07-16T12:55:35Z", "updated_at": "2022-08-31T05:50:45Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "A Rust crate with C dependency that uses `long double` targeting `wasm32-wasi` links incorrectly, while clang can compile such programs to WebAssembly.\r\n\r\nI tried this code:\r\n\r\n```rust\r\n// main.rs\r\nfn main() {\r\n    unsafe { print_long_double() };\r\n}\r\nextern \"C\" {\r\n    fn print_long_double();\r\n}\r\n// build.rs\r\ncc::Build::new()\r\n    .file(\"src/foo.c\")\r\n    .include(\"src\")\r\n    .compile(\"foo\");\r\n```\r\n\r\n```c\r\n// foo.c\r\nvoid print_long_double() {\r\n    srand(0);\r\n    long double x = rand();\r\n    printf(\"x = %Lf\\n\", x);\r\n}\r\n```\r\n\r\n```sh\r\nexport CC_wasm32_wasi=/opt/wasi-sdk/bin/clang\r\nexport CARGO_TARGET_WASM32_WASI_LINKER=/opt/wasi-sdk/bin/clang\r\nexport RUSTFLAGS='-C target-feature=-crt-static -C link-arg=-lc-printscan-long-double'\r\ncargo build --target wasm32-wasi\r\nwasmtime target/wasm32-wasi/debug/long-double.wasm\r\n```\r\n\r\nI expected to see this happen: the program should run and print a random number, just like when I compile with clang.\r\n\r\nInstead, this happened:\r\n\r\n```\r\nError: failed to run main module `target/wasm32-wasi/debug/long-double.wasm`\r\n\r\nCaused by:\r\n    0: failed to instantiate \"target/wasm32-wasi/debug/long-double.wasm\"\r\n    1: unknown import: `env::__floatsitf` has not been defined\r\n```\r\n\r\nSimple repo to **reproduce with Docker**: https://github.com/TjeuKayim/wasi-long-double\r\n\r\n### Motivation\r\n\r\nI tried to compile rusqlite to WASI following the instructions at https://doc.rust-lang.org/nightly/nightly-rustc/rustc_target/spec/wasm32_wasi/index.html. This was one of the issues I ran into. A work-around is to pass this flag `-DLONGDOUBLE_TYPE=double`. The weird thing is that when I compile sqlite with clang and wasi-sdk, it compiles and runs correctly. Also, other projects manage to compile sqlite to WebAssembly, like https://wapm.io/package/sqlite#shell.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/74393/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/74393/timeline", "performed_via_github_app": null, "state_reason": null}