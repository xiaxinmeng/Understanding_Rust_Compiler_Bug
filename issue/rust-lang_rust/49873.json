{"url": "https://api.github.com/repos/rust-lang/rust/issues/49873", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/49873/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/49873/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/49873/events", "html_url": "https://github.com/rust-lang/rust/issues/49873", "id": 313290372, "node_id": "MDU6SXNzdWUzMTMyOTAzNzI=", "number": 49873, "title": "Rust 1.25.0 regressed the performance of encoding_rs's UTF-8 validation on i686", "user": {"login": "hsivonen", "id": 478856, "node_id": "MDQ6VXNlcjQ3ODg1Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/478856?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hsivonen", "html_url": "https://github.com/hsivonen", "followers_url": "https://api.github.com/users/hsivonen/followers", "following_url": "https://api.github.com/users/hsivonen/following{/other_user}", "gists_url": "https://api.github.com/users/hsivonen/gists{/gist_id}", "starred_url": "https://api.github.com/users/hsivonen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hsivonen/subscriptions", "organizations_url": "https://api.github.com/users/hsivonen/orgs", "repos_url": "https://api.github.com/users/hsivonen/repos", "events_url": "https://api.github.com/users/hsivonen/events{/privacy}", "received_events_url": "https://api.github.com/users/hsivonen/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 884691893, "node_id": "MDU6TGFiZWw4ODQ2OTE4OTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/WG-codegen", "name": "WG-codegen", "color": "c2e0c6", "default": false, "description": "Working Group: Codegen (Runtime perf and code size)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 34, "created_at": "2018-04-11T11:51:20Z", "updated_at": "2018-06-08T08:02:37Z", "closed_at": "2018-05-20T00:49:46Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "When Firefox switched from Rust 1.24.0 to Rust 1.25.0, the win32 performance of encoding_rs's UTF-8 validation function [dropped 12.5%](https://bugzilla.mozilla.org/show_bug.cgi?id=1451703) when used on ASCII input. encoding_rs's UTF-8 validation function is a fork of the Rust standard library validation function that replaces the ASCII acceleration ALU trick that autovectorizes on x86_64 but not on i686 and works only  in the aligned case with explicit SIMD code that deals with both the aligned and unaligned cases.\r\n\r\nWhen the input is all ASCII, the function should stay in either the aligned-case or the unaligned-case inner loop that loads 16 bytes using `movdqa` or `movdqu`, respectively, performs `pmovmskb` on the xmm register and compares the result to zero jumping back to the start of the loop if it is zero.\r\n\r\nWhen compiled for i686 Linux with opt level 2 (which Firefox uses) using Rust 1.24.0, the result is exactly as expected.\r\n\r\nUnaligned:\r\n```asm\r\n.LBB12_3:\r\n\tmovdqu\t(%edx,%eax), %xmm0\r\n\tpmovmskb\t%xmm0, %ebp\r\n\ttestl\t%ebp, %ebp\r\n\tjne\t.LBB12_9\r\n\taddl\t$16, %eax\r\n\tcmpl\t%ebx, %eax\r\n\tjbe\t.LBB12_3\r\n\tjmp\t.LBB12_5\r\n\t.p2align\t4, 0x90\r\n```\r\n\r\nAligned:\r\n```asm\r\n.LBB12_7:\r\n\tmovdqa\t(%edx,%eax), %xmm0\r\n\tpmovmskb\t%xmm0, %ebp\r\n\ttestl\t%ebp, %ebp\r\n\tjne\t.LBB12_9\r\n\taddl\t$16, %eax\r\n\tcmpl\t%ebx, %eax\r\n\tjbe\t.LBB12_7\r\n\t.p2align\t4, 0x90\r\n```\r\n\r\n(Windows wouldn't let me see the asm  due to LLVM deeming the IR invalid with `--emit asm`.)\r\n\r\nWhen compiled with Rust 1.25.0,  the result is more complicated:\r\n\r\n 1. There are two instances of `movdqa` and two instances of `movdqu` suggesting that  the first trip through the loop has been unrolled to be a separate copy from the loop proper.\r\n 2. In the actual loop, ALU instructions have been moved around including placing one between the SSE2 instructions.\r\n\r\nBoth of these transformations look like plausible optimizations, but considering the performance result from Firefox CI, it seems these transformations made performance worse.\r\n\r\n```asm\r\n.LBB16_1:\r\n\tmovl\t%edx, %ebp\r\n\tleal\t(%ecx,%edi), %ebx\r\n\tmovl\t$0, %esi\r\n\tsubl\t%edi, %ebp\r\n\tcmpl\t$16, %ebp\r\n\tjb\t.LBB16_22\r\n\tleal\t-16(%ebp), %eax\r\n\ttestb\t$15, %bl\r\n\tmovl\t%eax, 20(%esp)\r\n\tje\t.LBB16_9\r\n\tmovdqu\t(%ebx), %xmm0\r\n\tmovl\t%edx, 12(%esp)\r\n\txorl\t%eax, %eax\r\n\tpmovmskb\t%xmm0, %edx\r\n\ttestl\t%edx, %edx\r\n\tjne\t.LBB16_7\r\n\tmovl\t24(%esp), %eax\r\n\txorl\t%esi, %esi\r\n\tleal\t(%eax,%edi), %ecx\r\n\t.p2align\t4, 0x90\r\n.LBB16_5:\r\n\tleal\t16(%esi), %eax\r\n\tcmpl\t20(%esp), %eax\r\n\tja\t.LBB16_20\r\n\tmovdqu\t(%ecx,%esi), %xmm0\r\n\tmovl\t%eax, %esi\r\n\tpmovmskb\t%xmm0, %edx\r\n\ttestl\t%edx, %edx\r\n\tje\t.LBB16_5\r\n.LBB16_7:\r\n\ttestl\t%edx, %edx\r\n\tje\t.LBB16_12\r\n\tbsfl\t%edx, %esi\r\n\tjmp\t.LBB16_13\r\n.LBB16_9:\r\n\tmovdqa\t(%ebx), %xmm0\r\n\txorl\t%ecx, %ecx\r\n\tpmovmskb\t%xmm0, %eax\r\n\ttestl\t%eax, %eax\r\n\tje\t.LBB16_15\r\n\ttestl\t%eax, %eax\r\n\tje\t.LBB16_19\r\n.LBB16_11:\r\n\tbsfl\t%eax, %esi\r\n\taddl\t%ecx, %esi\r\n\tjmp\t.LBB16_14\r\n.LBB16_12:\r\n\tmovl\t$32, %esi\r\n.LBB16_13:\r\n\tmovl\t12(%esp), %edx\r\n\taddl\t%eax, %esi\r\n.LBB16_14:\r\n\tmovb\t(%ebx,%esi), %al\r\n\tjmp\t.LBB16_24\r\n.LBB16_15:\r\n\tmovl\t$16, %esi\r\n\t.p2align\t4, 0x90\r\n.LBB16_16:\r\n\tcmpl\t20(%esp), %esi\r\n\tja\t.LBB16_22\r\n\tmovdqa\t(%ebx,%esi), %xmm0\r\n\taddl\t$16, %esi\r\n\tpmovmskb\t%xmm0, %eax\r\n\ttestl\t%eax, %eax\r\n\tje\t.LBB16_16\r\n\taddl\t$-16, %esi\r\n\tmovl\t%esi, %ecx\r\n\ttestl\t%eax, %eax\r\n\tjne\t.LBB16_11\r\n```\r\n\r\nThe asm was obtained by compiling [encoding_rs](https://github.com/hsivonen/encoding_rs) (Firefox uses 0.7.2) using `RUSTC_BOOTSTRAP=1 RUSTFLAGS='-C opt-level=2 --emit asm' cargo build --target i686-unknown-linux-gnu --release --features simd-accel` and searching for `utf8_valid_up_to` in the `.s` file.\r\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/49873/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/49873/timeline", "performed_via_github_app": null, "state_reason": "completed"}