{"url": "https://api.github.com/repos/rust-lang/rust/issues/51493", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/51493/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/51493/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/51493/events", "html_url": "https://github.com/rust-lang/rust/issues/51493", "id": 331152851, "node_id": "MDU6SXNzdWUzMzExNTI4NTE=", "number": 51493, "title": "ICE on potentially recursive trait implementation", "user": {"login": "leops", "id": 1895119, "node_id": "MDQ6VXNlcjE4OTUxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1895119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/leops", "html_url": "https://github.com/leops", "followers_url": "https://api.github.com/users/leops/followers", "following_url": "https://api.github.com/users/leops/following{/other_user}", "gists_url": "https://api.github.com/users/leops/gists{/gist_id}", "starred_url": "https://api.github.com/users/leops/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/leops/subscriptions", "organizations_url": "https://api.github.com/users/leops/orgs", "repos_url": "https://api.github.com/users/leops/repos", "events_url": "https://api.github.com/users/leops/events{/privacy}", "received_events_url": "https://api.github.com/users/leops/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-06-11T11:38:24Z", "updated_at": "2019-02-10T11:53:53Z", "closed_at": "2019-02-10T11:53:53Z", "author_association": "NONE", "active_lock_reason": null, "body": "The compiler panics when a generic implementation of a trait may depend on itself\r\n\r\n# Example\r\n```rust\r\n#![feature(try_from)]\r\n\r\nuse std::convert::TryInto;\r\n\r\npub enum Value {\r\n    Float(f32),\r\n    List(Vec<Value>),\r\n}\r\n\r\nimpl TryInto<f32> for Value {\r\n    type Error = ();\r\n\r\n    fn try_into(self) -> Result<f32, ()> {\r\n        match self {\r\n            Value::Float(val) => Ok(val),\r\n            _ => Err(()),\r\n        }\r\n    }\r\n}\r\n\r\nimpl<T> TryInto<Vec<T>> for Value where Value: TryInto<T, Error = ()> {\r\n    type Error = ();\r\n\r\n    fn try_into(self) -> Result<Vec<T>, ()> {\r\n        match self {\r\n            Value::List(list) => {\r\n                list.into_iter()\r\n                    .map(<Value as TryInto<T>>::try_into)\r\n                    .collect()\r\n            },\r\n            _ => Err(()),\r\n        }\r\n    }\r\n}\r\n\r\npub fn example(val: Value) -> Result<Vec<f32>, ()> {\r\n    val.try_into()\r\n}\r\n```\r\n\r\n# Expected behavior\r\nThe error happens for a reason, since the `impl` could potentially recurse infinitely on itself, so I think this code should not compile, but a useful error message would be expected\r\n\r\n# Observed behavior\r\nCrash with the following error message:\r\n```\r\nerror: internal compiler error: librustc/traits/structural_impls.rs:176: impossible case reached\r\n\r\nthread 'main' panicked at 'Box<Any>', librustc_errors/lib.rs:554:9\r\nstack backtrace:\r\n   0: std::sys::unix::backtrace::tracing::imp::unwind_backtrace\r\n   1: std::sys_common::backtrace::print\r\n   2: std::panicking::default_hook::{{closure}}\r\n   3: std::panicking::default_hook\r\n   4: rustc::util::common::panic_hook\r\n   5: std::panicking::rust_panic_with_hook\r\n   6: std::panicking::begin_panic\r\n   7: rustc_errors::Handler::bug\r\n   8: rustc::session::opt_span_bug_fmt::{{closure}}\r\n   9: rustc::ty::context::tls::with_opt::{{closure}}\r\n  10: rustc::ty::context::tls::with_context_opt\r\n  11: rustc::ty::context::tls::with_opt\r\n  12: rustc::session::opt_span_bug_fmt\r\n  13: rustc::session::bug_fmt\r\n  14: rustc::traits::structural_impls::<impl rustc::ty::context::Lift<'tcx> for rustc::traits::SelectionError<'a>>::lift_to_tcx\r\n  15: rustc::traits::select::SelectionContext::candidate_from_obligation\r\n  16: rustc::traits::select::SelectionContext::select\r\n  17: rustc::infer::InferCtxt::commit_if_ok\r\n  18: rustc::traits::project::opt_normalize_projection_type\r\n  19: rustc::traits::project::project_and_unify_type\r\n  20: rustc::infer::InferCtxt::commit_if_ok\r\n  21: rustc::traits::select::SelectionContext::evaluate_predicate_recursively\r\n  22: rustc::traits::select::SelectionContext::evaluate_candidate\r\n  23: <&'a mut I as core::iter::iterator::Iterator>::next\r\n  24: <alloc::vec::Vec<T> as alloc::vec::SpecExtend<T, I>>::from_iter\r\n  25: rustc::traits::select::SelectionContext::candidate_from_obligation_no_cache\r\n  26: rustc::dep_graph::graph::DepGraph::with_anon_task\r\n  27: rustc::traits::select::SelectionContext::candidate_from_obligation\r\n  28: rustc::traits::select::SelectionContext::select\r\n  29: rustc::infer::InferCtxt::commit_if_ok\r\n  30: rustc::traits::project::opt_normalize_projection_type\r\n  31: rustc::traits::project::project_and_unify_type\r\n  32: rustc::infer::InferCtxt::commit_if_ok\r\n  33: rustc::traits::select::SelectionContext::evaluate_predicate_recursively\r\n  34: rustc::traits::select::SelectionContext::evaluate_candidate\r\n  35: <&'a mut I as core::iter::iterator::Iterator>::next\r\n  36: <alloc::vec::Vec<T> as alloc::vec::SpecExtend<T, I>>::from_iter\r\n  37: rustc::traits::select::SelectionContext::candidate_from_obligation_no_cache\r\n  38: rustc::dep_graph::graph::DepGraph::with_anon_task\r\n  39: rustc::traits::select::SelectionContext::candidate_from_obligation\r\n  40: rustc::traits::select::SelectionContext::select\r\n  41: rustc::infer::InferCtxt::commit_if_ok\r\n  42: rustc::traits::project::opt_normalize_projection_type\r\n  43: rustc::traits::project::project_and_unify_type\r\n  44: rustc::infer::InferCtxt::commit_if_ok\r\n  45: rustc::traits::select::SelectionContext::evaluate_predicate_recursively\r\n  46: rustc::traits::select::SelectionContext::evaluate_candidate\r\n  47: <&'a mut I as core::iter::iterator::Iterator>::next\r\n  48: <alloc::vec::Vec<T> as alloc::vec::SpecExtend<T, I>>::from_iter\r\n  49: rustc::traits::select::SelectionContext::candidate_from_obligation_no_cache\r\n  50: rustc::dep_graph::graph::DepGraph::with_anon_task\r\n  51: rustc::traits::select::SelectionContext::candidate_from_obligation\r\n  52: rustc::traits::select::SelectionContext::select\r\n  53: rustc::infer::InferCtxt::commit_if_ok\r\n  54: rustc::traits::project::opt_normalize_projection_type\r\n  55: rustc::traits::project::project_and_unify_type\r\n  56: rustc::infer::InferCtxt::commit_if_ok\r\n  57: rustc::traits::select::SelectionContext::evaluate_predicate_recursively\r\n  58: rustc::traits::select::SelectionContext::evaluate_candidate\r\n  59: <&'a mut I as core::iter::iterator::Iterator>::next\r\n  60: <alloc::vec::Vec<T> as alloc::vec::SpecExtend<T, I>>::from_iter\r\n  61: rustc::traits::select::SelectionContext::candidate_from_obligation_no_cache\r\n  62: rustc::dep_graph::graph::DepGraph::with_anon_task\r\n  63: rustc::traits::select::SelectionContext::candidate_from_obligation\r\n  64: rustc::traits::select::SelectionContext::select\r\n  65: rustc::infer::InferCtxt::commit_if_ok\r\n  66: rustc::traits::project::opt_normalize_projection_type\r\n  67: rustc::traits::project::project_and_unify_type\r\n  68: rustc::infer::InferCtxt::commit_if_ok\r\n  69: rustc::traits::select::SelectionContext::evaluate_predicate_recursively\r\n  70: rustc::traits::select::SelectionContext::evaluate_candidate\r\n  71: <&'a mut I as core::iter::iterator::Iterator>::next\r\n  72: <alloc::vec::Vec<T> as alloc::vec::SpecExtend<T, I>>::from_iter\r\n  73: rustc::traits::select::SelectionContext::candidate_from_obligation_no_cache\r\n  74: rustc::dep_graph::graph::DepGraph::with_anon_task\r\n  75: rustc::traits::select::SelectionContext::candidate_from_obligation\r\n  76: rustc::traits::select::SelectionContext::select\r\n  77: rustc::infer::InferCtxt::commit_if_ok\r\n  78: rustc::traits::project::opt_normalize_projection_type\r\n  79: rustc::traits::project::project_and_unify_type\r\n  80: rustc::infer::InferCtxt::commit_if_ok\r\n  81: rustc::traits::select::SelectionContext::evaluate_predicate_recursively\r\n  82: rustc::traits::select::SelectionContext::evaluate_candidate\r\n  83: <&'a mut I as core::iter::iterator::Iterator>::next\r\n  84: <alloc::vec::Vec<T> as alloc::vec::SpecExtend<T, I>>::from_iter\r\n  85: rustc::traits::select::SelectionContext::candidate_from_obligation_no_cache\r\n  86: rustc::dep_graph::graph::DepGraph::with_anon_task\r\n  87: rustc::traits::select::SelectionContext::candidate_from_obligation\r\n  88: rustc::traits::select::SelectionContext::select\r\n  89: rustc::infer::InferCtxt::commit_if_ok\r\n  90: rustc::traits::project::opt_normalize_projection_type\r\n  91: rustc::traits::project::project_and_unify_type\r\n  92: rustc::infer::InferCtxt::commit_if_ok\r\n  93: rustc::traits::select::SelectionContext::evaluate_predicate_recursively\r\n  94: rustc::traits::select::SelectionContext::evaluate_candidate\r\n  95: <&'a mut I as core::iter::iterator::Iterator>::next\r\n  96: <alloc::vec::Vec<T> as alloc::vec::SpecExtend<T, I>>::from_iter\r\n  97: rustc::traits::select::SelectionContext::candidate_from_obligation_no_cache\r\n  98: rustc::dep_graph::graph::DepGraph::with_anon_task\r\n  99: rustc::traits::select::SelectionContext::candidate_from_obligation\r\nquery stack during panic:\r\n#0 [evaluate_obligation] evaluating trait selection obligation `Value: std::convert::TryInto<_>`\r\n#1 [typeck_tables_of] processing `<Value as std::convert::TryInto<f32>>::try_into`\r\n#2 [typeck_item_bodies] type-checking all item bodies\r\nend of query stack\r\n[...]\r\nnote: rustc 1.27.0-nightly (9fae15374 2018-05-13) running on x86_64-apple-darwin\r\nnote: compiler flags: -C opt-level=3 -C debuginfo=2 --crate-type rlib --crate-type cdylib\r\n```", "closed_by": {"login": "leops", "id": 1895119, "node_id": "MDQ6VXNlcjE4OTUxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1895119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/leops", "html_url": "https://github.com/leops", "followers_url": "https://api.github.com/users/leops/followers", "following_url": "https://api.github.com/users/leops/following{/other_user}", "gists_url": "https://api.github.com/users/leops/gists{/gist_id}", "starred_url": "https://api.github.com/users/leops/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/leops/subscriptions", "organizations_url": "https://api.github.com/users/leops/orgs", "repos_url": "https://api.github.com/users/leops/repos", "events_url": "https://api.github.com/users/leops/events{/privacy}", "received_events_url": "https://api.github.com/users/leops/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/51493/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/51493/timeline", "performed_via_github_app": null, "state_reason": "completed"}