{"url": "https://api.github.com/repos/rust-lang/rust/issues/68710", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/68710/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/68710/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/68710/events", "html_url": "https://github.com/rust-lang/rust/issues/68710", "id": 558315968, "node_id": "MDU6SXNzdWU1NTgzMTU5Njg=", "number": 68710, "title": "Field attributes lost in proc macro input", "user": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 132910982, "node_id": "MDU6TGFiZWwxMzI5MTA5ODI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-macros", "name": "A-macros", "color": "f7e101", "default": false, "description": "Area: All kinds of macros (custom derive, macro_rules!, proc macros, ..)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 1, "created_at": "2020-01-31T19:03:54Z", "updated_at": "2020-02-02T12:51:55Z", "closed_at": "2020-02-02T12:51:55Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "If we have an attribute macro whose input contains attributes on fields of a struct-expression, those attributes all seem to disappear before the macro is invoked.\r\n\r\nThe following repro compiles successfully if #\\[repro::repro\\] is removed, but fails with \"error\\[E0062\\]: field \\`field\\` specified more than once\" if the macro is present even though it does nothing.\r\n\r\n```rust\r\nstruct C {\r\n    field: u8,\r\n}\r\n\r\n#[repro::repro]\r\nconst C: C = C {\r\n    #[cfg(debug_assertions)]\r\n    field: 0,\r\n    #[cfg(not(debug_assertions))]\r\n    field: 1,\r\n};\r\n\r\nfn main() {}\r\n```\r\n\r\n```rust\r\nextern crate proc_macro;\r\nuse proc_macro::TokenStream;\r\n\r\n#[proc_macro_attribute]\r\npub fn repro(_args: TokenStream, input: TokenStream) -> TokenStream {\r\n    println!(\"{:#?}\", input);\r\n    input.into_iter().collect()\r\n}\r\n```\r\n\r\n<details>\r\n<summary>Here is a script that reproduces the behavior as of rustc 1.42.0-nightly (212b2c7da 2020-01-30)</summary>\r\n\r\n```bash\r\n#!/bin/bash\r\n\r\ncargo new repro\r\n\r\necho >>repro/Cargo.toml '\r\n[lib]\r\nproc-macro = true\r\n'\r\n\r\necho >repro/src/lib.rs '\r\nextern crate proc_macro;\r\nuse proc_macro::TokenStream;\r\n\r\n#[proc_macro_attribute]\r\npub fn repro(_args: TokenStream, input: TokenStream) -> TokenStream {\r\n    println!(\"{:#?}\", input);\r\n    input.into_iter().collect()\r\n}\r\n'\r\n\r\necho >repro/src/main.rs '\r\nstruct C {\r\n    field: u8,\r\n}\r\n#[repro::repro]\r\nconst C: C = C {\r\n    #[cfg(debug_assertions)]\r\n    field: 0,\r\n    #[cfg(not(debug_assertions))]\r\n    field: 1,\r\n};\r\nfn main() {}\r\n'\r\n\r\ncargo +nightly check --manifest-path repro/Cargo.toml\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary>Here is the input token stream as received by the proc macro</summary>\r\n\r\n```console\r\nTokenStream [\r\n    Ident {\r\n        ident: \"const\",\r\n        span: #0 bytes(0..0),\r\n    },\r\n    Ident {\r\n        ident: \"C\",\r\n        span: #0 bytes(0..0),\r\n    },\r\n    Punct {\r\n        ch: ':',\r\n        spacing: Alone,\r\n        span: #0 bytes(0..0),\r\n    },\r\n    Ident {\r\n        ident: \"C\",\r\n        span: #0 bytes(0..0),\r\n    },\r\n    Punct {\r\n        ch: '=',\r\n        spacing: Alone,\r\n        span: #0 bytes(0..0),\r\n    },\r\n    Ident {\r\n        ident: \"C\",\r\n        span: #0 bytes(0..0),\r\n    },\r\n    Group {\r\n        delimiter: Brace,\r\n        stream: TokenStream [\r\n            Ident {\r\n                ident: \"field\",\r\n                span: #0 bytes(0..0),\r\n            },\r\n            Punct {\r\n                ch: ':',\r\n                spacing: Alone,\r\n                span: #0 bytes(0..0),\r\n            },\r\n            Literal { lit: Lit { kind: Integer, symbol: \"0\", suffix: None }, span: Span { lo: BytePos(0), hi: BytePos(0), ctxt: #0 } },\r\n            Punct {\r\n                ch: ',',\r\n                spacing: Alone,\r\n                span: #0 bytes(0..0),\r\n            },\r\n            Ident {\r\n                ident: \"field\",\r\n                span: #0 bytes(0..0),\r\n            },\r\n            Punct {\r\n                ch: ':',\r\n                spacing: Alone,\r\n                span: #0 bytes(0..0),\r\n            },\r\n            Literal { lit: Lit { kind: Integer, symbol: \"1\", suffix: None }, span: Span { lo: BytePos(0), hi: BytePos(0), ctxt: #0 } },\r\n            Punct {\r\n                ch: ',',\r\n                spacing: Alone,\r\n                span: #0 bytes(0..0),\r\n            },\r\n        ],\r\n        span: #0 bytes(0..0),\r\n    },\r\n    Punct {\r\n        ch: ';',\r\n        spacing: Alone,\r\n        span: #0 bytes(0..0),\r\n    },\r\n]\r\n```\r\n</details>\r\n\r\ncc https://github.com/dtolnay/async-trait/issues/63", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/68710/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/68710/timeline", "performed_via_github_app": null, "state_reason": "completed"}