{"url": "https://api.github.com/repos/rust-lang/rust/issues/9724", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/9724/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/9724/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/9724/events", "html_url": "https://github.com/rust-lang/rust/issues/9724", "id": 20558149, "node_id": "MDU6SXNzdWUyMDU1ODE0OQ==", "number": 9724, "title": "Consider reducing memory usage after trans", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2013-10-05T01:49:37Z", "updated_at": "2013-10-18T01:55:07Z", "closed_at": "2013-10-18T01:55:07Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "When compiling libsyntax, we have about 250MB after trans has finished. In theory, at this time, the only live things should be LLVM contexts/modules and everything within. I wanted to open this issue to consider reducing our memory footprint after trans has finished.\n\nThe numbers for rustc I'm sure are higher, but my analysis involved running valgrind's `massif` tool over a stage1 compilation of `libsyntax` and then analyzing the first memory snapshot after trans finishes (the largest memory dip in the program).\n\nFrom what I could tell, these are the largest allocations which are never free'd until the compilation task terminates. In theory these could all be deallocated much sooner (some maybe even before trans runs, reducing the global peak memory usage)\n1. 43MB - all of the crate metadata. Crates are stored in the `Session`'s cstore, not in the tcx, meaning that this all persists until the session itself is dropped.\n2. 8MB - We gave ourselves an absolutely massive stack segment. This may be multiple stack segments, I couldn't tell.\n3. 3MB - The task-local sctable and resolve table used by the `mtwt_resolve` function inside `ast_map`. I have no idea what these are, but it looks like they aren't used after resolve finishes, perhaps the task-local maps could be dropped at that point (this would reduce peak memory usage, but not by much).\n4. ~4MB the code map and ident internern, these are in TLS and on the Session\n5. ~2.5MB lots of data structures from resolve, I presume because they're all very likely to have cyclical references to one another.\n\nNote that because many of these are needed for trans, this wouldn't necessarily be reducing our global peak of memory usage. It does have us in theory being slightly more responsible.\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/9724/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/9724/timeline", "performed_via_github_app": null, "state_reason": "completed"}