{"url": "https://api.github.com/repos/rust-lang/rust/issues/93296", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/93296/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/93296/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/93296/events", "html_url": "https://github.com/rust-lang/rust/issues/93296", "id": 1113747471, "node_id": "I_kwDOAAsO6M5CYnAP", "number": 93296, "title": "Cycle detected with significant destructor from 1.58", "user": {"login": "SuperFluffy", "id": 701177, "node_id": "MDQ6VXNlcjcwMTE3Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/701177?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SuperFluffy", "html_url": "https://github.com/SuperFluffy", "followers_url": "https://api.github.com/users/SuperFluffy/followers", "following_url": "https://api.github.com/users/SuperFluffy/following{/other_user}", "gists_url": "https://api.github.com/users/SuperFluffy/gists{/gist_id}", "starred_url": "https://api.github.com/users/SuperFluffy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SuperFluffy/subscriptions", "organizations_url": "https://api.github.com/users/SuperFluffy/orgs", "repos_url": "https://api.github.com/users/SuperFluffy/repos", "events_url": "https://api.github.com/users/SuperFluffy/events{/privacy}", "received_events_url": "https://api.github.com/users/SuperFluffy/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2413861294, "node_id": "MDU6TGFiZWwyNDEzODYxMjk0", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-untriaged", "name": "regression-untriaged", "color": "e4008a", "default": false, "description": "Untriaged performance or correctness regression."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2022-01-25T11:06:16Z", "updated_at": "2022-01-26T15:28:36Z", "closed_at": "2022-01-26T15:26:13Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "**MWE:** https://github.com/SuperFluffy/google_proto_struct_mwe (see branches master, 1.57, 1.56, nightly).\r\n\r\nI am getting a confusing error message when compiling a generated struct (see below). This compiles in 1.56 and 1.57, but no longer in 1.58.* or nightly.\r\n\r\n~Note that I cannot reproduce this locally! It happily builds on my local machine (MacOS M1, rustc 1.58.1), but it does not in CI (ubuntu-latest, 1.58.1).~\r\n\r\nI can reproduce this locally, as pointed out in https://github.com/rust-lang/rust/issues/93296#issuecomment-1021087756\r\n\r\n```\r\nerror[E0391]: cycle detected when computing when `Struct` has a significant destructor\r\n --> src/lib.rs:2:1\r\n  |\r\n2 | pub struct Struct {\r\n  | ^^^^^^^^^^^^^^^^^\r\n  |\r\n  = note: ...which immediately requires computing when `Struct` has a significant destructor again\r\n  = note: cycle used when computing whether `Struct` has a significant drop\r\n```\r\n\r\n# Code\r\n\r\nThe code reproduced below is constructed by [prost-build](https://github.com/tokio-rs/prost-build). It can be generated from scratch or imported via [prost-types](https://github.com/tokio-rs/prost/tree/master/prost-types). The error occurs in both cases.\r\n\r\nI have inlined the code into the repository to demonstrate the issue without extra dependencies.\r\n\r\nI have made an MWE here: https://github.com/SuperFluffy/google_proto_struct_mwe\r\n\r\nThe error as copied verbatim can be seen in this github action: https://github.com/SuperFluffy/google_proto_struct_mwe/runs/4935446281\r\n\r\n```rust\r\n#[derive(Clone, PartialEq, ::prost::Message)]\r\npub struct Struct {\r\n    #[prost(map = \"string, message\", tag = \"1\")]\r\n    pub fields: ::std::collections::HashMap<::prost::alloc::string::String, Value>,\r\n}\r\n\r\n#[derive(Clone, PartialEq, ::prost::Message)]\r\npub struct Value {\r\n    #[prost(oneof = \"value::Kind\", tags = \"1, 2, 3, 4, 5, 6\")]\r\n    pub kind: ::core::option::Option<value::Kind>,\r\n}\r\npub mod value {\r\n    #[derive(Clone, PartialEq, ::prost::Oneof)]\r\n    pub enum Kind {\r\n        #[prost(enumeration = \"super::NullValue\", tag = \"1\")]\r\n        NullValue(i32),\r\n        #[prost(double, tag = \"2\")]\r\n        NumberValue(f64),\r\n        #[prost(string, tag = \"3\")]\r\n        StringValue(::prost::alloc::string::String),\r\n        #[prost(bool, tag = \"4\")]\r\n        BoolValue(bool),\r\n        #[prost(message, tag = \"5\")]\r\n        StructValue(super::Struct),\r\n        #[prost(message, tag = \"6\")]\r\n        ListValue(super::ListValue),\r\n    }\r\n}\r\n\r\n#[derive(Clone, PartialEq, ::prost::Message)]\r\npub struct ListValue {\r\n    #[prost(message, repeated, tag = \"1\")]\r\n    pub values: ::prost::alloc::vec::Vec<Value>,\r\n}\r\n\r\n#[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]\r\n#[repr(i32)]\r\npub enum NullValue {\r\n    NullValue = 0,\r\n}\r\n```\r\n\r\n## I expected to see this happen:\r\n\r\nIt should compile. It used to compile, but it started breaking with 1.58.0 and 1.58.1, and also nightly. It works in 1.57 and 1.56.\r\n\r\n## Instead, this happens:\r\n\r\nCompilation error, see above\r\n\r\n### Meta\r\n\r\n#### Works\r\n\r\n```\r\n# Local\r\n\r\nrustc 1.58.1 (db9d1b20b 2022-01-20)\r\nbinary: rustc\r\ncommit-hash: db9d1b20bba1968c1ec1fc49616d4742c1725b4b\r\ncommit-date: 2022-01-20\r\nhost: aarch64-apple-darwin\r\nrelease: 1.58.1\r\nLLVM version: 13.0.0\r\n\r\n# CI\r\n\r\nrustc 1.57.0 (f1edd0429 2021-11-29)\r\nbinary: rustc\r\ncommit-hash: f1edd0429582dd29cccacaf50fd134b05593bd9c\r\ncommit-date: 2021-11-29\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.57.0\r\nLLVM version: 13.0.0\r\n```\r\n\r\n#### Does not work\r\n\r\n```\r\n# CI\r\n\r\nrustc 1.58.1 (db9d1b20b 2022-01-20)\r\nbinary: rustc\r\ncommit-hash: db9d1b20bba1968c1ec1fc49616d4742c1725b4b\r\ncommit-date: 2022-01-20\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.58.1\r\nLLVM version: 13.0.0\r\n\r\nrustc 1.60.0-nightly (51126be1b 2022-01-24)\r\nbinary: rustc\r\ncommit-hash: 51126be1b260216b41143469086e6e6ee567647e\r\ncommit-date: 2022-01-24\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.60.0-nightly\r\nLLVM version: 13.0.0\r\n```\r\n\r\n### Backtraces\r\n\r\nNothing in there; see the CI reports with `RUST_BACKTRACE=1` enabled.\r\n\r\n### Version it worked on\r\n\r\n`1.57` (see 1.57 branch on cI)\r\n\r\n### Version with regression\r\n\r\n`1.58`", "closed_by": {"login": "apiraino", "id": 6098822, "node_id": "MDQ6VXNlcjYwOTg4MjI=", "avatar_url": "https://avatars.githubusercontent.com/u/6098822?v=4", "gravatar_id": "", "url": "https://api.github.com/users/apiraino", "html_url": "https://github.com/apiraino", "followers_url": "https://api.github.com/users/apiraino/followers", "following_url": "https://api.github.com/users/apiraino/following{/other_user}", "gists_url": "https://api.github.com/users/apiraino/gists{/gist_id}", "starred_url": "https://api.github.com/users/apiraino/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/apiraino/subscriptions", "organizations_url": "https://api.github.com/users/apiraino/orgs", "repos_url": "https://api.github.com/users/apiraino/repos", "events_url": "https://api.github.com/users/apiraino/events{/privacy}", "received_events_url": "https://api.github.com/users/apiraino/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/93296/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/93296/timeline", "performed_via_github_app": null, "state_reason": "completed"}