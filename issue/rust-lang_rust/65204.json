{"url": "https://api.github.com/repos/rust-lang/rust/issues/65204", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/65204/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/65204/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/65204/events", "html_url": "https://github.com/rust-lang/rust/issues/65204", "id": 503987157, "node_id": "MDU6SXNzdWU1MDM5ODcxNTc=", "number": 65204, "title": "DWARF for legacy enum incorrect", "user": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 203130, "node_id": "MDU6TGFiZWwyMDMxMzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-debuginfo", "name": "A-debuginfo", "color": "f7e101", "default": false, "description": "Area: Debugging information in compiled programs (DWARF, PDB, etc.)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2019-10-08T11:28:27Z", "updated_at": "2023-06-19T14:41:15Z", "closed_at": "2023-06-19T14:41:14Z", "author_association": "NONE", "active_lock_reason": null, "body": "With test-case gdb.rust/simple.exp (https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;a=blob;f=gdb/testsuite/gdb.rust/simple.rs;hb=HEAD) we run into gdb testsuite failure reported here ( https://sourceware.org/bugzilla/show_bug.cgi?id=25048 ).\r\n\r\nThis is on openSUSE Leap 15.1 using rustc version 1.36.0 (while using llvm 7), but also reproduced using 1.38.0 (while using llvm 7).\r\n\r\nThe problem is we're trying to print variable k, which should look like this:\r\n```\r\n$1 = simple::SpaceSaver::Nothing\"                                                               \r\n```\r\nbut instead we get:\r\n```\r\n$1 = simple::SpaceSaver::Thebox(40, 0x0)\r\n```\r\n\r\nThis has been analyzed to be a problem in the debug info, generated for the legacy enum encoding (which is due to using a relatively recent version of Rust with a somewhat older version of LLVM).\r\n\r\nSo, the variable k:\r\n```\r\n <17><3d58>: Abbrev Number: 15 (DW_TAG_variable)\r\n    <3d59>   DW_AT_location    : 3 byte block: 91 b8 4  (DW_OP_fbreg: 568)\r\n    <3d5d>   DW_AT_name        : (indirect string, offset: 0xf9a): k\r\n    <3d61>   DW_AT_alignment   : 1\r\n    <3d62>   DW_AT_decl_file   : 1\r\n    <3d63>   DW_AT_decl_line   : 129\r\n    <3d64>   DW_AT_type        : <0x4232>\r\n```\r\nhas type:\r\n```\r\n <2><4232>: Abbrev Number: 11 (DW_TAG_union_type)\r\n    <4233>   DW_AT_name        : (indirect string, offset: 0x3037): SpaceSaver\r\n    <4237>   DW_AT_byte_size   : 16\r\n    <4238>   DW_AT_alignment   : 8\r\n <3><4239>: Abbrev Number: 9 (DW_TAG_member)\r\n    <423a>   DW_AT_name        : (indirect string, offset: 0x29f5): RUST$ENCODED$ENUM$0$Nothing\r\n    <423e>   DW_AT_type        : <0x4245>\r\n    <4242>   DW_AT_alignment   : 8\r\n    <4243>   DW_AT_data_member_location: 0\r\n```\r\nThe \"RUST$ENCODED$ENUM$0$Nothing\" means that field 0 is both a pointer and a\r\ndiscriminant, and if the value is 0, then the enum is just a data-less variant\r\nnamed \"Nothing\".\r\n\r\nHowever, the corresponding type has two fields, where not field 0 but field 1\r\nis a pointer, and field 0 is a byte:\r\n```\r\n <2><4245>: Abbrev Number: 8 (DW_TAG_structure_type)\r\n    <4246>   DW_AT_name        : (indirect string, offset: 0x2a11): Thebox\r\n    <424a>   DW_AT_byte_size   : 16\r\n    <424b>   DW_AT_alignment   : 8\r\n <3><424c>: Abbrev Number: 9 (DW_TAG_member)\r\n    <424d>   DW_AT_name        : (indirect string, offset: 0x670): __0\r\n    <4251>   DW_AT_type        : <0x436b>\r\n    <4255>   DW_AT_alignment   : 1\r\n    <4256>   DW_AT_data_member_location: 8\r\n <3><4257>: Abbrev Number: 9 (DW_TAG_member)\r\n    <4258>   DW_AT_name        : (indirect string, offset: 0x1662): __1\r\n    <425c>   DW_AT_type        : <0x45da>\r\n    <4260>   DW_AT_alignment   : 8\r\n    <4261>   DW_AT_data_member_location: 0\r\n```", "closed_by": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/65204/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/65204/timeline", "performed_via_github_app": null, "state_reason": "completed"}