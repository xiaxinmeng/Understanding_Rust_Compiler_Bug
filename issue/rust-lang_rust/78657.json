{"url": "https://api.github.com/repos/rust-lang/rust/issues/78657", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/78657/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/78657/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/78657/events", "html_url": "https://github.com/rust-lang/rust/issues/78657", "id": 734147343, "node_id": "MDU6SXNzdWU3MzQxNDczNDM=", "number": 78657, "title": "Long Functions Cause Invalid DWARF, Debug/ Breaking Unavailable", "user": {"login": "dan-fritchman", "id": 20178855, "node_id": "MDQ6VXNlcjIwMTc4ODU1", "avatar_url": "https://avatars.githubusercontent.com/u/20178855?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dan-fritchman", "html_url": "https://github.com/dan-fritchman", "followers_url": "https://api.github.com/users/dan-fritchman/followers", "following_url": "https://api.github.com/users/dan-fritchman/following{/other_user}", "gists_url": "https://api.github.com/users/dan-fritchman/gists{/gist_id}", "starred_url": "https://api.github.com/users/dan-fritchman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dan-fritchman/subscriptions", "organizations_url": "https://api.github.com/users/dan-fritchman/orgs", "repos_url": "https://api.github.com/users/dan-fritchman/repos", "events_url": "https://api.github.com/users/dan-fritchman/events{/privacy}", "received_events_url": "https://api.github.com/users/dan-fritchman/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 203130, "node_id": "MDU6TGFiZWwyMDMxMzA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-debuginfo", "name": "A-debuginfo", "color": "f7e101", "default": false, "description": "Area: Debugging information in compiled programs (DWARF, PDB, etc.)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2020-11-02T03:19:57Z", "updated_at": "2020-11-05T13:38:38Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "Including long functions appears to cause rustc to create invalid DWARF debug files. This leaves debugging and break-pointing unavailable. Debugging fails *throughout* the program, not just in the long functions. \r\n\r\nOriginally uncovered while porting (someone else's!) C code, which included a function of about 5k LOC. Also reproduced with macro-generated long methods. A minimal example is available here:\r\nhttps://github.com/dan-fritchman/DwDemo\r\n\r\nPreviously reported this to LLDB, whose maintainers helped point out that the DWARF files appear invalid. Building from a fresh clone of that demo repo - \r\n\r\n```\r\nDwDemo $ cargo build\r\n   Compiling dwdemo v0.0.1 (/Users/dan/dev/HW21/DwDemo)\r\n    Finished dev [unoptimized + debuginfo] target(s) in 8.50s\r\nDwDemo $ dwarfdump --debug-line target/debug/dwdemo.dSYM \r\nerror: target/debug/dwdemo.dSYM/Contents/Resources/DWARF/dwdemo: The file was not recognized as a valid object file\r\n```\r\n\r\nThe demo's macros expand to a few similar-length functions, about 5-6k LOC. Shortening them (via shortening the structure/ schema files) causes `dwarfdump` and `lldb` to be happy with rustc's output - \r\n\r\n```\r\nDwDemo $ cargo build          \r\n   Compiling dwdemo v0.0.1 (/Users/dan/dev/HW21/DwDemo)\r\n    Finished dev [unoptimized + debuginfo] target(s) in 4.11s\r\nDwDemo $ dwarfdump --debug-line target/debug/dwdemo.dSYM | head -n 30\r\ntarget/debug/dwdemo.dSYM/Contents/Resources/DWARF/dwdemo:       file format Mach-O 64-bit x86-64\r\n\r\n.debug_line contents:\r\ndebug_line[0x00000000]\r\nLine table prologue:\r\n    total_length: 0x000000ca\r\n         version: 2\r\n prologue_length: 0x00000075\r\n min_inst_length: 1\r\n default_is_stmt: 1\r\n       line_base: -5\r\n      line_range: 14\r\n     opcode_base: 13\r\nstandard_opcode_lengths[DW_LNS_copy] = 0\r\nstandard_opcode_lengths[DW_LNS_advance_pc] = 1\r\nstandard_opcode_lengths[DW_LNS_advance_line] = 1\r\nstandard_opcode_lengths[DW_LNS_set_file] = 1\r\nstandard_opcode_lengths[DW_LNS_set_column] = 1\r\nstandard_opcode_lengths[DW_LNS_negate_stmt] = 0\r\nstandard_opcode_lengths[DW_LNS_set_basic_block] = 0\r\nstandard_opcode_lengths[DW_LNS_const_add_pc] = 0\r\nstandard_opcode_lengths[DW_LNS_fixed_advance_pc] = 1\r\nstandard_opcode_lengths[DW_LNS_set_prologue_end] = 0\r\nstandard_opcode_lengths[DW_LNS_set_epilogue_begin] = 0\r\nstandard_opcode_lengths[DW_LNS_set_isa] = 1\r\ninclude_directories[  1] = \"/Users/dan/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/src/rust/src/libstd\"\r\nfile_names[  1]:\r\n           name: \"rt.rs\"\r\n      dir_index: 1\r\n       mod_time: 0x00000000\r\n```\r\n\r\nAll of that was run on MacOS with the stable rust toolchain. \r\n\r\n```\r\nDwDemo $ rustup show\r\nDefault host: x86_64-apple-darwin\r\nrustup home:  /Users/dan/.rustup\r\n\r\ninstalled toolchains\r\n--------------------\r\n\r\nstable-x86_64-apple-darwin (default)\r\nnightly-x86_64-apple-darwin\r\n\r\nactive toolchain\r\n----------------\r\n\r\nstable-x86_64-apple-darwin (default)\r\nrustc 1.46.0 (04488afe3 2020-08-24)\r\n```\r\n\r\nThanks for all of the team's work on this project. \r\nPlease let me know if there's any further info I can provide. ", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/78657/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/78657/timeline", "performed_via_github_app": null, "state_reason": null}