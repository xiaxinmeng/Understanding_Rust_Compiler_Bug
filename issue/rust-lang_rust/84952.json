{"url": "https://api.github.com/repos/rust-lang/rust/issues/84952", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/84952/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/84952/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/84952/events", "html_url": "https://github.com/rust-lang/rust/issues/84952", "id": 876358339, "node_id": "MDU6SXNzdWU4NzYzNTgzMzk=", "number": 84952, "title": "Panic related to compound `if ... && let Ok(...) = ... {` statement", "user": {"login": "nickbp", "id": 35933, "node_id": "MDQ6VXNlcjM1OTMz", "avatar_url": "https://avatars.githubusercontent.com/u/35933?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nickbp", "html_url": "https://github.com/nickbp", "followers_url": "https://api.github.com/users/nickbp/followers", "following_url": "https://api.github.com/users/nickbp/following{/other_user}", "gists_url": "https://api.github.com/users/nickbp/gists{/gist_id}", "starred_url": "https://api.github.com/users/nickbp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nickbp/subscriptions", "organizations_url": "https://api.github.com/users/nickbp/orgs", "repos_url": "https://api.github.com/users/nickbp/repos", "events_url": "https://api.github.com/users/nickbp/events{/privacy}", "received_events_url": "https://api.github.com/users/nickbp/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1359848690, "node_id": "MDU6TGFiZWwxMzU5ODQ4Njkw", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-mcve", "name": "E-needs-mcve", "color": "02e10c", "default": false, "description": "Call for participation: This issue needs a Minimal Complete and Verifiable Example"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-05-05T11:37:34Z", "updated_at": "2021-05-05T23:49:23Z", "closed_at": "2021-05-05T23:49:22Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for finding an Internal Compiler Error! \ud83e\uddca  If possible, try to provide\r\na minimal verifiable example. You can read \"Rust Bug Minimization Patterns\" for\r\nhow to create smaller examples.\r\n\r\nhttp://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/\r\n\r\n-->\r\n\r\n### Code\r\n\r\nThe code in question (copied below) is also found here: https://git.sr.ht/~nickbp/kapiti/tree/8b9a7869/item/src/runner.rs#L308\r\n\r\nIf `filter_uri.scheme() != None &&` is removed from line 308, the crash goes away. I tried getting a minimal repro via a separate project but wasn't able to get the panic, only the error around experimental support. For example, I tried reproducing it with regular functions, and then again with async functions with smol imported as the async runtime to match the original code, and none of these were able to get a repro.\r\n\r\nThe crash that I had experienced locally was also reproduced in the CI build of the `8b9a7869` commit, so it looks like it's at least not just my machine: https://builds.sr.ht/~nickbp/job/501433\r\n\r\n```Rust\r\nasync fn refresh_filter(\r\n    fetch_client: &Client<hyper_smol::SmolConnector>,\r\n    filters_dir: &PathBuf,\r\n    filter_path_or_url: &String,\r\n    filter_type: reader::FilterType,\r\n) -> Option<reader::FilterEntries> {\r\n    if let Ok(filter_uri) = Uri::try_from(filter_path_or_url) {\r\n        // Parsed as a URL, try to download\r\n        // Filesystem paths can get parsed as URLs with no scheme\r\n        // COMPILER CRASH!:\r\n        if filter_uri.scheme() != None && let Ok((local_path, _downloaded)) = filter::update_url(\r\n            fetch_client,\r\n            filters_dir,\r\n            filter_path_or_url,\r\n            10000,\r\n        ).await {\r\n            if let Ok(filter) = reader::read(\r\n                filter_type,\r\n                reader::FileInfo {\r\n                    source_path: filter_path_or_url.clone(),\r\n                    local_path\r\n                }\r\n            ) {\r\n                return Some(filter);\r\n            }\r\n        }\r\n        return None\r\n    } else if let Ok(filter) = reader::read(\r\n        filter_type,\r\n        reader::FileInfo {\r\n            source_path: filter_path_or_url.clone(),\r\n            local_path: filter_path_or_url.clone(),\r\n        }\r\n    ) {\r\n        return Some(filter);\r\n    }\r\n    None\r\n}\r\n```\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.51.0 (2fd73fabe 2021-03-23)\r\nbinary: rustc\r\ncommit-hash: 2fd73fabe469357a12c2c974c140f67e7cdd76d0\r\ncommit-date: 2021-03-23\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.51.0\r\nLLVM version: 11.0.1\r\n```\r\n\r\n### Error output\r\n\r\n```\r\n$ RUST_BACKTRACE=full cargo build\r\n   Compiling kapiti v0.0.1 (/home/nick/proj/kapiti)\r\nerror[E0658]: `let` expressions in this position are experimental\r\n   --> src/runner.rs:308:43\r\n    |\r\n308 |           if filter_uri.scheme() != None && let Ok((local_path, _downloaded)) = filter::update_url(\r\n    |  ___________________________________________^\r\n309 | |             fetch_client,\r\n310 | |             filters_dir,\r\n311 | |             filter_path_or_url,\r\n312 | |             10000,\r\n313 | |         ).await {\r\n    | |_______________^\r\n    |\r\n    = note: see issue #53667 <https://github.com/rust-lang/rust/issues/53667> for more information\r\n\r\nthread 'rustc' panicked at 'expected `NodeId` to be lowered already for res Local(\r\n    NodeId(20547),\r\n)', compiler/rustc_ast_lowering/src/lib.rs:714:17\r\nstack backtrace:\r\n  [see below]\r\n\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&template=ice.md\r\n\r\nnote: rustc 1.51.0 (2fd73fabe 2021-03-23) running on x86_64-unknown-linux-gnu\r\n\r\nnote: compiler flags: -C embed-bitcode=no -C debuginfo=2 -C incremental --crate-type lib\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n\r\nquery stack during panic:\r\nend of query stack\r\nerror: aborting due to previous error\r\n\r\nFor more information about this error, try `rustc --explain E0658`.\r\nerror: could not compile `kapiti`\r\n\r\nTo learn more, run the command again with --verbose.\r\n```\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary><strong>Backtrace</strong></summary>\r\n<p>\r\n\r\n```\r\n   0:     0x7fe7e70b1ee0 - std::backtrace_rs::backtrace::libunwind::trace::h5e9d00f0cdf4f57e\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/../../backtrace/src/backtrace/libunwind.rs:90:5\r\n   1:     0x7fe7e70b1ee0 - std::backtrace_rs::backtrace::trace_unsynchronized::hd5302bd66215dab9\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/../../backtrace/src/backtrace/mod.rs:66:5\r\n   2:     0x7fe7e70b1ee0 - std::sys_common::backtrace::_print_fmt::ha0237cd11a34e2bf\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/sys_common/backtrace.rs:67:5\r\n   3:     0x7fe7e70b1ee0 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::h171d4c10df1a98ee\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/sys_common/backtrace.rs:46:22\r\n   4:     0x7fe7e7122d0c - core::fmt::write::h89e4288724daa3fa\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/core/src/fmt/mod.rs:1096:17\r\n   5:     0x7fe7e70a4ff2 - std::io::Write::write_fmt::h6d40f996e84584d9\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/io/mod.rs:1568:15\r\n   6:     0x7fe7e70b5d95 - std::sys_common::backtrace::_print::h0c0b93221682afc8\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/sys_common/backtrace.rs:49:5\r\n   7:     0x7fe7e70b5d95 - std::sys_common::backtrace::print::h57a9f95204c2fdd6\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/sys_common/backtrace.rs:36:9\r\n   8:     0x7fe7e70b5d95 - std::panicking::default_hook::{{closure}}::h4245258b50e37e69\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panicking.rs:208:50\r\n   9:     0x7fe7e70b58f3 - std::panicking::default_hook::h7b00dcc1d0944747\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panicking.rs:225:9\r\n  10:     0x7fe7e7917f3b - rustc_driver::report_ice::hd11b2540f4ebea82\r\n  11:     0x7fe7d1efb506 - <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call::hb235817cd188ea25\r\n                               at /home/nick/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:1535:9\r\n  12:     0x7fe7d1f21b19 - proc_macro::bridge::client::<impl proc_macro::bridge::Bridge>::enter::{{closure}}::{{closure}}::h7f8d2074dfba5d83\r\n                               at /home/nick/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/proc_macro/src/bridge/client.rs:320:21\r\n  13:     0x7fe7e70b6696 - std::panicking::rust_panic_with_hook::h71e6a073d87de1f5\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panicking.rs:595:17\r\n  14:     0x7fe7e70b61b7 - std::panicking::begin_panic_handler::{{closure}}::hd549436f6bb6dbb8\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panicking.rs:497:13\r\n  15:     0x7fe7e70b237c - std::sys_common::backtrace::__rust_end_short_backtrace::h4e5f4b72b04174c3\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/sys_common/backtrace.rs:141:18\r\n  16:     0x7fe7e70b6119 - rust_begin_unwind\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panicking.rs:493:5\r\n  17:     0x7fe7e70b60cb - std::panicking::begin_panic_fmt::h818c3c917eaeb432\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panicking.rs:435:5\r\n  18:     0x7fe7e94c5e8e - rustc_ast_lowering::LoweringContext::lower_node_id_generic::h002cd4f9b856a42a\r\n  19:     0x7fe7e94c0823 - rustc_ast_lowering::path::<impl rustc_ast_lowering::LoweringContext>::lower_qpath::h948d180b7a292ea4\r\n  20:     0x7fe7e94d4ad4 - rustc_data_structures::stack::ensure_sufficient_stack::haf3691f03b57c500\r\n  21:     0x7fe7e94cf18f - rustc_ast_lowering::Arena::alloc_from_iter::hb07baa383b21d949\r\n  22:     0x7fe7e94d5558 - rustc_data_structures::stack::ensure_sufficient_stack::haf3691f03b57c500\r\n  23:     0x7fe7e94d978a - <smallvec::SmallVec<A> as core::iter::traits::collect::Extend<<A as smallvec::Array>::Item>>::extend::h804dbd4869de84ce\r\n  24:     0x7fe7e94b8a9f - rustc_ast_lowering::expr::<impl rustc_ast_lowering::LoweringContext>::lower_exprs::h31ae1104318e374f\r\n  25:     0x7fe7e94d4d37 - rustc_data_structures::stack::ensure_sufficient_stack::haf3691f03b57c500\r\n  26:     0x7fe7ea0c3f32 - rustc_ast_lowering::expr::<impl rustc_ast_lowering::LoweringContext>::lower_expr_if_let::hc3e641198888b81e\r\n  27:     0x7fe7e94d58f6 - rustc_data_structures::stack::ensure_sufficient_stack::haf3691f03b57c500\r\n  28:     0x7fe7e94b7d40 - core::ops::function::impls::<impl core::ops::function::FnMut<A> for &mut F>::call_mut::hb22a697bd9a38dee\r\n  29:     0x7fe7e94d7409 - <core::iter::adapters::flatten::Flatten<I> as core::iter::traits::iterator::Iterator>::next::h9267902070b24882\r\n  30:     0x7fe7e94d9393 - <smallvec::SmallVec<A> as core::iter::traits::collect::Extend<<A as smallvec::Array>::Item>>::extend::h523719ca991d7de5\r\n  31:     0x7fe7e94d0f96 - rustc_arena::cold_path::h2d0592dc184bf65c\r\n  32:     0x7fe7ea0c3648 - rustc_ast_lowering::expr::<impl rustc_ast_lowering::LoweringContext>::lower_expr_if::h4e01bb73047fe9d5\r\n  33:     0x7fe7e94d548f - rustc_data_structures::stack::ensure_sufficient_stack::haf3691f03b57c500\r\n  34:     0x7fe7e94cd9dd - rustc_ast_lowering::LoweringContext::lower_stmt::h89627d805bec8b65\r\n  35:     0x7fe7e94b7daa - core::ops::function::impls::<impl core::ops::function::FnMut<A> for &mut F>::call_mut::hb22a697bd9a38dee\r\n  36:     0x7fe7e94d7409 - <core::iter::adapters::flatten::Flatten<I> as core::iter::traits::iterator::Iterator>::next::h9267902070b24882\r\n  37:     0x7fe7e94d9393 - <smallvec::SmallVec<A> as core::iter::traits::collect::Extend<<A as smallvec::Array>::Item>>::extend::h523719ca991d7de5\r\n  38:     0x7fe7e94d0f96 - rustc_arena::cold_path::h2d0592dc184bf65c\r\n  39:     0x7fe7ea0c4088 - rustc_ast_lowering::expr::<impl rustc_ast_lowering::LoweringContext>::lower_expr_if_let::hc3e641198888b81e\r\n  40:     0x7fe7e94d58f6 - rustc_data_structures::stack::ensure_sufficient_stack::haf3691f03b57c500\r\n  41:     0x7fe7e94cd9dd - rustc_ast_lowering::LoweringContext::lower_stmt::h89627d805bec8b65\r\n  42:     0x7fe7e94b7daa - core::ops::function::impls::<impl core::ops::function::FnMut<A> for &mut F>::call_mut::hb22a697bd9a38dee\r\n  43:     0x7fe7e94d7409 - <core::iter::adapters::flatten::Flatten<I> as core::iter::traits::iterator::Iterator>::next::h9267902070b24882\r\n  44:     0x7fe7e94d9393 - <smallvec::SmallVec<A> as core::iter::traits::collect::Extend<<A as smallvec::Array>::Item>>::extend::h523719ca991d7de5\r\n  45:     0x7fe7e94d0f96 - rustc_arena::cold_path::h2d0592dc184bf65c\r\n  46:     0x7fe7e94bd998 - rustc_ast_lowering::item::<impl rustc_ast_lowering::LoweringContext>::lower_maybe_async_body::he02a6308a00b8208\r\n  47:     0x7fe7e94ba665 - rustc_ast_lowering::item::<impl rustc_ast_lowering::LoweringContext>::lower_item::h3ba67499588754eb\r\n  48:     0x7fe7e94c76d5 - rustc_ast_lowering::LoweringContext::with_hir_id_owner::h7b2fa9b481f88b61\r\n  49:     0x7fe7e94d0ad3 - <rustc_ast_lowering::item::ItemLowerer as rustc_ast::visit::Visitor>::visit_mod::h73d8ca6d3aa148c9\r\n  50:     0x7fe7e94e381e - rustc_ast::visit::walk_item::hebaa139b96b09853\r\n  51:     0x7fe7e94b9239 - rustc_ast_lowering::item::<impl rustc_ast_lowering::LoweringContext>::with_parent_item_lifetime_defs::h852a078c86fec3d5\r\n  52:     0x7fe7e94d0aec - <rustc_ast_lowering::item::ItemLowerer as rustc_ast::visit::Visitor>::visit_mod::h73d8ca6d3aa148c9\r\n  53:     0x7fe7e94c3406 - rustc_ast_lowering::lower_crate::hb73d62985cd7bb14\r\n  54:     0x7fe7e9cb790f - rustc_interface::passes::BoxedResolver::access::{{closure}}::hb9c484859450932f\r\n  55:     0x7fe7e9ca8f54 - rustc_interface::passes::configure_and_expand::{{closure}}::h3a41a297ff107384\r\n  56:     0x7fe7e9cb7756 - rustc_interface::passes::BoxedResolver::access::hfd0e687e2c8082e4\r\n  57:     0x7fe7e9cc71b5 - rustc_interface::queries::Queries::lower_to_hir::h526946090fe9ea3a\r\n  58:     0x7fe7e9cc7c1e - rustc_interface::queries::Queries::global_ctxt::hd6c3bc1c7f006419\r\n  59:     0x7fe7e9c5bc23 - rustc_interface::queries::<impl rustc_interface::interface::Compiler>::enter::hc8c0f3e9bba77540\r\n  60:     0x7fe7e9c55643 - rustc_span::with_source_map::hedfeccc0422f91c4\r\n  61:     0x7fe7e9c5ceca - rustc_interface::interface::create_compiler_and_run::h7abf0b53119fd7ea\r\n  62:     0x7fe7e9c55d05 - rustc_span::with_session_globals::hb5dbfdbd3bd12723\r\n  63:     0x7fe7e9c5d36a - std::sys_common::backtrace::__rust_begin_short_backtrace::hfe0fde7e082e2baf\r\n  64:     0x7fe7e9c79c4a - core::ops::function::FnOnce::call_once{{vtable.shim}}::h83306388c44d16bf\r\n  65:     0x7fe7e70c6c8a - <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once::h61144a2be4ee36d8\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/alloc/src/boxed.rs:1521:9\r\n  66:     0x7fe7e70c6c8a - <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once::hcf5d395fdd120c17\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/alloc/src/boxed.rs:1521:9\r\n  67:     0x7fe7e70c6c8a - std::sys::unix::thread::Thread::new::thread_start::hb5e40d3d934ebb7a\r\n                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/sys/unix/thread.rs:71:17\r\n  68:     0x7fe7e6fd8299 - start_thread\r\n  69:     0x7fe7e6eed053 - clone\r\n  70:                0x0 - <unknown>\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n", "closed_by": {"login": "nickbp", "id": 35933, "node_id": "MDQ6VXNlcjM1OTMz", "avatar_url": "https://avatars.githubusercontent.com/u/35933?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nickbp", "html_url": "https://github.com/nickbp", "followers_url": "https://api.github.com/users/nickbp/followers", "following_url": "https://api.github.com/users/nickbp/following{/other_user}", "gists_url": "https://api.github.com/users/nickbp/gists{/gist_id}", "starred_url": "https://api.github.com/users/nickbp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nickbp/subscriptions", "organizations_url": "https://api.github.com/users/nickbp/orgs", "repos_url": "https://api.github.com/users/nickbp/repos", "events_url": "https://api.github.com/users/nickbp/events{/privacy}", "received_events_url": "https://api.github.com/users/nickbp/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/84952/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/84952/timeline", "performed_via_github_app": null, "state_reason": "completed"}