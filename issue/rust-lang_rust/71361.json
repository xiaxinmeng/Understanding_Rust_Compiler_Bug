{"url": "https://api.github.com/repos/rust-lang/rust/issues/71361", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/71361/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/71361/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/71361/events", "html_url": "https://github.com/rust-lang/rust/issues/71361", "id": 603387257, "node_id": "MDU6SXNzdWU2MDMzODcyNTc=", "number": 71361, "title": "Non-reproducible builds depending on the compiling OS", "user": {"login": "gendx", "id": 4346404, "node_id": "MDQ6VXNlcjQzNDY0MDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4346404?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gendx", "html_url": "https://github.com/gendx", "followers_url": "https://api.github.com/users/gendx/followers", "following_url": "https://api.github.com/users/gendx/following{/other_user}", "gists_url": "https://api.github.com/users/gendx/gists{/gist_id}", "starred_url": "https://api.github.com/users/gendx/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gendx/subscriptions", "organizations_url": "https://api.github.com/users/gendx/orgs", "repos_url": "https://api.github.com/users/gendx/repos", "events_url": "https://api.github.com/users/gendx/events{/privacy}", "received_events_url": "https://api.github.com/users/gendx/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 609101895, "node_id": "MDU6TGFiZWw2MDkxMDE4OTU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-cargo", "name": "T-cargo", "color": "bfd4f2", "default": false, "description": "Relevant to the cargo team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1508600909, "node_id": "MDU6TGFiZWwxNTA4NjAwOTA5", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-reproducibility", "name": "A-reproducibility", "color": "f7e101", "default": false, "description": "Area: Reproducible / Deterministic builds"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2020-04-20T16:56:23Z", "updated_at": "2020-04-21T14:12:46Z", "closed_at": "2020-04-21T14:12:46Z", "author_association": "NONE", "active_lock_reason": null, "body": "[Tock](https://github.com/tock/tock) is an operating system written in Rust for embedded platforms (e.g. Cortex-M, RISC-V). We've been trying to make builds reproducible, with good progress (https://github.com/tock/tock/issues/1666). In particular:\r\n- pinning a version of the Rust compiler,\r\n- using `--remap-path-prefix`,\r\n- using a Cargo workspace,\r\n- using `cargo rustc` to avoid passing custom linker arguments (that include paths on the filesystem) to the dependencies.\r\n\r\nThis allows reproducibility of the builds on various Linux machines.\r\n\r\nHowever, the builds are different on MacOS, as evidenced by CI on a GitHub workflow (https://github.com/google/OpenSK/pull/94#issuecomment-616671549).\r\n\r\nIn particular, the issue seems to stem from a different `-C metadata=` (and `-C extra-filename=`) passed to `rustc` (while the steps that I mentioned above make sure that the same `metadata` hash is passed across Linux machines for each crate in the project).\r\n\r\nThese are built with the `--verbose` parameter passed to `cargo`, and an example `rustc` invocation is the following (`tock_cells` crate of the Tock project). Do you have any idea of which invocation parameter could cause the `metadata` to be different?\r\n\r\n- On Linux (https://github.com/google/OpenSK/pull/94/checks?check_run_id=602439620): `rustc --crate-name tock_cells libraries/tock-cells/src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts --crate-type lib --emit=dep-info,metadata,link -C opt-level=z -C panic=abort -C debuginfo=2 -C metadata=92487154152022d3 -C extra-filename=-92487154152022d3 --out-dir /home/runner/work/OpenSK/OpenSK/third_party/tock/target/thumbv7em-none-eabi/release/deps --target thumbv7em-none-eabi -L dependency=/home/runner/work/OpenSK/OpenSK/third_party/tock/target/thumbv7em-none-eabi/release/deps -L dependency=/home/runner/work/OpenSK/OpenSK/third_party/tock/target/release/deps -C link-arg=-Tlayout.ld -C linker=rust-lld -C linker-flavor=ld.lld -C relocation-model=dynamic-no-pic -C link-arg=-zmax-page-size=512 -C link-arg=-icf=all --remap-path-prefix=/home/runner/work/OpenSK/OpenSK/third_party/tock/= -D warnings`\r\n- On OSX (https://github.com/google/OpenSK/pull/94/checks?check_run_id=602439631): `rustc --crate-name tock_cells libraries/tock-cells/src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts --crate-type lib --emit=dep-info,metadata,link -C opt-level=z -C panic=abort -C debuginfo=2 -C metadata=9fc982d890c0358d -C extra-filename=-9fc982d890c0358d --out-dir /Users/runner/runners/2.169.0/work/OpenSK/OpenSK/third_party/tock/target/thumbv7em-none-eabi/release/deps --target thumbv7em-none-eabi -L dependency=/Users/runner/runners/2.169.0/work/OpenSK/OpenSK/third_party/tock/target/thumbv7em-none-eabi/release/deps -L dependency=/Users/runner/runners/2.169.0/work/OpenSK/OpenSK/third_party/tock/target/release/deps -C link-arg=-Tlayout.ld -C linker=rust-lld -C linker-flavor=ld.lld -C relocation-model=dynamic-no-pic -C link-arg=-zmax-page-size=512 -C link-arg=-icf=all --remap-path-prefix=/Users/runner/runners/2.169.0/work/OpenSK/OpenSK/third_party/tock/= -D warnings`\r\n\r\nThis could be relevant to #34902, although this issue is more specific.", "closed_by": {"login": "gendx", "id": 4346404, "node_id": "MDQ6VXNlcjQzNDY0MDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4346404?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gendx", "html_url": "https://github.com/gendx", "followers_url": "https://api.github.com/users/gendx/followers", "following_url": "https://api.github.com/users/gendx/following{/other_user}", "gists_url": "https://api.github.com/users/gendx/gists{/gist_id}", "starred_url": "https://api.github.com/users/gendx/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gendx/subscriptions", "organizations_url": "https://api.github.com/users/gendx/orgs", "repos_url": "https://api.github.com/users/gendx/repos", "events_url": "https://api.github.com/users/gendx/events{/privacy}", "received_events_url": "https://api.github.com/users/gendx/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/71361/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/71361/timeline", "performed_via_github_app": null, "state_reason": "completed"}