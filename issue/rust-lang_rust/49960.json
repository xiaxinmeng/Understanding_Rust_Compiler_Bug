{"url": "https://api.github.com/repos/rust-lang/rust/issues/49960", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/49960/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/49960/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/49960/events", "html_url": "https://github.com/rust-lang/rust/issues/49960", "id": 314309948, "node_id": "MDU6SXNzdWUzMTQzMDk5NDg=", "number": 49960, "title": "Shouldn't ICE when owned_box has wrong type", "user": {"login": "glandium", "id": 1038527, "node_id": "MDQ6VXNlcjEwMzg1Mjc=", "avatar_url": "https://avatars.githubusercontent.com/u/1038527?v=4", "gravatar_id": "", "url": "https://api.github.com/users/glandium", "html_url": "https://github.com/glandium", "followers_url": "https://api.github.com/users/glandium/followers", "following_url": "https://api.github.com/users/glandium/following{/other_user}", "gists_url": "https://api.github.com/users/glandium/gists{/gist_id}", "starred_url": "https://api.github.com/users/glandium/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/glandium/subscriptions", "organizations_url": "https://api.github.com/users/glandium/orgs", "repos_url": "https://api.github.com/users/glandium/repos", "events_url": "https://api.github.com/users/glandium/events{/privacy}", "received_events_url": "https://api.github.com/users/glandium/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-04-14T08:11:22Z", "updated_at": "2018-04-14T08:41:41Z", "closed_at": "2018-04-14T08:41:41Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Starting from this code:\r\n\r\n```rust\r\n#![feature(lang_items, box_syntax, owned_box, start)]\r\n#![no_std]\r\n\r\n#[start]\r\npub fn start(_: isize, _: *const *const u8) -> isize { \r\n    let x = box 1i32;\r\n    0\r\n}\r\n\r\n#[lang = \"eh_personality\"] extern fn eh_personality() {}\r\n#[lang = \"eh_unwind_resume\"] extern fn eh_unwind_resume() {}\r\n#[lang = \"panic_fmt\"] fn panic_fmt() -> ! { loop {} }\r\n\r\n#[lang = \"exchange_malloc\"]\r\nunsafe fn exchange_malloc(size: usize, align: usize) -> *mut u8 {\r\n    core::ptr::null_mut()\r\n}\r\n```\r\n\r\nAdding various `owned_box` patterns leads to different kinds of ICE:\r\n```rust\r\n#[lang = \"owned_box\"]\r\nstruct Box;\r\n```\r\nyields\r\n```\r\nthread 'main' panicked at 'index out of bounds: the len is 0 but the index is 0', /checkout/src/libcore/slice/mod.rs:865:10\r\n```\r\n\r\n```rust\r\n#[lang = \"owned_box\"]\r\nstruct Box<T>(Option<T>);\r\n```\r\n\r\nyields\r\n```\r\nerror: internal compiler error: librustc_trans/mir/operand.rs:175: Deref of by-Ref operand OperandRef(Ref((%\"Box<i32>\"*:  %3 = alloca %\"Box<i32>\", align 4), Align { abi: 2, pref: 3 }) @ TyLayout { ty: Box<i32>, details: LayoutDetails { variants: Single { index: 0 }, fields: Arbitrary { offsets: [Size { raw: 0 }], memory_index: [0] }, abi: Aggregate { sized: true }, align: Align { abi: 2, pref: 3 }, size: Size { raw: 8 } } })\r\n\r\nthread 'main' panicked at 'Box<Any>', librustc_errors/lib.rs:542:9\r\n```\r\n\r\n```rust\r\n#[lang = \"owned_box\"]\r\nstruct Box<T>(u8, T);\r\n```\r\nyields\r\n```\r\nerror: internal compiler error: librustc/ty/layout.rs:2245: TyLayout::field_type(TyLayout { ty: *mut i32, details: LayoutDetails { variants: Single { index: 0 }, fields: Union(0), abi: Scalar(Scalar { value: Pointer, valid_range: 0..=18446744073709551615 }), align: Align { abi: 3, pref: 3 }, size: Size { raw: 8 } } }): not applicable\r\n\r\nthread 'main' panicked at 'Box<Any>', librustc_errors/lib.rs:542:9\r\n```\r\n\r\n```rust\r\n#[lang = \"owned_box\"]\r\nstruct Box<T, U>(T, U);\r\n```\r\nyields\r\n```\r\nerror: internal compiler error: librustc/ty/subst.rs:493: Type parameter `U/#1` (U/1) out of range when substituting (root type=Some(U)) substs=[i32]\r\n\r\nthread 'main' panicked at 'Box<Any>', librustc_errors/lib.rs:487:9\r\n```\r\n", "closed_by": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/49960/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/49960/timeline", "performed_via_github_app": null, "state_reason": "completed"}