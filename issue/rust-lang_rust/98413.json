{"url": "https://api.github.com/repos/rust-lang/rust/issues/98413", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/98413/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/98413/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/98413/events", "html_url": "https://github.com/rust-lang/rust/issues/98413", "id": 1281654181, "node_id": "I_kwDOAAsO6M5MZH2l", "number": 98413, "title": "rustdoc: adjust static file names for better cache configuration", "user": {"login": "jsha", "id": 220205, "node_id": "MDQ6VXNlcjIyMDIwNQ==", "avatar_url": "https://avatars.githubusercontent.com/u/220205?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsha", "html_url": "https://github.com/jsha", "followers_url": "https://api.github.com/users/jsha/followers", "following_url": "https://api.github.com/users/jsha/following{/other_user}", "gists_url": "https://api.github.com/users/jsha/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsha/subscriptions", "organizations_url": "https://api.github.com/users/jsha/orgs", "repos_url": "https://api.github.com/users/jsha/repos", "events_url": "https://api.github.com/users/jsha/events{/privacy}", "received_events_url": "https://api.github.com/users/jsha/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 203738, "node_id": "MDU6TGFiZWwyMDM3Mzg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-rustdoc", "name": "T-rustdoc", "color": "bfd4f2", "default": false, "description": "Relevant to the rustdoc team, which will review and decide on the PR/issue."}, {"id": 593503757, "node_id": "MDU6TGFiZWw1OTM1MDM3NTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-infra", "name": "T-infra", "color": "bfd4f2", "default": false, "description": "Relevant to the infrastructure team, which will review and decide on the PR/issue."}, {"id": 2795630663, "node_id": "MDU6TGFiZWwyNzk1NjMwNjYz", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-docs-rs", "name": "T-docs-rs", "color": "bfd4f2", "default": false, "description": "Relevant to the docs-rs subteam, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 18, "created_at": "2022-06-23T03:41:05Z", "updated_at": "2022-11-05T20:39:01Z", "closed_at": "2022-11-05T20:39:01Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "rustdoc has a number of static files that should really be long-cached by the browser for best loading performance: the fonts, the CSS, storage.js, main.js, and so on. We should add a hash to their names so that services can be more confident in setting long cache headers for them.\r\n\r\nRight now we categorize things into Unversioned, ToolchainSpecific, and InvocationSpecific:\r\n\r\nhttps://github.com/rust-lang/rust/blob/10f4ce324baf7cfb7ce2b2096662b82b79204944/src/librustdoc/html/render/write_shared.rs#L44-L57\r\n\r\nUnversioned is used just for the font files. ToolchainSpecific is used for the CSS, the images, and most of the JS. InvocationSpecific is used for `search-indexN.NN.N.js`, `source-filesN.NN.N.js`, `cratesN.NN.N.js`, the JS that contains the list of implementors on trait pages, and the JS that contains the list of additional sidebar items (siblings in a module).\r\n\r\nUnversioned gets no infix. ToolchainSpecific gets a version suffix, like `main1.63.0.js` (from `main.js`). InvocationSpecific gets the same version suffix.\r\n\r\nUnversioned and ToolchainSpecific files should be infinitely cacheable. Right now, that's not the case for ToolchainSpecific, because multiple toolchains have the same version infix. For instance, every nightly build right now creates a `main1.63.0.js`, but it's potentially different each night. That means https://doc.rust-lang.org/nightly/main1.63.0.js potentially changes every night, and can't be long-cached. Since `docs.rs` uses the nightly toolchain, the `main1.63.0.js` it produces for a crate today may be different than the one it produces for a crate it builds tomorrow.\r\n\r\n`docs.rs` has special code to recognize the ToolchainSpecific files and rename them to contain a date and a hash, like https://docs.rs/main-20220517-1.63.0-nightly-4c5f6e627.js. But `doc.rust-lang.org` doesn't have that code, and as a result is less able to cache things that should be cached. And anyone who self-hosts docs is on their own.\r\n\r\nI propose that we change our file naming scheme. All Unversioned and ToolchainSpecific files should be emitted to a subdirectory `s/<hash>/`, where `<hash>` is calculated over the contents of all of those files together. This makes it easy to configure a web server to set Cache-Control headers for everything under that subdirectory.\r\n\r\nAdvantage: this makes calculating URLs for such resources easy, especially when the calculation is done in JS. Disadvantage: if one file changes, the whole hash changes, potentially requiring the user to load more files when navigating between crates generated with different rustdoc versions.\r\n\r\nAlternately, we could add a hash of each individual file to that file's name. That makes calculating URLs harder, but means better reuse of cached data across different nightly versions.\r\n\r\n/cc @rust-lang/rustdoc @rust-lang/docs-rs ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/98413/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/98413/timeline", "performed_via_github_app": null, "state_reason": "completed"}