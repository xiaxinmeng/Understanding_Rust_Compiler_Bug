{"url": "https://api.github.com/repos/rust-lang/rust/issues/92133", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/92133/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/92133/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/92133/events", "html_url": "https://github.com/rust-lang/rust/issues/92133", "id": 1085103825, "node_id": "I_kwDOAAsO6M5ArV7R", "number": 92133, "title": "When trying to use cross language LTO on windows for the MSVC target, proc macros give a linker error without an explicit target", "user": {"login": "nico-abram", "id": 24706838, "node_id": "MDQ6VXNlcjI0NzA2ODM4", "avatar_url": "https://avatars.githubusercontent.com/u/24706838?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nico-abram", "html_url": "https://github.com/nico-abram", "followers_url": "https://api.github.com/users/nico-abram/followers", "following_url": "https://api.github.com/users/nico-abram/following{/other_user}", "gists_url": "https://api.github.com/users/nico-abram/gists{/gist_id}", "starred_url": "https://api.github.com/users/nico-abram/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nico-abram/subscriptions", "organizations_url": "https://api.github.com/users/nico-abram/orgs", "repos_url": "https://api.github.com/users/nico-abram/repos", "events_url": "https://api.github.com/users/nico-abram/events{/privacy}", "received_events_url": "https://api.github.com/users/nico-abram/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2021-12-20T18:54:54Z", "updated_at": "2022-04-25T08:00:21Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I'm building a hello world generated by cargo, using this .cargo/config:\r\n\r\n```toml\r\n[target.x86_64-pc-windows-msvc]\r\nlinker = \"lld-link.exe\"\r\nrustflags = [\"-Clinker=lld-link\", \"-Clinker-plugin-lto\"]\r\n```\r\n\r\nI have LLVM/bin (From LLVM13 to match my current rust LLVM version) in my path. `cargo build` runs fine. But as soon as I add a dependency with a proc macro, it results in a linking error. For example:\r\n\r\n```toml\r\n[dependencies]\r\nthiserror=\"1.0.30\"\r\n```\r\n\r\nResults in:\r\n\r\n```\r\n    Updating crates.io index\r\n   Compiling proc-macro2 v1.0.34\r\n   Compiling unicode-xid v0.2.2\r\n   Compiling syn v1.0.82\r\n   Compiling quote v1.0.10\r\n   Compiling thiserror-impl v1.0.30\r\nerror: Linker plugin based LTO is not supported together with `-C prefer-dynamic` when targeting Windows-like targets\r\n\r\nerror: could not compile `thiserror-impl` due to previous error\r\n```\r\n\r\nThis goes away if an explicit target is used: `cargo build --target x86_64-pc-windows-msvc`\r\n\r\nAfter reading the cargo docs [here](https://doc.rust-lang.org/cargo/reference/config.html) \r\n\r\n```\r\nIf the --target flag (or build.target) is used, then the flags will only be passed to the compiler for the target.\r\nThings being built for the host, such as build scripts or proc macros, will not receive the args.\r\nWithout --target, the flags will be passed to all compiler invocations (including build scripts and proc macros) because dependencies are shared.\r\nIf you have args that you do not want to pass to build scripts or proc macros and are building for the host, pass --target with the host triple.\r\n```\r\n\r\nIt makes sense but this is still super confusing, and the only reason I got it to work is someone suggested it to me. Could this restriction on prefer-dynamic + linker-plugin-lto be softened on proc-macros, or maybe the error message improved to suggest using an explicit target?", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/92133/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/92133/timeline", "performed_via_github_app": null, "state_reason": null}