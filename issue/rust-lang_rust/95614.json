{"url": "https://api.github.com/repos/rust-lang/rust/issues/95614", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/95614/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/95614/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/95614/events", "html_url": "https://github.com/rust-lang/rust/issues/95614", "id": 1190906013, "node_id": "I_kwDOAAsO6M5G-8id", "number": 95614, "title": "Documentation error in `with_capacity` family of methods", "user": {"login": "jmaargh", "id": 11151181, "node_id": "MDQ6VXNlcjExMTUxMTgx", "avatar_url": "https://avatars.githubusercontent.com/u/11151181?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jmaargh", "html_url": "https://github.com/jmaargh", "followers_url": "https://api.github.com/users/jmaargh/followers", "following_url": "https://api.github.com/users/jmaargh/following{/other_user}", "gists_url": "https://api.github.com/users/jmaargh/gists{/gist_id}", "starred_url": "https://api.github.com/users/jmaargh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jmaargh/subscriptions", "organizations_url": "https://api.github.com/users/jmaargh/orgs", "repos_url": "https://api.github.com/users/jmaargh/repos", "events_url": "https://api.github.com/users/jmaargh/events{/privacy}", "received_events_url": "https://api.github.com/users/jmaargh/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 431251592, "node_id": "MDU6TGFiZWw0MzEyNTE1OTI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-docs", "name": "A-docs", "color": "f7e101", "default": false, "description": "Area: documentation for any part of the project, including the compiler, standard library, and tools"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2022-04-03T11:43:37Z", "updated_at": "2022-06-24T04:37:20Z", "closed_at": "2022-06-24T04:37:20Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "As discussed [here](https://github.com/rust-lang/rust/issues/43490), methods like `Vec::with_capacity` are guaranteed to create a container with _at least_ the specified capacity, but are allowed to allocate more.\r\n\r\nThe easiest way to see this is with zero-sized types, since no allocation is necessary and capacity is always `usize::MAX` (I assume).\r\n\r\nHowever, the documentation states \"Constructs a new, empty `Vec<T>` with the specified capacity. The vector will be able to hold exactly capacity elements without reallocating.\" This is wrong, especially so with the use of the word \"exactly\". I've picked on `Vec::with_capacity` here, but all of the other standard library `with_capacity` and `with_capacity_in` methods I've checked have the same issue.\r\n\r\nObviously the case of zero-sized types is a trivial example, but this is a safety issue if you're breaking containers into raw parts (e.g. for FFI) and then reconstructing them. For example the following is not sound, but the documentation says it is:\r\n```rust\r\nconst CAPACITY: usize = 123;\r\nlet mut cstr = Vec::<u8>::with_capacity(CAPACITY);\r\nlet ptr = cstr.as_mut_ptr();\r\nlet mut length = 0;\r\nstd::mem::forget(cstr);\r\n\r\nlet returned_string = unsafe {\r\n  ffi_that_fills_the_string(CAPACITY, &mut length, ptr);\r\n  Vec::from_raw_parts(ptr, length, CAPACITY);\r\n}\r\n\r\nlet returned_string = String::from_utf8(returned_string)?;\r\n```\r\nSince the allocator is allowed to allocate more than `CAPACITY`, making the call to `from_raw_parts` unsound.\r\n\r\nThe documentation for `reserve` and `reserve_exact` on the other hand are accurate (though I'm not sure why `reserve_exact` exists, or certainly why it has that name, if it can't guarantee exact allocation).", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/95614/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/95614/timeline", "performed_via_github_app": null, "state_reason": "completed"}