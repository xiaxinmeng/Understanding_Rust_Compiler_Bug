{"url": "https://api.github.com/repos/rust-lang/rust/issues/44080", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/44080/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/44080/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/44080/events", "html_url": "https://github.com/rust-lang/rust/issues/44080", "id": 252857288, "node_id": "MDU6SXNzdWUyNTI4NTcyODg=", "number": 44080, "title": "chars/bytes confusion in the error emitter", "user": {"login": "est31", "id": 8872119, "node_id": "MDQ6VXNlcjg4NzIxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8872119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/est31", "html_url": "https://github.com/est31", "followers_url": "https://api.github.com/users/est31/followers", "following_url": "https://api.github.com/users/est31/following{/other_user}", "gists_url": "https://api.github.com/users/est31/gists{/gist_id}", "starred_url": "https://api.github.com/users/est31/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/est31/subscriptions", "organizations_url": "https://api.github.com/users/est31/orgs", "repos_url": "https://api.github.com/users/est31/repos", "events_url": "https://api.github.com/users/est31/events{/privacy}", "received_events_url": "https://api.github.com/users/est31/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-08-25T10:17:11Z", "updated_at": "2018-02-10T03:06:18Z", "closed_at": "2018-02-10T03:06:18Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "`src/librustc_errors/snippet.rs` has [big comment](https://github.com/rust-lang/rust/blob/32b50e280faf56f21cbd82d1cf82cb4795535143/src/librustc_errors/snippet.rs#L123-L124) saying that the column info is provided in characters, not in bytes. However, the error emitter doesn't care about that at all and uses these like byte offsets all over the place. This leads to bugs like #44023 and #44078 .\r\n\r\nAs an example, look how span printing varies with varying characters used:\r\n\r\nCorrect case:\r\n\r\n```\r\n12 |       \"B   \"\";\r\n   |  ___________^\r\n```\r\n\r\nNow add an emoji character:\r\n\r\n```\r\n12 |       \"\ud83d\ude0a   \"\";\r\n   |  ___________^\r\n```\r\n\r\nNote how its off by one char now. This can stack up:\r\n\r\n```\r\n12 |       \"\ud83d\ude0a\ud83d\ude0a\ud83d\ude0a\ud83d\ude0a   \"\";\r\n   |  ______________^\r\n```\r\n\r\nIf I didn't use any spaces at all, I'd run into #44078.\r\n\r\nNow this can be fixed by going through the emitter code and looking for all places where the pos is used in a byte position fashion. A much more proper fix instead is to stop trusting that people read comments and encode this via the type system. There is already a mechanism for that inside the compiler, its `libsyntax_pos::CharPos`! Just convert the types of `start_col`, `end_col` members of the `MultilineAnnotation` and `Annotation` structs to `CharPos`, or maybe to `BytePos` if that's preferred.", "closed_by": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/44080/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/44080/timeline", "performed_via_github_app": null, "state_reason": "completed"}