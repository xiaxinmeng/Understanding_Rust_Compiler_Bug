{"url": "https://api.github.com/repos/rust-lang/rust/issues/47770", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/47770/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/47770/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/47770/events", "html_url": "https://github.com/rust-lang/rust/issues/47770", "id": 291857350, "node_id": "MDU6SXNzdWUyOTE4NTczNTA=", "number": 47770, "title": "ThinLTO bloats size of bare metal programs by up to 1200%", "user": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2018-01-26T10:24:56Z", "updated_at": "2018-01-26T21:47:53Z", "closed_at": "2018-01-26T21:47:53Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Original report: https://github.com/japaric/stm32f103xx-hal/issues/44\r\n\r\n### STR\r\n\r\n``` console\r\n$ git clone https://github.com/japaric/stm32f103xx-hal\r\n\r\n$ cd stm32f103xx-hal\r\n\r\n$ git checkout 9f80811a6026f0849ce2afee5baf0cf086563b65\r\n\r\n$ xargo build --example reactive-serial-circ --release\r\n(..)\r\n    Finished release [optimized + debuginfo] target(s) in 13.52 secs\r\n(..)\r\n    Finished release [optimized + debuginfo] target(s) in 2.24 secs\r\n(..)\r\n    Finished release [optimized + debuginfo] target(s) in 38.37 secs\r\n\r\n$ arm-none-eabi-size target/thumbv7m-none-eabi/release/examples/reactive-serial-circ\r\n   text    data     bss     dec     hex filename\r\n  12154       8      20   12182    2f96 (..)\r\n\r\n$ xargo bloat --example reactive-serial-circ --release\r\nFile  .text   Size Name\r\n0.0%   2.3%   170B [15 Others]\r\n0.4%  18.9% 1.4KiB core::fmt::Formatter::pad_integral\r\n0.2%  12.9%   962B core::fmt::Formatter::pad\r\n0.2%   9.7%   720B stm32f103xx_hal::rcc::CFGR::freeze\r\n0.2%   9.0%   672B core::str::slice_error_fail\r\n0.1%   7.3%   544B core::fmt::write\r\n0.1%   7.2%   538B <char as core::fmt::Debug>::fmt\r\n0.1%   5.9%   440B _ZN20reactive_serial_circ4main17h416bbf939f973349E.llvm.E85F65E9\r\n0.1%   4.6%   340B cortex_m::peripheral::nvic::<impl cortex_m::peripheral::NVIC>::enable\r\n0.1%   3.6%   266B _ZN4core3fmt10ArgumentV110show_usize17h636fea4f06967745E.llvm.EA6B2883\r\n0.1%   3.6%   266B core::fmt::num::<impl core::fmt::Display for usize>::fmt\r\n0.1%   3.6%   266B core::fmt::num::<impl core::fmt::Debug for usize>::fmt\r\n0.0%   2.4%   182B _ZN4core12char_private5check17h7f91014bbb6a3313E.llvm.9871CEB7\r\n0.0%   1.6%   118B DMA1_CHANNEL5\r\n0.0%   1.4%   106B cortex_m_rt::reset_handler\r\n0.0%   1.2%    92B core::result::unwrap_failed\r\n0.0%   1.0%    78B core::slice::slice_index_order_fail\r\n0.0%   1.0%    78B core::slice::slice_index_len_fail\r\n0.0%   1.0%    74B core::panicking::panic_bounds_check\r\n0.0%   0.9%    70B <core::ops::range::Range<Idx> as core::fmt::Debug>::fmt\r\n0.0%   0.8%    60B core::panicking::panic\r\n1.9% 100.0% 7.3KiB .text section size, the file size is 376.2KiB\r\n```\r\n\r\nChanging `profile.release.codegen-units` to 1 (suggested in other issues) does *not* help. Fully\r\ndisabling ThinLTO passing `-Z thinlto=no` to `rustc` (is there a Cargo.toml setting for that?) fixes\r\nthe binary size problem without meaningfully affecting the compilation speed (if anything it's\r\nslightly faster)\r\n\r\n``` console\r\n$ cat .cargo/config\r\n[target.thumbv7m-none-eabi]\r\nrunner = 'arm-none-eabi-gdb'\r\nrustflags = [\r\n  \"-C\", \"link-arg=-Tlink.x\",\r\n  \"-C\", \"linker=arm-none-eabi-ld\",\r\n  \"-Z\", \"linker-flavor=ld\",\r\n  \"-Z\", \"thinlto=no\", # <-\r\n]\r\n\r\n[build]\r\ntarget = \"thumbv7m-none-eabi\"\r\n\r\n$ xargo build --example reactive-serial-circ --release\r\n(..)\r\n    Finished release [optimized + debuginfo] target(s) in 12.69 secs\r\n(..)\r\n    Finished release [optimized + debuginfo] target(s) in 1.98 secs\r\n(..)\r\n    Finished release [optimized + debuginfo] target(s) in 38.54 secs\r\n\r\n$ arm-none-eabi-size target/thumbv7m-none-eabi/release/examples/reactive-serial-circ\r\n   text    data     bss     dec     hex filename\r\n    890       8      20     918     396 (..)\r\n\r\n$ xargo bloat --example reactive-serial-circ --release\r\nFile  .text Size Name\r\n0.0%   0.0%   0B [0 Others]\r\n0.1%  37.2% 250B reactive_serial_circ::init\r\n0.1%  29.2% 196B cortex_m_rt::reset_handler\r\n0.0%  16.1% 108B DMA1_CHANNEL5\r\n0.0%   1.5%  10B core::result::unwrap_failed\r\n0.0%   1.5%  10B SVCALL\r\n0.0%   1.5%  10B MEM_MANAGE\r\n0.0%   1.5%  10B DEBUG_MONITOR\r\n0.0%   1.5%  10B PENDSV\r\n0.0%   1.5%  10B USAGE_FAULT\r\n0.0%   1.5%  10B SYS_TICK\r\n0.0%   1.5%  10B NMI\r\n0.0%   1.5%  10B DEFAULT_HANDLER\r\n0.0%   1.5%  10B BUS_FAULT\r\n0.0%   1.5%  10B HARD_FAULT\r\n0.0%   0.6%   4B core::panicking::panic_fmt\r\n0.0%   0.6%   4B cortex_m_rt::default_handler\r\n0.3% 100.0% 672B .text section size, the file size is 261.6KiB\r\n```\r\n\r\n### Meta\r\n\r\n``` console\r\n$ rustc -Vv\r\nrustc 1.25.0-nightly (ae920dcc9 2018-01-22)\r\n```\r\n\r\n---\r\n\r\nGiven the severity of the issue I'm going to recommend my users to disable ThinLTO as I already do\r\nwith [parallel codegen and incremental compilation][quickstart].\r\n\r\n[quickstart]: https://github.com/japaric/cortex-m-quickstart/blob/v0.2.3/Cargo.toml#L19\r\n\r\ncc @alexcrichton @aturon \r\ncc #47745", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/47770/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/47770/timeline", "performed_via_github_app": null, "state_reason": "completed"}