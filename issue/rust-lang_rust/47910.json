{"url": "https://api.github.com/repos/rust-lang/rust/issues/47910", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/47910/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/47910/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/47910/events", "html_url": "https://github.com/rust-lang/rust/issues/47910", "id": 293259978, "node_id": "MDU6SXNzdWUyOTMyNTk5Nzg=", "number": 47910, "title": "Unable to compile toolchain targeting Fuchsia with newer, thinner sysroot", "user": {"login": "pylaligand", "id": 1115379, "node_id": "MDQ6VXNlcjExMTUzNzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1115379?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pylaligand", "html_url": "https://github.com/pylaligand", "followers_url": "https://api.github.com/users/pylaligand/followers", "following_url": "https://api.github.com/users/pylaligand/following{/other_user}", "gists_url": "https://api.github.com/users/pylaligand/gists{/gist_id}", "starred_url": "https://api.github.com/users/pylaligand/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pylaligand/subscriptions", "organizations_url": "https://api.github.com/users/pylaligand/orgs", "repos_url": "https://api.github.com/users/pylaligand/repos", "events_url": "https://api.github.com/users/pylaligand/events{/privacy}", "received_events_url": "https://api.github.com/users/pylaligand/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}, {"id": 325438536, "node_id": "MDU6TGFiZWwzMjU0Mzg1MzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-bootstrap", "name": "T-bootstrap", "color": "bfd4f2", "default": false, "description": "Relevant to the bootstrap subteam: Rust's build system (x.py and src/bootstrap)"}, {"id": 630810559, "node_id": "MDU6TGFiZWw2MzA4MTA1NTk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-libtest", "name": "A-libtest", "color": "f7e101", "default": false, "description": "Area: #[test] related"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2018-01-31T18:14:29Z", "updated_at": "2019-12-10T16:22:24Z", "closed_at": "2019-12-10T16:22:24Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "#### Context\r\n\r\nWe're making the Fuchsia sysroot thinner by removing several libraries which now require some special attention in order to be linked in. This applies to libraries such as `fdio`, `launchpad`, and `backtrace` which the Rust toolchain depends on.\r\nWhat this means is that in order to target Fuchsia, one cannot rely on a sysroot alone and needs a proper Fuchsia SDK with these now independent libraries.\r\n\r\n#### Approach\r\n\r\nHere's my attempt at teaching The Rust toolchain build how to find the libraries it needs: https://fuchsia-review.googlesource.com/c/third_party/rust/+/118156\r\nI am running the toolchain build using a custom script which wraps `x.py install`: https://fuchsia.googlesource.com/scripts/+/master/rust/build_toolchain.py\r\n\r\n#### Complications\r\n\r\nThis approach works fine when building `libstd` for `x86_64-unknown-fuchsia`, but fails at the next step of the build which happens to be building `libtest`:\r\n```\r\nrunning: \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage0/bin/cargo\" \"build\" \"--target\" \"x86_64-unknown-fuchsia\" \"-j\" \"48\" \"--release\" \"--manifest-path\" \"/usr/local/google/home/pylaligand/work/rust-in-fuchsia/src/libtest/Cargo.toml\" \"--message-format\" \"json\"\r\n   Compiling term v0.0.0 (file:///usr/local/google/home/pylaligand/work/rust-in-fuchsia/src/libterm)\r\n   Compiling getopts v0.2.15\r\nerror: linking with `/usr/local/google/home/pylaligand/work/fuchsia/buildtools/linux-x64/clang/bin/clang` failed: exit code: 1\r\n  |\r\n  = note: \"/usr/local/google/home/pylaligand/work/fuchsia/buildtools/linux-x64/clang/bin/clang\" \"-m64\" \"-L\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-fuchsia/lib\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term0-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term1-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term10-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term11-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term12-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term13-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term14-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term15-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term2-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term3-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term4-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term5-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term6-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term7-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term8-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.term9-58885e4611cf95bdeaca25d39d9166fc.rs.rcgu.o\" \"-o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/libterm-9b9dc10620e528f0.so\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.crate.metadata.rcgu.o\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps/term-9b9dc10620e528f0.crate.allocator.rcgu.o\" \"-Wl,-O1\" \"-nodefaultlibs\" \"-L\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps\" \"-L\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/release/deps\" \"-L\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-fuchsia/lib\" \"-L\" \"/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-fuchsia/lib\" \"-l\" \"std-11d911d56160c356\" \"-Wl,-Bstatic\" \"/tmp/rustc.lBegFuiKKmOm/libcompiler_builtins-7ee6ad76632d65af.rlib\" \"-Wl,-Bdynamic\" \"-l\" \"zircon\" \"-l\" \"backtrace\" \"-l\" \"fdio\" \"-l\" \"launchpad\" \"-l\" \"unwind\" \"-l\" \"c\" \"-l\" \"fdio\" \"-shared\" \"-Wl,-rpath,$ORIGIN/../lib\" \"--target=x86_64-unknown-fuchsia\" \"--sysroot=/usr/local/google/home/pylaligand/work/fuchsia/out/debug-x86-64/sdks/zircon_minimal/pkg/sysroot\"\r\n  = note: /usr/local/google/home/pylaligand/work/fuchsia/buildtools/linux-x64/clang/bin/ld.lld: error: unable to find library -lbacktrace\r\n          /usr/local/google/home/pylaligand/work/fuchsia/buildtools/linux-x64/clang/bin/ld.lld: error: unable to find library -lfdio\r\n          /usr/local/google/home/pylaligand/work/fuchsia/buildtools/linux-x64/clang/bin/ld.lld: error: unable to find library -llaunchpad\r\n          /usr/local/google/home/pylaligand/work/fuchsia/buildtools/linux-x64/clang/bin/ld.lld: error: unable to find library -lfdio\r\n          clang-7.0: error: ld.lld command failed with exit code 1 (use -v to see invocation)\r\n          \r\n\r\nerror: aborting due to previous error\r\n\r\nerror: Could not compile `term`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `/tmp/fuchsia_rustc_staging/out/build/bootstrap/debug/rustc --crate-name term libterm/lib.rs --error-format json --crate-type dylib --crate-type rlib --emit=dep-info,link -C prefer-dynamic -C opt-level=2 -C metadata=9b9dc10620e528f0 -C extra-filename=-9b9dc10620e528f0 --out-dir /tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps --target x86_64-unknown-fuchsia -C ar=/usr/local/google/home/pylaligand/work/fuchsia/buildtools/linux-x64/clang/bin/llvm-ar -C linker=/usr/local/google/home/pylaligand/work/fuchsia/buildtools/linux-x64/clang/bin/clang -L dependency=/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/x86_64-unknown-fuchsia/release/deps -L dependency=/tmp/fuchsia_rustc_staging/out/build/x86_64-unknown-linux-gnu/stage2-test/release/deps -C link-arg=--target=x86_64-unknown-fuchsia -C link-arg=--sysroot=/usr/local/google/home/pylaligand/work/fuchsia/out/debug-x86-64/sdks/zircon_minimal/pkg/sysroot` (exit code: 101)\r\n```\r\n\r\nThe issue is that the build is trying to link `fdio` and its friends but the clang invocation does not contain the search paths added in the change above and the linking consequently fails.\r\n\r\nI have been unable to identify the code path which draws these Fuchsia libraries into the `libtest` build. Any pointer would be much appreciated!", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/47910/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/47910/timeline", "performed_via_github_app": null, "state_reason": "completed"}