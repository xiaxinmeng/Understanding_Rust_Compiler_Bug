{"url": "https://api.github.com/repos/rust-lang/rust/issues/62588", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/62588/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/62588/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/62588/events", "html_url": "https://github.com/rust-lang/rust/issues/62588", "id": 466933549, "node_id": "MDU6SXNzdWU0NjY5MzM1NDk=", "number": 62588, "title": "Inconsistent `#[link(name = \"\")]` resolution on Windows", "user": {"login": "ralfbiedert", "id": 301288, "node_id": "MDQ6VXNlcjMwMTI4OA==", "avatar_url": "https://avatars.githubusercontent.com/u/301288?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ralfbiedert", "html_url": "https://github.com/ralfbiedert", "followers_url": "https://api.github.com/users/ralfbiedert/followers", "following_url": "https://api.github.com/users/ralfbiedert/following{/other_user}", "gists_url": "https://api.github.com/users/ralfbiedert/gists{/gist_id}", "starred_url": "https://api.github.com/users/ralfbiedert/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ralfbiedert/subscriptions", "organizations_url": "https://api.github.com/users/ralfbiedert/orgs", "repos_url": "https://api.github.com/users/ralfbiedert/repos", "events_url": "https://api.github.com/users/ralfbiedert/events{/privacy}", "received_events_url": "https://api.github.com/users/ralfbiedert/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 266005765, "node_id": "MDU6TGFiZWwyNjYwMDU3NjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows-msvc", "name": "O-windows-msvc", "color": "6e6ec0", "default": false, "description": "Toolchain: MSVC, Operating system: Windows"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2019-07-11T10:29:11Z", "updated_at": "2021-07-09T00:07:49Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!-- Thanks for filing a \ud83d\udc1b bug report \ud83d\ude04! -->\r\n\r\n**Background**\r\n\r\nWe have a Rust project (lets call it `dylib`) where we want to produce a shared library (.dll, .dylib, .so) for various platforms. As part of the build process we also want to verify the provided headers match the library. \r\n\r\nTo do that we have a separate project `dylib_test`, where we extract C doc tests into individual `generated_nnn.c` files, produce a `generated.rs` file that knows all C tests, and emits a `#[test]` for each, which we then want to run with `cargo test`.\r\n\r\nThe `dylib` project should only emit a `cdylib`, and the `dylib_test` should only link against that `cdylib`, to make sure the actual .dll, ... works.  \r\n\r\n\r\n**Problem**\r\nWhen linking against `dylib` from the `dylib_test` crate, the `#[link(name = \"dylib\")]` attribute behaves inconsistently. On Mac and Linux the attribute works. On Windows, it fails with an \r\n\r\n```\r\nerror: linking with `link.exe` failed: exit code: 1181\r\n  |\r\n  = note: \"C:\\\\Program Files (x86)\\\\Microsoft Visual Studio\\\\2019\\\\BuildTools\\\\VC\\\\Tools\\\\MSVC\\\\14.21.27702\\\\bin\\\\HostX64\\\\x64\\\\link.exe\" \"/NOLOGO\" \"/NXCOMPAT\" \"/LIBPATH:C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\deps\\\\dylib_test-16b85ad62e2643c4.17sc3p6xub1nskk5.rcgu.o\" \"D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\deps\\\\dylib_test-16b85ad62e2643c4.1d4yl2ra8f02uq65.rcgu.o\" \"D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\deps\\\\dylib_test-16b85ad62e2643c4.2boci68ky9pbilmt.rcgu.o\" \"D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\deps\\\\dylib_test-16b85ad62e2643c4.2kg3da7ad2y6u5t4.rcgu.o\" \"D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\deps\\\\dylib_test-16b85ad62e2643c4.328elmwbbr69laus.rcgu.o\" \"D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\deps\\\\dylib_test-16b85ad62e2643c4.3pjpoaqleh1qku54.rcgu.o\" \"D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\deps\\\\dylib_test-16b85ad62e2643c4.48cxjx0647kyqroa.rcgu.o\" \"D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\deps\\\\dylib_test-16b85ad62e2643c4.4xn06m0s17xpy7q7.rcgu.o\" \"D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\deps\\\\dylib_test-16b85ad62e2643c4.bdw34kj2m6ietun.rcgu.o\" \"D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\deps\\\\dylib_test-16b85ad62e2643c4.dxf6w5mo3hfjrm.rcgu.o\" \"/OUT:D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\deps\\\\dylib_test-16b85ad62e2643c4.exe\" \"D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\deps\\\\dylib_test-16b85ad62e2643c4.3tou2046e23p3ckg.rcgu.o\" \"/OPT:REF,NOICF\" \"/DEBUG\" \"/NATVIS:C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\etc\\\\intrinsic.natvis\" \"/NATVIS:C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\etc\\\\liballoc.natvis\" \"/NATVIS:C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\etc\\\\libcore.natvis\" \"/LIBPATH:D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\deps\" \"/LIBPATH:D:\\\\Development\\\\Source\\\\rust_issues\\\\target\\\\debug\\\\build\\\\dylib_test-df967a17b396e952\\\\out\" \"/LIBPATH:C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"dylib.lib\" \"test_harness.lib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libtest-5868cd1efdb1a14a.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libterm-4a1cd4f9337faede.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libgetopts-c94244661cc3c49c.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libunicode_width-5d83c260a3fd1c81.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libstd-69ffdb8026c42481.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libpanic_unwind-324700ef1bcafc8b.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libbacktrace-66fccb33cfc77b7d.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\librustc_demangle-429461051376b1a5.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libhashbrown-16c7dc58d869d64a.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\librustc_std_workspace_alloc-b5f6113de773ee4b.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libunwind-52ee0b65e04bcb17.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libcfg_if-eee1f1d0cc78c8f9.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\liblibc-f5bd27a471d11e8c.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\liballoc-bb531cfdfdeadec5.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\librustc_std_workspace_core-48d94702399abeaa.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libcore-edaeab1200806e65.rlib\" \"C:\\\\Users\\\\rb\\\\.rustup\\\\toolchains\\\\nightly-2019-07-08-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\\\\libcompiler_builtins-5cb137db32dc726e.rlib\" \"kernel32.lib\" \"advapi32.lib\" \"ws2_32.lib\" \"userenv.lib\" \"msvcrt.lib\"\r\n  = note: LINK : fatal error LNK1181: cannot open input file 'dylib.lib'\r\n```  \r\n\r\nI believe this is because Rust on Windows produces a `dylib.dll` and `dylib.dll.lib` (instead of a `dylib.lib`). When then resolving the library Rust apparently isn't aware that to resolve `name=\"dylib\"` it should not only look for the (`dylib.lib`, `dylib.dll`) pair, but instead also for the (`dylib.dll.lib`, `dylib.dll`) pair.\r\n\r\n\r\n\r\n**Steps**\r\n1. Clone https://github.com/ralfbiedert/rust_issues/tree/dylib_issues\r\n2. Run `cargo test` (on Windows)\r\n\r\n**Possible Solution(s)**\r\nWhen given a `#[link(name = \"dylib\")]`, consider to look for `dylib.dll.lib` on Windows.\r\n\r\nThe current workaround is to specify `#[link(name = \"dylib.dll\")]`, but from a cross-platform perspective that feels inconsistent. \r\n\r\n**Notes**\r\n\r\nOutput of `cargo version`:\r\n\r\n<!-- Also, any additional context or information you feel may be relevant to the issue. -->\r\n<!-- (e.g rust version, OS platform/distribution/version, target toolchain(s), release channel.. -->\r\n`cargo 1.37.0-nightly (4c1fa54d1 2019-06-24)`\r\n`rustc 1.38.0-nightly (6e310f2ab 2019-07-07)`   \r\n`x86_64-pc-windows-msvc`", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/62588/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/62588/timeline", "performed_via_github_app": null, "state_reason": null}