{"url": "https://api.github.com/repos/rust-lang/rust/issues/112709", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/112709/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/112709/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/112709/events", "html_url": "https://github.com/rust-lang/rust/issues/112709", "id": 1760947681, "node_id": "I_kwDOAAsO6M5o9e3h", "number": 112709, "title": "\"error: instruction requires: aes\" on aarch64-unknown-linux-gnu for inline ASM inside `inline(always)` fn", "user": {"login": "tarcieri", "id": 797, "node_id": "MDQ6VXNlcjc5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/797?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tarcieri", "html_url": "https://github.com/tarcieri", "followers_url": "https://api.github.com/users/tarcieri/followers", "following_url": "https://api.github.com/users/tarcieri/following{/other_user}", "gists_url": "https://api.github.com/users/tarcieri/gists{/gist_id}", "starred_url": "https://api.github.com/users/tarcieri/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tarcieri/subscriptions", "organizations_url": "https://api.github.com/users/tarcieri/orgs", "repos_url": "https://api.github.com/users/tarcieri/repos", "events_url": "https://api.github.com/users/tarcieri/events{/privacy}", "received_events_url": "https://api.github.com/users/tarcieri/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2023-06-16T16:20:52Z", "updated_at": "2023-06-17T15:23:37Z", "closed_at": "2023-06-16T19:42:38Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I have code that, for whatever reason, will compile on `aarch64-apple-darwin` but not on `aarch64-unknown-linux-gnu`. It's asking me to enable `target_feature`s on a function that's annotated `inline(always)` (which, in and of itself, does not seem to make sense).\r\n\r\nA minimal reproduction is also elusive in that everything I've tried so far compiles. I'm wondering if this is some kind of bug related to the inliner.\r\n\r\nTo start with, here are the functions it's complaining about:\r\n\r\n```rust\r\n/// AES single round encryption.\r\n#[inline(always)]\r\npub unsafe fn vaeseq_u8(mut data: uint8x16_t, key: uint8x16_t) -> uint8x16_t {\r\n    asm!(\r\n        \"AESE {d:v}.16B, {k:v}.16B\",\r\n        d = inout(vreg) data,\r\n        k = in(vreg) key,\r\n        options(pure, nomem, nostack, preserves_flags)\r\n    );\r\n    data\r\n}\r\n\r\n/// AES inverse mix columns.\r\n#[inline(always)]\r\npub unsafe fn vaesimcq_u8(mut data: uint8x16_t) -> uint8x16_t {\r\n    asm!(\r\n        \"AESIMC {d:v}.16B, {d:v}.16B\",\r\n        d = inout(vreg) data,\r\n        options(pure, nomem, nostack, preserves_flags)\r\n    );\r\n    data\r\n}\r\n```\r\n\r\nThese compile fine in and of themselves. In fact trying to put together a minimal repro I haven't been able to reproduce the compile error, even with quite a bit of the related code in place: https://godbolt.org/z/P7h8KsaMG\r\n\r\nSo it seems like some strange interactions in more complicated code, possibly related to inlining.\r\n\r\nIt's easily reproducible, but unfortunately the only repro I have to offer is the following commit of this PR: https://github.com/RustCrypto/block-ciphers/pull/365/commits/7818f355c1ca2511c3275e7b334c780c9153bb86\r\n\r\nThe compile error is as follows (which I've reproduced locally): https://github.com/RustCrypto/block-ciphers/actions/runs/5283017067/jobs/9558698657\r\n\r\n```\r\nerror: instruction requires: aes\r\n  --> aes/src/armv8/intrinsics.rs:11:10\r\n   |\r\n11 |         \"AESE {d:v}.16B, {k:v}.16B\",\r\n   |          ^\r\n   |\r\nnote: instantiated into assembly here\r\n  --> <inline asm>:1:2\r\n   |\r\n1  |     AESE v1.16B, v0.16B\r\n   |     ^\r\n\r\nerror: instruction requires: aes\r\n  --> aes/src/armv8/intrinsics.rs:47:10\r\n   |\r\n47 |         \"AESIMC {d:v}.16B, {d:v}.16B\",\r\n   |          ^\r\n   |\r\nnote: instantiated into assembly here\r\n  --> <inline asm>:1:2\r\n   |\r\n1  |     AESIMC v0.16B, v0.16B\r\n   |     ^\r\n```\r\n\r\nOne more odd observation, the compile error can be \"solved\" by replacing `#[inline(always)]` with `#[target_feature(enable = \"aes\")]`, as in here: https://github.com/RustCrypto/block-ciphers/pull/365/commits/10debe547fdae5612fdf72fb445ad5ed4904b27e\r\n\r\nHowever, this solution seemed to cause massive performance degradation with spooky-action-at-a-distance impacts on seemingly unrelated code (although code that was using the same CPU instruction): https://github.com/RustCrypto/block-ciphers/pull/365#issuecomment-1593814783\r\n\r\n### Meta\r\nThis reproduces on all versions of rustc I've tried, including the latest nighty. The code in question is targeting an MSRV of 1.61, where the error also occurs.", "closed_by": {"login": "tarcieri", "id": 797, "node_id": "MDQ6VXNlcjc5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/797?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tarcieri", "html_url": "https://github.com/tarcieri", "followers_url": "https://api.github.com/users/tarcieri/followers", "following_url": "https://api.github.com/users/tarcieri/following{/other_user}", "gists_url": "https://api.github.com/users/tarcieri/gists{/gist_id}", "starred_url": "https://api.github.com/users/tarcieri/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tarcieri/subscriptions", "organizations_url": "https://api.github.com/users/tarcieri/orgs", "repos_url": "https://api.github.com/users/tarcieri/repos", "events_url": "https://api.github.com/users/tarcieri/events{/privacy}", "received_events_url": "https://api.github.com/users/tarcieri/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/112709/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/112709/timeline", "performed_via_github_app": null, "state_reason": "completed"}