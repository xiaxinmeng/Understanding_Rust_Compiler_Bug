{"url": "https://api.github.com/repos/rust-lang/rust/issues/23239", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/23239/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/23239/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/23239/events", "html_url": "https://github.com/rust-lang/rust/issues/23239", "id": 60436535, "node_id": "MDU6SXNzdWU2MDQzNjUzNQ==", "number": 23239, "title": "Compiler crash", "user": {"login": "bwindels", "id": 274386, "node_id": "MDQ6VXNlcjI3NDM4Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/274386?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bwindels", "html_url": "https://github.com/bwindels", "followers_url": "https://api.github.com/users/bwindels/followers", "following_url": "https://api.github.com/users/bwindels/following{/other_user}", "gists_url": "https://api.github.com/users/bwindels/gists{/gist_id}", "starred_url": "https://api.github.com/users/bwindels/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bwindels/subscriptions", "organizations_url": "https://api.github.com/users/bwindels/orgs", "repos_url": "https://api.github.com/users/bwindels/repos", "events_url": "https://api.github.com/users/bwindels/events{/privacy}", "received_events_url": "https://api.github.com/users/bwindels/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2015-03-10T01:16:37Z", "updated_at": "2015-03-10T02:00:12Z", "closed_at": "2015-03-10T02:00:12Z", "author_association": "NONE", "active_lock_reason": null, "body": "Compiler panics while compiling the following code:\n\n``` rust\nuse libc::c_char;\nuse std::ffi;\nuse std::str;\nuse std::vec;\n\nstruct TokenCollection {\n    parts: Vec<&str>,\n    name: &str\n}\n\nfn c_str_to_slice(c_str: *mut c_char) -> &str {\n    let c_bytes = unsafe { ffi::c_str_to_bytes(&c_str); };\n    std::from_utf8(c_bytes).unwrap()\n}\n\nimpl TokenCollection {\n    fn new(str: &str) -> &TokenCollection {\n        TokenCollection {\n            parts: str.split(|c| c.is_whitespace()).collect()\n        }\n    }\n\n    fn len(&self) -> usize {\n        self.parts.len()\n    }\n}\n\n// impl Drop for TokenCollection {\n//  fn drop(&self) {\n//      println!(\"drop it like it's hot\");\n//  }\n// }\n\n#[no_mangle]\npub extern fn token_collection_create(c_str: *c_char) -> *mut TokenCollection {\n    let str = c_str_to_slice(c_str);\n\n    unsafe { transmute(box TokenCollection::new(str)) }\n}\n\n#[no_mangle]\npub extern fn token_collection_len(pimpl: *mut TokenCollection) -> libc::uint64_t {\n    pimpl.len()\n}\n\n#[no_mangle]\npub extern fn token_collection_destroy(pimpl: *mut TokenCollection) {\n    let str = c_str_to_slice(c_str);\n\n    unsafe { transmute(box TokenCollection::new(str)) }\n}\n```\n\nI expected running the compiler would show the errors it found in the code, which it did, but then it paniced:\n\nCompiler command: `rustc foo.rs --crate-type=\"staticlib\" -o foo.a`\nCompiler output:\n\n```\nfoo.rs:35:46: 35:47 error: bare raw pointers are no longer allowed, you should likely use `*mut T`, but otherwise `*T` is now known as `*const T`\nfoo.rs:35 pub extern fn token_collection_create(c_str: *c_char) -> *mut TokenCollection {\n                                                       ^\nerror: internal compiler error: unexpected panic\nnote: the compiler unexpectedly panicked. this is a bug.\n...\n```\n## Meta\n\n`rustc --version --verbose`:\n\n```\nrustc 1.0.0-nightly (91bdf23f5 2015-03-09) (built 2015-03-08)\nbinary: rustc\ncommit-hash: 91bdf23f504f79ed59617cde3dfebd3d5e39a476\ncommit-date: 2015-03-09\nbuild-date: 2015-03-08\nhost: x86_64-apple-darwin\nrelease: 1.0.0-nightly\n```\n\nBacktrace:\n\n```\nstack backtrace:\n   1:        0x1080af27d - sys::backtrace::write::h8bb5f05fb3b15b46KDA\n   2:        0x1080d8c34 - panicking::on_panic::h774322e801e90255MsJ\n   3:        0x10800a299 - rt::unwind::begin_unwind_inner::h91fe489b48891c2fibJ\n   4:        0x10800a71e - rt::unwind::begin_unwind_fmt::h611a8fe214a71d11T9I\n   5:        0x1080d870d - rust_begin_unwind\n   6:        0x108127815 - panicking::panic_fmt::h28951af8a1739750HZs\n   7:        0x108121b07 - panicking::panic::h1f407e1cc2932c40TXs\n   8:        0x1047a1667 - driver::build_output_filenames::h2291f05686c39ba461a\n   9:        0x1047963a9 - driver::compile_input::h65a0e989415894e2Nba\n  10:        0x104864bd6 - run_compiler::h6bbe5e8fdeccf450G6b\n  11:        0x1048622c0 - thunk::F.Invoke<A, R>::invoke::h11072616449651537896\n  12:        0x104860dff - rt::unwind::try::try_fn::h9635732175488659353\n  13:        0x108152ca8 - rust_try_inner\n  14:        0x108152c95 - rust_try\n  15:        0x10486161f - thunk::F.Invoke<A, R>::invoke::h10357567482835563298\n  16:        0x1080c43f2 - sys::thread::thread_start::h214ccfe780c3e0cb32E\n  17:     0x7fff88da5898 - _pthread_body\n  18:     0x7fff88da5729 - _pthread_start\n```\n", "closed_by": {"login": "bwindels", "id": 274386, "node_id": "MDQ6VXNlcjI3NDM4Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/274386?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bwindels", "html_url": "https://github.com/bwindels", "followers_url": "https://api.github.com/users/bwindels/followers", "following_url": "https://api.github.com/users/bwindels/following{/other_user}", "gists_url": "https://api.github.com/users/bwindels/gists{/gist_id}", "starred_url": "https://api.github.com/users/bwindels/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bwindels/subscriptions", "organizations_url": "https://api.github.com/users/bwindels/orgs", "repos_url": "https://api.github.com/users/bwindels/repos", "events_url": "https://api.github.com/users/bwindels/events{/privacy}", "received_events_url": "https://api.github.com/users/bwindels/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/23239/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/23239/timeline", "performed_via_github_app": null, "state_reason": "completed"}