{"url": "https://api.github.com/repos/rust-lang/rust/issues/84259", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/84259/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/84259/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/84259/events", "html_url": "https://github.com/rust-lang/rust/issues/84259", "id": 860135663, "node_id": "MDU6SXNzdWU4NjAxMzU2NjM=", "number": 84259, "title": "Odd behaviour coming from macros", "user": {"login": "InnocentusLime", "id": 17496400, "node_id": "MDQ6VXNlcjE3NDk2NDAw", "avatar_url": "https://avatars.githubusercontent.com/u/17496400?v=4", "gravatar_id": "", "url": "https://api.github.com/users/InnocentusLime", "html_url": "https://github.com/InnocentusLime", "followers_url": "https://api.github.com/users/InnocentusLime/followers", "following_url": "https://api.github.com/users/InnocentusLime/following{/other_user}", "gists_url": "https://api.github.com/users/InnocentusLime/gists{/gist_id}", "starred_url": "https://api.github.com/users/InnocentusLime/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/InnocentusLime/subscriptions", "organizations_url": "https://api.github.com/users/InnocentusLime/orgs", "repos_url": "https://api.github.com/users/InnocentusLime/repos", "events_url": "https://api.github.com/users/InnocentusLime/events{/privacy}", "received_events_url": "https://api.github.com/users/InnocentusLime/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 132910982, "node_id": "MDU6TGFiZWwxMzI5MTA5ODI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-macros", "name": "A-macros", "color": "f7e101", "default": false, "description": "Area: All kinds of macros (custom derive, macro_rules!, proc macros, ..)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2021-04-16T20:17:23Z", "updated_at": "2021-04-17T19:01:20Z", "closed_at": "2021-04-17T19:01:20Z", "author_association": "NONE", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI tried this code:\r\n\r\n```rust\r\nstruct T(i32);\r\n\r\n#[macro_export]\r\nmacro_rules! test {\r\n  ($array_type:ty => $($elem:expr),+ $(,)?) => {};\r\n  ($($elem:expr),+) => {};\r\n}\r\n\r\nfn main() {\r\n    test!(T(2));\r\n}\r\n```\r\n\r\nI expected it to compile, since `T(2)` is obviously an expression.\r\n\r\nInstead I received the following compiler error:\r\n\r\n> error: expected type, found `2`\r\n\r\nThe compiler seems to forcefully parse the string with the first rule (although it is clearly inapplicable here), fails and terminates with an error.\r\n\r\nWhat is more surprising is that the following code compiles just fine\r\n\r\n```rust\r\nstruct T;\r\n\r\n#[macro_export]\r\nmacro_rules! test {\r\n  ($array_type:ty => $($elem:expr),+ $(,)?) => {};\r\n  ($($elem:expr),+) => {};\r\n}\r\n\r\nfn main() {\r\n    test!(T);\r\n}\r\n```\r\n\r\nEven the right branch gets picked (the second one)!\r\n\r\nMoreover, reordering the branches breaks the following example (which **compiles** if you swap the `test`'s arms back)\r\n\r\n```rust\r\nstruct T(i32);\r\n\r\n#[macro_export]\r\nmacro_rules! test {\r\n  ($($elem:expr),+) => {};\r\n  ($array_type:ty => $($elem:expr),+ $(,)?) => {};\r\n}\r\n\r\nfn main() {\r\n    test!([&'static T; 2] => T(2));\r\n}\r\n```\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.51.0 (2fd73fabe 2021-03-23)\r\nbinary: rustc\r\ncommit-hash: 2fd73fabe469357a12c2c974c140f67e7cdd76d0\r\ncommit-date: 2021-03-23\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.51.0\r\nLLVM version: 11.0.1\r\n```\r\n\r\nBeta and nightly struggle with this code too.\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->", "closed_by": {"login": "InnocentusLime", "id": 17496400, "node_id": "MDQ6VXNlcjE3NDk2NDAw", "avatar_url": "https://avatars.githubusercontent.com/u/17496400?v=4", "gravatar_id": "", "url": "https://api.github.com/users/InnocentusLime", "html_url": "https://github.com/InnocentusLime", "followers_url": "https://api.github.com/users/InnocentusLime/followers", "following_url": "https://api.github.com/users/InnocentusLime/following{/other_user}", "gists_url": "https://api.github.com/users/InnocentusLime/gists{/gist_id}", "starred_url": "https://api.github.com/users/InnocentusLime/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/InnocentusLime/subscriptions", "organizations_url": "https://api.github.com/users/InnocentusLime/orgs", "repos_url": "https://api.github.com/users/InnocentusLime/repos", "events_url": "https://api.github.com/users/InnocentusLime/events{/privacy}", "received_events_url": "https://api.github.com/users/InnocentusLime/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/84259/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/84259/timeline", "performed_via_github_app": null, "state_reason": "completed"}