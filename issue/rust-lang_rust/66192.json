{"url": "https://api.github.com/repos/rust-lang/rust/issues/66192", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/66192/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/66192/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/66192/events", "html_url": "https://github.com/rust-lang/rust/issues/66192", "id": 519381288, "node_id": "MDU6SXNzdWU1MTkzODEyODg=", "number": 66192, "title": "MSVC rustc is unnaturally slower than Linux rustc", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 64037154, "node_id": "MDU6TGFiZWw2NDAzNzE1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compiletime", "name": "I-compiletime", "color": "e11d21", "default": false, "description": "Problems and improvements with respect to compile times."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 266005765, "node_id": "MDU6TGFiZWwyNjYwMDU3NjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-windows-msvc", "name": "O-windows-msvc", "color": "6e6ec0", "default": false, "description": "Toolchain: MSVC, Operating system: Windows"}, {"id": 593503757, "node_id": "MDU6TGFiZWw1OTM1MDM3NTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-infra", "name": "T-infra", "color": "bfd4f2", "default": false, "description": "Relevant to the infrastructure team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 10, "created_at": "2019-11-07T16:38:50Z", "updated_at": "2019-11-13T04:21:39Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "While it's generally assumed that build systems on Windows are slower than build systems on Linux, I'm seeing a discrepancy of up to nearly 2x differences in compile times *per crate* on a Windows machine vs a Linux machine. These are personal machines I work on and they're not exactly equivalent machines, but I'm pretty surprised about the 2x differences I'm seeing here and wanted to open an issue to see if we can investigate to get to the bottom of what's going on.\r\n\r\nThe specifications of the machines I have are:\r\n\r\n* Linux - Intel(R) Core(TM) i9-7940X CPU @ 3.10GHz, 14-core/28-thread, 64GB ram\r\n* Windows - Intel(R) Core(TM) i7-7700K CPU @ 4.20GHz, 4-core/8-thread, 32GB ram\r\n\r\nI don't really know a ton about Intel CPUs, so I'm not actually sure if these are expected where the i9 is 2x faster than the i7. I wanted to write down some details though to see if others have thoughts. All Cargo commands were executed with `-j4` to ensure that neither machine had an unfair parallelism advantage, and also to ideally isolate the effect of hyperthreads.\r\n\r\nI started out by building https://github.com/cranestation/wasmtime/tree/ab3cd945bc2f4626a2fae8eabf6c7108973ce1a5, and the full `-Ztimings` graph I got was:\r\n\r\n* [Linux](https://gistpreview.github.io/?fc260cc6a40bc83729d7262b8b2eb873)\r\n* [Windows](https://gistpreview.github.io/?69ab4ee6d88fec5f267bcce571651ce4)\r\n\r\nFor the same project and the same compiler commit the Windows build is nearly 70% slower! I don't *think* that my CPUs have a 70% performance difference between them, and I don't have a perfect test environment for this, but 70% feels like a huge performance discrepancy between Linux and Windows.\r\n\r\nGlancing at the slow building crates (use the \"min unit time\" slider to see them more easily) I'm seeing that almost all crates are 2x slower on Windows than on Linux. This doesn't look like a \"chalk it up to windows being slow\" issue, but this is where I started thinking that this was more likely to be a bug somewhere in rustc and/or LLVM.\r\n\r\nNext up I wanted to try out `-Z self-profile` on a particular crate. One I wrote recently was the `wast` crate, which took 13.76s on Linux and 23.05s on Windows. I dug in a bit more building just that crate at https://github.com/alexcrichton/wat/tree/2288911124001d30de0a68e284db9ab010495536/crates/wast.\r\n\r\nHere sure enough, the command `cargo +nightly build --release -p wast -j4` has a huge discrepancy:\r\n\r\n* Linux - 5.18s\r\n* Windows - 8.58s\r\n\r\nNext up I tried `-Z self-profile` and using `measurme` I ran `summarize diff` and got [this output](https://gist.github.com/alexcrichton/03306558740b8f4363a18482e0653cc5), notably:\r\n\r\n```\r\n+---------------------------------------------+---------------+------------+------------+--------------+-----------------------+\r\n| Item                                        | Self Time     | Item count | Cache hits | Blocked time | Incremental load time |\r\n+---------------------------------------------+---------------+------------+------------+--------------+-----------------------+\r\n| LLVM_thin_lto_optimize                      | +3.86042516s  | +0         | +0         | +0ns         | +0ns                  |\r\n+---------------------------------------------+---------------+------------+------------+--------------+-----------------------+\r\n| LLVM_module_optimize_module_passes          | +3.152410865s | +0         | +0         | +0ns         | +0ns                  |\r\n+---------------------------------------------+---------------+------------+------------+--------------+-----------------------+\r\n| LLVM_module_codegen_emit_obj                | +1.783877999s | +0         | +0         | +0ns         | +0ns                  |\r\n+---------------------------------------------+---------------+------------+------------+--------------+-----------------------+\r\n| codegen_crate                               | +1.021669947s | +0         | +0         | +0ns         | +0ns                  |\r\n+---------------------------------------------+---------------+------------+------------+--------------+-----------------------+\r\n| LLVM_thin_lto_import                        | +245.950489ms | +0         | +0         | +0ns         | +0ns                  |\r\n+---------------------------------------------+---------------+------------+------------+--------------+-----------------------+\r\n| codegen_module                              | +220.253166ms | +0         | +0         | +0ns         | +0ns                  |\r\n+---------------------------------------------+---------------+------------+------------+--------------+-----------------------+\r\n| LLVM_module_optimize_function_passes        | +134.256719ms | +0         | +0         | +0ns         | +0ns                  |\r\n+---------------------------------------------+---------------+------------+------------+--------------+-----------------------+\r\n| LLVM_module_codegen_make_bitcode            | +111.530996ms | +0         | +0         | +0ns         | +0ns                  |\r\n+---------------------------------------------+---------------+------------+------------+--------------+-----------------------+\r\n```\r\n\r\nFor whatever reason, it appears that LLVM is *massively* slower on Windows than it is on Linux. \r\n\r\nIt was at this point that I decided to write up the issue here and get this all down in a report. I suspect that this is either a build system problem with Windows or it's a compiler problem. We're using Clang on Linux but we're not using Clang on Windows yet, so it may be time to make the transition!", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/66192/reactions", "total_count": 6, "+1": 6, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/66192/timeline", "performed_via_github_app": null, "state_reason": null}