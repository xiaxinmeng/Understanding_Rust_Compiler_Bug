{"url": "https://api.github.com/repos/rust-lang/rust/issues/89751", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/89751/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/89751/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/89751/events", "html_url": "https://github.com/rust-lang/rust/issues/89751", "id": 1022107485, "node_id": "I_kwDOAAsO6M487B9d", "number": 89751, "title": "Rust program using Linux C library links but fails to run", "user": {"login": "LukeMauldin", "id": 1440808, "node_id": "MDQ6VXNlcjE0NDA4MDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1440808?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LukeMauldin", "html_url": "https://github.com/LukeMauldin", "followers_url": "https://api.github.com/users/LukeMauldin/followers", "following_url": "https://api.github.com/users/LukeMauldin/following{/other_user}", "gists_url": "https://api.github.com/users/LukeMauldin/gists{/gist_id}", "starred_url": "https://api.github.com/users/LukeMauldin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LukeMauldin/subscriptions", "organizations_url": "https://api.github.com/users/LukeMauldin/orgs", "repos_url": "https://api.github.com/users/LukeMauldin/repos", "events_url": "https://api.github.com/users/LukeMauldin/events{/privacy}", "received_events_url": "https://api.github.com/users/LukeMauldin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1359848690, "node_id": "MDU6TGFiZWwxMzU5ODQ4Njkw", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-mcve", "name": "E-needs-mcve", "color": "02e10c", "default": false, "description": "Call for participation: This issue needs a Minimal Complete and Verifiable Example"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2021-10-10T22:21:43Z", "updated_at": "2021-10-14T01:31:38Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "For reference see discussion: https://users.rust-lang.org/t/linux-executable-lazy-loading/65621/24\r\n\r\nSummary:\r\nOn Linux x64 using either Rust 1.55 or Rust 1.57 nightly (a8f2463c6 2021-10-09), I have a simple Rust program that compiles and links against C libraries provided by a software vendor.  The Rust program fails to run with `undefined symbol` errors even though the `LD_LIBRARY_PATH` is setup correctly.  I have built a similar C program which links and runs as expected.  Initially it was assumed the problem was due to `RELRO` but I wrote a custom linker script that strips off the `RELRO` link options and the Rust binary still fails to run.  See the linker commands and readelf outputs below.\r\n\r\nAdditional information:\r\nThe RHEL 7.9 is being used for the Rust and C program compiles.  The vendor libraries being linked against are pretty old and were originally built on Suse 10 SP2.  The vendor has provided an updated set of libraries that were built on RHEL 7.4 and I verified the Rust program compiled, linked, and runs as expected against the newer vendor libraries.  Unfortunately, I need to get Rust linking/running against the older version of the vendor libraries because that is the version of the application still in use by the business.  I think the issue is somehow related to the age of the vendor libraries but both C and Go programs (using CGO) will link and run against the vendor libraries and so I think Rust should as well.\r\n\r\nRust linker command: \r\n```\r\ncc -m64 /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.13p9e1ntyogo9xsq.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.1iij31zcahtqtiv5.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.1l6169r8k8eut7l2.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.2gjar0q85zo53a76.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.2k238mae54tufgj9.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.2khfd30djo2j9kj2.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.30j9pt2j18mofsvb.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.3aliuipsukidwcp1.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.3hccpq6246r15ccj.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.3mblox8452khn7gt.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.3t4cjyhj779kk0qr.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.3zuhas95lhzq610q.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.45wlivfnv8f4n4m0.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.4d3znlnisojq460.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.4kfpl27e23y5yblb.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.4tsmg47mo9ot09rg.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.56udpy3ecn6gwk3v.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.5a3amov6yy7wfscc.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.5cf61klwqdixyzvj.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.5orcigdhwyefptr.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.9x7slzthbld3jn.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.cde9lw0m0vpja0a.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.gzsb73e5bh99x9g.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.lphb1hwcx9397qd.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.q46zvmgwxroxyjw.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.uov2smtu6r3uncy.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.y30a08oijsqtlo9.rcgu.o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91.1lyc4h18v76f6y14.rcgu.o -Wl,--as-needed -L /USERHOME/CODEDIR/target/debug/deps -L /LIBDIR -L /usr/lib/x86_64-linux-gnu -L /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib -lae -lbom -lepm -lfclasses -lform -ltcinit -ltc -ltccore -lbase_utils -lps -lpublication -lqry -lres -lsa -ltcsoaprojectmanagement -lcfilter -lstdc++ -Wl,--start-group -Wl,-Bstatic /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd-008055cc7d873802.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libpanic_unwind-06f01ac2578bda94.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libminiz_oxide-f9a3c3274a1835e0.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libadler-d4cbb754ee9f4daa.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libobject-95c14e1c1e3ebcc4.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libaddr2line-d489f0ca872880cc.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libgimli-75f07df0b18fea39.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd_detect-0c35b278736219a2.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc_demangle-e530649c9a06e3c6.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libhashbrown-6b148909d375a785.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc_std_workspace_alloc-cd15fa647f4775d1.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libunwind-74be3a703f788ba2.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcfg_if-8f2c5b445c28b2e3.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/liblibc-8480e85e0be96197.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/liballoc-ac23a75f6f42004e.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc_std_workspace_core-557ba8776e04d182.rlib /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcore-4beb03d03503c439.rlib -Wl,--end-group /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-dd7db1bec6909f24.rlib -Wl,-Bdynamic -lgcc_s -lutil -lrt -lpthread -lm -ldl -lc -Wl,--eh-frame-hdr -Wl,-znoexecstack -L /USERHOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib -o /USERHOME/CODEDIR/target/debug/deps/tclogin-3aa5bdb40b601d91 -Wl,--gc-sections -nodefaultlibs -Wl,--unresolved-symbols=ignore-all -Wl,-znorelro -Wl,-zlazy\r\n```\r\n\r\n\r\nCustom linker script:\r\n```\r\n#!/bin/bash\r\n\r\ndeclare -a FILTERARGS\r\nfor ITEM in \"$@\"\r\ndo\r\n    # if [[ \"$ITEM\" != \"-Wl,-znow\" && \"$ITEM\" != \"-Wl,-zrelro\" ]]; then\r\n    #    FILTERARGS+=(\"$ITEM\")\r\n    # fi\r\n    case \"$ITEM\" in\r\n    -Wl,-znow|-Wl,-zrelro)\r\n        # do nothing\r\n        ;;\r\n    *)\r\n       FILTERARGS+=(\"$ITEM\")\r\n        ;;\r\n    esac\r\ndone\r\n\r\necho \"invoking: cc ${FILTERARGS[@]}\"\r\ncc ${FILTERARGS[@]}\r\n```\r\n\r\nRust readelf -d\r\n```\r\n0x000000000000000c (INIT)               0x405530\r\n 0x000000000000000d (FINI)               0x435f40\r\n 0x0000000000000019 (INIT_ARRAY)         0x643000\r\n 0x000000000000001b (INIT_ARRAYSZ)       16 (bytes)\r\n 0x000000000000001a (FINI_ARRAY)         0x643010\r\n 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)\r\n 0x000000006ffffef5 (GNU_HASH)           0x400298\r\n 0x0000000000000005 (STRTAB)             0x401a20\r\n 0x0000000000000006 (SYMTAB)             0x4006b8\r\n 0x000000000000000a (STRSZ)              9597 (bytes)\r\n 0x000000000000000b (SYMENT)             24 (bytes)\r\n 0x0000000000000015 (DEBUG)              0x0\r\n 0x0000000000000003 (PLTGOT)             0x645c80\r\n 0x0000000000000002 (PLTRELSZ)           120 (bytes)\r\n 0x0000000000000014 (PLTREL)             RELA\r\n 0x0000000000000017 (JMPREL)             0x4054b8\r\n 0x0000000000000007 (RELA)               0x404240\r\n 0x0000000000000008 (RELASZ)             4728 (bytes)\r\n 0x0000000000000009 (RELAENT)            24 (bytes)\r\n 0x000000006ffffffe (VERNEED)            0x404140\r\n 0x000000006fffffff (VERNEEDNUM)         6\r\n 0x000000006ffffff0 (VERSYM)             0x403f9e\r\n 0x0000000000000000 (NULL)               0x0\r\n```\r\n\r\nRust readelf -l \r\n```\r\nElf file type is EXEC (Executable file)\r\nEntry point 0x407c18\r\nThere are 9 program headers, starting at offset 64\r\n\r\nProgram Headers:\r\n  Type           Offset             VirtAddr           PhysAddr\r\n                 FileSiz            MemSiz              Flags  Align\r\n  PHDR           0x0000000000000040 0x0000000000400040 0x0000000000400040\r\n                 0x00000000000001f8 0x00000000000001f8  R E    8\r\n  INTERP         0x0000000000000238 0x0000000000400238 0x0000000000400238\r\n                 0x000000000000001c 0x000000000000001c  R      1\r\n      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]\r\n  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000\r\n                 0x0000000000042200 0x0000000000042200  R E    200000\r\n  LOAD           0x0000000000043000 0x0000000000643000 0x0000000000643000\r\n                 0x0000000000002d08 0x0000000000002ed0  RW     200000\r\n  DYNAMIC        0x0000000000045390 0x0000000000645390 0x0000000000645390\r\n                 0x00000000000002c0 0x00000000000002c0  RW     8\r\n  NOTE           0x0000000000000254 0x0000000000400254 0x0000000000400254\r\n                 0x0000000000000044 0x0000000000000044  R      4\r\n  TLS            0x0000000000043000 0x0000000000643000 0x0000000000643000\r\n                 0x0000000000000000 0x0000000000000078  R      10\r\n  GNU_EH_FRAME   0x000000000003afa4 0x000000000043afa4 0x000000000043afa4\r\n                 0x0000000000001004 0x0000000000001004  R      4\r\n  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000\r\n                 0x0000000000000000 0x0000000000000000  RW     10\r\n\r\n Section to Segment mapping:\r\n  Segment Sections...\r\n   00\r\n   01     .interp\r\n   02     .interp .note.ABI-tag .note.gnu.build-id .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt .init .plt .text .fini .rodata .debug_gdb_scripts .eh_frame_hdr .eh_frame .gcc_except_table\r\n   03     .init_array .fini_array .jcr .data.rel.ro .dynamic .got .got.plt .data .bss\r\n   04     .dynamic\r\n   05     .note.ABI-tag .note.gnu.build-id\r\n   06     .tbss\r\n   07     .eh_frame_hdr\r\n   08\r\n```\r\n\r\nC readelf -d\r\n```\r\n0x000000000000000c (INIT)               0x401220\r\n 0x000000000000000d (FINI)               0x4016e4\r\n 0x0000000000000019 (INIT_ARRAY)         0x602428\r\n 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)\r\n 0x000000000000001a (FINI_ARRAY)         0x602430\r\n 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)\r\n 0x000000006ffffef5 (GNU_HASH)           0x400298\r\n 0x0000000000000005 (STRTAB)             0x400520\r\n 0x0000000000000006 (SYMTAB)             0x4002e0\r\n 0x000000000000000a (STRSZ)              2777 (bytes)\r\n 0x000000000000000b (SYMENT)             24 (bytes)\r\n 0x0000000000000015 (DEBUG)              0x0\r\n 0x0000000000000003 (PLTGOT)             0x603000\r\n 0x0000000000000002 (PLTRELSZ)           264 (bytes)\r\n 0x0000000000000014 (PLTREL)             RELA\r\n 0x0000000000000017 (JMPREL)             0x401118\r\n 0x0000000000000007 (RELA)               0x4010a0\r\n 0x0000000000000008 (RELASZ)             120 (bytes)\r\n 0x0000000000000009 (RELAENT)            24 (bytes)\r\n 0x000000006ffffffe (VERNEED)            0x401030\r\n 0x000000006fffffff (VERNEEDNUM)         3\r\n 0x000000006ffffff0 (VERSYM)             0x400ffa\r\n 0x0000000000000000 (NULL)               0x0\r\n```\r\n\r\nC readelf -l\r\n```\r\nElf file type is EXEC (Executable file)\r\nEntry point 0x401300\r\nThere are 9 program headers, starting at offset 64\r\n\r\nProgram Headers:\r\n  Type           Offset             VirtAddr           PhysAddr\r\n                 FileSiz            MemSiz              Flags  Align\r\n  PHDR           0x0000000000000040 0x0000000000400040 0x0000000000400040\r\n                 0x00000000000001f8 0x00000000000001f8  R E    8\r\n  INTERP         0x0000000000000238 0x0000000000400238 0x0000000000400238\r\n                 0x000000000000001c 0x000000000000001c  R      1\r\n      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]\r\n  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000\r\n                 0x0000000000001a78 0x0000000000001a78  R E    200000\r\n  LOAD           0x0000000000002428 0x0000000000602428 0x0000000000602428\r\n                 0x0000000000000c68 0x0000000000000c78  RW     200000\r\n  DYNAMIC        0x0000000000002450 0x0000000000602450 0x0000000000602450\r\n                 0x0000000000000ba0 0x0000000000000ba0  RW     8\r\n  NOTE           0x0000000000000254 0x0000000000400254 0x0000000000400254\r\n                 0x0000000000000044 0x0000000000000044  R      4\r\n  GNU_EH_FRAME   0x0000000000001878 0x0000000000401878 0x0000000000401878\r\n                 0x0000000000000044 0x0000000000000044  R      4\r\n  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000\r\n                 0x0000000000000000 0x0000000000000000  RW     10\r\n  GNU_RELRO      0x0000000000002428 0x0000000000602428 0x0000000000602428\r\n                 0x0000000000000bd8 0x0000000000000bd8  R      1\r\n\r\n Section to Segment mapping:\r\n  Segment Sections...\r\n   00\r\n   01     .interp\r\n   02     .interp .note.ABI-tag .note.gnu.build-id .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt .init .plt .text .fini .rodata .eh_frame_hdr .eh_frame .gcc_except_table\r\n   03     .init_array .fini_array .jcr .data.rel.ro .dynamic .got .got.plt .data .bss\r\n   04     .dynamic\r\n   05     .note.ABI-tag .note.gnu.build-id\r\n   06     .eh_frame_hdr\r\n   07\r\n   08     .init_array .fini_array .jcr .data.rel.ro .dynamic .got\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/89751/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/89751/timeline", "performed_via_github_app": null, "state_reason": null}