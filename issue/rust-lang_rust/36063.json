{"url": "https://api.github.com/repos/rust-lang/rust/issues/36063", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/36063/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/36063/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/36063/events", "html_url": "https://github.com/rust-lang/rust/issues/36063", "id": 173635714, "node_id": "MDU6SXNzdWUxNzM2MzU3MTQ=", "number": 36063, "title": "internal UnsafeCell causes references to be dropped immediately", "user": {"login": "vitiral", "id": 5587659, "node_id": "MDQ6VXNlcjU1ODc2NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/5587659?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vitiral", "html_url": "https://github.com/vitiral", "followers_url": "https://api.github.com/users/vitiral/followers", "following_url": "https://api.github.com/users/vitiral/following{/other_user}", "gists_url": "https://api.github.com/users/vitiral/gists{/gist_id}", "starred_url": "https://api.github.com/users/vitiral/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vitiral/subscriptions", "organizations_url": "https://api.github.com/users/vitiral/orgs", "repos_url": "https://api.github.com/users/vitiral/repos", "events_url": "https://api.github.com/users/vitiral/events{/privacy}", "received_events_url": "https://api.github.com/users/vitiral/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2016-08-28T08:22:32Z", "updated_at": "2016-08-28T17:10:13Z", "closed_at": "2016-08-28T13:35:45Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "This has been driving me crazy and I have finally found the root cause of the bug.\n\n```\n# just updated today\n$ rustup toolchain list\nstable-x86_64-unknown-linux-gnu\nnightly-2016-06-16-x86_64-unknown-linux-gnu\nnightly-2016-07-07-x86_64-unknown-linux-gnu\nnightly-2016-08-18-x86_64-unknown-linux-gnu\nnightly-x86_64-unknown-linux-gnu (default)\n```\n\nI have tried to compile with all of these versions, so I can be pretty sure that this bug is NOT a regression.\n\nThe source code that details the bug is here:\nhttps://github.com/vitiral/notes/tree/rust_bug/rust/lifesucks/src\n\nYou can see I have created 3 versions of roughly the same code in increasing complexity:\n- `simple.rs` contains an ultra simple version of what I am trying to do: have some data behind a pool that allocates to a mutex. In this case, it doesn't even support dynamic types. **This compiles**\n- `complex.rs` is a more complete version of the same thing and **this also compiles**\n- `very_complex.rs` is almost idential to `complex.rs` _but it hides it's data behind an UnsafeCell_. **this does not compile**\n\nFor `very_complex.rs` the compiler gives these errors:\n\n```\nsrc/very_complex.rs:67:18: 67:33 error: `unwrapped_alloc` does not live long enough\nsrc/very_complex.rs:67     let locked = unwrapped_alloc.try_lock();\n                                        ^~~~~~~~~~~~~~~\nsrc/very_complex.rs:64:41: 79:2 note: reference must be valid for the block suffix following statement 1 at 64:40...\nsrc/very_complex.rs:64     let pool = Pool::new(&mut data[..]);\n                                                               ^\nsrc/very_complex.rs:66:44: 79:2 note: ...but borrowed value is only valid for the block suffix following statement 3 at 66:43\nsrc/very_complex.rs:66     let unwrapped_alloc = alloced.unwrap();\n                                                                  ^\nsrc/very_complex.rs:71:24: 71:25 error: `v` does not live long enough\nsrc/very_complex.rs:71         Ok(v) => match v.try_lock() {\n```\n\neven though that section of code looks like this:\n\n```\nlet alloced = pool.alloc::<u32>();\nlet unwrapped_alloc = alloced.unwrap();\nlet locked = unwrapped_alloc.try_lock();\nlet unwrapped_locked = locked.unwrap();\nassert_eq!(unwrapped_locked.deref(), &0x01010101);\n```\n\nIn other words, there is no way this is because of #15023 (also, it works fine in the other versions).\n\nIt would be great if someone could take a look, this has been driving me absolutely crazy today.\n", "closed_by": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/36063/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/36063/timeline", "performed_via_github_app": null, "state_reason": "completed"}