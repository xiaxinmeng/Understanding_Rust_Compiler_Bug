{"url": "https://api.github.com/repos/rust-lang/rust/issues/31030", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/31030/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/31030/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/31030/events", "html_url": "https://github.com/rust-lang/rust/issues/31030", "id": 127531923, "node_id": "MDU6SXNzdWUxMjc1MzE5MjM=", "number": 31030, "title": "Upgrade jemalloc, re-enable Windows GNU", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2016-01-19T20:32:22Z", "updated_at": "2017-03-24T19:22:20Z", "closed_at": "2016-03-06T02:29:40Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "As of the time of this writing, we are running jemalloc at the revision https://github.com/rust-lang/jemalloc/commit/91010a9e2ebfc84b1ac1ed7fdde3bfed4f65f180 which I believe is the 4.0.4 release of jemalloc. Previously we were running https://github.com/rust-lang/jemalloc/commit/e24a1a025a1f214e40eedafe3b9c7b1d69937922 which I believe is somewhere in the 3.6 series. We attempted to upgrade jemalloc many times between these two commits eventually [reaching the conclusion](https://github.com/jemalloc/jemalloc/issues/310) that the previous behavior of `--enable-lazy-lock` on Windows is fundamentally racy in jemalloc right now unfortunately. This led to a [successful upgrade of jemalloc](https://github.com/rust-lang/rust/pull/30434) to where we are today.\n\nUnfortunately, however, there is a [deadlock in jemalloc 4.0.4](https://github.com/jemalloc/jemalloc/issues/315) so we are attempting to downgrade back to 3.6. There were no known problems other than some Windows issues with jemalloc 3.6, so we believe it'll be fine for awhile. In this downgrade, however, it appears that the implementation of `--disable-lazy-lock` is somewhat broken as well, causing the [initial downgrade](https://github.com/rust-lang/rust/pull/30985) to fail to land.\n\nAs a result, the downgrade attempt will disable jemalloc on Windows entirely. This issue will track re-enabling it on Windows as well as re-upgrading once the deadlock bug is fixed. As far as I know the only reason to not enable Windows is that lots of locking support was improved in 4.0.*, and the only reason to not upgrade immediately is the deadlock bugs we've encountered.\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/31030/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/31030/timeline", "performed_via_github_app": null, "state_reason": "completed"}