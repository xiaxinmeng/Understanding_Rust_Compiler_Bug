{"url": "https://api.github.com/repos/rust-lang/rust/issues/81124", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/81124/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/81124/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/81124/events", "html_url": "https://github.com/rust-lang/rust/issues/81124", "id": 787747239, "node_id": "MDU6SXNzdWU3ODc3NDcyMzk=", "number": 81124, "title": "Rustc takes 3.5 GB RSS to check `vtparse`", "user": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 171502053, "node_id": "MDU6TGFiZWwxNzE1MDIwNTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-borrow-checker", "name": "A-borrow-checker", "color": "f7e101", "default": false, "description": "Area: The borrow checker"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 630799571, "node_id": "MDU6TGFiZWw2MzA3OTk1NzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compilemem", "name": "I-compilemem", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to memory usage during compilation."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 849077850, "node_id": "MDU6TGFiZWw4NDkwNzc4NTA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/WG-compiler-performance", "name": "WG-compiler-performance", "color": "c2e0c6", "default": false, "description": "Working group: Compiler Performance"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2021-01-17T16:55:51Z", "updated_at": "2021-05-02T02:43:06Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "I tried this code: https://github.com/wez/wezterm/commit/fa4bbbd077837d4eafe26805079f95a51054c4d7\r\n\r\nI expected to see this happen: The compiler builds the code in a reasonable amount of memory (say, < 800 MB).\r\n\r\nInstead, this happened: The compiler uses over 3 GB, causing docs.rs to kill the process: https://github.com/rust-lang/docs.rs/issues/1247\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\n> rustc --version -v\r\nrustc 1.51.0-nightly (a62a76047 2021-01-13)\r\nbinary: rustc\r\ncommit-hash: a62a76047ea24aad7639f14eb3ce0e620b77bdb7\r\ncommit-date: 2021-01-13\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.51.0-nightly\r\n```\r\n\r\n<details><summary>-Z time-passes</summary>\r\n\r\n```\r\n> cargo rustc --profile=check -- -Z time-passes\r\n    Checking utf8parse v0.2.0\r\n    Checking vtparse v0.4.0 (/home/joshua/test-rustdoc/wezterm/vtparse)\r\ntime: 0.002; rss: 52MB\tparse_crate\r\ntime: 0.000; rss: 52MB\tattributes_injection\r\ntime: 0.000; rss: 53MB\tincr_comp_prepare_session_directory\r\ntime: 0.000; rss: 53MB\tincr_comp_garbage_collect_session_directories\r\ntime: 0.000; rss: 53MB\trecursion_limit\r\ntime: 0.000; rss: 53MB\tplugin_loading\r\ntime: 0.000; rss: 53MB\tplugin_registration\r\ntime: 0.000; rss: 53MB\tpre_AST_expansion_lint_checks\r\ntime: 0.000; rss: 53MB\tcrate_injection\r\ntime: 0.000; rss: 56MB\tpre_AST_expansion_lint_checks\r\ntime: 0.000; rss: 56MB\tpre_AST_expansion_lint_checks\r\ntime: 0.174; rss: 83MB\texpand_crate\r\ntime: 0.000; rss: 83MB\tcheck_unused_macros\r\ntime: 0.174; rss: 83MB\tmacro_expand_crate\r\ntime: 0.000; rss: 83MB\tmaybe_building_test_harness\r\ntime: 0.002; rss: 83MB\tAST_validation\r\ntime: 0.000; rss: 83MB\tmaybe_create_a_macro_crate\r\ntime: 0.002; rss: 88MB\tcomplete_gated_feature_checking\r\ntime: 0.196; rss: 88MB\tconfigure_and_expand\r\ntime: 0.000; rss: 88MB\tprepare_outputs\r\ntime: 0.000; rss: 88MB\tblocked_on_dep_graph_loading\r\ntime: 0.013; rss: 97MB\thir_lowering\r\ntime: 0.004; rss: 97MB\tearly_lint_checks\r\ntime: 0.000; rss: 98MB\tsetup_global_ctxt\r\ntime: 0.001; rss: 98MB\tdep_graph_tcx_init\r\ntime: 0.002; rss: 98MB\tcreate_global_ctxt\r\ntime: 0.000; rss: 103MB\tlooking_for_entry_point\r\ntime: 0.000; rss: 103MB\tlooking_for_plugin_registrar\r\ntime: 0.000; rss: 103MB\tlooking_for_derive_registrar\r\ntime: 0.009; rss: 108MB\tmisc_checking_1\r\ntime: 0.007; rss: 116MB\ttype_collecting\r\ntime: 0.000; rss: 116MB\timpl_wf_inference\r\ntime: 0.000; rss: 150MB\tunsafety_checking\r\ntime: 0.000; rss: 150MB\torphan_checking\r\ntime: 0.059; rss: 150MB\tcoherence_checking\r\ntime: 0.016; rss: 156MB\twf_checking\r\ntime: 0.572; rss: 221MB\titem_types_checking\r\ntime: 0.064; rss: 245MB\titem_bodies_checking\r\ntime: 0.719; rss: 245MB\ttype_check_crate\r\ntime: 0.002; rss: 245MB\tmatch_checking\r\ntime: 0.004; rss: 245MB\tliveness_and_intrinsic_checking\r\ntime: 0.006; rss: 245MB\tmisc_checking_2\r\ntime: 2.499; rss: 1910MB\tMIR_borrow_checking\r\ntime: 0.761; rss: 3685MB\tMIR_effect_checking\r\ntime: 0.000; rss: 3685MB\tlayout_testing\r\ntime: 0.002; rss: 3685MB\tdeath_checking\r\ntime: 0.001; rss: 3685MB\tunused_lib_feature_checking\r\ntime: 1.156; rss: 3393MB\tcrate_lints\r\ntime: 0.007; rss: 3393MB\tmodule_lints\r\ntime: 1.164; rss: 3393MB\tlint_checking\r\ntime: 0.006; rss: 3393MB\tprivacy_checking_modules\r\ntime: 1.176; rss: 3393MB\tmisc_checking_3\r\ntime: 0.016; rss: 3393MB\tgenerate_crate_metadata\r\ntime: 0.004; rss: 3393MB\tcodegen_crate\r\ntime: 0.000; rss: 3393MB\tassert_dep_graph\r\ntime: 0.001; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::type_of)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::generics_of)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::predicates_of)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::mir_const_qualif)\r\ntime: 0.020; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::mir_for_ctfe)\r\ntime: 0.001; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::optimized_mir)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::coverageinfo)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::covered_file_name)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::covered_code_regions)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::promoted_mir)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::unsafety_check_result)\r\ntime: 0.002; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::typeck)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::diagnostic_only_typeck)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::used_trait_imports)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::mir_borrowck)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::eval_to_allocation_raw)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::eval_to_const_value_raw)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::check_match)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::symbol_name)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::codegen_fn_attrs)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::codegen_fulfill_obligation)\r\ntime: 0.001; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::specialization_graph_of)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::adt_drop_tys)\r\ntime: 0.000; rss: 3394MB\tencode_query_results_for(rustc_middle::ty::query::queries::unused_generic_params)\r\ntime: 0.026; rss: 3394MB\tencode_query_results\r\ntime: 0.028; rss: 3394MB\tincr_comp_serialize_result_cache\r\ntime: 0.028; rss: 3394MB\tincr_comp_persist_result_cache\r\ntime: 0.000; rss: 3394MB\tincr_comp_serialize_dep_graph\r\ntime: 0.002; rss: 3394MB\tincr_comp_encode_serialized_dep_graph\r\ntime: 0.003; rss: 3394MB\tincr_comp_encode_dep_graph\r\ntime: 0.003; rss: 3394MB\tincr_comp_persist_dep_graph\r\ntime: 0.031; rss: 3394MB\tserialize_dep_graph\r\ntime: 0.010; rss: 3330MB\tfree_global_ctxt\r\ntime: 0.000; rss: 3330MB\tjoin_worker_thread\r\ntime: 0.001; rss: 3330MB\tcopy_all_cgu_workproducts_to_incr_comp_cache_dir\r\ntime: 0.001; rss: 3330MB\tfinish_ongoing_codegen\r\ntime: 0.000; rss: 3330MB\tllvm_dump_timing_file\r\ntime: 0.000; rss: 3330MB\tserialize_work_products\r\ntime: 0.000; rss: 3330MB\tincr_comp_finalize_session_directory\r\ntime: 0.000; rss: 3330MB\tlink_binary_check_files_are_writeable\r\ntime: 0.000; rss: 3330MB\tlink_binary_remove_temps\r\ntime: 0.000; rss: 3330MB\tlink_binary\r\ntime: 0.000; rss: 3330MB\tlink_crate\r\ntime: 0.002; rss: 3330MB\tlink\r\ntime: 5.477; rss: 3330MB\t\ttotal\r\n    Finished check [unoptimized + debuginfo] target(s) in 6.10s\r\n```\r\n\r\n</details>\r\n\r\nThe main offenders that stand out are\r\n\r\n```\r\ntime: 2.499; rss: 1910MB\tMIR_borrow_checking\r\ntime: 0.761; rss: 3685MB\tMIR_effect_checking\r\n```\r\nwhich spike up from `time: 0.006; rss: 245MB\tmisc_checking_2` before. It would be nice to reduce this somehow.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/81124/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/81124/timeline", "performed_via_github_app": null, "state_reason": null}