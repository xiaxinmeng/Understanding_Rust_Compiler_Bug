{"url": "https://api.github.com/repos/rust-lang/rust/issues/34304", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/34304/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/34304/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/34304/events", "html_url": "https://github.com/rust-lang/rust/issues/34304", "id": 160655364, "node_id": "MDU6SXNzdWUxNjA2NTUzNjQ=", "number": 34304, "title": "Compiler panic on invalid reference type", "user": {"login": "ninewise", "id": 994166, "node_id": "MDQ6VXNlcjk5NDE2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/994166?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ninewise", "html_url": "https://github.com/ninewise", "followers_url": "https://api.github.com/users/ninewise/followers", "following_url": "https://api.github.com/users/ninewise/following{/other_user}", "gists_url": "https://api.github.com/users/ninewise/gists{/gist_id}", "starred_url": "https://api.github.com/users/ninewise/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ninewise/subscriptions", "organizations_url": "https://api.github.com/users/ninewise/orgs", "repos_url": "https://api.github.com/users/ninewise/repos", "events_url": "https://api.github.com/users/ninewise/events{/privacy}", "received_events_url": "https://api.github.com/users/ninewise/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2016-06-16T12:58:22Z", "updated_at": "2016-06-29T16:31:22Z", "closed_at": "2016-06-29T16:31:22Z", "author_association": "NONE", "active_lock_reason": null, "body": "Context: I was playing around with trees for a bit, when I decided the order of the children didn't matter and swapped `Vec`s for `HashSet`s. However, I forgot to substitute them everywhere, which resulted in the following (minimized) code and a compiler panic.\n\nI tried this code:\n\n``` rust\nuse std::collections::HashMap;\nuse std::collections::HashSet;\n\nfn main() {\n    let tree: HashMap<usize, HashSet<usize>> = HashMap::new();\n    let size_of_1 = tree.get(&1).unwrap_or(&Vec::new()).len();\n}\n```\n\nI expected to see this happen: the rust compiler complaining about incorrect types. After all, the `&Vec::new()` should've been a `&HashSet::new()`.\n\nInstead, this happened:\n\n```\n$ rustc test.rs \nerror: internal compiler error: unexpected panic\nnote: the compiler unexpectedly panicked. this is a bug.\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\nthread 'rustc' panicked at 'index out of bounds: the len is 18 but the index is 20', src/libcollections/vec.rs:1166\nnote: Run with `RUST_BACKTRACE=1` for a backtrace.\n```\n\nNote that using the correct intializer works, and using\n\n``` rust\nuse std::collections::HashMap;\nuse std::collections::HashSet;\n\nstruct A { a: usize }\n\nfn main() {\n    let tree: HashMap<usize, HashSet<usize>> = HashMap::new();\n    let size_of_1 = tree.get(&1).unwrap_or(&A {a: 1}).len();\n}\n```\n\ncomplains as expected:\n\n```\n$ rustc test.rs\ntest.rs:9:44: 9:53 error: mismatched types:\n expected `&std::collections::HashSet<usize>`,\n    found `&A`\n(expected struct `std::collections::HashSet`,\n    found struct `A`) [E0308]\ntest.rs:9     let size_of_1 = tree.get(&1).unwrap_or(&A {a: 1}).len();\n                                                     ^~~~~~~~~\ntest.rs:9:44: 9:53 help: run `rustc --explain E0308` to see a detailed explanation\nerror: aborting due to previous error\n```\n## Meta\n\n```\n$ rustc --version --verbose\nrustc 1.9.0\nbinary: rustc\ncommit-hash: unknown\ncommit-date: unknown\nhost: x86_64-unknown-linux-gnu\nrelease: 1.9.0\n```\n\nBacktrace:\n\n```\n$ RUST_BACKTRACE=1 rustc test.rs\nerror: internal compiler error: unexpected panic\nnote: the compiler unexpectedly panicked. this is a bug.\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\nnote: run with `RUST_BACKTRACE=1` for a backtrace\nthread 'rustc' panicked at 'index out of bounds: the len is 18 but the index is 20', src/libcollections/vec.rs:1166\nstack backtrace:\n   1:     0x7fedb86d7310 - <unknown>\n   2:     0x7fedb86e4a0b - <unknown>\n   3:     0x7fedb86e45ac - <unknown>\n   4:     0x7fedb86a953f - std::sys_common::unwind::begin_unwind_inner::h39d40f52add53ef7\n   5:     0x7fedb86ab628 - std::sys_common::unwind::begin_unwind_fmt::h64c0ff793199cc1b\n   6:     0x7fedb86d4b21 - rust_begin_unwind\n   7:     0x7fedb872730f - core::panicking::panic_fmt::h73bf9d7e8e891a73\n   8:     0x7fedb87274f2 - core::panicking::panic_bounds_check::hc30e971884568c27\n   9:     0x7fedb2d52bcd - <unknown>\n  10:     0x7fedb2ce89e0 - rustc::infer::InferCtxt::shallow_resolve::he47cdea6677f40d2\n  11:     0x7fedb2e49eb0 - <unknown>\n  12:     0x7fedb2e48c27 - <unknown>\n  13:     0x7fedb2e4424f - rustc::traits::fulfill::FulfillmentContext::select_where_possible::hf3fc6484c301b5bb\n  14:     0x7fedb3abbc91 - <unknown>\n  15:     0x7fedb3acd423 - rustc_typeck::check::FnCtxt::resolve_type_vars_if_possible::ha2a2b0468a33b7be\n  16:     0x7fedb3ae1ef6 - rustc_typeck::check::demand::coerce::hd43013069440cf8a\n  17:     0x7fedb3adf606 - <unknown>\n  18:     0x7fedb3ade63f - <unknown>\n  19:     0x7fedb3ae4b49 - <unknown>\n  20:     0x7fedb3ae2ba2 - <unknown>\n  21:     0x7fedb3b1a40a - rustc_typeck::check::check_decl_initializer::h130cfba0c1b76b7a\n  22:     0x7fedb3b1a4d1 - rustc_typeck::check::check_decl_local::he651fa13100c1d0f\n  23:     0x7fedb3b1a7c1 - rustc_typeck::check::check_stmt::h90d31dcbe73b93a2\n  24:     0x7fedb3ac15a8 - <unknown>\n  25:     0x7fedb3ab9239 - <unknown>\n  26:     0x7fedb3ab6aec - <unknown>\n  27:     0x7fedb3ab19c6 - rustc_typeck::check::check_item_body::h1895344155d5b2b2\n  28:     0x7fedb3aa9881 - rustc_typeck::check::check_item_bodies::h525c1aa0e1abb529\n  29:     0x7fedb3aa0def - rustc_typeck::check_crate::h0ef96f4043e1e69a\n  30:     0x7fedb8c21960 - <unknown>\n  31:     0x7fedb8c1fa48 - <unknown>\n  32:     0x7fedb8c1c45e - <unknown>\n  33:     0x7fedb8bee90f - rustc_driver::driver::compile_input::h6491aaddd9e61258\n  34:     0x7fedb8bd4e74 - rustc_driver::run_compiler::h80b2ba5e4d787c5f\n  35:     0x7fedb8bd22d1 - <unknown>\n  36:     0x7fedb86d4aab - <unknown>\n  37:     0x7fedb86d4a3d - std::sys_common::unwind::inner_try::h9eebd8dc83f388a6\n  38:     0x7fedb8bd2b1a - <unknown>\n  39:     0x7fedb86e2ba4 - <unknown>\n  40:     0x7fedb120b3f3 - start_thread\n                        at /builddir/glibc-2.23/nptl/pthread_create.c:333\n  41:     0x7fedb833fbac - clone\n                        at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109\n  42:                0x0 - <unknown>\n```\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/34304/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/34304/timeline", "performed_via_github_app": null, "state_reason": "completed"}