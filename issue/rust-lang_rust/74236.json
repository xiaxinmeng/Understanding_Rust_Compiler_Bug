{"url": "https://api.github.com/repos/rust-lang/rust/issues/74236", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/74236/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/74236/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/74236/events", "html_url": "https://github.com/rust-lang/rust/issues/74236", "id": 655165123, "node_id": "MDU6SXNzdWU2NTUxNjUxMjM=", "number": 74236, "title": "ICE when printing paths in modules with non-DefId reexports (e.g. NonMacroAttr(Builtin)).", "user": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2020-07-11T08:36:45Z", "updated_at": "2020-07-14T02:36:22Z", "closed_at": "2020-07-14T02:36:03Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "`dep.rs` (compiled with `--edition=2018`):\r\n```rust\r\nmod private { pub struct Pub; }\r\n// Reexport built-in attribute without a DefId (requires Rust 2018).\r\npub use cfg_attr as attr;\r\n// This export needs to be after the built-in attribute to trigger the bug.\r\npub use private::Pub as Renamed;\r\n```\r\n`main.rs`:\r\n```rust\r\nfn main() {\r\n    // Trigger an error that will print the path of dep::private::Pub (as \"dep::Renamed\").\r\n    let () = dep::Renamed;\r\n}\r\n```\r\nResults in `attempted .def_id() on invalid res: NonMacroAttr(Builtin)` due to the `.def_id()` call in: https://github.com/rust-lang/rust/blob/daecab3a784f28082df90cebb204998051f3557d/src/librustc_middle/ty/print/pretty.rs#L391-L401\r\n\r\nThe snippet above is searching `dep`'s children for the reexport of `dep::private::Pub` in order to grab its reexported name (`Renamed` here) when it runs into the `pub use cfg_attr as attr;` reexport lacking a `DefId`.\r\n\r\nFix is straight-forward, we can just ignore siblings lacking a `DefId`:\r\n```diff\r\n-         .find(|child| child.res.def_id() == def_id)\r\n+         .find(|child| child.res.opt_def_id() == Some(def_id))\r\n```\r\n\r\n<hr/>\r\n\r\nBut I'm mostly making this issue to point out the fact that it is possible to create strange reexports that could break various parts of the compiler, even if it might be very rare (#74081 appears to be an instance of this).\r\n\r\n(as I was writing this I found that @da-x had already tried out the fix - see https://github.com/rust-lang/rust/issues/74081#issuecomment-657012684)\r\n\r\ncc @rust-lang/compiler ", "closed_by": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/74236/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/74236/timeline", "performed_via_github_app": null, "state_reason": "completed"}