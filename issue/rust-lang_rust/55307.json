{"url": "https://api.github.com/repos/rust-lang/rust/issues/55307", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/55307/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/55307/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/55307/events", "html_url": "https://github.com/rust-lang/rust/issues/55307", "id": 373420491, "node_id": "MDU6SXNzdWUzNzM0MjA0OTE=", "number": 55307, "title": "Misleading/unhelpful error message from borrow checker", "user": {"login": "vsajip", "id": 130553, "node_id": "MDQ6VXNlcjEzMDU1Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/130553?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vsajip", "html_url": "https://github.com/vsajip", "followers_url": "https://api.github.com/users/vsajip/followers", "following_url": "https://api.github.com/users/vsajip/following{/other_user}", "gists_url": "https://api.github.com/users/vsajip/gists{/gist_id}", "starred_url": "https://api.github.com/users/vsajip/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vsajip/subscriptions", "organizations_url": "https://api.github.com/users/vsajip/orgs", "repos_url": "https://api.github.com/users/vsajip/repos", "events_url": "https://api.github.com/users/vsajip/events{/privacy}", "received_events_url": "https://api.github.com/users/vsajip/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 1775993, "node_id": "MDU6TGFiZWwxNzc1OTkz", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-lifetimes", "name": "A-lifetimes", "color": "f7e101", "default": false, "description": "Area: lifetime related"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 1596121013, "node_id": "MDU6TGFiZWwxNTk2MTIxMDEz", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-confusing", "name": "D-confusing", "color": "c9f7a3", "default": false, "description": "Confusing diagnostic error that should be reworked"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-10-24T10:47:17Z", "updated_at": "2020-06-11T17:35:03Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "The following program, when compiled, gives rise to a misleading and unhelpful error message:\r\n```\r\nuse std::io;\r\n\r\nenum Error<'a> {\r\n    Invalid(&'a [u8]),\r\n    Io(io::Error),\r\n}\r\n\r\nstruct Thing {\r\n    counter: usize\r\n}\r\n\r\nenum Result<'a> {\r\n    Done,\r\n    Error(Error<'a>),\r\n    Value(usize)\r\n}\r\n\r\nimpl Thing {\r\n    fn new() -> Self {\r\n        Self { counter: 0 }\r\n    }\r\n\r\n    fn process(&mut self) -> Result {\r\n        self.counter += 1;\r\n        Result::Done // for now\r\n    }\r\n}\r\n\r\nfn main() {\r\n    let mut thing = Thing::new();\r\n    loop {\r\n        let result = thing.process();\r\n        match result {\r\n            Result::Done => {\r\n                break;\r\n            }\r\n            Result::Error(e) => panic!(e),\r\n            Result::Value(v) => {\r\n                println!(\"{}\", v);\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nThe message is:\r\n```\r\n   Compiling playground v0.0.1 (/playground)\r\nerror[E0499]: cannot borrow `thing` as mutable more than once at a time\r\n  --> src/lib.rs:32:22\r\n   |\r\n32 |         let result = thing.process();\r\n   |                      ^^^^^ mutable borrow starts here in previous iteration of loop\r\n   |\r\n   = note: borrowed value must be valid for the static lifetime...\r\n\r\nerror: aborting due to previous error\r\n```\r\n\r\nHowever, the mutable borrow complaint appears remote from the true reason for the error.\r\n\r\nThe key to determining the problem, as analysed by Daniel Keep  [here](https://users.rust-lang.org/t/trying-to-understand-lifetimes-in-loops/21356/2), is the exact language of the error message:\r\n\r\n> note: borrowed value must be valid for the static lifetime...\r\n\r\nAt first glance, there are no static borrows anywhere in the code. But what's actually happening is that when there's the `panic!(e)`, `e` is being used as the literal panic payload. In order for that to work, `e` itself must live forever. But, as `Error` contains a borrow, that borrow must live forever.\r\n\r\nBut the `'a` lifetime of that `Error` borrow is tied to the `'a` lifetime in `Result`. And that lifetime is tied to the lifetime of `self`, which is in turn the required lifetime of the `thing` variable.\r\n\r\nSo `thing` has to be `'static`, but it cannot be `'static` because it\u2019s on the stack.\r\n\r\nIt's not immediately obvious how best to improve the error message, but the current message isn't helpful, because it points to the borrow in the loop.\r\n\r\nApparently Polonius doesn't give any better message.\r\n\r\nLinks which may be useful:\r\n\r\n[The sample in Rust Playground](https://play.rust-lang.org/?version=beta&mode=debug&edition=2018&gist=f9737238a4c8b43305e0f08487aa668a)\r\n[Discussion on users.rust-lang.org](https://users.rust-lang.org/t/trying-to-understand-lifetimes-in-loops/21356)\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/55307/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/55307/timeline", "performed_via_github_app": null, "state_reason": null}