{"url": "https://api.github.com/repos/rust-lang/rust/issues/44405", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/44405/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/44405/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/44405/events", "html_url": "https://github.com/rust-lang/rust/issues/44405", "id": 256112197, "node_id": "MDU6SXNzdWUyNTYxMTIxOTc=", "number": 44405, "title": "ICE when calling mutation method on map value indexed with mutable reference", "user": {"login": "saghm", "id": 5875560, "node_id": "MDQ6VXNlcjU4NzU1NjA=", "avatar_url": "https://avatars.githubusercontent.com/u/5875560?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saghm", "html_url": "https://github.com/saghm", "followers_url": "https://api.github.com/users/saghm/followers", "following_url": "https://api.github.com/users/saghm/following{/other_user}", "gists_url": "https://api.github.com/users/saghm/gists{/gist_id}", "starred_url": "https://api.github.com/users/saghm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saghm/subscriptions", "organizations_url": "https://api.github.com/users/saghm/orgs", "repos_url": "https://api.github.com/users/saghm/repos", "events_url": "https://api.github.com/users/saghm/events{/privacy}", "received_events_url": "https://api.github.com/users/saghm/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 46741598, "node_id": "MDU6TGFiZWw0Njc0MTU5OA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-test", "name": "E-needs-test", "color": "02e10c", "default": false, "description": "Call for participation: writing correctness tests"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-09-08T01:00:34Z", "updated_at": "2019-08-09T15:55:11Z", "closed_at": "2019-08-09T15:55:11Z", "author_association": "NONE", "active_lock_reason": null, "body": "When calling a mutation method on an value obtained from a HashMap with a mutable reference index, an ICE occurs.\r\n\r\nCode:\r\n```rust\r\nuse std::collections::HashMap;\r\n\r\nfn main() {\r\n    let mut map: HashMap<i32, Vec<i32>> = HashMap::new();\r\n    let mut i = 1;\r\n    map.insert(i, Vec::new());\r\n\r\n    map[&mut i].push(3); // ICE occurs here\r\n}\r\n```\r\nCompiler output:\r\n```\r\nerror: internal compiler error: re-trying op failed\r\n --> src/main.rs:8:5\r\n  |\r\n8 |     map[&mut i].push(3);\r\n  |     ^^^^^^^^^^^\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n```\r\n\r\nBacktrace:\r\n```\r\nthread 'rustc' panicked at 'Box<Any>', /checkout/src/librustc_errors/lib.rs:437:8\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\nstack backtrace:\r\n   0: std::sys::imp::backtrace::tracing::imp::unwind_backtrace\r\n             at /checkout/src/libstd/sys/unix/backtrace/tracing/gcc_s.rs:49\r\n   1: std::sys_common::backtrace::_print\r\n             at /checkout/src/libstd/sys_common/backtrace.rs:71\r\n   2: std::panicking::default_hook::{{closure}}\r\n             at /checkout/src/libstd/sys_common/backtrace.rs:60\r\n             at /checkout/src/libstd/panicking.rs:380\r\n   3: std::panicking::default_hook\r\n             at /checkout/src/libstd/panicking.rs:390\r\n   4: std::panicking::rust_panic_with_hook\r\n             at /checkout/src/libstd/panicking.rs:611\r\n   5: std::panicking::begin_panic_new\r\n   6: rustc_errors::Handler::abort_if_errors\r\n   7: rustc_passes::consts::check_crate\r\n   8: rustc_driver::driver::phase_3_run_analysis_passes::{{closure}}\r\n   9: rustc_driver::driver::phase_3_run_analysis_passes\r\n  10: rustc_driver::driver::compile_input\r\n  11: rustc_driver::run_compiler\r\n```\r\n\r\nI believe that the correct behavior here would be for the compiler to report an error to the user on the indicated line due to IndexMut not being implemented for HashMap, which is what occurs when replacing `&mut i` with just `&i`.\r\n\r\nrustc version:\r\n```\r\nrustc 1.20.0 (f3d6973f4 2017-08-27)\r\nbinary: rustc\r\ncommit-hash: f3d6973f41a7d1fb83029c9c0ceaf0f5d4fd7208\r\ncommit-date: 2017-08-27\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.20.0\r\nLLVM version: 4.0\r\n```", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/44405/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/44405/timeline", "performed_via_github_app": null, "state_reason": "completed"}