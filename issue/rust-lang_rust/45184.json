{"url": "https://api.github.com/repos/rust-lang/rust/issues/45184", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/45184/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/45184/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/45184/events", "html_url": "https://github.com/rust-lang/rust/issues/45184", "id": 264373649, "node_id": "MDU6SXNzdWUyNjQzNzM2NDk=", "number": 45184, "title": "MIR: permit \"false edges\", that are only used in the analysis", "user": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37234, "node_id": "MDU6TGFiZWwzNzIzNA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-cleanup", "name": "C-cleanup", "color": "f5f1fd", "default": false, "description": "Category: PRs that clean code up or issues documenting cleanup."}, {"id": 67766349, "node_id": "MDU6TGFiZWw2Nzc2NjM0OQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-mentor", "name": "E-mentor", "color": "02E10C", "default": false, "description": "Call for participation: This issue has a mentor. Use RustcContributor::new on Zulip for discussion."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 12, "created_at": "2017-10-10T20:57:49Z", "updated_at": "2017-11-15T20:21:41Z", "closed_at": "2017-11-15T20:21:41Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "As discussed in https://github.com/rust-lang/rust/issues/45043, we sometimes want to have false edges in the MIR that are used by borrowck and other conservative safety analyses, but which are optimized away when we actually generate code. The current hack is to e.g. replace a `GOTO X` terminator with something like `IF TRUE { X } ELSE { Y }`. This works (and should be optimized away), but it's not that flexible, and not that obvious.\r\n\r\nIt'd be nice to have something more first class. This *could* look like a vector of `false_edges: Vec<BasicBlock>` as part of `BasicBlockData` (that would get cleared after analysis), but that's a bit unfortunate since in that case they can be easily overlooked, since the code now has to remember to look not only at the terminator but also elsewhere.\r\n\r\nOn Gitter, we were thinking that a nice approach might be to add a new [`TerminatorKind`](https://github.com/rust-lang/rust/blob/ec016f80cf725a9c8a613cdcd2ac97588d5f9af2/src/librustc/mir/mod.rs#L588) variant named  something like `FalseEdges`. This could even wrap the \"true\" terminator and then add additional edges:\r\n\r\n```rust\r\nenum TerminatorKind {\r\n    ...\r\n    FalseEdges(Box<FalseEdgesData>) // introducing box here keeps total size down\r\n}\r\n\r\nstruct FalseEdgesData {\r\n    true_terminator: TerminatorKind,\r\n    false_edges: Vec<BasicBlock>\r\n}\r\n```\r\n\r\nThis would then be replaced with the `true_terminator` by the [terminator simplification code](https://github.com/rust-lang/rust/blob/ec016f80cf725a9c8a613cdcd2ac97588d5f9af2/src/librustc_mir/transform/simplify_branches.rs#L39).\r\n\r\nFor now, places that could benefit from this are marked with FIXME.\r\n\r\nThe steps to make this change are roughly:\r\n\r\n- Introduce the variant listed above. Get things to compile. Reach out to myself or others [on gitter](https://gitter.im/rust-impl-period/WG-compiler-nll) if weird things arise in the process.\r\n- Modify the [terminator simplification code](https://github.com/rust-lang/rust/blob/ec016f80cf725a9c8a613cdcd2ac97588d5f9af2/src/librustc_mir/transform/simplify_branches.rs#L39) to replace `FalseEdges` with the underlying true terminator.\r\n- Replace the existing code using hacky false edges with the new stuff.\r\n- Huzzah!", "closed_by": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/45184/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/45184/timeline", "performed_via_github_app": null, "state_reason": "completed"}