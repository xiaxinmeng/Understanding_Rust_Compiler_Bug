{"url": "https://api.github.com/repos/rust-lang/rust/issues/87294", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/87294/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/87294/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/87294/events", "html_url": "https://github.com/rust-lang/rust/issues/87294", "id": 948002416, "node_id": "MDU6SXNzdWU5NDgwMDI0MTY=", "number": 87294, "title": "Use u32 instead of usize in ArcInner to save memory", "user": {"login": "eloff", "id": 27574, "node_id": "MDQ6VXNlcjI3NTc0", "avatar_url": "https://avatars.githubusercontent.com/u/27574?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eloff", "html_url": "https://github.com/eloff", "followers_url": "https://api.github.com/users/eloff/followers", "following_url": "https://api.github.com/users/eloff/following{/other_user}", "gists_url": "https://api.github.com/users/eloff/gists{/gist_id}", "starred_url": "https://api.github.com/users/eloff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eloff/subscriptions", "organizations_url": "https://api.github.com/users/eloff/orgs", "repos_url": "https://api.github.com/users/eloff/repos", "events_url": "https://api.github.com/users/eloff/events{/privacy}", "received_events_url": "https://api.github.com/users/eloff/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2021-07-19T20:29:34Z", "updated_at": "2021-08-16T12:32:46Z", "closed_at": "2021-08-16T04:43:33Z", "author_association": "NONE", "active_lock_reason": null, "body": "There's little point to using usize instead of u32 for Arc. There's no desirable reason to have more than 4 billion strong or weak references to an Arc. It's weird that 32bit and 64bit platforms would support different amounts of references, but fortunately because there's no reason to do that, nobody thinks about this in practice when targeting multiple platforms.\r\n\r\nWe can save 8 bytes on 64bit platforms per Arc (and the associated cache pressure) by switching to u32 instead. I don't see that this would impact any (valid) Rust programs in the wild, but it would give a widespread small efficiency boost for a comparatively small change.\r\n\r\nIt would also open up the possibility of storing both strong and weak count in the same 64bit word on 64bit platforms, which would speedup some of the methods like get_mut, make_mut, upgrade, etc - albeit at the cost of extra complexity by having different 32bit and 64bit code paths in some places. But that's an optional optimization and not required for this proposal to be beneficial.\r\n\r\nI believe there may be one reason usize is used, and that's to avoid undefined behaviour if the ref count overflows. I don't think this is an issue for valid programs, and anyway, if it was an issue, it still is on 32bit platforms.\r\n\r\nThoughts? Is my reasoning too simplistic or flawed here?", "closed_by": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/87294/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/87294/timeline", "performed_via_github_app": null, "state_reason": "completed"}