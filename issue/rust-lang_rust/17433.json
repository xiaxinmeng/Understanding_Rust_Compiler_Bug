{"url": "https://api.github.com/repos/rust-lang/rust/issues/17433", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/17433/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/17433/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/17433/events", "html_url": "https://github.com/rust-lang/rust/issues/17433", "id": 43367400, "node_id": "MDU6SXNzdWU0MzM2NzQwMA==", "number": 17433, "title": "librustuv: avoid using the magic number -1 for offset", "user": {"login": "nodakai", "id": 90726, "node_id": "MDQ6VXNlcjkwNzI2", "avatar_url": "https://avatars.githubusercontent.com/u/90726?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nodakai", "html_url": "https://github.com/nodakai", "followers_url": "https://api.github.com/users/nodakai/followers", "following_url": "https://api.github.com/users/nodakai/following{/other_user}", "gists_url": "https://api.github.com/users/nodakai/gists{/gist_id}", "starred_url": "https://api.github.com/users/nodakai/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nodakai/subscriptions", "organizations_url": "https://api.github.com/users/nodakai/orgs", "repos_url": "https://api.github.com/users/nodakai/repos", "events_url": "https://api.github.com/users/nodakai/events{/privacy}", "received_events_url": "https://api.github.com/users/nodakai/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2014-09-22T03:53:33Z", "updated_at": "2014-10-02T08:45:14Z", "closed_at": "2014-10-02T08:45:14Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The signature of [uv_fs_read()](https://github.com/rust-lang/libuv/blob/master/include/uv.h#L1634) is\n\n``` c\nUV_EXTERN int uv_fs_read(uv_loop_t* loop, uv_fs_t* req, uv_file file,\n    void* buf, size_t length, int64_t offset, uv_fs_cb cb);\n```\n\nand when we pass `-1` as `offset`, `libuv` discards it in favor of the intrinsic file offset.\n- https://github.com/rust-lang/libuv/blob/master/src/win/fs.c#L527\n\n``` c\n  if (offset != -1) {\n    memset(&overlapped, 0, sizeof overlapped);\n\n    offset_.QuadPart = offset;\n    overlapped.Offset = offset_.LowPart;\n    overlapped.OffsetHigh = offset_.HighPart;\n\n    overlapped_ptr = &overlapped;\n  } else {\n    overlapped_ptr = NULL;\n  }\n```\n- https://github.com/rust-lang/libuv/blob/master/src/unix/fs.c#L191\n\n``` c\nstatic ssize_t uv__fs_read(uv_fs_t* req) {\n  if (req->off < 0)\n    return read(req->file, req->buf, req->len);\n  else\n    return pread(req->file, req->buf, req->len, req->off);\n}\n```\n\n(The same goes for write operations.)\n\nSuch an interface design is fine for `libuv` itself, but `librustuv` should present more meaningful interface such as `offset: Option<u64>`.  Note that the role of the magic number `-1` is documented nowhere in `libuv` (sample codes in the [uvbook](http://nikhilm.github.io/uvbook/filesystem.html) use it without any explanations.)  That pretty much means the users of `libuv` are expected to go through its implementation code in C.  But all the developers of Rust don't need to do so.\n", "closed_by": {"login": "thestinger", "id": 1505226, "node_id": "MDQ6VXNlcjE1MDUyMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thestinger", "html_url": "https://github.com/thestinger", "followers_url": "https://api.github.com/users/thestinger/followers", "following_url": "https://api.github.com/users/thestinger/following{/other_user}", "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}", "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions", "organizations_url": "https://api.github.com/users/thestinger/orgs", "repos_url": "https://api.github.com/users/thestinger/repos", "events_url": "https://api.github.com/users/thestinger/events{/privacy}", "received_events_url": "https://api.github.com/users/thestinger/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/17433/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/17433/timeline", "performed_via_github_app": null, "state_reason": "completed"}