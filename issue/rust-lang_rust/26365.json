{"url": "https://api.github.com/repos/rust-lang/rust/issues/26365", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/26365/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/26365/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/26365/events", "html_url": "https://github.com/rust-lang/rust/issues/26365", "id": 88894221, "node_id": "MDU6SXNzdWU4ODg5NDIyMQ==", "number": 26365, "title": "symbol names specified by link_name get mangled on x86 but not x86_64", "user": {"login": "bvinc", "id": 165166, "node_id": "MDQ6VXNlcjE2NTE2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/165166?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bvinc", "html_url": "https://github.com/bvinc", "followers_url": "https://api.github.com/users/bvinc/followers", "following_url": "https://api.github.com/users/bvinc/following{/other_user}", "gists_url": "https://api.github.com/users/bvinc/gists{/gist_id}", "starred_url": "https://api.github.com/users/bvinc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bvinc/subscriptions", "organizations_url": "https://api.github.com/users/bvinc/orgs", "repos_url": "https://api.github.com/users/bvinc/repos", "events_url": "https://api.github.com/users/bvinc/events{/privacy}", "received_events_url": "https://api.github.com/users/bvinc/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2015-06-17T02:47:51Z", "updated_at": "2015-06-17T23:07:07Z", "closed_at": "2015-06-17T23:07:07Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "When specifying the link_name attribute for an extern function, the symbol names get mangled on x86 but not on x86_64.\n\nI tried this code:\n\n``` rust\nextern \"stdcall\" {\n    #[link_name=\"mylinknamestdcall\"]\n    pub fn a(x: u32) -> u32;\n}\nextern \"C\" {\n    #[link_name=\"mylinknamec\"]\n    pub fn b(x: u32) -> u32;\n}\n\nfn main() {\n    unsafe {\n        a(1);\n        b(2);\n    }\n}\n```\n\nOf course, it fails to compile.  But here is what happens on Windows x86:\n\n```\nnote: C:\\src\\symboltest\\target\\debug\\symboltest.o: In function `ZN10symboltest4mainE':\nC:\\src\\symboltest/src/main.rs:12: undefined reference to `mylinknamestdcall@4'\nC:\\src\\symboltest/src/main.rs:13: undefined reference to `mylinknamec'\n```\n\nThis error message is a bit misleading, since underscores aren't showing up in the error message.  The true symbol names that are undefined are:\n\n```\n$ objdump.exe -t target/debug/symboltest.o | grep mylinkname\n[ 30](sec  0)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00000000 _mylinknamestdcall@4\n[ 31](sec  0)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00000000 _mylinknamec\n```\n\nNotice that both symbol names are being mangled, depending on the calling convention.\n\nOn x86_64, the exact same code produces non-mangled symbols:\n\n```\n$ objdump.exe -t target/debug/symboltest.o | grep mylinkname\n[ 31](sec  0)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00000000 mylinknamestdcall\n[ 32](sec  0)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00000000 mylinknamec\n```\n\nI would expect that a name specified by the `link_name` attribute would not get mangled.  I would also expect the same behavior on x86 and x86_64.\n\n```\n$ rustc --version --verbose\nrustc 1.2.0-nightly (d6c8028ce 2015-06-09)\nbinary: rustc\ncommit-hash: d6c8028ce0eaf18abb67e4e2dafc5aae2e6e91de\ncommit-date: 2015-06-09\nhost: i686-pc-windows-gnu\nrelease: 1.2.0-nightly\n```\n## Workaround\n\nIf you start your `link_name` attribute with a \\x01, this apparently signals LLVM to disable name mangling.  Like: `#[link_name=\"\\x01mylinkname\"]`\n", "closed_by": {"login": "bvinc", "id": 165166, "node_id": "MDQ6VXNlcjE2NTE2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/165166?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bvinc", "html_url": "https://github.com/bvinc", "followers_url": "https://api.github.com/users/bvinc/followers", "following_url": "https://api.github.com/users/bvinc/following{/other_user}", "gists_url": "https://api.github.com/users/bvinc/gists{/gist_id}", "starred_url": "https://api.github.com/users/bvinc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bvinc/subscriptions", "organizations_url": "https://api.github.com/users/bvinc/orgs", "repos_url": "https://api.github.com/users/bvinc/repos", "events_url": "https://api.github.com/users/bvinc/events{/privacy}", "received_events_url": "https://api.github.com/users/bvinc/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/26365/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/26365/timeline", "performed_via_github_app": null, "state_reason": "completed"}