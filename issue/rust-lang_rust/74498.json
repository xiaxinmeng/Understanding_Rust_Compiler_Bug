{"url": "https://api.github.com/repos/rust-lang/rust/issues/74498", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/74498/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/74498/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/74498/events", "html_url": "https://github.com/rust-lang/rust/issues/74498", "id": 660557005, "node_id": "MDU6SXNzdWU2NjA1NTcwMDU=", "number": 74498, "title": "LTO triggers apparent miscompilation on Windows 10 x64", "user": {"login": "AlyoshaVasilieva", "id": 1284317, "node_id": "MDQ6VXNlcjEyODQzMTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1284317?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AlyoshaVasilieva", "html_url": "https://github.com/AlyoshaVasilieva", "followers_url": "https://api.github.com/users/AlyoshaVasilieva/followers", "following_url": "https://api.github.com/users/AlyoshaVasilieva/following{/other_user}", "gists_url": "https://api.github.com/users/AlyoshaVasilieva/gists{/gist_id}", "starred_url": "https://api.github.com/users/AlyoshaVasilieva/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AlyoshaVasilieva/subscriptions", "organizations_url": "https://api.github.com/users/AlyoshaVasilieva/orgs", "repos_url": "https://api.github.com/users/AlyoshaVasilieva/repos", "events_url": "https://api.github.com/users/AlyoshaVasilieva/events{/privacy}", "received_events_url": "https://api.github.com/users/AlyoshaVasilieva/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}, {"id": 203429200, "node_id": "MDU6TGFiZWwyMDM0MjkyMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-high", "name": "P-high", "color": "eb6420", "default": false, "description": "High priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 267612997, "node_id": "MDU6TGFiZWwyNjc2MTI5OTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-unsound", "name": "I-unsound", "color": "e11d21", "default": false, "description": "Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1568663381, "node_id": "MDU6TGFiZWwxNTY4NjYzMzgx", "url": "https://api.github.com/repos/rust-lang/rust/labels/ICEBreaker-LLVM", "name": "ICEBreaker-LLVM", "color": "74cc28", "default": false, "description": "Bugs identified for the LLVM ICE-breaker group"}, {"id": 2459791492, "node_id": "MDU6TGFiZWwyNDU5NzkxNDky", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-lto", "name": "A-lto", "color": "f7e101", "default": false, "description": "Area: Link Time Optimization"}], "state": "closed", "locked": false, "assignee": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 24, "created_at": "2020-07-19T03:33:42Z", "updated_at": "2021-03-06T11:21:13Z", "closed_at": "2021-03-06T11:21:13Z", "author_association": "NONE", "active_lock_reason": null, "body": "I tried this code:\r\n\r\nCargo.toml:\r\n\r\n```toml\r\n[package]\r\nname = \"bmp-minimal\"\r\nversion = \"0.1.0\"\r\nauthors = [\"Malloc Voidstar <1284317+AlyoshaVasilieva@users.noreply.github.com>\"]\r\nedition = \"2018\"\r\n\r\n[dependencies]\r\n\r\n[profile.release]\r\nlto = true\r\ncodegen-units = 1\r\n```\r\n\r\nmain.rs:\r\n\r\n```rust\r\nuse std::io::Write;\r\n\r\nfn main() {\r\n    let mut out = Vec::with_capacity(51200);\r\n    for val in 0u8..=255 {\r\n        out.write_all(&[val, val, val, 0]).unwrap();\r\n    }\r\n\r\n    for _ in (0..1).rev() {\r\n        for _ in 0..1 {\r\n            out.write_all(&[0]).unwrap();\r\n        }\r\n    }\r\n    println!(\"{} bytes written\", out.len());\r\n}\r\n\r\n```\r\n\r\n(extremely minimized form of grayscale BMP encoding from `image` crate)\r\n\r\nCommand: `cargo run --release`\r\n\r\nI expected to see this happen: `1025 bytes written`\r\n\r\nInstead, this happened: \r\n```\r\nmemory allocation of 26843545600 bytes failederror: process didn't exit successfully: `target\\release\\bmp-minimal.exe` (exit code: 0xc0000409, STATUS_STACK_BUFFER_OVERRUN)\r\n```\r\n\r\n### Meta\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.45.0 (5c1f21c3b 2020-07-13)\r\nbinary: rustc\r\ncommit-hash: 5c1f21c3b82297671ad3ae1e8c942d2ca92e84f2\r\ncommit-date: 2020-07-13\r\nhost: x86_64-pc-windows-msvc\r\nrelease: 1.45.0\r\nLLVM version: 10.0\r\n```\r\n\r\nIt appears to work fine on ARM Linux in my limited testing.\r\n\r\nThis minimized form works/doesn't work on the following versions:\r\n\r\n|Rust version|Works?|\r\n|-|-|\r\n|1.45 (LLVM 10.0)|No|\r\n|1.44.1|No|\r\n|1.43.1|Yes|\r\n|1.42.0|No|\r\n|1.41.1|No|\r\n|1.40.0|No|\r\n|1.39.0|No|\r\n|1.38.0 (LLVM 9.0)|No|\r\n|1.37.0|Yes|\r\n|1.36.0|Yes|\r\n|1.35.0|Yes|\r\n|1.34.0|Yes|\r\n\r\nIf the LTO and codegen-units settings are removed it works on all above versions.\r\n\r\nI originally noticed this when a project that worked on 1.44.1 suddenly started failing with huge memory allocations on 1.45, so this table specifically applies to this repro, not whatever the underlying bug is.", "closed_by": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/74498/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/74498/timeline", "performed_via_github_app": null, "state_reason": "completed"}