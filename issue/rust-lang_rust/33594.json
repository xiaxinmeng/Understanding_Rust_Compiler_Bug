{"url": "https://api.github.com/repos/rust-lang/rust/issues/33594", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/33594/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/33594/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/33594/events", "html_url": "https://github.com/rust-lang/rust/issues/33594", "id": 154524827, "node_id": "MDU6SXNzdWUxNTQ1MjQ4Mjc=", "number": 33594, "title": "Seemingly pathological behavior in typechecking, item collecting, and trans", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 12, "created_at": "2016-05-12T16:23:45Z", "updated_at": "2017-06-23T13:37:31Z", "closed_at": "2017-06-23T13:37:31Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "In working on a prototype [futures library](https://github.com/alexcrichton/futures-rs) I've played around a bit with a [small example program](https://github.com/alexcrichton/futures-rs/blob/08332cfa6bf62731859c887b8bc0764a60228078/examples/retry.rs). Unfortunately this [20-line function](https://github.com/alexcrichton/futures-rs/blob/08332cfa6bf62731859c887b8bc0764a60228078/examples/retry.rs#L11-L35) has a **12 second compile time in debug mode**. Looking at `-Z time-passes`, the worst offenders are:\n\n```\n$ rustup run nightly cargo rustc --example retry -- -Z time-passes\n...\ntime: 2.266; rss: 87MB  item-bodies checking\n...\ntime: 0.000; rss: 95MB  Prepare MIR codegen passes\n  time: 3.745; rss: 106MB       translation item collection                                             \n  time: 0.000; rss: 124MB       write metadata                                                          \ntime: 9.259; rss: 124MB translation                                                                     \ntime: 0.000; rss: 124MB assert dep graph\ntime: 0.000; rss: 124MB serialize dep graph\n  time: 0.021; rss: 73MB        llvm function passes [0]\n  time: 0.005; rss: 74MB        llvm module passes [0]  \n  time: 0.365; rss: 79MB        codegen passes [0]      \n  time: 0.000; rss: 71MB        codegen passes [0]      \ntime: 0.402; rss: 71MB  LLVM passes                     \n  time: 0.042; rss: 71MB        running linker\ntime: 0.043; rss: 71MB  linking               \n```\n\nSome interesting data points\n- Item-bodies checking is taking two seconds? (cc @nikomatsakis)\n- Translation item collection it taking **four seconds**. (cc @michaelwoerister)\n- Trans itself is taking around six seconds (cc @arielb1, @dotdash). I didn't _think_ this is monomorphizing massive amounts of code, at least not 6 seconds worth of trans of code.\n\nFWIW, the `perf record` of this compile looks like the hottest functions are (those above 1%):\n\n```\n 23.53%     rustc  librustc-031d5509.so                  [.] _$LT$ty..subst..Substs$LT$$u27$tcx$GT$$u20$as$u20$core..hash..Hash$GT$::hash::h67025cda0fa7ab1b                                                \n 10.49%     rustc  librustc-031d5509.so                  [.] _$LT$collections..vec..Vec$LT$T$GT$$u20$as$u20$core..hash..Hash$GT$::hash::ha06e4f3f77f47962                                                   \n  4.92%     rustc  librustc-031d5509.so                  [.] _$LT$std..collections..HashMap$LT$K$C$$u20$V$C$$u20$S$GT$$GT$::get::h97a8507e2c811a37                                                          \n  4.88%     rustc  librustc-031d5509.so                  [.] _$LT$std..collections..HashMap$LT$K$C$$u20$V$C$$u20$S$GT$$GT$::get::hfbcbea9f0e6ca77f                                                          \n  2.79%     rustc  libstd-031d5509.so                    [.] mallocx                                                                                                                                        \n  2.73%     rustc  libstd-031d5509.so                    [.] sdallocx                                                                                                                                       \n  2.43%     rustc  librustc-031d5509.so                  [.] _$LT$ty..sty..TypeVariants$LT$$u27$tcx$GT$$u20$as$u20$core..hash..Hash$GT$::hash::h13defa770fe420c4                                            \n  2.16%     rustc  librustc-031d5509.so                  [.] rustc::ty::fold::TypeFolder::fold_ty::hc4acd00a49a1567e                                                                                        \n  1.71%     rustc  librustc-031d5509.so                  [.] _$LT$ty..sty..TypeVariants$LT$$u27$tcx$GT$$u20$as$u20$core..cmp..PartialEq$GT$::eq::he128d17c0cf9651e                                          \n  1.57%     rustc  librustc-031d5509.so                  [.] rustc::ty::context::TyCtxt::intern_ty::h30fe821a54c8bb56                                                                                       \n  1.53%     rustc  libc-2.19.so                          [.] __memmove_ssse3_back                                                                                                                           \n  1.24%     rustc  librustc-031d5509.so                  [.] rustc::ty::context::TyCtxt::mk_substs::hf9ef6f493c09a1fb                                                                                       \n  1.19%     rustc  librustc-031d5509.so                  [.] _$LT$ty..sty..Binder$LT$T$GT$$u20$as$u20$core..hash..Hash$GT$::hash::h1d6271393e0c767b                                                         \n  1.05%     rustc  librustc-031d5509.so                  [.] traits..ObligationCause$LT$$u27$static$GT$::drop.80363::hae63a8e62161292a                                                                      \n  1.04%     rustc  librustc-031d5509.so                  [.] _$LT$infer..resolve..OpportunisticTypeResolver$LT$$u27$a$C$$u20$$u27$tcx$GT$$u20$as$u20$ty..fold..TypeFolder$LT$$u27$tcx$GT$$GT$::fold_ty::hffa\n```\n\nWe seem to be hashing... a lot!\n", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/33594/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/33594/timeline", "performed_via_github_app": null, "state_reason": "completed"}