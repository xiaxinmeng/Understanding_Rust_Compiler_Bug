{"url": "https://api.github.com/repos/rust-lang/rust/issues/38032", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/38032/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/38032/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/38032/events", "html_url": "https://github.com/rust-lang/rust/issues/38032", "id": 191873474, "node_id": "MDU6SXNzdWUxOTE4NzM0NzQ=", "number": 38032, "title": "Bad code generated when returning `Option<[u8; 8]>`", "user": {"login": "bluss", "id": 3209739, "node_id": "MDQ6VXNlcjMyMDk3Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bluss", "html_url": "https://github.com/bluss", "followers_url": "https://api.github.com/users/bluss/followers", "following_url": "https://api.github.com/users/bluss/following{/other_user}", "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}", "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bluss/subscriptions", "organizations_url": "https://api.github.com/users/bluss/orgs", "repos_url": "https://api.github.com/users/bluss/repos", "events_url": "https://api.github.com/users/bluss/events{/privacy}", "received_events_url": "https://api.github.com/users/bluss/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2016-11-27T17:29:17Z", "updated_at": "2017-02-13T23:32:14Z", "closed_at": "2017-02-13T23:32:14Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "The following function generates a lot of code even when optimized. [(playground link)](https://play.rust-lang.org/?gist=d97228032971336a710a0279ac67e7bb&version=nightly&backtrace=1)\r\n\r\nExpected result: Better code.\r\n\r\n```rust\r\npub fn u64_to_u8(number: u64) -> Option<[u8; 8]> {\r\n    Some(unsafe { std::ptr::read(&number as *const u64 as *const [u8; 8]) })\r\n}\r\n```\r\n\r\n```llvm\r\n; Function Attrs: nounwind uwtable\r\ndefine void @_ZN8rust_out9u64_to_u817hb41c7f933efd518fE(%\"core::option::Option<[u8; 8]>\"* noalias nocapture sret dereferenceable(9), i64) unnamed_addr #0 personality i32 (i32, i32, i64, %\"unwind::libunwind::_Unwind_Exception\"*, %\"unwind::libunwind::_Unwind_Context\"*)* @rust_eh_personality {\r\nentry-block:\r\n  %_3.sroa.0.0.extract.trunc = trunc i64 %1 to i8\r\n  %_3.sroa.4.0.extract.shift = lshr i64 %1, 8\r\n  %_3.sroa.4.0.extract.trunc = trunc i64 %_3.sroa.4.0.extract.shift to i8\r\n  %_3.sroa.5.0.extract.shift = lshr i64 %1, 16\r\n  %_3.sroa.5.0.extract.trunc = trunc i64 %_3.sroa.5.0.extract.shift to i8\r\n  %_3.sroa.6.0.extract.shift = lshr i64 %1, 24\r\n  %_3.sroa.6.0.extract.trunc = trunc i64 %_3.sroa.6.0.extract.shift to i8\r\n  %_3.sroa.7.0.extract.shift = lshr i64 %1, 32\r\n  %_3.sroa.7.0.extract.trunc = trunc i64 %_3.sroa.7.0.extract.shift to i8\r\n  %_3.sroa.8.0.extract.shift = lshr i64 %1, 40\r\n  %_3.sroa.8.0.extract.trunc = trunc i64 %_3.sroa.8.0.extract.shift to i8\r\n  %_3.sroa.9.0.extract.shift = lshr i64 %1, 48\r\n  %_3.sroa.9.0.extract.trunc = trunc i64 %_3.sroa.9.0.extract.shift to i8\r\n  %_3.sroa.10.0.extract.shift = lshr i64 %1, 56\r\n  %_3.sroa.10.0.extract.trunc = trunc i64 %_3.sroa.10.0.extract.shift to i8\r\n  %2 = getelementptr inbounds %\"core::option::Option<[u8; 8]>\", %\"core::option::Option<[u8; 8]>\"* %0, i64 0, i32 0\r\n  store i8 1, i8* %2, align 1\r\n  %.repack = getelementptr inbounds %\"core::option::Option<[u8; 8]>\", %\"core::option::Option<[u8; 8]>\"* %0, i64 0, i32 2, i64 0\r\n  store i8 %_3.sroa.0.0.extract.trunc, i8* %.repack, align 1\r\n  %.repack3 = getelementptr inbounds %\"core::option::Option<[u8; 8]>\", %\"core::option::Option<[u8; 8]>\"* %0, i64 0, i32 2, i64 1\r\n  store i8 %_3.sroa.4.0.extract.trunc, i8* %.repack3, align 1\r\n  %.repack5 = getelementptr inbounds %\"core::option::Option<[u8; 8]>\", %\"core::option::Option<[u8; 8]>\"* %0, i64 0, i32 2, i64 2\r\n  store i8 %_3.sroa.5.0.extract.trunc, i8* %.repack5, align 1\r\n  %.repack7 = getelementptr inbounds %\"core::option::Option<[u8; 8]>\", %\"core::option::Option<[u8; 8]>\"* %0, i64 0, i32 2, i64 3\r\n  store i8 %_3.sroa.6.0.extract.trunc, i8* %.repack7, align 1\r\n  %.repack9 = getelementptr inbounds %\"core::option::Option<[u8; 8]>\", %\"core::option::Option<[u8; 8]>\"* %0, i64 0, i32 2, i64 4\r\n  store i8 %_3.sroa.7.0.extract.trunc, i8* %.repack9, align 1\r\n  %.repack11 = getelementptr inbounds %\"core::option::Option<[u8; 8]>\", %\"core::option::Option<[u8; 8]>\"* %0, i64 0, i32 2, i64 5\r\n  store i8 %_3.sroa.8.0.extract.trunc, i8* %.repack11, align 1\r\n  %.repack13 = getelementptr inbounds %\"core::option::Option<[u8; 8]>\", %\"core::option::Option<[u8; 8]>\"* %0, i64 0, i32 2, i64 6\r\n  store i8 %_3.sroa.9.0.extract.trunc, i8* %.repack13, align 1\r\n  %.repack15 = getelementptr inbounds %\"core::option::Option<[u8; 8]>\", %\"core::option::Option<[u8; 8]>\"* %0, i64 0, i32 2, i64 7\r\n  store i8 %_3.sroa.10.0.extract.trunc, i8* %.repack15, align 1\r\n  ret void\r\n}\r\n```\r\n\r\nversion: `rustc 1.15.0-nightly (d9bdc636d 2016-11-24)`", "closed_by": {"login": "bluss", "id": 3209739, "node_id": "MDQ6VXNlcjMyMDk3Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bluss", "html_url": "https://github.com/bluss", "followers_url": "https://api.github.com/users/bluss/followers", "following_url": "https://api.github.com/users/bluss/following{/other_user}", "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}", "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bluss/subscriptions", "organizations_url": "https://api.github.com/users/bluss/orgs", "repos_url": "https://api.github.com/users/bluss/repos", "events_url": "https://api.github.com/users/bluss/events{/privacy}", "received_events_url": "https://api.github.com/users/bluss/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/38032/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/38032/timeline", "performed_via_github_app": null, "state_reason": "completed"}