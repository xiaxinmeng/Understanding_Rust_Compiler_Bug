{"url": "https://api.github.com/repos/rust-lang/rust/issues/74513", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/74513/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/74513/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/74513/events", "html_url": "https://github.com/rust-lang/rust/issues/74513", "id": 660825179, "node_id": "MDU6SXNzdWU2NjA4MjUxNzk=", "number": 74513, "title": "LLVM codegen backend error in stable embedded Rust project", "user": {"login": "luojia65", "id": 40385009, "node_id": "MDQ6VXNlcjQwMzg1MDA5", "avatar_url": "https://avatars.githubusercontent.com/u/40385009?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luojia65", "html_url": "https://github.com/luojia65", "followers_url": "https://api.github.com/users/luojia65/followers", "following_url": "https://api.github.com/users/luojia65/following{/other_user}", "gists_url": "https://api.github.com/users/luojia65/gists{/gist_id}", "starred_url": "https://api.github.com/users/luojia65/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luojia65/subscriptions", "organizations_url": "https://api.github.com/users/luojia65/orgs", "repos_url": "https://api.github.com/users/luojia65/repos", "events_url": "https://api.github.com/users/luojia65/events{/privacy}", "received_events_url": "https://api.github.com/users/luojia65/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2020-07-19T13:03:36Z", "updated_at": "2021-11-09T05:30:35Z", "closed_at": "2021-11-09T05:30:35Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for finding an Internal Compiler Error! \ud83e\uddca  If possible, try to provide\r\na minimal verifiable example. You can read \"Rust Bug Minimization Patterns\" for\r\nhow to create smaller examples.\r\n\r\nhttp://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/\r\n\r\n-->\r\n\r\n### Code\r\n\r\nI don't know exactly where, but somewhere in my embedded Rust code resulted in compile error. The compiler is stable Rust 1.45.0.\r\n\r\nI cannot reproduce if I take a part of the source code, maybe I need further help to get a minimum ICE example.\r\n\r\nHere's the file:\r\n\r\n[gd32v-workspace.zip](https://github.com/rust-lang/rust/files/4943729/gd32v-workspace.zip)\r\n\r\nDownload this file, decompress and execute:\r\n\r\n```\r\ncd gd32vf103-example\r\ncargo build --example vf103c-start-backup-data\r\n```\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.45.0 (5c1f21c3b 2020-07-13)\r\nbinary: rustc\r\ncommit-hash: 5c1f21c3b82297671ad3ae1e8c942d2ca92e84f2\r\ncommit-date: 2020-07-13\r\nhost: x86_64-apple-darwin\r\nrelease: 1.45.0\r\nLLVM version: 10.0\r\n```\r\n\r\n### Error output\r\n\r\n<!--\r\nInclude a backtrace in the code block by setting `RUST_BACKTRACE=1` in your\r\nenvironment. E.g. `RUST_BACKTRACE=1 cargo build`.\r\n-->\r\n<details><summary><strong>Backtrace</strong></summary>\r\n<p>\r\n\r\n```\r\n\u276f RUST_BACKTRACE=full cargo build --example vf103c-start-backup-data --verbose\r\n       Fresh lazy_static v1.4.0\r\n       Fresh regex-syntax v0.6.18\r\n       Fresh semver-parser v0.7.0\r\n       Fresh unicode-xid v0.1.0\r\n       Fresh bit_field v0.10.0\r\n       Fresh rand_core v0.4.2\r\n       Fresh vcell v0.1.2\r\n       Fresh nb v1.0.0\r\n       Fresh r0 v1.0.0\r\n       Fresh nb v0.1.2\r\n       Fresh panic-halt v0.2.0\r\n       Fresh thread_local v1.0.1\r\n       Fresh semver v0.9.0\r\n       Fresh rand_core v0.3.1\r\n       Fresh embedded-hal v1.0.0-alpha.1 (https://github.com/rust-embedded/embedded-hal#83f5beac)\r\n       Fresh memchr v2.3.3\r\n       Fresh rustc_version v0.2.3\r\n       Fresh proc-macro2 v0.4.30\r\n       Fresh rand v0.5.6\r\n       Fresh aho-corasick v0.7.10\r\n       Fresh quote v0.6.13\r\n       Fresh regex v1.3.9\r\n       Fresh syn v0.15.44\r\n       Fresh riscv-target v0.1.2\r\n       Fresh bare-metal v0.2.5\r\n       Fresh riscv-rt-macros v0.1.6\r\n       Fresh riscv v0.6.0\r\n       Fresh gd32vf103-pac v0.3.1 (/Users/mac/2020/RustProjects/gd32v-workspace/gd32vf103-pac)\r\n       Fresh riscv-rt v0.8.0\r\nwarning: lint `legacy_directory_ownership` has been removed: `converted into hard error, see issue #37872 <https://github.com/rust-lang/rust/issues/37872> for more information`\r\n --> gd32vf103-pac/src/lib.rs:5:9\r\n  |\r\n5 | #![deny(legacy_directory_ownership)]\r\n  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  |\r\n  = note: `#[warn(renamed_and_removed_lints)]` on by default\r\n\r\nwarning: lint `plugin_as_library` has been removed: `plugins have been deprecated and retired`\r\n  --> gd32vf103-pac/src/lib.rs:12:9\r\n   |\r\n12 | #![deny(plugin_as_library)]\r\n   |         ^^^^^^^^^^^^^^^^^\r\n\r\nwarning: lint `safe_extern_statics` has been removed: `converted into hard error, see issue #36247 <https://github.com/rust-lang/rust/issues/36247> for more information`\r\n  --> gd32vf103-pac/src/lib.rs:14:9\r\n   |\r\n14 | #![deny(safe_extern_statics)]\r\n   |         ^^^^^^^^^^^^^^^^^^^\r\n\r\nwarning: unknown lint: `unions_with_drop_fields`\r\n  --> gd32vf103-pac/src/lib.rs:16:9\r\n   |\r\n16 | #![deny(unions_with_drop_fields)]\r\n   |         ^^^^^^^^^^^^^^^^^^^^^^^\r\n   |\r\n   = note: `#[warn(unknown_lints)]` on by default\r\n\r\nwarning: 4 warnings emitted\r\n\r\n   Compiling gd32vf103-hal v0.0.5 (/Users/mac/2020/RustProjects/gd32v-workspace/gd32vf103-hal)\r\n     Running `rustc --crate-name gd32vf103_hal --edition=2018 gd32vf103-hal/src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts --crate-type lib --emit=dep-info,metadata,link -Cembed-bitcode=no -C debuginfo=2 -C metadata=7d55167f0e15211b -C extra-filename=-7d55167f0e15211b --out-dir /Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps --target riscv32imac-unknown-none-elf -C incremental=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/incremental -L dependency=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps -L dependency=/Users/mac/2020/RustProjects/gd32v-workspace/target/debug/deps --extern embedded_hal=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps/libembedded_hal-019224d84e9de5c8.rmeta --extern gd32vf103_pac=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps/libgd32vf103_pac-8dcf5f32b20d82e4.rmeta --extern nb=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps/libnb-7b5a980be221e162.rmeta --extern riscv=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps/libriscv-af815419a3534480.rmeta -C link-arg=-Tlink.x -C link-arg=-Tmemory.x -L /Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/build/gd32vf103-hal-84316d11b058d843/out -l static=gd32vf103-hal -L /Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/build/riscv-e1760fc6a9873660/out`\r\nwarning: unused import: `bkp`\r\n --> gd32vf103-hal/src/backup.rs:3:18\r\n  |\r\n3 | use crate::pac::{bkp, BKP, PMU};\r\n  |                  ^^^\r\n  |\r\n  = note: `#[warn(unused_imports)]` on by default\r\n\r\nwarning: associated function is never used: `cfg1`\r\n   --> gd32vf103-hal/src/rcu.rs:127:19\r\n    |\r\n127 |     pub(crate) fn cfg1(&mut self) -> &rcu::CFG1 {\r\n    |                   ^^^^\r\n    |\r\n    = note: `#[warn(dead_code)]` on by default\r\n\r\nwarning: associated function is never used: `bdctl`\r\n   --> gd32vf103-hal/src/rcu.rs:510:19\r\n    |\r\n510 |     pub(crate) fn bdctl(&mut self) -> &rcu::BDCTL {\r\n    |                   ^^^^^\r\n\r\nwarning: field is never read: `state`\r\n  --> gd32vf103-hal/src/wdog.rs:44:5\r\n   |\r\n44 |     state: STATE,\r\n   |     ^^^^^^^^^^^^\r\n\r\nwarning: field is never read: `wwdgt`\r\n   --> gd32vf103-hal/src/wdog.rs:190:5\r\n    |\r\n190 |     wwdgt: WWDGT,\r\n    |     ^^^^^^^^^^^^\r\n\r\n   Compiling gd32vf103-hal-example v0.1.0 (/Users/mac/2020/RustProjects/gd32v-workspace/gd32vf103-example)\r\n     Running `rustc --crate-name gd32vf103_hal_example --edition=2018 gd32vf103-example/src/lib.rs --error-format=json --json=diagnostic-rendered-ansi --crate-type lib --emit=dep-info,metadata,link -Cembed-bitcode=no -C debuginfo=2 -C metadata=776c25045ed9234f -C extra-filename=-776c25045ed9234f --out-dir /Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps --target riscv32imac-unknown-none-elf -C incremental=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/incremental -L dependency=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps -L dependency=/Users/mac/2020/RustProjects/gd32v-workspace/target/debug/deps --extern gd32vf103_hal=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps/libgd32vf103_hal-7d55167f0e15211b.rmeta --extern nb=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps/libnb-053dad82f20964c3.rmeta --extern panic_halt=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps/libpanic_halt-c20813a18ecd9008.rmeta --extern riscv_rt=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps/libriscv_rt-78f019e90760d0fe.rmeta -C link-arg=-Tlink.x -C link-arg=-Tmemory.x -L /Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/build/gd32vf103-hal-example-c7768ee9e23700f1/out -L /Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/build/gd32vf103-hal-84316d11b058d843/out -L /Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/build/riscv-e1760fc6a9873660/out -L /Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/build/riscv-rt-45d4352344ed4955/out -L /Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/build/riscv-rt-45d4352344ed4955/out`\r\nthread 'rustc' panicked at 'called `Option::unwrap()` on a `None` value', src/librustc_codegen_llvm/back/archive.rs:274:33\r\nstack backtrace:\r\n   0:        0x10fb22dbe - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::he3a6eecb2201efb0\r\n   1:        0x10fb5c51c - core::fmt::write::h8ef98027ac1df1be\r\n   2:        0x10fb14897 - std::io::Write::write_fmt::hed52d76b85d70756\r\n   3:        0x10fb278f5 - std::panicking::default_hook::{{closure}}::h013242fa408d10b7\r\n   4:        0x10fb27632 - std::panicking::default_hook::h9777ceea989331ac\r\n   5:        0x11417d2b8 - rustc_driver::report_ice::h3b4ef3e9c85f0bd8\r\n   6:        0x10fb27f45 - std::panicking::rust_panic_with_hook::h845f7f3fcb3a3323\r\n   7:        0x10fb27af2 - rust_begin_unwind\r\n   8:        0x10fb7f87f - core::panicking::panic_fmt::h60d70f2d73364aac\r\n   9:        0x10fb7f7d7 - core::panicking::panic::h3582cc3308948195\r\n  10:        0x1144475b3 - <rustc_codegen_llvm::back::archive::LlvmArchiveBuilder as rustc_codegen_ssa::back::archive::ArchiveBuilder>::build::h4aad89d60bdd3c09\r\n  11:        0x1144bd564 - rustc_codegen_ssa::back::link::link_binary::hd1bf01b56348ffb1\r\n  12:        0x11457730f - rustc_session::utils::<impl rustc_session::session::Session>::time::h0f9de8a99a521001\r\n  13:        0x1144e271b - <rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_ssa::traits::backend::CodegenBackend>::link::h193ab3317bc5ddb9\r\n  14:        0x1142e7d94 - rustc_interface::queries::Linker::link::hb730e2c76eb5ddbe\r\n  15:        0x1141451f7 - rustc_interface::interface::run_compiler_in_existing_thread_pool::h18c835dfaf7b6d80\r\n  16:        0x11418b635 - rustc_ast::attr::with_globals::h3bd9a4b2c3edf3dd\r\n  17:        0x11418fe71 - std::sys_common::backtrace::__rust_begin_short_backtrace::hb809cf68603b0e7f\r\n  18:        0x1141480ec - core::ops::function::FnOnce::call_once{{vtable.shim}}::ha95ea21f25d153e2\r\n  19:        0x10fb3611d - std::sys::unix::thread::Thread::new::thread_start::h0031c4f1bba2584f\r\n  20:     0x7fff6d962109 - _ZL12preoptimized\r\n\r\nerror: internal compiler error: unexpected panic\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\r\n\r\nnote: rustc 1.45.0 (5c1f21c3b 2020-07-13) running on x86_64-apple-darwin\r\n\r\nnote: compiler flags: -C embed-bitcode=no -C debuginfo=2 -C incremental -C link-arg=-Tlink.x -C link-arg=-Tmemory.x --crate-type lib\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n\r\nquery stack during panic:\r\nend of query stack\r\nwarning: 5 warnings emitted\r\n\r\nerror: could not compile `gd32vf103-hal`.\r\n\r\nCaused by:\r\n  process didn't exit successfully: `rustc --crate-name gd32vf103_hal --edition=2018 gd32vf103-hal/src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts --crate-type lib --emit=dep-info,metadata,link -Cembed-bitcode=no -C debuginfo=2 -C metadata=7d55167f0e15211b -C extra-filename=-7d55167f0e15211b --out-dir /Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps --target riscv32imac-unknown-none-elf -C incremental=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/incremental -L dependency=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps -L dependency=/Users/mac/2020/RustProjects/gd32v-workspace/target/debug/deps --extern embedded_hal=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps/libembedded_hal-019224d84e9de5c8.rmeta --extern gd32vf103_pac=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps/libgd32vf103_pac-8dcf5f32b20d82e4.rmeta --extern nb=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps/libnb-7b5a980be221e162.rmeta --extern riscv=/Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/deps/libriscv-af815419a3534480.rmeta -C link-arg=-Tlink.x -C link-arg=-Tmemory.x -L /Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/build/gd32vf103-hal-84316d11b058d843/out -l static=gd32vf103-hal -L /Users/mac/2020/RustProjects/gd32v-workspace/target/riscv32imac-unknown-none-elf/debug/build/riscv-e1760fc6a9873660/out` (exit code: 101)\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n", "closed_by": {"login": "luojia65", "id": 40385009, "node_id": "MDQ6VXNlcjQwMzg1MDA5", "avatar_url": "https://avatars.githubusercontent.com/u/40385009?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luojia65", "html_url": "https://github.com/luojia65", "followers_url": "https://api.github.com/users/luojia65/followers", "following_url": "https://api.github.com/users/luojia65/following{/other_user}", "gists_url": "https://api.github.com/users/luojia65/gists{/gist_id}", "starred_url": "https://api.github.com/users/luojia65/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luojia65/subscriptions", "organizations_url": "https://api.github.com/users/luojia65/orgs", "repos_url": "https://api.github.com/users/luojia65/repos", "events_url": "https://api.github.com/users/luojia65/events{/privacy}", "received_events_url": "https://api.github.com/users/luojia65/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/74513/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/74513/timeline", "performed_via_github_app": null, "state_reason": "completed"}