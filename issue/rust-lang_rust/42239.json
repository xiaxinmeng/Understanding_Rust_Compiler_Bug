{"url": "https://api.github.com/repos/rust-lang/rust/issues/42239", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/42239/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/42239/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/42239/events", "html_url": "https://github.com/rust-lang/rust/issues/42239", "id": 231589015, "node_id": "MDU6SXNzdWUyMzE1ODkwMTU=", "number": 42239, "title": "Mips (big endian) gives \"undefined reference to `std::rt::lang_start'\"", "user": {"login": "jcowgill", "id": 1226825, "node_id": "MDQ6VXNlcjEyMjY4MjU=", "avatar_url": "https://avatars.githubusercontent.com/u/1226825?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jcowgill", "html_url": "https://github.com/jcowgill", "followers_url": "https://api.github.com/users/jcowgill/followers", "following_url": "https://api.github.com/users/jcowgill/following{/other_user}", "gists_url": "https://api.github.com/users/jcowgill/gists{/gist_id}", "starred_url": "https://api.github.com/users/jcowgill/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jcowgill/subscriptions", "organizations_url": "https://api.github.com/users/jcowgill/orgs", "repos_url": "https://api.github.com/users/jcowgill/repos", "events_url": "https://api.github.com/users/jcowgill/events{/privacy}", "received_events_url": "https://api.github.com/users/jcowgill/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2017-05-26T10:35:49Z", "updated_at": "2017-06-03T01:09:26Z", "closed_at": "2017-06-03T01:09:26Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Attempting to compile this example program `foo.rs` using a nightly compiler:\r\n```rust\r\nfn main() {}\r\n```\r\n\r\nOn a native mips big endian machine gives me this:\r\n```\r\nerror: linking with `cc` failed: exit code: 1\r\n  |\r\n  = note: \"cc\" \"-Wl,--as-needed\" \"-Wl,-z,noexecstack\" \"-L\" \"/usr/local/lib/rustlib/mips-unknown-linux-gnu/lib\" \"foo.0.o\" \"-o\" \"foo\" \"-Wl,--gc-sections\" \"-pie\" \"-nodefaultlibs\" \"-L\" \"/usr/local/lib/rustlib/mips-unknown-linux-gnu/lib\" \"-Wl,-Bstatic\" \"/usr/local/lib/rustlib/mips-unknown-linux-gnu/lib/libstd-8bd0331885bb8f82.rlib\" \"/usr/local/lib/rustlib/mips-unknown-linux-gnu/lib/librand-c59b047c329fc869.rlib\" \"/usr/local/lib/rustlib/mips-unknown-linux-gnu/lib/libpanic_unwind-8b5a5d5d9b47b90e.rlib\" \"/usr/local/lib/rustlib/mips-unknown-linux-gnu/lib/libcollections-940fff481f9db1f7.rlib\" \"/usr/local/lib/rustlib/mips-unknown-linux-gnu/lib/liballoc-00bc69f25a7886ed.rlib\" \"/usr/local/lib/rustlib/mips-unknown-linux-gnu/lib/liballoc_system-8a70e0fa55025ef9.rlib\" \"/usr/local/lib/rustlib/mips-unknown-linux-gnu/lib/libunwind-6f736b1bf227d828.rlib\" \"/usr/local/lib/rustlib/mips-unknown-linux-gnu/lib/liblibc-0d4b94d34314ddab.rlib\" \"/usr/local/lib/rustlib/mips-unknown-linux-gnu/lib/libstd_unicode-27c6703fdb4bd5ba.rlib\" \"/usr/local/lib/rustlib/mips-unknown-linux-gnu/lib/libcore-f7c6aa272ea55579.rlib\" \"/usr/local/lib/rustlib/mips-unknown-linux-gnu/lib/libcompiler_builtins-93f6c14c48cd2162.rlib\" \"-Wl,-Bdynamic\" \"-l\" \"dl\" \"-l\" \"rt\" \"-l\" \"pthread\" \"-l\" \"gcc_s\" \"-l\" \"c\" \"-l\" \"m\" \"-l\" \"rt\" \"-l\" \"pthread\" \"-l\" \"util\"\r\n  = note: foo.0.o: In function `main':\r\n          foo.cgu-0.rs:(.text.main+0x34): undefined reference to `std::rt::lang_start'\r\n          collect2: error: ld returned 1 exit status\r\n\r\n\r\nerror: aborting due to previous error(s)\r\n```\r\n\r\nIf I compile `foo.rs` to an object and dump the symbols, I see that the hash for `lang_start` is different between the object and the rlib file:\r\n```\r\n$ objdump -t foo.o | grep lang_start\r\n00000000         *UND*  00000000 _ZN3std2rt10lang_start17h826655afc17b8ea3E\r\n\r\n$ objdump -t /usr/local/lib/rustlib/mips-unknown-linux-gnu/lib/libstd-8bd0331885bb8f82.rlib | grep lang_start\r\n00000000 l    d  .text._ZN3std2rt10lang_start17h5492aeb665e2d414E       00000000 .text._ZN3std2rt10lang_start17h5492aeb665e2d414E\r\n00000000 g     F .text._ZN3std2rt10lang_start17h5492aeb665e2d414E       00000aec _ZN3std2rt10lang_start17h5492aeb665e2d414E\r\n```\r\n\r\nAfter some debugging, I managed to work out that the value of `tcx.def_path_hash(def_id)` for `lang_start` passed to the `TypeIdHasher` in `rustc_trans::back::symbol_names::get_symbol_hash` is byteswapped when run natively compared to running on an x86 -> mips cross compiler. I couldn't work out where this value originally comes from, but hopefully someone here knows. :)\r\n\r\nI also tried using a stable compiler, but it failed with the issue #41471 before getting to this stage.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/42239/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/42239/timeline", "performed_via_github_app": null, "state_reason": "completed"}