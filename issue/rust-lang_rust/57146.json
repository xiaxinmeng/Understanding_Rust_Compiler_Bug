{"url": "https://api.github.com/repos/rust-lang/rust/issues/57146", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/57146/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/57146/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/57146/events", "html_url": "https://github.com/rust-lang/rust/issues/57146", "id": 394390247, "node_id": "MDU6SXNzdWUzOTQzOTAyNDc=", "number": 57146, "title": "invalid \"cannot return value referencing local variable\" in current nightly", "user": {"login": "xMAC94x", "id": 5282251, "node_id": "MDQ6VXNlcjUyODIyNTE=", "avatar_url": "https://avatars.githubusercontent.com/u/5282251?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xMAC94x", "html_url": "https://github.com/xMAC94x", "followers_url": "https://api.github.com/users/xMAC94x/followers", "following_url": "https://api.github.com/users/xMAC94x/following{/other_user}", "gists_url": "https://api.github.com/users/xMAC94x/gists{/gist_id}", "starred_url": "https://api.github.com/users/xMAC94x/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xMAC94x/subscriptions", "organizations_url": "https://api.github.com/users/xMAC94x/orgs", "repos_url": "https://api.github.com/users/xMAC94x/repos", "events_url": "https://api.github.com/users/xMAC94x/events{/privacy}", "received_events_url": "https://api.github.com/users/xMAC94x/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 171502053, "node_id": "MDU6TGFiZWwxNzE1MDIwNTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-borrow-checker", "name": "A-borrow-checker", "color": "f7e101", "default": false, "description": "Area: The borrow checker"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2018-12-27T13:06:40Z", "updated_at": "2019-12-25T15:48:05Z", "closed_at": "2019-12-25T15:48:05Z", "author_association": "NONE", "active_lock_reason": null, "body": "while compiling, rust throws an error \"cannot return value referencing local variable\" which is invalid in my opinion. It did not do this in `nightly of Dec02 2018`, but in current nightly it does.\r\n\r\nI tried this code:\r\n\r\nI compiled the veloren source code located at gitlab: https://gitlab.com/veloren/game (note: recently rust changes div_euc to div_euclid and mod_euc to rem_euclid, you have to adjust it before the bug will show up.)\r\nThe important part is this function:\r\n```rust\r\n    pub fn get_sample(&self, from: Vec3<VoxAbs>, to: Vec3<VoxAbs>) -> Result<ChunkSample, ChunkSampleError> {\r\n        let mut map = HashMap::new();\r\n        let chunk_from = terrain::voxabs_to_voloffs(from, self.vol_size);\r\n        let chunk_to = terrain::voxabs_to_voloffs(to, self.vol_size);\r\n        let lock = self.pers.read();\r\n        for x in chunk_from.x..chunk_to.x + 1 {\r\n            for y in chunk_from.y..chunk_to.y + 1 {\r\n                for z in chunk_from.z..chunk_to.z + 1 {\r\n                    let key = Vec3::new(x, y, z);\r\n                    let cc = lock.get(&key).map(|v| v.clone());\r\n                    if let Some(cc) = cc {\r\n                        if cc\r\n                            .data_try()\r\n                            .take()\r\n                            .map(|value| map.insert(key, Arc::new(value)))\r\n                            .is_none()\r\n                        {\r\n                            debug!(\"Cannot get lock: {}\", &key);\r\n                            return Err(ChunkSampleError::CannotGetLock { key });\r\n                        }\r\n                        let _ = map.get(&key).unwrap();\r\n                    } else {\r\n                        debug!(\"Chunk does not exist: {}\", &key);\r\n                        return Err(ChunkSampleError::ChunkMissing { key });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        Ok(ChunkSample::new_internal(self.vol_size, from, to, map))\r\n    }\r\n```\r\nThe function tries to aquire multiple locks, and if all locks are aquired it will return them, otherwise it will fail.\r\nThe last line, where we return OK(...) is borrowing from \"if cc\". my guess is, that the borrowing is detected via the map.insert inside the if. however key is newly created before and the Arc is also new created. This is why in my opinion the error is invalid.\r\n\r\n\r\nI expected to see this happen: \"compilation successfull\"\r\n\r\nInstead, this happened: \r\n```rust\r\nerror[E0515]: cannot return value referencing local variable `cc`\r\n   --> common/src/terrain/chunk_mgr.rs:126:9\r\n    |\r\n109 |                         if cc\r\n    |                            -- `cc` is borrowed here\r\n...\r\n126 |         Ok(ChunkSample::new_internal(self.vol_size, from, to, map))\r\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ returns a value referencing data owned by the current function\r\n\r\nerror: aborting due to previous error\r\n\r\nFor more information about this error, try `rustc --explain E0515`.\r\nerror: Could not compile `common`.\r\nwarning: build failed, waiting for other jobs to finish...\r\nerror: build failed\r\n```\r\n\r\n\r\n## Meta\r\n\r\nThe error is reproducible on multiple computers from me, and other people had the same problem. i think mostly linux-64bit.\r\nnightly `2018-12-02` compiles this code fine without any problems\r\n\r\n`rustc --version --verbose`:\r\n```bash\r\nrustc 1.33.0-nightly (a7be40c65 2018-12-26)\r\nbinary: rustc\r\ncommit-hash: a7be40c65ae8ace467c9c40b0a22642973e31a13\r\ncommit-date: 2018-12-26\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.33.0-nightly\r\nLLVM version: 8.0\r\n```\r\n\r\nBacktrace:\r\n\r\n", "closed_by": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/57146/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/57146/timeline", "performed_via_github_app": null, "state_reason": "completed"}