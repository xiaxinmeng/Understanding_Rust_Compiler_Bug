{"url": "https://api.github.com/repos/rust-lang/rust/issues/87643", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/87643/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/87643/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/87643/events", "html_url": "https://github.com/rust-lang/rust/issues/87643", "id": 957023677, "node_id": "MDU6SXNzdWU5NTcwMjM2Nzc=", "number": 87643, "title": "WASM float to int performance regression since 1.53.0", "user": {"login": "CryZe", "id": 1451630, "node_id": "MDQ6VXNlcjE0NTE2MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1451630?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CryZe", "html_url": "https://github.com/CryZe", "followers_url": "https://api.github.com/users/CryZe/followers", "following_url": "https://api.github.com/users/CryZe/following{/other_user}", "gists_url": "https://api.github.com/users/CryZe/gists{/gist_id}", "starred_url": "https://api.github.com/users/CryZe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CryZe/subscriptions", "organizations_url": "https://api.github.com/users/CryZe/orgs", "repos_url": "https://api.github.com/users/CryZe/repos", "events_url": "https://api.github.com/users/CryZe/events{/privacy}", "received_events_url": "https://api.github.com/users/CryZe/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 474645165, "node_id": "MDU6TGFiZWw0NzQ2NDUxNjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-wasm", "name": "O-wasm", "color": "6e6ec0", "default": false, "description": "Target: WASM (WebAssembly), http://webassembly.org/"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2021-07-30T19:57:10Z", "updated_at": "2021-12-17T06:34:45Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Both Rust and WASM introduced saturating float to int casts. However WASM originally only had trapping float to int casts. LLVMs internal float casts are speculatable, i.e. it can execute them early, assuming no trap ever happens. This however means LLVM needs to protect itself from WASM's trapping casts by emitting some more code around it. Once Rust introduced saturating float to int casts, rustc itself started emitting a bunch of code around the casts to saturate the values. This then led to both rustc and LLVM emitting this guard code around each cast. However since rustc already protected itself some dangerous values, LLVM didn't need to emit any of these additional instructions. This was eventually implemented. Check this previous issues and related PRs: https://github.com/rust-lang/rust/issues/73591\r\n\r\nHowever with the switch to LLVM 12, it was possible to throw out a lot of the manual codegen in rustc:\r\nhttps://github.com/rust-lang/rust/pull/84339 which acknowledges a regression in those casts\r\n\r\nand then a follow up PR:\r\nhttps://github.com/rust-lang/rust/pull/84654 which supposedly fixes the regression\r\n\r\nHowever it seems like there's still a regression: https://rust.godbolt.org/z/W18vGcv9T\r\n\r\ncc @alexcrichton ", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/87643/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/87643/timeline", "performed_via_github_app": null, "state_reason": null}