{"url": "https://api.github.com/repos/rust-lang/rust/issues/110551", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/110551/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/110551/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/110551/events", "html_url": "https://github.com/rust-lang/rust/issues/110551", "id": 1675297721, "node_id": "I_kwDOAAsO6M5j2wO5", "number": 110551, "title": "Codegen regression involving `assume`/`unreachable_unchecked`", "user": {"login": "WaffleLapkin", "id": 38225716, "node_id": "MDQ6VXNlcjM4MjI1NzE2", "avatar_url": "https://avatars.githubusercontent.com/u/38225716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/WaffleLapkin", "html_url": "https://github.com/WaffleLapkin", "followers_url": "https://api.github.com/users/WaffleLapkin/followers", "following_url": "https://api.github.com/users/WaffleLapkin/following{/other_user}", "gists_url": "https://api.github.com/users/WaffleLapkin/gists{/gist_id}", "starred_url": "https://api.github.com/users/WaffleLapkin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/WaffleLapkin/subscriptions", "organizations_url": "https://api.github.com/users/WaffleLapkin/orgs", "repos_url": "https://api.github.com/users/WaffleLapkin/repos", "events_url": "https://api.github.com/users/WaffleLapkin/events{/privacy}", "received_events_url": "https://api.github.com/users/WaffleLapkin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 147085028, "node_id": "MDU6TGFiZWwxNDcwODUwMjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-nightly", "name": "regression-from-stable-to-nightly", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to nightly."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 2019962432, "node_id": "MDU6TGFiZWwyMDE5OTYyNDMy", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-mir-opt-inlining", "name": "A-mir-opt-inlining", "color": "f7e101", "default": false, "description": "Area: MIR inlining"}], "state": "closed", "locked": false, "assignee": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 6, "created_at": "2023-04-19T17:05:42Z", "updated_at": "2023-04-21T17:28:34Z", "closed_at": "2023-04-21T17:28:34Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a regression report! \ud83d\udc1b A regression is something that changed between versions of Rust but was not supposed to.\r\n\r\nPlease provide a short summary of the regression, along with any information you feel is relevant to replicate it.\r\n-->\r\n\r\n### Code\r\n\r\nI tried this code:\r\n\r\n```rust\r\npub fn f(a: Option<u32>) -> u32 {\r\n    match a {\r\n        None => {}\r\n        Some(_) => unsafe { std::hint::unreachable_unchecked() }\r\n    }\r\n\r\n    a.unwrap()\r\n}\r\n```\r\n\r\nI expected to see this happen: no branch instructions emitted, `unreachable_unchecked` makes an assumption that `a` is `None`, so `unwrap` should be inlined and optimized as a panic.\r\n\r\nInstead, this happened: there is a discriminant check still emitted.\r\n\r\n### Version it worked on\r\n\r\n<!--\r\nProvide the most recent version this worked on, for example:\r\n\r\nIt most recently worked on: \r\n-->\r\n\r\nIt most recently worked on: nightly-2023-03-26\r\n\r\n### Version with regression\r\n\r\n<!--\r\nProvide the version you are using that has the regression.\r\n-->\r\n\r\n```\r\n; rustc +nightly-2023-03-27 --version --verbose\r\nrustc 1.70.0-nightly (db0cbc48d 2023-03-26)\r\nbinary: rustc\r\ncommit-hash: db0cbc48d4aaa300713a95d9b317a365a474490c\r\ncommit-date: 2023-03-26\r\nhost: aarch64-unknown-linux-gnu\r\nrelease: 1.70.0-nightly\r\nLLVM version: 16.0.0\r\n```\r\n\r\n## ASM diff\r\n\r\nSee godbolt: https://godbolt.org/z/5WKTY99Te\r\n\r\n## Bisection results\r\n\r\nRegression occurred in #106428 (cc @saethlin).\r\n\r\nsearched nightlies: from nightly-2023-03-01 to nightly-2023-04-01\r\nregressed nightly: nightly-2023-03-27\r\nsearched commit range: https://github.com/rust-lang/rust/compare/0c61c7a978fe9f7b77a1d667c77d2202dadd1c10...db0cbc48d4aaa300713a95d9b317a365a474490c\r\nregressed commit: https://github.com/rust-lang/rust/commit/2420bd34ba68a625840022de2a56aec228500359\r\n\r\n<details>\r\n<summary>bisected with <a href='https://github.com/rust-lang/cargo-bisect-rustc'>cargo-bisect-rustc</a> v0.6.6</summary>\r\n\r\n\r\nHost triple: aarch64-unknown-linux-gnu\r\nReproduce with:\r\n```bash\r\ncargo bisect-rustc --start=2023-03-01 --end=2023-04-01 --regress=success --script=./t.sh\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary>t.sh</summary>\r\n\r\n```bash\r\n#!/bin/sh\r\n\r\nset -ex\r\n\r\nrustc t.rs --crate-type=lib --emit=asm -O && cat ./t.s | grep -E \"cbz\\s+w0, .LBB0_2\"\r\n```\r\n\r\n(if you want to test on `x86_64` replace `\"cbz\\s+w0, .LBB0_2\"` with `\"testl\\s+%edi, %edi\"`)\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>t.rs</summary>\r\n\r\n\r\n```rust\r\npub fn f(a: Option<i32>) -> i32 {\r\n    unsafe { if !a.is_none() { std::hint::unreachable_unchecked() } }\r\n\r\n    return a.unwrap();\r\n}\r\n```\r\n\r\n</details>\r\n\r\n## History\r\n\r\n@heckad originally noticed the problem and opened #110456, then @WaffleLapkin suggested that this is a compiler issue, then @bugadani [noticed](https://github.com/rust-lang/rust/pull/110456#issuecomment-1512025633) that this is a regression, then @WaffleLapkin bisected and opened this issue.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/110551/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/110551/timeline", "performed_via_github_app": null, "state_reason": "completed"}