{"url": "https://api.github.com/repos/rust-lang/rust/issues/110071", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/110071/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/110071/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/110071/events", "html_url": "https://github.com/rust-lang/rust/issues/110071", "id": 1659357671, "node_id": "I_kwDOAAsO6M5i58nn", "number": 110071, "title": "bootstrap panic generating rustc docs while cross-compiling with `x.py dist`", "user": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 167285428, "node_id": "MDU6TGFiZWwxNjcyODU0Mjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-cross", "name": "A-cross", "color": "f7e101", "default": false, "description": "Area: Cross compilation"}, {"id": 325438536, "node_id": "MDU6TGFiZWwzMjU0Mzg1MzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-bootstrap", "name": "T-bootstrap", "color": "bfd4f2", "default": false, "description": "Relevant to the bootstrap subteam: Rust's build system (x.py and src/bootstrap)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2023-04-08T03:33:50Z", "updated_at": "2023-04-08T04:18:44Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "With `RUST_BACKTRACE=full  ./x.py dist --target riscv64gc-unknown-linux-musl --verbose` and the following `config.toml` file:\r\n\r\n```\r\nprofile = \"codegen\"\r\n\r\n[target.riscv64gc-unknown-linux-musl]\r\nar = \"riscv64-unknown-linux-musl-ar\"\r\nlinker = \"riscv64-unknown-linux-musl-gcc\"\r\ncc = \"riscv64-unknown-linux-musl-gcc\"\r\ncxx = \"riscv64-unknown-linux-musl-g++\"\r\nmusl-root = \"/home/tjc/riscv64-linux-musl-cross/riscv64-linux-musl\"\r\n```\r\nthe `rust-installer` command fails while installing docs because it can't find the target's `compiler-doc` directory. This makes sense because the `compiler-doc` directory is created in one of two places:\r\n\r\nhttps://github.com/rust-lang/rust/blob/master/src/bootstrap/doc.rs#L631\r\nhttps://github.com/rust-lang/rust/blob/master/src/bootstrap/doc.rs#L780\r\n\r\nand both of these are only invoked for the host (in the enclosing impls of each of those call sites,  `ONLY_HOSTS` is set to true).\r\n\r\nSo the problem is that the `dist::RustcDocs` step, which relies on the existence of the `compiler-doc` directory (see https://github.com/rust-lang/rust/blob/master/src/bootstrap/dist.rs#L150 ), is run for the target ( https://github.com/rust-lang/rust/blob/master/src/bootstrap/dist.rs#L140 ), but the steps that would create that directory have only been run for the host.\r\n\r\nI was able to fix this by adding `const ONLY_HOSTS: bool = true` inside the `impl Step for RustcDocs` ( https://github.com/rust-lang/rust/blob/master/src/bootstrap/dist.rs#L130 ), so that rustc docs aren't generated for the target. I'm not sure if that's the right solution, and in general I'm unsure about the logic for which pieces of documentation are generated for the host and which ones for the target under cross-compilation.\r\n\r\nThe end of the output, showing that `rust-installer` fails due to reading a nonexistent directory, is:\r\n\r\n```\r\nDist rust-docs-1.70.0-dev-riscv64gc-unknown-linux-musl\r\nrunning: LD_LIBRARY_PATH=\"/home/tjc/rust/build/x86_64-unknown-linux-gnu/stage0-bootstrap-tools/x86_64-unknown-linux-gnu/release/deps:/home/tjc/rust/build/x86_64-unknown-linux-gnu/stage0/lib:/home/tjc/WebKit/WebKitBuild/Debug/lib:/home/tjc/WebKit/WebKitBuild/GTK/Debug/lib:/home/tjc/WebKit/WebKitBuild/Debug/lib:/home/tjc/WebKit/WebKitBuild/GTK/Debug/lib:/home/tjc/WebKit/WebKitBuild/Debug/lib:/home/tjc/WebKit/WebKitBuild/GTK/Debug/lib:\" RUSTC=\"/home/tjc/rust/build/x86_64-unknown-linux-gnu/stage0/bin/rustc\" \"/home/tjc/rust/build/x86_64-unknown-linux-gnu/stage0-tools-bin/rust-installer\" \"generate\" \"--image-dir\" \"/home/tjc/rust/build/tmp/tarball/rust-docs/riscv64gc-unknown-linux-musl/image\" \"--component-name=rust-docs\" \"--bulk-dirs\" \"share/doc/rust/html\" \"--rel-manifest-dir=rustlib\" \"--legacy-manifest-dirs=rustlib,cargo\" \"--product-name=Rust Documentation\" \"--success-message=rust-docs installed.\" \"--package-name=rust-docs-1.70.0-dev-riscv64gc-unknown-linux-musl\" \"--non-installed-overlay\" \"/home/tjc/rust/build/tmp/tarball/rust-docs/riscv64gc-unknown-linux-musl/overlay\" \"--output-dir\" \"/home/tjc/rust/build/dist\" \"--work-dir\" \"/home/tjc/rust/build/tmp/tarball/rust-docs/riscv64gc-unknown-linux-musl\" \"--compression-profile\" \"fast\"\r\n\tfinished in 3.464 seconds\r\nthread 'main' panicked at 'could not read dir \"/home/tjc/rust/build/riscv64gc-unknown-linux-musl/compiler-doc\": Os { code: 2, kind: NotFound, message: \"No such file or directory\" }', lib.rs:1538:25\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/b955c8271da80a1af8a1d54c4e1bbdaf51b032e9/library/std/src/panicking.rs:579:5\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/b955c8271da80a1af8a1d54c4e1bbdaf51b032e9/library/core/src/panicking.rs:64:14\r\n   2: bootstrap::Build::read_dir\r\n             at ./src/bootstrap/lib.rs:1538:25\r\n   3: bootstrap::Build::cp_r\r\n             at ./src/bootstrap/lib.rs:1450:18\r\n   4: bootstrap::tarball::Tarball::add_dir\r\n             at ./src/bootstrap/tarball.rs:205:9\r\n   5: bootstrap::tarball::Tarball::add_bulk_dir\r\n             at ./src/bootstrap/tarball.rs:210:9\r\n   6: <bootstrap::dist::RustcDocs as bootstrap::builder::Step>::run\r\n             at ./src/bootstrap/dist.rs:150:9\r\n   7: bootstrap::builder::Builder::ensure\r\n             at ./src/bootstrap/builder.rs:2019:23\r\n   8: <bootstrap::dist::RustcDocs as bootstrap::builder::Step>::make_run\r\n             at ./src/bootstrap/dist.rs:140:9\r\n   9: bootstrap::builder::StepDescription::maybe_run\r\n             at ./src/bootstrap/builder.rs:301:13\r\n  10: bootstrap::builder::StepDescription::run\r\n             at ./src/bootstrap/builder.rs:338:21\r\n  11: bootstrap::builder::Builder::run_step_descriptions\r\n             at ./src/bootstrap/builder.rs:924:9\r\n  12: bootstrap::builder::Builder::execute_cli\r\n             at ./src/bootstrap/builder.rs:904:9\r\n  13: bootstrap::Build::build\r\n             at ./src/bootstrap/lib.rs:683:13\r\n  14: bootstrap::main\r\n             at ./src/bootstrap/bin/main.rs:58:5\r\n  15: core::ops::function::FnOnce::call_once\r\n             at /rustc/b955c8271da80a1af8a1d54c4e1bbdaf51b032e9/library/core/src/ops/function.rs:250:5\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\nTraceback (most recent call last):\r\n  File \"/home/tjc/rust/./x.py\", line 29, in <module>\r\n    bootstrap.main()\r\n  File \"/home/tjc/rust/src/bootstrap/bootstrap.py\", line 949, in main\r\n    bootstrap(args)\r\n  File \"/home/tjc/rust/src/bootstrap/bootstrap.py\", line 924, in bootstrap\r\n    run(args, env=env, verbose=build.verbose, is_bootstrap=True)\r\n  File \"/home/tjc/rust/src/bootstrap/bootstrap.py\", line 167, in run\r\n    raise RuntimeError(err)\r\nRuntimeError: failed to run: /home/tjc/rust/build/bootstrap/debug/bootstrap dist --target riscv64gc-unknown-linux-musl --verbose\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/110071/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/110071/timeline", "performed_via_github_app": null, "state_reason": null}