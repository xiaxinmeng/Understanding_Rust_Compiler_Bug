{"url": "https://api.github.com/repos/rust-lang/rust/issues/62496", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/62496/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/62496/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/62496/events", "html_url": "https://github.com/rust-lang/rust/issues/62496", "id": 465356184, "node_id": "MDU6SXNzdWU0NjUzNTYxODQ=", "number": 62496, "title": "install.sh miplaces codegen-backends directory with libdir = \"/lib/something\"", "user": {"login": "gyakovlev", "id": 168902, "node_id": "MDQ6VXNlcjE2ODkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/168902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gyakovlev", "html_url": "https://github.com/gyakovlev", "followers_url": "https://api.github.com/users/gyakovlev/followers", "following_url": "https://api.github.com/users/gyakovlev/following{/other_user}", "gists_url": "https://api.github.com/users/gyakovlev/gists{/gist_id}", "starred_url": "https://api.github.com/users/gyakovlev/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gyakovlev/subscriptions", "organizations_url": "https://api.github.com/users/gyakovlev/orgs", "repos_url": "https://api.github.com/users/gyakovlev/repos", "events_url": "https://api.github.com/users/gyakovlev/events{/privacy}", "received_events_url": "https://api.github.com/users/gyakovlev/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 325438536, "node_id": "MDU6TGFiZWwzMjU0Mzg1MzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-bootstrap", "name": "T-bootstrap", "color": "bfd4f2", "default": false, "description": "Relevant to the bootstrap subteam: Rust's build system (x.py and src/bootstrap)"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2019-07-08T16:37:08Z", "updated_at": "2019-08-20T22:15:48Z", "closed_at": "2019-08-20T22:15:48Z", "author_association": "NONE", "active_lock_reason": null, "body": "opening here for visibility\r\noriginal issue here https://github.com/rust-lang/rust-installer/issues/93\r\n\r\n\r\nif someone passes `libdir = \"lib/rust-1.x.x\"` via config.toml\r\ninstall.sh misplaces codegen-backends directory, because `/lib` path is treated as a special case.\r\n\r\nthis code here at fault:\r\nhttps://github.com/rust-lang/rust-installer/blob/5afc0089f282570f2c39b4345d2706bf97e3d84b/install-template.sh#L573-L578\r\n\r\nimagine this scenario\r\n\r\npart of config.toml\r\n```toml\r\n[install]\r\nlibdir = \"lib/rust-1.34.2\"\r\n```\r\n\r\n`DESTDIR=/var/tmp/portage/dev-lang/rust-1.34.2/image ./x.py install`\r\n\r\ninstall.sh gets `\"--libdir=/var/tmp/portage/dev-lang/rust-1.34.2/image/usr/lib/rust-1.34.2\"` as one of args.\r\n\r\nminimal reproducer\r\n```sh\r\n#!/bin/sh\r\n\r\nCFG_LIBDIR=/var/tmp/portage/dev-lang/rust-1.34.2/image/usr/lib/rust-1.34.2\r\nfiles=(\r\n\tlib/rustlib/i686-unknown-linux-gnu/lib/libLLVM-8-rust-1.34.2-stable.so\r\n\tlib/rust-1.34.2/rustlib/i686-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n\tlib/libsyntax_pos-3b2f33a4aab1c362.so\r\n)\r\nfor _file in ${files[@]}; do\r\n\tif echo \"$_file\" | grep \"^lib/\" > /dev/null; then\r\n\t\t_f=\"$(echo \"$_file\" | sed 's/^lib\\///')\"\r\n\t\t_file_install_path=\"$CFG_LIBDIR/$_f\"\r\n\tfi\r\n\techo $_file_install_path\r\ndone\r\n```\r\n```sh\r\nsh test.sh\r\n/var/tmp/portage/dev-lang/rust-1.34.2/image/usr/lib/rust-1.34.2/rustlib/i686-unknown-linux-gnu/lib/libLLVM-8-rust-1.34.2-stable.so\r\n/var/tmp/portage/dev-lang/rust-1.34.2/image/usr/lib/rust-1.34.2/rust-1.34.2/rustlib/i686-unknown-linux-gnu/codegen-backends/librustc_codegen_llvm-llvm.so\r\n/var/tmp/portage/dev-lang/rust-1.34.2/image/usr/lib/rust-1.34.2/libsyntax_pos-3b2f33a4aab1c362.so\r\n```\r\n\r\nso the resulting `codegen-backends` gets installed into `/usr/lib/rust-1.34.2/rust-1.34.2`\r\n\r\nit can't be observed on x86_64 hosts because installer replaces `lib/`, not for `lib64/`\r\n\r\nthis breaks rustc as it can't find `librustc_codegen_llvm-llvm.so` until it's moved to proper location.", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/62496/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/62496/timeline", "performed_via_github_app": null, "state_reason": "completed"}