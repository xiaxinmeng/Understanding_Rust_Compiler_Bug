{"url": "https://api.github.com/repos/rust-lang/rust/issues/91452", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/91452/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/91452/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/91452/events", "html_url": "https://github.com/rust-lang/rust/issues/91452", "id": 1069577924, "node_id": "I_kwDOAAsO6M4_wHbE", "number": 91452, "title": "#[inline(never)] is not respected for trivial functions", "user": {"login": "linkmauve", "id": 7755816, "node_id": "MDQ6VXNlcjc3NTU4MTY=", "avatar_url": "https://avatars.githubusercontent.com/u/7755816?v=4", "gravatar_id": "", "url": "https://api.github.com/users/linkmauve", "html_url": "https://github.com/linkmauve", "followers_url": "https://api.github.com/users/linkmauve/followers", "following_url": "https://api.github.com/users/linkmauve/following{/other_user}", "gists_url": "https://api.github.com/users/linkmauve/gists{/gist_id}", "starred_url": "https://api.github.com/users/linkmauve/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/linkmauve/subscriptions", "organizations_url": "https://api.github.com/users/linkmauve/orgs", "repos_url": "https://api.github.com/users/linkmauve/repos", "events_url": "https://api.github.com/users/linkmauve/events{/privacy}", "received_events_url": "https://api.github.com/users/linkmauve/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2021-12-02T13:55:39Z", "updated_at": "2022-11-30T05:23:54Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "<!--\r\nThank you for filing a bug report! \ud83d\udc1b Please provide a short summary of the bug,\r\nalong with any information you feel relevant to replicating the bug.\r\n-->\r\n\r\nI\u2019m working on a pure Rust Wii/GameCube bare metal runtime, and in order to get the [Dolphin](https://dolphin-emu.org) emulator to output debug information to `stdout` I need to have a function named a certain way which gets replaced at runtime with code from outside the sandbox.\r\n\r\nIn order to do so, `#[inline(never)]` seemed the perfect match, but I couldn\u2019t get it to actually force the function to never be inlined, which kind of defeats its purpose.\r\n\r\nI found a workaround in having an empty `asm!()` call, which also needs to receive the registers, otherwise `rustc` won\u2019t even emit the code putting the correct values for the arguments before the call.  This has the downside of allocating and deallocating 16\u00a0bytes on the stack, I\u2019m really not sure why as the assembly doesn\u2019t actually do anything.\r\n\r\nI tried this code:\r\n\r\n```rust\r\n#![feature(asm)]\r\n\r\n#[no_mangle]\r\n#[inline(never)]\r\nunsafe extern \"C\" fn do_foo(arg: u32) {\r\n    // Comment out this line and this function becomes a noop, and never gets\r\n    // called.\r\n    asm!(\"/* {0} */\", in(reg) arg);\r\n}\r\n\r\nfn main() {\r\n    unsafe { do_foo(4) };\r\n    unsafe { do_foo(12) };\r\n}\r\n```\r\n\r\nI expected to see this happen: codegen should be exactly the same with and without the `asm!()` call on line 8, due to the `#[inline(never)]` which requests `do_foo()` calls to stay as calls and not be inlined.\r\n\r\nInstead, this happened: when line 8 is commented out, `rustc` detects `do_foo` is a noop and inlines it in `main` as such, which then contains a single `blr` instruction (equivalent of `ret` on x86).  This renders `#[inline(never)]` useless.\r\n\r\n### Meta\r\n<!--\r\nIf you're using the stable version of the compiler, you should also check if the\r\nbug also exists in the beta or nightly versions.\r\n-->\r\n\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.58.0-nightly (65f3f8b22 2021-11-21)\r\nbinary: rustc\r\ncommit-hash: 65f3f8b220f020e562c5dd848ff7319257a7ba45\r\ncommit-date: 2021-11-21\r\nhost: x86_64-unknown-linux-gnu\r\nrelease: 1.58.0-nightly\r\nLLVM version: 13.0.0\r\n```\r\n\r\nI\u2019m building for PowerPC, but this bug also reproduces on x86.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/91452/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/91452/timeline", "performed_via_github_app": null, "state_reason": null}