{"url": "https://api.github.com/repos/rust-lang/rust/issues/84182", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/84182/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/84182/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/84182/events", "html_url": "https://github.com/rust-lang/rust/issues/84182", "id": 857517060, "node_id": "MDU6SXNzdWU4NTc1MTcwNjA=", "number": 84182, "title": "Unable to build nightly from tarball due to miri (git repository expected)", "user": {"login": "semarie", "id": 8948701, "node_id": "MDQ6VXNlcjg5NDg3MDE=", "avatar_url": "https://avatars.githubusercontent.com/u/8948701?v=4", "gravatar_id": "", "url": "https://api.github.com/users/semarie", "html_url": "https://github.com/semarie", "followers_url": "https://api.github.com/users/semarie/followers", "following_url": "https://api.github.com/users/semarie/following{/other_user}", "gists_url": "https://api.github.com/users/semarie/gists{/gist_id}", "starred_url": "https://api.github.com/users/semarie/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/semarie/subscriptions", "organizations_url": "https://api.github.com/users/semarie/orgs", "repos_url": "https://api.github.com/users/semarie/repos", "events_url": "https://api.github.com/users/semarie/events{/privacy}", "received_events_url": "https://api.github.com/users/semarie/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2021-04-14T04:49:41Z", "updated_at": "2021-05-15T13:33:25Z", "closed_at": "2021-05-15T13:33:25Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The latest update of miri (#84050) makes build from tarball to fail. In nigthly, it isn't really a big problem (as tarball is unusual build method), but when it would reach stable (1.53.0), it will hurt downstream distributions.\r\n\r\nIf I correctly understood the problem, miri tries to extract informations at build time from expected git repository (sha + timestamp). See [src/tools/miri/cargo-miri/build.rs](https://github.com/rust-lang/miri/blob/b9b2af9729243ab8d5b02cca2e19ce93cc23c1b1/cargo-miri/build.rs#L8). But when the build is from tarball, such git repository doesn't exist, and the build fails with `Unable to generate vergen keys!`.\r\n\r\nThe full error when building 1.53.0-nightly (a86612456 2021-04-11) is the following:\r\n\r\n```\r\n   Compiling cargo-miri v0.1.0 (/data/semarie/build-rust/build_dir/rustc-nightly-src/src/tools/miri/cargo-miri)\r\nerror: failed to run custom build command for `cargo-miri v0.1.0 (/data/semarie/build-rust/build_dir/rustc-nightly-src/src/tools/miri/cargo-miri)`\r\n\r\nCaused by:\r\n  process didn't exit successfully: `/data/semarie/build-rust/build_dir/build/x86_64-unknown-openbsd/stage1-tools/release/build/cargo-miri-a3c3912099a18c0b/build-script-build` (exit code: 101)\r\n  --- stdout\r\n  cargo:rerun-if-changed=build.rs\r\n\r\n  --- stderr\r\n  thread 'main' panicked at 'Unable to generate vergen keys!: could not find repository from '/data/semarie/build-rust/build_dir/rustc-nightly-src/src/tools/miri/cargo-miri'; class=Repository (6); code=NotFound (-3)\r\n\r\n  Stack backtrace:\r\n     0: <unknown>\r\n     1: <unknown>\r\n     2: <unknown>\r\n     3: <unknown>\r\n     4: <unknown>\r\n     5: <unknown>\r\n     6: <unknown>\r\n     7: <unknown>\r\n     8: <unknown>\r\n     9: <unknown>\r\n    10: <unknown>\r\n    11: <unknown>\r\n    12: <unknown>', src/tools/miri/cargo-miri/build.rs:10:24\r\n  stack backtrace:\r\n  note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\ncommand did not execute successfully: \"/data/semarie/build-rust/install_dir/beta/bin/cargo.bin\" \"build\" \"--target\" \"x86_64-unknown-openbsd\" \"-Zbinary-dep-depinfo\" \"-j\" \"4\" \"--release\" \"--frozen\" \"--manifest-path\"\r\n\"/data/semarie/build-rust/build_dir/rustc-nightly-src/src/tools/miri/cargo-miri/Cargo.toml\" \"--message-format\" \"json-render-diagnostics\"\r\nexpected success, got: exit code: 101\r\n      < ToolBuild { compiler: Compiler { stage: 1, host: TargetSelection { triple: \"x86_64-unknown-openbsd\", file: None } }, target: TargetSelection { triple: \"x86_64-unknown-openbsd\", file: None }, tool: \"cargo-miri\", path:\r\n\"src/tools/miri/cargo-miri\", mode: ToolRustc, is_optional_tool: true, source_type: Submodule, extra_features: [] }\r\n    < CargoMiri { compiler: Compiler { stage: 1, host: TargetSelection { triple: \"x86_64-unknown-openbsd\", file: None } }, target: TargetSelection { triple: \"x86_64-unknown-openbsd\", file: None }, extra_features: [] }\r\nthread 'main' panicked at 'Unable to build cargo miri', src/bootstrap/dist.rs:44:9\r\nstack backtrace:\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\nTraceback (most recent call last):\r\n  File \"/data/semarie/build-rust/build_dir/rustc-nightly-src/x.py\", line 27, in <module>\r\n    bootstrap.main()\r\n  File \"/data/semarie/build-rust/build_dir/rustc-nightly-src/src/bootstrap/bootstrap.py\", line 1191, in main\r\n    bootstrap(help_triggered)\r\n  File \"/data/semarie/build-rust/build_dir/rustc-nightly-src/src/bootstrap/bootstrap.py\", line 1177, in bootstrap\r\n    run(args, env=env, verbose=build.verbose)\r\n  File \"/data/semarie/build-rust/build_dir/rustc-nightly-src/src/bootstrap/bootstrap.py\", line 153, in run\r\n    raise RuntimeError(err)\r\nRuntimeError: failed to run: /data/semarie/build-rust/build_dir/build/bootstrap/debug/bootstrap dist --jobs=4\r\n```\r\n\r\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/84182/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/84182/timeline", "performed_via_github_app": null, "state_reason": "completed"}