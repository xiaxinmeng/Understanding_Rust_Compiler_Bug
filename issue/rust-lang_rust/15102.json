{"url": "https://api.github.com/repos/rust-lang/rust/issues/15102", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/15102/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/15102/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/15102/events", "html_url": "https://github.com/rust-lang/rust/issues/15102", "id": 36257189, "node_id": "MDU6SXNzdWUzNjI1NzE4OQ==", "number": 15102, "title": "dead_code lint incorrectly warns about struct fields that aren't dead due to transmuting", "user": {"login": "lilyball", "id": 714, "node_id": "MDQ6VXNlcjcxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lilyball", "html_url": "https://github.com/lilyball", "followers_url": "https://api.github.com/users/lilyball/followers", "following_url": "https://api.github.com/users/lilyball/following{/other_user}", "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}", "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions", "organizations_url": "https://api.github.com/users/lilyball/orgs", "repos_url": "https://api.github.com/users/lilyball/repos", "events_url": "https://api.github.com/users/lilyball/events{/privacy}", "received_events_url": "https://api.github.com/users/lilyball/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235137, "node_id": "MDU6TGFiZWwyMzUxMzc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-lint", "name": "A-lint", "color": "f7e101", "default": false, "description": "Area: Lints (warnings about flaws in source code) such as unused_mut."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 14, "created_at": "2014-06-23T01:39:38Z", "updated_at": "2017-04-30T19:10:56Z", "closed_at": "2017-04-30T19:10:56Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The `dead_code` lint was recently (#14696) modified to detect dead struct fields. Unfortunately, it warns about fields even when it can't be 100% certain they're dead.\n\nOne case where this happens was filed as #15101, where the struct is used as C FFI. That case has the (undocumented) solution of using `#[repr(C)]` (even though `#[repr(C)]` hasn't been implemented to actually do anything yet).\n\nAnother case that doesn't have a clear solution beyond turning off the warning is a struct that contains fields for the purpose of being memory-layout-compatible with another struct.\n\nNotably, in kballard/rust-lua@be46e268c0, the file `lib.rs` defines 3 structs with identical layout. Two of the structs properly use all defined fields, but one of the structs does not use one field (beyond initialization). However, there are methods that use `men::transmute()` to convert between the struct types. If this method is used, then the allegedly-dead field becomes live, as the destination struct uses that field.\n\nI recognize that this is a bit of an edge case, but this isn't the only one. Besides C FFI, a quick test demonstrates that a supposedly-unused struct field that is in fact printed via a `format!(\"{:?}\", foo)` directive is also considered dead. I wouldn't be surprised to find out that there are more edge cases either. The basic point here is that the `dead_code` lint is making an unqualified statement that the field is never used, but it doesn't actually have 100% certainty of that fact. It should be modified to recognize cases where the struct is used in ways the lint can't see into. So far the list of cases includes:\n1. Being passed as a `*mut` to a C FFI function\n2. Being passed to `mem::transmute()`\n3. Being passed to `::debug::fmt::secret_poly`\n\nAnd we can probably add casting `*mut StructType` to any `*mut T` (via `as`, e.g. `foo as *mut ()`) to the list.\n\n/cc @jakub-\n", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/15102/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/15102/timeline", "performed_via_github_app": null, "state_reason": "completed"}