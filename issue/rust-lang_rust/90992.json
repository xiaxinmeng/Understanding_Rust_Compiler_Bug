{"url": "https://api.github.com/repos/rust-lang/rust/issues/90992", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/90992/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/90992/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/90992/events", "html_url": "https://github.com/rust-lang/rust/issues/90992", "id": 1056679737, "node_id": "I_kwDOAAsO6M4--6c5", "number": 90992, "title": "FulfilmentError ICE with trait-provided method implementations and -Clink-dead-code", "user": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}, {"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2021-11-17T22:06:41Z", "updated_at": "2023-04-30T17:42:31Z", "closed_at": "2023-04-30T17:42:31Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "The following code ICEs from 1.24.0 onwards when built with `-Clink-dead-code` ([godbolt](https://godbolt.org/z/aTEhajEzM)):\r\n\r\n```rust\r\nstruct Banana<'a>(&'a ());\r\n\r\npub trait Peach: Sized {\r\n    fn chaenomeles() -> Self;\r\n    fn apple() -> Self {\r\n        Self::chaenomeles()\r\n    }\r\n}\r\n\r\nimpl <'a> Peach for Banana<'a>\r\nwhere &'a (): Peach {\r\n     fn chaenomeles() -> Banana<'a> {\r\n        unimplemented!()\r\n    }\r\n}\r\n```\r\n\r\n---\r\n\r\nIn this example, the `where &'a (): Peach` bound is never satisfied and it is indeed reported as such by the compiler when attempting to call `Banana::<'static>::apple` explicitly:\r\n\r\n```\r\nerror[E0599]: the function or associated item `apple` exists for struct `Banana<'static>`, but its trait bounds were not satisfied\r\n  --> <source>:18:24\r\n   |\r\n1  | struct Banana<'a>(&'a ());\r\n   | --------------------------\r\n   | |\r\n   | function or associated item `apple` not found for this\r\n   | doesn't satisfy `Banana<'_>: Peach`\r\n...\r\n18 |     Banana::<'static>::apple();\r\n   |                        ^^^^^ function or associated item cannot be called on `Banana<'static>` due to unsatisfied trait bounds\r\n   |\r\n   = note: the following trait bounds were not satisfied:\r\n           `&(): Peach`\r\n           which is required by `Banana<'_>: Peach`\r\n   = help: items from traits can only be used if the trait is implemented and in scope\r\nnote: `Peach` defines an item `apple`, perhaps you need to implement it\r\n  --> <source>:3:1\r\n   |\r\n3  | pub trait Peach: Sized {\r\n   | ^^^^^^^^^^^^^^^^^^^^^^\r\n\r\nerror: aborting due to previous error\r\n```\r\n\r\nHowever in absence of calls to `Banana::apple` there is nothing to \u201cforce\u201d typeck to report this error and yet `-Clink-dead-code` causes codegen to attempt to codegen the method anyway, despite the where clause not being satisfied.\r\n\r\nThe correct fix here would probably to make sure that the monomorphization collector in `-Clink-dead-code` mode does not collect items with unsatisfied bounds?\r\n\r\nAdditionally, I feel like a lint warning along the lines of\r\n\r\n```\r\nwarning: this where clause is never satisfied\r\n     where &'a (): Peach\r\n           ^^^^^^^^^^^^^\r\n```\r\n\r\ncould be useful", "closed_by": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/90992/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/90992/timeline", "performed_via_github_app": null, "state_reason": "completed"}