{"url": "https://api.github.com/repos/rust-lang/rust/issues/32588", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/32588/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/32588/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/32588/events", "html_url": "https://github.com/rust-lang/rust/issues/32588", "id": 144369703, "node_id": "MDU6SXNzdWUxNDQzNjk3MDM=", "number": 32588, "title": "Incorrect behavior calling extern \"C\" varargs functions in nightly (works in 1.8 beta)", "user": {"login": "jgallagher", "id": 1435635, "node_id": "MDQ6VXNlcjE0MzU2MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/1435635?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jgallagher", "html_url": "https://github.com/jgallagher", "followers_url": "https://api.github.com/users/jgallagher/followers", "following_url": "https://api.github.com/users/jgallagher/following{/other_user}", "gists_url": "https://api.github.com/users/jgallagher/gists{/gist_id}", "starred_url": "https://api.github.com/users/jgallagher/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jgallagher/subscriptions", "organizations_url": "https://api.github.com/users/jgallagher/orgs", "repos_url": "https://api.github.com/users/jgallagher/repos", "events_url": "https://api.github.com/users/jgallagher/events{/privacy}", "received_events_url": "https://api.github.com/users/jgallagher/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2016-03-29T19:56:46Z", "updated_at": "2016-03-29T20:31:26Z", "closed_at": "2016-03-29T20:28:27Z", "author_association": "NONE", "active_lock_reason": null, "body": "I was seeing segfaults in libsqlite running one of the tests on [rusqlite](https://github.com/jgallagher/rusqlite) on the latest nightly. Tracked it down to rust not calling extern \"C\" functions with variable args correctly.\n\nGiven this C function:\n\n``` c\nvoid foobar(int32_t x, ...) {\n    va_list ap;\n    va_start(ap, 2);\n    uint64_t y = va_arg(ap, uint64_t);\n    uint64_t z = va_arg(ap, uint64_t);\n    va_end(ap);\n\n    printf(\"called with x = %d and varargs %#lx %#lx\\n\", x, y, z);\n}\n```\n\nwhere two 64-bit values are expected in the varargs, and this Rust function:\n\n``` rust\nextern \"C\" {\n    fn foobar(x: i32, ...);\n}\n\nfn main() {\n    extern \"C\" fn callback() {\n    }\n\n    println!(\"calling foobar(1, 0x{:x}, 3u64)\", callback as usize);\n    unsafe { foobar(1, callback, 3u64); }\n}\n```\n\nRunning on `rustc 1.8.0-beta.2 (2879d940a 2016-03-22)` outputs\n\n```\ncalling foobar(1, 0x105906d40, 3u64)\ncalled with x = 1 and varargs 0x105906d40 0x3\n```\n\nand running on `rustc 1.9.0-nightly (d5a91e695 2016-03-26)` outputs\n\n```\ncalling foobar(1, 0x101223d40, 3u64)\ncalled with x = 1 and varargs 0x3 0x10000000100\n```\n\n(I uploaded a full cargo project [reproducer](https://github.com/jgallagher/rustc-varargs).)\n\nI assume this is related to #19925, as both workarounds listed there for transmute fix the above problem too; i.e.,\n\n``` rust\nfoobar(1, callback as extern \"C\" fn(), 3u64);\nfoobar(1, callback as usize, 3u64);\n```\n\nboth work correctly on nightly, but given this started causing segfaults in code that was working previously, I wonder if a warning or error could be issued for \"you're passing a 0-sized thing to a C function and that's probably not what you want\"? (I assume the output I pasted above from nightly is a result of rustc skipping over the 0-size `callback` and passing only a single parameter to the varargs instead of two.)\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/32588/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/32588/timeline", "performed_via_github_app": null, "state_reason": "completed"}