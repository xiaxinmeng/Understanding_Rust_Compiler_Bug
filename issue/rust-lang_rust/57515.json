{"url": "https://api.github.com/repos/rust-lang/rust/issues/57515", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/57515/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/57515/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/57515/events", "html_url": "https://github.com/rust-lang/rust/issues/57515", "id": 398311581, "node_id": "MDU6SXNzdWUzOTgzMTE1ODE=", "number": 57515, "title": "compiletest: compare_output() fails on Windows due to different line endings", "user": {"login": "fkohlgrueber", "id": 9519668, "node_id": "MDQ6VXNlcjk1MTk2Njg=", "avatar_url": "https://avatars.githubusercontent.com/u/9519668?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fkohlgrueber", "html_url": "https://github.com/fkohlgrueber", "followers_url": "https://api.github.com/users/fkohlgrueber/followers", "following_url": "https://api.github.com/users/fkohlgrueber/following{/other_user}", "gists_url": "https://api.github.com/users/fkohlgrueber/gists{/gist_id}", "starred_url": "https://api.github.com/users/fkohlgrueber/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fkohlgrueber/subscriptions", "organizations_url": "https://api.github.com/users/fkohlgrueber/orgs", "repos_url": "https://api.github.com/users/fkohlgrueber/repos", "events_url": "https://api.github.com/users/fkohlgrueber/events{/privacy}", "received_events_url": "https://api.github.com/users/fkohlgrueber/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2019-01-11T14:29:28Z", "updated_at": "2019-01-11T20:57:01Z", "closed_at": "2019-01-11T20:57:01Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The comparison of stdout / stderr output for ui tests fails on Windows for projects checked out using git and the recommended line ending settings.\r\n\r\nFor example, this is the output when running `cargo test` in the `test-project` folder of the [compiletest-rs](https://github.com/laumann/compiletest-rs) project:\r\n\r\n```\r\n...\r\nrunning 1 test\r\ntest [ui] ui\\dyn-keyword.rs ... FAILED\r\n\r\nfailures:\r\n\r\n---- [ui] ui\\dyn-keyword.rs stdout ----\r\nnormalized stderr:\r\nerror: `dyn` is a keyword in the 2018 edition\r\n  --> $DIR/dyn-keyword.rs:17:9\r\n   |\r\n17 |     let dyn = (); //~ ERROR dyn\r\n   |         ^^^ help: you can use a raw identifier to stay compatible: `r#dyn`\r\n   |\r\nnote: lint level defined here\r\n  --> $DIR/dyn-keyword.rs:14:9\r\n   |\r\n14 | #![deny(keyword_idents)]\r\n   |         ^^^^^^^^^^^^^^\r\n   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in the 2018 edition!\r\n   = note: for more information, see issue #49716 <https://github.com/rust-lang/rust/issues/49716>\r\n\r\nerror: aborting due to previous error\r\n\r\n\r\n\r\nexpected stderr:\r\nerror: `dyn` is a keyword in the 2018 edition\r\n  --> $DIR/dyn-keyword.rs:17:9\r\n   |\r\n17 |     let dyn = (); //~ ERROR dyn\r\n   |         ^^^ help: you can use a raw identifier to stay compatible: `r#dyn`\r\n   |\r\nnote: lint level defined here\r\n  --> $DIR/dyn-keyword.rs:14:9\r\n   |\r\n14 | #![deny(keyword_idents)]\r\n   |         ^^^^^^^^^^^^^^\r\n   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in the 2018 edition!\r\n   = note: for more information, see issue #49716 <https://github.com/rust-lang/rust/issues/49716>\r\n\r\nerror: aborting due to previous error\r\n\r\n\r\n\r\ndiff of stderr:\r\n\r\n error: `dyn` is a keyword in the 2018 edition\r\n   --> $DIR/dyn-keyword.rs:17:9\r\n    |\r\n 17 |     let dyn = (); //~ ERROR dyn\r\n    |         ^^^ help: you can use a raw identifier to stay compatible: `r#dyn`\r\n    |\r\n note: lint level defined here\r\n   --> $DIR/dyn-keyword.rs:14:9\r\n    |\r\n 14 | #![deny(keyword_idents)]\r\n    |         ^^^^^^^^^^^^^^\r\n    = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in the 2018 edition!\r\n    = note: for more information, see issue #49716 <https://github.com/rust-lang/rust/issues/49716>\r\n\r\n error: aborting due to previous error\r\n\r\n\r\n\r\nThe actual stderr differed from the expected stderr.\r\nActual stderr saved to C:\\Users\\felix\\AppData\\Local\\Temp\\compiletestsGP0Kn\\dyn-keyword.stderr\r\nTo update references, run this command from build directory:\r\ntests/ui/update-references.sh 'C:\\Users\\felix\\AppData\\Local\\Temp\\compiletestsGP0Kn' 'dyn-keyword.rs'\r\n...\r\n```\r\n\r\nOn Windows, Git's recommended line ending setting is *Checkout Windows-style, commit Unix-style* (see [here](https://stackoverflow.com/questions/10418975/how-to-change-line-ending-settings)). This means that the line endings of all files (including `*.stderr`) are converted from `LF` to `CRLF` on checkout.\r\n\r\nSince line breaks in the actual output get normalized to `LF` (see [here](https://docs.rs/compiletest_rs/0.3.18/src/compiletest_rs/runtest.rs.html#2531-2532)), the comparison between actual and expected output fails (see [here](https://docs.rs/compiletest_rs/0.3.18/src/compiletest_rs/runtest.rs.html#2570)).\r\n\r\nAdditionally, the `fixed` actual output doesn't get normalized and therefore can have `CRLF` line endings (see [here](https://docs.rs/compiletest_rs/0.3.18/src/compiletest_rs/runtest.rs.html#2571-2290)).\r\n\r\nMy suggestion would be to add another check to [`compare_output()`](https://docs.rs/compiletest_rs/0.3.18/src/compiletest_rs/runtest.rs.html#2570):\r\n\r\n```\r\nif actual == expected {\r\n    return 0;\r\n}\r\n\r\n// check if files only differ in line endings\r\nif actual.replace(\"\\r\\n\", \"\\n\") == expected.replace(\"\\r\\n\", \"\\n\") {\r\n    return 0;\r\n}\r\n```\r\n\r\nI can open a PR if you agree that this is the right way to solve the issue. What do you think?", "closed_by": {"login": "fkohlgrueber", "id": 9519668, "node_id": "MDQ6VXNlcjk1MTk2Njg=", "avatar_url": "https://avatars.githubusercontent.com/u/9519668?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fkohlgrueber", "html_url": "https://github.com/fkohlgrueber", "followers_url": "https://api.github.com/users/fkohlgrueber/followers", "following_url": "https://api.github.com/users/fkohlgrueber/following{/other_user}", "gists_url": "https://api.github.com/users/fkohlgrueber/gists{/gist_id}", "starred_url": "https://api.github.com/users/fkohlgrueber/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fkohlgrueber/subscriptions", "organizations_url": "https://api.github.com/users/fkohlgrueber/orgs", "repos_url": "https://api.github.com/users/fkohlgrueber/repos", "events_url": "https://api.github.com/users/fkohlgrueber/events{/privacy}", "received_events_url": "https://api.github.com/users/fkohlgrueber/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/57515/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/57515/timeline", "performed_via_github_app": null, "state_reason": "completed"}