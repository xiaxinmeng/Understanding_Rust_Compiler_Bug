{"url": "https://api.github.com/repos/rust-lang/rust/issues/106629", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/106629/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/106629/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/106629/events", "html_url": "https://github.com/rust-lang/rust/issues/106629", "id": 1525483533, "node_id": "I_kwDOAAsO6M5a7QgN", "number": 106629, "title": "`improper_ctypes` lint fires on `#[repr(transparent)]` wrappers around `PhantomData` (in struct fields).", "user": {"login": "thomcc", "id": 860665, "node_id": "MDQ6VXNlcjg2MDY2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/860665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thomcc", "html_url": "https://github.com/thomcc", "followers_url": "https://api.github.com/users/thomcc/followers", "following_url": "https://api.github.com/users/thomcc/following{/other_user}", "gists_url": "https://api.github.com/users/thomcc/gists{/gist_id}", "starred_url": "https://api.github.com/users/thomcc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thomcc/subscriptions", "organizations_url": "https://api.github.com/users/thomcc/orgs", "repos_url": "https://api.github.com/users/thomcc/repos", "events_url": "https://api.github.com/users/thomcc/events{/privacy}", "received_events_url": "https://api.github.com/users/thomcc/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235137, "node_id": "MDU6TGFiZWwyMzUxMzc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-lint", "name": "A-lint", "color": "f7e101", "default": false, "description": "Area: Lints (warnings about flaws in source code) such as unused_mut."}, {"id": 45472092, "node_id": "MDU6TGFiZWw0NTQ3MjA5Mg==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-ffi", "name": "A-ffi", "color": "f7e101", "default": false, "description": "Area: Foreign Function Interface (FFI)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": {"login": "krtab", "id": 53921575, "node_id": "MDQ6VXNlcjUzOTIxNTc1", "avatar_url": "https://avatars.githubusercontent.com/u/53921575?v=4", "gravatar_id": "", "url": "https://api.github.com/users/krtab", "html_url": "https://github.com/krtab", "followers_url": "https://api.github.com/users/krtab/followers", "following_url": "https://api.github.com/users/krtab/following{/other_user}", "gists_url": "https://api.github.com/users/krtab/gists{/gist_id}", "starred_url": "https://api.github.com/users/krtab/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/krtab/subscriptions", "organizations_url": "https://api.github.com/users/krtab/orgs", "repos_url": "https://api.github.com/users/krtab/repos", "events_url": "https://api.github.com/users/krtab/events{/privacy}", "received_events_url": "https://api.github.com/users/krtab/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "krtab", "id": 53921575, "node_id": "MDQ6VXNlcjUzOTIxNTc1", "avatar_url": "https://avatars.githubusercontent.com/u/53921575?v=4", "gravatar_id": "", "url": "https://api.github.com/users/krtab", "html_url": "https://github.com/krtab", "followers_url": "https://api.github.com/users/krtab/followers", "following_url": "https://api.github.com/users/krtab/following{/other_user}", "gists_url": "https://api.github.com/users/krtab/gists{/gist_id}", "starred_url": "https://api.github.com/users/krtab/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/krtab/subscriptions", "organizations_url": "https://api.github.com/users/krtab/orgs", "repos_url": "https://api.github.com/users/krtab/repos", "events_url": "https://api.github.com/users/krtab/events{/privacy}", "received_events_url": "https://api.github.com/users/krtab/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2023-01-09T12:16:29Z", "updated_at": "2023-01-13T02:12:55Z", "closed_at": "2023-01-13T02:12:55Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "If I have a `#[repr(transparent)]` wrapper around a `PhantomData`, it's considered an improper C type when used in a struct field, even though the wrapped `PhantomData` would be allowed. Specifically ([playground](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=c82e16eb77a88e4613e5812d1b1123e3))\n```rs\n#[repr(transparent)]\n#[derive(Copy, Clone)]\nstruct MyPhantom(core::marker::PhantomData<u8>);\n\n#[repr(C)]\n#[derive(Copy, Clone)]\npub struct Bar {\n    pub x: i32,\n    _marker: MyPhantom,\n}\n\nextern \"C\" {\n    pub fn foo(bar: *mut Bar);\n}\n```\n\nproduces the error\n```\n   Compiling playground v0.0.1 (/playground)\nwarning: `extern` block uses type `MyPhantom`, which is not FFI-safe\n  --> src/lib.rs:13:21\n   |\n13 |     pub fn foo(bar: *mut Bar);\n   |                     ^^^^^^^^ not FFI-safe\n   |\n   = note: this struct contains only zero-sized fields\nnote: the type is defined here\n  --> src/lib.rs:3:1\n   |\n3  | struct MyPhantom(core::marker::PhantomData<u8>);\n   | ^^^^^^^^^^^^^^^^\n   = note: `#[warn(improper_ctypes)]` on by default\n\nwarning: `playground` (lib) generated 1 warning\n    Finished dev [unoptimized + debuginfo] target(s) in 0.51s\n```\n\nThis is over-zealous for a few reasons.\n\n1. `PhantomData` on its own is allowed in C structs, so changing this to `_marker: PhantomData<u8>` would solve the warning (but defeats the point of my use case[^1]).\n\n2. `#[repr(transparent)]` is supposed to be treated as the inner type for purposes of ABI, and the `improper_ctypes` lint is about ABI.\n\n3. Using `#[repr(C)]` instead of `#[repr(transparent)]` solves this technically (it shuts the warning up), but seems pretty dodgy, since it's not actually laid out the way C would lay it out anymore (that is, we've guaranteed that `PhantomData` is never going to impact layout at all, and we *haven't* guaranteed this for zero-sized `#[repr(C)]` types which are notably not a real thing in C).\n\nTLDR: this lint fires on `#[repr(transparent)]` wrappers around `PhantomData` when they're used as struct fields. IMO these should be fine since `PhantomData` doesn't emit a warning in that case, and `#[repr(transparent)]` is supposed to defer to the inner type.\n\n[^1]: If you're curious about the real use case I have, a closer but still-basically-minimized version is [here](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=614935f0bf5a85469cf646f1f89f4ebe). It's important that the type not be a direct `PhantomData` (basically `#[non_exhaustive]` is not really usable for FFI, but C has cases where considers appending new fields to the end of a type to be a non-breaking change).\n\n*(That said, firing this lint on a type passed by pointer is pretty weird anyway, since the indirection means doesn't actually have to be a valid C type (for the ABI), which is the basic complaint behind #66373, which is *not* what I'm complaining about. IMO this shouldn't fire even if `Bar` were being passed by value, as making the field `PhantomData` (instead of a wrapper around one) doesn't fire in that case)*\n\n<!-- TRIAGEBOT_START -->\n\n<!-- TRIAGEBOT_ASSIGN_START -->\n\n<!-- TRIAGEBOT_ASSIGN_DATA_START$${\"user\":\"krtab\"}$$TRIAGEBOT_ASSIGN_DATA_END -->\n\n<!-- TRIAGEBOT_ASSIGN_END -->\n<!-- TRIAGEBOT_END -->", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/106629/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/106629/timeline", "performed_via_github_app": null, "state_reason": "completed"}