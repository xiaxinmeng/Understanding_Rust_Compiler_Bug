{"url": "https://api.github.com/repos/rust-lang/rust/issues/46367", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/46367/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/46367/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/46367/events", "html_url": "https://github.com/rust-lang/rust/issues/46367", "id": 277767422, "node_id": "MDU6SXNzdWUyNzc3Njc0MjI=", "number": 46367, "title": "wasm32-unknown-unknown produces \"index out of bounds\" when not optimized", "user": {"login": "chrysn", "id": 442326, "node_id": "MDQ6VXNlcjQ0MjMyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/442326?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chrysn", "html_url": "https://github.com/chrysn", "followers_url": "https://api.github.com/users/chrysn/followers", "following_url": "https://api.github.com/users/chrysn/following{/other_user}", "gists_url": "https://api.github.com/users/chrysn/gists{/gist_id}", "starred_url": "https://api.github.com/users/chrysn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chrysn/subscriptions", "organizations_url": "https://api.github.com/users/chrysn/orgs", "repos_url": "https://api.github.com/users/chrysn/repos", "events_url": "https://api.github.com/users/chrysn/events{/privacy}", "received_events_url": "https://api.github.com/users/chrysn/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}, {"id": 474645165, "node_id": "MDU6TGFiZWw0NzQ2NDUxNjU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-wasm", "name": "O-wasm", "color": "6e6ec0", "default": false, "description": "Target: WASM (WebAssembly), http://webassembly.org/"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2017-11-29T14:08:49Z", "updated_at": "2018-03-06T17:10:23Z", "closed_at": "2018-03-06T17:10:23Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "With the current nightly builds (1.24.0-nightly (73bca2b9f 2017-11-28)), some (I assume most) programs are unrunnable on wasm32-unknown-unknown (tested in Firefox 56.0) unless compiled with optimization flags. The condition appears somewhere between where the start function and main is called in this example, but I've also tested overriding the start function to a no-op, and then the most simple functions (just returning an integer) worked, but anything that called another function didn't.\r\n\r\nSteps to reproduce:\r\n\r\n```rust\r\n#[no_mangle]\r\npub extern \"C\" fn pub_function(x: i32) -> i32 { 2 * x }\r\npub fn main() {}\r\n```\r\n\r\nas demo.rs; compile with `rustc +nightly --target wasm32-unknown-unknown -O demo.rs` and serve together with this index.html:\r\n\r\n```html\r\n<script>\r\nfetch(\"demo.wasm\").then(response =>\r\n    response.arrayBuffer()\r\n).then(bytes =>\r\n    WebAssembly.instantiate(bytes, {})\r\n).then(results =>\r\n    console.log(results.instance.exports.pub_function(42))\r\n);\r\n</script>\r\n```\r\n\r\n\u2026 and the console will print `84`. Leave out the `-O`, and instead, the console will give `RuntimeError: index out of bounds`, with a stack trace 7 deep into the start function at a `i32.store offset=4` instruction.", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/46367/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/46367/timeline", "performed_via_github_app": null, "state_reason": "completed"}