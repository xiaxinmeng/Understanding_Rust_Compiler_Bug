{"url": "https://api.github.com/repos/rust-lang/rust/issues/92867", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/92867/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/92867/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/92867/events", "html_url": "https://github.com/rust-lang/rust/issues/92867", "id": 1102414547, "node_id": "I_kwDOAAsO6M5BtYLT", "number": 92867, "title": "Linker error when building rust toolchain on x86_64 to target and run on i586 machines", "user": {"login": "teknoman117", "id": 326028, "node_id": "MDQ6VXNlcjMyNjAyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/326028?v=4", "gravatar_id": "", "url": "https://api.github.com/users/teknoman117", "html_url": "https://github.com/teknoman117", "followers_url": "https://api.github.com/users/teknoman117/followers", "following_url": "https://api.github.com/users/teknoman117/following{/other_user}", "gists_url": "https://api.github.com/users/teknoman117/gists{/gist_id}", "starred_url": "https://api.github.com/users/teknoman117/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/teknoman117/subscriptions", "organizations_url": "https://api.github.com/users/teknoman117/orgs", "repos_url": "https://api.github.com/users/teknoman117/repos", "events_url": "https://api.github.com/users/teknoman117/events{/privacy}", "received_events_url": "https://api.github.com/users/teknoman117/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2022-01-13T21:34:54Z", "updated_at": "2022-01-15T04:26:55Z", "closed_at": "2022-01-15T04:26:55Z", "author_association": "NONE", "active_lock_reason": null, "body": "I'm attempting to compile the Rust toolchain to target and run on a really old computer (AMD K6-2+/500), but build it on my modern desktop (Threadripper 1950X). This is part of adding xorg to the Gentoo image I have going for it, and I need a Rust toolchain as spidermonkey uses Rust and is apparently a dependency of polkit these days, which is a dependency of pam, which is a dependency of elogind, and so on. The default Gentoo Rust ebuild doesn't seem to understand i586 and ends up building an i686 toolchain instead, meaning all the Rust programs are potentially build with SSE and SSE2 instructions. So here I am building from source manually so I can understand the whole process first, then hack up *dev-lang/rust-bin* to install my custom one.\r\n\r\nI cloned rust from GitHub, checked out the 1.56.1 tag (I also tried 1.57.0), updated and init'd the submodules, and ran the setup script. Rust doesn't seem to be too happy about trying to compile 32-bit toolchains with a 64-bit rust compiler, so I set the build toolchain as i686 and the host and target to i586. \r\n```\r\n# set target and host to i586-unknown-linux-gnu, generates config.toml\r\n./x.py setup --build i686-unknown-linux-gnu --host i586-unknown-linux-gnu --target i586-unknown-linux-gnu -j 32\r\n\r\n# build toolchain\r\n./x.py dist --build i686-unknown-linux-gnu --host i586-unknown-linux-gnu --target i586-unknown-linux-gnu -j 32\r\n```\r\n\r\nIt runs for about 15 minutes before failing to link when building the stage1 compiler artifacts. The symbols it's complaining about suggest an unsatisfied dependency on zlib.\r\n\r\n```\r\nBuilding stage1 compiler artifacts (i686-unknown-linux-gnu -> i586-unknown-linux-gnu)\r\n   Compiling rustc-main v0.0.0 (/home/nlewis/Sources/rust/compiler/rustc)\r\nerror: linking with `cc` failed: exit status: 1\r\n  |\r\n  = note: \"cc\" \"-m32\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/i586-unknown-linux-gnu/release/deps/rustc_main-8dca1282a3ea6fe5.rustc_main.049335a6-cgu.0.rcgu.o\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/i586-unknown-linux-gnu/release/deps/rustc_main-8dca1282a3ea6fe5.rustc_main.049335a6-cgu.1.rcgu.o\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/i586-unknown-linux-gnu/release/deps/rustc_main-8dca1282a3ea6fe5.rustc_main.049335a6-cgu.2.rcgu.o\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/i586-unknown-linux-gnu/release/deps/rustc_main-8dca1282a3ea6fe5.rustc_main.049335a6-cgu.3.rcgu.o\" \"-Wl,--as-needed\" \"-L\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/i586-unknown-linux-gnu/release/deps\" \"-L\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/release/deps\" \"-L\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/i586-unknown-linux-gnu/release/build/psm-575ab1ac3c62167e/out\" \"-L\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/i586-unknown-linux-gnu/release/build/rustc_llvm-a25318d4dac0e88d/out\" \"-L\" \"/home/nlewis/Sources/rust/build/i586-unknown-linux-gnu/llvm/build/lib\" \"-L\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1/lib/rustlib/i586-unknown-linux-gnu/lib\" \"-L\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/i586-unknown-linux-gnu/release/deps\" \"-lrustc_driver-758e2c9545688f16\" \"-Wl,--start-group\" \"-L\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1/lib/rustlib/i586-unknown-linux-gnu/lib\" \"-lstd-13a451e692cd4b84\" \"-Wl,--end-group\" \"-Wl,-Bstatic\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1/lib/rustlib/i586-unknown-linux-gnu/lib/libcompiler_builtins-c6f3a48116e83ade.rlib\" \"-Wl,-Bdynamic\" \"-lstdc++\" \"-lgcc_s\" \"-lutil\" \"-lrt\" \"-lpthread\" \"-lm\" \"-ldl\" \"-lc\" \"-Wl,--eh-frame-hdr\" \"-Wl,-znoexecstack\" \"-L\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1/lib/rustlib/i586-unknown-linux-gnu/lib\" \"-o\" \"/home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/i586-unknown-linux-gnu/release/deps/rustc_main-8dca1282a3ea6fe5\" \"-Wl,--gc-sections\" \"-pie\" \"-Wl,-zrelro\" \"-Wl,-znow\" \"-Wl,-O1\" \"-nodefaultlibs\" \"-Wl,-rpath,$ORIGIN/../lib\"\r\n  = note: /usr/lib/gcc/x86_64-pc-linux-gnu/11.2.1/../../../../x86_64-pc-linux-gnu/bin/ld: /home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/i586-unknown-linux-gnu/release/deps/librustc_driver-758e2c9545688f16.so: undefined reference to `uncompress'\r\n          /usr/lib/gcc/x86_64-pc-linux-gnu/11.2.1/../../../../x86_64-pc-linux-gnu/bin/ld: /home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/i586-unknown-linux-gnu/release/deps/librustc_driver-758e2c9545688f16.so: undefined reference to `compress2'\r\n          /usr/lib/gcc/x86_64-pc-linux-gnu/11.2.1/../../../../x86_64-pc-linux-gnu/bin/ld: /home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/i586-unknown-linux-gnu/release/deps/librustc_driver-758e2c9545688f16.so: undefined reference to `crc32'\r\n          /usr/lib/gcc/x86_64-pc-linux-gnu/11.2.1/../../../../x86_64-pc-linux-gnu/bin/ld: /home/nlewis/Sources/rust/build/i686-unknown-linux-gnu/stage1-rustc/i586-unknown-linux-gnu/release/deps/librustc_driver-758e2c9545688f16.so: undefined reference to `compressBound'\r\n          collect2: error: ld returned 1 exit status\r\n\r\n  = help: some `extern` functions couldn't be found; some native libraries may need to be installed or have their path specified\r\n  = note: use the `-l` flag to specify native libraries to link\r\n  = note: use the `cargo:rustc-link-lib` directive to specify the native libraries to link with Cargo (see https://doc.rust-lang.org/cargo/reference/build-scripts.html#cargorustc-link-libkindname)\r\n\r\nerror: could not compile `rustc-main` due to previous error\r\nBuild completed unsuccessfully in 0:00:49\r\n```\r\nDoes anyone know what I'm missing here?", "closed_by": {"login": "teknoman117", "id": 326028, "node_id": "MDQ6VXNlcjMyNjAyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/326028?v=4", "gravatar_id": "", "url": "https://api.github.com/users/teknoman117", "html_url": "https://github.com/teknoman117", "followers_url": "https://api.github.com/users/teknoman117/followers", "following_url": "https://api.github.com/users/teknoman117/following{/other_user}", "gists_url": "https://api.github.com/users/teknoman117/gists{/gist_id}", "starred_url": "https://api.github.com/users/teknoman117/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/teknoman117/subscriptions", "organizations_url": "https://api.github.com/users/teknoman117/orgs", "repos_url": "https://api.github.com/users/teknoman117/repos", "events_url": "https://api.github.com/users/teknoman117/events{/privacy}", "received_events_url": "https://api.github.com/users/teknoman117/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/92867/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/92867/timeline", "performed_via_github_app": null, "state_reason": "completed"}