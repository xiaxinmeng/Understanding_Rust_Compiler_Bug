{"url": "https://api.github.com/repos/rust-lang/rust/issues/77834", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/77834/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/77834/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/77834/events", "html_url": "https://github.com/rust-lang/rust/issues/77834", "id": 718928768, "node_id": "MDU6SXNzdWU3MTg5Mjg3Njg=", "number": 77834, "title": "Add error help to \"cannot borrow ... as mutable more than once at a time\" error that recommends assigning to a variable first", "user": {"login": "camelid", "id": 37223377, "node_id": "MDQ6VXNlcjM3MjIzMzc3", "avatar_url": "https://avatars.githubusercontent.com/u/37223377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camelid", "html_url": "https://github.com/camelid", "followers_url": "https://api.github.com/users/camelid/followers", "following_url": "https://api.github.com/users/camelid/following{/other_user}", "gists_url": "https://api.github.com/users/camelid/gists{/gist_id}", "starred_url": "https://api.github.com/users/camelid/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camelid/subscriptions", "organizations_url": "https://api.github.com/users/camelid/orgs", "repos_url": "https://api.github.com/users/camelid/repos", "events_url": "https://api.github.com/users/camelid/events{/privacy}", "received_events_url": "https://api.github.com/users/camelid/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 171502053, "node_id": "MDU6TGFiZWwxNzE1MDIwNTM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-borrow-checker", "name": "A-borrow-checker", "color": "f7e101", "default": false, "description": "Area: The borrow checker"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 1596121013, "node_id": "MDU6TGFiZWwxNTk2MTIxMDEz", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-confusing", "name": "D-confusing", "color": "c9f7a3", "default": false, "description": "Confusing diagnostic error that should be reworked"}, {"id": 1596122811, "node_id": "MDU6TGFiZWwxNTk2MTIyODEx", "url": "https://api.github.com/repos/rust-lang/rust/labels/D-newcomer-roadblock", "name": "D-newcomer-roadblock", "color": "c9f7a3", "default": false, "description": "Confusing diagnostic error hard to understand for new users"}], "state": "closed", "locked": false, "assignee": {"login": "camelid", "id": 37223377, "node_id": "MDQ6VXNlcjM3MjIzMzc3", "avatar_url": "https://avatars.githubusercontent.com/u/37223377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camelid", "html_url": "https://github.com/camelid", "followers_url": "https://api.github.com/users/camelid/followers", "following_url": "https://api.github.com/users/camelid/following{/other_user}", "gists_url": "https://api.github.com/users/camelid/gists{/gist_id}", "starred_url": "https://api.github.com/users/camelid/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camelid/subscriptions", "organizations_url": "https://api.github.com/users/camelid/orgs", "repos_url": "https://api.github.com/users/camelid/repos", "events_url": "https://api.github.com/users/camelid/events{/privacy}", "received_events_url": "https://api.github.com/users/camelid/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "camelid", "id": 37223377, "node_id": "MDQ6VXNlcjM3MjIzMzc3", "avatar_url": "https://avatars.githubusercontent.com/u/37223377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camelid", "html_url": "https://github.com/camelid", "followers_url": "https://api.github.com/users/camelid/followers", "following_url": "https://api.github.com/users/camelid/following{/other_user}", "gists_url": "https://api.github.com/users/camelid/gists{/gist_id}", "starred_url": "https://api.github.com/users/camelid/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camelid/subscriptions", "organizations_url": "https://api.github.com/users/camelid/orgs", "repos_url": "https://api.github.com/users/camelid/repos", "events_url": "https://api.github.com/users/camelid/events{/privacy}", "received_events_url": "https://api.github.com/users/camelid/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 4, "created_at": "2020-10-11T21:17:31Z", "updated_at": "2021-12-11T21:57:17Z", "closed_at": "2021-12-11T21:57:17Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "A newcomer to Rust may have some code that looks like this ([playground](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=b44d0e3b2a0464c662499b2d6cc2a0e1)):\r\n\r\n```rust\r\nstruct Foo;\r\n\r\nimpl Foo {\r\n  fn foo(&mut self, _: f32) -> i32 { todo!() }\r\n  fn bar(&mut self) -> f32 { todo!() }\r\n  fn baz(&mut self) {\r\n    self.foo(self.bar());\r\n  }\r\n}\r\n```\r\n\r\nWhich you would think would work, since the call to `self.foo()` happens after `self.bar()` returns, and so they have unique access to `self`. However, this desugars into something like this:\r\n\r\n```rust\r\nstruct Foo;\r\n\r\nimpl Foo {\r\n  fn foo(&mut self, _: f32) -> i32 { todo!() }\r\n  fn bar(&mut self) -> f32 { todo!() }\r\n  fn baz(&mut self) {\r\n    Self::foo(&mut self, Self::bar(&mut self));\r\n  }\r\n}\r\n```\r\n\r\nWhich, due to something else in the Rust aliasing rules that can be confusing, means that there are actually two unique borrows of `self` live at the same time, and produces this error:\r\n\r\n```\r\n   Compiling playground v0.0.1 (/playground)\r\nerror[E0499]: cannot borrow `*self` as mutable more than once at a time\r\n --> src/lib.rs:7:14\r\n  |\r\n7 |     self.foo(self.bar());\r\n  |     ---- --- ^^^^ second mutable borrow occurs here\r\n  |     |    |\r\n  |     |    first borrow later used by call\r\n  |     first mutable borrow occurs here\r\n```\r\n\r\nHowever, this error is confusing because the error is only visible when the code is desugared. Because of how the code is desugared, this code \u2013 which is functionally equivalent \u2013 compiles fine ([playground](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=733e234866dbee7a1714f561940039d6)):\r\n\r\n```rust\r\nstruct Foo;\r\n\r\nimpl Foo {\r\n  fn foo(&mut self, _: f32) -> i32 { todo!() }\r\n  fn bar(&mut self) -> f32 { todo!() }\r\n  fn baz(&mut self) {\r\n    let temp = self.bar();\r\n    self.foo(temp);\r\n  }\r\n}\r\n```\r\n\r\nTherefore I propose adding a help message to the error that suggests extracting the result into a temporary. Something like this:\r\n\r\n```\r\nerror[E0499]: cannot borrow `*self` as mutable more than once at a time\r\n --> src/lib.rs:7:14\r\n  |\r\n7 |     self.foo(self.bar());\r\n  |     ---- --- ^^^^ second mutable borrow occurs here\r\n  |     |    |\r\n  |     |    first borrow later used by call\r\n  |     first mutable borrow occurs here\r\n  |\r\n  = help: try assigning `self.bar()` to a variable and then call `self.foo()` with that variable\r\n```\r\n\r\nCc @jyn514 ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/77834/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/77834/timeline", "performed_via_github_app": null, "state_reason": "completed"}