{"url": "https://api.github.com/repos/rust-lang/rust/issues/41366", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/41366/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/41366/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/41366/events", "html_url": "https://github.com/rust-lang/rust/issues/41366", "id": 222437043, "node_id": "MDU6SXNzdWUyMjI0MzcwNDM=", "number": 41366, "title": "Invalid closure lifetime inference", "user": {"login": "phaylon", "id": 41822, "node_id": "MDQ6VXNlcjQxODIy", "avatar_url": "https://avatars.githubusercontent.com/u/41822?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phaylon", "html_url": "https://github.com/phaylon", "followers_url": "https://api.github.com/users/phaylon/followers", "following_url": "https://api.github.com/users/phaylon/following{/other_user}", "gists_url": "https://api.github.com/users/phaylon/gists{/gist_id}", "starred_url": "https://api.github.com/users/phaylon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phaylon/subscriptions", "organizations_url": "https://api.github.com/users/phaylon/orgs", "repos_url": "https://api.github.com/users/phaylon/repos", "events_url": "https://api.github.com/users/phaylon/events{/privacy}", "received_events_url": "https://api.github.com/users/phaylon/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1775993, "node_id": "MDU6TGFiZWwxNzc1OTkz", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-lifetimes", "name": "A-lifetimes", "color": "f7e101", "default": false, "description": "Area: lifetime related"}, {"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 46741598, "node_id": "MDU6TGFiZWw0Njc0MTU5OA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-needs-test", "name": "E-needs-test", "color": "02e10c", "default": false, "description": "Call for participation: writing correctness tests"}, {"id": 122406831, "node_id": "MDU6TGFiZWwxMjI0MDY4MzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-closures", "name": "A-closures", "color": "f7e101", "default": false, "description": "Area: closures (`|args| { .. }`)"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 604454086, "node_id": "MDU6TGFiZWw2MDQ0NTQwODY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-inference", "name": "A-inference", "color": "f7e101", "default": false, "description": "Area: Type inference"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2017-04-18T14:33:08Z", "updated_at": "2019-10-23T13:34:22Z", "closed_at": "2019-10-23T13:34:22Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I'm experimenting with a parser combinator and ran into an issue with closure lifetime inference.\r\n\r\nThis might be a duplicate of #39943, since it uses a similar (but simpler) mechanism to produce the same error message. However, in the code below the error is potentially a lot further away, and since I need to return values from the closure I'm having trouble finding any way to make it work by explicitly specifying a signature. Since it involves more moving parts, I'm also not sure how to confirm if the underlying issue is the same.\r\n\r\nI removed all parts that aren't involved in triggering the error message (the original use case has trait methods with related return types).\r\n\r\nIt comes down to the following error message:\r\n```\r\nrustc 1.16.0 (30cf806ef 2017-03-10)\r\nerror: `content` does not live long enough\r\n  --> <anon>:64:1\r\n   |\r\n62 |         let _ = apply(&content, parser);\r\n   |                        ------- borrow occurs here\r\n63 |     };\r\n64 | }\r\n   | ^ `content` dropped here while still borrowed\r\n   |\r\n   = note: values in a scope are dropped in the opposite order they are created\r\n\r\nerror: aborting due to previous error\r\n```\r\n\r\nAnd here is the triggering code:\r\n```\r\ntrait Parse<'input> {\r\n\r\n    type Output;\r\n}\r\n\r\n// needs one parser which has its Output depending on the input\r\nstruct AnyParser;\r\n\r\nimpl<'input> Parse<'input>\r\nfor AnyParser {\r\n\r\n    type Output = &'input str;\r\n}\r\n\r\n// also needs another parser taking a closure that takes a subparsers\r\n// result\r\nfn fold<P, I, F>(parser: P, init: I, fold: F) -> Fold<P, I, F>\r\n{\r\n    Fold {\r\n        parser: parser,\r\n        init: init,\r\n        fold: fold,\r\n    }\r\n}\r\n\r\nstruct Fold<P, I, F> {\r\n    parser: P,\r\n    init: I,\r\n    fold: F,\r\n}\r\n\r\nimpl<'input, P, I, F, T> Parse<'input>\r\nfor Fold<P, I, F>\r\nwhere\r\n    P: Parse<'input>,\r\n    I: Fn() -> T,\r\n    F: Fn(T, P::Output) -> T,\r\n{\r\n    type Output = T;\r\n}\r\n\r\n// taking the content and the parser together\r\nfn apply<'input, P>(input: &'input str, parser: P)\r\nwhere\r\n    P: Parse<'input>,\r\n{\r\n    unimplemented!();\r\n}\r\n\r\nfn main() {\r\n    let parser = fold(\r\n        AnyParser,\r\n        // these closures seems to make it think the parser holds on to\r\n        // the AnyParser result (which is part of the input)\r\n        || None,\r\n        |_, v| Some(v),\r\n    );\r\n    // rustc says this must outlive the parser, which is unfortunate\r\n    let content: String = \"foo\".into();\r\n    {\r\n        let _ = apply(&content, parser);\r\n    };\r\n}\r\n```", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/41366/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/41366/timeline", "performed_via_github_app": null, "state_reason": "completed"}