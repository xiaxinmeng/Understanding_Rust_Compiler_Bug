{"url": "https://api.github.com/repos/rust-lang/rust/issues/12455", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/12455/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/12455/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/12455/events", "html_url": "https://github.com/rust-lang/rust/issues/12455", "id": 28080426, "node_id": "MDU6SXNzdWUyODA4MDQyNg==", "number": 12455, "title": "Investigate placing modules in separate object sections", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2014-02-21T23:10:20Z", "updated_at": "2017-02-08T15:43:34Z", "closed_at": "2014-05-21T03:36:32Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Rust's linkage model means that crates compile to one object file. Linkers today will pull in an entire object file if any symbol from it is used during linkage. This means that if you link to the standard library that you're pulling in the entire library no matter what. This can be circumvented with LTO, but that requires a lot of work on LLVM's part and takes a significant amount of time. \n\nI believe that we can get similar gains through `--gc-sections` (`-dead_strip` on osx). All of our object code is emitted to the same section, so this flag currently doesn't eliminate much code. Issue #12140 proposed turning `-ffunction-sections` on by default, but this causes object size bloat as well as slowing down link times for small crates. \n\nI believe that we may be able to strike a compromise by placing each _module_'s functions in their own section. This reduces the number of sections from thousands to dozens, with the sections being much larger. In this manner, in theory if you don't use any functions from the `std::f64` module the entire module can be omitted from linkage.\n\nI would like to investigate the impact of turning these features on _by default_ for all rust compilations. Concretely, this involves two steps:\n1. Instruct LLVM to place each function in a section corresponding to the enclosing module's name.\n2. Pass `-Wl,--gc-sections` to the linker by default (`-Wl,-dead_strip` on osx). Also add `-C no-gc-sections` to turn off passing this flag.\n\nNote that I think we need to be careful to ensure that the linker doesn't GC away metadata for dylibs, but other than that I believe rust code can safely run with `--gc-sections` for now.\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/12455/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/12455/timeline", "performed_via_github_app": null, "state_reason": "completed"}