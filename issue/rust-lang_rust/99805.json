{"url": "https://api.github.com/repos/rust-lang/rust/issues/99805", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/99805/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/99805/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/99805/events", "html_url": "https://github.com/rust-lang/rust/issues/99805", "id": 1319469825, "node_id": "I_kwDOAAsO6M5OpYMB", "number": 99805, "title": "Improve `VecDeque` implementation", "user": {"login": "joboet", "id": 25721079, "node_id": "MDQ6VXNlcjI1NzIxMDc5", "avatar_url": "https://avatars.githubusercontent.com/u/25721079?v=4", "gravatar_id": "", "url": "https://api.github.com/users/joboet", "html_url": "https://github.com/joboet", "followers_url": "https://api.github.com/users/joboet/followers", "following_url": "https://api.github.com/users/joboet/following{/other_user}", "gists_url": "https://api.github.com/users/joboet/gists{/gist_id}", "starred_url": "https://api.github.com/users/joboet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/joboet/subscriptions", "organizations_url": "https://api.github.com/users/joboet/orgs", "repos_url": "https://api.github.com/users/joboet/repos", "events_url": "https://api.github.com/users/joboet/events{/privacy}", "received_events_url": "https://api.github.com/users/joboet/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 25, "created_at": "2022-07-27T12:09:36Z", "updated_at": "2022-12-23T16:09:04Z", "closed_at": "2022-12-23T16:09:03Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "`VecDeque` currently allocates one extra empty element because it needs to discern between an empty and full queue. Besides wasting memory, this means `VecDeque::new` cannot currently be `const`.\r\n\r\n## Solution\r\n\r\nThe most elegant solution would be to reimplement `VecDeque` based off the (third) technique described by Juho Snellman [in this blog post](https://www.snellman.net/blog/archive/2016-12-13-ring-buffers/). In this implementation, the buffer indexes are not clamped to the buffer size, but instead use the whole range of `usize`. Only when accessing an element are they masked to fit. The length of the buffer is defined by the wrapping distance between the two indexes. By limiting the capacity to values smaller than `isize::MAX` (which Rust's memory model dictates anyway), an empty queue (with `head == tail`) is strictly different from a full queue (where `head - tail == capacity`). \r\n\r\nIn the described implementation, the capacity is always be a power of two so that wrapping arithmetic can be used. This is great for performance and simplifies the implementation, but may result in significant unused memory when a large but precise capacity is required. Therefore, Eli Dupree [proposed](https://internals.rust-lang.org/t/vecdeque-allow-len-cap-to-make-full-usage-of-memory-in-the-rawvec/16363/6) a variation where the indexes are kept smaller than `2 * capacity` using modular arithmetic, which would relax the above requirement but incur higher runtime cost since the more expensive modular arithmetic needs to be used. \r\n\r\n## Links and related work\r\n\r\n* [Previous discussion](https://internals.rust-lang.org/t/vecdeque-allow-len-cap-to-make-full-usage-of-memory-in-the-rawvec/16363) on Rust Internals\r\n\r\n@rustbot label +T-libs +T-libs-api", "closed_by": {"login": "joboet", "id": 25721079, "node_id": "MDQ6VXNlcjI1NzIxMDc5", "avatar_url": "https://avatars.githubusercontent.com/u/25721079?v=4", "gravatar_id": "", "url": "https://api.github.com/users/joboet", "html_url": "https://github.com/joboet", "followers_url": "https://api.github.com/users/joboet/followers", "following_url": "https://api.github.com/users/joboet/following{/other_user}", "gists_url": "https://api.github.com/users/joboet/gists{/gist_id}", "starred_url": "https://api.github.com/users/joboet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/joboet/subscriptions", "organizations_url": "https://api.github.com/users/joboet/orgs", "repos_url": "https://api.github.com/users/joboet/repos", "events_url": "https://api.github.com/users/joboet/events{/privacy}", "received_events_url": "https://api.github.com/users/joboet/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/99805/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/99805/timeline", "performed_via_github_app": null, "state_reason": "completed"}