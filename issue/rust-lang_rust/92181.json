{"url": "https://api.github.com/repos/rust-lang/rust/issues/92181", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/92181/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/92181/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/92181/events", "html_url": "https://github.com/rust-lang/rust/issues/92181", "id": 1086256567, "node_id": "I_kwDOAAsO6M5AvvW3", "number": 92181, "title": "rustc should specify `SHT_INIT_ARRAY` for its `init_array` section", "user": {"login": "adetaylor", "id": 145740, "node_id": "MDQ6VXNlcjE0NTc0MA==", "avatar_url": "https://avatars.githubusercontent.com/u/145740?v=4", "gravatar_id": "", "url": "https://api.github.com/users/adetaylor", "html_url": "https://github.com/adetaylor", "followers_url": "https://api.github.com/users/adetaylor/followers", "following_url": "https://api.github.com/users/adetaylor/following{/other_user}", "gists_url": "https://api.github.com/users/adetaylor/gists{/gist_id}", "starred_url": "https://api.github.com/users/adetaylor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/adetaylor/subscriptions", "organizations_url": "https://api.github.com/users/adetaylor/orgs", "repos_url": "https://api.github.com/users/adetaylor/repos", "events_url": "https://api.github.com/users/adetaylor/events{/privacy}", "received_events_url": "https://api.github.com/users/adetaylor/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2021-12-21T21:50:03Z", "updated_at": "2022-02-04T20:02:33Z", "closed_at": "2022-01-04T08:52:04Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "This recent commit to [`lld` broke Rust programs which used that linker](https://github.com/llvm/llvm-project/commit/21dbfd430021cc8f4270daaec15897b023a5cacc). That's because it discards sections entitled `.init_array` unless they are labeled with the correct section type, `SHT_INIT_ARRAY`.\r\n\r\nRust programs continued to link and run successfully, but couldn't see their command-line arguments (`std::env::args` would return nothing) because [the Rust standard library relies on usage of `.init_array` to retrieve those arguments](https://github.com/rust-lang/rust/blob/master/library/std/src/sys/unix/args.rs#L109). This section was `SHT_PROGBITS` rather than `SHT_INIT_ARRAY` so was discarded.\r\n\r\nThis `lld` change has now been [undone](https://github.com/llvm/llvm-project/commit/48161b7490e4aa174faf2b0e840e743a3ee56a4a) but my understanding from the LLVM folks (specifically @MaskRay) is that this is temporary.\r\n\r\nTo fix this to the satisfaction of the LLVM folks, rustc would need to set the section type correctly using `llvm::MCContext::getELFSection`. Unfortunately, that isn't currently exposed via LLVM's C API (as far as I can tell), so an LLVM change would first be needed to expose it.\r\n\r\nAfter that, we'd need to decide whether to expose the section type ID via [something like a new `#[link_section_type]` attribute](https://doc.rust-lang.org/reference/abi.html#the-link_section-attribute) or whether we'd simply hard-code the section type ID for certain well-known sections such as this.\r\n\r\nNB I am not personally an LLVM person so forgive me if I've misunderstood the layering of LLVM APIs or similar. I just did a bit of the investigation here to understand why my command-line cupboard was bare.\r\n\r\nRelated issues:\r\n* [Go issue](https://golang.org/issue/50295)\r\n* [Our investigation within Chromium](https://bugs.chromium.org/p/chromium/issues/detail?id=1281664)", "closed_by": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/92181/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/92181/timeline", "performed_via_github_app": null, "state_reason": "completed"}