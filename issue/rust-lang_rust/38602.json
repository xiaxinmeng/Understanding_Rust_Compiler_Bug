{"url": "https://api.github.com/repos/rust-lang/rust/issues/38602", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/38602/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/38602/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/38602/events", "html_url": "https://github.com/rust-lang/rust/issues/38602", "id": 197509624, "node_id": "MDU6SXNzdWUxOTc1MDk2MjQ=", "number": 38602, "title": "Weird error with inline assemby (invalid operand for inline asm constraint 'i')", "user": {"login": "DominusCarnufex", "id": 18592176, "node_id": "MDQ6VXNlcjE4NTkyMTc2", "avatar_url": "https://avatars.githubusercontent.com/u/18592176?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DominusCarnufex", "html_url": "https://github.com/DominusCarnufex", "followers_url": "https://api.github.com/users/DominusCarnufex/followers", "following_url": "https://api.github.com/users/DominusCarnufex/following{/other_user}", "gists_url": "https://api.github.com/users/DominusCarnufex/gists{/gist_id}", "starred_url": "https://api.github.com/users/DominusCarnufex/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DominusCarnufex/subscriptions", "organizations_url": "https://api.github.com/users/DominusCarnufex/orgs", "repos_url": "https://api.github.com/users/DominusCarnufex/repos", "events_url": "https://api.github.com/users/DominusCarnufex/events{/privacy}", "received_events_url": "https://api.github.com/users/DominusCarnufex/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2016-12-25T17:42:03Z", "updated_at": "2016-12-26T13:58:43Z", "closed_at": "2016-12-26T13:58:43Z", "author_association": "NONE", "active_lock_reason": null, "body": "The following code\r\n\r\n```rust\r\n#![crate_type=\"rlib\"]\r\n#![crate_name = \"rsc\"]\r\n#![feature(asm)]\r\n\r\npub enum MyEnum {\r\n    Value1,\r\n    Value2,\r\n}\r\n\r\nimpl MyEnum {\r\n    pub fn method(&self)    {\r\n        unsafe  {\r\n            asm!(\"mov rax, $0\"\r\n                : \r\n                : \"i\"(u64::from(self))\r\n                : \r\n                : \"intel\", \"volatile\"\r\n            );\r\n        }\r\n    }\r\n}\r\n\r\nimpl<'a> From<&'a MyEnum> for u64   {\r\n    fn from(s : &MyEnum) -> u64 {\r\n        match *s    {\r\n            MyEnum::Value1 => 0x1,\r\n            MyEnum::Value2 => 0x2,\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nfails to compile with the following error\r\n\r\n```\r\nerror: invalid operand for inline asm constraint 'i'\r\n  --> lib.rs:13:13\r\n   |\r\n13 |               asm!(\"mov rax, $0\"\r\n   |  _____________^ starting here...\r\n14 | |                 : \r\n15 | |                 : \"i\"(u64::from(self))\r\n16 | |                 : \r\n17 | |                 : \"intel\", \"volatile\"\r\n18 | |             );\r\n   | |______________^ ...ending here\r\n```\r\n\r\nWhat is weird is :\r\n\r\n1. Everything works perfectly fine with `#![crate_type=\"bin\"]` and `#![crate_type=\"staticlib\"]` but fails with `#![crate_type=\"rlib\"]` and `#![crate_type=\"dylib\"]`.\r\n2. If there is only one variant in the enumeration, it compiles fine.\r\n3. If you replace `\"i\"(u64::from(self))` with `\"i\"(0x1)`, it compiles fine.\r\n4. If you replace the method `MyEnum::method` by the following function, it compiles fine\r\n\r\n```rust\r\nfn function(param : MyEnum) {\r\n    unsafe  {\r\n        asm!(\"mov rax, $0\"\r\n            : \r\n            : \"i\"(u64::from(&param))\r\n            : \r\n            : \"intel\", \"volatile\"\r\n        );\r\n    }\r\n}\r\n```\r\n\r\n5. If you replace the body of `MyEnum::method` with the following code, it fails too.\r\n\r\n```rust\r\n        let param : u64 = u64::from(self);\r\n\r\n        unsafe  {\r\n            asm!(\"mov rax, $0\"\r\n                : \r\n                : \"i\"(param)\r\n                : \r\n                : \"intel\", \"volatile\"\r\n            );\r\n        }\r\n```\r\n\r\nAny idea what\u2019s going on ?", "closed_by": {"login": "DominusCarnufex", "id": 18592176, "node_id": "MDQ6VXNlcjE4NTkyMTc2", "avatar_url": "https://avatars.githubusercontent.com/u/18592176?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DominusCarnufex", "html_url": "https://github.com/DominusCarnufex", "followers_url": "https://api.github.com/users/DominusCarnufex/followers", "following_url": "https://api.github.com/users/DominusCarnufex/following{/other_user}", "gists_url": "https://api.github.com/users/DominusCarnufex/gists{/gist_id}", "starred_url": "https://api.github.com/users/DominusCarnufex/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DominusCarnufex/subscriptions", "organizations_url": "https://api.github.com/users/DominusCarnufex/orgs", "repos_url": "https://api.github.com/users/DominusCarnufex/repos", "events_url": "https://api.github.com/users/DominusCarnufex/events{/privacy}", "received_events_url": "https://api.github.com/users/DominusCarnufex/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/38602/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/38602/timeline", "performed_via_github_app": null, "state_reason": "completed"}