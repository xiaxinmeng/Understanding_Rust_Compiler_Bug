{"url": "https://api.github.com/repos/rust-lang/rust/issues/85714", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/85714/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/85714/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/85714/events", "html_url": "https://github.com/rust-lang/rust/issues/85714", "id": 901989088, "node_id": "MDU6SXNzdWU5MDE5ODkwODg=", "number": 85714, "title": "Should `improper_ctypes_definitions` lint warn against boxed DST?", "user": {"login": "marmeladema", "id": 1629419, "node_id": "MDQ6VXNlcjE2Mjk0MTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1629419?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marmeladema", "html_url": "https://github.com/marmeladema", "followers_url": "https://api.github.com/users/marmeladema/followers", "following_url": "https://api.github.com/users/marmeladema/following{/other_user}", "gists_url": "https://api.github.com/users/marmeladema/gists{/gist_id}", "starred_url": "https://api.github.com/users/marmeladema/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marmeladema/subscriptions", "organizations_url": "https://api.github.com/users/marmeladema/orgs", "repos_url": "https://api.github.com/users/marmeladema/repos", "events_url": "https://api.github.com/users/marmeladema/events{/privacy}", "received_events_url": "https://api.github.com/users/marmeladema/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-05-26T08:26:11Z", "updated_at": "2021-06-05T00:59:03Z", "closed_at": "2021-06-05T00:59:03Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Given the following code: <!-- Please provide a link to play.rust-lang.org -->\r\n\r\n```rust\r\n#![deny(improper_ctypes_definitions)]\r\n\r\n#[no_mangle]\r\npub extern \"C\" fn test_boxed_str() -> Box<str> {\r\n    \"test_boxed_str\".into()\r\n}\r\n\r\n#[no_mangle]\r\npub extern \"C\" fn test_boxed_slice() -> Box<[u8]> {\r\n    b\"test_boxed_slice\"[..].into()\r\n}\r\n```\r\n\r\nPlayground link: https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=dfca164488b7561826bbb61ee137b6bc\r\n\r\nThe current output is:\r\n\r\n* It compiles successfully\r\n\r\n<!-- The following is not always necessary. -->\r\nIdeally the output should look like:\r\n\r\n```\r\nwarning: `extern` fn uses type `Box<str>`, which is not FFI-safe\r\n  --> src/lib.rs:24:32\r\n   |\r\n24 | pub extern \"C\" fn test_boxed_str() -> Box<str> {\r\n   |                                       ^^^^^^^^ not FFI-safe\r\n   |\r\n   = note: `#[warn(improper_ctypes_definitions)]` on by default\r\n   = help: consider adding a `#[repr(C)]` or `#[repr(transparent)]` attribute to this struct\r\n   = note: this struct has unspecified layout\r\n```\r\n\r\nFrom what I understand, fat pointers layout is not stable and should not be relied upon, pretty much in the same way that relying on the layout of a `#[repr(rust)]` type is an internal decision to the compiler. If they are now considered stable ABI, then the current lint is fine.\r\n\r\nBut in any case, I believe the documentation at https://doc.rust-lang.org/std/boxed/index.html#memory-layout could probably be enhanced to speak more about DST. Either to say they should be avoided because the memory layout is not stable, or to explicitly document that it is and makes this a commitment from the compiler.\r\n\r\nIf those arguments are compelling and the compiler team agrees to those changes, I am willing to implement them, providing a little bit of mentoring from someone :+1: ", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/85714/reactions", "total_count": 4, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 1, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/85714/timeline", "performed_via_github_app": null, "state_reason": "completed"}