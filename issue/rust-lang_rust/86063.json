{"url": "https://api.github.com/repos/rust-lang/rust/issues/86063", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/86063/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/86063/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/86063/events", "html_url": "https://github.com/rust-lang/rust/issues/86063", "id": 912860949, "node_id": "MDU6SXNzdWU5MTI4NjA5NDk=", "number": 86063, "title": "i128 multiplication on Cortex M0+ unconditionally causes overflow in bitshift causing debug panic, when codegen-units = 1", "user": {"login": "nickmertin", "id": 14988409, "node_id": "MDQ6VXNlcjE0OTg4NDA5", "avatar_url": "https://avatars.githubusercontent.com/u/14988409?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nickmertin", "html_url": "https://github.com/nickmertin", "followers_url": "https://api.github.com/users/nickmertin/followers", "following_url": "https://api.github.com/users/nickmertin/following{/other_user}", "gists_url": "https://api.github.com/users/nickmertin/gists{/gist_id}", "starred_url": "https://api.github.com/users/nickmertin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nickmertin/subscriptions", "organizations_url": "https://api.github.com/users/nickmertin/orgs", "repos_url": "https://api.github.com/users/nickmertin/repos", "events_url": "https://api.github.com/users/nickmertin/events{/privacy}", "received_events_url": "https://api.github.com/users/nickmertin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 108333, "node_id": "MDU6TGFiZWwxMDgzMzM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-LLVM", "name": "A-LLVM", "color": "f7e101", "default": false, "description": "Area: Code generation parts specific to LLVM. Both correctness bugs and optimization-related issues."}, {"id": 55301954, "node_id": "MDU6TGFiZWw1NTMwMTk1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-Arm", "name": "O-Arm", "color": "6e6ec0", "default": false, "description": "Target: 32-bit Arm processors (armv6, armv7, thumb...), including 64-bit Arm in AArch32 state"}, {"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 262252628, "node_id": "MDU6TGFiZWwyNjIyNTI2Mjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-beta", "name": "regression-from-stable-to-beta", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to beta."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/rust-lang/rust/milestones/82", "html_url": "https://github.com/rust-lang/rust/milestone/82", "labels_url": "https://api.github.com/repos/rust-lang/rust/milestones/82/labels", "id": 6717076, "node_id": "MDk6TWlsZXN0b25lNjcxNzA3Ng==", "number": 82, "title": "1.54.0", "description": null, "creator": {"login": "rustbot", "id": 47979223, "node_id": "MDQ6VXNlcjQ3OTc5MjIz", "avatar_url": "https://avatars.githubusercontent.com/u/47979223?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rustbot", "html_url": "https://github.com/rustbot", "followers_url": "https://api.github.com/users/rustbot/followers", "following_url": "https://api.github.com/users/rustbot/following{/other_user}", "gists_url": "https://api.github.com/users/rustbot/gists{/gist_id}", "starred_url": "https://api.github.com/users/rustbot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rustbot/subscriptions", "organizations_url": "https://api.github.com/users/rustbot/orgs", "repos_url": "https://api.github.com/users/rustbot/repos", "events_url": "https://api.github.com/users/rustbot/events{/privacy}", "received_events_url": "https://api.github.com/users/rustbot/received_events", "type": "User", "site_admin": false}, "open_issues": 2, "closed_issues": 652, "state": "closed", "created_at": "2021-05-01T02:53:57Z", "updated_at": "2022-02-03T12:07:26Z", "due_on": null, "closed_at": "2021-08-17T19:06:49Z"}, "comments": 27, "created_at": "2021-06-06T15:18:19Z", "updated_at": "2021-08-02T04:59:08Z", "closed_at": "2021-08-02T04:59:08Z", "author_association": "NONE", "active_lock_reason": null, "body": "Minimal reproducible example, targeting the STM32G030F6 microcontroller:\r\n\r\n```rs\r\n#![no_main]\r\n#![no_std]\r\n\r\nuse cortex_m_rt::entry;\r\nuse cortex_m_semihosting::*;\r\nuse panic_semihosting as _;\r\nuse stm32g0xx_hal as _;\r\n\r\n#[entry]\r\nfn main() -> ! {\r\n    let x = dbg!(1i128);\r\n    dbg!(x * x);\r\n    loop {}\r\n}\r\n```\r\n\r\nThis panics in the computation of `x * x` when built with:\r\n\r\n```toml\r\n[profile.dev]\r\ncodegen-units = 1\r\nopt-level = 1 # to fit in size\r\n```\r\n\r\nNote: this had to be tested with `opt-level = 1` in the dev profile, in order to fit on the small flash size on the chip. This was confirmed on the `nightly-2021-05-22` and `nightly-2021-06-05` toolchains.\r\n\r\n<details>\r\n<summary>GDB backtrace at the panic</summary>\r\n\r\n```\r\n#0  panic_semihosting::panic (info=0x20001bc8) at /home/nmertin/.cargo/registry/src/github.com-1ecc6299db9ec823/panic-semihosting-0.5.6/src/lib.rs:79\r\n#1  0x08001098 in core::panicking::panic_fmt (fmt=...)\r\n    at /home/nmertin/.rustup/toolchains/nightly-2021-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:92\r\n#2  0x0800107a in core::panicking::panic (expr=...)\r\n    at /home/nmertin/.rustup/toolchains/nightly-2021-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:50\r\n#3  0x0800332a in core::ops::bit::{{impl}}::shl (self=<optimized out>, other=<optimized out>)\r\n    at /home/nmertin/.rustup/toolchains/nightly-2021-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/bit.rs:459\r\n#4  0x0800394a in compiler_builtins::int::shift::Ashl::ashl<u64> (self=<optimized out>, shl=4294967264)\r\n    at /home/nmertin/.cargo/registry/src/github.com-1ecc6299db9ec823/compiler_builtins-0.1.43/src/int/shift.rs:9\r\n#5  0x08004642 in compiler_builtins::int::shift::__ashldi3 (a=2305873692996934600, b=134241300)\r\n    at /home/nmertin/.cargo/registry/src/github.com-1ecc6299db9ec823/compiler_builtins-0.1.43/src/int/shift.rs:80\r\n#6  0x0800464c in compiler_builtins::int::shift::__aeabi_llsl::__aeabi_llsl (a=2305873692996934600, b=134241300)\r\n    at /home/nmertin/.cargo/registry/src/github.com-1ecc6299db9ec823/compiler_builtins-0.1.43/src/macros.rs:226\r\n#7  0x08003456 in core::ops::bit::{{impl}}::shl (self=536878024, other=32)\r\n    at /home/nmertin/.rustup/toolchains/nightly-2021-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/bit.rs:459\r\n#8  0x08003680 in compiler_builtins::int::mul::Mul::mul<i128> (self=0, rhs=<optimized out>)\r\n    at /home/nmertin/.cargo/registry/src/github.com-1ecc6299db9ec823/compiler_builtins-0.1.43/src/int/mul.rs:22\r\n#9  0x08004564 in compiler_builtins::int::mul::__multi3 (a=10635484907954590928331707261963475912, b=<optimized out>)\r\n    at /home/nmertin/.cargo/registry/src/github.com-1ecc6299db9ec823/compiler_builtins-0.1.43/src/int/mul.rs:108\r\n#10 0x08004582 in compiler_builtins::int::mul::__multi3::__multi3 (a=10635484907954590928331707261963475912, b=<optimized out>)\r\n    at /home/nmertin/.cargo/registry/src/github.com-1ecc6299db9ec823/compiler_builtins-0.1.43/src/macros.rs:270\r\n#11 0x08001e26 in core::fmt::num::udiv_1e19 (n=<optimized out>)\r\n    at /home/nmertin/.rustup/toolchains/nightly-2021-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/num.rs:663\r\n#12 0x08001c1c in core::fmt::num::fmt_u128 (n=2305873692460056577, is_nonnegative=<optimized out>, f=0x20001e88)\r\n    at /home/nmertin/.rustup/toolchains/nightly-2021-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/num.rs:599\r\n#13 0x08001bfc in core::fmt::num::{{impl}}::fmt (self=<optimized out>, f=0x1)\r\n    at /home/nmertin/.rustup/toolchains/nightly-2021-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/num.rs:586\r\n#14 0x08000156 in core::fmt::num::{{impl}}::fmt (self=0x20001f98, f=0x20001e88)\r\n    at /home/nmertin/.rustup/toolchains/nightly-2021-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/num.rs:191\r\n#15 0x08000106 in core::fmt::{{impl}}::fmt<i128> (self=<optimized out>, f=0x20001be8)\r\n    at /home/nmertin/.rustup/toolchains/nightly-2021-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/mod.rs:2030\r\n#16 0x080021e4 in core::fmt::run (fmt=0x20001e88, arg=0x8004a08, args=...)\r\n    at /home/nmertin/.rustup/toolchains/nightly-2021-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/mod.rs:1155\r\n#17 0x080020a8 in core::fmt::write (output=..., args=...)\r\n    at /home/nmertin/.rustup/toolchains/nightly-2021-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/mod.rs:1123\r\n#18 0x08000494 in core::fmt::Write::write_fmt<cortex_m_semihosting::hio::HStderr> (self=0x20000004 <cortex_m_semihosting::export::HSTDERR+4>, args=...)\r\n    at /home/nmertin/.rustup/toolchains/nightly-2021-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/mod.rs:184\r\n#19 0x08000810 in cortex_m_semihosting::export::hstderr_fmt::{{closure}} ()\r\n    at /home/nmertin/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-semihosting-0.3.7/src/export.rs:49\r\n#20 0x08000796 in cortex_m::interrupt::free<closure-0,core::result::Result<(), ()>> (f=...)\r\n    at /home/nmertin/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-0.7.2/src/interrupt.rs:64\r\n#21 0x080007ca in cortex_m_semihosting::export::hstderr_fmt (args=...)\r\n    at /home/nmertin/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-semihosting-0.3.7/src/export.rs:44\r\n#22 0x0800021e in interface_firmware::__cortex_m_rt_main () at src/main.rs:32\r\n#23 0x080001b0 in interface_firmware::__cortex_m_rt_main_trampoline () at src/main.rs:30\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary>Full Cargo.toml to build</summary>\r\n\r\n```toml\r\n[package]\r\nname = \"interface-firmware\"\r\nversion = \"0.1.0\"\r\nreadme = \"README.md\"\r\nauthors = [\"Nick Mertin <nickmertin@gmail.com>\"]\r\nedition = \"2018\"\r\n\r\n[dependencies]\r\ncortex-m-semihosting = \"0.3.3\"\r\ncortex-m-rt = \"0.6.14\"\r\npanic-semihosting = \"0.5.6\"\r\n\r\n[dependencies.stm32g0xx-hal]\r\nversion = \"0.1.0\"\r\ndefault-features = false\r\nfeatures = [\"stm32g030\", \"rt\"]\r\n\r\n[profile.dev]\r\ncodegen-units = 1\r\nopt-level = 1 # to fit in size\r\n\r\n[profile.release]\r\ncodegen-units = 1\r\ndebug = true\r\nlto = true\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary>memory.x for the STM32G030F6</summary>\r\n\r\n```\r\nMEMORY\r\n{\r\n    FLASH : ORIGIN = 0x08000000, LENGTH = 32K\r\n    RAM : ORIGIN = 0x20000000, LENGTH = 8K\r\n}\r\n```\r\n</details>", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/86063/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/86063/timeline", "performed_via_github_app": null, "state_reason": "completed"}