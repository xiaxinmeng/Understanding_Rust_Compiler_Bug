{"url": "https://api.github.com/repos/rust-lang/rust/issues/85354", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/85354/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/85354/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/85354/events", "html_url": "https://github.com/rust-lang/rust/issues/85354", "id": 892573213, "node_id": "MDU6SXNzdWU4OTI1NzMyMTM=", "number": 85354, "title": "strong performance issue when using struct instead of multiple variables", "user": {"login": "ZuseZ4", "id": 25483084, "node_id": "MDQ6VXNlcjI1NDgzMDg0", "avatar_url": "https://avatars.githubusercontent.com/u/25483084?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ZuseZ4", "html_url": "https://github.com/ZuseZ4", "followers_url": "https://api.github.com/users/ZuseZ4/followers", "following_url": "https://api.github.com/users/ZuseZ4/following{/other_user}", "gists_url": "https://api.github.com/users/ZuseZ4/gists{/gist_id}", "starred_url": "https://api.github.com/users/ZuseZ4/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ZuseZ4/subscriptions", "organizations_url": "https://api.github.com/users/ZuseZ4/orgs", "repos_url": "https://api.github.com/users/ZuseZ4/repos", "events_url": "https://api.github.com/users/ZuseZ4/events{/privacy}", "received_events_url": "https://api.github.com/users/ZuseZ4/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 113376, "node_id": "MDU6TGFiZWwxMTMzNzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-slow", "name": "I-slow", "color": "e10c02", "default": false, "description": "Problems and improvements with respect to performance of generated code."}, {"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 23, "created_at": "2021-05-16T01:29:47Z", "updated_at": "2022-06-03T15:29:39Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I ran into an issue when working on a prime sieve.\r\nI grouped three related variables (two arrays and an integer) into a struct to have less variables being passed around.\r\nWhile profiling I noticed that the execution time went up from 2.8s to 7s when using the struct.\r\nBased on some Discord hint\u00b4s I guess that shouldn\u00b4t be the case: https://discord.com/channels/273534239310479360/273541522815713281/843272480852672513\r\n\r\nHere is my actual struct:\r\n```Rust\r\npub struct Aux {\r\n    pub sieve: [u64;_AUX_SIEVE_WORDS_ as usize], \r\n    pub primes: [u32;_NUMBER_OF_AUX_PRIMES_],\r\n    pub base: u32,\r\n}\r\n```\r\nI created a gh repo, showing the different versions: https://github.com/ZuseZ4/perf_comp\r\n\r\nBranch with_struct: I\u00b4m passing the struct by ref => 7s\r\nBranch no_struct: I\u00b4m passing both arrays by ref, integer by value => 2.8s\r\nBranch no_struct_ref: I\u00b4m passing both arrays and the integer by ref => 2.8s\r\n\r\n**Setup:**\r\nI use release mode, lto=true and target=native. (The last two seem to have no effect.)\r\nrustc 1.52.1 (9bc8c42 2021-05-09)\r\n(1.54.0-nightly (fe72845f7 2021-05-16) gives the same performance)\r\nUbuntu 20.04 (5.4.0-73-generic)\r\nAMD\u00ae Athlon 200ge with 2x16 GB DDR4-3200\r\n\r\nI could understand that an extra layer of indirection and therefore (if not removed by optimizations) pointer deref. could cause some performance cost, but I\u00b4m surprised about the large difference. \r\n\r\nDid I miss something?", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/85354/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/85354/timeline", "performed_via_github_app": null, "state_reason": null}