{"url": "https://api.github.com/repos/rust-lang/rust/issues/108059", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/108059/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/108059/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/108059/events", "html_url": "https://github.com/rust-lang/rust/issues/108059", "id": 1584693642, "node_id": "I_kwDOAAsO6M5edIGK", "number": 108059, "title": "std::sys::windows::rand::hashmap_random_keys() panics on some systems", "user": {"login": "marti4d", "id": 22406337, "node_id": "MDQ6VXNlcjIyNDA2MzM3", "avatar_url": "https://avatars.githubusercontent.com/u/22406337?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marti4d", "html_url": "https://github.com/marti4d", "followers_url": "https://api.github.com/users/marti4d/followers", "following_url": "https://api.github.com/users/marti4d/following{/other_user}", "gists_url": "https://api.github.com/users/marti4d/gists{/gist_id}", "starred_url": "https://api.github.com/users/marti4d/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marti4d/subscriptions", "organizations_url": "https://api.github.com/users/marti4d/orgs", "repos_url": "https://api.github.com/users/marti4d/repos", "events_url": "https://api.github.com/users/marti4d/events{/privacy}", "received_events_url": "https://api.github.com/users/marti4d/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2023-02-14T19:14:43Z", "updated_at": "2023-02-15T12:02:04Z", "closed_at": "2023-02-15T12:02:04Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Hi there,\r\n\r\nIn Issue #94098, Firefox was running into a problem where any use of `std::collections::HashMap` was causing a crash on the machines of some small subset of users.\r\n\r\nThe root cause is that `Bcrypt.dll` or `bcryptprimitives.dll` will fail to load on some machines, causing any attempt to generate random numbers to also fail, leading Rust `std` to panic. Note that this was a regression from previous `std` behavior, and was caused when `std` made the choice to move away from `RtlGenRandom` to BCrypt as its only source of randomness on Win32 in #84096.\r\n\r\nNote that this issue is likely not specific to Firefox -- It's likely any program written in Rust will have this exact same behavior on this small set of machines.\r\n\r\nAt this time, I had made PR #96917 to re-introduce `RtlGenRandom` as a \"fallback\" in case BCrypt failed to load.\r\n\r\nSince then, I see that PR #102044 attempted to re-remove `RtlGenRandom` and changed the fallback to use BCrypt as well. Starting with the release of this change, we are seeing crashes again in Firefox due to failing RNG on these machines. See [this Bug on Bugzilla](https://bugzilla.mozilla.org/show_bug.cgi?id=1788004#c16).\r\n\r\nIt appears that if BCrypt's primary provider is broken, the fallback will likely be broken as well.\r\n\r\nMy suggestion is that we should once-again re-introduce `RtlGenRandom()` as a fallback mechanism.\r\n\r\nThanks,\r\nChris", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/108059/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/108059/timeline", "performed_via_github_app": null, "state_reason": "completed"}