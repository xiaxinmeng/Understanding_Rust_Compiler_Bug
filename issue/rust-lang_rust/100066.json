{"url": "https://api.github.com/repos/rust-lang/rust/issues/100066", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/100066/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/100066/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/100066/events", "html_url": "https://github.com/rust-lang/rust/issues/100066", "id": 1326100398, "node_id": "I_kwDOAAsO6M5PCq-u", "number": 100066, "title": "`rustc --test` ignores `static:-whole-archive` link modifiers", "user": {"login": "dcsommer", "id": 1082656, "node_id": "MDQ6VXNlcjEwODI2NTY=", "avatar_url": "https://avatars.githubusercontent.com/u/1082656?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dcsommer", "html_url": "https://github.com/dcsommer", "followers_url": "https://api.github.com/users/dcsommer/followers", "following_url": "https://api.github.com/users/dcsommer/following{/other_user}", "gists_url": "https://api.github.com/users/dcsommer/gists{/gist_id}", "starred_url": "https://api.github.com/users/dcsommer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dcsommer/subscriptions", "organizations_url": "https://api.github.com/users/dcsommer/orgs", "repos_url": "https://api.github.com/users/dcsommer/repos", "events_url": "https://api.github.com/users/dcsommer/events{/privacy}", "received_events_url": "https://api.github.com/users/dcsommer/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2022-08-02T16:28:59Z", "updated_at": "2022-08-04T03:52:26Z", "closed_at": "2022-08-04T03:52:26Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I am attempting to use the ([now stabilized](https://github.com/rust-lang/rust/pull/93901)) [RFC 2951](https://rust-lang.github.io/rfcs/2951-native-link-modifiers.html) syntax to control how my test binary is compiled. I have created a repro at https://github.com/dcsommer/rustc-linking\r\n\r\n```\r\ngit clone https://github.com/dcsommer/rustc-linking.git\r\ncd rustc-linking\r\n./run.sh\r\n```\r\n\r\nIn `run.sh`, I tell `rustc` to link 2 static libraries, one *with* (+whole-archive) and one *without* (-whole-archive). I add a nonsense link argument so I can inspect the produced link line.\r\n\r\nI expect to see `libbar.a` linked without whole archive.\r\n\r\nInstead, I see both `foo` and `bar` libraries linked with --whole-archive:\r\n```\r\n-l static:+whole-archive=foo -l static:-whole-archive=bar\r\n# linker line yields ...\r\n\"-Wl,-Bstatic\" \"-Wl,--whole-archive\" \"-lfoo\" \"-Wl,--no-whole-archive\" \"-Wl,--whole-archive\" \"-lbar\" \"-Wl,--no-whole-archive\"\r\n```\r\n\r\nThis may be related to the default `+bundle` documented [here](https://rust-lang.github.io/rfcs/2951-native-link-modifiers.html#bundle). When I use nightly and specify `-bundle` it works as expected:\r\n\r\n```\r\n-l static:+whole-archive,-bundle=foo -l static:-whole-archive,-bundle=bar\r\n# linker line yields ...\r\n\"-Wl,-Bstatic\" \"-Wl,--whole-archive\" \"-lfoo\" \"-Wl,--no-whole-archive\" \"-lbar\"\r\n```\r\n\r\nHowever, I cannot use the nightly toolchain, so I cannot use `-bundle`, and `+bundle` seems inappropriate for a final binary crate types like cdylib, staticlib, and executables anyway.\r\n\r\nTested with 1.62.1 stable and 1.64 nightly.\r\n\r\nPossibly related issues: #99429, #73632", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/100066/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/100066/timeline", "performed_via_github_app": null, "state_reason": "completed"}