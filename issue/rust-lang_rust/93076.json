{"url": "https://api.github.com/repos/rust-lang/rust/issues/93076", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/93076/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/93076/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/93076/events", "html_url": "https://github.com/rust-lang/rust/issues/93076", "id": 1108098801, "node_id": "I_kwDOAAsO6M5CDD7x", "number": 93076, "title": "rust_2021_incompatible_closure_captures seems inconsistent", "user": {"login": "Alfred-Mountfield", "id": 25749103, "node_id": "MDQ6VXNlcjI1NzQ5MTAz", "avatar_url": "https://avatars.githubusercontent.com/u/25749103?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Alfred-Mountfield", "html_url": "https://github.com/Alfred-Mountfield", "followers_url": "https://api.github.com/users/Alfred-Mountfield/followers", "following_url": "https://api.github.com/users/Alfred-Mountfield/following{/other_user}", "gists_url": "https://api.github.com/users/Alfred-Mountfield/gists{/gist_id}", "starred_url": "https://api.github.com/users/Alfred-Mountfield/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Alfred-Mountfield/subscriptions", "organizations_url": "https://api.github.com/users/Alfred-Mountfield/orgs", "repos_url": "https://api.github.com/users/Alfred-Mountfield/repos", "events_url": "https://api.github.com/users/Alfred-Mountfield/events{/privacy}", "received_events_url": "https://api.github.com/users/Alfred-Mountfield/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2022-01-19T13:25:04Z", "updated_at": "2023-05-07T19:53:25Z", "closed_at": "2023-05-07T19:53:24Z", "author_association": "NONE", "active_lock_reason": null, "body": "Apologies if this is the wrong place to submit this, if it isn't the right place, could you point me as to where this would be appropriate?\r\n\r\nI've noticed some weird behavior related to when `rust_2021_incompatible_closure_captures` creates warnings.\r\n\r\nI tried to create a minimum viable example:\r\n```rust\r\n#![warn(rust_2021_compatibility)]\r\nuse std::sync::Arc;\r\n\r\npub struct Warns {\r\n    _test: Arc<String>, // Removing this Arc results in no warning\r\n    foo: String,\r\n}\r\n\r\nimpl Warns {\r\n    pub fn test(self) -> std::io::Result<()> {\r\n        let closure = move || {\r\n            let _ = self.foo;\r\n            Ok(())\r\n        };\r\n        closure()\r\n    }\r\n}\r\n```\r\n\r\nRunning that results in the following warning, however the warning isn't present when `_test` isn't wrapped in an `Arc`:\r\n```rust\r\nwarning: changes to closure capture in Rust 2021 will affect drop order\r\n  --> src/lib.rs:11:23\r\n   |\r\n11 |         let closure = move || {\r\n   |                       ^^^^^^^\r\n12 |             let _ = self.foo;\r\n   |                     ---- in Rust 2018, this causes the closure to capture `self`, but in Rust 2021, it has no effect\r\n...\r\n16 |     }\r\n   |     - in Rust 2018, `self` is dropped here along with the closure, but in Rust 2021 `self` is not part of the closure\r\n   |\r\n```\r\n\r\nThis is also reproducible [on the playground](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=603861161fe636612a7963d6cc231bf6)\r\n\r\nSome other users have tried this and said that warnings appear for `Box`/`Arc`/`Mutex` but not `Rc` or `Vec` for example. \r\n\r\n---\r\n\r\nIt's also worth noting that a related warning appears about dropping a field on `self` when accessing `self.foo.bar` or similar, but I didn't include in that example to avoid complicating it. ([Here is the equivalent code on the playground](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=851d2e79882e1475a37c5c2f825ec335))\r\n```rust\r\nwarning: changes to closure capture in Rust 2021 will affect drop order\r\n  --> src/lib.rs:15:23\r\n   |\r\n15 |         let closure = move || {\r\n   |                       ^^^^^^^\r\n16 |             let _ = Foo { bar: self.foo.bar };\r\n   |                                ------------ in Rust 2018, this closure captures all of `self`, but in Rust 2021, it will only capture `self.foo.bar`\r\n...\r\n22 |     }\r\n   |     - in Rust 2018, `self` is dropped here, but in Rust 2021, only `self.foo.bar` will be dropped here as part of the closure\r\n```\r\n\r\nThe preliminary thought is that it has something to do with the `Drop` trait.\r\n", "closed_by": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/93076/reactions", "total_count": 3, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 1}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/93076/timeline", "performed_via_github_app": null, "state_reason": "completed"}