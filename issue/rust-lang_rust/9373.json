{"url": "https://api.github.com/repos/rust-lang/rust/issues/9373", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/9373/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/9373/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/9373/events", "html_url": "https://github.com/rust-lang/rust/issues/9373", "id": 19847394, "node_id": "MDU6SXNzdWUxOTg0NzM5NA==", "number": 9373, "title": "RUST_THREADS=1 must stay with a single thread, which the runtime doesn't", "user": {"login": "glycerine", "id": 445247, "node_id": "MDQ6VXNlcjQ0NTI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/445247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/glycerine", "html_url": "https://github.com/glycerine", "followers_url": "https://api.github.com/users/glycerine/followers", "following_url": "https://api.github.com/users/glycerine/following{/other_user}", "gists_url": "https://api.github.com/users/glycerine/gists{/gist_id}", "starred_url": "https://api.github.com/users/glycerine/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/glycerine/subscriptions", "organizations_url": "https://api.github.com/users/glycerine/orgs", "repos_url": "https://api.github.com/users/glycerine/repos", "events_url": "https://api.github.com/users/glycerine/events{/privacy}", "received_events_url": "https://api.github.com/users/glycerine/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2013-09-21T00:05:42Z", "updated_at": "2013-10-17T02:53:40Z", "closed_at": "2013-10-17T02:53:40Z", "author_association": "NONE", "active_lock_reason": null, "body": "rustc 0.8-pre (570431f 2013-09-19 15:56:04 -0700)\n\nRUST_THREADS=1 must not allow the rust runtime to start a second thread, which it does now.  This is _really_ bad.\n\nBackground: If I wish to fork(2) and use the resulting image, only the thread that calls fork(2) gets duplicated. If any other thread has locked a mutex (say for printf, or malloc) and was in the middle of a critical section, then those locks remain locked, the other threads vanish, and my new child process is hosed.\n\nFrom the rust-dev thread on rusti - the - repl renovation: (20 sept 2013):\n\nI'm trying some sanity checks.  This one had a curious result. I did\n$ export RUST_THREADS=1\nand then started rusti under gdb. Expected: only one thread going. Observed: I have two threads going instead.\n\n(This is troublesome, because fork will never work if Rust doesn't honor the request of RUST_THREADS=1; you can't mix threads and fork; explanation: http://www.linuxprogrammingblog.com/threads-and-fork-think-twice-before-using-them )\n\nQ: Is there a way to _really_ just get one thread in the rust runtime?  Best case, I'm hoping the two threads observed is just a bug that can be fixed.\n\nJason\n\nFrom: Alex Crichton alex@crichton.co\nDate: Fri, Sep 20, 2013 at 4:24 PM\nSubject: Re: [rust-dev] rusti - the - repl renovation\nTo: \"Jason E. Aten\" j.e.aten@gmail.com\n\n> Q: Is there a way to _really_ just get one thread in the rust runtime?  Best\n> case, I'm hoping the two threads observed is just a bug that can be fixed.\n> Right now the runtime will always spawn at least one thread, so\n> without turning off the runtime you'll have at least two threads.\n> That's arguably a bug in the runtime though... \n\n```\njaten@fre:/usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin$ ./rustc -v\n./rustc 0.8-pre (570431f 2013-09-19 15:56:04 -0700)\nhost: x86_64-unknown-linux-gnu\njaten@fre:/usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin$ \n\n\n\njaten@fre:/usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin$ env|grep RUST\nRUST_THREADS=1\njaten@fre:/usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin$ gdb ./rusti\nGNU gdb (Ubuntu/Linaro 7.4-2012.04-0ubuntu2.1) 7.4-2012.04\nCopyright (C) 2012 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-linux-gnu\".\nFor bug reporting instructions, please see:\n<http://bugs.launchpad.net/gdb-linaro/>...\nReading symbols from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/rusti...(no debugging symbols found)...done.\n(gdb) run\nStarting program: /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/rusti\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\n[New Thread 0x7ffff7fd3700 (LWP 11639)]\nWARNING: The Rust REPL is experimental and may be\nunstable. If you encounter problems, please use the\ncompiler instead. Type :help for help.\nrusti>   C-c C-c\nProgram received signal SIGINT, Interrupt.\n0x00007ffff4356148 in pthread_join () from /lib/x86_64-linux-gnu/libpthread.so.0\n(gdb) bt\n#0  0x00007ffff4356148 in pthread_join () from /lib/x86_64-linux-gnu/libpthread.so.0\n#1  0x00007ffff49369d4 in rust_thread::join (this=0x7ffff001f2e0) at src/rt/sync/rust_thread.cpp:65\n#2  0x00007ffff4937469 in rust_raw_thread_join (thread=0x7ffff001f2e0) at src/rt/rust_builtin.cpp:417\n#3  0x00007ffff768f2e9 in rt::thread::Thread::join::hf3525925b944a51ZTas::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#4  0x00007ffff77cddd3 in rt::run_::h82e8c355ab8d949faz::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#5  0x00007ffff77cb694 in rt::run::hd3cab0f3a053bc41ab::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#6  0x00007ffff770968e in rt::start::h98ebfd32a7b8f1ad::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#7  0x00007ffff77095f7 in unstable::lang::start::h76d6c774aa357c7aaj::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#8  0x0000000000400c2b in main ()\n(gdb) i th\n  Id   Target Id         Frame\n  2    Thread 0x7ffff7fd3700 (LWP 11639) \"rusti\" 0x00007ffff46508cd in read () from /lib/x86_64-linux-gnu/libc.so.6\n* 1    Thread 0x7ffff7fd5780 (LWP 11636) \"rusti\" 0x00007ffff4356148 in pthread_join () from /lib/x86_64-linux-gnu/libpthread.so.0\n(gdb) thread 2\n[Switching to thread 2 (Thread 0x7ffff7fd3700 (LWP 11639))]\n#0  0x00007ffff46508cd in read () from /lib/x86_64-linux-gnu/libc.so.6\n(gdb) bt\n#0  0x00007ffff46508cd in read () from /lib/x86_64-linux-gnu/libc.so.6\n#1  0x00007ffff45e4ff8 in _IO_file_underflow () from /lib/x86_64-linux-gnu/libc.so.6\n#2  0x00007ffff45e603e in _IO_default_uflow () from /lib/x86_64-linux-gnu/libc.so.6\n#3  0x00007ffff45da18a in _IO_getline_info () from /lib/x86_64-linux-gnu/libc.so.6\n#4  0x00007ffff45d906b in fgets () from /lib/x86_64-linux-gnu/libc.so.6\n#5  0x00007ffff4946358 in linenoise (prompt=0x7fffefc58058 \"rusti> \") at src/rt/linenoise/linenoise.c:1405\n#6  0x00007ffff70a8061 in rl::rustrt::linenoise::h64cc97493178b67aa3::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libextra-a7c050cfd46b2c9a-0.8-pre.so\n#7  0x00007ffff70a8b26 in rl::read::anon::expr_fn::a1 () from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libextra-a7c050cfd46b2c9a-0.8-pre.so\n#8  0x00007ffff70a8aba in c_str::CString::with_ref::hb23b2a52bcdd1fsya0::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libextra-a7c050cfd46b2c9a-0.8-pre.so\n#9  0x00007ffff70a89b4 in c_str::ToCStr::with_c_str::hb23b2a52bcdd1faZ::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libextra-a7c050cfd46b2c9a-0.8-pre.so\n#10 0x00007ffff70a8936 in rl::read::h55e92cb2e4e46fea8::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libextra-a7c050cfd46b2c9a-0.8-pre.so\n#11 0x00007ffff4d691a2 in get_line::hacc817425f24a23caR::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/librusti-53e0ef2ae196aaff-0.8-pre.so\n#12 0x00007ffff4d7b1d2 in main_args::h37a11c4051c2827aO::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/librusti-53e0ef2ae196aaff-0.8-pre.so\n#13 0x00007ffff4d7a947 in main::h3a346db0adc4cf51aB::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/librusti-53e0ef2ae196aaff-0.8-pre.so\n#14 0x0000000000400bb9 in main::h4eb1c8bbff1fac2ag::v0.0 ()\n#15 0x00007ffff7709758 in unstable::lang::start::anon::expr_fn::a1 ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#16 0x00007ffff7719814 in rt::task::__extensions__::build_start_wrapper::anon::anon::expr_fn::ab ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#17 0x00007ffff761849c in unstable::finally::Finally$__extensions__::finally::h199ab8d6eb226980ECan::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#18 0x00007ffff77170d5 in rt::task::__extensions__::run::anon::expr_fn::at ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#19 0x00007ffff7719ce9 in rt::task::Unwinder::try::try_fn::__rust_abi::Vc ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#20 0x00007ffff7719c47 in rt::task::Unwinder::try::try_fn::hae27117228cab98fVca9::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#21 0x00007ffff4937787 in rust_try (f=0x7ffff7719bf0 <rt::task::Unwinder::try::try_fn::hae27117228cab98fVca9::v0.8$x2dpre>, fptr=0x7ffff7717080, env=0x7ffff0236348)\n    at src/rt/rust_builtin.cpp:523\n#22 0x00007ffff7716fa2 in rt::task::Unwinder::try::h199ab8d6eb226980Vcas::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#23 0x00007ffff7716e36 in rt::task::Task::run::h199ab8d6eb226980iXar::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#24 0x00007ffff7719467 in rt::task::__extensions__::build_start_wrapper::anon::expr_fn::a2 ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#25 0x00007ffff77b0db5 in rt::context::Context::new::task_start_wrapper::__rust_abi::se ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#26 0x00007ffff77b0d67 in rt::context::Context::new::task_start_wrapper::h1b9fdc38dc3bcfa4sea8::v0.8$x2dpre ()\n   from /usr/cn/rust/debug-build/rust/x86_64-unknown-linux-gnu/stage2/bin/../lib/libstd-6c65cf4b443341b1-0.8-pre.so\n#27 0x0000000000000000 in ?? ()\n(gdb)\n```\n", "closed_by": {"login": "thestinger", "id": 1505226, "node_id": "MDQ6VXNlcjE1MDUyMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thestinger", "html_url": "https://github.com/thestinger", "followers_url": "https://api.github.com/users/thestinger/followers", "following_url": "https://api.github.com/users/thestinger/following{/other_user}", "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}", "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions", "organizations_url": "https://api.github.com/users/thestinger/orgs", "repos_url": "https://api.github.com/users/thestinger/repos", "events_url": "https://api.github.com/users/thestinger/events{/privacy}", "received_events_url": "https://api.github.com/users/thestinger/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/9373/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/9373/timeline", "performed_via_github_app": null, "state_reason": "completed"}