{"url": "https://api.github.com/repos/rust-lang/rust/issues/110509", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/110509/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/110509/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/110509/events", "html_url": "https://github.com/rust-lang/rust/issues/110509", "id": 1673947772, "node_id": "I_kwDOAAsO6M5jxmp8", "number": 110509, "title": "\"warning: dropping unsupported crate type `dylib`\" for linux-musl targets", "user": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 419557634, "node_id": "MDU6TGFiZWw0MTk1NTc2MzQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/E-medium", "name": "E-medium", "color": "02e10c", "default": false, "description": "Call for participation: Experience needed to fix: Medium / intermediate"}, {"id": 630662867, "node_id": "MDU6TGFiZWw2MzA2NjI4Njc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-musl", "name": "O-musl", "color": "6e6ec0", "default": false, "description": "Target: The musl libc"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2023-04-18T23:14:38Z", "updated_at": "2023-04-19T01:18:00Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "### Code\r\n\r\n```Shell\r\n$ rustc - --crate-name ___ --print=file-names  --target riscv64gc-unknown-linux-musl --crate-type dylib\r\n[EOF]\r\n```\r\n### Current output\r\n\r\n```Shell\r\nwarning: dropping unsupported crate type `dylib` for target `riscv64gc-unknown-linux-musl`\r\n\r\nwarning: 1 warning emitted\r\n```\r\n\r\n### Desired output\r\n\r\n\r\nI found this error message confusing, because it implies that the target doesn't support dynamic libraries. The real issue is that rustc assumes by default that musl targets statically link libc (see https://github.com/rust-lang/rust/blob/master/compiler/rustc_target/src/spec/linux_musl_base.rs#L12 ). Even the name of the function that indirectly determines if the warning is emitted (`invalid_output_for_target()` -- https://github.com/rust-lang/rust/blob/master/compiler/rustc_session/src/output.rs#L178 ) is a bit misleading, as its result isn't just based on the target, but also on the target options.\r\n\r\nIt would be helpful to reword the warning to something like:\r\n\r\n```\r\nwarning: crate type `dylib` for target `riscv64gc-unknown-linux-musl` is unsupported with target options: `crt_static_default = true, crt_static_allows_dylibs = false, ...`\r\n```\r\n\r\nand/or include a suggestion to add the `-Ctarget-feature=-crt-static` flag if desired.\r\n\r\nIt appears there might be some underlying unresolved issues ( I found https://github.com/rust-lang/compiler-team/issues/422 ), but it seems like improving the error message isn't blocked on resolving those.\r\n\r\n\r\n### Rationale and extra context\r\n\r\nI originally ran into this while cross-compiling rustc, but was able to isolate it to the the `--print=file-names ...` output.\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/110509/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/110509/timeline", "performed_via_github_app": null, "state_reason": null}