{"url": "https://api.github.com/repos/rust-lang/rust/issues/7797", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/7797/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/7797/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/7797/events", "html_url": "https://github.com/rust-lang/rust/issues/7797", "id": 16744650, "node_id": "MDU6SXNzdWUxNjc0NDY1MA==", "number": 7797, "title": "random fails/segfaults from the io-upstream merge when RUST_THREADS=2 on Mac", "user": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 100522, "node_id": "MDU6TGFiZWwxMDA1MjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-crash", "name": "I-crash", "color": "e10c02", "default": false, "description": "Issue: The compiler crashes (SIGSEGV, SIGABRT, etc). Use I-ICE instead when the compiler panics."}, {"id": 123111, "node_id": "MDU6TGFiZWwxMjMxMTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-macos", "name": "O-macos", "color": "6e6ec0", "default": false, "description": "Operating system: macOS"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2013-07-15T09:01:57Z", "updated_at": "2013-07-17T22:57:31Z", "closed_at": "2013-07-17T22:57:31Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Summary: there is some non-deterministic crash while doing `make check` that is easier for me to reproduce when I set environment variable `RUST_THREADS=2` during the `make check`.  This is on a build with both `--enable-debug` and `--enable-optimize`; I am not sure if removing those options actually makes the bug go away, or merely makes it harder to reproduce.  (Update: `--enable-optimize` is not relevant; it can be toggled on/off and the bug persists.)\n\nIt appears to have been injected by commit 41dcec2fe16e272016ae77d10a6a5ff3a737f192\n\nThis is a merge commit by bors; its parent supplied by bors is: 137d1fb210a844a76f89d7355a1aaf9f7a88af33\n\nThings seem to work fine on the parent.\n\n\ufeff\nI found during my attempts to bisect the history that I could not trust our build infrastructure to reliably update LLVM source and/or rebuild the object code (perhaps for LLVM or perhaps elsewhere), so I got in the habit of deleting the both the LLVM source tree and the entire build tree (and re-running configure) during the bisection.  This of course makes the build take a bit longer.  (But maybe now that I have narrowed it to this particular merge, perhaps one can be less conservative with how much cleanup one does before testing.)\n\nSo, to reproduce, here is the command I was running in the build tree:\n\n```\nexport RUST_THREADS=2 ; git log -1 ; echo ; echo ; rm -rf ../src/llvm/ ; rm -rf * ; echo ; echo ; /Users/pnkfelix/Dev/Mozilla/rust.git/configure --enable-debug --enable-optimize  --enable-clang --prefix=~/opt/rust-dbg ; remake clean clean-llvm ; time make check \n```\n\n(There is certainly steps that can be omitted from the above, like the `git log -1`, which was for my own logging purposes while I bisected.  `remake` is the fork of GNU make I often use: [remake](http://bashdb.sourceforge.net/remake/), but that is almost certainly orthogonal.)\n\nI wish I had better information (either a more specific commit from the originating branch, or a narrow test test), but as of yet I have not been able to gather such.  I'm mostly filing this so that I keep a log of the crashes and any other detail I manage to gather.\n\nA few of the crashes I saw occurred while testing `rustpkg`, and included this as the output:\n\n```\n  rustc: for the -arm-enable-ehabi option: may only occur zero or one times!\n  rustc: for the -arm-enable-ehabi-descriptors option: may only occur zero or one times!\n```\n\nshortly before crashing; from what I can tell from skimming the source code, there is no way we should be seeing that message from tests on an Intel Mac, unless some internal state has been corrupted.  But the failure is non-deterministic, so this does not happen reliably.\n\nA few samples of the sorts of crashes that one sees while running `make check`, some while using `RUST_LOG` to get more info (I have more complete logs available on request); I had to post process some of the output, replacing raw bytes unacceptable to this text box e.g. \\342\\200\\224 with character strings representing those byte sequences:\n\n```\ntest rt::io::net::tcp::test::bind_error ... ignored\ntest rt::io::extensions::test::read_bytes ... ok\ntest result::tests::chain_failure ... ok\nrust: ~\"waking up task for 140313321592696\"\ntest rt::io::extensions::test::push_bytes_partial ... ok\ntest rt::io::mem::test::test_mem_writer ... okrust: ~\"waking up task for 140313322615688\"\nrust: ~\"waking up task for 140313318415048\"\nerror opening /dev/urandom: Too many open files\n```\n\n```\ntest rt::io::extensions::test::read_to_end ... ok\ntest rt::io::extensions::test::read_byte_0_bytes ... ok\nrust: ~\"blocked = 0 this = 7f9e45c08be0\"\nrust: ~\"blocked = 7f9e45c08be0 this = 7f9e45c08be0 old_task = 0\"\nrust: ~\"woke up, p.state = Full\"\nrust: ~\"no data available on &mut {header: {state: Blocked, blocked_task: (0x7f9e45c08be0 as *()), buffer: (0x7f9e45a038c0 as *())}, payload: None}, going to sleep.\"\ntask failed at 'assertion failed: handle.is_not_null()', /Users/pnkfelix/Dev/Mozilla/rust.git/src/libstd/rt/uv/mod.rs:100\ne\nThere was a night when winds from unknown spaces whirled us irresistibly into\nlimitless vacum beyond all thought and entity. Perceptions of the most\nmaddeningly untransmissible sort thronged upon us; perceptions of infinity\nwhich at the time convulsed us with joy, yet which are now partly lost to my\nmemory and partly incapable of presentation to others.\n\nfatal runtime error: assertion failed: void_sched.is_not_null()\n```\n\n```\ntest rt::comm::test::oneshot_single_thread_send_then_recv ... ok\ntest rt::io::mem::test::test_mem_reader ... ok\nrust: ~\"blocked = 0 this = 7fea01519590\"\nrust: ~\"blocked = 7fea01519590 this = 7fea01519590 old_task = 0\"\nrust: ~\"no data available on &mut {header: {state: Blocked, blocked_task: (0x7fea01519590 as *()), buffer: (0x7fea0150ec00 as *())}, payload: None}, going to sleep.\"\nrust: ~\"waking up task for 140643020157512\"\ntest rt::io::net::tcp::test::connect_error ... ok\nrust: ~\"blocked = 0 this = 7fea02a022a0\"\ntest rt::io::extensions::test::push_bytes_partial ... ok\nrust: ~\"blocked = 7fea02a022a0 this = 7fea02a022a0 old_task = 0\"\nrust: ~\"blocked = 0 this = 7fea02b15670\"\ntest rt::comm::test::oneshot_single_thread_send_port_close ... ok\nrust: ~\"blocked = 0 this = 7fea02a04750\"\nrust: ~\"blocked = 7fea02b15670 this = 7fea02b15670 old_task = 0\"\ntest rt::io::extensions::test::read_to_end_error ... ok\nrust: ~\"no data available on &mut {header: {state: Blocked, blocked_task: (0x7fea02a022a0 as *()), buffer: (0x7fea01418ce0 as *())}, payload: None}, going to sleep.\"\nrust: ~\"blocked = 7fea02a04750 this = 7fea02a04750 old_task = 0\"\nrust: ~\"blocked = 0 this = 7fea01519890\"\nrust: ~\"no data available on &mut {header: {state: Blocked, blocked_task: (0x7fea02b15670 as *()), buffer: (0x7fea02b154e0 as *())}, payload: None}, going to sleep.\"\ntest rt::io::extensions::test::read_bytes ... okrust: ~\"blocked = 7fea01519890 this = 7fea01519890 old_task = 0\"\nrust: ~\"no data available on &mut {header: {state: Blocked, blocked_task: (0x7fea02a04750 as *()), buffer: (0x7fea02a00800 as *())}, payload: None}, going to sleep.\"\nrust: ~\"no data available on &mut {header: {state: Blocked, blocked_task: (0x7fea01519890 as *()), buffer: (0x7fea01609fa0 as *())}, payload: None}, going to sleep.\"\ntest rt::comm::test::oneshot_single_thread_close_port_first ... ok\nrust: ~\"blocked = 0 this = 7fea01601c60\"\nrust: ~\"blocked = 7fea01601c60 this = 7fea01601c60 old_task = 0\"\nrust: ~\"no data available on &mut {header: {state: Blocked, blocked_task: (0x7fea01601c60 as *()), buffer: (0x7fea0280f020 as *())}, payload: None}, going to sleep.\"\n(libuv) Failed to create kqueue (24)\n\n\nInstead of the poems I had hoped for, there came only a shuddering blackness\nand ineffable loneliness; and I saw at last a fearful truth which no one had\never dared to breathe before \\342\\200\\224 the unwhisperable secret of secrets \\342\\200\\224 The fact\nthat this city of stone and stridor is not a sentient perpetuation of Old New\nYork as London is of Old London and Paris of Old Paris, but that it is in fact\nquite dead, its sprawling body imperfectly embalmed and infested with queer\nanimate things which have nothing to do with it as it was in life.\n\nfatal runtime error: no scheduler\n```\n\n```\ntest rt::io::extensions::test::push_bytes_eof ... ok\ntest rt::comm::test::oneshot_single_thread_try_send_closed ... ok\ntest rt::io::file::super_simple_smoke_test_lets_go_read_some_files_and_have_a_good_time ... ignored\nrust: ~\"no data available on &mut {header: {state: Blocked, blocked_task: (0x7f81dbe030a0 as *()), buffer: (0x7f81ddc011b0 as *())}, payload: None}, going to sleep.\"\ntest rt::io::flate::test::smoke_test ... ignored\nrust: ~\"\\\"Trap: pushing handler to TLS\\\"\"\nrust: ~\"blocked = 0 this = 7f81ddb03a20\"\nrust: ~\"blocked = 7f81ddb03a20 this = 7f81ddb03a20 old_task = 0\"\nrust: ~\"\\\"Condition.raise: found handler\\\"\"\nrust: ~\"\\\"Guard: popping handler from TLS\\\"\"\nrust: ~\"no data available on &mut {header: {state: Blocked, blocked_task: (0x7f81ddb03a20 as *()), buffer: (0x7f81ddb025e0 as *())}, payload: None}, going to sleep.\"\nrust: ~\"woke up, p.state = Full\"\ntest rt::comm::test::megapipe_stress ... okrust: ~\"blocked = 0 this = 7f81dd901580\"\nrust: ~\"blocked = 0 this = 7f81dda01dd0\"\nrust: ~\"woke up, p.state = Full\"\nrust: ~\"\\\"read 0 bytes. trying again\\\"\"\ns ... ok\ntest rt::io::extensions::test::read_bytes_eof ... ok\nrust: ~\"blocked = 7f81dd901580 this = 7f81dd901580 old_task = 0\"\ntest rt::comm::test::oneshot_single_thread_try_recv_open ... okrust: ~\"blocked = 7f81dda01dd0 this = 7f81dda01dd0 old_task = 0\"\nrust: ~\"\\\"Trap: pushing handler to TLS\\\"\"\nrust: ~\"no data available on &mut {header: {state: Blocked, blocked_task: (0x7f81dd901580 as *()), buffer: (0x7f81ddc028a0 as *())}, payload: None}, going to sleep.\"\nrust: ~\"\\\"Condition.raise: found handler\\\"\"\nrust: ~\"no data available on &mut {header: {state: Blocked, blocked_task: (0x7f81dda01dd0 as *()), buffer: (0x7f81dbe06a10 as *())}, payload: None}, going to sleep.\"\nrust: ~\"\\\"Condition.raise: found handler\\\"\"\nrust: ~\"\\\"Guard: popping handler from TLS\\\"\"\nrust: ~\"\\\"Trap: pushing handler to TLS\\\"\"\nrust: ~\"\\\"Condition.raise: found handler\\\"\"\nrust: ~\"\\\"Condition.raise: found no handler\\\"\"\nrust: task failed at 'Unhandled condition: read_error: {kind: OtherIoError, desc: \"Placeholder error. You shouldn\\'t be seeing this\", detail: None}', /Users/pnkfelix/Dev/Mozilla/rust.git/src/libstd/condition.rs:43\ntest rt::io::net::http::test::smoke_test ... ignored\ntest rt::io::net::tcp::test::bind_error ... ignored\ntest rt::io::extensions::test::read_byte_0_bytes ... ok\ntest rt::comm::test::oneshot_multi_task_recv_then_close ... ok\nrust: ~\"blocked = 0 this = 7f81dbe08970\"\nrust: ~\"blocked = 7f81dbe08970 this = 7f81dbe08970 old_task = 0\"\ntest rt::io::extensions::test::read_byte ... ok\nrust: ~\"no data available on &mut {header: {state: Blocked, blocked_task: (0x7f81dbe08970 as *()), buffer: (0x7f81ddb07b80 as *())}, payload: None}, going to sleep.\"\nrust: ~\"waking up task for 140195716426264\"\n~\"\\\"Trap: pushing handler to TLS\\\"\"\n```\n", "closed_by": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/7797/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/7797/timeline", "performed_via_github_app": null, "state_reason": "completed"}