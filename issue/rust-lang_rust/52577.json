{"url": "https://api.github.com/repos/rust-lang/rust/issues/52577", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/52577/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/52577/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/52577/events", "html_url": "https://github.com/rust-lang/rust/issues/52577", "id": 343261380, "node_id": "MDU6SXNzdWUzNDMyNjEzODA=", "number": 52577, "title": "'solaris' runtime stack guard conflicts with OS stack-clash mitigation", "user": {"login": "pfmooney", "id": 1555070, "node_id": "MDQ6VXNlcjE1NTUwNzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1555070?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pfmooney", "html_url": "https://github.com/pfmooney", "followers_url": "https://api.github.com/users/pfmooney/followers", "following_url": "https://api.github.com/users/pfmooney/following{/other_user}", "gists_url": "https://api.github.com/users/pfmooney/gists{/gist_id}", "starred_url": "https://api.github.com/users/pfmooney/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pfmooney/subscriptions", "organizations_url": "https://api.github.com/users/pfmooney/orgs", "repos_url": "https://api.github.com/users/pfmooney/repos", "events_url": "https://api.github.com/users/pfmooney/events{/privacy}", "received_events_url": "https://api.github.com/users/pfmooney/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}, {"id": 262252840, "node_id": "MDU6TGFiZWwyNjIyNTI4NDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-stable", "name": "regression-from-stable-to-stable", "color": "e4008a", "default": false, "description": "Performance or correctness regression from one stable version to another."}, {"id": 632931028, "node_id": "MDU6TGFiZWw2MzI5MzEwMjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-solaris", "name": "O-solaris", "color": "6e6ec0", "default": false, "description": "Operating system: Solaris"}], "state": "closed", "locked": false, "assignee": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 18, "created_at": "2018-07-20T22:08:16Z", "updated_at": "2020-03-24T02:37:14Z", "closed_at": "2020-03-24T02:37:13Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "We have found the stack guard logic present in rust 1.27 conflicts with the OS-provided mitigation present in illumos distributions.  This became clear on SmartOS when the 2018Q2 pkgsrc update moved from rust 1.24 to 1.27.  Those binaries, compiled on an old platform without the mitigation, bail immediately on machines that do possess it\r\n\r\n```\r\n# rustc\r\nthread 'main' panicked at 'failed to allocate a guard page', libstd/sys/unix/thread.rs:337:17\r\nnote: Run with `RUST_BACKTRACE=1` for a backtrace.\r\n# RUST_BACKTRACE=full rustc\r\nthread 'main' panicked at 'failed to allocate a guard page', libstd/sys/unix/thread.rs:337:17\r\nstack backtrace:\r\n   0: 0xfffffd7fde402f3e - std::sys::unix::backtrace::tracing::imp::unwind_backtrace::ha22b267de1618f10\r\n   1: 0xfffffd7fde3cdee6 - std::sys_common::backtrace::print::h9be6459ca953ea86\r\n   2: 0xfffffd7fde410a1b - std::panicking::default_hook::{{closure}}::h11d519068135b02a\r\n   3: 0xfffffd7fde4106e1 - std::panicking::default_hook::he7d6fa94ad994305\r\n   4: 0xfffffd7fde41110c - std::panicking::rust_panic_with_hook::hef4aa8f9edd49f7f\r\n   5: 0xfffffd7fde410ef6 - std::panicking::begin_panic::h350ed1a97f2676c6\r\n   6: 0xfffffd7fde3e7b24 - std::sys::unix::thread::guard::init::h66e847be7b85328f\r\n   7: 0xfffffd7fde3e44fd - std::rt::update_stack_guard::h3749f1240dd6decc\r\n   8: 0xfffffd7fde786185 - rustc_driver::run::hf99f9e1bb314cfb8\r\n   9: 0xfffffd7fde7954da - rustc_driver::main::he45a01066d380276\r\n  10:           0x401842 - std::rt::lang_start::{{closure}}::h50ce2fc38c241613\r\n  11: 0xfffffd7fde410be2 - std::panicking::try::do_call::h260c23fa696aee03\r\n  12: 0xfffffd7fde417919 - __rust_maybe_catch_panic\r\n  13: 0xfffffd7fde3e4325 - std::rt::lang_start_internal::hef1606e7d03cbe2a\r\n  14:           0x4018a3 - main\r\n  15:           0x40167b - _start\r\n```\r\n\r\nThe details of how the two guards are conflicting can be found written up in [OS-7059](https://smartos.org/bugview/OS-7059).  The stack-clash mitigation was added to SmartOS and OmniOS back in October 2017.  It was merged into illumos-gate [this past week](https://www.illumos.org/issues/9641), marking its availability for any remaining downstream distributions.\r\n\r\nOur temporary mitigation has been to [float a patch](https://github.com/joyent/pkgsrc/blob/joyent/release/2018Q2/lang/rust/patches/patch-src_libstd_sys_unix_thread.rs) in pkgsrc to treat the 'solaris' platform like 'linux', disabling the stack-guard mapping:\r\n\r\n```diff\r\n--- src/libstd/sys/unix/thread.rs.orig 2018-06-24 22:42:29.203295357 +0000\r\n+++ src/libstd/sys/unix/thread.rs\r\n@@ -309,7 +309,7 @@ pub mod guard {\r\n\r\n         let stackaddr = get_stack_start_aligned()?;\r\n\r\n-        if cfg!(target_os = \"linux\") {\r\n+        if cfg!(any(target_os = \"linux\", target_os = \"solaris\")) {\r\n             // Linux doesn't allocate the whole stack right away, and\r\n             // the kernel has its own stack-guard mechanism to fault\r\n             // when growing too close to an existing mapping.  If we map\r\n@@ -345,7 +354,7 @@ pub mod guard {\r\n     }\r\n\r\n     pub unsafe fn deinit() {\r\n-        if !cfg!(target_os = \"linux\") {\r\n+        if cfg!(not(any(target_os = \"linux\", target_os = \"solaris\"))) {\r\n             if let Some(stackaddr) = get_stack_start_aligned() {\r\n                 // Remove the protection on the guard page.\r\n// FIXME: we cannot unmap the page, because when we mmap()\r\n```\r\n\r\nConsidering the rest of the illumos ecosystem is (or soon will be) effected by this issue, it would be nice to get that stack-guard exclusion moved into upstream rust.\r\n", "closed_by": {"login": "pfmooney", "id": 1555070, "node_id": "MDQ6VXNlcjE1NTUwNzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1555070?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pfmooney", "html_url": "https://github.com/pfmooney", "followers_url": "https://api.github.com/users/pfmooney/followers", "following_url": "https://api.github.com/users/pfmooney/following{/other_user}", "gists_url": "https://api.github.com/users/pfmooney/gists{/gist_id}", "starred_url": "https://api.github.com/users/pfmooney/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pfmooney/subscriptions", "organizations_url": "https://api.github.com/users/pfmooney/orgs", "repos_url": "https://api.github.com/users/pfmooney/repos", "events_url": "https://api.github.com/users/pfmooney/events{/privacy}", "received_events_url": "https://api.github.com/users/pfmooney/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/52577/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/52577/timeline", "performed_via_github_app": null, "state_reason": "completed"}