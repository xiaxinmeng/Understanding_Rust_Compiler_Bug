{"url": "https://api.github.com/repos/rust-lang/rust/issues/46893", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/46893/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/46893/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/46893/events", "html_url": "https://github.com/rust-lang/rust/issues/46893", "id": 283710531, "node_id": "MDU6SXNzdWUyODM3MTA1MzE=", "number": 46893, "title": "Can't specialize `Drop`", "user": {"login": "Rantanen", "id": 385385, "node_id": "MDQ6VXNlcjM4NTM4NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/385385?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Rantanen", "html_url": "https://github.com/Rantanen", "followers_url": "https://api.github.com/users/Rantanen/followers", "following_url": "https://api.github.com/users/Rantanen/following{/other_user}", "gists_url": "https://api.github.com/users/Rantanen/gists{/gist_id}", "starred_url": "https://api.github.com/users/Rantanen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Rantanen/subscriptions", "organizations_url": "https://api.github.com/users/Rantanen/orgs", "repos_url": "https://api.github.com/users/Rantanen/repos", "events_url": "https://api.github.com/users/Rantanen/events{/privacy}", "received_events_url": "https://api.github.com/users/Rantanen/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 234902, "node_id": "MDU6TGFiZWwyMzQ5MDI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-enhancement", "name": "C-enhancement", "color": "f5f1fd", "default": false, "description": "Category: An issue proposing an enhancement or a PR with one."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 347795552, "node_id": "MDU6TGFiZWwzNDc3OTU1NTI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-specialization", "name": "A-specialization", "color": "f7e101", "default": false, "description": "Area: Trait impl specialization"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2017-12-20T22:10:15Z", "updated_at": "2021-02-06T00:46:01Z", "closed_at": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "The `Drop` trait has checks to ensure that the `impl` can't add new restrictions on generic parameters.\r\n\r\n```rust\r\nstruct S<T> { ... }\r\nimpl<T: Foo> Drop for S<T> { ... }\r\n```\r\n\r\nThe above won't compile (as intended?), as the `S` would have a Drop that's conditional based on the type parameter.\r\n\r\nHowever with specialization we could have something like:\r\n\r\n```rust\r\nstruct S<T> { ... }\r\ndefault impl<T> Drop for S<T> { ... }\r\nimpl <T: Foo> Drop S<T> { ... }\r\n```\r\n\r\nBoth of these examples yield the same error\r\n\r\n```\r\nerror[E0367]: The requirement `T: Foo` is added only by the Drop impl.\r\n```\r\n\r\nMy first instinct was that this had something to do with the type information getting lost on destructors, but that doesn't seem to be the case as the issue can be worked around by specializing a different trait, to which `drop` delegates to:\r\n\r\n```rust\r\nstruct S<T> { ... }\r\n\r\n// Specialized Drop implementation.\r\ntrait SpecialDrop { fn drop( &mut self ); }\r\ndefault impl<T> SpecialDrop for S<T> { ... }\r\nimpl<T: Foo> SpecialDrop for S<T> { ... }\r\n\r\n// Drop delegates to SpecialDrop.\r\nimpl<T> Drop S<T> { fn drop(&mut self) {\r\n    (self as &mut SpecialDrop).drop()\r\n}\r\n```\r\n\r\nLinking to #31844", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/46893/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/46893/timeline", "performed_via_github_app": null, "state_reason": null}