{"url": "https://api.github.com/repos/rust-lang/rust/issues/31435", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/31435/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/31435/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/31435/events", "html_url": "https://github.com/rust-lang/rust/issues/31435", "id": 131742549, "node_id": "MDU6SXNzdWUxMzE3NDI1NDk=", "number": 31435, "title": "Regression in compile times after LLVM was upgraded", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 60344715, "node_id": "MDU6TGFiZWw2MDM0NDcxNQ==", "url": "https://api.github.com/repos/rust-lang/rust/labels/P-medium", "name": "P-medium", "color": "eb6420", "default": false, "description": "Medium priority"}, {"id": 64037154, "node_id": "MDU6TGFiZWw2NDAzNzE1NA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-compiletime", "name": "I-compiletime", "color": "e11d21", "default": false, "description": "Problems and improvements with respect to compile times."}, {"id": 147085028, "node_id": "MDU6TGFiZWwxNDcwODUwMjg=", "url": "https://api.github.com/repos/rust-lang/rust/labels/regression-from-stable-to-nightly", "name": "regression-from-stable-to-nightly", "color": "e4008a", "default": false, "description": "Performance or correctness regression from stable to nightly."}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 14, "created_at": "2016-02-05T20:04:31Z", "updated_at": "2016-04-07T18:54:17Z", "closed_at": "2016-04-07T18:54:16Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "LLVM was recently upgraded in #30448 which appears to have caused a regression\nin compile times. First up, let's talk numbers. The compiler revisions in\nquestion are:\n- 074f49a350f22b6f33890cd105b2ebe2c790ee3c - just before the LLVM upgrade\n- 303892ee156e5c31222b10786e661abb24dcf241 - just after the LLVM upgrade\n\nThe `nightly-2016-01-30` toolchain conveniently corresponds exactly to\n303892ee156e5c31222b10786e661abb24dcf241. The benchmarks here will all be\ncompiling libsyntax at these two revision in optimized mode. Note that\nlibsyntax did not change at all between these two revisions. For local\ncompilations I configured with:\n\n```\n./configure --enable-rpath --disable-optimize-tests --enable-ccache\n```\n\nand the C++ compiler version is:\n\n```\n$ g++ --version\ng++ (Ubuntu 4.8.4-2ubuntu1~14.04) 4.8.4\nCopyright (C) 2013 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n```\n### Nightly compiler (`nightly-2016-01-30`)\n\n```\n$ multirust run nightly-2016-01-30 rustc -vV\nrustc 1.8.0-nightly (303892ee1 2016-01-30)\n$ time multirust run nightly-2016-01-30 rustc src/libsyntax/lib.rs -O > out\nmultirust run nightly-2016-01-30 rustc src/libsyntax/lib.rs -O -Z time-passes  129.85s user 1.31s system 99% cpu 2:11.18 total\n```\n\nSummary: **2:11.18**s compile time, [full output of time-passes](https://gist.github.com/alexcrichton/6caa509afae7643ceff5)\n### Locally compiled after LLVM upgrade (303892ee1)\n\n```\n$ ./x86_64-unknown-linux-gnu/stage2/bin/rustc -V\nrustc 1.8.0-dev (303892ee1 2016-01-30)\n$ time ./x86_64-unknown-linux-gnu/stage2/bin/rustc src/libsyntax/lib.rs -O -Z time-passes > out\n./x86_64-unknown-linux-gnu/stage2/bin/rustc src/libsyntax/lib.rs -O -Z  > out  96.16s user 1.29s system 99% cpu 1:37.48 total\n```\n\nSummary: **1:37.48**s compile time, [full output of time-passes](https://gist.github.com/alexcrichton/34883cbe4e1e10be7b69)\n### Locally compiled before LLVM upgrade (074f49a35)\n\n```\n$ ./x86_64-unknown-linux-gnu/stage2/bin/rustc -V\nrustc 1.8.0-dev (074f49a35 2016-01-29)\n$ time ./x86_64-unknown-linux-gnu/stage2/bin/rustc src/libsyntax/lib.rs -O -Z time-passes > out\n./x86_64-unknown-linux-gnu/stage2/bin/rustc src/libsyntax/lib.rs -O -Z  > out  81.39s user 1.28s system 99% cpu 1:22.69 total\n```\n\nSummary: **1:22.69**s compile time, [full output of time-passes](https://gist.github.com/alexcrichton/30117ca8a7f97c526fe0)\n## Summary\n\nSo there are some fascinating data points here:\n- ~~The nightlies we're shipping are 35% slower than a locally compiled copy~~ -- Edit: nightly has LLVM assertions enabled where my local compilers did not\n- The LLVM upgrade made compilation 18% slower\n- Almost the entire compile time difference can be attributed to LLVM\n  - [nightly](https://gist.github.com/alexcrichton/6caa509afae7643ceff5#file-out4-L64) vs [local-upgraded](https://gist.github.com/alexcrichton/34883cbe4e1e10be7b69#file-out2-L64) is 33s longer in LLVM, and 34s longer overall\n  - [local-upgraded](https://gist.github.com/alexcrichton/34883cbe4e1e10be7b69#file-out2-L64) vs [local-before](https://gist.github.com/alexcrichton/30117ca8a7f97c526fe0#file-out-L64) is 15s longer in LLVM, and 15s longer overall\n\nOk, so something looks clearly suspicious with LLVM! Let's try and take a closer\nlook. First, some data dumps of `-Z time-llvm-passes`\n- [`nightly-2016-01-30` compiler](https://gist.github.com/alexcrichton/33df0eb8d1bb89e7332b)\n- [303892ee1 local compiler](https://gist.github.com/alexcrichton/94d68863313a9db8536d)\n- [074f49a35 local compiler](https://gist.github.com/alexcrichton/8c66d83ca257fb473233)\n\nUnfortunately I don't have much of a takeaway from this. Maybe others might\nthought?\n## Next steps\n- Should we revert the LLVM upgrade? This would unfortunately not be trivial.\n- Is there something here we can report to upstream LLVM? Is there a bug fix we\n  can include in our local LLVM fork temporarily?\n- Is this analysis a red herring and perhaps there's something else going on\n  here?\n", "closed_by": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/31435/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/31435/timeline", "performed_via_github_app": null, "state_reason": "completed"}