{"url": "https://api.github.com/repos/rust-lang/rust/issues/28595", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/28595/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/28595/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/28595/events", "html_url": "https://github.com/rust-lang/rust/issues/28595", "id": 107816594, "node_id": "MDU6SXNzdWUxMDc4MTY1OTQ=", "number": 28595, "title": "Native libraries for the local crate linked in the wrong order", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2015-09-22T22:38:35Z", "updated_at": "2015-10-01T06:19:03Z", "closed_at": "2015-10-01T06:19:03Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "There's currently a [large comment in the compiler](https://github.com/rust-lang/rust/blob/9c1aaeb7b97e34b6688f31c6921d636d27c02e73/src/librustc_trans/back/link.rs#L977-L1009) explaining how we link artifacts in this order:\n1. The local object file\n2. Rust dependencies\n3. Local native dependencies\n4. Upstream native dependencies\n\nIt also [explicitly mentions](https://github.com/rust-lang/rust/blob/9c1aaeb7b97e34b6688f31c6921d636d27c02e73/src/librustc_trans/back/link.rs#L991) why 2/3 are a little backwards.\n\nUnfortunately, however, it looks like the ordering above causes link errors in otherwise correct situations. For example let's consider (code example at the end of this issue)\n- We have a dependency, B, which statically links the native library libB\n- We are linking a native dependency libA which depends on libB\n- We are also producing an executable.\n\nThe ordering of flags on the command line will be:\n\n```\n[ object file ]  [ B rlib + libB ] [ libA ]\n```\n\nThe problem here is that libB is contained in B's rlib, so the ordering of the linker is incorrect, libA shows up after libB. This will cause a linker error if the object file doesn't otherwise reference symbols from B's rlib.\n\nI think that the wording for why steps 2/3 above are swapped is far out of date by this point (with Cargo build scripts and modern methods to link native libraries), so it sounds to me like they should be swapped now. This may cause breakage, but it should always be fixable by restructuring the DAG to more accurately reflect the network of dependencies between C libraries and Rust crates.\n\n``` toml\n# Cargo.toml\n[package]\nname = \"a\"\nversion = \"0.1.0\"\nauthors = [\"Alex Crichton <alex@alexcrichton.com>\"]\nbuild = \"build.rs\"\n\n[build-dependencies]\ngcc = \"0.3\"\n[dependencies]\nb = { path = \"b\" }\n```\n\n``` rust\n// build.rs\nextern crate gcc;\n\nfn main() {\n    gcc::compile_library(\"liba.a\", &[\"src/lib.c\"]);\n}\n```\n\n``` rust\n// src/main.rs\nextern crate b;\n\nextern {\n    fn a();\n}\n\nfn main() {\n    unsafe { a(); }\n}\n```\n\n``` c\n// src/lib.c\nextern void b(void);\n\nvoid a(void) {\n  b();\n}\n```\n\n``` toml\n# b/Cargo.toml\n[package]\nname = \"b\"\nversion = \"0.1.0\"\nauthors = [\"Alex Crichton <alex@alexcrichton.com>\"]\nbuild = \"build.rs\"\n\n[build-dependencies]\ngcc = \"0.3\"\n```\n\n``` rust\n// b/build.rs\nextern crate gcc;\n\nfn main() {\n    gcc::compile_library(\"libb.a\", &[\"src/lib.c\"]);\n}\n```\n\n``` c\n// b/src/lib.c\nvoid b() {}\n```\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/28595/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/28595/timeline", "performed_via_github_app": null, "state_reason": "completed"}