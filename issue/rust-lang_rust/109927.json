{"url": "https://api.github.com/repos/rust-lang/rust/issues/109927", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/109927/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/109927/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/109927/events", "html_url": "https://github.com/rust-lang/rust/issues/109927", "id": 1653382774, "node_id": "I_kwDOAAsO6M5ijJ52", "number": 109927, "title": "LNK1223 error when building rustc with custom LLVM under windows", "user": {"login": "Escapingbug", "id": 19388242, "node_id": "MDQ6VXNlcjE5Mzg4MjQy", "avatar_url": "https://avatars.githubusercontent.com/u/19388242?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Escapingbug", "html_url": "https://github.com/Escapingbug", "followers_url": "https://api.github.com/users/Escapingbug/followers", "following_url": "https://api.github.com/users/Escapingbug/following{/other_user}", "gists_url": "https://api.github.com/users/Escapingbug/gists{/gist_id}", "starred_url": "https://api.github.com/users/Escapingbug/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Escapingbug/subscriptions", "organizations_url": "https://api.github.com/users/Escapingbug/orgs", "repos_url": "https://api.github.com/users/Escapingbug/repos", "events_url": "https://api.github.com/users/Escapingbug/events{/privacy}", "received_events_url": "https://api.github.com/users/Escapingbug/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2023-04-04T07:58:02Z", "updated_at": "2023-04-04T08:47:34Z", "closed_at": "2023-04-04T08:47:27Z", "author_association": "NONE", "active_lock_reason": null, "body": "I am currently trying to experiment with a llvm patch under windows, and needing a way to build rustc with that patched LLVM.\r\nWhat I am tring is:\r\n\r\n1. build my own llvm, install that to some dir, command:\r\n\r\n```\r\ncmake -G \"Ninja\" ../llvm -DCMAKE_INSTALL_PREFIX=~/myllvm -DCMAKE_CXX_STANDARD=17 -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_PROJECTS=\"clang;lld;\" -DLLVM_TARGETS_TO_BUILD=\"X86\" -DLLVM_INSTALL_UTILS=ON -DLLVM_INCLUDE_TESTS=OFF -DLLVM_BUILD_TESTS=OFF -DLLVM_INCLUDE_BENCHMARKS=OFF -DLLVM_BUILD_BENCHMARKS=OFF \r\n```\r\n\r\n2. clone the rustc repo, copy the config.example.toml to config.toml, and change:\r\n  - set `debug` to false\r\n  - target from `target.x86_64-unknown-linux-gnu` to `target.x86_64-pc-windows`\r\n  - uncomment `llvm-config` and set that to my installed llvm's `llvm-config`\r\n  - change the channel from \"dev\" to \"nightly\"\r\n3. `python3 x.py build`\r\n\r\nThe next thing I encounter is something like in [this issue](https://github.com/rust-lang/rust/issues/81381).\r\n\r\nThe author mentioned a possible workaround by `crt-static=true` and `LLVM_USE_CRT` sets to `MT`.\r\nSo I did that and set `LLVM_USE_CRT_RELEASE` to `MT` (also, LLVM is built under release) by adding `-DLLVM_USE_CRT_RELEASE=MT`, and build again.\r\n\r\nThen I got this problem:\r\n\r\n```\r\nC:\\\\Program Files\\\\Microsoft Visual Studio\\\\2022\\\\Community\\\\VC\\\\Tools\\\\MSVC\\\\14.35.32215\\\\bin\\\\HostX64\\\\x64\\\\link.exe\" \"/DEF:C:\\\\Users\\\\anciety\\\\AppData\\\\Local\\\\Temp\\\\rustc0SuoXn\\\\lib.def\" \"/NOLOGO\" \"C:\\\\Users\\\\anciety\\\\AppData\\\\Local\\\\Temp\\\\rustc0SuoXn\\\\symbols.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.0.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.1.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.10.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.11.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.12.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.13.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.14.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.15.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.2.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.3.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.4.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.5.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.6.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.7.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.8.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.std.c912c465-cgu.9.rcgu.o\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.vkfgxdag4tpv3nl.rcgu.rmeta\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.1zvn7bwchgkkuqxu.rcgu.o\" \"/LIBPATH:C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\" \"/LIBPATH:C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\release\\\\deps\" \"/LIBPATH:C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\build\\\\compiler_builtins-592565ba788e8799\\\\out\" \"/LIBPATH:C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"kernel32.lib\" \"advapi32.lib\" \"userenv.lib\" \"kernel32.lib\" \"ws2_32.lib\" \"bcrypt.lib\" \"ntdll.lib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\libpanic_unwind-cf7c52c8541247c8.rlib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\librustc_demangle-67cc44dcafd2d2f4.rlib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\libstd_detect-9c65bbe3cdbe5411.rlib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\libhashbrown-a2bb50a6fd9e49f8.rlib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\libminiz_oxide-1c79f89a19e72a0a.rlib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\libadler-b3c29514229011f3.rlib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\librustc_std_workspace_alloc-2392fa0dadf20a4d.rlib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\libunwind-a075aa5d3b38968b.rlib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\libcfg_if-2ad7fd5fa547498a.rlib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\liblibc-76a3007190d3f3fd.rlib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\liballoc-053b41ffcfb63338.rlib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\librustc_std_workspace_core-f9a15394bd813ed9.rlib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\libcore-28c478c35cb147ba.rlib\" \"C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\libcompiler_builtins-c0705f95d29d72f6.rlib\" \"libcmt.lib\" \"legacy_stdio_definitions.lib\" \"/NXCOMPAT\" \"/LIBPATH:C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"/OUT:C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.dll\" \"/OPT:REF,ICF\" \"/DLL\" \"/IMPLIB:C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.dll.lib\" \"/DEBUG\"\\n  = note: Non-UTF-8 output:   \u6b63\u5728\u521b\u5efa\u5e93 C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.dll.lib \u548c\u5bf9\u8c61 C:\\\\Users\\\\anciety\\\\Code\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage1-std\\\\x86_64-pc-windows-msvc\\\\release\\\\deps\\\\std-d383a381ab4a5870.dll.exp\\r\\nstd-d383a381ab4a5870.std.c912c465-cgu.9.rcgu.o : fatal error LNK1223: \u65e0\u6548\u6216\u635f\u574f\u7684\u6587\u4ef6: \u6587\u4ef6\u5305\u542b\u65e0\u6548\u7684 .pdata \u57fa\u503c\\r\\n\\n'\r\n```\r\n\r\nIt says the file contains invalid .pdata base value.", "closed_by": {"login": "Escapingbug", "id": 19388242, "node_id": "MDQ6VXNlcjE5Mzg4MjQy", "avatar_url": "https://avatars.githubusercontent.com/u/19388242?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Escapingbug", "html_url": "https://github.com/Escapingbug", "followers_url": "https://api.github.com/users/Escapingbug/followers", "following_url": "https://api.github.com/users/Escapingbug/following{/other_user}", "gists_url": "https://api.github.com/users/Escapingbug/gists{/gist_id}", "starred_url": "https://api.github.com/users/Escapingbug/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Escapingbug/subscriptions", "organizations_url": "https://api.github.com/users/Escapingbug/orgs", "repos_url": "https://api.github.com/users/Escapingbug/repos", "events_url": "https://api.github.com/users/Escapingbug/events{/privacy}", "received_events_url": "https://api.github.com/users/Escapingbug/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/109927/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/109927/timeline", "performed_via_github_app": null, "state_reason": "completed"}