{"url": "https://api.github.com/repos/rust-lang/rust/issues/18836", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/18836/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/18836/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/18836/events", "html_url": "https://github.com/rust-lang/rust/issues/18836", "id": 48254870, "node_id": "MDU6SXNzdWU0ODI1NDg3MA==", "number": 18836, "title": "TaskPool tries to reuse the panicked task, thus dies", "user": {"login": "barosl", "id": 573768, "node_id": "MDQ6VXNlcjU3Mzc2OA==", "avatar_url": "https://avatars.githubusercontent.com/u/573768?v=4", "gravatar_id": "", "url": "https://api.github.com/users/barosl", "html_url": "https://github.com/barosl", "followers_url": "https://api.github.com/users/barosl/followers", "following_url": "https://api.github.com/users/barosl/following{/other_user}", "gists_url": "https://api.github.com/users/barosl/gists{/gist_id}", "starred_url": "https://api.github.com/users/barosl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/barosl/subscriptions", "organizations_url": "https://api.github.com/users/barosl/orgs", "repos_url": "https://api.github.com/users/barosl/repos", "events_url": "https://api.github.com/users/barosl/events{/privacy}", "received_events_url": "https://api.github.com/users/barosl/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2014-11-10T11:28:37Z", "updated_at": "2014-11-14T08:25:37Z", "closed_at": "2014-11-14T08:25:37Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Consider the following example:\n\n``` rust\nuse std::sync::TaskPool;\nuse std::io::timer::sleep;\nuse std::time::duration::Duration;\n\nfn main() {\n    let mut pool = TaskPool::new(5, || { proc(id: uint) { id } });\n\n    pool.execute(proc(id: &uint) panic!(\"!! at Task #{}\", id));\n    sleep(Duration::milliseconds(10));\n\n    loop {\n        pool.execute(proc(id: &uint) println!(\"Task #{}\", id));\n        sleep(Duration::milliseconds(10));\n    }\n}\n```\n\nWe make the first task in the pool `panic!()`. It results the task to die, and the associated channel becomes unusable.\n\nAfter a while, in the infinite loop, `TaskPool` chooses the first task (which is dead) again and tries to reuse it. However, the channel as well as the task is not available. So, the main task panics like this:\n\n```\ntask '<unnamed>' panicked at '!! at Task #0', test.rs:8\nTask #1\nTask #2\nTask #3\nTask #4\ntask '<main>' panicked at 'sending on a closed channel', /home/rustbuild/src/rust-buildbot/slave/nightly-linux/build/src/libsync/comm/mod.rs:571\ntask '<main>' panicked at 'sending on a closed channel', /home/rustbuild/src/rust-buildbot/slave/nightly-linux/build/src/libsync/comm/mod.rs:571\nstack backtrace:\n   1:     0x7f3f3c383dd0 - rt::backtrace::imp::write::h8a05a2225574bd5ascq\n   2:     0x7f3f3c386c50 - failure::on_fail::h3903c5b5788bc95c3xq\n   3:     0x7f3f3c3942a0 - unwind::begin_unwind_inner::h0919efe752d6fd357Rd\n   4:     0x7f3f3c393f20 - unwind::begin_unwind_fmt::hd089b86912964a95zPd\n   5:     0x7f3f3c393ee0 - rust_begin_unwind\n   6:     0x7f3f3c3c5500 - panicking::panic_fmt::h57475b82a3c609a1x7j\n   7:     0x7f3f3c3c5240 - panicking::panic::h695f69b4c28a75e0B4j\n   8:     0x7f3f3c3438f0 - comm::Sender<T>::send::h14935566101124425183\n   9:     0x7f3f3c3475d0 - sync::task_pool::TaskPool<T>.Drop::drop::h11194483048085865320\n  10:     0x7f3f3c347540 - std..sync..task_pool..TaskPool<uint>::glue_drop.2909::h08736b903b89c2b2\n  11:     0x7f3f3c332d70 - main::he6e3314dedd67115haa\n  12:     0x7f3f3c37b7a0 - start::closure.8531\n  13:     0x7f3f3c394e10 - rust_try_inner\n  14:     0x7f3f3c394e00 - rust_try\n  15:     0x7f3f3c392460 - unwind::try::h32143614f9ac9c88PGd\n  16:     0x7f3f3c392300 - task::Task::run::h8c90cb04437a131dFMc\n  17:     0x7f3f3c37b4c0 - start::hd7eedac68fc68d83Yje\n  18:     0x7f3f3c37b430 - lang_start::h6d3cacf2b5551a44hje\n  19:     0x7f3f3c332e90 - main\n  20:     0x7f3f3b727dd0 - __libc_start_main\n  21:     0x7f3f3c332c40 - <unknown>\n  22:                0x0 - <unknown>\ntask failed during unwinding. aborting.\nzsh: illegal hardware instruction (core dumped)  ./test\n```\n\nIs this intended? Or is it just a bug?\n", "closed_by": {"login": "barosl", "id": 573768, "node_id": "MDQ6VXNlcjU3Mzc2OA==", "avatar_url": "https://avatars.githubusercontent.com/u/573768?v=4", "gravatar_id": "", "url": "https://api.github.com/users/barosl", "html_url": "https://github.com/barosl", "followers_url": "https://api.github.com/users/barosl/followers", "following_url": "https://api.github.com/users/barosl/following{/other_user}", "gists_url": "https://api.github.com/users/barosl/gists{/gist_id}", "starred_url": "https://api.github.com/users/barosl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/barosl/subscriptions", "organizations_url": "https://api.github.com/users/barosl/orgs", "repos_url": "https://api.github.com/users/barosl/repos", "events_url": "https://api.github.com/users/barosl/events{/privacy}", "received_events_url": "https://api.github.com/users/barosl/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/18836/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/18836/timeline", "performed_via_github_app": null, "state_reason": "completed"}