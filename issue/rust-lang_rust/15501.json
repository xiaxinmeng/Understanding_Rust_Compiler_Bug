{"url": "https://api.github.com/repos/rust-lang/rust/issues/15501", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/15501/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/15501/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/15501/events", "html_url": "https://github.com/rust-lang/rust/issues/15501", "id": 37275313, "node_id": "MDU6SXNzdWUzNzI3NTMxMw==", "number": 15501, "title": "channel shuts down too early during program termination", "user": {"login": "mgmeier", "id": 4739597, "node_id": "MDQ6VXNlcjQ3Mzk1OTc=", "avatar_url": "https://avatars.githubusercontent.com/u/4739597?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mgmeier", "html_url": "https://github.com/mgmeier", "followers_url": "https://api.github.com/users/mgmeier/followers", "following_url": "https://api.github.com/users/mgmeier/following{/other_user}", "gists_url": "https://api.github.com/users/mgmeier/gists{/gist_id}", "starred_url": "https://api.github.com/users/mgmeier/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mgmeier/subscriptions", "organizations_url": "https://api.github.com/users/mgmeier/orgs", "repos_url": "https://api.github.com/users/mgmeier/repos", "events_url": "https://api.github.com/users/mgmeier/events{/privacy}", "received_events_url": "https://api.github.com/users/mgmeier/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2014-07-07T14:46:41Z", "updated_at": "2014-07-07T15:12:01Z", "closed_at": "2014-07-07T15:07:19Z", "author_association": "NONE", "active_lock_reason": null, "body": "I didn't check if this has been reported yet, but there seems to be an inconsistency in the runtime system at program termination. \n\nI slightly modified the channels example from rust's tutorial:\n\n```\nuse std::comm::DuplexStream;\nuse std::comm::duplex;\n\nfn stringifier (channel: &DuplexStream<String, uint>) {\n    let mut value: uint;\n    loop {\n        value = channel.recv();\n        channel.send(value.to_str());\n\n        // KEEP THREAD RUNNING DURING PROGRAM TERMINATION\n        // if value == 0 { break; }\n    }\n}\n\nfn main () {\n    let (from_child, to_child) = duplex();\n\n    spawn(proc() {\n        stringifier(&to_child);\n    });\n\n    from_child.send(22);\n    assert!(from_child.recv().as_slice() == \"22\");\n\n    from_child.send(23);\n    from_child.send(0);\n\n    assert!(from_child.recv().as_slice() == \"23\");\n    assert!(from_child.recv().as_slice() == \"0\");\n    println! (\"everything ok\");\n}\n```\n\nThe program output is this:\n\n```\neverything ok\ntask '<unnamed>' failed at 'receiving on a closed channel', /home/rustbuild/src/rust-buildbot/slave/dist2-linux/build/src/libsync/comm/mod.rs:806\n```\n\nIt seems to me, that during program termination, it is safe to kill everything listening on some channel before closing it, not afterwards, thus avoiding above error. Or does the ordering of the shutdown serve some purpose I overlooked?\n\nBTW I'm using the following build\n`rustc 0.11.0 (aa1163b92de7717eb7c5eba002b4012e0574a7fe 2014-06-27 12:50:16 -0700)`\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/15501/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/15501/timeline", "performed_via_github_app": null, "state_reason": "completed"}