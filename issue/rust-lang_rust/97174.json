{"url": "https://api.github.com/repos/rust-lang/rust/issues/97174", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/97174/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/97174/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/97174/events", "html_url": "https://github.com/rust-lang/rust/issues/97174", "id": 1241834395, "node_id": "I_kwDOAAsO6M5KBOOb", "number": 97174, "title": "NVPTX: \"LLVM ERROR: Cannot select\" when returning struct with 3byte size from \"device function\"", "user": {"login": "kjetilkjeka", "id": 5366742, "node_id": "MDQ6VXNlcjUzNjY3NDI=", "avatar_url": "https://avatars.githubusercontent.com/u/5366742?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kjetilkjeka", "html_url": "https://github.com/kjetilkjeka", "followers_url": "https://api.github.com/users/kjetilkjeka/followers", "following_url": "https://api.github.com/users/kjetilkjeka/following{/other_user}", "gists_url": "https://api.github.com/users/kjetilkjeka/gists{/gist_id}", "starred_url": "https://api.github.com/users/kjetilkjeka/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kjetilkjeka/subscriptions", "organizations_url": "https://api.github.com/users/kjetilkjeka/orgs", "repos_url": "https://api.github.com/users/kjetilkjeka/repos", "events_url": "https://api.github.com/users/kjetilkjeka/events{/privacy}", "received_events_url": "https://api.github.com/users/kjetilkjeka/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 510582527, "node_id": "MDU6TGFiZWw1MTA1ODI1Mjc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-NVPTX", "name": "O-NVPTX", "color": "6e6ec0", "default": false, "description": "Target: the NVPTX LLVM backend for running rust on GPUs, https://llvm.org/docs/NVPTXUsage.html"}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2022-05-19T13:58:53Z", "updated_at": "2022-12-27T14:48:30Z", "closed_at": "2022-12-27T14:48:29Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I tried this code (compiling with `rustc +nightly main_rs.rs --target nvptx64-nvidia-cuda --crate-type=cdylib --emit=asm`):\r\n\r\n```rust\r\n#![feature(abi_ptx)]\r\n#![no_std]\r\n\r\n#[panic_handler]\r\nunsafe fn breakpoint_panic_handler(_: &::core::panic::PanicInfo) -> ! {\r\n    loop {}\r\n    core::hint::unreachable_unchecked();\r\n}\r\n\r\n#[derive(Clone, Copy)]\r\npub struct Foo {\r\n    a: u8,\r\n    b: u8,\r\n    c: u8,\r\n}\r\n\r\n#[inline(never)]\r\nfn device(v: u8) -> Foo {\r\n    Foo {\r\n        a: v,\r\n        b: v,\r\n        c: v,\r\n    }\r\n}\r\n\r\n#[no_mangle]\r\npub unsafe extern \"ptx-kernel\" fn kernel(input: *const u8, output: *mut Foo) {\r\n    *output = device(input.read());\r\n}\r\n\r\n```\r\n\r\nI expected to see this happen: A well formed .ptx file\r\n\r\nInstead, this happened: The following error (from ptx linker)\r\n```\r\nLLVM ERROR: Cannot select: 0x7f8743a820d0: ch = NVPTXISD::StoreRetval<(store (s24), align 1)> 0x7f8743a82410, Constant:i32<0>, 0x7f8743a827b8\r\n  0x7f8743a822d8: i32 = Constant<0>\r\n  0x7f8743a827b8: i32 = or 0x7f8743a82a28, 0x7f8743a829c0\r\n    0x7f8743a82a28: i32 = or 0x7f8743a82000, 0x7f8743a824e0\r\n      0x7f8743a82000: i32 = shl 0x7f8743a82340, Constant:i32<8>\r\n        0x7f8743a82340: i32,ch = load<(dereferenceable load (s8) from %ir.6 + 1), zext from i8> 0x7f8743a82618, 0x7f8743a82820, undef:i64\r\n          0x7f8743a82820: i64 = or FrameIndex:i64<0>, Constant:i64<1>\r\n            0x7f8743a82c98: i64 = FrameIndex<0>\r\n            0x7f8743a82a90: i64 = Constant<1>\r\n          0x7f8743a823a8: i64 = undef\r\n        0x7f8743a826e8: i32 = Constant<8>\r\n      0x7f8743a824e0: i32,ch = load<(dereferenceable load (s8) from %ir.6), zext from i8> 0x7f8743a82618, FrameIndex:i64<0>, undef:i64\r\n        0x7f8743a82c98: i64 = FrameIndex<0>\r\n        0x7f8743a823a8: i64 = undef\r\n    0x7f8743a829c0: i32 = shl 0x7f8743a82478, Constant:i32<16>\r\n      0x7f8743a82478: i32,ch = load<(dereferenceable load (s8) from %ir.6 + 2), anyext from i8> 0x7f8743a82618, 0x7f8743a82750, undef:i64\r\n        0x7f8743a82750: i64 = or FrameIndex:i64<0>, Constant:i64<2>\r\n          0x7f8743a82c98: i64 = FrameIndex<0>\r\n          0x7f8743a82888: i64 = Constant<2>\r\n        0x7f8743a823a8: i64 = undef\r\n      0x7f8743a82c30: i32 = Constant<16>\r\nIn function: _ZN7main_rs6device17h13d51938dd622c57E\r\n```\r\n\r\n### Meta\r\n`rustc --version --verbose`:\r\n```\r\nrustc 1.63.0-nightly (4c5f6e627 2022-05-17)\r\n```\r\n\r\n### Comment\r\nIt seems like there are problems with the `NVPTXISD::StoreRetval` being used with a `s24`. I assume the problem is that a `s24` is not a valid type at all. If anyone knows where this problems originate, and if it's on the rustc or LLVM side I'm very thankful.\r\n\r\nI will do some experiments with clang, possibly this weekend, to see how device functions are being called with such types.\r\n\r\n\r\n\r\n", "closed_by": {"login": "kjetilkjeka", "id": 5366742, "node_id": "MDQ6VXNlcjUzNjY3NDI=", "avatar_url": "https://avatars.githubusercontent.com/u/5366742?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kjetilkjeka", "html_url": "https://github.com/kjetilkjeka", "followers_url": "https://api.github.com/users/kjetilkjeka/followers", "following_url": "https://api.github.com/users/kjetilkjeka/following{/other_user}", "gists_url": "https://api.github.com/users/kjetilkjeka/gists{/gist_id}", "starred_url": "https://api.github.com/users/kjetilkjeka/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kjetilkjeka/subscriptions", "organizations_url": "https://api.github.com/users/kjetilkjeka/orgs", "repos_url": "https://api.github.com/users/kjetilkjeka/repos", "events_url": "https://api.github.com/users/kjetilkjeka/events{/privacy}", "received_events_url": "https://api.github.com/users/kjetilkjeka/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/97174/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/97174/timeline", "performed_via_github_app": null, "state_reason": "completed"}