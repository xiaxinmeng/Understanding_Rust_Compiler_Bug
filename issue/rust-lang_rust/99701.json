{"url": "https://api.github.com/repos/rust-lang/rust/issues/99701", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/99701/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/99701/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/99701/events", "html_url": "https://github.com/rust-lang/rust/issues/99701", "id": 1316042916, "node_id": "I_kwDOAAsO6M5OcTik", "number": 99701, "title": "Miri `-Zmiri-retag-fields` libstd test failure inside `VecDeque::drain`", "user": {"login": "5225225", "id": 8584210, "node_id": "MDQ6VXNlcjg1ODQyMTA=", "avatar_url": "https://avatars.githubusercontent.com/u/8584210?v=4", "gravatar_id": "", "url": "https://api.github.com/users/5225225", "html_url": "https://github.com/5225225", "followers_url": "https://api.github.com/users/5225225/followers", "following_url": "https://api.github.com/users/5225225/following{/other_user}", "gists_url": "https://api.github.com/users/5225225/gists{/gist_id}", "starred_url": "https://api.github.com/users/5225225/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/5225225/subscriptions", "organizations_url": "https://api.github.com/users/5225225/orgs", "repos_url": "https://api.github.com/users/5225225/repos", "events_url": "https://api.github.com/users/5225225/events{/privacy}", "received_events_url": "https://api.github.com/users/5225225/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2022-07-24T23:55:14Z", "updated_at": "2022-08-13T14:30:16Z", "closed_at": "2022-08-13T14:30:16Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Using https://github.com/rust-lang/miri-test-libstd, running `MIRIFLAGS=\"-Zmiri-retag-fields\" ./run-test.sh alloc --all-targets collections::vec_deque::tests::test_drain`, I get\r\n\r\n```rust\r\nrunning 1 test\r\ntest collections::vec_deque::tests::test_drain ... error: Undefined Behavior: not granting access to tag <2685105> because incompatible item [SharedReadOnly for <3084900>] is protected by call 841439\r\n    --> /home/jess/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/intrinsics.rs:2547:9\r\n     |\r\n2547 |         copy(src, dst, count)\r\n     |         ^^^^^^^^^^^^^^^^^^^^^ not granting access to tag <2685105> because incompatible item [SharedReadOnly for <3084900>] is protected by call 841439\r\n     |\r\n     = help: this indicates a potential bug in the program: it performed an invalid operation, but the Stacked Borrows rules it violated are still experimental\r\n     = help: see https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md for further information\r\nhelp: <2685105> was created by a retag at offsets [0x0..0x40]\r\n    --> alloc_miri_test/../liballoc/src/raw_vec.rs:185:45\r\n     |\r\n185  |                 AllocInit::Uninitialized => alloc.allocate(layout),\r\n     |                                             ^^^^^^^^^^^^^^^^^^^^^^\r\nhelp: <2685105> was protected due to <3084896> which was created here\r\n    --> alloc_miri_test/../liballoc/src/collections/vec_deque/mod.rs:2991:65\r\n     |\r\n2991 |         <Self as SpecExtend<T, I::IntoIter>>::spec_extend(self, iter.into_iter());\r\n     |                                                                 ^^^^^^^^^^^^^^^^\r\nhelp: this protector is live for this call\r\n    --> alloc_miri_test/../liballoc/src/collections/vec_deque/spec_extend.rs:17:5\r\n     |\r\n17   | /     default fn spec_extend(&mut self, mut iter: I) {\r\n18   | |         // This function should be the moral equivalent of:\r\n19   | |         //\r\n20   | |         //      for item in iter {\r\n...    |\r\n34   | |         }\r\n35   | |     }\r\n     | |_____^\r\n     = note: backtrace:\r\n     = note: inside `core::intrinsics::copy::<usize>` at /home/jess/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/intrinsics.rs:2547:9\r\nnote: inside `collections::vec_deque::VecDeque::<usize>::copy` at alloc_miri_test/../liballoc/src/collections/vec_deque/mod.rs:273:13\r\n    --> alloc_miri_test/../liballoc/src/collections/vec_deque/mod.rs:273:13\r\n     |\r\n273  |             ptr::copy(self.ptr().add(src), self.ptr().add(dst), len);\r\n     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nnote: inside `collections::vec_deque::VecDeque::<usize>::wrap_copy` at alloc_miri_test/../liballoc/src/collections/vec_deque/mod.rs:339:21\r\n    --> alloc_miri_test/../liballoc/src/collections/vec_deque/mod.rs:339:21\r\n     |\r\n339  |                     self.copy(dst, src, len);\r\n     |                     ^^^^^^^^^^^^^^^^^^^^^^^^\r\nnote: inside `<<collections::vec_deque::drain::Drain<'_, T, A> as core::ops::Drop>::drop::DropGuard<usize, std::alloc::Global> as core::ops::Drop>::drop` at alloc_miri_test/../liballoc/src/collections/vec_deque/drain.rs:95:29\r\n    --> alloc_miri_test/../liballoc/src/collections/vec_deque/drain.rs:95:29\r\n     |\r\n95   | ...                   source_deque.wrap_copy(source_deque.tail, orig_tail, tail_len);\r\n     |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n     = note: inside `core::ptr::drop_in_place::<<collections::vec_deque::drain::Drain<'_, T, A> as core::ops::Drop>::drop::DropGuard<usize, std::alloc::Global>> - shim(Some(<collections::vec_deque::drain::Drain<'_, T, A> as core::ops::Drop>::drop::DropGuard<usize, std::alloc::Global>))` at /home/jess/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:487:1\r\nnote: inside `<collections::vec_deque::drain::Drain<usize> as core::ops::Drop>::drop` at alloc_miri_test/../liballoc/src/collections/vec_deque/drain.rs:111:24\r\n    --> alloc_miri_test/../liballoc/src/collections/vec_deque/drain.rs:111:24\r\n     |\r\n111  |         DropGuard(self);\r\n     |                        ^\r\n     = note: inside `core::ptr::drop_in_place::<collections::vec_deque::drain::Drain<usize>> - shim(Some(collections::vec_deque::drain::Drain<usize>))` at /home/jess/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:487:1\r\nnote: inside `<collections::vec_deque::VecDeque<usize> as collections::vec_deque::spec_extend::SpecExtend<usize, collections::vec_deque::drain::Drain<usize>>>::spec_extend` at alloc_miri_test/../liballoc/src/collections/vec_deque/spec_extend.rs:35:5\r\n    --> alloc_miri_test/../liballoc/src/collections/vec_deque/spec_extend.rs:35:5\r\n     |\r\n35   |     }\r\n     |     ^\r\nnote: inside `<collections::vec_deque::VecDeque<usize> as core::iter::Extend<usize>>::extend::<collections::vec_deque::drain::Drain<usize>>` at alloc_miri_test/../liballoc/src/collections/vec_deque/mod.rs:2991:9\r\n    --> alloc_miri_test/../liballoc/src/collections/vec_deque/mod.rs:2991:9\r\n     |\r\n2991 |         <Self as SpecExtend<T, I::IntoIter>>::spec_extend(self, iter.into_iter());\r\n     |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nnote: inside `<collections::vec_deque::VecDeque<usize> as core::iter::FromIterator<usize>>::from_iter::<collections::vec_deque::drain::Drain<usize>>` at alloc_miri_test/../liballoc/src/collections/vec_deque/mod.rs:2951:9\r\n    --> alloc_miri_test/../liballoc/src/collections/vec_deque/mod.rs:2951:9\r\n     |\r\n2951 |         deq.extend(iterator);\r\n     |         ^^^^^^^^^^^^^^^^^^^^\r\n     = note: inside `<collections::vec_deque::drain::Drain<usize> as core::iter::Iterator>::collect::<collections::vec_deque::VecDeque<usize>>` at /home/jess/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/iter/traits/iterator.rs:1836:9\r\nnote: inside `collections::vec_deque::tests::test_drain` at alloc_miri_test/../liballoc/src/collections/vec_deque/tests.rs:685:48\r\n    --> alloc_miri_test/../liballoc/src/collections/vec_deque/tests.rs:685:48\r\n     |\r\n685  |                     let drained: VecDeque<_> = tester.drain(drain_start..drain_end).collect();\r\n     |                                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nnote: inside closure at alloc_miri_test/../liballoc/src/collections/vec_deque/tests.rs:670:1\r\n    --> alloc_miri_test/../liballoc/src/collections/vec_deque/tests.rs:670:1\r\n     |\r\n669  |   #[test]\r\n     |   ------- in this procedural macro expansion\r\n670  | / fn test_drain() {\r\n671  | |     let mut tester: VecDeque<usize> = VecDeque::with_capacity(7);\r\n672  | |\r\n673  | |     let cap = tester.capacity();\r\n...    |\r\n701  | |     }\r\n702  | | }\r\n     | |_^\r\n     = note: this error originates in the attribute macro `test` (in Nightly builds, run with -Z macro-backtrace for more info)\r\n\r\nnote: some details are omitted, run with `MIRIFLAGS=-Zmiri-backtrace=full` for a verbose backtrace\r\n\r\nerror: aborting due to previous error\r\n\r\nerror: test failed, to rerun pass '--lib'\r\n```\r\n\r\nThe test is a bit large, will try and shrink this down, but figured I'd make the issue now. I can reproduce this by copy pasting the test into a normal rust file.", "closed_by": {"login": "5225225", "id": 8584210, "node_id": "MDQ6VXNlcjg1ODQyMTA=", "avatar_url": "https://avatars.githubusercontent.com/u/8584210?v=4", "gravatar_id": "", "url": "https://api.github.com/users/5225225", "html_url": "https://github.com/5225225", "followers_url": "https://api.github.com/users/5225225/followers", "following_url": "https://api.github.com/users/5225225/following{/other_user}", "gists_url": "https://api.github.com/users/5225225/gists{/gist_id}", "starred_url": "https://api.github.com/users/5225225/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/5225225/subscriptions", "organizations_url": "https://api.github.com/users/5225225/orgs", "repos_url": "https://api.github.com/users/5225225/repos", "events_url": "https://api.github.com/users/5225225/events{/privacy}", "received_events_url": "https://api.github.com/users/5225225/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/99701/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/99701/timeline", "performed_via_github_app": null, "state_reason": "completed"}