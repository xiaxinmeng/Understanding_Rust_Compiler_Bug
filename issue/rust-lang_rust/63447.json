{"url": "https://api.github.com/repos/rust-lang/rust/issues/63447", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/63447/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/63447/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/63447/events", "html_url": "https://github.com/rust-lang/rust/issues/63447", "id": 479295459, "node_id": "MDU6SXNzdWU0NzkyOTU0NTk=", "number": 63447, "title": "Incorrect Code Generation", "user": {"login": "npmccallum", "id": 288304, "node_id": "MDQ6VXNlcjI4ODMwNA==", "avatar_url": "https://avatars.githubusercontent.com/u/288304?v=4", "gravatar_id": "", "url": "https://api.github.com/users/npmccallum", "html_url": "https://github.com/npmccallum", "followers_url": "https://api.github.com/users/npmccallum/followers", "following_url": "https://api.github.com/users/npmccallum/following{/other_user}", "gists_url": "https://api.github.com/users/npmccallum/gists{/gist_id}", "starred_url": "https://api.github.com/users/npmccallum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/npmccallum/subscriptions", "organizations_url": "https://api.github.com/users/npmccallum/orgs", "repos_url": "https://api.github.com/users/npmccallum/repos", "events_url": "https://api.github.com/users/npmccallum/events{/privacy}", "received_events_url": "https://api.github.com/users/npmccallum/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2019-08-10T18:41:02Z", "updated_at": "2019-08-11T00:40:31Z", "closed_at": "2019-08-10T22:07:37Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "https://godbolt.org/z/Q0WgsL\r\n\r\n```rust\r\nuse std::os::raw::c_char;\r\nuse std::ffi::c_void;\r\n\r\nconst RTLD_NEXT: *mut c_void = -1i64 as *mut c_void;\r\n\r\nextern \"C\" {\r\n    fn dlsym(handle: *mut c_void,\r\n            symbol: *const c_char) -> *mut c_void;\r\n}\r\n\r\n#[allow(non_camel_case_types)]\r\ntype pid_t = i32;\r\n\r\n#[inline(never)]\r\nfn lookup<T: Copy>(_: T, name: *const u8) -> T {\r\n    unsafe {\r\n        let f = dlsym(RTLD_NEXT, name as *const c_char);\r\n        let f = &f as *const *mut c_void as *const T;\r\n        *f\r\n    }\r\n}\r\n\r\n#[no_mangle]\r\npub extern \"C\" fn getpid() -> pid_t {\r\n    let gp = lookup(getpid, \"getpid\\0\".as_ptr());\r\n    gp()\r\n}\r\n```\r\n\r\n`-C opt-level=0`:\r\n\r\n```asm\r\ncore::str::<impl str>::as_ptr:\r\n  pushq %rax\r\n  movq %rdi, %rax\r\n  movq %rsi, (%rsp)\r\n  popq %rcx\r\n  retq\r\n\r\nexample::lookup:\r\n  subq $24, %rsp\r\n  movq $-1, %rax\r\n  movq %rdi, 8(%rsp)\r\n  movq %rax, %rdi\r\n  movq 8(%rsp), %rsi\r\n  callq *dlsym@GOTPCREL(%rip)\r\n  movq %rax, 16(%rsp)\r\n  addq $24, %rsp\r\n  retq\r\n\r\ngetpid:\r\n  subq $24, %rsp\r\n  leaq .L__unnamed_1(%rip), %rax\r\n  movq %rax, %rdi\r\n  movl $7, %esi\r\n  callq core::str::<impl str>::as_ptr\r\n  movq %rax, 16(%rsp)\r\n  movq 16(%rsp), %rdi\r\n  callq example::lookup\r\n  callq *getpid@GOTPCREL(%rip)\r\n  movl %eax, 12(%rsp)\r\n  movl 12(%rsp), %eax\r\n  addq $24, %rsp\r\n  retq\r\n\r\n.L__unnamed_1:\r\n  .asciz \"getpid\"\r\n```\r\n\r\n`-C opt-level=3`:\r\n```asm\r\nexample::lookup:\r\n  leaq .L__unnamed_1(%rip), %rsi\r\n  movq $-1, %rdi\r\n  jmpq *dlsym@GOTPCREL(%rip)\r\n\r\ngetpid:\r\n  pushq %rax\r\n.LBB1_1:\r\n  callq example::lookup\r\n  jmp .LBB1_1\r\n\r\n.L__unnamed_1:\r\n  .asciz \"getpid\"\r\n```\r\n\r\nThe error is easiest to see under `-C opt-level=3`, though optimizers aren't causing the problem. The intent of the rust code is clearly to get the `RTLD_NEXT` version of `getpid()`. But for some reason Rust emits a recursive call.", "closed_by": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/63447/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/63447/timeline", "performed_via_github_app": null, "state_reason": "completed"}