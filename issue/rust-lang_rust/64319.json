{"url": "https://api.github.com/repos/rust-lang/rust/issues/64319", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/64319/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/64319/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/64319/events", "html_url": "https://github.com/rust-lang/rust/issues/64319", "id": 491276001, "node_id": "MDU6SXNzdWU0OTEyNzYwMDE=", "number": 64319, "title": "Symbol names may not correctly account for optimization level differences between crates", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37547, "node_id": "MDU6TGFiZWwzNzU0Nw==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-linkage", "name": "A-linkage", "color": "f7e101", "default": false, "description": "Area: linking into static, shared libraries and binaries"}, {"id": 234956, "node_id": "MDU6TGFiZWwyMzQ5NTY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-codegen", "name": "A-codegen", "color": "f7e101", "default": false, "description": "Area: Code generation"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2019-09-09T19:14:57Z", "updated_at": "2020-01-22T16:49:09Z", "closed_at": "2020-01-22T16:49:09Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "On investigating https://github.com/rust-lang/wg-cargo-std-aware/issues/32 I've managed to reduce this down to:\r\n\r\n```\r\n$ cat foo.rs\r\npub fn foo() {\r\n    bar::<usize>();\r\n}\r\n\r\npub fn bar<T>() {\r\n    baz();\r\n}\r\n\r\nfn baz() {}\r\n$ cat bar.rs\r\nextern crate foo;\r\n\r\npub fn bar() {\r\n    foo::foo();\r\n}\r\n$ rustc --crate-type rlib foo.rs\r\n$ rustc --crate-type dylib bar.rs -L .\r\n$ rustc --crate-type dylib bar.rs -L .  -C opt-level=2\r\nerror: linking with `link.exe` failed: exit code: 1120\r\n  |\r\n  = note: \"C:\\\\Program Files (x86)\\\\Microsoft Visual Studio\\\\2019\\\\Community\\\\VC\\\\Tools\\\\MSVC\\\\14.22.27905\\\\bin\\\\HostX64\\\\x64\\\\link.exe\" \"/NOLOGO\" \"/NXCOMPAT\" \"/LIBPATH:C:\\\\Users\\\\alex\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"bar.bar.3a1fbbbh-cgu.0.rcgu.o\" \"/OUT:bar.dll\" \"/DEF:C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\lib.def\" \"bar.13x131manznmlae2.rcgu.o\" \"bar.4hnz5vh12lvh2qha.rcgu.o\" \"/OPT:REF,ICF\" \"/DEBUG\" \"/NATVIS:C:\\\\Users\\\\alex\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\etc\\\\intrinsic.natvis\" \"/NATVIS:C:\\\\Users\\\\alex\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\etc\\\\liballoc.natvis\" \"/NATVIS:C:\\\\Users\\\\alex\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\etc\\\\libcore.natvis\" \"/LIBPATH:.\" \"/LIBPATH:C:\\\\Users\\\\alex\\\\.rustup\\\\toolchains\\\\stable-x86_64-pc-windows-msvc\\\\lib\\\\rustlib\\\\x86_64-pc-windows-msvc\\\\lib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\libfoo.rlib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\libstd-b2f27b8d08c4688f.rlib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\libpanic_unwind-9c73c9c2e052b2f1.rlib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\libbacktrace-7a588e8fa018f6bc.rlib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\librustc_demangle-74b71f441b8acffe.rlib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\libhashbrown-42efce06651eab9c.rlib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\librustc_std_workspace_alloc-7518db6030684168.rlib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\libunwind-f7edde5930d50b47.rlib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\libcfg_if-30189c8e78e151e8.rlib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\liblibc-5f5719f1cab83a12.rlib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\liballoc-f297c401e81b90c6.rlib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\librustc_std_workspace_core-f8c80c1aefab6a32.rlib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\libcore-6d66b6e58725d3ed.rlib\" \"C:\\\\Users\\\\alex\\\\AppData\\\\Local\\\\Temp\\\\rustcAYUABK\\\\libcompiler_builtins-1f6a73e107798f53.rlib\" \"advapi32.lib\" \"ws2_32.lib\" \"userenv.lib\" \"msvcrt.lib\" \"/DLL\" \"/IMPLIB:bar.dll.lib\"\r\n  = note: lib.def : error LNK2001: unresolved external symbol _ZN3foo3bar17h95b7da637b923d2cE\r\n          bar.dll.lib : fatal error LNK1120: 1 unresolved externals\r\n\r\n\r\nerror: aborting due to previous error\r\n```\r\n\r\nThe platform used here to reproduce the error is x86_64-pc-windows-msvc, but it looks like macOS also generates the same error. The error doesn't appear to manifest on Linux, presumably because the linker options just ignore non-defined symbols.\r\n\r\nHere you can see that when both crates are compiled with the same optimization level the link succeeds, but with different optimization levels the wrong symbol name is generated, so the wrong symbol is asked to be exported which causes an error.", "closed_by": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/64319/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/64319/timeline", "performed_via_github_app": null, "state_reason": "completed"}