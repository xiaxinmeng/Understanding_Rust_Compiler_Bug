{"url": "https://api.github.com/repos/rust-lang/rust/issues/33183", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/33183/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/33183/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/33183/events", "html_url": "https://github.com/rust-lang/rust/issues/33183", "id": 150699257, "node_id": "MDU6SXNzdWUxNTA2OTkyNTc=", "number": 33183, "title": "Command::env()/env_remove() freeze the parent's environment", "user": {"login": "oconnor663", "id": 860932, "node_id": "MDQ6VXNlcjg2MDkzMg==", "avatar_url": "https://avatars.githubusercontent.com/u/860932?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oconnor663", "html_url": "https://github.com/oconnor663", "followers_url": "https://api.github.com/users/oconnor663/followers", "following_url": "https://api.github.com/users/oconnor663/following{/other_user}", "gists_url": "https://api.github.com/users/oconnor663/gists{/gist_id}", "starred_url": "https://api.github.com/users/oconnor663/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oconnor663/subscriptions", "organizations_url": "https://api.github.com/users/oconnor663/orgs", "repos_url": "https://api.github.com/users/oconnor663/repos", "events_url": "https://api.github.com/users/oconnor663/events{/privacy}", "received_events_url": "https://api.github.com/users/oconnor663/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2016-04-24T20:59:18Z", "updated_at": "2016-04-25T13:17:16Z", "closed_at": "2016-04-25T13:17:16Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "An example:\n\n``` rust\nuse std::process::Command;\nuse std::env;\n\nfn main() {\n    // Create a command to echo $foo.\n    let mut c = Command::new(\"bash\");\n    c.arg(\"-c\").arg(\"echo $foo\");\n\n    // Set an unrelated variable. This caches the current environment.\n    c.env(\"UNRELATED_VARIABLE\", \"junk\");\n\n    // Define $foo in the parent. This has no effect on the child,\n    // because of the line above!\n    env::set_var(\"foo\", \"FOO IS DEFINED!!!\");\n\n    c.spawn().unwrap();\n}\n```\n\nThis program will run `echo $foo`, which prints an empty line because `$foo` is not defined in the child. But if we delete the line that sets `$UNRELATED_VARIABLE` and run again, we see `FOO IS DEFINED!!!` in the child's output.\n\nThe problem is that (at least in the unix implementation) the [`init_env_map` function](https://github.com/rust-lang/rust/blob/91aea5cf87953788477ccaa3a37c3f2c855e7a0a/src/libstd/sys/unix/process.rs#L129) caches the parent's environment the first time it's called. My preferred behavior would be that Command never caches anything from the parent, and instead reads the environment at the time the child is spawned. Does anyone know of code relying on the current behavior?\n", "closed_by": {"login": "oconnor663", "id": 860932, "node_id": "MDQ6VXNlcjg2MDkzMg==", "avatar_url": "https://avatars.githubusercontent.com/u/860932?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oconnor663", "html_url": "https://github.com/oconnor663", "followers_url": "https://api.github.com/users/oconnor663/followers", "following_url": "https://api.github.com/users/oconnor663/following{/other_user}", "gists_url": "https://api.github.com/users/oconnor663/gists{/gist_id}", "starred_url": "https://api.github.com/users/oconnor663/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oconnor663/subscriptions", "organizations_url": "https://api.github.com/users/oconnor663/orgs", "repos_url": "https://api.github.com/users/oconnor663/repos", "events_url": "https://api.github.com/users/oconnor663/events{/privacy}", "received_events_url": "https://api.github.com/users/oconnor663/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/33183/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/33183/timeline", "performed_via_github_app": null, "state_reason": "completed"}