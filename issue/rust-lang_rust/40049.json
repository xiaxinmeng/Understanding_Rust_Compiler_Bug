{"url": "https://api.github.com/repos/rust-lang/rust/issues/40049", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/40049/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/40049/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/40049/events", "html_url": "https://github.com/rust-lang/rust/issues/40049", "id": 209678213, "node_id": "MDU6SXNzdWUyMDk2NzgyMTM=", "number": 40049, "title": "change musl linker to /lib/ld-musl-x86_64.so.1 or support -dynamic-linker option", "user": {"login": "vishvananda", "id": 142222, "node_id": "MDQ6VXNlcjE0MjIyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/142222?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vishvananda", "html_url": "https://github.com/vishvananda", "followers_url": "https://api.github.com/users/vishvananda/followers", "following_url": "https://api.github.com/users/vishvananda/following{/other_user}", "gists_url": "https://api.github.com/users/vishvananda/gists{/gist_id}", "starred_url": "https://api.github.com/users/vishvananda/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vishvananda/subscriptions", "organizations_url": "https://api.github.com/users/vishvananda/orgs", "repos_url": "https://api.github.com/users/vishvananda/repos", "events_url": "https://api.github.com/users/vishvananda/events{/privacy}", "received_events_url": "https://api.github.com/users/vishvananda/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 11, "created_at": "2017-02-23T06:46:04Z", "updated_at": "2020-04-30T12:42:28Z", "closed_at": "2017-02-23T20:11:58Z", "author_association": "NONE", "active_lock_reason": null, "body": "I've been attempting to build libraries for the x86_64-unknown-linux-musl target. I've managed to get static linking working. Dynamic linking is very close. Consider the following steps.\r\n\r\n1. build libseccomp with musl:\r\n```\r\n    git clone https://github.com/seccomp/libseccomp\r\n    cd libseccomp\r\n    ./autogen.sh\r\n    CPPFLAGS=\"-I/usr/include/x86_64-linux-musl\" ./configure --enable-static\r\n    make\r\n```\r\n2. build a project that includes the libseccomp-sys crate and include the new seccomp:\r\n```\r\n    RUSTFLAGS=\"-L native=/path/to/libseccomp/src/.libs -l static=seccomp\"\r\n    cargo build --verbose --target  x86_64-unknown-linux-musl\r\n```\r\n3. attempt to build with a dynamic library (ignore for the moment that this pulls in libc, still working on that issue):\r\n```\r\n    RUSTFLAGS=\"-L native=/path/to/libseccomp/src/.libs\"\r\n    cargo build --verbose --target  x86_64-unknown-linux-musl\r\n    # using something from libseccomp segfaults because it tries to use the default loader\r\n    LD_LIBRARY_PATH=/path/to/libseccomp/src/.libs ldd railcar\r\n        linux-vdso.so.1 =>  (0x00007ffd5d5fe000)\r\n        libseccomp.so.0 => /path/to/libseccomp/src/.libs/libseccomp.so.0 (0x00007f9b4e9ee000)\r\n        /lib64/ld-linux-x86-64.so.2 (0x0000558a2ea4f000)\r\n        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f9b4e618000)\r\n```\r\n4. replace the dynamic linker with the musl one:\r\n```\r\n    patchelf --set-interpreter /lib/ld-musl-x86_64.so.1 $BINARY\r\n    patchelf --remove-needed ld-linux-x86-64.so.2 $BINARY\r\n    LD_LIBRARY_PATH=/path/to/libseccomp/src/.libs ./$BINARY\r\n    # runs without error\r\n    LD_LIBRARY_PATH=/path/to/libseccomp/src/.libs ldd railcar\r\n        linux-vdso.so.1 =>  (0x00007fffea727000)\r\n        libseccomp.so.0 => /path/to/libseccomp/src/.libs/libseccomp.so.0 (0x00007f267f87d000)\r\n        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f267f4a7000)\r\n        /lib/ld-musl-x86_64.so.1 => /lib64/ld-linux-x86-64.so.2 (0x0000555f3380c000)\r\n```\r\n5. try to build binary with the right interpreter\r\n```\r\n    RUSTFLAGS=\"-L native=/path/to/libseccomp/src/.libs -C link-arg=-dynamic-linker=/lib/ld-musl-x86_64.so.1\"\r\n    cargo build --verbose --target  x86_64-unknown-linux-musl\r\n    patchelf --print-interpreter $BINARY\r\n        /lib64/ld-linux-x86-64.so.2\r\n```\r\nAny ideas why the -dynamic-linker arg is getting ignored when building my binary?", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/40049/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/40049/timeline", "performed_via_github_app": null, "state_reason": "completed"}