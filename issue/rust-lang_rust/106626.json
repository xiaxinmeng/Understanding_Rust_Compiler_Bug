{"url": "https://api.github.com/repos/rust-lang/rust/issues/106626", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/106626/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/106626/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/106626/events", "html_url": "https://github.com/rust-lang/rust/issues/106626", "id": 1525237006, "node_id": "I_kwDOAAsO6M5a6UUO", "number": 106626, "title": "`#[thread_local]` code gets compiled on targets that don't support it (and code does not work correctly)", "user": {"login": "flba-eb", "id": 108917393, "node_id": "U_kgDOBn3ykQ", "avatar_url": "https://avatars.githubusercontent.com/u/108917393?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flba-eb", "html_url": "https://github.com/flba-eb", "followers_url": "https://api.github.com/users/flba-eb/followers", "following_url": "https://api.github.com/users/flba-eb/following{/other_user}", "gists_url": "https://api.github.com/users/flba-eb/gists{/gist_id}", "starred_url": "https://api.github.com/users/flba-eb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flba-eb/subscriptions", "organizations_url": "https://api.github.com/users/flba-eb/orgs", "repos_url": "https://api.github.com/users/flba-eb/repos", "events_url": "https://api.github.com/users/flba-eb/events{/privacy}", "received_events_url": "https://api.github.com/users/flba-eb/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2023-01-09T09:39:34Z", "updated_at": "2023-01-16T16:01:19Z", "closed_at": "2023-01-16T16:01:19Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "@gh-tr and I have been trying to figure out why the test case [tls.rs](https://github.com/rust-lang/rust/blob/master/src/test/ui/thread-local/tls.rs) does not succeed on the QNX/Neutrino operating system. On this system, [TLS support is disabled in TargetOptions](https://github.com/rust-lang/rust/blob/5e656baf8bc832d3b77a1e49373352b3b2685fc0/compiler/rustc_target/src/spec/nto_qnx_base.rs#L11).\r\nThe test code compiles but at runtime both threads get the same address for the thread-local value.\r\n\r\nAfter a [discussion on zulip](https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/TLS.20.28thread.20local.20storage.29.20emulate.20or.20not) with @bjorn3 , @thomcc and @Amanieu my conclusion is that `#[thread_local]` is only supposed to work on targets that have TLS enabled in their `TargetOptions`.\r\n\r\nIf this is correct, then:\r\n\r\nWhy does the compiler accept it? Is this a bug in the compiler (even though the nightly feature is not stabilized)? Should it reject the code (of the test case on this target)? Or should we just ignore the test case?\r\n\r\nWe've noticed that when enabling emulated TLS in the compiler for QNX, the issue goes away.  Is this the reason this test case succeeds on other targets that don't support thread_local but have emulated TLS enabled in the compiler such as Android?  Are there other OS's that don't support thread_local, don't have emulated TLS enabled in the compiler and are passing this test?\r\nShould the test be disabled on all targets that don't support TLS, or is this always expected to succeed? \r\n\r\nWe've seen this for months in different Rust versions (e.g. [master from 19th of December 2022](https://github.com/rust-lang/rust/commit/10723378900ba2d25fc5d8baf785e1082f385832) or from [9th of January 2023](https://github.com/rust-lang/rust/commit/a377893da2cd7124e5a18c7116cbb70e16dd5541)). Target is [x86_64-pc-nto-qnx710](https://doc.rust-lang.org/nightly/rustc/platform-support/nto-qnx.html).\r\n\r\nAny help is appreciated!", "closed_by": {"login": "flba-eb", "id": 108917393, "node_id": "U_kgDOBn3ykQ", "avatar_url": "https://avatars.githubusercontent.com/u/108917393?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flba-eb", "html_url": "https://github.com/flba-eb", "followers_url": "https://api.github.com/users/flba-eb/followers", "following_url": "https://api.github.com/users/flba-eb/following{/other_user}", "gists_url": "https://api.github.com/users/flba-eb/gists{/gist_id}", "starred_url": "https://api.github.com/users/flba-eb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flba-eb/subscriptions", "organizations_url": "https://api.github.com/users/flba-eb/orgs", "repos_url": "https://api.github.com/users/flba-eb/repos", "events_url": "https://api.github.com/users/flba-eb/events{/privacy}", "received_events_url": "https://api.github.com/users/flba-eb/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/106626/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/106626/timeline", "performed_via_github_app": null, "state_reason": "completed"}