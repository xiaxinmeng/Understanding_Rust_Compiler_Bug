{"url": "https://api.github.com/repos/rust-lang/rust/issues/60012", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/60012/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/60012/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/60012/events", "html_url": "https://github.com/rust-lang/rust/issues/60012", "id": 433821696, "node_id": "MDU6SXNzdWU0MzM4MjE2OTY=", "number": 60012, "title": "`riscv64gc-unknown-none-elf` target generates soft-float ABI", "user": {"login": "laanwj", "id": 126646, "node_id": "MDQ6VXNlcjEyNjY0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4", "gravatar_id": "", "url": "https://api.github.com/users/laanwj", "html_url": "https://github.com/laanwj", "followers_url": "https://api.github.com/users/laanwj/followers", "following_url": "https://api.github.com/users/laanwj/following{/other_user}", "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}", "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions", "organizations_url": "https://api.github.com/users/laanwj/orgs", "repos_url": "https://api.github.com/users/laanwj/repos", "events_url": "https://api.github.com/users/laanwj/events{/privacy}", "received_events_url": "https://api.github.com/users/laanwj/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 1210355734, "node_id": "MDU6TGFiZWwxMjEwMzU1NzM0", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-riscv", "name": "O-riscv", "color": "6e6ec0", "default": false, "description": "Target: RISC-V architecture"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2019-04-16T14:45:33Z", "updated_at": "2019-05-11T10:51:14Z", "closed_at": "2019-05-11T10:51:14Z", "author_association": "NONE", "active_lock_reason": null, "body": "tl;dr: confusion about float ABI in rust-generated RV64 object files\r\n\r\nTo do a little testing with Rust on Kendryte K210 (RV64GC) without having to write a full BSP, I'm trying to link the output of rust into an existing bare-metal project,\r\n\r\nWith the following source:\r\n```rust\r\n#![no_std]\r\n\r\nuse core::panic::PanicInfo;\r\n\r\n#[panic_handler]\r\nfn panic(_info: &PanicInfo) -> ! {\r\n        loop {}\r\n}\r\n\r\n#[allow(non_camel_case_types)]\r\ntype size_t = usize;\r\n\r\nextern {\r\n    fn callback_to_c(input: *const u8, input_length: size_t, val: f32);\r\n}\r\n\r\n#[no_mangle]\r\npub extern fn rust_main() {\r\n    let x: f32 = 3.0;\r\n    let test = \"string\";\r\n    unsafe {\r\n        callback_to_c(test.as_ptr(), test.len(), x);\r\n    }\r\n}\r\n```\r\nHowever, it looks like the output (see `flags` is marked as soft-float ABI):\r\n```bash\r\n$ rustc +nightly --version\r\nrustc 1.35.0-nightly (2975a3c4b 2019-04-15)\r\n$ rustc +nightly --target riscv64gc-unknown-none-elf --crate-type staticlib --release src/lib.rs\r\n$ readelf -a liblib.a |head -n 20\r\n\r\nFile: liblib.a(lib.lib.3a1fbbbh-cgu.0.rcgu.o)\r\nELF Header:\r\n  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00\r\n  Class:                             ELF64\r\n  Data:                              2's complement, little endian\r\n  Version:                           1 (current)\r\n  OS/ABI:                            UNIX - System V\r\n  ABI Version:                       0\r\n  Type:                              REL (Relocatable file)\r\n  Machine:                           RISC-V\r\n  Version:                           0x1\r\n  Entry point address:               0x0\r\n  Start of program headers:          0 (bytes into file)\r\n  Start of section headers:          296 (bytes into file)\r\n--->  Flags:                             0x1, RVC, soft-float ABI  <----\r\n  Size of this header:               64 (bytes)\r\n  Size of program headers:           0 (bytes)\r\n  Number of program headers:         0\r\n  Size of section headers:           64 (bytes)\r\n```\r\nThis causes the following error during link:\r\n```\r\n/opt/kendryte-toolchain/lib/gcc/riscv64-unknown-elf/8.2.0/../../../../riscv64-unknown-elf/bin/ld: /home/user/maixgo/rust-test/target/riscv64gc-unknown-none-elf/release/librust_test.a(rust_test-235c1d6ff76f1afc.rust_test.412mpu3z-cgu.0.rcgu.o):\r\ncan't link hard-float modules with soft-float modules\r\n```\r\nThe expected value for `flags` would be, in this specific case:\r\n```\r\n   Flags:                             0x3, RVC, single-float ABI\r\n```\r\n\r\nTo be honest I don't know if this is expected or not! For gcc it seems to have to do with the `-mabi` flag\u2014I'm not sure what ABI we'd be expecting Rust to generate here:\r\n```\r\n$ riscv64-unknown-elf-gcc -mabi=lp64d -march=rv64gc test.c -c -o test.o && readelf -h test.o|grep Flags\r\n  Flags:                             0x5, RVC, double-float ABI\r\n$ riscv64-unknown-elf-gcc -mabi=lp64f -march=rv64gc test.c -c -o test.o && readelf -h test.o|grep Flags\r\n  Flags:                             0x3, RVC, single-float ABI\r\n$ riscv64-unknown-elf-gcc -mabi=lp64 -march=rv64gc test.c -c -o test.o && readelf -h test.o|grep Flags\r\n  Flags:                             0x1, RVC, soft-float ABI\r\n```\r\n", "closed_by": {"login": "laanwj", "id": 126646, "node_id": "MDQ6VXNlcjEyNjY0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4", "gravatar_id": "", "url": "https://api.github.com/users/laanwj", "html_url": "https://github.com/laanwj", "followers_url": "https://api.github.com/users/laanwj/followers", "following_url": "https://api.github.com/users/laanwj/following{/other_user}", "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}", "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions", "organizations_url": "https://api.github.com/users/laanwj/orgs", "repos_url": "https://api.github.com/users/laanwj/repos", "events_url": "https://api.github.com/users/laanwj/events{/privacy}", "received_events_url": "https://api.github.com/users/laanwj/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/60012/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/60012/timeline", "performed_via_github_app": null, "state_reason": "completed"}