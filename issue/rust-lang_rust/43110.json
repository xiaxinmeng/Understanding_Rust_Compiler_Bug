{"url": "https://api.github.com/repos/rust-lang/rust/issues/43110", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/43110/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/43110/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/43110/events", "html_url": "https://github.com/rust-lang/rust/issues/43110", "id": 241312552, "node_id": "MDU6SXNzdWUyNDEzMTI1NTI=", "number": 43110, "title": "Today's nightly (stack probes) causes capnpc to segfault", "user": {"login": "FauxFaux", "id": 328180, "node_id": "MDQ6VXNlcjMyODE4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/328180?v=4", "gravatar_id": "", "url": "https://api.github.com/users/FauxFaux", "html_url": "https://github.com/FauxFaux", "followers_url": "https://api.github.com/users/FauxFaux/followers", "following_url": "https://api.github.com/users/FauxFaux/following{/other_user}", "gists_url": "https://api.github.com/users/FauxFaux/gists{/gist_id}", "starred_url": "https://api.github.com/users/FauxFaux/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/FauxFaux/subscriptions", "organizations_url": "https://api.github.com/users/FauxFaux/orgs", "repos_url": "https://api.github.com/users/FauxFaux/repos", "events_url": "https://api.github.com/users/FauxFaux/events{/privacy}", "received_events_url": "https://api.github.com/users/FauxFaux/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-07-07T16:17:56Z", "updated_at": "2017-07-07T17:36:55Z", "closed_at": "2017-07-07T17:36:55Z", "author_association": "NONE", "active_lock_reason": null, "body": "When `capnpc` is called from a build script, it segfaults. This did not happen on yesterday's nightly. It doesn't seem to happen outside of build scripts. I don't get why that would be.\r\n\r\nTestcase: https://github.com/FauxFaux/capnpc-segfault\r\n\r\nYou need `capnp` on your path (although it's irrelevant); `apt install capnproto` on recent Debian/Ubuntu.\r\n\r\n```\r\n% rustup run nightly-2017-07-06 cargo build\r\n    Finished dev [unoptimized + debuginfo] target(s) in 0.0 secs\r\n\r\n% rustup run nightly cargo build \r\n   Compiling capnpc-segfault v0.1.0 (fi...t)\r\nerror: failed to run custom build command for `capnpc-segfault v0.1.0 (fi..t)`\r\nprocess didn't exit successfully: `...lt/target/debug/build/c...4a/build-script-build` (signal: 11, SIGSEGV: invalid memory reference)\r\n\r\n% rustup run nightly rustc --version\r\nrustc 1.20.0-nightly (696412de7 2017-07-06)\r\n```\r\n\r\n```\r\n% OUT_DIR=/tmp RUST_BACKTRACE=1 rust-gdb --args target/debug/build/*/build-script-build /tmp\r\n...\r\n(gdb) bt\r\n#0  0x000055555567f8ec in compiler_builtins::probestack::__rust_probestack () at /checkout/src/rustc/compiler_builtins_shim/../../libcompiler_builtins/src/probestack.rs:55\r\n#1  0x00005555555f0e31 in capnpc::codegen::generate_node (gen=0x0, node_id=0, node_name=\"\", parent_node_id=core::option::Option::None) at /home/faux/.cargo/registry/src/github.com-1ecc6299db9ec823/capnpc-0.8.5/src/codegen.rs:1014\r\n#2  0x00005555555f166d in capnpc::codegen::generate_node (gen=0x7fffffffc3f0, node_id=12947750709585725918, node_name=\"entry\", parent_node_id=core::option::Option::None)\r\n    at /home/faux/.cargo/registry/src/github.com-1ecc6299db9ec823/capnpc-0.8.5/src/codegen.rs:1030\r\n#3  0x0000555555617988 in capnpc::codegen::main<std::process::ChildStdout> (inp=ChildStdout = {...}, out_dir=0x7ffff6c20038) at /home/faux/.cargo/registry/src/github.com-1ecc6299db9ec823/capnpc-0.8.5/src/codegen.rs:1846\r\n#4  0x0000555555624b44 in capnpc::run_command (command=Command = {...}) at /home/faux/.cargo/registry/src/github.com-1ecc6299db9ec823/capnpc-0.8.5/src/lib.rs:76\r\n#5  0x0000555555625849 in capnpc::CompilerCommand::run (self=0x7fffffffde30) at /home/faux/.cargo/registry/src/github.com-1ecc6299db9ec823/capnpc-0.8.5/src/lib.rs:162\r\n#6  0x0000555555566831 in build_script_build::main () at build.rs:4\r\n```\r\n\r\nThe faulting code looks pretty innocent, and we're only two frames down the recursion?\r\n\r\nhttps://github.com/capnproto/capnpc-rust/blob/e775eec5af5eea77e8ed4919a647fab9fc877343/src/codegen.rs#L1019\r\n\r\nPresumably related to https://github.com/rust-lang/rust/commit/5dbd97de3d825c6898df62baca33ff1f57cb77eb / #43052.\r\n\r\nHappens on this machine:\r\n * Ubuntu Zesty (17.04); `4.10.0-26-generic #30-Ubuntu` `amd64`, i7 Ivy-Bridge, 24GB RAM.\r\n\r\nBut not on:\r\n * Ubuntu Trusty (16.04); `4.4.0-79-generic #100-Ubuntu`, `amd64`, E3-1 Xeon, 16GB RAM.\r\n\r\n...presumably because the second machine has not been rebooted to pick up the stack guard fixes.\r\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/43110/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/43110/timeline", "performed_via_github_app": null, "state_reason": "completed"}