{"url": "https://api.github.com/repos/rust-lang/rust/issues/96158", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/96158/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/96158/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/96158/events", "html_url": "https://github.com/rust-lang/rust/issues/96158", "id": 1206495549, "node_id": "I_kwDOAAsO6M5H6ak9", "number": 96158, "title": "enum padding incorrectly has Scalar::Initialized layout", "user": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2022-04-17T21:59:42Z", "updated_at": "2022-04-22T13:56:07Z", "closed_at": "2022-04-22T13:56:07Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "https://github.com/rust-lang/rust/pull/94527 extended our `Scalar` layout with the notion of whether a scalar has to be initialized or not. Miri enforces this, and also uses it to know whether it can use a more efficient representation for scalars that *have* to be initialized.\r\n\r\nHowever, in some situations we currently compute a `Scalar::Initialized` layout when it should be `Scalar::Union` (aka \"may be uninitialized\" -- maybe we should rename it to `Scalar::MaybeUninit`). Specifically, `Option<u32>` [has](https://play.rust-lang.org/?version=nightly&mode=debug&edition=2021&gist=92914061696d357eb96f359bfa1c9978):\r\n```\r\n           abi: ScalarPair(\r\n               Initialized {\r\n                   value: Int(\r\n                       I32,\r\n                       false,\r\n                   ),\r\n                   valid_range: 0..=1,\r\n               },\r\n               Initialized {\r\n                   value: Int(\r\n                       I32,\r\n                       false,\r\n                   ),\r\n                   valid_range: 0..=4294967295,\r\n               },\r\n           ),\r\n```\r\nNote that this claims that the second field must be always initialized. This is not true though, since for a `None` that second field is padding and hence does not have to be initialized.\r\n\r\nThis causes https://github.com/rust-lang/miri/issues/2068.\r\n@oli-obk any idea how hard this is to fix?\r\n\r\n(To be clear, this bug only causes problems in Miri, not during regular codegen -- at least for now, since we don't [yet] tell LLVM about this \"must be initialized\" thing.)", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/96158/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/96158/timeline", "performed_via_github_app": null, "state_reason": "completed"}