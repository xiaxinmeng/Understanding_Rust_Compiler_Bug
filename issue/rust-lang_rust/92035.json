{"url": "https://api.github.com/repos/rust-lang/rust/issues/92035", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/92035/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/92035/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/92035/events", "html_url": "https://github.com/rust-lang/rust/issues/92035", "id": 1083213367, "node_id": "I_kwDOAAsO6M5AkIY3", "number": 92035, "title": "[ER] Missed Vec allocation elision", "user": {"login": "leonardo-m", "id": 22328461, "node_id": "MDQ6VXNlcjIyMzI4NDYx", "avatar_url": "https://avatars.githubusercontent.com/u/22328461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/leonardo-m", "html_url": "https://github.com/leonardo-m", "followers_url": "https://api.github.com/users/leonardo-m/followers", "following_url": "https://api.github.com/users/leonardo-m/following{/other_user}", "gists_url": "https://api.github.com/users/leonardo-m/gists{/gist_id}", "starred_url": "https://api.github.com/users/leonardo-m/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/leonardo-m/subscriptions", "organizations_url": "https://api.github.com/users/leonardo-m/orgs", "repos_url": "https://api.github.com/users/leonardo-m/repos", "events_url": "https://api.github.com/users/leonardo-m/events{/privacy}", "received_events_url": "https://api.github.com/users/leonardo-m/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2021-12-17T12:29:20Z", "updated_at": "2021-12-17T19:35:51Z", "closed_at": "2021-12-17T19:35:51Z", "author_association": "NONE", "active_lock_reason": null, "body": "This code compiled in release mode (1.59.0-nightly 5531927e8 2021-12-16):\r\n\r\n```rust\r\n#![feature(box_syntax)]\r\n\r\npub fn foo(_n: usize) -> u32 {\r\n    let a =  box [0_u32; 1001];\r\n    a[0]\r\n}\r\n```\r\n\r\nOptimizes nicely:\r\n \r\n```asm\r\nexample::foo:\r\n        xor     eax, eax\r\n        ret\r\n```\r\n\r\nWhile similar code with a run-time length vec:\r\n\r\n```rust\r\npub fn foo(n: usize) -> u32 {\r\n    let a = vec![0_u32; n + 1];\r\n    a[0]\r\n}\r\n```\r\n\r\nIsn't optimized well enough:\r\n\r\n```asm\r\ncore::ptr::drop_in_place<alloc::vec::Vec<u32>>:\r\n        mov     rsi, qword ptr [rdi + 8]\r\n        test    rsi, rsi\r\n        je      .LBB0_2\r\n        shl     rsi, 2\r\n        test    rsi, rsi\r\n        je      .LBB0_2\r\n        mov     rdi, qword ptr [rdi]\r\n        mov     edx, 4\r\n        jmp     qword ptr [rip + __rust_dealloc@GOTPCREL]\r\n.LBB0_2:\r\n        ret\r\n\r\nexample::foo:\r\n        push    r15\r\n        push    r14\r\n        push    rbx\r\n        sub     rsp, 32\r\n        mov     r15, rdi\r\n        add     r15, 1\r\n        mov     ecx, 4\r\n        xor     ebx, ebx\r\n        mov     rax, r15\r\n        mul     rcx\r\n        mov     r14, rax\r\n        setno   al\r\n        jo      .LBB1_12\r\n        mov     bl, al\r\n        shl     rbx, 2\r\n        test    r14, r14\r\n        je      .LBB1_2\r\n        mov     rdi, r14\r\n        mov     rsi, rbx\r\n        call    qword ptr [rip + __rust_alloc_zeroed@GOTPCREL]\r\n        test    rax, rax\r\n        je      .LBB1_13\r\n.LBB1_5:\r\n        mov     rcx, r14\r\n        shr     rcx, 2\r\n        mov     qword ptr [rsp + 8], rax\r\n        mov     qword ptr [rsp + 16], rcx\r\n        mov     qword ptr [rsp + 24], r15\r\n        test    r15, r15\r\n        je      .LBB1_6\r\n        mov     ebx, dword ptr [rax]\r\n        test    r14, r14\r\n        je      .LBB1_10\r\n        mov     edx, 4\r\n        mov     rdi, rax\r\n        mov     rsi, r14\r\n        call    qword ptr [rip + __rust_dealloc@GOTPCREL]\r\n.LBB1_10:\r\n        mov     eax, ebx\r\n        add     rsp, 32\r\n        pop     rbx\r\n        pop     r14\r\n        pop     r15\r\n        ret\r\n.LBB1_2:\r\n        mov     rax, rbx\r\n        test    rax, rax\r\n        jne     .LBB1_5\r\n.LBB1_13:\r\n        mov     rdi, r14\r\n        mov     rsi, rbx\r\n        call    qword ptr [rip + alloc::alloc::handle_alloc_error@GOTPCREL]\r\n        ud2\r\n.LBB1_6:\r\n        lea     rdx, [rip + .L__unnamed_1]\r\n        xor     edi, edi\r\n        xor     esi, esi\r\n        call    qword ptr [rip + core::panicking::panic_bounds_check@GOTPCREL]\r\n        ud2\r\n.LBB1_12:\r\n        call    qword ptr [rip + alloc::raw_vec::capacity_overflow@GOTPCREL]\r\n        ud2\r\n        mov     rbx, rax\r\n        lea     rdi, [rsp + 8]\r\n        call    core::ptr::drop_in_place<alloc::vec::Vec<u32>>\r\n        mov     rdi, rbx\r\n        call    _Unwind_Resume@PLT\r\n        ud2\r\n\r\n.L__unnamed_2:\r\n        .ascii  \"/app/example.rs\"\r\n\r\n.L__unnamed_1:\r\n        .quad   .L__unnamed_2\r\n        .asciz  \"\\017\\000\\000\\000\\000\\000\\000\\000\\003\\000\\000\\000\\005\\000\\000\"\r\n\r\nDW.ref.rust_eh_personality:\r\n        .quad   rust_eh_personality\r\n```\r\n", "closed_by": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/92035/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/92035/timeline", "performed_via_github_app": null, "state_reason": "completed"}