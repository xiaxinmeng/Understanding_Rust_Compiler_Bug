{"url": "https://api.github.com/repos/rust-lang/rust/issues/32085", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/32085/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/32085/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/32085/events", "html_url": "https://github.com/rust-lang/rust/issues/32085", "id": 138841108, "node_id": "MDU6SXNzdWUxMzg4NDExMDg=", "number": 32085, "title": "Don't return an error after a partial write in `LineWriter`", "user": {"login": "Stebalien", "id": 310393, "node_id": "MDQ6VXNlcjMxMDM5Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/310393?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Stebalien", "html_url": "https://github.com/Stebalien", "followers_url": "https://api.github.com/users/Stebalien/followers", "following_url": "https://api.github.com/users/Stebalien/following{/other_user}", "gists_url": "https://api.github.com/users/Stebalien/gists{/gist_id}", "starred_url": "https://api.github.com/users/Stebalien/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Stebalien/subscriptions", "organizations_url": "https://api.github.com/users/Stebalien/orgs", "repos_url": "https://api.github.com/users/Stebalien/repos", "events_url": "https://api.github.com/users/Stebalien/events{/privacy}", "received_events_url": "https://api.github.com/users/Stebalien/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2016-03-06T21:32:14Z", "updated_at": "2016-03-10T22:57:37Z", "closed_at": "2016-03-10T22:57:37Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "`LineWriter` can return an error after a partial write if flushing the inner `BufWriter` fails (https://github.com/rust-lang/rust/blob/cb343c33acf0f9833d8d6eb637234acf4321976b/src/libstd/io/buffered.rs#L766). It should instead return `Ok(bytes_written)`, ignoring the error.\n## OLD REPORT:\n\nI originally thought this problem was systematic so I audited stdlib. Apparently it isn't... See below.\n\nThe write trait guarantees:\n\n> If an error is returned then no bytes in the buffer were written to this writer.\n\nHowever, this is violated all over stdlib. For example, if `\"abc\\nde\"` is written to a `LineWriter`, the `LineWriter` could write `\"abc\"`, try to flush, and then return an error due to a failed flush. However, `\"abc\"` has been written violating the spec.\n\nIMO, the solution is to return `Ok(amount_written)` for partial writes and drop the error (if any). This should be safe because of write's write-xor-error guarantee. If the error was transient, the caller never needs to know. Otherwise, they will will learn of it on the next write.\n\nHere's everything in the stdlib that implements write (and should be audited):\n- [x] `Sink` in `librustdoc/test.rs`\n- [x] `Sink` in `libstd/io/util.rs`\n- [x] `&'a mut W` in `libstd/io/impls.rs`\n- [x] `Box<W>` in `libstd/io/impls.rs`\n- [x] `&'a mut [u8]` in `libstd/io/impls.rs`\n- [x] `Vec<u8>` in `libstd/io/impls.rs`\n- [x] `Cursor<&'a mut [u8]>` in `libstd/io/cursor.rs`\n- [x] `Cursor<Vec<u8>>` in `libstd/io/cursor.rs`\n- [x] `Cursor<Box<[u8]>>` in `libstd/io/cursor.rs`\n- [x] `StdoutRaw` in `libstd/io/stdio.rs`\n- [x] `StderrRaw` in `libstd/io/stdio.rs`\n- [x] `Maybe<W>` in `libstd/io/stdio.rs`\n- [x] `Stdout` in `libstd/io/stdio.rs`\n- [x] `StdoutLock<'a>` in `libstd/io/stdio.rs`\n- [x] `Stderr` in `libstd/io/stdio.rs`\n- [x] `StderrLock<'a>` in `libstd/io/stdio.rs`\n- [x] `BufWriter<W>` in `libstd/io/buffered.rs`\n- [ ] `LineWriter<W>` in `libstd/io/buffered.rs` (buggy)\n- [x] `Broadcast<T, U>` in `libstd/io/mod.rs` (buggy but unfixable and deprecated).\n- [x] `TcpStream` in `libstd/net/tcp.rs`\n- [x] `&'a TcpStream` in `libstd/net/tcp.rs`\n- [x] `Stderr` in `libstd/sys/unix/stdio.rs`\n- [ ] `Stderr` in `libstd/sys/windows/stdio.rs` (panics on partial write)\n- [x] `ChildStdin` in `libstd/process.rs`\n- [x] `File` in `libstd/fs.rs`\n- [x] `&'a File` in `libstd/fs.rs`\n", "closed_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/32085/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/32085/timeline", "performed_via_github_app": null, "state_reason": "completed"}