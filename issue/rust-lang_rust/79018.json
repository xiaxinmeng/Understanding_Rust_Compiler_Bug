{"url": "https://api.github.com/repos/rust-lang/rust/issues/79018", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/79018/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/79018/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/79018/events", "html_url": "https://github.com/rust-lang/rust/issues/79018", "id": 742498741, "node_id": "MDU6SXNzdWU3NDI0OTg3NDE=", "number": 79018, "title": "ICE: feature(generic_const_exprs) enabled in one crate but not another", "user": {"login": "jplatte", "id": 951129, "node_id": "MDQ6VXNlcjk1MTEyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/951129?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jplatte", "html_url": "https://github.com/jplatte", "followers_url": "https://api.github.com/users/jplatte/followers", "following_url": "https://api.github.com/users/jplatte/following{/other_user}", "gists_url": "https://api.github.com/users/jplatte/gists{/gist_id}", "starred_url": "https://api.github.com/users/jplatte/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jplatte/subscriptions", "organizations_url": "https://api.github.com/users/jplatte/orgs", "repos_url": "https://api.github.com/users/jplatte/repos", "events_url": "https://api.github.com/users/jplatte/events{/privacy}", "received_events_url": "https://api.github.com/users/jplatte/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 9618520, "node_id": "MDU6TGFiZWw5NjE4NTIw", "url": "https://api.github.com/repos/rust-lang/rust/labels/I-ICE", "name": "I-ICE", "color": "e10c02", "default": false, "description": "Issue: The compiler panicked, giving an Internal Compilation Error (ICE) \u2744\ufe0f"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 650731663, "node_id": "MDU6TGFiZWw2NTA3MzE2NjM=", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-bug", "name": "C-bug", "color": "f5f1fd", "default": false, "description": "Category: This is a bug."}, {"id": 1282665911, "node_id": "MDU6TGFiZWwxMjgyNjY1OTEx", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-const-generics", "name": "A-const-generics", "color": "f7e101", "default": false, "description": "Area: const generics (parameters and arguments)"}, {"id": 1472563007, "node_id": "MDU6TGFiZWwxNDcyNTYzMDA3", "url": "https://api.github.com/repos/rust-lang/rust/labels/requires-nightly", "name": "requires-nightly", "color": "76dcde", "default": false, "description": "This issue requires a nightly compiler in some way."}, {"id": 2341291797, "node_id": "MDU6TGFiZWwyMzQxMjkxNzk3", "url": "https://api.github.com/repos/rust-lang/rust/labels/F-generic_const_exprs", "name": "F-generic_const_exprs", "color": "f9c0cc", "default": false, "description": "`#![feature(generic_const_exprs)]`"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 10, "created_at": "2020-11-13T14:40:48Z", "updated_at": "2022-03-21T15:31:51Z", "closed_at": "2022-03-21T15:31:51Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "_Extracted out from https://github.com/rust-lang/rust/issues/78139#issuecomment-714720836, as that issue was closed but my case still ICEs_\r\n\r\nGiven this code:\r\n\r\n`src/lib.rs`:\r\n\r\n```rust\r\n#![feature(const_generics, const_evaluatable_checked)]\r\n#![allow(incomplete_features)]\r\n\r\npub struct Const<const U: u8>;\r\n\r\npub trait Trait {\r\n    type AssocTy;\r\n    fn assoc_fn() -> Self::AssocTy;\r\n}\r\n\r\nimpl<const U: u8> Trait for Const<U>\r\nwhere\r\n    Const<{ my_const_fn(U) }>: ,\r\n{\r\n    type AssocTy = Const<{ my_const_fn(U) }>;\r\n    fn assoc_fn() -> Self::AssocTy {\r\n        Const\r\n    }\r\n}\r\n\r\nconst fn my_const_fn(val: u8) -> u8 {\r\n    // body of this function doesn't matter\r\n    val\r\n}\r\n```\r\n\r\n`examples/breakit.rs`:\r\n\r\n```rust\r\nuse my_crate::{Const, Trait};\r\n\r\nfn main() {\r\n    let _ = Const::<1>::assoc_fn();\r\n}\r\n```\r\n\r\nI get the following error:\r\n\r\n```\r\nerror: constant expression depends on a generic parameter\r\n  |\r\n  = note: this may fail depending on what value the parameter takes\r\n\r\nerror: internal compiler error: compiler/rustc_traits/src/normalize_erasing_regions.rs:37:32: could not fully normalize `<my_crate::Const<U> as my_crate::Trait>::AssocTy`\r\n```\r\n\r\n<details><summary>Backtrace</summary>\r\n\r\n```\r\nthread 'rustc' panicked at 'Box<Any>', compiler/rustc_errors/src/lib.rs:945:9\r\nstack backtrace:\r\n   0: std::panicking::begin_panic\r\n   1: rustc_errors::HandlerInner::bug\r\n   2: rustc_errors::Handler::bug\r\n   3: rustc_middle::util::bug::opt_span_bug_fmt::{{closure}}\r\n   4: rustc_middle::ty::context::tls::with_opt::{{closure}}\r\n   5: rustc_middle::ty::context::tls::with_opt\r\n   6: rustc_middle::util::bug::opt_span_bug_fmt\r\n   7: rustc_middle::util::bug::bug_fmt\r\n   8: rustc_infer::infer::InferCtxtBuilder::enter\r\n   9: rustc_traits::normalize_erasing_regions::normalize_generic_arg_after_erasing_regions\r\n  10: rustc_middle::dep_graph::<impl rustc_query_system::dep_graph::DepKind for rustc_middle::dep_graph::dep_node::DepKind>::with_deps\r\n  11: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task_impl\r\n  12: rustc_data_structures::stack::ensure_sufficient_stack\r\n  13: rustc_query_system::query::plumbing::get_query_impl\r\n  14: rustc_middle::ty::structural_impls::fold_list\r\n  15: rustc_middle::ty::normalize_erasing_regions::<impl rustc_middle::ty::context::TyCtxt>::normalize_erasing_regions\r\n  16: rustc_middle::ty::layout::<impl rustc_middle::ty::instance::Instance>::fn_sig_for_fn_abi\r\n  17: <rustc_target::abi::call::FnAbi<&rustc_middle::ty::TyS> as rustc_middle::ty::layout::FnAbiExt<C>>::of_instance\r\n  18: rustc_codegen_ssa::mir::block::<impl rustc_codegen_ssa::mir::FunctionCx<Bx>>::codegen_call_terminator\r\n  19: rustc_codegen_ssa::mir::block::<impl rustc_codegen_ssa::mir::FunctionCx<Bx>>::codegen_block\r\n  20: rustc_codegen_ssa::mir::codegen_mir\r\n  21: rustc_codegen_ssa::base::codegen_instance\r\n  22: <rustc_middle::mir::mono::MonoItem as rustc_codegen_ssa::mono_item::MonoItemExt>::define\r\n  23: rustc_codegen_llvm::base::compile_codegen_unit::module_codegen\r\n  24: rustc_middle::dep_graph::<impl rustc_query_system::dep_graph::DepKind for rustc_middle::dep_graph::dep_node::DepKind>::with_deps\r\n  25: rustc_query_system::dep_graph::graph::DepGraph<K>::with_task\r\n  26: rustc_codegen_llvm::base::compile_codegen_unit\r\n  27: rustc_codegen_ssa::base::codegen_crate\r\n  28: <rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_ssa::traits::backend::CodegenBackend>::codegen_crate\r\n  29: rustc_session::utils::<impl rustc_session::session::Session>::time\r\n  30: rustc_interface::queries::Queries::ongoing_codegen\r\n  31: rustc_interface::queries::<impl rustc_interface::interface::Compiler>::enter\r\n  32: rustc_span::with_source_map\r\n  33: scoped_tls::ScopedKey<T>::set\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n\r\nnote: the compiler unexpectedly panicked. this is a bug.\r\n\r\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&template=ice.md\r\n\r\nnote: rustc 1.49.0-nightly (e3051d8c2 2020-10-16) running on x86_64-unknown-linux-gnu\r\n\r\nnote: compiler flags: -C embed-bitcode=no -C debuginfo=2 -C incremental --crate-type bin\r\n\r\nnote: some of the compiler flags provided by cargo are hidden\r\n\r\nquery stack during panic:\r\n#0 [normalize_generic_arg_after_erasing_regions] normalizing `<my_crate::Const<U> as my_crate::Trait>::AssocTy`\r\nend of query stack\r\nerror: aborting due to 2 previous errors\r\n\r\nerror: could not compile `my_crate`\r\n```\r\n\r\n</details>\r\n\r\nIt goes away when putting all of the code into one compilation unit.", "closed_by": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/79018/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/79018/timeline", "performed_via_github_app": null, "state_reason": "completed"}