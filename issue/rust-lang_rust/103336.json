{"url": "https://api.github.com/repos/rust-lang/rust/issues/103336", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/103336/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/103336/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/103336/events", "html_url": "https://github.com/rust-lang/rust/issues/103336", "id": 1417962635, "node_id": "I_kwDOAAsO6M5UhGSL", "number": 103336, "title": "Provide better errors and docs for conditional compilation of binaries", "user": {"login": "pemistahl", "id": 1145043, "node_id": "MDQ6VXNlcjExNDUwNDM=", "avatar_url": "https://avatars.githubusercontent.com/u/1145043?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pemistahl", "html_url": "https://github.com/pemistahl", "followers_url": "https://api.github.com/users/pemistahl/followers", "following_url": "https://api.github.com/users/pemistahl/following{/other_user}", "gists_url": "https://api.github.com/users/pemistahl/gists{/gist_id}", "starred_url": "https://api.github.com/users/pemistahl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pemistahl/subscriptions", "organizations_url": "https://api.github.com/users/pemistahl/orgs", "repos_url": "https://api.github.com/users/pemistahl/repos", "events_url": "https://api.github.com/users/pemistahl/events{/privacy}", "received_events_url": "https://api.github.com/users/pemistahl/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 235791, "node_id": "MDU6TGFiZWwyMzU3OTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-diagnostics", "name": "A-diagnostics", "color": "f7e101", "default": false, "description": "Area: Messages for errors, warnings, and lints"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-10-21T08:28:32Z", "updated_at": "2022-10-21T08:28:32Z", "closed_at": null, "author_association": "NONE", "active_lock_reason": null, "body": "One of my Rust projects consists of a library and a binary. The library can be compiled to WASM but not the binary because one of the binary's dependencies does not support WASM compilation. I tried to disable compilation of the binary for WASM by putting the following attribute at the top-level of the `main.rs` file:\r\n\r\n```rust\r\n// main.rs\r\n\r\n#![cfg(not(target_family = \"wasm\"))]\r\n```\r\n\r\nWhen compiling for WASM, the following error is thrown by the compiler:\r\n\r\n```\r\nerror[E0601]: `main` function not found in crate `grex`\r\n   --> src/main.rs:1:2\r\n    |\r\n1   | \r\n    |  ^ consider adding a `main` function to `src/main.rs`\r\n\r\n```\r\n\r\nIt is not obvious how to handle this error and how to correctly do conditional compilation of binaries. It is not explicitly mentioned in the official Rust docs or I simply could not find it. The only trick that worked for me was to add a second `main()` function in the `main.rs` file which remains empty. When targeting WASM, this empty `main()` function is compiled, otherwise the original first one:\r\n\r\n```rust\r\n// main.rs\r\n\r\n#[cfg(not(target_family = \"wasm\"))]\r\nfn main() {\r\n    // contains the binary-specific code\r\n}\r\n\r\n#[cfg(target_family = \"wasm\")]\r\nfn main() {} // remains empty for the other targets\r\n```\r\n\r\nIt would be great if the whole handling of conditional compilation of binaries could be improved. At least, the docs and compiler error message should be improved, stating that two separate conditionally compiled `main()` functions are needed if a binary cannot be compiled for all targets. It would be even better to support adding a top-level attribute such as \r\n\r\n```rust\r\n#![cfg(not(target_family = \"wasm\"))]\r\n``` \r\n\r\nto the `main.rs` file so that the binary is not compiled for WASM. Another alternative would be to provide a setting for it in the `Cargo.toml`, for instance.\r\n\r\nPerhaps you will find ways for improvements in this matter. Thank you for your attention.\r\n\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/103336/reactions", "total_count": 7, "+1": 7, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/103336/timeline", "performed_via_github_app": null, "state_reason": null}