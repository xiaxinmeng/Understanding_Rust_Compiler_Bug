{"url": "https://api.github.com/repos/rust-lang/rust/issues/63157", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/63157/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/63157/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/63157/events", "html_url": "https://github.com/rust-lang/rust/issues/63157", "id": 475086409, "node_id": "MDU6SXNzdWU0NzUwODY0MDk=", "number": 63157, "title": "Drop ordering breaks macro hygiene", "user": {"login": "JaniM", "id": 908675, "node_id": "MDQ6VXNlcjkwODY3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/908675?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JaniM", "html_url": "https://github.com/JaniM", "followers_url": "https://api.github.com/users/JaniM/followers", "following_url": "https://api.github.com/users/JaniM/following{/other_user}", "gists_url": "https://api.github.com/users/JaniM/gists{/gist_id}", "starred_url": "https://api.github.com/users/JaniM/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JaniM/subscriptions", "organizations_url": "https://api.github.com/users/JaniM/orgs", "repos_url": "https://api.github.com/users/JaniM/repos", "events_url": "https://api.github.com/users/JaniM/events{/privacy}", "received_events_url": "https://api.github.com/users/JaniM/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 43009118, "node_id": "MDU6TGFiZWw0MzAwOTExOA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-destructors", "name": "A-destructors", "color": "f7e101", "default": false, "description": "Area: destructors (Drop, ..)"}, {"id": 132910982, "node_id": "MDU6TGFiZWwxMzI5MTA5ODI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-macros", "name": "A-macros", "color": "f7e101", "default": false, "description": "Area: All kinds of macros (custom derive, macro_rules!, proc macros, ..)"}, {"id": 211668019, "node_id": "MDU6TGFiZWwyMTE2NjgwMTk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-lang", "name": "T-lang", "color": "bfd4f2", "default": false, "description": "Relevant to the language team, which will review and decide on the PR/issue."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2019-07-31T11:23:20Z", "updated_at": "2019-07-31T12:35:07Z", "closed_at": "2019-07-31T12:35:07Z", "author_association": "NONE", "active_lock_reason": null, "body": "Macro hygiene implies any objects created in the macro should be dropped before any code run after it executes. This does not happen in latest stable or nightly.\r\n\r\nI tried this code:\r\n\r\n```rust\r\nuse std::io::Write;\r\n\r\nmacro_rules! out {\r\n    ($content:expr $(, $vars:expr)*) => {\r\n        let stdout = std::io::stdout();\r\n        let mut out = std::io::BufWriter::with_capacity(2 * 1024 * 1024, stdout.lock());\r\n        write!(out, $content $(, $vars)*).unwrap()\r\n    }\r\n}\r\n\r\nfn main() {\r\n    out!(\"hi\\n\");\r\n    out!(\"bye\\n\");\r\n}\r\n```\r\n\r\nPlayground link https://play.rust-lang.org/?version=nightly&mode=debug&edition=2018&gist=0ddca23a27a8f6cd6c5af3251c503ff4\r\n\r\nI expected to see this happen: stdout\r\n\r\n```\r\nhi\r\nbye\r\n```\r\n\r\nInstead, this happened: stdout\r\n\r\n```\r\nbye\r\nhi\r\n```\r\n\r\n## Meta\r\n\r\n`rustc --version --verbose`:\r\n\r\n```\r\n\r\nrustc 1.38.0-nightly (311376d30 2019-07-18)\r\nbinary: rustc\r\ncommit-hash: 311376d30dc1cfa622142a9f50317b1e0cb4608a\r\ncommit-date: 2019-07-18\r\nhost: x86_64-pc-windows-gnu\r\nrelease: 1.38.0-nightly\r\nLLVM version: 9.0\r\n```\r\n\r\nReproducible on the rust playground on nightly and stable.", "closed_by": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/63157/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/63157/timeline", "performed_via_github_app": null, "state_reason": "completed"}