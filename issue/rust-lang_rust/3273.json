{"url": "https://api.github.com/repos/rust-lang/rust/issues/3273", "repository_url": "https://api.github.com/repos/rust-lang/rust", "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/3273/labels{/name}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/3273/comments", "events_url": "https://api.github.com/repos/rust-lang/rust/issues/3273/events", "html_url": "https://github.com/rust-lang/rust/issues/3273", "id": 6446488, "node_id": "MDU6SXNzdWU2NDQ2NDg4", "number": 3273, "title": "More typesafe task-local data + LLVM shouldn't fold constants", "user": {"login": "bblum", "id": 1820515, "node_id": "MDQ6VXNlcjE4MjA1MTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1820515?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bblum", "html_url": "https://github.com/bblum", "followers_url": "https://api.github.com/users/bblum/followers", "following_url": "https://api.github.com/users/bblum/following{/other_user}", "gists_url": "https://api.github.com/users/bblum/gists{/gist_id}", "starred_url": "https://api.github.com/users/bblum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bblum/subscriptions", "organizations_url": "https://api.github.com/users/bblum/orgs", "repos_url": "https://api.github.com/users/bblum/repos", "events_url": "https://api.github.com/users/bblum/events{/privacy}", "received_events_url": "https://api.github.com/users/bblum/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 37234, "node_id": "MDU6TGFiZWwzNzIzNA==", "url": "https://api.github.com/repos/rust-lang/rust/labels/C-cleanup", "name": "C-cleanup", "color": "f5f1fd", "default": false, "description": "Category: PRs that clean code up or issues documenting cleanup."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2012-08-24T23:18:05Z", "updated_at": "2013-07-14T18:58:23Z", "closed_at": "2013-07-14T18:58:23Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Currently, task-local data (TLS) is implemented by keying off the code pointer of a closure that takes the desired type as its argument. You use it like this:\n\n```\nfn my_tls_key(+_x: @my_type) { }\n\nlocal_data_set(my_key, value);\nassert local_data_get(my_key).get() == my_value; // can be in a different function or module\n```\n\nThis has three known flaws:\n- As per #2912, TLS may randomly fail to retrieve values if used in coretest test cases if the other access is done in core itself.\n- On windows, TLS does not work cross-crate because of the way linking is done.\n- It has to be marked 'unsafe' because you could instantiate a polymorphic function at multiple types for easy type coercion.\n\nAn alternative proposal would be to key off the address of a global constant. A couple issues to address:\n- Shouldn't have to provide an inhabitant of the type to generate the key (maybe inhabitants can only be generated at runtime). Hence, use an empty vector: `const my_key: &[my_type] = [];`\n- Shouldn't allow an attacker to collide addresses by having differently-typed vectors on multiple stack frames. This would be solved by requiring the pointer to have the `static` region. `type local_data_key<T> = &static/[T];`\n- Finally, we should make sure that LLVM does not fold constants that are identical into each other. If you write `const key1: &[my_type] = [], key2: &[my_type] = [];` in order to have two different TLS slots to store the same type, then they shouldn't \"accidentally\" end up with the same data address and overwrite each other.\n\nThis last, 3rd point is really the major thing blocking this bug being easy. May require a special attribute to tell llvm not to put it in rodata.\n\nI wrote more about this here: http://bubblingbeebles.livejournal.com/111016.html\n", "closed_by": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/rust-lang/rust/issues/3273/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/3273/timeline", "performed_via_github_app": null, "state_reason": "completed"}