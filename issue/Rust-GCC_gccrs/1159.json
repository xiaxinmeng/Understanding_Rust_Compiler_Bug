{"url": "https://api.github.com/repos/Rust-GCC/gccrs/issues/1159", "repository_url": "https://api.github.com/repos/Rust-GCC/gccrs", "labels_url": "https://api.github.com/repos/Rust-GCC/gccrs/issues/1159/labels{/name}", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/issues/1159/comments", "events_url": "https://api.github.com/repos/Rust-GCC/gccrs/issues/1159/events", "html_url": "https://github.com/Rust-GCC/gccrs/issues/1159", "id": 1212355902, "node_id": "I_kwDOANBUbM5IQxU-", "number": 1159, "title": "Resolve SimplePaths to DefId's", "user": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 61372777, "node_id": "MDU6TGFiZWw2MTM3Mjc3Nw==", "url": "https://api.github.com/repos/Rust-GCC/gccrs/labels/enhancement", "name": "enhancement", "color": "84b6eb", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}], "milestone": {"url": "https://api.github.com/repos/Rust-GCC/gccrs/milestones/6", "html_url": "https://github.com/Rust-GCC/gccrs/milestone/6", "labels_url": "https://api.github.com/repos/Rust-GCC/gccrs/milestones/6/labels", "id": 6262846, "node_id": "MDk6TWlsZXN0b25lNjI2Mjg0Ng==", "number": 6, "title": "Imports and visibility", "description": "Multi file compilation and with use, extern and mod.", "creator": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 161, "state": "closed", "created_at": "2021-01-03T14:20:54Z", "updated_at": "2022-08-23T08:04:15Z", "due_on": "2022-05-30T07:00:00Z", "closed_at": "2022-08-03T10:02:38Z"}, "comments": 1, "created_at": "2022-04-22T13:21:28Z", "updated_at": "2022-05-05T12:45:10Z", "closed_at": "2022-05-05T12:45:10Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "This change depends on #1158 \r\n\r\n- [x] Add missing mappings to HIR::SimplePath #1176 \r\n- [x] Add missing mappings to HIR::SimpePathSegment #1176\r\n- [x] Remove the default locus argument of builtin_location on HIR::SimplePathSegment #1174 \r\n\r\nResolving a SimplePath to a DefId its achieved via the name-resolver class:\r\n\r\n\r\n```\r\n   Parameter: SimplePath* expr;\r\n\r\n    NodeId ast_node_id = expr.get_mappings ().get_nodeid ();\r\n\r\n    // then lookup the reference_node_id\r\n    NodeId ref_node_id = UNKNOWN_NODEID;\r\n    if (resolver->lookup_resolved_name (ast_node_id, &ref_node_id))\r\n      {\r\n\t// these ref_node_ids will resolve to a pattern declaration but we are\r\n\t// interested in the definition that this refers to get the parent id\r\n\tDefinition def;\r\n\tif (!resolver->lookup_definition (ref_node_id, &def))\r\n\t  {\r\n\t    // FIXME\r\n\t    // this is an internal error\r\n\t    rust_error_at (expr.get_locus (),\r\n\t\t\t   \"unknown reference for resolved name\");\r\n\t    return;\r\n\t  }\r\n\tref_node_id = def.parent;\r\n      }\r\n```\r\n\r\nif we are assuming this path can or should only resolve to modules we can ignore the type resolver name-space.\r\n\r\n```\r\n    if (ref_node_id == UNKNOWN_NODEID)\r\n      {\r\n        // this is an internal error but error messages are useful for now\r\n        // down the line we will be able to rely on the changes make in #1158 \r\n        // that this will have already errored out for us and we can just return\r\n\trust_error_at (expr.get_locus (), \"path: %s\",\r\n\t\t       expr.as_string ().c_str ());\r\n\treturn;\r\n      }\r\n```\r\n\r\nNow we have resolved the expression to its definitions NodeId which is all within the AST. \r\n\r\n### Getting the DefId from NodeId\r\n\r\nNote there is a bug with our mappings class here but we can fix this either as part of this issue or in a separate issue/pr we need to reverse map the NodeId back to an Hir node so that we can look up the Hir node to the DefID but the mappings class as nested these reverse mappings with the associated CrateNum which is wrong but we can ignore this for now.\r\n\r\n```\r\n    // node back to HIR\r\n    HirId ref;\r\n    if (!mappings->lookup_node_to_hir (expr.get_mappings ().get_crate_num (),\r\n\t\t\t\t       ref_node_id, &ref))\r\n      {\r\n\t// this is an internal error like above but its useful for debugging for now\r\n\trust_error_at (expr.get_locus (), \"reverse lookup failure\");\r\n\treturn;\r\n      }\r\n```\r\n\r\nNow that we have the associated HirId of the resolved path we can look it up again in the mappings and again this wrongly associates the crate num here but ignore this for now.\r\n\r\n```\r\n  HIR::Item *lookup_hir_item (CrateNum crateNum, HirId id);\r\n```\r\nNow you have an HIR::Item and you can get the DefId directly from that item which should be the module you looking for.", "closed_by": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/Rust-GCC/gccrs/issues/1159/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/Rust-GCC/gccrs/issues/1159/timeline", "performed_via_github_app": null, "state_reason": "completed"}