{"sha": "b334eef162ba9c10faa97c9d5c5d249f25afc7df", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIzMzRlZWYxNjJiYTljMTBmYWE5N2M5ZDVjNWQyNDlmMjVhZmM3ZGY=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2020-10-14T04:42:59Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2020-10-23T19:21:47Z"}, "message": "Do not ICE with TraitPredicates containing [type error]\n\nFix #77919.", "tree": {"sha": "d3ecf5d7fd2d3a1c12ea3a55311795bfad272f76", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d3ecf5d7fd2d3a1c12ea3a55311795bfad272f76"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b334eef162ba9c10faa97c9d5c5d249f25afc7df", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b334eef162ba9c10faa97c9d5c5d249f25afc7df", "html_url": "https://github.com/rust-lang/rust/commit/b334eef162ba9c10faa97c9d5c5d249f25afc7df", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b334eef162ba9c10faa97c9d5c5d249f25afc7df/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "07a63e6d1fabf3560e8e1e17c1d56b10a06152d9", "url": "https://api.github.com/repos/rust-lang/rust/commits/07a63e6d1fabf3560e8e1e17c1d56b10a06152d9", "html_url": "https://github.com/rust-lang/rust/commit/07a63e6d1fabf3560e8e1e17c1d56b10a06152d9"}], "stats": {"total": 78, "additions": 72, "deletions": 6}, "files": [{"sha": "d4124c82197cbfdb3f5a94b60252ea2b418a07f9", "filename": "compiler/rustc_trait_selection/src/traits/select/mod.rs", "status": "modified", "additions": 13, "deletions": 6, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/b334eef162ba9c10faa97c9d5c5d249f25afc7df/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b334eef162ba9c10faa97c9d5c5d249f25afc7df/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs?ref=b334eef162ba9c10faa97c9d5c5d249f25afc7df", "patch": "@@ -2031,12 +2031,19 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n                 &predicate.subst(tcx, substs),\n                 &mut obligations,\n             );\n-            obligations.push(Obligation {\n-                cause: cause.clone(),\n-                recursion_depth,\n-                param_env,\n-                predicate,\n-            });\n+            if predicate.references_error() {\n+                self.tcx().sess.delay_span_bug(\n+                    cause.span,\n+                    &format!(\"impl_or_trait_obligation with errors: {:?}\", predicate),\n+                );\n+            } else {\n+                obligations.push(Obligation {\n+                    cause: cause.clone(),\n+                    recursion_depth,\n+                    param_env,\n+                    predicate,\n+                });\n+            }\n         }\n \n         // We are performing deduplication here to avoid exponential blowups"}, {"sha": "9b04d5ee0008db4df88f4c272ed6dbf995760e3c", "filename": "src/test/ui/issues/issue-77919.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/b334eef162ba9c10faa97c9d5c5d249f25afc7df/src%2Ftest%2Fui%2Fissues%2Fissue-77919.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b334eef162ba9c10faa97c9d5c5d249f25afc7df/src%2Ftest%2Fui%2Fissues%2Fissue-77919.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-77919.rs?ref=b334eef162ba9c10faa97c9d5c5d249f25afc7df", "patch": "@@ -0,0 +1,13 @@\n+fn main() {\n+    [1; <Multiply<Five, Five>>::VAL]; //~ ERROR evaluation of constant value failed\n+}\n+trait TypeVal<T> {\n+    const VAL: T; //~ ERROR any use of this value will cause an error\n+}\n+struct Five;\n+struct Multiply<N, M> {\n+    _n: PhantomData, //~ ERROR cannot find type `PhantomData` in this scope\n+}\n+impl<N, M> TypeVal<usize> for Multiply<N, M> where N: TypeVal<VAL> {}\n+//~^ ERROR cannot find type `VAL` in this scope\n+//~| ERROR not all trait items implemented, missing: `VAL`"}, {"sha": "129af00644fff589a9e76f74477a5571a29eda65", "filename": "src/test/ui/issues/issue-77919.stderr", "status": "added", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/b334eef162ba9c10faa97c9d5c5d249f25afc7df/src%2Ftest%2Fui%2Fissues%2Fissue-77919.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b334eef162ba9c10faa97c9d5c5d249f25afc7df/src%2Ftest%2Fui%2Fissues%2Fissue-77919.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-77919.stderr?ref=b334eef162ba9c10faa97c9d5c5d249f25afc7df", "patch": "@@ -0,0 +1,46 @@\n+error[E0412]: cannot find type `PhantomData` in this scope\n+  --> $DIR/issue-77919.rs:9:9\n+   |\n+LL |     _n: PhantomData,\n+   |         ^^^^^^^^^^^ not found in this scope\n+   |\n+help: consider importing this struct\n+   |\n+LL | use std::marker::PhantomData;\n+   |\n+\n+error[E0412]: cannot find type `VAL` in this scope\n+  --> $DIR/issue-77919.rs:11:63\n+   |\n+LL | impl<N, M> TypeVal<usize> for Multiply<N, M> where N: TypeVal<VAL> {}\n+   |          -                                                    ^^^ not found in this scope\n+   |          |\n+   |          help: you might be missing a type parameter: `, VAL`\n+\n+error[E0046]: not all trait items implemented, missing: `VAL`\n+  --> $DIR/issue-77919.rs:11:1\n+   |\n+LL |     const VAL: T;\n+   |     ------------- `VAL` from trait\n+...\n+LL | impl<N, M> TypeVal<usize> for Multiply<N, M> where N: TypeVal<VAL> {}\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ missing `VAL` in implementation\n+\n+error: any use of this value will cause an error\n+  --> $DIR/issue-77919.rs:5:5\n+   |\n+LL |     const VAL: T;\n+   |     ^^^^^^^^^^^^^ no MIR body is available for DefId(0:7 ~ issue_77919[317d]::TypeVal::VAL)\n+   |\n+   = note: `#[deny(const_err)]` on by default\n+\n+error[E0080]: evaluation of constant value failed\n+  --> $DIR/issue-77919.rs:2:9\n+   |\n+LL |     [1; <Multiply<Five, Five>>::VAL];\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^ referenced constant has errors\n+\n+error: aborting due to 5 previous errors\n+\n+Some errors have detailed explanations: E0046, E0080, E0412.\n+For more information about an error, try `rustc --explain E0046`."}]}