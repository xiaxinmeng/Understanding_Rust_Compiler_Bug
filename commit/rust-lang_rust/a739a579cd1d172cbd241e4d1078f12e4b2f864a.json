{"sha": "a739a579cd1d172cbd241e4d1078f12e4b2f864a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE3MzlhNTc5Y2QxZDE3MmNiZDI0MWU0ZDEwNzhmMTJlNGIyZjg2NGE=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-08-10T12:31:35Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-08-10T12:31:35Z"}, "message": "Merge #9841\n\n9841: internal: print total size of source code in analysis-stats r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "1ec2f8830b24fe3eafea29fe0208f586bfd1044a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1ec2f8830b24fe3eafea29fe0208f586bfd1044a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a739a579cd1d172cbd241e4d1078f12e4b2f864a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhEnGnCRBK7hj4Ov3rIwAAYV8IADlEaPHc87hjpAil3yUxh8U5\nf5xxRqCHDO6K/tXxnp+G+KuG+MTxWshnziraXljzmVsHc8KeAoWqcup7hWSb/h0Z\nefM7n7GKZtZkq8s00S1pkZsrIjLHwub4zT1XrXvzsKHKhbB7EGUamivB/2+wM2KE\nvfa0OWmYn5rrtfluopSHOdekSNjWRHZZ+kDvSD40t+KOYBgtCpTMOncPTj2ZdLHc\nzrQMUeLy3zR0Ep3qnrv9DOVG/ihE8QZRmPnRTF65JPEWTyVVlGoi+meSBptecuJ9\nF0xqweCX8wbmIsjJ/TmAjfbG0Owqi+dG58A4zJAeDKJT4klYIvGZiR/hgMUQeW4=\n=gZp7\n-----END PGP SIGNATURE-----\n", "payload": "tree 1ec2f8830b24fe3eafea29fe0208f586bfd1044a\nparent 62c85726084622ea4e9dc188025e875f28027f7f\nparent a379bd715fff61fc3f0d92eaccf2742728373689\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1628598695 +0000\ncommitter GitHub <noreply@github.com> 1628598695 +0000\n\nMerge #9841\n\n9841: internal: print total size of source code in analysis-stats r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a739a579cd1d172cbd241e4d1078f12e4b2f864a", "html_url": "https://github.com/rust-lang/rust/commit/a739a579cd1d172cbd241e4d1078f12e4b2f864a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a739a579cd1d172cbd241e4d1078f12e4b2f864a/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "62c85726084622ea4e9dc188025e875f28027f7f", "url": "https://api.github.com/repos/rust-lang/rust/commits/62c85726084622ea4e9dc188025e875f28027f7f", "html_url": "https://github.com/rust-lang/rust/commit/62c85726084622ea4e9dc188025e875f28027f7f"}, {"sha": "a379bd715fff61fc3f0d92eaccf2742728373689", "url": "https://api.github.com/repos/rust-lang/rust/commits/a379bd715fff61fc3f0d92eaccf2742728373689", "html_url": "https://github.com/rust-lang/rust/commit/a379bd715fff61fc3f0d92eaccf2742728373689"}], "stats": {"total": 40, "additions": 35, "deletions": 5}, "files": [{"sha": "a8ee4032fa3d0c015eb4a64ae5e4c181f660632c", "filename": "crates/rust-analyzer/src/cli/analysis_stats.rs", "status": "modified", "additions": 25, "deletions": 4, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/a739a579cd1d172cbd241e4d1078f12e4b2f864a/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a739a579cd1d172cbd241e4d1078f12e4b2f864a/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs?ref=a739a579cd1d172cbd241e4d1078f12e4b2f864a", "patch": "@@ -14,16 +14,17 @@ use hir_def::{body::BodySourceMap, expr::ExprId, FunctionId};\n use hir_ty::{TyExt, TypeWalk};\n use ide::{Analysis, AnalysisHost, LineCol, RootDatabase};\n use ide_db::base_db::{\n-    salsa::{self, ParallelDatabase},\n-    SourceDatabaseExt,\n+    salsa::{self, debug::DebugQueryTable, ParallelDatabase},\n+    SourceDatabase, SourceDatabaseExt,\n };\n use itertools::Itertools;\n use oorandom::Rand32;\n+use profile::{Bytes, StopWatch};\n use project_model::CargoConfig;\n use rayon::prelude::*;\n use rustc_hash::FxHashSet;\n use stdx::format_to;\n-use syntax::AstNode;\n+use syntax::{AstNode, SyntaxNode};\n use vfs::{Vfs, VfsPath};\n \n use crate::cli::{\n@@ -33,7 +34,6 @@ use crate::cli::{\n     progress_report::ProgressReport,\n     report_metric, Result, Verbosity,\n };\n-use profile::StopWatch;\n \n /// Need to wrap Snapshot to provide `Clone` impl for `map_with`\n struct Snap<DB>(DB);\n@@ -137,6 +137,21 @@ impl flags::AnalysisStats {\n             eprintln!(\"{}\", profile::countme::get_all());\n         }\n \n+        if self.source_stats {\n+            let mut total_file_size = Bytes::default();\n+            for e in ide_db::base_db::ParseQuery.in_db(db).entries::<Vec<_>>() {\n+                total_file_size += syntax_len(db.parse(e.key).syntax_node())\n+            }\n+\n+            let mut total_macro_file_size = Bytes::default();\n+            for e in hir::db::ParseMacroExpansionQuery.in_db(db).entries::<Vec<_>>() {\n+                if let Some((val, _)) = db.parse_macro_expansion(e.key).value {\n+                    total_macro_file_size += syntax_len(val.syntax_node())\n+                }\n+            }\n+            eprintln!(\"source files: {}, macro files: {}\", total_file_size, total_macro_file_size);\n+        }\n+\n         if self.memory_usage && verbosity.is_verbose() {\n             print_memory_usage(host, vfs);\n         }\n@@ -361,3 +376,9 @@ fn shuffle<T>(rng: &mut Rand32, slice: &mut [T]) {\n fn percentage(n: u64, total: u64) -> u64 {\n     (n * 100).checked_div(total).unwrap_or(100)\n }\n+\n+fn syntax_len(node: SyntaxNode) -> usize {\n+    // Macro expanded code doesn't contain whitespace, so erase *all* whitespace\n+    // to make macro and non-macro code comparable.\n+    node.to_string().replace(|it: char| it.is_ascii_whitespace(), \"\").len()\n+}"}, {"sha": "e2e250143c0a065cc534df51c46f92ca2e3ae7ba", "filename": "crates/rust-analyzer/src/cli/flags.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/a739a579cd1d172cbd241e4d1078f12e4b2f864a/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fflags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a739a579cd1d172cbd241e4d1078f12e4b2f864a/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fflags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fflags.rs?ref=a739a579cd1d172cbd241e4d1078f12e4b2f864a", "patch": "@@ -7,7 +7,7 @@ use ide_ssr::{SsrPattern, SsrRule};\n use crate::cli::Verbosity;\n \n xflags::xflags! {\n-    src \"./src/bin/flags.rs\"\n+    src \"./src/cli/flags.rs\"\n \n     /// LSP server for the Rust programming language.\n     cmd rust-analyzer {\n@@ -60,6 +60,8 @@ xflags::xflags! {\n             optional --parallel\n             /// Collect memory usage statistics.\n             optional --memory-usage\n+            /// Print the total length of all source and macro files (whitespace is not counted).\n+            optional --source-stats\n \n             /// Only analyze items matching this path.\n             optional -o, --only path: String\n@@ -156,6 +158,7 @@ pub struct AnalysisStats {\n     pub randomize: bool,\n     pub parallel: bool,\n     pub memory_usage: bool,\n+    pub source_stats: bool,\n     pub only: Option<String>,\n     pub with_deps: bool,\n     pub no_sysroot: bool,\n@@ -190,9 +193,15 @@ pub struct ProcMacro;\n impl RustAnalyzer {\n     pub const HELP: &'static str = Self::HELP_;\n \n+    #[allow(dead_code)]\n     pub fn from_env() -> xflags::Result<Self> {\n         Self::from_env_()\n     }\n+\n+    #[allow(dead_code)]\n+    pub fn from_vec(args: Vec<std::ffi::OsString>) -> xflags::Result<Self> {\n+        Self::from_vec_(args)\n+    }\n }\n // generated end\n "}]}