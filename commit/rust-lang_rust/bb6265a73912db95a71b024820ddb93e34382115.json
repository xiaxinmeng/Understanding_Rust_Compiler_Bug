{"sha": "bb6265a73912db95a71b024820ddb93e34382115", "node_id": "C_kwDOAAsO6NoAKGJiNjI2NWE3MzkxMmRiOTVhNzFiMDI0ODIwZGRiOTNlMzQzODIxMTU", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2022-04-26T11:22:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-04-26T11:22:29Z"}, "message": "Rollup merge of #96372 - compiler-errors:field-method-suggest, r=oli-obk\n\nSuggest calling method on nested field when struct is missing method\n\nSimilar to the suggestion to change `x.field` to `x.nested.field`, implement a similar suggestion for when `x.method()` should be replaced with `x.nested.method()`.", "tree": {"sha": "60e12cdb699cd6f02c73691b4b2873fb5ac32fdd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/60e12cdb699cd6f02c73691b4b2873fb5ac32fdd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bb6265a73912db95a71b024820ddb93e34382115", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiZ9X1CRBK7hj4Ov3rIwAA9tkIADhrj2DqTTfaAHG1DHuSQw8W\nTqN8Imx+saJQ/NS//f17Xy/UWb1RwvLCGL8DiLY63hp2qyXGUJJz57AP7HWBiQvg\nONgNwKVKLWF/A60m49BedsTfqer62ON8WgAa9+0ueW876CwALOsqV0+iLIcc7vZa\numIzojzr7bmuhkTNiNqDQaLOjOr2cIYXKT2aCT1YZZwoXHWwpUM0KAK5CPqSvVHW\nXyALzNHI7Lr4f+t5L3GtYZXiWUh1UjAlW/AHnHyGNJ4oTwNQ5oXEceOr3gsY67WH\nMPRdHNpepJcL7aDKTQrs/lm8J18U/ulq1RM0AxB24ZbDBCE52fRNrz+cweHjbVY=\n=5str\n-----END PGP SIGNATURE-----\n", "payload": "tree 60e12cdb699cd6f02c73691b4b2873fb5ac32fdd\nparent 52fefb0454405763dc0b8ebe9f1fb927df3ca2d3\nparent dff7f25981e219f70dc55a2056da8d5b6d715ebf\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1650972149 +0200\ncommitter GitHub <noreply@github.com> 1650972149 +0200\n\nRollup merge of #96372 - compiler-errors:field-method-suggest, r=oli-obk\n\nSuggest calling method on nested field when struct is missing method\n\nSimilar to the suggestion to change `x.field` to `x.nested.field`, implement a similar suggestion for when `x.method()` should be replaced with `x.nested.method()`.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bb6265a73912db95a71b024820ddb93e34382115", "html_url": "https://github.com/rust-lang/rust/commit/bb6265a73912db95a71b024820ddb93e34382115", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bb6265a73912db95a71b024820ddb93e34382115/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "52fefb0454405763dc0b8ebe9f1fb927df3ca2d3", "url": "https://api.github.com/repos/rust-lang/rust/commits/52fefb0454405763dc0b8ebe9f1fb927df3ca2d3", "html_url": "https://github.com/rust-lang/rust/commit/52fefb0454405763dc0b8ebe9f1fb927df3ca2d3"}, {"sha": "dff7f25981e219f70dc55a2056da8d5b6d715ebf", "url": "https://api.github.com/repos/rust-lang/rust/commits/dff7f25981e219f70dc55a2056da8d5b6d715ebf", "html_url": "https://github.com/rust-lang/rust/commit/dff7f25981e219f70dc55a2056da8d5b6d715ebf"}], "stats": {"total": 134, "additions": 113, "deletions": 21}, "files": [{"sha": "480a5512249296d111bee1e8be320946e679e70c", "filename": "compiler/rustc_typeck/src/check/expr.rs", "status": "modified", "additions": 16, "deletions": 20, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/bb6265a73912db95a71b024820ddb93e34382115/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bb6265a73912db95a71b024820ddb93e34382115/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs?ref=bb6265a73912db95a71b024820ddb93e34382115", "patch": "@@ -2285,14 +2285,17 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         // try to add a suggestion in case the field is a nested field of a field of the Adt\n         if let Some((fields, substs)) = self.get_field_candidates(span, expr_t) {\n             for candidate_field in fields.iter() {\n-                if let Some(field_path) = self.check_for_nested_field(\n+                if let Some(mut field_path) = self.check_for_nested_field_satisfying(\n                     span,\n-                    field,\n+                    &|candidate_field, _| candidate_field.ident(self.tcx()) == field,\n                     candidate_field,\n                     substs,\n                     vec![],\n                     self.tcx.parent_module(id).to_def_id(),\n                 ) {\n+                    // field_path includes `field` that we're looking for, so pop it.\n+                    field_path.pop();\n+\n                     let field_path_str = field_path\n                         .iter()\n                         .map(|id| id.name.to_ident_string())\n@@ -2312,7 +2315,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         err\n     }\n \n-    fn get_field_candidates(\n+    crate fn get_field_candidates(\n         &self,\n         span: Span,\n         base_t: Ty<'tcx>,\n@@ -2337,49 +2340,42 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n \n     /// This method is called after we have encountered a missing field error to recursively\n     /// search for the field\n-    fn check_for_nested_field(\n+    crate fn check_for_nested_field_satisfying(\n         &self,\n         span: Span,\n-        target_field: Ident,\n+        matches: &impl Fn(&ty::FieldDef, Ty<'tcx>) -> bool,\n         candidate_field: &ty::FieldDef,\n         subst: SubstsRef<'tcx>,\n         mut field_path: Vec<Ident>,\n         id: DefId,\n     ) -> Option<Vec<Ident>> {\n         debug!(\n-            \"check_for_nested_field(span: {:?}, candidate_field: {:?}, field_path: {:?}\",\n+            \"check_for_nested_field_satisfying(span: {:?}, candidate_field: {:?}, field_path: {:?}\",\n             span, candidate_field, field_path\n         );\n \n-        if candidate_field.ident(self.tcx) == target_field {\n-            Some(field_path)\n-        } else if field_path.len() > 3 {\n+        if field_path.len() > 3 {\n             // For compile-time reasons and to avoid infinite recursion we only check for fields\n             // up to a depth of three\n             None\n         } else {\n             // recursively search fields of `candidate_field` if it's a ty::Adt\n-\n             field_path.push(candidate_field.ident(self.tcx).normalize_to_macros_2_0());\n             let field_ty = candidate_field.ty(self.tcx, subst);\n             if let Some((nested_fields, subst)) = self.get_field_candidates(span, field_ty) {\n                 for field in nested_fields.iter() {\n-                    let accessible = field.vis.is_accessible_from(id, self.tcx);\n-                    if accessible {\n-                        let ident = field.ident(self.tcx).normalize_to_macros_2_0();\n-                        if ident == target_field {\n+                    if field.vis.is_accessible_from(id, self.tcx) {\n+                        if matches(candidate_field, field_ty) {\n                             return Some(field_path);\n-                        }\n-                        let field_path = field_path.clone();\n-                        if let Some(path) = self.check_for_nested_field(\n+                        } else if let Some(field_path) = self.check_for_nested_field_satisfying(\n                             span,\n-                            target_field,\n+                            matches,\n                             field,\n                             subst,\n-                            field_path,\n+                            field_path.clone(),\n                             id,\n                         ) {\n-                            return Some(path);\n+                            return Some(field_path);\n                         }\n                     }\n                 }"}, {"sha": "88e0a4bada845255136d82d431e733ec311994d4", "filename": "compiler/rustc_typeck/src/check/method/suggest.rs", "status": "modified", "additions": 41, "deletions": 1, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/bb6265a73912db95a71b024820ddb93e34382115/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fsuggest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bb6265a73912db95a71b024820ddb93e34382115/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fsuggest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fsuggest.rs?ref=bb6265a73912db95a71b024820ddb93e34382115", "patch": "@@ -28,7 +28,7 @@ use rustc_trait_selection::traits::{\n use std::cmp::Ordering;\n use std::iter;\n \n-use super::probe::Mode;\n+use super::probe::{Mode, ProbeScope};\n use super::{CandidateSource, MethodError, NoMatchData};\n \n impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n@@ -1129,6 +1129,46 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                     label_span_not_found();\n                 }\n \n+                if let SelfSource::MethodCall(expr) = source\n+                    && let Some((fields, substs)) = self.get_field_candidates(span, actual)\n+                {\n+                    let call_expr =\n+                        self.tcx.hir().expect_expr(self.tcx.hir().get_parent_node(expr.hir_id));\n+                    for candidate_field in fields.iter() {\n+                        if let Some(field_path) = self.check_for_nested_field_satisfying(\n+                            span,\n+                            &|_, field_ty| {\n+                                self.lookup_probe(\n+                                    span,\n+                                    item_name,\n+                                    field_ty,\n+                                    call_expr,\n+                                    ProbeScope::AllTraits,\n+                                )\n+                                .is_ok()\n+                            },\n+                            candidate_field,\n+                            substs,\n+                            vec![],\n+                            self.tcx.parent_module(expr.hir_id).to_def_id(),\n+                        ) {\n+                            let field_path_str = field_path\n+                                .iter()\n+                                .map(|id| id.name.to_ident_string())\n+                                .collect::<Vec<String>>()\n+                                .join(\".\");\n+                            debug!(\"field_path_str: {:?}\", field_path_str);\n+\n+                            err.span_suggestion_verbose(\n+                                item_name.span.shrink_to_lo(),\n+                                \"one of the expressions' fields has a method of the same name\",\n+                                format!(\"{field_path_str}.\"),\n+                                Applicability::MaybeIncorrect,\n+                            );\n+                        }\n+                    }\n+                }\n+\n                 bound_spans.sort();\n                 bound_spans.dedup();\n                 for (span, msg) in bound_spans.into_iter() {"}, {"sha": "7157b186fc8ad591967e48e829b074c9ebe3ec3b", "filename": "src/test/ui/hrtb/issue-30786.migrate.stderr", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bb6265a73912db95a71b024820ddb93e34382115/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.migrate.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bb6265a73912db95a71b024820ddb93e34382115/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.migrate.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.migrate.stderr?ref=bb6265a73912db95a71b024820ddb93e34382115", "patch": "@@ -18,6 +18,10 @@ note: the following trait bounds were not satisfied:\n    |\n LL | impl<T> StreamExt for T where for<'a> &'a mut T: Stream {}\n    |         ---------     -                          ^^^^^^ unsatisfied trait bound introduced here\n+help: one of the expressions' fields has a method of the same name\n+   |\n+LL |     let filter = map.stream.filterx(|x: &_| true);\n+   |                      +++++++\n \n error[E0599]: the method `countx` exists for struct `Filter<Map<Repeat, for<'r> fn(&'r u64) -> &'r u64 {identity::<u64>}>, [closure@$DIR/issue-30786.rs:139:30: 139:42]>`, but its trait bounds were not satisfied\n   --> $DIR/issue-30786.rs:140:24\n@@ -39,6 +43,10 @@ note: the following trait bounds were not satisfied:\n    |\n LL | impl<T> StreamExt for T where for<'a> &'a mut T: Stream {}\n    |         ---------     -                          ^^^^^^ unsatisfied trait bound introduced here\n+help: one of the expressions' fields has a method of the same name\n+   |\n+LL |     let count = filter.stream.countx();\n+   |                        +++++++\n \n error: aborting due to 2 previous errors\n "}, {"sha": "7157b186fc8ad591967e48e829b074c9ebe3ec3b", "filename": "src/test/ui/hrtb/issue-30786.nll.stderr", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bb6265a73912db95a71b024820ddb93e34382115/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bb6265a73912db95a71b024820ddb93e34382115/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.nll.stderr?ref=bb6265a73912db95a71b024820ddb93e34382115", "patch": "@@ -18,6 +18,10 @@ note: the following trait bounds were not satisfied:\n    |\n LL | impl<T> StreamExt for T where for<'a> &'a mut T: Stream {}\n    |         ---------     -                          ^^^^^^ unsatisfied trait bound introduced here\n+help: one of the expressions' fields has a method of the same name\n+   |\n+LL |     let filter = map.stream.filterx(|x: &_| true);\n+   |                      +++++++\n \n error[E0599]: the method `countx` exists for struct `Filter<Map<Repeat, for<'r> fn(&'r u64) -> &'r u64 {identity::<u64>}>, [closure@$DIR/issue-30786.rs:139:30: 139:42]>`, but its trait bounds were not satisfied\n   --> $DIR/issue-30786.rs:140:24\n@@ -39,6 +43,10 @@ note: the following trait bounds were not satisfied:\n    |\n LL | impl<T> StreamExt for T where for<'a> &'a mut T: Stream {}\n    |         ---------     -                          ^^^^^^ unsatisfied trait bound introduced here\n+help: one of the expressions' fields has a method of the same name\n+   |\n+LL |     let count = filter.stream.countx();\n+   |                        +++++++\n \n error: aborting due to 2 previous errors\n "}, {"sha": "980000151e2f7f4ea468ef17e246a7523e998539", "filename": "src/test/ui/suggestions/field-has-method.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/bb6265a73912db95a71b024820ddb93e34382115/src%2Ftest%2Fui%2Fsuggestions%2Ffield-has-method.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bb6265a73912db95a71b024820ddb93e34382115/src%2Ftest%2Fui%2Fsuggestions%2Ffield-has-method.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Ffield-has-method.rs?ref=bb6265a73912db95a71b024820ddb93e34382115", "patch": "@@ -0,0 +1,23 @@\n+struct Kind;\n+\n+struct Ty {\n+    kind: Kind,\n+}\n+\n+impl Ty {\n+    fn kind(&self) -> Kind {\n+        todo!()\n+    }\n+}\n+\n+struct InferOk<T> {\n+    value: T,\n+    predicates: Vec<()>,\n+}\n+\n+fn foo(i: InferOk<Ty>) {\n+    let k = i.kind();\n+    //~^ no method named `kind` found for struct `InferOk` in the current scope\n+}\n+\n+fn main() {}"}, {"sha": "3a57436f200bab227bda5dc95b008c46cdcf70b5", "filename": "src/test/ui/suggestions/field-has-method.stderr", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/bb6265a73912db95a71b024820ddb93e34382115/src%2Ftest%2Fui%2Fsuggestions%2Ffield-has-method.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bb6265a73912db95a71b024820ddb93e34382115/src%2Ftest%2Fui%2Fsuggestions%2Ffield-has-method.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Ffield-has-method.stderr?ref=bb6265a73912db95a71b024820ddb93e34382115", "patch": "@@ -0,0 +1,17 @@\n+error[E0599]: no method named `kind` found for struct `InferOk` in the current scope\n+  --> $DIR/field-has-method.rs:19:15\n+   |\n+LL | struct InferOk<T> {\n+   | ----------------- method `kind` not found for this\n+...\n+LL |     let k = i.kind();\n+   |               ^^^^ method not found in `InferOk<Ty>`\n+   |\n+help: one of the expressions' fields has a method of the same name\n+   |\n+LL |     let k = i.value.kind();\n+   |               ++++++\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0599`."}]}