{"sha": "07baa176c28530ad2b9bd6c73dd3c8f0f40e3266", "node_id": "C_kwDOAAsO6NoAKDA3YmFhMTc2YzI4NTMwYWQyYjliZDZjNzNkZDNjOGYwZjQwZTMyNjY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-18T05:36:24Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-18T05:36:24Z"}, "message": "Auto merge of #14828 - lowr:fix/macro_use_prelude_is_in_scope, r=Veykril\n\nfix: process `macro_use` prelude in semantic scope resolver\n\nFixes #14826", "tree": {"sha": "b29dd05bcbfeebf61d24584da8b1d2ac919a5deb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b29dd05bcbfeebf61d24584da8b1d2ac919a5deb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/07baa176c28530ad2b9bd6c73dd3c8f0f40e3266", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/07baa176c28530ad2b9bd6c73dd3c8f0f40e3266", "html_url": "https://github.com/rust-lang/rust/commit/07baa176c28530ad2b9bd6c73dd3c8f0f40e3266", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/07baa176c28530ad2b9bd6c73dd3c8f0f40e3266/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b7b026bce672f3161df83d9d503ff32c393e3768", "url": "https://api.github.com/repos/rust-lang/rust/commits/b7b026bce672f3161df83d9d503ff32c393e3768", "html_url": "https://github.com/rust-lang/rust/commit/b7b026bce672f3161df83d9d503ff32c393e3768"}, {"sha": "68a74decb683929f59588e07636e44c40434d6bc", "url": "https://api.github.com/repos/rust-lang/rust/commits/68a74decb683929f59588e07636e44c40434d6bc", "html_url": "https://github.com/rust-lang/rust/commit/68a74decb683929f59588e07636e44c40434d6bc"}], "stats": {"total": 36, "additions": 32, "deletions": 4}, "files": [{"sha": "1e299fecc9d81426314d94917e9dc0ac7a81f92b", "filename": "crates/hir-def/src/find_path.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/07baa176c28530ad2b9bd6c73dd3c8f0f40e3266/crates%2Fhir-def%2Fsrc%2Ffind_path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/07baa176c28530ad2b9bd6c73dd3c8f0f40e3266/crates%2Fhir-def%2Fsrc%2Ffind_path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Ffind_path.rs?ref=07baa176c28530ad2b9bd6c73dd3c8f0f40e3266", "patch": "@@ -183,7 +183,7 @@ fn find_path_for_module(\n \n     // - if the item is the crate root of a dependency crate, return the name from the extern prelude\n     let root_def_map = crate_root.def_map(db);\n-    for (name, &def_id) in root_def_map.extern_prelude() {\n+    for (name, def_id) in root_def_map.extern_prelude() {\n         if module_id == def_id {\n             let name = scope_name.unwrap_or_else(|| name.clone());\n "}, {"sha": "176637f9d0dde163a227f0b36d69eb483c86fc64", "filename": "crates/hir-def/src/nameres.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/07baa176c28530ad2b9bd6c73dd3c8f0f40e3266/crates%2Fhir-def%2Fsrc%2Fnameres.rs", "raw_url": "https://github.com/rust-lang/rust/raw/07baa176c28530ad2b9bd6c73dd3c8f0f40e3266/crates%2Fhir-def%2Fsrc%2Fnameres.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fnameres.rs?ref=07baa176c28530ad2b9bd6c73dd3c8f0f40e3266", "patch": "@@ -355,8 +355,12 @@ impl DefMap {\n         self.prelude\n     }\n \n-    pub(crate) fn extern_prelude(&self) -> impl Iterator<Item = (&Name, &ModuleId)> + '_ {\n-        self.extern_prelude.iter()\n+    pub(crate) fn extern_prelude(&self) -> impl Iterator<Item = (&Name, ModuleId)> + '_ {\n+        self.extern_prelude.iter().map(|(name, def)| (name, *def))\n+    }\n+\n+    pub(crate) fn macro_use_prelude(&self) -> impl Iterator<Item = (&Name, MacroId)> + '_ {\n+        self.macro_use_prelude.iter().map(|(name, def)| (name, *def))\n     }\n \n     pub fn module_id(&self, local_id: LocalModuleId) -> ModuleId {"}, {"sha": "afa3b33cc9fea1d3afdafa39cee4fa2febfdf7f1", "filename": "crates/hir-def/src/resolver.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/07baa176c28530ad2b9bd6c73dd3c8f0f40e3266/crates%2Fhir-def%2Fsrc%2Fresolver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/07baa176c28530ad2b9bd6c73dd3c8f0f40e3266/crates%2Fhir-def%2Fsrc%2Fresolver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fresolver.rs?ref=07baa176c28530ad2b9bd6c73dd3c8f0f40e3266", "patch": "@@ -461,7 +461,10 @@ impl Resolver {\n                 res.add(name, ScopeDef::ModuleDef(ModuleDefId::MacroId(mac)));\n             })\n         });\n-        def_map.extern_prelude().for_each(|(name, &def)| {\n+        def_map.macro_use_prelude().for_each(|(name, def)| {\n+            res.add(name, ScopeDef::ModuleDef(def.into()));\n+        });\n+        def_map.extern_prelude().for_each(|(name, def)| {\n             res.add(name, ScopeDef::ModuleDef(ModuleDefId::ModuleId(def)));\n         });\n         BUILTIN_SCOPE.iter().for_each(|(name, &def)| {"}, {"sha": "8c038c0fbaa1c93b519549f303dacd96e24c232f", "filename": "crates/ide-completion/src/tests/flyimport.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/07baa176c28530ad2b9bd6c73dd3c8f0f40e3266/crates%2Fide-completion%2Fsrc%2Ftests%2Fflyimport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/07baa176c28530ad2b9bd6c73dd3c8f0f40e3266/crates%2Fide-completion%2Fsrc%2Ftests%2Fflyimport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Ftests%2Fflyimport.rs?ref=07baa176c28530ad2b9bd6c73dd3c8f0f40e3266", "patch": "@@ -1265,3 +1265,24 @@ macro_rules! define_struct {\n         \"#]],\n     );\n }\n+\n+#[test]\n+fn macro_use_prelude_is_in_scope() {\n+    check(\n+        r#\"\n+//- /main.rs crate:main deps:dep\n+#[macro_use]\n+extern crate dep;\n+\n+fn main() {\n+    print$0\n+}\n+//- /lib.rs crate:dep\n+#[macro_export]\n+macro_rules! println {\n+    () => {}\n+}\n+\"#,\n+        expect![\"\"],\n+    )\n+}"}]}