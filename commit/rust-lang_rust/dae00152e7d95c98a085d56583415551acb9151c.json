{"sha": "dae00152e7d95c98a085d56583415551acb9151c", "node_id": "C_kwDOAAsO6NoAKGRhZTAwMTUyZTdkOTVjOThhMDg1ZDU2NTgzNDE1NTUxYWNiOTE1MWM", "commit": {"author": {"name": "Arpad Borsos", "email": "swatinem@swatinem.de", "date": "2023-02-05T15:26:51Z"}, "committer": {"name": "Arpad Borsos", "email": "swatinem@swatinem.de", "date": "2023-02-05T16:34:33Z"}, "message": "Sort Generator `print-type-sizes` according to their yield points\n\nEspecially when trying to diagnose runaway future sizes, it might be\nmore intuitive to sort the variants according to the control flow\n(aka their yield points) rather than the size of the variants.", "tree": {"sha": "d156419d6107ee0a1fabde04d17506f841a3060f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d156419d6107ee0a1fabde04d17506f841a3060f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dae00152e7d95c98a085d56583415551acb9151c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZNNjbpmzULCa7LeL/HvKd4JLMpgFAmPf2p0ACgkQ/HvKd4JL\nMpg0rA//RKGfin8Nj0Xx7BLK8ckar/9+y9xn1lfuLcwKb85NU9xfeRWyN823Sszl\nnTWanUYjuj/IsKFhVNdkmLYWe3tj7sDLJqp4fg9Xv7ANIGz4lACchvkHOBVW64Sm\nB7TbDCiu1D0zSlCZOYVwghHiR4FDaCBK8rZakybObkMmTPxoEVde4RDS98AofKWo\nmrBS2G+oDkpRpbc52XfgDtTAXFASMVr4n+e25qb05+5Xlf2QjQ3WtggtxWTouYo5\nzdWeLr4gCCkSjMRwXK0urNeUwNad9waC83b/ZSVQ5/GeYPWhNWzed1x1Pf1zYWGR\n3crT1L/yDdW2BVD+jgsDuxaTkBGAo/6ot3AjLBPNQwg8NSFqGuZpTY8qkRWMykkc\naGsydSo9oqqeUnSSLCm/eGtFSgy/9GRu3A4aBnmyUopw36hvjJHpSsBlyxugRi6Q\n0EQ0EU8HJP7dZpS2yMbFpW+yv6rk1i6g++qkUDEne7GjjSxLblCRopGO/fhl1QF3\n39MEg/SgpQ036A49CeaR3Fc/YhlCHuLFgoevER8wBUwG443lQHR7Icy2Cxl2RhYF\n65C8J37h1ls2TJXz8qj5NjaV8/TgNNMJ77hJLMIuoiCCSBRGNAsP3PEUfNQw/0Cq\nxdOPiEq0E2og8CPHVVsz2tRAWhbtknw997YcRV5paPL9BG2dG3E=\n=Zm7/\n-----END PGP SIGNATURE-----", "payload": "tree d156419d6107ee0a1fabde04d17506f841a3060f\nparent 7f97aeaf73047268299ab55288b3dd886130be47\nauthor Arpad Borsos <swatinem@swatinem.de> 1675610811 +0100\ncommitter Arpad Borsos <swatinem@swatinem.de> 1675614873 +0100\n\nSort Generator `print-type-sizes` according to their yield points\n\nEspecially when trying to diagnose runaway future sizes, it might be\nmore intuitive to sort the variants according to the control flow\n(aka their yield points) rather than the size of the variants.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dae00152e7d95c98a085d56583415551acb9151c", "html_url": "https://github.com/rust-lang/rust/commit/dae00152e7d95c98a085d56583415551acb9151c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dae00152e7d95c98a085d56583415551acb9151c/comments", "author": {"login": "Swatinem", "id": 580492, "node_id": "MDQ6VXNlcjU4MDQ5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/580492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Swatinem", "html_url": "https://github.com/Swatinem", "followers_url": "https://api.github.com/users/Swatinem/followers", "following_url": "https://api.github.com/users/Swatinem/following{/other_user}", "gists_url": "https://api.github.com/users/Swatinem/gists{/gist_id}", "starred_url": "https://api.github.com/users/Swatinem/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Swatinem/subscriptions", "organizations_url": "https://api.github.com/users/Swatinem/orgs", "repos_url": "https://api.github.com/users/Swatinem/repos", "events_url": "https://api.github.com/users/Swatinem/events{/privacy}", "received_events_url": "https://api.github.com/users/Swatinem/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Swatinem", "id": 580492, "node_id": "MDQ6VXNlcjU4MDQ5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/580492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Swatinem", "html_url": "https://github.com/Swatinem", "followers_url": "https://api.github.com/users/Swatinem/followers", "following_url": "https://api.github.com/users/Swatinem/following{/other_user}", "gists_url": "https://api.github.com/users/Swatinem/gists{/gist_id}", "starred_url": "https://api.github.com/users/Swatinem/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Swatinem/subscriptions", "organizations_url": "https://api.github.com/users/Swatinem/orgs", "repos_url": "https://api.github.com/users/Swatinem/repos", "events_url": "https://api.github.com/users/Swatinem/events{/privacy}", "received_events_url": "https://api.github.com/users/Swatinem/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7f97aeaf73047268299ab55288b3dd886130be47", "url": "https://api.github.com/repos/rust-lang/rust/commits/7f97aeaf73047268299ab55288b3dd886130be47", "html_url": "https://github.com/rust-lang/rust/commit/7f97aeaf73047268299ab55288b3dd886130be47"}], "stats": {"total": 37, "additions": 25, "deletions": 12}, "files": [{"sha": "55178250472ef94bc08d45ba429ea02f7f83458b", "filename": "compiler/rustc_session/src/code_stats.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/dae00152e7d95c98a085d56583415551acb9151c/compiler%2Frustc_session%2Fsrc%2Fcode_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dae00152e7d95c98a085d56583415551acb9151c/compiler%2Frustc_session%2Fsrc%2Fcode_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fcode_stats.rs?ref=dae00152e7d95c98a085d56583415551acb9151c", "patch": "@@ -84,7 +84,11 @@ impl CodeStats {\n         // Sort variants so the largest ones are shown first. A stable sort is\n         // used here so that source code order is preserved for all variants\n         // that have the same size.\n-        variants.sort_by(|info1, info2| info2.size.cmp(&info1.size));\n+        // Except for Generators, whose variants are already sorted according to\n+        // their yield points in `variant_info_for_generator`.\n+        if kind != DataTypeKind::Generator {\n+            variants.sort_by(|info1, info2| info2.size.cmp(&info1.size));\n+        }\n         let info = TypeSizeInfo {\n             kind,\n             type_description: type_desc.to_string(),"}, {"sha": "2aeb255c1641c61b6329110582aa8bd8ea06808d", "filename": "compiler/rustc_ty_utils/src/layout.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/dae00152e7d95c98a085d56583415551acb9151c/compiler%2Frustc_ty_utils%2Fsrc%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dae00152e7d95c98a085d56583415551acb9151c/compiler%2Frustc_ty_utils%2Fsrc%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Flayout.rs?ref=dae00152e7d95c98a085d56583415551acb9151c", "patch": "@@ -970,7 +970,7 @@ fn variant_info_for_generator<'tcx>(\n         })\n         .collect();\n \n-    let variant_infos: Vec<_> = generator\n+    let mut variant_infos: Vec<_> = generator\n         .variant_fields\n         .iter_enumerated()\n         .map(|(variant_idx, variant_def)| {\n@@ -1033,6 +1033,15 @@ fn variant_info_for_generator<'tcx>(\n             }\n         })\n         .collect();\n+\n+    // The first three variants are hardcoded to be `UNRESUMED`, `RETURNED` and `POISONED`.\n+    // We will move the `RETURNED` and `POISONED` elements to the end so we\n+    // are left with a sorting order according to the generators yield points:\n+    // First `Unresumed`, then the `SuspendN` followed by `Returned` and `Panicked` (POISONED).\n+    let end_states = variant_infos.drain(1..=2);\n+    let end_states: Vec<_> = end_states.collect();\n+    variant_infos.extend(end_states);\n+\n     (\n         variant_infos,\n         match tag_encoding {"}, {"sha": "91db4b1531f541177ba1944d798f9d68b9fc24e0", "filename": "tests/ui/async-await/future-sizes/large-arg.stdout", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/dae00152e7d95c98a085d56583415551acb9151c/tests%2Fui%2Fasync-await%2Ffuture-sizes%2Flarge-arg.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/dae00152e7d95c98a085d56583415551acb9151c/tests%2Fui%2Fasync-await%2Ffuture-sizes%2Flarge-arg.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fasync-await%2Ffuture-sizes%2Flarge-arg.stdout?ref=dae00152e7d95c98a085d56583415551acb9151c", "patch": "@@ -1,17 +1,17 @@\n print-type-size type: `[async fn body@$DIR/large-arg.rs:6:21: 8:2]`: 3076 bytes, alignment: 1 bytes\n print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 0 bytes\n print-type-size     variant `Suspend0`: 3075 bytes\n print-type-size         local `.__awaitee`: 3075 bytes, offset: 0 bytes, alignment: 1 bytes\n-print-type-size     variant `Unresumed`: 0 bytes\n print-type-size     variant `Returned`: 0 bytes\n print-type-size     variant `Panicked`: 0 bytes\n print-type-size type: `[async fn body@$DIR/large-arg.rs:10:30: 12:2]`: 3075 bytes, alignment: 1 bytes\n print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 1024 bytes\n+print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Suspend0`: 3074 bytes\n print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size         local `.__awaitee`: 2050 bytes\n-print-type-size     variant `Unresumed`: 1024 bytes\n-print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Returned`: 1024 bytes\n print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Panicked`: 1024 bytes\n@@ -24,11 +24,11 @@ print-type-size         field `.uninit`: 0 bytes\n print-type-size         field `.value`: 3075 bytes\n print-type-size type: `[async fn body@$DIR/large-arg.rs:13:26: 15:2]`: 2050 bytes, alignment: 1 bytes\n print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 1024 bytes\n+print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Suspend0`: 2049 bytes\n print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size         local `.__awaitee`: 1025 bytes\n-print-type-size     variant `Unresumed`: 1024 bytes\n-print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Returned`: 1024 bytes\n print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Panicked`: 1024 bytes"}, {"sha": "8fe936efc8983ed96b21ecdb7ef781b6227cbe39", "filename": "tests/ui/print_type_sizes/async.stdout", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/dae00152e7d95c98a085d56583415551acb9151c/tests%2Fui%2Fprint_type_sizes%2Fasync.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/dae00152e7d95c98a085d56583415551acb9151c/tests%2Fui%2Fprint_type_sizes%2Fasync.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fprint_type_sizes%2Fasync.stdout?ref=dae00152e7d95c98a085d56583415551acb9151c", "patch": "@@ -1,11 +1,11 @@\n print-type-size type: `[async fn body@$DIR/async.rs:8:36: 11:2]`: 16386 bytes, alignment: 1 bytes\n print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 8192 bytes\n+print-type-size         upvar `.arg`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Suspend0`: 16385 bytes\n print-type-size         upvar `.arg`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size         local `.arg`: 8192 bytes\n print-type-size         local `.__awaitee`: 1 bytes\n-print-type-size     variant `Unresumed`: 8192 bytes\n-print-type-size         upvar `.arg`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Returned`: 8192 bytes\n print-type-size         upvar `.arg`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Panicked`: 8192 bytes"}, {"sha": "7c58d6ce5ffa1e79785cd7577cbe5174c8d8f082", "filename": "tests/ui/print_type_sizes/generator.stdout", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/dae00152e7d95c98a085d56583415551acb9151c/tests%2Fui%2Fprint_type_sizes%2Fgenerator.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/dae00152e7d95c98a085d56583415551acb9151c/tests%2Fui%2Fprint_type_sizes%2Fgenerator.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fprint_type_sizes%2Fgenerator.stdout?ref=dae00152e7d95c98a085d56583415551acb9151c", "patch": "@@ -2,9 +2,9 @@ print-type-size type: `[generator@$DIR/generator.rs:10:5: 10:14]`: 8193 bytes, a\n print-type-size     discriminant: 1 bytes\n print-type-size     variant `Unresumed`: 8192 bytes\n print-type-size         upvar `.array`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n+print-type-size     variant `Suspend0`: 8192 bytes\n+print-type-size         upvar `.array`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Returned`: 8192 bytes\n print-type-size         upvar `.array`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Panicked`: 8192 bytes\n print-type-size         upvar `.array`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n-print-type-size     variant `Suspend0`: 8192 bytes\n-print-type-size         upvar `.array`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes"}, {"sha": "f2a11c7a33bab49c2d8f343d8fb63f610be500dc", "filename": "tests/ui/print_type_sizes/generator_discr_placement.stdout", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dae00152e7d95c98a085d56583415551acb9151c/tests%2Fui%2Fprint_type_sizes%2Fgenerator_discr_placement.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/dae00152e7d95c98a085d56583415551acb9151c/tests%2Fui%2Fprint_type_sizes%2Fgenerator_discr_placement.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fprint_type_sizes%2Fgenerator_discr_placement.stdout?ref=dae00152e7d95c98a085d56583415551acb9151c", "patch": "@@ -1,11 +1,11 @@\n print-type-size type: `[generator@$DIR/generator_discr_placement.rs:11:13: 11:15]`: 8 bytes, alignment: 4 bytes\n print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 0 bytes\n print-type-size     variant `Suspend0`: 7 bytes\n print-type-size         padding: 3 bytes\n print-type-size         local `.w`: 4 bytes, alignment: 4 bytes\n print-type-size     variant `Suspend1`: 7 bytes\n print-type-size         padding: 3 bytes\n print-type-size         local `.z`: 4 bytes, alignment: 4 bytes\n-print-type-size     variant `Unresumed`: 0 bytes\n print-type-size     variant `Returned`: 0 bytes\n print-type-size     variant `Panicked`: 0 bytes"}]}