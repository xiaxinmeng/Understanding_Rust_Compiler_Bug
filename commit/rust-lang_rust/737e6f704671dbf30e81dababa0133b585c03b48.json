{"sha": "737e6f704671dbf30e81dababa0133b585c03b48", "node_id": "C_kwDOAAsO6NoAKDczN2U2ZjcwNDY3MWRiZjMwZTgxZGFiYWJhMDEzM2I1ODVjMDNiNDg", "commit": {"author": {"name": "Yacin Tmimi", "email": "yacintmimi@gmail.com", "date": "2021-12-20T02:27:25Z"}, "committer": {"name": "Caleb Cartwright", "email": "calebcartwright@users.noreply.github.com", "date": "2022-01-01T16:27:49Z"}, "message": "Improve out of line module resolution\n\nFixes 5119\n\nWhen the directory structure was laid out as follows:\n\n```\ndir\n |---mod_a\n |    |---sub_mod_1.rs\n |    |---sub_mod_2.rs\n |---mod_a.rs\n```\n\nAnd ``mod_a.rs`` contains the following content:\n\n```rust\nmod mod_a {\n    mod sub_mod_1;\n    mod sub_mod_2;\n}\n```\n\nrustfmt previously tried to find ``sub_mod_1.rs`` and ``sub_mod_2.rs``\nin ``./mod_a/mod_a/``. This directory does not exist and this caused\nrustfmt to fail with the error message:\n\n    Error writing files: failed to resolve mod\n\nNow, both ``sub_mod_1.rs`` and ``sub_mod_2.rs`` are resolved correctly\nand found at ``mod_a/sub_mod_1.rs`` and ``mod_a/sub_mod_2.rs``.", "tree": {"sha": "d623ec894fce91e6c85b8418fee947621cd7e23e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d623ec894fce91e6c85b8418fee947621cd7e23e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/737e6f704671dbf30e81dababa0133b585c03b48", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/737e6f704671dbf30e81dababa0133b585c03b48", "html_url": "https://github.com/rust-lang/rust/commit/737e6f704671dbf30e81dababa0133b585c03b48", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/737e6f704671dbf30e81dababa0133b585c03b48/comments", "author": {"login": "ytmimi", "id": 29028348, "node_id": "MDQ6VXNlcjI5MDI4MzQ4", "avatar_url": "https://avatars.githubusercontent.com/u/29028348?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ytmimi", "html_url": "https://github.com/ytmimi", "followers_url": "https://api.github.com/users/ytmimi/followers", "following_url": "https://api.github.com/users/ytmimi/following{/other_user}", "gists_url": "https://api.github.com/users/ytmimi/gists{/gist_id}", "starred_url": "https://api.github.com/users/ytmimi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ytmimi/subscriptions", "organizations_url": "https://api.github.com/users/ytmimi/orgs", "repos_url": "https://api.github.com/users/ytmimi/repos", "events_url": "https://api.github.com/users/ytmimi/events{/privacy}", "received_events_url": "https://api.github.com/users/ytmimi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "calebcartwright", "id": 13042488, "node_id": "MDQ6VXNlcjEzMDQyNDg4", "avatar_url": "https://avatars.githubusercontent.com/u/13042488?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebcartwright", "html_url": "https://github.com/calebcartwright", "followers_url": "https://api.github.com/users/calebcartwright/followers", "following_url": "https://api.github.com/users/calebcartwright/following{/other_user}", "gists_url": "https://api.github.com/users/calebcartwright/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebcartwright/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebcartwright/subscriptions", "organizations_url": "https://api.github.com/users/calebcartwright/orgs", "repos_url": "https://api.github.com/users/calebcartwright/repos", "events_url": "https://api.github.com/users/calebcartwright/events{/privacy}", "received_events_url": "https://api.github.com/users/calebcartwright/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4a053f206fd6799a25823c307f7d7f9d897be118", "url": "https://api.github.com/repos/rust-lang/rust/commits/4a053f206fd6799a25823c307f7d7f9d897be118", "html_url": "https://github.com/rust-lang/rust/commit/4a053f206fd6799a25823c307f7d7f9d897be118"}], "stats": {"total": 83, "additions": 82, "deletions": 1}, "files": [{"sha": "70b937b02836fdc6106e04460d853c8b6b8350a0", "filename": "src/modules.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/737e6f704671dbf30e81dababa0133b585c03b48/src%2Fmodules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/737e6f704671dbf30e81dababa0133b585c03b48/src%2Fmodules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmodules.rs?ref=737e6f704671dbf30e81dababa0133b585c03b48", "patch": "@@ -458,6 +458,7 @@ impl<'ast, 'sess, 'c> ModResolver<'ast, 'sess> {\n             self.directory.path.push(path.as_str());\n             self.directory.ownership = DirectoryOwnership::Owned { relative: None };\n         } else {\n+            let id = id.as_str();\n             // We have to push on the current module name in the case of relative\n             // paths in order to ensure that any additional module paths from inline\n             // `mod x { ... }` come after the relative extension.\n@@ -468,9 +469,15 @@ impl<'ast, 'sess, 'c> ModResolver<'ast, 'sess> {\n                 if let Some(ident) = relative.take() {\n                     // remove the relative offset\n                     self.directory.path.push(ident.as_str());\n+\n+                    // In the case where there is an x.rs and an ./x directory we want\n+                    // to prevent adding x twice. For example, ./x/x\n+                    if self.directory.path.exists() && !self.directory.path.join(id).exists() {\n+                        return;\n+                    }\n                 }\n             }\n-            self.directory.path.push(id.as_str());\n+            self.directory.path.push(id);\n         }\n     }\n "}, {"sha": "fcff6d14e6fa46c6baa7364769023dc94456b4df", "filename": "src/test/mod_resolver.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/737e6f704671dbf30e81dababa0133b585c03b48/src%2Ftest%2Fmod_resolver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/737e6f704671dbf30e81dababa0133b585c03b48/src%2Ftest%2Fmod_resolver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmod_resolver.rs?ref=737e6f704671dbf30e81dababa0133b585c03b48", "patch": "@@ -50,3 +50,17 @@ fn skip_out_of_line_nested_inline_within_out_of_line() {\n         &[\"tests/mod-resolver/skip-files-issue-5065/one.rs\"],\n     );\n }\n+\n+#[test]\n+fn fmt_out_of_line_test_modules() {\n+    // See also https://github.com/rust-lang/rustfmt/issues/5119\n+    verify_mod_resolution(\n+        \"tests/mod-resolver/test-submodule-issue-5119/tests/test1.rs\",\n+        &[\n+            \"tests/mod-resolver/test-submodule-issue-5119/tests/test1.rs\",\n+            \"tests/mod-resolver/test-submodule-issue-5119/tests/test1/sub1.rs\",\n+            \"tests/mod-resolver/test-submodule-issue-5119/tests/test1/sub2.rs\",\n+            \"tests/mod-resolver/test-submodule-issue-5119/tests/test1/sub3/sub4.rs\",\n+        ],\n+    )\n+}"}, {"sha": "bf81f253f6913fc6b367faa0a3041840743d981d", "filename": "tests/cargo-fmt/main.rs", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fcargo-fmt%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fcargo-fmt%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcargo-fmt%2Fmain.rs?ref=737e6f704671dbf30e81dababa0133b585c03b48", "patch": "@@ -2,6 +2,7 @@\n \n use std::env;\n use std::process::Command;\n+use std::path::Path;\n \n /// Run the cargo-fmt executable and return its output.\n fn cargo_fmt(args: &[&str]) -> (String, String) {\n@@ -71,3 +72,26 @@ fn rustfmt_help() {\n     assert_that!(&[\"--\", \"-h\"], contains(\"Format Rust code\"));\n     assert_that!(&[\"--\", \"--help=config\"], contains(\"Configuration Options:\"));\n }\n+\n+#[test]\n+fn cargo_fmt_out_of_line_test_modules() {\n+    // See also https://github.com/rust-lang/rustfmt/issues/5119\n+    let expected_modified_files = [\n+        \"tests/mod-resolver/test-submodule-issue-5119/src/lib.rs\",\n+        \"tests/mod-resolver/test-submodule-issue-5119/tests/test1.rs\",\n+        \"tests/mod-resolver/test-submodule-issue-5119/tests/test1/sub1.rs\",\n+        \"tests/mod-resolver/test-submodule-issue-5119/tests/test1/sub2.rs\",\n+        \"tests/mod-resolver/test-submodule-issue-5119/tests/test1/sub3/sub4.rs\",\n+    ];\n+    let args = [\n+        \"-v\",\n+        \"--check\",\n+        \"--manifest-path\",\n+        \"tests/mod-resolver/test-submodule-issue-5119/Cargo.toml\",\n+    ];\n+    let (stdout, _) = cargo_fmt(&args);\n+    for file in expected_modified_files {\n+        let path = Path::new(file).canonicalize().unwrap();\n+        assert!(stdout.contains(&format!(\"Diff in {}\", path.display())))\n+    }\n+}"}, {"sha": "0993f12795991d2ec4a75bb396aff7643cfa1d16", "filename": "tests/mod-resolver/test-submodule-issue-5119/Cargo.toml", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2FCargo.toml?ref=737e6f704671dbf30e81dababa0133b585c03b48", "patch": "@@ -0,0 +1,8 @@\n+[package]\n+name = \"rustfmt-test-submodule-issue\"\n+version = \"0.1.0\"\n+edition = \"2018\"\n+\n+# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n+\n+[dependencies]"}, {"sha": "3f7ddba8a288c71986e6735c31f2576befc6cb23", "filename": "tests/mod-resolver/test-submodule-issue-5119/src/lib.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Fsrc%2Flib.rs?ref=737e6f704671dbf30e81dababa0133b585c03b48", "patch": "@@ -0,0 +1,7 @@\n+pub fn foo() -> i32 {\n+3\n+}\n+\n+pub fn bar() -> i32 {\n+4\n+}"}, {"sha": "da4e86169ad926dcae7d34de1f480fdd79f32666", "filename": "tests/mod-resolver/test-submodule-issue-5119/tests/test1.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1.rs?ref=737e6f704671dbf30e81dababa0133b585c03b48", "patch": "@@ -0,0 +1,8 @@\n+mod test1 {\n+#[cfg(unix)]\n+mod sub1;\n+#[cfg(not(unix))]\n+mod sub2;\n+\n+mod sub3;\n+}"}, {"sha": "b760ba23cd2775c3aa55c763f2f86a7791ba50c6", "filename": "tests/mod-resolver/test-submodule-issue-5119/tests/test1/sub1.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1%2Fsub1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1%2Fsub1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1%2Fsub1.rs?ref=737e6f704671dbf30e81dababa0133b585c03b48", "patch": "@@ -0,0 +1,6 @@\n+use rustfmt_test_submodule_issue::foo;\n+\n+#[test]\n+fn test_foo() {\n+assert_eq!(3, foo());\n+}"}, {"sha": "4fd8286eac400a4bc2cc9846aa2341127bf55668", "filename": "tests/mod-resolver/test-submodule-issue-5119/tests/test1/sub2.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1%2Fsub2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1%2Fsub2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1%2Fsub2.rs?ref=737e6f704671dbf30e81dababa0133b585c03b48", "patch": "@@ -0,0 +1,6 @@\n+use rustfmt_test_submodule_issue::bar;\n+\n+#[test]\n+fn test_bar() {\n+assert_eq!(4, bar());\n+}"}, {"sha": "e029785bc24579303fbcf4f0b5c75b1f880fd0ac", "filename": "tests/mod-resolver/test-submodule-issue-5119/tests/test1/sub3/mod.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1%2Fsub3%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1%2Fsub3%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1%2Fsub3%2Fmod.rs?ref=737e6f704671dbf30e81dababa0133b585c03b48", "patch": "@@ -0,0 +1 @@\n+mod sub4;"}, {"sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391", "filename": "tests/mod-resolver/test-submodule-issue-5119/tests/test1/sub3/sub4.rs", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1%2Fsub3%2Fsub4.rs", "raw_url": "https://github.com/rust-lang/rust/raw/737e6f704671dbf30e81dababa0133b585c03b48/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1%2Fsub3%2Fsub4.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmod-resolver%2Ftest-submodule-issue-5119%2Ftests%2Ftest1%2Fsub3%2Fsub4.rs?ref=737e6f704671dbf30e81dababa0133b585c03b48"}]}