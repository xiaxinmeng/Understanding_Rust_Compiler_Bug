{"sha": "445280a1b1d740f084f39efa3f583980adfe1dfa", "node_id": "C_kwDOAAsO6NoAKDQ0NTI4MGExYjFkNzQwZjA4NGYzOWVmYTNmNTgzOTgwYWRmZTFkZmE", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-11-16T18:32:38Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-11-16T18:42:19Z"}, "message": "Allow disabling perf access via `RA_DISABLE_PERF`", "tree": {"sha": "bde057cc8ba7769c6d0752820e3c75db3535d3f4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bde057cc8ba7769c6d0752820e3c75db3535d3f4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/445280a1b1d740f084f39efa3f583980adfe1dfa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/445280a1b1d740f084f39efa3f583980adfe1dfa", "html_url": "https://github.com/rust-lang/rust/commit/445280a1b1d740f084f39efa3f583980adfe1dfa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/445280a1b1d740f084f39efa3f583980adfe1dfa/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9f1e26c3f9804eaaf2941feaa140d6f8c6d8c562", "url": "https://api.github.com/repos/rust-lang/rust/commits/9f1e26c3f9804eaaf2941feaa140d6f8c6d8c562", "html_url": "https://github.com/rust-lang/rust/commit/9f1e26c3f9804eaaf2941feaa140d6f8c6d8c562"}], "stats": {"total": 27, "additions": 19, "deletions": 8}, "files": [{"sha": "6258328482962d622b0c6d91ee1641d7cf35940c", "filename": "crates/profile/src/stop_watch.rs", "status": "modified", "additions": 19, "deletions": 8, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/445280a1b1d740f084f39efa3f583980adfe1dfa/crates%2Fprofile%2Fsrc%2Fstop_watch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/445280a1b1d740f084f39efa3f583980adfe1dfa/crates%2Fprofile%2Fsrc%2Fstop_watch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fprofile%2Fsrc%2Fstop_watch.rs?ref=445280a1b1d740f084f39efa3f583980adfe1dfa", "patch": "@@ -23,16 +23,27 @@ impl StopWatch {\n     pub fn start() -> StopWatch {\n         #[cfg(target_os = \"linux\")]\n         let counter = {\n-            let mut counter = perf_event::Builder::new()\n-                .build()\n-                .map_err(|err| eprintln!(\"Failed to create perf counter: {}\", err))\n-                .ok();\n-            if let Some(counter) = &mut counter {\n-                if let Err(err) = counter.enable() {\n-                    eprintln!(\"Failed to start perf counter: {}\", err)\n+            // When debugging rust-analyzer using rr, the perf-related syscalls cause it to abort.\n+            // We allow disabling perf by setting the env var `RA_DISABLE_PERF`.\n+\n+            use once_cell::sync::Lazy;\n+            static PERF_ENABLED: Lazy<bool> =\n+                Lazy::new(|| std::env::var_os(\"RA_DISABLE_PERF\").is_none());\n+\n+            if *PERF_ENABLED {\n+                let mut counter = perf_event::Builder::new()\n+                    .build()\n+                    .map_err(|err| eprintln!(\"Failed to create perf counter: {}\", err))\n+                    .ok();\n+                if let Some(counter) = &mut counter {\n+                    if let Err(err) = counter.enable() {\n+                        eprintln!(\"Failed to start perf counter: {}\", err)\n+                    }\n                 }\n+                counter\n+            } else {\n+                None\n             }\n-            counter\n         };\n         let time = Instant::now();\n         StopWatch {"}]}