{"sha": "7ba1a239a4fc54f101434128e76b370b926cb8ef", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdiYTFhMjM5YTRmYzU0ZjEwMTQzNDEyOGU3NmIzNzBiOTI2Y2I4ZWY=", "commit": {"author": {"name": "Matthijs Hofstra", "email": "thiezz@gmail.com", "date": "2013-06-16T15:50:16Z"}, "committer": {"name": "Matthijs Hofstra", "email": "thiezz@gmail.com", "date": "2013-06-23T22:09:04Z"}, "message": "Changed Arena API to make it usable once more.", "tree": {"sha": "e103836108964824b6286b0049d3419f52e820de", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e103836108964824b6286b0049d3419f52e820de"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7ba1a239a4fc54f101434128e76b370b926cb8ef", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7ba1a239a4fc54f101434128e76b370b926cb8ef", "html_url": "https://github.com/rust-lang/rust/commit/7ba1a239a4fc54f101434128e76b370b926cb8ef", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7ba1a239a4fc54f101434128e76b370b926cb8ef/comments", "author": {"login": "Thiez", "id": 204550, "node_id": "MDQ6VXNlcjIwNDU1MA==", "avatar_url": "https://avatars.githubusercontent.com/u/204550?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Thiez", "html_url": "https://github.com/Thiez", "followers_url": "https://api.github.com/users/Thiez/followers", "following_url": "https://api.github.com/users/Thiez/following{/other_user}", "gists_url": "https://api.github.com/users/Thiez/gists{/gist_id}", "starred_url": "https://api.github.com/users/Thiez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Thiez/subscriptions", "organizations_url": "https://api.github.com/users/Thiez/orgs", "repos_url": "https://api.github.com/users/Thiez/repos", "events_url": "https://api.github.com/users/Thiez/events{/privacy}", "received_events_url": "https://api.github.com/users/Thiez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Thiez", "id": 204550, "node_id": "MDQ6VXNlcjIwNDU1MA==", "avatar_url": "https://avatars.githubusercontent.com/u/204550?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Thiez", "html_url": "https://github.com/Thiez", "followers_url": "https://api.github.com/users/Thiez/followers", "following_url": "https://api.github.com/users/Thiez/following{/other_user}", "gists_url": "https://api.github.com/users/Thiez/gists{/gist_id}", "starred_url": "https://api.github.com/users/Thiez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Thiez/subscriptions", "organizations_url": "https://api.github.com/users/Thiez/orgs", "repos_url": "https://api.github.com/users/Thiez/repos", "events_url": "https://api.github.com/users/Thiez/events{/privacy}", "received_events_url": "https://api.github.com/users/Thiez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6762754d5b718d2d3f938963d2a4d82eb20eb9fd", "url": "https://api.github.com/repos/rust-lang/rust/commits/6762754d5b718d2d3f938963d2a4d82eb20eb9fd", "html_url": "https://github.com/rust-lang/rust/commit/6762754d5b718d2d3f938963d2a4d82eb20eb9fd"}], "stats": {"total": 22, "additions": 11, "deletions": 11}, "files": [{"sha": "302f1fbeb04aad065eab5a3d13f4c0ddab57775a", "filename": "src/libextra/arena.rs", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/7ba1a239a4fc54f101434128e76b370b926cb8ef/src%2Flibextra%2Farena.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ba1a239a4fc54f101434128e76b370b926cb8ef/src%2Flibextra%2Farena.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibextra%2Farena.rs?ref=7ba1a239a4fc54f101434128e76b370b926cb8ef", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -39,7 +39,7 @@ use core::prelude::*;\n use list::{MutList, MutCons, MutNil};\n \n use core::at_vec;\n-use core::cast::{transmute, transmute_mut_region};\n+use core::cast::{transmute, transmute_mut, transmute_mut_region};\n use core::cast;\n use core::libc::size_t;\n use core::ptr;\n@@ -74,6 +74,7 @@ struct Chunk {\n     is_pod: bool,\n }\n \n+#[mutable]\n pub struct Arena {\n     // The head is separated out from the list as a unbenchmarked\n     // microoptimization, to avoid needing to case on the list to\n@@ -269,23 +270,22 @@ impl Arena {\n \n     // The external interface\n     #[inline]\n-    pub fn alloc<'a, T>(&'a mut self, op: &fn() -> T) -> &'a T {\n+    pub fn alloc<'a, T>(&'a self, op: &fn() -> T) -> &'a T {\n         unsafe {\n             // XXX: Borrow check\n-            let this = transmute_mut_region(self);\n-            if !intrinsics::needs_drop::<T>() {\n-                return this.alloc_pod(op);\n+            let this = transmute_mut(self);\n+            if intrinsics::needs_drop::<T>() {\n+                this.alloc_nonpod(op)\n+            } else {\n+                this.alloc_pod(op)\n             }\n-            // XXX: Borrow check\n-            let this = transmute_mut_region(self);\n-            this.alloc_nonpod(op)\n         }\n     }\n }\n \n #[test]\n fn test_arena_destructors() {\n-    let mut arena = Arena();\n+    let arena = Arena();\n     for uint::range(0, 10) |i| {\n         // Arena allocate something with drop glue to make sure it\n         // doesn't leak.\n@@ -300,7 +300,7 @@ fn test_arena_destructors() {\n #[should_fail]\n #[ignore(cfg(windows))]\n fn test_arena_destructors_fail() {\n-    let mut arena = Arena();\n+    let arena = Arena();\n     // Put some stuff in the arena.\n     for uint::range(0, 10) |i| {\n         // Arena allocate something with drop glue to make sure it"}]}