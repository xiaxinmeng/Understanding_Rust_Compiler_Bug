{"sha": "5f93159e9ddc05f479ade72e604a0267b5413be7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVmOTMxNTllOWRkYzA1ZjQ3OWFkZTcyZTYwNGEwMjY3YjU0MTNiZTc=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2018-01-22T22:44:08Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2018-01-22T22:44:08Z"}, "message": "Fasten up theme loading", "tree": {"sha": "369d3bd1ddaf105f266015e8958cf89aba981ae0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/369d3bd1ddaf105f266015e8958cf89aba981ae0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5f93159e9ddc05f479ade72e604a0267b5413be7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5f93159e9ddc05f479ade72e604a0267b5413be7", "html_url": "https://github.com/rust-lang/rust/commit/5f93159e9ddc05f479ade72e604a0267b5413be7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5f93159e9ddc05f479ade72e604a0267b5413be7/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3c52acd9ca3c231b2cab881a9653135dca17e8aa", "url": "https://api.github.com/repos/rust-lang/rust/commits/3c52acd9ca3c231b2cab881a9653135dca17e8aa", "html_url": "https://github.com/rust-lang/rust/commit/3c52acd9ca3c231b2cab881a9653135dca17e8aa"}], "stats": {"total": 74, "additions": 49, "deletions": 25}, "files": [{"sha": "7b4781870de6669d254c3abf2672fbc3b279083b", "filename": "src/librustdoc/html/layout.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5f93159e9ddc05f479ade72e604a0267b5413be7/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f93159e9ddc05f479ade72e604a0267b5413be7/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Flayout.rs?ref=5f93159e9ddc05f479ade72e604a0267b5413be7", "patch": "@@ -48,7 +48,8 @@ r##\"<!DOCTYPE html>\n \n     <link rel=\"stylesheet\" type=\"text/css\" href=\"{root_path}normalize.css\">\n     <link rel=\"stylesheet\" type=\"text/css\" href=\"{root_path}rustdoc.css\" id=\"mainThemeStyle\">\n-    <link rel=\"stylesheet\" type=\"text/css\" href=\"{root_path}main.css\" id=\"themeStyle\">\n+    <link rel=\"stylesheet\" type=\"text/css\" href=\"\" id=\"themeStyle\">\n+    <script src=\"{root_path}storage.js\"></script>\n     {css_extension}\n \n     {favicon}\n@@ -70,10 +71,10 @@ r##\"<!DOCTYPE html>\n         {sidebar}\n     </nav>\n \n-    <div id=\"theme-picker\">\n+    <button id=\"theme-picker\">\n         <img src=\"{root_path}brush.svg\" width=\"18\" alt=\"Pick another theme!\">\n         <div id=\"theme-choices\"></div>\n-    </div>\n+    </button>\n     <script src=\"{root_path}theme.js\"></script>\n     <nav class=\"sub\">\n         <form class=\"search-form js-only\">"}, {"sha": "9993823c5804adc406d7a7ccad1c92740eb66859", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 1, "deletions": 22, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/5f93159e9ddc05f479ade72e604a0267b5413be7/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f93159e9ddc05f479ade72e604a0267b5413be7/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=5f93159e9ddc05f479ade72e604a0267b5413be7", "patch": "@@ -917,8 +917,6 @@ themePicker.onclick = function() {{\n         themePicker.style.borderBottomLeftRadius = \"0\";\n     }}\n }};\n-var currentTheme = document.getElementById(\"themeStyle\");\n-var mainTheme = document.getElementById(\"mainThemeStyle\");\n [{}].forEach(function(item) {{\n     var div = document.createElement('div');\n     div.innerHTML = item;\n@@ -927,32 +925,13 @@ var mainTheme = document.getElementById(\"mainThemeStyle\");\n     }};\n     themes.appendChild(div);\n }});\n-\n-function updateLocalStorage(theme) {{\n-    if (typeof(Storage) !== \"undefined\") {{\n-        localStorage.theme = theme;\n-    }} else {{\n-        // No Web Storage support so we do nothing\n-    }}\n-}}\n-function switchTheme(styleElem, mainStyleElem, newTheme) {{\n-    styleElem.href = mainStyleElem.href.replace(\"rustdoc.css\", newTheme + \".css\");\n-    updateLocalStorage(newTheme);\n-}}\n-function getCurrentTheme() {{\n-    if (typeof(Storage) !== \"undefined\" && localStorage.theme !== undefined) {{\n-        return localStorage.theme;\n-    }}\n-    return \"main\";\n-}}\n-\n-switchTheme(currentTheme, mainTheme, getCurrentTheme());\n \"#, themes.iter()\n           .map(|s| format!(\"\\\"{}\\\"\", s))\n           .collect::<Vec<String>>()\n           .join(\",\")).as_bytes())?;\n \n     write(cx.dst.join(\"main.js\"), include_bytes!(\"static/main.js\"))?;\n+    write(cx.dst.join(\"storage.js\"), include_bytes!(\"static/storage.js\"))?;\n \n     if let Some(ref css) = cx.shared.css_file_extension {\n         let out = cx.dst.join(\"theme.css\");"}, {"sha": "7e384a64c0aa5b5ae56f46f47bac28fe702c1a2f", "filename": "src/librustdoc/html/static/storage.js", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/5f93159e9ddc05f479ade72e604a0267b5413be7/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fstorage.js", "raw_url": "https://github.com/rust-lang/rust/raw/5f93159e9ddc05f479ade72e604a0267b5413be7/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fstorage.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fstorage.js?ref=5f93159e9ddc05f479ade72e604a0267b5413be7", "patch": "@@ -0,0 +1,44 @@\n+/*!\n+ * Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+ * file at the top-level directory of this distribution and at\n+ * http://rust-lang.org/COPYRIGHT.\n+ *\n+ * Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+ * http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+ * <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+ * option. This file may not be copied, modified, or distributed\n+ * except according to those terms.\n+ */\n+\n+var currentTheme = document.getElementById(\"themeStyle\");\n+var mainTheme = document.getElementById(\"mainThemeStyle\");\n+\n+function updateLocalStorage(name, value) {\n+    if (typeof(Storage) !== \"undefined\") {\n+        localStorage[name] = value;\n+    } else {\n+        // No Web Storage support so we do nothing\n+    }\n+}\n+\n+function getCurrentValue(name) {\n+    if (typeof(Storage) !== \"undefined\" && localStorage[name] !== undefined) {\n+        return localStorage[name];\n+    }\n+    return null;\n+}\n+\n+function switchTheme(styleElem, mainStyleElem, newTheme) {\n+    styleElem.href = mainStyleElem.href.replace(\"rustdoc.css\", newTheme + \".css\");\n+    updateLocalStorage('theme', newTheme);\n+    /*var elem = document.getElementsByTagName('body')[0];\n+    if (elem) {\n+        updateLocalStorage('background', getComputedStyle(elem)['background-color']);\n+    }*/\n+}\n+\n+/*var elem = document.getElementsByTagName('body')[0];\n+if (elem) {\n+    var value = \n+}*/\n+switchTheme(currentTheme, mainTheme, getCurrentValue('theme') || 'main');"}]}