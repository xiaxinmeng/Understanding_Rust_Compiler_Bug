{"sha": "f0e802f4903cee864b193beb2ddcd50d6d9f60c7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYwZTgwMmY0OTAzY2VlODY0YjE5M2JlYjJkZGNkNTBkNmQ5ZjYwYzc=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-01-13T11:09:51Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-01-13T12:07:30Z"}, "message": "Don't show internal server error on rename\n\nDoesn't quite work due to https://github.com/microsoft/vscode-languageserver-node/issues/730\n\nNote that this intentionally removes `impl std::Error for RenameError`\n-- we nether want to blindly bubble the rename error.", "tree": {"sha": "9830f7b3a9607d7b385fb3311ef078ade5a42768", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9830f7b3a9607d7b385fb3311ef078ade5a42768"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f0e802f4903cee864b193beb2ddcd50d6d9f60c7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f0e802f4903cee864b193beb2ddcd50d6d9f60c7", "html_url": "https://github.com/rust-lang/rust/commit/f0e802f4903cee864b193beb2ddcd50d6d9f60c7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f0e802f4903cee864b193beb2ddcd50d6d9f60c7/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "52fa926f005890f07dffc789c84c2be57a6bdccc", "url": "https://api.github.com/repos/rust-lang/rust/commits/52fa926f005890f07dffc789c84c2be57a6bdccc", "html_url": "https://github.com/rust-lang/rust/commit/52fa926f005890f07dffc789c84c2be57a6bdccc"}], "stats": {"total": 24, "additions": 10, "deletions": 14}, "files": [{"sha": "3db08e84cfc46c0aeb79b648dd73d017b3faa36c", "filename": "crates/ide/src/references/rename.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f0e802f4903cee864b193beb2ddcd50d6d9f60c7/crates%2Fide%2Fsrc%2Freferences%2Frename.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f0e802f4903cee864b193beb2ddcd50d6d9f60c7/crates%2Fide%2Fsrc%2Freferences%2Frename.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Freferences%2Frename.rs?ref=f0e802f4903cee864b193beb2ddcd50d6d9f60c7", "patch": "@@ -1,7 +1,6 @@\n //! FIXME: write short doc here\n use std::{\n     convert::TryInto,\n-    error::Error,\n     fmt::{self, Display},\n };\n \n@@ -34,8 +33,6 @@ impl fmt::Display for RenameError {\n     }\n }\n \n-impl Error for RenameError {}\n-\n macro_rules! format_err {\n     ($fmt:expr) => {RenameError(format!($fmt))};\n     ($fmt:expr, $($arg:tt)+) => {RenameError(format!($fmt, $($arg)+))}"}, {"sha": "a21571eea023b6dcad42e5701a2e722a9533cd40", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 4, "deletions": 10, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f0e802f4903cee864b193beb2ddcd50d6d9f60c7/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f0e802f4903cee864b193beb2ddcd50d6d9f60c7/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=f0e802f4903cee864b193beb2ddcd50d6d9f60c7", "patch": "@@ -773,7 +773,8 @@ pub(crate) fn handle_prepare_rename(\n     let _p = profile::span(\"handle_prepare_rename\");\n     let position = from_proto::file_position(&snap, params)?;\n \n-    let change = snap.analysis.prepare_rename(position)??;\n+    let change = snap.analysis.prepare_rename(position)?.map_err(to_proto::rename_error)?;\n+\n     let line_index = snap.analysis.file_line_index(position.file_id)?;\n     let range = to_proto::range(&line_index, change.range);\n     Ok(Some(PrepareRenameResponse::Range(range)))\n@@ -786,15 +787,8 @@ pub(crate) fn handle_rename(\n     let _p = profile::span(\"handle_rename\");\n     let position = from_proto::file_position(&snap, params.text_document_position)?;\n \n-    if params.new_name.is_empty() {\n-        return Err(LspError::new(\n-            ErrorCode::InvalidParams as i32,\n-            \"New Name cannot be empty\".into(),\n-        )\n-        .into());\n-    }\n-\n-    let change = snap.analysis.rename(position, &*params.new_name)??;\n+    let change =\n+        snap.analysis.rename(position, &*params.new_name)?.map_err(to_proto::rename_error)?;\n     let workspace_edit = to_proto::workspace_edit(&snap, change.info)?;\n     Ok(Some(workspace_edit))\n }"}, {"sha": "a7ff8975adfe17e900ba56bd9f65fa446fe20e92", "filename": "crates/rust-analyzer/src/to_proto.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f0e802f4903cee864b193beb2ddcd50d6d9f60c7/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f0e802f4903cee864b193beb2ddcd50d6d9f60c7/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs?ref=f0e802f4903cee864b193beb2ddcd50d6d9f60c7", "patch": "@@ -8,7 +8,8 @@ use ide::{\n     Assist, AssistKind, CallInfo, CompletionItem, CompletionItemKind, Documentation, FileId,\n     FileRange, FileSystemEdit, Fold, FoldKind, Highlight, HlMod, HlPunct, HlRange, HlTag, Indel,\n     InlayHint, InlayKind, InsertTextFormat, LineIndex, Markup, NavigationTarget, ReferenceAccess,\n-    Runnable, Severity, SourceChange, SourceFileEdit, SymbolKind, TextEdit, TextRange, TextSize,\n+    RenameError, Runnable, Severity, SourceChange, SourceFileEdit, SymbolKind, TextEdit, TextRange,\n+    TextSize,\n };\n use itertools::Itertools;\n \n@@ -855,6 +856,10 @@ pub(crate) fn markup_content(markup: Markup) -> lsp_types::MarkupContent {\n     lsp_types::MarkupContent { kind: lsp_types::MarkupKind::Markdown, value }\n }\n \n+pub(crate) fn rename_error(err: RenameError) -> crate::LspError {\n+    crate::LspError { code: lsp_server::ErrorCode::InvalidParams as i32, message: err.to_string() }\n+}\n+\n #[cfg(test)]\n mod tests {\n     use ide::Analysis;"}]}