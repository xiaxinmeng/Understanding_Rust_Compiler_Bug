{"sha": "5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "node_id": "C_kwDOAAsO6NoAKDViZjEzOWUzNjA5MjU1ZjZiZGVhZTBmOGRjYzQwZWViMTAyMTE0OGI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-27T22:19:56Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-27T22:19:56Z"}, "message": "Auto merge of #109440 - WaffleLapkin:make_tidy_slower, r=jyn514\n\nDon't skip all directories when tidy-checking\n\nThis fixes a regression from https://github.com/rust-lang/rust/pull/108772 which basically made it that tidy style checks only `README.md` and `COMPILER_TESTS.md`.", "tree": {"sha": "638e8f08b909ec1ef357423dfd3e6df456eb2fcb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/638e8f08b909ec1ef357423dfd3e6df456eb2fcb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "html_url": "https://github.com/rust-lang/rust/commit/5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2036fdd24f77d607dcfaa24c48fbe85d3f785823", "url": "https://api.github.com/repos/rust-lang/rust/commits/2036fdd24f77d607dcfaa24c48fbe85d3f785823", "html_url": "https://github.com/rust-lang/rust/commit/2036fdd24f77d607dcfaa24c48fbe85d3f785823"}, {"sha": "904dd2c3987028f0270db306b9964bc465689de8", "url": "https://api.github.com/repos/rust-lang/rust/commits/904dd2c3987028f0270db306b9964bc465689de8", "html_url": "https://github.com/rust-lang/rust/commit/904dd2c3987028f0270db306b9964bc465689de8"}], "stats": {"total": 154, "additions": 87, "deletions": 67}, "files": [{"sha": "cb217be66547663af86c1a27f5421d08b3390392", "filename": "compiler/rustc_attr/src/builtin.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/compiler%2Frustc_attr%2Fsrc%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/compiler%2Frustc_attr%2Fsrc%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_attr%2Fsrc%2Fbuiltin.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -227,7 +227,7 @@ impl UnstableReason {\n }\n \n /// Collects stability info from `stable`/`unstable`/`rustc_allowed_through_unstable_modules`\n-/// attributes in `attrs`.  Returns `None` if no stability attributes are found.\n+/// attributes in `attrs`. Returns `None` if no stability attributes are found.\n pub fn find_stability(\n     sess: &Session,\n     attrs: &[Attribute],\n@@ -281,7 +281,7 @@ pub fn find_stability(\n }\n \n /// Collects stability info from `rustc_const_stable`/`rustc_const_unstable`/`rustc_promotable`\n-/// attributes in `attrs`.  Returns `None` if no stability attributes are found.\n+/// attributes in `attrs`. Returns `None` if no stability attributes are found.\n pub fn find_const_stability(\n     sess: &Session,\n     attrs: &[Attribute],"}, {"sha": "69bb00f804d3cda155b50ba84fa908a47a86d604", "filename": "compiler/rustc_codegen_ssa/src/back/linker.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -1621,7 +1621,7 @@ impl<'a> Linker for AixLinker<'a> {\n         let path = tmpdir.join(\"list.exp\");\n         let res: io::Result<()> = try {\n             let mut f = BufWriter::new(File::create(&path)?);\n-            // TODO: use llvm-nm to generate export list.\n+            // FIXME: use llvm-nm to generate export list.\n             for symbol in symbols {\n                 debug!(\"  _{}\", symbol);\n                 writeln!(f, \"  {}\", symbol)?;"}, {"sha": "c05324a5a2ccbc5c472634cfceb8a4567821c9ce", "filename": "compiler/rustc_error_codes/src/error_codes/E0080.md", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/compiler%2Frustc_error_codes%2Fsrc%2Ferror_codes%2FE0080.md", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/compiler%2Frustc_error_codes%2Fsrc%2Ferror_codes%2FE0080.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_codes%2Fsrc%2Ferror_codes%2FE0080.md?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -16,7 +16,8 @@ or causing an integer overflow are two ways to induce this error.\n Ensure that the expressions given can be evaluated as the desired integer type.\n \n See the [Discriminants] section of the Reference for more information about\n-setting custom integer types on enums using the [`repr` attribute][repr-attribute].\n+setting custom integer types on enums using the\n+[`repr` attribute][repr-attribute].\n \n [discriminants]: https://doc.rust-lang.org/reference/items/enumerations.html#discriminants\n [repr-attribute]: https://doc.rust-lang.org/reference/type-layout.html#representations"}, {"sha": "c8f73de95a214c74ba609cd1e6ce427bd6be5efe", "filename": "compiler/rustc_error_codes/src/error_codes/E0794.md", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/compiler%2Frustc_error_codes%2Fsrc%2Ferror_codes%2FE0794.md", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/compiler%2Frustc_error_codes%2Fsrc%2Ferror_codes%2FE0794.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_codes%2Fsrc%2Ferror_codes%2FE0794.md?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -59,6 +59,6 @@ In the definition of `bar`, the lifetime parameter `'a` is late-bound, while\n where `'a` is universally quantified and `'b` is substituted by a specific\n lifetime. It is not allowed to explicitly specify early-bound lifetime\n arguments when late-bound lifetime parameters are present (as for `bar_fn2`,\n-see [issue #42868](https://github.com/rust-lang/rust/issues/42868)), although the\n-types that are constrained by early-bound parameters can be specified (as for\n-`bar_fn3`).\n+see [issue #42868](https://github.com/rust-lang/rust/issues/42868)), although\n+the types that are constrained by early-bound parameters can be specified (as\n+for `bar_fn3`)."}, {"sha": "7fff801b1692d81bab23ebdd99dfd018435dcebb", "filename": "compiler/rustc_mir_build/src/build/expr/as_rvalue.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_rvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_rvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_rvalue.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -568,7 +568,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             BinOp::Shl | BinOp::Shr if self.check_overflow && ty.is_integral() => {\n                 // For an unsigned RHS, the shift is in-range for `rhs < bits`.\n                 // For a signed RHS, `IntToInt` cast to the equivalent unsigned\n-                // type and do that same comparison.  Because the type is the\n+                // type and do that same comparison. Because the type is the\n                 // same size, there's no negative shift amount that ends up\n                 // overlapping with valid ones, thus it catches negatives too.\n                 let (lhs_size, _) = ty.int_size_and_signed(self.tcx);"}, {"sha": "b55348b7889c520fcb1545708739e7e3004e2338", "filename": "src/doc/unstable-book/src/compiler-flags/sanitizer.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fsanitizer.md", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fsanitizer.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fsanitizer.md?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -213,7 +213,7 @@ See the [Clang ControlFlowIntegrity documentation][clang-cfi] for more details.\n \n ## Example\n \n-```rust,ignore\n+```rust,ignore (making doc tests pass cross-platform is hard)\n #![feature(naked_functions)]\n \n use std::arch::asm;"}, {"sha": "0aebfc4aad2c8d0af1276c3c47f0065495aa952e", "filename": "src/tools/replace-version-placeholder/src/main.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Freplace-version-placeholder%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Freplace-version-placeholder%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Freplace-version-placeholder%2Fsrc%2Fmain.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -10,7 +10,7 @@ fn main() {\n     let version_str = version_str.trim();\n     walk::walk(\n         &root_path,\n-        |path| {\n+        |path, _is_dir| {\n             walk::filter_dirs(path)\n                 // We exempt these as they require the placeholder\n                 // for their operation"}, {"sha": "fdc411c892530ce3e14886c6b9bc48e87e0165b8", "filename": "src/tools/tidy/src/alphabetical.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Falphabetical.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Falphabetical.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Falphabetical.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -95,7 +95,7 @@ fn check_section<'a>(\n }\n \n pub fn check(path: &Path, bad: &mut bool) {\n-    walk(path, filter_dirs, &mut |entry, contents| {\n+    walk(path, |path, _is_dir| filter_dirs(path), &mut |entry, contents| {\n         let file = &entry.path().display();\n \n         let mut lines = contents.lines().enumerate().peekable();"}, {"sha": "7e5b4d810ba9325c1733b052804495acaccaf856", "filename": "src/tools/tidy/src/bins.rs", "status": "modified", "additions": 31, "deletions": 27, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fbins.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fbins.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fbins.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -103,36 +103,40 @@ mod os_impl {\n \n         // FIXME: we don't need to look at all binaries, only files that have been modified in this branch\n         // (e.g. using `git ls-files`).\n-        walk_no_read(&[path], |path| filter_dirs(path) || path.ends_with(\"src/etc\"), &mut |entry| {\n-            let file = entry.path();\n-            let extension = file.extension();\n-            let scripts = [\"py\", \"sh\", \"ps1\"];\n-            if scripts.into_iter().any(|e| extension == Some(OsStr::new(e))) {\n-                return;\n-            }\n-\n-            if t!(is_executable(&file), file) {\n-                let rel_path = file.strip_prefix(path).unwrap();\n-                let git_friendly_path = rel_path.to_str().unwrap().replace(\"\\\\\", \"/\");\n-\n-                if ALLOWED.contains(&git_friendly_path.as_str()) {\n+        walk_no_read(\n+            &[path],\n+            |path, _is_dir| filter_dirs(path) || path.ends_with(\"src/etc\"),\n+            &mut |entry| {\n+                let file = entry.path();\n+                let extension = file.extension();\n+                let scripts = [\"py\", \"sh\", \"ps1\"];\n+                if scripts.into_iter().any(|e| extension == Some(OsStr::new(e))) {\n                     return;\n                 }\n \n-                let output = Command::new(\"git\")\n-                    .arg(\"ls-files\")\n-                    .arg(&git_friendly_path)\n-                    .current_dir(path)\n-                    .stderr(Stdio::null())\n-                    .output()\n-                    .unwrap_or_else(|e| {\n-                        panic!(\"could not run git ls-files: {e}\");\n-                    });\n-                let path_bytes = rel_path.as_os_str().as_bytes();\n-                if output.status.success() && output.stdout.starts_with(path_bytes) {\n-                    tidy_error!(bad, \"binary checked into source: {}\", file.display());\n+                if t!(is_executable(&file), file) {\n+                    let rel_path = file.strip_prefix(path).unwrap();\n+                    let git_friendly_path = rel_path.to_str().unwrap().replace(\"\\\\\", \"/\");\n+\n+                    if ALLOWED.contains(&git_friendly_path.as_str()) {\n+                        return;\n+                    }\n+\n+                    let output = Command::new(\"git\")\n+                        .arg(\"ls-files\")\n+                        .arg(&git_friendly_path)\n+                        .current_dir(path)\n+                        .stderr(Stdio::null())\n+                        .output()\n+                        .unwrap_or_else(|e| {\n+                            panic!(\"could not run git ls-files: {e}\");\n+                        });\n+                    let path_bytes = rel_path.as_os_str().as_bytes();\n+                    if output.status.success() && output.stdout.starts_with(path_bytes) {\n+                        tidy_error!(bad, \"binary checked into source: {}\", file.display());\n+                    }\n                 }\n-            }\n-        })\n+            },\n+        )\n     }\n }"}, {"sha": "582014d5059d1550c3d36b63a312c7386130d557", "filename": "src/tools/tidy/src/debug_artifacts.rs", "status": "modified", "additions": 16, "deletions": 6, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fdebug_artifacts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fdebug_artifacts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fdebug_artifacts.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -6,11 +6,21 @@ use std::path::Path;\n const GRAPHVIZ_POSTFLOW_MSG: &str = \"`borrowck_graphviz_postflow` attribute in test\";\n \n pub fn check(test_dir: &Path, bad: &mut bool) {\n-    walk(test_dir, |path| filter_dirs(path) || filter_not_rust(path), &mut |entry, contents| {\n-        for (i, line) in contents.lines().enumerate() {\n-            if line.contains(\"borrowck_graphviz_postflow\") {\n-                tidy_error!(bad, \"{}:{}: {}\", entry.path().display(), i + 1, GRAPHVIZ_POSTFLOW_MSG);\n+    walk(\n+        test_dir,\n+        |path, _is_dir| filter_dirs(path) || filter_not_rust(path),\n+        &mut |entry, contents| {\n+            for (i, line) in contents.lines().enumerate() {\n+                if line.contains(\"borrowck_graphviz_postflow\") {\n+                    tidy_error!(\n+                        bad,\n+                        \"{}:{}: {}\",\n+                        entry.path().display(),\n+                        i + 1,\n+                        GRAPHVIZ_POSTFLOW_MSG\n+                    );\n+                }\n             }\n-        }\n-    });\n+        },\n+    );\n }"}, {"sha": "f28f677e0ff22fff13656cec2973b8b26aed1c57", "filename": "src/tools/tidy/src/edition.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fedition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fedition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fedition.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -9,7 +9,7 @@ fn is_edition_2021(mut line: &str) -> bool {\n }\n \n pub fn check(path: &Path, bad: &mut bool) {\n-    walk(path, |path| filter_dirs(path), &mut |entry, contents| {\n+    walk(path, |path, _is_dir| filter_dirs(path), &mut |entry, contents| {\n         let file = entry.path();\n         let filename = file.file_name().unwrap();\n         if filename != \"Cargo.toml\" {"}, {"sha": "417ace58c325deda7bfa7a0526f5774e1afc86eb", "filename": "src/tools/tidy/src/error_codes.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Ferror_codes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Ferror_codes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Ferror_codes.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -129,7 +129,7 @@ fn check_error_codes_docs(\n \n     let mut no_longer_emitted_codes = Vec::new();\n \n-    walk(&docs_path, |_| false, &mut |entry, contents| {\n+    walk(&docs_path, |_, _| false, &mut |entry, contents| {\n         let path = entry.path();\n \n         // Error if the file isn't markdown.\n@@ -321,7 +321,7 @@ fn check_error_codes_used(\n \n     let mut found_codes = Vec::new();\n \n-    walk_many(search_paths, filter_dirs, &mut |entry, contents| {\n+    walk_many(search_paths, |path, _is_dir| filter_dirs(path), &mut |entry, contents| {\n         let path = entry.path();\n \n         // Return early if we aren't looking at a source file."}, {"sha": "2fd4c797b43f19502398f2c16ddaa97822049098", "filename": "src/tools/tidy/src/features.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Ffeatures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Ffeatures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Ffeatures.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -102,7 +102,7 @@ pub fn check(\n             &tests_path.join(\"rustdoc-ui\"),\n             &tests_path.join(\"rustdoc\"),\n         ],\n-        |path| {\n+        |path, _is_dir| {\n             filter_dirs(path)\n                 || filter_not_rust(path)\n                 || path.file_name() == Some(OsStr::new(\"features.rs\"))\n@@ -478,7 +478,7 @@ fn map_lib_features(\n ) {\n     walk(\n         base_src_path,\n-        |path| filter_dirs(path) || path.ends_with(\"tests\"),\n+        |path, _is_dir| filter_dirs(path) || path.ends_with(\"tests\"),\n         &mut |entry, contents| {\n             let file = entry.path();\n             let filename = file.file_name().unwrap().to_string_lossy();"}, {"sha": "2f6918510e8bf0a9d92e51b603037f7018fc1e93", "filename": "src/tools/tidy/src/mir_opt_tests.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fmir_opt_tests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fmir_opt_tests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fmir_opt_tests.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -11,7 +11,7 @@ fn check_unused_files(path: &Path, bless: bool, bad: &mut bool) {\n \n     walk_no_read(\n         &[&path.join(\"mir-opt\")],\n-        |path| path.file_name() == Some(\"README.md\".as_ref()),\n+        |path, _is_dir| path.file_name() == Some(\"README.md\".as_ref()),\n         &mut |file| {\n             let filepath = file.path();\n             if filepath.extension() == Some(\"rs\".as_ref()) {"}, {"sha": "d40c4ad0711cff175a1521fb0dccca463a8f6455", "filename": "src/tools/tidy/src/pal.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fpal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fpal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fpal.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -67,7 +67,7 @@ pub fn check(path: &Path, bad: &mut bool) {\n     // Sanity check that the complex parsing here works.\n     let mut saw_target_arch = false;\n     let mut saw_cfg_bang = false;\n-    walk(path, filter_dirs, &mut |entry, contents| {\n+    walk(path, |path, _is_dir| filter_dirs(path), &mut |entry, contents| {\n         let file = entry.path();\n         let filestr = file.to_string_lossy().replace(\"\\\\\", \"/\");\n         if !filestr.ends_with(\".rs\") {"}, {"sha": "91776bc989e1d36235f02b69c2b029922f074cc7", "filename": "src/tools/tidy/src/rustdoc_gui_tests.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Frustdoc_gui_tests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Frustdoc_gui_tests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Frustdoc_gui_tests.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -5,10 +5,7 @@ use std::path::Path;\n pub fn check(path: &Path, bad: &mut bool) {\n     crate::walk::walk(\n         &path.join(\"rustdoc-gui\"),\n-        |p| {\n-            // If there is no extension, it's very likely a folder and we want to go into it.\n-            p.extension().map(|e| e != \"goml\").unwrap_or(false)\n-        },\n+        |p, is_dir| !is_dir && p.extension().map_or(true, |e| e != \"goml\"),\n         &mut |entry, content| {\n             for line in content.lines() {\n                 if !line.starts_with(\"// \") {"}, {"sha": "a2012db903a1891d36e4f98ca9db104a30a6b0e4", "filename": "src/tools/tidy/src/style.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fstyle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fstyle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fstyle.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -227,7 +227,7 @@ fn is_unexplained_ignore(extension: &str, line: &str) -> bool {\n }\n \n pub fn check(path: &Path, bad: &mut bool) {\n-    fn skip(path: &Path) -> bool {\n+    fn skip(path: &Path, is_dir: bool) -> bool {\n         if path.file_name().map_or(false, |name| name.to_string_lossy().starts_with(\".#\")) {\n             // vim or emacs temporary file\n             return true;\n@@ -237,8 +237,15 @@ pub fn check(path: &Path, bad: &mut bool) {\n             return true;\n         }\n \n+        // Don't check extensions for directories\n+        if is_dir {\n+            return false;\n+        }\n+\n         let extensions = [\"rs\", \"py\", \"js\", \"sh\", \"c\", \"cpp\", \"h\", \"md\", \"css\", \"ftl\", \"goml\"];\n-        if extensions.iter().all(|e| path.extension() != Some(OsStr::new(e))) {\n+\n+        // NB: don't skip paths without extensions (or else we'll skip all directories and will only check top level files)\n+        if path.extension().map_or(true, |ext| !extensions.iter().any(|e| ext == OsStr::new(e))) {\n             return true;\n         }\n "}, {"sha": "de022be289480893fc955e3a7125eab7bcbc4734", "filename": "src/tools/tidy/src/target_specific_tests.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Ftarget_specific_tests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Ftarget_specific_tests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Ftarget_specific_tests.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -37,7 +37,7 @@ struct RevisionInfo<'a> {\n }\n \n pub fn check(path: &Path, bad: &mut bool) {\n-    crate::walk::walk(path, filter_not_rust, &mut |entry, content| {\n+    crate::walk::walk(path, |path, _is_dir| filter_not_rust(path), &mut |entry, content| {\n         let file = entry.path().display();\n         let mut header_map = BTreeMap::new();\n         iter_header(content, &mut |cfg, directive| {"}, {"sha": "20b8a2c3b24d47ca8cc90b6486c100d09c99a396", "filename": "src/tools/tidy/src/ui_tests.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fui_tests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fui_tests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fui_tests.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -51,7 +51,7 @@ pub fn check(path: &Path, bad: &mut bool) {\n     check_entries(&path, bad);\n     let (ui, ui_fulldeps) = (path.join(\"ui\"), path.join(\"ui-fulldeps\"));\n     let paths = [ui.as_path(), ui_fulldeps.as_path()];\n-    crate::walk::walk_no_read(&paths, |_| false, &mut |entry| {\n+    crate::walk::walk_no_read(&paths, |_, _| false, &mut |entry| {\n         let file_path = entry.path();\n         if let Some(ext) = file_path.extension() {\n             if ext == \"stderr\" || ext == \"stdout\" {"}, {"sha": "0a5dad8878943cac855dcf48a41cdf7513eb738b", "filename": "src/tools/tidy/src/unit_tests.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Funit_tests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Funit_tests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Funit_tests.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -20,9 +20,9 @@ pub fn check(root_path: &Path, bad: &mut bool) {\n             && !(path.starts_with(&core_tests) || path.starts_with(&core_benches))\n     };\n \n-    let skip = move |path: &Path| {\n+    let skip = move |path: &Path, is_dir| {\n         let file_name = path.file_name().unwrap_or_default();\n-        if path.is_dir() {\n+        if is_dir {\n             filter_dirs(path)\n                 || path.ends_with(\"src/doc\")\n                 || (file_name == \"tests\" || file_name == \"benches\") && !is_core(path)"}, {"sha": "3539943ebefe2c50cd7d7743f360e24df01649f1", "filename": "src/tools/tidy/src/walk.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fwalk.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/src%2Ftools%2Ftidy%2Fsrc%2Fwalk.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fwalk.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -41,15 +41,15 @@ pub fn filter_not_rust(path: &Path) -> bool {\n \n pub fn walk(\n     path: &Path,\n-    skip: impl Clone + Send + Sync + 'static + Fn(&Path) -> bool,\n+    skip: impl Send + Sync + 'static + Fn(&Path, bool) -> bool,\n     f: &mut dyn FnMut(&DirEntry, &str),\n ) {\n     walk_many(&[path], skip, f);\n }\n \n pub fn walk_many(\n     paths: &[&Path],\n-    skip: impl Clone + Send + Sync + 'static + Fn(&Path) -> bool,\n+    skip: impl Send + Sync + 'static + Fn(&Path, bool) -> bool,\n     f: &mut dyn FnMut(&DirEntry, &str),\n ) {\n     let mut contents = Vec::new();\n@@ -67,14 +67,16 @@ pub fn walk_many(\n \n pub(crate) fn walk_no_read(\n     paths: &[&Path],\n-    skip: impl Send + Sync + 'static + Fn(&Path) -> bool,\n+    skip: impl Send + Sync + 'static + Fn(&Path, bool) -> bool,\n     f: &mut dyn FnMut(&DirEntry),\n ) {\n     let mut walker = ignore::WalkBuilder::new(paths[0]);\n     for path in &paths[1..] {\n         walker.add(path);\n     }\n-    let walker = walker.filter_entry(move |e| !skip(e.path()));\n+    let walker = walker.filter_entry(move |e| {\n+        !skip(e.path(), e.file_type().map(|ft| ft.is_dir()).unwrap_or(false))\n+    });\n     for entry in walker.build() {\n         if let Ok(entry) = entry {\n             if entry.file_type().map_or(true, |kind| kind.is_dir() || kind.is_symlink()) {"}, {"sha": "9c36d0d71c4bccdca8f7aed5f7a46f109f3c777d", "filename": "tests/rustdoc/issue-108925.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/tests%2Frustdoc%2Fissue-108925.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/tests%2Frustdoc%2Fissue-108925.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc%2Fissue-108925.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -8,4 +8,3 @@ pub enum MyThing {\n     #[doc(hidden)]\n     NotShown,\n }\n-"}, {"sha": "85345d65c4af42b94a2da0268736bccfdc385ecd", "filename": "tests/ui/const-generics/generic_const_exprs/typeid-equality-by-subtyping.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/tests%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Ftypeid-equality-by-subtyping.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bf139e3609255f6bdeae0f8dcc40eeb1021148b/tests%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Ftypeid-equality-by-subtyping.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Ftypeid-equality-by-subtyping.rs?ref=5bf139e3609255f6bdeae0f8dcc40eeb1021148b", "patch": "@@ -17,7 +17,7 @@ const fn to_usize<T: 'static>() -> usize {\n     match TypeId::of::<T>() {\n         WHAT_A_TYPE => 0,\n         _ => 1000,\n-    } \n+    }\n }\n impl<T: 'static> AssocCt for T {\n     const ASSOC: usize = to_usize::<T>();"}]}