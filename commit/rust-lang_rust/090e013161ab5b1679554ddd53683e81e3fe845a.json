{"sha": "090e013161ab5b1679554ddd53683e81e3fe845a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA5MGUwMTMxNjFhYjViMTY3OTU1NGRkZDUzNjgzZTgxZTNmZTg0NWE=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-03-20T22:32:25Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-20T22:32:25Z"}, "message": "Merge #8124\n\n8124: Add basic lifetime completion r=Veykril a=Veykril\n\nThis adds basic lifetime completion, basic in the sense that the completions for lifetimes are only shown when the user enters `'` followed by a char. Showing them when nothing is entered is kind of a pain, as we would want them to only show up where they are useful which in turn requires a lot of tree traversal and cursor position checking to verify whether the position is valid for a lifetime. This in itself doesn't seem too bad as usually when you know you want to write a lifetime putting `'` to ask for lifetime completions seems fine.\r\n\r\n~~I'll take a look at whether its possible to lift the restriction of having to put a char after `'`.~~ This actually already works so I guess this is the clients responsibility, in which case VSCode doesn't like it.\r\n\r\n![TYH9gIlyVo](https://user-images.githubusercontent.com/3757771/111886437-c9b02f80-89cd-11eb-9bee-340f1536b0de.gif)\r\n\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "ffcf20a2b041f8fada69f7dfbc4adb1e129327f1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ffcf20a2b041f8fada69f7dfbc4adb1e129327f1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/090e013161ab5b1679554ddd53683e81e3fe845a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgVnf5CRBK7hj4Ov3rIwAAdHIIAGQ8jEVr37nDjiWavQbKxTOG\naXbqbeSsO797OKYWB09ZlJ8CEVNZvEZJQkdXzgRH5OI1AUFamK4mLHEdwOKvHwEn\ndsV3vGn1FQBkFJ8WgPrLzEnMIy0AYiDpWdzHZQYPsK7CDB8BtQ+pAOq+s8BFkIej\niM00OIrsIYx9o0xuqxlm917SV1rHj2dkfPVTQc3zynWaG/vWZcUcAABlnZ5T1EN1\nvUwNli1HfWSv18hfxN1IL0KyMWkfZjd1Kcp8buEkCFAe1opgGIgLlQCGsqxlOwY8\nKX9oyv2Yo+jcvq8o5ulZCJ1t1xpYU0583GszVzxiKGfw6mk1vcq+EmkSV0JlKkY=\n=M31p\n-----END PGP SIGNATURE-----\n", "payload": "tree ffcf20a2b041f8fada69f7dfbc4adb1e129327f1\nparent be3dc673e2f00eaa7cfbf4727cc69032ed0b6179\nparent 3c000c6364ebcf94652d221ee9ffe8970540589c\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1616279545 +0000\ncommitter GitHub <noreply@github.com> 1616279545 +0000\n\nMerge #8124\n\n8124: Add basic lifetime completion r=Veykril a=Veykril\n\nThis adds basic lifetime completion, basic in the sense that the completions for lifetimes are only shown when the user enters `'` followed by a char. Showing them when nothing is entered is kind of a pain, as we would want them to only show up where they are useful which in turn requires a lot of tree traversal and cursor position checking to verify whether the position is valid for a lifetime. This in itself doesn't seem too bad as usually when you know you want to write a lifetime putting `'` to ask for lifetime completions seems fine.\r\n\r\n~~I'll take a look at whether its possible to lift the restriction of having to put a char after `'`.~~ This actually already works so I guess this is the clients responsibility, in which case VSCode doesn't like it.\r\n\r\n![TYH9gIlyVo](https://user-images.githubusercontent.com/3757771/111886437-c9b02f80-89cd-11eb-9bee-340f1536b0de.gif)\r\n\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/090e013161ab5b1679554ddd53683e81e3fe845a", "html_url": "https://github.com/rust-lang/rust/commit/090e013161ab5b1679554ddd53683e81e3fe845a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/090e013161ab5b1679554ddd53683e81e3fe845a/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "be3dc673e2f00eaa7cfbf4727cc69032ed0b6179", "url": "https://api.github.com/repos/rust-lang/rust/commits/be3dc673e2f00eaa7cfbf4727cc69032ed0b6179", "html_url": "https://github.com/rust-lang/rust/commit/be3dc673e2f00eaa7cfbf4727cc69032ed0b6179"}, {"sha": "3c000c6364ebcf94652d221ee9ffe8970540589c", "url": "https://api.github.com/repos/rust-lang/rust/commits/3c000c6364ebcf94652d221ee9ffe8970540589c", "html_url": "https://github.com/rust-lang/rust/commit/3c000c6364ebcf94652d221ee9ffe8970540589c"}], "stats": {"total": 247, "additions": 233, "deletions": 14}, "files": [{"sha": "cdac4e41a9d893e515bdf462031270edbace718c", "filename": "crates/ide_completion/src/completions.rs", "status": "modified", "additions": 19, "deletions": 10, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/090e013161ab5b1679554ddd53683e81e3fe845a/crates%2Fide_completion%2Fsrc%2Fcompletions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/090e013161ab5b1679554ddd53683e81e3fe845a/crates%2Fide_completion%2Fsrc%2Fcompletions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions.rs?ref=090e013161ab5b1679554ddd53683e81e3fe845a", "patch": "@@ -2,25 +2,27 @@\n \n pub(crate) mod attribute;\n pub(crate) mod dot;\n-pub(crate) mod record;\n-pub(crate) mod pattern;\n+pub(crate) mod flyimport;\n pub(crate) mod fn_param;\n pub(crate) mod keyword;\n-pub(crate) mod snippet;\n-pub(crate) mod qualified_path;\n-pub(crate) mod unqualified_path;\n-pub(crate) mod postfix;\n+pub(crate) mod lifetime;\n pub(crate) mod macro_in_item_position;\n-pub(crate) mod trait_impl;\n pub(crate) mod mod_;\n-pub(crate) mod flyimport;\n+pub(crate) mod pattern;\n+pub(crate) mod postfix;\n+pub(crate) mod qualified_path;\n+pub(crate) mod record;\n+pub(crate) mod snippet;\n+pub(crate) mod trait_impl;\n+pub(crate) mod unqualified_path;\n \n use std::iter;\n \n use hir::{known, ModPath, ScopeDef, Type};\n+use ide_db::SymbolKind;\n \n use crate::{\n-    item::Builder,\n+    item::{Builder, CompletionKind},\n     render::{\n         const_::render_const,\n         enum_variant::render_variant,\n@@ -31,7 +33,7 @@ use crate::{\n         type_alias::render_type_alias,\n         RenderContext,\n     },\n-    CompletionContext, CompletionItem,\n+    CompletionContext, CompletionItem, CompletionItemKind,\n };\n \n /// Represents an in-progress set of completions being built.\n@@ -77,6 +79,13 @@ impl Completions {\n         self.add(item);\n     }\n \n+    pub(crate) fn add_static_lifetime(&mut self, ctx: &CompletionContext) {\n+        let mut item =\n+            CompletionItem::new(CompletionKind::Reference, ctx.source_range(), \"'static\");\n+        item.kind(CompletionItemKind::SymbolKind(SymbolKind::LifetimeParam));\n+        self.add(item.build());\n+    }\n+\n     pub(crate) fn add_resolution(\n         &mut self,\n         ctx: &CompletionContext,"}, {"sha": "74eb233602a89ab100f5aa86d278286ca4d1e955", "filename": "crates/ide_completion/src/completions/lifetime.rs", "status": "added", "additions": 181, "deletions": 0, "changes": 181, "blob_url": "https://github.com/rust-lang/rust/blob/090e013161ab5b1679554ddd53683e81e3fe845a/crates%2Fide_completion%2Fsrc%2Fcompletions%2Flifetime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/090e013161ab5b1679554ddd53683e81e3fe845a/crates%2Fide_completion%2Fsrc%2Fcompletions%2Flifetime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Flifetime.rs?ref=090e013161ab5b1679554ddd53683e81e3fe845a", "patch": "@@ -0,0 +1,181 @@\n+//! Completes lifetimes.\n+use hir::ScopeDef;\n+\n+use crate::{completions::Completions, context::CompletionContext};\n+\n+/// Completes lifetimes.\n+pub(crate) fn complete_lifetime(acc: &mut Completions, ctx: &CompletionContext) {\n+    if !ctx.lifetime_allowed {\n+        return;\n+    }\n+    let param_lifetime = match (\n+        &ctx.lifetime_syntax,\n+        ctx.lifetime_param_syntax.as_ref().and_then(|lp| lp.lifetime()),\n+    ) {\n+        (Some(lt), Some(lp)) if lp == lt.clone() => return,\n+        (Some(_), Some(lp)) => Some(lp.to_string()),\n+        _ => None,\n+    };\n+\n+    ctx.scope.process_all_names(&mut |name, res| {\n+        if let ScopeDef::GenericParam(hir::GenericParam::LifetimeParam(_)) = res {\n+            if param_lifetime != Some(name.to_string()) {\n+                acc.add_resolution(ctx, name.to_string(), &res);\n+            }\n+        }\n+    });\n+    if param_lifetime.is_none() {\n+        acc.add_static_lifetime(ctx);\n+    }\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use expect_test::{expect, Expect};\n+\n+    use crate::{\n+        test_utils::{check_edit, completion_list_with_config, TEST_CONFIG},\n+        CompletionConfig, CompletionKind,\n+    };\n+\n+    fn check(ra_fixture: &str, expect: Expect) {\n+        check_with_config(TEST_CONFIG, ra_fixture, expect);\n+    }\n+\n+    fn check_with_config(config: CompletionConfig, ra_fixture: &str, expect: Expect) {\n+        let actual = completion_list_with_config(config, ra_fixture, CompletionKind::Reference);\n+        expect.assert_eq(&actual)\n+    }\n+\n+    #[test]\n+    fn check_lifetime_edit() {\n+        check_edit(\n+            \"'lifetime\",\n+            r#\"\n+fn func<'lifetime>(foo: &'li$0) {}\n+\"#,\n+            r#\"\n+fn func<'lifetime>(foo: &'lifetime) {}\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn complete_lifetime_in_ref() {\n+        check(\n+            r#\"\n+fn foo<'lifetime>(foo: &'a$0 usize) {}\n+\"#,\n+            expect![[r#\"\n+                lt 'lifetime\n+                lt 'static\n+            \"#]],\n+        );\n+    }\n+\n+    #[test]\n+    fn complete_lifetime_in_ref_missing_ty() {\n+        check(\n+            r#\"\n+fn foo<'lifetime>(foo: &'a$0) {}\n+\"#,\n+            expect![[r#\"\n+                lt 'lifetime\n+                lt 'static\n+            \"#]],\n+        );\n+    }\n+    #[test]\n+    fn complete_lifetime_in_self_ref() {\n+        check(\n+            r#\"\n+struct Foo;\n+impl<'impl> Foo {\n+    fn foo<'func>(&'a$0 self) {}\n+}\n+\"#,\n+            expect![[r#\"\n+                lt 'func\n+                lt 'impl\n+                lt 'static\n+            \"#]],\n+        );\n+    }\n+\n+    #[test]\n+    fn complete_lifetime_in_arg_list() {\n+        check(\n+            r#\"\n+struct Foo<'lt>;\n+fn foo<'lifetime>(_: Foo<'a$0>) {}\n+\"#,\n+            expect![[r#\"\n+                lt 'lifetime\n+                lt 'static\n+            \"#]],\n+        );\n+    }\n+\n+    #[test]\n+    fn complete_lifetime_in_where_pred() {\n+        check(\n+            r#\"\n+fn foo2<'lifetime, T>() where 'a$0 {}\n+\"#,\n+            expect![[r#\"\n+                lt 'lifetime\n+                lt 'static\n+            \"#]],\n+        );\n+    }\n+\n+    #[test]\n+    fn complete_lifetime_in_ty_bound() {\n+        check(\n+            r#\"\n+fn foo2<'lifetime, T>() where T: 'a$0 {}\n+\"#,\n+            expect![[r#\"\n+                lt 'lifetime\n+                lt 'static\n+            \"#]],\n+        );\n+        check(\n+            r#\"\n+fn foo2<'lifetime, T>() where T: Trait<'a$0> {}\n+\"#,\n+            expect![[r#\"\n+                lt 'lifetime\n+                lt 'static\n+            \"#]],\n+        );\n+    }\n+\n+    #[test]\n+    fn dont_complete_lifetime_in_assoc_ty_bound() {\n+        check(\n+            r#\"\n+fn foo2<'lifetime, T>() where T: Trait<Item = 'a$0> {}\n+\"#,\n+            expect![[r#\"\"#]],\n+        );\n+    }\n+\n+    #[test]\n+    fn complete_lifetime_in_param_list() {\n+        check(\n+            r#\"\n+fn foo<'a$0>() {}\n+\"#,\n+            expect![[r#\"\"#]],\n+        );\n+        check(\n+            r#\"\n+fn foo<'footime, 'lifetime: 'a$0>() {}\n+\"#,\n+            expect![[r#\"\n+                lt 'footime\n+            \"#]],\n+        );\n+    }\n+}"}, {"sha": "b06498e6da4a90dd4aeb3255f4d2b240aa39d012", "filename": "crates/ide_completion/src/completions/pattern.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/090e013161ab5b1679554ddd53683e81e3fe845a/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fpattern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/090e013161ab5b1679554ddd53683e81e3fe845a/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fpattern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fpattern.rs?ref=090e013161ab5b1679554ddd53683e81e3fe845a", "patch": "@@ -1,4 +1,4 @@\n-//! Completes constats and paths in patterns.\n+//! Completes constants and paths in patterns.\n \n use crate::{CompletionContext, Completions};\n "}, {"sha": "4c2b31084d66fdb39dcd317edeac0ca84aa2fbae", "filename": "crates/ide_completion/src/context.rs", "status": "modified", "additions": 31, "deletions": 3, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/090e013161ab5b1679554ddd53683e81e3fe845a/crates%2Fide_completion%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/090e013161ab5b1679554ddd53683e81e3fe845a/crates%2Fide_completion%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcontext.rs?ref=090e013161ab5b1679554ddd53683e81e3fe845a", "patch": "@@ -41,12 +41,15 @@ pub(crate) struct CompletionContext<'a> {\n     pub(super) expected_name: Option<NameOrNameRef>,\n     pub(super) expected_type: Option<Type>,\n     pub(super) name_ref_syntax: Option<ast::NameRef>,\n+    pub(super) lifetime_syntax: Option<ast::Lifetime>,\n+    pub(super) lifetime_param_syntax: Option<ast::LifetimeParam>,\n     pub(super) function_syntax: Option<ast::Fn>,\n     pub(super) use_item_syntax: Option<ast::Use>,\n     pub(super) record_lit_syntax: Option<ast::RecordExpr>,\n     pub(super) record_pat_syntax: Option<ast::RecordPat>,\n     pub(super) record_field_syntax: Option<ast::RecordExprField>,\n     pub(super) impl_def: Option<ast::Impl>,\n+    pub(super) lifetime_allowed: bool,\n     /// FIXME: `ActiveParameter` is string-based, which is very very wrong\n     pub(super) active_parameter: Option<ActiveParameter>,\n     pub(super) is_param: bool,\n@@ -139,9 +142,12 @@ impl<'a> CompletionContext<'a> {\n             original_token,\n             token,\n             krate,\n+            lifetime_allowed: false,\n             expected_name: None,\n             expected_type: None,\n             name_ref_syntax: None,\n+            lifetime_syntax: None,\n+            lifetime_param_syntax: None,\n             function_syntax: None,\n             use_item_syntax: None,\n             record_lit_syntax: None,\n@@ -244,7 +250,7 @@ impl<'a> CompletionContext<'a> {\n     pub(crate) fn source_range(&self) -> TextRange {\n         // check kind of macro-expanded token, but use range of original token\n         let kind = self.token.kind();\n-        if kind == IDENT || kind == UNDERSCORE || kind.is_keyword() {\n+        if kind == IDENT || kind == LIFETIME_IDENT || kind == UNDERSCORE || kind.is_keyword() {\n             cov_mark::hit!(completes_if_prefix_is_keyword);\n             self.original_token.text_range()\n         } else {\n@@ -390,6 +396,11 @@ impl<'a> CompletionContext<'a> {\n         self.expected_name = expected_name;\n         self.attribute_under_caret = find_node_at_offset(&file_with_fake_ident, offset);\n \n+        if let Some(lifetime) = find_node_at_offset::<ast::Lifetime>(&file_with_fake_ident, offset)\n+        {\n+            self.classify_lifetime(original_file, lifetime, offset);\n+        }\n+\n         // First, let's try to complete a reference to some declaration.\n         if let Some(name_ref) = find_node_at_offset::<ast::NameRef>(&file_with_fake_ident, offset) {\n             // Special case, `trait T { fn foo(i_am_a_name_ref) {} }`.\n@@ -449,18 +460,35 @@ impl<'a> CompletionContext<'a> {\n         }\n     }\n \n+    fn classify_lifetime(\n+        &mut self,\n+        original_file: &SyntaxNode,\n+        lifetime: ast::Lifetime,\n+        offset: TextSize,\n+    ) {\n+        self.lifetime_syntax =\n+            find_node_at_offset(original_file, lifetime.syntax().text_range().start());\n+        if lifetime.syntax().parent().map_or(false, |p| p.kind() != syntax::SyntaxKind::ERROR) {\n+            self.lifetime_allowed = true;\n+        }\n+        if let Some(_) = lifetime.syntax().parent().and_then(ast::LifetimeParam::cast) {\n+            self.lifetime_param_syntax =\n+                self.sema.find_node_at_offset_with_macros(original_file, offset);\n+        }\n+    }\n+\n     fn classify_name_ref(\n         &mut self,\n         original_file: &SyntaxNode,\n         name_ref: ast::NameRef,\n         offset: TextSize,\n     ) {\n         self.name_ref_syntax =\n-            find_node_at_offset(&original_file, name_ref.syntax().text_range().start());\n+            find_node_at_offset(original_file, name_ref.syntax().text_range().start());\n         let name_range = name_ref.syntax().text_range();\n         if ast::RecordExprField::for_field_name(&name_ref).is_some() {\n             self.record_lit_syntax =\n-                self.sema.find_node_at_offset_with_macros(&original_file, offset);\n+                self.sema.find_node_at_offset_with_macros(original_file, offset);\n         }\n \n         self.fill_impl_def();"}, {"sha": "7a0eb6a96623298ec3a6658146971723ca9edfdd", "filename": "crates/ide_completion/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/090e013161ab5b1679554ddd53683e81e3fe845a/crates%2Fide_completion%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/090e013161ab5b1679554ddd53683e81e3fe845a/crates%2Fide_completion%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Flib.rs?ref=090e013161ab5b1679554ddd53683e81e3fe845a", "patch": "@@ -130,6 +130,7 @@ pub fn completions(\n     completions::trait_impl::complete_trait_impl(&mut acc, &ctx);\n     completions::mod_::complete_mod(&mut acc, &ctx);\n     completions::flyimport::import_on_the_fly(&mut acc, &ctx);\n+    completions::lifetime::complete_lifetime(&mut acc, &ctx);\n \n     Some(acc)\n }"}]}