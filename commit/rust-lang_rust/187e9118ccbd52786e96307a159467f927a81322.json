{"sha": "187e9118ccbd52786e96307a159467f927a81322", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE4N2U5MTE4Y2NiZDUyNzg2ZTk2MzA3YTE1OTQ2N2Y5MjdhODEzMjI=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2019-11-14T05:16:17Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-11-14T05:16:17Z"}, "message": "Rollup merge of #66264 - guanqun:fix-mbe-missing-close-delim, r=estebank\n\nfix an ICE in macro's diagnostic message\n\nThis has two small fixes:\n1. for the left brace, we don't need `<space>{`, simply `{` is enough.\n2. for the right brace, it tries to peel off one character even when the close delim is missing. Without this fix, it would crash in some cases. (as shown in the new test case)\n\nr? @estebank", "tree": {"sha": "e54043857d9c0d8415e65d8a8af0ff78025dfb7c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e54043857d9c0d8415e65d8a8af0ff78025dfb7c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/187e9118ccbd52786e96307a159467f927a81322", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdzOMiCRBK7hj4Ov3rIwAAdHIIAAor90g1T0WAz2XyZ/RjG+gF\n9+udeT4553Mkwo9xH65BTfYuQJ3wB6MvMdKZDl2XjvvzGY/LjAVh80XUR36jk1tn\ncErJCWA8HxA0D1UnVbex/ZYvX/Mf5Qcl3vNWMK33BKEaVB1taWv6rhU3WzGI15Yf\nYgJHJaH5KGMwto67nBF0+8xJ1YEMvBOcOKqhpykJF1hNfyEIrmG6J7ynJamz0gb0\nx8Fe044KxSZEUyCCzrfNXCAlilxG7K1Co0eVlqaCB2BgiRX3Hoo9P+Qnfuzxe1Wi\n1zUrE0KqNZHSiBrWirhCUZPw78v/2WXGHN7ZRd5EFOqYxFAVjwEaSHWotVseDoM=\n=LfFs\n-----END PGP SIGNATURE-----\n", "payload": "tree e54043857d9c0d8415e65d8a8af0ff78025dfb7c\nparent 79e2afc28c53bbda4b86ae824519430f0a7d7516\nparent 292ba98cb723fe2ab6ddcac9e4852be960deaaaa\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1573708577 +0900\ncommitter GitHub <noreply@github.com> 1573708577 +0900\n\nRollup merge of #66264 - guanqun:fix-mbe-missing-close-delim, r=estebank\n\nfix an ICE in macro's diagnostic message\n\nThis has two small fixes:\n1. for the left brace, we don't need `<space>{`, simply `{` is enough.\n2. for the right brace, it tries to peel off one character even when the close delim is missing. Without this fix, it would crash in some cases. (as shown in the new test case)\n\nr? @estebank\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/187e9118ccbd52786e96307a159467f927a81322", "html_url": "https://github.com/rust-lang/rust/commit/187e9118ccbd52786e96307a159467f927a81322", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/187e9118ccbd52786e96307a159467f927a81322/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "79e2afc28c53bbda4b86ae824519430f0a7d7516", "url": "https://api.github.com/repos/rust-lang/rust/commits/79e2afc28c53bbda4b86ae824519430f0a7d7516", "html_url": "https://github.com/rust-lang/rust/commit/79e2afc28c53bbda4b86ae824519430f0a7d7516"}, {"sha": "292ba98cb723fe2ab6ddcac9e4852be960deaaaa", "url": "https://api.github.com/repos/rust-lang/rust/commits/292ba98cb723fe2ab6ddcac9e4852be960deaaaa", "html_url": "https://github.com/rust-lang/rust/commit/292ba98cb723fe2ab6ddcac9e4852be960deaaaa"}], "stats": {"total": 55, "additions": 50, "deletions": 5}, "files": [{"sha": "1f386b8bbbf547da4273958dbc37ae224db30ea4", "filename": "src/librustc_parse/parser/item.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/187e9118ccbd52786e96307a159467f927a81322/src%2Flibrustc_parse%2Fparser%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/187e9118ccbd52786e96307a159467f927a81322/src%2Flibrustc_parse%2Fparser%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_parse%2Fparser%2Fitem.rs?ref=187e9118ccbd52786e96307a159467f927a81322", "patch": "@@ -1742,14 +1742,25 @@ impl<'a> Parser<'a> {\n     }\n \n     fn report_invalid_macro_expansion_item(&self) {\n+        let has_close_delim = self.sess.source_map()\n+            .span_to_snippet(self.prev_span)\n+            .map(|s| s.ends_with(\")\") || s.ends_with(\"]\"))\n+            .unwrap_or(false);\n+        let right_brace_span = if has_close_delim {\n+            // it's safe to peel off one character only when it has the close delim\n+            self.prev_span.with_lo(self.prev_span.hi() - BytePos(1))\n+        } else {\n+            self.sess.source_map().next_point(self.prev_span)\n+        };\n+\n         self.struct_span_err(\n             self.prev_span,\n             \"macros that expand to items must be delimited with braces or followed by a semicolon\",\n         ).multipart_suggestion(\n             \"change the delimiters to curly braces\",\n             vec![\n-                (self.prev_span.with_hi(self.prev_span.lo() + BytePos(1)), String::from(\" {\")),\n-                (self.prev_span.with_lo(self.prev_span.hi() - BytePos(1)), '}'.to_string()),\n+                (self.prev_span.with_hi(self.prev_span.lo() + BytePos(1)), \"{\".to_string()),\n+                (right_brace_span, '}'.to_string()),\n             ],\n             Applicability::MaybeIncorrect,\n         ).span_suggestion("}, {"sha": "f9019b78c8d3862e86de88406cf41688cec117d7", "filename": "src/test/ui/parser/macros-no-semicolon-items.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/187e9118ccbd52786e96307a159467f927a81322/src%2Ftest%2Fui%2Fparser%2Fmacros-no-semicolon-items.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/187e9118ccbd52786e96307a159467f927a81322/src%2Ftest%2Fui%2Fparser%2Fmacros-no-semicolon-items.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fmacros-no-semicolon-items.stderr?ref=187e9118ccbd52786e96307a159467f927a81322", "patch": "@@ -6,8 +6,8 @@ LL | macro_rules! foo()\n    |\n help: change the delimiters to curly braces\n    |\n-LL | macro_rules! foo {}\n-   |                  ^^\n+LL | macro_rules! foo{}\n+   |                 ^^\n help: add a semicolon\n    |\n LL | macro_rules! foo();\n@@ -26,7 +26,7 @@ LL | | )\n    |\n help: change the delimiters to curly braces\n    |\n-LL | bar! {\n+LL | bar!{\n LL |     blah\n LL |     blah\n LL |     blah"}, {"sha": "689176b3eb75b76489f665a2b5a47d6b685ab046", "filename": "src/test/ui/parser/mbe_missing_right_paren.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/187e9118ccbd52786e96307a159467f927a81322/src%2Ftest%2Fui%2Fparser%2Fmbe_missing_right_paren.rs", "raw_url": "https://github.com/rust-lang/rust/raw/187e9118ccbd52786e96307a159467f927a81322/src%2Ftest%2Fui%2Fparser%2Fmbe_missing_right_paren.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fmbe_missing_right_paren.rs?ref=187e9118ccbd52786e96307a159467f927a81322", "patch": "@@ -0,0 +1,3 @@\n+// ignore-tidy-trailing-newlines\n+// error-pattern: aborting due to 3 previous errors\n+macro_rules! abc(\u063c\n\\ No newline at end of file"}, {"sha": "4504fc0eb0004843cfd0f7a830b3dbb0225abcec", "filename": "src/test/ui/parser/mbe_missing_right_paren.stderr", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/187e9118ccbd52786e96307a159467f927a81322/src%2Ftest%2Fui%2Fparser%2Fmbe_missing_right_paren.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/187e9118ccbd52786e96307a159467f927a81322/src%2Ftest%2Fui%2Fparser%2Fmbe_missing_right_paren.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fmbe_missing_right_paren.stderr?ref=187e9118ccbd52786e96307a159467f927a81322", "patch": "@@ -0,0 +1,31 @@\n+error: this file contains an un-closed delimiter\n+  --> $DIR/mbe_missing_right_paren.rs:3:19\n+   |\n+LL | macro_rules! abc(\u063c\n+   |                 - ^\n+   |                 |\n+   |                 un-closed delimiter\n+\n+error: macros that expand to items must be delimited with braces or followed by a semicolon\n+  --> $DIR/mbe_missing_right_paren.rs:3:17\n+   |\n+LL | macro_rules! abc(\u063c\n+   |                 ^^\n+   |\n+help: change the delimiters to curly braces\n+   |\n+LL | macro_rules! abc{\u063c}\n+   |                 ^ ^\n+help: add a semicolon\n+   |\n+LL | macro_rules! abc(\u063c;\n+   |                   ^\n+\n+error: unexpected end of macro invocation\n+  --> $DIR/mbe_missing_right_paren.rs:3:1\n+   |\n+LL | macro_rules! abc(\u063c\n+   | ^^^^^^^^^^^^^^^^^^ missing tokens in macro arguments\n+\n+error: aborting due to 3 previous errors\n+"}]}