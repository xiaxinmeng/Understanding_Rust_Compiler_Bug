{"sha": "84434bc0844545e9c3fb392126f3e80913028b9e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg0NDM0YmMwODQ0NTQ1ZTljM2ZiMzkyMTI2ZjNlODA5MTMwMjhiOWU=", "commit": {"author": {"name": "Eric Holk", "email": "eric.holk@gmail.com", "date": "2012-07-05T23:46:32Z"}, "committer": {"name": "Eric Holk", "email": "eric.holk@gmail.com", "date": "2012-07-06T17:42:40Z"}, "message": "Recursively expand items, and keep expansion stack, per Paul's code review comments.", "tree": {"sha": "4b0944452e6567cdb9d4c745fa1aa41a65010595", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4b0944452e6567cdb9d4c745fa1aa41a65010595"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/84434bc0844545e9c3fb392126f3e80913028b9e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/84434bc0844545e9c3fb392126f3e80913028b9e", "html_url": "https://github.com/rust-lang/rust/commit/84434bc0844545e9c3fb392126f3e80913028b9e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/84434bc0844545e9c3fb392126f3e80913028b9e/comments", "author": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d09bcc0131935e2ad403aa965e9be06ddcf01c08", "url": "https://api.github.com/repos/rust-lang/rust/commits/d09bcc0131935e2ad403aa965e9be06ddcf01c08", "html_url": "https://github.com/rust-lang/rust/commit/d09bcc0131935e2ad403aa965e9be06ddcf01c08"}], "stats": {"total": 13, "additions": 10, "deletions": 3}, "files": [{"sha": "4ac7dc19c00071eb046c610af454eb899f47ecda", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/84434bc0844545e9c3fb392126f3e80913028b9e/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84434bc0844545e9c3fb392126f3e80913028b9e/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=84434bc0844545e9c3fb392126f3e80913028b9e", "patch": "@@ -139,7 +139,7 @@ fn expand_item(exts: hashmap<str, syntax_extension>,\n     };\n     let it = alt it.node {\n       ast::item_mac(*) {\n-        expand_item_mac(exts, cx, it)\n+        expand_item_mac(exts, cx, it, fld)\n       }\n       _ { it }\n     };\n@@ -150,7 +150,8 @@ fn expand_item(exts: hashmap<str, syntax_extension>,\n }\n \n fn expand_item_mac(exts: hashmap<str, syntax_extension>,\n-                   cx: ext_ctxt, &&it: @ast::item) -> @ast::item {\n+                   cx: ext_ctxt, &&it: @ast::item,\n+                   fld: ast_fold) -> @ast::item {\n     alt it.node {\n       item_mac({node: mac_invoc_tt(pth, tt), span}) {\n         let extname = pth.idents[0];\n@@ -160,7 +161,13 @@ fn expand_item_mac(exts: hashmap<str, syntax_extension>,\n                           #fmt(\"macro undefined: '%s'\", *extname))\n           }\n           some(item_tt(expand)) {\n-            expand.expander(cx, it.span, it.ident, tt)\n+            cx.bt_push(expanded_from({call_site: it.span,\n+                                      callie: {name: *extname,\n+                                               span: expand.span}}));\n+            let it = fld.fold_item(\n+                expand.expander(cx, it.span, it.ident, tt));\n+            cx.bt_pop();\n+            ret it\n           }\n           _ { cx.span_fatal(it.span,\n                             #fmt(\"%s is not a legal here\", *extname)) }"}]}