{"sha": "9c4c52fd77ca7eb92476022811c726749bece0b0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjljNGM1MmZkNzdjYTdlYjkyNDc2MDIyODExYzcyNjc0OWJlY2UwYjA=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-05-11T20:20:55Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-05-11T20:20:55Z"}, "message": "Rollup merge of #72027 - Mark-Simulacrum:ci-caches, r=pietroalbini\n\nUse CDN for ci-caches on download\n\nThis will reduce costs, as well as lays the groundwork for developers to be able\nto locally pull the published docker images without needing AWS credentials.\n\nr? @pietroalbini", "tree": {"sha": "3d881b4e07395d2f5b37e9b228375d920678fd72", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3d881b4e07395d2f5b37e9b228375d920678fd72"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9c4c52fd77ca7eb92476022811c726749bece0b0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeubOoCRBK7hj4Ov3rIwAAdHIIAAWvoyMWE1Q9yUe5f8YyCO6o\nMZE+btZZmJ8s1TQvm0EyBI+czucNbz1J4oY59TfHKymUPFzTAQdTt1RfEEfX/hl/\nJDV0RYpGHlAYnYr5kBtA1boYRHxVN4DzNB92TGjG/uwA+zCzY+gd6jf1MpFRhbH7\nTwULTLOq1kEDg5RcO3XCDu3h7tttpZmR6l9lg5zLkYgRK98TFrn3WvgYpNSgseE5\nEa4MuX8HPcmOX46Q35lyJYjXbqZ17HVRBh3dtCBq/ECUhM2+tVbMVmqpw+Fycvwx\ny5FcF5AR/q1xgKKa9AFzCnMWKM+J1dPgx5s8GyERdM8YzZGcinUc4M2N5pAGQlY=\n=ZVa8\n-----END PGP SIGNATURE-----\n", "payload": "tree 3d881b4e07395d2f5b37e9b228375d920678fd72\nparent 705671ef4986f47044ad45babc77ce822d2c04d6\nparent 9a4e7183d4a6c31b32beca1a82095480ea32e359\nauthor Dylan DPC <dylan.dpc@gmail.com> 1589228455 +0200\ncommitter GitHub <noreply@github.com> 1589228455 +0200\n\nRollup merge of #72027 - Mark-Simulacrum:ci-caches, r=pietroalbini\n\nUse CDN for ci-caches on download\n\nThis will reduce costs, as well as lays the groundwork for developers to be able\nto locally pull the published docker images without needing AWS credentials.\n\nr? @pietroalbini\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9c4c52fd77ca7eb92476022811c726749bece0b0", "html_url": "https://github.com/rust-lang/rust/commit/9c4c52fd77ca7eb92476022811c726749bece0b0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9c4c52fd77ca7eb92476022811c726749bece0b0/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "705671ef4986f47044ad45babc77ce822d2c04d6", "url": "https://api.github.com/repos/rust-lang/rust/commits/705671ef4986f47044ad45babc77ce822d2c04d6", "html_url": "https://github.com/rust-lang/rust/commit/705671ef4986f47044ad45babc77ce822d2c04d6"}, {"sha": "9a4e7183d4a6c31b32beca1a82095480ea32e359", "url": "https://api.github.com/repos/rust-lang/rust/commits/9a4e7183d4a6c31b32beca1a82095480ea32e359", "html_url": "https://github.com/rust-lang/rust/commit/9a4e7183d4a6c31b32beca1a82095480ea32e359"}], "stats": {"total": 16, "additions": 12, "deletions": 4}, "files": [{"sha": "291dbf603612a71441121ec13d1e601b06242158", "filename": ".github/workflows/ci.yml", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9c4c52fd77ca7eb92476022811c726749bece0b0/.github%2Fworkflows%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/9c4c52fd77ca7eb92476022811c726749bece0b0/.github%2Fworkflows%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yml?ref=9c4c52fd77ca7eb92476022811c726749bece0b0", "patch": "@@ -34,6 +34,7 @@ jobs:\n       CI_JOB_NAME: \"${{ matrix.name }}\"\n       SCCACHE_BUCKET: rust-lang-gha-caches\n       TOOLSTATE_REPO: \"https://github.com/pietroalbini/rust-toolstate\"\n+      CACHE_DOMAIN: ci-caches-gha.rust-lang.org\n     if: \"github.event_name == 'pull_request'\"\n     strategy:\n       matrix:\n@@ -146,6 +147,7 @@ jobs:\n       TOOLSTATE_PUBLISH: 1\n       CACHES_AWS_ACCESS_KEY_ID: AKIA46X5W6CZOMUQATD5\n       ARTIFACTS_AWS_ACCESS_KEY_ID: AKIA46X5W6CZH5AYXDVF\n+      CACHE_DOMAIN: ci-caches-gha.rust-lang.org\n     if: \"github.event_name == 'push' && github.ref == 'refs/heads/try' && github.repository == 'rust-lang-ci/rust'\"\n     strategy:\n       matrix:\n@@ -255,6 +257,7 @@ jobs:\n       TOOLSTATE_PUBLISH: 1\n       CACHES_AWS_ACCESS_KEY_ID: AKIA46X5W6CZOMUQATD5\n       ARTIFACTS_AWS_ACCESS_KEY_ID: AKIA46X5W6CZH5AYXDVF\n+      CACHE_DOMAIN: ci-caches-gha.rust-lang.org\n     if: \"github.event_name == 'push' && github.ref == 'refs/heads/auto' && github.repository == 'rust-lang-ci/rust'\"\n     strategy:\n       matrix:\n@@ -606,6 +609,7 @@ jobs:\n       TOOLSTATE_PUBLISH: 1\n       CACHES_AWS_ACCESS_KEY_ID: AKIA46X5W6CZOMUQATD5\n       ARTIFACTS_AWS_ACCESS_KEY_ID: AKIA46X5W6CZH5AYXDVF\n+      CACHE_DOMAIN: ci-caches-gha.rust-lang.org\n     if: \"github.event_name == 'push' && github.ref == 'refs/heads/master' && github.repository == 'rust-lang-ci/rust'\"\n     steps:\n       - name: checkout the source code"}, {"sha": "d891ad1b6680e622323b7bbd21632d21a3e81fb2", "filename": "src/ci/docker/run.sh", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/9c4c52fd77ca7eb92476022811c726749bece0b0/src%2Fci%2Fdocker%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/9c4c52fd77ca7eb92476022811c726749bece0b0/src%2Fci%2Fdocker%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Frun.sh?ref=9c4c52fd77ca7eb92476022811c726749bece0b0", "patch": "@@ -17,6 +17,8 @@ dist=$objdir/build/dist\n \n source \"$ci_dir/shared.sh\"\n \n+CACHE_DOMAIN=\"${CACHE_DOMAIN:-ci-caches.rust-lang.org}\"\n+\n if [ -f \"$docker_dir/$image/Dockerfile\" ]; then\n     if [ \"$CI\" != \"\" ]; then\n       hash_key=/tmp/.docker-hash-key.txt\n@@ -38,9 +40,7 @@ if [ -f \"$docker_dir/$image/Dockerfile\" ]; then\n       cksum=$(sha512sum $hash_key | \\\n         awk '{print $1}')\n \n-      s3url=\"s3://$SCCACHE_BUCKET/docker/$cksum\"\n-      url=\"https://$SCCACHE_BUCKET.s3.amazonaws.com/docker/$cksum\"\n-      upload=\"aws s3 cp - $s3url\"\n+      url=\"https://$CACHE_DOMAIN/docker/$cksum\"\n \n       echo \"Attempting to download $url\"\n       rm -f /tmp/rustci_docker_cache\n@@ -65,7 +65,9 @@ if [ -f \"$docker_dir/$image/Dockerfile\" ]; then\n       -f \"$dockerfile\" \\\n       \"$context\"\n \n-    if [ \"$upload\" != \"\" ]; then\n+    if [ \"$CI\" != \"\" ]; then\n+      s3url=\"s3://$SCCACHE_BUCKET/docker/$cksum\"\n+      upload=\"aws s3 cp - $s3url\"\n       digest=$(docker inspect rust-ci --format '{{.Id}}')\n       echo \"Built container $digest\"\n       if ! grep -q \"$digest\" <(echo \"$loaded_images\"); then"}, {"sha": "1c120f8163459579e0fcfdf4c8fa33df9c748976", "filename": "src/ci/github-actions/ci.yml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9c4c52fd77ca7eb92476022811c726749bece0b0/src%2Fci%2Fgithub-actions%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/9c4c52fd77ca7eb92476022811c726749bece0b0/src%2Fci%2Fgithub-actions%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fgithub-actions%2Fci.yml?ref=9c4c52fd77ca7eb92476022811c726749bece0b0", "patch": "@@ -37,6 +37,7 @@ x--expand-yaml-anchors--remove:\n   - &public-variables\n     SCCACHE_BUCKET: rust-lang-gha-caches\n     TOOLSTATE_REPO: https://github.com/pietroalbini/rust-toolstate\n+    CACHE_DOMAIN: ci-caches-gha.rust-lang.org\n \n   - &prod-variables\n     SCCACHE_BUCKET: rust-lang-gha-caches\n@@ -51,6 +52,7 @@ x--expand-yaml-anchors--remove:\n     # (caches, artifacts...).\n     CACHES_AWS_ACCESS_KEY_ID: AKIA46X5W6CZOMUQATD5\n     ARTIFACTS_AWS_ACCESS_KEY_ID: AKIA46X5W6CZH5AYXDVF\n+    CACHE_DOMAIN: ci-caches-gha.rust-lang.org\n \n   - &base-job\n     env: {}"}]}