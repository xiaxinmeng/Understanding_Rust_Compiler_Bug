{"sha": "baf68d3a3756b040aae2028f8d5a7a0a239458ef", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJhZjY4ZDNhMzc1NmIwNDBhYWUyMDI4ZjhkNWE3YTBhMjM5NDU4ZWY=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2017-12-10T20:36:42Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2017-12-11T20:41:27Z"}, "message": "Fixed case where borrowed value lives until after scope", "tree": {"sha": "aed63fb9c75e0ff854c76dad22701c2bff6da3da", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/aed63fb9c75e0ff854c76dad22701c2bff6da3da"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/baf68d3a3756b040aae2028f8d5a7a0a239458ef", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIcBAABCgAGBQJaLu13AAoJEAF2C0+fU/FUNvgP/iOsOgERXfasS3jTJyON1h19\nM/lq9iaf1Pp5/MdCsmiNfYeNX1xFBmEuAj4Y7592gkRlIZGpYzJYnko+AK5S00pN\nEBY/syyLVYFbx5cyQ5uaNhDfdRnj+2ASzlUb1JiOUt2uTpJAKkvNXQNMdH9Oc+IQ\nqyCWjVdWdumuNRyWhYGLbdwUWXfgxdOSy4I8p0H6cb4+zNdRJWPmPjQpcjt9f8px\nIkayG/egb8tJRSDtchJ8ZNPE++U9JbRsqEARCfRc2TrKoT2mSvxAZfuJX6F5brmK\n8AFE5JcT2nB+IrDQHgayTM0wo+AaD/r693GKR9ARXZyORRkR3gj64RAD2qY50gWX\nrKEgpy7BEe3cK6qYGStnV5aTVhRtf6yqH6DexgMZtz6LjwYWapU6I0NHrtI6svRl\nHJutHKqNRcLhPkhwr4MpbPHkr5VUia7CKraltrwJMa21wg8MLhLsv/Nmq702kDLI\nDxZlwqzSXr7cRwRggwmi9Ok9A7kyw4Xs072oqvvu4PQxzU/eDx85jtV6e09TTyTt\noZUIyK6HlXJonDJp70ml8DWItIbWvBQ00YQGqqKaSFf1CPWsloYysRMoFh/AxNel\nBpom+HTNiK+m5ZyUIEm8WMQeGUQePPKhPj6EDw0+wfoqu4cRw/ifxvT+qdHPXwa4\nueoYzWWR02s3E23GVYFl\n=4ppk\n-----END PGP SIGNATURE-----", "payload": "tree aed63fb9c75e0ff854c76dad22701c2bff6da3da\nparent 52442d4d8a04f24735f9de120579ba3d997b811b\nauthor David Wood <david@davidtw.co> 1512938202 +0000\ncommitter David Wood <david@davidtw.co> 1513024887 +0000\n\nFixed case where borrowed value lives until after scope\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/baf68d3a3756b040aae2028f8d5a7a0a239458ef", "html_url": "https://github.com/rust-lang/rust/commit/baf68d3a3756b040aae2028f8d5a7a0a239458ef", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/baf68d3a3756b040aae2028f8d5a7a0a239458ef/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "52442d4d8a04f24735f9de120579ba3d997b811b", "url": "https://api.github.com/repos/rust-lang/rust/commits/52442d4d8a04f24735f9de120579ba3d997b811b", "html_url": "https://github.com/rust-lang/rust/commit/52442d4d8a04f24735f9de120579ba3d997b811b"}], "stats": {"total": 77, "additions": 69, "deletions": 8}, "files": [{"sha": "a8feaa9ca94408674d91299837e026c841d55948", "filename": "src/librustc_mir/borrow_check/error_reporting.rs", "status": "modified", "additions": 24, "deletions": 8, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/baf68d3a3756b040aae2028f8d5a7a0a239458ef/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/baf68d3a3756b040aae2028f8d5a7a0a239458ef/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs?ref=baf68d3a3756b040aae2028f8d5a7a0a239458ef", "patch": "@@ -356,14 +356,30 @@ impl<'cx, 'gcx, 'tcx> MirBorrowckCtxt<'cx, 'gcx, 'tcx> {\n \n         match &self.describe_place(&borrow.place) {\n             Some(description) => {\n-                let mut err = self.tcx.path_does_not_live_long_enough(\n-                    borrow_span, &format!(\"`{}`\", description), Origin::Mir);\n-                err.span_label(borrow_span, \"does not live long enough\");\n-                err.span_label(drop_span, \"borrowed value only lives until here\");\n-                self.tcx.note_and_explain_region(scope_tree, &mut err,\n-                                                 \"borrowed value must be valid for \",\n-                                                 borrow.region, \"...\");\n-                err.emit();\n+                match borrow.region {\n+                    RegionKind::ReScope(_) => {\n+                        let mut err = self.tcx.path_does_not_live_long_enough(\n+                            drop_span, &format!(\"`{}`\", description), Origin::Mir);\n+                        err.span_label(borrow_span, \"borrow occurs here\");\n+                        err.span_label(drop_span,\n+                                       format!(\"`{}` dropped here while still borrowed\",\n+                                               description));\n+                        if let Some(end) = end_span {\n+                            err.span_label(end, \"borrowed value needs to live until here\");\n+                        }\n+                        err.emit();\n+                    },\n+                    _ => {\n+                        let mut err = self.tcx.path_does_not_live_long_enough(\n+                            borrow_span, &format!(\"`{}`\", description), Origin::Mir);\n+                        err.span_label(borrow_span, \"does not live long enough\");\n+                        err.span_label(drop_span, \"borrowed value only lives until here\");\n+                        self.tcx.note_and_explain_region(scope_tree, &mut err,\n+                                                         \"borrowed value must be valid for \",\n+                                                         borrow.region, \"...\");\n+                        err.emit();\n+                    }\n+                }\n             },\n             None => {\n                 match borrow.region {"}, {"sha": "977ea785fe6d33c5be337107bb027c0bcb3033dd", "filename": "src/test/ui/issue-46471-1.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/baf68d3a3756b040aae2028f8d5a7a0a239458ef/src%2Ftest%2Fui%2Fissue-46471-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/baf68d3a3756b040aae2028f8d5a7a0a239458ef/src%2Ftest%2Fui%2Fissue-46471-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-46471-1.rs?ref=baf68d3a3756b040aae2028f8d5a7a0a239458ef", "patch": "@@ -0,0 +1,21 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags: -Z emit-end-regions -Z borrowck=compare\n+\n+fn main() {\n+    let y = {\n+        let mut z = 0;\n+        &mut z\n+    };\n+    //~^ ERROR `z` does not live long enough (Ast) [E0597]\n+    //~| ERROR `z` does not live long enough (Mir) [E0597]\n+    println!(\"{}\", y);\n+}"}, {"sha": "c33b9a7ba7b51d37406776368f28664855f83eae", "filename": "src/test/ui/issue-46471-1.stderr", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/baf68d3a3756b040aae2028f8d5a7a0a239458ef/src%2Ftest%2Fui%2Fissue-46471-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/baf68d3a3756b040aae2028f8d5a7a0a239458ef/src%2Ftest%2Fui%2Fissue-46471-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-46471-1.stderr?ref=baf68d3a3756b040aae2028f8d5a7a0a239458ef", "patch": "@@ -0,0 +1,24 @@\n+error[E0597]: `z` does not live long enough (Ast)\n+  --> $DIR/issue-46471-1.rs:17:5\n+   |\n+16 |         &mut z\n+   |              - borrow occurs here\n+17 |     };\n+   |     ^ `z` dropped here while still borrowed\n+...\n+21 | }\n+   | - borrowed value needs to live until here\n+\n+error[E0597]: `z` does not live long enough (Mir)\n+  --> $DIR/issue-46471-1.rs:17:6\n+   |\n+16 |         &mut z\n+   |         ------ borrow occurs here\n+17 |     };\n+   |      ^ `z` dropped here while still borrowed\n+...\n+21 | }\n+   | - borrowed value needs to live until here\n+\n+error: aborting due to 2 previous errors\n+"}]}