{"sha": "961cae7e53a05625f3e010076673ca083479b481", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk2MWNhZTdlNTNhMDU2MjVmM2UwMTAwNzY2NzNjYTA4MzQ3OWI0ODE=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-12-08T22:02:53Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-12-09T10:33:16Z"}, "message": "thread info about dep names", "tree": {"sha": "653672f36816ff6eb2bf098a06e48e7d3adbee56", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/653672f36816ff6eb2bf098a06e48e7d3adbee56"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/961cae7e53a05625f3e010076673ca083479b481", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/961cae7e53a05625f3e010076673ca083479b481", "html_url": "https://github.com/rust-lang/rust/commit/961cae7e53a05625f3e010076673ca083479b481", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/961cae7e53a05625f3e010076673ca083479b481/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ca7e5905c1daffbed6a08fe674ae821f99bd274d", "url": "https://api.github.com/repos/rust-lang/rust/commits/ca7e5905c1daffbed6a08fe674ae821f99bd274d", "html_url": "https://github.com/rust-lang/rust/commit/ca7e5905c1daffbed6a08fe674ae821f99bd274d"}], "stats": {"total": 36, "additions": 24, "deletions": 12}, "files": [{"sha": "44c5bac9328fabb5acb2daffa7db671e90df59b6", "filename": "crates/ra_db/src/input.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/961cae7e53a05625f3e010076673ca083479b481/crates%2Fra_db%2Fsrc%2Finput.rs", "raw_url": "https://github.com/rust-lang/rust/raw/961cae7e53a05625f3e010076673ca083479b481/crates%2Fra_db%2Fsrc%2Finput.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_db%2Fsrc%2Finput.rs?ref=961cae7e53a05625f3e010076673ca083479b481", "patch": "@@ -1,7 +1,7 @@\n use std::sync::Arc;\n \n-use rustc_hash::FxHashMap;\n-use rustc_hash::FxHashSet;\n+use rustc_hash::{FxHashSet, FxHashMap};\n+use ra_syntax::SmolStr;\n use salsa;\n \n use crate::file_resolver::FileResolverImp;\n@@ -31,14 +31,15 @@ impl CrateData {\n         }\n     }\n \n-    fn add_dep(&mut self, dep: CrateId) {\n-        self.dependencies.push(Dependency { crate_id: dep })\n+    fn add_dep(&mut self, name: SmolStr, crate_id: CrateId) {\n+        self.dependencies.push(Dependency { name, crate_id })\n     }\n }\n \n #[derive(Debug, Clone, PartialEq, Eq)]\n pub struct Dependency {\n     crate_id: CrateId,\n+    name: SmolStr,\n }\n \n impl Dependency {\n@@ -57,8 +58,8 @@ impl CrateGraph {\n     //FIXME: check that we don't have cycles here.\n     // Just a simple depth first search from `to` should work,\n     // the graph is small.\n-    pub fn add_dep(&mut self, from: CrateId, to: CrateId) {\n-        self.arena.get_mut(&from).unwrap().add_dep(to)\n+    pub fn add_dep(&mut self, from: CrateId, name: SmolStr, to: CrateId) {\n+        self.arena.get_mut(&from).unwrap().add_dep(name, to)\n     }\n     pub fn crate_root(&self, crate_id: CrateId) -> FileId {\n         self.arena[&crate_id].file_id"}, {"sha": "cb91ada90ac6257ef7fba617701f8f85101236fd", "filename": "crates/ra_lsp_server/src/project_model.rs", "status": "modified", "additions": 15, "deletions": 4, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/961cae7e53a05625f3e010076673ca083479b481/crates%2Fra_lsp_server%2Fsrc%2Fproject_model.rs", "raw_url": "https://github.com/rust-lang/rust/raw/961cae7e53a05625f3e010076673ca083479b481/crates%2Fra_lsp_server%2Fsrc%2Fproject_model.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fproject_model.rs?ref=961cae7e53a05625f3e010076673ca083479b481", "patch": "@@ -34,7 +34,13 @@ struct PackageData {\n     manifest: PathBuf,\n     targets: Vec<Target>,\n     is_member: bool,\n-    dependencies: Vec<Package>,\n+    dependencies: Vec<PackageDependency>,\n+}\n+\n+#[derive(Debug, Clone)]\n+pub struct PackageDependency {\n+    pub pkg: Package,\n+    pub name: SmolStr,\n }\n \n #[derive(Debug, Clone)]\n@@ -68,8 +74,11 @@ impl Package {\n     pub fn is_member(self, ws: &CargoWorkspace) -> bool {\n         ws.pkg(self).is_member\n     }\n-    pub fn dependencies<'a>(self, ws: &'a CargoWorkspace) -> impl Iterator<Item = Package> + 'a {\n-        ws.pkg(self).dependencies.iter().cloned()\n+    pub fn dependencies<'a>(\n+        self,\n+        ws: &'a CargoWorkspace,\n+    ) -> impl Iterator<Item = &'a PackageDependency> + 'a {\n+        ws.pkg(self).dependencies.iter()\n     }\n }\n \n@@ -135,7 +144,9 @@ impl CargoWorkspace {\n             let source = pkg_by_id[&node.id];\n             for id in node.dependencies {\n                 let target = pkg_by_id[&id];\n-                packages[source.0].dependencies.push(target);\n+                let name: SmolStr = packages[target.0].name.replace('-', \"_\").into();\n+                let dep = PackageDependency { name, pkg: target };\n+                packages[source.0].dependencies.push(dep);\n             }\n         }\n "}, {"sha": "ab4c2c8aad639f2b44c7ef2801e8c472fd76cc73", "filename": "crates/ra_lsp_server/src/server_world.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/961cae7e53a05625f3e010076673ca083479b481/crates%2Fra_lsp_server%2Fsrc%2Fserver_world.rs", "raw_url": "https://github.com/rust-lang/rust/raw/961cae7e53a05625f3e010076673ca083479b481/crates%2Fra_lsp_server%2Fsrc%2Fserver_world.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fserver_world.rs?ref=961cae7e53a05625f3e010076673ca083479b481", "patch": "@@ -162,9 +162,9 @@ impl ServerWorldState {\n             }\n             for pkg in ws.packages() {\n                 for dep in pkg.dependencies(ws) {\n-                    if let Some(&to) = pkg_to_lib_crate.get(&dep) {\n+                    if let Some(&to) = pkg_to_lib_crate.get(&dep.pkg) {\n                         for &from in pkg_crates.get(&pkg).into_iter().flatten() {\n-                            crate_graph.add_dep(from, to);\n+                            crate_graph.add_dep(from, dep.name.clone(), to);\n                         }\n                     }\n                 }"}]}