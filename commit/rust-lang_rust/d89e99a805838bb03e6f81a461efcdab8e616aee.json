{"sha": "d89e99a805838bb03e6f81a461efcdab8e616aee", "node_id": "C_kwDOAAsO6NoAKGQ4OWU5OWE4MDU4MzhiYjAzZTZmODFhNDYxZWZjZGFiOGU2MTZhZWU", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-07-26T04:12:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-26T04:12:20Z"}, "message": "Rollup merge of #99593 - TaKO8Ki:suggest-removing-tuple-struct-field, r=compiler-errors\n\nSuggest removing the tuple struct field for the unwrapped value\n\nfixes #99416", "tree": {"sha": "8ee6295ea78064272dc4d9579534fff4c04e8f11", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8ee6295ea78064272dc4d9579534fff4c04e8f11"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d89e99a805838bb03e6f81a461efcdab8e616aee", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi32mkCRBK7hj4Ov3rIwAATU4IAHjkdmqqZ0J9QZkfmKk/U7IU\ncZoTInukde4OQ6KH9fQObIZezgXSIGEBKr1W2dEo9YRjZw7ikIShAAZLAC02EtCx\ncZuQvjhuH3ao99YLFpLEPS10PSv9p//ZOVLKH8wMB9pxBAXBLJLoSL6f65khdEYE\nkSJ+IHl+4TmTHqa46wYOSP34nnvM2E8kdiJiAQ+JwRu5QCQNWaIn0zx+lL11q7OT\n5Ixx+YlEvK9Oux2ZETVk2kYDHpW5NS2/j7GpOiU0YwFhFuRK3qTDr6IzX8ZjYkfq\nFFopKB7TcBygf1c68x8TTe9ITpmmvtwvx+ycH8LYrelV0QPnWULegvMnESiHZnI=\n=PKFk\n-----END PGP SIGNATURE-----\n", "payload": "tree 8ee6295ea78064272dc4d9579534fff4c04e8f11\nparent 29444545405471a106c67adf48593c5943b6f483\nparent f85f37583d91152b967cd0d1bd7253b339a26d42\nauthor Yuki Okushi <jtitor@2k36.org> 1658808740 +0900\ncommitter GitHub <noreply@github.com> 1658808740 +0900\n\nRollup merge of #99593 - TaKO8Ki:suggest-removing-tuple-struct-field, r=compiler-errors\n\nSuggest removing the tuple struct field for the unwrapped value\n\nfixes #99416\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d89e99a805838bb03e6f81a461efcdab8e616aee", "html_url": "https://github.com/rust-lang/rust/commit/d89e99a805838bb03e6f81a461efcdab8e616aee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d89e99a805838bb03e6f81a461efcdab8e616aee/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "29444545405471a106c67adf48593c5943b6f483", "url": "https://api.github.com/repos/rust-lang/rust/commits/29444545405471a106c67adf48593c5943b6f483", "html_url": "https://github.com/rust-lang/rust/commit/29444545405471a106c67adf48593c5943b6f483"}, {"sha": "f85f37583d91152b967cd0d1bd7253b339a26d42", "url": "https://api.github.com/repos/rust-lang/rust/commits/f85f37583d91152b967cd0d1bd7253b339a26d42", "html_url": "https://github.com/rust-lang/rust/commit/f85f37583d91152b967cd0d1bd7253b339a26d42"}], "stats": {"total": 90, "additions": 90, "deletions": 0}, "files": [{"sha": "381c3a4ea1f7e04904cefc3f58af85945e078518", "filename": "compiler/rustc_typeck/src/check/demand.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/d89e99a805838bb03e6f81a461efcdab8e616aee/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fdemand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d89e99a805838bb03e6f81a461efcdab8e616aee/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fdemand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fdemand.rs?ref=d89e99a805838bb03e6f81a461efcdab8e616aee", "patch": "@@ -287,6 +287,21 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         expr_ty: Ty<'tcx>,\n     ) {\n         if let ty::Adt(expected_adt, substs) = expected.kind() {\n+            if let hir::ExprKind::Field(base, ident) = expr.kind {\n+                let base_ty = self.typeck_results.borrow().expr_ty(base);\n+                if self.can_eq(self.param_env, base_ty, expected).is_ok()\n+                    && let Some(base_span) = base.span.find_ancestor_inside(expr.span)\n+                {\n+                    err.span_suggestion_verbose(\n+                        expr.span.with_lo(base_span.hi()),\n+                        format!(\"consider removing the tuple struct field `{ident}`\"),\n+                        \"\",\n+                        Applicability::MaybeIncorrect,\n+                    );\n+                    return\n+                }\n+            }\n+\n             // If the expression is of type () and it's the return expression of a block,\n             // we suggest adding a separate return expression instead.\n             // (To avoid things like suggesting `Ok(while .. { .. })`.)"}, {"sha": "63b65ab20fea8a961f920959e81f8597c5d6ab60", "filename": "src/test/ui/mismatched_types/suggest-removing-tulpe-struct-field.fixed", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d89e99a805838bb03e6f81a461efcdab8e616aee/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-removing-tulpe-struct-field.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/d89e99a805838bb03e6f81a461efcdab8e616aee/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-removing-tulpe-struct-field.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-removing-tulpe-struct-field.fixed?ref=d89e99a805838bb03e6f81a461efcdab8e616aee", "patch": "@@ -0,0 +1,17 @@\n+// run-rustfix\n+\n+macro_rules! my_wrapper {\n+    ($expr:expr) => { MyWrapper($expr) }\n+}\n+\n+pub struct MyWrapper(u32);\n+\n+fn main() {\n+    let value = MyWrapper(123);\n+    some_fn(value); //~ ERROR mismatched types\n+    some_fn(my_wrapper!(123)); //~ ERROR mismatched types\n+}\n+\n+fn some_fn(wrapped: MyWrapper) {\n+    drop(wrapped);\n+}"}, {"sha": "2ab4e3955f336aad0a1a0363066066cafba0bcfa", "filename": "src/test/ui/mismatched_types/suggest-removing-tulpe-struct-field.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d89e99a805838bb03e6f81a461efcdab8e616aee/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-removing-tulpe-struct-field.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d89e99a805838bb03e6f81a461efcdab8e616aee/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-removing-tulpe-struct-field.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-removing-tulpe-struct-field.rs?ref=d89e99a805838bb03e6f81a461efcdab8e616aee", "patch": "@@ -0,0 +1,17 @@\n+// run-rustfix\n+\n+macro_rules! my_wrapper {\n+    ($expr:expr) => { MyWrapper($expr) }\n+}\n+\n+pub struct MyWrapper(u32);\n+\n+fn main() {\n+    let value = MyWrapper(123);\n+    some_fn(value.0); //~ ERROR mismatched types\n+    some_fn(my_wrapper!(123).0); //~ ERROR mismatched types\n+}\n+\n+fn some_fn(wrapped: MyWrapper) {\n+    drop(wrapped);\n+}"}, {"sha": "82a7f276372c9903dec8c85b1b64202ddb3c9aae", "filename": "src/test/ui/mismatched_types/suggest-removing-tulpe-struct-field.stderr", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/d89e99a805838bb03e6f81a461efcdab8e616aee/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-removing-tulpe-struct-field.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d89e99a805838bb03e6f81a461efcdab8e616aee/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-removing-tulpe-struct-field.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-removing-tulpe-struct-field.stderr?ref=d89e99a805838bb03e6f81a461efcdab8e616aee", "patch": "@@ -0,0 +1,41 @@\n+error[E0308]: mismatched types\n+  --> $DIR/suggest-removing-tulpe-struct-field.rs:11:13\n+   |\n+LL |     some_fn(value.0);\n+   |     ------- ^^^^^^^ expected struct `MyWrapper`, found `u32`\n+   |     |\n+   |     arguments to this function are incorrect\n+   |\n+note: function defined here\n+  --> $DIR/suggest-removing-tulpe-struct-field.rs:15:4\n+   |\n+LL | fn some_fn(wrapped: MyWrapper) {\n+   |    ^^^^^^^ ------------------\n+help: consider removing the tuple struct field `0`\n+   |\n+LL -     some_fn(value.0);\n+LL +     some_fn(value);\n+   |\n+\n+error[E0308]: mismatched types\n+  --> $DIR/suggest-removing-tulpe-struct-field.rs:12:13\n+   |\n+LL |     some_fn(my_wrapper!(123).0);\n+   |     ------- ^^^^^^^^^^^^^^^^^^ expected struct `MyWrapper`, found `u32`\n+   |     |\n+   |     arguments to this function are incorrect\n+   |\n+note: function defined here\n+  --> $DIR/suggest-removing-tulpe-struct-field.rs:15:4\n+   |\n+LL | fn some_fn(wrapped: MyWrapper) {\n+   |    ^^^^^^^ ------------------\n+help: consider removing the tuple struct field `0`\n+   |\n+LL -     some_fn(my_wrapper!(123).0);\n+LL +     some_fn(my_wrapper!(123));\n+   |\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0308`."}]}