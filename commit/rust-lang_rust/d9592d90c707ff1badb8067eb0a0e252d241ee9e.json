{"sha": "d9592d90c707ff1badb8067eb0a0e252d241ee9e", "node_id": "C_kwDOAAsO6NoAKGQ5NTkyZDkwYzcwN2ZmMWJhZGI4MDY3ZWIwYTBlMjUyZDI0MWVlOWU", "commit": {"author": {"name": "Chayim Refael Friedman", "email": "chayimfr@gmail.com", "date": "2022-02-14T00:00:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-02-14T00:55:12Z"}, "message": "Fix suggestion to slice if scurtinee is a reference to `Result` or `Option`", "tree": {"sha": "7dff3654beeed241f14c1e0c47c4ad5903ad2959", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7dff3654beeed241f14c1e0c47c4ad5903ad2959"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d9592d90c707ff1badb8067eb0a0e252d241ee9e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d9592d90c707ff1badb8067eb0a0e252d241ee9e", "html_url": "https://github.com/rust-lang/rust/commit/d9592d90c707ff1badb8067eb0a0e252d241ee9e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d9592d90c707ff1badb8067eb0a0e252d241ee9e/comments", "author": {"login": "ChayimFriedman2", "id": 24700207, "node_id": "MDQ6VXNlcjI0NzAwMjA3", "avatar_url": "https://avatars.githubusercontent.com/u/24700207?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChayimFriedman2", "html_url": "https://github.com/ChayimFriedman2", "followers_url": "https://api.github.com/users/ChayimFriedman2/followers", "following_url": "https://api.github.com/users/ChayimFriedman2/following{/other_user}", "gists_url": "https://api.github.com/users/ChayimFriedman2/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChayimFriedman2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChayimFriedman2/subscriptions", "organizations_url": "https://api.github.com/users/ChayimFriedman2/orgs", "repos_url": "https://api.github.com/users/ChayimFriedman2/repos", "events_url": "https://api.github.com/users/ChayimFriedman2/events{/privacy}", "received_events_url": "https://api.github.com/users/ChayimFriedman2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9a60099cc43c8a07abb280be323d1ed9afc27f2c", "url": "https://api.github.com/repos/rust-lang/rust/commits/9a60099cc43c8a07abb280be323d1ed9afc27f2c", "html_url": "https://github.com/rust-lang/rust/commit/9a60099cc43c8a07abb280be323d1ed9afc27f2c"}], "stats": {"total": 87, "additions": 62, "deletions": 25}, "files": [{"sha": "af378a0e708a260dea3892438e9580a9317295aa", "filename": "compiler/rustc_typeck/src/check/pat.rs", "status": "modified", "additions": 32, "deletions": 24, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/d9592d90c707ff1badb8067eb0a0e252d241ee9e/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fpat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9592d90c707ff1badb8067eb0a0e252d241ee9e/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fpat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fpat.rs?ref=d9592d90c707ff1badb8067eb0a0e252d241ee9e", "patch": "@@ -2029,34 +2029,42 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 err.help(\"the semantics of slice patterns changed recently; see issue #62254\");\n             }\n         } else if Autoderef::new(&self.infcx, self.param_env, self.body_id, span, expected_ty, span)\n-            .any(|(ty, _)| matches!(ty.kind(), ty::Slice(..)))\n+            .any(|(ty, _)| matches!(ty.kind(), ty::Slice(..) | ty::Array(..)))\n         {\n             if let (Some(span), true) = (ti.span, ti.origin_expr) {\n                 if let Ok(snippet) = self.tcx.sess.source_map().span_to_snippet(span) {\n-                    let applicability = match self.resolve_vars_if_possible(ti.expected).kind() {\n-                        ty::Adt(adt_def, _)\n-                            if self.tcx.is_diagnostic_item(sym::Option, adt_def.did)\n-                                || self.tcx.is_diagnostic_item(sym::Result, adt_def.did) =>\n-                        {\n-                            // Slicing won't work here, but `.as_deref()` might (issue #91328).\n-                            err.span_suggestion(\n-                                span,\n-                                \"consider using `as_deref` here\",\n-                                format!(\"{}.as_deref()\", snippet),\n-                                Applicability::MaybeIncorrect,\n-                            );\n-                            None\n-                        }\n-                        // FIXME: instead of checking for Vec only, we could check whether the\n-                        // type implements `Deref<Target=X>`; see\n-                        // https://github.com/rust-lang/rust/pull/91343#discussion_r761466979\n-                        ty::Adt(adt_def, _)\n-                            if self.tcx.is_diagnostic_item(sym::Vec, adt_def.did) =>\n-                        {\n-                            Some(Applicability::MachineApplicable)\n+                    let applicability = Autoderef::new(\n+                        &self.infcx,\n+                        self.param_env,\n+                        self.body_id,\n+                        span,\n+                        self.resolve_vars_if_possible(ti.expected),\n+                        span,\n+                    )\n+                    .find_map(|(ty, _)| {\n+                        match ty.kind() {\n+                            ty::Adt(adt_def, _)\n+                                if self.tcx.is_diagnostic_item(sym::Option, adt_def.did)\n+                                    || self.tcx.is_diagnostic_item(sym::Result, adt_def.did) =>\n+                            {\n+                                // Slicing won't work here, but `.as_deref()` might (issue #91328).\n+                                err.span_suggestion(\n+                                    span,\n+                                    \"consider using `as_deref` here\",\n+                                    format!(\"{}.as_deref()\", snippet),\n+                                    Applicability::MaybeIncorrect,\n+                                );\n+                                Some(None)\n+                            }\n+\n+                            ty::Slice(..) | ty::Array(..) => {\n+                                Some(Some(Applicability::MachineApplicable))\n+                            }\n+\n+                            _ => None,\n                         }\n-                        _ => Some(Applicability::MaybeIncorrect),\n-                    };\n+                    })\n+                    .unwrap_or(Some(Applicability::MaybeIncorrect));\n \n                     if let Some(applicability) = applicability {\n                         err.span_suggestion("}, {"sha": "c0384399a92e683f1fdc4e63528cd6482f0008ea", "filename": "src/test/ui/typeck/issue-91328.fixed", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d9592d90c707ff1badb8067eb0a0e252d241ee9e/src%2Ftest%2Fui%2Ftypeck%2Fissue-91328.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/d9592d90c707ff1badb8067eb0a0e252d241ee9e/src%2Ftest%2Fui%2Ftypeck%2Fissue-91328.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-91328.fixed?ref=d9592d90c707ff1badb8067eb0a0e252d241ee9e", "patch": "@@ -34,4 +34,14 @@ fn baz(v: Vec<i32>) -> i32 {\n     }\n }\n \n+fn qux(a: &Option<Box<[i32; 2]>>) -> i32 {\n+    match a.as_deref() {\n+    //~^ HELP: consider using `as_deref` here\n+        Some([a, b]) => a + b,\n+        //~^ ERROR: expected an array or slice\n+        //~| NOTE: pattern cannot match with input type\n+        _ => 42,\n+    }\n+}\n+\n fn main() {}"}, {"sha": "63602d26f970df5b77f43dd0341c61694944bca4", "filename": "src/test/ui/typeck/issue-91328.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d9592d90c707ff1badb8067eb0a0e252d241ee9e/src%2Ftest%2Fui%2Ftypeck%2Fissue-91328.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9592d90c707ff1badb8067eb0a0e252d241ee9e/src%2Ftest%2Fui%2Ftypeck%2Fissue-91328.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-91328.rs?ref=d9592d90c707ff1badb8067eb0a0e252d241ee9e", "patch": "@@ -34,4 +34,14 @@ fn baz(v: Vec<i32>) -> i32 {\n     }\n }\n \n+fn qux(a: &Option<Box<[i32; 2]>>) -> i32 {\n+    match a {\n+    //~^ HELP: consider using `as_deref` here\n+        Some([a, b]) => a + b,\n+        //~^ ERROR: expected an array or slice\n+        //~| NOTE: pattern cannot match with input type\n+        _ => 42,\n+    }\n+}\n+\n fn main() {}"}, {"sha": "f2f407bcafff222acedc6040dd381bb6417acabc", "filename": "src/test/ui/typeck/issue-91328.stderr", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/d9592d90c707ff1badb8067eb0a0e252d241ee9e/src%2Ftest%2Fui%2Ftypeck%2Fissue-91328.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d9592d90c707ff1badb8067eb0a0e252d241ee9e/src%2Ftest%2Fui%2Ftypeck%2Fissue-91328.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-91328.stderr?ref=d9592d90c707ff1badb8067eb0a0e252d241ee9e", "patch": "@@ -25,6 +25,15 @@ LL |\n LL |         [a, b] => a + b,\n    |         ^^^^^^ pattern cannot match with input type `Vec<i32>`\n \n-error: aborting due to 3 previous errors\n+error[E0529]: expected an array or slice, found `Box<[i32; 2]>`\n+  --> $DIR/issue-91328.rs:40:14\n+   |\n+LL |     match a {\n+   |           - help: consider using `as_deref` here: `a.as_deref()`\n+LL |\n+LL |         Some([a, b]) => a + b,\n+   |              ^^^^^^ pattern cannot match with input type `Box<[i32; 2]>`\n+\n+error: aborting due to 4 previous errors\n \n For more information about this error, try `rustc --explain E0529`."}]}