{"sha": "857747c9caa561c83ee32b598a172bcccdd134b2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg1Nzc0N2M5Y2FhNTYxYzgzZWUzMmI1OThhMTcyYmNjY2RkMTM0YjI=", "commit": {"author": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-05-25T00:24:04Z"}, "committer": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-05-25T06:50:46Z"}, "message": "Consider trailing try operations when counting almost_total", "tree": {"sha": "28f3d4c7b638ec0fcd03142dc7b6377bf9053913", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/28f3d4c7b638ec0fcd03142dc7b6377bf9053913"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/857747c9caa561c83ee32b598a172bcccdd134b2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/857747c9caa561c83ee32b598a172bcccdd134b2", "html_url": "https://github.com/rust-lang/rust/commit/857747c9caa561c83ee32b598a172bcccdd134b2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/857747c9caa561c83ee32b598a172bcccdd134b2/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a7b8dcc60d50f9be0785ec5a572f813691af2032", "url": "https://api.github.com/repos/rust-lang/rust/commits/a7b8dcc60d50f9be0785ec5a572f813691af2032", "html_url": "https://github.com/rust-lang/rust/commit/a7b8dcc60d50f9be0785ec5a572f813691af2032"}], "stats": {"total": 13, "additions": 11, "deletions": 2}, "files": [{"sha": "c61ee2267e8861ea952535896d497db0f9749185", "filename": "src/chains.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/857747c9caa561c83ee32b598a172bcccdd134b2/src%2Fchains.rs", "raw_url": "https://github.com/rust-lang/rust/raw/857747c9caa561c83ee32b598a172bcccdd134b2/src%2Fchains.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fchains.rs?ref=857747c9caa561c83ee32b598a172bcccdd134b2", "patch": "@@ -97,6 +97,15 @@ pub fn rewrite_chain(expr: &ast::Expr, context: &RewriteContext, shape: Shape) -\n     if chain_only_try(&subexpr_list) {\n         return rewrite_try(&parent, subexpr_list.len(), context, shape);\n     }\n+    let trailing_try_num = subexpr_list\n+        .iter()\n+        .take_while(|e| {\n+                        match e.node {\n+                            ast::ExprKind::Try(..) => true,\n+                            _ => false,\n+                        }\n+                    })\n+        .count();\n \n     // Parent is the first item in the chain, e.g., `foo` in `foo.bar.baz()`.\n     let parent_shape = if is_block_expr(context, &parent, \"\\n\") {\n@@ -166,7 +175,7 @@ pub fn rewrite_chain(expr: &ast::Expr, context: &RewriteContext, shape: Shape) -\n                                     .collect::<Option<Vec<_>>>());\n \n     // Total of all items excluding the last.\n-    let almost_total = rewrites[..rewrites.len() - 1]\n+    let almost_total = rewrites[..rewrites.len() - (1 + trailing_try_num)]\n         .iter()\n         .fold(0, |a, b| a + first_line_width(b)) + parent_rewrite.len();\n     let one_line_len = rewrites.iter().fold(0, |a, r| a + first_line_width(r)) +\n@@ -195,7 +204,7 @@ pub fn rewrite_chain(expr: &ast::Expr, context: &RewriteContext, shape: Shape) -\n     let mut fits_single_line = !veto_single_line && almost_total <= shape.width;\n     if fits_single_line {\n         let len = rewrites.len();\n-        let (init, last) = rewrites.split_at_mut(len - 1);\n+        let (init, last) = rewrites.split_at_mut(len - (1 + trailing_try_num));\n         fits_single_line = init.iter().all(|s| !s.contains('\\n'));\n \n         if fits_single_line {"}]}