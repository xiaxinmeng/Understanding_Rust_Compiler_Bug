{"sha": "925a3040c7f0a84885a91ba8919d1f6d7516302a", "node_id": "C_kwDOAAsO6NoAKDkyNWEzMDQwYzdmMGE4NDg4NWE5MWJhODkxOWQxZjZkNzUxNjMwMmE", "commit": {"author": {"name": "ozkanonur", "email": "work@onurozkan.dev", "date": "2023-04-06T17:16:51Z"}, "committer": {"name": "ozkanonur", "email": "work@onurozkan.dev", "date": "2023-04-06T17:16:51Z"}, "message": "improve/extend `detect_src_and_out` test\n\nSigned-off-by: ozkanonur <work@onurozkan.dev>", "tree": {"sha": "9c4d173f955f60d114e885932952c53b2798ddad", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9c4d173f955f60d114e885932952c53b2798ddad"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/925a3040c7f0a84885a91ba8919d1f6d7516302a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/925a3040c7f0a84885a91ba8919d1f6d7516302a", "html_url": "https://github.com/rust-lang/rust/commit/925a3040c7f0a84885a91ba8919d1f6d7516302a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/925a3040c7f0a84885a91ba8919d1f6d7516302a/comments", "author": {"login": "ozkanonur", "id": 39852038, "node_id": "MDQ6VXNlcjM5ODUyMDM4", "avatar_url": "https://avatars.githubusercontent.com/u/39852038?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ozkanonur", "html_url": "https://github.com/ozkanonur", "followers_url": "https://api.github.com/users/ozkanonur/followers", "following_url": "https://api.github.com/users/ozkanonur/following{/other_user}", "gists_url": "https://api.github.com/users/ozkanonur/gists{/gist_id}", "starred_url": "https://api.github.com/users/ozkanonur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ozkanonur/subscriptions", "organizations_url": "https://api.github.com/users/ozkanonur/orgs", "repos_url": "https://api.github.com/users/ozkanonur/repos", "events_url": "https://api.github.com/users/ozkanonur/events{/privacy}", "received_events_url": "https://api.github.com/users/ozkanonur/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ozkanonur", "id": 39852038, "node_id": "MDQ6VXNlcjM5ODUyMDM4", "avatar_url": "https://avatars.githubusercontent.com/u/39852038?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ozkanonur", "html_url": "https://github.com/ozkanonur", "followers_url": "https://api.github.com/users/ozkanonur/followers", "following_url": "https://api.github.com/users/ozkanonur/following{/other_user}", "gists_url": "https://api.github.com/users/ozkanonur/gists{/gist_id}", "starred_url": "https://api.github.com/users/ozkanonur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ozkanonur/subscriptions", "organizations_url": "https://api.github.com/users/ozkanonur/orgs", "repos_url": "https://api.github.com/users/ozkanonur/repos", "events_url": "https://api.github.com/users/ozkanonur/events{/privacy}", "received_events_url": "https://api.github.com/users/ozkanonur/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0058748944abb3282aba0e0a74823c6411703565", "url": "https://api.github.com/repos/rust-lang/rust/commits/0058748944abb3282aba0e0a74823c6411703565", "html_url": "https://github.com/rust-lang/rust/commit/0058748944abb3282aba0e0a74823c6411703565"}], "stats": {"total": 65, "additions": 44, "deletions": 21}, "files": [{"sha": "4a9ab158e6ca2f49c42e062ebd3c96f91ccabe6d", "filename": "src/bootstrap/config/tests.rs", "status": "modified", "additions": 44, "deletions": 21, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/925a3040c7f0a84885a91ba8919d1f6d7516302a/src%2Fbootstrap%2Fconfig%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/925a3040c7f0a84885a91ba8919d1f6d7516302a/src%2Fbootstrap%2Fconfig%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig%2Ftests.rs?ref=925a3040c7f0a84885a91ba8919d1f6d7516302a", "patch": "@@ -33,35 +33,58 @@ fn download_ci_llvm() {\n     ));\n }\n \n+// FIXME(ozkanonur): extend scope of the test\n+// refs:\n+//   - https://github.com/rust-lang/rust/issues/109120\n+//   - https://github.com/rust-lang/rust/pull/109162#issuecomment-1496782487\n #[test]\n fn detect_src_and_out() {\n-    let cfg = parse(\"\");\n+    fn test(cfg: Config, build_dir: Option<&str>) {\n+        // This will bring absolute form of `src/bootstrap` path\n+        let current_dir = std::env::current_dir().unwrap();\n \n-    // This will bring absolute form of `src/bootstrap` path\n-    let current_dir = std::env::current_dir().unwrap();\n+        // get `src` by moving into project root path\n+        let expected_src = current_dir.ancestors().nth(2).unwrap();\n+        assert_eq!(&cfg.src, expected_src);\n \n-    // get `src` by moving into project root path\n-    let expected_src = current_dir.ancestors().nth(2).unwrap();\n+        // Sanity check for `src`\n+        let manifest_dir = Path::new(env!(\"CARGO_MANIFEST_DIR\"));\n+        let expected_src = manifest_dir.ancestors().nth(2).unwrap();\n+        assert_eq!(&cfg.src, expected_src);\n \n-    assert_eq!(&cfg.src, expected_src);\n+        // test if build-dir was manually given in config.toml\n+        if let Some(custom_build_dir) = build_dir {\n+            assert_eq!(&cfg.out, Path::new(custom_build_dir));\n+        }\n+        // test the native bootstrap way\n+        else {\n+            // This should bring output path of bootstrap in absolute form\n+            let cargo_target_dir = env::var_os(\"CARGO_TARGET_DIR\").expect(\n+                \"CARGO_TARGET_DIR must been provided for the test environment from bootstrap\",\n+            );\n \n-    // This should bring output path of bootstrap in absolute form\n-    let cargo_target_dir = env::var_os(\"CARGO_TARGET_DIR\")\n-        .expect(\"CARGO_TARGET_DIR must been provided for the test environment from bootstrap\");\n+            // Move to `build` from `build/bootstrap`\n+            let expected_out = Path::new(&cargo_target_dir).parent().unwrap();\n+            assert_eq!(&cfg.out, expected_out);\n \n-    // Move to `build` from `build/bootstrap`\n-    let expected_out = Path::new(&cargo_target_dir).parent().unwrap();\n-    assert_eq!(&cfg.out, expected_out);\n+            let args: Vec<String> = env::args().collect();\n \n-    let args: Vec<String> = env::args().collect();\n+            // Another test for `out` as a sanity check\n+            //\n+            // This will bring something similar to:\n+            //     `{build-dir}/bootstrap/debug/deps/bootstrap-c7ee91d5661e2804`\n+            // `{build-dir}` can be anywhere, not just in the rust project directory.\n+            let dep = Path::new(args.first().unwrap());\n+            let expected_out = dep.ancestors().nth(4).unwrap();\n \n-    // Another test for `out` as a sanity check\n-    //\n-    // This will bring something similar to:\n-    //     `{config_toml_place}/build/bootstrap/debug/deps/bootstrap-c7ee91d5661e2804`\n-    // `{config_toml_place}` can be anywhere, not just in the rust project directory.\n-    let dep = Path::new(args.first().unwrap());\n-    let expected_out = dep.ancestors().nth(4).unwrap();\n+            assert_eq!(&cfg.out, expected_out);\n+        }\n+    }\n+\n+    test(parse(\"\"), None);\n \n-    assert_eq!(&cfg.out, expected_out);\n+    {\n+        let build_dir = if cfg!(windows) { Some(\"C:\\\\tmp\") } else { Some(\"/tmp\") };\n+        test(parse(\"build.build-dir = \\\"/tmp\\\"\"), build_dir);\n+    }\n }"}]}