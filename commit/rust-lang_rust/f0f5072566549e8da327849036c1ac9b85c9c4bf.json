{"sha": "f0f5072566549e8da327849036c1ac9b85c9c4bf", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYwZjUwNzI1NjY1NDllOGRhMzI3ODQ5MDM2YzFhYzliODVjOWM0YmY=", "commit": {"author": {"name": "Piotr Czarnecki", "email": "pioczarn@gmail.com", "date": "2014-03-23T07:59:18Z"}, "committer": {"name": "Piotr Czarnecki", "email": "pioczarn@gmail.com", "date": "2014-03-23T12:36:49Z"}, "message": "rustc: Change the filename of compressed bitcode\n\nFixes #12992\nStore compressed bitcode files in rlibs with a different extension. Compression doesn't interfere with --emit=bc.\nRegression test compares outputs.", "tree": {"sha": "b722276a05c2001f96aeaa5158c6ed97647f9a54", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b722276a05c2001f96aeaa5158c6ed97647f9a54"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f0f5072566549e8da327849036c1ac9b85c9c4bf", "comment_count": 9, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f0f5072566549e8da327849036c1ac9b85c9c4bf", "html_url": "https://github.com/rust-lang/rust/commit/f0f5072566549e8da327849036c1ac9b85c9c4bf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f0f5072566549e8da327849036c1ac9b85c9c4bf/comments", "author": {"login": "pczarn", "id": 3356767, "node_id": "MDQ6VXNlcjMzNTY3Njc=", "avatar_url": "https://avatars.githubusercontent.com/u/3356767?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pczarn", "html_url": "https://github.com/pczarn", "followers_url": "https://api.github.com/users/pczarn/followers", "following_url": "https://api.github.com/users/pczarn/following{/other_user}", "gists_url": "https://api.github.com/users/pczarn/gists{/gist_id}", "starred_url": "https://api.github.com/users/pczarn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pczarn/subscriptions", "organizations_url": "https://api.github.com/users/pczarn/orgs", "repos_url": "https://api.github.com/users/pczarn/repos", "events_url": "https://api.github.com/users/pczarn/events{/privacy}", "received_events_url": "https://api.github.com/users/pczarn/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pczarn", "id": 3356767, "node_id": "MDQ6VXNlcjMzNTY3Njc=", "avatar_url": "https://avatars.githubusercontent.com/u/3356767?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pczarn", "html_url": "https://github.com/pczarn", "followers_url": "https://api.github.com/users/pczarn/followers", "following_url": "https://api.github.com/users/pczarn/following{/other_user}", "gists_url": "https://api.github.com/users/pczarn/gists{/gist_id}", "starred_url": "https://api.github.com/users/pczarn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pczarn/subscriptions", "organizations_url": "https://api.github.com/users/pczarn/orgs", "repos_url": "https://api.github.com/users/pczarn/repos", "events_url": "https://api.github.com/users/pczarn/events{/privacy}", "received_events_url": "https://api.github.com/users/pczarn/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "11c6817e13cf568167b7bffe66e528f1e8204635", "url": "https://api.github.com/repos/rust-lang/rust/commits/11c6817e13cf568167b7bffe66e528f1e8204635", "html_url": "https://github.com/rust-lang/rust/commit/11c6817e13cf568167b7bffe66e528f1e8204635"}], "stats": {"total": 16, "additions": 10, "deletions": 6}, "files": [{"sha": "f198a41af655754fa3c8e5fe67412a04423f3658", "filename": "src/librustc/back/link.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f0f5072566549e8da327849036c1ac9b85c9c4bf/src%2Flibrustc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f0f5072566549e8da327849036c1ac9b85c9c4bf/src%2Flibrustc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Flink.rs?ref=f0f5072566549e8da327849036c1ac9b85c9c4bf", "patch": "@@ -937,16 +937,18 @@ fn link_rlib<'a>(sess: &'a Session,\n             // For LTO purposes, the bytecode of this library is also inserted\n             // into the archive.\n             let bc = obj_filename.with_extension(\"bc\");\n+            let bc_deflated = obj_filename.with_extension(\"bc.deflate\");\n             match fs::File::open(&bc).read_to_end().and_then(|data| {\n-                fs::File::create(&bc).write(flate::deflate_bytes(data).as_slice())\n+                fs::File::create(&bc_deflated).write(flate::deflate_bytes(data).as_slice())\n             }) {\n                 Ok(()) => {}\n                 Err(e) => {\n                     sess.err(format!(\"failed to compress bytecode: {}\", e));\n                     sess.abort_if_errors()\n                 }\n             }\n-            a.add_file(&bc, false);\n+            a.add_file(&bc_deflated, false);\n+            remove(sess, &bc_deflated);\n             if !sess.opts.cg.save_temps &&\n                !sess.opts.output_types.contains(&OutputTypeBitcode) {\n                 remove(sess, &bc);"}, {"sha": "ef3496f113b599fdc8dae389ee93a88bf68bdfc3", "filename": "src/librustc/back/lto.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f0f5072566549e8da327849036c1ac9b85c9c4bf/src%2Flibrustc%2Fback%2Flto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f0f5072566549e8da327849036c1ac9b85c9c4bf/src%2Flibrustc%2Fback%2Flto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Flto.rs?ref=f0f5072566549e8da327849036c1ac9b85c9c4bf", "patch": "@@ -52,9 +52,9 @@ pub fn run(sess: &session::Session, llmod: ModuleRef,\n \n         let archive = ArchiveRO::open(&path).expect(\"wanted an rlib\");\n         debug!(\"reading {}\", name);\n-        let bc = time(sess.time_passes(), format!(\"read {}.bc\", name), (), |_|\n-                      archive.read(format!(\"{}.bc\", name)));\n-        let bc = bc.expect(\"missing bytecode in archive!\");\n+        let bc = time(sess.time_passes(), format!(\"read {}.bc.deflate\", name), (), |_|\n+                      archive.read(format!(\"{}.bc.deflate\", name)));\n+        let bc = bc.expect(\"missing compressed bytecode in archive!\");\n         let bc = time(sess.time_passes(), format!(\"inflate {}.bc\", name), (), |_|\n                       flate::inflate_bytes(bc));\n         let ptr = bc.as_slice().as_ptr();"}, {"sha": "94e0ce833438f1e72b22fa84da64ce61b402b4ed", "filename": "src/test/run-make/output-type-permutations/Makefile", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f0f5072566549e8da327849036c1ac9b85c9c4bf/src%2Ftest%2Frun-make%2Foutput-type-permutations%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/f0f5072566549e8da327849036c1ac9b85c9c4bf/src%2Ftest%2Frun-make%2Foutput-type-permutations%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Foutput-type-permutations%2FMakefile?ref=f0f5072566549e8da327849036c1ac9b85c9c4bf", "patch": "@@ -15,7 +15,6 @@ all:\n \trm $(TMPDIR)/bar\n \t$(RUSTC) foo.rs --emit=asm,ir,bc,obj,link --crate-type=staticlib\n \trm $(TMPDIR)/bar.ll\n-\trm $(TMPDIR)/bar.bc\n \trm $(TMPDIR)/bar.s\n \trm $(TMPDIR)/bar.o\n \trm $(TMPDIR)/$(call STATICLIB_GLOB,bar)\n@@ -37,6 +36,9 @@ all:\n \trm $(TMPDIR)/foo\n \t$(RUSTC) foo.rs --crate-type=bin -o $(TMPDIR)/foo\n \trm $(TMPDIR)/foo\n+\tmv $(TMPDIR)/bar.bc $(TMPDIR)/foo.bc\n \t$(RUSTC) foo.rs --emit=bc,link --crate-type=rlib\n+\tcmp $(TMPDIR)/foo.bc $(TMPDIR)/bar.bc\n \trm $(TMPDIR)/bar.bc\n+\trm $(TMPDIR)/foo.bc\n \trm $(TMPDIR)/$(call RLIB_GLOB,bar)"}]}