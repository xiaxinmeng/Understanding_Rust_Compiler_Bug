{"sha": "abdb7733f47d2cfe27a1f25275b16b06adb35144", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFiZGI3NzMzZjQ3ZDJjZmUyN2ExZjI1Mjc1YjE2YjA2YWRiMzUxNDQ=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2019-03-19T20:34:06Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-03-19T20:34:06Z"}, "message": "Rollup merge of #59253 - kennytm:precise-docker-cache-hash, r=pietroalbini\n\nCalculate Docker cache hash precisely from Dockerfile's dependencies\n\n#58549 changed the Docker cache calculation to include every file under `src/ci/docker`, so that when files under `dist-x86_64-linux` is changed, its dependent image `dist-i686-linux` will also be rebuilt.\n\nHowever, this ultraconservative solution caused the `dist-i686-linux` to be rebuilt every time an irrelevant Dockerfile (e.g. the PowerPC ones) is changed, which increases the building time beyond 3 hours and forcing a spurious but expected failure.\n\nThis commit instead parses the Dockerfile itself and look for the actual dependencies. The scripts needs to be copied into the Docker image, which must be done with the COPY command, so we just need to find all lines with a COPY command and add the source file into the hash calculator.\n\nNote: this script only handles single-lined COPY command in the form `COPY src1 src2 src3 dst`, since these are the only variant used inside this repository.", "tree": {"sha": "e334871adcf3b8daadf96d9f009869c60ac1dabe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e334871adcf3b8daadf96d9f009869c60ac1dabe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/abdb7733f47d2cfe27a1f25275b16b06adb35144", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJckVI+CRBK7hj4Ov3rIwAAdHIIAJUjV6KV3vmjqgjtx/9+bvmI\nu8AyflZ49CBMVPJD7TEc0MDQ7jJGu0/bZYAlCl3s+7Z3Cf5444fEH0rh2LtArkHM\nje4pjlbOwMoXcj2n8J52fFy8G6MSxSejaU07SZ5DdpoKc7Bz6//gy+vpB+ANgxqv\niyUvIyj6x6rMYjWKtsq0WYvyz30SPHBueSHa87XzrJ0j4FlbBbZRV+Tdab+y3gst\nJzsjr+1DZ7HWsALwIMtaQ64jzmn+eFsr7XE0hJuK/mYOkcKbEoJoAP5jErFybbA0\nLci4GVGk9qd2aNHTXSp1jTzsLySh66+5UEHhzQaVxO46DrHio5wl4x65vKBle7I=\n=7x2A\n-----END PGP SIGNATURE-----\n", "payload": "tree e334871adcf3b8daadf96d9f009869c60ac1dabe\nparent 9da8fe4e020e0f9a0ba811cbb742cfaaba946ccf\nparent 07aee1df4427bcc2be5e9f6be5c853a0f6987b40\nauthor kennytm <kennytm@gmail.com> 1553027646 +0800\ncommitter GitHub <noreply@github.com> 1553027646 +0800\n\nRollup merge of #59253 - kennytm:precise-docker-cache-hash, r=pietroalbini\n\nCalculate Docker cache hash precisely from Dockerfile's dependencies\n\n#58549 changed the Docker cache calculation to include every file under `src/ci/docker`, so that when files under `dist-x86_64-linux` is changed, its dependent image `dist-i686-linux` will also be rebuilt.\n\nHowever, this ultraconservative solution caused the `dist-i686-linux` to be rebuilt every time an irrelevant Dockerfile (e.g. the PowerPC ones) is changed, which increases the building time beyond 3 hours and forcing a spurious but expected failure.\n\nThis commit instead parses the Dockerfile itself and look for the actual dependencies. The scripts needs to be copied into the Docker image, which must be done with the COPY command, so we just need to find all lines with a COPY command and add the source file into the hash calculator.\n\nNote: this script only handles single-lined COPY command in the form `COPY src1 src2 src3 dst`, since these are the only variant used inside this repository.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/abdb7733f47d2cfe27a1f25275b16b06adb35144", "html_url": "https://github.com/rust-lang/rust/commit/abdb7733f47d2cfe27a1f25275b16b06adb35144", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/abdb7733f47d2cfe27a1f25275b16b06adb35144/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9da8fe4e020e0f9a0ba811cbb742cfaaba946ccf", "url": "https://api.github.com/repos/rust-lang/rust/commits/9da8fe4e020e0f9a0ba811cbb742cfaaba946ccf", "html_url": "https://github.com/rust-lang/rust/commit/9da8fe4e020e0f9a0ba811cbb742cfaaba946ccf"}, {"sha": "07aee1df4427bcc2be5e9f6be5c853a0f6987b40", "url": "https://api.github.com/repos/rust-lang/rust/commits/07aee1df4427bcc2be5e9f6be5c853a0f6987b40", "html_url": "https://github.com/rust-lang/rust/commit/07aee1df4427bcc2be5e9f6be5c853a0f6987b40"}], "stats": {"total": 13, "additions": 12, "deletions": 1}, "files": [{"sha": "ef151750af9bfcb7962760c07f4de7675a0fa73c", "filename": "src/ci/docker/run.sh", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/abdb7733f47d2cfe27a1f25275b16b06adb35144/src%2Fci%2Fdocker%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/abdb7733f47d2cfe27a1f25275b16b06adb35144/src%2Fci%2Fdocker%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Frun.sh?ref=abdb7733f47d2cfe27a1f25275b16b06adb35144", "patch": "@@ -22,7 +22,18 @@ if [ -f \"$docker_dir/$image/Dockerfile\" ]; then\n       hash_key=/tmp/.docker-hash-key.txt\n       rm -f \"${hash_key}\"\n       echo $image >> $hash_key\n-      find $docker_dir -type f | sort | xargs cat >> $hash_key\n+\n+      cat \"$docker_dir/$image/Dockerfile\" >> $hash_key\n+      # Look for all source files involves in the COPY command\n+      copied_files=/tmp/.docker-copied-files.txt\n+      rm -f \"$copied_files\"\n+      for i in $(sed -n -e 's/^COPY \\(.*\\) .*$/\\1/p' \"$docker_dir/$image/Dockerfile\"); do\n+        # List the file names\n+        find \"$docker_dir/$i\" -type f >> $copied_files\n+      done\n+      # Sort the file names and cat the content into the hash key\n+      sort $copied_files | xargs cat >> $hash_key\n+\n       docker --version >> $hash_key\n       cksum=$(sha512sum $hash_key | \\\n         awk '{print $1}')"}]}