{"sha": "3dced8029843ac9cfdeaa11400dec99d331a2779", "node_id": "C_kwDOAAsO6NoAKDNkY2VkODAyOTg0M2FjOWNmZGVhYTExNDAwZGVjOTlkMzMxYTI3Nzk", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-04-16T17:42:02Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-04-16T17:42:02Z"}, "message": "Rollup merge of #95006 - tmiasko:thread-local-static, r=wesleywiser\n\nReject `#[thread_local]` attribute on non-static items", "tree": {"sha": "758ce0c05e34f57c4e05e78bb69f54265019a3dd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/758ce0c05e34f57c4e05e78bb69f54265019a3dd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3dced8029843ac9cfdeaa11400dec99d331a2779", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiWv/qCRBK7hj4Ov3rIwAA+4cIAIR6WRME9VLXltScC6CM/c8L\nv9bc2+d7QZ9DEL/sMfMwuSwqWK3mCtwCuzvM6pQfJJKTG62wWoFPNs8aCWTUFc1x\nYPOxyg7KVQEOiO3jNYw1Q/1C25q2l0Scx9ZPQdOZK1vo5Hp7nF9urGjJQb2B5BdX\nJsU+rqQ7+qquPi02YNf3NZKSRW0eJfezgB+rvr4e7hJSIxGw21KBpQ6dAe1CkgJE\nXdiL9z4xHimMFLF4IUgrz2VngVKr1KgWOJgVwhYe7T2SWN9AASJKKSubsNK7kgVx\n0R5EfQKRv5uEdY0NoyGpr9kahUvoNvu7JZ8SWxMxOeq0ijx+vXAQd+Habx8tjHQ=\n=HXrE\n-----END PGP SIGNATURE-----\n", "payload": "tree 758ce0c05e34f57c4e05e78bb69f54265019a3dd\nparent 22d554657d08cff395911c5128be297e366899ec\nparent 5e7610378f5dce4f3cfdaf05fbafc962d000ffcd\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1650130922 +0200\ncommitter GitHub <noreply@github.com> 1650130922 +0200\n\nRollup merge of #95006 - tmiasko:thread-local-static, r=wesleywiser\n\nReject `#[thread_local]` attribute on non-static items\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3dced8029843ac9cfdeaa11400dec99d331a2779", "html_url": "https://github.com/rust-lang/rust/commit/3dced8029843ac9cfdeaa11400dec99d331a2779", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3dced8029843ac9cfdeaa11400dec99d331a2779/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "22d554657d08cff395911c5128be297e366899ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/22d554657d08cff395911c5128be297e366899ec", "html_url": "https://github.com/rust-lang/rust/commit/22d554657d08cff395911c5128be297e366899ec"}, {"sha": "5e7610378f5dce4f3cfdaf05fbafc962d000ffcd", "url": "https://api.github.com/repos/rust-lang/rust/commits/5e7610378f5dce4f3cfdaf05fbafc962d000ffcd", "html_url": "https://github.com/rust-lang/rust/commit/5e7610378f5dce4f3cfdaf05fbafc962d000ffcd"}], "stats": {"total": 84, "additions": 84, "deletions": 0}, "files": [{"sha": "a9444972130a85a0bef02baaf23bffb0189ef75b", "filename": "compiler/rustc_passes/src/check_attr.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/3dced8029843ac9cfdeaa11400dec99d331a2779/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dced8029843ac9cfdeaa11400dec99d331a2779/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs?ref=3dced8029843ac9cfdeaa11400dec99d331a2779", "patch": "@@ -80,6 +80,7 @@ impl CheckAttrVisitor<'_> {\n                     self.check_rustc_must_implement_one_of(attr, span, target)\n                 }\n                 sym::target_feature => self.check_target_feature(hir_id, attr, span, target),\n+                sym::thread_local => self.check_thread_local(attr, span, target),\n                 sym::track_caller => {\n                     self.check_track_caller(hir_id, attr.span, attrs, span, target)\n                 }\n@@ -523,6 +524,21 @@ impl CheckAttrVisitor<'_> {\n         }\n     }\n \n+    /// Checks if the `#[thread_local]` attribute on `item` is valid. Returns `true` if valid.\n+    fn check_thread_local(&self, attr: &Attribute, span: Span, target: Target) -> bool {\n+        match target {\n+            Target::ForeignStatic | Target::Static => true,\n+            _ => {\n+                self.tcx\n+                    .sess\n+                    .struct_span_err(attr.span, \"attribute should be applied to a static\")\n+                    .span_label(span, \"not a static\")\n+                    .emit();\n+                false\n+            }\n+        }\n+    }\n+\n     fn doc_attr_str_error(&self, meta: &NestedMetaItem, attr_name: &str) {\n         self.tcx\n             .sess"}, {"sha": "f1c4273870bffdbdd0e830c2af39e7363714386d", "filename": "src/test/ui/thread-local/non-static.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/3dced8029843ac9cfdeaa11400dec99d331a2779/src%2Ftest%2Fui%2Fthread-local%2Fnon-static.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dced8029843ac9cfdeaa11400dec99d331a2779/src%2Ftest%2Fui%2Fthread-local%2Fnon-static.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fthread-local%2Fnon-static.rs?ref=3dced8029843ac9cfdeaa11400dec99d331a2779", "patch": "@@ -0,0 +1,30 @@\n+// Check that #[thread_local] attribute is rejected on non-static items.\n+#![feature(thread_local)]\n+\n+#[thread_local]\n+//~^ ERROR attribute should be applied to a static\n+const A: u32 = 0;\n+\n+#[thread_local]\n+//~^ ERROR attribute should be applied to a static\n+fn main() {\n+    #[thread_local] || {};\n+    //~^ ERROR attribute should be applied to a static\n+}\n+\n+struct S {\n+    #[thread_local]\n+    //~^ ERROR attribute should be applied to a static\n+    a: String,\n+    b: String,\n+}\n+\n+#[thread_local]\n+// Static. OK.\n+static B: u32 = 0;\n+\n+extern \"C\" {\n+    #[thread_local]\n+    // Foreign static. OK.\n+    static C: u32;\n+}"}, {"sha": "09a1618d6e710362fe8b8b0578a87a624f46717e", "filename": "src/test/ui/thread-local/non-static.stderr", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/3dced8029843ac9cfdeaa11400dec99d331a2779/src%2Ftest%2Fui%2Fthread-local%2Fnon-static.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3dced8029843ac9cfdeaa11400dec99d331a2779/src%2Ftest%2Fui%2Fthread-local%2Fnon-static.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fthread-local%2Fnon-static.stderr?ref=3dced8029843ac9cfdeaa11400dec99d331a2779", "patch": "@@ -0,0 +1,38 @@\n+error: attribute should be applied to a static\n+  --> $DIR/non-static.rs:4:1\n+   |\n+LL | #[thread_local]\n+   | ^^^^^^^^^^^^^^^\n+LL |\n+LL | const A: u32 = 0;\n+   | ----------------- not a static\n+\n+error: attribute should be applied to a static\n+  --> $DIR/non-static.rs:8:1\n+   |\n+LL |   #[thread_local]\n+   |   ^^^^^^^^^^^^^^^\n+LL |\n+LL | / fn main() {\n+LL | |     #[thread_local] || {};\n+LL | |\n+LL | | }\n+   | |_- not a static\n+\n+error: attribute should be applied to a static\n+  --> $DIR/non-static.rs:11:5\n+   |\n+LL |     #[thread_local] || {};\n+   |     ^^^^^^^^^^^^^^^ ----- not a static\n+\n+error: attribute should be applied to a static\n+  --> $DIR/non-static.rs:16:5\n+   |\n+LL |     #[thread_local]\n+   |     ^^^^^^^^^^^^^^^\n+LL |\n+LL |     a: String,\n+   |     --------- not a static\n+\n+error: aborting due to 4 previous errors\n+"}]}