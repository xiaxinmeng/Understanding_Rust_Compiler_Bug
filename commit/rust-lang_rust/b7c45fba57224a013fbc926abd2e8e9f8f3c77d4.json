{"sha": "b7c45fba57224a013fbc926abd2e8e9f8f3c77d4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI3YzQ1ZmJhNTcyMjRhMDEzZmJjOTI2YWJkMmU4ZTlmOGYzYzc3ZDQ=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-01-17T10:44:40Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-01-17T10:44:40Z"}, "message": "Extract expr_with_attrs", "tree": {"sha": "d60e5d620be3a99cfd7eb1dceaa232e19c99e7e6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d60e5d620be3a99cfd7eb1dceaa232e19c99e7e6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b7c45fba57224a013fbc926abd2e8e9f8f3c77d4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b7c45fba57224a013fbc926abd2e8e9f8f3c77d4", "html_url": "https://github.com/rust-lang/rust/commit/b7c45fba57224a013fbc926abd2e8e9f8f3c77d4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b7c45fba57224a013fbc926abd2e8e9f8f3c77d4/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "90b8a31b83b1aafc3fb555ba4307527f9258f46d", "url": "https://api.github.com/repos/rust-lang/rust/commits/90b8a31b83b1aafc3fb555ba4307527f9258f46d", "html_url": "https://github.com/rust-lang/rust/commit/90b8a31b83b1aafc3fb555ba4307527f9258f46d"}], "stats": {"total": 59, "additions": 36, "deletions": 23}, "files": [{"sha": "3cf619e38859d29cc3080a2ef9035cf8fbd6eaeb", "filename": "crates/ra_parser/src/grammar/expressions.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/b7c45fba57224a013fbc926abd2e8e9f8f3c77d4/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b7c45fba57224a013fbc926abd2e8e9f8f3c77d4/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions.rs?ref=b7c45fba57224a013fbc926abd2e8e9f8f3c77d4", "patch": "@@ -19,6 +19,26 @@ pub(super) fn expr(p: &mut Parser) -> (Option<CompletedMarker>, BlockLike) {\n     expr_bp(p, r, 1)\n }\n \n+pub(super) fn expr_with_attrs(p: &mut Parser) -> bool {\n+    let m = p.start();\n+    let has_attrs = p.at(T![#]);\n+    attributes::outer_attributes(p);\n+\n+    let (cm, _block_like) = expr(p);\n+    let success = cm.is_some();\n+\n+    match (has_attrs, cm) {\n+        (true, Some(cm)) => {\n+            let kind = cm.kind();\n+            cm.undo_completion(p).abandon(p);\n+            m.complete(p, kind);\n+        }\n+        _ => m.abandon(p),\n+    }\n+\n+    success\n+}\n+\n pub(super) fn expr_stmt(p: &mut Parser) -> (Option<CompletedMarker>, BlockLike) {\n     let r = Restrictions { forbid_structs: false, prefer_stmt: true };\n     expr_bp(p, r, 1)"}, {"sha": "2cc321473aa51674edb66e16fd7b3a072116e014", "filename": "crates/ra_parser/src/grammar/expressions/atom.rs", "status": "modified", "additions": 2, "deletions": 13, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b7c45fba57224a013fbc926abd2e8e9f8f3c77d4/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions%2Fatom.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b7c45fba57224a013fbc926abd2e8e9f8f3c77d4/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions%2Fatom.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions%2Fatom.rs?ref=b7c45fba57224a013fbc926abd2e8e9f8f3c77d4", "patch": "@@ -191,19 +191,8 @@ fn array_expr(p: &mut Parser) -> CompletedMarker {\n \n         // test array_attrs\n         // const A: &[i64] = &[1, #[cfg(test)] 2];\n-        let m = p.start();\n-        let has_attrs = p.at(T![#]);\n-        attributes::outer_attributes(p);\n-\n-        let cm = expr(p).0;\n-\n-        match (has_attrs, cm) {\n-            (true, Some(cm)) => {\n-                let kind = cm.kind();\n-                cm.undo_completion(p).abandon(p);\n-                m.complete(p, kind);\n-            }\n-            _ => m.abandon(p),\n+        if !expr_with_attrs(p) {\n+            break;\n         }\n \n         if n_exprs == 1 && p.eat(T![;]) {"}, {"sha": "2237eb4130950acd245c9484789d366019cb6b6e", "filename": "crates/ra_syntax/test_data/parser/err/0022_bad_exprs.txt", "status": "modified", "additions": 14, "deletions": 10, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/b7c45fba57224a013fbc926abd2e8e9f8f3c77d4/crates%2Fra_syntax%2Ftest_data%2Fparser%2Ferr%2F0022_bad_exprs.txt", "raw_url": "https://github.com/rust-lang/rust/raw/b7c45fba57224a013fbc926abd2e8e9f8f3c77d4/crates%2Fra_syntax%2Ftest_data%2Fparser%2Ferr%2F0022_bad_exprs.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Ftest_data%2Fparser%2Ferr%2F0022_bad_exprs.txt?ref=b7c45fba57224a013fbc926abd2e8e9f8f3c77d4", "patch": "@@ -12,8 +12,8 @@ SOURCE_FILE@[0; 112)\n       BLOCK@[7; 33)\n         L_CURLY@[7; 8) \"{\"\n         WHITESPACE@[8; 9) \" \"\n-        EXPR_STMT@[9; 26)\n-          ARRAY_EXPR@[9; 26)\n+        EXPR_STMT@[9; 17)\n+          ARRAY_EXPR@[9; 17)\n             L_BRACK@[9; 10) \"[\"\n             LITERAL@[10; 11)\n               INT_NUMBER@[10; 11) \"1\"\n@@ -25,10 +25,13 @@ SOURCE_FILE@[0; 112)\n             WHITESPACE@[15; 16) \" \"\n             ERROR@[16; 17)\n               AT@[16; 17) \"@\"\n+        EXPR_STMT@[17; 18)\n+          ERROR@[17; 18)\n             COMMA@[17; 18) \",\"\n-            WHITESPACE@[18; 19) \" \"\n-            ERROR@[19; 25)\n-              STRUCT_KW@[19; 25) \"struct\"\n+        WHITESPACE@[18; 19) \" \"\n+        STRUCT_DEF@[19; 26)\n+          STRUCT_KW@[19; 25) \"struct\"\n+          ERROR@[25; 26)\n             COMMA@[25; 26) \",\"\n         WHITESPACE@[26; 27) \" \"\n         LET_STMT@[27; 31)\n@@ -148,11 +151,12 @@ SOURCE_FILE@[0; 112)\n         R_CURLY@[110; 111) \"}\"\n   WHITESPACE@[111; 112) \"\\n\"\n error 16: expected expression\n-error 19: expected expression\n-error 26: expected expression\n-error 26: expected COMMA\n-error 26: expected R_BRACK\n-error 26: expected SEMI\n+error 17: expected R_BRACK\n+error 17: expected SEMI\n+error 17: expected expression\n+error 18: expected SEMI\n+error 25: expected a name\n+error 26: expected `;`, `{`, or `(`\n error 30: expected pattern\n error 31: expected SEMI\n error 52: expected expression"}]}