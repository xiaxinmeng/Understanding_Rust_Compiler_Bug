{"sha": "66c1309446236985da64b56994ceca1127ca514e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY2YzEzMDk0NDYyMzY5ODVkYTY0YjU2OTk0Y2VjYTExMjdjYTUxNGU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-11-14T09:11:25Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-11-14T09:11:25Z"}, "message": "Auto merge of #78959 - petrochenkov:likeuefi, r=nagisa\n\nrustc_target: Mark UEFI targets as `is_like_windows`/`is_like_msvc`\n\nAnd document what `is_like_windows` and `is_like_msvc` actually mean in more detail.\n\nAddresses FIXMEs left from https://github.com/rust-lang/rust/pull/71030.\nr? `@nagisa`", "tree": {"sha": "2606c452515adaac43167b8c77dfab4ae5407b70", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2606c452515adaac43167b8c77dfab4ae5407b70"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/66c1309446236985da64b56994ceca1127ca514e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/66c1309446236985da64b56994ceca1127ca514e", "html_url": "https://github.com/rust-lang/rust/commit/66c1309446236985da64b56994ceca1127ca514e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/66c1309446236985da64b56994ceca1127ca514e/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1a25580c6c6640a47067743d5c36888fac822a12", "url": "https://api.github.com/repos/rust-lang/rust/commits/1a25580c6c6640a47067743d5c36888fac822a12", "html_url": "https://github.com/rust-lang/rust/commit/1a25580c6c6640a47067743d5c36888fac822a12"}, {"sha": "04d41e1f4083307b1434d305899da739b21e5155", "url": "https://api.github.com/repos/rust-lang/rust/commits/04d41e1f4083307b1434d305899da739b21e5155", "html_url": "https://github.com/rust-lang/rust/commit/04d41e1f4083307b1434d305899da739b21e5155"}], "stats": {"total": 36, "additions": 21, "deletions": 15}, "files": [{"sha": "6237a4c0020ebb58e5313bdcaf7d219ae17ddb50", "filename": "compiler/rustc_codegen_llvm/src/back/write.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/66c1309446236985da64b56994ceca1127ca514e/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/66c1309446236985da64b56994ceca1127ca514e/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Fwrite.rs?ref=66c1309446236985da64b56994ceca1127ca514e", "patch": "@@ -925,9 +925,7 @@ unsafe fn embed_bitcode(\n         || cgcx.opts.target_triple.triple().starts_with(\"asmjs\")\n     {\n         // nothing to do here\n-    } else if cgcx.opts.target_triple.triple().contains(\"windows\")\n-        || cgcx.opts.target_triple.triple().contains(\"uefi\")\n-    {\n+    } else if cgcx.is_pe_coff {\n         let asm = \"\n             .section .llvmbc,\\\"n\\\"\n             .section .llvmcmd,\\\"n\\\""}, {"sha": "7f2bb7b5bcdaffd7b4189f0f8c1699d6f326f87e", "filename": "compiler/rustc_codegen_ssa/src/back/write.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/66c1309446236985da64b56994ceca1127ca514e/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/66c1309446236985da64b56994ceca1127ca514e/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fwrite.rs?ref=66c1309446236985da64b56994ceca1127ca514e", "patch": "@@ -307,6 +307,7 @@ pub struct CodegenContext<B: WriteBackendMethods> {\n     pub allocator_module_config: Arc<ModuleConfig>,\n     pub tm_factory: TargetMachineFactory<B>,\n     pub msvc_imps_needed: bool,\n+    pub is_pe_coff: bool,\n     pub target_pointer_width: u32,\n     pub target_arch: String,\n     pub debuginfo: config::DebugInfo,\n@@ -1022,6 +1023,7 @@ fn start_executing_work<B: ExtraBackendMethods>(\n         tm_factory: TargetMachineFactory(backend.target_machine_factory(tcx.sess, ol)),\n         total_cgus,\n         msvc_imps_needed: msvc_imps_needed(tcx),\n+        is_pe_coff: tcx.sess.target.is_like_windows,\n         target_pointer_width: tcx.sess.target.pointer_width,\n         target_arch: tcx.sess.target.arch.clone(),\n         debuginfo: tcx.sess.opts.debuginfo,"}, {"sha": "b37783c5820bf59cb8fab1b3c0f3ba91dcff0e32", "filename": "compiler/rustc_target/src/spec/mod.rs", "status": "modified", "additions": 16, "deletions": 3, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/66c1309446236985da64b56994ceca1127ca514e/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/66c1309446236985da64b56994ceca1127ca514e/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs?ref=66c1309446236985da64b56994ceca1127ca514e", "patch": "@@ -822,10 +822,23 @@ pub struct TargetOptions {\n     /// Only useful for compiling against Illumos/Solaris,\n     /// as they have a different set of linker flags. Defaults to false.\n     pub is_like_solaris: bool,\n-    /// Whether the target toolchain is like Windows'. Only useful for compiling against Windows,\n-    /// only really used for figuring out how to find libraries, since Windows uses its own\n-    /// library naming convention. Defaults to false.\n+    /// Whether the target is like Windows.\n+    /// This is a combination of several more specific properties represented as a single flag:\n+    ///   - The target uses a Windows ABI,\n+    ///   - uses PE/COFF as a format for object code,\n+    ///   - uses Windows-style dllexport/dllimport for shared libraries,\n+    ///   - uses import libraries and .def files for symbol exports,\n+    ///   - executables support setting a subsystem.\n     pub is_like_windows: bool,\n+    /// Whether the target is like MSVC.\n+    /// This is a combination of several more specific properties represented as a single flag:\n+    ///   - The target has all the properties from `is_like_windows`\n+    ///     (for in-tree targets \"is_like_msvc \u21d2 is_like_windows\" is ensured by a unit test),\n+    ///   - has some MSVC-specific Windows ABI properties,\n+    ///   - uses a link.exe-like linker,\n+    ///   - uses CodeView/PDB for debuginfo and natvis for its visualization,\n+    ///   - uses SEH-based unwinding,\n+    ///   - supports control flow guard mechanism.\n     pub is_like_msvc: bool,\n     /// Whether the target toolchain is like Emscripten's. Only useful for compiling with\n     /// Emscripten toolchain."}, {"sha": "9ec8467e0ac449507f9aa80e2d97b3ca7a8ae757", "filename": "compiler/rustc_target/src/spec/tests/tests_impl.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/66c1309446236985da64b56994ceca1127ca514e/compiler%2Frustc_target%2Fsrc%2Fspec%2Ftests%2Ftests_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/66c1309446236985da64b56994ceca1127ca514e/compiler%2Frustc_target%2Fsrc%2Fspec%2Ftests%2Ftests_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Ftests%2Ftests_impl.rs?ref=66c1309446236985da64b56994ceca1127ca514e", "patch": "@@ -8,6 +8,7 @@ pub(super) fn test_target(target: Target) {\n \n impl Target {\n     fn check_consistency(&self) {\n+        assert!(self.is_like_windows || !self.is_like_msvc);\n         // Check that LLD with the given flavor is treated identically to the linker it emulates.\n         // If your target really needs to deviate from the rules below, except it and document the\n         // reasons.\n@@ -16,6 +17,7 @@ impl Target {\n                 || self.linker_flavor == LinkerFlavor::Lld(LldFlavor::Link),\n             self.lld_flavor == LldFlavor::Link,\n         );\n+        assert_eq!(self.is_like_msvc, self.lld_flavor == LldFlavor::Link);\n         for args in &[\n             &self.pre_link_args,\n             &self.late_link_args,"}, {"sha": "322b6f530e9fdc9cd87a5e6d03bba1dcf98327d4", "filename": "compiler/rustc_target/src/spec/uefi_msvc_base.rs", "status": "modified", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/66c1309446236985da64b56994ceca1127ca514e/compiler%2Frustc_target%2Fsrc%2Fspec%2Fuefi_msvc_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/66c1309446236985da64b56994ceca1127ca514e/compiler%2Frustc_target%2Fsrc%2Fspec%2Fuefi_msvc_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fuefi_msvc_base.rs?ref=66c1309446236985da64b56994ceca1127ca514e", "patch": "@@ -46,15 +46,6 @@ pub fn opts() -> TargetOptions {\n         stack_probes: true,\n         singlethread: true,\n         linker: Some(\"rust-lld\".to_string()),\n-        // FIXME: This should likely be `true` inherited from `msvc_base`\n-        // because UEFI follows Windows ABI and uses PE/COFF.\n-        // The `false` is probably causing ABI bugs right now.\n-        is_like_windows: false,\n-        // FIXME: This should likely be `true` inherited from `msvc_base`\n-        // because UEFI follows Windows ABI and uses PE/COFF.\n-        // The `false` is probably causing ABI bugs right now.\n-        is_like_msvc: false,\n-\n         ..base\n     }\n }"}]}