{"sha": "388bcc1cb086c567f17a4933bfb1d3f14eb19fb7", "node_id": "C_kwDOAAsO6NoAKDM4OGJjYzFjYjA4NmM1NjdmMTdhNDkzM2JmYjFkM2YxNGViMTlmYjc", "commit": {"author": {"name": "Fabian Wolff", "email": "fabian.wolff@alumni.ethz.ch", "date": "2021-10-04T19:15:02Z"}, "committer": {"name": "Fabian Wolff", "email": "fabian.wolff@alumni.ethz.ch", "date": "2021-10-04T19:15:02Z"}, "message": "Fix suggestion to borrow when casting from pointer to reference", "tree": {"sha": "d9c2793c032205ab5e9862a8734f55c41ba9d772", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d9c2793c032205ab5e9862a8734f55c41ba9d772"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7", "html_url": "https://github.com/rust-lang/rust/commit/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/comments", "author": {"login": "FabianWolff", "id": 16052130, "node_id": "MDQ6VXNlcjE2MDUyMTMw", "avatar_url": "https://avatars.githubusercontent.com/u/16052130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/FabianWolff", "html_url": "https://github.com/FabianWolff", "followers_url": "https://api.github.com/users/FabianWolff/followers", "following_url": "https://api.github.com/users/FabianWolff/following{/other_user}", "gists_url": "https://api.github.com/users/FabianWolff/gists{/gist_id}", "starred_url": "https://api.github.com/users/FabianWolff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/FabianWolff/subscriptions", "organizations_url": "https://api.github.com/users/FabianWolff/orgs", "repos_url": "https://api.github.com/users/FabianWolff/repos", "events_url": "https://api.github.com/users/FabianWolff/events{/privacy}", "received_events_url": "https://api.github.com/users/FabianWolff/received_events", "type": "User", "site_admin": false}, "committer": {"login": "FabianWolff", "id": 16052130, "node_id": "MDQ6VXNlcjE2MDUyMTMw", "avatar_url": "https://avatars.githubusercontent.com/u/16052130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/FabianWolff", "html_url": "https://github.com/FabianWolff", "followers_url": "https://api.github.com/users/FabianWolff/followers", "following_url": "https://api.github.com/users/FabianWolff/following{/other_user}", "gists_url": "https://api.github.com/users/FabianWolff/gists{/gist_id}", "starred_url": "https://api.github.com/users/FabianWolff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/FabianWolff/subscriptions", "organizations_url": "https://api.github.com/users/FabianWolff/orgs", "repos_url": "https://api.github.com/users/FabianWolff/repos", "events_url": "https://api.github.com/users/FabianWolff/events{/privacy}", "received_events_url": "https://api.github.com/users/FabianWolff/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "edebf77e0090195bf80c0d8cda821e1bf9d03053", "url": "https://api.github.com/repos/rust-lang/rust/commits/edebf77e0090195bf80c0d8cda821e1bf9d03053", "html_url": "https://github.com/rust-lang/rust/commit/edebf77e0090195bf80c0d8cda821e1bf9d03053"}], "stats": {"total": 94, "additions": 80, "deletions": 14}, "files": [{"sha": "fe0de61ab89e2f254209f232c6a2b135ad60f385", "filename": "compiler/rustc_typeck/src/check/cast.rs", "status": "modified", "additions": 36, "deletions": 8, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcast.rs?ref=388bcc1cb086c567f17a4933bfb1d3f14eb19fb7", "patch": "@@ -351,7 +351,7 @@ impl<'a, 'tcx> CastCheck<'tcx> {\n                 );\n                 let mut sugg = None;\n                 let mut sugg_mutref = false;\n-                if let ty::Ref(reg, _, mutbl) = *self.cast_ty.kind() {\n+                if let ty::Ref(reg, cast_ty, mutbl) = *self.cast_ty.kind() {\n                     if let ty::RawPtr(TypeAndMut { ty: expr_ty, .. }) = *self.expr_ty.kind() {\n                         if fcx\n                             .try_coerce(\n@@ -366,7 +366,7 @@ impl<'a, 'tcx> CastCheck<'tcx> {\n                             )\n                             .is_ok()\n                         {\n-                            sugg = Some(format!(\"&{}*\", mutbl.prefix_str()));\n+                            sugg = Some((format!(\"&{}*\", mutbl.prefix_str()), cast_ty == expr_ty));\n                         }\n                     } else if let ty::Ref(expr_reg, expr_ty, expr_mutbl) = *self.expr_ty.kind() {\n                         if expr_mutbl == Mutability::Not\n@@ -400,7 +400,7 @@ impl<'a, 'tcx> CastCheck<'tcx> {\n                             )\n                             .is_ok()\n                     {\n-                        sugg = Some(format!(\"&{}\", mutbl.prefix_str()));\n+                        sugg = Some((format!(\"&{}\", mutbl.prefix_str()), false));\n                     }\n                 } else if let ty::RawPtr(TypeAndMut { mutbl, .. }) = *self.cast_ty.kind() {\n                     if fcx\n@@ -416,19 +416,47 @@ impl<'a, 'tcx> CastCheck<'tcx> {\n                         )\n                         .is_ok()\n                     {\n-                        sugg = Some(format!(\"&{}\", mutbl.prefix_str()));\n+                        sugg = Some((format!(\"&{}\", mutbl.prefix_str()), false));\n                     }\n                 }\n                 if sugg_mutref {\n                     err.span_label(self.span, \"invalid cast\");\n                     err.span_note(self.expr.span, \"this reference is immutable\");\n                     err.span_note(self.cast_span, \"trying to cast to a mutable reference type\");\n-                } else if let Some(sugg) = sugg {\n+                } else if let Some((sugg, remove_cast)) = sugg {\n                     err.span_label(self.span, \"invalid cast\");\n-                    err.span_suggestion_verbose(\n-                        self.expr.span.shrink_to_lo(),\n+\n+                    let has_parens = fcx\n+                        .tcx\n+                        .sess\n+                        .source_map()\n+                        .span_to_snippet(self.expr.span)\n+                        .map_or(false, |snip| snip.starts_with(\"(\"));\n+\n+                    // Very crude check to see whether the expression must be wrapped\n+                    // in parentheses for the suggestion to work (issue #89497).\n+                    // Can/should be extended in the future.\n+                    let needs_parens = !has_parens\n+                        && match self.expr.kind {\n+                            hir::ExprKind::Cast(..) => true,\n+                            _ => false,\n+                        };\n+\n+                    let mut suggestion = vec![(self.expr.span.shrink_to_lo(), sugg)];\n+                    if needs_parens {\n+                        suggestion[0].1 += \"(\";\n+                        suggestion.push((self.expr.span.shrink_to_hi(), \")\".to_string()));\n+                    }\n+                    if remove_cast {\n+                        suggestion.push((\n+                            self.expr.span.shrink_to_hi().to(self.cast_span),\n+                            String::new(),\n+                        ));\n+                    }\n+\n+                    err.multipart_suggestion_verbose(\n                         \"consider borrowing the value\",\n-                        sugg,\n+                        suggestion,\n                         Applicability::MachineApplicable,\n                     );\n                 } else if !matches!("}, {"sha": "04c10a5f79ed4d580244dfce4f031e3279100fe8", "filename": "src/test/ui/cast/issue-89497.fixed", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/src%2Ftest%2Fui%2Fcast%2Fissue-89497.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/src%2Ftest%2Fui%2Fcast%2Fissue-89497.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcast%2Fissue-89497.fixed?ref=388bcc1cb086c567f17a4933bfb1d3f14eb19fb7", "patch": "@@ -0,0 +1,10 @@\n+// Regression test for issue #89497.\n+\n+// run-rustfix\n+\n+fn main() {\n+    let pointer: usize = &1_i32 as *const i32 as usize;\n+    let _reference: &'static i32 = unsafe { &*(pointer as *const i32) };\n+    //~^ ERROR: non-primitive cast\n+    //~| HELP: consider borrowing the value\n+}"}, {"sha": "76301b704c81c08b8b81807152d09a98e99c618d", "filename": "src/test/ui/cast/issue-89497.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/src%2Ftest%2Fui%2Fcast%2Fissue-89497.rs", "raw_url": "https://github.com/rust-lang/rust/raw/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/src%2Ftest%2Fui%2Fcast%2Fissue-89497.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcast%2Fissue-89497.rs?ref=388bcc1cb086c567f17a4933bfb1d3f14eb19fb7", "patch": "@@ -0,0 +1,10 @@\n+// Regression test for issue #89497.\n+\n+// run-rustfix\n+\n+fn main() {\n+    let pointer: usize = &1_i32 as *const i32 as usize;\n+    let _reference: &'static i32 = unsafe { pointer as *const i32 as &'static i32 };\n+    //~^ ERROR: non-primitive cast\n+    //~| HELP: consider borrowing the value\n+}"}, {"sha": "3726f8a41015ec540f014fba07e4c24e0bc5e491", "filename": "src/test/ui/cast/issue-89497.stderr", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/src%2Ftest%2Fui%2Fcast%2Fissue-89497.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/src%2Ftest%2Fui%2Fcast%2Fissue-89497.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcast%2Fissue-89497.stderr?ref=388bcc1cb086c567f17a4933bfb1d3f14eb19fb7", "patch": "@@ -0,0 +1,15 @@\n+error[E0605]: non-primitive cast: `*const i32` as `&'static i32`\n+  --> $DIR/issue-89497.rs:7:45\n+   |\n+LL |     let _reference: &'static i32 = unsafe { pointer as *const i32 as &'static i32 };\n+   |                                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ invalid cast\n+   |\n+help: consider borrowing the value\n+   |\n+LL -     let _reference: &'static i32 = unsafe { pointer as *const i32 as &'static i32 };\n+LL +     let _reference: &'static i32 = unsafe { &*(pointer as *const i32) };\n+   | \n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0605`."}, {"sha": "d082b6c10cc2a5ffa41360809d104496ebc990be", "filename": "src/test/ui/error-codes/E0605.stderr", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/src%2Ftest%2Fui%2Ferror-codes%2FE0605.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/src%2Ftest%2Fui%2Ferror-codes%2FE0605.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferror-codes%2FE0605.stderr?ref=388bcc1cb086c567f17a4933bfb1d3f14eb19fb7", "patch": "@@ -12,8 +12,9 @@ LL |     v as &u8;\n    |\n help: consider borrowing the value\n    |\n-LL |     &*v as &u8;\n-   |     ++\n+LL -     v as &u8;\n+LL +     &*v;\n+   | \n \n error: aborting due to 2 previous errors\n "}, {"sha": "7616f987d7312803c1813a4e19a03528248c5079", "filename": "src/test/ui/issues/issue-2995.stderr", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/src%2Ftest%2Fui%2Fissues%2Fissue-2995.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/src%2Ftest%2Fui%2Fissues%2Fissue-2995.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-2995.stderr?ref=388bcc1cb086c567f17a4933bfb1d3f14eb19fb7", "patch": "@@ -6,8 +6,9 @@ LL |     let _q: &isize = p as &isize;\n    |\n help: consider borrowing the value\n    |\n-LL |     let _q: &isize = &*p as &isize;\n-   |                      ++\n+LL -     let _q: &isize = p as &isize;\n+LL +     let _q: &isize = &*p;\n+   | \n \n error: aborting due to previous error\n "}, {"sha": "7f91d5ed42ce4d6c446585c160b6af6ab8871ed1", "filename": "src/test/ui/mismatched_types/cast-rfc0401.stderr", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/src%2Ftest%2Fui%2Fmismatched_types%2Fcast-rfc0401.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/388bcc1cb086c567f17a4933bfb1d3f14eb19fb7/src%2Ftest%2Fui%2Fmismatched_types%2Fcast-rfc0401.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fcast-rfc0401.stderr?ref=388bcc1cb086c567f17a4933bfb1d3f14eb19fb7", "patch": "@@ -28,8 +28,9 @@ LL |     let _ = v as &u8;\n    |\n help: consider borrowing the value\n    |\n-LL |     let _ = &*v as &u8;\n-   |             ++\n+LL -     let _ = v as &u8;\n+LL +     let _ = &*v;\n+   | \n \n error[E0605]: non-primitive cast: `*const u8` as `E`\n   --> $DIR/cast-rfc0401.rs:30:13"}]}