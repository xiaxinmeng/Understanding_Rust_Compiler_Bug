{"sha": "473eaa42e9365c47d129f72693b5d163a20cf369", "node_id": "C_kwDOAAsO6NoAKDQ3M2VhYTQyZTkzNjVjNDdkMTI5ZjcyNjkzYjVkMTYzYTIwY2YzNjk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-11-03T11:48:52Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-11-03T11:48:52Z"}, "message": "Auto merge of #90517 - willcrichton:example-analyzer, r=jyn514\n\nFix URL for scrape-examples.js in rustdoc page template\n\nAlso adds line numbers to URLs in the \"additional examples\" section of rustdoc.\n\nr? `@jyn514`", "tree": {"sha": "fc48e84297788bda8f620ca341f3fe9b08755fcf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fc48e84297788bda8f620ca341f3fe9b08755fcf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/473eaa42e9365c47d129f72693b5d163a20cf369", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/473eaa42e9365c47d129f72693b5d163a20cf369", "html_url": "https://github.com/rust-lang/rust/commit/473eaa42e9365c47d129f72693b5d163a20cf369", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/473eaa42e9365c47d129f72693b5d163a20cf369/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3831aaa13c740e20a97c5aa4b8c760da30bff726", "url": "https://api.github.com/repos/rust-lang/rust/commits/3831aaa13c740e20a97c5aa4b8c760da30bff726", "html_url": "https://github.com/rust-lang/rust/commit/3831aaa13c740e20a97c5aa4b8c760da30bff726"}, {"sha": "ce943d26f8f1449a40c70a48ead48e351fd1b128", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce943d26f8f1449a40c70a48ead48e351fd1b128", "html_url": "https://github.com/rust-lang/rust/commit/ce943d26f8f1449a40c70a48ead48e351fd1b128"}], "stats": {"total": 39, "additions": 23, "deletions": 16}, "files": [{"sha": "25fef114d95fd8bc67cb857ff9f3670856a4f41d", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 20, "deletions": 13, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/473eaa42e9365c47d129f72693b5d163a20cf369/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/473eaa42e9365c47d129f72693b5d163a20cf369/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=473eaa42e9365c47d129f72693b5d163a20cf369", "patch": "@@ -76,7 +76,7 @@ use crate::html::format::{\n use crate::html::highlight;\n use crate::html::markdown::{HeadingOffset, Markdown, MarkdownHtml, MarkdownSummaryLine};\n use crate::html::sources;\n-use crate::scrape_examples::CallData;\n+use crate::scrape_examples::{CallData, CallLocation};\n use crate::try_none;\n \n /// A pair of name and its optional document.\n@@ -2594,6 +2594,21 @@ fn render_call_locations(w: &mut Buffer, cx: &Context<'_>, item: &clean::Item) {\n         id = id\n     );\n \n+    // Create a URL to a particular location in a reverse-dependency's source file\n+    let link_to_loc = |call_data: &CallData, loc: &CallLocation| -> (String, String) {\n+        let (line_lo, line_hi) = loc.call_expr.line_span;\n+        let (anchor, title) = if line_lo == line_hi {\n+            ((line_lo + 1).to_string(), format!(\"line {}\", line_lo + 1))\n+        } else {\n+            (\n+                format!(\"{}-{}\", line_lo + 1, line_hi + 1),\n+                format!(\"lines {}-{}\", line_lo + 1, line_hi + 1),\n+            )\n+        };\n+        let url = format!(\"{}{}#{}\", cx.root_path(), call_data.url, anchor);\n+        (url, title)\n+    };\n+\n     // Generate the HTML for a single example, being the title and code block\n     let write_example = |w: &mut Buffer, (path, call_data): (&PathBuf, &CallData)| -> bool {\n         let contents = match fs::read_to_string(&path) {\n@@ -2631,15 +2646,7 @@ fn render_call_locations(w: &mut Buffer, cx: &Context<'_>, item: &clean::Item) {\n                 let (line_lo, line_hi) = loc.call_expr.line_span;\n                 let byte_range = (byte_lo - byte_min, byte_hi - byte_min);\n                 let line_range = (line_lo - line_min, line_hi - line_min);\n-                let (anchor, line_title) = if line_lo == line_hi {\n-                    (format!(\"{}\", line_lo + 1), format!(\"line {}\", line_lo + 1))\n-                } else {\n-                    (\n-                        format!(\"{}-{}\", line_lo + 1, line_hi + 1),\n-                        format!(\"lines {}-{}\", line_lo + 1, line_hi + 1),\n-                    )\n-                };\n-                let line_url = format!(\"{}{}#{}\", cx.root_path(), call_data.url, anchor);\n+                let (line_url, line_title) = link_to_loc(call_data, loc);\n \n                 (byte_range, (line_range, line_url, line_title))\n             })\n@@ -2768,11 +2775,11 @@ fn render_call_locations(w: &mut Buffer, cx: &Context<'_>, item: &clean::Item) {\n         if it.peek().is_some() {\n             write!(w, r#\"<div class=\"example-links\">Additional examples can be found in:<br><ul>\"#);\n             it.for_each(|(_, call_data)| {\n+                let (url, _) = link_to_loc(&call_data, &call_data.locations[0]);\n                 write!(\n                     w,\n-                    r#\"<li><a href=\"{root}{url}\">{name}</a></li>\"#,\n-                    root = cx.root_path(),\n-                    url = call_data.url,\n+                    r#\"<li><a href=\"{url}\">{name}</a></li>\"#,\n+                    url = url,\n                     name = call_data.display_name\n                 );\n             });"}, {"sha": "9fafea6914524ad3f8cb6ab503f179a5fbf797d6", "filename": "src/librustdoc/html/templates/page.html", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/473eaa42e9365c47d129f72693b5d163a20cf369/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "raw_url": "https://github.com/rust-lang/rust/raw/473eaa42e9365c47d129f72693b5d163a20cf369/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html?ref=473eaa42e9365c47d129f72693b5d163a20cf369", "patch": "@@ -108,12 +108,12 @@\n          data-search-js=\"{{static_root_path | safe}}search{{page.resource_suffix}}.js\"> {#- -#}\n     </div>\n     <script src=\"{{static_root_path | safe}}main{{page.resource_suffix}}.js\"></script> {#- -#}\n-    {%- if layout.scrape_examples_extension -%}\n-    <script src=\"{{static_root_path | safe}}scrape-examples{{page.resource_suffix}}.js\"></script> {#- -#}\n-    {%- endif -%}\n     {%- for script in page.static_extra_scripts -%}\n     <script src=\"{{static_root_path | safe}}{{script}}.js\"></script> {#- -#}\n     {% endfor %}\n+    {%- if layout.scrape_examples_extension -%}\n+    <script src=\"{{page.root_path | safe}}scrape-examples{{page.resource_suffix}}.js\"></script> {#- -#}\n+    {%- endif -%}\n     {%- for script in page.extra_scripts -%}\n     <script src=\"{{page.root_path | safe}}{{script}}.js\"></script> {#- -#}\n     {% endfor %}"}]}