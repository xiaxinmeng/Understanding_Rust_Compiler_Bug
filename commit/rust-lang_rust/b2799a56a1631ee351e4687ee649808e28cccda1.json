{"sha": "b2799a56a1631ee351e4687ee649808e28cccda1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIyNzk5YTU2YTE2MzFlZTM1MWU0Njg3ZWU2NDk4MDhlMjhjY2NkYTE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-09-01T09:53:28Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-09-01T09:53:28Z"}, "message": "Auto merge of #35755 - SimonSapin:char_convert, r=alexcrichton\n\nImplement std::convert traits for char\n\nThis is motivated by avoiding the `as` operator, which sometimes silently truncates, and instead use conversions that are explicitly lossless and infallible.\n\nI\u2019m less certain that `From<u8> for char` should be implemented: while it matches an existing behavior of `as`, it\u2019s not necessarily the right thing to use for non-ASCII bytes. It effectively decodes bytes as ISO/IEC 8859-1 (since Unicode designed its first 256 code points to be compatible with that encoding), but that is not apparent in the API name.", "tree": {"sha": "ee8fd765766cc38f38e8dd02782412c1d2ee189d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ee8fd765766cc38f38e8dd02782412c1d2ee189d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b2799a56a1631ee351e4687ee649808e28cccda1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b2799a56a1631ee351e4687ee649808e28cccda1", "html_url": "https://github.com/rust-lang/rust/commit/b2799a56a1631ee351e4687ee649808e28cccda1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b2799a56a1631ee351e4687ee649808e28cccda1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3135b7877a66e72ac4833588eb8654aa155876e8", "url": "https://api.github.com/repos/rust-lang/rust/commits/3135b7877a66e72ac4833588eb8654aa155876e8", "html_url": "https://github.com/rust-lang/rust/commit/3135b7877a66e72ac4833588eb8654aa155876e8"}, {"sha": "f040208d533e1d6d9ee0e0408ee74e26e14d1284", "url": "https://api.github.com/repos/rust-lang/rust/commits/f040208d533e1d6d9ee0e0408ee74e26e14d1284", "html_url": "https://github.com/rust-lang/rust/commit/f040208d533e1d6d9ee0e0408ee74e26e14d1284"}], "stats": {"total": 97, "additions": 91, "deletions": 6}, "files": [{"sha": "ad492c81bd38ac2d1e4eb8dcb7289c835bb4367d", "filename": "src/libcore/char.rs", "status": "modified", "additions": 63, "deletions": 6, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/b2799a56a1631ee351e4687ee649808e28cccda1/src%2Flibcore%2Fchar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2799a56a1631ee351e4687ee649808e28cccda1/src%2Flibcore%2Fchar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fchar.rs?ref=b2799a56a1631ee351e4687ee649808e28cccda1", "patch": "@@ -16,6 +16,8 @@\n #![stable(feature = \"core_char\", since = \"1.2.0\")]\n \n use char_private::is_printable;\n+use convert::TryFrom;\n+use fmt;\n use iter::FusedIterator;\n use mem::transmute;\n \n@@ -122,12 +124,7 @@ pub const MAX: char = '\\u{10ffff}';\n #[inline]\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n pub fn from_u32(i: u32) -> Option<char> {\n-    // catch out-of-bounds and surrogates\n-    if (i > MAX as u32) || (i >= 0xD800 && i <= 0xDFFF) {\n-        None\n-    } else {\n-        Some(unsafe { from_u32_unchecked(i) })\n-    }\n+    char::try_from(i).ok()\n }\n \n /// Converts a `u32` to a `char`, ignoring validity.\n@@ -175,6 +172,66 @@ pub unsafe fn from_u32_unchecked(i: u32) -> char {\n     transmute(i)\n }\n \n+#[stable(feature = \"char_convert\", since = \"1.13.0\")]\n+impl From<char> for u32 {\n+    #[inline]\n+    fn from(c: char) -> Self {\n+        c as u32\n+    }\n+}\n+\n+/// Maps a byte in 0x00...0xFF to a `char` whose code point has the same value, in U+0000 to U+00FF.\n+///\n+/// Unicode is designed such that this effectively decodes bytes\n+/// with the character encoding that IANA calls ISO-8859-1.\n+/// This encoding is compatible with ASCII.\n+///\n+/// Note that this is different from ISO/IEC 8859-1 a.k.a. ISO 8859-1 (with one less hypen),\n+/// which leaves some \"blanks\", byte values that are not assigned to any character.\n+/// ISO-8859-1 (the IANA one) assigns them to the C0 and C1 control codes.\n+///\n+/// Note that this is *also* different from Windows-1252 a.k.a. code page 1252,\n+/// which is a superset ISO/IEC 8859-1 that assigns some (not all!) blanks\n+/// to punctuation and various Latin characters.\n+///\n+/// To confuse things further, [on the Web](https://encoding.spec.whatwg.org/)\n+/// `ascii`, `iso-8859-1`, and `windows-1252` are all aliases\n+/// for a superset of Windows-1252 that fills the remaining blanks with corresponding\n+/// C0 and C1 control codes.\n+#[stable(feature = \"char_convert\", since = \"1.13.0\")]\n+impl From<u8> for char {\n+    #[inline]\n+    fn from(i: u8) -> Self {\n+        i as char\n+    }\n+}\n+\n+#[unstable(feature = \"try_from\", issue = \"33417\")]\n+impl TryFrom<u32> for char {\n+    type Err = CharTryFromError;\n+\n+    #[inline]\n+    fn try_from(i: u32) -> Result<Self, Self::Err> {\n+        if (i > MAX as u32) || (i >= 0xD800 && i <= 0xDFFF) {\n+            Err(CharTryFromError(()))\n+        } else {\n+            Ok(unsafe { from_u32_unchecked(i) })\n+        }\n+    }\n+}\n+\n+/// The error type returned when a conversion from u32 to char fails.\n+#[unstable(feature = \"try_from\", issue = \"33417\")]\n+#[derive(Copy, Clone, Debug, PartialEq, Eq)]\n+pub struct CharTryFromError(());\n+\n+#[unstable(feature = \"try_from\", issue = \"33417\")]\n+impl fmt::Display for CharTryFromError {\n+    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n+        \"converted integer out of range for `char`\".fmt(f)\n+    }\n+}\n+\n /// Converts a digit in the given radix to a `char`.\n ///\n /// A 'radix' here is sometimes also called a 'base'. A radix of two"}, {"sha": "199437a431eeea6c298947f6640b00c3921d71a1", "filename": "src/libcoretest/char.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/b2799a56a1631ee351e4687ee649808e28cccda1/src%2Flibcoretest%2Fchar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2799a56a1631ee351e4687ee649808e28cccda1/src%2Flibcoretest%2Fchar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcoretest%2Fchar.rs?ref=b2799a56a1631ee351e4687ee649808e28cccda1", "patch": "@@ -9,6 +9,24 @@\n // except according to those terms.\n \n use std::char;\n+use std::convert::TryFrom;\n+\n+#[test]\n+fn test_convert() {\n+    assert_eq!(u32::from('a'), 0x61);\n+    assert_eq!(char::from(b'\\0'), '\\0');\n+    assert_eq!(char::from(b'a'), 'a');\n+    assert_eq!(char::from(b'\\xFF'), '\\u{FF}');\n+    assert_eq!(char::try_from(0_u32), Ok('\\0'));\n+    assert_eq!(char::try_from(0x61_u32), Ok('a'));\n+    assert_eq!(char::try_from(0xD7FF_u32), Ok('\\u{D7FF}'));\n+    assert!(char::try_from(0xD800_u32).is_err());\n+    assert!(char::try_from(0xDFFF_u32).is_err());\n+    assert_eq!(char::try_from(0xE000_u32), Ok('\\u{E000}'));\n+    assert_eq!(char::try_from(0x10FFFF_u32), Ok('\\u{10FFFF}'));\n+    assert!(char::try_from(0x110000_u32).is_err());\n+    assert!(char::try_from(0xFFFF_FFFF_u32).is_err());\n+}\n \n #[test]\n fn test_is_lowercase() {"}, {"sha": "5a0c27d9c609f4cc5b0b09e4081a0707669d0c21", "filename": "src/librustc_unicode/char.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b2799a56a1631ee351e4687ee649808e28cccda1/src%2Flibrustc_unicode%2Fchar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2799a56a1631ee351e4687ee649808e28cccda1/src%2Flibrustc_unicode%2Fchar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_unicode%2Fchar.rs?ref=b2799a56a1631ee351e4687ee649808e28cccda1", "patch": "@@ -40,6 +40,8 @@ pub use core::char::{MAX, from_digit, from_u32, from_u32_unchecked};\n pub use core::char::{EncodeUtf16, EncodeUtf8, EscapeDebug, EscapeDefault, EscapeUnicode};\n \n // unstable reexports\n+#[unstable(feature = \"try_from\", issue = \"33417\")]\n+pub use core::char::CharTryFromError;\n #[unstable(feature = \"decode_utf8\", issue = \"33906\")]\n pub use core::char::{DecodeUtf8, decode_utf8};\n #[unstable(feature = \"unicode\", issue = \"27783\")]"}, {"sha": "65bd717e01a8232df3ff044f1d41ecafc37107f9", "filename": "src/librustc_unicode/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b2799a56a1631ee351e4687ee649808e28cccda1/src%2Flibrustc_unicode%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2799a56a1631ee351e4687ee649808e28cccda1/src%2Flibrustc_unicode%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_unicode%2Flib.rs?ref=b2799a56a1631ee351e4687ee649808e28cccda1", "patch": "@@ -38,6 +38,7 @@\n #![feature(fused)]\n #![feature(lang_items)]\n #![feature(staged_api)]\n+#![feature(try_from)]\n #![feature(unicode)]\n \n mod tables;"}, {"sha": "16290620010035f554d1f7985f0fb551b0b36de3", "filename": "src/libstd/error.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/b2799a56a1631ee351e4687ee649808e28cccda1/src%2Flibstd%2Ferror.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2799a56a1631ee351e4687ee649808e28cccda1/src%2Flibstd%2Ferror.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Ferror.rs?ref=b2799a56a1631ee351e4687ee649808e28cccda1", "patch": "@@ -302,6 +302,13 @@ impl<'a, T: ?Sized + Reflect> Error for cell::BorrowMutError<'a, T> {\n     }\n }\n \n+#[unstable(feature = \"try_from\", issue = \"33417\")]\n+impl Error for char::CharTryFromError {\n+    fn description(&self) -> &str {\n+        \"converted integer out of range for `char`\"\n+    }\n+}\n+\n // copied from any.rs\n impl Error + 'static {\n     /// Returns true if the boxed type is the same as `T`"}]}