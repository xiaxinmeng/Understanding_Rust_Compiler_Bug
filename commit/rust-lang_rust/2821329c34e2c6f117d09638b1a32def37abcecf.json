{"sha": "2821329c34e2c6f117d09638b1a32def37abcecf", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI4MjEzMjljMzRlMmM2ZjExN2QwOTYzOGIxYTMyZGVmMzdhYmNlY2Y=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-05-13T19:36:49Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-05-13T19:36:49Z"}, "message": "Rollup merge of #60176 - matthewjasper:yield-ref-to-local, r=pnkfelix\n\nExplain error when yielding a reference to a local variable\n\nCloses #56508", "tree": {"sha": "9c726a32606027d80729d1633687407d311954b4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9c726a32606027d80729d1633687407d311954b4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2821329c34e2c6f117d09638b1a32def37abcecf", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJc2cdRCRBK7hj4Ov3rIwAAdHIIAC7zXHbC78uHQZXyddyLGD0M\njg84jykFcy5sDPwBeOuF70KinVOcw6pd94SGNajUQ5aNpBnqqy9SQnFgNFhYlkMe\nw/UO4x9Cq+MWdxdCjtXaz9mJ/CVYxVp1RTWq3v6ib6zxMce1OdKPFO9j9hsff/qf\nMWtjQHNPGHJkBEMo9BIhNiKybN0+y77y+J5A0ou6/WCHtfbiKWbdyKcFDkO2Kf0e\nX+Xv1Vx98HBDWmj7v4J0NuEtNb33o94oKhUlm5IX3y+R2odQp6PycClvDJ5Ni4Co\nzfnurHwQidIXz4qDtY2beiMnPtVjeaBgb0lH/Z7ct0edGc3aoe//2sOHuveshPw=\n=Qvps\n-----END PGP SIGNATURE-----\n", "payload": "tree 9c726a32606027d80729d1633687407d311954b4\nparent a9ec99f4201ec33026a468ef1289f98a95b4d71a\nparent d9ea132b7322cebd595598a0639cf6018816d454\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1557776209 +0200\ncommitter GitHub <noreply@github.com> 1557776209 +0200\n\nRollup merge of #60176 - matthewjasper:yield-ref-to-local, r=pnkfelix\n\nExplain error when yielding a reference to a local variable\n\nCloses #56508\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2821329c34e2c6f117d09638b1a32def37abcecf", "html_url": "https://github.com/rust-lang/rust/commit/2821329c34e2c6f117d09638b1a32def37abcecf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2821329c34e2c6f117d09638b1a32def37abcecf/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a9ec99f4201ec33026a468ef1289f98a95b4d71a", "url": "https://api.github.com/repos/rust-lang/rust/commits/a9ec99f4201ec33026a468ef1289f98a95b4d71a", "html_url": "https://github.com/rust-lang/rust/commit/a9ec99f4201ec33026a468ef1289f98a95b4d71a"}, {"sha": "d9ea132b7322cebd595598a0639cf6018816d454", "url": "https://api.github.com/repos/rust-lang/rust/commits/d9ea132b7322cebd595598a0639cf6018816d454", "html_url": "https://github.com/rust-lang/rust/commit/d9ea132b7322cebd595598a0639cf6018816d454"}], "stats": {"total": 133, "additions": 107, "deletions": 26}, "files": [{"sha": "1a1000f0bb41db9eaab73ab76d13ba7f562b213d", "filename": "src/librustc_mir/borrow_check/error_reporting.rs", "status": "modified", "additions": 24, "deletions": 10, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/2821329c34e2c6f117d09638b1a32def37abcecf/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2821329c34e2c6f117d09638b1a32def37abcecf/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs?ref=2821329c34e2c6f117d09638b1a32def37abcecf", "patch": "@@ -826,18 +826,21 @@ impl<'cx, 'gcx, 'tcx> MirBorrowckCtxt<'cx, 'gcx, 'tcx> {\n \n         let borrow_span = borrow_spans.var_or_use();\n         if let BorrowExplanation::MustBeValidFor {\n-            category: ConstraintCategory::Return,\n+            category,\n             span,\n             ref opt_place_desc,\n             from_closure: false,\n             ..\n         } = explanation {\n-            return self.report_cannot_return_reference_to_local(\n+            if let Some(diag) = self.try_report_cannot_return_reference_to_local(\n                 borrow,\n                 borrow_span,\n                 span,\n+                category,\n                 opt_place_desc.as_ref(),\n-            );\n+            ) {\n+                return diag;\n+            }\n         }\n \n         let mut err = self.infcx.tcx.path_does_not_live_long_enough(\n@@ -1015,17 +1018,20 @@ impl<'cx, 'gcx, 'tcx> MirBorrowckCtxt<'cx, 'gcx, 'tcx> {\n         );\n \n         if let BorrowExplanation::MustBeValidFor {\n-            category: ConstraintCategory::Return,\n+            category,\n             span,\n             from_closure: false,\n             ..\n         } = explanation {\n-            return self.report_cannot_return_reference_to_local(\n+            if let Some(diag) = self.try_report_cannot_return_reference_to_local(\n                 borrow,\n                 proper_span,\n                 span,\n+                category,\n                 None,\n-            );\n+            ) {\n+                return diag;\n+            }\n         }\n \n         let tcx = self.infcx.tcx;\n@@ -1064,15 +1070,22 @@ impl<'cx, 'gcx, 'tcx> MirBorrowckCtxt<'cx, 'gcx, 'tcx> {\n         err\n     }\n \n-    fn report_cannot_return_reference_to_local(\n+    fn try_report_cannot_return_reference_to_local(\n         &self,\n         borrow: &BorrowData<'tcx>,\n         borrow_span: Span,\n         return_span: Span,\n+        category: ConstraintCategory,\n         opt_place_desc: Option<&String>,\n-    ) -> DiagnosticBuilder<'cx> {\n+    ) -> Option<DiagnosticBuilder<'cx>> {\n         let tcx = self.infcx.tcx;\n \n+        let return_kind = match category {\n+            ConstraintCategory::Return => \"return\",\n+            ConstraintCategory::Yield => \"yield\",\n+            _ => return None,\n+        };\n+\n         // FIXME use a better heuristic than Spans\n         let reference_desc = if return_span == self.mir.source_info(borrow.reserve_location).span {\n             \"reference to\"\n@@ -1110,7 +1123,7 @@ impl<'cx, 'gcx, 'tcx> MirBorrowckCtxt<'cx, 'gcx, 'tcx> {\n             let local = if let Place::Base(PlaceBase::Local(local)) = *root_place {\n                 local\n             } else {\n-                bug!(\"report_cannot_return_reference_to_local: not a local\")\n+                bug!(\"try_report_cannot_return_reference_to_local: not a local\")\n             };\n             match self.mir.local_kind(local) {\n                 LocalKind::ReturnPointer | LocalKind::Temp => {\n@@ -1131,6 +1144,7 @@ impl<'cx, 'gcx, 'tcx> MirBorrowckCtxt<'cx, 'gcx, 'tcx> {\n \n         let mut err = tcx.cannot_return_reference_to_local(\n             return_span,\n+            return_kind,\n             reference_desc,\n             &place_desc,\n             Origin::Mir,\n@@ -1140,7 +1154,7 @@ impl<'cx, 'gcx, 'tcx> MirBorrowckCtxt<'cx, 'gcx, 'tcx> {\n             err.span_label(borrow_span, note);\n         }\n \n-        err\n+        Some(err)\n     }\n \n     fn report_escaping_closure_capture("}, {"sha": "35efc6195be39709d4bfcdd273afe53e07a838bc", "filename": "src/librustc_mir/borrow_check/nll/explain_borrow/mod.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2821329c34e2c6f117d09638b1a32def37abcecf/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fexplain_borrow%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2821329c34e2c6f117d09638b1a32def37abcecf/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fexplain_borrow%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fexplain_borrow%2Fmod.rs?ref=2821329c34e2c6f117d09638b1a32def37abcecf", "patch": "@@ -310,9 +310,13 @@ impl<'cx, 'gcx, 'tcx> MirBorrowckCtxt<'cx, 'gcx, 'tcx> {\n                             opt_place_desc,\n                         }\n                     } else {\n+                        debug!(\"explain_why_borrow_contains_point: \\\n+                                Could not generate a region name\");\n                         BorrowExplanation::Unexplained\n                     }\n                 } else {\n+                    debug!(\"explain_why_borrow_contains_point: \\\n+                            Could not generate an error region vid\");\n                     BorrowExplanation::Unexplained\n                 }\n             }"}, {"sha": "4ced31593b1ae6cc0264bcdb6bb160eb4c51eb99", "filename": "src/librustc_mir/borrow_check/nll/region_infer/error_reporting/region_name.rs", "status": "modified", "additions": 66, "deletions": 5, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/2821329c34e2c6f117d09638b1a32def37abcecf/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Ferror_reporting%2Fregion_name.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2821329c34e2c6f117d09638b1a32def37abcecf/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Ferror_reporting%2Fregion_name.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Ferror_reporting%2Fregion_name.rs?ref=2821329c34e2c6f117d09638b1a32def37abcecf", "patch": "@@ -34,6 +34,7 @@ crate enum RegionNameSource {\n     MatchedAdtAndSegment(Span),\n     AnonRegionFromUpvar(Span, String),\n     AnonRegionFromOutput(Span, String, String),\n+    AnonRegionFromYieldTy(Span, String),\n }\n \n impl RegionName {\n@@ -48,7 +49,8 @@ impl RegionName {\n             RegionNameSource::MatchedHirTy(..) |\n             RegionNameSource::MatchedAdtAndSegment(..) |\n             RegionNameSource::AnonRegionFromUpvar(..) |\n-            RegionNameSource::AnonRegionFromOutput(..) => false,\n+            RegionNameSource::AnonRegionFromOutput(..) |\n+            RegionNameSource::AnonRegionFromYieldTy(..) => false,\n         }\n     }\n \n@@ -105,6 +107,12 @@ impl RegionName {\n                     format!(\"return type{} is {}\", mir_description, type_name),\n                 );\n             },\n+            RegionNameSource::AnonRegionFromYieldTy(span, type_name) => {\n+                diag.span_label(\n+                    *span,\n+                    format!(\"yield type is {}\", type_name),\n+                );\n+            }\n             RegionNameSource::Static => {},\n         }\n     }\n@@ -170,6 +178,11 @@ impl<'tcx> RegionInferenceContext<'tcx> {\n                 self.give_name_if_anonymous_region_appears_in_output(\n                     infcx, mir, mir_def_id, fr, counter,\n                 )\n+            })\n+            .or_else(|| {\n+                self.give_name_if_anonymous_region_appears_in_yield_ty(\n+                    infcx, mir, mir_def_id, fr, counter,\n+                )\n             });\n \n         debug!(\"give_region_a_name: gave name {:?}\", value);\n@@ -676,10 +689,7 @@ impl<'tcx> RegionInferenceContext<'tcx> {\n             \"give_name_if_anonymous_region_appears_in_output: return_ty = {:?}\",\n             return_ty\n         );\n-        if !infcx\n-            .tcx\n-            .any_free_region_meets(&return_ty, |r| r.to_region_vid() == fr)\n-        {\n+        if !tcx.any_free_region_meets(&return_ty, |r| r.to_region_vid() == fr) {\n             return None;\n         }\n \n@@ -724,6 +734,57 @@ impl<'tcx> RegionInferenceContext<'tcx> {\n         })\n     }\n \n+    fn give_name_if_anonymous_region_appears_in_yield_ty(\n+        &self,\n+        infcx: &InferCtxt<'_, '_, 'tcx>,\n+        mir: &Mir<'tcx>,\n+        mir_def_id: DefId,\n+        fr: RegionVid,\n+        counter: &mut usize,\n+    ) -> Option<RegionName> {\n+        // Note: generators from `async fn` yield `()`, so we don't have to\n+        // worry about them here.\n+        let yield_ty = self.universal_regions.yield_ty?;\n+        debug!(\n+            \"give_name_if_anonymous_region_appears_in_yield_ty: yield_ty = {:?}\",\n+            yield_ty,\n+        );\n+\n+        let tcx = infcx.tcx;\n+\n+        if !tcx.any_free_region_meets(&yield_ty, |r| r.to_region_vid() == fr) {\n+            return None;\n+        }\n+\n+        let mut highlight = RegionHighlightMode::default();\n+        highlight.highlighting_region_vid(fr, *counter);\n+        let type_name = infcx.extract_type_name(&yield_ty, Some(highlight));\n+\n+        let mir_node_id = tcx.hir().as_local_node_id(mir_def_id).expect(\"non-local mir\");\n+\n+        let yield_span = match tcx.hir().get(mir_node_id) {\n+            hir::Node::Expr(hir::Expr {\n+                node: hir::ExprKind::Closure(_, _, _, span, _),\n+                ..\n+            }) => (\n+                tcx.sess.source_map().end_point(*span)\n+            ),\n+            _ => mir.span,\n+        };\n+\n+        debug!(\n+            \"give_name_if_anonymous_region_appears_in_yield_ty: \\\n+             type_name = {:?}, yield_span = {:?}\",\n+            yield_span,\n+            type_name,\n+        );\n+\n+        Some(RegionName {\n+            name: self.synthesize_region_name(counter),\n+            source: RegionNameSource::AnonRegionFromYieldTy(yield_span, type_name),\n+        })\n+    }\n+\n     /// Creates a synthetic region named `'1`, incrementing the\n     /// counter.\n     fn synthesize_region_name(&self, counter: &mut usize) -> InternedString {"}, {"sha": "a5dfb736b819c08762e55271fb496a69da20ad3b", "filename": "src/librustc_mir/util/borrowck_errors.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/2821329c34e2c6f117d09638b1a32def37abcecf/src%2Flibrustc_mir%2Futil%2Fborrowck_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2821329c34e2c6f117d09638b1a32def37abcecf/src%2Flibrustc_mir%2Futil%2Fborrowck_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Fborrowck_errors.rs?ref=2821329c34e2c6f117d09638b1a32def37abcecf", "patch": "@@ -634,6 +634,7 @@ pub trait BorrowckErrors<'cx>: Sized + Copy {\n     fn cannot_return_reference_to_local(\n         self,\n         span: Span,\n+        return_kind: &str,\n         reference_desc: &str,\n         path_desc: &str,\n         o: Origin,\n@@ -642,15 +643,16 @@ pub trait BorrowckErrors<'cx>: Sized + Copy {\n             self,\n             span,\n             E0515,\n-            \"cannot return {REFERENCE} {LOCAL}{OGN}\",\n+            \"cannot {RETURN} {REFERENCE} {LOCAL}{OGN}\",\n+            RETURN=return_kind,\n             REFERENCE=reference_desc,\n             LOCAL=path_desc,\n             OGN = o\n         );\n \n         err.span_label(\n             span,\n-            format!(\"returns a {} data owned by the current function\", reference_desc),\n+            format!(\"{}s a {} data owned by the current function\", return_kind, reference_desc),\n         );\n \n         self.cancel_if_wrong_origin(err, o)"}, {"sha": "a8f7299f89937a29898d7fd31052cec7de32bf22", "filename": "src/test/ui/nll/issue-55850.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2821329c34e2c6f117d09638b1a32def37abcecf/src%2Ftest%2Fui%2Fnll%2Fissue-55850.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2821329c34e2c6f117d09638b1a32def37abcecf/src%2Ftest%2Fui%2Fnll%2Fissue-55850.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fissue-55850.rs?ref=2821329c34e2c6f117d09638b1a32def37abcecf", "patch": "@@ -25,7 +25,7 @@ where\n fn bug<'a>() -> impl Iterator<Item = &'a str> {\n     GenIter(move || {\n         let mut s = String::new();\n-        yield &s[..] //~ ERROR `s` does not live long enough [E0597]\n+        yield &s[..] //~ ERROR cannot yield value referencing local variable `s` [E0515]\n         //~| ERROR borrow may still be in use when generator yields\n     })\n }"}, {"sha": "86a8cdc42ff9fdf1e344ae54ae628241c1a135c8", "filename": "src/test/ui/nll/issue-55850.stderr", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/2821329c34e2c6f117d09638b1a32def37abcecf/src%2Ftest%2Fui%2Fnll%2Fissue-55850.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2821329c34e2c6f117d09638b1a32def37abcecf/src%2Ftest%2Fui%2Fnll%2Fissue-55850.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fissue-55850.stderr?ref=2821329c34e2c6f117d09638b1a32def37abcecf", "patch": "@@ -1,11 +1,11 @@\n-error[E0597]: `s` does not live long enough\n-  --> $DIR/issue-55850.rs:28:16\n+error[E0515]: cannot yield value referencing local variable `s`\n+  --> $DIR/issue-55850.rs:28:9\n    |\n LL |         yield &s[..]\n-   |                ^ borrowed value does not live long enough\n-LL |\n-LL |     })\n-   |     - `s` dropped here while still borrowed\n+   |         ^^^^^^^-^^^^\n+   |         |      |\n+   |         |      `s` is borrowed here\n+   |         yields a value referencing data owned by the current function\n \n error[E0626]: borrow may still be in use when generator yields\n   --> $DIR/issue-55850.rs:28:16\n@@ -15,5 +15,5 @@ LL |         yield &s[..]\n \n error: aborting due to 2 previous errors\n \n-Some errors have detailed explanations: E0597, E0626.\n-For more information about an error, try `rustc --explain E0597`.\n+Some errors have detailed explanations: E0515, E0626.\n+For more information about an error, try `rustc --explain E0515`."}]}