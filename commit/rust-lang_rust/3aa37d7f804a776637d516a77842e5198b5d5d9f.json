{"sha": "3aa37d7f804a776637d516a77842e5198b5d5d9f", "node_id": "C_kwDOAAsO6NoAKDNhYTM3ZDdmODA0YTc3NjYzN2Q1MTZhNzc4NDJlNTE5OGI1ZDVkOWY", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-10-04T15:39:55Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-10-04T15:39:55Z"}, "message": "Avoid cycle when lowering predicates for associated item lookup", "tree": {"sha": "6646f721c516b06756eb37ecaa297ab104a60175", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6646f721c516b06756eb37ecaa297ab104a60175"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3aa37d7f804a776637d516a77842e5198b5d5d9f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3aa37d7f804a776637d516a77842e5198b5d5d9f", "html_url": "https://github.com/rust-lang/rust/commit/3aa37d7f804a776637d516a77842e5198b5d5d9f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3aa37d7f804a776637d516a77842e5198b5d5d9f/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9724ca7af1e5533ab1bdbefcd17061dc141ecf26", "url": "https://api.github.com/repos/rust-lang/rust/commits/9724ca7af1e5533ab1bdbefcd17061dc141ecf26", "html_url": "https://github.com/rust-lang/rust/commit/9724ca7af1e5533ab1bdbefcd17061dc141ecf26"}], "stats": {"total": 82, "additions": 65, "deletions": 17}, "files": [{"sha": "a541cbd5e18888ac6c1db22d5349e49c3a098f3a", "filename": "crates/hir/src/display.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3aa37d7f804a776637d516a77842e5198b5d5d9f/crates%2Fhir%2Fsrc%2Fdisplay.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3aa37d7f804a776637d516a77842e5198b5d5d9f/crates%2Fhir%2Fsrc%2Fdisplay.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fdisplay.rs?ref=3aa37d7f804a776637d516a77842e5198b5d5d9f", "patch": "@@ -241,7 +241,7 @@ impl HirDisplay for TypeParam {\n             return Ok(());\n         }\n \n-        let bounds = f.db.generic_predicates_for_param(self.id);\n+        let bounds = f.db.generic_predicates_for_param(self.id, None);\n         let substs = TyBuilder::type_params_subst(f.db, self.id.parent);\n         let predicates: Vec<_> =\n             bounds.iter().cloned().map(|b| b.substitute(&Interner, &substs)).collect();"}, {"sha": "a33c8ce65eb0c0a5d0ad188b1c40685e02610469", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3aa37d7f804a776637d516a77842e5198b5d5d9f/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3aa37d7f804a776637d516a77842e5198b5d5d9f/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=3aa37d7f804a776637d516a77842e5198b5d5d9f", "patch": "@@ -2024,7 +2024,7 @@ impl TypeParam {\n     }\n \n     pub fn trait_bounds(self, db: &dyn HirDatabase) -> Vec<Trait> {\n-        db.generic_predicates_for_param(self.id)\n+        db.generic_predicates_for_param(self.id, None)\n             .iter()\n             .filter_map(|pred| match &pred.skip_binders().skip_binders() {\n                 hir_ty::WhereClause::Implemented(trait_ref) => {"}, {"sha": "98a584900123fd747381d901cad38f616b8fc029", "filename": "crates/hir_ty/src/db.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3aa37d7f804a776637d516a77842e5198b5d5d9f/crates%2Fhir_ty%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3aa37d7f804a776637d516a77842e5198b5d5d9f/crates%2Fhir_ty%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fdb.rs?ref=3aa37d7f804a776637d516a77842e5198b5d5d9f", "patch": "@@ -61,6 +61,7 @@ pub trait HirDatabase: DefDatabase + Upcast<dyn DefDatabase> {\n     fn generic_predicates_for_param(\n         &self,\n         param_id: TypeParamId,\n+        assoc_name: Option<Name>,\n     ) -> Arc<[Binders<QuantifiedWhereClause>]>;\n \n     #[salsa::invoke(crate::lower::generic_predicates_query)]"}, {"sha": "d5f3940149f1965517a6aff01a287b37d49c3764", "filename": "crates/hir_ty/src/lower.rs", "status": "modified", "additions": 58, "deletions": 12, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/3aa37d7f804a776637d516a77842e5198b5d5d9f/crates%2Fhir_ty%2Fsrc%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3aa37d7f804a776637d516a77842e5198b5d5d9f/crates%2Fhir_ty%2Fsrc%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Flower.rs?ref=3aa37d7f804a776637d516a77842e5198b5d5d9f", "patch": "@@ -30,6 +30,7 @@ use smallvec::SmallVec;\n use stdx::impl_from;\n use syntax::ast;\n \n+use crate::all_super_traits;\n use crate::{\n     consteval,\n     db::HirDatabase,\n@@ -531,9 +532,10 @@ impl<'a> TyLoweringContext<'a> {\n \n     fn select_associated_type(&self, res: Option<TypeNs>, segment: PathSegment<'_>) -> Ty {\n         if let Some(res) = res {\n-            let ty = associated_type_shorthand_candidates(\n+            let ty = named_associated_type_shorthand_candidates(\n                 self.db,\n                 res,\n+                Some(segment.name.clone()),\n                 move |name, t, associated_ty| {\n                     if name == segment.name {\n                         let substs = match self.type_param_mode {\n@@ -555,16 +557,16 @@ impl<'a> TyLoweringContext<'a> {\n                         // associated_type_shorthand_candidates does not do that\n                         let substs = substs.shifted_in_from(&Interner, self.in_binders);\n                         // FIXME handle type parameters on the segment\n-                        return Some(\n+                        Some(\n                             TyKind::Alias(AliasTy::Projection(ProjectionTy {\n                                 associated_ty_id: to_assoc_type_id(associated_ty),\n                                 substitution: substs,\n                             }))\n                             .intern(&Interner),\n-                        );\n+                        )\n+                    } else {\n+                        None\n                     }\n-\n-                    None\n                 },\n             );\n \n@@ -935,6 +937,15 @@ pub fn callable_item_sig(db: &dyn HirDatabase, def: CallableDefId) -> PolyFnSig\n pub fn associated_type_shorthand_candidates<R>(\n     db: &dyn HirDatabase,\n     res: TypeNs,\n+    cb: impl FnMut(&Name, &TraitRef, TypeAliasId) -> Option<R>,\n+) -> Option<R> {\n+    named_associated_type_shorthand_candidates(db, res, None, cb)\n+}\n+\n+fn named_associated_type_shorthand_candidates<R>(\n+    db: &dyn HirDatabase,\n+    res: TypeNs,\n+    assoc_name: Option<Name>,\n     mut cb: impl FnMut(&Name, &TraitRef, TypeAliasId) -> Option<R>,\n ) -> Option<R> {\n     let mut search = |t| {\n@@ -959,7 +970,7 @@ pub fn associated_type_shorthand_candidates<R>(\n             db.impl_trait(impl_id)?.into_value_and_skipped_binders().0,\n         ),\n         TypeNs::GenericParam(param_id) => {\n-            let predicates = db.generic_predicates_for_param(param_id);\n+            let predicates = db.generic_predicates_for_param(param_id, assoc_name);\n             let res = predicates.iter().find_map(|pred| match pred.skip_binders().skip_binders() {\n                 // FIXME: how to correctly handle higher-ranked bounds here?\n                 WhereClause::Implemented(tr) => search(\n@@ -1022,6 +1033,7 @@ pub(crate) fn field_types_query(\n pub(crate) fn generic_predicates_for_param_query(\n     db: &dyn HirDatabase,\n     param_id: TypeParamId,\n+    assoc_name: Option<Name>,\n ) -> Arc<[Binders<QuantifiedWhereClause>]> {\n     let resolver = param_id.parent.resolver(db.upcast());\n     let ctx =\n@@ -1031,13 +1043,46 @@ pub(crate) fn generic_predicates_for_param_query(\n         .where_predicates_in_scope()\n         // we have to filter out all other predicates *first*, before attempting to lower them\n         .filter(|pred| match pred {\n-            WherePredicate::ForLifetime { target, .. }\n-            | WherePredicate::TypeBound { target, .. } => match target {\n-                WherePredicateTypeTarget::TypeRef(type_ref) => {\n-                    ctx.lower_ty_only_param(type_ref) == Some(param_id)\n+            WherePredicate::ForLifetime { target, bound, .. }\n+            | WherePredicate::TypeBound { target, bound, .. } => {\n+                match target {\n+                    WherePredicateTypeTarget::TypeRef(type_ref) => {\n+                        if ctx.lower_ty_only_param(type_ref) != Some(param_id) {\n+                            return false;\n+                        }\n+                    }\n+                    WherePredicateTypeTarget::TypeParam(local_id) => {\n+                        if *local_id != param_id.local_id {\n+                            return false;\n+                        }\n+                    }\n+                };\n+\n+                match &**bound {\n+                    TypeBound::ForLifetime(_, path) | TypeBound::Path(path, _) => {\n+                        // Only lower the bound if the trait could possibly define the associated\n+                        // type we're looking for.\n+\n+                        let assoc_name = match &assoc_name {\n+                            Some(it) => it,\n+                            None => return true,\n+                        };\n+                        let tr = match resolver\n+                            .resolve_path_in_type_ns_fully(db.upcast(), path.mod_path())\n+                        {\n+                            Some(TypeNs::TraitId(tr)) => tr,\n+                            _ => return false,\n+                        };\n+\n+                        all_super_traits(db.upcast(), tr).iter().any(|tr| {\n+                            db.trait_data(*tr).items.iter().any(|(name, item)| {\n+                                matches!(item, AssocItemId::TypeAliasId(_)) && name == assoc_name\n+                            })\n+                        })\n+                    }\n+                    TypeBound::Lifetime(_) | TypeBound::Error => false,\n                 }\n-                WherePredicateTypeTarget::TypeParam(local_id) => *local_id == param_id.local_id,\n-            },\n+            }\n             WherePredicate::Lifetime { .. } => false,\n         })\n         .flat_map(|pred| ctx.lower_where_predicate(pred, true).map(|p| make_binders(&generics, p)))\n@@ -1056,6 +1101,7 @@ pub(crate) fn generic_predicates_for_param_recover(\n     _db: &dyn HirDatabase,\n     _cycle: &[String],\n     _param_id: &TypeParamId,\n+    _assoc_name: &Option<Name>,\n ) -> Arc<[Binders<QuantifiedWhereClause>]> {\n     Arc::new([])\n }"}, {"sha": "9531be760e9d01b60873f18a5a80012afbb49fd0", "filename": "crates/hir_ty/src/tests/traits.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3aa37d7f804a776637d516a77842e5198b5d5d9f/crates%2Fhir_ty%2Fsrc%2Ftests%2Ftraits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3aa37d7f804a776637d516a77842e5198b5d5d9f/crates%2Fhir_ty%2Fsrc%2Ftests%2Ftraits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Ftraits.rs?ref=3aa37d7f804a776637d516a77842e5198b5d5d9f", "patch": "@@ -2100,7 +2100,8 @@ fn test() {\n \n #[test]\n fn unselected_projection_in_trait_env_cycle_1() {\n-    // this is a legitimate cycle\n+    // This is not a cycle, because the `T: Trait2<T::Item>` bound depends only on the `T: Trait`\n+    // bound, not on itself (since only `Trait` can define `Item`).\n     check_types(\n         r#\"\n trait Trait {\n@@ -2111,7 +2112,7 @@ trait Trait2<T> {}\n \n fn test<T: Trait>() where T: Trait2<T::Item> {\n     let x: T::Item = no_matter;\n-}                  //^^^^^^^^^ {unknown}\n+}                  //^^^^^^^^^ Trait::Item<T>\n \"#,\n     );\n }"}, {"sha": "07898f00888f06396db914408c0234105cbdd541", "filename": "crates/hir_ty/src/utils.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3aa37d7f804a776637d516a77842e5198b5d5d9f/crates%2Fhir_ty%2Fsrc%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3aa37d7f804a776637d516a77842e5198b5d5d9f/crates%2Fhir_ty%2Fsrc%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Futils.rs?ref=3aa37d7f804a776637d516a77842e5198b5d5d9f", "patch": "@@ -79,7 +79,7 @@ fn direct_super_trait_refs(db: &dyn HirDatabase, trait_ref: &TraitRef) -> Vec<Tr\n         Some(p) => TypeParamId { parent: trait_ref.hir_trait_id().into(), local_id: p },\n         None => return Vec::new(),\n     };\n-    db.generic_predicates_for_param(trait_self)\n+    db.generic_predicates_for_param(trait_self, None)\n         .iter()\n         .filter_map(|pred| {\n             pred.as_ref().filter_map(|pred| match pred.skip_binders() {"}]}