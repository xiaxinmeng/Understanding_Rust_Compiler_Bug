{"sha": "91af0003e8ba8c010f90c171d0e0e291c27e07aa", "node_id": "C_kwDOAAsO6NoAKDkxYWYwMDAzZThiYThjMDEwZjkwYzE3MWQwZTBlMjkxYzI3ZTA3YWE", "commit": {"author": {"name": "the8472", "email": "the8472@users.noreply.github.com", "date": "2021-09-22T17:03:25Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-22T17:03:25Z"}, "message": "Rollup merge of #89162 - petrochenkov:ivmap, r=davidtwco\n\nrustc_index: Add some map-like APIs to `IndexVec`\n\n`IndexVec` is often used as a map, but its map APIs are lacking.\nThis PR adds a couple of useful methods.", "tree": {"sha": "4af348b75a2d821e8310b7250dba69dcad16d408", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4af348b75a2d821e8310b7250dba69dcad16d408"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/91af0003e8ba8c010f90c171d0e0e291c27e07aa", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhS2HdCRBK7hj4Ov3rIwAAfDcIAAXh89VHO1d2aTYNv8XAAsfp\n0sR3tc5q0n3MDTnGiz+5sHxrRtLEZDsgS8M0W7bEK1KV/MUIQEp/B6HpQBk8GC/f\n1RSPdh7avaxr4TY3v0gtaKqC9GjhHaPczqJBSbr+OaTbYhalotqE7CdxbosuwSbV\nnNwRaGwk5/wbRu/T9ciDYk4J+lo8sT6ZIj5EiT3HsoN2zdC4z5PjJorZdQf21d4o\n7JLv//9sWo25i0VZiicaMoTNdQRmQqBKsvWCe35diMalD9thNJOmV0QnNlRQi8pz\nMc0Fe6FjnObKF+nq6J1RgKGTI29ow5W0mJae32F9CshSlkeKD+ep0MhPdp2Esvs=\n=sb1D\n-----END PGP SIGNATURE-----\n", "payload": "tree 4af348b75a2d821e8310b7250dba69dcad16d408\nparent 3bdc894486293af5c741d2f48cfee7d36c57838a\nparent fbe5e5c0ee521dd812852c76b16564b49e446c4e\nauthor the8472 <the8472@users.noreply.github.com> 1632330205 +0200\ncommitter GitHub <noreply@github.com> 1632330205 +0200\n\nRollup merge of #89162 - petrochenkov:ivmap, r=davidtwco\n\nrustc_index: Add some map-like APIs to `IndexVec`\n\n`IndexVec` is often used as a map, but its map APIs are lacking.\nThis PR adds a couple of useful methods.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/91af0003e8ba8c010f90c171d0e0e291c27e07aa", "html_url": "https://github.com/rust-lang/rust/commit/91af0003e8ba8c010f90c171d0e0e291c27e07aa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/91af0003e8ba8c010f90c171d0e0e291c27e07aa/comments", "author": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3bdc894486293af5c741d2f48cfee7d36c57838a", "url": "https://api.github.com/repos/rust-lang/rust/commits/3bdc894486293af5c741d2f48cfee7d36c57838a", "html_url": "https://github.com/rust-lang/rust/commit/3bdc894486293af5c741d2f48cfee7d36c57838a"}, {"sha": "fbe5e5c0ee521dd812852c76b16564b49e446c4e", "url": "https://api.github.com/repos/rust-lang/rust/commits/fbe5e5c0ee521dd812852c76b16564b49e446c4e", "html_url": "https://github.com/rust-lang/rust/commit/fbe5e5c0ee521dd812852c76b16564b49e446c4e"}], "stats": {"total": 52, "additions": 28, "deletions": 24}, "files": [{"sha": "9f879494d7374ff574afb02f34f18597744cb89b", "filename": "compiler/rustc_ast_lowering/src/item.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/91af0003e8ba8c010f90c171d0e0e291c27e07aa/compiler%2Frustc_ast_lowering%2Fsrc%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/91af0003e8ba8c010f90c171d0e0e291c27e07aa/compiler%2Frustc_ast_lowering%2Fsrc%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Fitem.rs?ref=91af0003e8ba8c010f90c171d0e0e291c27e07aa", "patch": "@@ -474,9 +474,10 @@ impl<'hir> LoweringContext<'_, 'hir> {\n                         res\n                     } else {\n                         // Associate an HirId to both ids even if there is no resolution.\n-                        self.node_id_to_hir_id.ensure_contains_elem(new_node_id, || None);\n-                        debug_assert!(self.node_id_to_hir_id[new_node_id].is_none());\n-                        self.node_id_to_hir_id[new_node_id] = Some(hir::HirId::make_owner(new_id));\n+                        let _old = self\n+                            .node_id_to_hir_id\n+                            .insert(new_node_id, hir::HirId::make_owner(new_id));\n+                        debug_assert!(_old.is_none());\n                         continue;\n                     };\n                     let ident = *ident;"}, {"sha": "3c75089a760f32fb9cc74c78391d8b32cc7fabac", "filename": "compiler/rustc_ast_lowering/src/lib.rs", "status": "modified", "additions": 7, "deletions": 15, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/91af0003e8ba8c010f90c171d0e0e291c27e07aa/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/91af0003e8ba8c010f90c171d0e0e291c27e07aa/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs?ref=91af0003e8ba8c010f90c171d0e0e291c27e07aa", "patch": "@@ -469,11 +469,8 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n         let def_id = self.resolver.local_def_id(owner);\n \n         // Always allocate the first `HirId` for the owner itself.\n-        self.node_id_to_hir_id.ensure_contains_elem(owner, || None);\n-        if let Some(_lowered) = self.node_id_to_hir_id[owner] {\n-            panic!(\"with_hir_id_owner must not be called multiple times on owner {:?}\", def_id);\n-        }\n-        self.node_id_to_hir_id[owner] = Some(hir::HirId::make_owner(def_id));\n+        let _old = self.node_id_to_hir_id.insert(owner, hir::HirId::make_owner(def_id));\n+        debug_assert_eq!(_old, None);\n \n         let current_owner = std::mem::replace(&mut self.current_hir_id_owner, def_id);\n         let current_local_counter =\n@@ -484,8 +481,8 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n         self.current_hir_id_owner = current_owner;\n         self.item_local_id_counter = current_local_counter;\n \n-        self.owners.ensure_contains_elem(def_id, || None);\n-        self.owners[def_id] = Some(item);\n+        let _old = self.owners.insert(def_id, item);\n+        debug_assert!(_old.is_none());\n \n         def_id\n     }\n@@ -499,18 +496,13 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n     fn lower_node_id(&mut self, ast_node_id: NodeId) -> hir::HirId {\n         assert_ne!(ast_node_id, DUMMY_NODE_ID);\n \n-        self.node_id_to_hir_id.ensure_contains_elem(ast_node_id, || None);\n-        if let Some(existing_hir_id) = self.node_id_to_hir_id[ast_node_id] {\n-            existing_hir_id\n-        } else {\n+        *self.node_id_to_hir_id.get_or_insert_with(ast_node_id, || {\n             // Generate a new `HirId`.\n             let owner = self.current_hir_id_owner;\n             let local_id = self.item_local_id_counter;\n             self.item_local_id_counter.increment_by(1);\n-            let hir_id = hir::HirId { owner, local_id };\n-            self.node_id_to_hir_id[ast_node_id] = Some(hir_id);\n-            hir_id\n-        }\n+            hir::HirId { owner, local_id }\n+        })\n     }\n \n     fn next_id(&mut self) -> hir::HirId {"}, {"sha": "5b1add4cfc6117c65baf25e3da754f4699c237a8", "filename": "compiler/rustc_index/src/bit_set.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/91af0003e8ba8c010f90c171d0e0e291c27e07aa/compiler%2Frustc_index%2Fsrc%2Fbit_set.rs", "raw_url": "https://github.com/rust-lang/rust/raw/91af0003e8ba8c010f90c171d0e0e291c27e07aa/compiler%2Frustc_index%2Fsrc%2Fbit_set.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_index%2Fsrc%2Fbit_set.rs?ref=91af0003e8ba8c010f90c171d0e0e291c27e07aa", "patch": "@@ -1072,13 +1072,9 @@ impl<R: Idx, C: Idx> SparseBitMatrix<R, C> {\n     }\n \n     fn ensure_row(&mut self, row: R) -> &mut HybridBitSet<C> {\n-        // Instantiate any missing rows up to and including row `row` with an\n-        // empty HybridBitSet.\n-        self.rows.ensure_contains_elem(row, || None);\n-\n+        // Instantiate any missing rows up to and including row `row` with an empty HybridBitSet.\n         // Then replace row `row` with a full HybridBitSet if necessary.\n-        let num_columns = self.num_columns;\n-        self.rows[row].get_or_insert_with(|| HybridBitSet::new_empty(num_columns))\n+        self.rows.get_or_insert_with(row, || HybridBitSet::new_empty(self.num_columns))\n     }\n \n     /// Sets the cell at `(row, column)` to true. Put another way, insert"}, {"sha": "8535a7c866d96bb255a9565cf4195b1c46161778", "filename": "compiler/rustc_index/src/vec.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/91af0003e8ba8c010f90c171d0e0e291c27e07aa/compiler%2Frustc_index%2Fsrc%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/91af0003e8ba8c010f90c171d0e0e291c27e07aa/compiler%2Frustc_index%2Fsrc%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_index%2Fsrc%2Fvec.rs?ref=91af0003e8ba8c010f90c171d0e0e291c27e07aa", "patch": "@@ -720,6 +720,21 @@ impl<I: Idx, T> IndexVec<I, T> {\n     }\n }\n \n+/// `IndexVec` is often used as a map, so it provides some map-like APIs.\n+impl<I: Idx, T> IndexVec<I, Option<T>> {\n+    #[inline]\n+    pub fn insert(&mut self, index: I, value: T) -> Option<T> {\n+        self.ensure_contains_elem(index, || None);\n+        self[index].replace(value)\n+    }\n+\n+    #[inline]\n+    pub fn get_or_insert_with(&mut self, index: I, value: impl FnOnce() -> T) -> &mut T {\n+        self.ensure_contains_elem(index, || None);\n+        self[index].get_or_insert_with(value)\n+    }\n+}\n+\n impl<I: Idx, T: Clone> IndexVec<I, T> {\n     #[inline]\n     pub fn resize(&mut self, new_len: usize, value: T) {"}]}