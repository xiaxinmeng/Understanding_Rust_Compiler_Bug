{"sha": "e1a3b9606e712dac18bae566498d2fa93ca0c276", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUxYTNiOTYwNmU3MTJkYWMxOGJhZTU2NjQ5OGQyZmE5M2NhMGMyNzY=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2018-07-16T09:42:46Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2018-07-16T09:42:46Z"}, "message": "TLS on Windows", "tree": {"sha": "08a82e062758d8a2398bb8f9cf06fbc06a59463e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/08a82e062758d8a2398bb8f9cf06fbc06a59463e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e1a3b9606e712dac18bae566498d2fa93ca0c276", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e1a3b9606e712dac18bae566498d2fa93ca0c276", "html_url": "https://github.com/rust-lang/rust/commit/e1a3b9606e712dac18bae566498d2fa93ca0c276", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e1a3b9606e712dac18bae566498d2fa93ca0c276/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "216b8f74075a6f555c3cc1bf8a2dab16af35ca0a", "url": "https://api.github.com/repos/rust-lang/rust/commits/216b8f74075a6f555c3cc1bf8a2dab16af35ca0a", "html_url": "https://github.com/rust-lang/rust/commit/216b8f74075a6f555c3cc1bf8a2dab16af35ca0a"}], "stats": {"total": 51, "additions": 48, "deletions": 3}, "files": [{"sha": "31b3b4b18d17184dfb008171d41a0959cfccc929", "filename": "src/fn_call.rs", "status": "modified", "additions": 29, "deletions": 1, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/e1a3b9606e712dac18bae566498d2fa93ca0c276/src%2Ffn_call.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1a3b9606e712dac18bae566498d2fa93ca0c276/src%2Ffn_call.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ffn_call.rs?ref=e1a3b9606e712dac18bae566498d2fa93ca0c276", "patch": "@@ -607,7 +607,7 @@ impl<'a, 'mir, 'tcx: 'mir + 'a> EvalContextExt<'tcx> for EvalContext<'a, 'mir, '\n             }\n \n             \"_tlv_atexit\" => {\n-                return err!(Unimplemented(\"can't interpret with full mir for osx target\".to_owned()));\n+                return err!(Unimplemented(\"Thread-local store is not fully supported on macOS\".to_owned()));\n             },\n \n             // Stub out all the other pthread calls to just return 0\n@@ -643,6 +643,34 @@ impl<'a, 'mir, 'tcx: 'mir + 'a> EvalContextExt<'tcx> for EvalContext<'a, 'mir, '\n                 self.write_scalar(dest, Scalar::from_u128(120), dest_ty)?;\n             },\n \n+            // Windows TLS\n+            \"TlsAlloc\" => {\n+                // This just creates a key; Windows does not natively support TLS dtors.\n+\n+                // Figure out how large a TLS key actually is. This is c::DWORD.\n+                let key_size = self.layout_of(dest_ty)?.size;\n+\n+                // Create key and return it\n+                let key = self.memory.create_tls_key(None) as u128;\n+                if key_size.bits() < 128 && key >= (1u128 << key_size.bits() as u128) {\n+                    return err!(OutOfTls);\n+                }\n+                self.write_scalar(dest, Scalar::from_u128(key), dest_ty)?;\n+            }\n+            \"TlsGetValue\" => {\n+                let key = self.value_to_scalar(args[0])?.to_bytes()?;\n+                let ptr = self.memory.load_tls(key)?;\n+                self.write_ptr(dest, ptr, dest_ty)?;\n+            }\n+            \"TlsSetValue\" => {\n+                let key = self.value_to_scalar(args[0])?.to_bytes()?;\n+                let new_ptr = self.into_ptr(args[1].value)?;\n+                self.memory.store_tls(key, new_ptr)?;\n+\n+                // Return success (1)\n+                self.write_scalar(dest, Scalar::from_u128(1), dest_ty)?;\n+            }\n+\n             // We can't execute anything else\n             _ => {\n                 return err!(Unimplemented("}, {"sha": "5a2d7e77d65feebc6176914d9be1bed90b29eb6a", "filename": "src/lib.rs", "status": "modified", "additions": 18, "deletions": 2, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/e1a3b9606e712dac18bae566498d2fa93ca0c276/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1a3b9606e712dac18bae566498d2fa93ca0c276/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=e1a3b9606e712dac18bae566498d2fa93ca0c276", "patch": "@@ -141,7 +141,12 @@ pub fn create_ecx<'a, 'mir: 'a, 'tcx: 'mir>(\n     main_id: DefId,\n     start_wrapper: Option<DefId>,\n ) -> EvalResult<'tcx, (EvalContext<'a, 'mir, 'tcx, Evaluator<'tcx>>, Option<Pointer>)> {\n-    let mut ecx = EvalContext::new(tcx.at(syntax::codemap::DUMMY_SP), ty::ParamEnv::reveal_all(), Default::default(), Default::default());\n+    let mut ecx = EvalContext::new(\n+        tcx.at(syntax::codemap::DUMMY_SP),\n+        ty::ParamEnv::reveal_all(),\n+        Default::default(),\n+        MemoryData::new()\n+    );\n \n     let main_instance = ty::Instance::mono(ecx.tcx.tcx, main_id);\n     let main_mir = ecx.load_mir(main_instance.def)?;\n@@ -338,7 +343,7 @@ pub struct TlsEntry<'tcx> {\n     dtor: Option<ty::Instance<'tcx>>,\n }\n \n-#[derive(Clone, Default, PartialEq, Eq)]\n+#[derive(Clone, PartialEq, Eq)]\n pub struct MemoryData<'tcx> {\n     /// The Key to use for the next thread-local allocation.\n     next_thread_local: TlsKey,\n@@ -355,6 +360,17 @@ pub struct MemoryData<'tcx> {\n     statics: HashMap<GlobalId<'tcx>, AllocId>,\n }\n \n+impl<'tcx> MemoryData<'tcx> {\n+    fn new() -> Self {\n+        MemoryData {\n+            next_thread_local: 1, // start with 1 as we must not use 0 on Windows\n+            thread_local: BTreeMap::new(),\n+            locks: HashMap::new(),\n+            statics: HashMap::new(),\n+        }\n+    }\n+}\n+\n impl<'tcx> Hash for MemoryData<'tcx> {\n     fn hash<H: Hasher>(&self, state: &mut H) {\n         let MemoryData {"}, {"sha": "ffcf86291590d06e2631c7cd910e0eb5c8afe2a1", "filename": "src/tls.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e1a3b9606e712dac18bae566498d2fa93ca0c276/src%2Ftls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1a3b9606e712dac18bae566498d2fa93ca0c276/src%2Ftls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftls.rs?ref=e1a3b9606e712dac18bae566498d2fa93ca0c276", "patch": "@@ -139,6 +139,7 @@ impl<'a, 'mir, 'tcx: 'mir + 'a> EvalContextExt<'tcx> for EvalContext<'a, 'mir, '\n                 None => self.memory.fetch_tls_dtor(None)?,\n             };\n         }\n+        // FIXME: On a windows target, call `unsafe extern \"system\" fn on_tls_callback`.\n         Ok(())\n     }\n }"}]}