{"sha": "a7f789b5023226c585b9d5dd652054501c5e2e94", "node_id": "C_kwDOAAsO6NoAKGE3Zjc4OWI1MDIzMjI2YzU4NWI5ZDVkZDY1MjA1NDUwMWM1ZTJlOTQ", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-06-21T11:08:10Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-06-21T11:08:10Z"}, "message": "Rollup merge of #98022 - compiler-errors:erroneous-borrowck-span, r=oli-obk\n\nFix erroneous span for borrowck error\n\nI am not confident that this is the correct fix, but it does the job. Open to suggestions for a real fix instead.\n\nFixes #97997\n\nThe issue is that we pass a [dummy location](https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_middle/mir/visit.rs.html#302) when type-checking the [\"required consts\"](https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/struct.Body.html#structfield.required_consts) that are needed by the MIR body during borrowck. This means that when we fail to evaluate the constant, we use the span of `bb0[0]`, instead of the actual span of the constant.\n\nThere are quite a few other places that use `START_BLOCK.start_location()`, `Location::START`, etc. when calling for a random/unspecified `Location` value. This is because, unlike (for example) `Span`, we don't have a dummy/miscellaneous value to use instead. I would appreciate guidance (either in this PR, or a follow-up) on what needs to be done to clean this up in general.", "tree": {"sha": "5f7bf41fcd6357b309cdef12c04439bd60127bd2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5f7bf41fcd6357b309cdef12c04439bd60127bd2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a7f789b5023226c585b9d5dd652054501c5e2e94", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJisaaaCRBK7hj4Ov3rIwAATaYIAJitaIcEpfvl1OQaGfyeu1Wc\noSn4jGeY6cMQXzeYrOhArBOuZj7HaohyDcTDFHxTJKk+r1uSClLGOHrxMYHz5nDh\nm+JdybebJzALYZow05+fMn/eL9aDGlesUDpzzifaAp4O2Eh8mb+MmkIss7NcLn5/\n20zgKYDS/Ooz/zIsRSg/8TWFGXpoROoXVHWD6JltsIJycDsv5ko+zjJvTEPjapjo\nrn9C0LIhjjf77tUix7y5botRajX3F47KtA5WtsjMCoscSyjh/DGezhW7pnUn033S\nC1i5z/aGffNOkoSajO8rTxGp2cE6D03wZanxGpTe5LTqXXtihQVkmglXN47KC64=\n=cWZe\n-----END PGP SIGNATURE-----\n", "payload": "tree 5f7bf41fcd6357b309cdef12c04439bd60127bd2\nparent 9c800ec4e97ec92c5b9b2ae2bd3f2aeeb4146df6\nparent ccf6124bd972ed2b0995f98a86554d201b8ac5c7\nauthor Yuki Okushi <jtitor@2k36.org> 1655809690 +0900\ncommitter GitHub <noreply@github.com> 1655809690 +0900\n\nRollup merge of #98022 - compiler-errors:erroneous-borrowck-span, r=oli-obk\n\nFix erroneous span for borrowck error\n\nI am not confident that this is the correct fix, but it does the job. Open to suggestions for a real fix instead.\n\nFixes #97997\n\nThe issue is that we pass a [dummy location](https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_middle/mir/visit.rs.html#302) when type-checking the [\"required consts\"](https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/struct.Body.html#structfield.required_consts) that are needed by the MIR body during borrowck. This means that when we fail to evaluate the constant, we use the span of `bb0[0]`, instead of the actual span of the constant.\n\nThere are quite a few other places that use `START_BLOCK.start_location()`, `Location::START`, etc. when calling for a random/unspecified `Location` value. This is because, unlike (for example) `Span`, we don't have a dummy/miscellaneous value to use instead. I would appreciate guidance (either in this PR, or a follow-up) on what needs to be done to clean this up in general.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a7f789b5023226c585b9d5dd652054501c5e2e94", "html_url": "https://github.com/rust-lang/rust/commit/a7f789b5023226c585b9d5dd652054501c5e2e94", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a7f789b5023226c585b9d5dd652054501c5e2e94/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9c800ec4e97ec92c5b9b2ae2bd3f2aeeb4146df6", "url": "https://api.github.com/repos/rust-lang/rust/commits/9c800ec4e97ec92c5b9b2ae2bd3f2aeeb4146df6", "html_url": "https://github.com/rust-lang/rust/commit/9c800ec4e97ec92c5b9b2ae2bd3f2aeeb4146df6"}, {"sha": "ccf6124bd972ed2b0995f98a86554d201b8ac5c7", "url": "https://api.github.com/repos/rust-lang/rust/commits/ccf6124bd972ed2b0995f98a86554d201b8ac5c7", "html_url": "https://github.com/rust-lang/rust/commit/ccf6124bd972ed2b0995f98a86554d201b8ac5c7"}], "stats": {"total": 62, "additions": 51, "deletions": 11}, "files": [{"sha": "355254fe9429b89f773817d5e706966ce82e30b2", "filename": "compiler/rustc_borrowck/src/type_check/mod.rs", "status": "modified", "additions": 14, "deletions": 10, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/a7f789b5023226c585b9d5dd652054501c5e2e94/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a7f789b5023226c585b9d5dd652054501c5e2e94/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs?ref=a7f789b5023226c585b9d5dd652054501c5e2e94", "patch": "@@ -357,12 +357,20 @@ impl<'a, 'b, 'tcx> Visitor<'tcx> for TypeVerifier<'a, 'b, 'tcx> {\n                 .add_element(live_region_vid, location);\n         });\n \n+        // HACK(compiler-errors): Constants that are gathered into Body.required_consts\n+        // have their locations erased...\n+        let locations = if location != Location::START {\n+            location.to_locations()\n+        } else {\n+            Locations::All(constant.span)\n+        };\n+\n         if let Some(annotation_index) = constant.user_ty {\n             if let Err(terr) = self.cx.relate_type_and_user_type(\n                 constant.literal.ty(),\n                 ty::Variance::Invariant,\n                 &UserTypeProjection { base: annotation_index, projs: vec![] },\n-                location.to_locations(),\n+                locations,\n                 ConstraintCategory::Boring,\n             ) {\n                 let annotation = &self.cx.user_type_annotations[annotation_index];\n@@ -390,12 +398,9 @@ impl<'a, 'b, 'tcx> Visitor<'tcx> for TypeVerifier<'a, 'b, 'tcx> {\n                                      promoted: &Body<'tcx>,\n                                      ty,\n                                      san_ty| {\n-                        if let Err(terr) = verifier.cx.eq_types(\n-                            ty,\n-                            san_ty,\n-                            location.to_locations(),\n-                            ConstraintCategory::Boring,\n-                        ) {\n+                        if let Err(terr) =\n+                            verifier.cx.eq_types(ty, san_ty, locations, ConstraintCategory::Boring)\n+                        {\n                             span_mirbug!(\n                                 verifier,\n                                 promoted,\n@@ -416,7 +421,7 @@ impl<'a, 'b, 'tcx> Visitor<'tcx> for TypeVerifier<'a, 'b, 'tcx> {\n                     }\n                 } else {\n                     if let Err(terr) = self.cx.fully_perform_op(\n-                        location.to_locations(),\n+                        locations,\n                         ConstraintCategory::Boring,\n                         self.cx.param_env.and(type_op::ascribe_user_type::AscribeUserType::new(\n                             constant.literal.ty(),\n@@ -435,7 +440,6 @@ impl<'a, 'b, 'tcx> Visitor<'tcx> for TypeVerifier<'a, 'b, 'tcx> {\n                 }\n             } else if let Some(static_def_id) = constant.check_static_ptr(tcx) {\n                 let unnormalized_ty = tcx.type_of(static_def_id);\n-                let locations = location.to_locations();\n                 let normalized_ty = self.cx.normalize(unnormalized_ty, locations);\n                 let literal_ty = constant.literal.ty().builtin_deref(true).unwrap().ty;\n \n@@ -454,7 +458,7 @@ impl<'a, 'b, 'tcx> Visitor<'tcx> for TypeVerifier<'a, 'b, 'tcx> {\n                 self.cx.normalize_and_prove_instantiated_predicates(\n                     def_id,\n                     instantiated_predicates,\n-                    location.to_locations(),\n+                    locations,\n                 );\n             }\n         }"}, {"sha": "b4312091edb279f9a987b73efe3e97634be548aa", "filename": "src/test/ui/hrtb/hrtb-just-for-static.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a7f789b5023226c585b9d5dd652054501c5e2e94/src%2Ftest%2Fui%2Fhrtb%2Fhrtb-just-for-static.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a7f789b5023226c585b9d5dd652054501c5e2e94/src%2Ftest%2Fui%2Fhrtb%2Fhrtb-just-for-static.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhrtb%2Fhrtb-just-for-static.stderr?ref=a7f789b5023226c585b9d5dd652054501c5e2e94", "patch": "@@ -2,7 +2,7 @@ error: implementation of `Foo` is not general enough\n   --> $DIR/hrtb-just-for-static.rs:24:5\n    |\n LL |     want_hrtb::<StaticInt>()\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^ implementation of `Foo` is not general enough\n+   |     ^^^^^^^^^^^^^^^^^^^^^^ implementation of `Foo` is not general enough\n    |\n    = note: `StaticInt` must implement `Foo<&'0 isize>`, for any lifetime `'0`...\n    = note: ...but it actually implements `Foo<&'static isize>`"}, {"sha": "c64e720b12f7f49bab8872566b4bcba5de396656", "filename": "src/test/ui/nll/issue-97997.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/a7f789b5023226c585b9d5dd652054501c5e2e94/src%2Ftest%2Fui%2Fnll%2Fissue-97997.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a7f789b5023226c585b9d5dd652054501c5e2e94/src%2Ftest%2Fui%2Fnll%2Fissue-97997.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fissue-97997.rs?ref=a7f789b5023226c585b9d5dd652054501c5e2e94", "patch": "@@ -0,0 +1,16 @@\n+trait Foo {\n+    const ASSOC: bool = true;\n+}\n+impl<T> Foo for fn(T) {}\n+\n+fn foo(_x: i32) {}\n+\n+fn impls_foo<T: Foo>(_x: T) {}\n+\n+fn main() {\n+    impls_foo(foo as fn(i32));\n+\n+    <fn(&u8) as Foo>::ASSOC;\n+    //~^ ERROR implementation of `Foo` is not general enough\n+    //~| ERROR implementation of `Foo` is not general enough\n+}"}, {"sha": "78401bbf6540aad7849d0f675487218c131ab152", "filename": "src/test/ui/nll/issue-97997.stderr", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/a7f789b5023226c585b9d5dd652054501c5e2e94/src%2Ftest%2Fui%2Fnll%2Fissue-97997.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a7f789b5023226c585b9d5dd652054501c5e2e94/src%2Ftest%2Fui%2Fnll%2Fissue-97997.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fissue-97997.stderr?ref=a7f789b5023226c585b9d5dd652054501c5e2e94", "patch": "@@ -0,0 +1,20 @@\n+error: implementation of `Foo` is not general enough\n+  --> $DIR/issue-97997.rs:13:5\n+   |\n+LL |     <fn(&u8) as Foo>::ASSOC;\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^ implementation of `Foo` is not general enough\n+   |\n+   = note: `Foo` would have to be implemented for the type `for<'r> fn(&'r u8)`\n+   = note: ...but `Foo` is actually implemented for the type `fn(&'0 u8)`, for some specific lifetime `'0`\n+\n+error: implementation of `Foo` is not general enough\n+  --> $DIR/issue-97997.rs:13:5\n+   |\n+LL |     <fn(&u8) as Foo>::ASSOC;\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^ implementation of `Foo` is not general enough\n+   |\n+   = note: `Foo` would have to be implemented for the type `for<'r> fn(&'r u8)`\n+   = note: ...but `Foo` is actually implemented for the type `fn(&'0 u8)`, for some specific lifetime `'0`\n+\n+error: aborting due to 2 previous errors\n+"}]}