{"sha": "14ac1b5faab32d268a85dfde6c6592b7183c5864", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE0YWMxYjVmYWFiMzJkMjY4YTg1ZGZkZTZjNjU5MmI3MTgzYzU4NjQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-03-27T07:16:29Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-03-27T07:16:29Z"}, "message": "Auto merge of #49279 - varkor:generated-closure-return-type, r=alexcrichton\n\nFix implicit closure return type generation for libsyntax\n\nThe `lambda` function for constructing closures in libsyntax was explicitly setting the return type to `_`, which resulted in incorrect corresponding syntax (as `|| -> _ x` is not valid, without the enclosing brackets). This meant the generated code, when printed, was invalid.\n\nI also took the opportunity to slightly improve the generated code for the `RustcEncodable::encode` method for unit structs.\n\nFixes #42213.", "tree": {"sha": "e276b99607fbb4e812cdde3857510407ccdc2f66", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e276b99607fbb4e812cdde3857510407ccdc2f66"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/14ac1b5faab32d268a85dfde6c6592b7183c5864", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/14ac1b5faab32d268a85dfde6c6592b7183c5864", "html_url": "https://github.com/rust-lang/rust/commit/14ac1b5faab32d268a85dfde6c6592b7183c5864", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/14ac1b5faab32d268a85dfde6c6592b7183c5864/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "31ae4f9fde9b23100c26e5642030128a7e1444ef", "url": "https://api.github.com/repos/rust-lang/rust/commits/31ae4f9fde9b23100c26e5642030128a7e1444ef", "html_url": "https://github.com/rust-lang/rust/commit/31ae4f9fde9b23100c26e5642030128a7e1444ef"}, {"sha": "ad50f3389a13d74aa0088bcb39c406193b721769", "url": "https://api.github.com/repos/rust-lang/rust/commits/ad50f3389a13d74aa0088bcb39c406193b721769", "html_url": "https://github.com/rust-lang/rust/commit/ad50f3389a13d74aa0088bcb39c406193b721769"}], "stats": {"total": 26, "additions": 13, "deletions": 13}, "files": [{"sha": "ee38cca7828be0ef486d8f3555d0675ee6b26524", "filename": "src/librustc_allocator/expand.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/14ac1b5faab32d268a85dfde6c6592b7183c5864/src%2Flibrustc_allocator%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14ac1b5faab32d268a85dfde6c6592b7183c5864/src%2Flibrustc_allocator%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_allocator%2Fexpand.rs?ref=14ac1b5faab32d268a85dfde6c6592b7183c5864", "patch": "@@ -145,7 +145,7 @@ impl<'a> AllocFnFactory<'a> {\n         let result = self.call_allocator(method.name, args);\n         let (output_ty, output_expr) =\n             self.ret_ty(&method.output, &mut abi_args, mk, result);\n-        let kind = ItemKind::Fn(self.cx.fn_decl(abi_args, output_ty),\n+        let kind = ItemKind::Fn(self.cx.fn_decl(abi_args, ast::FunctionRetTy::Ty(output_ty)),\n                                 Unsafety::Unsafe,\n                                 dummy_spanned(Constness::NotConst),\n                                 Abi::Rust,"}, {"sha": "269517e998f5b1fe7dfddc9093725555ed289bf1", "filename": "src/libsyntax/ext/build.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/14ac1b5faab32d268a85dfde6c6592b7183c5864/src%2Flibsyntax%2Fext%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14ac1b5faab32d268a85dfde6c6592b7183c5864/src%2Flibsyntax%2Fext%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbuild.rs?ref=14ac1b5faab32d268a85dfde6c6592b7183c5864", "patch": "@@ -214,7 +214,7 @@ pub trait AstBuilder {\n \n     fn arg(&self, span: Span, name: Ident, ty: P<ast::Ty>) -> ast::Arg;\n     // FIXME unused self\n-    fn fn_decl(&self, inputs: Vec<ast::Arg> , output: P<ast::Ty>) -> P<ast::FnDecl>;\n+    fn fn_decl(&self, inputs: Vec<ast::Arg> , output: ast::FunctionRetTy) -> P<ast::FnDecl>;\n \n     fn item_fn_poly(&self,\n                     span: Span,\n@@ -924,7 +924,7 @@ impl<'a> AstBuilder for ExtCtxt<'a> {\n               -> P<ast::Expr> {\n         let fn_decl = self.fn_decl(\n             ids.iter().map(|id| self.arg(span, *id, self.ty_infer(span))).collect(),\n-            self.ty_infer(span));\n+            ast::FunctionRetTy::Default(span));\n \n         // FIXME -- We are using `span` as the span of the `|...|`\n         // part of the lambda, but it probably (maybe?) corresponds to\n@@ -970,10 +970,10 @@ impl<'a> AstBuilder for ExtCtxt<'a> {\n     }\n \n     // FIXME unused self\n-    fn fn_decl(&self, inputs: Vec<ast::Arg>, output: P<ast::Ty>) -> P<ast::FnDecl> {\n+    fn fn_decl(&self, inputs: Vec<ast::Arg>, output: ast::FunctionRetTy) -> P<ast::FnDecl> {\n         P(ast::FnDecl {\n             inputs,\n-            output: ast::FunctionRetTy::Ty(output),\n+            output,\n             variadic: false\n         })\n     }\n@@ -1003,7 +1003,7 @@ impl<'a> AstBuilder for ExtCtxt<'a> {\n         self.item(span,\n                   name,\n                   Vec::new(),\n-                  ast::ItemKind::Fn(self.fn_decl(inputs, output),\n+                  ast::ItemKind::Fn(self.fn_decl(inputs, ast::FunctionRetTy::Ty(output)),\n                               ast::Unsafety::Normal,\n                               dummy_spanned(ast::Constness::NotConst),\n                               Abi::Rust,"}, {"sha": "67a822e4e02af052a7db504dd50db193b33f3778", "filename": "src/libsyntax/test.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/14ac1b5faab32d268a85dfde6c6592b7183c5864/src%2Flibsyntax%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14ac1b5faab32d268a85dfde6c6592b7183c5864/src%2Flibsyntax%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ftest.rs?ref=14ac1b5faab32d268a85dfde6c6592b7183c5864", "patch": "@@ -547,7 +547,7 @@ fn mk_main(cx: &mut TestCtxt) -> P<ast::Item> {\n     // pub fn main() { ... }\n     let main_ret_ty = ecx.ty(sp, ast::TyKind::Tup(vec![]));\n     let main_body = ecx.block(sp, vec![call_test_main]);\n-    let main = ast::ItemKind::Fn(ecx.fn_decl(vec![], main_ret_ty),\n+    let main = ast::ItemKind::Fn(ecx.fn_decl(vec![], ast::FunctionRetTy::Ty(main_ret_ty)),\n                            ast::Unsafety::Normal,\n                            dummy_spanned(ast::Constness::NotConst),\n                            ::abi::Abi::Rust, ast::Generics::default(), main_body);"}, {"sha": "88baa22e7fa1160561b664e82bb4f4a1437447b4", "filename": "src/libsyntax_ext/deriving/encodable.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/14ac1b5faab32d268a85dfde6c6592b7183c5864/src%2Flibsyntax_ext%2Fderiving%2Fencodable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14ac1b5faab32d268a85dfde6c6592b7183c5864/src%2Flibsyntax_ext%2Fderiving%2Fencodable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fencodable.rs?ref=14ac1b5faab32d268a85dfde6c6592b7183c5864", "patch": "@@ -228,13 +228,13 @@ fn encodable_substructure(cx: &mut ExtCtxt,\n             }\n \n             // unit structs have no fields and need to return Ok()\n-            if stmts.is_empty() {\n+            let blk = if stmts.is_empty() {\n                 let ok = cx.expr_ok(trait_span, cx.expr_tuple(trait_span, vec![]));\n-                let ret_ok = cx.expr(trait_span, ExprKind::Ret(Some(ok)));\n-                stmts.push(cx.stmt_expr(ret_ok));\n-            }\n+                cx.lambda1(trait_span, ok, blkarg)\n+            } else {\n+                cx.lambda_stmts_1(trait_span, stmts, blkarg)\n+            };\n \n-            let blk = cx.lambda_stmts_1(trait_span, stmts, blkarg);\n             cx.expr_method_call(trait_span,\n                                 encoder,\n                                 cx.ident_of(\"emit_struct\"),"}, {"sha": "3935f1722b61525670885e978fa53a15f36b02da", "filename": "src/libsyntax_ext/deriving/generic/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/14ac1b5faab32d268a85dfde6c6592b7183c5864/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14ac1b5faab32d268a85dfde6c6592b7183c5864/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fmod.rs?ref=14ac1b5faab32d268a85dfde6c6592b7183c5864", "patch": "@@ -962,7 +962,7 @@ impl<'a> MethodDef<'a> {\n         let ret_type = self.get_ret_ty(cx, trait_, generics, type_ident);\n \n         let method_ident = cx.ident_of(self.name);\n-        let fn_decl = cx.fn_decl(args, ret_type);\n+        let fn_decl = cx.fn_decl(args, ast::FunctionRetTy::Ty(ret_type));\n         let body_block = cx.block_expr(body);\n \n         let unsafety = if self.is_unsafe {"}]}