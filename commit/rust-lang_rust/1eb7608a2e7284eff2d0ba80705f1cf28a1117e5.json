{"sha": "1eb7608a2e7284eff2d0ba80705f1cf28a1117e5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFlYjc2MDhhMmU3Mjg0ZWZmMmQwYmE4MDcwNWYxY2YyOGExMTE3ZTU=", "commit": {"author": {"name": "Andrew Houts", "email": "ahouts4@gmail.com", "date": "2020-12-18T03:09:55Z"}, "committer": {"name": "Andrew Houts", "email": "ahouts4@gmail.com", "date": "2020-12-18T03:28:16Z"}, "message": "make needless_update ignore non_exhaustive structs", "tree": {"sha": "1fcffdbb3a7ef81b0b7df681fbc4c2896eee4e81", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1fcffdbb3a7ef81b0b7df681fbc4c2896eee4e81"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1eb7608a2e7284eff2d0ba80705f1cf28a1117e5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1eb7608a2e7284eff2d0ba80705f1cf28a1117e5", "html_url": "https://github.com/rust-lang/rust/commit/1eb7608a2e7284eff2d0ba80705f1cf28a1117e5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1eb7608a2e7284eff2d0ba80705f1cf28a1117e5/comments", "author": {"login": "ahouts", "id": 16907671, "node_id": "MDQ6VXNlcjE2OTA3Njcx", "avatar_url": "https://avatars.githubusercontent.com/u/16907671?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ahouts", "html_url": "https://github.com/ahouts", "followers_url": "https://api.github.com/users/ahouts/followers", "following_url": "https://api.github.com/users/ahouts/following{/other_user}", "gists_url": "https://api.github.com/users/ahouts/gists{/gist_id}", "starred_url": "https://api.github.com/users/ahouts/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ahouts/subscriptions", "organizations_url": "https://api.github.com/users/ahouts/orgs", "repos_url": "https://api.github.com/users/ahouts/repos", "events_url": "https://api.github.com/users/ahouts/events{/privacy}", "received_events_url": "https://api.github.com/users/ahouts/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ahouts", "id": 16907671, "node_id": "MDQ6VXNlcjE2OTA3Njcx", "avatar_url": "https://avatars.githubusercontent.com/u/16907671?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ahouts", "html_url": "https://github.com/ahouts", "followers_url": "https://api.github.com/users/ahouts/followers", "following_url": "https://api.github.com/users/ahouts/following{/other_user}", "gists_url": "https://api.github.com/users/ahouts/gists{/gist_id}", "starred_url": "https://api.github.com/users/ahouts/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ahouts/subscriptions", "organizations_url": "https://api.github.com/users/ahouts/orgs", "repos_url": "https://api.github.com/users/ahouts/repos", "events_url": "https://api.github.com/users/ahouts/events{/privacy}", "received_events_url": "https://api.github.com/users/ahouts/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5c00931642357c835d5ba292d8c642ef7389021b", "url": "https://api.github.com/repos/rust-lang/rust/commits/5c00931642357c835d5ba292d8c642ef7389021b", "html_url": "https://github.com/rust-lang/rust/commit/5c00931642357c835d5ba292d8c642ef7389021b"}], "stats": {"total": 34, "additions": 31, "deletions": 3}, "files": [{"sha": "1e387b518c3ad8cea6a5b409c5e19652b9f31f61", "filename": "clippy_lints/src/needless_update.rs", "status": "modified", "additions": 19, "deletions": 2, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/1eb7608a2e7284eff2d0ba80705f1cf28a1117e5/clippy_lints%2Fsrc%2Fneedless_update.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1eb7608a2e7284eff2d0ba80705f1cf28a1117e5/clippy_lints%2Fsrc%2Fneedless_update.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fneedless_update.rs?ref=1eb7608a2e7284eff2d0ba80705f1cf28a1117e5", "patch": "@@ -21,7 +21,14 @@ declare_clippy_lint! {\n     /// #     z: i32,\n     /// # }\n     /// # let zero_point = Point { x: 0, y: 0, z: 0 };\n-    ///\n+    /// #\n+    /// # #[non_exhaustive]\n+    /// # struct Options {\n+    /// #     a: bool,\n+    /// #     b: i32,\n+    /// # }\n+    /// # let default_options = Options { a: false, b: 0 };\n+    /// #\n     /// // Bad\n     /// Point {\n     ///     x: 1,\n@@ -36,6 +43,14 @@ declare_clippy_lint! {\n     ///     y: 1,\n     ///     ..zero_point\n     /// };\n+    ///\n+    /// // this lint is not applied to structs marked with [non_exhaustive](https://doc.rust-lang.org/reference/attributes/type_system.html)\n+    /// // Ok\n+    /// Options {\n+    ///     a: true,\n+    ///     b: 321,\n+    ///     ..default_options\n+    ///  };\n     /// ```\n     pub NEEDLESS_UPDATE,\n     complexity,\n@@ -49,7 +64,9 @@ impl<'tcx> LateLintPass<'tcx> for NeedlessUpdate {\n         if let ExprKind::Struct(_, ref fields, Some(ref base)) = expr.kind {\n             let ty = cx.typeck_results().expr_ty(expr);\n             if let ty::Adt(def, _) = ty.kind() {\n-                if fields.len() == def.non_enum_variant().fields.len() {\n+                if fields.len() == def.non_enum_variant().fields.len()\n+                    && !def.variants[0_usize.into()].is_field_list_non_exhaustive()\n+                {\n                     span_lint(\n                         cx,\n                         NEEDLESS_UPDATE,"}, {"sha": "b93ff048a62f21de1f957e5c1df595552dae851d", "filename": "tests/ui/needless_update.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1eb7608a2e7284eff2d0ba80705f1cf28a1117e5/tests%2Fui%2Fneedless_update.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1eb7608a2e7284eff2d0ba80705f1cf28a1117e5/tests%2Fui%2Fneedless_update.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_update.rs?ref=1eb7608a2e7284eff2d0ba80705f1cf28a1117e5", "patch": "@@ -6,9 +6,20 @@ struct S {\n     pub b: i32,\n }\n \n+#[non_exhaustive]\n+struct T {\n+    pub x: i32,\n+    pub y: i32,\n+}\n+\n fn main() {\n     let base = S { a: 0, b: 0 };\n     S { ..base }; // no error\n     S { a: 1, ..base }; // no error\n     S { a: 1, b: 1, ..base };\n+\n+    let base = T { x: 0, y: 0 };\n+    T { ..base }; // no error\n+    T { x: 1, ..base }; // no error\n+    T { x: 1, y: 1, ..base }; // no error\n }"}, {"sha": "b154b3b306ddcc1fab314d1d11ef898865015f7c", "filename": "tests/ui/needless_update.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1eb7608a2e7284eff2d0ba80705f1cf28a1117e5/tests%2Fui%2Fneedless_update.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1eb7608a2e7284eff2d0ba80705f1cf28a1117e5/tests%2Fui%2Fneedless_update.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_update.stderr?ref=1eb7608a2e7284eff2d0ba80705f1cf28a1117e5", "patch": "@@ -1,5 +1,5 @@\n error: struct update has no effect, all the fields in the struct have already been specified\n-  --> $DIR/needless_update.rs:13:23\n+  --> $DIR/needless_update.rs:19:23\n    |\n LL |     S { a: 1, b: 1, ..base };\n    |                       ^^^^"}]}