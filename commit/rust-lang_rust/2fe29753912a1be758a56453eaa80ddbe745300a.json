{"sha": "2fe29753912a1be758a56453eaa80ddbe745300a", "node_id": "C_kwDOAAsO6NoAKDJmZTI5NzUzOTEyYTFiZTc1OGE1NjQ1M2VhYTgwZGRiZTc0NTMwMGE", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-08-19T06:56:40Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-19T06:56:40Z"}, "message": "Rollup merge of #100081 - RalfJung:unused-unsafe-in-unsafe-fn, r=jackh726\n\nnever consider unsafe blocks unused if they would be required with deny(unsafe_op_in_unsafe_fn)\n\nJudging from https://github.com/rust-lang/rust/issues/71668#issuecomment-1200317370 the consensus nowadays seems to be that we should never consider an unsafe block unused if it was required with `deny(unsafe_op_in_unsafe_fn)`, no matter whether that lint is actually enabled or not. So let's adjust rustc accordingly.\n\nThe first commit does the change, the 2nd does some cleanup.", "tree": {"sha": "fcdf459aa8bd9413e845e55c909cab892a79fc82", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fcdf459aa8bd9413e845e55c909cab892a79fc82"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2fe29753912a1be758a56453eaa80ddbe745300a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi/zQoCRBK7hj4Ov3rIwAAs8kIAGbl/2+DNFAGtRp+lUWAU5L4\njcXlo9EZS11R7qYQ+Fu0gCxHX35acE++nxN8m+LikGky96dbgXNlY1CfrKBjprZh\nyMRP14/WX14Ue9Rtc0DasxSRrlNRK67HGlV864QBgx3MfBEKSjwaD5YrDpK0vKxw\nULuRWj9YVoiT/FUc1rD+gRIHsf40NVF542+OuAh7tncmW5px9IbTd1Px2mZYupXG\n/Y5tic2qJW8F2rFkxg2BiUMDrFez4gjSRZJ461Hi6P5KS0M+4CBdvVNlt176Sc79\n6CHyratHv89b2SADmy67FfpYWTtyvM34R8Sd805udrI4HnBpR38DXMcpQ7NP7Cc=\n=V+G0\n-----END PGP SIGNATURE-----\n", "payload": "tree fcdf459aa8bd9413e845e55c909cab892a79fc82\nparent 078844283c8943b34b5b4ed90f6032c042dc4416\nparent 86e2ca30880a06cb9dbcef1db4a20266e54cf862\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1660892200 +0530\ncommitter GitHub <noreply@github.com> 1660892200 +0530\n\nRollup merge of #100081 - RalfJung:unused-unsafe-in-unsafe-fn, r=jackh726\n\nnever consider unsafe blocks unused if they would be required with deny(unsafe_op_in_unsafe_fn)\n\nJudging from https://github.com/rust-lang/rust/issues/71668#issuecomment-1200317370 the consensus nowadays seems to be that we should never consider an unsafe block unused if it was required with `deny(unsafe_op_in_unsafe_fn)`, no matter whether that lint is actually enabled or not. So let's adjust rustc accordingly.\n\nThe first commit does the change, the 2nd does some cleanup.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2fe29753912a1be758a56453eaa80ddbe745300a", "html_url": "https://github.com/rust-lang/rust/commit/2fe29753912a1be758a56453eaa80ddbe745300a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2fe29753912a1be758a56453eaa80ddbe745300a/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "078844283c8943b34b5b4ed90f6032c042dc4416", "url": "https://api.github.com/repos/rust-lang/rust/commits/078844283c8943b34b5b4ed90f6032c042dc4416", "html_url": "https://github.com/rust-lang/rust/commit/078844283c8943b34b5b4ed90f6032c042dc4416"}, {"sha": "86e2ca30880a06cb9dbcef1db4a20266e54cf862", "url": "https://api.github.com/repos/rust-lang/rust/commits/86e2ca30880a06cb9dbcef1db4a20266e54cf862", "html_url": "https://github.com/rust-lang/rust/commit/86e2ca30880a06cb9dbcef1db4a20266e54cf862"}], "stats": {"total": 829, "additions": 134, "deletions": 695}, "files": [{"sha": "04159bff4ff411539cf7983a633e24c13b11235f", "filename": "compiler/rustc_errors/src/diagnostic_builder.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2fe29753912a1be758a56453eaa80ddbe745300a/compiler%2Frustc_errors%2Fsrc%2Fdiagnostic_builder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fe29753912a1be758a56453eaa80ddbe745300a/compiler%2Frustc_errors%2Fsrc%2Fdiagnostic_builder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Fdiagnostic_builder.rs?ref=2fe29753912a1be758a56453eaa80ddbe745300a", "patch": "@@ -566,7 +566,7 @@ impl Drop for DiagnosticBuilderInner<'_> {\n                         ),\n                     ));\n                     handler.emit_diagnostic(&mut self.diagnostic);\n-                    panic!();\n+                    panic!(\"error was constructed but not emitted\");\n                 }\n             }\n             // `.emit()` was previously called, or maybe we're during `.cancel()`."}, {"sha": "594c14a642ded51def3afe5ee4ae60cee3d3e345", "filename": "compiler/rustc_middle/src/mir/query.rs", "status": "modified", "additions": 2, "deletions": 20, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/2fe29753912a1be758a56453eaa80ddbe745300a/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fquery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fe29753912a1be758a56453eaa80ddbe745300a/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fquery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fquery.rs?ref=2fe29753912a1be758a56453eaa80ddbe745300a", "patch": "@@ -2,7 +2,7 @@\n \n use crate::mir::{Body, ConstantKind, Promoted};\n use crate::ty::{self, OpaqueHiddenType, Ty, TyCtxt};\n-use rustc_data_structures::fx::FxHashMap;\n+use rustc_data_structures::fx::FxHashSet;\n use rustc_data_structures::vec_map::VecMap;\n use rustc_errors::ErrorGuaranteed;\n use rustc_hir as hir;\n@@ -115,21 +115,6 @@ pub enum UnusedUnsafe {\n     /// `unsafe` block nested under another (used) `unsafe` block\n     /// > ``\u2026 because it's nested under this `unsafe` block``\n     InUnsafeBlock(hir::HirId),\n-    /// `unsafe` block nested under `unsafe fn`\n-    /// > ``\u2026 because it's nested under this `unsafe fn` ``\n-    ///\n-    /// the second HirId here indicates the first usage of the `unsafe` block,\n-    /// which allows retrieval of the LintLevelSource for why that operation would\n-    /// have been permitted without the block\n-    InUnsafeFn(hir::HirId, hir::HirId),\n-}\n-\n-#[derive(Copy, Clone, PartialEq, TyEncodable, TyDecodable, HashStable, Debug)]\n-pub enum UsedUnsafeBlockData {\n-    SomeDisallowedInUnsafeFn,\n-    // the HirId here indicates the first usage of the `unsafe` block\n-    // (i.e. the one that's first encountered in the MIR traversal of the unsafety check)\n-    AllAllowedInUnsafeFn(hir::HirId),\n }\n \n #[derive(TyEncodable, TyDecodable, HashStable, Debug)]\n@@ -138,10 +123,7 @@ pub struct UnsafetyCheckResult {\n     pub violations: Vec<UnsafetyViolation>,\n \n     /// Used `unsafe` blocks in this function. This is used for the \"unused_unsafe\" lint.\n-    ///\n-    /// The keys are the used `unsafe` blocks, the UnusedUnsafeKind indicates whether\n-    /// or not any of the usages happen at a place that doesn't allow `unsafe_op_in_unsafe_fn`.\n-    pub used_unsafe_blocks: FxHashMap<hir::HirId, UsedUnsafeBlockData>,\n+    pub used_unsafe_blocks: FxHashSet<hir::HirId>,\n \n     /// This is `Some` iff the item is not a closure.\n     pub unused_unsafes: Option<Vec<(hir::HirId, UnusedUnsafe)>>,"}, {"sha": "f0b0456c4b9610a7e2bec3488188d0266726c55a", "filename": "compiler/rustc_mir_build/src/check_unsafety.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/2fe29753912a1be758a56453eaa80ddbe745300a/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fe29753912a1be758a56453eaa80ddbe745300a/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs?ref=2fe29753912a1be758a56453eaa80ddbe745300a", "patch": "@@ -75,10 +75,11 @@ impl<'tcx> UnsafetyVisitor<'_, 'tcx> {\n         match self.safety_context {\n             SafetyContext::BuiltinUnsafeBlock => {}\n             SafetyContext::UnsafeBlock { ref mut used, .. } => {\n-                if !self.body_unsafety.is_unsafe() || !unsafe_op_in_unsafe_fn_allowed {\n-                    // Mark this block as useful\n-                    *used = true;\n-                }\n+                // Mark this block as useful (even inside `unsafe fn`, where it is technically\n+                // redundant -- but we want to eventually enable `unsafe_op_in_unsafe_fn` by\n+                // default which will require those blocks:\n+                // https://github.com/rust-lang/rust/issues/71668#issuecomment-1203075594).\n+                *used = true;\n             }\n             SafetyContext::UnsafeFn if unsafe_op_in_unsafe_fn_allowed => {}\n             SafetyContext::UnsafeFn => {"}, {"sha": "0f5fd77f7ab164368e67dda28392af2c125ebc6a", "filename": "compiler/rustc_mir_transform/src/check_unsafety.rs", "status": "modified", "additions": 17, "deletions": 71, "changes": 88, "blob_url": "https://github.com/rust-lang/rust/blob/2fe29753912a1be758a56453eaa80ddbe745300a/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fe29753912a1be758a56453eaa80ddbe745300a/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_unsafety.rs?ref=2fe29753912a1be758a56453eaa80ddbe745300a", "patch": "@@ -1,17 +1,16 @@\n-use rustc_data_structures::fx::FxHashMap;\n+use rustc_data_structures::fx::FxHashSet;\n use rustc_errors::struct_span_err;\n use rustc_hir as hir;\n use rustc_hir::def_id::{DefId, LocalDefId};\n use rustc_hir::hir_id::HirId;\n use rustc_hir::intravisit;\n use rustc_middle::mir::visit::{MutatingUseContext, PlaceContext, Visitor};\n+use rustc_middle::mir::*;\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::{self, TyCtxt};\n-use rustc_middle::{lint, mir::*};\n use rustc_session::lint::builtin::{UNSAFE_OP_IN_UNSAFE_FN, UNUSED_UNSAFE};\n use rustc_session::lint::Level;\n \n-use std::collections::hash_map;\n use std::ops::Bound;\n \n pub struct UnsafetyChecker<'a, 'tcx> {\n@@ -23,10 +22,7 @@ pub struct UnsafetyChecker<'a, 'tcx> {\n     param_env: ty::ParamEnv<'tcx>,\n \n     /// Used `unsafe` blocks in this function. This is used for the \"unused_unsafe\" lint.\n-    ///\n-    /// The keys are the used `unsafe` blocks, the UnusedUnsafeKind indicates whether\n-    /// or not any of the usages happen at a place that doesn't allow `unsafe_op_in_unsafe_fn`.\n-    used_unsafe_blocks: FxHashMap<HirId, UsedUnsafeBlockData>,\n+    used_unsafe_blocks: FxHashSet<HirId>,\n }\n \n impl<'a, 'tcx> UnsafetyChecker<'a, 'tcx> {\n@@ -130,10 +126,7 @@ impl<'tcx> Visitor<'tcx> for UnsafetyChecker<'_, 'tcx> {\n                 &AggregateKind::Closure(def_id, _) | &AggregateKind::Generator(def_id, _, _) => {\n                     let UnsafetyCheckResult { violations, used_unsafe_blocks, .. } =\n                         self.tcx.unsafety_check_result(def_id);\n-                    self.register_violations(\n-                        violations,\n-                        used_unsafe_blocks.iter().map(|(&h, &d)| (h, d)),\n-                    );\n+                    self.register_violations(violations, used_unsafe_blocks.iter().copied());\n                 }\n             },\n             _ => {}\n@@ -257,22 +250,8 @@ impl<'tcx> UnsafetyChecker<'_, 'tcx> {\n     fn register_violations<'a>(\n         &mut self,\n         violations: impl IntoIterator<Item = &'a UnsafetyViolation>,\n-        new_used_unsafe_blocks: impl IntoIterator<Item = (HirId, UsedUnsafeBlockData)>,\n+        new_used_unsafe_blocks: impl IntoIterator<Item = HirId>,\n     ) {\n-        use UsedUnsafeBlockData::{AllAllowedInUnsafeFn, SomeDisallowedInUnsafeFn};\n-\n-        let update_entry = |this: &mut Self, hir_id, new_usage| {\n-            match this.used_unsafe_blocks.entry(hir_id) {\n-                hash_map::Entry::Occupied(mut entry) => {\n-                    if new_usage == SomeDisallowedInUnsafeFn {\n-                        *entry.get_mut() = SomeDisallowedInUnsafeFn;\n-                    }\n-                }\n-                hash_map::Entry::Vacant(entry) => {\n-                    entry.insert(new_usage);\n-                }\n-            };\n-        };\n         let safety = self.body.source_scopes[self.source_info.scope]\n             .local_data\n             .as_ref()\n@@ -299,22 +278,14 @@ impl<'tcx> UnsafetyChecker<'_, 'tcx> {\n                 }\n             }),\n             Safety::BuiltinUnsafe => {}\n-            Safety::ExplicitUnsafe(hir_id) => violations.into_iter().for_each(|violation| {\n-                update_entry(\n-                    self,\n-                    hir_id,\n-                    match self.tcx.lint_level_at_node(UNSAFE_OP_IN_UNSAFE_FN, violation.lint_root).0\n-                    {\n-                        Level::Allow => AllAllowedInUnsafeFn(violation.lint_root),\n-                        _ => SomeDisallowedInUnsafeFn,\n-                    },\n-                )\n+            Safety::ExplicitUnsafe(hir_id) => violations.into_iter().for_each(|_violation| {\n+                self.used_unsafe_blocks.insert(hir_id);\n             }),\n         };\n \n-        new_used_unsafe_blocks\n-            .into_iter()\n-            .for_each(|(hir_id, usage_data)| update_entry(self, hir_id, usage_data));\n+        new_used_unsafe_blocks.into_iter().for_each(|hir_id| {\n+            self.used_unsafe_blocks.insert(hir_id);\n+        });\n     }\n     fn check_mut_borrowing_layout_constrained_field(\n         &mut self,\n@@ -411,34 +382,28 @@ enum Context {\n \n struct UnusedUnsafeVisitor<'a, 'tcx> {\n     tcx: TyCtxt<'tcx>,\n-    used_unsafe_blocks: &'a FxHashMap<HirId, UsedUnsafeBlockData>,\n+    used_unsafe_blocks: &'a FxHashSet<HirId>,\n     context: Context,\n     unused_unsafes: &'a mut Vec<(HirId, UnusedUnsafe)>,\n }\n \n impl<'tcx> intravisit::Visitor<'tcx> for UnusedUnsafeVisitor<'_, 'tcx> {\n     fn visit_block(&mut self, block: &'tcx hir::Block<'tcx>) {\n-        use UsedUnsafeBlockData::{AllAllowedInUnsafeFn, SomeDisallowedInUnsafeFn};\n-\n         if let hir::BlockCheckMode::UnsafeBlock(hir::UnsafeSource::UserProvided) = block.rules {\n             let used = match self.tcx.lint_level_at_node(UNUSED_UNSAFE, block.hir_id) {\n-                (Level::Allow, _) => Some(SomeDisallowedInUnsafeFn),\n-                _ => self.used_unsafe_blocks.get(&block.hir_id).copied(),\n+                (Level::Allow, _) => true,\n+                _ => self.used_unsafe_blocks.contains(&block.hir_id),\n             };\n             let unused_unsafe = match (self.context, used) {\n-                (_, None) => UnusedUnsafe::Unused,\n-                (Context::Safe, Some(_))\n-                | (Context::UnsafeFn(_), Some(SomeDisallowedInUnsafeFn)) => {\n+                (_, false) => UnusedUnsafe::Unused,\n+                (Context::Safe, true) | (Context::UnsafeFn(_), true) => {\n                     let previous_context = self.context;\n                     self.context = Context::UnsafeBlock(block.hir_id);\n                     intravisit::walk_block(self, block);\n                     self.context = previous_context;\n                     return;\n                 }\n-                (Context::UnsafeFn(hir_id), Some(AllAllowedInUnsafeFn(lint_root))) => {\n-                    UnusedUnsafe::InUnsafeFn(hir_id, lint_root)\n-                }\n-                (Context::UnsafeBlock(hir_id), Some(_)) => UnusedUnsafe::InUnsafeBlock(hir_id),\n+                (Context::UnsafeBlock(hir_id), true) => UnusedUnsafe::InUnsafeBlock(hir_id),\n             };\n             self.unused_unsafes.push((block.hir_id, unused_unsafe));\n         }\n@@ -462,7 +427,7 @@ impl<'tcx> intravisit::Visitor<'tcx> for UnusedUnsafeVisitor<'_, 'tcx> {\n fn check_unused_unsafe(\n     tcx: TyCtxt<'_>,\n     def_id: LocalDefId,\n-    used_unsafe_blocks: &FxHashMap<HirId, UsedUnsafeBlockData>,\n+    used_unsafe_blocks: &FxHashSet<HirId>,\n ) -> Vec<(HirId, UnusedUnsafe)> {\n     let body_id = tcx.hir().maybe_body_owned_by(def_id);\n \n@@ -535,25 +500,6 @@ fn report_unused_unsafe(tcx: TyCtxt<'_>, kind: UnusedUnsafe, id: HirId) {\n                     \"because it's nested under this `unsafe` block\",\n                 );\n             }\n-            UnusedUnsafe::InUnsafeFn(id, usage_lint_root) => {\n-                db.span_label(\n-                    tcx.sess.source_map().guess_head_span(tcx.hir().span(id)),\n-                    \"because it's nested under this `unsafe` fn\",\n-                )\n-                .note(\n-                    \"this `unsafe` block does contain unsafe operations, \\\n-                    but those are already allowed in an `unsafe fn`\",\n-                );\n-                let (level, source) =\n-                    tcx.lint_level_at_node(UNSAFE_OP_IN_UNSAFE_FN, usage_lint_root);\n-                assert_eq!(level, Level::Allow);\n-                lint::explain_lint_level_source(\n-                    UNSAFE_OP_IN_UNSAFE_FN,\n-                    Level::Allow,\n-                    source,\n-                    &mut db,\n-                );\n-            }\n         }\n \n         db.emit();"}, {"sha": "adb72c26bba470274533ab8b03aafff9d4b1dac4", "filename": "src/test/ui/span/lint-unused-unsafe-thir.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe-thir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe-thir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe-thir.rs?ref=2fe29753912a1be758a56453eaa80ddbe745300a", "patch": "@@ -22,7 +22,7 @@ fn bad1() { unsafe {} }                  //~ ERROR: unnecessary `unsafe` block\n fn bad2() { unsafe { bad1() } }          //~ ERROR: unnecessary `unsafe` block\n unsafe fn bad3() { unsafe {} }           //~ ERROR: unnecessary `unsafe` block\n fn bad4() { unsafe { callback(||{}) } }  //~ ERROR: unnecessary `unsafe` block\n-unsafe fn bad5() { unsafe { unsf() } }   //~ ERROR: unnecessary `unsafe` block\n+unsafe fn bad5() { unsafe { unsf() } }\n fn bad6() {\n     unsafe {                             // don't put the warning here\n         unsafe {                         //~ ERROR: unnecessary `unsafe` block\n@@ -31,7 +31,7 @@ fn bad6() {\n     }\n }\n unsafe fn bad7() {\n-    unsafe {                             //~ ERROR: unnecessary `unsafe` block\n+    unsafe {\n         unsafe {                         //~ ERROR: unnecessary `unsafe` block\n             unsf()\n         }"}, {"sha": "3bcbb759775aac879dc2cc2a4c157f5442b30309", "filename": "src/test/ui/span/lint-unused-unsafe-thir.stderr", "status": "modified", "additions": 1, "deletions": 17, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe-thir.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe-thir.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe-thir.stderr?ref=2fe29753912a1be758a56453eaa80ddbe745300a", "patch": "@@ -30,14 +30,6 @@ error: unnecessary `unsafe` block\n LL | fn bad4() { unsafe { callback(||{}) } }\n    |             ^^^^^^ unnecessary `unsafe` block\n \n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe-thir.rs:25:20\n-   |\n-LL | unsafe fn bad5() { unsafe { unsf() } }\n-   | ----------------   ^^^^^^ unnecessary `unsafe` block\n-   | |\n-   | because it's nested under this `unsafe` fn\n-\n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe-thir.rs:28:9\n    |\n@@ -54,13 +46,5 @@ LL |     unsafe {\n LL |         unsafe {\n    |         ^^^^^^ unnecessary `unsafe` block\n \n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe-thir.rs:34:5\n-   |\n-LL | unsafe fn bad7() {\n-   | ---------------- because it's nested under this `unsafe` fn\n-LL |     unsafe {\n-   |     ^^^^^^ unnecessary `unsafe` block\n-\n-error: aborting due to 8 previous errors\n+error: aborting due to 6 previous errors\n "}, {"sha": "d8412908c738320512891c307ac39aa3ff1e155c", "filename": "src/test/ui/span/lint-unused-unsafe.mir.stderr", "status": "modified", "additions": 63, "deletions": 485, "changes": 548, "blob_url": "https://github.com/rust-lang/rust/blob/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe.mir.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe.mir.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe.mir.stderr?ref=2fe29753912a1be758a56453eaa80ddbe745300a", "patch": "@@ -28,17 +28,6 @@ error: unnecessary `unsafe` block\n LL | fn bad4() { unsafe { callback(||{}) } }\n    |             ^^^^^^ unnecessary `unsafe` block\n \n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:30:20\n-   |\n-LL | unsafe fn bad5() { unsafe { unsf() } }\n-   | ----------------   ^^^^^^ unnecessary `unsafe` block\n-   | |\n-   | because it's nested under this `unsafe` fn\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-   = note: `#[allow(unsafe_op_in_unsafe_fn)]` on by default\n-\n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:32:5\n    |\n@@ -51,17 +40,6 @@ error: unnecessary `unsafe` block\n LL |     unsafe {\n    |     ^^^^^^ unnecessary `unsafe` block\n \n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:40:9\n-   |\n-LL | unsafe fn bad7() {\n-   | ---------------- because it's nested under this `unsafe` fn\n-LL |     unsafe {\n-LL |         unsafe {\n-   |         ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:74:9\n    |\n@@ -272,91 +250,32 @@ error: unnecessary `unsafe` block\n LL |         unsafe {\n    |         ^^^^^^ unnecessary `unsafe` block\n \n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:197:13\n-   |\n-LL |     unsafe fn granularity_2() {\n-   |     ------------------------- because it's nested under this `unsafe` fn\n-LL |         unsafe {\n-LL |             unsafe { unsf() }\n-   |             ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:194:13\n-   |\n-LL |     #[allow(unsafe_op_in_unsafe_fn)]\n-   |             ^^^^^^^^^^^^^^^^^^^^^^\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:198:13\n-   |\n-LL |     unsafe fn granularity_2() {\n-   |     ------------------------- because it's nested under this `unsafe` fn\n-...\n-LL |             unsafe { unsf() }\n-   |             ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:199:13\n-   |\n-LL |     unsafe fn granularity_2() {\n-   |     ------------------------- because it's nested under this `unsafe` fn\n-...\n-LL |             unsafe { unsf() }\n-   |             ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:205:9\n-   |\n-LL |     unsafe fn top_level_used_2() {\n-   |     ---------------------------- because it's nested under this `unsafe` fn\n-LL |         unsafe {\n-   |         ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:203:13\n-   |\n-LL |     #[allow(unsafe_op_in_unsafe_fn)]\n-   |             ^^^^^^^^^^^^^^^^^^^^^^\n-\n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:207:13\n    |\n-LL |     unsafe fn top_level_used_2() {\n-   |     ---------------------------- because it's nested under this `unsafe` fn\n-...\n+LL |         unsafe {\n+   |         ------ because it's nested under this `unsafe` block\n+LL |             unsf();\n LL |             unsafe { unsf() }\n    |             ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:208:13\n    |\n-LL |     unsafe fn top_level_used_2() {\n-   |     ---------------------------- because it's nested under this `unsafe` fn\n+LL |         unsafe {\n+   |         ------ because it's nested under this `unsafe` block\n ...\n LL |             unsafe { unsf() }\n    |             ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:209:13\n    |\n-LL |     unsafe fn top_level_used_2() {\n-   |     ---------------------------- because it's nested under this `unsafe` fn\n+LL |         unsafe {\n+   |         ------ because it's nested under this `unsafe` block\n ...\n LL |             unsafe { unsf() }\n    |             ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:220:17\n@@ -398,19 +317,12 @@ LL |         unsafe {\n    |         ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:254:9\n+  --> $DIR/lint-unused-unsafe.rs:255:13\n    |\n-LL |     unsafe fn granular_disallow_op_in_unsafe_fn_3() {\n-   |     ----------------------------------------------- because it's nested under this `unsafe` fn\n LL |         unsafe {\n-   |         ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:252:13\n-   |\n-LL |     #[allow(unsafe_op_in_unsafe_fn)]\n-   |             ^^^^^^^^^^^^^^^^^^^^^^\n+   |         ------ because it's nested under this `unsafe` block\n+LL |             unsafe {\n+   |             ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:268:13\n@@ -630,91 +542,32 @@ error: unnecessary `unsafe` block\n LL |         let _ = || unsafe {\n    |                    ^^^^^^ unnecessary `unsafe` block\n \n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:409:24\n-   |\n-LL |     unsafe fn granularity_2() {\n-   |     ------------------------- because it's nested under this `unsafe` fn\n-LL |         let _ = || unsafe {\n-LL |             let _ = || unsafe { unsf() };\n-   |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:406:13\n-   |\n-LL |     #[allow(unsafe_op_in_unsafe_fn)]\n-   |             ^^^^^^^^^^^^^^^^^^^^^^\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:410:24\n-   |\n-LL |     unsafe fn granularity_2() {\n-   |     ------------------------- because it's nested under this `unsafe` fn\n-...\n-LL |             let _ = || unsafe { unsf() };\n-   |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:411:24\n-   |\n-LL |     unsafe fn granularity_2() {\n-   |     ------------------------- because it's nested under this `unsafe` fn\n-...\n-LL |             let _ = || unsafe { unsf() };\n-   |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:417:20\n-   |\n-LL |     unsafe fn top_level_used_2() {\n-   |     ---------------------------- because it's nested under this `unsafe` fn\n-LL |         let _ = || unsafe {\n-   |                    ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:415:13\n-   |\n-LL |     #[allow(unsafe_op_in_unsafe_fn)]\n-   |             ^^^^^^^^^^^^^^^^^^^^^^\n-\n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:419:24\n    |\n-LL |     unsafe fn top_level_used_2() {\n-   |     ---------------------------- because it's nested under this `unsafe` fn\n-...\n+LL |         let _ = || unsafe {\n+   |                    ------ because it's nested under this `unsafe` block\n+LL |             unsf();\n LL |             let _ = || unsafe { unsf() };\n    |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:420:24\n    |\n-LL |     unsafe fn top_level_used_2() {\n-   |     ---------------------------- because it's nested under this `unsafe` fn\n+LL |         let _ = || unsafe {\n+   |                    ------ because it's nested under this `unsafe` block\n ...\n LL |             let _ = || unsafe { unsf() };\n    |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:421:24\n    |\n-LL |     unsafe fn top_level_used_2() {\n-   |     ---------------------------- because it's nested under this `unsafe` fn\n+LL |         let _ = || unsafe {\n+   |                    ------ because it's nested under this `unsafe` block\n ...\n LL |             let _ = || unsafe { unsf() };\n    |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:432:28\n@@ -756,19 +609,12 @@ LL |         let _ = || unsafe {\n    |                    ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:466:20\n+  --> $DIR/lint-unused-unsafe.rs:467:24\n    |\n-LL |     unsafe fn granular_disallow_op_in_unsafe_fn_3() {\n-   |     ----------------------------------------------- because it's nested under this `unsafe` fn\n LL |         let _ = || unsafe {\n-   |                    ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:464:13\n-   |\n-LL |     #[allow(unsafe_op_in_unsafe_fn)]\n-   |             ^^^^^^^^^^^^^^^^^^^^^^\n+   |                    ------ because it's nested under this `unsafe` block\n+LL |             let _ = || unsafe {\n+   |                        ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:480:24\n@@ -988,91 +834,32 @@ error: unnecessary `unsafe` block\n LL |         let _ = || unsafe {\n    |                    ^^^^^^ unnecessary `unsafe` block\n \n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:622:24\n-   |\n-LL |     unsafe fn granularity_2() {\n-   |     ------------------------- because it's nested under this `unsafe` fn\n-LL |         let _ = || unsafe {\n-LL |             let _ = || unsafe { let _ = || unsf(); };\n-   |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:619:13\n-   |\n-LL |     #[allow(unsafe_op_in_unsafe_fn)]\n-   |             ^^^^^^^^^^^^^^^^^^^^^^\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:623:24\n-   |\n-LL |     unsafe fn granularity_2() {\n-   |     ------------------------- because it's nested under this `unsafe` fn\n-...\n-LL |             let _ = || unsafe { let _ = || unsf(); };\n-   |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:624:24\n-   |\n-LL |     unsafe fn granularity_2() {\n-   |     ------------------------- because it's nested under this `unsafe` fn\n-...\n-LL |             let _ = || unsafe { let _ = || unsf(); };\n-   |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:630:20\n-   |\n-LL |     unsafe fn top_level_used_2() {\n-   |     ---------------------------- because it's nested under this `unsafe` fn\n-LL |         let _ = || unsafe {\n-   |                    ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:628:13\n-   |\n-LL |     #[allow(unsafe_op_in_unsafe_fn)]\n-   |             ^^^^^^^^^^^^^^^^^^^^^^\n-\n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:632:24\n    |\n-LL |     unsafe fn top_level_used_2() {\n-   |     ---------------------------- because it's nested under this `unsafe` fn\n-...\n+LL |         let _ = || unsafe {\n+   |                    ------ because it's nested under this `unsafe` block\n+LL |             let _ = || unsf();\n LL |             let _ = || unsafe { let _ = || unsf(); };\n    |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:633:24\n    |\n-LL |     unsafe fn top_level_used_2() {\n-   |     ---------------------------- because it's nested under this `unsafe` fn\n+LL |         let _ = || unsafe {\n+   |                    ------ because it's nested under this `unsafe` block\n ...\n LL |             let _ = || unsafe { let _ = || unsf(); };\n    |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:634:24\n    |\n-LL |     unsafe fn top_level_used_2() {\n-   |     ---------------------------- because it's nested under this `unsafe` fn\n+LL |         let _ = || unsafe {\n+   |                    ------ because it's nested under this `unsafe` block\n ...\n LL |             let _ = || unsafe { let _ = || unsf(); };\n    |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:645:28\n@@ -1114,19 +901,12 @@ LL |         let _ = || unsafe {\n    |                    ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:679:20\n+  --> $DIR/lint-unused-unsafe.rs:680:24\n    |\n-LL |     unsafe fn granular_disallow_op_in_unsafe_fn_3() {\n-   |     ----------------------------------------------- because it's nested under this `unsafe` fn\n LL |         let _ = || unsafe {\n-   |                    ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:677:13\n-   |\n-LL |     #[allow(unsafe_op_in_unsafe_fn)]\n-   |             ^^^^^^^^^^^^^^^^^^^^^^\n+   |                    ------ because it's nested under this `unsafe` block\n+LL |             let _ = || unsafe {\n+   |                        ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:693:24\n@@ -1256,91 +1036,32 @@ error: unnecessary `unsafe` block\n LL |             let _ = || unsafe {\n    |                        ^^^^^^ unnecessary `unsafe` block\n \n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:784:28\n-   |\n-LL |         unsafe fn granularity_2() {\n-   |         ------------------------- because it's nested under this `unsafe` fn\n-LL |             let _ = || unsafe {\n-LL |                 let _ = || unsafe { unsf() };\n-   |                            ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:781:17\n-   |\n-LL |         #[allow(unsafe_op_in_unsafe_fn)]\n-   |                 ^^^^^^^^^^^^^^^^^^^^^^\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:785:28\n-   |\n-LL |         unsafe fn granularity_2() {\n-   |         ------------------------- because it's nested under this `unsafe` fn\n-...\n-LL |                 let _ = || unsafe { unsf() };\n-   |                            ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:786:28\n-   |\n-LL |         unsafe fn granularity_2() {\n-   |         ------------------------- because it's nested under this `unsafe` fn\n-...\n-LL |                 let _ = || unsafe { unsf() };\n-   |                            ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:792:24\n-   |\n-LL |         unsafe fn top_level_used_2() {\n-   |         ---------------------------- because it's nested under this `unsafe` fn\n-LL |             let _ = || unsafe {\n-   |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:790:17\n-   |\n-LL |         #[allow(unsafe_op_in_unsafe_fn)]\n-   |                 ^^^^^^^^^^^^^^^^^^^^^^\n-\n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:794:28\n    |\n-LL |         unsafe fn top_level_used_2() {\n-   |         ---------------------------- because it's nested under this `unsafe` fn\n-...\n+LL |             let _ = || unsafe {\n+   |                        ------ because it's nested under this `unsafe` block\n+LL |                 unsf();\n LL |                 let _ = || unsafe { unsf() };\n    |                            ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:795:28\n    |\n-LL |         unsafe fn top_level_used_2() {\n-   |         ---------------------------- because it's nested under this `unsafe` fn\n+LL |             let _ = || unsafe {\n+   |                        ------ because it's nested under this `unsafe` block\n ...\n LL |                 let _ = || unsafe { unsf() };\n    |                            ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:796:28\n    |\n-LL |         unsafe fn top_level_used_2() {\n-   |         ---------------------------- because it's nested under this `unsafe` fn\n+LL |             let _ = || unsafe {\n+   |                        ------ because it's nested under this `unsafe` block\n ...\n LL |                 let _ = || unsafe { unsf() };\n    |                            ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:807:32\n@@ -1382,19 +1103,12 @@ LL |             let _ = || unsafe {\n    |                        ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:841:24\n+  --> $DIR/lint-unused-unsafe.rs:842:28\n    |\n-LL |         unsafe fn granular_disallow_op_in_unsafe_fn_3() {\n-   |         ----------------------------------------------- because it's nested under this `unsafe` fn\n LL |             let _ = || unsafe {\n-   |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:839:17\n-   |\n-LL |         #[allow(unsafe_op_in_unsafe_fn)]\n-   |                 ^^^^^^^^^^^^^^^^^^^^^^\n+   |                        ------ because it's nested under this `unsafe` block\n+LL |                 let _ = || unsafe {\n+   |                            ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:855:28\n@@ -1524,91 +1238,32 @@ error: unnecessary `unsafe` block\n LL |             let _ = || unsafe {\n    |                        ^^^^^^ unnecessary `unsafe` block\n \n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:942:28\n-   |\n-LL |         unsafe fn granularity_2() {\n-   |         ------------------------- because it's nested under this `unsafe` fn\n-LL |             let _ = || unsafe {\n-LL |                 let _ = || unsafe { unsf() };\n-   |                            ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:939:17\n-   |\n-LL |         #[allow(unsafe_op_in_unsafe_fn)]\n-   |                 ^^^^^^^^^^^^^^^^^^^^^^\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:943:28\n-   |\n-LL |         unsafe fn granularity_2() {\n-   |         ------------------------- because it's nested under this `unsafe` fn\n-...\n-LL |                 let _ = || unsafe { unsf() };\n-   |                            ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:944:28\n-   |\n-LL |         unsafe fn granularity_2() {\n-   |         ------------------------- because it's nested under this `unsafe` fn\n-...\n-LL |                 let _ = || unsafe { unsf() };\n-   |                            ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:950:24\n-   |\n-LL |         unsafe fn top_level_used_2() {\n-   |         ---------------------------- because it's nested under this `unsafe` fn\n-LL |             let _ = || unsafe {\n-   |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:948:17\n-   |\n-LL |         #[allow(unsafe_op_in_unsafe_fn)]\n-   |                 ^^^^^^^^^^^^^^^^^^^^^^\n-\n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:952:28\n    |\n-LL |         unsafe fn top_level_used_2() {\n-   |         ---------------------------- because it's nested under this `unsafe` fn\n-...\n+LL |             let _ = || unsafe {\n+   |                        ------ because it's nested under this `unsafe` block\n+LL |                 unsf();\n LL |                 let _ = || unsafe { unsf() };\n    |                            ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:953:28\n    |\n-LL |         unsafe fn top_level_used_2() {\n-   |         ---------------------------- because it's nested under this `unsafe` fn\n+LL |             let _ = || unsafe {\n+   |                        ------ because it's nested under this `unsafe` block\n ...\n LL |                 let _ = || unsafe { unsf() };\n    |                            ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:954:28\n    |\n-LL |         unsafe fn top_level_used_2() {\n-   |         ---------------------------- because it's nested under this `unsafe` fn\n+LL |             let _ = || unsafe {\n+   |                        ------ because it's nested under this `unsafe` block\n ...\n LL |                 let _ = || unsafe { unsf() };\n    |                            ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:965:32\n@@ -1650,19 +1305,12 @@ LL |             let _ = || unsafe {\n    |                        ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:999:24\n+  --> $DIR/lint-unused-unsafe.rs:1000:28\n    |\n-LL |         unsafe fn granular_disallow_op_in_unsafe_fn_3() {\n-   |         ----------------------------------------------- because it's nested under this `unsafe` fn\n LL |             let _ = || unsafe {\n-   |                        ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:997:17\n-   |\n-LL |         #[allow(unsafe_op_in_unsafe_fn)]\n-   |                 ^^^^^^^^^^^^^^^^^^^^^^\n+   |                        ------ because it's nested under this `unsafe` block\n+LL |                 let _ = || unsafe {\n+   |                            ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:1013:28\n@@ -1672,21 +1320,6 @@ LL |             let _ = || unsafe {\n LL |                 let _ = || unsafe {\n    |                            ^^^^^^ unnecessary `unsafe` block\n \n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:1044:9\n-   |\n-LL |     unsafe fn multiple_unsafe_op_in_unsafe_fn_allows() {\n-   |     -------------------------------------------------- because it's nested under this `unsafe` fn\n-LL |         unsafe {\n-   |         ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:1045:21\n-   |\n-LL |             #[allow(unsafe_op_in_unsafe_fn)]\n-   |                     ^^^^^^^^^^^^^^^^^^^^^^\n-\n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:1059:29\n    |\n@@ -1726,87 +1359,32 @@ error: unnecessary `unsafe` block\n LL |             let _ = async { unsafe {\n    |                             ^^^^^^ unnecessary `unsafe` block\n \n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:1074:33\n-   |\n-LL |     async unsafe fn async_blocks() {\n-   |     ------------------------------ because it's nested under this `unsafe` fn\n-...\n-LL |                 let _ = async { unsafe { let _ = async { unsf() }; }};\n-   |                                 ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/lint-unused-unsafe.rs:1071:17\n-   |\n-LL |         #[allow(unsafe_op_in_unsafe_fn)]\n-   |                 ^^^^^^^^^^^^^^^^^^^^^^\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:1075:33\n-   |\n-LL |     async unsafe fn async_blocks() {\n-   |     ------------------------------ because it's nested under this `unsafe` fn\n-...\n-LL |                 let _ = async { unsafe { let _ = async { unsf() }; }};\n-   |                                 ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:1076:33\n-   |\n-LL |     async unsafe fn async_blocks() {\n-   |     ------------------------------ because it's nested under this `unsafe` fn\n-...\n-LL |                 let _ = async { unsafe { let _ = async { unsf() }; }};\n-   |                                 ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:1078:29\n-   |\n-LL |     async unsafe fn async_blocks() {\n-   |     ------------------------------ because it's nested under this `unsafe` fn\n-...\n-LL |             let _ = async { unsafe {\n-   |                             ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-\n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:1080:33\n    |\n-LL |     async unsafe fn async_blocks() {\n-   |     ------------------------------ because it's nested under this `unsafe` fn\n-...\n+LL |             let _ = async { unsafe {\n+   |                             ------ because it's nested under this `unsafe` block\n+LL |                 let _ = async { unsf() };\n LL |                 let _ = async { unsafe { let _ = async { unsf() }; }};\n    |                                 ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:1081:33\n    |\n-LL |     async unsafe fn async_blocks() {\n-   |     ------------------------------ because it's nested under this `unsafe` fn\n+LL |             let _ = async { unsafe {\n+   |                             ------ because it's nested under this `unsafe` block\n ...\n LL |                 let _ = async { unsafe { let _ = async { unsf() }; }};\n    |                                 ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:1082:33\n    |\n-LL |     async unsafe fn async_blocks() {\n-   |     ------------------------------ because it's nested under this `unsafe` fn\n+LL |             let _ = async { unsafe {\n+   |                             ------ because it's nested under this `unsafe` block\n ...\n LL |                 let _ = async { unsafe { let _ = async { unsf() }; }};\n    |                                 ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:1092:22\n@@ -1820,5 +1398,5 @@ error: unnecessary `unsafe` block\n LL |         let _x: [(); unsafe { unsafe { size() } }] = [];\n    |                      ^^^^^^ unnecessary `unsafe` block\n \n-error: aborting due to 201 previous errors\n+error: aborting due to 174 previous errors\n "}, {"sha": "5d042768be0025ee994a10e10aaf558b2a181ffe", "filename": "src/test/ui/span/lint-unused-unsafe.rs", "status": "modified", "additions": 37, "deletions": 37, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe.rs?ref=2fe29753912a1be758a56453eaa80ddbe745300a", "patch": "@@ -27,7 +27,7 @@ fn bad1() { unsafe {} }                  //~ ERROR: unnecessary `unsafe` block\n fn bad2() { unsafe { bad1() } }          //~ ERROR: unnecessary `unsafe` block\n unsafe fn bad3() { unsafe {} }           //~ ERROR: unnecessary `unsafe` block\n fn bad4() { unsafe { callback(||{}) } }  //~ ERROR: unnecessary `unsafe` block\n-unsafe fn bad5() { unsafe { unsf() } }   //~ ERROR: unnecessary `unsafe` block\n+unsafe fn bad5() { unsafe { unsf() } }\n fn bad6() {\n     unsafe {                             //~ ERROR: unnecessary `unsafe` block\n         unsafe {                         // don't put the warning here\n@@ -37,7 +37,7 @@ fn bad6() {\n }\n unsafe fn bad7() {\n     unsafe {                             //~ ERROR: unnecessary `unsafe` block\n-        unsafe {                         //~ ERROR: unnecessary `unsafe` block\n+        unsafe {\n             unsf()\n         }\n     }\n@@ -194,15 +194,15 @@ mod additional_tests {\n     #[allow(unsafe_op_in_unsafe_fn)]\n     unsafe fn granularity_2() {\n         unsafe { //~ ERROR: unnecessary `unsafe` block\n-            unsafe { unsf() } //~ ERROR: unnecessary `unsafe` block\n-            unsafe { unsf() } //~ ERROR: unnecessary `unsafe` block\n-            unsafe { unsf() } //~ ERROR: unnecessary `unsafe` block\n+            unsafe { unsf() }\n+            unsafe { unsf() }\n+            unsafe { unsf() }\n         }\n     }\n \n     #[allow(unsafe_op_in_unsafe_fn)]\n     unsafe fn top_level_used_2() {\n-        unsafe { //~ ERROR: unnecessary `unsafe` block\n+        unsafe {\n             unsf();\n             unsafe { unsf() } //~ ERROR: unnecessary `unsafe` block\n             unsafe { unsf() } //~ ERROR: unnecessary `unsafe` block\n@@ -251,8 +251,8 @@ mod additional_tests {\n \n     #[allow(unsafe_op_in_unsafe_fn)]\n     unsafe fn granular_disallow_op_in_unsafe_fn_3() {\n-        unsafe { //~ ERROR: unnecessary `unsafe` block\n-            unsafe {\n+        unsafe {\n+            unsafe { //~ ERROR: unnecessary `unsafe` block\n                 #[deny(unsafe_op_in_unsafe_fn)]\n                 {\n                     unsf();\n@@ -406,15 +406,15 @@ mod additional_tests_closures {\n     #[allow(unsafe_op_in_unsafe_fn)]\n     unsafe fn granularity_2() {\n         let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n-            let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n-            let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n-            let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n+            let _ = || unsafe { unsf() };\n+            let _ = || unsafe { unsf() };\n+            let _ = || unsafe { unsf() };\n         };\n     }\n \n     #[allow(unsafe_op_in_unsafe_fn)]\n     unsafe fn top_level_used_2() {\n-        let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n+        let _ = || unsafe {\n             unsf();\n             let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n             let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n@@ -463,8 +463,8 @@ mod additional_tests_closures {\n \n     #[allow(unsafe_op_in_unsafe_fn)]\n     unsafe fn granular_disallow_op_in_unsafe_fn_3() {\n-        let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n-            let _ = || unsafe {\n+        let _ = || unsafe {\n+            let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n                 #[deny(unsafe_op_in_unsafe_fn)]\n                 {\n                     unsf();\n@@ -619,15 +619,15 @@ mod additional_tests_even_more_closures {\n     #[allow(unsafe_op_in_unsafe_fn)]\n     unsafe fn granularity_2() {\n         let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n-            let _ = || unsafe { let _ = || unsf(); }; //~ ERROR: unnecessary `unsafe` block\n-            let _ = || unsafe { let _ = || unsf(); }; //~ ERROR: unnecessary `unsafe` block\n-            let _ = || unsafe { let _ = || unsf(); }; //~ ERROR: unnecessary `unsafe` block\n+            let _ = || unsafe { let _ = || unsf(); };\n+            let _ = || unsafe { let _ = || unsf(); };\n+            let _ = || unsafe { let _ = || unsf(); };\n         };\n     }\n \n     #[allow(unsafe_op_in_unsafe_fn)]\n     unsafe fn top_level_used_2() {\n-        let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n+        let _ = || unsafe {\n             let _ = || unsf();\n             let _ = || unsafe { let _ = || unsf(); }; //~ ERROR: unnecessary `unsafe` block\n             let _ = || unsafe { let _ = || unsf(); }; //~ ERROR: unnecessary `unsafe` block\n@@ -676,8 +676,8 @@ mod additional_tests_even_more_closures {\n \n     #[allow(unsafe_op_in_unsafe_fn)]\n     unsafe fn granular_disallow_op_in_unsafe_fn_3() {\n-        let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n-            let _ = || unsafe {\n+        let _ = || unsafe {\n+            let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n                 #[deny(unsafe_op_in_unsafe_fn)]\n                 {\n                     let _ = || unsf();\n@@ -781,15 +781,15 @@ mod item_likes {\n         #[allow(unsafe_op_in_unsafe_fn)]\n         unsafe fn granularity_2() {\n             let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n-                let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n-                let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n-                let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n+                let _ = || unsafe { unsf() };\n+                let _ = || unsafe { unsf() };\n+                let _ = || unsafe { unsf() };\n             };\n         }\n \n         #[allow(unsafe_op_in_unsafe_fn)]\n         unsafe fn top_level_used_2() {\n-            let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n+            let _ = || unsafe {\n                 unsf();\n                 let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n                 let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n@@ -838,8 +838,8 @@ mod item_likes {\n \n         #[allow(unsafe_op_in_unsafe_fn)]\n         unsafe fn granular_disallow_op_in_unsafe_fn_3() {\n-            let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n-                let _ = || unsafe {\n+            let _ = || unsafe {\n+                let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n                     #[deny(unsafe_op_in_unsafe_fn)]\n                     {\n                         unsf();\n@@ -939,15 +939,15 @@ mod item_likes {\n         #[allow(unsafe_op_in_unsafe_fn)]\n         unsafe fn granularity_2() {\n             let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n-                let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n-                let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n-                let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n+                let _ = || unsafe { unsf() };\n+                let _ = || unsafe { unsf() };\n+                let _ = || unsafe { unsf() };\n             };\n         }\n \n         #[allow(unsafe_op_in_unsafe_fn)]\n         unsafe fn top_level_used_2() {\n-            let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n+            let _ = || unsafe {\n                 unsf();\n                 let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n                 let _ = || unsafe { unsf() }; //~ ERROR: unnecessary `unsafe` block\n@@ -996,8 +996,8 @@ mod item_likes {\n \n         #[allow(unsafe_op_in_unsafe_fn)]\n         unsafe fn granular_disallow_op_in_unsafe_fn_3() {\n-            let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n-                let _ = || unsafe {\n+            let _ = || unsafe {\n+                let _ = || unsafe { //~ ERROR: unnecessary `unsafe` block\n                     #[deny(unsafe_op_in_unsafe_fn)]\n                     {\n                         unsf();\n@@ -1041,7 +1041,7 @@ mod additional_tests_extra {\n \n     #[warn(unsafe_op_in_unsafe_fn)]\n     unsafe fn multiple_unsafe_op_in_unsafe_fn_allows() {\n-        unsafe { //~ ERROR: unnecessary `unsafe` block\n+        unsafe {\n             #[allow(unsafe_op_in_unsafe_fn)]\n             {\n                 unsf();\n@@ -1071,11 +1071,11 @@ mod additional_tests_extra {\n         #[allow(unsafe_op_in_unsafe_fn)]\n         {\n             let _ = async { unsafe { //~ ERROR: unnecessary `unsafe` block\n-                let _ = async { unsafe { let _ = async { unsf() }; }}; //~ ERROR: unnecessary `unsafe` block\n-                let _ = async { unsafe { let _ = async { unsf() }; }}; //~ ERROR: unnecessary `unsafe` block\n-                let _ = async { unsafe { let _ = async { unsf() }; }}; //~ ERROR: unnecessary `unsafe` block\n+                let _ = async { unsafe { let _ = async { unsf() }; }};\n+                let _ = async { unsafe { let _ = async { unsf() }; }};\n+                let _ = async { unsafe { let _ = async { unsf() }; }};\n             }};\n-            let _ = async { unsafe { //~ ERROR: unnecessary `unsafe` block\n+            let _ = async { unsafe {\n                 let _ = async { unsf() };\n                 let _ = async { unsafe { let _ = async { unsf() }; }}; //~ ERROR: unnecessary `unsafe` block\n                 let _ = async { unsafe { let _ = async { unsf() }; }}; //~ ERROR: unnecessary `unsafe` block"}, {"sha": "b968174dd2d7ec09eb48d9df2fa9ba37db4cebc5", "filename": "src/test/ui/unsafe/rfc-2585-unsafe_op_in_unsafe_fn.mir.stderr", "status": "modified", "additions": 3, "deletions": 35, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Funsafe%2Frfc-2585-unsafe_op_in_unsafe_fn.mir.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Funsafe%2Frfc-2585-unsafe_op_in_unsafe_fn.mir.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funsafe%2Frfc-2585-unsafe_op_in_unsafe_fn.mir.stderr?ref=2fe29753912a1be758a56453eaa80ddbe745300a", "patch": "@@ -81,54 +81,22 @@ error: unnecessary `unsafe` block\n LL |     unsafe { unsafe { unsf() } }\n    |     ^^^^^^ unnecessary `unsafe` block\n \n-error: unnecessary `unsafe` block\n-  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:60:5\n-   |\n-LL | unsafe fn allow_level() {\n-   | ----------------------- because it's nested under this `unsafe` fn\n-...\n-LL |     unsafe { unsf() }\n-   |     ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:53:9\n-   |\n-LL | #[allow(unsafe_op_in_unsafe_fn)]\n-   |         ^^^^^^^^^^^^^^^^^^^^^^\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:72:9\n-   |\n-LL | unsafe fn nested_allow_level() {\n-   | ------------------------------ because it's nested under this `unsafe` fn\n-...\n-LL |         unsafe { unsf() }\n-   |         ^^^^^^ unnecessary `unsafe` block\n-   |\n-   = note: this `unsafe` block does contain unsafe operations, but those are already allowed in an `unsafe fn`\n-note: the lint level is defined here\n-  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:65:13\n-   |\n-LL |     #[allow(unsafe_op_in_unsafe_fn)]\n-   |             ^^^^^^^^^^^^^^^^^^^^^^\n-\n error[E0133]: call to unsafe function is unsafe and requires unsafe block\n-  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:78:5\n+  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:76:5\n    |\n LL |     unsf();\n    |     ^^^^^^ call to unsafe function\n    |\n    = note: consult the function's documentation for information on how to avoid undefined behavior\n \n error[E0133]: call to unsafe function is unsafe and requires unsafe function or block\n-  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:83:9\n+  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:81:9\n    |\n LL |         unsf();\n    |         ^^^^^^ call to unsafe function\n    |\n    = note: consult the function's documentation for information on how to avoid undefined behavior\n \n-error: aborting due to 13 previous errors\n+error: aborting due to 11 previous errors\n \n For more information about this error, try `rustc --explain E0133`."}, {"sha": "db1e916a36c1fb7e885171e727806bdf6dc9b58d", "filename": "src/test/ui/unsafe/rfc-2585-unsafe_op_in_unsafe_fn.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Funsafe%2Frfc-2585-unsafe_op_in_unsafe_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Funsafe%2Frfc-2585-unsafe_op_in_unsafe_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funsafe%2Frfc-2585-unsafe_op_in_unsafe_fn.rs?ref=2fe29753912a1be758a56453eaa80ddbe745300a", "patch": "@@ -58,7 +58,6 @@ unsafe fn allow_level() {\n     VOID = ();\n \n     unsafe { unsf() }\n-    //~^ ERROR unnecessary `unsafe` block\n }\n \n unsafe fn nested_allow_level() {\n@@ -70,7 +69,6 @@ unsafe fn nested_allow_level() {\n         VOID = ();\n \n         unsafe { unsf() }\n-        //~^ ERROR unnecessary `unsafe` block\n     }\n }\n "}, {"sha": "e365293657e305259afbec3c352845d0572b65ec", "filename": "src/test/ui/unsafe/rfc-2585-unsafe_op_in_unsafe_fn.thir.stderr", "status": "modified", "additions": 3, "deletions": 21, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Funsafe%2Frfc-2585-unsafe_op_in_unsafe_fn.thir.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fe29753912a1be758a56453eaa80ddbe745300a/src%2Ftest%2Fui%2Funsafe%2Frfc-2585-unsafe_op_in_unsafe_fn.thir.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funsafe%2Frfc-2585-unsafe_op_in_unsafe_fn.thir.stderr?ref=2fe29753912a1be758a56453eaa80ddbe745300a", "patch": "@@ -83,40 +83,22 @@ LL |     unsafe { unsafe { unsf() } }\n    |     |\n    |     because it's nested under this `unsafe` block\n \n-error: unnecessary `unsafe` block\n-  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:60:5\n-   |\n-LL | unsafe fn allow_level() {\n-   | ----------------------- because it's nested under this `unsafe` fn\n-...\n-LL |     unsafe { unsf() }\n-   |     ^^^^^^ unnecessary `unsafe` block\n-\n-error: unnecessary `unsafe` block\n-  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:72:9\n-   |\n-LL | unsafe fn nested_allow_level() {\n-   | ------------------------------ because it's nested under this `unsafe` fn\n-...\n-LL |         unsafe { unsf() }\n-   |         ^^^^^^ unnecessary `unsafe` block\n-\n error[E0133]: call to unsafe function `unsf` is unsafe and requires unsafe block\n-  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:78:5\n+  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:76:5\n    |\n LL |     unsf();\n    |     ^^^^^^ call to unsafe function\n    |\n    = note: consult the function's documentation for information on how to avoid undefined behavior\n \n error[E0133]: call to unsafe function `unsf` is unsafe and requires unsafe function or block\n-  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:83:9\n+  --> $DIR/rfc-2585-unsafe_op_in_unsafe_fn.rs:81:9\n    |\n LL |         unsf();\n    |         ^^^^^^ call to unsafe function\n    |\n    = note: consult the function's documentation for information on how to avoid undefined behavior\n \n-error: aborting due to 13 previous errors\n+error: aborting due to 11 previous errors\n \n For more information about this error, try `rustc --explain E0133`."}]}