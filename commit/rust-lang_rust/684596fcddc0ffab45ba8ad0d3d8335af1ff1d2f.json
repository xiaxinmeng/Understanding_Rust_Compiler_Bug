{"sha": "684596fcddc0ffab45ba8ad0d3d8335af1ff1d2f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY4NDU5NmZjZGRjMGZmYWI0NWJhOGFkMGQzZDgzMzVhZjFmZjFkMmY=", "commit": {"author": {"name": "Marcus Klaas de Vries", "email": "mail@marcusklaas.nl", "date": "2016-03-02T13:34:36Z"}, "committer": {"name": "Marcus Klaas de Vries", "email": "mail@marcusklaas.nl", "date": "2016-03-02T13:34:36Z"}, "message": "Merge pull request #846 from kamalmarhubi/update-design-doc\n\ndoc: Update Design.md to mention syntex_syntax and config", "tree": {"sha": "3e8aea6af367e27a5fa7bd17f992e5d42447cc9c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3e8aea6af367e27a5fa7bd17f992e5d42447cc9c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/684596fcddc0ffab45ba8ad0d3d8335af1ff1d2f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/684596fcddc0ffab45ba8ad0d3d8335af1ff1d2f", "html_url": "https://github.com/rust-lang/rust/commit/684596fcddc0ffab45ba8ad0d3d8335af1ff1d2f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/684596fcddc0ffab45ba8ad0d3d8335af1ff1d2f/comments", "author": {"login": "marcusklaas", "id": 1255413, "node_id": "MDQ6VXNlcjEyNTU0MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1255413?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcusklaas", "html_url": "https://github.com/marcusklaas", "followers_url": "https://api.github.com/users/marcusklaas/followers", "following_url": "https://api.github.com/users/marcusklaas/following{/other_user}", "gists_url": "https://api.github.com/users/marcusklaas/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcusklaas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcusklaas/subscriptions", "organizations_url": "https://api.github.com/users/marcusklaas/orgs", "repos_url": "https://api.github.com/users/marcusklaas/repos", "events_url": "https://api.github.com/users/marcusklaas/events{/privacy}", "received_events_url": "https://api.github.com/users/marcusklaas/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marcusklaas", "id": 1255413, "node_id": "MDQ6VXNlcjEyNTU0MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1255413?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcusklaas", "html_url": "https://github.com/marcusklaas", "followers_url": "https://api.github.com/users/marcusklaas/followers", "following_url": "https://api.github.com/users/marcusklaas/following{/other_user}", "gists_url": "https://api.github.com/users/marcusklaas/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcusklaas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcusklaas/subscriptions", "organizations_url": "https://api.github.com/users/marcusklaas/orgs", "repos_url": "https://api.github.com/users/marcusklaas/repos", "events_url": "https://api.github.com/users/marcusklaas/events{/privacy}", "received_events_url": "https://api.github.com/users/marcusklaas/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c018a972ae3f7d40238233d6dd3b6946665dbef8", "url": "https://api.github.com/repos/rust-lang/rust/commits/c018a972ae3f7d40238233d6dd3b6946665dbef8", "html_url": "https://github.com/rust-lang/rust/commit/c018a972ae3f7d40238233d6dd3b6946665dbef8"}, {"sha": "1a26a32f8c29dbb62481652be765b3f558e8108b", "url": "https://api.github.com/repos/rust-lang/rust/commits/1a26a32f8c29dbb62481652be765b3f558e8108b", "html_url": "https://github.com/rust-lang/rust/commit/1a26a32f8c29dbb62481652be765b3f558e8108b"}], "stats": {"total": 37, "additions": 23, "deletions": 14}, "files": [{"sha": "7e2f00aebdfa9dc59f42251c6bc6c27ff36f5853", "filename": "Design.md", "status": "modified", "additions": 23, "deletions": 14, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/684596fcddc0ffab45ba8ad0d3d8335af1ff1d2f/Design.md", "raw_url": "https://github.com/rust-lang/rust/raw/684596fcddc0ffab45ba8ad0d3d8335af1ff1d2f/Design.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Design.md?ref=684596fcddc0ffab45ba8ad0d3d8335af1ff1d2f", "patch": "@@ -134,25 +134,34 @@ not worthwhile due to uniformity being desirable, but it is a useful goal).\n \n ### Architecture details\n \n-We use the AST from libsyntax. We use libsyntax's visit module to walk the AST\n-to find starting points for reformatting. Eventually, we should reformat everything\n-and we shouldn't need the visit module. We keep track of the last formatted\n-position in the code, and when we reformat the next piece of code we make sure\n-to output the span for all the code in between (handled by missed_spans.rs).\n+We use the AST from [syntex_syntax], an export of rustc's libsyntax. We use\n+syntex_syntax's visit module to walk the AST to find starting points for\n+reformatting. Eventually, we should reformat everything and we shouldn't need\n+the visit module. We keep track of the last formatted position in the code, and\n+when we reformat the next piece of code we make sure to output the span for all\n+the code in between (handled by missed_spans.rs).\n+\n+[syntex_syntax]: https://crates.io/crates/syntex_syntax\n+\n+We read in formatting configuration from a `rustfmt.toml` file if there is one.\n+The options and their defaults are defined in `config.rs`. A `Config` object is\n+passed throughout the formatting code, and each formatting routine looks there\n+for its configuration.\n \n Our visitor keeps track of the desired current indent due to blocks (\n-`block_indent`). Each `visit_*` method reformats code according to this indent\n-and `IDEAL_WIDTH` and `MAX_WIDTH` (which should one day be supplied from a\n-config file). Most reformatting done in the `visit_*` methods is a bit hackey\n-and is meant to be temporary until it can be done properly.\n+`block_indent`). Each `visit_*` method reformats code according to this indent,\n+`config.ideal_width` and `config.max_width`. Most reformatting done in the\n+`visit_*` methods is a bit hackey and is meant to be temporary until it can be\n+done properly.\n \n There are a bunch of methods called `rewrite_*`. There do the bulk of the\n reformatting. These take the AST node to be reformatted (this may not literally\n-be an AST node from libsyntax, there might be multiple parameters describing a\n-logical node), the current indent, and the current width budget. They return a\n-`String` (or sometimes an `Option<String>`) which formats the code in the box\n-given by the indent and width budget. If the method fails, it returns `None` and\n-the calling method then has to fallback in some way to give the callee more space.\n+be an AST node from syntex_syntax: there might be multiple parameters\n+describing a logical node), the current indent, and the current width budget.\n+They return a `String` (or sometimes an `Option<String>`) which formats the\n+code in the box given by the indent and width budget. If the method fails, it\n+returns `None` and the calling method then has to fallback in some way to give\n+the callee more space.\n \n So, in summary to format a node, we calculate the width budget and then walk down\n the tree from the node. At a leaf, we generate an actual string and then unwind,"}]}