{"sha": "c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf", "node_id": "C_kwDOAAsO6NoAKGMxY2I5NzQ4MWE2MzNiZGZkZjNkNmI1N2M2ZGNlYmZkZmFkYmNmZGY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-10T04:41:03Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-10T04:41:03Z"}, "message": "Auto merge of #89695 - jsha:more-templates, r=GuillaumeGomez\n\nMove top part of print_item to Tera templates\n\nPart of #84419.\n\nThis moves the first line of each item page (E.g. `Struct foo::Bar .... 1.0.0 [-][src]` into a Tera template.\n\nI also moved template initialization into its own module and added a small macro to reduce duplication and opportunity for errors.", "tree": {"sha": "8ec060353b3008ae2cc1f83cdb07c20609ad41a2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8ec060353b3008ae2cc1f83cdb07c20609ad41a2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf", "html_url": "https://github.com/rust-lang/rust/commit/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6928fafe06e4ab29317f75194e1bf67c119dccdc", "url": "https://api.github.com/repos/rust-lang/rust/commits/6928fafe06e4ab29317f75194e1bf67c119dccdc", "html_url": "https://github.com/rust-lang/rust/commit/6928fafe06e4ab29317f75194e1bf67c119dccdc"}, {"sha": "d0a33fb175fad3b1e9bbe4a6ca3fe41b1aa242d6", "url": "https://api.github.com/repos/rust-lang/rust/commits/d0a33fb175fad3b1e9bbe4a6ca3fe41b1aa242d6", "html_url": "https://github.com/rust-lang/rust/commit/d0a33fb175fad3b1e9bbe4a6ca3fe41b1aa242d6"}], "stats": {"total": 168, "additions": 113, "deletions": 55}, "files": [{"sha": "011d3cfcf72d7a1171356fdaff2c57d5a84f6ec0", "filename": "src/librustdoc/html/render/context.rs", "status": "modified", "additions": 3, "deletions": 9, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs?ref=c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf", "patch": "@@ -1,6 +1,5 @@\n use std::cell::RefCell;\n use std::collections::BTreeMap;\n-use std::error::Error as StdError;\n use std::io;\n use std::path::{Path, PathBuf};\n use std::rc::Rc;\n@@ -16,6 +15,7 @@ use rustc_span::symbol::sym;\n \n use super::cache::{build_index, ExternalLocation};\n use super::print_item::{full_path, item_path, print_item};\n+use super::templates;\n use super::write_shared::write_shared;\n use super::{\n     collect_spans_and_sources, print_sidebar, settings, AllTypes, LinkFromSrc, NameDoc, StylePath,\n@@ -33,7 +33,6 @@ use crate::formats::FormatRenderer;\n use crate::html::escape::Escape;\n use crate::html::format::Buffer;\n use crate::html::markdown::{self, plain_text_summary, ErrorCodes, IdMap};\n-use crate::html::static_files::PAGE;\n use crate::html::{layout, sources};\n \n /// Major driving force in all rustdoc rendering. This contains information\n@@ -225,7 +224,7 @@ impl<'tcx> Context<'tcx> {\n                 &self.shared.layout,\n                 &page,\n                 |buf: &mut _| print_sidebar(self, it, buf),\n-                |buf: &mut _| print_item(self, it, buf, &page),\n+                |buf: &mut _| print_item(self, &self.shared.templates, it, buf, &page),\n                 &self.shared.style_files,\n             )\n         } else {\n@@ -416,12 +415,7 @@ impl<'tcx> FormatRenderer<'tcx> for Context<'tcx> {\n         };\n         let mut issue_tracker_base_url = None;\n         let mut include_sources = true;\n-\n-        let mut templates = tera::Tera::default();\n-        templates.add_raw_template(\"page.html\", PAGE).map_err(|e| Error {\n-            file: \"page.html\".into(),\n-            error: format!(\"{}: {}\", e, e.source().map(|e| e.to_string()).unwrap_or_default()),\n-        })?;\n+        let templates = templates::load()?;\n \n         // Crawl the crate attributes looking for attributes which control how we're\n         // going to emit HTML"}, {"sha": "dc5aec3b084f56a3b062ae037f7acee57922ef8b", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf", "patch": "@@ -31,6 +31,7 @@ mod tests;\n mod context;\n mod print_item;\n mod span_map;\n+mod templates;\n mod write_shared;\n \n crate use context::*;"}, {"sha": "4cfc57ac99588d5aa859424438111c0a6a8c44f3", "filename": "src/librustdoc/html/render/print_item.rs", "status": "modified", "additions": 63, "deletions": 44, "changes": 107, "blob_url": "https://github.com/rust-lang/rust/blob/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs?ref=c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf", "patch": "@@ -32,16 +32,41 @@ use crate::html::highlight;\n use crate::html::layout::Page;\n use crate::html::markdown::{HeadingOffset, MarkdownSummaryLine};\n \n+use serde::Serialize;\n+\n const ITEM_TABLE_OPEN: &'static str = \"<div class=\\\"item-table\\\">\";\n const ITEM_TABLE_CLOSE: &'static str = \"</div>\";\n const ITEM_TABLE_ROW_OPEN: &'static str = \"<div class=\\\"item-row\\\">\";\n const ITEM_TABLE_ROW_CLOSE: &'static str = \"</div>\";\n \n-pub(super) fn print_item(cx: &Context<'_>, item: &clean::Item, buf: &mut Buffer, page: &Page<'_>) {\n+// A component in a `use` path, like `string` in std::string::ToString\n+#[derive(Serialize)]\n+struct PathComponent<'a> {\n+    path: String,\n+    name: &'a str,\n+}\n+\n+#[derive(Serialize)]\n+struct ItemVars<'a> {\n+    page: &'a Page<'a>,\n+    static_root_path: &'a str,\n+    typ: &'a str,\n+    name: &'a str,\n+    item_type: &'a str,\n+    path_components: Vec<PathComponent<'a>>,\n+    stability_since_raw: &'a str,\n+    src_href: Option<&'a str>,\n+}\n+\n+pub(super) fn print_item(\n+    cx: &Context<'_>,\n+    templates: &tera::Tera,\n+    item: &clean::Item,\n+    buf: &mut Buffer,\n+    page: &Page<'_>,\n+) {\n     debug_assert!(!item.is_stripped());\n-    // Write the breadcrumb trail header for the top\n-    buf.write_str(\"<h1 class=\\\"fqn\\\"><span class=\\\"in-band\\\">\");\n-    let name = match *item.kind {\n+    let typ = match *item.kind {\n         clean::ModuleItem(_) => {\n             if item.is_crate() {\n                 \"Crate \"\n@@ -73,60 +98,54 @@ pub(super) fn print_item(cx: &Context<'_>, item: &clean::Item, buf: &mut Buffer,\n             unreachable!();\n         }\n     };\n-    buf.write_str(name);\n-    if !item.is_primitive() && !item.is_keyword() {\n-        let cur = &cx.current;\n-        let amt = if item.is_mod() { cur.len() - 1 } else { cur.len() };\n-        for (i, component) in cur.iter().enumerate().take(amt) {\n-            write!(\n-                buf,\n-                \"<a href=\\\"{}index.html\\\">{}</a>::<wbr>\",\n-                \"../\".repeat(cur.len() - i - 1),\n-                component\n-            );\n-        }\n-    }\n-    write!(buf, \"<a class=\\\"{}\\\" href=\\\"#\\\">{}</a>\", item.type_(), item.name.as_ref().unwrap());\n-    write!(\n-        buf,\n-        \"<button id=\\\"copy-path\\\" onclick=\\\"copy_path(this)\\\" title=\\\"Copy item path to clipboard\\\">\\\n-            <img src=\\\"{static_root_path}clipboard{suffix}.svg\\\" \\\n-                width=\\\"19\\\" height=\\\"18\\\" \\\n-                alt=\\\"Copy item path\\\">\\\n-         </button>\",\n-        static_root_path = page.get_static_root_path(),\n-        suffix = page.resource_suffix,\n-    );\n-\n-    buf.write_str(\"</span>\"); // in-band\n-    buf.write_str(\"<span class=\\\"out-of-band\\\">\");\n+    let mut stability_since_raw = Buffer::new();\n     render_stability_since_raw(\n-        buf,\n+        &mut stability_since_raw,\n         item.stable_since(cx.tcx()).as_deref(),\n         item.const_stability(cx.tcx()),\n         None,\n         None,\n     );\n-    buf.write_str(\n-        \"<span id=\\\"render-detail\\\">\\\n-                <a id=\\\"toggle-all-docs\\\" href=\\\"javascript:void(0)\\\" \\\n-                    title=\\\"collapse all docs\\\">\\\n-                    [<span class=\\\"inner\\\">&#x2212;</span>]\\\n-                </a>\\\n-            </span>\",\n-    );\n+    let stability_since_raw: String = stability_since_raw.into_inner();\n \n     // Write `src` tag\n     //\n     // When this item is part of a `crate use` in a downstream crate, the\n     // [src] link in the downstream documentation will actually come back to\n     // this page, and this link will be auto-clicked. The `id` attribute is\n     // used to find the link to auto-click.\n-    if cx.include_sources && !item.is_primitive() {\n-        write_srclink(cx, item, buf);\n-    }\n+    let src_href =\n+        if cx.include_sources && !item.is_primitive() { cx.src_href(item) } else { None };\n+\n+    let path_components = if item.is_primitive() || item.is_keyword() {\n+        vec![]\n+    } else {\n+        let cur = &cx.current;\n+        let amt = if item.is_mod() { cur.len() - 1 } else { cur.len() };\n+        cur.iter()\n+            .enumerate()\n+            .take(amt)\n+            .map(|(i, component)| PathComponent {\n+                path: \"../\".repeat(cur.len() - i - 1),\n+                name: component,\n+            })\n+            .collect()\n+    };\n+\n+    let item_vars = ItemVars {\n+        page: page,\n+        static_root_path: page.get_static_root_path(),\n+        typ: typ,\n+        name: &item.name.as_ref().unwrap().as_str(),\n+        item_type: &item.type_().to_string(),\n+        path_components: path_components,\n+        stability_since_raw: &stability_since_raw,\n+        src_href: src_href.as_deref(),\n+    };\n \n-    buf.write_str(\"</span></h1>\"); // out-of-band\n+    let teractx = tera::Context::from_serialize(item_vars).unwrap();\n+    let heading = templates.render(\"print_item.html\", &teractx).unwrap();\n+    buf.write_str(&heading);\n \n     match *item.kind {\n         clean::ModuleItem(ref m) => item_module(buf, cx, item, &m.items),"}, {"sha": "d1f182394479a5ea81952068dd5a50feafbe57de", "filename": "src/librustdoc/html/render/templates.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf/src%2Flibrustdoc%2Fhtml%2Frender%2Ftemplates.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf/src%2Flibrustdoc%2Fhtml%2Frender%2Ftemplates.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Ftemplates.rs?ref=c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf", "patch": "@@ -0,0 +1,20 @@\n+use std::error::Error as StdError;\n+\n+use crate::error::Error;\n+\n+pub(crate) fn load() -> Result<tera::Tera, Error> {\n+    let mut templates = tera::Tera::default();\n+\n+    macro_rules! include_template {\n+        ($file:literal, $fullpath:literal) => {\n+            templates.add_raw_template($file, include_str!($fullpath)).map_err(|e| Error {\n+                file: $file.into(),\n+                error: format!(\"{}: {}\", e, e.source().map(|e| e.to_string()).unwrap_or_default()),\n+            })?\n+        };\n+    }\n+\n+    include_template!(\"page.html\", \"../templates/page.html\");\n+    include_template!(\"print_item.html\", \"../templates/print_item.html\");\n+    Ok(templates)\n+}"}, {"sha": "ccc25e6cc495fae43b31844288cfdbd3c728c341", "filename": "src/librustdoc/html/static_files.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf/src%2Flibrustdoc%2Fhtml%2Fstatic_files.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf/src%2Flibrustdoc%2Fhtml%2Fstatic_files.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic_files.rs?ref=c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf", "patch": "@@ -70,8 +70,6 @@ crate static RUST_FAVICON_SVG: &[u8] = include_bytes!(\"static/images/favicon.svg\n crate static RUST_FAVICON_PNG_16: &[u8] = include_bytes!(\"static/images/favicon-16x16.png\");\n crate static RUST_FAVICON_PNG_32: &[u8] = include_bytes!(\"static/images/favicon-32x32.png\");\n \n-crate static PAGE: &str = include_str!(\"templates/page.html\");\n-\n /// The built-in themes given to every documentation site.\n crate mod themes {\n     /// The \"light\" theme, selected by default when no setting is available. Used as the basis for"}, {"sha": "5a468f3cc1ea02cca9ba17dfc339a6b9d6090bdc", "filename": "src/librustdoc/html/templates/print_item.html", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fprint_item.html", "raw_url": "https://github.com/rust-lang/rust/raw/c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fprint_item.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fprint_item.html?ref=c1cb97481a633bdfdf3d6b57c6dcebfdfadbcfdf", "patch": "@@ -0,0 +1,26 @@\n+<h1 class=\"fqn\"> {#- -#}\n+    <span class=\"in-band\"> {#- -#}\n+        {{-typ-}}\n+        {#- The breadcrumbs of the item path, like std::string -#}\n+        {%- for component in path_components -%}\n+        <a href=\"{{component.path | safe}}index.html\">{{component.name}}</a>::<wbr>\n+        {%- endfor -%}\n+        <a class=\"{{item_type}}\" href=\"#\">{{name}}</a> {#- -#}\n+        <button id=\"copy-path\" onclick=\"copy_path(this)\" title=\"Copy item path to clipboard\"> {#- -#}\n+            <img src=\"{{static_root_path | safe}}clipboard{{page.resource_suffix}}.svg\" {# -#}\n+                width=\"19\" height=\"18\" {# -#}\n+                alt=\"Copy item path\"> {#- -#}\n+        </button> {#- -#}\n+    </span> {#- -#}\n+    <span class=\"out-of-band\"> {#- -#}\n+        {{- stability_since_raw | safe -}}\n+        <span id=\"render-detail\"> {#- -#}\n+            <a id=\"toggle-all-docs\" href=\"javascript:void(0)\" title=\"collapse all docs\"> {#- -#}\n+                [<span class=\"inner\">&#x2212;</span>] {#- -#}\n+            </a> {#- -#}\n+        </span> {#- -#}\n+        {%- if src_href -%}\n+        <a class=\"srclink\" href=\"{{src_href | safe}}\" title=\"goto source code\">[src]</a>\n+        {%- endif -%}\n+    </span> {#- -#}\n+</h1> {#- -#}"}]}