{"sha": "55ebe6380aef233fff86b7e6cead361787bf1f65", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU1ZWJlNjM4MGFlZjIzM2ZmZjg2YjdlNmNlYWQzNjE3ODdiZjFmNjU=", "commit": {"author": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-10-31T19:41:24Z"}, "committer": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-10-31T19:41:24Z"}, "message": "Merge #167\n\n167: Attempt to extract useful comments from function signatures r=matklad a=kjeremy\n\nI'm trying to extract useful function comments for signature info. This will also be useful for hover.  This is a WIP (and actually works pretty well!) but I don't think it's the right approach long term so some guidance would be appreciated so that we could also get comments for say types and variable instances etc.\r\n\r\nCurrently `test_fn_signature_with_simple_doc` fails due to a bug in `extend` but we probably shouldn't use this approach anyway. Maybe comments should be attached to nodes somehow? I'm also thinking that maybe the markdown bits should live in the language server.\r\n\r\nThoughts?\n\nCo-authored-by: Jeremy A. Kolb <jkolb@ara.com>", "tree": {"sha": "9ed060e4738a0504ddfd146649b9cf8a2f2fac40", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9ed060e4738a0504ddfd146649b9cf8a2f2fac40"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/55ebe6380aef233fff86b7e6cead361787bf1f65", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/55ebe6380aef233fff86b7e6cead361787bf1f65", "html_url": "https://github.com/rust-lang/rust/commit/55ebe6380aef233fff86b7e6cead361787bf1f65", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/55ebe6380aef233fff86b7e6cead361787bf1f65/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "parents": [{"sha": "dfba29e4fb66457d101db295e3c356a932ac005e", "url": "https://api.github.com/repos/rust-lang/rust/commits/dfba29e4fb66457d101db295e3c356a932ac005e", "html_url": "https://github.com/rust-lang/rust/commit/dfba29e4fb66457d101db295e3c356a932ac005e"}, {"sha": "74320945b664916005d263552194201cbe9a52bc", "url": "https://api.github.com/repos/rust-lang/rust/commits/74320945b664916005d263552194201cbe9a52bc", "html_url": "https://github.com/rust-lang/rust/commit/74320945b664916005d263552194201cbe9a52bc"}], "stats": {"total": 240, "additions": 235, "deletions": 5}, "files": [{"sha": "ae40f3e8f863f2c8aaa7c826c8ffb78f2932d9f4", "filename": "crates/ra_analysis/src/descriptors/function/mod.rs", "status": "modified", "additions": 57, "deletions": 3, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/55ebe6380aef233fff86b7e6cead361787bf1f65/crates%2Fra_analysis%2Fsrc%2Fdescriptors%2Ffunction%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55ebe6380aef233fff86b7e6cead361787bf1f65/crates%2Fra_analysis%2Fsrc%2Fdescriptors%2Ffunction%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fdescriptors%2Ffunction%2Fmod.rs?ref=55ebe6380aef233fff86b7e6cead361787bf1f65", "patch": "@@ -1,8 +1,11 @@\n pub(super) mod imp;\n mod scope;\n \n+use std::cmp::{min, max};\n+\n use ra_syntax::{\n-    ast::{self, AstNode, NameOwner}\n+    ast::{self, AstNode, DocCommentsOwner, NameOwner},\n+    TextRange, TextUnit\n };\n \n use crate::{\n@@ -30,14 +33,17 @@ pub struct FnDescriptor {\n     pub label: String,\n     pub ret_type: Option<String>,\n     pub params: Vec<String>,\n+    pub doc: Option<String>\n }\n \n impl FnDescriptor {\n     pub fn new(node: ast::FnDef) -> Option<Self> {\n         let name = node.name()?.text().to_string();\n \n+        let mut doc = None;\n+\n         // Strip the body out for the label.\n-        let label: String = if let Some(body) = node.body() {\n+        let mut label: String = if let Some(body) = node.body() {\n             let body_range = body.syntax().range();\n             let label: String = node\n                 .syntax()\n@@ -50,17 +56,65 @@ impl FnDescriptor {\n             node.syntax().text().to_string()\n         };\n \n+        if let Some((comment_range, docs)) = FnDescriptor::extract_doc_comments(node) {\n+            let comment_range = comment_range.checked_sub(node.syntax().range().start()).unwrap();\n+            let start = comment_range.start().to_usize();\n+            let end = comment_range.end().to_usize();\n+\n+            // Remove the comment from the label\n+            label.replace_range(start..end, \"\");\n+\n+            // Massage markdown\n+            let mut processed_lines = Vec::new();\n+            let mut in_code_block = false;\n+            for line in docs.lines() {\n+                if line.starts_with(\"```\") {\n+                    in_code_block = !in_code_block;\n+                }\n+\n+                let line = if in_code_block && line.starts_with(\"```\") && !line.contains(\"rust\") {\n+                    \"```rust\".into()\n+                } else {\n+                    line.to_string()\n+                };\n+\n+                processed_lines.push(line);\n+            }\n+\n+            if !processed_lines.is_empty() {\n+                doc = Some(processed_lines.join(\"\\n\"));\n+            }\n+        }\n+\n         let params = FnDescriptor::param_list(node);\n         let ret_type = node.ret_type().map(|r| r.syntax().text().to_string());\n \n         Some(FnDescriptor {\n             name,\n             ret_type,\n             params,\n-            label,\n+            label: label.trim().to_owned(),\n+            doc\n         })\n     }\n \n+    fn extract_doc_comments(node: ast::FnDef) -> Option<(TextRange, String)> {\n+        if node.doc_comments().count() == 0 {\n+            return None;\n+        }\n+\n+        let comment_text = node.doc_comment_text();\n+\n+        let (begin, end) = node.doc_comments()\n+            .map(|comment| comment.syntax().range())\n+            .map(|range| (range.start().to_usize(), range.end().to_usize()))\n+            .fold((std::usize::MAX, std::usize::MIN), |acc, range| (min(acc.0, range.0), max(acc.1, range.1)));\n+\n+        let range = TextRange::from_to(TextUnit::from_usize(begin), TextUnit::from_usize(end));\n+\n+        Some((range, comment_text))\n+    }\n+\n     fn param_list(node: ast::FnDef) -> Vec<String> {\n         let mut res = vec![];\n         if let Some(param_list) = node.param_list() {"}, {"sha": "9e2478d9e8154912244a2ad0d319e5d979504235", "filename": "crates/ra_analysis/tests/tests.rs", "status": "modified", "additions": 147, "deletions": 0, "changes": 147, "blob_url": "https://github.com/rust-lang/rust/blob/55ebe6380aef233fff86b7e6cead361787bf1f65/crates%2Fra_analysis%2Ftests%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55ebe6380aef233fff86b7e6cead361787bf1f65/crates%2Fra_analysis%2Ftests%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Ftests%2Ftests.rs?ref=55ebe6380aef233fff86b7e6cead361787bf1f65", "patch": "@@ -195,6 +195,153 @@ fn bar() {\n     assert_eq!(param, Some(1));\n }\n \n+#[test]\n+fn test_fn_signature_with_docs_simple() {\n+    let (desc, param) = get_signature(\n+        r#\"\n+// test\n+fn foo(j: u32) -> u32 {\n+    j\n+}\n+\n+fn bar() {\n+    let _ = foo(<|>);\n+}\n+\"#,\n+    );\n+\n+    assert_eq!(desc.name, \"foo\".to_string());\n+    assert_eq!(desc.params, vec![\"j\".to_string()]);\n+    assert_eq!(desc.ret_type, Some(\"-> u32\".to_string()));\n+    assert_eq!(param, Some(0));\n+    assert_eq!(desc.label, \"fn foo(j: u32) -> u32\".to_string());\n+    assert_eq!(desc.doc, Some(\"test\".into()));\n+}\n+\n+#[test]\n+fn test_fn_signature_with_docs() {\n+    let (desc, param) = get_signature(\n+        r#\"\n+/// Adds one to the number given.\n+///\n+/// # Examples\n+///\n+/// ```\n+/// let five = 5;\n+///\n+/// assert_eq!(6, my_crate::add_one(5));\n+/// ```\n+pub fn add_one(x: i32) -> i32 {\n+    x + 1\n+}\n+\n+pub fn do() {\n+    add_one(<|>\n+}\"#,\n+    );\n+\n+    assert_eq!(desc.name, \"add_one\".to_string());\n+    assert_eq!(desc.params, vec![\"x\".to_string()]);\n+    assert_eq!(desc.ret_type, Some(\"-> i32\".to_string()));\n+    assert_eq!(param, Some(0));\n+    assert_eq!(desc.label, \"pub fn add_one(x: i32) -> i32\".to_string());\n+    assert_eq!(desc.doc, Some(\n+r#\"Adds one to the number given.\n+\n+# Examples\n+\n+```rust\n+let five = 5;\n+\n+assert_eq!(6, my_crate::add_one(5));\n+```\"#.into()));\n+}\n+\n+#[test]\n+fn test_fn_signature_with_docs_impl() {\n+    let (desc, param) = get_signature(\n+        r#\"\n+struct addr;\n+impl addr {\n+    /// Adds one to the number given.\n+    ///\n+    /// # Examples\n+    ///\n+    /// ```\n+    /// let five = 5;\n+    ///\n+    /// assert_eq!(6, my_crate::add_one(5));\n+    /// ```\n+    pub fn add_one(x: i32) -> i32 {\n+        x + 1\n+    }\n+}\n+\n+pub fn do_it() {\n+    addr {};\n+    addr::add_one(<|>);\n+}\"#);\n+\n+    assert_eq!(desc.name, \"add_one\".to_string());\n+    assert_eq!(desc.params, vec![\"x\".to_string()]);\n+    assert_eq!(desc.ret_type, Some(\"-> i32\".to_string()));\n+    assert_eq!(param, Some(0));\n+    assert_eq!(desc.label, \"pub fn add_one(x: i32) -> i32\".to_string());\n+    assert_eq!(desc.doc, Some(\n+r#\"Adds one to the number given.\n+\n+# Examples\n+\n+```rust\n+let five = 5;\n+\n+assert_eq!(6, my_crate::add_one(5));\n+```\"#.into()));\n+}\n+\n+#[test]\n+fn test_fn_signature_with_docs_from_actix() {\n+    let (desc, param) = get_signature(\n+        r#\"\n+pub trait WriteHandler<E>\n+where\n+    Self: Actor,\n+    Self::Context: ActorContext,\n+{\n+    /// Method is called when writer emits error.\n+    ///\n+    /// If this method returns `ErrorAction::Continue` writer processing\n+    /// continues otherwise stream processing stops.\n+    fn error(&mut self, err: E, ctx: &mut Self::Context) -> Running {\n+        Running::Stop\n+    }\n+\n+    /// Method is called when writer finishes.\n+    ///\n+    /// By default this method stops actor's `Context`.\n+    fn finished(&mut self, ctx: &mut Self::Context) {\n+        ctx.stop()\n+    }\n+}\n+\n+pub fn foo() {\n+    WriteHandler r;\n+    r.finished(<|>);\n+}\n+\n+\"#);\n+\n+    assert_eq!(desc.name, \"finished\".to_string());\n+    assert_eq!(desc.params, vec![\"&mut self\".to_string(), \"ctx\".to_string()]);\n+    assert_eq!(desc.ret_type, None);\n+    assert_eq!(param, Some(1));\n+    assert_eq!(desc.doc, Some(\n+r#\"Method is called when writer finishes.\n+\n+By default this method stops actor's `Context`.\"#.into()));\n+}\n+\n+\n fn get_all_refs(text: &str) -> Vec<(FileId, TextRange)> {\n     let (analysis, position) = single_file_with_position(text);\n     analysis.find_all_refs(position.file_id, position.offset).unwrap()"}, {"sha": "20cb5f7728ddc54bf2860601b7f27d59519da066", "filename": "crates/ra_lsp_server/src/main_loop/handlers.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/55ebe6380aef233fff86b7e6cead361787bf1f65/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55ebe6380aef233fff86b7e6cead361787bf1f65/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs?ref=55ebe6380aef233fff86b7e6cead361787bf1f65", "patch": "@@ -5,7 +5,7 @@ use languageserver_types::{\n     CodeActionResponse, Command, CompletionItem, CompletionItemKind, Diagnostic,\n     DiagnosticSeverity, DocumentSymbol, FoldingRange, FoldingRangeKind, FoldingRangeParams,\n     InsertTextFormat, Location, Position, SymbolInformation, TextDocumentIdentifier, TextEdit,\n-    RenameParams, WorkspaceEdit, PrepareRenameResponse\n+    RenameParams, WorkspaceEdit, PrepareRenameResponse, Documentation, MarkupContent, MarkupKind\n };\n use gen_lsp_server::ErrorCode;\n use ra_analysis::{FileId, FoldKind, Query, RunnableKind};\n@@ -465,9 +465,18 @@ pub fn handle_signature_help(\n             })\n             .collect();\n \n+        let documentation = if let Some(doc) = descriptor.doc {\n+            Some(Documentation::MarkupContent(MarkupContent {\n+                kind: MarkupKind::Markdown,\n+                value: doc\n+            }))\n+        } else {\n+            None\n+        };\n+\n         let sig_info = SignatureInformation {\n             label: descriptor.label,\n-            documentation: None,\n+            documentation,\n             parameters: Some(parameters),\n         };\n "}, {"sha": "b6a15dbdc1a3867151028fa6fbffdb0dea80da8a", "filename": "crates/ra_syntax/src/ast/generated.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/55ebe6380aef233fff86b7e6cead361787bf1f65/crates%2Fra_syntax%2Fsrc%2Fast%2Fgenerated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55ebe6380aef233fff86b7e6cead361787bf1f65/crates%2Fra_syntax%2Fsrc%2Fast%2Fgenerated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fast%2Fgenerated.rs?ref=55ebe6380aef233fff86b7e6cead361787bf1f65", "patch": "@@ -864,6 +864,7 @@ impl<'a> AstNode<'a> for FnDef<'a> {\n impl<'a> ast::NameOwner<'a> for FnDef<'a> {}\n impl<'a> ast::TypeParamsOwner<'a> for FnDef<'a> {}\n impl<'a> ast::AttrsOwner<'a> for FnDef<'a> {}\n+impl<'a> ast::DocCommentsOwner<'a> for FnDef<'a> {}\n impl<'a> FnDef<'a> {\n     pub fn param_list(self) -> Option<ParamList<'a>> {\n         super::child_opt(self)"}, {"sha": "3aa11b9ddaef843126297f526ec4e54fe8b399ce", "filename": "crates/ra_syntax/src/ast/mod.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/55ebe6380aef233fff86b7e6cead361787bf1f65/crates%2Fra_syntax%2Fsrc%2Fast%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55ebe6380aef233fff86b7e6cead361787bf1f65/crates%2Fra_syntax%2Fsrc%2Fast%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fast%2Fmod.rs?ref=55ebe6380aef233fff86b7e6cead361787bf1f65", "patch": "@@ -65,6 +65,24 @@ pub trait AttrsOwner<'a>: AstNode<'a> {\n     }\n }\n \n+pub trait DocCommentsOwner<'a>: AstNode<'a> {\n+    fn doc_comments(self) -> AstChildren<'a, Comment<'a>> { children(self) }\n+\n+    /// Returns the textual content of a doc comment block as a single string.\n+    /// That is, strips leading `///` and joins lines\n+    fn doc_comment_text(self) -> String {\n+        self.doc_comments()\n+            .map(|comment| {\n+                let prefix = comment.prefix();\n+                let trimmed = comment.text().as_str()\n+                    .trim()\n+                    .trim_start_matches(prefix)\n+                    .trim_start();\n+                trimmed.to_owned()\n+            }).join(\"\\n\")\n+    }\n+}\n+\n impl<'a> FnDef<'a> {\n     pub fn has_atom_attr(&self, atom: &str) -> bool {\n         self.attrs().filter_map(|x| x.as_atom()).any(|x| x == atom)"}, {"sha": "6951db010a724ed8a1581eba767c32da0877bc54", "filename": "crates/ra_syntax/src/grammar.ron", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/55ebe6380aef233fff86b7e6cead361787bf1f65/crates%2Fra_syntax%2Fsrc%2Fgrammar.ron", "raw_url": "https://github.com/rust-lang/rust/raw/55ebe6380aef233fff86b7e6cead361787bf1f65/crates%2Fra_syntax%2Fsrc%2Fgrammar.ron", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fgrammar.ron?ref=55ebe6380aef233fff86b7e6cead361787bf1f65", "patch": "@@ -251,6 +251,7 @@ Grammar(\n                 \"NameOwner\",\n                 \"TypeParamsOwner\",\n                 \"AttrsOwner\",\n+                \"DocCommentsOwner\"\n             ],\n             options: [ \"ParamList\", [\"body\", \"Block\"], \"RetType\" ],\n         ),"}]}