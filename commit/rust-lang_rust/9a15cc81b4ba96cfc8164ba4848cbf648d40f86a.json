{"sha": "9a15cc81b4ba96cfc8164ba4848cbf648d40f86a", "node_id": "C_kwDOAAsO6NoAKDlhMTVjYzgxYjRiYTk2Y2ZjODE2NGJhNDg0OGNiZjY0OGQ0MGY4NmE", "commit": {"author": {"name": "bvanjoi", "email": "bohan-zhang@foxmail.com", "date": "2023-01-06T10:52:41Z"}, "committer": {"name": "bvanjoi", "email": "bohan-zhang@foxmail.com", "date": "2023-01-10T02:28:17Z"}, "message": "fix(ty): should query impls in nearest block", "tree": {"sha": "f12ee307f5035b5f2908e42c4355de3e0fb4e53b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f12ee307f5035b5f2908e42c4355de3e0fb4e53b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9a15cc81b4ba96cfc8164ba4848cbf648d40f86a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9a15cc81b4ba96cfc8164ba4848cbf648d40f86a", "html_url": "https://github.com/rust-lang/rust/commit/9a15cc81b4ba96cfc8164ba4848cbf648d40f86a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9a15cc81b4ba96cfc8164ba4848cbf648d40f86a/comments", "author": {"login": "bvanjoi", "id": 30187863, "node_id": "MDQ6VXNlcjMwMTg3ODYz", "avatar_url": "https://avatars.githubusercontent.com/u/30187863?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bvanjoi", "html_url": "https://github.com/bvanjoi", "followers_url": "https://api.github.com/users/bvanjoi/followers", "following_url": "https://api.github.com/users/bvanjoi/following{/other_user}", "gists_url": "https://api.github.com/users/bvanjoi/gists{/gist_id}", "starred_url": "https://api.github.com/users/bvanjoi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bvanjoi/subscriptions", "organizations_url": "https://api.github.com/users/bvanjoi/orgs", "repos_url": "https://api.github.com/users/bvanjoi/repos", "events_url": "https://api.github.com/users/bvanjoi/events{/privacy}", "received_events_url": "https://api.github.com/users/bvanjoi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bvanjoi", "id": 30187863, "node_id": "MDQ6VXNlcjMwMTg3ODYz", "avatar_url": "https://avatars.githubusercontent.com/u/30187863?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bvanjoi", "html_url": "https://github.com/bvanjoi", "followers_url": "https://api.github.com/users/bvanjoi/followers", "following_url": "https://api.github.com/users/bvanjoi/following{/other_user}", "gists_url": "https://api.github.com/users/bvanjoi/gists{/gist_id}", "starred_url": "https://api.github.com/users/bvanjoi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bvanjoi/subscriptions", "organizations_url": "https://api.github.com/users/bvanjoi/orgs", "repos_url": "https://api.github.com/users/bvanjoi/repos", "events_url": "https://api.github.com/users/bvanjoi/events{/privacy}", "received_events_url": "https://api.github.com/users/bvanjoi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "80cabf726068187d8686b5ccf37aac484da84904", "url": "https://api.github.com/repos/rust-lang/rust/commits/80cabf726068187d8686b5ccf37aac484da84904", "html_url": "https://github.com/rust-lang/rust/commit/80cabf726068187d8686b5ccf37aac484da84904"}], "stats": {"total": 73, "additions": 71, "deletions": 2}, "files": [{"sha": "680e01e26b3c59797e69c956f93c1d292af90be1", "filename": "crates/hir-ty/src/method_resolution.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/9a15cc81b4ba96cfc8164ba4848cbf648d40f86a/crates%2Fhir-ty%2Fsrc%2Fmethod_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9a15cc81b4ba96cfc8164ba4848cbf648d40f86a/crates%2Fhir-ty%2Fsrc%2Fmethod_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Fmethod_resolution.rs?ref=9a15cc81b4ba96cfc8164ba4848cbf648d40f86a", "patch": "@@ -1094,13 +1094,13 @@ fn iterate_inherent_methods(\n         None => return ControlFlow::Continue(()),\n     };\n \n-    let (module, block) = match visible_from_module {\n+    let (module, mut block) = match visible_from_module {\n         VisibleFromModule::Filter(module) => (Some(module), module.containing_block()),\n         VisibleFromModule::IncludeBlock(block) => (None, Some(block)),\n         VisibleFromModule::None => (None, None),\n     };\n \n-    if let Some(block_id) = block {\n+    while let Some(block_id) = block {\n         if let Some(impls) = db.inherent_impls_in_block(block_id) {\n             impls_for_self_ty(\n                 &impls,\n@@ -1113,6 +1113,11 @@ fn iterate_inherent_methods(\n                 callback,\n             )?;\n         }\n+\n+        block = db\n+            .block_def_map(block_id)\n+            .and_then(|map| map.parent())\n+            .and_then(|module| module.containing_block());\n     }\n \n     for krate in def_crates {"}, {"sha": "93019527f44da40a1a7136755e1d74b61d023a1a", "filename": "crates/ide/src/goto_definition.rs", "status": "modified", "additions": 64, "deletions": 0, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/9a15cc81b4ba96cfc8164ba4848cbf648d40f86a/crates%2Fide%2Fsrc%2Fgoto_definition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9a15cc81b4ba96cfc8164ba4848cbf648d40f86a/crates%2Fide%2Fsrc%2Fgoto_definition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fgoto_definition.rs?ref=9a15cc81b4ba96cfc8164ba4848cbf648d40f86a", "patch": "@@ -1916,4 +1916,68 @@ fn main() {\n \"#,\n         )\n     }\n+\n+    #[test]\n+    fn query_impls_in_nearest_block() {\n+        check(\n+            r#\"\n+struct S1;\n+impl S1 {\n+    fn e() -> () {}\n+}\n+fn f1() {\n+    struct S1;\n+    impl S1 {\n+        fn e() -> () {}\n+         //^\n+    }\n+    fn f2() {\n+        fn f3() {\n+            S1::e$0();\n+        }\n+    }\n+}\n+\"#,\n+        );\n+\n+        check(\n+            r#\"\n+struct S1;\n+impl S1 {\n+    fn e() -> () {}\n+}\n+fn f1() {\n+    struct S1;\n+    impl S1 {\n+        fn e() -> () {}\n+         //^\n+    }\n+    fn f2() {\n+        struct S2;\n+        S1::e$0();\n+    }\n+}\n+fn f12() {\n+    struct S1;\n+    impl S1 {\n+        fn e() -> () {}\n+    }\n+}\n+\"#,\n+        );\n+\n+        check(\n+            r#\"\n+struct S1;\n+impl S1 {\n+    fn e() -> () {}\n+     //^\n+}\n+fn f2() {\n+    struct S2;\n+    S1::e$0();\n+}\n+\"#,\n+        );\n+    }\n }"}]}