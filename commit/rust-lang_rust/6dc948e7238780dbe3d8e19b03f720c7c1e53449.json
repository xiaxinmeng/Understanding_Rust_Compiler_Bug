{"sha": "6dc948e7238780dbe3d8e19b03f720c7c1e53449", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZkYzk0OGU3MjM4NzgwZGJlM2Q4ZTE5YjAzZjcyMGM3YzFlNTM0NDk=", "commit": {"author": {"name": "The8472", "email": "git@infinite-source.de", "date": "2021-02-20T21:52:44Z"}, "committer": {"name": "The8472", "email": "git@infinite-source.de", "date": "2021-02-20T22:12:56Z"}, "message": "limit rustfmt parallelism by taking -j into account", "tree": {"sha": "a4de10196065ac94bfa0ea917013ba528d61b4c4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a4de10196065ac94bfa0ea917013ba528d61b4c4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6dc948e7238780dbe3d8e19b03f720c7c1e53449", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6dc948e7238780dbe3d8e19b03f720c7c1e53449", "html_url": "https://github.com/rust-lang/rust/commit/6dc948e7238780dbe3d8e19b03f720c7c1e53449", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6dc948e7238780dbe3d8e19b03f720c7c1e53449/comments", "author": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "committer": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "211d49c73cccdcf10444c0db3b8ae1e91582c6cd", "url": "https://api.github.com/repos/rust-lang/rust/commits/211d49c73cccdcf10444c0db3b8ae1e91582c6cd", "html_url": "https://github.com/rust-lang/rust/commit/211d49c73cccdcf10444c0db3b8ae1e91582c6cd"}], "stats": {"total": 6, "additions": 3, "deletions": 3}, "files": [{"sha": "3c9b66e5a017d8e7543a0aab4dcd02564645c58f", "filename": "src/bootstrap/format.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6dc948e7238780dbe3d8e19b03f720c7c1e53449/src%2Fbootstrap%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6dc948e7238780dbe3d8e19b03f720c7c1e53449/src%2Fbootstrap%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fformat.rs?ref=6dc948e7238780dbe3d8e19b03f720c7c1e53449", "patch": "@@ -122,8 +122,8 @@ pub fn format(build: &Build, check: bool) {\n         WalkBuilder::new(src.clone()).types(matcher).overrides(ignore_fmt).build_parallel();\n \n     // there is a lot of blocking involved in spawning a child process and reading files to format.\n-    // spawn more processes than available cores to keep the CPU busy\n-    let max_processes = num_cpus::get() * 2;\n+    // spawn more processes than available concurrency to keep the CPU busy\n+    let max_processes = build.jobs() as usize * 2;\n \n     // spawn child processes on a separate thread so we can batch entries we have received from ignore\n     let thread = std::thread::spawn(move || {\n@@ -135,7 +135,7 @@ pub fn format(build: &Build, check: bool) {\n             let child = rustfmt(&src, &rustfmt_path, paths.as_slice(), check);\n             children.push_back(child);\n \n-            if children.len() > max_processes {\n+            if children.len() >= max_processes {\n                 // await oldest child\n                 children.pop_front().unwrap()();\n             }"}]}