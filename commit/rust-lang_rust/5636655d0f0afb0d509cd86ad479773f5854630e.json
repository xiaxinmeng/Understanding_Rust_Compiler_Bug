{"sha": "5636655d0f0afb0d509cd86ad479773f5854630e", "node_id": "C_kwDOAAsO6NoAKDU2MzY2NTVkMGYwYWZiMGQ1MDljZDg2YWQ0Nzk3NzNmNTg1NDYzMGU", "commit": {"author": {"name": "Jacob Pratt", "email": "jacob@jhpratt.dev", "date": "2022-02-16T23:48:33Z"}, "committer": {"name": "Jacob Pratt", "email": "jacob@jhpratt.dev", "date": "2022-03-09T21:32:47Z"}, "message": "New `deprecated_suggestion` feature, use in tests", "tree": {"sha": "384cfb3eae42fab06a0f55cebffc9d2144f6d80a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/384cfb3eae42fab06a0f55cebffc9d2144f6d80a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5636655d0f0afb0d509cd86ad479773f5854630e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYKAB0WIQTgxeqBxcDGar1sVhy4DhnkZitapAUCYikc/wAKCRC4DhnkZita\npLZHAQD23FemrHjtfIgzo6JLwl/xQJ/huX6rvUucGXBbaN3XHgD/cZHI5UWuW7Vi\nVavD0pnp52S03rDclNY4aWo77rwKIQM=\n=gQGi\n-----END PGP SIGNATURE-----", "payload": "tree 384cfb3eae42fab06a0f55cebffc9d2144f6d80a\nparent 6efc8e34d8b83de7f5b1e47d4bbbe0f2daa385f8\nauthor Jacob Pratt <jacob@jhpratt.dev> 1645055313 -0500\ncommitter Jacob Pratt <jacob@jhpratt.dev> 1646861567 -0500\n\nNew `deprecated_suggestion` feature, use in tests\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5636655d0f0afb0d509cd86ad479773f5854630e", "html_url": "https://github.com/rust-lang/rust/commit/5636655d0f0afb0d509cd86ad479773f5854630e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5636655d0f0afb0d509cd86ad479773f5854630e/comments", "author": {"login": "jhpratt", "id": 3161395, "node_id": "MDQ6VXNlcjMxNjEzOTU=", "avatar_url": "https://avatars.githubusercontent.com/u/3161395?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jhpratt", "html_url": "https://github.com/jhpratt", "followers_url": "https://api.github.com/users/jhpratt/followers", "following_url": "https://api.github.com/users/jhpratt/following{/other_user}", "gists_url": "https://api.github.com/users/jhpratt/gists{/gist_id}", "starred_url": "https://api.github.com/users/jhpratt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jhpratt/subscriptions", "organizations_url": "https://api.github.com/users/jhpratt/orgs", "repos_url": "https://api.github.com/users/jhpratt/repos", "events_url": "https://api.github.com/users/jhpratt/events{/privacy}", "received_events_url": "https://api.github.com/users/jhpratt/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jhpratt", "id": 3161395, "node_id": "MDQ6VXNlcjMxNjEzOTU=", "avatar_url": "https://avatars.githubusercontent.com/u/3161395?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jhpratt", "html_url": "https://github.com/jhpratt", "followers_url": "https://api.github.com/users/jhpratt/followers", "following_url": "https://api.github.com/users/jhpratt/following{/other_user}", "gists_url": "https://api.github.com/users/jhpratt/gists{/gist_id}", "starred_url": "https://api.github.com/users/jhpratt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jhpratt/subscriptions", "organizations_url": "https://api.github.com/users/jhpratt/orgs", "repos_url": "https://api.github.com/users/jhpratt/repos", "events_url": "https://api.github.com/users/jhpratt/events{/privacy}", "received_events_url": "https://api.github.com/users/jhpratt/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6efc8e34d8b83de7f5b1e47d4bbbe0f2daa385f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/6efc8e34d8b83de7f5b1e47d4bbbe0f2daa385f8", "html_url": "https://github.com/rust-lang/rust/commit/6efc8e34d8b83de7f5b1e47d4bbbe0f2daa385f8"}], "stats": {"total": 48, "additions": 40, "deletions": 8}, "files": [{"sha": "9a750d9f40f5feb4c701a727af3b31b87a30f613", "filename": "compiler/rustc_attr/src/builtin.rs", "status": "modified", "additions": 13, "deletions": 5, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/5636655d0f0afb0d509cd86ad479773f5854630e/compiler%2Frustc_attr%2Fsrc%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5636655d0f0afb0d509cd86ad479773f5854630e/compiler%2Frustc_attr%2Fsrc%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_attr%2Fsrc%2Fbuiltin.rs?ref=5636655d0f0afb0d509cd86ad479773f5854630e", "patch": "@@ -741,7 +741,19 @@ where\n                                     continue 'outer;\n                                 }\n                             }\n-                            sym::suggestion if attr.has_name(sym::rustc_deprecated) => {\n+                            sym::suggestion => {\n+                                if !sess.features_untracked().deprecated_suggestion {\n+                                    let mut diag = sess.struct_span_err(\n+                                        mi.span,\n+                                        \"suggestions on deprecated items are unstable\",\n+                                    );\n+                                    if sess.is_nightly_build() {\n+                                        diag.help(\"add `#![feature(deprecated_suggestion)]` to the crate root\");\n+                                    }\n+                                    // FIXME(jhpratt) change this to an actual tracking issue\n+                                    diag.note(\"see #XXX for more details\").emit();\n+                                }\n+\n                                 if !get(mi, &mut suggestion) {\n                                     continue 'outer;\n                                 }\n@@ -778,10 +790,6 @@ where\n             }\n         }\n \n-        if suggestion.is_some() && attr.has_name(sym::deprecated) {\n-            unreachable!(\"only allowed on rustc_deprecated\")\n-        }\n-\n         if attr.has_name(sym::rustc_deprecated) {\n             if since.is_none() {\n                 handle_errors(&sess.parse_sess, attr.span, AttrError::MissingSince);"}, {"sha": "d39847f7b97dc9baaaf977c3a543fde845dce41d", "filename": "compiler/rustc_feature/src/active.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5636655d0f0afb0d509cd86ad479773f5854630e/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5636655d0f0afb0d509cd86ad479773f5854630e/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Factive.rs?ref=5636655d0f0afb0d509cd86ad479773f5854630e", "patch": "@@ -368,6 +368,8 @@ declare_features! (\n     (active, default_alloc_error_handler, \"1.48.0\", Some(66741), None),\n     /// Allows default type parameters to influence type inference.\n     (active, default_type_parameter_fallback, \"1.3.0\", Some(27336), None),\n+    /// Allows having using `suggestion` in the `#[deprecated]` attribute.\n+    (active, deprecated_suggestion, \"1.61.0\", Some(94785), None),\n     /// Allows `#[derive(Default)]` and `#[default]` on enums.\n     (active, derive_default_enum, \"1.56.0\", Some(86985), None),\n     /// Tells rustdoc to automatically generate `#[doc(cfg(...))]`."}, {"sha": "793e7286e96bd78ac7ffed8087b84a4c5e7487d2", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5636655d0f0afb0d509cd86ad479773f5854630e/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5636655d0f0afb0d509cd86ad479773f5854630e/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=5636655d0f0afb0d509cd86ad479773f5854630e", "patch": "@@ -562,6 +562,7 @@ symbols! {\n         delay_span_bug_from_inside_query,\n         deny,\n         deprecated,\n+        deprecated_suggestion,\n         deref,\n         deref_method,\n         deref_mut,"}, {"sha": "34b091299643efeea0a4a4020bc70ab5385a6962", "filename": "library/core/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5636655d0f0afb0d509cd86ad479773f5854630e/library%2Fcore%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5636655d0f0afb0d509cd86ad479773f5854630e/library%2Fcore%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Flib.rs?ref=5636655d0f0afb0d509cd86ad479773f5854630e", "patch": "@@ -166,6 +166,7 @@\n #![feature(const_refs_to_cell)]\n #![feature(decl_macro)]\n #![feature(derive_default_enum)]\n+#![cfg_attr(not(bootstrap), feature(deprecated_suggestion))]\n #![feature(doc_cfg)]\n #![feature(doc_notable_trait)]\n #![feature(rustdoc_internals)]"}, {"sha": "4040db38be7157692685b76b1329f6054a70bc11", "filename": "library/std/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5636655d0f0afb0d509cd86ad479773f5854630e/library%2Fstd%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5636655d0f0afb0d509cd86ad479773f5854630e/library%2Fstd%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Flib.rs?ref=5636655d0f0afb0d509cd86ad479773f5854630e", "patch": "@@ -270,6 +270,7 @@\n #![feature(doc_cfg)]\n #![feature(doc_cfg_hide)]\n #![feature(rustdoc_internals)]\n+#![cfg_attr(not(bootstrap), feature(deprecated_suggestion))]\n #![feature(doc_masked)]\n #![feature(doc_notable_trait)]\n #![feature(dropck_eyepatch)]"}, {"sha": "a2d0023e3f47938b23195d9e93ab07a894bfb919", "filename": "src/test/ui/deprecation/feature-gate-deprecated_suggestion.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5636655d0f0afb0d509cd86ad479773f5854630e/src%2Ftest%2Fui%2Fdeprecation%2Ffeature-gate-deprecated_suggestion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5636655d0f0afb0d509cd86ad479773f5854630e/src%2Ftest%2Fui%2Fdeprecation%2Ffeature-gate-deprecated_suggestion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdeprecation%2Ffeature-gate-deprecated_suggestion.rs?ref=5636655d0f0afb0d509cd86ad479773f5854630e", "patch": "@@ -0,0 +1,6 @@\n+// compile-flags: --crate-type=lib\n+\n+#![no_implicit_prelude]\n+\n+#[deprecated(suggestion = \"foo\")] //~ ERROR suggestions on deprecated items are unstable\n+struct Foo {}"}, {"sha": "3b995fed75c8cb73afaeb067a33839676d141ad9", "filename": "src/test/ui/deprecation/feature-gate-deprecated_suggestion.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/5636655d0f0afb0d509cd86ad479773f5854630e/src%2Ftest%2Fui%2Fdeprecation%2Ffeature-gate-deprecated_suggestion.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5636655d0f0afb0d509cd86ad479773f5854630e/src%2Ftest%2Fui%2Fdeprecation%2Ffeature-gate-deprecated_suggestion.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdeprecation%2Ffeature-gate-deprecated_suggestion.stderr?ref=5636655d0f0afb0d509cd86ad479773f5854630e", "patch": "@@ -0,0 +1,11 @@\n+error: suggestions on deprecated items are unstable\n+  --> $DIR/feature-gate-deprecated_suggestion.rs:5:14\n+   |\n+LL | #[deprecated(suggestion = \"foo\")]\n+   |              ^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: add `#![feature(deprecated_suggestion)]` to the crate root\n+   = note: see #XXX for more details\n+\n+error: aborting due to previous error\n+"}, {"sha": "6c2718a0296e3f776de37a55c1f48c6dfdafd579", "filename": "src/test/ui/deprecation/suggestion.fixed", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5636655d0f0afb0d509cd86ad479773f5854630e/src%2Ftest%2Fui%2Fdeprecation%2Fsuggestion.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/5636655d0f0afb0d509cd86ad479773f5854630e/src%2Ftest%2Fui%2Fdeprecation%2Fsuggestion.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdeprecation%2Fsuggestion.fixed?ref=5636655d0f0afb0d509cd86ad479773f5854630e", "patch": "@@ -1,6 +1,7 @@\n // run-rustfix\n \n #![feature(staged_api)]\n+#![feature(deprecated_suggestion)]\n \n #![stable(since = \"1.0.0\", feature = \"test\")]\n "}, {"sha": "d512d3227b8d62949a24806449e84b48ebddefe8", "filename": "src/test/ui/deprecation/suggestion.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5636655d0f0afb0d509cd86ad479773f5854630e/src%2Ftest%2Fui%2Fdeprecation%2Fsuggestion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5636655d0f0afb0d509cd86ad479773f5854630e/src%2Ftest%2Fui%2Fdeprecation%2Fsuggestion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdeprecation%2Fsuggestion.rs?ref=5636655d0f0afb0d509cd86ad479773f5854630e", "patch": "@@ -1,6 +1,7 @@\n // run-rustfix\n \n #![feature(staged_api)]\n+#![feature(deprecated_suggestion)]\n \n #![stable(since = \"1.0.0\", feature = \"test\")]\n "}, {"sha": "8d1e108345f30418210b459951133102253c6cd1", "filename": "src/test/ui/deprecation/suggestion.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5636655d0f0afb0d509cd86ad479773f5854630e/src%2Ftest%2Fui%2Fdeprecation%2Fsuggestion.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5636655d0f0afb0d509cd86ad479773f5854630e/src%2Ftest%2Fui%2Fdeprecation%2Fsuggestion.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdeprecation%2Fsuggestion.stderr?ref=5636655d0f0afb0d509cd86ad479773f5854630e", "patch": "@@ -1,17 +1,17 @@\n error: use of deprecated function `bar::deprecated`: replaced by `replacement`\n-  --> $DIR/suggestion.rs:41:10\n+  --> $DIR/suggestion.rs:42:10\n    |\n LL |     bar::deprecated();\n    |          ^^^^^^^^^^ help: replace the use of the deprecated function: `replacement`\n    |\n note: the lint level is defined here\n-  --> $DIR/suggestion.rs:7:9\n+  --> $DIR/suggestion.rs:8:9\n    |\n LL | #![deny(deprecated)]\n    |         ^^^^^^^^^^\n \n error: use of deprecated associated function `Foo::deprecated`: replaced by `replacement`\n-  --> $DIR/suggestion.rs:39:9\n+  --> $DIR/suggestion.rs:40:9\n    |\n LL |     foo.deprecated();\n    |         ^^^^^^^^^^ help: replace the use of the deprecated associated function: `replacement`"}]}