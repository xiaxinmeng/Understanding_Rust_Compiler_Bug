{"sha": "5f98e5ee5613abe3d8c2439af52d399bd6e98949", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVmOThlNWVlNTYxM2FiZTNkOGMyNDM5YWY1MmQzOTliZDZlOTg5NDk=", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-05-24T17:24:58Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-06-30T18:31:52Z"}, "message": "Simplify DepGraph creation.", "tree": {"sha": "095065a24d9aa44a26d8948e24ffc6ae95f3e6cf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/095065a24d9aa44a26d8948e24ffc6ae95f3e6cf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5f98e5ee5613abe3d8c2439af52d399bd6e98949", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5f98e5ee5613abe3d8c2439af52d399bd6e98949", "html_url": "https://github.com/rust-lang/rust/commit/5f98e5ee5613abe3d8c2439af52d399bd6e98949", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5f98e5ee5613abe3d8c2439af52d399bd6e98949/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "868c702d0c9a471a28fb55f0148eb1e3e8b1dcc5", "url": "https://api.github.com/repos/rust-lang/rust/commits/868c702d0c9a471a28fb55f0148eb1e3e8b1dcc5", "html_url": "https://github.com/rust-lang/rust/commit/868c702d0c9a471a28fb55f0148eb1e3e8b1dcc5"}], "stats": {"total": 52, "additions": 21, "deletions": 31}, "files": [{"sha": "ee62089b2376003d84b526073cc84c21b4a00ba1", "filename": "compiler/rustc_incremental/src/persist/load.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/5f98e5ee5613abe3d8c2439af52d399bd6e98949/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f98e5ee5613abe3d8c2439af52d399bd6e98949/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fload.rs?ref=5f98e5ee5613abe3d8c2439af52d399bd6e98949", "patch": "@@ -21,8 +21,8 @@ pub enum LoadResult<T> {\n     Error { message: String },\n }\n \n-impl LoadResult<(SerializedDepGraph, WorkProductMap)> {\n-    pub fn open(self, sess: &Session) -> (SerializedDepGraph, WorkProductMap) {\n+impl<T: Default> LoadResult<T> {\n+    pub fn open(self, sess: &Session) -> T {\n         match self {\n             LoadResult::Error { message } => {\n                 sess.warn(&message);\n@@ -74,11 +74,14 @@ pub enum MaybeAsync<T> {\n     Sync(T),\n     Async(std::thread::JoinHandle<T>),\n }\n-impl<T> MaybeAsync<T> {\n-    pub fn open(self) -> std::thread::Result<T> {\n+\n+impl<T> MaybeAsync<LoadResult<T>> {\n+    pub fn open(self) -> LoadResult<T> {\n         match self {\n-            MaybeAsync::Sync(result) => Ok(result),\n-            MaybeAsync::Async(handle) => handle.join(),\n+            MaybeAsync::Sync(result) => result,\n+            MaybeAsync::Async(handle) => handle.join().unwrap_or_else(|e| LoadResult::Error {\n+                message: format!(\"could not decode incremental cache: {:?}\", e),\n+            }),\n         }\n     }\n }"}, {"sha": "e37a0347dcb98d5783424a7505ba4cfd5c4739c3", "filename": "compiler/rustc_interface/src/queries.rs", "status": "modified", "additions": 12, "deletions": 25, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/5f98e5ee5613abe3d8c2439af52d399bd6e98949/compiler%2Frustc_interface%2Fsrc%2Fqueries.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f98e5ee5613abe3d8c2439af52d399bd6e98949/compiler%2Frustc_interface%2Fsrc%2Fqueries.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fqueries.rs?ref=5f98e5ee5613abe3d8c2439af52d399bd6e98949", "patch": "@@ -119,11 +119,8 @@ impl<'tcx> Queries<'tcx> {\n \n     pub fn dep_graph_future(&self) -> Result<&Query<Option<DepGraphFuture>>> {\n         self.dep_graph_future.compute(|| {\n-            Ok(self\n-                .session()\n-                .opts\n-                .build_dep_graph()\n-                .then(|| rustc_incremental::load_dep_graph(self.session())))\n+            let sess = self.session();\n+            Ok(sess.opts.build_dep_graph().then(|| rustc_incremental::load_dep_graph(sess)))\n         })\n     }\n \n@@ -195,27 +192,17 @@ impl<'tcx> Queries<'tcx> {\n \n     pub fn dep_graph(&self) -> Result<&Query<DepGraph>> {\n         self.dep_graph.compute(|| {\n-            Ok(match self.dep_graph_future()?.take() {\n-                None => DepGraph::new_disabled(),\n-                Some(future) => {\n+            let sess = self.session();\n+            let future_opt = self.dep_graph_future()?.take();\n+            let dep_graph = future_opt\n+                .and_then(|future| {\n                     let (prev_graph, prev_work_products) =\n-                        self.session().time(\"blocked_on_dep_graph_loading\", || {\n-                            future\n-                                .open()\n-                                .unwrap_or_else(|e| rustc_incremental::LoadResult::Error {\n-                                    message: format!(\"could not decode incremental cache: {:?}\", e),\n-                                })\n-                                .open(self.session())\n-                        });\n-\n-                    rustc_incremental::build_dep_graph(\n-                        self.session(),\n-                        prev_graph,\n-                        prev_work_products,\n-                    )\n-                    .unwrap_or_else(DepGraph::new_disabled)\n-                }\n-            })\n+                        sess.time(\"blocked_on_dep_graph_loading\", || future.open().open(sess));\n+\n+                    rustc_incremental::build_dep_graph(sess, prev_graph, prev_work_products)\n+                })\n+                .unwrap_or_else(DepGraph::new_disabled);\n+            Ok(dep_graph)\n         })\n     }\n "}]}