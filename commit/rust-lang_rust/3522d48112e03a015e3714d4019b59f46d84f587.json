{"sha": "3522d48112e03a015e3714d4019b59f46d84f587", "node_id": "C_kwDOAAsO6NoAKDM1MjJkNDgxMTJlMDNhMDE1ZTM3MTRkNDAxOWI1OWY0NmQ4NGY1ODc", "commit": {"author": {"name": "Jakob Degen", "email": "jakob.e.degen@gmail.com", "date": "2022-12-13T12:22:47Z"}, "committer": {"name": "Jakob Degen", "email": "jakob.e.degen@gmail.com", "date": "2022-12-13T12:22:47Z"}, "message": "Don't require owned data in `MaybeStorageLive`", "tree": {"sha": "26bc95b13467ad0b1ec00e3c4be34e1ebff826ab", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/26bc95b13467ad0b1ec00e3c4be34e1ebff826ab"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3522d48112e03a015e3714d4019b59f46d84f587", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3522d48112e03a015e3714d4019b59f46d84f587", "html_url": "https://github.com/rust-lang/rust/commit/3522d48112e03a015e3714d4019b59f46d84f587", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3522d48112e03a015e3714d4019b59f46d84f587/comments", "author": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "109cccbe4f345c0f0785ce860788580c3e2a29f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/109cccbe4f345c0f0785ce860788580c3e2a29f5", "html_url": "https://github.com/rust-lang/rust/commit/109cccbe4f345c0f0785ce860788580c3e2a29f5"}], "stats": {"total": 19, "additions": 10, "deletions": 9}, "files": [{"sha": "1b932d0e7084f74442f2a3019002acb291787781", "filename": "compiler/rustc_const_eval/src/transform/validate.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3522d48112e03a015e3714d4019b59f46d84f587/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3522d48112e03a015e3714d4019b59f46d84f587/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs?ref=3522d48112e03a015e3714d4019b59f46d84f587", "patch": "@@ -52,7 +52,7 @@ impl<'tcx> MirPass<'tcx> for Validator {\n         };\n \n         let always_live_locals = always_storage_live_locals(body);\n-        let storage_liveness = MaybeStorageLive::new(always_live_locals)\n+        let storage_liveness = MaybeStorageLive::new(std::borrow::Cow::Owned(always_live_locals))\n             .into_engine(tcx, body)\n             .iterate_to_fixpoint()\n             .into_results_cursor(body);\n@@ -79,7 +79,7 @@ struct TypeChecker<'a, 'tcx> {\n     param_env: ParamEnv<'tcx>,\n     mir_phase: MirPhase,\n     reachable_blocks: BitSet<BasicBlock>,\n-    storage_liveness: ResultsCursor<'a, 'tcx, MaybeStorageLive>,\n+    storage_liveness: ResultsCursor<'a, 'tcx, MaybeStorageLive<'static>>,\n     place_cache: Vec<PlaceRef<'tcx>>,\n     value_cache: Vec<u128>,\n }"}, {"sha": "8d379b90a86db28194b2946df68bc564b8e84961", "filename": "compiler/rustc_mir_dataflow/src/impls/storage_liveness.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/3522d48112e03a015e3714d4019b59f46d84f587/compiler%2Frustc_mir_dataflow%2Fsrc%2Fimpls%2Fstorage_liveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3522d48112e03a015e3714d4019b59f46d84f587/compiler%2Frustc_mir_dataflow%2Fsrc%2Fimpls%2Fstorage_liveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Fimpls%2Fstorage_liveness.rs?ref=3522d48112e03a015e3714d4019b59f46d84f587", "patch": "@@ -3,20 +3,21 @@ pub use super::*;\n use crate::{CallReturnPlaces, GenKill, Results, ResultsRefCursor};\n use rustc_middle::mir::visit::{NonMutatingUseContext, PlaceContext, Visitor};\n use rustc_middle::mir::*;\n+use std::borrow::Cow;\n use std::cell::RefCell;\n \n #[derive(Clone)]\n-pub struct MaybeStorageLive {\n-    always_live_locals: BitSet<Local>,\n+pub struct MaybeStorageLive<'a> {\n+    always_live_locals: Cow<'a, BitSet<Local>>,\n }\n \n-impl MaybeStorageLive {\n-    pub fn new(always_live_locals: BitSet<Local>) -> Self {\n+impl<'a> MaybeStorageLive<'a> {\n+    pub fn new(always_live_locals: Cow<'a, BitSet<Local>>) -> Self {\n         MaybeStorageLive { always_live_locals }\n     }\n }\n \n-impl<'tcx> crate::AnalysisDomain<'tcx> for MaybeStorageLive {\n+impl<'tcx, 'a> crate::AnalysisDomain<'tcx> for MaybeStorageLive<'a> {\n     type Domain = BitSet<Local>;\n \n     const NAME: &'static str = \"maybe_storage_live\";\n@@ -38,7 +39,7 @@ impl<'tcx> crate::AnalysisDomain<'tcx> for MaybeStorageLive {\n     }\n }\n \n-impl<'tcx> crate::GenKillAnalysis<'tcx> for MaybeStorageLive {\n+impl<'tcx, 'a> crate::GenKillAnalysis<'tcx> for MaybeStorageLive<'a> {\n     type Idx = Local;\n \n     fn statement_effect("}, {"sha": "c097af6161159a7fcec85b6b0bb69a3605fcb8e9", "filename": "compiler/rustc_mir_transform/src/generator.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3522d48112e03a015e3714d4019b59f46d84f587/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3522d48112e03a015e3714d4019b59f46d84f587/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs?ref=3522d48112e03a015e3714d4019b59f46d84f587", "patch": "@@ -490,7 +490,7 @@ fn locals_live_across_suspend_points<'tcx>(\n \n     // Calculate when MIR locals have live storage. This gives us an upper bound of their\n     // lifetimes.\n-    let mut storage_live = MaybeStorageLive::new(always_live_locals.clone())\n+    let mut storage_live = MaybeStorageLive::new(std::borrow::Cow::Borrowed(always_live_locals))\n         .into_engine(tcx, body_ref)\n         .iterate_to_fixpoint()\n         .into_results_cursor(body_ref);"}]}