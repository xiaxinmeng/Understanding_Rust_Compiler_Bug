{"sha": "7c55c992ab22878913963c5430c2c31bf400c9df", "node_id": "C_kwDOAAsO6NoAKDdjNTVjOTkyYWIyMjg3ODkxMzk2M2M1NDMwYzJjMzFiZjQwMGM5ZGY", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-09-17T10:01:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-09-17T10:01:08Z"}, "message": "Rollup merge of #101807 - jackh726:no-gat-defaults, r=lcnr\n\nDisallow defaults on type GATs\n\nFixes #99205", "tree": {"sha": "fe2138cd525888c95e7bdadb6077e4987430ea25", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fe2138cd525888c95e7bdadb6077e4987430ea25"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7c55c992ab22878913963c5430c2c31bf400c9df", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjJZrkCRBK7hj4Ov3rIwAABJUIAFSHEX+HoOTltG9UnGNAOfQd\nT0GmRqeAeY5L/fwtyfii9Gm7m7lGFr9rCyJj5XZNXwoIo1ksmtKOghtxxNCWLChS\nw4gmOqdMtFmm+RiTouk9iOMd+0SZYpnGAWDF53eJ/SOQ+BVN8NCNDjULrZvqAJsk\nT2nAq0RPyR13lRHK+viMdStEWsnnSG2JtgK2vxD+zZfwXJT1rfmicoJVBMqbFE0z\nWpIJ8DI7ED9/f5fcrDHv22HYRYzHKNgiNFbmt+6l3wQSatfUqsVFKSzzu+Hi4E2C\nqswFMxxyqrGhO+qp9oJQUMA8UJJQN1v18gensXnOkNKmH7hQ/eZCV/6eyY4ZQ7A=\n=fKfu\n-----END PGP SIGNATURE-----\n", "payload": "tree fe2138cd525888c95e7bdadb6077e4987430ea25\nparent 4c64c144202f6367755c476048aaaf0741af6086\nparent d657d1f4a1712a57fa3f176dde4e0be72bc21e8b\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1663408868 +0530\ncommitter GitHub <noreply@github.com> 1663408868 +0530\n\nRollup merge of #101807 - jackh726:no-gat-defaults, r=lcnr\n\nDisallow defaults on type GATs\n\nFixes #99205\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7c55c992ab22878913963c5430c2c31bf400c9df", "html_url": "https://github.com/rust-lang/rust/commit/7c55c992ab22878913963c5430c2c31bf400c9df", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7c55c992ab22878913963c5430c2c31bf400c9df/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4c64c144202f6367755c476048aaaf0741af6086", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c64c144202f6367755c476048aaaf0741af6086", "html_url": "https://github.com/rust-lang/rust/commit/4c64c144202f6367755c476048aaaf0741af6086"}, {"sha": "d657d1f4a1712a57fa3f176dde4e0be72bc21e8b", "url": "https://api.github.com/repos/rust-lang/rust/commits/d657d1f4a1712a57fa3f176dde4e0be72bc21e8b", "html_url": "https://github.com/rust-lang/rust/commit/d657d1f4a1712a57fa3f176dde4e0be72bc21e8b"}], "stats": {"total": 115, "additions": 96, "deletions": 19}, "files": [{"sha": "45a5eca708ab5eac832aa107495e199de4ea67e2", "filename": "compiler/rustc_typeck/src/collect.rs", "status": "modified", "additions": 42, "deletions": 19, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/7c55c992ab22878913963c5430c2c31bf400c9df/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c55c992ab22878913963c5430c2c31bf400c9df/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs?ref=7c55c992ab22878913963c5430c2c31bf400c9df", "patch": "@@ -1606,6 +1606,13 @@ fn generics_of(tcx: TyCtxt<'_>, def_id: DefId) -> ty::Generics {\n         _ => None,\n     };\n \n+    enum Defaults {\n+        Allowed,\n+        // See #36887\n+        FutureCompatDisallowed,\n+        Deny,\n+    }\n+\n     let no_generics = hir::Generics::empty();\n     let ast_generics = node.generics().unwrap_or(&no_generics);\n     let (opt_self, allow_defaults) = match node {\n@@ -1627,17 +1634,26 @@ fn generics_of(tcx: TyCtxt<'_>, def_id: DefId) -> ty::Generics {\n                         },\n                     });\n \n-                    (opt_self, true)\n+                    (opt_self, Defaults::Allowed)\n                 }\n                 ItemKind::TyAlias(..)\n                 | ItemKind::Enum(..)\n                 | ItemKind::Struct(..)\n                 | ItemKind::OpaqueTy(..)\n-                | ItemKind::Union(..) => (None, true),\n-                _ => (None, false),\n+                | ItemKind::Union(..) => (None, Defaults::Allowed),\n+                _ => (None, Defaults::FutureCompatDisallowed),\n             }\n         }\n-        _ => (None, false),\n+\n+        // GATs\n+        Node::TraitItem(item) if matches!(item.kind, TraitItemKind::Type(..)) => {\n+            (None, Defaults::Deny)\n+        }\n+        Node::ImplItem(item) if matches!(item.kind, ImplItemKind::TyAlias(..)) => {\n+            (None, Defaults::Deny)\n+        }\n+\n+        _ => (None, Defaults::FutureCompatDisallowed),\n     };\n \n     let has_self = opt_self.is_some();\n@@ -1670,23 +1686,30 @@ fn generics_of(tcx: TyCtxt<'_>, def_id: DefId) -> ty::Generics {\n     let type_start = own_start - has_self as u32 + params.len() as u32;\n     let mut i = 0;\n \n+    const TYPE_DEFAULT_NOT_ALLOWED: &'static str = \"defaults for type parameters are only allowed in \\\n+    `struct`, `enum`, `type`, or `trait` definitions\";\n+\n     params.extend(ast_generics.params.iter().filter_map(|param| match param.kind {\n         GenericParamKind::Lifetime { .. } => None,\n         GenericParamKind::Type { ref default, synthetic, .. } => {\n-            if !allow_defaults && default.is_some() {\n-                if !tcx.features().default_type_parameter_fallback {\n-                    tcx.struct_span_lint_hir(\n-                        lint::builtin::INVALID_TYPE_PARAM_DEFAULT,\n-                        param.hir_id,\n-                        param.span,\n-                        |lint| {\n-                            lint.build(\n-                                \"defaults for type parameters are only allowed in \\\n-                                 `struct`, `enum`, `type`, or `trait` definitions\",\n-                            )\n-                            .emit();\n-                        },\n-                    );\n+            if default.is_some() {\n+                match allow_defaults {\n+                    Defaults::Allowed => {}\n+                    Defaults::FutureCompatDisallowed\n+                        if tcx.features().default_type_parameter_fallback => {}\n+                    Defaults::FutureCompatDisallowed => {\n+                        tcx.struct_span_lint_hir(\n+                            lint::builtin::INVALID_TYPE_PARAM_DEFAULT,\n+                            param.hir_id,\n+                            param.span,\n+                            |lint| {\n+                                lint.build(TYPE_DEFAULT_NOT_ALLOWED).emit();\n+                            },\n+                        );\n+                    }\n+                    Defaults::Deny => {\n+                        tcx.sess.span_err(param.span, TYPE_DEFAULT_NOT_ALLOWED);\n+                    }\n                 }\n             }\n \n@@ -1703,7 +1726,7 @@ fn generics_of(tcx: TyCtxt<'_>, def_id: DefId) -> ty::Generics {\n             Some(param_def)\n         }\n         GenericParamKind::Const { default, .. } => {\n-            if !allow_defaults && default.is_some() {\n+            if !matches!(allow_defaults, Defaults::Allowed) && default.is_some() {\n                 tcx.sess.span_err(\n                     param.span,\n                     \"defaults for const parameters are only allowed in \\"}, {"sha": "f034076b01093aed18f4a3eaf60466bf05cbfa0d", "filename": "src/test/ui/generic-associated-types/type-param-defaults.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/7c55c992ab22878913963c5430c2c31bf400c9df/src%2Ftest%2Fui%2Fgeneric-associated-types%2Ftype-param-defaults.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c55c992ab22878913963c5430c2c31bf400c9df/src%2Ftest%2Fui%2Fgeneric-associated-types%2Ftype-param-defaults.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Ftype-param-defaults.rs?ref=7c55c992ab22878913963c5430c2c31bf400c9df", "patch": "@@ -0,0 +1,34 @@\n+// Check that we disallow GAT param defaults, even with `invalid_type_param_default` allowed\n+\n+#![allow(invalid_type_param_default)]\n+\n+trait Trait {\n+    type Assoc<T = u32>;\n+    //~^ defaults for type parameters are only allowed\n+}\n+\n+impl Trait for () {\n+    type Assoc<T = u32> = u64;\n+    //~^ defaults for type parameters are only allowed\n+}\n+\n+impl Trait for u32 {\n+    type Assoc<T = u32> = T;\n+    //~^ defaults for type parameters are only allowed\n+}\n+\n+trait Other {}\n+impl Other for u32 {}\n+\n+fn foo<T>()\n+where\n+    T: Trait<Assoc = u32>,\n+    T::Assoc: Other {\n+    }\n+\n+fn main() {\n+    // errors\n+    foo::<()>();\n+    // works\n+    foo::<u32>();\n+}"}, {"sha": "85ccaba0e69e721a40b70821dc7776ce0849c7a4", "filename": "src/test/ui/generic-associated-types/type-param-defaults.stderr", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/7c55c992ab22878913963c5430c2c31bf400c9df/src%2Ftest%2Fui%2Fgeneric-associated-types%2Ftype-param-defaults.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7c55c992ab22878913963c5430c2c31bf400c9df/src%2Ftest%2Fui%2Fgeneric-associated-types%2Ftype-param-defaults.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Ftype-param-defaults.stderr?ref=7c55c992ab22878913963c5430c2c31bf400c9df", "patch": "@@ -0,0 +1,20 @@\n+error: defaults for type parameters are only allowed in `struct`, `enum`, `type`, or `trait` definitions\n+  --> $DIR/type-param-defaults.rs:6:16\n+   |\n+LL |     type Assoc<T = u32>;\n+   |                ^^^^^^^\n+\n+error: defaults for type parameters are only allowed in `struct`, `enum`, `type`, or `trait` definitions\n+  --> $DIR/type-param-defaults.rs:11:16\n+   |\n+LL |     type Assoc<T = u32> = u64;\n+   |                ^^^^^^^\n+\n+error: defaults for type parameters are only allowed in `struct`, `enum`, `type`, or `trait` definitions\n+  --> $DIR/type-param-defaults.rs:16:16\n+   |\n+LL |     type Assoc<T = u32> = T;\n+   |                ^^^^^^^\n+\n+error: aborting due to 3 previous errors\n+"}]}