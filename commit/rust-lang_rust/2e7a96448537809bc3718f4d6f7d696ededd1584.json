{"sha": "2e7a96448537809bc3718f4d6f7d696ededd1584", "node_id": "C_kwDOAAsO6NoAKDJlN2E5NjQ0ODUzNzgwOWJjMzcxOGY0ZDZmN2Q2OTZlZGVkZDE1ODQ", "commit": {"author": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2022-09-30T01:18:26Z"}, "committer": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2022-09-30T01:18:26Z"}, "message": "Adjust the s390x data layout for LLVM 16\n\nLLVM [D131158] changed the SystemZ data layout to always set 64-bit\nvector alignment, which used to be conditional on the \"vector\" feature.\n\n[D131158]: https://reviews.llvm.org/D131158", "tree": {"sha": "b2f96b8d10243796c037f7a77938f30035dcf902", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b2f96b8d10243796c037f7a77938f30035dcf902"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2e7a96448537809bc3718f4d6f7d696ededd1584", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2e7a96448537809bc3718f4d6f7d696ededd1584", "html_url": "https://github.com/rust-lang/rust/commit/2e7a96448537809bc3718f4d6f7d696ededd1584", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2e7a96448537809bc3718f4d6f7d696ededd1584/comments", "author": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9c56d9d6fec6262bbb1549cfe466a812ae2c6523", "url": "https://api.github.com/repos/rust-lang/rust/commits/9c56d9d6fec6262bbb1549cfe466a812ae2c6523", "html_url": "https://github.com/rust-lang/rust/commit/9c56d9d6fec6262bbb1549cfe466a812ae2c6523"}], "stats": {"total": 21, "additions": 13, "deletions": 8}, "files": [{"sha": "2ab69d2541169fc51580a1f83cf77ea1cd23224f", "filename": "compiler/rustc_codegen_llvm/src/context.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/2e7a96448537809bc3718f4d6f7d696ededd1584/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e7a96448537809bc3718f4d6f7d696ededd1584/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs?ref=2e7a96448537809bc3718f4d6f7d696ededd1584", "patch": "@@ -154,6 +154,11 @@ pub unsafe fn create_module<'ll>(\n             target_data_layout = target_data_layout.replace(\"-p10:8:8-p20:8:8\", \"\");\n         }\n     }\n+    if llvm_version < (16, 0, 0) {\n+        if sess.target.arch == \"s390x\" {\n+            target_data_layout = target_data_layout.replace(\"-v128:64\", \"\");\n+        }\n+    }\n \n     // Ensure the data-layout values hardcoded remain the defaults.\n     if sess.target.is_builtin {"}, {"sha": "cda88de0ea40693558af4084af4a49adcaa33ea4", "filename": "compiler/rustc_target/src/spec/s390x_unknown_linux_gnu.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2e7a96448537809bc3718f4d6f7d696ededd1584/compiler%2Frustc_target%2Fsrc%2Fspec%2Fs390x_unknown_linux_gnu.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e7a96448537809bc3718f4d6f7d696ededd1584/compiler%2Frustc_target%2Fsrc%2Fspec%2Fs390x_unknown_linux_gnu.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fs390x_unknown_linux_gnu.rs?ref=2e7a96448537809bc3718f4d6f7d696ededd1584", "patch": "@@ -6,9 +6,9 @@ pub fn target() -> Target {\n     base.endian = Endian::Big;\n     // z10 is the oldest CPU supported by LLVM\n     base.cpu = \"z10\".into();\n-    // FIXME: The data_layout string below and the ABI implementation in\n-    // cabi_s390x.rs are for now hard-coded to assume the no-vector ABI.\n-    // Pass the -vector feature string to LLVM to respect this assumption.\n+    // FIXME: The ABI implementation in cabi_s390x.rs is for now hard-coded to assume the no-vector\n+    // ABI. Pass the -vector feature string to LLVM to respect this assumption. On LLVM < 16, we\n+    // also strip v128 from the data_layout below to match the older LLVM's expectation.\n     base.features = \"-vector\".into();\n     base.max_atomic_width = Some(64);\n     base.min_global_align = Some(16);\n@@ -17,7 +17,7 @@ pub fn target() -> Target {\n     Target {\n         llvm_target: \"s390x-unknown-linux-gnu\".into(),\n         pointer_width: 64,\n-        data_layout: \"E-m:e-i1:8:16-i8:8:16-i64:64-f128:64-a:8:16-n32:64\".into(),\n+        data_layout: \"E-m:e-i1:8:16-i8:8:16-i64:64-f128:64-v128:64-a:8:16-n32:64\".into(),\n         arch: \"s390x\".into(),\n         options: base,\n     }"}, {"sha": "91e63aee5e49020211443eec54f3c776b0be92e7", "filename": "compiler/rustc_target/src/spec/s390x_unknown_linux_musl.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2e7a96448537809bc3718f4d6f7d696ededd1584/compiler%2Frustc_target%2Fsrc%2Fspec%2Fs390x_unknown_linux_musl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e7a96448537809bc3718f4d6f7d696ededd1584/compiler%2Frustc_target%2Fsrc%2Fspec%2Fs390x_unknown_linux_musl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fs390x_unknown_linux_musl.rs?ref=2e7a96448537809bc3718f4d6f7d696ededd1584", "patch": "@@ -6,9 +6,9 @@ pub fn target() -> Target {\n     base.endian = Endian::Big;\n     // z10 is the oldest CPU supported by LLVM\n     base.cpu = \"z10\".into();\n-    // FIXME: The data_layout string below and the ABI implementation in\n-    // cabi_s390x.rs are for now hard-coded to assume the no-vector ABI.\n-    // Pass the -vector feature string to LLVM to respect this assumption.\n+    // FIXME: The ABI implementation in cabi_s390x.rs is for now hard-coded to assume the no-vector\n+    // ABI. Pass the -vector feature string to LLVM to respect this assumption. On LLVM < 16, we\n+    // also strip v128 from the data_layout below to match the older LLVM's expectation.\n     base.features = \"-vector\".into();\n     base.max_atomic_width = Some(64);\n     base.min_global_align = Some(16);\n@@ -18,7 +18,7 @@ pub fn target() -> Target {\n     Target {\n         llvm_target: \"s390x-unknown-linux-musl\".into(),\n         pointer_width: 64,\n-        data_layout: \"E-m:e-i1:8:16-i8:8:16-i64:64-f128:64-a:8:16-n32:64\".into(),\n+        data_layout: \"E-m:e-i1:8:16-i8:8:16-i64:64-f128:64-v128:64-a:8:16-n32:64\".into(),\n         arch: \"s390x\".into(),\n         options: base,\n     }"}]}