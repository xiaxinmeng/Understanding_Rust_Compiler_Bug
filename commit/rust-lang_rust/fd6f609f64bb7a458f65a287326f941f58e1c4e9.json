{"sha": "fd6f609f64bb7a458f65a287326f941f58e1c4e9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZkNmY2MDlmNjRiYjdhNDU4ZjY1YTI4NzMyNmY5NDFmNThlMWM0ZTk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-01-25T17:47:54Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-01-25T17:47:54Z"}, "message": "Auto merge of #5083 - Areredify:issue-4399, r=flip1995\n\ndont fire `possible_missing_comma` if intendation is present\n\nCloses #4399\nchangelog: dont fire `possible_missing_comma` if intendation is present\n\nI suspect there is already a utils function for indentation (but searching indent didn't yield a function for that), and my solution is certainly not universal, but it's probably the best we can do.", "tree": {"sha": "489e2b7b81770f638db28d474987bb1602b53d20", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/489e2b7b81770f638db28d474987bb1602b53d20"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fd6f609f64bb7a458f65a287326f941f58e1c4e9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fd6f609f64bb7a458f65a287326f941f58e1c4e9", "html_url": "https://github.com/rust-lang/rust/commit/fd6f609f64bb7a458f65a287326f941f58e1c4e9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fd6f609f64bb7a458f65a287326f941f58e1c4e9/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6b5419412eb7af7269e71496dd55837c1848f87f", "url": "https://api.github.com/repos/rust-lang/rust/commits/6b5419412eb7af7269e71496dd55837c1848f87f", "html_url": "https://github.com/rust-lang/rust/commit/6b5419412eb7af7269e71496dd55837c1848f87f"}, {"sha": "a234aef084d2f591e8472029b2d03a0f51b5adb2", "url": "https://api.github.com/repos/rust-lang/rust/commits/a234aef084d2f591e8472029b2d03a0f51b5adb2", "html_url": "https://github.com/rust-lang/rust/commit/a234aef084d2f591e8472029b2d03a0f51b5adb2"}], "stats": {"total": 59, "additions": 42, "deletions": 17}, "files": [{"sha": "fed87f26be058541f14bd243f941934638b113d9", "filename": "clippy_lints/src/formatting.rs", "status": "modified", "additions": 22, "deletions": 16, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/fd6f609f64bb7a458f65a287326f941f58e1c4e9/clippy_lints%2Fsrc%2Fformatting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd6f609f64bb7a458f65a287326f941f58e1c4e9/clippy_lints%2Fsrc%2Fformatting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fformatting.rs?ref=fd6f609f64bb7a458f65a287326f941f58e1c4e9", "patch": "@@ -3,6 +3,7 @@ use if_chain::if_chain;\n use rustc::lint::in_external_macro;\n use rustc_lint::{EarlyContext, EarlyLintPass};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n+use rustc_span::source_map::Span;\n use syntax::ast::*;\n \n declare_clippy_lint! {\n@@ -242,26 +243,31 @@ fn has_unary_equivalent(bin_op: BinOpKind) -> bool {\n     bin_op == BinOpKind::And || bin_op == BinOpKind::Mul || bin_op == BinOpKind::Sub\n }\n \n+fn indentation(cx: &EarlyContext<'_>, span: Span) -> usize {\n+    cx.sess.source_map().lookup_char_pos(span.lo()).col.0\n+}\n+\n /// Implementation of the `POSSIBLE_MISSING_COMMA` lint for array\n fn check_array(cx: &EarlyContext<'_>, expr: &Expr) {\n     if let ExprKind::Array(ref array) = expr.kind {\n         for element in array {\n-            if let ExprKind::Binary(ref op, ref lhs, _) = element.kind {\n-                if has_unary_equivalent(op.node) && !differing_macro_contexts(lhs.span, op.span) {\n-                    let space_span = lhs.span.between(op.span);\n-                    if let Some(space_snippet) = snippet_opt(cx, space_span) {\n-                        let lint_span = lhs.span.with_lo(lhs.span.hi());\n-                        if space_snippet.contains('\\n') {\n-                            span_note_and_lint(\n-                                cx,\n-                                POSSIBLE_MISSING_COMMA,\n-                                lint_span,\n-                                \"possibly missing a comma here\",\n-                                lint_span,\n-                                \"to remove this lint, add a comma or write the expr in a single line\",\n-                            );\n-                        }\n-                    }\n+            if_chain! {\n+                if let ExprKind::Binary(ref op, ref lhs, _) = element.kind;\n+                if has_unary_equivalent(op.node) && !differing_macro_contexts(lhs.span, op.span);\n+                let space_span = lhs.span.between(op.span);\n+                if let Some(space_snippet) = snippet_opt(cx, space_span);\n+                let lint_span = lhs.span.with_lo(lhs.span.hi());\n+                if space_snippet.contains('\\n');\n+                if indentation(cx, op.span) <= indentation(cx, lhs.span);\n+                then {\n+                    span_note_and_lint(\n+                        cx,\n+                        POSSIBLE_MISSING_COMMA,\n+                        lint_span,\n+                        \"possibly missing a comma here\",\n+                        lint_span,\n+                        \"to remove this lint, add a comma or write the expr in a single line\",\n+                    );\n                 }\n             }\n         }"}, {"sha": "078811b8d882b8ba378b8f3b86409f82a8b8fbb5", "filename": "tests/ui/formatting.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/fd6f609f64bb7a458f65a287326f941f58e1c4e9/tests%2Fui%2Fformatting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd6f609f64bb7a458f65a287326f941f58e1c4e9/tests%2Fui%2Fformatting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fformatting.rs?ref=fd6f609f64bb7a458f65a287326f941f58e1c4e9", "patch": "@@ -143,4 +143,15 @@ fn main() {\n         true\n         | false,\n     ];\n+\n+    // don't lint if the indentation suggests not to\n+    let _ = &[\n+        1 + 2, 3 \n+                - 4, 5\n+    ];\n+    // lint if it doesnt\n+    let _ = &[\n+        -1\n+        -4,\n+    ];\n }"}, {"sha": "e2095cc125bb7652db8fe7c147cf8f5362009b72", "filename": "tests/ui/formatting.stderr", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/fd6f609f64bb7a458f65a287326f941f58e1c4e9/tests%2Fui%2Fformatting.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fd6f609f64bb7a458f65a287326f941f58e1c4e9/tests%2Fui%2Fformatting.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fformatting.stderr?ref=fd6f609f64bb7a458f65a287326f941f58e1c4e9", "patch": "@@ -115,5 +115,13 @@ LL |         -1, -2, -3 // <= no comma here\n    |\n    = note: to remove this lint, add a comma or write the expr in a single line\n \n-error: aborting due to 13 previous errors\n+error: possibly missing a comma here\n+  --> $DIR/formatting.rs:154:11\n+   |\n+LL |         -1\n+   |           ^\n+   |\n+   = note: to remove this lint, add a comma or write the expr in a single line\n+\n+error: aborting due to 14 previous errors\n "}]}