{"sha": "a656bc5b089aa39c69ee208baecce21e8bf138a7", "node_id": "C_kwDOAAsO6NoAKGE2NTZiYzViMDg5YWEzOWM2OWVlMjA4YmFlY2NlMjFlOGJmMTM4YTc", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-10-22T10:42:49Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-10-22T10:42:49Z"}, "message": "Rollup merge of #90069 - tmiasko:promoted-const-qualif, r=oli-obk\n\nFix const qualification when executed after promotion\n\nThe const qualification was so far performed before the promotion and\nthe implementation assumed that it will never encounter a promoted.\n\nWith `const_precise_live_drops` feature, checking for live drops is\ndelayed until after drop elaboration, which in turn runs after\npromotion. so the assumption is no longer true. When evaluating\n`NeedsNonConstDrop` it is now possible to encounter promoteds.\n\nUse type base qualification for the promoted. It is a sound\napproximation in general, and in the specific case of promoteds and\n`NeedsNonConstDrop` it is precise.\n\nFixes #89938.", "tree": {"sha": "ca5f3d14c58d38aea08fba0356b0cbd89defa15b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ca5f3d14c58d38aea08fba0356b0cbd89defa15b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a656bc5b089aa39c69ee208baecce21e8bf138a7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhcpWqCRBK7hj4Ov3rIwAAHIYIAFfalZngGoYzIF7rrAfA5WCu\nPV1j6Sptfdn7LxJtn2DuChAGF6osFkl4omjHvG+6+f6A4yNzHOqnhfsjSslYO793\nYie1PPttBph/KqqEzsoTJUgcz4kMd7xPa75yVzDoEmC1GS2ezI+h0Y99qM9ccZjO\naeyySPkVhzVEJxVyVKS6j2ClS+LUGGTbupTogcCPugHJgjLiEKqK/nbP9oWxwEYk\nBdO1NnI5gOUtlHXzIJwK61ZmmoNdrz79ZB6M2afqL36kttxsmnOQibn+dhgYg76n\nQGcKjxlBsapuahpiGxzifMJpim01MXlpViVqZVXxWi0GycriEWkaRzrFqHy9pBM=\n=NWZY\n-----END PGP SIGNATURE-----\n", "payload": "tree ca5f3d14c58d38aea08fba0356b0cbd89defa15b\nparent 9ed9025ea9f047a13653bb15b57c5f62e1be3828\nparent 74c6636d27fe95e79d130f7420302d5db2559c3b\nauthor Yuki Okushi <jtitor@2k36.org> 1634899369 +0900\ncommitter GitHub <noreply@github.com> 1634899369 +0900\n\nRollup merge of #90069 - tmiasko:promoted-const-qualif, r=oli-obk\n\nFix const qualification when executed after promotion\n\nThe const qualification was so far performed before the promotion and\nthe implementation assumed that it will never encounter a promoted.\n\nWith `const_precise_live_drops` feature, checking for live drops is\ndelayed until after drop elaboration, which in turn runs after\npromotion. so the assumption is no longer true. When evaluating\n`NeedsNonConstDrop` it is now possible to encounter promoteds.\n\nUse type base qualification for the promoted. It is a sound\napproximation in general, and in the specific case of promoteds and\n`NeedsNonConstDrop` it is precise.\n\nFixes #89938.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a656bc5b089aa39c69ee208baecce21e8bf138a7", "html_url": "https://github.com/rust-lang/rust/commit/a656bc5b089aa39c69ee208baecce21e8bf138a7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a656bc5b089aa39c69ee208baecce21e8bf138a7/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9ed9025ea9f047a13653bb15b57c5f62e1be3828", "url": "https://api.github.com/repos/rust-lang/rust/commits/9ed9025ea9f047a13653bb15b57c5f62e1be3828", "html_url": "https://github.com/rust-lang/rust/commit/9ed9025ea9f047a13653bb15b57c5f62e1be3828"}, {"sha": "74c6636d27fe95e79d130f7420302d5db2559c3b", "url": "https://api.github.com/repos/rust-lang/rust/commits/74c6636d27fe95e79d130f7420302d5db2559c3b", "html_url": "https://github.com/rust-lang/rust/commit/74c6636d27fe95e79d130f7420302d5db2559c3b"}], "stats": {"total": 20, "additions": 18, "deletions": 2}, "files": [{"sha": "aaeb1eeb04397cdd2ffa0b74797ede607f30b264", "filename": "compiler/rustc_const_eval/src/transform/check_consts/qualifs.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/a656bc5b089aa39c69ee208baecce21e8bf138a7/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fqualifs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a656bc5b089aa39c69ee208baecce21e8bf138a7/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fqualifs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fqualifs.rs?ref=a656bc5b089aa39c69ee208baecce21e8bf138a7", "patch": "@@ -46,6 +46,9 @@ pub trait Qualif {\n     /// Whether this `Qualif` is cleared when a local is moved from.\n     const IS_CLEARED_ON_MOVE: bool = false;\n \n+    /// Whether this `Qualif` might be evaluated after the promotion and can encounter a promoted.\n+    const ALLOW_PROMOTED: bool = false;\n+\n     /// Extracts the field of `ConstQualifs` that corresponds to this `Qualif`.\n     fn in_qualifs(qualifs: &ConstQualifs) -> bool;\n \n@@ -129,6 +132,7 @@ pub struct NeedsNonConstDrop;\n impl Qualif for NeedsNonConstDrop {\n     const ANALYSIS_NAME: &'static str = \"flow_needs_nonconst_drop\";\n     const IS_CLEARED_ON_MOVE: bool = true;\n+    const ALLOW_PROMOTED: bool = true;\n \n     fn in_qualifs(qualifs: &ConstQualifs) -> bool {\n         qualifs.needs_non_const_drop\n@@ -310,9 +314,12 @@ where\n     // Check the qualifs of the value of `const` items.\n     if let Some(ct) = constant.literal.const_for_ty() {\n         if let ty::ConstKind::Unevaluated(ty::Unevaluated { def, substs_: _, promoted }) = ct.val {\n-            assert!(promoted.is_none());\n+            // Use qualifs of the type for the promoted. Promoteds in MIR body should be possible\n+            // only for `NeedsNonConstDrop` with precise drop checking. This is the only const\n+            // check performed after the promotion. Verify that with an assertion.\n+            assert!(promoted.is_none() || Q::ALLOW_PROMOTED);\n             // Don't peek inside trait associated constants.\n-            if cx.tcx.trait_of_item(def.did).is_none() {\n+            if promoted.is_none() && cx.tcx.trait_of_item(def.did).is_none() {\n                 let qualifs = if let Some((did, param_did)) = def.as_const_arg() {\n                     cx.tcx.at(constant.span).mir_const_qualif_const_arg((did, param_did))\n                 } else {"}, {"sha": "6f2317a5a27a802aac4580ba0380114c45b6dc10", "filename": "src/test/ui/consts/precise-drop-with-promoted.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a656bc5b089aa39c69ee208baecce21e8bf138a7/src%2Ftest%2Fui%2Fconsts%2Fprecise-drop-with-promoted.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a656bc5b089aa39c69ee208baecce21e8bf138a7/src%2Ftest%2Fui%2Fconsts%2Fprecise-drop-with-promoted.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fprecise-drop-with-promoted.rs?ref=a656bc5b089aa39c69ee208baecce21e8bf138a7", "patch": "@@ -0,0 +1,9 @@\n+// Regression test for issue #89938.\n+// check-pass\n+// compile-flags: --crate-type=lib\n+#![feature(const_precise_live_drops)]\n+\n+pub const fn f() {\n+    let _: Option<String> = None;\n+    let _: &'static Option<String> = &None;\n+}"}]}