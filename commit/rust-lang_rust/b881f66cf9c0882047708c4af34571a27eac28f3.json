{"sha": "b881f66cf9c0882047708c4af34571a27eac28f3", "node_id": "C_kwDOAAsO6NoAKGI4ODFmNjZjZjljMDg4MjA0NzcwOGM0YWYzNDU3MWEyN2VhYzI4ZjM", "commit": {"author": {"name": "Thom Chiovoloni", "email": "thom@shift.click", "date": "2022-11-18T00:14:44Z"}, "committer": {"name": "Thom Chiovoloni", "email": "thom@shift.click", "date": "2022-11-18T00:14:44Z"}, "message": "Don't assume `FILE_ID_BOTH_DIR_INFO` will be aligned", "tree": {"sha": "e2f40d6bd31afd5532f9799f0d37708a5bb96265", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e2f40d6bd31afd5532f9799f0d37708a5bb96265"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b881f66cf9c0882047708c4af34571a27eac28f3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYKAB0WIQQszICQ1r0Zqrp7OLPXcz0dendfCgUCY3bOdAAKCRDXcz0dendf\nCs49AQDNx0F13Say7FKEmtMS5SC/a0XGjAlu+zIZsT3gjWZs9QEAt0LbS1+v/tPq\nXrgX0ZzQMXWgM6tMDAK//Fr8zxNcMw8=\n=t7LL\n-----END PGP SIGNATURE-----", "payload": "tree e2f40d6bd31afd5532f9799f0d37708a5bb96265\nparent 36db030a7c3c51cb4484cbd8c8daebcf5057d61c\nauthor Thom Chiovoloni <thom@shift.click> 1668730484 -0800\ncommitter Thom Chiovoloni <thom@shift.click> 1668730484 -0800\n\nDon't assume `FILE_ID_BOTH_DIR_INFO` will be aligned\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b881f66cf9c0882047708c4af34571a27eac28f3", "html_url": "https://github.com/rust-lang/rust/commit/b881f66cf9c0882047708c4af34571a27eac28f3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b881f66cf9c0882047708c4af34571a27eac28f3/comments", "author": {"login": "thomcc", "id": 860665, "node_id": "MDQ6VXNlcjg2MDY2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/860665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thomcc", "html_url": "https://github.com/thomcc", "followers_url": "https://api.github.com/users/thomcc/followers", "following_url": "https://api.github.com/users/thomcc/following{/other_user}", "gists_url": "https://api.github.com/users/thomcc/gists{/gist_id}", "starred_url": "https://api.github.com/users/thomcc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thomcc/subscriptions", "organizations_url": "https://api.github.com/users/thomcc/orgs", "repos_url": "https://api.github.com/users/thomcc/repos", "events_url": "https://api.github.com/users/thomcc/events{/privacy}", "received_events_url": "https://api.github.com/users/thomcc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "thomcc", "id": 860665, "node_id": "MDQ6VXNlcjg2MDY2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/860665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thomcc", "html_url": "https://github.com/thomcc", "followers_url": "https://api.github.com/users/thomcc/followers", "following_url": "https://api.github.com/users/thomcc/following{/other_user}", "gists_url": "https://api.github.com/users/thomcc/gists{/gist_id}", "starred_url": "https://api.github.com/users/thomcc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thomcc/subscriptions", "organizations_url": "https://api.github.com/users/thomcc/orgs", "repos_url": "https://api.github.com/users/thomcc/repos", "events_url": "https://api.github.com/users/thomcc/events{/privacy}", "received_events_url": "https://api.github.com/users/thomcc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "36db030a7c3c51cb4484cbd8c8daebcf5057d61c", "url": "https://api.github.com/repos/rust-lang/rust/commits/36db030a7c3c51cb4484cbd8c8daebcf5057d61c", "html_url": "https://github.com/rust-lang/rust/commit/36db030a7c3c51cb4484cbd8c8daebcf5057d61c"}], "stats": {"total": 14, "additions": 9, "deletions": 5}, "files": [{"sha": "cb569e5ba83997045da0ceffbfdfa44fb063c417", "filename": "library/std/src/sys/windows/fs.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/b881f66cf9c0882047708c4af34571a27eac28f3/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b881f66cf9c0882047708c4af34571a27eac28f3/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Ffs.rs?ref=b881f66cf9c0882047708c4af34571a27eac28f3", "patch": "@@ -734,15 +734,19 @@ impl<'a> Iterator for DirBuffIter<'a> {\n         //   `FileNameLength` bytes)\n         let (name, is_directory, next_entry) = unsafe {\n             let info = buffer.as_ptr().cast::<c::FILE_ID_BOTH_DIR_INFO>();\n-            // Guaranteed to be aligned in documentation for\n+            // While this is guaranteed to be aligned in documentation for\n             // https://docs.microsoft.com/en-us/windows/win32/api/winbase/ns-winbase-file_id_both_dir_info\n-            assert!(info.is_aligned());\n-            let next_entry = (*info).NextEntryOffset as usize;\n+            // it does not seem that reality is so kind, and assuming this\n+            // caused crashes in some cases (https://github.com/rust-lang/rust/issues/104530)\n+            // presumably, this can be blamed on buggy filesystem drivers, but who knows.\n+            let next_entry = ptr::addr_of!((*info).NextEntryOffset).read_unaligned() as usize;\n+            let length = ptr::addr_of!((*info).FileNameLength).read_unaligned() as usize;\n+            let attrs = ptr::addr_of!((*info).FileAttributes).read_unaligned();\n             let name = crate::slice::from_raw_parts(\n                 ptr::addr_of!((*info).FileName).cast::<u16>(),\n-                (*info).FileNameLength as usize / size_of::<u16>(),\n+                length / size_of::<u16>(),\n             );\n-            let is_directory = ((*info).FileAttributes & c::FILE_ATTRIBUTE_DIRECTORY) != 0;\n+            let is_directory = (attrs & c::FILE_ATTRIBUTE_DIRECTORY) != 0;\n \n             (name, is_directory, next_entry)\n         };"}]}