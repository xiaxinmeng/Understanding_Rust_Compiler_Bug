{"sha": "c130b83bae47777e8a9e1b4cb3d6249cf987c0d6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMxMzBiODNiYWU0Nzc3N2U4YTllMWI0Y2IzZDYyNDljZjk4N2MwZDY=", "commit": {"author": {"name": "Thomas Lively", "email": "tlively@google.com", "date": "2017-06-24T18:35:48Z"}, "committer": {"name": "Thomas Lively", "email": "tlively@google.com", "date": "2017-06-24T18:35:48Z"}, "message": "Restore old emscripten.sh for use by asmjs", "tree": {"sha": "62ee8cf383350a3beda5441c1c8ee792493001a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/62ee8cf383350a3beda5441c1c8ee792493001a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c130b83bae47777e8a9e1b4cb3d6249cf987c0d6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c130b83bae47777e8a9e1b4cb3d6249cf987c0d6", "html_url": "https://github.com/rust-lang/rust/commit/c130b83bae47777e8a9e1b4cb3d6249cf987c0d6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c130b83bae47777e8a9e1b4cb3d6249cf987c0d6/comments", "author": {"login": "tlively", "id": 7121787, "node_id": "MDQ6VXNlcjcxMjE3ODc=", "avatar_url": "https://avatars.githubusercontent.com/u/7121787?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tlively", "html_url": "https://github.com/tlively", "followers_url": "https://api.github.com/users/tlively/followers", "following_url": "https://api.github.com/users/tlively/following{/other_user}", "gists_url": "https://api.github.com/users/tlively/gists{/gist_id}", "starred_url": "https://api.github.com/users/tlively/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tlively/subscriptions", "organizations_url": "https://api.github.com/users/tlively/orgs", "repos_url": "https://api.github.com/users/tlively/repos", "events_url": "https://api.github.com/users/tlively/events{/privacy}", "received_events_url": "https://api.github.com/users/tlively/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tlively", "id": 7121787, "node_id": "MDQ6VXNlcjcxMjE3ODc=", "avatar_url": "https://avatars.githubusercontent.com/u/7121787?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tlively", "html_url": "https://github.com/tlively", "followers_url": "https://api.github.com/users/tlively/followers", "following_url": "https://api.github.com/users/tlively/following{/other_user}", "gists_url": "https://api.github.com/users/tlively/gists{/gist_id}", "starred_url": "https://api.github.com/users/tlively/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tlively/subscriptions", "organizations_url": "https://api.github.com/users/tlively/orgs", "repos_url": "https://api.github.com/users/tlively/repos", "events_url": "https://api.github.com/users/tlively/events{/privacy}", "received_events_url": "https://api.github.com/users/tlively/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4ad6a9586050762a3d7e4e9bfee2faa36fbf726f", "url": "https://api.github.com/repos/rust-lang/rust/commits/4ad6a9586050762a3d7e4e9bfee2faa36fbf726f", "html_url": "https://github.com/rust-lang/rust/commit/4ad6a9586050762a3d7e4e9bfee2faa36fbf726f"}], "stats": {"total": 99, "additions": 76, "deletions": 23}, "files": [{"sha": "c75b5d455c522b7662ece88cdb419c172d56d1f9", "filename": "src/ci/docker/disabled/wasm32/Dockerfile", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c130b83bae47777e8a9e1b4cb3d6249cf987c0d6/src%2Fci%2Fdocker%2Fdisabled%2Fwasm32%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/c130b83bae47777e8a9e1b4cb3d6249cf987c0d6/src%2Fci%2Fdocker%2Fdisabled%2Fwasm32%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdisabled%2Fwasm32%2FDockerfile?ref=c130b83bae47777e8a9e1b4cb3d6249cf987c0d6", "patch": "@@ -20,8 +20,8 @@ COPY scripts/dumb-init.sh /scripts/\n RUN sh /scripts/dumb-init.sh\n \n # emscripten\n-COPY scripts/emscripten.sh /scripts/\n-RUN bash /scripts/emscripten.sh\n+COPY scripts/emscripten-wasm.sh /scripts/\n+RUN bash /scripts/emscripten-wasm.sh\n COPY disabled/wasm32/node.sh /usr/local/bin/node\n \n # cache"}, {"sha": "e693f975f69bc374073315ddd796c1b9799f31bc", "filename": "src/ci/docker/scripts/emscripten-wasm.sh", "status": "added", "additions": 64, "deletions": 0, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/c130b83bae47777e8a9e1b4cb3d6249cf987c0d6/src%2Fci%2Fdocker%2Fscripts%2Femscripten-wasm.sh", "raw_url": "https://github.com/rust-lang/rust/raw/c130b83bae47777e8a9e1b4cb3d6249cf987c0d6/src%2Fci%2Fdocker%2Fscripts%2Femscripten-wasm.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Femscripten-wasm.sh?ref=c130b83bae47777e8a9e1b4cb3d6249cf987c0d6", "patch": "@@ -0,0 +1,64 @@\n+# Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+# file at the top-level directory of this distribution and at\n+# http://rust-lang.org/COPYRIGHT.\n+#\n+# Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+# http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+# <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+# option. This file may not be copied, modified, or distributed\n+# except according to those terms.\n+\n+set -ex\n+\n+hide_output() {\n+  set +x\n+  on_err=\"\n+echo ERROR: An error was encountered with the build.\n+cat /tmp/build.log\n+exit 1\n+\"\n+  trap \"$on_err\" ERR\n+  bash -c \"while true; do sleep 30; echo \\$(date) - building ...; done\" &\n+  PING_LOOP_PID=$!\n+  $@ &> /tmp/build.log\n+  trap - ERR\n+  kill $PING_LOOP_PID\n+  rm -f /tmp/build.log\n+  set -x\n+}\n+\n+# Download emsdk\n+cd /\n+curl -L https://s3.amazonaws.com/mozilla-games/emscripten/releases/emsdk-portable.tar.gz | \\\n+    tar -xz\n+\n+# Download last known good emscripten from WebAssembly waterfall\n+BUILD=$(curl -L https://storage.googleapis.com/wasm-llvm/builds/linux/lkgr.json | \\\n+    jq '.build | tonumber')\n+curl -L https://storage.googleapis.com/wasm-llvm/builds/linux/$BUILD/wasm-binaries.tbz2 | \\\n+    hide_output tar xvkj\n+\n+# node 8 is required to run wasm\n+cd /\n+curl -L https://nodejs.org/dist/v8.0.0/node-v8.0.0-linux-x64.tar.xz | \\\n+    tar -xJ\n+\n+cd /emsdk-portable\n+./emsdk update\n+hide_output ./emsdk install sdk-1.37.13-64bit\n+./emsdk activate sdk-1.37.13-64bit\n+\n+# Make emscripten use wasm-ready node and LLVM tools\n+echo \"NODE_JS='/node-v8.0.0-linux-x64/bin/node'\" >> /root/.emscripten\n+echo \"LLVM_ROOT='/wasm-install/bin'\" >> /root/.emscripten\n+\n+# Make emsdk usable by any user\n+cp /root/.emscripten /emsdk-portable\n+chmod a+rxw -R /emsdk-portable\n+\n+# Compile and cache libc\n+source ./emsdk_env.sh\n+echo \"main(){}\" > a.c\n+HOME=/emsdk-portable/ emcc a.c\n+HOME=/emsdk-portable/ emcc -s WASM=1 a.c\n+rm -f a.*"}, {"sha": "cf5eecbdb6c8c1e94a38789718d0894d2ff7eb01", "filename": "src/ci/docker/scripts/emscripten.sh", "status": "modified", "additions": 10, "deletions": 21, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/c130b83bae47777e8a9e1b4cb3d6249cf987c0d6/src%2Fci%2Fdocker%2Fscripts%2Femscripten.sh", "raw_url": "https://github.com/rust-lang/rust/raw/c130b83bae47777e8a9e1b4cb3d6249cf987c0d6/src%2Fci%2Fdocker%2Fscripts%2Femscripten.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Femscripten.sh?ref=c130b83bae47777e8a9e1b4cb3d6249cf987c0d6", "patch": "@@ -27,38 +27,27 @@ exit 1\n   set -x\n }\n \n-# Download emsdk\n cd /\n curl -L https://s3.amazonaws.com/mozilla-games/emscripten/releases/emsdk-portable.tar.gz | \\\n     tar -xz\n \n-# Download last known good emscripten from WebAssembly waterfall\n-BUILD=$(curl -L https://storage.googleapis.com/wasm-llvm/builds/linux/lkgr.json | \\\n-    jq '.build | tonumber')\n-curl -L https://storage.googleapis.com/wasm-llvm/builds/linux/$BUILD/wasm-binaries.tbz2 | \\\n-    hide_output tar xvkj\n-\n-# node 8 is required to run wasm\n-cd /\n-curl -L https://nodejs.org/dist/v8.0.0/node-v8.0.0-linux-x64.tar.xz | \\\n-    tar -xJ\n-\n cd /emsdk-portable\n ./emsdk update\n hide_output ./emsdk install sdk-1.37.13-64bit\n ./emsdk activate sdk-1.37.13-64bit\n \n-# Make emscripten use wasm-ready node and LLVM tools\n-echo \"NODE_JS='/node-v8.0.0-linux-x64/bin/node'\" >> /root/.emscripten\n-echo \"LLVM_ROOT='/wasm-install/bin'\" >> /root/.emscripten\n-\n-# Make emsdk usable by any user\n-cp /root/.emscripten /emsdk-portable\n-chmod a+rxw -R /emsdk-portable\n-\n # Compile and cache libc\n source ./emsdk_env.sh\n echo \"main(){}\" > a.c\n HOME=/emsdk-portable/ emcc a.c\n-HOME=/emsdk-portable/ emcc -s WASM=1 a.c\n+HOME=/emsdk-portable/ emcc -s BINARYEN=1 a.c\n rm -f a.*\n+\n+# Make emsdk usable by any user\n+cp /root/.emscripten /emsdk-portable\n+chmod a+rxw -R /emsdk-portable\n+\n+# node 8 is required to run wasm\n+cd /\n+curl -L https://nodejs.org/dist/v8.0.0/node-v8.0.0-linux-x64.tar.xz | \\\n+  tar -xJ"}]}