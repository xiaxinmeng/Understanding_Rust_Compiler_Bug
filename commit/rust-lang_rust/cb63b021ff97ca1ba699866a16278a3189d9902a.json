{"sha": "cb63b021ff97ca1ba699866a16278a3189d9902a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNiNjNiMDIxZmY5N2NhMWJhNjk5ODY2YTE2Mjc4YTMxODlkOTkwMmE=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-07-07T20:50:20Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-07-07T20:50:20Z"}, "message": "Implement LUB coercion of array elements", "tree": {"sha": "a161b4eb07bbefc6982c23a41bb47bc9df0c5aaa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a161b4eb07bbefc6982c23a41bb47bc9df0c5aaa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cb63b021ff97ca1ba699866a16278a3189d9902a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cb63b021ff97ca1ba699866a16278a3189d9902a", "html_url": "https://github.com/rust-lang/rust/commit/cb63b021ff97ca1ba699866a16278a3189d9902a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cb63b021ff97ca1ba699866a16278a3189d9902a/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f5a100e5fd753580a6b909f0d45198f0c5593c41", "url": "https://api.github.com/repos/rust-lang/rust/commits/f5a100e5fd753580a6b909f0d45198f0c5593c41", "html_url": "https://github.com/rust-lang/rust/commit/f5a100e5fd753580a6b909f0d45198f0c5593c41"}], "stats": {"total": 36, "additions": 25, "deletions": 11}, "files": [{"sha": "12e0b04131614e4bc40e3411feaa7f9770488450", "filename": "crates/hir_ty/src/infer/expr.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/cb63b021ff97ca1ba699866a16278a3189d9902a/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb63b021ff97ca1ba699866a16278a3189d9902a/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs?ref=cb63b021ff97ca1ba699866a16278a3189d9902a", "patch": "@@ -729,7 +729,7 @@ impl<'a> InferenceContext<'a> {\n                 TyKind::Tuple(tys.len(), Substitution::from_iter(&Interner, tys)).intern(&Interner)\n             }\n             Expr::Array(array) => {\n-                let elem_ty =\n+                let mut elem_ty =\n                     match expected.to_option(&mut self.table).as_ref().map(|t| t.kind(&Interner)) {\n                         Some(TyKind::Array(st, _) | TyKind::Slice(st)) => st.clone(),\n                         _ => self.table.new_type_var(),\n@@ -738,8 +738,8 @@ impl<'a> InferenceContext<'a> {\n                 let len = match array {\n                     Array::ElementList(items) => {\n                         for expr in items.iter() {\n-                            // FIXME: use CoerceMany (coerce_merge_branch)\n-                            self.infer_expr_coerce(*expr, &Expectation::has_type(elem_ty.clone()));\n+                            let cur_elem_ty = self.infer_expr_inner(*expr, expected);\n+                            elem_ty = self.coerce_merge_branch(Some(*expr), &elem_ty, &cur_elem_ty);\n                         }\n                         Some(items.len() as u64)\n                     }"}, {"sha": "6c57bf697d81de3d77140b2535e5dd419fae5b11", "filename": "crates/hir_ty/src/tests/coercion.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/cb63b021ff97ca1ba699866a16278a3189d9902a/crates%2Fhir_ty%2Fsrc%2Ftests%2Fcoercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb63b021ff97ca1ba699866a16278a3189d9902a/crates%2Fhir_ty%2Fsrc%2Ftests%2Fcoercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Fcoercion.rs?ref=cb63b021ff97ca1ba699866a16278a3189d9902a", "patch": "@@ -507,3 +507,17 @@ fn main() {\n         \"#,\n     );\n }\n+\n+#[test]\n+fn coerce_array_elems_lub() {\n+    check_no_mismatches(\n+        r#\"\n+fn f() {}\n+fn g() {}\n+\n+fn test() {\n+    [f, g];\n+}\n+        \"#,\n+    );\n+}"}, {"sha": "d80375f02fd7335655afcab9928741217c722d2b", "filename": "crates/hir_ty/src/tests/regression.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/cb63b021ff97ca1ba699866a16278a3189d9902a/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb63b021ff97ca1ba699866a16278a3189d9902a/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs?ref=cb63b021ff97ca1ba699866a16278a3189d9902a", "patch": "@@ -117,19 +117,19 @@ fn recursive_vars_2() {\n         \"#,\n         expect![[r#\"\n             10..79 '{     ...x)]; }': ()\n-            20..21 'x': &{unknown}\n-            24..31 'unknown': &{unknown}\n+            20..21 'x': {unknown}\n+            24..31 'unknown': {unknown}\n             41..42 'y': {unknown}\n             45..52 'unknown': {unknown}\n-            58..76 '[(x, y..., &x)]': [(&{unknown}, {unknown}); 2]\n-            59..65 '(x, y)': (&{unknown}, {unknown})\n-            60..61 'x': &{unknown}\n+            58..76 '[(x, y..., &x)]': [({unknown}, {unknown}); 2]\n+            59..65 '(x, y)': ({unknown}, {unknown})\n+            60..61 'x': {unknown}\n             63..64 'y': {unknown}\n-            67..75 '(&y, &x)': (&{unknown}, {unknown})\n+            67..75 '(&y, &x)': (&{unknown}, &{unknown})\n             68..70 '&y': &{unknown}\n             69..70 'y': {unknown}\n-            72..74 '&x': &&{unknown}\n-            73..74 'x': &{unknown}\n+            72..74 '&x': &{unknown}\n+            73..74 'x': {unknown}\n         \"#]],\n     );\n }"}]}