{"sha": "463301aa5a369609d598d2c66902c47a3b1efb51", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ2MzMwMWFhNWEzNjk2MDlkNTk4ZDJjNjY5MDJjNDdhM2IxZWZiNTE=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-07-08T01:44:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-08T01:44:34Z"}, "message": "Rollup merge of #86932 - rylev:fix-ice-86895, r=estebank\n\nFix ICE when misplaced visibility cannot be properly parsed\n\nFixes #86895\n\nThe issue was that a failure to parse the visibility was causing the original error to be dropped before being emitted.\n\nThe resulting error isn't quite as nice as when the visibility is parsed properly, but I'm not sure which error to prioritize here. Displaying both errors might be too confusing.\n\nr? ```@estebank```", "tree": {"sha": "84731637e3c3919de60845c7def7f7b69885d3fc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/84731637e3c3919de60845c7def7f7b69885d3fc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/463301aa5a369609d598d2c66902c47a3b1efb51", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg5liCCRBK7hj4Ov3rIwAAEcwIAJ3JwUpUKpycly+MUib2qQaA\npOOLGYT5j3pFYGKBohOALQFmdOC7+pfiJyJ/HPE10ce/gT5W9MiBUNnfEKoKOG2L\nWqKAsyqGHiBtivblMJrMNE+s6zzh3LOuDGBBKbOvUqZ5GOncx463bNQ4JXF7z6WC\nU7Lf7GcKoy0Dtk2tKXk3DS4U2GRG3V3XLPiqGYUlkEKYS6jvtTUHM///6S1aUxXr\nxdVIAktqrOqKLnyucbEpbzPyjej+T8ft5dNa5wsDwKF55Y40dz2XRL4SZcc/o/Iq\nKD7mRUjWagfWSD+RP2o+K2QTZeh4F+e6PQCYF75szF64Wk90Ha6VcpJk0g+1/HI=\n=EiU4\n-----END PGP SIGNATURE-----\n", "payload": "tree 84731637e3c3919de60845c7def7f7b69885d3fc\nparent 89638a1ddc07a1da91b293a0e359557bf061c12f\nparent 04a9c10fc27fcf7c4a4415401c7653a361177631\nauthor Yuki Okushi <jtitor@2k36.org> 1625708674 +0900\ncommitter GitHub <noreply@github.com> 1625708674 +0900\n\nRollup merge of #86932 - rylev:fix-ice-86895, r=estebank\n\nFix ICE when misplaced visibility cannot be properly parsed\n\nFixes #86895\n\nThe issue was that a failure to parse the visibility was causing the original error to be dropped before being emitted.\n\nThe resulting error isn't quite as nice as when the visibility is parsed properly, but I'm not sure which error to prioritize here. Displaying both errors might be too confusing.\n\nr? ```@estebank```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/463301aa5a369609d598d2c66902c47a3b1efb51", "html_url": "https://github.com/rust-lang/rust/commit/463301aa5a369609d598d2c66902c47a3b1efb51", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/463301aa5a369609d598d2c66902c47a3b1efb51/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "89638a1ddc07a1da91b293a0e359557bf061c12f", "url": "https://api.github.com/repos/rust-lang/rust/commits/89638a1ddc07a1da91b293a0e359557bf061c12f", "html_url": "https://github.com/rust-lang/rust/commit/89638a1ddc07a1da91b293a0e359557bf061c12f"}, {"sha": "04a9c10fc27fcf7c4a4415401c7653a361177631", "url": "https://api.github.com/repos/rust-lang/rust/commits/04a9c10fc27fcf7c4a4415401c7653a361177631", "html_url": "https://github.com/rust-lang/rust/commit/04a9c10fc27fcf7c4a4415401c7653a361177631"}], "stats": {"total": 19, "additions": 18, "deletions": 1}, "files": [{"sha": "2ce63d011f438b07467fa8726c55e02610e55e90", "filename": "compiler/rustc_parse/src/parser/item.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/463301aa5a369609d598d2c66902c47a3b1efb51/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/463301aa5a369609d598d2c66902c47a3b1efb51/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs?ref=463301aa5a369609d598d2c66902c47a3b1efb51", "patch": "@@ -1791,7 +1791,13 @@ impl<'a> Parser<'a> {\n                     if self.check_keyword(kw::Pub) {\n                         let sp = sp_start.to(self.prev_token.span);\n                         if let Ok(snippet) = self.span_to_snippet(sp) {\n-                            let vis = self.parse_visibility(FollowedByType::No)?;\n+                            let vis = match self.parse_visibility(FollowedByType::No) {\n+                                Ok(v) => v,\n+                                Err(mut d) => {\n+                                    d.cancel();\n+                                    return Err(err);\n+                                }\n+                            };\n                             let vs = pprust::vis_to_string(&vis);\n                             let vs = vs.trim_end();\n                             err.span_suggestion("}, {"sha": "4cd09843107dd8c6066bab733f46ffb1fdfce276", "filename": "src/test/ui/parser/issue-86895.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/463301aa5a369609d598d2c66902c47a3b1efb51/src%2Ftest%2Fui%2Fparser%2Fissue-86895.rs", "raw_url": "https://github.com/rust-lang/rust/raw/463301aa5a369609d598d2c66902c47a3b1efb51/src%2Ftest%2Fui%2Fparser%2Fissue-86895.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fissue-86895.rs?ref=463301aa5a369609d598d2c66902c47a3b1efb51", "patch": "@@ -0,0 +1,3 @@\n+const pub () {}\n+//~^ ERROR expected one of `async`, `extern`, `fn`, or `unsafe`\n+pub fn main() {}"}, {"sha": "575d857c0ed4f441f2d9bf2a2f70d92510780888", "filename": "src/test/ui/parser/issue-86895.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/463301aa5a369609d598d2c66902c47a3b1efb51/src%2Ftest%2Fui%2Fparser%2Fissue-86895.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/463301aa5a369609d598d2c66902c47a3b1efb51/src%2Ftest%2Fui%2Fparser%2Fissue-86895.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fissue-86895.stderr?ref=463301aa5a369609d598d2c66902c47a3b1efb51", "patch": "@@ -0,0 +1,8 @@\n+error: expected one of `async`, `extern`, `fn`, or `unsafe`, found keyword `pub`\n+  --> $DIR/issue-86895.rs:1:7\n+   |\n+LL | const pub () {}\n+   |       ^^^ expected one of `async`, `extern`, `fn`, or `unsafe`\n+\n+error: aborting due to previous error\n+"}]}