{"sha": "33e6df4b62237af312bf6e3f40a97f5bdc94949a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMzZTZkZjRiNjIyMzdhZjMxMmJmNmUzZjQwYTk3ZjViZGM5NDk0OWE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-15T04:06:25Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-15T04:06:25Z"}, "message": "Auto merge of #57130 - VardhanThigle:Vardhan/x86_64-fortanix-unknown-sgx-tier2_support, r=alexcrichton\n\nUpgrade x86_64-fortanix-unknown-sgx platform support to tier 2\n\n## Overview\n1. This PR upgrades x86_64-fortanix-unknown-sgx platform support to tier 2 (std only) by setting up build automation for this target.\n1. For supporting unwinding, this target needs to link to a port of LLVM's libunwind (more details could be found in #56979), which will be distributed along with the Rust binaries (similar to the extra musl objects)\n\n### Building and copying libunwind:\nWe have added a new build script  (`build-x86_64-fortanix-unknown-sgx-toolchain.sh`) that will run while the container is built. This will build `libunwind.a` from git source.\nWhile the container is built, the persistent volumes where obj/ gets created aren't yet mapped. As a workaround, we copy the built `libunwind.a` to  `obj/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-fortanix-unknown-sgx/lib/` after x.py runs.\n If any reviewer knows of a better solution, please do tell.\n\nr? @Mark-Simulacrum", "tree": {"sha": "a8cd44217ba1afaaa007bbc38b9e77e9632202b5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a8cd44217ba1afaaa007bbc38b9e77e9632202b5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/33e6df4b62237af312bf6e3f40a97f5bdc94949a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/33e6df4b62237af312bf6e3f40a97f5bdc94949a", "html_url": "https://github.com/rust-lang/rust/commit/33e6df4b62237af312bf6e3f40a97f5bdc94949a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/33e6df4b62237af312bf6e3f40a97f5bdc94949a/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aea9f0aa976db2f5de28be3b6b287c6889cd926b", "url": "https://api.github.com/repos/rust-lang/rust/commits/aea9f0aa976db2f5de28be3b6b287c6889cd926b", "html_url": "https://github.com/rust-lang/rust/commit/aea9f0aa976db2f5de28be3b6b287c6889cd926b"}, {"sha": "99fbd1bf110c1e62c0c22a0e2232bec4bf9fdd89", "url": "https://api.github.com/repos/rust-lang/rust/commits/99fbd1bf110c1e62c0c22a0e2232bec4bf9fdd89", "html_url": "https://github.com/rust-lang/rust/commit/99fbd1bf110c1e62c0c22a0e2232bec4bf9fdd89"}], "stats": {"total": 154, "additions": 134, "deletions": 20}, "files": [{"sha": "b581271663e7ed27d4afc02d1f2d07283263dd01", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 33, "deletions": 20, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=33e6df4b62237af312bf6e3f40a97f5bdc94949a", "patch": "@@ -78,11 +78,8 @@ impl Step for Std {\n             builder.info(&format!(\"Uplifting stage1 std ({} -> {})\", from.host, target));\n \n             // Even if we're not building std this stage, the new sysroot must\n-            // still contain the musl startup objects.\n-            if target.contains(\"musl\") {\n-                let libdir = builder.sysroot_libdir(compiler, target);\n-                copy_musl_third_party_objects(builder, target, &libdir);\n-            }\n+            // still contain the third party objects needed by various targets.\n+            copy_third_party_objects(builder, &compiler, target);\n \n             builder.ensure(StdLink {\n                 compiler: from,\n@@ -92,10 +89,7 @@ impl Step for Std {\n             return;\n         }\n \n-        if target.contains(\"musl\") {\n-            let libdir = builder.sysroot_libdir(compiler, target);\n-            copy_musl_third_party_objects(builder, target, &libdir);\n-        }\n+        copy_third_party_objects(builder, &compiler, target);\n \n         let mut cargo = builder.cargo(compiler, Mode::Std, target, \"build\");\n         std_cargo(builder, &compiler, target, &mut cargo);\n@@ -116,17 +110,36 @@ impl Step for Std {\n     }\n }\n \n-/// Copies the crt(1,i,n).o startup objects\n-///\n-/// Since musl supports fully static linking, we can cross link for it even\n-/// with a glibc-targeting toolchain, given we have the appropriate startup\n-/// files. As those shipped with glibc won't work, copy the ones provided by\n-/// musl so we have them on linux-gnu hosts.\n-fn copy_musl_third_party_objects(builder: &Builder,\n-                                 target: Interned<String>,\n-                                 into: &Path) {\n-    for &obj in &[\"crt1.o\", \"crti.o\", \"crtn.o\"] {\n-        builder.copy(&builder.musl_root(target).unwrap().join(\"lib\").join(obj), &into.join(obj));\n+/// Copies third pary objects needed by various targets.\n+fn copy_third_party_objects(builder: &Builder, compiler: &Compiler, target: Interned<String>) {\n+    let libdir = builder.sysroot_libdir(*compiler, target);\n+\n+    // Copies the crt(1,i,n).o startup objects\n+    //\n+    // Since musl supports fully static linking, we can cross link for it even\n+    // with a glibc-targeting toolchain, given we have the appropriate startup\n+    // files. As those shipped with glibc won't work, copy the ones provided by\n+    // musl so we have them on linux-gnu hosts.\n+    if target.contains(\"musl\") {\n+        for &obj in &[\"crt1.o\", \"crti.o\", \"crtn.o\"] {\n+            builder.copy(\n+                &builder.musl_root(target).unwrap().join(\"lib\").join(obj),\n+                &libdir.join(obj),\n+            );\n+        }\n+    }\n+\n+    // Copies libunwind.a compiled to be linked wit x86_64-fortanix-unknown-sgx.\n+    //\n+    // This target needs to be linked to Fortanix's port of llvm's libunwind.\n+    // libunwind requires support for rwlock and printing to stderr,\n+    // which is provided by std for this target.\n+    if target == \"x86_64-fortanix-unknown-sgx\" {\n+        let src_path_env = \"X86_FORTANIX_SGX_LIBS\";\n+        let obj = \"libunwind.a\";\n+        let src = env::var(src_path_env).expect(&format!(\"{} not found in env\", src_path_env));\n+        let src = Path::new(&src).join(obj);\n+        builder.copy(&src, &libdir.join(obj));\n     }\n }\n "}, {"sha": "906255533ad29355dfc44cb6fb624dbee123a546", "filename": "src/ci/docker/dist-various-2/Dockerfile", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile?ref=33e6df4b62237af312bf6e3f40a97f5bdc94949a", "patch": "@@ -29,6 +29,10 @@ RUN /tmp/build-fuchsia-toolchain.sh\n COPY dist-various-2/build-solaris-toolchain.sh /tmp/\n RUN /tmp/build-solaris-toolchain.sh x86_64  amd64   solaris-i386\n RUN /tmp/build-solaris-toolchain.sh sparcv9 sparcv9 solaris-sparc\n+COPY dist-various-2/build-x86_64-fortanix-unknown-sgx-toolchain.sh /tmp/\n+# We pass the commit id of the port of LLVM's libunwind to the build script.\n+# Any update to the commit id here, should cause the container image to be re-built from this point on.\n+RUN /tmp/build-x86_64-fortanix-unknown-sgx-toolchain.sh \"bbe23902411be88d7388f381becefadd6e3ef819\"\n \n COPY scripts/sccache.sh /scripts/\n RUN sh /scripts/sccache.sh\n@@ -65,6 +69,9 @@ ENV TARGETS=$TARGETS,wasm32-unknown-unknown\n ENV TARGETS=$TARGETS,x86_64-sun-solaris\n ENV TARGETS=$TARGETS,x86_64-unknown-linux-gnux32\n ENV TARGETS=$TARGETS,x86_64-unknown-cloudabi\n+ENV TARGETS=$TARGETS,x86_64-fortanix-unknown-sgx\n+\n+ENV X86_FORTANIX_SGX_LIBS=\"/x86_64-fortanix-unknown-sgx/lib/\"\n \n ENV RUST_CONFIGURE_ARGS --enable-extended --enable-lld --disable-docs\n ENV SCRIPT python2.7 ../x.py dist --target $TARGETS"}, {"sha": "76921316df2cc625c0d6e193f694bffde09ea100", "filename": "src/ci/docker/dist-various-2/build-x86_64-fortanix-unknown-sgx-toolchain.sh", "status": "added", "additions": 57, "deletions": 0, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-x86_64-fortanix-unknown-sgx-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-x86_64-fortanix-unknown-sgx-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-x86_64-fortanix-unknown-sgx-toolchain.sh?ref=33e6df4b62237af312bf6e3f40a97f5bdc94949a", "patch": "@@ -0,0 +1,57 @@\n+#!/bin/bash\n+\n+set -eu\n+source shared.sh\n+\n+if [ -z \"$1\" ]; then\n+    echo \"Usage: ${0} <commit_id>\"\n+    exit -1\n+fi\n+\n+target=\"x86_64-fortanix-unknown-sgx\"\n+url=\"https://github.com/fortanix/llvm-project/archive/${1}.tar.gz\"\n+repo_name=\"llvm-project\"\n+\n+install_prereq()\n+{\n+    apt-get update\n+    apt-get install -y --no-install-recommends \\\n+            build-essential \\\n+            ca-certificates \\\n+            cmake \\\n+            git\n+}\n+\n+# Clone Fortanix's port of llvm-project to build libunwind that would link with this target.\n+# The below method to download a single commit from llvm-project is based on fetch_submodule\n+# from init_repo.sh\n+fetch_llvm_commit()\n+{\n+    cached=\"download-${repo_name}.tar.gz\"\n+    curl -f -sSL -o ${cached} ${url}\n+    tar -xvzf ${cached}\n+    mkdir \"./${repo_name}\" && tar -xf ${cached} -C ${repo_name} --strip-components 1\n+}\n+\n+build_unwind()\n+{\n+    dir_name=\"${target}_temp\"\n+    rm -rf \"./${dir_name}\"\n+    mkdir -p ${dir_name}\n+    cd ${dir_name}\n+\n+    retry fetch_llvm_commit\n+    cd \"${repo_name}/libunwind\"\n+\n+    # Build libunwind\n+    mkdir -p build\n+    cd build\n+    cmake -DCMAKE_BUILD_TYPE=\"RELEASE\" -DRUST_SGX=1 -G \"Unix Makefiles\" -DLLVM_PATH=../../llvm/ ../\n+    make unwind_static\n+    install -D \"lib/libunwind.a\" \"/${target}/lib/libunwind.a\"\n+    rm -rf ${dir_name}\n+}\n+\n+set -x\n+hide_output install_prereq\n+hide_output build_unwind"}, {"sha": "fb917b0510e40261f28ac8ad3e7efa5a71694700", "filename": "src/ci/docker/dist-various-2/shared.sh", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Fci%2Fdocker%2Fdist-various-2%2Fshared.sh", "raw_url": "https://github.com/rust-lang/rust/raw/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Fci%2Fdocker%2Fdist-various-2%2Fshared.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-2%2Fshared.sh?ref=33e6df4b62237af312bf6e3f40a97f5bdc94949a", "patch": "@@ -13,3 +13,21 @@ exit 1\n   kill $PING_LOOP_PID\n   set -x\n }\n+\n+function retry {\n+  echo \"Attempting with retry:\" \"$@\"\n+  local n=1\n+  local max=5\n+  while true; do\n+    \"$@\" && break || {\n+      if [[ $n -lt $max ]]; then\n+        sleep $n  # don't retry immediately\n+        ((n++))\n+        echo \"Command failed. Attempt $n/$max:\"\n+      else\n+        echo \"The command has failed after $n attempts.\"\n+        return 1\n+      fi\n+    }\n+  done\n+}"}, {"sha": "ac7f95d4eae80fc587edbc548a21f18a66707f04", "filename": "src/libstd/sys/sgx/abi/entry.S", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Flibstd%2Fsys%2Fsgx%2Fabi%2Fentry.S", "raw_url": "https://github.com/rust-lang/rust/raw/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Flibstd%2Fsys%2Fsgx%2Fabi%2Fentry.S", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fsgx%2Fabi%2Fentry.S?ref=33e6df4b62237af312bf6e3f40a97f5bdc94949a", "patch": "@@ -4,6 +4,16 @@\n .global IMAGE_BASE\n IMAGE_BASE:\n \n+.section \".note.x86_64-fortanix-unknown-sgx\", \"\", @note\n+    .align 4\n+    .long 1f - 0f              /* name length (not including padding) */\n+    .long 3f - 2f              /* desc length (not including padding) */\n+    .long 1                    /* type = NT_VERSION */\n+0:  .asciz \"toolchain-version\" /* name */\n+1:  .align 4\n+2:  .long 0                    /* desc - toolchain version number, 32-bit LE */\n+3:  .align 4\n+\n .section .rodata\n /*  The XSAVE area needs to be a large chunk of readable memory, but since we are */\n /*  going to restore everything to its initial state (XSTATE_BV=0), only certain */"}, {"sha": "407fe72b0e62354b8a9af49c93cbb7a0f51a1024", "filename": "src/libstd/sys/sgx/time.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Flibstd%2Fsys%2Fsgx%2Ftime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Flibstd%2Fsys%2Fsgx%2Ftime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fsgx%2Ftime.rs?ref=33e6df4b62237af312bf6e3f40a97f5bdc94949a", "patch": "@@ -25,6 +25,14 @@ impl Instant {\n     pub fn checked_sub_duration(&self, other: &Duration) -> Option<Instant> {\n         Some(Instant(self.0.checked_sub(*other)?))\n     }\n+\n+    pub fn actually_monotonic() -> bool {\n+        false\n+    }\n+\n+    pub const fn zero() -> Instant {\n+        Instant(Duration::from_secs(0))\n+    }\n }\n \n impl SystemTime {"}, {"sha": "51c00a1433e76a78181d7d6199be7cf22531cad0", "filename": "src/libstd/sys/sgx/waitqueue.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Flibstd%2Fsys%2Fsgx%2Fwaitqueue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/33e6df4b62237af312bf6e3f40a97f5bdc94949a/src%2Flibstd%2Fsys%2Fsgx%2Fwaitqueue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fsgx%2Fwaitqueue.rs?ref=33e6df4b62237af312bf6e3f40a97f5bdc94949a", "patch": "@@ -456,6 +456,7 @@ mod spin_mutex {\n         }\n     }\n \n+    /// Lock the Mutex or return false.\n     pub macro try_lock_or_false {\n         ($e:expr) => {\n             if let Some(v) = $e.try_lock() {"}]}