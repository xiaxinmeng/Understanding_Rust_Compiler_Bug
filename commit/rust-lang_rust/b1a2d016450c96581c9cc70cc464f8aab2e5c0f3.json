{"sha": "b1a2d016450c96581c9cc70cc464f8aab2e5c0f3", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIxYTJkMDE2NDUwYzk2NTgxYzljYzcwY2M0NjRmOGFhYjJlNWMwZjM=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-06-30T21:17:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-30T21:17:54Z"}, "message": "Merge #5142\n\n5142: analysis-stats: allow parallel type inference r=matklad a=jonas-schievink\n\nThis is mostly just for testing/fun, but it looks like type inference can be sped up massively with little to no effort (since it runs after the serial phases are already done).\r\n\r\nWithout `--parallel`:\r\n\r\n```\r\nItem Collection: 16.43597698s, 683mb allocated 720mb resident\r\nInference: 25.429774879s, 1720mb allocated 1781mb resident\r\nTotal: 41.865866352s, 1720mb allocated 1781mb resident\r\n```\r\n\r\nWith `--parallel`:\r\n\r\n```\r\nItem Collection: 16.380369815s, 683mb allocated 735mb resident\r\nParallel Inference: 7.449166445s, 1721mb allocated 1812mb resident\r\nInference: 143.437157ms, 1721mb allocated 1812mb resident\r\nTotal: 23.973303611s, 1721mb allocated 1812mb resident\r\n```\n\nCo-authored-by: Jonas Schievink <jonas.schievink@ferrous-systems.com>", "tree": {"sha": "82ef9f21262870147c3377daff9ed8de16a1e9c9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/82ef9f21262870147c3377daff9ed8de16a1e9c9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe+6wCCRBK7hj4Ov3rIwAAdHIIAAwZarj0xzlcmQDseq9DRhHG\nOpCbyOCuOsZzUmO/VVXeB91QWpmXJGwrKJrQjvZmXqAHpoI/l0fbhQVa+doMoeIE\nBb2m+C9UjJqGnKTEI6Dgx/9fJMS+/dEyzjMKz291opTwVR/mJFm/FshVC5sKMZLd\nTzo4xGqpDSfShlvvoDtKSDSUxU2y8DYnDvxXNN48Okag7qaNr7IG9RXhdowdT8Gv\nLEfUT5OYYkQYl4JMa8t+s6QXnFS004uC6ApX9keEVCxHGhcZQiW/yo9RjrDW3an+\n3iusT2Igall8GrswO72mn5ik3IhtXhr1RcDhVj+fZwcOP87rRswZaX/ZLkbeXCo=\n=Z+b/\n-----END PGP SIGNATURE-----\n", "payload": "tree 82ef9f21262870147c3377daff9ed8de16a1e9c9\nparent c78180c318156d02e0b9454da67438ee96ad476d\nparent 4602c2eeaaeaf997d0f665d6064c469af53687ca\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1593551874 +0000\ncommitter GitHub <noreply@github.com> 1593551874 +0000\n\nMerge #5142\n\n5142: analysis-stats: allow parallel type inference r=matklad a=jonas-schievink\n\nThis is mostly just for testing/fun, but it looks like type inference can be sped up massively with little to no effort (since it runs after the serial phases are already done).\r\n\r\nWithout `--parallel`:\r\n\r\n```\r\nItem Collection: 16.43597698s, 683mb allocated 720mb resident\r\nInference: 25.429774879s, 1720mb allocated 1781mb resident\r\nTotal: 41.865866352s, 1720mb allocated 1781mb resident\r\n```\r\n\r\nWith `--parallel`:\r\n\r\n```\r\nItem Collection: 16.380369815s, 683mb allocated 735mb resident\r\nParallel Inference: 7.449166445s, 1721mb allocated 1812mb resident\r\nInference: 143.437157ms, 1721mb allocated 1812mb resident\r\nTotal: 23.973303611s, 1721mb allocated 1812mb resident\r\n```\n\nCo-authored-by: Jonas Schievink <jonas.schievink@ferrous-systems.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3", "html_url": "https://github.com/rust-lang/rust/commit/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c78180c318156d02e0b9454da67438ee96ad476d", "url": "https://api.github.com/repos/rust-lang/rust/commits/c78180c318156d02e0b9454da67438ee96ad476d", "html_url": "https://github.com/rust-lang/rust/commit/c78180c318156d02e0b9454da67438ee96ad476d"}, {"sha": "4602c2eeaaeaf997d0f665d6064c469af53687ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/4602c2eeaaeaf997d0f665d6064c469af53687ca", "html_url": "https://github.com/rust-lang/rust/commit/4602c2eeaaeaf997d0f665d6064c469af53687ca"}], "stats": {"total": 48, "additions": 43, "deletions": 5}, "files": [{"sha": "e1d2475e226dd556a3976cf367a661739b119386", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=b1a2d016450c96581c9cc70cc464f8aab2e5c0f3", "patch": "@@ -1461,6 +1461,7 @@ dependencies = [\n  \"ra_toolchain\",\n  \"ra_tt\",\n  \"rand\",\n+ \"rayon\",\n  \"rustc-hash\",\n  \"serde\",\n  \"serde_json\","}, {"sha": "837b6714d503168f41db28c1ae1e6b3cf44b4a03", "filename": "crates/rust-analyzer/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3/crates%2Frust-analyzer%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3/crates%2Frust-analyzer%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2FCargo.toml?ref=b1a2d016450c96581c9cc70cc464f8aab2e5c0f3", "patch": "@@ -28,6 +28,7 @@ rustc-hash = \"1.1.0\"\n serde = { version = \"1.0.106\", features = [\"derive\"] }\n serde_json = \"1.0.48\"\n threadpool = \"1.7.1\"\n+rayon = \"1.3.1\"\n \n stdx = { path = \"../stdx\" }\n "}, {"sha": "8a0b101174998f4a6355014f37ceb46cfc76653d", "filename": "crates/rust-analyzer/src/bin/args.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fargs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fargs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fargs.rs?ref=b1a2d016450c96581c9cc70cc464f8aab2e5c0f3", "patch": "@@ -25,6 +25,7 @@ pub(crate) enum Command {\n     },\n     Stats {\n         randomize: bool,\n+        parallel: bool,\n         memory_usage: bool,\n         only: Option<String>,\n         with_deps: bool,\n@@ -157,10 +158,14 @@ USAGE:\n     rust-analyzer analysis-stats [FLAGS] [OPTIONS] [PATH]\n \n FLAGS:\n+    -o, --only              Only analyze items matching this path\n     -h, --help              Prints help information\n-        --memory-usage\n+        --memory-usage      Collect memory usage statistics (requires `--feature jemalloc`)\n+        --randomize         Randomize order in which crates, modules, and items are processed\n+        --parallel          Run type inference in parallel\n         --load-output-dirs  Load OUT_DIR values by running `cargo check` before analysis\n-        --with-proc-macro    Use ra-proc-macro-srv for proc-macro expanding\n+        --with-proc-macro   Use ra-proc-macro-srv for proc-macro expanding\n+        --with-deps         Also analyze all dependencies\n     -v, --verbose\n     -q, --quiet\n \n@@ -174,6 +179,7 @@ ARGS:\n                 }\n \n                 let randomize = matches.contains(\"--randomize\");\n+                let parallel = matches.contains(\"--parallel\");\n                 let memory_usage = matches.contains(\"--memory-usage\");\n                 let only: Option<String> = matches.opt_value_from_str([\"-o\", \"--only\"])?;\n                 let with_deps: bool = matches.contains(\"--with-deps\");\n@@ -189,6 +195,7 @@ ARGS:\n \n                 Command::Stats {\n                     randomize,\n+                    parallel,\n                     memory_usage,\n                     only,\n                     with_deps,\n@@ -209,7 +216,7 @@ USAGE:\n FLAGS:\n     -h, --help          Prints help information\n     --load-output-dirs  Load OUT_DIR values by running `cargo check` before analysis\n-    --with-proc-macro    Use ra-proc-macro-srv for proc-macro expanding\n+    --with-proc-macro   Use ra-proc-macro-srv for proc-macro expanding\n     -v, --verbose\n \n OPTIONS:"}, {"sha": "0f55c3ee2b2ebc41496500f1c871ba6deee8cc8e", "filename": "crates/rust-analyzer/src/bin/main.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs?ref=b1a2d016450c96581c9cc70cc464f8aab2e5c0f3", "patch": "@@ -32,6 +32,7 @@ fn main() -> Result<()> {\n         args::Command::Highlight { rainbow } => cli::highlight(rainbow)?,\n         args::Command::Stats {\n             randomize,\n+            parallel,\n             memory_usage,\n             only,\n             with_deps,\n@@ -45,6 +46,7 @@ fn main() -> Result<()> {\n             only.as_ref().map(String::as_ref),\n             with_deps,\n             randomize,\n+            parallel,\n             load_output_dirs,\n             with_proc_macro,\n         )?,"}, {"sha": "14982919dbb79a644291636f3c50ed3806d74cee", "filename": "crates/rust-analyzer/src/cli/analysis_stats.rs", "status": "modified", "additions": 29, "deletions": 2, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b1a2d016450c96581c9cc70cc464f8aab2e5c0f3/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs?ref=b1a2d016450c96581c9cc70cc464f8aab2e5c0f3", "patch": "@@ -5,6 +5,7 @@ use std::{path::Path, time::Instant};\n \n use itertools::Itertools;\n use rand::{seq::SliceRandom, thread_rng};\n+use rayon::prelude::*;\n use rustc_hash::FxHashSet;\n \n use hir::{\n@@ -13,19 +14,31 @@ use hir::{\n };\n use hir_def::FunctionId;\n use hir_ty::{Ty, TypeWalk};\n-use ra_db::SourceDatabaseExt;\n+use ra_db::{\n+    salsa::{self, ParallelDatabase},\n+    SourceDatabaseExt,\n+};\n use ra_syntax::AstNode;\n use stdx::format_to;\n \n use crate::cli::{load_cargo::load_cargo, progress_report::ProgressReport, Result, Verbosity};\n \n+/// Need to wrap Snapshot to provide `Clone` impl for `map_with`\n+struct Snap<DB>(DB);\n+impl<DB: ParallelDatabase> Clone for Snap<salsa::Snapshot<DB>> {\n+    fn clone(&self) -> Snap<salsa::Snapshot<DB>> {\n+        Snap(self.0.snapshot())\n+    }\n+}\n+\n pub fn analysis_stats(\n     verbosity: Verbosity,\n     memory_usage: bool,\n     path: &Path,\n     only: Option<&str>,\n     with_deps: bool,\n     randomize: bool,\n+    parallel: bool,\n     load_output_dirs: bool,\n     with_proc_macro: bool,\n ) -> Result<()> {\n@@ -91,12 +104,26 @@ pub fn analysis_stats(\n         funcs.shuffle(&mut thread_rng());\n     }\n \n-    let inference_time = Instant::now();\n     let mut bar = match verbosity {\n         Verbosity::Quiet | Verbosity::Spammy => ProgressReport::hidden(),\n         _ => ProgressReport::new(funcs.len() as u64),\n     };\n \n+    if parallel {\n+        let inference_time = Instant::now();\n+        let snap = Snap(db.snapshot());\n+        funcs\n+            .par_iter()\n+            .map_with(snap, |snap, &f| {\n+                let f_id = FunctionId::from(f);\n+                snap.0.body(f_id.into());\n+                snap.0.infer(f_id.into());\n+            })\n+            .count();\n+        println!(\"Parallel Inference: {:?}, {}\", inference_time.elapsed(), ra_prof::memory_usage());\n+    }\n+\n+    let inference_time = Instant::now();\n     bar.tick();\n     let mut num_exprs = 0;\n     let mut num_exprs_unknown = 0;"}]}