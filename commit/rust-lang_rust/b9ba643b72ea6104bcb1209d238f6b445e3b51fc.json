{"sha": "b9ba643b72ea6104bcb1209d238f6b445e3b51fc", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI5YmE2NDNiNzJlYTYxMDRiY2IxMjA5ZDIzOGY2YjQ0NWUzYjUxZmM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-02-13T21:15:39Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-02-13T21:15:39Z"}, "message": "Auto merge of #22200 - alexcrichton:opt-vec-collect, r=huonw\n\nThis PR is an optimization of the `FromIterator` implementation of `Vec`\r\n\r\nBenchmark: https://gist.github.com/alexcrichton/03d666159a28a80e7c70\r\n\r\nBefore:\r\n\r\n    test macro_repeat1     ... bench:        57 ns/iter (+/- 1)\r\n    test macro_repeat2     ... bench:        56 ns/iter (+/- 1)\r\n    test map_clone1        ... bench:       828 ns/iter (+/- 13)\r\n    test map_clone2        ... bench:       828 ns/iter (+/- 8)\r\n    test repeat1           ... bench:      1104 ns/iter (+/- 10)\r\n    test repeat2           ... bench:      1106 ns/iter (+/- 11)\r\n\r\nAfter:\r\n\r\n    test macro_repeat1     ... bench:        75 ns/iter (+/- 21)\r\n    test macro_repeat2     ... bench:        59 ns/iter (+/- 31)\r\n    test map_clone1        ... bench:        34 ns/iter (+/- 22)\r\n    test map_clone2        ... bench:        52 ns/iter (+/- 21)\r\n    test repeat1           ... bench:        34 ns/iter (+/- 11)\r\n    test repeat2           ... bench:        33 ns/iter (+/- 12)\r\n\r\nThe idea behind this optimization is to avoid all bounds checks for space\r\nalready allocated into the vector. This may involve running the iterator twice,\r\nbut the first run of the iterator should be optimizable to a memcpy or memset if\r\npossible.\r\n\r\nThe same treatment can in theory be applied to `Vec::extend` but the benchmarks\r\nfor that currently get *worse* if the change is applied. This appears to be some\r\nLLVM optimizations going awry but it's seems prudent to land at least the\r\n`collect` portion beforehand.", "tree": {"sha": "02682727b0557c70d24348d845048706cf6f7c3f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/02682727b0557c70d24348d845048706cf6f7c3f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b9ba643b72ea6104bcb1209d238f6b445e3b51fc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b9ba643b72ea6104bcb1209d238f6b445e3b51fc", "html_url": "https://github.com/rust-lang/rust/commit/b9ba643b72ea6104bcb1209d238f6b445e3b51fc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b9ba643b72ea6104bcb1209d238f6b445e3b51fc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cf636c233dfeef5abf0de8fb35e23c0a161810d2", "url": "https://api.github.com/repos/rust-lang/rust/commits/cf636c233dfeef5abf0de8fb35e23c0a161810d2", "html_url": "https://github.com/rust-lang/rust/commit/cf636c233dfeef5abf0de8fb35e23c0a161810d2"}, {"sha": "985fc7d09b9a3884a8bfa81f739aa15796efc373", "url": "https://api.github.com/repos/rust-lang/rust/commits/985fc7d09b9a3884a8bfa81f739aa15796efc373", "html_url": "https://github.com/rust-lang/rust/commit/985fc7d09b9a3884a8bfa81f739aa15796efc373"}], "stats": {"total": 12, "additions": 11, "deletions": 1}, "files": [{"sha": "cebde59634b3024d5f1ad47294e971b9a52e025b", "filename": "src/libcollections/vec.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/b9ba643b72ea6104bcb1209d238f6b445e3b51fc/src%2Flibcollections%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9ba643b72ea6104bcb1209d238f6b445e3b51fc/src%2Flibcollections%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fvec.rs?ref=b9ba643b72ea6104bcb1209d238f6b445e3b51fc", "patch": "@@ -1386,7 +1386,17 @@ impl<T> FromIterator<T> for Vec<T> {\n     fn from_iter<I:Iterator<Item=T>>(iterator: I) -> Vec<T> {\n         let (lower, _) = iterator.size_hint();\n         let mut vector = Vec::with_capacity(lower);\n-        for element in iterator {\n+\n+        let mut i = iterator.fuse();\n+        for element in i.by_ref().take(vector.capacity()) {\n+            let len = vector.len();\n+            unsafe {\n+                ptr::write(vector.get_unchecked_mut(len), element);\n+                vector.set_len(len + 1);\n+            }\n+        }\n+\n+        for element in i {\n             vector.push(element)\n         }\n         vector"}]}