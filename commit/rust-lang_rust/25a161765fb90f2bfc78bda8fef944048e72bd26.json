{"sha": "25a161765fb90f2bfc78bda8fef944048e72bd26", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI1YTE2MTc2NWZiOTBmMmJmYzc4YmRhOGZlZjk0NDA0OGU3MmJkMjY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-05-10T11:37:22Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-05-10T11:37:22Z"}, "message": "Auto merge of #41815 - Yamakaky:improve-backtrace-bottom, r=alexcrichton\n\nImprove cleaning of the bottom of the backtrace\n\nFollowing https://github.com/rust-lang/rust/pull/40264. It only cleans the bottom of the trace (after the main). It handles correctly the normal main, tests, benchmarks and threads.\n\nI kept `skipped_before` since it will be used later for the cleaning of the top.", "tree": {"sha": "0dc21722451293bbedf2367b1fea0fa06c112bb7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0dc21722451293bbedf2367b1fea0fa06c112bb7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/25a161765fb90f2bfc78bda8fef944048e72bd26", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/25a161765fb90f2bfc78bda8fef944048e72bd26", "html_url": "https://github.com/rust-lang/rust/commit/25a161765fb90f2bfc78bda8fef944048e72bd26", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/25a161765fb90f2bfc78bda8fef944048e72bd26/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2b97174ada7fb1854269558ed2cf3b089e58beee", "url": "https://api.github.com/repos/rust-lang/rust/commits/2b97174ada7fb1854269558ed2cf3b089e58beee", "html_url": "https://github.com/rust-lang/rust/commit/2b97174ada7fb1854269558ed2cf3b089e58beee"}, {"sha": "ca8b75466cef854d30fdf7614c2358b1eb46816e", "url": "https://api.github.com/repos/rust-lang/rust/commits/ca8b75466cef854d30fdf7614c2358b1eb46816e", "html_url": "https://github.com/rust-lang/rust/commit/ca8b75466cef854d30fdf7614c2358b1eb46816e"}], "stats": {"total": 81, "additions": 68, "deletions": 13}, "files": [{"sha": "acff7faf8a7d0a853bf3d09e903f360db7c8f721", "filename": "src/libstd/rt.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/25a161765fb90f2bfc78bda8fef944048e72bd26/src%2Flibstd%2Frt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25a161765fb90f2bfc78bda8fef944048e72bd26/src%2Flibstd%2Frt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Frt.rs?ref=25a161765fb90f2bfc78bda8fef944048e72bd26", "patch": "@@ -29,8 +29,7 @@ pub use panicking::{begin_panic, begin_panic_fmt, update_panic_count};\n \n #[cfg(not(test))]\n #[lang = \"start\"]\n-fn lang_start(main: *const u8, argc: isize, argv: *const *const u8) -> isize {\n-    use mem;\n+fn lang_start(main: fn(), argc: isize, argv: *const *const u8) -> isize {\n     use panic;\n     use sys;\n     use sys_common;\n@@ -54,7 +53,9 @@ fn lang_start(main: *const u8, argc: isize, argv: *const *const u8) -> isize {\n         sys::args::init(argc, argv);\n \n         // Let's run some code!\n-        let res = panic::catch_unwind(mem::transmute::<_, fn()>(main));\n+        let res = panic::catch_unwind(|| {\n+            ::sys_common::backtrace::__rust_begin_short_backtrace(main)\n+        });\n         sys_common::cleanup();\n         res.is_err()\n     };"}, {"sha": "617218fe7a5a6989d64a3d0a0fe0a7396a7883f3", "filename": "src/libstd/sys_common/backtrace.rs", "status": "modified", "additions": 40, "deletions": 4, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/25a161765fb90f2bfc78bda8fef944048e72bd26/src%2Flibstd%2Fsys_common%2Fbacktrace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25a161765fb90f2bfc78bda8fef944048e72bd26/src%2Flibstd%2Fsys_common%2Fbacktrace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys_common%2Fbacktrace.rs?ref=25a161765fb90f2bfc78bda8fef944048e72bd26", "patch": "@@ -93,11 +93,47 @@ fn _print(w: &mut Write, format: PrintFormat) -> io::Result<()> {\n     Ok(())\n }\n \n-fn filter_frames(_frames: &[Frame],\n-                 _format: PrintFormat,\n-                 _context: &BacktraceContext) -> (usize, usize)\n+/// Returns a number of frames to remove at the beginning and at the end of the\n+/// backtrace, according to the backtrace format.\n+fn filter_frames(frames: &[Frame],\n+                 format: PrintFormat,\n+                 context: &BacktraceContext) -> (usize, usize)\n {\n-    (0, 0)\n+    if format == PrintFormat::Full {\n+        return (0, 0);\n+    }\n+\n+    let skipped_before = 0;\n+\n+    let skipped_after = frames.len() - frames.iter().position(|frame| {\n+        let mut is_marker = false;\n+        let _ = resolve_symname(*frame, |symname| {\n+            if let Some(mangled_symbol_name) = symname {\n+                // Use grep to find the concerned functions\n+                if mangled_symbol_name.contains(\"__rust_begin_short_backtrace\") {\n+                    is_marker = true;\n+                }\n+            }\n+            Ok(())\n+        }, context);\n+        is_marker\n+    }).unwrap_or(frames.len());\n+\n+    if skipped_before + skipped_after >= frames.len() {\n+        // Avoid showing completely empty backtraces\n+        return (0, 0);\n+    }\n+\n+    (skipped_before, skipped_after)\n+}\n+\n+\n+/// Fixed frame used to clean the backtrace with `RUST_BACKTRACE=1`.\n+#[inline(never)]\n+pub fn __rust_begin_short_backtrace<F, T>(f: F) -> T\n+    where F: FnOnce() -> T, F: Send + 'static, T: Send + 'static\n+{\n+    f()\n }\n \n /// Controls how the backtrace should be formated."}, {"sha": "4432f898e04f8aa00bea7925bf7ec27b3db03be0", "filename": "src/libstd/thread/mod.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/25a161765fb90f2bfc78bda8fef944048e72bd26/src%2Flibstd%2Fthread%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25a161765fb90f2bfc78bda8fef944048e72bd26/src%2Flibstd%2Fthread%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fthread%2Fmod.rs?ref=25a161765fb90f2bfc78bda8fef944048e72bd26", "patch": "@@ -365,7 +365,9 @@ impl Builder {\n             }\n             unsafe {\n                 thread_info::set(imp::guard::current(), their_thread);\n-                let try_result = panic::catch_unwind(panic::AssertUnwindSafe(f));\n+                let try_result = panic::catch_unwind(panic::AssertUnwindSafe(|| {\n+                    ::sys_common::backtrace::__rust_begin_short_backtrace(f)\n+                }));\n                 *their_packet.get() = Some(try_result);\n             }\n         };"}, {"sha": "0d615db3deb4796270876c8b15597b4bdc10284f", "filename": "src/libtest/lib.rs", "status": "modified", "additions": 21, "deletions": 5, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/25a161765fb90f2bfc78bda8fef944048e72bd26/src%2Flibtest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25a161765fb90f2bfc78bda8fef944048e72bd26/src%2Flibtest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Flib.rs?ref=25a161765fb90f2bfc78bda8fef944048e72bd26", "patch": "@@ -1314,12 +1314,16 @@ pub fn convert_benchmarks_to_tests(tests: Vec<TestDescAndFn>) -> Vec<TestDescAnd\n         let testfn = match x.testfn {\n             DynBenchFn(bench) => {\n                 DynTestFn(Box::new(move |()| {\n-                    bench::run_once(|b| bench.run(b))\n+                    bench::run_once(|b| {\n+                        __rust_begin_short_backtrace(|| bench.run(b))\n+                    })\n                 }))\n             }\n             StaticBenchFn(benchfn) => {\n                 DynTestFn(Box::new(move |()| {\n-                    bench::run_once(|b| benchfn(b))\n+                    bench::run_once(|b| {\n+                        __rust_begin_short_backtrace(|| benchfn(b))\n+                    })\n                 }))\n             }\n             f => f,\n@@ -1425,12 +1429,24 @@ pub fn run_test(opts: &TestOpts,\n             monitor_ch.send((desc, TrMetrics(mm), Vec::new())).unwrap();\n             return;\n         }\n-        DynTestFn(f) => run_test_inner(desc, monitor_ch, opts.nocapture, f),\n-        StaticTestFn(f) => run_test_inner(desc, monitor_ch, opts.nocapture,\n-                                          Box::new(move |()| f())),\n+        DynTestFn(f) => {\n+            let cb = move |()| {\n+                __rust_begin_short_backtrace(|| f.call_box(()))\n+            };\n+            run_test_inner(desc, monitor_ch, opts.nocapture, Box::new(cb))\n+        }\n+        StaticTestFn(f) =>\n+            run_test_inner(desc, monitor_ch, opts.nocapture,\n+                           Box::new(move |()| __rust_begin_short_backtrace(f))),\n     }\n }\n \n+/// Fixed frame used to clean the backtrace with `RUST_BACKTRACE=1`.\n+#[inline(never)]\n+fn __rust_begin_short_backtrace<F: FnOnce()>(f: F) {\n+    f()\n+}\n+\n fn calc_result(desc: &TestDesc, task_result: Result<(), Box<Any + Send>>) -> TestResult {\n     match (&desc.should_panic, task_result) {\n         (&ShouldPanic::No, Ok(())) |"}]}