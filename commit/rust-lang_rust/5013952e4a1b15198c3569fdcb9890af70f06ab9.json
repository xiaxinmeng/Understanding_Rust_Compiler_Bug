{"sha": "5013952e4a1b15198c3569fdcb9890af70f06ab9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUwMTM5NTJlNGExYjE1MTk4YzM1NjlmZGNiOTg5MGFmNzBmMDZhYjk=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-05-04T18:06:51Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-05-04T21:03:04Z"}, "message": "rustc: Stabilize `-C target-feature=+crt-static`\n\nThis commit stabilizes the `crt-static` feature accepted by the compiler. Note\nthat this does not stabilize the `#[cfg]` attribute for `crt-static` as\nthat's going to be covered by #29717. This only stabilizes a few small pieces:\n\n* The `crt-static` feature as accepted by the `-C target-feature` flag, and its\n  connection with the platform-specific definition of `crt-static`.\n* The semantics of `--print cfg` printing out activated `crt-static` feature, if\n  available.\n\nThis should be enough to get the benefits of `crt-static` on stable Rust with\nMSVC and with musl, but sidsteps the issue of stabilizing #29717 first.\n\nCloses #37406", "tree": {"sha": "ee41cf682967bdd44cd1578cf8440eefee15581a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ee41cf682967bdd44cd1578cf8440eefee15581a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5013952e4a1b15198c3569fdcb9890af70f06ab9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5013952e4a1b15198c3569fdcb9890af70f06ab9", "html_url": "https://github.com/rust-lang/rust/commit/5013952e4a1b15198c3569fdcb9890af70f06ab9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5013952e4a1b15198c3569fdcb9890af70f06ab9/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "222971f7d2a098b4b8b57520452ab475bc5ea45f", "url": "https://api.github.com/repos/rust-lang/rust/commits/222971f7d2a098b4b8b57520452ab475bc5ea45f", "html_url": "https://github.com/rust-lang/rust/commit/222971f7d2a098b4b8b57520452ab475bc5ea45f"}], "stats": {"total": 44, "additions": 16, "deletions": 28}, "files": [{"sha": "eef3b38a8b5e9bdb32c8b12788c32f68a1308ea9", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 16, "deletions": 3, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/5013952e4a1b15198c3569fdcb9890af70f06ab9/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5013952e4a1b15198c3569fdcb9890af70f06ab9/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=5013952e4a1b15198c3569fdcb9890af70f06ab9", "patch": "@@ -635,11 +635,24 @@ impl RustcDefaultCalls {\n                             node: ast::MetaItemKind::Word,\n                             span: DUMMY_SP,\n                         });\n-                        if !allow_unstable_cfg && gated_cfg.is_some() {\n-                            continue;\n+\n+                        // Note that crt-static is a specially recognized cfg\n+                        // directive that's printed out here as part of\n+                        // rust-lang/rust#37406, but in general the\n+                        // `target_feature` cfg is gated under\n+                        // rust-lang/rust#29717. For now this is just\n+                        // specifically allowing the crt-static cfg and that's\n+                        // it, this is intended to get into Cargo and then go\n+                        // through to build scripts.\n+                        let value = value.as_ref().map(|s| s.as_str());\n+                        let value = value.as_ref().map(|s| s.as_ref());\n+                        if name != \"target_feature\" || value != Some(\"crt-static\") {\n+                            if !allow_unstable_cfg && gated_cfg.is_some() {\n+                                continue;\n+                            }\n                         }\n \n-                        cfgs.push(if let &Some(ref value) = value {\n+                        cfgs.push(if let Some(value) = value {\n                             format!(\"{}=\\\"{}\\\"\", name, value)\n                         } else {\n                             format!(\"{}\", name)"}, {"sha": "e383f92d7b80ec37201023f9f7cc23bd064f38ed", "filename": "src/librustc_driver/target_features.rs", "status": "modified", "additions": 0, "deletions": 11, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/5013952e4a1b15198c3569fdcb9890af70f06ab9/src%2Flibrustc_driver%2Ftarget_features.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5013952e4a1b15198c3569fdcb9890af70f06ab9/src%2Flibrustc_driver%2Ftarget_features.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Ftarget_features.rs?ref=5013952e4a1b15198c3569fdcb9890af70f06ab9", "patch": "@@ -12,7 +12,6 @@ use syntax::ast;\n use llvm::LLVMRustHasFeature;\n use rustc::session::Session;\n use rustc_trans::back::write::create_target_machine;\n-use syntax::feature_gate::UnstableFeatures;\n use syntax::symbol::Symbol;\n use libc::c_char;\n \n@@ -50,8 +49,6 @@ pub fn add_configuration(cfg: &mut ast::CrateConfig, sess: &Session) {\n     }\n \n     let requested_features = sess.opts.cg.target_feature.split(',');\n-    let unstable_options = sess.opts.debugging_opts.unstable_options;\n-    let is_nightly = UnstableFeatures::from_environment().is_nightly_build();\n     let found_negative = requested_features.clone().any(|r| r == \"-crt-static\");\n     let found_positive = requested_features.clone().any(|r| r == \"+crt-static\");\n \n@@ -65,14 +62,6 @@ pub fn add_configuration(cfg: &mut ast::CrateConfig, sess: &Session) {\n         found_positive\n     };\n \n-    // If we switched from the default then that's only allowed on nightly, so\n-    // gate that here.\n-    if (found_positive || found_negative) && (!is_nightly || !unstable_options) {\n-        sess.fatal(\"specifying the `crt-static` target feature is only allowed \\\n-                    on the nightly channel with `-Z unstable-options` passed \\\n-                    as well\");\n-    }\n-\n     if crt_static {\n         cfg.insert((tf, Some(Symbol::intern(\"crt-static\"))));\n     }"}, {"sha": "6c7c60b653a25db5373782f8e9f40ac69b6de8d7", "filename": "src/test/compile-fail/crt-static-gated.rs", "status": "removed", "additions": 0, "deletions": 14, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/222971f7d2a098b4b8b57520452ab475bc5ea45f/src%2Ftest%2Fcompile-fail%2Fcrt-static-gated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/222971f7d2a098b4b8b57520452ab475bc5ea45f/src%2Ftest%2Fcompile-fail%2Fcrt-static-gated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fcrt-static-gated.rs?ref=222971f7d2a098b4b8b57520452ab475bc5ea45f", "patch": "@@ -1,14 +0,0 @@\n-// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n-// file at the top-level directory of this distribution and at\n-// http://rust-lang.org/COPYRIGHT.\n-//\n-// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n-// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n-// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n-// option. This file may not be copied, modified, or distributed\n-// except according to those terms.\n-\n-// compile-flags:-C target-feature=+crt-static\n-// error-pattern: specifying the `crt-static` target feature is only allowed\n-\n-fn main() {}"}]}