{"sha": "59f979fa06fed49e02606d4891b5b5e4fc545725", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU5Zjk3OWZhMDZmZWQ0OWUwMjYwNmQ0ODkxYjViNWU0ZmM1NDU3MjU=", "commit": {"author": {"name": "Arlo Siemsen", "email": "arsiem@microsoft.com", "date": "2020-07-02T17:45:10Z"}, "committer": {"name": "Arlo Siemsen", "email": "arsiem@microsoft.com", "date": "2020-07-08T15:19:50Z"}, "message": "Fix cross-compilation of LLVM to aarch64 Windows targets\n\nWhen cross-compiling, the LLVM build system recurses to build tools\nthat need to run on the host system. However, since we pass cmake defines\nto set the compiler and target, LLVM still compiles these tools for the\ntarget system, rather than the host. The tools then fail to execute\nduring the LLVM build.\n\nThis change sets defines for the tools that need to run on the\nhost (llvm-nm, llvm-tablegen, and llvm-config), so that the LLVM build\ndoes not attempt to build them, and instead relies on the tools already built.\n\nIf compiling with clang-cl, this change also adds the `--target` option\nto specify the target triple. MSVC compilers do not require this, since there\nis a separate compiler binary for cross-compilation.", "tree": {"sha": "c987bdb865adbf94ad8ad0adb1874578aca92b9b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c987bdb865adbf94ad8ad0adb1874578aca92b9b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/59f979fa06fed49e02606d4891b5b5e4fc545725", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/59f979fa06fed49e02606d4891b5b5e4fc545725", "html_url": "https://github.com/rust-lang/rust/commit/59f979fa06fed49e02606d4891b5b5e4fc545725", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/59f979fa06fed49e02606d4891b5b5e4fc545725/comments", "author": {"login": "arlosi", "id": 704597, "node_id": "MDQ6VXNlcjcwNDU5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/704597?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arlosi", "html_url": "https://github.com/arlosi", "followers_url": "https://api.github.com/users/arlosi/followers", "following_url": "https://api.github.com/users/arlosi/following{/other_user}", "gists_url": "https://api.github.com/users/arlosi/gists{/gist_id}", "starred_url": "https://api.github.com/users/arlosi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arlosi/subscriptions", "organizations_url": "https://api.github.com/users/arlosi/orgs", "repos_url": "https://api.github.com/users/arlosi/repos", "events_url": "https://api.github.com/users/arlosi/events{/privacy}", "received_events_url": "https://api.github.com/users/arlosi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "arlosi", "id": 704597, "node_id": "MDQ6VXNlcjcwNDU5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/704597?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arlosi", "html_url": "https://github.com/arlosi", "followers_url": "https://api.github.com/users/arlosi/followers", "following_url": "https://api.github.com/users/arlosi/following{/other_user}", "gists_url": "https://api.github.com/users/arlosi/gists{/gist_id}", "starred_url": "https://api.github.com/users/arlosi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arlosi/subscriptions", "organizations_url": "https://api.github.com/users/arlosi/orgs", "repos_url": "https://api.github.com/users/arlosi/repos", "events_url": "https://api.github.com/users/arlosi/events{/privacy}", "received_events_url": "https://api.github.com/users/arlosi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1d919c9377f4602d991ca1c7ba852e7555943740", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d919c9377f4602d991ca1c7ba852e7555943740", "html_url": "https://github.com/rust-lang/rust/commit/1d919c9377f4602d991ca1c7ba852e7555943740"}], "stats": {"total": 37, "additions": 26, "deletions": 11}, "files": [{"sha": "37928c4d5581acca3cd37d5ec2495b7c13f7ff11", "filename": "Cargo.lock", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/59f979fa06fed49e02606d4891b5b5e4fc545725/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/59f979fa06fed49e02606d4891b5b5e4fc545725/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=59f979fa06fed49e02606d4891b5b5e4fc545725", "patch": "@@ -404,9 +404,9 @@ version = \"0.1.0\"\n \n [[package]]\n name = \"cc\"\n-version = \"1.0.54\"\n+version = \"1.0.57\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"7bbb73db36c1246e9034e307d0fba23f9a2e251faa47ade70c1bd252220c8311\"\n+checksum = \"0fde55d2a2bfaa4c9668bbc63f531fbdeee3ffe188f4662511ce2c22b3eedebe\"\n dependencies = [\n  \"jobserver\",\n ]"}, {"sha": "e8ec575ea37466379f6ab1e75ccc3134f5c22ddd", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 23, "deletions": 8, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/59f979fa06fed49e02606d4891b5b5e4fc545725/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/59f979fa06fed49e02606d4891b5b5e4fc545725/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=59f979fa06fed49e02606d4891b5b5e4fc545725", "patch": "@@ -9,6 +9,7 @@\n //! ensure that they're always in place if needed.\n \n use std::env;\n+use std::env::consts::EXE_EXTENSION;\n use std::ffi::OsString;\n use std::fs::{self, File};\n use std::io;\n@@ -252,8 +253,14 @@ impl Step for Llvm {\n             // FIXME: if the llvm root for the build triple is overridden then we\n             //        should use llvm-tblgen from there, also should verify that it\n             //        actually exists most of the time in normal installs of LLVM.\n-            let host = builder.llvm_out(builder.config.build).join(\"bin/llvm-tblgen\");\n-            cfg.define(\"CMAKE_CROSSCOMPILING\", \"True\").define(\"LLVM_TABLEGEN\", &host);\n+            let host_bin = builder.llvm_out(builder.config.build).join(\"bin\");\n+            cfg.define(\"CMAKE_CROSSCOMPILING\", \"True\");\n+            cfg.define(\"LLVM_TABLEGEN\", host_bin.join(\"llvm-tblgen\").with_extension(EXE_EXTENSION));\n+            cfg.define(\"LLVM_NM\", host_bin.join(\"llvm-nm\").with_extension(EXE_EXTENSION));\n+            cfg.define(\n+                \"LLVM_CONFIG_PATH\",\n+                host_bin.join(\"llvm-config\").with_extension(EXE_EXTENSION),\n+            );\n \n             if target.contains(\"netbsd\") {\n                 cfg.define(\"CMAKE_SYSTEM_NAME\", \"NetBSD\");\n@@ -262,8 +269,6 @@ impl Step for Llvm {\n             } else if target.contains(\"windows\") {\n                 cfg.define(\"CMAKE_SYSTEM_NAME\", \"Windows\");\n             }\n-\n-            cfg.define(\"LLVM_NATIVE_BUILD\", builder.llvm_out(builder.config.build).join(\"build\"));\n         }\n \n         if let Some(ref suffix) = builder.config.llvm_version_suffix {\n@@ -431,6 +436,9 @@ fn configure_cmake(\n             cflags.push_str(\" -miphoneos-version-min=10.0\");\n         }\n     }\n+    if builder.config.llvm_clang_cl.is_some() {\n+        cflags.push_str(&format!(\" --target={}\", target))\n+    }\n     cfg.define(\"CMAKE_C_FLAGS\", cflags);\n     let mut cxxflags = builder.cflags(target, GitRepo::Llvm).join(\" \");\n     if builder.config.llvm_static_stdcpp && !target.contains(\"msvc\") && !target.contains(\"netbsd\") {\n@@ -439,6 +447,9 @@ fn configure_cmake(\n     if let Some(ref s) = builder.config.llvm_cxxflags {\n         cxxflags.push_str(&format!(\" {}\", s));\n     }\n+    if builder.config.llvm_clang_cl.is_some() {\n+        cxxflags.push_str(&format!(\" --target={}\", target))\n+    }\n     cfg.define(\"CMAKE_CXX_FLAGS\", cxxflags);\n     if let Some(ar) = builder.ar(target) {\n         if ar.is_absolute() {\n@@ -484,7 +495,7 @@ impl Step for Lld {\n         run.builder.ensure(Lld { target: run.target });\n     }\n \n-    /// Compile LLVM for `target`.\n+    /// Compile LLD for `target`.\n     fn run(self, builder: &Builder<'_>) -> PathBuf {\n         if builder.config.dry_run {\n             return PathBuf::from(\"lld-out-dir-test-gen\");\n@@ -521,6 +532,7 @@ impl Step for Lld {\n         // can't build on a system where your paths require `\\` on Windows, but\n         // there's probably a lot of reasons you can't do that other than this.\n         let llvm_config_shim = env::current_exe().unwrap().with_file_name(\"llvm-config-wrapper\");\n+\n         cfg.out_dir(&out_dir)\n             .profile(\"Release\")\n             .env(\"LLVM_CONFIG_REAL\", &llvm_config)\n@@ -543,7 +555,10 @@ impl Step for Lld {\n         if target != builder.config.build {\n             cfg.env(\"LLVM_CONFIG_SHIM_REPLACE\", &builder.config.build)\n                 .env(\"LLVM_CONFIG_SHIM_REPLACE_WITH\", &target)\n-                .define(\"LLVM_TABLEGEN_EXE\", llvm_config.with_file_name(\"llvm-tblgen\"));\n+                .define(\n+                    \"LLVM_TABLEGEN_EXE\",\n+                    llvm_config.with_file_name(\"llvm-tblgen\").with_extension(EXE_EXTENSION),\n+                );\n         }\n \n         // Explicitly set C++ standard, because upstream doesn't do so\n@@ -595,8 +610,8 @@ impl Step for TestHelpers {\n         }\n \n         // We may have found various cross-compilers a little differently due to our\n-        // extra configuration, so inform gcc of these compilers. Note, though, that\n-        // on MSVC we still need gcc's detection of env vars (ugh).\n+        // extra configuration, so inform cc of these compilers. Note, though, that\n+        // on MSVC we still need cc's detection of env vars (ugh).\n         if !target.contains(\"msvc\") {\n             if let Some(ar) = builder.ar(target) {\n                 cfg.archiver(ar);"}, {"sha": "d134a53927fa033ae7e0f3e8ee872ff2dc71468d", "filename": "src/llvm-project", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fllvm-project?ref=59f979fa06fed49e02606d4891b5b5e4fc545725", "patch": "@@ -1 +1 @@\n-Subproject commit 6c040dd86ed62d38e585279027486e6efc42fb36\n+Subproject commit d134a53927fa033ae7e0f3e8ee872ff2dc71468d"}]}