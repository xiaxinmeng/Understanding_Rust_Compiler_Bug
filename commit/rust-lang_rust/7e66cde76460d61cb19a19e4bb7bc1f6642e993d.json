{"sha": "7e66cde76460d61cb19a19e4bb7bc1f6642e993d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdlNjZjZGU3NjQ2MGQ2MWNiMTlhMTllNGJiN2JjMWY2NjQyZTk5M2Q=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-02-02T17:02:48Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-02-02T17:02:48Z"}, "message": "Merge #7525\n\n7525: Fix resolution of `crate` paths from within blocks r=jonas-schievink a=jonas-schievink\n\nThey resolve to the crate root, not the DefMap's root module (which\r\ncan be a block)\r\n\r\nbors r+\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>", "tree": {"sha": "c8c20aff862d670f1baebd33d95e645a1281ca7f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c8c20aff862d670f1baebd33d95e645a1281ca7f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7e66cde76460d61cb19a19e4bb7bc1f6642e993d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgGYW4CRBK7hj4Ov3rIwAAdHIIAFCGvMhTJZM1OWCfGpzkvS67\nyEmH3JlHGb8spCF0lz+K8z4DM1fUAZQbo+PrcQDmr+Fu211h81iVb+swbU4vZ8uL\nTdNvW7QT2JT3wQ1op6WnuEfrTzsnoSnV2NhTJK6IBHMiRTXLSNDp+7mSUMEG8Wfj\n8aJOD5VAMSr3yXG6MiD3ujGvYfuEiw89natjtfaTd2JIoc9+ZpAF2s5OyV/EhbSQ\nWo36Q7wGMC53mfKQ47jVm0VdqnKMTCPgot7fHXihmJbrpQTFLXatpuzJLjlWxYLu\nkNz8F6Kezx9olPS53uTAqY7nqccjqHd9dIizFphJ5Uj5UqkxKrwv9+K4tZ2t6aQ=\n=wXZE\n-----END PGP SIGNATURE-----\n", "payload": "tree c8c20aff862d670f1baebd33d95e645a1281ca7f\nparent 12e8cc4aa29f616e43b4951e18b1f1f231e539a3\nparent 5914f86d473f34e0fa78dc150024b07bd26a2db9\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1612285368 +0000\ncommitter GitHub <noreply@github.com> 1612285368 +0000\n\nMerge #7525\n\n7525: Fix resolution of `crate` paths from within blocks r=jonas-schievink a=jonas-schievink\n\nThey resolve to the crate root, not the DefMap's root module (which\r\ncan be a block)\r\n\r\nbors r+\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7e66cde76460d61cb19a19e4bb7bc1f6642e993d", "html_url": "https://github.com/rust-lang/rust/commit/7e66cde76460d61cb19a19e4bb7bc1f6642e993d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7e66cde76460d61cb19a19e4bb7bc1f6642e993d/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "12e8cc4aa29f616e43b4951e18b1f1f231e539a3", "url": "https://api.github.com/repos/rust-lang/rust/commits/12e8cc4aa29f616e43b4951e18b1f1f231e539a3", "html_url": "https://github.com/rust-lang/rust/commit/12e8cc4aa29f616e43b4951e18b1f1f231e539a3"}, {"sha": "5914f86d473f34e0fa78dc150024b07bd26a2db9", "url": "https://api.github.com/repos/rust-lang/rust/commits/5914f86d473f34e0fa78dc150024b07bd26a2db9", "html_url": "https://github.com/rust-lang/rust/commit/5914f86d473f34e0fa78dc150024b07bd26a2db9"}], "stats": {"total": 9, "additions": 7, "deletions": 2}, "files": [{"sha": "0a15fc4704076c6bf346c87dcb359d01d66a0e65", "filename": "crates/hir_def/src/nameres.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/7e66cde76460d61cb19a19e4bb7bc1f6642e993d/crates%2Fhir_def%2Fsrc%2Fnameres.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e66cde76460d61cb19a19e4bb7bc1f6642e993d/crates%2Fhir_def%2Fsrc%2Fnameres.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres.rs?ref=7e66cde76460d61cb19a19e4bb7bc1f6642e993d", "patch": "@@ -275,6 +275,11 @@ impl DefMap {\n         ModuleId { krate: self.krate, local_id, block }\n     }\n \n+    pub(crate) fn crate_root(&self) -> ModuleId {\n+        let (root_map, _) = self.ancestor_maps(self.root).last().unwrap();\n+        root_map.module_id(root_map.root)\n+    }\n+\n     pub(crate) fn resolve_path(\n         &self,\n         db: &dyn DefDatabase,"}, {"sha": "ecf75c777cff129e1fe943e4d9351fd187713706", "filename": "crates/hir_def/src/nameres/path_resolution.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/7e66cde76460d61cb19a19e4bb7bc1f6642e993d/crates%2Fhir_def%2Fsrc%2Fnameres%2Fpath_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e66cde76460d61cb19a19e4bb7bc1f6642e993d/crates%2Fhir_def%2Fsrc%2Fnameres%2Fpath_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fpath_resolution.rs?ref=7e66cde76460d61cb19a19e4bb7bc1f6642e993d", "patch": "@@ -152,15 +152,15 @@ impl DefMap {\n             PathKind::DollarCrate(krate) => {\n                 if krate == self.krate {\n                     mark::hit!(macro_dollar_crate_self);\n-                    PerNs::types(self.module_id(self.root).into(), Visibility::Public)\n+                    PerNs::types(self.crate_root().into(), Visibility::Public)\n                 } else {\n                     let def_map = db.crate_def_map(krate);\n                     let module = def_map.module_id(def_map.root);\n                     mark::hit!(macro_dollar_crate_other);\n                     PerNs::types(module.into(), Visibility::Public)\n                 }\n             }\n-            PathKind::Crate => PerNs::types(self.module_id(self.root).into(), Visibility::Public),\n+            PathKind::Crate => PerNs::types(self.crate_root().into(), Visibility::Public),\n             // plain import or absolute path in 2015: crate-relative with\n             // fallback to extern prelude (with the simplification in\n             // rust-lang/rust#57745)"}]}