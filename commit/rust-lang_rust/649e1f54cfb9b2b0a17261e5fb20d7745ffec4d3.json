{"sha": "649e1f54cfb9b2b0a17261e5fb20d7745ffec4d3", "node_id": "C_kwDOAAsO6NoAKDY0OWUxZjU0Y2ZiOWIyYjBhMTcyNjFlNWZiMjBkNzc0NWZmZWM0ZDM", "commit": {"author": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-07-02T17:31:07Z"}, "committer": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-07-02T18:29:15Z"}, "message": "fix: report type mismatch on identifier in destructuring assignments", "tree": {"sha": "1eb5b63d4e9fb33dcc349f848cfe40e2813983fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1eb5b63d4e9fb33dcc349f848cfe40e2813983fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/649e1f54cfb9b2b0a17261e5fb20d7745ffec4d3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEkSbsQIURluxz4rzf4laYqTBYYXEFAmLAjnsACgkQ4laYqTBY\nYXH7YQ/+OvNi8Btsu3q9OThWYeFI7y2DLCZhbUOwL6qW0/cEk6Eu0DWwc/bveHYm\nEAXS4l5kwf7AbYUVbv0iNIccm/VZZi/zwgZfnBcY2WGtkCe80VlwM5MyzlWIfJjD\nx8UcsO16LMMC53lO0P3K19uduoihV/RbsSvSrhF8yJCo5nd+FVQ6QixKa9gFPpZs\n88tcJ0ooGCsSnyDv51/iejVGyVwI6gi42LulBe7pNkY7L2pa0Chs0Jw9ud0a1kMS\nyn4YWgmn+FLJBAJgUn0ji4B6xKAkdk/NVpy+iOQYLV3cfnP8FYBek1PXeRX83cPk\nRb0emoVDBimHboV9Agrrwaz3HusE+VRPFifoggip5R+fX0YzK6pZ3IL2rm3UrgIX\nnPvQuCgl5PIWb8doMXmcNlv1TSB7fiRL1z+uiKe6WQms5obUfOgCdVu2DC/P2Qhu\ndkvR8NZzNfgX7L8vjfDCYghlnH2p9bKR8WqAhrJkjuhThP62gLaeo4xh8lc+WuJU\nweHRyzoc2Ugj8sSw2Ww05WsHPN9JCeNqIMCAnZqFxpCpSBJP9cNXNtkDjD3Aw0V5\n4IH06Ostm6oYB8ducTPyb1++4pN8WEoo0sMEg5V2bhxKip18knEhu5SCKW6X5bm0\n0o46BpuWtl7GKkf/gswhCHlmz+uJjjg+YYwfT+g6paU3tcBN64U=\n=Nw2G\n-----END PGP SIGNATURE-----", "payload": "tree 1eb5b63d4e9fb33dcc349f848cfe40e2813983fa\nparent afdbd6cce247d057e1e4014d20b79bb2a2d4bfac\nauthor Ryo Yoshida <low.ryoshida@gmail.com> 1656783067 +0900\ncommitter Ryo Yoshida <low.ryoshida@gmail.com> 1656786555 +0900\n\nfix: report type mismatch on identifier in destructuring assignments\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/649e1f54cfb9b2b0a17261e5fb20d7745ffec4d3", "html_url": "https://github.com/rust-lang/rust/commit/649e1f54cfb9b2b0a17261e5fb20d7745ffec4d3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/649e1f54cfb9b2b0a17261e5fb20d7745ffec4d3/comments", "author": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "afdbd6cce247d057e1e4014d20b79bb2a2d4bfac", "url": "https://api.github.com/repos/rust-lang/rust/commits/afdbd6cce247d057e1e4014d20b79bb2a2d4bfac", "html_url": "https://github.com/rust-lang/rust/commit/afdbd6cce247d057e1e4014d20b79bb2a2d4bfac"}], "stats": {"total": 37, "additions": 36, "deletions": 1}, "files": [{"sha": "6dee0322a9bedc0044e9a58f9755499f2f850216", "filename": "crates/hir-ty/src/infer/expr.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/649e1f54cfb9b2b0a17261e5fb20d7745ffec4d3/crates%2Fhir-ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/649e1f54cfb9b2b0a17261e5fb20d7745ffec4d3/crates%2Fhir-ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Finfer%2Fexpr.rs?ref=649e1f54cfb9b2b0a17261e5fb20d7745ffec4d3", "patch": "@@ -911,7 +911,15 @@ impl<'a> InferenceContext<'a> {\n                 let lhs_ty = self.insert_type_vars_shallow(lhs_ty);\n                 let ty = match self.coerce(None, &rhs_ty, &lhs_ty) {\n                     Ok(ty) => ty,\n-                    Err(_) => self.err_ty(),\n+                    Err(_) => {\n+                        self.result.type_mismatches.insert(\n+                            lhs.into(),\n+                            TypeMismatch { expected: rhs_ty.clone(), actual: lhs_ty.clone() },\n+                        );\n+                        // `rhs_ty` is returned so no further type mismatches are\n+                        // reported because of this mismatch.\n+                        rhs_ty\n+                    }\n                 };\n                 self.write_expr_ty(lhs, ty.clone());\n                 return ty;"}, {"sha": "5b08f552109efe4a533c134e15046079056636ad", "filename": "crates/hir-ty/src/tests/simple.rs", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/649e1f54cfb9b2b0a17261e5fb20d7745ffec4d3/crates%2Fhir-ty%2Fsrc%2Ftests%2Fsimple.rs", "raw_url": "https://github.com/rust-lang/rust/raw/649e1f54cfb9b2b0a17261e5fb20d7745ffec4d3/crates%2Fhir-ty%2Fsrc%2Ftests%2Fsimple.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Ftests%2Fsimple.rs?ref=649e1f54cfb9b2b0a17261e5fb20d7745ffec4d3", "patch": "@@ -3043,3 +3043,30 @@ fn main() {\n         \"#,\n     );\n }\n+\n+#[test]\n+fn destructuring_assignment_type_mismatch_on_identifier() {\n+    check(\n+        r#\"\n+struct S { v: i64 }\n+struct TS(i64);\n+fn main() {\n+    let mut a: usize = 0;\n+    (a,) = (0i64,);\n+   //^expected i64, got usize\n+\n+    let mut a: usize = 0;\n+    [a,] = [0i64,];\n+   //^expected i64, got usize\n+\n+    let mut a: usize = 0;\n+    S { v: a } = S { v: 0 };\n+         //^expected i64, got usize\n+\n+    let mut a: usize = 0;\n+    TS(a) = TS(0);\n+     //^expected i64, got usize\n+}\n+        \"#,\n+    );\n+}"}]}