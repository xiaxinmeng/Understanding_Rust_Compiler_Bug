{"sha": "8ef3e227198f6ff674b1626d0862c4112358c1a1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhlZjNlMjI3MTk4ZjZmZjY3NGIxNjI2ZDA4NjJjNDExMjM1OGMxYTE=", "commit": {"author": {"name": "Kevin Ballard", "email": "kevin@sb.org", "date": "2014-05-15T00:54:36Z"}, "committer": {"name": "Kevin Ballard", "email": "kevin@sb.org", "date": "2014-05-16T21:02:14Z"}, "message": "Optimize and fix time::precise_time_ns() on macos\n\nUse sync::one::Once to fetch the mach_timebase_info only once when\nrunning precise_time_ns(). This helps because mach_timebase_info() is\nsurprisingly inefficient. Also fix the order of operations when applying\nthe timebase to the mach absolute time value.\n\nThis improves the time on my machine from\n\n```\ntest tests::bench_precise_time_ns ... bench:       157 ns/iter (+/- 4)\n```\n\nto\n\n```\ntest tests::bench_precise_time_ns ... bench:        38 ns/iter (+/- 3)\n```\n\nand it will get even faster once #14174 lands.", "tree": {"sha": "52938169b18421a54344649686e5b33a7f4e320e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/52938169b18421a54344649686e5b33a7f4e320e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8ef3e227198f6ff674b1626d0862c4112358c1a1", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8ef3e227198f6ff674b1626d0862c4112358c1a1", "html_url": "https://github.com/rust-lang/rust/commit/8ef3e227198f6ff674b1626d0862c4112358c1a1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8ef3e227198f6ff674b1626d0862c4112358c1a1/comments", "author": {"login": "lilyball", "id": 714, "node_id": "MDQ6VXNlcjcxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lilyball", "html_url": "https://github.com/lilyball", "followers_url": "https://api.github.com/users/lilyball/followers", "following_url": "https://api.github.com/users/lilyball/following{/other_user}", "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}", "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions", "organizations_url": "https://api.github.com/users/lilyball/orgs", "repos_url": "https://api.github.com/users/lilyball/repos", "events_url": "https://api.github.com/users/lilyball/events{/privacy}", "received_events_url": "https://api.github.com/users/lilyball/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lilyball", "id": 714, "node_id": "MDQ6VXNlcjcxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lilyball", "html_url": "https://github.com/lilyball", "followers_url": "https://api.github.com/users/lilyball/followers", "following_url": "https://api.github.com/users/lilyball/following{/other_user}", "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}", "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions", "organizations_url": "https://api.github.com/users/lilyball/orgs", "repos_url": "https://api.github.com/users/lilyball/repos", "events_url": "https://api.github.com/users/lilyball/events{/privacy}", "received_events_url": "https://api.github.com/users/lilyball/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "25c54226c3e7dd6f59cf2e92238a4d79d8b0128d", "url": "https://api.github.com/repos/rust-lang/rust/commits/25c54226c3e7dd6f59cf2e92238a4d79d8b0128d", "html_url": "https://github.com/rust-lang/rust/commit/25c54226c3e7dd6f59cf2e92238a4d79d8b0128d"}], "stats": {"total": 25, "additions": 20, "deletions": 5}, "files": [{"sha": "4ac4abe9063ef9662855ec4b8d444cf9a3223b09", "filename": "mk/crates.mk", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8ef3e227198f6ff674b1626d0862c4112358c1a1/mk%2Fcrates.mk", "raw_url": "https://github.com/rust-lang/rust/raw/8ef3e227198f6ff674b1626d0862c4112358c1a1/mk%2Fcrates.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fcrates.mk?ref=8ef3e227198f6ff674b1626d0862c4112358c1a1", "patch": "@@ -83,7 +83,7 @@ DEPS_fourcc := syntax std\n DEPS_hexfloat := syntax std\n DEPS_num := std rand\n DEPS_test := std collections getopts serialize term time regex\n-DEPS_time := std serialize\n+DEPS_time := std serialize sync\n DEPS_rand := std\n DEPS_url := std collections\n DEPS_workcache := std serialize collections log"}, {"sha": "812985dd199335b8b3ea0b0d795f48040a0e39e6", "filename": "src/libtime/lib.rs", "status": "modified", "additions": 19, "deletions": 4, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/8ef3e227198f6ff674b1626d0862c4112358c1a1/src%2Flibtime%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ef3e227198f6ff674b1626d0862c4112358c1a1/src%2Flibtime%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtime%2Flib.rs?ref=8ef3e227198f6ff674b1626d0862c4112358c1a1", "patch": "@@ -24,6 +24,8 @@\n #[cfg(test)] #[phase(syntax, link)] extern crate log;\n extern crate serialize;\n extern crate libc;\n+#[cfg(target_os = \"macos\")]\n+extern crate sync;\n \n use std::io::BufReader;\n use std::num;\n@@ -159,10 +161,16 @@ pub fn precise_time_ns() -> u64 {\n \n     #[cfg(target_os = \"macos\")]\n     fn os_precise_time_ns() -> u64 {\n-        let time = unsafe { imp::mach_absolute_time() };\n-        let mut info = libc::mach_timebase_info { numer: 0, denom: 0 };\n-        unsafe { imp::mach_timebase_info(&mut info); }\n-        return time * ((info.numer / info.denom) as u64);\n+        static mut TIMEBASE: libc::mach_timebase_info = libc::mach_timebase_info { numer: 0,\n+                                                                                   denom: 0 };\n+        static mut ONCE: sync::one::Once = sync::one::ONCE_INIT;\n+        unsafe {\n+            ONCE.doit(|| {\n+                imp::mach_timebase_info(&mut TIMEBASE);\n+            });\n+            let time = imp::mach_absolute_time();\n+            time * TIMEBASE.numer as u64 / TIMEBASE.denom as u64\n+        }\n     }\n \n     #[cfg(not(windows), not(target_os = \"macos\"))]\n@@ -1080,11 +1088,13 @@ pub fn strftime(format: &str, tm: &Tm) -> StrBuf {\n \n #[cfg(test)]\n mod tests {\n+    extern crate test;\n     use super::{Timespec, get_time, precise_time_ns, precise_time_s, tzset,\n                 at_utc, at, strptime};\n \n     use std::f64;\n     use std::result::{Err, Ok};\n+    use self::test::Bencher;\n \n     #[cfg(windows)]\n     fn set_time_zone() {\n@@ -1520,4 +1530,9 @@ mod tests {\n         test_strftime();\n         test_timespec_eq_ord();\n     }\n+\n+    #[bench]\n+    fn bench_precise_time_ns(b: &mut Bencher) {\n+        b.iter(|| precise_time_ns())\n+    }\n }"}]}