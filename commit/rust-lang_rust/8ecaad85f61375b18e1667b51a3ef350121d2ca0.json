{"sha": "8ecaad85f61375b18e1667b51a3ef350121d2ca0", "node_id": "C_kwDOAAsO6NoAKDhlY2FhZDg1ZjYxMzc1YjE4ZTE2NjdiNTFhM2VmMzUwMTIxZDJjYTA", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-11T08:50:38Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-11T08:50:38Z"}, "message": "Auto merge of #105919 - uweigand:s390x-stack-overflow, r=Nilstrieb\n\nFix stack overflow in recursive AST walk in early lint\n\nThe src/test/ui/issues/issue-74564-if-expr-stack-overflow.rs test case added to verify https://github.com/rust-lang/rust/issues/74564 still crashes with a stack overflow on s390x-ibm-linux.\n\nSymptom is a very deep recursion in compiler/rustc_lint/src/early.rs:\n    fn visit_expr(&mut self, e: &'a ast::Expr) {\n        self.with_lint_attrs(e.id, &e.attrs, |cx| {\n            lint_callback!(cx, check_expr, e);\n            ast_visit::walk_expr(cx, e);\n        })\n    }\n(where walk_expr recursively calls back into visit_expr).  The crash happens at a nesting depth of over 17000 stack frames when using the default 8 MB stack size on s390x.\n\nThis patch fixes the problem by adding a ensure_sufficient_stack call to the with_lint_attrs routine (which also should take care of all the other mutually recursive visitors here).\n\nFixes part of https://github.com/rust-lang/rust/issues/105383.", "tree": {"sha": "86486584ce6a8c1aeca6d135f3680209f5e5eea1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/86486584ce6a8c1aeca6d135f3680209f5e5eea1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8ecaad85f61375b18e1667b51a3ef350121d2ca0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8ecaad85f61375b18e1667b51a3ef350121d2ca0", "html_url": "https://github.com/rust-lang/rust/commit/8ecaad85f61375b18e1667b51a3ef350121d2ca0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8ecaad85f61375b18e1667b51a3ef350121d2ca0/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ca855e6e42787ecd062d81d53336fe6788ef51a9", "url": "https://api.github.com/repos/rust-lang/rust/commits/ca855e6e42787ecd062d81d53336fe6788ef51a9", "html_url": "https://github.com/rust-lang/rust/commit/ca855e6e42787ecd062d81d53336fe6788ef51a9"}, {"sha": "6bb2bda23eb0ced0375ebd119454f8e95dc36db8", "url": "https://api.github.com/repos/rust-lang/rust/commits/6bb2bda23eb0ced0375ebd119454f8e95dc36db8", "html_url": "https://github.com/rust-lang/rust/commit/6bb2bda23eb0ced0375ebd119454f8e95dc36db8"}], "stats": {"total": 3, "additions": 2, "deletions": 1}, "files": [{"sha": "d757471dceed9e5f0e0dba9484de5c83c203ed2e", "filename": "compiler/rustc_lint/src/early.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/8ecaad85f61375b18e1667b51a3ef350121d2ca0/compiler%2Frustc_lint%2Fsrc%2Fearly.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ecaad85f61375b18e1667b51a3ef350121d2ca0/compiler%2Frustc_lint%2Fsrc%2Fearly.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fearly.rs?ref=8ecaad85f61375b18e1667b51a3ef350121d2ca0", "patch": "@@ -19,6 +19,7 @@ use crate::passes::{EarlyLintPass, EarlyLintPassObject};\n use rustc_ast::ptr::P;\n use rustc_ast::visit::{self as ast_visit, Visitor};\n use rustc_ast::{self as ast, walk_list, HasAttrs};\n+use rustc_data_structures::stack::ensure_sufficient_stack;\n use rustc_middle::ty::RegisteredTools;\n use rustc_session::lint::{BufferedEarlyLint, LintBuffer, LintPass};\n use rustc_session::Session;\n@@ -71,7 +72,7 @@ impl<'a, T: EarlyLintPass> EarlyContextAndPass<'a, T> {\n         self.inlined_check_id(id);\n         debug!(\"early context: enter_attrs({:?})\", attrs);\n         lint_callback!(self, enter_lint_attrs, attrs);\n-        f(self);\n+        ensure_sufficient_stack(|| f(self));\n         debug!(\"early context: exit_attrs({:?})\", attrs);\n         lint_callback!(self, exit_lint_attrs, attrs);\n         self.context.builder.pop(push);"}]}