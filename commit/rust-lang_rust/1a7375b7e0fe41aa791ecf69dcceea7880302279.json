{"sha": "1a7375b7e0fe41aa791ecf69dcceea7880302279", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFhNzM3NWI3ZTBmZTQxYWE3OTFlY2Y2OWRjY2VlYTc4ODAzMDIyNzk=", "commit": {"author": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2017-03-23T21:57:29Z"}, "committer": {"name": "QuietMisdreavus", "email": "grey@quietmisdreavus.net", "date": "2017-05-16T21:25:57Z"}, "message": "Add an option to run rustbuild on low priority\n\nThis is a resurrection of #40776, combining their Windows setup with an\nadditional setup on Unix to set the program group's niceness to +10\n(low-but-not-lowest priority) when the `low_priority` option is on.", "tree": {"sha": "eca7b4391da7793c7e53b2b291d07e2d13d6adfb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eca7b4391da7793c7e53b2b291d07e2d13d6adfb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1a7375b7e0fe41aa791ecf69dcceea7880302279", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1a7375b7e0fe41aa791ecf69dcceea7880302279", "html_url": "https://github.com/rust-lang/rust/commit/1a7375b7e0fe41aa791ecf69dcceea7880302279", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1a7375b7e0fe41aa791ecf69dcceea7880302279/comments", "author": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "QuietMisdreavus", "id": 5217170, "node_id": "MDQ6VXNlcjUyMTcxNzA=", "avatar_url": "https://avatars.githubusercontent.com/u/5217170?v=4", "gravatar_id": "", "url": "https://api.github.com/users/QuietMisdreavus", "html_url": "https://github.com/QuietMisdreavus", "followers_url": "https://api.github.com/users/QuietMisdreavus/followers", "following_url": "https://api.github.com/users/QuietMisdreavus/following{/other_user}", "gists_url": "https://api.github.com/users/QuietMisdreavus/gists{/gist_id}", "starred_url": "https://api.github.com/users/QuietMisdreavus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/QuietMisdreavus/subscriptions", "organizations_url": "https://api.github.com/users/QuietMisdreavus/orgs", "repos_url": "https://api.github.com/users/QuietMisdreavus/repos", "events_url": "https://api.github.com/users/QuietMisdreavus/events{/privacy}", "received_events_url": "https://api.github.com/users/QuietMisdreavus/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4d09a0eb5d201c831d19f3fe93fbe636eca7d97d", "url": "https://api.github.com/repos/rust-lang/rust/commits/4d09a0eb5d201c831d19f3fe93fbe636eca7d97d", "html_url": "https://github.com/rust-lang/rust/commit/4d09a0eb5d201c831d19f3fe93fbe636eca7d97d"}], "stats": {"total": 44, "additions": 40, "deletions": 4}, "files": [{"sha": "4f750945b72919e33d87ac6d22cdddd10201a435", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1a7375b7e0fe41aa791ecf69dcceea7880302279/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a7375b7e0fe41aa791ecf69dcceea7880302279/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=1a7375b7e0fe41aa791ecf69dcceea7880302279", "patch": "@@ -94,6 +94,7 @@ pub struct Config {\n     pub backtrace: bool, // support for RUST_BACKTRACE\n \n     // misc\n+    pub low_priority: bool,\n     pub channel: String,\n     pub quiet_tests: bool,\n     // Fallback musl-root for all targets\n@@ -146,6 +147,7 @@ struct Build {\n     target: Vec<String>,\n     cargo: Option<String>,\n     rustc: Option<String>,\n+    low_priority: Option<bool>,\n     compiler_docs: Option<bool>,\n     docs: Option<bool>,\n     submodules: Option<bool>,\n@@ -302,6 +304,7 @@ impl Config {\n         config.nodejs = build.nodejs.map(PathBuf::from);\n         config.gdb = build.gdb.map(PathBuf::from);\n         config.python = build.python.map(PathBuf::from);\n+        set(&mut config.low_priority, build.low_priority);\n         set(&mut config.compiler_docs, build.compiler_docs);\n         set(&mut config.docs, build.docs);\n         set(&mut config.submodules, build.submodules);"}, {"sha": "52937e6ac9b228aad88a9b98b5771e3543beb338", "filename": "src/bootstrap/config.toml.example", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1a7375b7e0fe41aa791ecf69dcceea7880302279/src%2Fbootstrap%2Fconfig.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/1a7375b7e0fe41aa791ecf69dcceea7880302279/src%2Fbootstrap%2Fconfig.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.toml.example?ref=1a7375b7e0fe41aa791ecf69dcceea7880302279", "patch": "@@ -152,6 +152,9 @@\n # known-good version of OpenSSL, compile it, and link it to Cargo.\n #openssl-static = false\n \n+# Run the build with low priority\n+#low_priority = false\n+\n # =============================================================================\n # General install configuration options\n # ============================================================================="}, {"sha": "72a5d1338b8d05b1067f36e7c9998e6a29b43fd8", "filename": "src/bootstrap/job.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/1a7375b7e0fe41aa791ecf69dcceea7880302279/src%2Fbootstrap%2Fjob.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a7375b7e0fe41aa791ecf69dcceea7880302279/src%2Fbootstrap%2Fjob.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fjob.rs?ref=1a7375b7e0fe41aa791ecf69dcceea7880302279", "patch": "@@ -42,6 +42,7 @@\n use std::env;\n use std::io;\n use std::mem;\n+use Build;\n \n type HANDLE = *mut u8;\n type BOOL = i32;\n@@ -60,8 +61,10 @@ const DUPLICATE_SAME_ACCESS: DWORD = 0x2;\n const PROCESS_DUP_HANDLE: DWORD = 0x40;\n const JobObjectExtendedLimitInformation: JOBOBJECTINFOCLASS = 9;\n const JOB_OBJECT_LIMIT_KILL_ON_JOB_CLOSE: DWORD = 0x2000;\n+const JOB_OBJECT_LIMIT_PRIORITY_CLASS: DWORD = 0x00000020;\n const SEM_FAILCRITICALERRORS: UINT = 0x0001;\n const SEM_NOGPFAULTERRORBOX: UINT = 0x0002;\n+const BELOW_NORMAL_PRIORITY_CLASS: DWORD = 0x00004000;\n \n extern \"system\" {\n     fn CreateJobObjectW(lpJobAttributes: *mut u8, lpName: *const u8) -> HANDLE;\n@@ -118,7 +121,7 @@ struct JOBOBJECT_BASIC_LIMIT_INFORMATION {\n     SchedulingClass: DWORD,\n }\n \n-pub unsafe fn setup() {\n+pub unsafe fn setup(build: &mut Build) {\n     // Tell Windows to not show any UI on errors (such as not finding a required dll\n     // during startup or terminating abnormally).  This is important for running tests,\n     // since some of them use abnormal termination by design.\n@@ -136,6 +139,10 @@ pub unsafe fn setup() {\n     // children will reside in the job by default.\n     let mut info = mem::zeroed::<JOBOBJECT_EXTENDED_LIMIT_INFORMATION>();\n     info.BasicLimitInformation.LimitFlags = JOB_OBJECT_LIMIT_KILL_ON_JOB_CLOSE;\n+    if build.config.low_priority {\n+        info.BasicLimitInformation.LimitFlags |= JOB_OBJECT_LIMIT_PRIORITY_CLASS;\n+        info.BasicLimitInformation.PriorityClass = BELOW_NORMAL_PRIORITY_CLASS;\n+    }\n     let r = SetInformationJobObject(job,\n                                     JobObjectExtendedLimitInformation,\n                                     &mut info as *mut _ as LPVOID,"}, {"sha": "a9f53cda7ed2636f03adeca707d07daf1a183881", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 26, "deletions": 3, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/1a7375b7e0fe41aa791ecf69dcceea7880302279/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a7375b7e0fe41aa791ecf69dcceea7880302279/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=1a7375b7e0fe41aa791ecf69dcceea7880302279", "patch": "@@ -76,6 +76,9 @@ extern crate num_cpus;\n extern crate rustc_serialize;\n extern crate toml;\n \n+#[cfg(unix)]\n+extern crate libc;\n+\n use std::cmp;\n use std::collections::HashMap;\n use std::env;\n@@ -108,9 +111,29 @@ pub mod util;\n #[cfg(windows)]\n mod job;\n \n-#[cfg(not(windows))]\n+#[cfg(unix)]\n mod job {\n-    pub unsafe fn setup() {}\n+    use libc;\n+\n+    //apparently glibc defines their own enum for this parameter, in a different type\n+    #[cfg(not(any(target_env = \"musl\", target_env = \"musleabi\", target_env = \"musleabihf\",\n+                  target_os = \"emscripten\", target_arch = \"mips\", target_arch = \"mipsel\")))]\n+    const PRIO_PGRP: libc::c_uint = libc::PRIO_PGRP as libc::c_uint;\n+    #[cfg(any(target_env = \"musl\", target_env = \"musleabi\", target_env = \"musleabihf\",\n+              target_os = \"emscripten\", target_arch = \"mips\", target_arch = \"mipsel\"))]\n+    const PRIO_PGRP: libc::c_int = libc::PRIO_PGRP;\n+\n+    pub unsafe fn setup(build: &mut ::Build) {\n+        if build.config.low_priority {\n+            libc::setpriority(PRIO_PGRP, 0, 10);\n+        }\n+    }\n+}\n+\n+#[cfg(not(any(unix, windows)))]\n+mod job {\n+    pub unsafe fn setup(_build: &mut ::Build) {\n+    }\n }\n \n pub use config::Config;\n@@ -263,7 +286,7 @@ impl Build {\n     /// Executes the entire build, as configured by the flags and configuration.\n     pub fn build(&mut self) {\n         unsafe {\n-            job::setup();\n+            job::setup(self);\n         }\n \n         if let Subcommand::Clean = self.flags.cmd {"}]}