{"sha": "5161c4ce4d9af10b66fdb9c4daac81590848f6a1", "node_id": "C_kwDOAAsO6NoAKDUxNjFjNGNlNGQ5YWYxMGI2NmZkYjljNGRhYWM4MTU5MDg0OGY2YTE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-24T06:25:52Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-24T06:25:52Z"}, "message": "Auto merge of #10697 - lochetti:fix_9757, r=dswij\n\nIgnore `shadow` warns in code from macro expansions\n\nThis PR fixes https://github.com/rust-lang/rust-clippy/issues/9757\n\nI am in doubt if just looking for `pat.span.from_expansion()` would be sufficient instead of looking for both `pat.span.desugaring_kind().is_some()` or `pat.span.from_expansion()`. The tests (including the new one) passes if I leave the only `if pat.span.from_expansion()`. Any feedbacks?\n\nAlso, this is my first PR here, sorry for anything and thanks for the patience!\n\nchangelog: [`shadow_same`, `shadow_reuse`, `shadow_unrelated`]: avoiding warns in macro-generated code", "tree": {"sha": "94de935d66acb290f05b0c52c96323f68284b852", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/94de935d66acb290f05b0c52c96323f68284b852"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5161c4ce4d9af10b66fdb9c4daac81590848f6a1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5161c4ce4d9af10b66fdb9c4daac81590848f6a1", "html_url": "https://github.com/rust-lang/rust/commit/5161c4ce4d9af10b66fdb9c4daac81590848f6a1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5161c4ce4d9af10b66fdb9c4daac81590848f6a1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "96f8471d81a72e74d0791781906426353fe835a6", "url": "https://api.github.com/repos/rust-lang/rust/commits/96f8471d81a72e74d0791781906426353fe835a6", "html_url": "https://github.com/rust-lang/rust/commit/96f8471d81a72e74d0791781906426353fe835a6"}, {"sha": "628605e07a2a9a546ba698f1a50311b16832f227", "url": "https://api.github.com/repos/rust-lang/rust/commits/628605e07a2a9a546ba698f1a50311b16832f227", "html_url": "https://github.com/rust-lang/rust/commit/628605e07a2a9a546ba698f1a50311b16832f227"}], "stats": {"total": 106, "additions": 59, "deletions": 47}, "files": [{"sha": "993f9373d85d351ff8f2e4931c764fcc2554d4eb", "filename": "clippy_lints/src/shadow.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5161c4ce4d9af10b66fdb9c4daac81590848f6a1/clippy_lints%2Fsrc%2Fshadow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5161c4ce4d9af10b66fdb9c4daac81590848f6a1/clippy_lints%2Fsrc%2Fshadow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fshadow.rs?ref=5161c4ce4d9af10b66fdb9c4daac81590848f6a1", "patch": "@@ -108,7 +108,7 @@ impl<'tcx> LateLintPass<'tcx> for Shadow {\n     fn check_pat(&mut self, cx: &LateContext<'tcx>, pat: &'tcx Pat<'_>) {\n         let PatKind::Binding(_, id, ident, _) = pat.kind else { return };\n \n-        if pat.span.desugaring_kind().is_some() {\n+        if pat.span.desugaring_kind().is_some() || pat.span.from_expansion() {\n             return;\n         }\n "}, {"sha": "2c0fc3e3fd83ffb8bdd090599162478abb36c01f", "filename": "tests/ui/shadow.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5161c4ce4d9af10b66fdb9c4daac81590848f6a1/tests%2Fui%2Fshadow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5161c4ce4d9af10b66fdb9c4daac81590848f6a1/tests%2Fui%2Fshadow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fshadow.rs?ref=5161c4ce4d9af10b66fdb9c4daac81590848f6a1", "patch": "@@ -8,6 +8,12 @@ extern crate proc_macro_derive;\n #[derive(proc_macro_derive::ShadowDerive)]\n pub struct Nothing;\n \n+macro_rules! reuse {\n+    ($v:ident) => {\n+        let $v = $v + 1;\n+    };\n+}\n+\n fn shadow_same() {\n     let x = 1;\n     let x = x;\n@@ -33,6 +39,12 @@ fn shadow_reuse() -> Option<()> {\n     None\n }\n \n+fn shadow_reuse_macro() {\n+    let x = 1;\n+    // this should not warn\n+    reuse!(x);\n+}\n+\n fn shadow_unrelated() {\n     let x = 1;\n     let x = 2;"}, {"sha": "8321f6df224cf8444d39605c81ee3b8b122225a1", "filename": "tests/ui/shadow.stderr", "status": "modified", "additions": 46, "deletions": 46, "changes": 92, "blob_url": "https://github.com/rust-lang/rust/blob/5161c4ce4d9af10b66fdb9c4daac81590848f6a1/tests%2Fui%2Fshadow.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5161c4ce4d9af10b66fdb9c4daac81590848f6a1/tests%2Fui%2Fshadow.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fshadow.stderr?ref=5161c4ce4d9af10b66fdb9c4daac81590848f6a1", "patch": "@@ -1,278 +1,278 @@\n error: `x` is shadowed by itself in `x`\n-  --> $DIR/shadow.rs:13:9\n+  --> $DIR/shadow.rs:19:9\n    |\n LL |     let x = x;\n    |         ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:12:9\n+  --> $DIR/shadow.rs:18:9\n    |\n LL |     let x = 1;\n    |         ^\n    = note: `-D clippy::shadow-same` implied by `-D warnings`\n \n error: `mut x` is shadowed by itself in `&x`\n-  --> $DIR/shadow.rs:14:13\n+  --> $DIR/shadow.rs:20:13\n    |\n LL |     let mut x = &x;\n    |             ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:13:9\n+  --> $DIR/shadow.rs:19:9\n    |\n LL |     let x = x;\n    |         ^\n \n error: `x` is shadowed by itself in `&mut x`\n-  --> $DIR/shadow.rs:15:9\n+  --> $DIR/shadow.rs:21:9\n    |\n LL |     let x = &mut x;\n    |         ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:14:9\n+  --> $DIR/shadow.rs:20:9\n    |\n LL |     let mut x = &x;\n    |         ^^^^^\n \n error: `x` is shadowed by itself in `*x`\n-  --> $DIR/shadow.rs:16:9\n+  --> $DIR/shadow.rs:22:9\n    |\n LL |     let x = *x;\n    |         ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:15:9\n+  --> $DIR/shadow.rs:21:9\n    |\n LL |     let x = &mut x;\n    |         ^\n \n error: `x` is shadowed\n-  --> $DIR/shadow.rs:21:9\n+  --> $DIR/shadow.rs:27:9\n    |\n LL |     let x = x.0;\n    |         ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:20:9\n+  --> $DIR/shadow.rs:26:9\n    |\n LL |     let x = ([[0]], ());\n    |         ^\n    = note: `-D clippy::shadow-reuse` implied by `-D warnings`\n \n error: `x` is shadowed\n-  --> $DIR/shadow.rs:22:9\n+  --> $DIR/shadow.rs:28:9\n    |\n LL |     let x = x[0];\n    |         ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:21:9\n+  --> $DIR/shadow.rs:27:9\n    |\n LL |     let x = x.0;\n    |         ^\n \n error: `x` is shadowed\n-  --> $DIR/shadow.rs:23:10\n+  --> $DIR/shadow.rs:29:10\n    |\n LL |     let [x] = x;\n    |          ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:22:9\n+  --> $DIR/shadow.rs:28:9\n    |\n LL |     let x = x[0];\n    |         ^\n \n error: `x` is shadowed\n-  --> $DIR/shadow.rs:24:9\n+  --> $DIR/shadow.rs:30:9\n    |\n LL |     let x = Some(x);\n    |         ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:23:10\n+  --> $DIR/shadow.rs:29:10\n    |\n LL |     let [x] = x;\n    |          ^\n \n error: `x` is shadowed\n-  --> $DIR/shadow.rs:25:9\n+  --> $DIR/shadow.rs:31:9\n    |\n LL |     let x = foo(x);\n    |         ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:24:9\n+  --> $DIR/shadow.rs:30:9\n    |\n LL |     let x = Some(x);\n    |         ^\n \n error: `x` is shadowed\n-  --> $DIR/shadow.rs:26:9\n+  --> $DIR/shadow.rs:32:9\n    |\n LL |     let x = || x;\n    |         ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:25:9\n+  --> $DIR/shadow.rs:31:9\n    |\n LL |     let x = foo(x);\n    |         ^\n \n error: `x` is shadowed\n-  --> $DIR/shadow.rs:27:9\n+  --> $DIR/shadow.rs:33:9\n    |\n LL |     let x = Some(1).map(|_| x)?;\n    |         ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:26:9\n+  --> $DIR/shadow.rs:32:9\n    |\n LL |     let x = || x;\n    |         ^\n \n error: `y` is shadowed\n-  --> $DIR/shadow.rs:29:9\n+  --> $DIR/shadow.rs:35:9\n    |\n LL |     let y = match y {\n    |         ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:28:9\n+  --> $DIR/shadow.rs:34:9\n    |\n LL |     let y = 1;\n    |         ^\n \n error: `x` shadows a previous, unrelated binding\n-  --> $DIR/shadow.rs:38:9\n+  --> $DIR/shadow.rs:50:9\n    |\n LL |     let x = 2;\n    |         ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:37:9\n+  --> $DIR/shadow.rs:49:9\n    |\n LL |     let x = 1;\n    |         ^\n    = note: `-D clippy::shadow-unrelated` implied by `-D warnings`\n \n error: `x` shadows a previous, unrelated binding\n-  --> $DIR/shadow.rs:43:13\n+  --> $DIR/shadow.rs:55:13\n    |\n LL |         let x = 1;\n    |             ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:42:10\n+  --> $DIR/shadow.rs:54:10\n    |\n LL |     fn f(x: u32) {\n    |          ^\n \n error: `x` shadows a previous, unrelated binding\n-  --> $DIR/shadow.rs:48:14\n+  --> $DIR/shadow.rs:60:14\n    |\n LL |         Some(x) => {\n    |              ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:45:9\n+  --> $DIR/shadow.rs:57:9\n    |\n LL |     let x = 1;\n    |         ^\n \n error: `x` shadows a previous, unrelated binding\n-  --> $DIR/shadow.rs:49:17\n+  --> $DIR/shadow.rs:61:17\n    |\n LL |             let x = 1;\n    |                 ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:48:14\n+  --> $DIR/shadow.rs:60:14\n    |\n LL |         Some(x) => {\n    |              ^\n \n error: `x` shadows a previous, unrelated binding\n-  --> $DIR/shadow.rs:53:17\n+  --> $DIR/shadow.rs:65:17\n    |\n LL |     if let Some(x) = Some(1) {}\n    |                 ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:45:9\n+  --> $DIR/shadow.rs:57:9\n    |\n LL |     let x = 1;\n    |         ^\n \n error: `x` shadows a previous, unrelated binding\n-  --> $DIR/shadow.rs:54:20\n+  --> $DIR/shadow.rs:66:20\n    |\n LL |     while let Some(x) = Some(1) {}\n    |                    ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:45:9\n+  --> $DIR/shadow.rs:57:9\n    |\n LL |     let x = 1;\n    |         ^\n \n error: `x` shadows a previous, unrelated binding\n-  --> $DIR/shadow.rs:55:15\n+  --> $DIR/shadow.rs:67:15\n    |\n LL |     let _ = |[x]: [u32; 1]| {\n    |               ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:45:9\n+  --> $DIR/shadow.rs:57:9\n    |\n LL |     let x = 1;\n    |         ^\n \n error: `x` shadows a previous, unrelated binding\n-  --> $DIR/shadow.rs:56:13\n+  --> $DIR/shadow.rs:68:13\n    |\n LL |         let x = 1;\n    |             ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:55:15\n+  --> $DIR/shadow.rs:67:15\n    |\n LL |     let _ = |[x]: [u32; 1]| {\n    |               ^\n \n error: `y` is shadowed\n-  --> $DIR/shadow.rs:59:17\n+  --> $DIR/shadow.rs:71:17\n    |\n LL |     if let Some(y) = y {}\n    |                 ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:58:9\n+  --> $DIR/shadow.rs:70:9\n    |\n LL |     let y = Some(1);\n    |         ^\n \n error: `_b` shadows a previous, unrelated binding\n-  --> $DIR/shadow.rs:95:9\n+  --> $DIR/shadow.rs:107:9\n    |\n LL |     let _b = _a;\n    |         ^^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:94:28\n+  --> $DIR/shadow.rs:106:28\n    |\n LL | pub async fn foo2(_a: i32, _b: i64) {\n    |                            ^^\n \n error: `x` shadows a previous, unrelated binding\n-  --> $DIR/shadow.rs:101:21\n+  --> $DIR/shadow.rs:113:21\n    |\n LL |         if let Some(x) = Some(1) { x } else { 1 }\n    |                     ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:100:13\n+  --> $DIR/shadow.rs:112:13\n    |\n LL |         let x = 1;\n    |             ^"}]}