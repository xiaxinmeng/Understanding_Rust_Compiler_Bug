{"sha": "b9151b2d7014149be2acdea29ae9fa272dd11583", "node_id": "C_kwDOAAsO6NoAKGI5MTUxYjJkNzAxNDE0OWJlMmFjZGVhMjlhZTlmYTI3MmRkMTE1ODM", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2023-03-22T18:30:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-03-22T18:30:34Z"}, "message": "Rollup merge of #109405 - compiler-errors:rpitit-as-opaques, r=spastorino\n\nRPITITs are `DefKind::Opaque` with new lowering strategy\n\nr? `@spastorino`\n\nKinda cherry-picked #109400", "tree": {"sha": "b86785363525b10cad32a5251a7efa1edcd6e8ec", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b86785363525b10cad32a5251a7efa1edcd6e8ec"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b9151b2d7014149be2acdea29ae9fa272dd11583", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkG0lKCRBK7hj4Ov3rIwAAHA0IAEO0k08gbPg6eLzm4EEpP38Z\nxNNV76+d6zmLmRBNAZNubyafRXDeDVRhLaSQa5DdOZXJ57JsEDFjdLfgii9L0cc0\nYp4sRyotvZRNwdRu8iJFjiYCRrgZbpvSkcLi1x/Ygjr8ByGADZGH+QnABWRLQH58\nElAkQcd05lVxX/7VyM4hLcNYx9nI0g2/sn6vzS4DPo4AYxD09b6nxlEcxp05fbqw\nHXnaiXWCPLPQABBxuUkpjSCz9ZQs4AEQRNtTkAceiD81ZyNo5VDrs3CL4Dsy5COC\nosx/NRD/yy4G+LRWVakj1vBwVgs+dtdAoSQNbQfDfAPqgKOHJLsZRRjX0w9VNZU=\n=uC/O\n-----END PGP SIGNATURE-----\n", "payload": "tree b86785363525b10cad32a5251a7efa1edcd6e8ec\nparent 8ce52b7b65927c83189175e2488a3047201a5e8c\nparent c3e6f689312872ac9859b18230c6323ab27fbd7f\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1679509834 +0530\ncommitter GitHub <noreply@github.com> 1679509834 +0530\n\nRollup merge of #109405 - compiler-errors:rpitit-as-opaques, r=spastorino\n\nRPITITs are `DefKind::Opaque` with new lowering strategy\n\nr? `@spastorino`\n\nKinda cherry-picked #109400\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b9151b2d7014149be2acdea29ae9fa272dd11583", "html_url": "https://github.com/rust-lang/rust/commit/b9151b2d7014149be2acdea29ae9fa272dd11583", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b9151b2d7014149be2acdea29ae9fa272dd11583/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8ce52b7b65927c83189175e2488a3047201a5e8c", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ce52b7b65927c83189175e2488a3047201a5e8c", "html_url": "https://github.com/rust-lang/rust/commit/8ce52b7b65927c83189175e2488a3047201a5e8c"}, {"sha": "c3e6f689312872ac9859b18230c6323ab27fbd7f", "url": "https://api.github.com/repos/rust-lang/rust/commits/c3e6f689312872ac9859b18230c6323ab27fbd7f", "html_url": "https://github.com/rust-lang/rust/commit/c3e6f689312872ac9859b18230c6323ab27fbd7f"}], "stats": {"total": 61, "additions": 45, "deletions": 16}, "files": [{"sha": "d8dda7a93be1369d36d13c9e718b6c3d74168cf7", "filename": "compiler/rustc_hir_analysis/src/check/check.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/b9151b2d7014149be2acdea29ae9fa272dd11583/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9151b2d7014149be2acdea29ae9fa272dd11583/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcheck.rs?ref=b9151b2d7014149be2acdea29ae9fa272dd11583", "patch": "@@ -305,7 +305,7 @@ pub(super) fn check_opaque_for_inheriting_lifetimes(\n     }) = item.kind\n     {\n         let substs = InternalSubsts::identity_for_item(tcx, def_id);\n-        let opaque_identity_ty = if in_trait {\n+        let opaque_identity_ty = if in_trait && !tcx.lower_impl_trait_in_trait_to_assoc_ty() {\n             tcx.mk_projection(def_id.to_def_id(), substs)\n         } else {\n             tcx.mk_opaque(def_id.to_def_id(), substs)\n@@ -554,7 +554,15 @@ fn check_item_type(tcx: TyCtxt<'_>, id: hir::ItemId) {\n             check_union(tcx, id.owner_id.def_id);\n         }\n         DefKind::OpaqueTy => {\n-            check_opaque(tcx, id);\n+            let opaque = tcx.hir().expect_item(id.owner_id.def_id).expect_opaque_ty();\n+            if let hir::OpaqueTyOrigin::FnReturn(fn_def_id) | hir::OpaqueTyOrigin::AsyncFn(fn_def_id) = opaque.origin\n+                && let hir::Node::TraitItem(trait_item) = tcx.hir().get_by_def_id(fn_def_id)\n+                && let (_, hir::TraitFn::Required(..)) = trait_item.expect_fn()\n+            {\n+                // Skip opaques from RPIT in traits with no default body.\n+            } else {\n+                check_opaque(tcx, id);\n+            }\n         }\n         DefKind::ImplTraitPlaceholder => {\n             let parent = tcx.impl_trait_in_trait_parent_fn(id.owner_id.to_def_id());"}, {"sha": "4dd433a50a73b7f984207b9be1702626cc1b101c", "filename": "compiler/rustc_metadata/src/rmeta/encoder.rs", "status": "modified", "additions": 19, "deletions": 2, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/b9151b2d7014149be2acdea29ae9fa272dd11583/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9151b2d7014149be2acdea29ae9fa272dd11583/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs?ref=b9151b2d7014149be2acdea29ae9fa272dd11583", "patch": "@@ -1016,7 +1016,6 @@ fn should_encode_type(tcx: TyCtxt<'_>, def_id: LocalDefId, def_kind: DefKind) ->\n         | DefKind::Const\n         | DefKind::Static(..)\n         | DefKind::TyAlias\n-        | DefKind::OpaqueTy\n         | DefKind::ForeignTy\n         | DefKind::Impl { .. }\n         | DefKind::AssocFn\n@@ -1027,6 +1026,18 @@ fn should_encode_type(tcx: TyCtxt<'_>, def_id: LocalDefId, def_kind: DefKind) ->\n         | DefKind::AnonConst\n         | DefKind::InlineConst => true,\n \n+        DefKind::OpaqueTy => {\n+            let opaque = tcx.hir().expect_item(def_id).expect_opaque_ty();\n+            if let hir::OpaqueTyOrigin::FnReturn(fn_def_id) | hir::OpaqueTyOrigin::AsyncFn(fn_def_id) = opaque.origin\n+                && let hir::Node::TraitItem(trait_item) = tcx.hir().get_by_def_id(fn_def_id)\n+                && let (_, hir::TraitFn::Required(..)) = trait_item.expect_fn()\n+            {\n+                false\n+            } else {\n+                true\n+            }\n+        }\n+\n         DefKind::ImplTraitPlaceholder => {\n             let parent_def_id = tcx.impl_trait_in_trait_parent_fn(def_id.to_def_id());\n             let assoc_item = tcx.associated_item(parent_def_id);\n@@ -1044,7 +1055,13 @@ fn should_encode_type(tcx: TyCtxt<'_>, def_id: LocalDefId, def_kind: DefKind) ->\n             let assoc_item = tcx.associated_item(def_id);\n             match assoc_item.container {\n                 ty::AssocItemContainer::ImplContainer => true,\n-                ty::AssocItemContainer::TraitContainer => assoc_item.defaultness(tcx).has_value(),\n+                // FIXME(-Zlower-impl-trait-in-trait-to-assoc-ty) always encode RPITITs,\n+                // since we need to be able to \"project\" from an RPITIT associated item\n+                // to an opaque when installing the default projection predicates in\n+                // default trait methods with RPITITs.\n+                ty::AssocItemContainer::TraitContainer => {\n+                    assoc_item.defaultness(tcx).has_value() || assoc_item.opt_rpitit_info.is_some()\n+                }\n             }\n         }\n         DefKind::TyParam => {"}, {"sha": "89a485b47ca8c03318187d27258db4a486eb3304", "filename": "compiler/rustc_middle/src/hir/map/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b9151b2d7014149be2acdea29ae9fa272dd11583/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9151b2d7014149be2acdea29ae9fa272dd11583/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs?ref=b9151b2d7014149be2acdea29ae9fa272dd11583", "patch": "@@ -188,7 +188,7 @@ impl<'hir> Map<'hir> {\n                 ItemKind::Macro(_, macro_kind) => DefKind::Macro(macro_kind),\n                 ItemKind::Mod(..) => DefKind::Mod,\n                 ItemKind::OpaqueTy(ref opaque) => {\n-                    if opaque.in_trait {\n+                    if opaque.in_trait && !self.tcx.lower_impl_trait_in_trait_to_assoc_ty() {\n                         DefKind::ImplTraitPlaceholder\n                     } else {\n                         DefKind::OpaqueTy"}, {"sha": "562f5bffba315fb83e48c095af8f857259af6ca0", "filename": "compiler/rustc_ty_utils/src/assoc.rs", "status": "modified", "additions": 13, "deletions": 11, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/b9151b2d7014149be2acdea29ae9fa272dd11583/compiler%2Frustc_ty_utils%2Fsrc%2Fassoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9151b2d7014149be2acdea29ae9fa272dd11583/compiler%2Frustc_ty_utils%2Fsrc%2Fassoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Fassoc.rs?ref=b9151b2d7014149be2acdea29ae9fa272dd11583", "patch": "@@ -254,13 +254,16 @@ fn associated_type_for_impl_trait_in_trait(\n     tcx: TyCtxt<'_>,\n     opaque_ty_def_id: LocalDefId,\n ) -> LocalDefId {\n-    let fn_def_id = tcx.impl_trait_in_trait_parent_fn(opaque_ty_def_id.to_def_id());\n-    let trait_def_id = tcx.parent(fn_def_id);\n+    let (hir::OpaqueTyOrigin::FnReturn(fn_def_id) | hir::OpaqueTyOrigin::AsyncFn(fn_def_id)) =\n+        tcx.hir().expect_item(opaque_ty_def_id).expect_opaque_ty().origin\n+    else {\n+        bug!(\"expected opaque for {opaque_ty_def_id:?}\");\n+    };\n+    let trait_def_id = tcx.local_parent(fn_def_id);\n     assert_eq!(tcx.def_kind(trait_def_id), DefKind::Trait);\n \n     let span = tcx.def_span(opaque_ty_def_id);\n-    let trait_assoc_ty =\n-        tcx.at(span).create_def(trait_def_id.expect_local(), DefPathData::ImplTraitAssocTy);\n+    let trait_assoc_ty = tcx.at(span).create_def(trait_def_id, DefPathData::ImplTraitAssocTy);\n \n     let local_def_id = trait_assoc_ty.def_id();\n     let def_id = local_def_id.to_def_id();\n@@ -282,7 +285,7 @@ fn associated_type_for_impl_trait_in_trait(\n         container: ty::TraitContainer,\n         fn_has_self_parameter: false,\n         opt_rpitit_info: Some(ImplTraitInTraitData::Trait {\n-            fn_def_id,\n+            fn_def_id: fn_def_id.to_def_id(),\n             opaque_def_id: opaque_ty_def_id.to_def_id(),\n         }),\n     });\n@@ -324,7 +327,7 @@ fn associated_type_for_impl_trait_in_trait(\n             params.iter().map(|param| (param.def_id, param.index)).collect();\n \n         ty::Generics {\n-            parent: Some(trait_def_id),\n+            parent: Some(trait_def_id.to_def_id()),\n             parent_count,\n             params,\n             param_def_id_to_index,\n@@ -335,7 +338,7 @@ fn associated_type_for_impl_trait_in_trait(\n \n     // There are no predicates for the synthesized associated type.\n     trait_assoc_ty.explicit_predicates_of(ty::GenericPredicates {\n-        parent: Some(trait_def_id),\n+        parent: Some(trait_def_id.to_def_id()),\n         predicates: &[],\n     });\n \n@@ -356,7 +359,6 @@ fn associated_type_for_impl_trait_in_impl(\n     impl_fn_def_id: LocalDefId,\n ) -> LocalDefId {\n     let impl_local_def_id = tcx.local_parent(impl_fn_def_id);\n-    let impl_def_id = impl_local_def_id.to_def_id();\n \n     // FIXME fix the span, we probably want the def_id of the return type of the function\n     let span = tcx.def_span(impl_fn_def_id);\n@@ -402,7 +404,7 @@ fn associated_type_for_impl_trait_in_impl(\n         let trait_assoc_parent_count = trait_assoc_generics.parent_count;\n         let mut params = trait_assoc_generics.params.clone();\n \n-        let parent_generics = tcx.generics_of(impl_def_id);\n+        let parent_generics = tcx.generics_of(impl_local_def_id.to_def_id());\n         let parent_count = parent_generics.parent_count + parent_generics.params.len();\n \n         for param in &mut params {\n@@ -413,7 +415,7 @@ fn associated_type_for_impl_trait_in_impl(\n             params.iter().map(|param| (param.def_id, param.index)).collect();\n \n         ty::Generics {\n-            parent: Some(impl_def_id),\n+            parent: Some(impl_local_def_id.to_def_id()),\n             parent_count,\n             params,\n             param_def_id_to_index,\n@@ -424,7 +426,7 @@ fn associated_type_for_impl_trait_in_impl(\n \n     // There are no predicates for the synthesized associated type.\n     impl_assoc_ty.explicit_predicates_of(ty::GenericPredicates {\n-        parent: Some(impl_def_id),\n+        parent: Some(impl_local_def_id.to_def_id()),\n         predicates: &[],\n     });\n "}, {"sha": "74f7bc603aafcb1f782ef26c0ce5ed327d709435", "filename": "tests/ui/impl-trait/in-trait/auxiliary/rpitit.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b9151b2d7014149be2acdea29ae9fa272dd11583/tests%2Fui%2Fimpl-trait%2Fin-trait%2Fauxiliary%2Frpitit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9151b2d7014149be2acdea29ae9fa272dd11583/tests%2Fui%2Fimpl-trait%2Fin-trait%2Fauxiliary%2Frpitit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimpl-trait%2Fin-trait%2Fauxiliary%2Frpitit.rs?ref=b9151b2d7014149be2acdea29ae9fa272dd11583", "patch": "@@ -1,3 +1,5 @@\n+// [next] compile-flags: -Zlower-impl-trait-in-trait-to-assoc-ty\n+\n #![feature(return_position_impl_trait_in_trait)]\n \n pub trait Foo {"}]}