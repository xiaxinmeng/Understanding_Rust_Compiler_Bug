{"sha": "41ee6fe14725011c327e18a77ff71738b17cd869", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQxZWU2ZmUxNDcyNTAxMWMzMjdlMThhNzdmZjcxNzM4YjE3Y2Q4Njk=", "commit": {"author": {"name": "Collins Abitekaniza", "email": "abtcolns@gmail.com", "date": "2018-04-12T11:49:31Z"}, "committer": {"name": "Collins Abitekaniza", "email": "collins.abitekaniza@osmosisworld.com", "date": "2018-05-07T13:51:58Z"}, "message": "./x.py test should be able to run individual tests\n\ntrim and pass relative test paths as test-args\n\nuse collect for getting test_args\n\nmove suite_path to ShouldRun and make Option\n\nappend existing args to test_args\n\nuse enum for PathSet\n\nhandle Suites differently from Paths\n\nError out if part of test suite but not file\n\nrefactor, make requested changes", "tree": {"sha": "41bf4ff6f717f88294139e50f2b610cd2455d041", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/41bf4ff6f717f88294139e50f2b610cd2455d041"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/41ee6fe14725011c327e18a77ff71738b17cd869", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/41ee6fe14725011c327e18a77ff71738b17cd869", "html_url": "https://github.com/rust-lang/rust/commit/41ee6fe14725011c327e18a77ff71738b17cd869", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/41ee6fe14725011c327e18a77ff71738b17cd869/comments", "author": {"login": "collin5", "id": 11579108, "node_id": "MDQ6VXNlcjExNTc5MTA4", "avatar_url": "https://avatars.githubusercontent.com/u/11579108?v=4", "gravatar_id": "", "url": "https://api.github.com/users/collin5", "html_url": "https://github.com/collin5", "followers_url": "https://api.github.com/users/collin5/followers", "following_url": "https://api.github.com/users/collin5/following{/other_user}", "gists_url": "https://api.github.com/users/collin5/gists{/gist_id}", "starred_url": "https://api.github.com/users/collin5/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/collin5/subscriptions", "organizations_url": "https://api.github.com/users/collin5/orgs", "repos_url": "https://api.github.com/users/collin5/repos", "events_url": "https://api.github.com/users/collin5/events{/privacy}", "received_events_url": "https://api.github.com/users/collin5/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "898c9f7d71f202e1e472427694347da4a91d8258", "url": "https://api.github.com/repos/rust-lang/rust/commits/898c9f7d71f202e1e472427694347da4a91d8258", "html_url": "https://github.com/rust-lang/rust/commit/898c9f7d71f202e1e472427694347da4a91d8258"}], "stats": {"total": 78, "additions": 63, "deletions": 15}, "files": [{"sha": "cea8e139f33a609bb5bf01afd3ce61cdfa2bf249", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 38, "deletions": 13, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/41ee6fe14725011c327e18a77ff71738b17cd869/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/41ee6fe14725011c327e18a77ff71738b17cd869/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=41ee6fe14725011c327e18a77ff71738b17cd869", "patch": "@@ -111,27 +111,34 @@ struct StepDescription {\n }\n \n #[derive(Debug, Clone, PartialOrd, Ord, PartialEq, Eq)]\n-struct PathSet {\n-    set: BTreeSet<PathBuf>,\n+pub enum PathSet {\n+    Set (BTreeSet<PathBuf>),\n+    Suite (PathBuf)\n }\n \n impl PathSet {\n     fn empty() -> PathSet {\n-        PathSet { set: BTreeSet::new() }\n+        PathSet::Set(BTreeSet::new())\n     }\n \n     fn one<P: Into<PathBuf>>(path: P) -> PathSet {\n         let mut set = BTreeSet::new();\n         set.insert(path.into());\n-        PathSet { set }\n+        PathSet::Set(set)\n     }\n \n     fn has(&self, needle: &Path) -> bool {\n-        self.set.iter().any(|p| p.ends_with(needle))\n+        match self {\n+            PathSet::Set(set) => set.iter().any(|p| p.ends_with(needle)),\n+            PathSet::Suite(_) => false\n+        }\n     }\n \n     fn path(&self, builder: &Builder) -> PathBuf {\n-        self.set.iter().next().unwrap_or(&builder.build.src).to_path_buf()\n+        match self {\n+            PathSet::Set(set) => set.iter().next().unwrap_or(&builder.build.src).to_path_buf(),\n+            PathSet::Suite(path) => PathBuf::from(path)\n+        }\n     }\n }\n \n@@ -203,7 +210,10 @@ impl StepDescription {\n             for path in paths {\n                 let mut attempted_run = false;\n                 for (desc, should_run) in v.iter().zip(&should_runs) {\n-                    if let Some(pathset) = should_run.pathset_for_path(path) {\n+                    if let Some(suite) = should_run.is_suite_path(path) {\n+                        attempted_run = true;\n+                        desc.maybe_run(builder, suite);\n+                    } else if let Some(pathset) = should_run.pathset_for_path(path) {\n                         attempted_run = true;\n                         desc.maybe_run(builder, pathset);\n                     }\n@@ -250,7 +260,7 @@ impl<'a> ShouldRun<'a> {\n         for krate in self.builder.in_tree_crates(name) {\n             set.insert(PathBuf::from(&krate.path));\n         }\n-        self.paths.insert(PathSet { set });\n+        self.paths.insert(PathSet::Set(set));\n         self\n     }\n \n@@ -268,9 +278,21 @@ impl<'a> ShouldRun<'a> {\n \n     // multiple aliases for the same job\n     pub fn paths(mut self, paths: &[&str]) -> Self {\n-        self.paths.insert(PathSet {\n-            set: paths.iter().map(PathBuf::from).collect(),\n-        });\n+        self.paths.insert(PathSet::Set(paths.iter().map(PathBuf::from).collect()));\n+        self\n+    }\n+\n+    pub fn is_suite_path(&self, path: &Path) -> Option<&PathSet> {\n+        self.paths.iter().find(|pathset| {\n+            match pathset {\n+                PathSet::Suite(p) => path.starts_with(p),\n+                PathSet::Set(_) => false\n+            }\n+        })\n+    }\n+\n+    pub fn suite_path(mut self, suite: &str) -> Self {\n+        self.paths.insert(PathSet::Suite(PathBuf::from(suite)));\n         self\n     }\n \n@@ -372,8 +394,10 @@ impl<'a> Builder<'a> {\n         }\n         let mut help = String::from(\"Available paths:\\n\");\n         for pathset in should_run.paths {\n-            for path in pathset.set {\n-                help.push_str(format!(\"    ./x.py {} {}\\n\", subcommand, path.display()).as_str());\n+            if let PathSet::Set(set) = pathset{\n+                set.iter().for_each(|path| help.push_str(\n+                    format!(\"    ./x.py {} {}\\n\", subcommand, path.display()).as_str()\n+                    ))\n             }\n         }\n         Some(help)\n@@ -404,6 +428,7 @@ impl<'a> Builder<'a> {\n             parent: Cell::new(None),\n         };\n \n+\n         if kind == Kind::Dist {\n             assert!(!builder.config.test_miri, \"Do not distribute with miri enabled.\\n\\\n                 The distributed libraries would include all MIR (increasing binary size)."}, {"sha": "efb92be60e66bc21c7b3de38aa1766f3c8524355", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 25, "deletions": 2, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/41ee6fe14725011c327e18a77ff71738b17cd869/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/41ee6fe14725011c327e18a77ff71738b17cd869/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=41ee6fe14725011c327e18a77ff71738b17cd869", "patch": "@@ -34,6 +34,7 @@ use tool::{self, Tool};\n use util::{self, dylib_path, dylib_path_var};\n use Mode;\n use toolstate::ToolState;\n+use flags::Subcommand;\n \n const ADB_TEST_DIR: &str = \"/data/tmp/work\";\n \n@@ -556,6 +557,7 @@ impl Step for RustdocUi {\n             target: self.target,\n             mode: \"ui\",\n             suite: \"rustdoc-ui\",\n+            path: None,\n             compare_mode: None,\n         })\n     }\n@@ -660,7 +662,7 @@ macro_rules! test_definitions {\n             const ONLY_HOSTS: bool = $host;\n \n             fn should_run(run: ShouldRun) -> ShouldRun {\n-                run.path($path)\n+                run.suite_path($path)\n             }\n \n             fn make_run(run: RunConfig) {\n@@ -678,6 +680,7 @@ macro_rules! test_definitions {\n                     target: self.target,\n                     mode: $mode,\n                     suite: $suite,\n+                    path: Some($path),\n                     compare_mode: $compare_mode,\n                 })\n             }\n@@ -850,6 +853,7 @@ struct Compiletest {\n     target: Interned<String>,\n     mode: &'static str,\n     suite: &'static str,\n+    path: Option<&'static str>,\n     compare_mode: Option<&'static str>,\n }\n \n@@ -872,6 +876,9 @@ impl Step for Compiletest {\n         let suite = self.suite;\n         let compare_mode = self.compare_mode;\n \n+        // Path for test suite\n+        let suite_path = self.path.unwrap_or(\"\");\n+\n         // Skip codegen tests if they aren't enabled in configuration.\n         if !builder.config.codegen_tests && suite == \"codegen\" {\n             return;\n@@ -994,7 +1001,23 @@ impl Step for Compiletest {\n             cmd.arg(\"--lldb-python-dir\").arg(dir);\n         }\n \n-        cmd.args(&builder.config.cmd.test_args());\n+        // Get paths from cmd args\n+        let paths = match &builder.config.cmd {\n+            Subcommand::Test { ref paths, ..} => &paths[..],\n+            _ => &[]\n+        };\n+\n+        // Get test-args by striping suite path\n+        let assert_file = |p: &PathBuf| {\n+            assert!(p.is_file(), \"Expected {:?} to be a path to a test file\", p);\n+            return true\n+        };\n+        let mut test_args: Vec<&str> = paths.iter().filter(|p| p.starts_with(suite_path) &&\n+           assert_file(p)).map(|p| p.strip_prefix(suite_path).unwrap().to_str().unwrap()).collect();\n+\n+        test_args.append(&mut builder.config.cmd.test_args());\n+\n+        cmd.args(&test_args);\n \n         if builder.is_verbose() {\n             cmd.arg(\"--verbose\");"}]}