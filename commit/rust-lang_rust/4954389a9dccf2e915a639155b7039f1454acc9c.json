{"sha": "4954389a9dccf2e915a639155b7039f1454acc9c", "node_id": "C_kwDOAAsO6NoAKDQ5NTQzODlhOWRjY2YyZTkxNWE2MzkxNTViNzAzOWYxNDU0YWNjOWM", "commit": {"author": {"name": "Esteban Kuber", "email": "esteban@kuber.com.ar", "date": "2021-11-25T01:38:05Z"}, "committer": {"name": "Esteban Kuber", "email": "esteban@kuber.com.ar", "date": "2021-11-25T01:49:48Z"}, "message": "Account for incorrect `where T::Assoc = Ty` bound\n\nProvide suggestoin to constrain trait bound for associated type.\nRevert incorrect changes to `missing-bounds` test.\n\nAddress part of #20041.", "tree": {"sha": "2392dd6eb5d337961bd49b14c0c700da3080cd10", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2392dd6eb5d337961bd49b14c0c700da3080cd10"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4954389a9dccf2e915a639155b7039f1454acc9c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4954389a9dccf2e915a639155b7039f1454acc9c", "html_url": "https://github.com/rust-lang/rust/commit/4954389a9dccf2e915a639155b7039f1454acc9c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4954389a9dccf2e915a639155b7039f1454acc9c/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "311fa1f14dd8ffbbe83b229a94b17f7f1ecaf33b", "url": "https://api.github.com/repos/rust-lang/rust/commits/311fa1f14dd8ffbbe83b229a94b17f7f1ecaf33b", "html_url": "https://github.com/rust-lang/rust/commit/311fa1f14dd8ffbbe83b229a94b17f7f1ecaf33b"}], "stats": {"total": 148, "additions": 142, "deletions": 6}, "files": [{"sha": "efc30121987e289389fb54525bf191035a814efb", "filename": "compiler/rustc_ast_passes/src/ast_validation.rs", "status": "modified", "additions": 48, "deletions": 1, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/4954389a9dccf2e915a639155b7039f1454acc9c/compiler%2Frustc_ast_passes%2Fsrc%2Fast_validation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4954389a9dccf2e915a639155b7039f1454acc9c/compiler%2Frustc_ast_passes%2Fsrc%2Fast_validation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_passes%2Fsrc%2Fast_validation.rs?ref=4954389a9dccf2e915a639155b7039f1454acc9c", "patch": "@@ -23,7 +23,7 @@ use rustc_span::symbol::{kw, sym, Ident};\n use rustc_span::Span;\n use rustc_target::spec::abi;\n use std::mem;\n-use std::ops::DerefMut;\n+use std::ops::{Deref, DerefMut};\n \n const MORE_EXTERN: &str =\n     \"for more information, visit https://doc.rust-lang.org/std/keyword.extern.html\";\n@@ -1714,6 +1714,53 @@ fn deny_equality_constraints(\n             }\n         }\n     }\n+    // Given `A: Foo, A::Bar = RhsTy`, suggest `A: Foo<Bar = RhsTy>`.\n+    if let TyKind::Path(None, full_path) = &predicate.lhs_ty.kind {\n+        if let [potential_param, potential_assoc] = &full_path.segments[..] {\n+            for param in &generics.params {\n+                if param.ident == potential_param.ident {\n+                    for bound in &param.bounds {\n+                        if let ast::GenericBound::Trait(trait_ref, TraitBoundModifier::None) = bound\n+                        {\n+                            if let [trait_segment] = &trait_ref.trait_ref.path.segments[..] {\n+                                let assoc = pprust::path_to_string(&ast::Path::from_ident(\n+                                    potential_assoc.ident,\n+                                ));\n+                                let ty = pprust::ty_to_string(&predicate.rhs_ty);\n+                                let (args, span) = match &trait_segment.args {\n+                                    Some(args) => match args.deref() {\n+                                        ast::GenericArgs::AngleBracketed(args) => {\n+                                            let Some(arg) = args.args.last() else {\n+                                                continue;\n+                                            };\n+                                            (\n+                                                format!(\", {} = {}\", assoc, ty),\n+                                                arg.span().shrink_to_hi(),\n+                                            )\n+                                        }\n+                                        _ => continue,\n+                                    },\n+                                    None => (\n+                                        format!(\"<{} = {}>\", assoc, ty),\n+                                        trait_segment.span().shrink_to_hi(),\n+                                    ),\n+                                };\n+                                err.multipart_suggestion(\n+                                    &format!(\n+                                        \"if `{}::{}` is an associated type you're trying to set, \\\n+                                        use the associated type binding syntax\",\n+                                        trait_segment.ident, potential_assoc.ident,\n+                                    ),\n+                                    vec![(span, args), (predicate.span, String::new())],\n+                                    Applicability::MaybeIncorrect,\n+                                );\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n     err.note(\n         \"see issue #20041 <https://github.com/rust-lang/rust/issues/20041> for more information\",\n     );"}, {"sha": "adc4d117b805f587e349d4f8294fefe0731d4a00", "filename": "compiler/rustc_ast_passes/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4954389a9dccf2e915a639155b7039f1454acc9c/compiler%2Frustc_ast_passes%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4954389a9dccf2e915a639155b7039f1454acc9c/compiler%2Frustc_ast_passes%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_passes%2Fsrc%2Flib.rs?ref=4954389a9dccf2e915a639155b7039f1454acc9c", "patch": "@@ -6,6 +6,7 @@\n \n #![feature(iter_is_partitioned)]\n #![feature(box_patterns)]\n+#![feature(let_else)]\n #![recursion_limit = \"256\"]\n \n pub mod ast_validation;"}, {"sha": "fcc2da8014f878bd64d2f06c9e4b6341cb571aee", "filename": "src/test/ui/generic-associated-types/equality-bound.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/4954389a9dccf2e915a639155b7039f1454acc9c/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fequality-bound.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4954389a9dccf2e915a639155b7039f1454acc9c/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fequality-bound.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fequality-bound.rs?ref=4954389a9dccf2e915a639155b7039f1454acc9c", "patch": "@@ -0,0 +1,15 @@\n+fn sum<I: Iterator<Item = ()>>(i: I) -> i32 where I::Item = i32 {\n+//~^ ERROR equality constraints are not yet supported in `where` clauses\n+    panic!()\n+}\n+fn sum2<I: Iterator>(i: I) -> i32 where I::Item = i32 {\n+//~^ ERROR equality constraints are not yet supported in `where` clauses\n+    panic!()\n+}\n+fn sum3<J: Iterator>(i: J) -> i32 where I::Item = i32 {\n+//~^ ERROR equality constraints are not yet supported in `where` clauses\n+//~| ERROR failed to resolve: use of undeclared type `I`\n+    panic!()\n+}\n+\n+fn main() {}"}, {"sha": "27432641958bdaa52cb39f6b9ab7a97902c8a7c8", "filename": "src/test/ui/generic-associated-types/equality-bound.stderr", "status": "added", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/4954389a9dccf2e915a639155b7039f1454acc9c/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fequality-bound.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4954389a9dccf2e915a639155b7039f1454acc9c/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fequality-bound.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fequality-bound.stderr?ref=4954389a9dccf2e915a639155b7039f1454acc9c", "patch": "@@ -0,0 +1,43 @@\n+error: equality constraints are not yet supported in `where` clauses\n+  --> $DIR/equality-bound.rs:1:51\n+   |\n+LL | fn sum<I: Iterator<Item = ()>>(i: I) -> i32 where I::Item = i32 {\n+   |                                                   ^^^^^^^^^^^^^ not supported\n+   |\n+   = note: see issue #20041 <https://github.com/rust-lang/rust/issues/20041> for more information\n+help: if `Iterator::Item` is an associated type you're trying to set, use the associated type binding syntax\n+   |\n+LL - fn sum<I: Iterator<Item = ()>>(i: I) -> i32 where I::Item = i32 {\n+LL + fn sum<I: Iterator<Item = (), Item = i32>>(i: I) -> i32 where  {\n+   | \n+\n+error: equality constraints are not yet supported in `where` clauses\n+  --> $DIR/equality-bound.rs:5:41\n+   |\n+LL | fn sum2<I: Iterator>(i: I) -> i32 where I::Item = i32 {\n+   |                                         ^^^^^^^^^^^^^ not supported\n+   |\n+   = note: see issue #20041 <https://github.com/rust-lang/rust/issues/20041> for more information\n+help: if `Iterator::Item` is an associated type you're trying to set, use the associated type binding syntax\n+   |\n+LL - fn sum2<I: Iterator>(i: I) -> i32 where I::Item = i32 {\n+LL + fn sum2<I: Iterator<Item = i32>>(i: I) -> i32 where  {\n+   | \n+\n+error: equality constraints are not yet supported in `where` clauses\n+  --> $DIR/equality-bound.rs:9:41\n+   |\n+LL | fn sum3<J: Iterator>(i: J) -> i32 where I::Item = i32 {\n+   |                                         ^^^^^^^^^^^^^ not supported\n+   |\n+   = note: see issue #20041 <https://github.com/rust-lang/rust/issues/20041> for more information\n+\n+error[E0433]: failed to resolve: use of undeclared type `I`\n+  --> $DIR/equality-bound.rs:9:41\n+   |\n+LL | fn sum3<J: Iterator>(i: J) -> i32 where I::Item = i32 {\n+   |                                         ^ use of undeclared type `I`\n+\n+error: aborting due to 4 previous errors\n+\n+For more information about this error, try `rustc --explain E0433`."}, {"sha": "0e234120a51c5840a5a903c84772647bca701425", "filename": "src/test/ui/generic-associated-types/missing-bounds.fixed", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/4954389a9dccf2e915a639155b7039f1454acc9c/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fmissing-bounds.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/4954389a9dccf2e915a639155b7039f1454acc9c/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fmissing-bounds.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fmissing-bounds.fixed?ref=4954389a9dccf2e915a639155b7039f1454acc9c", "patch": "@@ -34,11 +34,12 @@ impl<B: std::ops::Add<Output = B>> Add for D<B> {\n \n struct E<B>(B);\n \n-impl<B: Add> Add for E<B> where B: Add<Output = B> {\n+impl<B: Add> Add for E<B> where B: Add<Output = B>, B: Add<Output = B> {\n+    //~^ ERROR equality constraints are not yet supported in `where` clauses\n     type Output = Self;\n \n     fn add(self, rhs: Self) -> Self {\n-        Self(self.0 + rhs.0)\n+        Self(self.0 + rhs.0) //~ ERROR mismatched types\n     }\n }\n "}, {"sha": "ffafff5e9f586d2543061aaaa616eec501040f8a", "filename": "src/test/ui/generic-associated-types/missing-bounds.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/4954389a9dccf2e915a639155b7039f1454acc9c/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fmissing-bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4954389a9dccf2e915a639155b7039f1454acc9c/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fmissing-bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fmissing-bounds.rs?ref=4954389a9dccf2e915a639155b7039f1454acc9c", "patch": "@@ -34,11 +34,12 @@ impl<B> Add for D<B> {\n \n struct E<B>(B);\n \n-impl<B: Add> Add for E<B> where B: Add<Output = B> {\n+impl<B: Add> Add for E<B> where <B as Add>::Output = B {\n+    //~^ ERROR equality constraints are not yet supported in `where` clauses\n     type Output = Self;\n \n     fn add(self, rhs: Self) -> Self {\n-        Self(self.0 + rhs.0)\n+        Self(self.0 + rhs.0) //~ ERROR mismatched types\n     }\n }\n "}, {"sha": "c9603b8d1ea4a3bcebe045f1630099e1a08f51eb", "filename": "src/test/ui/generic-associated-types/missing-bounds.stderr", "status": "modified", "additions": 29, "deletions": 1, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/4954389a9dccf2e915a639155b7039f1454acc9c/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fmissing-bounds.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4954389a9dccf2e915a639155b7039f1454acc9c/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fmissing-bounds.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fmissing-bounds.stderr?ref=4954389a9dccf2e915a639155b7039f1454acc9c", "patch": "@@ -1,3 +1,15 @@\n+error: equality constraints are not yet supported in `where` clauses\n+  --> $DIR/missing-bounds.rs:37:33\n+   |\n+LL | impl<B: Add> Add for E<B> where <B as Add>::Output = B {\n+   |                                 ^^^^^^^^^^^^^^^^^^^^^^ not supported\n+   |\n+   = note: see issue #20041 <https://github.com/rust-lang/rust/issues/20041> for more information\n+help: if `Output` is an associated type you're trying to set, use the associated type binding syntax\n+   |\n+LL | impl<B: Add> Add for E<B> where B: Add<Output = B> {\n+   |                                 ~~~~~~~~~~~~~~~~~~\n+\n error[E0308]: mismatched types\n   --> $DIR/missing-bounds.rs:11:11\n    |\n@@ -43,7 +55,23 @@ help: consider restricting type parameter `B`\n LL | impl<B: std::ops::Add<Output = B>> Add for D<B> {\n    |       +++++++++++++++++++++++++++\n \n-error: aborting due to 3 previous errors\n+error[E0308]: mismatched types\n+  --> $DIR/missing-bounds.rs:42:14\n+   |\n+LL | impl<B: Add> Add for E<B> where <B as Add>::Output = B {\n+   |      - this type parameter\n+...\n+LL |         Self(self.0 + rhs.0)\n+   |              ^^^^^^^^^^^^^^ expected type parameter `B`, found associated type\n+   |\n+   = note: expected type parameter `B`\n+             found associated type `<B as Add>::Output`\n+help: consider further restricting type parameter `B`\n+   |\n+LL | impl<B: Add> Add for E<B> where <B as Add>::Output = B, B: Add<Output = B> {\n+   |                                                       ++++++++++++++++++++\n+\n+error: aborting due to 5 previous errors\n \n Some errors have detailed explanations: E0308, E0369.\n For more information about an error, try `rustc --explain E0308`."}]}