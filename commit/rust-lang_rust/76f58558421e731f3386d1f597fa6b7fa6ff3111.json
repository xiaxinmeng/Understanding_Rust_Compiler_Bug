{"sha": "76f58558421e731f3386d1f597fa6b7fa6ff3111", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc2ZjU4NTU4NDIxZTczMWYzMzg2ZDFmNTk3ZmE2YjdmYTZmZjMxMTE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-27T21:44:16Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-27T21:44:16Z"}, "message": "Auto merge of #1817 - hyd-dev:doctest, r=RalfJung\n\nSkip doctests of `proc-macro` crates\n\nFixes #1813.\n\nVerified that the newly added tests failed without the `cargo-miri` change and pass with normal `cargo test`.", "tree": {"sha": "08f6fde2221467eda8c363d36d964a9e765649b5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/08f6fde2221467eda8c363d36d964a9e765649b5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/76f58558421e731f3386d1f597fa6b7fa6ff3111", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/76f58558421e731f3386d1f597fa6b7fa6ff3111", "html_url": "https://github.com/rust-lang/rust/commit/76f58558421e731f3386d1f597fa6b7fa6ff3111", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/76f58558421e731f3386d1f597fa6b7fa6ff3111/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0f03a705a2e2a38eca60617582f497286e19af9b", "url": "https://api.github.com/repos/rust-lang/rust/commits/0f03a705a2e2a38eca60617582f497286e19af9b", "html_url": "https://github.com/rust-lang/rust/commit/0f03a705a2e2a38eca60617582f497286e19af9b"}, {"sha": "d1de0843ed56eb663f9df9668ede39e58da778ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/d1de0843ed56eb663f9df9668ede39e58da778ec", "html_url": "https://github.com/rust-lang/rust/commit/d1de0843ed56eb663f9df9668ede39e58da778ec"}], "stats": {"total": 19, "additions": 17, "deletions": 2}, "files": [{"sha": "7836b26ea5f915b405784f6f9c5a9d8b49ed7497", "filename": "cargo-miri/bin.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/76f58558421e731f3386d1f597fa6b7fa6ff3111/cargo-miri%2Fbin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/76f58558421e731f3386d1f597fa6b7fa6ff3111/cargo-miri%2Fbin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/cargo-miri%2Fbin.rs?ref=76f58558421e731f3386d1f597fa6b7fa6ff3111", "patch": "@@ -900,10 +900,17 @@ fn phase_rustdoc(fst_arg: &str, mut args: env::Args) {\n     }\n \n     if crossmode {\n-        show_error(format!(\"cross-interpreting doc-tests is not currently supported by Miri.\"));\n+        show_error(format!(\"cross-interpreting doctests is not currently supported by Miri.\"));\n     }\n \n-    // For each doc-test, rustdoc starts two child processes: first the test is compiled,\n+    // Doctests of `proc-macro` crates (and their dependencies) are always built for the host,\n+    // so we are not able to run them in Miri.\n+    if ArgFlagValueIter::new(\"--crate-type\").any(|crate_type| crate_type == \"proc-macro\") {\n+        eprintln!(\"Running doctests of `proc-macro` crates is not currently supported by Miri.\");\n+        return;\n+    }\n+\n+    // For each doctest, rustdoc starts two child processes: first the test is compiled,\n     // then the produced executable is invoked. We want to reroute both of these to cargo-miri,\n     // such that the first time we'll enter phase_cargo_rustc, and phase_cargo_runner second.\n     //"}, {"sha": "c850e7d14591913f983b04ffbb4ae11a57f2c413", "filename": "test-cargo-miri/run-test.py", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/76f58558421e731f3386d1f597fa6b7fa6ff3111/test-cargo-miri%2Frun-test.py", "raw_url": "https://github.com/rust-lang/rust/raw/76f58558421e731f3386d1f597fa6b7fa6ff3111/test-cargo-miri%2Frun-test.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Frun-test.py?ref=76f58558421e731f3386d1f597fa6b7fa6ff3111", "patch": "@@ -140,6 +140,10 @@ def test_cargo_miri_test():\n         \"test.subcrate.stdout.ref\", \"test.stderr-proc-macro.ref\",\n         env={'MIRIFLAGS': \"-Zmiri-disable-isolation\"},\n     )\n+    test(\"`cargo miri test` (subcrate, doctests)\",\n+        cargo_miri(\"test\") + [\"-p\", \"subcrate\", \"--doc\"],\n+        \"test.stdout-empty.ref\", \"test.stderr-proc-macro-doctest.ref\",\n+    )\n \n os.chdir(os.path.dirname(os.path.realpath(__file__)))\n os.environ[\"RUST_TEST_NOCAPTURE\"] = \"0\" # this affects test output, so make sure it is not set"}, {"sha": "2ccb6704b05e6d9ad51ac5bf87c7f8bbf61e2616", "filename": "test-cargo-miri/subcrate/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/76f58558421e731f3386d1f597fa6b7fa6ff3111/test-cargo-miri%2Fsubcrate%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/76f58558421e731f3386d1f597fa6b7fa6ff3111/test-cargo-miri%2Fsubcrate%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Fsubcrate%2Fsrc%2Flib.rs?ref=76f58558421e731f3386d1f597fa6b7fa6ff3111", "patch": "@@ -1,2 +1,5 @@\n+#[cfg(doctest)]\n+compile_error!(\"rustdoc should not touch me\");\n+\n #[cfg(test)]\n compile_error!(\"Miri should not touch me\");"}, {"sha": "ca5e3a2392db86f336a6ba03c2cc4abba6d0384a", "filename": "test-cargo-miri/test.stderr-proc-macro-doctest.ref", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/76f58558421e731f3386d1f597fa6b7fa6ff3111/test-cargo-miri%2Ftest.stderr-proc-macro-doctest.ref", "raw_url": "https://github.com/rust-lang/rust/raw/76f58558421e731f3386d1f597fa6b7fa6ff3111/test-cargo-miri%2Ftest.stderr-proc-macro-doctest.ref", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Ftest.stderr-proc-macro-doctest.ref?ref=76f58558421e731f3386d1f597fa6b7fa6ff3111", "patch": "@@ -0,0 +1 @@\n+Running doctests of `proc-macro` crates is not currently supported by Miri."}, {"sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391", "filename": "test-cargo-miri/test.stdout-empty.ref", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/76f58558421e731f3386d1f597fa6b7fa6ff3111/test-cargo-miri%2Ftest.stdout-empty.ref", "raw_url": "https://github.com/rust-lang/rust/raw/76f58558421e731f3386d1f597fa6b7fa6ff3111/test-cargo-miri%2Ftest.stdout-empty.ref", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Ftest.stdout-empty.ref?ref=76f58558421e731f3386d1f597fa6b7fa6ff3111"}]}