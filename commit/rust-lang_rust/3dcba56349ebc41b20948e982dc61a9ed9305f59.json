{"sha": "3dcba56349ebc41b20948e982dc61a9ed9305f59", "node_id": "C_kwDOAAsO6NoAKDNkY2JhNTYzNDllYmM0MWIyMDk0OGU5ODJkYzYxYTllZDkzMDVmNTk", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-04-02T04:05:27Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-04-02T04:05:27Z"}, "message": "add test for nasty example", "tree": {"sha": "7b25d8bef50e4c348b7bc71bf4a996784c0a3422", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7b25d8bef50e4c348b7bc71bf4a996784c0a3422"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3dcba56349ebc41b20948e982dc61a9ed9305f59", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3dcba56349ebc41b20948e982dc61a9ed9305f59", "html_url": "https://github.com/rust-lang/rust/commit/3dcba56349ebc41b20948e982dc61a9ed9305f59", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3dcba56349ebc41b20948e982dc61a9ed9305f59/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1d79b60a1eed7fd1b176de1cbe2fa44ee158cc0d", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d79b60a1eed7fd1b176de1cbe2fa44ee158cc0d", "html_url": "https://github.com/rust-lang/rust/commit/1d79b60a1eed7fd1b176de1cbe2fa44ee158cc0d"}], "stats": {"total": 27, "additions": 27, "deletions": 0}, "files": [{"sha": "0fc64295f94ce869832062aaa2c65d45b406b81c", "filename": "tests/compile-fail/strict_provenance_transmute.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/3dcba56349ebc41b20948e982dc61a9ed9305f59/tests%2Fcompile-fail%2Fstrict_provenance_transmute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dcba56349ebc41b20948e982dc61a9ed9305f59/tests%2Fcompile-fail%2Fstrict_provenance_transmute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fstrict_provenance_transmute.rs?ref=3dcba56349ebc41b20948e982dc61a9ed9305f59", "patch": "@@ -0,0 +1,27 @@\n+// compile-flags: -Zmiri-strict-provenance\n+#![feature(strict_provenance)]\n+\n+use std::mem;\n+\n+// This is the example from\n+// <https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-1085144431>.\n+\n+unsafe fn deref(left: *const u8, right: *const u8) {\n+    let left_int: usize = mem::transmute(left); //~ERROR expected initialized plain (non-pointer) bytes\n+    let right_int: usize = mem::transmute(right);\n+    if left_int == right_int {\n+        // The compiler is allowed to replace `left_int` by `right_int` here...\n+        let left_ptr: *const u8 = mem::transmute(left_int);\n+        // ...which however means here it could be dereferencing the wrong pointer.\n+        let _val = *left_ptr;\n+    }\n+}\n+\n+fn main() {\n+    let ptr1 = &0u8 as *const u8;\n+    let ptr2 = &1u8 as *const u8;\n+    unsafe {\n+        // Two pointers with the same address but different provenance.\n+        deref(ptr1, ptr2.with_addr(ptr1.addr()));\n+    }\n+}"}]}