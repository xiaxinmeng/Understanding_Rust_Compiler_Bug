{"sha": "5bba438c9cf684812e72e9d90c8fea55bd29909c", "node_id": "C_kwDOAAsO6NoAKDViYmE0MzhjOWNmNjg0ODEyZTcyZTlkOTBjOGZlYTU1YmQyOTkwOWM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-28T07:05:43Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-28T07:05:43Z"}, "message": "Auto merge of #14366 - Veykril:linked-proj, r=Veykril\n\nfeat: Pop a notification prompting the user to add a Cargo.toml of unlinked file to the linkedProjects\n\ncc https://github.com/rust-lang/rust-analyzer/issues/13226 https://github.com/rust-lang/rust-analyzer/issues/9661", "tree": {"sha": "4b7988975a168b0cac6cc18fe3e31daa4ed938e2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4b7988975a168b0cac6cc18fe3e31daa4ed938e2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5bba438c9cf684812e72e9d90c8fea55bd29909c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5bba438c9cf684812e72e9d90c8fea55bd29909c", "html_url": "https://github.com/rust-lang/rust/commit/5bba438c9cf684812e72e9d90c8fea55bd29909c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5bba438c9cf684812e72e9d90c8fea55bd29909c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f73510560f93262ad2e375d63b526af37aa3ae48", "url": "https://api.github.com/repos/rust-lang/rust/commits/f73510560f93262ad2e375d63b526af37aa3ae48", "html_url": "https://github.com/rust-lang/rust/commit/f73510560f93262ad2e375d63b526af37aa3ae48"}, {"sha": "3622fb645632fcf81af82919259be4b0012a3939", "url": "https://api.github.com/repos/rust-lang/rust/commits/3622fb645632fcf81af82919259be4b0012a3939", "html_url": "https://github.com/rust-lang/rust/commit/3622fb645632fcf81af82919259be4b0012a3939"}], "stats": {"total": 89, "additions": 74, "deletions": 15}, "files": [{"sha": "0dc5343f9429d0bccf6888d4298a1e7eabf7d624", "filename": "crates/ide-diagnostics/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5bba438c9cf684812e72e9d90c8fea55bd29909c/crates%2Fide-diagnostics%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bba438c9cf684812e72e9d90c8fea55bd29909c/crates%2Fide-diagnostics%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-diagnostics%2Fsrc%2Flib.rs?ref=5bba438c9cf684812e72e9d90c8fea55bd29909c", "patch": "@@ -74,6 +74,7 @@ use ide_db::{\n };\n use syntax::{algo::find_node_at_range, ast::AstNode, SyntaxNodePtr, TextRange};\n \n+// FIXME: Make this an enum\n #[derive(Copy, Clone, Debug, PartialEq)]\n pub struct DiagnosticCode(pub &'static str);\n "}, {"sha": "f0ca8ff9dbde9f20e46f608257bd4978860eb50d", "filename": "crates/rust-analyzer/src/global_state.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5bba438c9cf684812e72e9d90c8fea55bd29909c/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bba438c9cf684812e72e9d90c8fea55bd29909c/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs?ref=5bba438c9cf684812e72e9d90c8fea55bd29909c", "patch": "@@ -337,7 +337,7 @@ impl GlobalState {\n     }\n \n     pub(crate) fn send_notification<N: lsp_types::notification::Notification>(\n-        &mut self,\n+        &self,\n         params: N::Params,\n     ) {\n         let not = lsp_server::Notification::new(N::METHOD.to_string(), params);\n@@ -378,7 +378,7 @@ impl GlobalState {\n         self.req_queue.incoming.is_completed(&request.id)\n     }\n \n-    fn send(&mut self, message: lsp_server::Message) {\n+    fn send(&self, message: lsp_server::Message) {\n         self.sender.send(message).unwrap()\n     }\n }"}, {"sha": "7b27a067062c1bf62fe8e695ff8dd116f43e495f", "filename": "crates/rust-analyzer/src/reload.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5bba438c9cf684812e72e9d90c8fea55bd29909c/crates%2Frust-analyzer%2Fsrc%2Freload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bba438c9cf684812e72e9d90c8fea55bd29909c/crates%2Frust-analyzer%2Fsrc%2Freload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Freload.rs?ref=5bba438c9cf684812e72e9d90c8fea55bd29909c", "patch": "@@ -120,7 +120,8 @@ impl GlobalState {\n             && self.config.notifications().cargo_toml_not_found\n         {\n             status.health = lsp_ext::Health::Warning;\n-            message.push_str(\"Failed to discover workspace.\\n\\n\");\n+            message.push_str(\"Failed to discover workspace.\\n\");\n+            message.push_str(\"Consider adding the `Cargo.toml` of the workspace to the [`linkedProjects`](https://rust-analyzer.github.io/manual.html#rust-analyzer.linkedProjects) setting.\\n\\n\");\n         }\n \n         for ws in self.workspaces.iter() {"}, {"sha": "0332fe30251008ad47672cbc1183fe07b01f264a", "filename": "editors/code/package.json", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5bba438c9cf684812e72e9d90c8fea55bd29909c/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/5bba438c9cf684812e72e9d90c8fea55bd29909c/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=5bba438c9cf684812e72e9d90c8fea55bd29909c", "patch": "@@ -449,6 +449,11 @@\n                         \"type\": \"string\"\n                     }\n                 },\n+                \"rust-analyzer.showUnlinkedFileNotification\": {\n+                    \"markdownDescription\": \"Whether to show a notification for unlinked files asking the user to add the corresponding Cargo.toml to the linked projects setting.\",\n+                    \"default\": true,\n+                    \"type\": \"boolean\"\n+                },\n                 \"$generated-start\": {},\n                 \"rust-analyzer.assist.emitMustUse\": {\n                     \"markdownDescription\": \"Whether to insert #[must_use] when generating `as_` methods\\nfor enum variants.\","}, {"sha": "4ca6601a6aadb376df2595031e5dd702dc2568e4", "filename": "editors/code/src/client.ts", "status": "modified", "additions": 59, "deletions": 10, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/5bba438c9cf684812e72e9d90c8fea55bd29909c/editors%2Fcode%2Fsrc%2Fclient.ts", "raw_url": "https://github.com/rust-lang/rust/raw/5bba438c9cf684812e72e9d90c8fea55bd29909c/editors%2Fcode%2Fsrc%2Fclient.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fclient.ts?ref=5bba438c9cf684812e72e9d90c8fea55bd29909c", "patch": "@@ -8,6 +8,7 @@ import * as diagnostics from \"./diagnostics\";\n import { WorkspaceEdit } from \"vscode\";\n import { Config, prepareVSCodeConfig } from \"./config\";\n import { randomUUID } from \"crypto\";\n+import { sep as pathSeparator } from \"path\";\n \n export interface Env {\n     [name: string]: string;\n@@ -69,7 +70,8 @@ export async function createClient(\n     outputChannel: vscode.OutputChannel,\n     initializationOptions: vscode.WorkspaceConfiguration,\n     serverOptions: lc.ServerOptions,\n-    config: Config\n+    config: Config,\n+    unlinkedFiles: vscode.Uri[]\n ): Promise<lc.LanguageClient> {\n     const clientOptions: lc.LanguageClientOptions = {\n         documentSelector: [{ scheme: \"file\", language: \"rust\" }],\n@@ -119,6 +121,60 @@ export async function createClient(\n                 const preview = config.previewRustcOutput;\n                 const errorCode = config.useRustcErrorCode;\n                 diagnosticList.forEach((diag, idx) => {\n+                    const value =\n+                        typeof diag.code === \"string\" || typeof diag.code === \"number\"\n+                            ? diag.code\n+                            : diag.code?.value;\n+                    if (value === \"unlinked-file\" && !unlinkedFiles.includes(uri)) {\n+                        const config = vscode.workspace.getConfiguration(\"rust-analyzer\");\n+                        if (config.get(\"showUnlinkedFileNotification\")) {\n+                            unlinkedFiles.push(uri);\n+                            const folder = vscode.workspace.getWorkspaceFolder(uri)?.uri.fsPath;\n+                            if (folder) {\n+                                const parentBackslash = uri.fsPath.lastIndexOf(\n+                                    pathSeparator + \"src\"\n+                                );\n+                                const parent = uri.fsPath.substring(0, parentBackslash);\n+\n+                                if (parent.startsWith(folder)) {\n+                                    const path = vscode.Uri.file(\n+                                        parent + pathSeparator + \"Cargo.toml\"\n+                                    );\n+                                    void vscode.workspace.fs.stat(path).then(async () => {\n+                                        const choice = await vscode.window.showInformationMessage(\n+                                            `This rust file does not belong to a loaded cargo project. It looks like it might belong to the workspace at ${path}, do you want to add it to the linked Projects?`,\n+                                            \"Yes\",\n+                                            \"No\",\n+                                            \"Don't show this again\"\n+                                        );\n+                                        switch (choice) {\n+                                            case \"Yes\":\n+                                                break;\n+                                            case \"No\":\n+                                                await config.update(\n+                                                    \"linkedProjects\",\n+                                                    config\n+                                                        .get<any[]>(\"linkedProjects\")\n+                                                        ?.concat(\n+                                                            path.fsPath.substring(folder.length)\n+                                                        ),\n+                                                    false\n+                                                );\n+                                                break;\n+                                            case \"Don't show this again\":\n+                                                await config.update(\n+                                                    \"showUnlinkedFileNotification\",\n+                                                    false,\n+                                                    false\n+                                                );\n+                                                break;\n+                                        }\n+                                    });\n+                                }\n+                            }\n+                        }\n+                    }\n+\n                     // Abuse the fact that VSCode leaks the LSP diagnostics data field through the\n                     // Diagnostic class, if they ever break this we are out of luck and have to go\n                     // back to the worst diagnostics experience ever:)\n@@ -138,22 +194,15 @@ export async function createClient(\n                                 .substring(0, index)\n                                 .replace(/^ -->[^\\n]+\\n/m, \"\");\n                         }\n-                        let value;\n-                        if (errorCode) {\n-                            if (typeof diag.code === \"string\" || typeof diag.code === \"number\") {\n-                                value = diag.code;\n-                            } else {\n-                                value = diag.code?.value;\n-                            }\n-                        }\n                         diag.code = {\n                             target: vscode.Uri.from({\n                                 scheme: diagnostics.URI_SCHEME,\n                                 path: `/diagnostic message [${idx.toString()}]`,\n                                 fragment: uri.toString(),\n                                 query: idx.toString(),\n                             }),\n-                            value: value ?? \"Click for full compiler diagnostic\",\n+                            value:\n+                                errorCode && value ? value : \"Click for full compiler diagnostic\",\n                         };\n                     }\n                 });"}, {"sha": "dd74b31cc71caf80e016d86a626a36220bf2cbac", "filename": "editors/code/src/ctx.ts", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5bba438c9cf684812e72e9d90c8fea55bd29909c/editors%2Fcode%2Fsrc%2Fctx.ts", "raw_url": "https://github.com/rust-lang/rust/raw/5bba438c9cf684812e72e9d90c8fea55bd29909c/editors%2Fcode%2Fsrc%2Fctx.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fctx.ts?ref=5bba438c9cf684812e72e9d90c8fea55bd29909c", "patch": "@@ -82,6 +82,7 @@ export class Ctx {\n     private state: PersistentState;\n     private commandFactories: Record<string, CommandFactory>;\n     private commandDisposables: Disposable[];\n+    private unlinkedFiles: vscode.Uri[];\n \n     get client() {\n         return this._client;\n@@ -94,11 +95,11 @@ export class Ctx {\n     ) {\n         extCtx.subscriptions.push(this);\n         this.statusBar = vscode.window.createStatusBarItem(vscode.StatusBarAlignment.Left);\n-        this.statusBar.show();\n         this.workspace = workspace;\n         this.clientSubscriptions = [];\n         this.commandDisposables = [];\n         this.commandFactories = commandFactories;\n+        this.unlinkedFiles = [];\n \n         this.state = new PersistentState(extCtx.globalState);\n         this.config = new Config(extCtx);\n@@ -218,7 +219,8 @@ export class Ctx {\n                 this.outputChannel,\n                 initializationOptions,\n                 serverOptions,\n-                this.config\n+                this.config,\n+                this.unlinkedFiles\n             );\n             this.pushClientCleanup(\n                 this._client.onNotification(ra.serverStatus, (params) =>\n@@ -335,6 +337,7 @@ export class Ctx {\n     setServerStatus(status: ServerStatusParams | { health: \"stopped\" }) {\n         let icon = \"\";\n         const statusBar = this.statusBar;\n+        statusBar.show();\n         statusBar.tooltip = new vscode.MarkdownString(\"\", true);\n         statusBar.tooltip.isTrusted = true;\n         switch (status.health) {"}]}