{"sha": "2c77f3e9c5804edc0bb520c7b4774424cea6beb0", "node_id": "C_kwDOAAsO6NoAKDJjNzdmM2U5YzU4MDRlZGMwYmI1MjBjN2I0Nzc0NDI0Y2VhNmJlYjA", "commit": {"author": {"name": "Luis Cardoso", "email": "61982523+LuisCardosoOliveira@users.noreply.github.com", "date": "2022-08-24T15:15:08Z"}, "committer": {"name": "Luis Cardoso", "email": "61982523+LuisCardosoOliveira@users.noreply.github.com", "date": "2022-08-26T14:10:11Z"}, "message": "translations(rustc_session): migrate check_expected_reuse\n\nThis commit migrates the errors in the function check_expected_reuse\nto use the new SessionDiagnostic. It also does some small refactor\nfor the IncorrectCguReuseType to include the 'at least' word in the\nfluent translation file", "tree": {"sha": "c28579cb1f13a93c8614a6a71d6154b10e0bf202", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c28579cb1f13a93c8614a6a71d6154b10e0bf202"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2c77f3e9c5804edc0bb520c7b4774424cea6beb0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2c77f3e9c5804edc0bb520c7b4774424cea6beb0", "html_url": "https://github.com/rust-lang/rust/commit/2c77f3e9c5804edc0bb520c7b4774424cea6beb0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2c77f3e9c5804edc0bb520c7b4774424cea6beb0/comments", "author": {"login": "LuisCardosoOliveira", "id": 61982523, "node_id": "MDQ6VXNlcjYxOTgyNTIz", "avatar_url": "https://avatars.githubusercontent.com/u/61982523?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LuisCardosoOliveira", "html_url": "https://github.com/LuisCardosoOliveira", "followers_url": "https://api.github.com/users/LuisCardosoOliveira/followers", "following_url": "https://api.github.com/users/LuisCardosoOliveira/following{/other_user}", "gists_url": "https://api.github.com/users/LuisCardosoOliveira/gists{/gist_id}", "starred_url": "https://api.github.com/users/LuisCardosoOliveira/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LuisCardosoOliveira/subscriptions", "organizations_url": "https://api.github.com/users/LuisCardosoOliveira/orgs", "repos_url": "https://api.github.com/users/LuisCardosoOliveira/repos", "events_url": "https://api.github.com/users/LuisCardosoOliveira/events{/privacy}", "received_events_url": "https://api.github.com/users/LuisCardosoOliveira/received_events", "type": "User", "site_admin": false}, "committer": {"login": "LuisCardosoOliveira", "id": 61982523, "node_id": "MDQ6VXNlcjYxOTgyNTIz", "avatar_url": "https://avatars.githubusercontent.com/u/61982523?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LuisCardosoOliveira", "html_url": "https://github.com/LuisCardosoOliveira", "followers_url": "https://api.github.com/users/LuisCardosoOliveira/followers", "following_url": "https://api.github.com/users/LuisCardosoOliveira/following{/other_user}", "gists_url": "https://api.github.com/users/LuisCardosoOliveira/gists{/gist_id}", "starred_url": "https://api.github.com/users/LuisCardosoOliveira/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LuisCardosoOliveira/subscriptions", "organizations_url": "https://api.github.com/users/LuisCardosoOliveira/orgs", "repos_url": "https://api.github.com/users/LuisCardosoOliveira/repos", "events_url": "https://api.github.com/users/LuisCardosoOliveira/events{/privacy}", "received_events_url": "https://api.github.com/users/LuisCardosoOliveira/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d5262a945246a624113faaadbbdae4ec5013c862", "url": "https://api.github.com/repos/rust-lang/rust/commits/d5262a945246a624113faaadbbdae4ec5013c862", "html_url": "https://github.com/rust-lang/rust/commit/d5262a945246a624113faaadbbdae4ec5013c862"}], "stats": {"total": 39, "additions": 17, "deletions": 22}, "files": [{"sha": "68f3b19b715ad7563a672184f44ce9aa895f7aa0", "filename": "compiler/rustc_codegen_ssa/src/back/write.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2c77f3e9c5804edc0bb520c7b4774424cea6beb0/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2c77f3e9c5804edc0bb520c7b4774424cea6beb0/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fwrite.rs?ref=2c77f3e9c5804edc0bb520c7b4774424cea6beb0", "patch": "@@ -1892,7 +1892,7 @@ impl<B: ExtraBackendMethods> OngoingCodegen<B> {\n             }\n         });\n \n-        sess.cgu_reuse_tracker.check_expected_reuse(sess.diagnostic());\n+        sess.cgu_reuse_tracker.check_expected_reuse(sess);\n \n         sess.abort_if_errors();\n "}, {"sha": "983e5cee8237d801c8295fb85e706c993f0d5e7e", "filename": "compiler/rustc_error_messages/locales/en-US/session.ftl", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/2c77f3e9c5804edc0bb520c7b4774424cea6beb0/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fsession.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/2c77f3e9c5804edc0bb520c7b4774424cea6beb0/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fsession.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fsession.ftl?ref=2c77f3e9c5804edc0bb520c7b4774424cea6beb0", "patch": "@@ -1,5 +1,8 @@\n session_incorrect_cgu_reuse_type =\n-    CGU-reuse for `{$cgu_user_name}` is `{$actual_reuse}` but should be `{$at_least}``${expected_reuse}`\n+    CGU-reuse for `{$cgu_user_name}` is `{$actual_reuse}` but should be {$at_least ->\n+    [one] {\"at least \"}\n+    *[other] {\"\"}\n+    }`{$expected_reuse}`\n \n session_cgu_not_recorded =\n     CGU-reuse for `{$cgu_user_name}` is (mangled: `{$cgu_name}`) was not recorded`"}, {"sha": "2a4a772f61085dfe13dfba1a48d4944cd39e0f56", "filename": "compiler/rustc_session/src/cgu_reuse_tracker.rs", "status": "modified", "additions": 5, "deletions": 12, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/2c77f3e9c5804edc0bb520c7b4774424cea6beb0/compiler%2Frustc_session%2Fsrc%2Fcgu_reuse_tracker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2c77f3e9c5804edc0bb520c7b4774424cea6beb0/compiler%2Frustc_session%2Fsrc%2Fcgu_reuse_tracker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fcgu_reuse_tracker.rs?ref=2c77f3e9c5804edc0bb520c7b4774424cea6beb0", "patch": "@@ -2,7 +2,8 @@\n //! compilation. This is used for incremental compilation tests and debug\n //! output.\n \n-use crate::errors::IncorrectCguReuseType;\n+use crate::errors::{CguNotRecorded, IncorrectCguReuseType};\n+use crate::Session;\n use rustc_data_structures::fx::FxHashMap;\n use rustc_errors::{DiagnosticArgValue, IntoDiagnosticArg};\n use rustc_span::{Span, Symbol};\n@@ -104,7 +105,7 @@ impl CguReuseTracker {\n         }\n     }\n \n-    pub fn check_expected_reuse(&self, diag: &rustc_errors::Handler) {\n+    pub fn check_expected_reuse(&self, sess: &Session) {\n         if let Some(ref data) = self.data {\n             let data = data.lock().unwrap();\n \n@@ -118,7 +119,7 @@ impl CguReuseTracker {\n                     };\n \n                     if error {\n-                        let at_least = if at_least { \"at least \" } else { \"\" };\n+                        let at_least = if at_least { 1 } else { 0 };\n                         IncorrectCguReuseType {\n                             span: error_span.0,\n                             cgu_user_name: &cgu_user_name,\n@@ -128,15 +129,7 @@ impl CguReuseTracker {\n                         };\n                     }\n                 } else {\n-                    //FIXME: Remove this once PR #100694 that implements `[fatal(..)]` is merged\n-                    let msg = format!(\n-                        \"CGU-reuse for `{cgu_user_name}` (mangled: `{cgu_name}`) was \\\n-                                       not recorded\"\n-                    );\n-                    diag.span_fatal(error_span.0, &msg)\n-\n-                    //FIXME: Uncomment this once PR #100694 that implements `[fatal(..)]` is merged\n-                    // CguNotRecorded { cgu_user_name, cgu_name };\n+                    sess.emit_fatal(CguNotRecorded { cgu_user_name, cgu_name });\n                 }\n             }\n         }"}, {"sha": "7252f1799dac178297ebcb0d024fea2444256e2f", "filename": "compiler/rustc_session/src/errors.rs", "status": "modified", "additions": 7, "deletions": 8, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/2c77f3e9c5804edc0bb520c7b4774424cea6beb0/compiler%2Frustc_session%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2c77f3e9c5804edc0bb520c7b4774424cea6beb0/compiler%2Frustc_session%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Ferrors.rs?ref=2c77f3e9c5804edc0bb520c7b4774424cea6beb0", "patch": "@@ -14,16 +14,15 @@ pub struct IncorrectCguReuseType<'a> {\n     pub cgu_user_name: &'a str,\n     pub actual_reuse: CguReuse,\n     pub expected_reuse: CguReuse,\n-    pub at_least: &'a str,\n+    pub at_least: u8,\n }\n \n-//FIXME: Uncomment this once PR #100694 that implements `[fatal(..)]` is merged\n-// #[derive(SessionDiagnostic)]\n-// #[fatal(session::cgu_not_recorded)]\n-// pub struct CguNotRecorded<'a> {\n-//     pub cgu_user_name: &'a str,\n-//     pub cgu_name: &'a str,\n-// }\n+#[derive(SessionDiagnostic)]\n+#[diag(session::cgu_not_recorded)]\n+pub struct CguNotRecorded<'a> {\n+    pub cgu_user_name: &'a str,\n+    pub cgu_name: &'a str,\n+}\n \n #[derive(SessionDiagnostic)]\n #[diag(session::feature_gate_error, code = \"E0658\")]"}]}