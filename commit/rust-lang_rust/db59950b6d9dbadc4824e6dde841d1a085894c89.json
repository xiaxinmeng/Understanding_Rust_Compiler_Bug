{"sha": "db59950b6d9dbadc4824e6dde841d1a085894c89", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRiNTk5NTBiNmQ5ZGJhZGM0ODI0ZTZkZGU4NDFkMWEwODU4OTRjODk=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2021-02-17T22:51:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-02-17T22:51:12Z"}, "message": "Rollup merge of #77728 - lygstate:master, r=Amanieu\n\nExpose force_quotes on Windows.\n\nOn Windows, the arg quotes and not quotes have different effect\nfor the program it called, if the program called are msys2/cygwin program.\nRefer to\nhttps://github.com/msys2/MSYS2-packages/issues/2176\n\nThis also solve the issues comes from\n\nhttps://internals.rust-lang.org/t/std-process-on-windows-is-escaping-raw-literals-which-causes-problems-with-chaining-commands/8163\n\nTracking issue:\nhttps://github.com/rust-lang/rust/issues/82227", "tree": {"sha": "8c2bbc7d246abd37d05fc1a8b938198ea3b6b035", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8c2bbc7d246abd37d05fc1a8b938198ea3b6b035"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/db59950b6d9dbadc4824e6dde841d1a085894c89", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgLZ3gCRBK7hj4Ov3rIwAAdHIIAJdXwbzf+BGpyp6AMc7neYMF\nvNHQPWTxTixYLoS/5CfUJxgE0pyWEhjMzaaeI5Cli5DQ9kzUTwBmpQ9XVu+2ncQ/\n5WrpewvcldwsCwsj5boWlUZhSmzP0gvywLSCL+lwPMTjfciZlmgkrBqtFGD9/b5m\ncBfaRP/b9XCdJtGxfqM2VrMv42q1SY/nANqew/FCFrPAlzEdvl5kDqNTRBXbX2gt\ns0AWPgwQnJjGyIvhcZXOdlisM19Bv2rIec6EF4sbiYxpxYtKongTsadQX6FfeXmW\nhTf3TU6kPwQIuh6tJWlHk3BTe765BQt45Fx4Mdig1M9W1C5uoxr2mUnNtfKk5qM=\n=Sq+s\n-----END PGP SIGNATURE-----\n", "payload": "tree 8c2bbc7d246abd37d05fc1a8b938198ea3b6b035\nparent 152f6609246558be5e2582e67376194815e6ba0d\nparent fa23ddf6e6932b0caa6ee14bd479264398a3a2a7\nauthor Dylan DPC <dylan.dpc@gmail.com> 1613602272 +0100\ncommitter GitHub <noreply@github.com> 1613602272 +0100\n\nRollup merge of #77728 - lygstate:master, r=Amanieu\n\nExpose force_quotes on Windows.\n\nOn Windows, the arg quotes and not quotes have different effect\nfor the program it called, if the program called are msys2/cygwin program.\nRefer to\nhttps://github.com/msys2/MSYS2-packages/issues/2176\n\nThis also solve the issues comes from\n\nhttps://internals.rust-lang.org/t/std-process-on-windows-is-escaping-raw-literals-which-causes-problems-with-chaining-commands/8163\n\nTracking issue:\nhttps://github.com/rust-lang/rust/issues/82227\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/db59950b6d9dbadc4824e6dde841d1a085894c89", "html_url": "https://github.com/rust-lang/rust/commit/db59950b6d9dbadc4824e6dde841d1a085894c89", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/db59950b6d9dbadc4824e6dde841d1a085894c89/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "152f6609246558be5e2582e67376194815e6ba0d", "url": "https://api.github.com/repos/rust-lang/rust/commits/152f6609246558be5e2582e67376194815e6ba0d", "html_url": "https://github.com/rust-lang/rust/commit/152f6609246558be5e2582e67376194815e6ba0d"}, {"sha": "fa23ddf6e6932b0caa6ee14bd479264398a3a2a7", "url": "https://api.github.com/repos/rust-lang/rust/commits/fa23ddf6e6932b0caa6ee14bd479264398a3a2a7", "html_url": "https://github.com/rust-lang/rust/commit/fa23ddf6e6932b0caa6ee14bd479264398a3a2a7"}], "stats": {"total": 59, "additions": 49, "deletions": 10}, "files": [{"sha": "67412e1677937b7afea82a624d6f13581bade34b", "filename": "library/std/src/sys/windows/ext/process.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/db59950b6d9dbadc4824e6dde841d1a085894c89/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fext%2Fprocess.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db59950b6d9dbadc4824e6dde841d1a085894c89/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fext%2Fprocess.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fext%2Fprocess.rs?ref=db59950b6d9dbadc4824e6dde841d1a085894c89", "patch": "@@ -105,6 +105,22 @@ pub trait CommandExt: Sealed {\n     /// [1]: https://docs.microsoft.com/en-us/windows/win32/procthread/process-creation-flags\n     #[stable(feature = \"windows_process_extensions\", since = \"1.16.0\")]\n     fn creation_flags(&mut self, flags: u32) -> &mut process::Command;\n+\n+    /// Forces all arguments to be wrapped in quote (`\"`) characters.\n+    ///\n+    /// This is useful for passing arguments to [MSYS2/Cygwin][1] based\n+    /// executables: these programs will expand unquoted arguments containing\n+    /// wildcard characters (`?` and `*`) by searching for any file paths\n+    /// matching the wildcard pattern.\n+    ///\n+    /// Adding quotes has no effect when passing arguments to programs\n+    /// that use [msvcrt][2]. This includes programs built with both\n+    /// MinGW and MSVC.\n+    ///\n+    /// [1]: <https://github.com/msys2/MSYS2-packages/issues/2176>\n+    /// [2]: <https://msdn.microsoft.com/en-us/library/17w5ykft.aspx>\n+    #[unstable(feature = \"windows_process_extensions_force_quotes\", issue = \"82227\")]\n+    fn force_quotes(&mut self, enabled: bool) -> &mut process::Command;\n }\n \n #[stable(feature = \"windows_process_extensions\", since = \"1.16.0\")]\n@@ -113,4 +129,9 @@ impl CommandExt for process::Command {\n         self.as_inner_mut().creation_flags(flags);\n         self\n     }\n+\n+    fn force_quotes(&mut self, enabled: bool) -> &mut process::Command {\n+        self.as_inner_mut().force_quotes(enabled);\n+        self\n+    }\n }"}, {"sha": "83d37795ee5c10bf4099a561cfe3ce6427ced88a", "filename": "library/std/src/sys/windows/process.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/db59950b6d9dbadc4824e6dde841d1a085894c89/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db59950b6d9dbadc4824e6dde841d1a085894c89/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs?ref=db59950b6d9dbadc4824e6dde841d1a085894c89", "patch": "@@ -78,6 +78,7 @@ pub struct Command {\n     stdin: Option<Stdio>,\n     stdout: Option<Stdio>,\n     stderr: Option<Stdio>,\n+    force_quotes_enabled: bool,\n }\n \n pub enum Stdio {\n@@ -109,6 +110,7 @@ impl Command {\n             stdin: None,\n             stdout: None,\n             stderr: None,\n+            force_quotes_enabled: false,\n         }\n     }\n \n@@ -134,6 +136,10 @@ impl Command {\n         self.flags = flags;\n     }\n \n+    pub fn force_quotes(&mut self, enabled: bool) {\n+        self.force_quotes_enabled = enabled;\n+    }\n+\n     pub fn get_program(&self) -> &OsStr {\n         &self.program\n     }\n@@ -181,7 +187,7 @@ impl Command {\n         si.dwFlags = c::STARTF_USESTDHANDLES;\n \n         let program = program.as_ref().unwrap_or(&self.program);\n-        let mut cmd_str = make_command_line(program, &self.args)?;\n+        let mut cmd_str = make_command_line(program, &self.args, self.force_quotes_enabled)?;\n         cmd_str.push(0); // add null terminator\n \n         // stolen from the libuv code.\n@@ -467,7 +473,7 @@ fn zeroed_process_information() -> c::PROCESS_INFORMATION {\n \n // Produces a wide string *without terminating null*; returns an error if\n // `prog` or any of the `args` contain a nul.\n-fn make_command_line(prog: &OsStr, args: &[OsString]) -> io::Result<Vec<u16>> {\n+fn make_command_line(prog: &OsStr, args: &[OsString], force_quotes: bool) -> io::Result<Vec<u16>> {\n     // Encode the command and arguments in a command line string such\n     // that the spawned process may recover them using CommandLineToArgvW.\n     let mut cmd: Vec<u16> = Vec::new();\n@@ -476,7 +482,7 @@ fn make_command_line(prog: &OsStr, args: &[OsString]) -> io::Result<Vec<u16>> {\n     append_arg(&mut cmd, prog, true)?;\n     for arg in args {\n         cmd.push(' ' as u16);\n-        append_arg(&mut cmd, arg, false)?;\n+        append_arg(&mut cmd, arg, force_quotes)?;\n     }\n     return Ok(cmd);\n "}, {"sha": "8830ae049c65d8b10e690ab770b1ba78debb827d", "filename": "library/std/src/sys/windows/process/tests.rs", "status": "modified", "additions": 19, "deletions": 7, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/db59950b6d9dbadc4824e6dde841d1a085894c89/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db59950b6d9dbadc4824e6dde841d1a085894c89/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess%2Ftests.rs?ref=db59950b6d9dbadc4824e6dde841d1a085894c89", "patch": "@@ -3,29 +3,41 @@ use crate::ffi::{OsStr, OsString};\n \n #[test]\n fn test_make_command_line() {\n-    fn test_wrapper(prog: &str, args: &[&str]) -> String {\n+    fn test_wrapper(prog: &str, args: &[&str], force_quotes: bool) -> String {\n         let command_line = &make_command_line(\n             OsStr::new(prog),\n             &args.iter().map(|a| OsString::from(a)).collect::<Vec<OsString>>(),\n+            force_quotes,\n         )\n         .unwrap();\n         String::from_utf16(command_line).unwrap()\n     }\n \n-    assert_eq!(test_wrapper(\"prog\", &[\"aaa\", \"bbb\", \"ccc\"]), \"\\\"prog\\\" aaa bbb ccc\");\n+    assert_eq!(test_wrapper(\"prog\", &[\"aaa\", \"bbb\", \"ccc\"], false), \"\\\"prog\\\" aaa bbb ccc\");\n \n     assert_eq!(\n-        test_wrapper(\"C:\\\\Program Files\\\\blah\\\\blah.exe\", &[\"aaa\"]),\n+        test_wrapper(\"C:\\\\Program Files\\\\blah\\\\blah.exe\", &[\"aaa\"], false),\n         \"\\\"C:\\\\Program Files\\\\blah\\\\blah.exe\\\" aaa\"\n     );\n     assert_eq!(\n-        test_wrapper(\"C:\\\\Program Files\\\\test\", &[\"aa\\\"bb\"]),\n+        test_wrapper(\"C:\\\\Program Files\\\\blah\\\\blah.exe\", &[\"aaa\", \"v*\"], false),\n+        \"\\\"C:\\\\Program Files\\\\blah\\\\blah.exe\\\" aaa v*\"\n+    );\n+    assert_eq!(\n+        test_wrapper(\"C:\\\\Program Files\\\\blah\\\\blah.exe\", &[\"aaa\", \"v*\"], true),\n+        \"\\\"C:\\\\Program Files\\\\blah\\\\blah.exe\\\" \\\"aaa\\\" \\\"v*\\\"\"\n+    );\n+    assert_eq!(\n+        test_wrapper(\"C:\\\\Program Files\\\\test\", &[\"aa\\\"bb\"], false),\n         \"\\\"C:\\\\Program Files\\\\test\\\" aa\\\\\\\"bb\"\n     );\n-    assert_eq!(test_wrapper(\"echo\", &[\"a b c\"]), \"\\\"echo\\\" \\\"a b c\\\"\");\n-    assert_eq!(test_wrapper(\"echo\", &[\"\\\" \\\\\\\" \\\\\", \"\\\\\"]), \"\\\"echo\\\" \\\"\\\\\\\" \\\\\\\\\\\\\\\" \\\\\\\\\\\" \\\\\");\n+    assert_eq!(test_wrapper(\"echo\", &[\"a b c\"], false), \"\\\"echo\\\" \\\"a b c\\\"\");\n+    assert_eq!(\n+        test_wrapper(\"echo\", &[\"\\\" \\\\\\\" \\\\\", \"\\\\\"], false),\n+        \"\\\"echo\\\" \\\"\\\\\\\" \\\\\\\\\\\\\\\" \\\\\\\\\\\" \\\\\"\n+    );\n     assert_eq!(\n-        test_wrapper(\"\\u{03c0}\\u{042f}\\u{97f3}\\u{00e6}\\u{221e}\", &[]),\n+        test_wrapper(\"\\u{03c0}\\u{042f}\\u{97f3}\\u{00e6}\\u{221e}\", &[], false),\n         \"\\\"\\u{03c0}\\u{042f}\\u{97f3}\\u{00e6}\\u{221e}\\\"\"\n     );\n }"}]}