{"sha": "f4b4f17662a7a1c80743b3108bb0da28b0fe47e5", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0YjRmMTc2NjJhN2ExYzgwNzQzYjMxMDhiYjBkYTI4YjBmZTQ3ZTU=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-11-17T15:47:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-17T15:47:36Z"}, "message": "Merge #6582\n\n6582: Fill the diagnostic code field in publish_diagnostics r=kjeremy a=Veykril\n\nFixes #6580\r\nBefore:\r\n![Code_znn6VgLLH9](https://user-images.githubusercontent.com/3757771/99408084-213f7100-28f0-11eb-8317-3f5c2b93313d.png)\r\nAfter:\r\n![Code_c4jJsvzOEA](https://user-images.githubusercontent.com/3757771/99408096-23093480-28f0-11eb-9bb2-8ebf2fb3d5a1.png)\r\n\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "2aa244cb6844eafa43a7a03178319fb6de20512f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2aa244cb6844eafa43a7a03178319fb6de20512f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f4b4f17662a7a1c80743b3108bb0da28b0fe47e5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfs/CYCRBK7hj4Ov3rIwAAdHIIAIoch+UdXI455G5Za2UYkKqZ\n4wgYin6gO7Jmq4gCcDUPIviQ2DwA/pigblDyNaXuS4vPuBA4Dq43H4TT9KmYyqZU\nb5vgoyfn0Yn0kBuOLVUK+yK0U+J4g7R/cX3ZiJq70QWGBlD52sSEF9XYrR2q88RR\nRgkjf3MySryyeYVV08r2jD5+rHZfJlo9X7jFtOLC8AZa1YpXREchuwMJuJZJtbkz\n8MqpPfRL2QYUIMB8K/ikWf9jXwDJAz9CTYM/sLi9GQktAJckIha8TYm6ZNRLs5yE\nTQdjvIYG+sbYBkZT30JkhUjLKIQNKERahMlM5ANXrPGlFMms91bKYA3uS41/oHE=\n=jC5K\n-----END PGP SIGNATURE-----\n", "payload": "tree 2aa244cb6844eafa43a7a03178319fb6de20512f\nparent 1863c0c7327724479b165c0ce91dcd54663334fd\nparent c868f0255f677a4cedb62c27af96758fffdd6f8f\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1605628056 +0000\ncommitter GitHub <noreply@github.com> 1605628056 +0000\n\nMerge #6582\n\n6582: Fill the diagnostic code field in publish_diagnostics r=kjeremy a=Veykril\n\nFixes #6580\r\nBefore:\r\n![Code_znn6VgLLH9](https://user-images.githubusercontent.com/3757771/99408084-213f7100-28f0-11eb-8317-3f5c2b93313d.png)\r\nAfter:\r\n![Code_c4jJsvzOEA](https://user-images.githubusercontent.com/3757771/99408096-23093480-28f0-11eb-9bb2-8ebf2fb3d5a1.png)\r\n\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f4b4f17662a7a1c80743b3108bb0da28b0fe47e5", "html_url": "https://github.com/rust-lang/rust/commit/f4b4f17662a7a1c80743b3108bb0da28b0fe47e5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f4b4f17662a7a1c80743b3108bb0da28b0fe47e5/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1863c0c7327724479b165c0ce91dcd54663334fd", "url": "https://api.github.com/repos/rust-lang/rust/commits/1863c0c7327724479b165c0ce91dcd54663334fd", "html_url": "https://github.com/rust-lang/rust/commit/1863c0c7327724479b165c0ce91dcd54663334fd"}, {"sha": "c868f0255f677a4cedb62c27af96758fffdd6f8f", "url": "https://api.github.com/repos/rust-lang/rust/commits/c868f0255f677a4cedb62c27af96758fffdd6f8f", "html_url": "https://github.com/rust-lang/rust/commit/c868f0255f677a4cedb62c27af96758fffdd6f8f"}], "stats": {"total": 50, "additions": 38, "deletions": 12}, "files": [{"sha": "d9ad8db6f76999def37cbbf11d770ffa0d8c0b4c", "filename": "crates/hir/src/diagnostics.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f4b4f17662a7a1c80743b3108bb0da28b0fe47e5/crates%2Fhir%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4b4f17662a7a1c80743b3108bb0da28b0fe47e5/crates%2Fhir%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fdiagnostics.rs?ref=f4b4f17662a7a1c80743b3108bb0da28b0fe47e5", "patch": "@@ -1,6 +1,8 @@\n //! FIXME: write short doc here\n pub use hir_def::diagnostics::{InactiveCode, UnresolvedModule};\n-pub use hir_expand::diagnostics::{Diagnostic, DiagnosticSink, DiagnosticSinkBuilder};\n+pub use hir_expand::diagnostics::{\n+    Diagnostic, DiagnosticCode, DiagnosticSink, DiagnosticSinkBuilder,\n+};\n pub use hir_ty::diagnostics::{\n     IncorrectCase, MismatchedArgCount, MissingFields, MissingMatchArms, MissingOkInTailExpr,\n     NoSuchField,"}, {"sha": "1043c6aeb5becc71a32202b086a16574bafae0af", "filename": "crates/hir_expand/src/diagnostics.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f4b4f17662a7a1c80743b3108bb0da28b0fe47e5/crates%2Fhir_expand%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4b4f17662a7a1c80743b3108bb0da28b0fe47e5/crates%2Fhir_expand%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fdiagnostics.rs?ref=f4b4f17662a7a1c80743b3108bb0da28b0fe47e5", "patch": "@@ -20,7 +20,7 @@ use syntax::SyntaxNodePtr;\n \n use crate::InFile;\n \n-#[derive(Copy, Clone, PartialEq)]\n+#[derive(Copy, Clone, Debug, PartialEq)]\n pub struct DiagnosticCode(pub &'static str);\n \n impl DiagnosticCode {"}, {"sha": "3df73ed4fa3450a5c21a4ad78a5ac34516ef558d", "filename": "crates/ide/src/diagnostics.rs", "status": "modified", "additions": 32, "deletions": 8, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/f4b4f17662a7a1c80743b3108bb0da28b0fe47e5/crates%2Fide%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4b4f17662a7a1c80743b3108bb0da28b0fe47e5/crates%2Fide%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fdiagnostics.rs?ref=f4b4f17662a7a1c80743b3108bb0da28b0fe47e5", "patch": "@@ -10,7 +10,7 @@ mod field_shorthand;\n use std::cell::RefCell;\n \n use hir::{\n-    diagnostics::{Diagnostic as _, DiagnosticSinkBuilder},\n+    diagnostics::{Diagnostic as _, DiagnosticCode, DiagnosticSinkBuilder},\n     Semantics,\n };\n use ide_db::base_db::SourceDatabase;\n@@ -35,15 +35,23 @@ pub struct Diagnostic {\n     pub severity: Severity,\n     pub fix: Option<Fix>,\n     pub unused: bool,\n+    pub code: Option<DiagnosticCode>,\n }\n \n impl Diagnostic {\n     fn error(range: TextRange, message: String) -> Self {\n-        Self { message, range, severity: Severity::Error, fix: None, unused: false }\n+        Self { message, range, severity: Severity::Error, fix: None, unused: false, code: None }\n     }\n \n     fn hint(range: TextRange, message: String) -> Self {\n-        Self { message, range, severity: Severity::WeakWarning, fix: None, unused: false }\n+        Self {\n+            message,\n+            range,\n+            severity: Severity::WeakWarning,\n+            fix: None,\n+            unused: false,\n+            code: None,\n+        }\n     }\n \n     fn with_fix(self, fix: Option<Fix>) -> Self {\n@@ -53,6 +61,10 @@ impl Diagnostic {\n     fn with_unused(self, unused: bool) -> Self {\n         Self { unused, ..self }\n     }\n+\n+    fn with_code(self, code: Option<DiagnosticCode>) -> Self {\n+        Self { code, ..self }\n+    }\n }\n \n #[derive(Debug)]\n@@ -126,7 +138,8 @@ pub(crate) fn diagnostics(\n             // Override severity and mark as unused.\n             res.borrow_mut().push(\n                 Diagnostic::hint(sema.diagnostics_display_range(d).range, d.message())\n-                    .with_unused(true),\n+                    .with_unused(true)\n+                    .with_code(Some(d.code())),\n             );\n         })\n         // Only collect experimental diagnostics when they're enabled.\n@@ -137,8 +150,10 @@ pub(crate) fn diagnostics(\n     let mut sink = sink_builder\n         // Diagnostics not handled above get no fix and default treatment.\n         .build(|d| {\n-            res.borrow_mut()\n-                .push(Diagnostic::error(sema.diagnostics_display_range(d).range, d.message()));\n+            res.borrow_mut().push(\n+                Diagnostic::error(sema.diagnostics_display_range(d).range, d.message())\n+                    .with_code(Some(d.code())),\n+            );\n         });\n \n     if let Some(m) = sema.to_module_def(file_id) {\n@@ -149,11 +164,15 @@ pub(crate) fn diagnostics(\n }\n \n fn diagnostic_with_fix<D: DiagnosticWithFix>(d: &D, sema: &Semantics<RootDatabase>) -> Diagnostic {\n-    Diagnostic::error(sema.diagnostics_display_range(d).range, d.message()).with_fix(d.fix(&sema))\n+    Diagnostic::error(sema.diagnostics_display_range(d).range, d.message())\n+        .with_fix(d.fix(&sema))\n+        .with_code(Some(d.code()))\n }\n \n fn warning_with_fix<D: DiagnosticWithFix>(d: &D, sema: &Semantics<RootDatabase>) -> Diagnostic {\n-    Diagnostic::hint(sema.diagnostics_display_range(d).range, d.message()).with_fix(d.fix(&sema))\n+    Diagnostic::hint(sema.diagnostics_display_range(d).range, d.message())\n+        .with_fix(d.fix(&sema))\n+        .with_code(Some(d.code()))\n }\n \n fn check_unnecessary_braces_in_use_statement(\n@@ -589,6 +608,11 @@ fn test_fn() {\n                             },\n                         ),\n                         unused: false,\n+                        code: Some(\n+                            DiagnosticCode(\n+                                \"unresolved-module\",\n+                            ),\n+                        ),\n                     },\n                 ]\n             \"#]],"}, {"sha": "8d2d86f0e4f6f6fe5ecc51aa06f1cc70c7754ffc", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f4b4f17662a7a1c80743b3108bb0da28b0fe47e5/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4b4f17662a7a1c80743b3108bb0da28b0fe47e5/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=f4b4f17662a7a1c80743b3108bb0da28b0fe47e5", "patch": "@@ -18,7 +18,7 @@ use lsp_types::{\n     CallHierarchyOutgoingCall, CallHierarchyOutgoingCallsParams, CallHierarchyPrepareParams,\n     CodeActionKind, CodeLens, Command, CompletionItem, Diagnostic, DiagnosticTag,\n     DocumentFormattingParams, DocumentHighlight, DocumentSymbol, FoldingRange, FoldingRangeParams,\n-    HoverContents, Location, Position, PrepareRenameResponse, Range, RenameParams,\n+    HoverContents, Location, NumberOrString, Position, PrepareRenameResponse, Range, RenameParams,\n     SemanticTokensDeltaParams, SemanticTokensFullDeltaResult, SemanticTokensParams,\n     SemanticTokensRangeParams, SemanticTokensRangeResult, SemanticTokensResult, SymbolInformation,\n     SymbolTag, TextDocumentIdentifier, Url, WorkspaceEdit,\n@@ -1128,7 +1128,7 @@ pub(crate) fn publish_diagnostics(\n         .map(|d| Diagnostic {\n             range: to_proto::range(&line_index, d.range),\n             severity: Some(to_proto::diagnostic_severity(d.severity)),\n-            code: None,\n+            code: d.code.map(|d| d.as_str().to_owned()).map(NumberOrString::String),\n             code_description: None,\n             source: Some(\"rust-analyzer\".to_string()),\n             message: d.message,"}]}