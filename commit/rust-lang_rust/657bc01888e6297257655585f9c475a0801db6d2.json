{"sha": "657bc01888e6297257655585f9c475a0801db6d2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY1N2JjMDE4ODhlNjI5NzI1NzY1NTU4NWY5YzQ3NWEwODAxZGI2ZDI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-31T20:03:18Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-31T20:03:18Z"}, "message": "Auto merge of #85702 - Aaron1011:no-vec-sort, r=michaelwoerister\n\nDon't sort a `Vec` before computing its `DepTrackingHash`\n\nPreviously, we sorted the vec prior to hashing, making the hash\nindependent of the original (command-line argument) order. However, the\noriginal vec was still always kept in the original order, so we were\nrelying on the rest of the compiler always working with it in an\n'order-independent' way.\n\nThis assumption was not being upheld by the `native_libraries` query -\nthe order of the entires in its result depends on the order of entries\nin `Options.libs`. This lead to an 'unstable fingerprint' ICE when the\n`-l` arguments were re-ordered.\n\nThis PR removes the sorting logic entirely. Re-ordering command-line\narguments (without adding/removing/changing any arguments) seems like a\nreally niche use case, and correctly optimizing for it would require\nadditional work. By always hashing arguments in their original order, we\ncan entirely avoid a cause of 'unstable fingerprint' errors.", "tree": {"sha": "a6f2d29abd336edb01822efe47d4885448d1958a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a6f2d29abd336edb01822efe47d4885448d1958a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/657bc01888e6297257655585f9c475a0801db6d2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/657bc01888e6297257655585f9c475a0801db6d2", "html_url": "https://github.com/rust-lang/rust/commit/657bc01888e6297257655585f9c475a0801db6d2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/657bc01888e6297257655585f9c475a0801db6d2/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6a3dce99f6ee4fd1ae317fe486b214dad7f4c1ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/6a3dce99f6ee4fd1ae317fe486b214dad7f4c1ee", "html_url": "https://github.com/rust-lang/rust/commit/6a3dce99f6ee4fd1ae317fe486b214dad7f4c1ee"}, {"sha": "605513a513ebe9dfe4d0716c87196d99160981a8", "url": "https://api.github.com/repos/rust-lang/rust/commits/605513a513ebe9dfe4d0716c87196d99160981a8", "html_url": "https://github.com/rust-lang/rust/commit/605513a513ebe9dfe4d0716c87196d99160981a8"}], "stats": {"total": 61, "additions": 31, "deletions": 30}, "files": [{"sha": "5d8a6084f2e0b486809c8705314e423618cbeab3", "filename": "compiler/rustc_interface/src/tests.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/657bc01888e6297257655585f9c475a0801db6d2/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/657bc01888e6297257655585f9c475a0801db6d2/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Ftests.rs?ref=657bc01888e6297257655585f9c475a0801db6d2", "patch": "@@ -252,7 +252,8 @@ fn test_lints_tracking_hash_different_construction_order() {\n         (String::from(\"d\"), Level::Forbid),\n     ];\n \n-    assert_same_hash(&v1, &v2);\n+    // The hash should be order-dependent\n+    assert_different_hash(&v1, &v2);\n }\n \n #[test]\n@@ -491,9 +492,10 @@ fn test_native_libs_tracking_hash_different_order() {\n         },\n     ];\n \n-    assert_same_hash(&v1, &v2);\n-    assert_same_hash(&v1, &v3);\n-    assert_same_hash(&v2, &v3);\n+    // The hash should be order-dependent\n+    assert_different_hash(&v1, &v2);\n+    assert_different_hash(&v1, &v3);\n+    assert_different_hash(&v2, &v3);\n }\n \n #[test]"}, {"sha": "52f8b536f4aad7074be615dd90d79c155bb5d30e", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 10, "deletions": 26, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/657bc01888e6297257655585f9c475a0801db6d2/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/657bc01888e6297257655585f9c475a0801db6d2/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=657bc01888e6297257655585f9c475a0801db6d2", "patch": "@@ -2427,22 +2427,6 @@ crate mod dep_tracking {\n         )+};\n     }\n \n-    macro_rules! impl_dep_tracking_hash_for_sortable_vec_of {\n-        ($($t:ty),+ $(,)?) => {$(\n-            impl DepTrackingHash for Vec<$t> {\n-                fn hash(&self, hasher: &mut DefaultHasher, error_format: ErrorOutputType) {\n-                    let mut elems: Vec<&$t> = self.iter().collect();\n-                    elems.sort();\n-                    Hash::hash(&elems.len(), hasher);\n-                    for (index, elem) in elems.iter().enumerate() {\n-                        Hash::hash(&index, hasher);\n-                        DepTrackingHash::hash(*elem, hasher, error_format);\n-                    }\n-                }\n-            }\n-        )+};\n-    }\n-\n     impl_dep_tracking_hash_via_hash!(\n         bool,\n         usize,\n@@ -2491,16 +2475,6 @@ crate mod dep_tracking {\n         TrimmedDefPaths,\n     );\n \n-    impl_dep_tracking_hash_for_sortable_vec_of!(\n-        String,\n-        PathBuf,\n-        (PathBuf, PathBuf),\n-        CrateType,\n-        NativeLib,\n-        (String, lint::Level),\n-        (String, u64)\n-    );\n-\n     impl<T1, T2> DepTrackingHash for (T1, T2)\n     where\n         T1: DepTrackingHash,\n@@ -2530,6 +2504,16 @@ crate mod dep_tracking {\n         }\n     }\n \n+    impl<T: DepTrackingHash> DepTrackingHash for Vec<T> {\n+        fn hash(&self, hasher: &mut DefaultHasher, error_format: ErrorOutputType) {\n+            Hash::hash(&self.len(), hasher);\n+            for (index, elem) in self.iter().enumerate() {\n+                Hash::hash(&index, hasher);\n+                DepTrackingHash::hash(elem, hasher, error_format);\n+            }\n+        }\n+    }\n+\n     // This is a stable hash because BTreeMap is a sorted container\n     crate fn stable_hash(\n         sub_hashes: BTreeMap<&'static str, &dyn DepTrackingHash>,"}, {"sha": "57cde5f7c6e48609c0d9e1cc4621e151e8b3eb84", "filename": "src/test/incremental/link_order/auxiliary/my_lib.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/657bc01888e6297257655585f9c475a0801db6d2/src%2Ftest%2Fincremental%2Flink_order%2Fauxiliary%2Fmy_lib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/657bc01888e6297257655585f9c475a0801db6d2/src%2Ftest%2Fincremental%2Flink_order%2Fauxiliary%2Fmy_lib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Flink_order%2Fauxiliary%2Fmy_lib.rs?ref=657bc01888e6297257655585f9c475a0801db6d2", "patch": "@@ -0,0 +1,3 @@\n+// no-prefer-dynamic\n+//[cfail1] compile-flags: -lbar -lfoo --crate-type lib\n+//[cfail2] compile-flags: -lfoo -lbar --crate-type lib"}, {"sha": "d211c295bc49fd340b88f61205a5b4ab262dfa1f", "filename": "src/test/incremental/link_order/main.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/657bc01888e6297257655585f9c475a0801db6d2/src%2Ftest%2Fincremental%2Flink_order%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/657bc01888e6297257655585f9c475a0801db6d2/src%2Ftest%2Fincremental%2Flink_order%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Flink_order%2Fmain.rs?ref=657bc01888e6297257655585f9c475a0801db6d2", "patch": "@@ -0,0 +1,12 @@\n+// aux-build:my_lib.rs\n+// error-pattern: error: linking with\n+// revisions:cfail1 cfail2\n+// compile-flags:-Z query-dep-graph\n+\n+// Tests that re-ordering the `-l` arguments used\n+// when compiling an external dependency does not lead to\n+// an 'unstable fingerprint' error.\n+\n+extern crate my_lib;\n+\n+fn main() {}"}]}