{"sha": "25bfa153710c24ed2f7f6fa0dd3c0758a1c27973", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI1YmZhMTUzNzEwYzI0ZWQyZjdmNmZhMGRkM2MwNzU4YTFjMjc5NzM=", "commit": {"author": {"name": "Corey Farwell", "email": "coreyf@rwell.org", "date": "2020-12-10T23:51:30Z"}, "committer": {"name": "Corey Farwell", "email": "coreyf@rwell.org", "date": "2020-12-10T23:51:30Z"}, "message": "Manually code-sign after running install_name_tool", "tree": {"sha": "15a7b2bb0669befea83827ea5efd05bf7ce181bd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/15a7b2bb0669befea83827ea5efd05bf7ce181bd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/25bfa153710c24ed2f7f6fa0dd3c0758a1c27973", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/25bfa153710c24ed2f7f6fa0dd3c0758a1c27973", "html_url": "https://github.com/rust-lang/rust/commit/25bfa153710c24ed2f7f6fa0dd3c0758a1c27973", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/25bfa153710c24ed2f7f6fa0dd3c0758a1c27973/comments", "author": {"login": "frewsxcv", "id": 416575, "node_id": "MDQ6VXNlcjQxNjU3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/416575?v=4", "gravatar_id": "", "url": "https://api.github.com/users/frewsxcv", "html_url": "https://github.com/frewsxcv", "followers_url": "https://api.github.com/users/frewsxcv/followers", "following_url": "https://api.github.com/users/frewsxcv/following{/other_user}", "gists_url": "https://api.github.com/users/frewsxcv/gists{/gist_id}", "starred_url": "https://api.github.com/users/frewsxcv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/frewsxcv/subscriptions", "organizations_url": "https://api.github.com/users/frewsxcv/orgs", "repos_url": "https://api.github.com/users/frewsxcv/repos", "events_url": "https://api.github.com/users/frewsxcv/events{/privacy}", "received_events_url": "https://api.github.com/users/frewsxcv/received_events", "type": "User", "site_admin": false}, "committer": {"login": "frewsxcv", "id": 416575, "node_id": "MDQ6VXNlcjQxNjU3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/416575?v=4", "gravatar_id": "", "url": "https://api.github.com/users/frewsxcv", "html_url": "https://github.com/frewsxcv", "followers_url": "https://api.github.com/users/frewsxcv/followers", "following_url": "https://api.github.com/users/frewsxcv/following{/other_user}", "gists_url": "https://api.github.com/users/frewsxcv/gists{/gist_id}", "starred_url": "https://api.github.com/users/frewsxcv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/frewsxcv/subscriptions", "organizations_url": "https://api.github.com/users/frewsxcv/orgs", "repos_url": "https://api.github.com/users/frewsxcv/repos", "events_url": "https://api.github.com/users/frewsxcv/events{/privacy}", "received_events_url": "https://api.github.com/users/frewsxcv/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d5173334465b9d58f3a15d59bd496af1c34f6f45", "url": "https://api.github.com/repos/rust-lang/rust/commits/d5173334465b9d58f3a15d59bd496af1c34f6f45", "html_url": "https://github.com/rust-lang/rust/commit/d5173334465b9d58f3a15d59bd496af1c34f6f45"}], "stats": {"total": 34, "additions": 26, "deletions": 8}, "files": [{"sha": "3cfb2f2836d5846286be412e01f3ce78d80509f7", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 26, "deletions": 8, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/25bfa153710c24ed2f7f6fa0dd3c0758a1c27973/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25bfa153710c24ed2f7f6fa0dd3c0758a1c27973/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=25bfa153710c24ed2f7f6fa0dd3c0758a1c27973", "patch": "@@ -356,14 +356,11 @@ fn copy_sanitizers(\n         builder.copy(&runtime.path, &dst);\n \n         if target == \"x86_64-apple-darwin\" || target == \"aarch64-apple-darwin\" {\n-            // Update the library install name reflect the fact it has been renamed.\n-            let status = Command::new(\"install_name_tool\")\n-                .arg(\"-id\")\n-                .arg(format!(\"@rpath/{}\", runtime.name))\n-                .arg(&dst)\n-                .status()\n-                .expect(\"failed to execute `install_name_tool`\");\n-            assert!(status.success());\n+            // Update the library\u2019s install name to reflect that it has has been renamed.\n+            apple_darwin_update_library_name(&dst, &format!(\"@rpath/{}\", &runtime.name));\n+            // Upon renaming the install name, the code signature of the file will invalidate,\n+            // so we will sign it again.\n+            apple_darwin_sign_file(&dst);\n         }\n \n         target_deps.push(dst);\n@@ -372,6 +369,27 @@ fn copy_sanitizers(\n     target_deps\n }\n \n+fn apple_darwin_update_library_name(library_path: &Path, new_name: &str) {\n+    let status = Command::new(\"install_name_tool\")\n+        .arg(\"-id\")\n+        .arg(new_name)\n+        .arg(library_path)\n+        .status()\n+        .expect(\"failed to execute `install_name_tool`\");\n+    assert!(status.success());\n+}\n+\n+fn apple_darwin_sign_file(file_path: &Path) {\n+    let status = Command::new(\"codesign\")\n+        .arg(\"-f\") // Force to rewrite the existing signature\n+        .arg(\"-s\")\n+        .arg(\"-\")\n+        .arg(file_path)\n+        .status()\n+        .expect(\"failed to execute `codesign`\");\n+    assert!(status.success());\n+}\n+\n #[derive(Debug, Copy, Clone, PartialEq, Eq, Hash)]\n pub struct StartupObjects {\n     pub compiler: Compiler,"}]}