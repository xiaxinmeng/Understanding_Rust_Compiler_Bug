{"sha": "9919ad6e9ed113557c68c430de2e0f434e4f5b6e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk5MTlhZDZlOWVkMTEzNTU3YzY4YzQzMGRlMmUwZjQzNGU0ZjViNmU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-01-05T00:20:18Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-01-05T00:20:18Z"}, "message": "Auto merge of #80426 - jyn514:bootstrap-caching, r=Mark-Simulacrum\n\nDon't use `self.date` unconditionally for `program_out_of_date()`\n\nThis avoids unnecessary cache invalidations for programs not affected by\nthe stage0 version (which is everything except the stage0 compiler\nitself).\n\nThe redundant invalidations weren't noticed until now because they only\nshowed up on stage0 bumps, at which point people are used to rebuilding\neverything anyway. I noticed it in https://github.com/rust-lang/rust/pull/79540\nbecause I wasn't adding `self.date` to the stamp file (because I didn't realize it was necessary). Rather than\nadding self.date I thought it was better to remove it from the cache key.", "tree": {"sha": "38ad2662014b3106ad2ab74fc85fe0d197870fae", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/38ad2662014b3106ad2ab74fc85fe0d197870fae"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9919ad6e9ed113557c68c430de2e0f434e4f5b6e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9919ad6e9ed113557c68c430de2e0f434e4f5b6e", "html_url": "https://github.com/rust-lang/rust/commit/9919ad6e9ed113557c68c430de2e0f434e4f5b6e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9919ad6e9ed113557c68c430de2e0f434e4f5b6e/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "61f5a0092364061ec5649ca98d5e3e9b927880fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/61f5a0092364061ec5649ca98d5e3e9b927880fe", "html_url": "https://github.com/rust-lang/rust/commit/61f5a0092364061ec5649ca98d5e3e9b927880fe"}, {"sha": "2f063cd39487714bd218ea2a23cfae64828a9058", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f063cd39487714bd218ea2a23cfae64828a9058", "html_url": "https://github.com/rust-lang/rust/commit/2f063cd39487714bd218ea2a23cfae64828a9058"}], "stats": {"total": 21, "additions": 11, "deletions": 10}, "files": [{"sha": "f60ae02bffee426bd8b72b2bdf6bf473656d6300", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/9919ad6e9ed113557c68c430de2e0f434e4f5b6e/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/9919ad6e9ed113557c68c430de2e0f434e4f5b6e/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=9919ad6e9ed113557c68c430de2e0f434e4f5b6e", "patch": "@@ -393,7 +393,7 @@ def download_stage0(self):\n \n         if self.rustc().startswith(self.bin_root()) and \\\n                 (not os.path.exists(self.rustc()) or\n-                 self.program_out_of_date(self.rustc_stamp())):\n+                 self.program_out_of_date(self.rustc_stamp(), self.date)):\n             if os.path.exists(self.bin_root()):\n                 shutil.rmtree(self.bin_root())\n             tarball_suffix = '.tar.xz' if support_xz() else '.tar.gz'\n@@ -429,7 +429,7 @@ def download_stage0(self):\n                 self.fix_bin_or_dylib(\"{}/bin/rustfmt\".format(self.bin_root()))\n                 self.fix_bin_or_dylib(\"{}/bin/cargo-fmt\".format(self.bin_root()))\n                 with output(self.rustfmt_stamp()) as rustfmt_stamp:\n-                    rustfmt_stamp.write(self.date + self.rustfmt_channel)\n+                    rustfmt_stamp.write(self.rustfmt_channel)\n \n         if self.downloading_llvm():\n             # We want the most recent LLVM submodule update to avoid downloading\n@@ -456,7 +456,7 @@ def download_stage0(self):\n                 for binary in [\"llvm-config\", \"FileCheck\"]:\n                     self.fix_bin_or_dylib(\"{}/bin/{}\".format(self.llvm_root(), binary))\n                 with output(self.llvm_stamp()) as llvm_stamp:\n-                    llvm_stamp.write(self.date + llvm_sha + str(llvm_assertions))\n+                    llvm_stamp.write(llvm_sha + str(llvm_assertions))\n \n     def downloading_llvm(self):\n         opt = self.get_toml('download-ci-llvm', 'llvm')\n@@ -623,12 +623,12 @@ def llvm_stamp(self):\n         return os.path.join(self.llvm_root(), '.llvm-stamp')\n \n \n-    def program_out_of_date(self, stamp_path, extra=\"\"):\n+    def program_out_of_date(self, stamp_path, key):\n         \"\"\"Check if the given program stamp is out of date\"\"\"\n         if not os.path.exists(stamp_path) or self.clean:\n             return True\n         with open(stamp_path, 'r') as stamp:\n-            return (self.date + extra) != stamp.read()\n+            return key != stamp.read()\n \n     def bin_root(self):\n         \"\"\"Return the binary root directory"}, {"sha": "615071141594f12a6d28fcb7db79ed98e93f6f19", "filename": "src/bootstrap/bootstrap_test.py", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/9919ad6e9ed113557c68c430de2e0f434e4f5b6e/src%2Fbootstrap%2Fbootstrap_test.py", "raw_url": "https://github.com/rust-lang/rust/raw/9919ad6e9ed113557c68c430de2e0f434e4f5b6e/src%2Fbootstrap%2Fbootstrap_test.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap_test.py?ref=9919ad6e9ed113557c68c430de2e0f434e4f5b6e", "patch": "@@ -70,6 +70,7 @@ def setUp(self):\n         self.build.build_dir = self.container\n         self.rustc_stamp_path = os.path.join(self.container, \"stage0\",\n                                              \".rustc-stamp\")\n+        self.key = self.build.date + str(None)\n \n     def tearDown(self):\n         rmtree(self.container)\n@@ -78,19 +79,19 @@ def test_stamp_path_does_not_exists(self):\n         \"\"\"Return True when the stamp file does not exists\"\"\"\n         if os.path.exists(self.rustc_stamp_path):\n             os.unlink(self.rustc_stamp_path)\n-        self.assertTrue(self.build.program_out_of_date(self.rustc_stamp_path))\n+        self.assertTrue(self.build.program_out_of_date(self.rustc_stamp_path, self.key))\n \n     def test_dates_are_different(self):\n         \"\"\"Return True when the dates are different\"\"\"\n         with open(self.rustc_stamp_path, \"w\") as rustc_stamp:\n-            rustc_stamp.write(\"2017-06-14\")\n-        self.assertTrue(self.build.program_out_of_date(self.rustc_stamp_path))\n+            rustc_stamp.write(\"2017-06-14None\")\n+        self.assertTrue(self.build.program_out_of_date(self.rustc_stamp_path, self.key))\n \n     def test_same_dates(self):\n         \"\"\"Return False both dates match\"\"\"\n         with open(self.rustc_stamp_path, \"w\") as rustc_stamp:\n-            rustc_stamp.write(\"2017-06-15\")\n-        self.assertFalse(self.build.program_out_of_date(self.rustc_stamp_path))\n+            rustc_stamp.write(\"2017-06-15None\")\n+        self.assertFalse(self.build.program_out_of_date(self.rustc_stamp_path, self.key))\n \n \n if __name__ == '__main__':"}]}