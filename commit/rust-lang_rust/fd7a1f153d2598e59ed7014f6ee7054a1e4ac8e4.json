{"sha": "fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4", "node_id": "C_kwDOAAsO6NoAKGZkN2ExZjE1M2QyNTk4ZTU5ZWQ3MDE0ZjZlZTcwNTRhMWU0YWM4ZTQ", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-04-16T05:12:46Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-04-16T05:12:46Z"}, "message": "Rollup merge of #96004 - JakobDegen:fix-validator-ice, r=petrochenkov\n\nConsider lifetimes when comparing types for equality in MIR validator\n\nCloses #95978 .", "tree": {"sha": "78c3a227e7009f6133ccb4d6bb7be3fe06b5dfa0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/78c3a227e7009f6133ccb4d6bb7be3fe06b5dfa0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiWlBOCRBK7hj4Ov3rIwAAh1UIAAC5G6cT9hKVKUVhIAjUmQ+q\nXx9uKIbYE3bLsFO3puboX1kvKw4fcrx6oZJoKMkjnUlM6JJJy5wEL76YWX8BeD+D\n1I8Suh99hJUPffyPQJPx7Lt8rOnYYhV4+f9Xvbus0/iMI40mhq1ZxzJwwpjVVId+\nkwuxj4ZKd1Rso2F0YfJ+1gVGRElaVxxsAoJMMdOhubpH5gab1EV0UZnP45Fn2IqU\nmw1dPqiO25E2ByDc+8vLIyq+VVX+4Bn6kTZGfcCDHnB8GeNDi3/+kDZ283sU/Ad4\nAA0d/sR3jETmdfQLUaiORJtfEYVRByrE3iRJp61CxwPaJRRsD3aYbC1fNY0jv0s=\n=CNVN\n-----END PGP SIGNATURE-----\n", "payload": "tree 78c3a227e7009f6133ccb4d6bb7be3fe06b5dfa0\nparent ea131bca17144d01434cc5ec5d12cb03bc69dbcb\nparent d5f3863204b655ad4498f08c3a02dc320b7b6ea1\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1650085966 +0200\ncommitter GitHub <noreply@github.com> 1650085966 +0200\n\nRollup merge of #96004 - JakobDegen:fix-validator-ice, r=petrochenkov\n\nConsider lifetimes when comparing types for equality in MIR validator\n\nCloses #95978 .\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4", "html_url": "https://github.com/rust-lang/rust/commit/fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ea131bca17144d01434cc5ec5d12cb03bc69dbcb", "url": "https://api.github.com/repos/rust-lang/rust/commits/ea131bca17144d01434cc5ec5d12cb03bc69dbcb", "html_url": "https://github.com/rust-lang/rust/commit/ea131bca17144d01434cc5ec5d12cb03bc69dbcb"}, {"sha": "d5f3863204b655ad4498f08c3a02dc320b7b6ea1", "url": "https://api.github.com/repos/rust-lang/rust/commits/d5f3863204b655ad4498f08c3a02dc320b7b6ea1", "html_url": "https://github.com/rust-lang/rust/commit/d5f3863204b655ad4498f08c3a02dc320b7b6ea1"}], "stats": {"total": 20, "additions": 15, "deletions": 5}, "files": [{"sha": "79d427ccc4469c08ef9e82d908063f5c6efca281", "filename": "compiler/rustc_const_eval/src/transform/validate.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs?ref=fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4", "patch": "@@ -315,9 +315,8 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n                                     | ty::FnPtr(..)\n                             )\n                         }\n-                        // None of the possible types have lifetimes, so we can just compare\n-                        // directly\n-                        if a != b {\n+                        // The function pointer types can have lifetimes\n+                        if !self.mir_assign_valid_types(a, b) {\n                             self.fail(\n                                 location,\n                                 format!(\"Cannot compare unequal types {:?} and {:?}\", a, b),\n@@ -464,7 +463,7 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n                 };\n                 // since CopyNonOverlapping is parametrized by 1 type,\n                 // we only need to check that they are equal and not keep an extra parameter.\n-                if op_src_ty != op_dst_ty {\n+                if !self.mir_assign_valid_types(op_src_ty, op_dst_ty) {\n                     self.fail(location, format!(\"bad arg ({:?} != {:?})\", op_src_ty, op_dst_ty));\n                 }\n "}, {"sha": "49769b7ae3d89cdbf58dfb875d8e0eda79cbb882", "filename": "compiler/rustc_middle/src/mir/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs?ref=fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4", "patch": "@@ -2518,7 +2518,8 @@ pub enum Rvalue<'tcx> {\n     /// * `Offset` has the same semantics as [`offset`](pointer::offset), except that the second\n     ///   parameter may be a `usize` as well.\n     /// * The comparison operations accept `bool`s, `char`s, signed or unsigned integers, floats,\n-    ///   raw pointers, or function pointers of matching types and return a `bool`.\n+    ///   raw pointers, or function pointers and return a `bool`. The types of the operands must be\n+    ///   matching, up to the usual caveat of the lifetimes in function pointers.\n     /// * Left and right shift operations accept signed or unsigned integers not necessarily of the\n     ///   same type and return a value of the same type as their LHS. Like in Rust, the RHS is\n     ///   truncated as needed."}, {"sha": "cd6c5bf271935a8b13b76fc8a992e44179f0da9e", "filename": "src/test/ui/mir/issue-95978-validator-lifetime-comparison.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4/src%2Ftest%2Fui%2Fmir%2Fissue-95978-validator-lifetime-comparison.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4/src%2Ftest%2Fui%2Fmir%2Fissue-95978-validator-lifetime-comparison.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmir%2Fissue-95978-validator-lifetime-comparison.rs?ref=fd7a1f153d2598e59ed7014f6ee7054a1e4ac8e4", "patch": "@@ -0,0 +1,10 @@\n+// check-pass\n+// compile-flags: -Zvalidate-mir\n+\n+fn foo(_a: &str) {}\n+\n+fn main() {\n+    let x = foo as fn(&'static str);\n+\n+    let _ = x == foo;\n+}"}]}