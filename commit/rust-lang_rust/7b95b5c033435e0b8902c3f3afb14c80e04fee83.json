{"sha": "7b95b5c033435e0b8902c3f3afb14c80e04fee83", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdiOTViNWMwMzM0MzVlMGI4OTAyYzNmM2FmYjE0YzgwZTA0ZmVlODM=", "commit": {"author": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2011-04-29T19:20:10Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2011-04-29T19:20:20Z"}, "message": "Don't emit metadata unless compiling -shared.", "tree": {"sha": "b42d338d615d96c2c30e991555730ad39b9c793f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b42d338d615d96c2c30e991555730ad39b9c793f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7b95b5c033435e0b8902c3f3afb14c80e04fee83", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7b95b5c033435e0b8902c3f3afb14c80e04fee83", "html_url": "https://github.com/rust-lang/rust/commit/7b95b5c033435e0b8902c3f3afb14c80e04fee83", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7b95b5c033435e0b8902c3f3afb14c80e04fee83/comments", "author": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c39a95da90a3d8247e011f6a42f0c53ced34de97", "url": "https://api.github.com/repos/rust-lang/rust/commits/c39a95da90a3d8247e011f6a42f0c53ced34de97", "html_url": "https://github.com/rust-lang/rust/commit/c39a95da90a3d8247e011f6a42f0c53ced34de97"}], "stats": {"total": 13, "additions": 8, "deletions": 5}, "files": [{"sha": "806f38b52528126f221f03896834f12cb5f8a1b5", "filename": "src/comp/middle/metadata.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/7b95b5c033435e0b8902c3f3afb14c80e04fee83/src%2Fcomp%2Fmiddle%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b95b5c033435e0b8902c3f3afb14c80e04fee83/src%2Fcomp%2Fmiddle%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Fmetadata.rs?ref=7b95b5c033435e0b8902c3f3afb14c80e04fee83", "patch": "@@ -235,9 +235,9 @@ mod Encode {\n }\n \n \n-// Returns a Plain Old LLVM String, *without* the trailing zero byte.\n+// Returns a Plain Old LLVM String.\n fn C_postr(str s) -> ValueRef {\n-    ret llvm.LLVMConstString(_str.buf(s), _str.byte_len(s) - 1u, False);\n+    ret llvm.LLVMConstString(_str.buf(s), _str.byte_len(s), False);\n }\n \n \n@@ -674,8 +674,11 @@ fn encode_metadata(@trans.crate_ctxt cx, @ast.crate crate)\n     ret C_postr(string_w.get_str());\n }\n \n-fn write_metadata(@trans.crate_ctxt cx, @ast.crate crate) {\n-    auto llmeta = encode_metadata(cx, crate);\n+fn write_metadata(@trans.crate_ctxt cx, bool shared, @ast.crate crate) {\n+    auto llmeta = C_postr(\"\");\n+    if (shared) {\n+        llmeta = encode_metadata(cx, crate);\n+    }\n \n     auto llconst = trans.C_struct(vec(llmeta));\n     auto llglobal = llvm.LLVMAddGlobal(cx.llmod, trans.val_ty(llconst),"}, {"sha": "64d1df7b1a8c543e993b35d12fca8539994f6352", "filename": "src/comp/middle/trans.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7b95b5c033435e0b8902c3f3afb14c80e04fee83/src%2Fcomp%2Fmiddle%2Ftrans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b95b5c033435e0b8902c3f3afb14c80e04fee83/src%2Fcomp%2Fmiddle%2Ftrans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans.rs?ref=7b95b5c033435e0b8902c3f3afb14c80e04fee83", "patch": "@@ -7747,7 +7747,7 @@ fn trans_crate(session.session sess, @ast.crate crate, ty.ctxt tcx,\n     }\n \n     // Translate the metadata.\n-    middle.metadata.write_metadata(cx.ccx, crate);\n+    middle.metadata.write_metadata(cx.ccx, shared, crate);\n \n     run_passes(llmod, optimize, verify, save_temps, output, ot);\n }"}]}