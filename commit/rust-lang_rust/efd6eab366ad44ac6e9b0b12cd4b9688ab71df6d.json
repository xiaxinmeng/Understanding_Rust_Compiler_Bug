{"sha": "efd6eab366ad44ac6e9b0b12cd4b9688ab71df6d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVmZDZlYWIzNjZhZDQ0YWM2ZTliMGIxMmNkNGI5Njg4YWI3MWRmNmQ=", "commit": {"author": {"name": "Nathan Stocks", "email": "nathan.stocks@gmail.com", "date": "2017-04-02T22:26:43Z"}, "committer": {"name": "Nathan Stocks", "email": "nathan.stocks@gmail.com", "date": "2017-04-02T22:26:43Z"}, "message": "Handle symlinks in src/bootstrap/clean.rs (mostly) -- resolves #40860.\n\nThe broken condition can be replicated with:\n\n``shell\nexport MYARCH=x86_64-apple-darwin && mkdir -p build/$MYARCH/subdir &&\ntouch build/$MYARCH/subdir/file && ln -s build/$MYARCH/subdir/file\nbuild/$MYARCH/subdir/symlink\n``\n\n`src/bootstrap/clean.rs` has a custom implementation of removing a tree\n`fn rm_rf` that used `std::path::Path::{is_file, is_dir, exists}` while\nrecursively deleting directories and files.  Unfortunately, `Path`'s\nimplementation of `is_file()` and `is_dir()` and `exists()` always\nunconditionally follow symlinks, which is the exact opposite of standard\nimplementations of deleting file trees.\n\nIt appears that this custom implementation is being used to workaround a\nbehavior in Windows where the files often get marked as read-only, which\nprevents us from simply using something nice and simple like\n`std::fs::remove_dir_all`, which properly deletes links instead of\nfollowing them.\n\nSo it looks like the fix is to use `.symlink_metadata()` to figure out\nwhether tree items are files/symlinks/directories.  The one corner case\nthis won't cover is if there is a broken symlink in the \"root\"\n`build/$MYARCH` directory, because those initial entries are run through\n`Path::canonicalize()`, which panics with broken symlinks.  So lets just\nnever use symlinks in that one directory. :-)", "tree": {"sha": "156abea78ea342534826e1de6b0f9af8bb21c9e5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/156abea78ea342534826e1de6b0f9af8bb21c9e5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/efd6eab366ad44ac6e9b0b12cd4b9688ab71df6d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/efd6eab366ad44ac6e9b0b12cd4b9688ab71df6d", "html_url": "https://github.com/rust-lang/rust/commit/efd6eab366ad44ac6e9b0b12cd4b9688ab71df6d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/efd6eab366ad44ac6e9b0b12cd4b9688ab71df6d/comments", "author": {"login": "CleanCut", "id": 5838512, "node_id": "MDQ6VXNlcjU4Mzg1MTI=", "avatar_url": "https://avatars.githubusercontent.com/u/5838512?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CleanCut", "html_url": "https://github.com/CleanCut", "followers_url": "https://api.github.com/users/CleanCut/followers", "following_url": "https://api.github.com/users/CleanCut/following{/other_user}", "gists_url": "https://api.github.com/users/CleanCut/gists{/gist_id}", "starred_url": "https://api.github.com/users/CleanCut/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CleanCut/subscriptions", "organizations_url": "https://api.github.com/users/CleanCut/orgs", "repos_url": "https://api.github.com/users/CleanCut/repos", "events_url": "https://api.github.com/users/CleanCut/events{/privacy}", "received_events_url": "https://api.github.com/users/CleanCut/received_events", "type": "User", "site_admin": true}, "committer": {"login": "CleanCut", "id": 5838512, "node_id": "MDQ6VXNlcjU4Mzg1MTI=", "avatar_url": "https://avatars.githubusercontent.com/u/5838512?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CleanCut", "html_url": "https://github.com/CleanCut", "followers_url": "https://api.github.com/users/CleanCut/followers", "following_url": "https://api.github.com/users/CleanCut/following{/other_user}", "gists_url": "https://api.github.com/users/CleanCut/gists{/gist_id}", "starred_url": "https://api.github.com/users/CleanCut/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CleanCut/subscriptions", "organizations_url": "https://api.github.com/users/CleanCut/orgs", "repos_url": "https://api.github.com/users/CleanCut/repos", "events_url": "https://api.github.com/users/CleanCut/events{/privacy}", "received_events_url": "https://api.github.com/users/CleanCut/received_events", "type": "User", "site_admin": true}, "parents": [{"sha": "5e122f59ba23494d460466cca53c71646d99c767", "url": "https://api.github.com/repos/rust-lang/rust/commits/5e122f59ba23494d460466cca53c71646d99c767", "html_url": "https://github.com/rust-lang/rust/commit/5e122f59ba23494d460466cca53c71646d99c767"}], "stats": {"total": 42, "additions": 22, "deletions": 20}, "files": [{"sha": "308a0ab3076dd5421f90d17efe36562364214b8d", "filename": "src/bootstrap/clean.rs", "status": "modified", "additions": 22, "deletions": 20, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/efd6eab366ad44ac6e9b0b12cd4b9688ab71df6d/src%2Fbootstrap%2Fclean.rs", "raw_url": "https://github.com/rust-lang/rust/raw/efd6eab366ad44ac6e9b0b12cd4b9688ab71df6d/src%2Fbootstrap%2Fclean.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fclean.rs?ref=efd6eab366ad44ac6e9b0b12cd4b9688ab71df6d", "patch": "@@ -44,36 +44,38 @@ pub fn clean(build: &Build) {\n }\n \n fn rm_rf(path: &Path) {\n-    if !path.exists() {\n-        return\n-    }\n-    if path.is_file() {\n-        return do_op(path, \"remove file\", |p| fs::remove_file(p));\n-    }\n-\n-    for file in t!(fs::read_dir(path)) {\n-        let file = t!(file).path();\n+    match path.symlink_metadata() {\n+        Err(e) => {\n+            if e.kind() == ErrorKind::NotFound {\n+                return;\n+            }\n+            panic!(\"failed to get metadata for file {}: {}\", path.display(), e);\n+        },\n+        Ok(metadata) => {\n+            if metadata.file_type().is_file() || metadata.file_type().is_symlink() {\n+                do_op(path, \"remove file\", |p| fs::remove_file(p));\n+                return;\n+            }\n \n-        if file.is_dir() {\n-            rm_rf(&file);\n-        } else {\n-            // On windows we can't remove a readonly file, and git will\n-            // often clone files as readonly. As a result, we have some\n-            // special logic to remove readonly files on windows.\n-            do_op(&file, \"remove file\", |p| fs::remove_file(p));\n-        }\n-    }\n-    do_op(path, \"remove dir\", |p| fs::remove_dir(p));\n+            for file in t!(fs::read_dir(path)) {\n+                rm_rf(&t!(file).path());\n+            }\n+            do_op(path, \"remove dir\", |p| fs::remove_dir(p));\n+        },\n+    };\n }\n \n fn do_op<F>(path: &Path, desc: &str, mut f: F)\n     where F: FnMut(&Path) -> io::Result<()>\n {\n     match f(path) {\n         Ok(()) => {}\n+        // On windows we can't remove a readonly file, and git will often clone files as readonly.\n+        // As a result, we have some special logic to remove readonly files on windows.\n+        // This is also the reason that we can't use things like fs::remove_dir_all().\n         Err(ref e) if cfg!(windows) &&\n                       e.kind() == ErrorKind::PermissionDenied => {\n-            let mut p = t!(path.metadata()).permissions();\n+            let mut p = t!(path.symlink_metadata()).permissions();\n             p.set_readonly(false);\n             t!(fs::set_permissions(path, p));\n             f(path).unwrap_or_else(|e| {"}]}