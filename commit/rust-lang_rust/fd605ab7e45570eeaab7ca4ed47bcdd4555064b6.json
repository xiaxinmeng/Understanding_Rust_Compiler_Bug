{"sha": "fd605ab7e45570eeaab7ca4ed47bcdd4555064b6", "node_id": "C_kwDOAAsO6NoAKGZkNjA1YWI3ZTQ1NTcwZWVhYWI3Y2E0ZWQ0N2JjZGQ0NTU1MDY0YjY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-05T20:04:14Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-05T20:04:14Z"}, "message": "Auto merge of #9124 - Jarcho:shadow_ice, r=Alexendoo\n\nLint `shadow_*` lints in anon const blocks\n\nchangelog: Lint `shadow_*` lints in anon const blocks", "tree": {"sha": "76be2533f5ce76797f205bce84a7976fe4df930c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/76be2533f5ce76797f205bce84a7976fe4df930c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fd605ab7e45570eeaab7ca4ed47bcdd4555064b6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fd605ab7e45570eeaab7ca4ed47bcdd4555064b6", "html_url": "https://github.com/rust-lang/rust/commit/fd605ab7e45570eeaab7ca4ed47bcdd4555064b6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fd605ab7e45570eeaab7ca4ed47bcdd4555064b6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "462136ac688f152004f23cd950b4c42f26efbddb", "url": "https://api.github.com/repos/rust-lang/rust/commits/462136ac688f152004f23cd950b4c42f26efbddb", "html_url": "https://github.com/rust-lang/rust/commit/462136ac688f152004f23cd950b4c42f26efbddb"}, {"sha": "3db0e00bdc1ebd35aa9f28b83c3ed4de7ba78a25", "url": "https://api.github.com/repos/rust-lang/rust/commits/3db0e00bdc1ebd35aa9f28b83c3ed4de7ba78a25", "html_url": "https://github.com/rust-lang/rust/commit/3db0e00bdc1ebd35aa9f28b83c3ed4de7ba78a25"}], "stats": {"total": 28, "additions": 19, "deletions": 9}, "files": [{"sha": "5dcdab5b8ab90e9a35a57ca5735ff56825ed9aad", "filename": "clippy_lints/src/shadow.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/fd605ab7e45570eeaab7ca4ed47bcdd4555064b6/clippy_lints%2Fsrc%2Fshadow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd605ab7e45570eeaab7ca4ed47bcdd4555064b6/clippy_lints%2Fsrc%2Fshadow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fshadow.rs?ref=fd605ab7e45570eeaab7ca4ed47bcdd4555064b6", "patch": "@@ -99,7 +99,7 @@ declare_clippy_lint! {\n \n #[derive(Default)]\n pub(crate) struct Shadow {\n-    bindings: Vec<FxHashMap<Symbol, Vec<ItemLocalId>>>,\n+    bindings: Vec<(FxHashMap<Symbol, Vec<ItemLocalId>>, LocalDefId)>,\n }\n \n impl_lint_pass!(Shadow => [SHADOW_SAME, SHADOW_REUSE, SHADOW_UNRELATED]);\n@@ -121,7 +121,7 @@ impl<'tcx> LateLintPass<'tcx> for Shadow {\n \n         let HirId { owner, local_id } = id;\n         // get (or insert) the list of items for this owner and symbol\n-        let data = self.bindings.last_mut().unwrap();\n+        let (ref mut data, scope_owner) = *self.bindings.last_mut().unwrap();\n         let items_with_name = data.entry(ident.name).or_default();\n \n         // check other bindings with the same name, most recently seen first\n@@ -131,7 +131,7 @@ impl<'tcx> LateLintPass<'tcx> for Shadow {\n                 return;\n             }\n \n-            if is_shadow(cx, owner, prev, local_id) {\n+            if is_shadow(cx, scope_owner, prev, local_id) {\n                 let prev_hir_id = HirId { owner, local_id: prev };\n                 lint_shadow(cx, pat, prev_hir_id, ident.span);\n                 // only lint against the \"nearest\" shadowed binding\n@@ -144,11 +144,9 @@ impl<'tcx> LateLintPass<'tcx> for Shadow {\n \n     fn check_body(&mut self, cx: &LateContext<'_>, body: &Body<'_>) {\n         let hir = cx.tcx.hir();\n-        if !matches!(\n-            hir.body_owner_kind(hir.body_owner_def_id(body.id())),\n-            BodyOwnerKind::Closure\n-        ) {\n-            self.bindings.push(FxHashMap::default());\n+        let owner_id = hir.body_owner_def_id(body.id());\n+        if !matches!(hir.body_owner_kind(owner_id), BodyOwnerKind::Closure) {\n+            self.bindings.push((FxHashMap::default(), owner_id));\n         }\n     }\n "}, {"sha": "43d76094d0e847e3e6f60c875d2cf2248adc330b", "filename": "tests/ui/shadow.stderr", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/fd605ab7e45570eeaab7ca4ed47bcdd4555064b6/tests%2Fui%2Fshadow.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fd605ab7e45570eeaab7ca4ed47bcdd4555064b6/tests%2Fui%2Fshadow.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fshadow.stderr?ref=fd605ab7e45570eeaab7ca4ed47bcdd4555064b6", "patch": "@@ -265,5 +265,17 @@ note: previous binding is here\n LL | pub async fn foo2(_a: i32, _b: i64) {\n    |                            ^^\n \n-error: aborting due to 22 previous errors\n+error: `x` shadows a previous, unrelated binding\n+  --> $DIR/shadow.rs:94:21\n+   |\n+LL |         if let Some(x) = Some(1) { x } else { 1 }\n+   |                     ^\n+   |\n+note: previous binding is here\n+  --> $DIR/shadow.rs:93:13\n+   |\n+LL |         let x = 1;\n+   |             ^\n+\n+error: aborting due to 23 previous errors\n "}]}