{"sha": "0a8a3dd88a1216e7487b8e39179fbac16d07bafe", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBhOGEzZGQ4OGExMjE2ZTc0ODdiOGUzOTE3OWZiYWMxNmQwN2JhZmU=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-08-31T04:17:10Z"}, "committer": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-08-31T04:17:10Z"}, "message": "qualify_consts: move thread_local condition out.", "tree": {"sha": "792cd25277fdd212c375cc70e2d0a48db81056fd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/792cd25277fdd212c375cc70e2d0a48db81056fd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0a8a3dd88a1216e7487b8e39179fbac16d07bafe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0a8a3dd88a1216e7487b8e39179fbac16d07bafe", "html_url": "https://github.com/rust-lang/rust/commit/0a8a3dd88a1216e7487b8e39179fbac16d07bafe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0a8a3dd88a1216e7487b8e39179fbac16d07bafe/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9196af0b3647c29cb1c268ba9b01546df55fc004", "url": "https://api.github.com/repos/rust-lang/rust/commits/9196af0b3647c29cb1c268ba9b01546df55fc004", "html_url": "https://github.com/rust-lang/rust/commit/9196af0b3647c29cb1c268ba9b01546df55fc004"}], "stats": {"total": 16, "additions": 3, "deletions": 13}, "files": [{"sha": "32b49ee942300290d29b3a6b2830cc918f74b2f4", "filename": "src/librustc_mir/transform/qualify_consts.rs", "status": "modified", "additions": 3, "deletions": 13, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/0a8a3dd88a1216e7487b8e39179fbac16d07bafe/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a8a3dd88a1216e7487b8e39179fbac16d07bafe/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs?ref=0a8a3dd88a1216e7487b8e39179fbac16d07bafe", "patch": "@@ -1648,9 +1648,9 @@ impl<'tcx> MirPass<'tcx> for QualifyAndPromoteConstants<'tcx> {\n             remove_drop_and_storage_dead_on_promoted_locals(body, promoted_temps);\n         }\n \n-        if let Mode::Static = mode {\n+        if mode == Mode::Static && !tcx.has_attr(def_id, sym::thread_local) {\n             // `static`s (not `static mut`s) which are not `#[thread_local]` must be `Sync`.\n-            check_non_thread_local_static_is_sync(tcx, body, def_id, hir_id);\n+            check_static_is_sync(tcx, body, hir_id);\n         }\n     }\n }\n@@ -1739,17 +1739,7 @@ fn remove_drop_and_storage_dead_on_promoted_locals(\n     }\n }\n \n-fn check_non_thread_local_static_is_sync(\n-    tcx: TyCtxt<'tcx>,\n-    body: &mut Body<'tcx>,\n-    def_id: DefId,\n-    hir_id: HirId,\n-) {\n-    // `#[thread_local]` statics don't have to be `Sync`.\n-    if tcx.has_attr(def_id, sym::thread_local) {\n-        return;\n-    }\n-\n+fn check_static_is_sync(tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>, hir_id: HirId) {\n     let ty = body.return_ty();\n     tcx.infer_ctxt().enter(|infcx| {\n         let cause = traits::ObligationCause::new(body.span, hir_id, traits::SharedStatic);"}]}