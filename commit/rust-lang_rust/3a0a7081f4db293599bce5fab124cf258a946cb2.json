{"sha": "3a0a7081f4db293599bce5fab124cf258a946cb2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNhMGE3MDgxZjRkYjI5MzU5OWJjZTVmYWIxMjRjZjI1OGE5NDZjYjI=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-04-24T00:27:38Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-04-24T00:27:38Z"}, "message": "Merge #4116\n\n4116: Make sure that adding a snippet requires corresponding capability r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "2b3d64141d9797715914e2d26496eee7adb38a11", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2b3d64141d9797715914e2d26496eee7adb38a11"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3a0a7081f4db293599bce5fab124cf258a946cb2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeojJ6CRBK7hj4Ov3rIwAAdHIIAFPpD3hcIXfIIB05ulIxpUKe\nWMefKa3pWYCwXmM6ZLrB8ULg2dMJnoTe9EW5o2cEOm7ms6cW9XL/XU2NpbbABWGt\nW0cz42Z5Qqy4oE10c5ncNPvnoZo61AHazgqb8h2wCHFEF6T7kvGGwm/L5ylCjgae\nIDmLgLqMbNJRVhD4mr9n4pYtgL3UgY/ai8sdtVsMZbZUB5JfDKFZWPkLKkBQ6v2m\n1uNFhxU3YKez+Cf77KzNrubgJUx/m2CbIG9AYj1pMwASxCeIz59d8HV9eV4R6XaZ\ntA9pLimStFmoQa7lCzdMXzM0IITQTiVq3nbJ/IAjB8kn6dvWvU3EE8Cbov1+rNs=\n=Syk4\n-----END PGP SIGNATURE-----\n", "payload": "tree 2b3d64141d9797715914e2d26496eee7adb38a11\nparent 601f89f2cb085ab7e638f034088f32b9428a0611\nparent 5fd5de4061362aa1066cb9a47aa9cb79eab38e47\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1587688058 +0000\ncommitter GitHub <noreply@github.com> 1587688058 +0000\n\nMerge #4116\n\n4116: Make sure that adding a snippet requires corresponding capability r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3a0a7081f4db293599bce5fab124cf258a946cb2", "html_url": "https://github.com/rust-lang/rust/commit/3a0a7081f4db293599bce5fab124cf258a946cb2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3a0a7081f4db293599bce5fab124cf258a946cb2/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "601f89f2cb085ab7e638f034088f32b9428a0611", "url": "https://api.github.com/repos/rust-lang/rust/commits/601f89f2cb085ab7e638f034088f32b9428a0611", "html_url": "https://github.com/rust-lang/rust/commit/601f89f2cb085ab7e638f034088f32b9428a0611"}, {"sha": "5fd5de4061362aa1066cb9a47aa9cb79eab38e47", "url": "https://api.github.com/repos/rust-lang/rust/commits/5fd5de4061362aa1066cb9a47aa9cb79eab38e47", "html_url": "https://github.com/rust-lang/rust/commit/5fd5de4061362aa1066cb9a47aa9cb79eab38e47"}], "stats": {"total": 204, "additions": 141, "deletions": 63}, "files": [{"sha": "f0e02180b50a04731640357de53637dde130a578", "filename": "crates/ra_ide/src/completion.rs", "status": "modified", "additions": 4, "deletions": 19, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion.rs?ref=3a0a7081f4db293599bce5fab124cf258a946cb2", "patch": "@@ -1,5 +1,6 @@\n //! FIXME: write short doc here\n \n+mod completion_config;\n mod completion_item;\n mod completion_context;\n mod presentation;\n@@ -28,27 +29,11 @@ use crate::{\n     FilePosition,\n };\n \n-pub use crate::completion::completion_item::{\n-    CompletionItem, CompletionItemKind, CompletionScore, InsertTextFormat,\n+pub use crate::completion::{\n+    completion_config::CompletionConfig,\n+    completion_item::{CompletionItem, CompletionItemKind, CompletionScore, InsertTextFormat},\n };\n \n-#[derive(Clone, Debug, PartialEq, Eq)]\n-pub struct CompletionConfig {\n-    pub enable_postfix_completions: bool,\n-    pub add_call_parenthesis: bool,\n-    pub add_call_argument_snippets: bool,\n-}\n-\n-impl Default for CompletionConfig {\n-    fn default() -> Self {\n-        CompletionConfig {\n-            enable_postfix_completions: true,\n-            add_call_parenthesis: true,\n-            add_call_argument_snippets: true,\n-        }\n-    }\n-}\n-\n /// Main entry point for completion. We run completion as a two-phase process.\n ///\n /// First, we look at the position and collect a so-called `CompletionContext."}, {"sha": "adefb290e81d98dd09c11a7ffa7c09edf64c1ef6", "filename": "crates/ra_ide/src/completion/complete_keyword.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_keyword.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_keyword.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_keyword.rs?ref=3a0a7081f4db293599bce5fab124cf258a946cb2", "patch": "@@ -42,10 +42,14 @@ pub(super) fn complete_use_tree_keyword(acc: &mut Completions, ctx: &CompletionC\n }\n \n fn keyword(ctx: &CompletionContext, kw: &str, snippet: &str) -> CompletionItem {\n-    CompletionItem::new(CompletionKind::Keyword, ctx.source_range(), kw)\n-        .kind(CompletionItemKind::Keyword)\n-        .insert_snippet(snippet)\n-        .build()\n+    let res = CompletionItem::new(CompletionKind::Keyword, ctx.source_range(), kw)\n+        .kind(CompletionItemKind::Keyword);\n+\n+    match ctx.config.snippet_cap {\n+        Some(cap) => res.insert_snippet(cap, snippet),\n+        _ => res.insert_text(if snippet.contains('$') { kw } else { snippet }),\n+    }\n+    .build()\n }\n \n pub(super) fn complete_expr_keyword(acc: &mut Completions, ctx: &CompletionContext) {"}, {"sha": "8d397b0feafb316e76f83764634a70ab0d6b6451", "filename": "crates/ra_ide/src/completion/complete_postfix.rs", "status": "modified", "additions": 33, "deletions": 6, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_postfix.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_postfix.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_postfix.rs?ref=3a0a7081f4db293599bce5fab124cf258a946cb2", "patch": "@@ -6,6 +6,7 @@ use ra_syntax::{\n };\n use ra_text_edit::TextEdit;\n \n+use super::completion_config::SnippetCap;\n use crate::{\n     completion::{\n         completion_context::CompletionContext,\n@@ -32,9 +33,15 @@ pub(super) fn complete_postfix(acc: &mut Completions, ctx: &CompletionContext) {\n         None => return,\n     };\n \n+    let cap = match ctx.config.snippet_cap {\n+        Some(it) => it,\n+        None => return,\n+    };\n+\n     if receiver_ty.is_bool() || receiver_ty.is_unknown() {\n         postfix_snippet(\n             ctx,\n+            cap,\n             &dot_receiver,\n             \"if\",\n             \"if expr {}\",\n@@ -43,6 +50,7 @@ pub(super) fn complete_postfix(acc: &mut Completions, ctx: &CompletionContext) {\n         .add_to(acc);\n         postfix_snippet(\n             ctx,\n+            cap,\n             &dot_receiver,\n             \"while\",\n             \"while expr {}\",\n@@ -52,11 +60,20 @@ pub(super) fn complete_postfix(acc: &mut Completions, ctx: &CompletionContext) {\n     }\n \n     // !&&&42 is a compiler error, ergo process it before considering the references\n-    postfix_snippet(ctx, &dot_receiver, \"not\", \"!expr\", &format!(\"!{}\", receiver_text)).add_to(acc);\n+    postfix_snippet(ctx, cap, &dot_receiver, \"not\", \"!expr\", &format!(\"!{}\", receiver_text))\n+        .add_to(acc);\n \n-    postfix_snippet(ctx, &dot_receiver, \"ref\", \"&expr\", &format!(\"&{}\", receiver_text)).add_to(acc);\n-    postfix_snippet(ctx, &dot_receiver, \"refm\", \"&mut expr\", &format!(\"&mut {}\", receiver_text))\n+    postfix_snippet(ctx, cap, &dot_receiver, \"ref\", \"&expr\", &format!(\"&{}\", receiver_text))\n         .add_to(acc);\n+    postfix_snippet(\n+        ctx,\n+        cap,\n+        &dot_receiver,\n+        \"refm\",\n+        \"&mut expr\",\n+        &format!(\"&mut {}\", receiver_text),\n+    )\n+    .add_to(acc);\n \n     // The rest of the postfix completions create an expression that moves an argument,\n     // so it's better to consider references now to avoid breaking the compilation\n@@ -66,6 +83,7 @@ pub(super) fn complete_postfix(acc: &mut Completions, ctx: &CompletionContext) {\n \n     postfix_snippet(\n         ctx,\n+        cap,\n         &dot_receiver,\n         \"match\",\n         \"match expr {}\",\n@@ -75,15 +93,23 @@ pub(super) fn complete_postfix(acc: &mut Completions, ctx: &CompletionContext) {\n \n     postfix_snippet(\n         ctx,\n+        cap,\n         &dot_receiver,\n         \"box\",\n         \"Box::new(expr)\",\n         &format!(\"Box::new({})\", receiver_text),\n     )\n     .add_to(acc);\n \n-    postfix_snippet(ctx, &dot_receiver, \"dbg\", \"dbg!(expr)\", &format!(\"dbg!({})\", receiver_text))\n-        .add_to(acc);\n+    postfix_snippet(\n+        ctx,\n+        cap,\n+        &dot_receiver,\n+        \"dbg\",\n+        \"dbg!(expr)\",\n+        &format!(\"dbg!({})\", receiver_text),\n+    )\n+    .add_to(acc);\n }\n \n fn get_receiver_text(receiver: &ast::Expr, receiver_is_ambiguous_float_literal: bool) -> String {\n@@ -108,6 +134,7 @@ fn include_references(initial_element: &ast::Expr) -> ast::Expr {\n \n fn postfix_snippet(\n     ctx: &CompletionContext,\n+    cap: SnippetCap,\n     receiver: &ast::Expr,\n     label: &str,\n     detail: &str,\n@@ -121,7 +148,7 @@ fn postfix_snippet(\n     };\n     CompletionItem::new(CompletionKind::Postfix, ctx.source_range(), label)\n         .detail(detail)\n-        .snippet_edit(edit)\n+        .snippet_edit(cap, edit)\n }\n \n #[cfg(test)]"}, {"sha": "4bccfbfed26f68ec5961d86f1db7dc4a8d25dec0", "filename": "crates/ra_ide/src/completion/complete_snippet.rs", "status": "modified", "additions": 18, "deletions": 8, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_snippet.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_snippet.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_snippet.rs?ref=3a0a7081f4db293599bce5fab124cf258a946cb2", "patch": "@@ -1,31 +1,41 @@\n //! FIXME: write short doc here\n \n use crate::completion::{\n-    completion_item::Builder, CompletionContext, CompletionItem, CompletionItemKind,\n-    CompletionKind, Completions,\n+    completion_config::SnippetCap, completion_item::Builder, CompletionContext, CompletionItem,\n+    CompletionItemKind, CompletionKind, Completions,\n };\n \n-fn snippet(ctx: &CompletionContext, label: &str, snippet: &str) -> Builder {\n+fn snippet(ctx: &CompletionContext, cap: SnippetCap, label: &str, snippet: &str) -> Builder {\n     CompletionItem::new(CompletionKind::Snippet, ctx.source_range(), label)\n-        .insert_snippet(snippet)\n+        .insert_snippet(cap, snippet)\n         .kind(CompletionItemKind::Snippet)\n }\n \n pub(super) fn complete_expr_snippet(acc: &mut Completions, ctx: &CompletionContext) {\n     if !(ctx.is_trivial_path && ctx.function_syntax.is_some()) {\n         return;\n     }\n+    let cap = match ctx.config.snippet_cap {\n+        Some(it) => it,\n+        None => return,\n+    };\n \n-    snippet(ctx, \"pd\", \"eprintln!(\\\"$0 = {:?}\\\", $0);\").add_to(acc);\n-    snippet(ctx, \"ppd\", \"eprintln!(\\\"$0 = {:#?}\\\", $0);\").add_to(acc);\n+    snippet(ctx, cap, \"pd\", \"eprintln!(\\\"$0 = {:?}\\\", $0);\").add_to(acc);\n+    snippet(ctx, cap, \"ppd\", \"eprintln!(\\\"$0 = {:#?}\\\", $0);\").add_to(acc);\n }\n \n pub(super) fn complete_item_snippet(acc: &mut Completions, ctx: &CompletionContext) {\n     if !ctx.is_new_item {\n         return;\n     }\n+    let cap = match ctx.config.snippet_cap {\n+        Some(it) => it,\n+        None => return,\n+    };\n+\n     snippet(\n         ctx,\n+        cap,\n         \"Test function\",\n         \"\\\n #[test]\n@@ -36,8 +46,8 @@ fn ${1:feature}() {\n     .lookup_by(\"tfn\")\n     .add_to(acc);\n \n-    snippet(ctx, \"macro_rules\", \"macro_rules! $1 {\\n\\t($2) => {\\n\\t\\t$0\\n\\t};\\n}\").add_to(acc);\n-    snippet(ctx, \"pub(crate)\", \"pub(crate) $0\").add_to(acc);\n+    snippet(ctx, cap, \"macro_rules\", \"macro_rules! $1 {\\n\\t($2) => {\\n\\t\\t$0\\n\\t};\\n}\").add_to(acc);\n+    snippet(ctx, cap, \"pub(crate)\", \"pub(crate) $0\").add_to(acc);\n }\n \n #[cfg(test)]"}, {"sha": "c39943252428df1b57663671f1747129ea7455a3", "filename": "crates/ra_ide/src/completion/complete_trait_impl.rs", "status": "modified", "additions": 13, "deletions": 5, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_trait_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_trait_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_trait_impl.rs?ref=3a0a7081f4db293599bce5fab124cf258a946cb2", "patch": "@@ -122,7 +122,7 @@ fn add_function_impl(\n     ctx: &CompletionContext,\n     func: &hir::Function,\n ) {\n-    let display = FunctionSignature::from_hir(ctx.db, *func);\n+    let signature = FunctionSignature::from_hir(ctx.db, *func);\n \n     let fn_name = func.name(ctx.db).to_string();\n \n@@ -141,12 +141,20 @@ fn add_function_impl(\n     } else {\n         CompletionItemKind::Function\n     };\n-\n-    let snippet = format!(\"{} {{\\n    $0\\n}}\", display);\n-\n     let range = TextRange::from_to(fn_def_node.text_range().start(), ctx.source_range().end());\n \n-    builder.snippet_edit(TextEdit::replace(range, snippet)).kind(completion_kind).add_to(acc);\n+    match ctx.config.snippet_cap {\n+        Some(cap) => {\n+            let snippet = format!(\"{} {{\\n    $0\\n}}\", signature);\n+            builder.snippet_edit(cap, TextEdit::replace(range, snippet))\n+        }\n+        None => {\n+            let header = format!(\"{} {{\", signature);\n+            builder.text_edit(TextEdit::replace(range, header))\n+        }\n+    }\n+    .kind(completion_kind)\n+    .add_to(acc);\n }\n \n fn add_type_alias_impl("}, {"sha": "6cf7ed6e4c97d7875716c699e358698965d88df2", "filename": "crates/ra_ide/src/completion/completion_config.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcompletion_config.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcompletion_config.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcompletion_config.rs?ref=3a0a7081f4db293599bce5fab124cf258a946cb2", "patch": "@@ -0,0 +1,29 @@\n+//! Settings for tweaking completion.\n+//!\n+//! The fun thing here is `SnippetCap` -- this type can only be created in this\n+//! module, and we use to statically check that we only produce snippet\n+//! completions if we are allowed to.\n+\n+#[derive(Clone, Debug, PartialEq, Eq)]\n+pub struct CompletionConfig {\n+    pub enable_postfix_completions: bool,\n+    pub add_call_parenthesis: bool,\n+    pub add_call_argument_snippets: bool,\n+    pub snippet_cap: Option<SnippetCap>,\n+}\n+\n+#[derive(Clone, Copy, Debug, PartialEq, Eq)]\n+pub struct SnippetCap {\n+    _private: (),\n+}\n+\n+impl Default for CompletionConfig {\n+    fn default() -> Self {\n+        CompletionConfig {\n+            enable_postfix_completions: true,\n+            add_call_parenthesis: true,\n+            add_call_argument_snippets: true,\n+            snippet_cap: Some(SnippetCap { _private: () }),\n+        }\n+    }\n+}"}, {"sha": "fb06cc1257d2d9b6d6be02991d1d6d812beca8a9", "filename": "crates/ra_ide/src/completion/completion_item.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcompletion_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcompletion_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcompletion_item.rs?ref=3a0a7081f4db293599bce5fab124cf258a946cb2", "patch": "@@ -2,6 +2,7 @@\n \n use std::fmt;\n \n+use super::completion_config::SnippetCap;\n use hir::Documentation;\n use ra_syntax::TextRange;\n use ra_text_edit::TextEdit;\n@@ -270,7 +271,11 @@ impl Builder {\n         self.insert_text = Some(insert_text.into());\n         self\n     }\n-    pub(crate) fn insert_snippet(mut self, snippet: impl Into<String>) -> Builder {\n+    pub(crate) fn insert_snippet(\n+        mut self,\n+        _cap: SnippetCap,\n+        snippet: impl Into<String>,\n+    ) -> Builder {\n         self.insert_text_format = InsertTextFormat::Snippet;\n         self.insert_text(snippet)\n     }\n@@ -282,7 +287,7 @@ impl Builder {\n         self.text_edit = Some(edit);\n         self\n     }\n-    pub(crate) fn snippet_edit(mut self, edit: TextEdit) -> Builder {\n+    pub(crate) fn snippet_edit(mut self, _cap: SnippetCap, edit: TextEdit) -> Builder {\n         self.insert_text_format = InsertTextFormat::Snippet;\n         self.text_edit(edit)\n     }"}, {"sha": "5e2b8b920ae95c691dfed97d7ec72cca73fac1e6", "filename": "crates/ra_ide/src/completion/presentation.rs", "status": "modified", "additions": 28, "deletions": 19, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fpresentation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fpresentation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fpresentation.rs?ref=3a0a7081f4db293599bce5fab124cf258a946cb2", "patch": "@@ -114,17 +114,19 @@ impl Completions {\n \n         // Add `<>` for generic types\n         if ctx.is_path_type && !ctx.has_type_args && ctx.config.add_call_parenthesis {\n-            let has_non_default_type_params = match resolution {\n-                ScopeDef::ModuleDef(Adt(it)) => it.has_non_default_type_params(ctx.db),\n-                ScopeDef::ModuleDef(TypeAlias(it)) => it.has_non_default_type_params(ctx.db),\n-                _ => false,\n-            };\n-            if has_non_default_type_params {\n-                tested_by!(inserts_angle_brackets_for_generics);\n-                completion_item = completion_item\n-                    .lookup_by(local_name.clone())\n-                    .label(format!(\"{}<\u2026>\", local_name))\n-                    .insert_snippet(format!(\"{}<$0>\", local_name));\n+            if let Some(cap) = ctx.config.snippet_cap {\n+                let has_non_default_type_params = match resolution {\n+                    ScopeDef::ModuleDef(Adt(it)) => it.has_non_default_type_params(ctx.db),\n+                    ScopeDef::ModuleDef(TypeAlias(it)) => it.has_non_default_type_params(ctx.db),\n+                    _ => false,\n+                };\n+                if has_non_default_type_params {\n+                    tested_by!(inserts_angle_brackets_for_generics);\n+                    completion_item = completion_item\n+                        .lookup_by(local_name.clone())\n+                        .label(format!(\"{}<\u2026>\", local_name))\n+                        .insert_snippet(cap, format!(\"{}<$0>\", local_name));\n+                }\n             }\n         }\n \n@@ -184,13 +186,16 @@ impl Completions {\n                 .set_deprecated(is_deprecated(macro_, ctx.db))\n                 .detail(detail);\n \n-        builder = if ctx.use_item_syntax.is_some() || ctx.is_macro_call {\n-            tested_by!(dont_insert_macro_call_parens_unncessary);\n-            builder.insert_text(name)\n-        } else {\n-            let macro_braces_to_insert =\n-                self.guess_macro_braces(&name, docs.as_ref().map_or(\"\", |s| s.as_str()));\n-            builder.insert_snippet(macro_declaration + macro_braces_to_insert)\n+        builder = match ctx.config.snippet_cap {\n+            Some(cap) if ctx.use_item_syntax.is_none() && !ctx.is_macro_call => {\n+                let macro_braces_to_insert =\n+                    self.guess_macro_braces(&name, docs.as_ref().map_or(\"\", |s| s.as_str()));\n+                builder.insert_snippet(cap, macro_declaration + macro_braces_to_insert)\n+            }\n+            _ => {\n+                tested_by!(dont_insert_macro_call_parens_unncessary);\n+                builder.insert_text(name)\n+            }\n         };\n \n         self.add(builder);\n@@ -366,6 +371,10 @@ impl Builder {\n         if ctx.use_item_syntax.is_some() || ctx.is_call {\n             return self;\n         }\n+        let cap = match ctx.config.snippet_cap {\n+            Some(it) => it,\n+            None => return self,\n+        };\n         // If not an import, add parenthesis automatically.\n         tested_by!(inserts_parens_for_function_calls);\n \n@@ -387,7 +396,7 @@ impl Builder {\n \n             (snippet, format!(\"{}(\u2026)\", name))\n         };\n-        self.lookup_by(name).label(label).insert_snippet(snippet)\n+        self.lookup_by(name).label(label).insert_snippet(cap, snippet)\n     }\n }\n "}, {"sha": "33d7c95a802fa61c9d9a360bc1a0dfdb5fb587ef", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a0a7081f4db293599bce5fab124cf258a946cb2/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=3a0a7081f4db293599bce5fab124cf258a946cb2", "patch": "@@ -104,6 +104,7 @@ impl Default for Config {\n                 enable_postfix_completions: true,\n                 add_call_parenthesis: true,\n                 add_call_argument_snippets: true,\n+                ..CompletionConfig::default()\n             },\n             call_info_full: true,\n         }"}]}