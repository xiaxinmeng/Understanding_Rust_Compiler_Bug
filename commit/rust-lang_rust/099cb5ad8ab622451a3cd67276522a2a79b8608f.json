{"sha": "099cb5ad8ab622451a3cd67276522a2a79b8608f", "node_id": "C_kwDOAAsO6NoAKDA5OWNiNWFkOGFiNjIyNDUxYTNjZDY3Mjc2NTIyYTJhNzliODYwOGY", "commit": {"author": {"name": "Ze'ev Maor", "email": "zeevm@microsoft.com", "date": "2022-07-05T20:38:52Z"}, "committer": {"name": "Ze'ev Maor", "email": "zeevm@microsoft.com", "date": "2022-07-05T20:38:52Z"}, "message": "only enable ConstProp on opt level 2", "tree": {"sha": "85b94ed60b70751b882bb4e6fc4c41bf69b88452", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/85b94ed60b70751b882bb4e6fc4c41bf69b88452"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/099cb5ad8ab622451a3cd67276522a2a79b8608f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/099cb5ad8ab622451a3cd67276522a2a79b8608f", "html_url": "https://github.com/rust-lang/rust/commit/099cb5ad8ab622451a3cd67276522a2a79b8608f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/099cb5ad8ab622451a3cd67276522a2a79b8608f/comments", "author": null, "committer": null, "parents": [{"sha": "41ad4d9b2dbb895666337d162eda52619a6056db", "url": "https://api.github.com/repos/rust-lang/rust/commits/41ad4d9b2dbb895666337d162eda52619a6056db", "html_url": "https://github.com/rust-lang/rust/commit/41ad4d9b2dbb895666337d162eda52619a6056db"}], "stats": {"total": 13, "additions": 2, "deletions": 11}, "files": [{"sha": "05d59a7acf447591f154f07c6aee537edf43dca0", "filename": "compiler/rustc_mir_transform/src/const_prop.rs", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/099cb5ad8ab622451a3cd67276522a2a79b8608f/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/099cb5ad8ab622451a3cd67276522a2a79b8608f/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs?ref=099cb5ad8ab622451a3cd67276522a2a79b8608f", "patch": "@@ -60,11 +60,8 @@ macro_rules! throw_machine_stop_str {\n pub struct ConstProp;\n \n impl<'tcx> MirPass<'tcx> for ConstProp {\n-    fn is_enabled(&self, _sess: &rustc_session::Session) -> bool {\n-        // FIXME(#70073): Unlike the other passes in \"optimizations\", this one emits errors, so it\n-        // runs even when MIR optimizations are disabled. We should separate the lint out from the\n-        // transform and move the lint as early in the pipeline as possible.\n-        true\n+    fn is_enabled(&self, sess: &rustc_session::Session) -> bool {\n+        sess.mir_opt_level() >= 2\n     }\n \n     #[instrument(skip(self, tcx), level = \"debug\")]\n@@ -786,12 +783,6 @@ impl<'mir, 'tcx> ConstPropagator<'mir, 'tcx> {\n \n     /// Returns `true` if and only if this `op` should be const-propagated into.\n     fn should_const_prop(&mut self, op: &OpTy<'tcx>) -> bool {\n-        let mir_opt_level = self.tcx.sess.mir_opt_level();\n-\n-        if mir_opt_level == 0 {\n-            return false;\n-        }\n-\n         if !self.tcx.consider_optimizing(|| format!(\"ConstantPropagation - OpTy: {:?}\", op)) {\n             return false;\n         }"}]}