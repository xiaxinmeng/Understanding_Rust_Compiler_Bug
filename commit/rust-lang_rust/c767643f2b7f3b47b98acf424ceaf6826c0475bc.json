{"sha": "c767643f2b7f3b47b98acf424ceaf6826c0475bc", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM3Njc2NDNmMmI3ZjNiNDdiOThhY2Y0MjRjZWFmNjgyNmMwNDc1YmM=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-09-04T23:54:05Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-09-20T02:48:58Z"}, "message": "std::rt: Try stealing from all schedulers\n\nThis guarantees that if there is work to do it will be found", "tree": {"sha": "2b606bba5adf27315593f7fb5e3395624bd346df", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2b606bba5adf27315593f7fb5e3395624bd346df"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c767643f2b7f3b47b98acf424ceaf6826c0475bc", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c767643f2b7f3b47b98acf424ceaf6826c0475bc", "html_url": "https://github.com/rust-lang/rust/commit/c767643f2b7f3b47b98acf424ceaf6826c0475bc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c767643f2b7f3b47b98acf424ceaf6826c0475bc/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "85c0fb7b8a81fc48a2155decd20abf16b1c5eeb6", "url": "https://api.github.com/repos/rust-lang/rust/commits/85c0fb7b8a81fc48a2155decd20abf16b1c5eeb6", "html_url": "https://github.com/rust-lang/rust/commit/85c0fb7b8a81fc48a2155decd20abf16b1c5eeb6"}], "stats": {"total": 37, "additions": 27, "deletions": 10}, "files": [{"sha": "22888d79984c2da3293af985f6751c48a8240ae3", "filename": "src/libstd/rt/sched.rs", "status": "modified", "additions": 27, "deletions": 10, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/c767643f2b7f3b47b98acf424ceaf6826c0475bc/src%2Flibstd%2Frt%2Fsched.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c767643f2b7f3b47b98acf424ceaf6826c0475bc/src%2Flibstd%2Frt%2Fsched.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Frt%2Fsched.rs?ref=c767643f2b7f3b47b98acf424ceaf6826c0475bc", "patch": "@@ -379,21 +379,20 @@ impl Scheduler {\n                 return Some(task)\n             }\n             None => {\n-                // Our naive stealing, try kinda hard.\n                 rtdebug!(\"scheduler trying to steal\");\n-                let len = self.work_queues.len();\n-                return self.try_steals(len/2);\n+                return self.try_steals();\n             }\n         }\n     }\n \n-    // With no backoff try stealing n times from the queues the\n-    // scheduler knows about. This naive implementation can steal from\n-    // our own queue or from other special schedulers.\n-    fn try_steals(&mut self, n: uint) -> Option<~Task> {\n-        for _ in range(0, n) {\n-            let index = self.rng.gen_uint_range(0, self.work_queues.len());\n-            let work_queues = &mut self.work_queues;\n+    // Try stealing from all queues the scheduler knows about. This\n+    // naive implementation can steal from our own queue or from other\n+    // special schedulers.\n+    fn try_steals(&mut self) -> Option<~Task> {\n+        let work_queues = &mut self.work_queues;\n+        let len = work_queues.len();\n+        let start_index = self.rng.gen_uint_range(0, len);\n+        for index in range(0, len).map(|i| (i + start_index) % len) {\n             match work_queues[index].steal() {\n                 Some(task) => {\n                     rtdebug!(\"found task by stealing\");\n@@ -1213,4 +1212,22 @@ mod test {\n         }\n     }\n \n+    #[test]\n+    fn dont_starve_1() {\n+        use rt::comm::oneshot;\n+\n+        do stress_factor().times {\n+            do run_in_mt_newsched_task {\n+                let (port, chan) = oneshot();\n+\n+                // This task should not be able to starve the sender;\n+                // The sender should get stolen to another thread.\n+                do spawntask {\n+                    while !port.peek() { }\n+                }\n+\n+                chan.send(());\n+            }\n+        }\n+    }\n }"}]}