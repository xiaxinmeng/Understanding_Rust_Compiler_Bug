{"sha": "d282fb000bd64a7e2a9685fa4c99485afc30ba63", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQyODJmYjAwMGJkNjRhN2UyYTk2ODVmYTRjOTk0ODVhZmMzMGJhNjM=", "commit": {"author": {"name": "Andrew Paverd", "email": "andrew.paverd@microsoft.com", "date": "2020-06-03T13:25:58Z"}, "committer": {"name": "Andrew Paverd", "email": "andrew.paverd@microsoft.com", "date": "2020-06-03T13:31:08Z"}, "message": "Updated documentation for Control Flow Guard", "tree": {"sha": "df283c3b15db2ed4dd728a8f7dc8f2b9255f86f6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/df283c3b15db2ed4dd728a8f7dc8f2b9255f86f6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d282fb000bd64a7e2a9685fa4c99485afc30ba63", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d282fb000bd64a7e2a9685fa4c99485afc30ba63", "html_url": "https://github.com/rust-lang/rust/commit/d282fb000bd64a7e2a9685fa4c99485afc30ba63", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d282fb000bd64a7e2a9685fa4c99485afc30ba63/comments", "author": {"login": "ajpaverd", "id": 207321, "node_id": "MDQ6VXNlcjIwNzMyMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/207321?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ajpaverd", "html_url": "https://github.com/ajpaverd", "followers_url": "https://api.github.com/users/ajpaverd/followers", "following_url": "https://api.github.com/users/ajpaverd/following{/other_user}", "gists_url": "https://api.github.com/users/ajpaverd/gists{/gist_id}", "starred_url": "https://api.github.com/users/ajpaverd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ajpaverd/subscriptions", "organizations_url": "https://api.github.com/users/ajpaverd/orgs", "repos_url": "https://api.github.com/users/ajpaverd/repos", "events_url": "https://api.github.com/users/ajpaverd/events{/privacy}", "received_events_url": "https://api.github.com/users/ajpaverd/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ajpaverd", "id": 207321, "node_id": "MDQ6VXNlcjIwNzMyMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/207321?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ajpaverd", "html_url": "https://github.com/ajpaverd", "followers_url": "https://api.github.com/users/ajpaverd/followers", "following_url": "https://api.github.com/users/ajpaverd/following{/other_user}", "gists_url": "https://api.github.com/users/ajpaverd/gists{/gist_id}", "starred_url": "https://api.github.com/users/ajpaverd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ajpaverd/subscriptions", "organizations_url": "https://api.github.com/users/ajpaverd/orgs", "repos_url": "https://api.github.com/users/ajpaverd/repos", "events_url": "https://api.github.com/users/ajpaverd/events{/privacy}", "received_events_url": "https://api.github.com/users/ajpaverd/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ff4aff6ce0f216c8cb8d40f432efaacdaca8095b", "url": "https://api.github.com/repos/rust-lang/rust/commits/ff4aff6ce0f216c8cb8d40f432efaacdaca8095b", "html_url": "https://github.com/rust-lang/rust/commit/ff4aff6ce0f216c8cb8d40f432efaacdaca8095b"}], "stats": {"total": 38, "additions": 31, "deletions": 7}, "files": [{"sha": "48dea213e8cee040f5d8427ac08273dfe9b5862f", "filename": "src/doc/unstable-book/src/compiler-flags/control-flow-guard.md", "status": "modified", "additions": 31, "deletions": 7, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/d282fb000bd64a7e2a9685fa4c99485afc30ba63/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fcontrol-flow-guard.md", "raw_url": "https://github.com/rust-lang/rust/raw/d282fb000bd64a7e2a9685fa4c99485afc30ba63/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fcontrol-flow-guard.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fcontrol-flow-guard.md?ref=d282fb000bd64a7e2a9685fa4c99485afc30ba63", "patch": "@@ -4,30 +4,54 @@ The tracking issue for this feature is: [#68793](https://github.com/rust-lang/ru\n \n ------------------------\n \n-The `-Zcontrol_flow_guard=checks` compiler flag enables the Windows [Control Flow Guard][cfguard-docs] platform security feature. When enabled, the compiler outputs a list of valid indirect call targets, and inserts runtime checks on all indirect jump instructions to ensure that the destination is in the list of valid call targets.\n+The rustc flag `-Z control_flow_guard=checks` enables the Windows [Control Flow Guard](https://docs.microsoft.com/en-us/windows/win32/secbp/control-flow-guard) (CFG) platform security feature.\n \n-[cfguard-docs]: https://docs.microsoft.com/en-us/windows/win32/secbp/control-flow-guard\n+CFG is an exploit mitigation designed to enforce control-flow integrity for software running on supported Windows platforms (Windows 8.1 onwards). Specifically, CFG uses runtime checks to validate the target address of every indirect call/jump before allowing the call to complete. \n \n-For testing purposes, the `-Zcontrol_flow_guard=nochecks` compiler flag can be used to emit only the list of valid call targets, but not the runtime checks.\n+During compilation, the compiler identifies all indirect calls/jumps and adds CFG checks. It also emits metadata containing the relative addresses of all address-taken functions. At runtime, if the binary is run on a CFG-aware operating system, the loader uses the CFG metadata to generate a bitmap of the address space and marks those addresses that contain valid targets. On each indirect call, the inserted check determines whether the target address is marked in this bitmap. If the target is not valid, the process is terminated.\n \n-It is strongly recommended to also enable Control Flow Guard checks in all linked libraries, including the standard library. \n+In terms of interoperability:\n+- Code compiled with CFG enabled can be linked with libraries and object files that are not compiled with CFG. In this case, a CFG-aware linker can identify address-taken functions in the non-CFG libraries.\n+- Libraries compiled with CFG can linked into non-CFG programs. In this case, the CFG runtime checks in the libraries are not used (i.e. the mitigation is completely disabled).\n \n-To enable Control Flow Guard in the standard library, you can use the [cargo `-Zbuild-std` functionality][build-std] to recompile the standard library with the same configuration options as the main program. \n+CFG functionality is completely implemented in the LLVM backend and is supported for X86 (32-bit and 64-bit), ARM, and Aarch64 targets. The rustc flag adds the relevant LLVM module flags to enable the feature. This flag will be ignored for all non-Windows targets.\n+\n+\n+## When to use Control Flow Guard\n+\n+The primary motivation for enabling CFG in Rust is to enhance security when linking against non-Rust code, especially C/C++ code. To achieve full CFG protection, all indirect calls (including any from Rust code) must have the appropriate CFG checks, as added by this flag. CFG can also improve security for Rust code that uses the `unsafe` keyword\n+\n+\n+## Overhead of Control Flow Guard\n+\n+The CFG checks and metadata can potentially increase binary size and runtime overhead. The magnitude of any increase depends on the number and frequency of indirect calls. For example, enabling CFG for the Rust standard library increases binary size by approximately 0.14%. Enabling CFG in the SPEC CPU 2017 Integer Speed benchmark suite (compiled with Clang/LLVM) incurs approximate runtime overheads of between 0% and 8%, with a geometric mean of 2.9%.\n+\n+\n+## Testing Control Flow Guard\n+\n+The rustc flag `-Z control_flow_guard=nochecks` instructs LLVM to emit the list of valid call targets without inserting runtime checks. This flag should only be used for testing purposes as it does not provide security enforcement.\n+\n+\n+## Control Flow Guard in libraries\n+\n+It is strongly recommended to also enable CFG checks for all linked libraries, including the standard library. \n+\n+To enable CFG in the standard library, use the [cargo `-Z build-std` functionality][build-std] to recompile the standard library with the same configuration options as the main program.\n \n [build-std]: https://doc.rust-lang.org/nightly/cargo/reference/unstable.html#build-std\n \n For example:\n ```cmd\n rustup toolchain install --force nightly\n rustup component add rust-src\n-SET RUSTFLAGS=-Zcontrol_flow_guard=checks\n+SET RUSTFLAGS=-Z control_flow_guard=checks\n cargo +nightly build -Z build-std --target x86_64-pc-windows-msvc\n ```\n \n ```PowerShell\n rustup toolchain install --force nightly\n rustup component add rust-src\n-$Env:RUSTFLAGS = \"-Zcontrol_flow_guard=checks\"\n+$Env:RUSTFLAGS = \"-Z control_flow_guard=checks\"\n cargo +nightly build -Z build-std --target x86_64-pc-windows-msvc\n ```\n "}]}