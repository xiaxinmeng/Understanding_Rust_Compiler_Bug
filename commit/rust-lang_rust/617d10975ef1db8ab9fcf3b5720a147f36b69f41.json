{"sha": "617d10975ef1db8ab9fcf3b5720a147f36b69f41", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYxN2QxMDk3NWVmMWRiOGFiOWZjZjNiNTcyMGExNDdmMzZiNjlmNDE=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2020-07-28T02:16:41Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2020-07-28T02:54:14Z"}, "message": "Separate `missing_doc_code_examples` from intra-doc links\n\nThese two lints have no relation other than both being nightly-only.\nThis allows stabilizing intra-doc links without stabilizing\nmissing_doc_code_examples.", "tree": {"sha": "eacc5bb65a4c024baffe88763b06f02f2e5dcb4c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eacc5bb65a4c024baffe88763b06f02f2e5dcb4c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/617d10975ef1db8ab9fcf3b5720a147f36b69f41", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/617d10975ef1db8ab9fcf3b5720a147f36b69f41", "html_url": "https://github.com/rust-lang/rust/commit/617d10975ef1db8ab9fcf3b5720a147f36b69f41", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/617d10975ef1db8ab9fcf3b5720a147f36b69f41/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d6953df14657f5932270ad2b33bccafe6f39fad4", "url": "https://api.github.com/repos/rust-lang/rust/commits/d6953df14657f5932270ad2b33bccafe6f39fad4", "html_url": "https://github.com/rust-lang/rust/commit/d6953df14657f5932270ad2b33bccafe6f39fad4"}], "stats": {"total": 63, "additions": 34, "deletions": 29}, "files": [{"sha": "418238181e9b8d1f4197f29884f4b88ccf47b23c", "filename": "src/librustdoc/passes/collect_intra_doc_links.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/617d10975ef1db8ab9fcf3b5720a147f36b69f41/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/617d10975ef1db8ab9fcf3b5720a147f36b69f41/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs?ref=617d10975ef1db8ab9fcf3b5720a147f36b69f41", "patch": "@@ -23,7 +23,7 @@ use crate::clean::*;\n use crate::core::DocContext;\n use crate::fold::DocFolder;\n use crate::html::markdown::markdown_links;\n-use crate::passes::{look_for_tests, Pass};\n+use crate::passes::Pass;\n \n use super::span_of_attrs;\n \n@@ -508,8 +508,6 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n         let dox = item.attrs.collapsed_doc_value().unwrap_or_else(String::new);\n         trace!(\"got documentation '{}'\", dox);\n \n-        look_for_tests(&cx, &dox, &item, true);\n-\n         // find item's parent to resolve `Self` in item's docs below\n         let parent_name = self.cx.as_local_hir_id(item.def_id).and_then(|item_hir| {\n             let parent_hir = self.cx.tcx.hir().get_parent_item(item_hir);"}, {"sha": "c604c804ddf5e918997650f22b166ec5c83ab89d", "filename": "src/librustdoc/passes/mod.rs", "status": "modified", "additions": 19, "deletions": 12, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/617d10975ef1db8ab9fcf3b5720a147f36b69f41/src%2Flibrustdoc%2Fpasses%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/617d10975ef1db8ab9fcf3b5720a147f36b69f41/src%2Flibrustdoc%2Fpasses%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fmod.rs?ref=617d10975ef1db8ab9fcf3b5720a147f36b69f41", "patch": "@@ -312,12 +312,7 @@ impl DocFolder for ImportStripper {\n     }\n }\n \n-pub fn look_for_tests<'tcx>(\n-    cx: &DocContext<'tcx>,\n-    dox: &str,\n-    item: &Item,\n-    check_missing_code: bool,\n-) {\n+pub fn look_for_tests<'tcx>(cx: &DocContext<'tcx>, dox: &str, item: &Item) {\n     let hir_id = match cx.as_local_hir_id(item.def_id) {\n         Some(hir_id) => hir_id,\n         None => {\n@@ -340,12 +335,24 @@ pub fn look_for_tests<'tcx>(\n \n     find_testable_code(&dox, &mut tests, ErrorCodes::No, false, None);\n \n-    if check_missing_code && tests.found_tests == 0 {\n-        let sp = span_of_attrs(&item.attrs).unwrap_or(item.source.span());\n-        cx.tcx.struct_span_lint_hir(lint::builtin::MISSING_DOC_CODE_EXAMPLES, hir_id, sp, |lint| {\n-            lint.build(\"missing code example in this documentation\").emit()\n-        });\n-    } else if !check_missing_code\n+    if tests.found_tests == 0 {\n+        use clean::ItemEnum::*;\n+\n+        let should_report = match item.inner {\n+            ExternCrateItem(_, _) | ImportItem(_) | PrimitiveItem(_) | KeywordItem(_) => false,\n+            _ => true,\n+        };\n+        if should_report {\n+            debug!(\"reporting error for {:?} (hir_id={:?})\", item, hir_id);\n+            let sp = span_of_attrs(&item.attrs).unwrap_or(item.source.span());\n+            cx.tcx.struct_span_lint_hir(\n+                lint::builtin::MISSING_DOC_CODE_EXAMPLES,\n+                hir_id,\n+                sp,\n+                |lint| lint.build(\"missing code example in this documentation\").emit(),\n+            );\n+        }\n+    } else if rustc_feature::UnstableFeatures::from_environment().is_nightly_build()\n         && tests.found_tests > 0\n         && !cx.renderinfo.borrow().access_levels.is_public(item.def_id)\n     {"}, {"sha": "77ed578ca7730a09bbeb2ca8ba3bb85dcbad0f39", "filename": "src/librustdoc/passes/private_items_doc_tests.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/617d10975ef1db8ab9fcf3b5720a147f36b69f41/src%2Flibrustdoc%2Fpasses%2Fprivate_items_doc_tests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/617d10975ef1db8ab9fcf3b5720a147f36b69f41/src%2Flibrustdoc%2Fpasses%2Fprivate_items_doc_tests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fprivate_items_doc_tests.rs?ref=617d10975ef1db8ab9fcf3b5720a147f36b69f41", "patch": "@@ -30,7 +30,7 @@ impl<'a, 'tcx> DocFolder for PrivateItemDocTestLinter<'a, 'tcx> {\n         let cx = self.cx;\n         let dox = item.attrs.collapsed_doc_value().unwrap_or_else(String::new);\n \n-        look_for_tests(&cx, &dox, &item, false);\n+        look_for_tests(&cx, &dox, &item);\n \n         self.fold_item_recur(item)\n     }"}, {"sha": "ad923c714da4daf741deb4680dfbb916e3550efc", "filename": "src/test/rustdoc-ui/lint-group.stderr", "status": "modified", "additions": 13, "deletions": 13, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/617d10975ef1db8ab9fcf3b5720a147f36b69f41/src%2Ftest%2Frustdoc-ui%2Flint-group.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/617d10975ef1db8ab9fcf3b5720a147f36b69f41/src%2Ftest%2Frustdoc-ui%2Flint-group.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Flint-group.stderr?ref=617d10975ef1db8ab9fcf3b5720a147f36b69f41", "patch": "@@ -1,3 +1,16 @@\n+error: missing code example in this documentation\n+  --> $DIR/lint-group.rs:16:1\n+   |\n+LL | /// wait, this doesn't have a doctest?\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+note: the lint level is defined here\n+  --> $DIR/lint-group.rs:7:9\n+   |\n+LL | #![deny(rustdoc)]\n+   |         ^^^^^^^\n+   = note: `#[deny(missing_doc_code_examples)]` implied by `#[deny(rustdoc)]`\n+\n error: documentation test in private item\n   --> $DIR/lint-group.rs:19:1\n    |\n@@ -29,18 +42,5 @@ LL | #![deny(rustdoc)]\n    = note: `#[deny(intra_doc_link_resolution_failure)]` implied by `#[deny(rustdoc)]`\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n-error: missing code example in this documentation\n-  --> $DIR/lint-group.rs:16:1\n-   |\n-LL | /// wait, this doesn't have a doctest?\n-   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-   |\n-note: the lint level is defined here\n-  --> $DIR/lint-group.rs:7:9\n-   |\n-LL | #![deny(rustdoc)]\n-   |         ^^^^^^^\n-   = note: `#[deny(missing_doc_code_examples)]` implied by `#[deny(rustdoc)]`\n-\n error: aborting due to 3 previous errors\n "}]}