{"sha": "c64471ab8624e256c745dfd5d5e89ea6aa9e8228", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM2NDQ3MWFiODYyNGUyNTZjNzQ1ZGZkNWQ1ZTg5ZWE2YWE5ZTgyMjg=", "commit": {"author": {"name": "Daniel Ralston", "email": "Wubbulous@gmail.com", "date": "2013-05-01T08:59:36Z"}, "committer": {"name": "Daniel Ralston", "email": "Wubbulous@gmail.com", "date": "2013-05-01T22:25:17Z"}, "message": "Add trait object field types to back/abi.rs, and use them\n\nI've added trt_field_vtable, trt_field_box, and trt_field_tydesc, and\ninserted them in place of the \"magic numbers\" used to access trait\nobject fields through GEPi().", "tree": {"sha": "c2fb8fcbc30498a418334dde672d96f21787abfb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c2fb8fcbc30498a418334dde672d96f21787abfb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c64471ab8624e256c745dfd5d5e89ea6aa9e8228", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c64471ab8624e256c745dfd5d5e89ea6aa9e8228", "html_url": "https://github.com/rust-lang/rust/commit/c64471ab8624e256c745dfd5d5e89ea6aa9e8228", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c64471ab8624e256c745dfd5d5e89ea6aa9e8228/comments", "author": {"login": "Sodel-the-Vociferous", "id": 918813, "node_id": "MDQ6VXNlcjkxODgxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/918813?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Sodel-the-Vociferous", "html_url": "https://github.com/Sodel-the-Vociferous", "followers_url": "https://api.github.com/users/Sodel-the-Vociferous/followers", "following_url": "https://api.github.com/users/Sodel-the-Vociferous/following{/other_user}", "gists_url": "https://api.github.com/users/Sodel-the-Vociferous/gists{/gist_id}", "starred_url": "https://api.github.com/users/Sodel-the-Vociferous/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Sodel-the-Vociferous/subscriptions", "organizations_url": "https://api.github.com/users/Sodel-the-Vociferous/orgs", "repos_url": "https://api.github.com/users/Sodel-the-Vociferous/repos", "events_url": "https://api.github.com/users/Sodel-the-Vociferous/events{/privacy}", "received_events_url": "https://api.github.com/users/Sodel-the-Vociferous/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Sodel-the-Vociferous", "id": 918813, "node_id": "MDQ6VXNlcjkxODgxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/918813?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Sodel-the-Vociferous", "html_url": "https://github.com/Sodel-the-Vociferous", "followers_url": "https://api.github.com/users/Sodel-the-Vociferous/followers", "following_url": "https://api.github.com/users/Sodel-the-Vociferous/following{/other_user}", "gists_url": "https://api.github.com/users/Sodel-the-Vociferous/gists{/gist_id}", "starred_url": "https://api.github.com/users/Sodel-the-Vociferous/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Sodel-the-Vociferous/subscriptions", "organizations_url": "https://api.github.com/users/Sodel-the-Vociferous/orgs", "repos_url": "https://api.github.com/users/Sodel-the-Vociferous/repos", "events_url": "https://api.github.com/users/Sodel-the-Vociferous/events{/privacy}", "received_events_url": "https://api.github.com/users/Sodel-the-Vociferous/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "08dd625d455548c7a5795db930ebfc5e3b1eb9c4", "url": "https://api.github.com/repos/rust-lang/rust/commits/08dd625d455548c7a5795db930ebfc5e3b1eb9c4", "html_url": "https://github.com/rust-lang/rust/commit/08dd625d455548c7a5795db930ebfc5e3b1eb9c4"}], "stats": {"total": 45, "additions": 28, "deletions": 17}, "files": [{"sha": "6d963d7cfd2cb24d52654fd3767d0f42c73651bc", "filename": "src/librustc/back/abi.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c64471ab8624e256c745dfd5d5e89ea6aa9e8228/src%2Flibrustc%2Fback%2Fabi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c64471ab8624e256c745dfd5d5e89ea6aa9e8228/src%2Flibrustc%2Fback%2Fabi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Fabi.rs?ref=c64471ab8624e256c745dfd5d5e89ea6aa9e8228", "patch": "@@ -57,6 +57,13 @@ pub static n_tydesc_fields: uint = 8u;\n pub static fn_field_code: uint = 0u;\n pub static fn_field_box: uint = 1u;\n \n+// The three fields of a trait object/trait instance: vtable, box, and type\n+// description.\n+pub static trt_field_vtable: uint = 0u;\n+pub static trt_field_box: uint = 1u;\n+// This field is only present in unique trait objects, so it comes last.\n+pub static trt_field_tydesc: uint = 2u;\n+\n pub static vec_elt_fill: uint = 0u;\n \n pub static vec_elt_alloc: uint = 1u;"}, {"sha": "f1888084c0b05249d04b4ee8dafa2fe2baceeb0a", "filename": "src/librustc/middle/trans/glue.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/c64471ab8624e256c745dfd5d5e89ea6aa9e8228/src%2Flibrustc%2Fmiddle%2Ftrans%2Fglue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c64471ab8624e256c745dfd5d5e89ea6aa9e8228/src%2Flibrustc%2Fmiddle%2Ftrans%2Fglue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fglue.rs?ref=c64471ab8624e256c745dfd5d5e89ea6aa9e8228", "patch": "@@ -549,12 +549,12 @@ pub fn make_drop_glue(bcx: block, v0: ValueRef, t: ty::t) {\n         closure::make_closure_glue(bcx, v0, t, drop_ty)\n       }\n       ty::ty_trait(_, _, ty::BoxTraitStore, _) => {\n-        let llbox = Load(bcx, GEPi(bcx, v0, [0u, 1u]));\n+        let llbox = Load(bcx, GEPi(bcx, v0, [0u, abi::trt_field_box]));\n         decr_refcnt_maybe_free(bcx, llbox, ty::mk_opaque_box(ccx.tcx))\n       }\n       ty::ty_trait(_, _, ty::UniqTraitStore, _) => {\n-        let lluniquevalue = GEPi(bcx, v0, [0, 1]);\n-        let lltydesc = Load(bcx, GEPi(bcx, v0, [0, 2]));\n+        let lluniquevalue = GEPi(bcx, v0, [0, abi::trt_field_box]);\n+        let lltydesc = Load(bcx, GEPi(bcx, v0, [0, abi::trt_field_tydesc]));\n         call_tydesc_glue_full(bcx, lluniquevalue, lltydesc,\n                               abi::tydesc_field_free_glue, None);\n         bcx\n@@ -613,13 +613,13 @@ pub fn make_take_glue(bcx: block, v: ValueRef, t: ty::t) {\n         closure::make_closure_glue(bcx, v, t, take_ty)\n       }\n       ty::ty_trait(_, _, ty::BoxTraitStore, _) => {\n-        let llbox = Load(bcx, GEPi(bcx, v, [0u, 1u]));\n+        let llbox = Load(bcx, GEPi(bcx, v, [0u, abi::trt_field_box]));\n         incr_refcnt_of_boxed(bcx, llbox);\n         bcx\n       }\n       ty::ty_trait(_, _, ty::UniqTraitStore, _) => {\n-        let llval = GEPi(bcx, v, [0, 1]);\n-        let lltydesc = Load(bcx, GEPi(bcx, v, [0, 2]));\n+        let llval = GEPi(bcx, v, [0, abi::trt_field_box]);\n+        let lltydesc = Load(bcx, GEPi(bcx, v, [0, abi::trt_field_tydesc]));\n         call_tydesc_glue_full(bcx, llval, lltydesc,\n                               abi::tydesc_field_take_glue, None);\n         bcx"}, {"sha": "a90475d9ed0856edf6957ab817d738f4ef4bfec5", "filename": "src/librustc/middle/trans/meth.rs", "status": "modified", "additions": 15, "deletions": 11, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/c64471ab8624e256c745dfd5d5e89ea6aa9e8228/src%2Flibrustc%2Fmiddle%2Ftrans%2Fmeth.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c64471ab8624e256c745dfd5d5e89ea6aa9e8228/src%2Flibrustc%2Fmiddle%2Ftrans%2Fmeth.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fmeth.rs?ref=c64471ab8624e256c745dfd5d5e89ea6aa9e8228", "patch": "@@ -637,14 +637,15 @@ pub fn trans_trait_callee_from_llval(bcx: block,\n            val_str(bcx.ccx().tn, llpair));\n     let llvtable = Load(bcx,\n                       PointerCast(bcx,\n-                                  GEPi(bcx, llpair, [0u, 0u]),\n+                                  GEPi(bcx, llpair,\n+                                       [0u, abi::trt_field_vtable]),\n                                   T_ptr(T_ptr(T_vtable()))));\n \n     // Load the box from the @Trait pair and GEP over the box header if\n     // necessary:\n     let mut llself;\n     debug!(\"(translating trait callee) loading second index from pair\");\n-    let llbox = Load(bcx, GEPi(bcx, llpair, [0u, 1u]));\n+    let llbox = Load(bcx, GEPi(bcx, llpair, [0u, abi::trt_field_box]));\n \n     // Munge `llself` appropriately for the type of `self` in the method.\n     let self_mode;\n@@ -845,27 +846,30 @@ pub fn trans_trait_cast(bcx: block,\n \n     match store {\n         ty::RegionTraitStore(_) | ty::BoxTraitStore => {\n-            let mut llboxdest = GEPi(bcx, lldest, [0u, 1u]);\n-            // Just store the pointer into the pair.\n+            let mut llboxdest = GEPi(bcx, lldest, [0u, abi::trt_field_box]);\n+            // Just store the pointer into the pair. (Region/borrowed\n+            // and boxed trait objects are represented as pairs, and\n+            // have no type descriptor field.)\n             llboxdest = PointerCast(bcx,\n                                     llboxdest,\n                                     T_ptr(type_of(bcx.ccx(), v_ty)));\n             bcx = expr::trans_into(bcx, val, SaveIn(llboxdest));\n         }\n         ty::UniqTraitStore => {\n-            // Translate the uniquely-owned value into the second element of\n-            // the triple. (The first element is the vtable.)\n-            let mut llvaldest = GEPi(bcx, lldest, [0, 1]);\n+            // Translate the uniquely-owned value in the\n+            // triple. (Unique trait objects are represented as\n+            // triples.)\n+            let mut llvaldest = GEPi(bcx, lldest, [0, abi::trt_field_box]);\n             llvaldest = PointerCast(bcx,\n                                     llvaldest,\n                                     T_ptr(type_of(bcx.ccx(), v_ty)));\n             bcx = expr::trans_into(bcx, val, SaveIn(llvaldest));\n \n-            // Get the type descriptor of the wrapped value and store it into\n-            // the third element of the triple as well.\n+            // Get the type descriptor of the wrapped value and store\n+            // it in the triple as well.\n             let tydesc = get_tydesc(bcx.ccx(), v_ty);\n             glue::lazily_emit_all_tydesc_glue(bcx.ccx(), tydesc);\n-            let lltydescdest = GEPi(bcx, lldest, [0, 2]);\n+            let lltydescdest = GEPi(bcx, lldest, [0, abi::trt_field_tydesc]);\n             Store(bcx, tydesc.tydesc, lltydescdest);\n         }\n     }\n@@ -875,7 +879,7 @@ pub fn trans_trait_cast(bcx: block,\n     let orig = resolve_vtable_in_fn_ctxt(bcx.fcx, orig);\n     let vtable = get_vtable(bcx.ccx(), orig);\n     Store(bcx, vtable, PointerCast(bcx,\n-                                   GEPi(bcx, lldest, [0u, 0u]),\n+                                   GEPi(bcx, lldest, [0u, abi::trt_field_vtable]),\n                                    T_ptr(val_ty(vtable))));\n \n     bcx"}]}