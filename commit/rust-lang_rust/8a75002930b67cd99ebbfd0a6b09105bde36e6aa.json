{"sha": "8a75002930b67cd99ebbfd0a6b09105bde36e6aa", "node_id": "C_kwDOAAsO6NoAKDhhNzUwMDI5MzBiNjdjZDk5ZWJiZmQwYTZiMDkxMDViZGUzNmU2YWE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-22T00:23:23Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-22T00:23:23Z"}, "message": "Auto merge of #7685 - camsteffen:let-else-needless-ret, r=giraffate\n\nFix needless_return with let-else\n\nchangelog: Fix needless_return FP with `let...else`\n\nFixes #7637", "tree": {"sha": "a3687de2065c464d217a004f7b32cc5e6b40fb8e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a3687de2065c464d217a004f7b32cc5e6b40fb8e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8a75002930b67cd99ebbfd0a6b09105bde36e6aa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8a75002930b67cd99ebbfd0a6b09105bde36e6aa", "html_url": "https://github.com/rust-lang/rust/commit/8a75002930b67cd99ebbfd0a6b09105bde36e6aa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8a75002930b67cd99ebbfd0a6b09105bde36e6aa/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "848e5518d66ff2084c10a4c1cfcf5da5e0534033", "url": "https://api.github.com/repos/rust-lang/rust/commits/848e5518d66ff2084c10a4c1cfcf5da5e0534033", "html_url": "https://github.com/rust-lang/rust/commit/848e5518d66ff2084c10a4c1cfcf5da5e0534033"}, {"sha": "b36591217df3d13a67f1bab77c39c2d5bb55ce02", "url": "https://api.github.com/repos/rust-lang/rust/commits/b36591217df3d13a67f1bab77c39c2d5bb55ce02", "html_url": "https://github.com/rust-lang/rust/commit/b36591217df3d13a67f1bab77c39c2d5bb55ce02"}], "stats": {"total": 93, "additions": 48, "deletions": 45}, "files": [{"sha": "ae85b7087e7b5add94b7cea8939f20f304f82377", "filename": "clippy_lints/src/returns.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/8a75002930b67cd99ebbfd0a6b09105bde36e6aa/clippy_lints%2Fsrc%2Freturns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a75002930b67cd99ebbfd0a6b09105bde36e6aa/clippy_lints%2Fsrc%2Freturns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Freturns.rs?ref=8a75002930b67cd99ebbfd0a6b09105bde36e6aa", "patch": "@@ -11,6 +11,7 @@ use rustc_middle::hir::map::Map;\n use rustc_middle::lint::in_external_macro;\n use rustc_middle::ty::subst::GenericArgKind;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n+use rustc_span::hygiene::DesugaringKind;\n use rustc_span::source_map::Span;\n use rustc_span::sym;\n \n@@ -199,7 +200,9 @@ fn check_final_expr<'tcx>(\n                 check_block_return(cx, ifblock);\n             }\n             if let Some(else_clause) = else_clause_opt {\n-                check_final_expr(cx, else_clause, None, RetReplacement::Empty);\n+                if expr.span.desugaring_kind() != Some(DesugaringKind::LetElse) {\n+                    check_final_expr(cx, else_clause, None, RetReplacement::Empty);\n+                }\n             }\n         },\n         // a match expr, check all arms"}, {"sha": "37efa6274df7aa904b65fc99b458ad60acc4dfef", "filename": "tests/ui/needless_return.fixed", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/8a75002930b67cd99ebbfd0a6b09105bde36e6aa/tests%2Fui%2Fneedless_return.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/8a75002930b67cd99ebbfd0a6b09105bde36e6aa/tests%2Fui%2Fneedless_return.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_return.fixed?ref=8a75002930b67cd99ebbfd0a6b09105bde36e6aa", "patch": "@@ -1,13 +1,9 @@\n // run-rustfix\n // edition:2018\n \n+#![feature(let_else)]\n #![allow(unused)]\n-#![allow(\n-    clippy::if_same_then_else,\n-    clippy::single_match,\n-    clippy::branches_sharing_code,\n-    clippy::needless_bool\n-)]\n+#![allow(clippy::if_same_then_else, clippy::single_match, clippy::needless_bool)]\n #![warn(clippy::needless_return)]\n \n macro_rules! the_answer {\n@@ -207,4 +203,8 @@ async fn async_test_return_in_macro() {\n     needed_return!(0);\n }\n \n+fn let_else() {\n+    let Some(1) = Some(1) else { return };\n+}\n+\n fn main() {}"}, {"sha": "cbf384ac9e4356a21548e5181947da79a0b95ad2", "filename": "tests/ui/needless_return.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/8a75002930b67cd99ebbfd0a6b09105bde36e6aa/tests%2Fui%2Fneedless_return.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a75002930b67cd99ebbfd0a6b09105bde36e6aa/tests%2Fui%2Fneedless_return.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_return.rs?ref=8a75002930b67cd99ebbfd0a6b09105bde36e6aa", "patch": "@@ -1,13 +1,9 @@\n // run-rustfix\n // edition:2018\n \n+#![feature(let_else)]\n #![allow(unused)]\n-#![allow(\n-    clippy::if_same_then_else,\n-    clippy::single_match,\n-    clippy::branches_sharing_code,\n-    clippy::needless_bool\n-)]\n+#![allow(clippy::if_same_then_else, clippy::single_match, clippy::needless_bool)]\n #![warn(clippy::needless_return)]\n \n macro_rules! the_answer {\n@@ -207,4 +203,8 @@ async fn async_test_return_in_macro() {\n     needed_return!(0);\n }\n \n+fn let_else() {\n+    let Some(1) = Some(1) else { return };\n+}\n+\n fn main() {}"}, {"sha": "7ce7028bbae4b1defd812911afb7a4a540d8b7fe", "filename": "tests/ui/needless_return.stderr", "status": "modified", "additions": 32, "deletions": 32, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/8a75002930b67cd99ebbfd0a6b09105bde36e6aa/tests%2Fui%2Fneedless_return.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8a75002930b67cd99ebbfd0a6b09105bde36e6aa/tests%2Fui%2Fneedless_return.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_return.stderr?ref=8a75002930b67cd99ebbfd0a6b09105bde36e6aa", "patch": "@@ -1,193 +1,193 @@\n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:24:5\n+  --> $DIR/needless_return.rs:20:5\n    |\n LL |     return true;\n    |     ^^^^^^^^^^^^ help: remove `return`: `true`\n    |\n    = note: `-D clippy::needless-return` implied by `-D warnings`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:28:5\n+  --> $DIR/needless_return.rs:24:5\n    |\n LL |     return true;\n    |     ^^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:33:9\n+  --> $DIR/needless_return.rs:29:9\n    |\n LL |         return true;\n    |         ^^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:35:9\n+  --> $DIR/needless_return.rs:31:9\n    |\n LL |         return false;\n    |         ^^^^^^^^^^^^^ help: remove `return`: `false`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:41:17\n+  --> $DIR/needless_return.rs:37:17\n    |\n LL |         true => return false,\n    |                 ^^^^^^^^^^^^ help: remove `return`: `false`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:43:13\n+  --> $DIR/needless_return.rs:39:13\n    |\n LL |             return true;\n    |             ^^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:50:9\n+  --> $DIR/needless_return.rs:46:9\n    |\n LL |         return true;\n    |         ^^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:52:16\n+  --> $DIR/needless_return.rs:48:16\n    |\n LL |     let _ = || return true;\n    |                ^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:60:5\n+  --> $DIR/needless_return.rs:56:5\n    |\n LL |     return;\n    |     ^^^^^^^ help: remove `return`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:65:9\n+  --> $DIR/needless_return.rs:61:9\n    |\n LL |         return;\n    |         ^^^^^^^ help: remove `return`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:67:9\n+  --> $DIR/needless_return.rs:63:9\n    |\n LL |         return;\n    |         ^^^^^^^ help: remove `return`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:74:14\n+  --> $DIR/needless_return.rs:70:14\n    |\n LL |         _ => return,\n    |              ^^^^^^ help: replace `return` with an empty block: `{}`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:89:9\n+  --> $DIR/needless_return.rs:85:9\n    |\n LL |         return String::from(\"test\");\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: remove `return`: `String::from(\"test\")`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:91:9\n+  --> $DIR/needless_return.rs:87:9\n    |\n LL |         return String::new();\n    |         ^^^^^^^^^^^^^^^^^^^^^ help: remove `return`: `String::new()`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:112:32\n+  --> $DIR/needless_return.rs:108:32\n    |\n LL |         bar.unwrap_or_else(|_| return)\n    |                                ^^^^^^ help: replace `return` with an empty block: `{}`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:117:13\n+  --> $DIR/needless_return.rs:113:13\n    |\n LL |             return;\n    |             ^^^^^^^ help: remove `return`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:119:20\n+  --> $DIR/needless_return.rs:115:20\n    |\n LL |         let _ = || return;\n    |                    ^^^^^^ help: replace `return` with an empty block: `{}`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:125:32\n+  --> $DIR/needless_return.rs:121:32\n    |\n LL |         res.unwrap_or_else(|_| return Foo)\n    |                                ^^^^^^^^^^ help: remove `return`: `Foo`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:134:5\n+  --> $DIR/needless_return.rs:130:5\n    |\n LL |     return true;\n    |     ^^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:138:5\n+  --> $DIR/needless_return.rs:134:5\n    |\n LL |     return true;\n    |     ^^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:143:9\n+  --> $DIR/needless_return.rs:139:9\n    |\n LL |         return true;\n    |         ^^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:145:9\n+  --> $DIR/needless_return.rs:141:9\n    |\n LL |         return false;\n    |         ^^^^^^^^^^^^^ help: remove `return`: `false`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:151:17\n+  --> $DIR/needless_return.rs:147:17\n    |\n LL |         true => return false,\n    |                 ^^^^^^^^^^^^ help: remove `return`: `false`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:153:13\n+  --> $DIR/needless_return.rs:149:13\n    |\n LL |             return true;\n    |             ^^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:160:9\n+  --> $DIR/needless_return.rs:156:9\n    |\n LL |         return true;\n    |         ^^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:162:16\n+  --> $DIR/needless_return.rs:158:16\n    |\n LL |     let _ = || return true;\n    |                ^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:170:5\n+  --> $DIR/needless_return.rs:166:5\n    |\n LL |     return;\n    |     ^^^^^^^ help: remove `return`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:175:9\n+  --> $DIR/needless_return.rs:171:9\n    |\n LL |         return;\n    |         ^^^^^^^ help: remove `return`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:177:9\n+  --> $DIR/needless_return.rs:173:9\n    |\n LL |         return;\n    |         ^^^^^^^ help: remove `return`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:184:14\n+  --> $DIR/needless_return.rs:180:14\n    |\n LL |         _ => return,\n    |              ^^^^^^ help: replace `return` with an empty block: `{}`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:199:9\n+  --> $DIR/needless_return.rs:195:9\n    |\n LL |         return String::from(\"test\");\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: remove `return`: `String::from(\"test\")`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:201:9\n+  --> $DIR/needless_return.rs:197:9\n    |\n LL |         return String::new();\n    |         ^^^^^^^^^^^^^^^^^^^^^ help: remove `return`: `String::new()`"}]}