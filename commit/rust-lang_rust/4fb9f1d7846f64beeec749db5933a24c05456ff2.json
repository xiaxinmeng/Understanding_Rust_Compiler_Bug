{"sha": "4fb9f1d7846f64beeec749db5933a24c05456ff2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRmYjlmMWQ3ODQ2ZjY0YmVlZWM3NDlkYjU5MzNhMjRjMDU0NTZmZjI=", "commit": {"author": {"name": "Bastian Kauschke", "email": "bastian_kauschke@hotmail.de", "date": "2020-12-08T09:34:31Z"}, "committer": {"name": "Bastian Kauschke", "email": "bastian_kauschke@hotmail.de", "date": "2020-12-08T09:34:31Z"}, "message": "fix unsoundness in `make_contiguous`", "tree": {"sha": "3a5822f7ccbcb37bfba63ac9e166cad134090f7f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3a5822f7ccbcb37bfba63ac9e166cad134090f7f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4fb9f1d7846f64beeec749db5933a24c05456ff2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4fb9f1d7846f64beeec749db5933a24c05456ff2", "html_url": "https://github.com/rust-lang/rust/commit/4fb9f1d7846f64beeec749db5933a24c05456ff2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4fb9f1d7846f64beeec749db5933a24c05456ff2/comments", "author": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "afa995b2dd1e194845f2082707e6045d539230a5", "url": "https://api.github.com/repos/rust-lang/rust/commits/afa995b2dd1e194845f2082707e6045d539230a5", "html_url": "https://github.com/rust-lang/rust/commit/afa995b2dd1e194845f2082707e6045d539230a5"}], "stats": {"total": 32, "additions": 27, "deletions": 5}, "files": [{"sha": "57807bc54539031f1044064c9d4570c14e2a484d", "filename": "library/alloc/src/collections/vec_deque/mod.rs", "status": "modified", "additions": 13, "deletions": 5, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/4fb9f1d7846f64beeec749db5933a24c05456ff2/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fb9f1d7846f64beeec749db5933a24c05456ff2/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Fmod.rs?ref=4fb9f1d7846f64beeec749db5933a24c05456ff2", "patch": "@@ -1469,6 +1469,8 @@ impl<T> VecDeque<T> {\n \n     #[inline]\n     fn is_contiguous(&self) -> bool {\n+        // FIXME: Should we consider `head == 0` to mean\n+        // that `self` is contiguous?\n         self.tail <= self.head\n     }\n \n@@ -2198,7 +2200,7 @@ impl<T> VecDeque<T> {\n         if self.is_contiguous() {\n             let tail = self.tail;\n             let head = self.head;\n-            return unsafe { &mut self.buffer_as_mut_slice()[tail..head] };\n+            return unsafe { RingSlices::ring_slices(self.buffer_as_mut_slice(), head, tail).0 };\n         }\n \n         let buf = self.buf.ptr();\n@@ -2224,7 +2226,13 @@ impl<T> VecDeque<T> {\n                 self.tail = 0;\n                 self.head = len;\n             }\n-        } else if free >= self.head {\n+        } else if free > self.head {\n+            // FIXME: We currently do not consider ....ABCDEFGH\n+            // to be contiguous because `head` would be `0` in this\n+            // case. While we probably want to change this it\n+            // isn't trivial as a few places expect `is_contiguous`\n+            // to mean that we can just slice using `buf[tail..head]`.\n+\n             // there is enough free space to copy the head in one go,\n             // this means that we first shift the tail forwards, and then\n             // copy the head to the correct position.\n@@ -2238,7 +2246,7 @@ impl<T> VecDeque<T> {\n                 // ...ABCDEFGH.\n \n                 self.tail = self.head;\n-                self.head = self.tail + len;\n+                self.head = self.wrap_add(self.tail, len);\n             }\n         } else {\n             // free is smaller than both head and tail,\n@@ -2278,7 +2286,7 @@ impl<T> VecDeque<T> {\n \n         let tail = self.tail;\n         let head = self.head;\n-        unsafe { &mut self.buffer_as_mut_slice()[tail..head] }\n+        unsafe { RingSlices::ring_slices(self.buffer_as_mut_slice(), head, tail).0 }\n     }\n \n     /// Rotates the double-ended queue `mid` places to the left.\n@@ -2839,7 +2847,7 @@ impl<T> From<VecDeque<T>> for Vec<T> {\n             let len = other.len();\n             let cap = other.cap();\n \n-            if other.head != 0 {\n+            if other.tail != 0 {\n                 ptr::copy(buf.add(other.tail), buf, len);\n             }\n             Vec::from_raw_parts(buf, len, cap)"}, {"sha": "21f52af056b2a2090c3bd90952a51d089085d4b1", "filename": "library/alloc/src/collections/vec_deque/tests.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4fb9f1d7846f64beeec749db5933a24c05456ff2/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fb9f1d7846f64beeec749db5933a24c05456ff2/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Ftests.rs?ref=4fb9f1d7846f64beeec749db5933a24c05456ff2", "patch": "@@ -210,6 +210,20 @@ fn make_contiguous_small_free() {\n     );\n }\n \n+#[test]\n+fn make_contiguous_head_to_end() {\n+    let mut dq = VecDeque::with_capacity(3);\n+    dq.push_front('B');\n+    dq.push_front('A');\n+    dq.push_back('C');\n+    dq.make_contiguous();\n+    let expected_tail = 0;\n+    let expected_head = 3;\n+    assert_eq!(expected_tail, dq.tail);\n+    assert_eq!(expected_head, dq.head);\n+    assert_eq!((&['A', 'B', 'C'] as &[_], &[] as &[_]), dq.as_slices());\n+}\n+\n #[test]\n fn test_remove() {\n     // This test checks that every single combination of tail position, length, and"}]}