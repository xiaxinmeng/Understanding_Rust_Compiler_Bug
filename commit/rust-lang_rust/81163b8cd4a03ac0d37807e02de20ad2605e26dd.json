{"sha": "81163b8cd4a03ac0d37807e02de20ad2605e26dd", "node_id": "C_kwDOAAsO6NoAKDgxMTYzYjhjZDRhMDNhYzBkMzc4MDdlMDJkZTIwYWQyNjA1ZTI2ZGQ", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-01-07T17:51:10Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-01-07T17:51:10Z"}, "message": "fix: Fix attribute stripping ignoring doc comments", "tree": {"sha": "07bb35e7ec874c29325496e32c4a9be028b98514", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/07bb35e7ec874c29325496e32c4a9be028b98514"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/81163b8cd4a03ac0d37807e02de20ad2605e26dd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/81163b8cd4a03ac0d37807e02de20ad2605e26dd", "html_url": "https://github.com/rust-lang/rust/commit/81163b8cd4a03ac0d37807e02de20ad2605e26dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/81163b8cd4a03ac0d37807e02de20ad2605e26dd/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "87735e5e9e52e4960068fe6cc24b81757d0620f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/87735e5e9e52e4960068fe6cc24b81757d0620f8", "html_url": "https://github.com/rust-lang/rust/commit/87735e5e9e52e4960068fe6cc24b81757d0620f8"}], "stats": {"total": 53, "additions": 35, "deletions": 18}, "files": [{"sha": "ec8349cfde7692ed8a7fc9b0538cf8658543f6f1", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/81163b8cd4a03ac0d37807e02de20ad2605e26dd/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81163b8cd4a03ac0d37807e02de20ad2605e26dd/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=81163b8cd4a03ac0d37807e02de20ad2605e26dd", "patch": "@@ -68,7 +68,7 @@ use once_cell::unsync::Lazy;\n use rustc_hash::FxHashSet;\n use stdx::{format_to, impl_from};\n use syntax::{\n-    ast::{self, HasAttrs as _, HasName},\n+    ast::{self, HasAttrs as _, HasDocComments, HasName},\n     AstNode, AstPtr, SmolStr, SyntaxKind, SyntaxNodePtr,\n };\n use tt::{Ident, Leaf, Literal, TokenTree};\n@@ -612,10 +612,13 @@ impl Module {\n                         }\n                         MacroCallKind::Attr { ast_id, invoc_attr_index, attr_name, .. } => {\n                             let node = ast_id.to_node(db.upcast());\n-                            let attr =\n-                                node.attrs().nth((*invoc_attr_index) as usize).unwrap_or_else(\n-                                    || panic!(\"cannot find attribute #{}\", invoc_attr_index),\n-                                );\n+                            let attr = node\n+                                .doc_comments_and_attrs()\n+                                .nth((*invoc_attr_index) as usize)\n+                                .and_then(Either::right)\n+                                .unwrap_or_else(|| {\n+                                    panic!(\"cannot find attribute #{}\", invoc_attr_index)\n+                                });\n                             (\n                                 ast_id.with_value(SyntaxNodePtr::from(AstPtr::new(&attr))),\n                                 Some(attr_name.clone()),"}, {"sha": "c39825b591c2af1a26a72726d363550064098672", "filename": "crates/hir_expand/src/db.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/81163b8cd4a03ac0d37807e02de20ad2605e26dd/crates%2Fhir_expand%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81163b8cd4a03ac0d37807e02de20ad2605e26dd/crates%2Fhir_expand%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fdb.rs?ref=81163b8cd4a03ac0d37807e02de20ad2605e26dd", "patch": "@@ -3,12 +3,13 @@\n use std::sync::Arc;\n \n use base_db::{salsa, SourceDatabase};\n+use either::Either;\n use limit::Limit;\n use mbe::{syntax_node_to_token_tree, ExpandError, ExpandResult};\n use rustc_hash::FxHashSet;\n use syntax::{\n     algo::diff,\n-    ast::{self, HasAttrs},\n+    ast::{self, HasAttrs, HasDocComments},\n     AstNode, GreenNode, Parse, SyntaxNode, SyntaxToken, T,\n };\n \n@@ -153,7 +154,10 @@ pub fn expand_speculative(\n             // Attributes may have an input token tree, build the subtree and map for this as well\n             // then try finding a token id for our token if it is inside this input subtree.\n             let item = ast::Item::cast(speculative_args.clone())?;\n-            let attr = item.attrs().nth(invoc_attr_index as usize)?;\n+            let attr = item\n+                .doc_comments_and_attrs()\n+                .nth(invoc_attr_index as usize)\n+                .and_then(Either::right)?;\n             match attr.token_tree() {\n                 Some(token_tree) => {\n                     let (mut tree, map) = syntax_node_to_token_tree(attr.token_tree()?.syntax());\n@@ -328,8 +332,9 @@ fn censor_for_macro_input(loc: &MacroCallLoc, node: &SyntaxNode) -> FxHashSet<Sy\n             MacroCallKind::Attr { invoc_attr_index, .. } => {\n                 cov_mark::hit!(attribute_macro_attr_censoring);\n                 ast::Item::cast(node.clone())?\n-                    .attrs()\n+                    .doc_comments_and_attrs()\n                     .nth(invoc_attr_index as usize)\n+                    .and_then(Either::right)\n                     .map(|attr| attr.syntax().clone())\n                     .into_iter()\n                     .collect()"}, {"sha": "d7dc0443b211d931cd8c4e60baf6c770f80528ba", "filename": "crates/hir_expand/src/hygiene.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/81163b8cd4a03ac0d37807e02de20ad2605e26dd/crates%2Fhir_expand%2Fsrc%2Fhygiene.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81163b8cd4a03ac0d37807e02de20ad2605e26dd/crates%2Fhir_expand%2Fsrc%2Fhygiene.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fhygiene.rs?ref=81163b8cd4a03ac0d37807e02de20ad2605e26dd", "patch": "@@ -9,7 +9,7 @@ use db::TokenExpander;\n use either::Either;\n use mbe::Origin;\n use syntax::{\n-    ast::{self, HasAttrs},\n+    ast::{self, HasDocComments},\n     AstNode, SyntaxKind, SyntaxNode, TextRange, TextSize,\n };\n \n@@ -187,7 +187,12 @@ fn make_hygiene_info(\n     });\n     let attr_input_or_mac_def = def.or_else(|| match loc.kind {\n         MacroCallKind::Attr { ast_id, invoc_attr_index, .. } => {\n-            let tt = ast_id.to_node(db).attrs().nth(invoc_attr_index as usize)?.token_tree()?;\n+            let tt = ast_id\n+                .to_node(db)\n+                .doc_comments_and_attrs()\n+                .nth(invoc_attr_index as usize)\n+                .and_then(Either::right)?\n+                .token_tree()?;\n             Some(InFile::new(ast_id.file_id, tt))\n         }\n         _ => None,"}, {"sha": "5f190b87277923fd65176c988a580afa9cc229fb", "filename": "crates/hir_expand/src/lib.rs", "status": "modified", "additions": 11, "deletions": 8, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/81163b8cd4a03ac0d37807e02de20ad2605e26dd/crates%2Fhir_expand%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81163b8cd4a03ac0d37807e02de20ad2605e26dd/crates%2Fhir_expand%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Flib.rs?ref=81163b8cd4a03ac0d37807e02de20ad2605e26dd", "patch": "@@ -25,7 +25,7 @@ use std::{hash::Hash, iter, sync::Arc};\n use base_db::{impl_intern_key, salsa, CrateId, FileId, FileRange};\n use syntax::{\n     algo::{self, skip_trivia_token},\n-    ast::{self, AstNode, HasAttrs},\n+    ast::{self, AstNode, HasDocComments},\n     Direction, SyntaxNode, SyntaxToken,\n };\n \n@@ -201,8 +201,9 @@ impl HirFileId {\n                     MacroCallKind::Attr { ast_id, invoc_attr_index, .. } => {\n                         let tt = ast_id\n                             .to_node(db)\n-                            .attrs()\n-                            .nth(invoc_attr_index as usize)?\n+                            .doc_comments_and_attrs()\n+                            .nth(invoc_attr_index as usize)\n+                            .and_then(Either::right)?\n                             .token_tree()?;\n                         Some(InFile::new(ast_id.file_id, tt))\n                     }\n@@ -429,8 +430,11 @@ impl ExpansionInfo {\n \n             let token_range = token.value.text_range();\n             match &loc.kind {\n-                MacroCallKind::Attr { attr_args, invoc_attr_index, .. } => {\n-                    let attr = item.attrs().nth(*invoc_attr_index as usize)?;\n+                MacroCallKind::Attr { attr_args: (_, map), invoc_attr_index, .. } => {\n+                    let attr = item\n+                        .doc_comments_and_attrs()\n+                        .nth(*invoc_attr_index as usize)\n+                        .and_then(Either::right)?;\n                     match attr.token_tree() {\n                         Some(token_tree)\n                             if token_tree.syntax().text_range().contains_range(token_range) =>\n@@ -440,9 +444,8 @@ impl ExpansionInfo {\n                             let relative_range =\n                                 token.value.text_range().checked_sub(attr_input_start)?;\n                             // shift by the item's tree's max id\n-                            let token_id = self\n-                                .macro_arg_shift\n-                                .shift(attr_args.1.token_by_range(relative_range)?);\n+                            let token_id =\n+                                self.macro_arg_shift.shift(map.token_by_range(relative_range)?);\n                             Some(token_id)\n                         }\n                         _ => None,"}, {"sha": "470e9a04b32dee398716fa3169d1b9a7fea1263b", "filename": "crates/syntax/src/ast/node_ext.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/81163b8cd4a03ac0d37807e02de20ad2605e26dd/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81163b8cd4a03ac0d37807e02de20ad2605e26dd/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs?ref=81163b8cd4a03ac0d37807e02de20ad2605e26dd", "patch": "@@ -772,6 +772,7 @@ impl ast::HasLoopBody for ast::ForExpr {\n }\n \n impl ast::HasAttrs for ast::AnyHasDocComments {}\n+impl ast::HasDocComments for ast::Item {}\n \n impl From<ast::Adt> for ast::Item {\n     fn from(it: ast::Adt) -> Self {"}]}