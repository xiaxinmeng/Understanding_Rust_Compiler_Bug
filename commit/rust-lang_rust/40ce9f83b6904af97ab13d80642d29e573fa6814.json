{"sha": "40ce9f83b6904af97ab13d80642d29e573fa6814", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQwY2U5ZjgzYjY5MDRhZjk3YWIxM2Q4MDY0MmQyOWU1NzNmYTY4MTQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-01-17T10:29:10Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-01-17T10:29:10Z"}, "message": "Auto merge of #6549 - ThibsG:FixClosureNeedlessReturn, r=phansch\n\nFix FP with empty return for `needless_return` lint\n\nThis fixes a false positive in `needless_return` lint, when triggered in a closure using `return` statement without value.\n\nFixes: #6501\n\nchangelog: none", "tree": {"sha": "e4f07cfee64ede321d7532163a2ce4b662ba85ef", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e4f07cfee64ede321d7532163a2ce4b662ba85ef"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/40ce9f83b6904af97ab13d80642d29e573fa6814", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/40ce9f83b6904af97ab13d80642d29e573fa6814", "html_url": "https://github.com/rust-lang/rust/commit/40ce9f83b6904af97ab13d80642d29e573fa6814", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/40ce9f83b6904af97ab13d80642d29e573fa6814/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3577cf79de342fd5e98775fe89560d918ca3793a", "url": "https://api.github.com/repos/rust-lang/rust/commits/3577cf79de342fd5e98775fe89560d918ca3793a", "html_url": "https://github.com/rust-lang/rust/commit/3577cf79de342fd5e98775fe89560d918ca3793a"}, {"sha": "46aa654c2d1792a42835d63f9a3dfcbffc20b758", "url": "https://api.github.com/repos/rust-lang/rust/commits/46aa654c2d1792a42835d63f9a3dfcbffc20b758", "html_url": "https://github.com/rust-lang/rust/commit/46aa654c2d1792a42835d63f9a3dfcbffc20b758"}], "stats": {"total": 57, "additions": 55, "deletions": 2}, "files": [{"sha": "e438f92b136ac453745d0f35cbfb85f52cf024da", "filename": "clippy_lints/src/returns.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/40ce9f83b6904af97ab13d80642d29e573fa6814/clippy_lints%2Fsrc%2Freturns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40ce9f83b6904af97ab13d80642d29e573fa6814/clippy_lints%2Fsrc%2Freturns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Freturns.rs?ref=40ce9f83b6904af97ab13d80642d29e573fa6814", "patch": "@@ -131,7 +131,16 @@ impl<'tcx> LateLintPass<'tcx> for Return {\n         _: HirId,\n     ) {\n         match kind {\n-            FnKind::Closure(_) => check_final_expr(cx, &body.value, Some(body.value.span), RetReplacement::Empty),\n+            FnKind::Closure(_) => {\n+                // when returning without value in closure, replace this `return`\n+                // with an empty block to prevent invalid suggestion (see #6501)\n+                let replacement = if let ExprKind::Ret(None) = &body.value.kind {\n+                    RetReplacement::Block\n+                } else {\n+                    RetReplacement::Empty\n+                };\n+                check_final_expr(cx, &body.value, Some(body.value.span), replacement)\n+            },\n             FnKind::ItemFn(..) | FnKind::Method(..) => {\n                 if let ExprKind::Block(ref block, _) = body.value.kind {\n                     check_block_return(cx, block);"}, {"sha": "f137e8ecae935a69765127624d3ac5a1c6ac28cd", "filename": "tests/ui/needless_return.fixed", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/40ce9f83b6904af97ab13d80642d29e573fa6814/tests%2Fui%2Fneedless_return.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/40ce9f83b6904af97ab13d80642d29e573fa6814/tests%2Fui%2Fneedless_return.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_return.fixed?ref=40ce9f83b6904af97ab13d80642d29e573fa6814", "patch": "@@ -101,6 +101,19 @@ fn test_return_in_macro() {\n     needed_return!(0);\n }\n \n+mod issue6501 {\n+    fn foo(bar: Result<(), ()>) {\n+        bar.unwrap_or_else(|_| {})\n+    }\n+\n+    fn test_closure() {\n+        let _ = || {\n+            \n+        };\n+        let _ = || {};\n+    }\n+}\n+\n fn main() {\n     let _ = test_end_of_fn();\n     let _ = test_no_semicolon();"}, {"sha": "d754e4d37a844fcbf6fdfafaaad5ac8632e23a21", "filename": "tests/ui/needless_return.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/40ce9f83b6904af97ab13d80642d29e573fa6814/tests%2Fui%2Fneedless_return.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40ce9f83b6904af97ab13d80642d29e573fa6814/tests%2Fui%2Fneedless_return.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_return.rs?ref=40ce9f83b6904af97ab13d80642d29e573fa6814", "patch": "@@ -101,6 +101,19 @@ fn test_return_in_macro() {\n     needed_return!(0);\n }\n \n+mod issue6501 {\n+    fn foo(bar: Result<(), ()>) {\n+        bar.unwrap_or_else(|_| return)\n+    }\n+\n+    fn test_closure() {\n+        let _ = || {\n+            return;\n+        };\n+        let _ = || return;\n+    }\n+}\n+\n fn main() {\n     let _ = test_end_of_fn();\n     let _ = test_no_semicolon();"}, {"sha": "d1240e161c07e7de80a2bac1432c4a6fdafe8bab", "filename": "tests/ui/needless_return.stderr", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/40ce9f83b6904af97ab13d80642d29e573fa6814/tests%2Fui%2Fneedless_return.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/40ce9f83b6904af97ab13d80642d29e573fa6814/tests%2Fui%2Fneedless_return.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_return.stderr?ref=40ce9f83b6904af97ab13d80642d29e573fa6814", "patch": "@@ -84,5 +84,23 @@ error: unneeded `return` statement\n LL |         return String::new();\n    |         ^^^^^^^^^^^^^^^^^^^^^ help: remove `return`: `String::new()`\n \n-error: aborting due to 14 previous errors\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:106:32\n+   |\n+LL |         bar.unwrap_or_else(|_| return)\n+   |                                ^^^^^^ help: replace `return` with an empty block: `{}`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:111:13\n+   |\n+LL |             return;\n+   |             ^^^^^^^ help: remove `return`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:113:20\n+   |\n+LL |         let _ = || return;\n+   |                    ^^^^^^ help: replace `return` with an empty block: `{}`\n+\n+error: aborting due to 17 previous errors\n "}]}