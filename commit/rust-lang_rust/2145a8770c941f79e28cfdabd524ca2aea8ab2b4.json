{"sha": "2145a8770c941f79e28cfdabd524ca2aea8ab2b4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIxNDVhODc3MGM5NDFmNzllMjhjZmRhYmQ1MjRjYTJhZWE4YWIyYjQ=", "commit": {"author": {"name": "\u00d6mer Sinan A\u011facan", "email": "omeragacan@gmail.com", "date": "2021-02-21T08:15:37Z"}, "committer": {"name": "\u00d6mer Sinan A\u011facan", "email": "omeragacan@gmail.com", "date": "2021-02-22T14:36:30Z"}, "message": "Fix mir-cfg dumps\n\nFixes #81918\nFixes #82326 (duplicate)\nFixes #82325", "tree": {"sha": "464f1ef871af69349f4b32a06e3f1722c8747812", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/464f1ef871af69349f4b32a06e3f1722c8747812"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2145a8770c941f79e28cfdabd524ca2aea8ab2b4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2145a8770c941f79e28cfdabd524ca2aea8ab2b4", "html_url": "https://github.com/rust-lang/rust/commit/2145a8770c941f79e28cfdabd524ca2aea8ab2b4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2145a8770c941f79e28cfdabd524ca2aea8ab2b4/comments", "author": {"login": "osa1", "id": 448274, "node_id": "MDQ6VXNlcjQ0ODI3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/448274?v=4", "gravatar_id": "", "url": "https://api.github.com/users/osa1", "html_url": "https://github.com/osa1", "followers_url": "https://api.github.com/users/osa1/followers", "following_url": "https://api.github.com/users/osa1/following{/other_user}", "gists_url": "https://api.github.com/users/osa1/gists{/gist_id}", "starred_url": "https://api.github.com/users/osa1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/osa1/subscriptions", "organizations_url": "https://api.github.com/users/osa1/orgs", "repos_url": "https://api.github.com/users/osa1/repos", "events_url": "https://api.github.com/users/osa1/events{/privacy}", "received_events_url": "https://api.github.com/users/osa1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "osa1", "id": 448274, "node_id": "MDQ6VXNlcjQ0ODI3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/448274?v=4", "gravatar_id": "", "url": "https://api.github.com/users/osa1", "html_url": "https://github.com/osa1", "followers_url": "https://api.github.com/users/osa1/followers", "following_url": "https://api.github.com/users/osa1/following{/other_user}", "gists_url": "https://api.github.com/users/osa1/gists{/gist_id}", "starred_url": "https://api.github.com/users/osa1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/osa1/subscriptions", "organizations_url": "https://api.github.com/users/osa1/orgs", "repos_url": "https://api.github.com/users/osa1/repos", "events_url": "https://api.github.com/users/osa1/events{/privacy}", "received_events_url": "https://api.github.com/users/osa1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a9f7862bcfa5870a34bb54f77a03c73d1db5c37", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a9f7862bcfa5870a34bb54f77a03c73d1db5c37", "html_url": "https://github.com/rust-lang/rust/commit/8a9f7862bcfa5870a34bb54f77a03c73d1db5c37"}], "stats": {"total": 34, "additions": 29, "deletions": 5}, "files": [{"sha": "92c7a358c0a41d59b9552a99ede510c04f0f0f84", "filename": "compiler/rustc_mir/src/util/graphviz.rs", "status": "modified", "additions": 18, "deletions": 5, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/2145a8770c941f79e28cfdabd524ca2aea8ab2b4/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgraphviz.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2145a8770c941f79e28cfdabd524ca2aea8ab2b4/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgraphviz.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgraphviz.rs?ref=2145a8770c941f79e28cfdabd524ca2aea8ab2b4", "patch": "@@ -2,7 +2,7 @@ use gsgdt::GraphvizSettings;\n use rustc_graphviz as dot;\n use rustc_hir::def_id::DefId;\n use rustc_middle::mir::*;\n-use rustc_middle::ty::TyCtxt;\n+use rustc_middle::ty::{self, TyCtxt};\n use std::fmt::Debug;\n use std::io::{self, Write};\n \n@@ -16,14 +16,27 @@ where\n {\n     let def_ids = dump_mir_def_ids(tcx, single);\n \n-    let use_subgraphs = def_ids.len() > 1;\n+    let mirs =\n+        def_ids\n+            .iter()\n+            .flat_map(|def_id| {\n+                if tcx.is_const_fn_raw(*def_id) {\n+                    vec![tcx.optimized_mir(*def_id), tcx.mir_for_ctfe(*def_id)]\n+                } else {\n+                    vec![tcx.instance_mir(ty::InstanceDef::Item(ty::WithOptConstParam::unknown(\n+                        *def_id,\n+                    )))]\n+                }\n+            })\n+            .collect::<Vec<_>>();\n+\n+    let use_subgraphs = mirs.len() > 1;\n     if use_subgraphs {\n         writeln!(w, \"digraph __crate__ {{\")?;\n     }\n \n-    for def_id in def_ids {\n-        let body = &tcx.optimized_mir(def_id);\n-        write_mir_fn_graphviz(tcx, body, use_subgraphs, w)?;\n+    for mir in mirs {\n+        write_mir_fn_graphviz(tcx, mir, use_subgraphs, w)?;\n     }\n \n     if use_subgraphs {"}, {"sha": "8938b8a6f2c52856bca6e94da4ca7d1f77fec7a3", "filename": "src/test/ui/issues/issue-81918.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/2145a8770c941f79e28cfdabd524ca2aea8ab2b4/src%2Ftest%2Fui%2Fissues%2Fissue-81918.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2145a8770c941f79e28cfdabd524ca2aea8ab2b4/src%2Ftest%2Fui%2Fissues%2Fissue-81918.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-81918.rs?ref=2145a8770c941f79e28cfdabd524ca2aea8ab2b4", "patch": "@@ -0,0 +1,11 @@\n+// check-pass\n+// dont-check-compiler-stdout\n+// compile-flags: -Z unpretty=mir-cfg\n+\n+// This checks that unpretty=mir-cfg does not panic. See #81918.\n+\n+const TAG: &'static str = \"ABCD\";\n+\n+fn main() {\n+    if TAG == \"\" {}\n+}"}]}