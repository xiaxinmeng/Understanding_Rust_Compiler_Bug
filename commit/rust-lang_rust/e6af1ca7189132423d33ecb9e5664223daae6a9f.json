{"sha": "e6af1ca7189132423d33ecb9e5664223daae6a9f", "node_id": "C_kwDOAAsO6NoAKGU2YWYxY2E3MTg5MTMyNDIzZDMzZWNiOWU1NjY0MjIzZGFhZTZhOWY", "commit": {"author": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-12-13T16:13:08Z"}, "committer": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-12-13T16:15:22Z"}, "message": "Add support for v6 macro metadata format", "tree": {"sha": "be20e5595f01671e59848839a43608d17e3e89e1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/be20e5595f01671e59848839a43608d17e3e89e1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e6af1ca7189132423d33ecb9e5664223daae6a9f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e6af1ca7189132423d33ecb9e5664223daae6a9f", "html_url": "https://github.com/rust-lang/rust/commit/e6af1ca7189132423d33ecb9e5664223daae6a9f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e6af1ca7189132423d33ecb9e5664223daae6a9f/comments", "author": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "db2a7087b994e20f264f26ad6db75184282ad120", "url": "https://api.github.com/repos/rust-lang/rust/commits/db2a7087b994e20f264f26ad6db75184282ad120", "html_url": "https://github.com/rust-lang/rust/commit/db2a7087b994e20f264f26ad6db75184282ad120"}], "stats": {"total": 24, "additions": 17, "deletions": 7}, "files": [{"sha": "f29970d477cd5dab30089554bb6c4583da3a4d94", "filename": "crates/proc_macro_api/src/version.rs", "status": "modified", "additions": 17, "deletions": 7, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/e6af1ca7189132423d33ecb9e5664223daae6a9f/crates%2Fproc_macro_api%2Fsrc%2Fversion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6af1ca7189132423d33ecb9e5664223daae6a9f/crates%2Fproc_macro_api%2Fsrc%2Fversion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_api%2Fsrc%2Fversion.rs?ref=e6af1ca7189132423d33ecb9e5664223daae6a9f", "patch": "@@ -99,7 +99,7 @@ fn read_section<'a>(dylib_binary: &'a [u8], section_name: &str) -> io::Result<&'\n /// * [length byte] next 1 byte tells us how many bytes we should read next\n ///   for the version string's utf8 bytes\n /// * [version string bytes encoded in utf8] <- GET THIS BOI\n-/// * [some more bytes that we don really care but still there] :-)\n+/// * [some more bytes that we don't really care but about still there] :-)\n /// Check this issue for more about the bytes layout:\n /// <https://github.com/rust-analyzer/rust-analyzer/issues/6174>\n fn read_version(dylib_path: &AbsPath) -> io::Result<String> {\n@@ -108,15 +108,25 @@ fn read_version(dylib_path: &AbsPath) -> io::Result<String> {\n \n     let dot_rustc = read_section(&dylib_mmaped, \".rustc\")?;\n \n-    let header = &dot_rustc[..8];\n-    const EXPECTED_HEADER: [u8; 8] = [b'r', b'u', b's', b't', 0, 0, 0, 5];\n-    // check if header is valid\n-    if header != EXPECTED_HEADER {\n+    // check if magic is valid\n+    if &dot_rustc[0..4] != b\"rust\" {\n         return Err(io::Error::new(\n             io::ErrorKind::InvalidData,\n-            format!(\"only metadata version 5 is supported, section header was: {:?}\", header),\n+            format!(\"unknown metadata magic, expected `rust`, found `{:?}`\", &dot_rustc[0..4]),\n         ));\n     }\n+    let version = u32::from_be_bytes([dot_rustc[4], dot_rustc[5], dot_rustc[6], dot_rustc[7]]);\n+    // Last supported version is:\n+    // https://github.com/rust-lang/rust/commit/0696e79f2740ad89309269b460579e548a5cd632\n+    match version {\n+        5 | 6 => {}\n+        _ => {\n+            return Err(io::Error::new(\n+                io::ErrorKind::InvalidData,\n+                format!(\"unsupported metadata version {}\", version),\n+            ));\n+        }\n+    }\n \n     let snappy_portion = &dot_rustc[8..];\n \n@@ -130,7 +140,7 @@ fn read_version(dylib_path: &AbsPath) -> io::Result<String> {\n     // to know the length\n     let mut bytes_before_version = [0u8; 13];\n     snappy_decoder.read_exact(&mut bytes_before_version)?;\n-    let length = bytes_before_version[12]; // what? can't use -1 indexing?\n+    let length = bytes_before_version[12];\n \n     let mut version_string_utf8 = vec![0u8; length as usize];\n     snappy_decoder.read_exact(&mut version_string_utf8)?;"}]}