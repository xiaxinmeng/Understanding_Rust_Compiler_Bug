{"sha": "f8015061c88ba35f7af09ff68a054ffe6c87990c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY4MDE1MDYxYzg4YmEzNWY3YWYwOWZmNjhhMDU0ZmZlNmM4Nzk5MGM=", "commit": {"author": {"name": "Ian Jackson", "email": "ijackson@chiark.greenend.org.uk", "date": "2021-02-07T11:42:44Z"}, "committer": {"name": "Ian Jackson", "email": "ijackson@chiark.greenend.org.uk", "date": "2021-05-07T10:17:44Z"}, "message": "panic tests: Command: Test that we do not unwind past fork\n\nThis is safe (does not involve heap allocation) but we don't yet have\na test to ensure that stays true.  That will come in a moment.\n\nSigned-off-by: Ian Jackson <ijackson@chiark.greenend.org.uk>\nCo-authored-by: Mara Bos <m-ou.se@m-ou.se>", "tree": {"sha": "f00feeafe46c8d97ecd8d8b81c4b9f2dbd98f929", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f00feeafe46c8d97ecd8d8b81c4b9f2dbd98f929"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f8015061c88ba35f7af09ff68a054ffe6c87990c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f8015061c88ba35f7af09ff68a054ffe6c87990c", "html_url": "https://github.com/rust-lang/rust/commit/f8015061c88ba35f7af09ff68a054ffe6c87990c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f8015061c88ba35f7af09ff68a054ffe6c87990c/comments", "author": {"login": "ijackson", "id": 2090772, "node_id": "MDQ6VXNlcjIwOTA3NzI=", "avatar_url": "https://avatars.githubusercontent.com/u/2090772?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ijackson", "html_url": "https://github.com/ijackson", "followers_url": "https://api.github.com/users/ijackson/followers", "following_url": "https://api.github.com/users/ijackson/following{/other_user}", "gists_url": "https://api.github.com/users/ijackson/gists{/gist_id}", "starred_url": "https://api.github.com/users/ijackson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ijackson/subscriptions", "organizations_url": "https://api.github.com/users/ijackson/orgs", "repos_url": "https://api.github.com/users/ijackson/repos", "events_url": "https://api.github.com/users/ijackson/events{/privacy}", "received_events_url": "https://api.github.com/users/ijackson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ijackson", "id": 2090772, "node_id": "MDQ6VXNlcjIwOTA3NzI=", "avatar_url": "https://avatars.githubusercontent.com/u/2090772?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ijackson", "html_url": "https://github.com/ijackson", "followers_url": "https://api.github.com/users/ijackson/followers", "following_url": "https://api.github.com/users/ijackson/following{/other_user}", "gists_url": "https://api.github.com/users/ijackson/gists{/gist_id}", "starred_url": "https://api.github.com/users/ijackson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ijackson/subscriptions", "organizations_url": "https://api.github.com/users/ijackson/orgs", "repos_url": "https://api.github.com/users/ijackson/repos", "events_url": "https://api.github.com/users/ijackson/events{/privacy}", "received_events_url": "https://api.github.com/users/ijackson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9283cdca362065a215e7f8b460719947493ddc54", "url": "https://api.github.com/repos/rust-lang/rust/commits/9283cdca362065a215e7f8b460719947493ddc54", "html_url": "https://github.com/rust-lang/rust/commit/9283cdca362065a215e7f8b460719947493ddc54"}], "stats": {"total": 23, "additions": 23, "deletions": 0}, "files": [{"sha": "61b2e4a145f80b669b5c85daccd26fb013185809", "filename": "library/std/src/sys/unix/process/process_unix/tests.rs", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/f8015061c88ba35f7af09ff68a054ffe6c87990c/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_unix%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8015061c88ba35f7af09ff68a054ffe6c87990c/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_unix%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_unix%2Ftests.rs?ref=f8015061c88ba35f7af09ff68a054ffe6c87990c", "patch": "@@ -1,3 +1,7 @@\n+use crate::os::unix::process::{CommandExt, ExitStatusExt};\n+use crate::panic::catch_unwind;\n+use crate::process::Command;\n+\n #[test]\n fn exitstatus_display_tests() {\n     // In practice this is the same on every Unix.\n@@ -28,3 +32,22 @@ fn exitstatus_display_tests() {\n         t(0x000ff, \"unrecognised wait status: 255 0xff\");\n     }\n }\n+\n+#[test]\n+fn test_command_fork_no_unwind() {\n+    let got = catch_unwind(|| {\n+        let mut c = Command::new(\"echo\");\n+        c.arg(\"hi\");\n+        unsafe {\n+            c.pre_exec(|| panic!(\"{}\", \"crash now!\"));\n+        }\n+        let st = c.status().expect(\"failed to get command status\");\n+        dbg!(st);\n+        st\n+    });\n+    dbg!(&got);\n+    let status = got.expect(\"panic unexpectedly propagated\");\n+    dbg!(status);\n+    let signal = status.signal().expect(\"expected child process to die of signal\");\n+    assert!(signal == libc::SIGABRT || signal == libc::SIGILL);\n+}"}]}