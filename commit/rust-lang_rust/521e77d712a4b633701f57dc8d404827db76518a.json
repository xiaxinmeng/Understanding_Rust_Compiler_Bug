{"sha": "521e77d712a4b633701f57dc8d404827db76518a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUyMWU3N2Q3MTJhNGI2MzM3MDFmNTdkYzhkNDA0ODI3ZGI3NjUxOGE=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-04-17T18:43:54Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-04-17T18:43:54Z"}, "message": "test that we properly check dynamic alignment", "tree": {"sha": "9ac6c94d7992f1376b5c1676351d32b1316f3b1e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9ac6c94d7992f1376b5c1676351d32b1316f3b1e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/521e77d712a4b633701f57dc8d404827db76518a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/521e77d712a4b633701f57dc8d404827db76518a", "html_url": "https://github.com/rust-lang/rust/commit/521e77d712a4b633701f57dc8d404827db76518a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/521e77d712a4b633701f57dc8d404827db76518a/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "216e686cc6f441a35f2bb3b12257b65381d6c663", "url": "https://api.github.com/repos/rust-lang/rust/commits/216e686cc6f441a35f2bb3b12257b65381d6c663", "html_url": "https://github.com/rust-lang/rust/commit/216e686cc6f441a35f2bb3b12257b65381d6c663"}], "stats": {"total": 19, "additions": 19, "deletions": 0}, "files": [{"sha": "a8cf54edc85fe4b47a8ddb5dba83da597f0fab1d", "filename": "tests/compile-fail/unaligned_pointers/dyn_alignment.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/521e77d712a4b633701f57dc8d404827db76518a/tests%2Fcompile-fail%2Funaligned_pointers%2Fdyn_alignment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/521e77d712a4b633701f57dc8d404827db76518a/tests%2Fcompile-fail%2Funaligned_pointers%2Fdyn_alignment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Funaligned_pointers%2Fdyn_alignment.rs?ref=521e77d712a4b633701f57dc8d404827db76518a", "patch": "@@ -0,0 +1,19 @@\n+// should find the bug even without these\n+// compile-flags: -Zmiri-disable-validation -Zmiri-disable-stacked-borrows\n+\n+#[repr(align(256))]\n+#[derive(Debug)]\n+struct MuchAlign;\n+\n+fn main() {\n+    let buf = [0u32; 256];\n+    // `buf` is sufficiently aligned for `layout.align` on a `dyn Debug`, but not\n+    // for the actual alignment required by `MuchAlign`.\n+    // We craft a wide reference `&dyn Debug` with the vtable for `MuchAlign`. That should be UB,\n+    // as the reference is not aligned to its dynamic alignment requirements.\n+    let mut ptr = &MuchAlign as &dyn std::fmt::Debug;\n+    // Overwrite the data part of `ptr`.\n+    unsafe { (&mut ptr as *mut _ as *mut *const u8).write(&buf as *const _ as *const u8); }\n+    // Re-borrow that. This should be UB.\n+    let _ptr = &*ptr; //~ ERROR accessing memory with alignment 4, but alignment 256 is required\n+}"}]}