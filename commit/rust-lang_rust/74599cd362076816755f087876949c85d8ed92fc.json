{"sha": "74599cd362076816755f087876949c85d8ed92fc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc0NTk5Y2QzNjIwNzY4MTY3NTVmMDg3ODc2OTQ5Yzg1ZDhlZDkyZmM=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-06-15T15:50:27Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-06-15T15:50:27Z"}, "message": "Always capture tokens for `macro_rules!` arguments", "tree": {"sha": "e539ae50e755d4ab976af1dadbe20dd7dc77bab4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e539ae50e755d4ab976af1dadbe20dd7dc77bab4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/74599cd362076816755f087876949c85d8ed92fc", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl7nmNIACgkQtAh+UQ6Y\nsWT5ChAAqEK4XlgvJOWWspT1QrjfGC1WW4BnfPN6kJIB0iCQbtwPoRpAHy0eJ0Zf\n8s2otmYYImlkT09LlLHfW0NutufKa+jQ9mvR/ZaD6ByaftdGID+i04VlC2pnwEW3\niJw8L1FWhiaiyZOH9jLp890w1XGcZDK71fnddoMM2IZpPWjXpkTPa9IGy2Gne0w7\ntcBVS7NOL6tCYv846U1ewnVHHWz6W9lzwMiYWy93VJFUpyv3qmKLOM+SIjmy+NS2\nBKKfKuMrluuf947QZD3zc9EkZ/aSQWY0HA6PPQq/MztbvLz1Rs5PfYb6DiHwDoyR\nREuTBf3HTtcU505fDyCRha2CS3q3uDl1BHrGO3kKjxJ17DsMyyXELiLaV1gyg7s+\npbSYVxfYtEa02O0PDUJ/fHKlTBY1aYiQOWcF5hd9+ujxNxStdohkQIquIhczbLg7\nnNuH1NwLemQckwvliflZ3JSXZnudC3PdlF1BtUINSeiSoXNZVIT0sHVOwWMOADBC\nLTBJ2izP2x3lYeS9QbMrx5q+i9eRi27oyorSv2a3BusR2TdL2XCq+NSYGMrnQ+BV\nKrmMc+yrCMTzMhzBcnYFPJ+X2T8Zl4ettPMHqCGG5fBEKqklrgFxE2/SsMVJotCY\nQnxDvkrono5P5twRTXlowrdV4ZkAd2q4pjuFB3Epu935B92olts=\n=7lJG\n-----END PGP SIGNATURE-----", "payload": "tree e539ae50e755d4ab976af1dadbe20dd7dc77bab4\nparent d4ecf31efc2309fb6df8c2a8af9aaf8176ab1c8d\nauthor Aaron Hill <aa1ronham@gmail.com> 1592236227 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1592236227 -0400\n\nAlways capture tokens for `macro_rules!` arguments\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/74599cd362076816755f087876949c85d8ed92fc", "html_url": "https://github.com/rust-lang/rust/commit/74599cd362076816755f087876949c85d8ed92fc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/74599cd362076816755f087876949c85d8ed92fc/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d4ecf31efc2309fb6df8c2a8af9aaf8176ab1c8d", "url": "https://api.github.com/repos/rust-lang/rust/commits/d4ecf31efc2309fb6df8c2a8af9aaf8176ab1c8d", "html_url": "https://github.com/rust-lang/rust/commit/d4ecf31efc2309fb6df8c2a8af9aaf8176ab1c8d"}], "stats": {"total": 210, "additions": 205, "deletions": 5}, "files": [{"sha": "968f7c8e273a36ae6a557085f42c2476e5662bbe", "filename": "src/librustc_expand/mbe/macro_parser.rs", "status": "modified", "additions": 25, "deletions": 4, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/74599cd362076816755f087876949c85d8ed92fc/src%2Flibrustc_expand%2Fmbe%2Fmacro_parser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74599cd362076816755f087876949c85d8ed92fc/src%2Flibrustc_expand%2Fmbe%2Fmacro_parser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_expand%2Fmbe%2Fmacro_parser.rs?ref=74599cd362076816755f087876949c85d8ed92fc", "patch": "@@ -866,18 +866,39 @@ fn parse_nt(p: &mut Parser<'_>, sp: Span, name: Symbol) -> Result<Nonterminal, (\n }\n \n fn parse_nt_inner<'a>(p: &mut Parser<'a>, sp: Span, name: Symbol) -> PResult<'a, Nonterminal> {\n+    // Any `Nonterminal` which stores its tokens (currently `NtItem` and `NtExpr`)\n+    // needs to have them force-captured here.\n+    // A `macro_rules!` invocation may pass a captured item/expr to a proc-macro,\n+    // which requires having captured tokens available. Since we cannot determine\n+    // in advance whether or not a proc-macro will be (transitively) invoked,\n+    // we always capture tokens for any `Nonterminal` which needs them.\n     Ok(match name {\n-        sym::item => match p.parse_item()? {\n-            Some(i) => token::NtItem(i),\n-            None => return Err(p.struct_span_err(p.token.span, \"expected an item keyword\")),\n+        sym::item => match p.collect_tokens(|this| this.parse_item())? {\n+            (Some(mut item), tokens) => {\n+                // If we captured tokens during parsing (due to outer attributes),\n+                // use those.\n+                if item.tokens.is_none() {\n+                    item.tokens = Some(tokens);\n+                }\n+                token::NtItem(item)\n+            }\n+            (None, _) => return Err(p.struct_span_err(p.token.span, \"expected an item keyword\")),\n         },\n         sym::block => token::NtBlock(p.parse_block()?),\n         sym::stmt => match p.parse_stmt()? {\n             Some(s) => token::NtStmt(s),\n             None => return Err(p.struct_span_err(p.token.span, \"expected a statement\")),\n         },\n         sym::pat => token::NtPat(p.parse_pat(None)?),\n-        sym::expr => token::NtExpr(p.parse_expr()?),\n+        sym::expr => {\n+            let (mut expr, tokens) = p.collect_tokens(|this| this.parse_expr())?;\n+            // If we captured tokens during parsing (due to outer attributes),\n+            // use those.\n+            if expr.tokens.is_none() {\n+                expr.tokens = Some(tokens);\n+            }\n+            token::NtExpr(expr)\n+        }\n         sym::literal => token::NtLiteral(p.parse_literal_maybe_minus()?),\n         sym::ty => token::NtTy(p.parse_ty()?),\n         // this could be handled like a token, since it is one"}, {"sha": "7811d5fb741b27d946b6ce57c6856d8d2b4977d5", "filename": "src/librustc_parse/parser/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/74599cd362076816755f087876949c85d8ed92fc/src%2Flibrustc_parse%2Fparser%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74599cd362076816755f087876949c85d8ed92fc/src%2Flibrustc_parse%2Fparser%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_parse%2Fparser%2Fmod.rs?ref=74599cd362076816755f087876949c85d8ed92fc", "patch": "@@ -1151,7 +1151,7 @@ impl<'a> Parser<'a> {\n     /// This restriction shouldn't be an issue in practice,\n     /// since this function is used to record the tokens for\n     /// a parsed AST item, which always has matching delimiters.\n-    fn collect_tokens<R>(\n+    pub fn collect_tokens<R>(\n         &mut self,\n         f: impl FnOnce(&mut Self) -> PResult<'a, R>,\n     ) -> PResult<'a, (R, TokenStream)> {"}, {"sha": "6331608fbe54353ff8f425c4ef6b54a003f5a455", "filename": "src/test/ui/proc-macro/auxiliary/first-second.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Ffirst-second.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Ffirst-second.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Ffirst-second.rs?ref=74599cd362076816755f087876949c85d8ed92fc", "patch": "@@ -0,0 +1,20 @@\n+// force-host\n+// no-prefer-dynamic\n+\n+#![crate_type = \"proc-macro\"]\n+\n+extern crate proc_macro;\n+\n+use proc_macro::{TokenStream, TokenTree, Group, Delimiter};\n+\n+#[proc_macro_attribute]\n+pub fn first(_attr: TokenStream, item: TokenStream) -> TokenStream {\n+    let tokens: TokenStream = \"#[derive(Second)]\".parse().unwrap();\n+    let wrapped = TokenTree::Group(Group::new(Delimiter::None, item.into_iter().collect()));\n+    tokens.into_iter().chain(std::iter::once(wrapped)).collect()\n+}\n+\n+#[proc_macro_derive(Second)]\n+pub fn second(item: TokenStream) -> TokenStream {\n+    TokenStream::new()\n+}"}, {"sha": "d4494a5aff2e9216ef9ffb29b270f48705fbac6a", "filename": "src/test/ui/proc-macro/auxiliary/recollect.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Frecollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Frecollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Frecollect.rs?ref=74599cd362076816755f087876949c85d8ed92fc", "patch": "@@ -0,0 +1,12 @@\n+// force-host\n+// no-prefer-dynamic\n+\n+#![crate_type = \"proc-macro\"]\n+\n+extern crate proc_macro;\n+use proc_macro::TokenStream;\n+\n+#[proc_macro]\n+pub fn recollect(tokens: TokenStream) -> TokenStream {\n+    tokens.into_iter().collect()\n+}"}, {"sha": "338e436df500fa223cd0e75db6aa3a6af7befb97", "filename": "src/test/ui/proc-macro/auxiliary/weird-hygiene.rs", "status": "added", "additions": 48, "deletions": 0, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Fweird-hygiene.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Fweird-hygiene.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Fweird-hygiene.rs?ref=74599cd362076816755f087876949c85d8ed92fc", "patch": "@@ -0,0 +1,48 @@\n+// force-host\n+// no-prefer-dynamic\n+\n+#![crate_type = \"proc-macro\"]\n+\n+extern crate proc_macro;\n+\n+use proc_macro::{TokenStream, TokenTree, Group};\n+\n+fn find_my_ident(tokens: TokenStream) -> Option<TokenStream> {\n+    for token in tokens {\n+        if let TokenTree::Ident(ident) = &token {\n+            if ident.to_string() == \"hidden_ident\" {\n+                return Some(vec![token].into_iter().collect())\n+            }\n+        } else if let TokenTree::Group(g) = token {\n+            if let Some(stream) = find_my_ident(g.stream()) {\n+                return Some(stream)\n+            }\n+        }\n+    }\n+    return None;\n+}\n+\n+\n+#[proc_macro_derive(WeirdDerive)]\n+pub fn weird_derive(item: TokenStream) -> TokenStream {\n+    let my_ident = find_my_ident(item).expect(\"Missing 'my_ident'!\");\n+    let tokens: TokenStream = \"call_it!();\".parse().unwrap();\n+    let final_call = tokens.into_iter().map(|tree| {\n+        if let TokenTree::Group(g) = tree {\n+            return Group::new(g.delimiter(), my_ident.clone()).into()\n+        } else {\n+            return tree\n+        }\n+    }).collect();\n+    final_call\n+}\n+\n+#[proc_macro]\n+pub fn recollect(item: TokenStream) -> TokenStream {\n+    item.into_iter().collect()\n+}\n+\n+#[proc_macro_attribute]\n+pub fn recollect_attr(_attr: TokenStream, mut item: TokenStream) -> TokenStream {\n+    item.into_iter().collect()\n+}"}, {"sha": "a404ddace9bbe8b6ab5c9fcb067718aea93a6096", "filename": "src/test/ui/proc-macro/capture-macro-rules-invoke.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fcapture-macro-rules-invoke.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fcapture-macro-rules-invoke.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fcapture-macro-rules-invoke.rs?ref=74599cd362076816755f087876949c85d8ed92fc", "patch": "@@ -0,0 +1,22 @@\n+// aux-build:test-macros.rs\n+// check-pass\n+\n+extern crate test_macros;\n+use test_macros::recollect;\n+\n+macro_rules! use_expr {\n+    ($expr:expr) => {\n+        recollect!($expr)\n+    }\n+}\n+\n+#[allow(dead_code)]\n+struct Foo;\n+impl Foo {\n+    #[allow(dead_code)]\n+    fn use_self(self) {\n+        drop(use_expr!(self));\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "5b4d577a1acc42a8919f6ae802169044b46e1fe6", "filename": "src/test/ui/proc-macro/macro-rules-derive.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fmacro-rules-derive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fmacro-rules-derive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fmacro-rules-derive.rs?ref=74599cd362076816755f087876949c85d8ed92fc", "patch": "@@ -0,0 +1,20 @@\n+// aux-build:first-second.rs\n+// FIXME: The spans here are bad, see PR #73084\n+\n+extern crate first_second;\n+use first_second::*;\n+\n+macro_rules! produce_it {\n+    ($name:ident) => {\n+        #[first] //~ ERROR cannot find type\n+        struct $name {\n+            field: MissingType\n+        }\n+    }\n+}\n+\n+produce_it!(MyName);\n+\n+fn main() {\n+    println!(\"Hello, world!\");\n+}"}, {"sha": "4b72d29fe8ae068ee0796a62ab3263dcd5dcb1ed", "filename": "src/test/ui/proc-macro/macro-rules-derive.stderr", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fmacro-rules-derive.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fmacro-rules-derive.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fmacro-rules-derive.stderr?ref=74599cd362076816755f087876949c85d8ed92fc", "patch": "@@ -0,0 +1,9 @@\n+error[E0412]: cannot find type `MissingType` in this scope\n+  --> $DIR/macro-rules-derive.rs:9:9\n+   |\n+LL |         #[first]\n+   |         ^^^^^^^^ not found in this scope\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0412`."}, {"sha": "3f48191b5b26e42c69f67b830a9f78c5461c0979", "filename": "src/test/ui/proc-macro/weird-hygiene.rs", "status": "added", "additions": 48, "deletions": 0, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fweird-hygiene.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74599cd362076816755f087876949c85d8ed92fc/src%2Ftest%2Fui%2Fproc-macro%2Fweird-hygiene.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fweird-hygiene.rs?ref=74599cd362076816755f087876949c85d8ed92fc", "patch": "@@ -0,0 +1,48 @@\n+// aux-build:weird-hygiene.rs\n+// check-pass\n+// FIXME: This should actually error, see PR #73084\n+\n+#![feature(stmt_expr_attributes)]\n+#![feature(proc_macro_hygiene)]\n+\n+extern crate weird_hygiene;\n+use weird_hygiene::*;\n+\n+macro_rules! other {\n+    ($tokens:expr) => {\n+        macro_rules! call_it {\n+            ($outer_ident:ident) => {\n+                macro_rules! inner {\n+                    () => {\n+                        $outer_ident;\n+                    }\n+                }\n+            }\n+        }\n+\n+        #[derive(WeirdDerive)]\n+        enum MyEnum {\n+            Value = (stringify!($tokens + hidden_ident), 1).1\n+        }\n+\n+        inner!();\n+    }\n+}\n+\n+macro_rules! invoke_it {\n+    ($token:expr) => {\n+        #[recollect_attr] {\n+            $token;\n+            hidden_ident\n+        }\n+    }\n+}\n+\n+fn main() {\n+    // `other` and `invoke_it` are both macro_rules! macros,\n+    // so it should be impossible for them to ever see `hidden_ident`,\n+    // even if they invoke a proc macro.\n+    let hidden_ident = \"Hello1\";\n+    other!(50);\n+    invoke_it!(25);\n+}"}]}