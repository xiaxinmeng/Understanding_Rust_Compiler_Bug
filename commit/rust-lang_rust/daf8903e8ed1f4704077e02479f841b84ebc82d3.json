{"sha": "daf8903e8ed1f4704077e02479f841b84ebc82d3", "node_id": "C_kwDOAAsO6NoAKGRhZjg5MDNlOGVkMWY0NzA0MDc3ZTAyNDc5Zjg0MWI4NGViYzgyZDM", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-10-02T19:14:52Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-10-06T17:10:07Z"}, "message": "Do not re-hash foreign spans.", "tree": {"sha": "6384a71ac1887533d317b460e28f087609afe049", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6384a71ac1887533d317b460e28f087609afe049"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/daf8903e8ed1f4704077e02479f841b84ebc82d3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/daf8903e8ed1f4704077e02479f841b84ebc82d3", "html_url": "https://github.com/rust-lang/rust/commit/daf8903e8ed1f4704077e02479f841b84ebc82d3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/daf8903e8ed1f4704077e02479f841b84ebc82d3/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ce21756ed3acdd6bb4c222725214c24e1bc70915", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce21756ed3acdd6bb4c222725214c24e1bc70915", "html_url": "https://github.com/rust-lang/rust/commit/ce21756ed3acdd6bb4c222725214c24e1bc70915"}], "stats": {"total": 38, "additions": 27, "deletions": 11}, "files": [{"sha": "48eb488792d8973b05fe582fa329c0c4679e854a", "filename": "compiler/rustc_query_impl/src/on_disk_cache.rs", "status": "modified", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/daf8903e8ed1f4704077e02479f841b84ebc82d3/compiler%2Frustc_query_impl%2Fsrc%2Fon_disk_cache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/daf8903e8ed1f4704077e02479f841b84ebc82d3/compiler%2Frustc_query_impl%2Fsrc%2Fon_disk_cache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_impl%2Fsrc%2Fon_disk_cache.rs?ref=daf8903e8ed1f4704077e02479f841b84ebc82d3", "patch": "@@ -664,7 +664,21 @@ impl<'a, 'tcx> Decodable<CacheDecoder<'a, 'tcx>> for ExpnId {\n \n             let data: ExpnData = decoder\n                 .with_position(pos.to_usize(), |decoder| decode_tagged(decoder, TAG_EXPN_DATA))?;\n-            rustc_span::hygiene::register_local_expn_id(data, hash)\n+            let expn_id = rustc_span::hygiene::register_local_expn_id(data, hash);\n+\n+            #[cfg(debug_assertions)]\n+            {\n+                use rustc_data_structures::stable_hasher::{HashStable, StableHasher};\n+                let mut hcx = decoder.tcx.create_stable_hashing_context();\n+                let mut hasher = StableHasher::new();\n+                hcx.while_hashing_spans(true, |hcx| {\n+                    expn_id.expn_data().hash_stable(hcx, &mut hasher)\n+                });\n+                let local_hash: u64 = hasher.finish();\n+                debug_assert_eq!(hash.local_hash(), local_hash);\n+            }\n+\n+            expn_id\n         } else {\n             let index_guess = decoder.foreign_expn_data[&hash];\n             decoder.tcx.cstore_untracked().expn_hash_to_expn_id(\n@@ -675,16 +689,7 @@ impl<'a, 'tcx> Decodable<CacheDecoder<'a, 'tcx>> for ExpnId {\n             )\n         };\n \n-        #[cfg(debug_assertions)]\n-        {\n-            use rustc_data_structures::stable_hasher::{HashStable, StableHasher};\n-            let mut hcx = decoder.tcx.create_stable_hashing_context();\n-            let mut hasher = StableHasher::new();\n-            hcx.while_hashing_spans(true, |hcx| expn_id.expn_data().hash_stable(hcx, &mut hasher));\n-            let local_hash: u64 = hasher.finish();\n-            debug_assert_eq!(hash.local_hash(), local_hash);\n-        }\n-\n+        debug_assert_eq!(expn_id.krate, krate);\n         Ok(expn_id)\n     }\n }"}, {"sha": "5bd863439df5d3426279359c784c67930334487a", "filename": "src/test/incremental/mir-opt.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/daf8903e8ed1f4704077e02479f841b84ebc82d3/src%2Ftest%2Fincremental%2Fmir-opt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/daf8903e8ed1f4704077e02479f841b84ebc82d3/src%2Ftest%2Fincremental%2Fmir-opt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fmir-opt.rs?ref=daf8903e8ed1f4704077e02479f841b84ebc82d3", "patch": "@@ -0,0 +1,11 @@\n+// MIR optimizations can create expansions after the TyCtxt has been created.\n+// This test verifies that those expansions can be decoded correctly.\n+\n+// revisions:rpass1 rpass2\n+// compile-flags: -Z query-dep-graph -Z mir-opt-level=3\n+\n+fn main() {\n+    if std::env::var(\"a\").is_ok() {\n+        println!(\"b\");\n+    }\n+}"}]}