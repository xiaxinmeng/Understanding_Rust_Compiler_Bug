{"sha": "413938d7a9df4efe800552fa03ce1a5866539cbc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQxMzkzOGQ3YTlkZjRlZmU4MDA1NTJmYTAzY2UxYTU4NjY1MzljYmM=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-03-31T21:23:32Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-03-31T21:24:27Z"}, "message": "Fix `--external-css` to be invocation-specific and note main.js should be invocation specific", "tree": {"sha": "3d2e8800940f602c8962089b24de8c26a65a6d23", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3d2e8800940f602c8962089b24de8c26a65a6d23"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/413938d7a9df4efe800552fa03ce1a5866539cbc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/413938d7a9df4efe800552fa03ce1a5866539cbc", "html_url": "https://github.com/rust-lang/rust/commit/413938d7a9df4efe800552fa03ce1a5866539cbc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/413938d7a9df4efe800552fa03ce1a5866539cbc/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1086d9b7b58fea8f15b1f10bc2e527b6fcb0e382", "url": "https://api.github.com/repos/rust-lang/rust/commits/1086d9b7b58fea8f15b1f10bc2e527b6fcb0e382", "html_url": "https://github.com/rust-lang/rust/commit/1086d9b7b58fea8f15b1f10bc2e527b6fcb0e382"}], "stats": {"total": 35, "additions": 27, "deletions": 8}, "files": [{"sha": "b2f2283c177df4d840dec9e936405312db2e62bf", "filename": "src/librustdoc/html/render/write_shared.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/413938d7a9df4efe800552fa03ce1a5866539cbc/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs", "raw_url": "https://github.com/rust-lang/rust/raw/413938d7a9df4efe800552fa03ce1a5866539cbc/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs?ref=413938d7a9df4efe800552fa03ce1a5866539cbc", "patch": "@@ -213,6 +213,9 @@ pub(super) fn write_shared(\n     let mut themes: Vec<&String> = themes.iter().collect();\n     themes.sort();\n \n+    // FIXME: this should probably not be a toolchain file since it depends on `--theme`.\n+    // But it seems a shame to copy it over and over when it's almost always the same.\n+    // Maybe we can change the representation to move this out of main.js?\n     write_minify(\n         \"main.js\",\n         &static_files::MAIN_JS.replace(\n@@ -238,7 +241,13 @@ pub(super) fn write_shared(\n \n     if let Some(ref css) = cx.shared.layout.css_file_extension {\n         let buffer = try_err!(fs::read_to_string(css), css);\n-        write_minify(\"theme.css\", &buffer)?;\n+        // This varies based on the invocation, so it can't go through the write_minify wrapper.\n+        cx.write_minify(\n+            SharedResource::InvocationSpecific { basename: \"theme.css\" },\n+            &buffer,\n+            options.enable_minification,\n+            &options.emit,\n+        )?;\n     }\n     write_minify(\"normalize.css\", static_files::NORMALIZE_CSS)?;\n     for (name, contents) in &*FILES_UNVERSIONED {"}, {"sha": "5c4825ae66c878a80627e31441288a76d43b18ab", "filename": "src/test/run-make/emit-shared-files/Makefile", "status": "modified", "additions": 17, "deletions": 7, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/413938d7a9df4efe800552fa03ce1a5866539cbc/src%2Ftest%2Frun-make%2Femit-shared-files%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/413938d7a9df4efe800552fa03ce1a5866539cbc/src%2Ftest%2Frun-make%2Femit-shared-files%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Femit-shared-files%2FMakefile?ref=413938d7a9df4efe800552fa03ce1a5866539cbc", "patch": "@@ -7,30 +7,40 @@ ALL_SHARED = $(TMPDIR)/all-shared\n all: invocation-only toolchain-only all-shared\n \n invocation-only:\n-\t$(RUSTDOC) -Z unstable-options --emit=invocation-specific --output $(INVOCATION_ONLY) --resource-suffix=-xxx --theme y.css x.rs\n+\t$(RUSTDOC) -Z unstable-options --emit=invocation-specific --output $(INVOCATION_ONLY) --resource-suffix=-xxx --theme y.css --extend-css z.css x.rs\n \t[ -e $(INVOCATION_ONLY)/search-index-xxx.js ]\n \t[ -e $(INVOCATION_ONLY)/settings.html ]\n \t[ -e $(INVOCATION_ONLY)/x/all.html ]\n \t[ -e $(INVOCATION_ONLY)/x/index.html ]\n-\t# FIXME: this probably shouldn't have a suffix\n-\t[ -e $(INVOCATION_ONLY)/y-xxx.css ]\n+\t[ -e $(INVOCATION_ONLY)/theme-xxx.css ] # generated from z.css\n \t! [ -e $(INVOCATION_ONLY)/storage-xxx.js ]\n \t! [ -e $(INVOCATION_ONLY)/SourceSerifPro-It.ttf.woff ]\n \n+\t# FIXME: this probably shouldn't have a suffix\n+\t[ -e $(INVOCATION_ONLY)/y-xxx.css ]\n+\t# FIXME: this is technically incorrect (see `write_shared`)\n+\t! [ -e $(INVOCATION_ONLY)/main-xxx.js ]\n+\n toolchain-only:\n-\t$(RUSTDOC) -Z unstable-options --emit=toolchain-shared-resources --output $(TOOLCHAIN_ONLY) --resource-suffix=-xxx x.rs\n+\t$(RUSTDOC) -Z unstable-options --emit=toolchain-shared-resources --output $(TOOLCHAIN_ONLY) --resource-suffix=-xxx --extend-css z.css x.rs\n \t[ -e $(TOOLCHAIN_ONLY)/storage-xxx.js ]\n-\t! [ -e $(TOOLCHAIN_ONLY)/y-xxx.css ]\n \t! [ -e $(TOOLCHAIN_ONLY)/SourceSerifPro-It.ttf.woff ]\n \t! [ -e $(TOOLCHAIN_ONLY)/search-index-xxx.js ]\n \t! [ -e $(TOOLCHAIN_ONLY)/x/index.html ]\n+\t! [ -e $(TOOLCHAIN_ONLY)/theme.css ]\n+\n+\t[ -e $(TOOLCHAIN_ONLY)/main-xxx.js ]\n+\t! [ -e $(TOOLCHAIN_ONLY)/y-xxx.css ]\n \n all-shared:\n-\t$(RUSTDOC) -Z unstable-options --emit=toolchain-shared-resources,unversioned-shared-resources --output $(ALL_SHARED) --resource-suffix=-xxx x.rs\n+\t$(RUSTDOC) -Z unstable-options --emit=toolchain-shared-resources,unversioned-shared-resources --output $(ALL_SHARED) --resource-suffix=-xxx --extend-css z.css x.rs\n \t[ -e $(ALL_SHARED)/storage-xxx.js ]\n \t[ -e $(ALL_SHARED)/SourceSerifPro-It.ttf.woff ]\n-\t! [ -e $(ALL_SHARED)/y-xxx.css ]\n \t! [ -e $(ALL_SHARED)/search-index-xxx.js ]\n \t! [ -e $(ALL_SHARED)/settings.html ]\n \t! [ -e $(ALL_SHARED)/x ]\n \t! [ -e $(ALL_SHARED)/src ]\n+\t! [ -e $(ALL_SHARED)/theme.css ]\n+\n+\t[ -e $(ALL_SHARED)/main-xxx.js ]\n+\t! [ -e $(ALL_SHARED)/y-xxx.css ]"}, {"sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391", "filename": "src/test/run-make/emit-shared-files/y.css", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/413938d7a9df4efe800552fa03ce1a5866539cbc/src%2Ftest%2Frun-make%2Femit-shared-files%2Fy.css", "raw_url": "https://github.com/rust-lang/rust/raw/413938d7a9df4efe800552fa03ce1a5866539cbc/src%2Ftest%2Frun-make%2Femit-shared-files%2Fy.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Femit-shared-files%2Fy.css?ref=413938d7a9df4efe800552fa03ce1a5866539cbc"}, {"sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391", "filename": "src/test/run-make/emit-shared-files/z.css", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/413938d7a9df4efe800552fa03ce1a5866539cbc/src%2Ftest%2Frun-make%2Femit-shared-files%2Fz.css", "raw_url": "https://github.com/rust-lang/rust/raw/413938d7a9df4efe800552fa03ce1a5866539cbc/src%2Ftest%2Frun-make%2Femit-shared-files%2Fz.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Femit-shared-files%2Fz.css?ref=413938d7a9df4efe800552fa03ce1a5866539cbc"}]}