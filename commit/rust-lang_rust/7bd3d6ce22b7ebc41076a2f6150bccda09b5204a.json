{"sha": "7bd3d6ce22b7ebc41076a2f6150bccda09b5204a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdiZDNkNmNlMjJiN2ViYzQxMDc2YTJmNjE1MGJjY2RhMDliNTIwNGE=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2021-01-28T06:09:02Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-28T06:09:02Z"}, "message": "Rollup merge of #79951 - LeSeulArtichaut:ty-ir, r=nikomatsakis\n\nRefractor a few more types to `rustc_type_ir`\n\nIn the continuation of #79169, ~~blocked on that PR~~.\n\nThis PR:\n - moves `IntVarValue`, `FloatVarValue`, `InferTy` (and friends) and `Variance`\n - creates the `IntTy`, `UintTy` and `FloatTy` enums in `rustc_type_ir`, based on their `ast` and `chalk_ir` equilavents, and uses them for types in the rest of the compiler.\n\n~~I will split up that commit to make this easier to review and to have a better commit history.~~\nEDIT: done, I split the PR in commits of 200-ish lines each\n\nr? `````@nikomatsakis````` cc `````@jackh726`````", "tree": {"sha": "93d17b50ea87676f2fbd7d7a5ce36027408a088b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/93d17b50ea87676f2fbd7d7a5ce36027408a088b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a", "html_url": "https://github.com/rust-lang/rust/commit/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e9b2cf4f6425d760df7e5e0675e8e02da11819f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/e9b2cf4f6425d760df7e5e0675e8e02da11819f8", "html_url": "https://github.com/rust-lang/rust/commit/e9b2cf4f6425d760df7e5e0675e8e02da11819f8"}, {"sha": "dce2262daea813f67fb8cce4e76eb5909ef510cb", "url": "https://api.github.com/repos/rust-lang/rust/commits/dce2262daea813f67fb8cce4e76eb5909ef510cb", "html_url": "https://github.com/rust-lang/rust/commit/dce2262daea813f67fb8cce4e76eb5909ef510cb"}], "stats": {"total": 54, "additions": 24, "deletions": 30}, "files": [{"sha": "ac9098a7584d6d6985a02d9d2f7c931e27d5185e", "filename": "clippy_lints/src/bytecount.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Fbytecount.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Fbytecount.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fbytecount.rs?ref=7bd3d6ce22b7ebc41076a2f6150bccda09b5204a", "patch": "@@ -2,11 +2,10 @@ use crate::utils::{\n     contains_name, get_pat_name, match_type, paths, single_segment_path, snippet_with_applicability, span_lint_and_sugg,\n };\n use if_chain::if_chain;\n-use rustc_ast::ast::UintTy;\n use rustc_errors::Applicability;\n use rustc_hir::{BinOpKind, BorrowKind, Expr, ExprKind, UnOp};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::ty;\n+use rustc_middle::ty::{self, UintTy};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::sym;\n use rustc_span::Symbol;"}, {"sha": "640cffd24a701d52a006f088726459a07358d3c1", "filename": "clippy_lints/src/consts.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fconsts.rs?ref=7bd3d6ce22b7ebc41076a2f6150bccda09b5204a", "patch": "@@ -2,14 +2,14 @@\n \n use crate::utils::{clip, sext, unsext};\n use if_chain::if_chain;\n-use rustc_ast::ast::{FloatTy, LitFloatType, LitKind};\n+use rustc_ast::ast::{self, LitFloatType, LitKind};\n use rustc_data_structures::sync::Lrc;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::{BinOp, BinOpKind, Block, Expr, ExprKind, HirId, QPath, UnOp};\n use rustc_lint::LateContext;\n use rustc_middle::mir::interpret::Scalar;\n use rustc_middle::ty::subst::{Subst, SubstsRef};\n-use rustc_middle::ty::{self, ScalarInt, Ty, TyCtxt};\n+use rustc_middle::ty::{self, FloatTy, ScalarInt, Ty, TyCtxt};\n use rustc_middle::{bug, span_bug};\n use rustc_span::symbol::Symbol;\n use std::cmp::Ordering::{self, Equal};\n@@ -167,8 +167,8 @@ pub fn lit_to_constant(lit: &LitKind, ty: Option<Ty<'_>>) -> Constant {\n         LitKind::Char(c) => Constant::Char(c),\n         LitKind::Int(n, _) => Constant::Int(n),\n         LitKind::Float(ref is, LitFloatType::Suffixed(fty)) => match fty {\n-            FloatTy::F32 => Constant::F32(is.as_str().parse().unwrap()),\n-            FloatTy::F64 => Constant::F64(is.as_str().parse().unwrap()),\n+            ast::FloatTy::F32 => Constant::F32(is.as_str().parse().unwrap()),\n+            ast::FloatTy::F64 => Constant::F64(is.as_str().parse().unwrap()),\n         },\n         LitKind::Float(ref is, LitFloatType::Unsuffixed) => match ty.expect(\"type of float is known\").kind() {\n             ty::Float(FloatTy::F32) => Constant::F32(is.as_str().parse().unwrap()),"}, {"sha": "ae56a8ba5ab4b4056a6a2dd9f8764e952a7fa54a", "filename": "clippy_lints/src/enum_clike.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Fenum_clike.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Fenum_clike.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fenum_clike.rs?ref=7bd3d6ce22b7ebc41076a2f6150bccda09b5204a", "patch": "@@ -3,10 +3,9 @@\n \n use crate::consts::{miri_to_const, Constant};\n use crate::utils::span_lint;\n-use rustc_ast::ast::{IntTy, UintTy};\n use rustc_hir::{Item, ItemKind};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::ty;\n+use rustc_middle::ty::{self, IntTy, UintTy};\n use rustc_middle::ty::util::IntTypeExt;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use std::convert::TryFrom;"}, {"sha": "be646cbe4d043659bed1a879e8e3f07836090feb", "filename": "clippy_lints/src/float_literal.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Ffloat_literal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Ffloat_literal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ffloat_literal.rs?ref=7bd3d6ce22b7ebc41076a2f6150bccda09b5204a", "patch": "@@ -1,10 +1,10 @@\n use crate::utils::{numeric_literal, span_lint_and_sugg};\n use if_chain::if_chain;\n-use rustc_ast::ast::{FloatTy, LitFloatType, LitKind};\n+use rustc_ast::ast::{self, LitFloatType, LitKind};\n use rustc_errors::Applicability;\n use rustc_hir as hir;\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::ty;\n+use rustc_middle::ty::{self, FloatTy};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use std::fmt;\n \n@@ -75,8 +75,8 @@ impl<'tcx> LateLintPass<'tcx> for FloatLiteral {\n                 let digits = count_digits(&sym_str);\n                 let max = max_digits(fty);\n                 let type_suffix = match lit_float_ty {\n-                    LitFloatType::Suffixed(FloatTy::F32) => Some(\"f32\"),\n-                    LitFloatType::Suffixed(FloatTy::F64) => Some(\"f64\"),\n+                    LitFloatType::Suffixed(ast::FloatTy::F32) => Some(\"f32\"),\n+                    LitFloatType::Suffixed(ast::FloatTy::F64) => Some(\"f64\"),\n                     LitFloatType::Unsuffixed => None\n                 };\n                 let (is_whole, mut float_str) = match fty {"}, {"sha": "40b236493a3135722fe1ded68054f20ca462a7d9", "filename": "clippy_lints/src/mutex_atomic.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Fmutex_atomic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Fmutex_atomic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmutex_atomic.rs?ref=7bd3d6ce22b7ebc41076a2f6150bccda09b5204a", "patch": "@@ -3,7 +3,6 @@\n //! This lint is **warn** by default\n \n use crate::utils::{is_type_diagnostic_item, span_lint};\n-use rustc_ast::ast;\n use rustc_hir::Expr;\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_middle::ty::{self, Ty};\n@@ -77,8 +76,8 @@ impl<'tcx> LateLintPass<'tcx> for Mutex {\n                         atomic_name\n                     );\n                     match *mutex_param.kind() {\n-                        ty::Uint(t) if t != ast::UintTy::Usize => span_lint(cx, MUTEX_INTEGER, expr.span, &msg),\n-                        ty::Int(t) if t != ast::IntTy::Isize => span_lint(cx, MUTEX_INTEGER, expr.span, &msg),\n+                        ty::Uint(t) if t != ty::UintTy::Usize => span_lint(cx, MUTEX_INTEGER, expr.span, &msg),\n+                        ty::Int(t) if t != ty::IntTy::Isize => span_lint(cx, MUTEX_INTEGER, expr.span, &msg),\n                         _ => span_lint(cx, MUTEX_ATOMIC, expr.span, &msg),\n                     };\n                 }"}, {"sha": "d977cea4da50b6427653d07a59af1ade1686b46e", "filename": "clippy_lints/src/transmute.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Ftransmute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Ftransmute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftransmute.rs?ref=7bd3d6ce22b7ebc41076a2f6150bccda09b5204a", "patch": "@@ -443,7 +443,7 @@ impl<'tcx> LateLintPass<'tcx> for Transmute {\n                             );\n                         },\n                     ),\n-                    (ty::Int(ast::IntTy::I32) | ty::Uint(ast::UintTy::U32), &ty::Char) => {\n+                    (ty::Int(ty::IntTy::I32) | ty::Uint(ty::UintTy::U32), &ty::Char) => {\n                         span_lint_and_then(\n                             cx,\n                             TRANSMUTE_INT_TO_CHAR,\n@@ -468,7 +468,7 @@ impl<'tcx> LateLintPass<'tcx> for Transmute {\n                     (ty::Ref(_, ty_from, from_mutbl), ty::Ref(_, ty_to, to_mutbl)) => {\n                         if_chain! {\n                             if let (&ty::Slice(slice_ty), &ty::Str) = (&ty_from.kind(), &ty_to.kind());\n-                            if let ty::Uint(ast::UintTy::U8) = slice_ty.kind();\n+                            if let ty::Uint(ty::UintTy::U8) = slice_ty.kind();\n                             if from_mutbl == to_mutbl;\n                             then {\n                                 let postfix = if *from_mutbl == Mutability::Mut {\n@@ -536,7 +536,7 @@ impl<'tcx> LateLintPass<'tcx> for Transmute {\n                             }\n                         },\n                     ),\n-                    (ty::Int(ast::IntTy::I8) | ty::Uint(ast::UintTy::U8), ty::Bool) => {\n+                    (ty::Int(ty::IntTy::I8) | ty::Uint(ty::UintTy::U8), ty::Bool) => {\n                         span_lint_and_then(\n                             cx,\n                             TRANSMUTE_INT_TO_BOOL,"}, {"sha": "17cef0af3e9c9e257f0b6cde1852d41cf7c7957f", "filename": "clippy_lints/src/types.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftypes.rs?ref=7bd3d6ce22b7ebc41076a2f6150bccda09b5204a", "patch": "@@ -5,7 +5,7 @@ use std::cmp::Ordering;\n use std::collections::BTreeMap;\n \n use if_chain::if_chain;\n-use rustc_ast::{FloatTy, IntTy, LitFloatType, LitIntType, LitKind, UintTy};\n+use rustc_ast::{LitFloatType, LitIntType, LitKind};\n use rustc_errors::{Applicability, DiagnosticBuilder};\n use rustc_hir as hir;\n use rustc_hir::intravisit::{walk_body, walk_expr, walk_ty, FnKind, NestedVisitorMap, Visitor};\n@@ -18,7 +18,7 @@ use rustc_lint::{LateContext, LateLintPass, LintContext};\n use rustc_middle::hir::map::Map;\n use rustc_middle::lint::in_external_macro;\n use rustc_middle::ty::TypeFoldable;\n-use rustc_middle::ty::{self, InferTy, Ty, TyCtxt, TyS, TypeAndMut, TypeckResults};\n+use rustc_middle::ty::{self, FloatTy, InferTy, IntTy, Ty, TyCtxt, TyS, TypeAndMut, TypeckResults, UintTy};\n use rustc_semver::RustcVersion;\n use rustc_session::{declare_lint_pass, declare_tool_lint, impl_lint_pass};\n use rustc_span::hygiene::{ExpnKind, MacroKind};\n@@ -1106,9 +1106,7 @@ fn is_empty_block(expr: &Expr<'_>) -> bool {\n         expr.kind,\n         ExprKind::Block(\n             Block {\n-                stmts: &[],\n-                expr: None,\n-                ..\n+                stmts: &[], expr: None, ..\n             },\n             _,\n         )"}, {"sha": "46b2b06d1a280d151f639fd9d21cd326ee634de2", "filename": "clippy_lints/src/utils/mod.rs", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7bd3d6ce22b7ebc41076a2f6150bccda09b5204a/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fmod.rs?ref=7bd3d6ce22b7ebc41076a2f6150bccda09b5204a", "patch": "@@ -35,7 +35,6 @@ use std::mem;\n \n use if_chain::if_chain;\n use rustc_ast::ast::{self, Attribute, LitKind};\n-use rustc_attr as attr;\n use rustc_data_structures::fx::FxHashMap;\n use rustc_errors::Applicability;\n use rustc_hir as hir;\n@@ -1224,27 +1223,27 @@ pub fn get_arg_name(pat: &Pat<'_>) -> Option<Symbol> {\n     }\n }\n \n-pub fn int_bits(tcx: TyCtxt<'_>, ity: ast::IntTy) -> u64 {\n-    Integer::from_attr(&tcx, attr::IntType::SignedInt(ity)).size().bits()\n+pub fn int_bits(tcx: TyCtxt<'_>, ity: ty::IntTy) -> u64 {\n+    Integer::from_int_ty(&tcx, ity).size().bits()\n }\n \n #[allow(clippy::cast_possible_wrap)]\n /// Turn a constant int byte representation into an i128\n-pub fn sext(tcx: TyCtxt<'_>, u: u128, ity: ast::IntTy) -> i128 {\n+pub fn sext(tcx: TyCtxt<'_>, u: u128, ity: ty::IntTy) -> i128 {\n     let amt = 128 - int_bits(tcx, ity);\n     ((u as i128) << amt) >> amt\n }\n \n #[allow(clippy::cast_sign_loss)]\n /// clip unused bytes\n-pub fn unsext(tcx: TyCtxt<'_>, u: i128, ity: ast::IntTy) -> u128 {\n+pub fn unsext(tcx: TyCtxt<'_>, u: i128, ity: ty::IntTy) -> u128 {\n     let amt = 128 - int_bits(tcx, ity);\n     ((u as u128) << amt) >> amt\n }\n \n /// clip unused bytes\n-pub fn clip(tcx: TyCtxt<'_>, u: u128, ity: ast::UintTy) -> u128 {\n-    let bits = Integer::from_attr(&tcx, attr::IntType::UnsignedInt(ity)).size().bits();\n+pub fn clip(tcx: TyCtxt<'_>, u: u128, ity: ty::UintTy) -> u128 {\n+    let bits = Integer::from_uint_ty(&tcx, ity).size().bits();\n     let amt = 128 - bits;\n     (u << amt) >> amt\n }"}]}