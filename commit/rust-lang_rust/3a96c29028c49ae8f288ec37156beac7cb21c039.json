{"sha": "3a96c29028c49ae8f288ec37156beac7cb21c039", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNhOTZjMjkwMjhjNDlhZThmMjg4ZWMzNzE1NmJlYWM3Y2IyMWMwMzk=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-11-26T16:30:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-26T16:30:05Z"}, "message": "Merge #6641\n\n6641: Fix def map volatility with `#[cfg]` diagnostics r=jonas-schievink a=jonas-schievink\n\nbors r+ :robot:\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>", "tree": {"sha": "41593247bcff0f60adf669dd0c2da0ec53ae80b4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/41593247bcff0f60adf669dd0c2da0ec53ae80b4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3a96c29028c49ae8f288ec37156beac7cb21c039", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfv9gNCRBK7hj4Ov3rIwAAdHIIAFitbgj5a6IaV7iW7CfOjZYG\n9EXE3pG06lLc2PBjkblO20+mVGAsUgcJKfFtm+fimkYwZ5Fh8qYoybIjylst/t5D\nrqFUZqMwC/mjXZ0kgis8FIlWgRZv12yt/SuvdyLA0yuoAblWmLi8GLlJmVYBOBXs\nnVdNHLX8dVCZH1Bof7tM7WbK3BPmIE3hDPJc816gjEouX/opXCsMFEo8yzdIXmsF\nMHnKeGfOpYBegBRK2+UP4z9S8N2g4eYGl27+oJBxX1f0mC5rLc/FOD5asF+RyGGZ\nZAaE8tMXuOm6wz7EfXeLHwWVYjktNNZMfoRGNKYz33YBkd817TGAn40f6p6dojY=\n=nK9I\n-----END PGP SIGNATURE-----\n", "payload": "tree 41593247bcff0f60adf669dd0c2da0ec53ae80b4\nparent ad343870ec33d744f0efbd1d9633e62b017b19ea\nparent 519d870c11a9200bdcc33bb788fb7d8a85e5f1e5\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1606408205 +0000\ncommitter GitHub <noreply@github.com> 1606408205 +0000\n\nMerge #6641\n\n6641: Fix def map volatility with `#[cfg]` diagnostics r=jonas-schievink a=jonas-schievink\n\nbors r+ :robot:\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3a96c29028c49ae8f288ec37156beac7cb21c039", "html_url": "https://github.com/rust-lang/rust/commit/3a96c29028c49ae8f288ec37156beac7cb21c039", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3a96c29028c49ae8f288ec37156beac7cb21c039/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ad343870ec33d744f0efbd1d9633e62b017b19ea", "url": "https://api.github.com/repos/rust-lang/rust/commits/ad343870ec33d744f0efbd1d9633e62b017b19ea", "html_url": "https://github.com/rust-lang/rust/commit/ad343870ec33d744f0efbd1d9633e62b017b19ea"}, {"sha": "519d870c11a9200bdcc33bb788fb7d8a85e5f1e5", "url": "https://api.github.com/repos/rust-lang/rust/commits/519d870c11a9200bdcc33bb788fb7d8a85e5f1e5", "html_url": "https://github.com/rust-lang/rust/commit/519d870c11a9200bdcc33bb788fb7d8a85e5f1e5"}], "stats": {"total": 21, "additions": 13, "deletions": 8}, "files": [{"sha": "202a7dcb6d8af3cf74987e7bf4357d92326826ea", "filename": "crates/hir_def/src/nameres.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/3a96c29028c49ae8f288ec37156beac7cb21c039/crates%2Fhir_def%2Fsrc%2Fnameres.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a96c29028c49ae8f288ec37156beac7cb21c039/crates%2Fhir_def%2Fsrc%2Fnameres.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres.rs?ref=3a96c29028c49ae8f288ec37156beac7cb21c039", "patch": "@@ -287,7 +287,7 @@ mod diagnostics {\n     use hir_expand::diagnostics::DiagnosticSink;\n     use hir_expand::hygiene::Hygiene;\n     use hir_expand::InFile;\n-    use syntax::{ast, AstPtr, SyntaxNodePtr};\n+    use syntax::{ast, AstPtr};\n \n     use crate::path::ModPath;\n     use crate::{db::DefDatabase, diagnostics::*, nameres::LocalModuleId, AstId};\n@@ -300,7 +300,7 @@ mod diagnostics {\n \n         UnresolvedImport { ast: AstId<ast::Use>, index: usize },\n \n-        UnconfiguredCode { ast: InFile<SyntaxNodePtr>, cfg: CfgExpr, opts: CfgOptions },\n+        UnconfiguredCode { ast: AstId<ast::Item>, cfg: CfgExpr, opts: CfgOptions },\n     }\n \n     #[derive(Debug, PartialEq, Eq)]\n@@ -341,7 +341,7 @@ mod diagnostics {\n \n         pub(super) fn unconfigured_code(\n             container: LocalModuleId,\n-            ast: InFile<SyntaxNodePtr>,\n+            ast: AstId<ast::Item>,\n             cfg: CfgExpr,\n             opts: CfgOptions,\n         ) -> Self {\n@@ -399,9 +399,10 @@ mod diagnostics {\n                 }\n \n                 DiagnosticKind::UnconfiguredCode { ast, cfg, opts } => {\n+                    let item = ast.to_node(db.upcast());\n                     sink.push(InactiveCode {\n                         file: ast.file_id,\n-                        node: ast.value.clone(),\n+                        node: AstPtr::new(&item).into(),\n                         cfg: cfg.clone(),\n                         opts: opts.clone(),\n                     });"}, {"sha": "5ed9073e08354daa4b3b928e354cbecc8087dd1d", "filename": "crates/hir_def/src/nameres/collector.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3a96c29028c49ae8f288ec37156beac7cb21c039/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a96c29028c49ae8f288ec37156beac7cb21c039/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=3a96c29028c49ae8f288ec37156beac7cb21c039", "patch": "@@ -1336,13 +1336,11 @@ impl ModCollector<'_, '_> {\n \n     fn emit_unconfigured_diagnostic(&mut self, item: ModItem, cfg: &CfgExpr) {\n         let ast_id = item.ast_id(self.item_tree);\n-        let id_map = self.def_collector.db.ast_id_map(self.file_id);\n-        let syntax_ptr = id_map.get(ast_id).syntax_node_ptr();\n \n-        let ast_node = InFile::new(self.file_id, syntax_ptr);\n+        let ast_id = InFile::new(self.file_id, ast_id);\n         self.def_collector.def_map.diagnostics.push(DefDiagnostic::unconfigured_code(\n             self.module_id,\n-            ast_node,\n+            ast_id,\n             cfg.clone(),\n             self.def_collector.cfg_options.clone(),\n         ));"}, {"sha": "8981fa7c94ff490605ee5079af58349d268313d6", "filename": "crates/hir_def/src/nameres/tests/incremental.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3a96c29028c49ae8f288ec37156beac7cb21c039/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests%2Fincremental.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a96c29028c49ae8f288ec37156beac7cb21c039/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests%2Fincremental.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests%2Fincremental.rs?ref=3a96c29028c49ae8f288ec37156beac7cb21c039", "patch": "@@ -38,6 +38,9 @@ fn typing_inside_a_function_should_not_invalidate_def_map() {\n         fn foo() -> i32 {\n             1 + 1\n         }\n+\n+        #[cfg(never)]\n+        fn no() {}\n         //- /foo/mod.rs\n         pub mod bar;\n \n@@ -53,6 +56,9 @@ fn typing_inside_a_function_should_not_invalidate_def_map() {\n         use E::*;\n \n         fn foo() -> i32 { 92 }\n+\n+        #[cfg(never)]\n+        fn no() {}\n         \",\n     );\n }"}]}