{"sha": "f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b", "node_id": "C_kwDOAAsO6NoAKGY5YjNkNmE1MjUyZTA0M2I5YTBmMDM0N2U4NDgxYTYxZDZiODNiOGI", "commit": {"author": {"name": "Chris Denton", "email": "chris@chrisdenton.dev", "date": "2023-04-15T10:57:07Z"}, "committer": {"name": "Chris Denton", "email": "chris@chrisdenton.dev", "date": "2023-05-05T19:48:16Z"}, "message": "Generate windows-sys bindings", "tree": {"sha": "fcb18e489a8cf7e8ff0beb2f4e9e0cd6b2fc67a6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fcb18e489a8cf7e8ff0beb2f4e9e0cd6b2fc67a6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE+p/jD6jrzmnSIWJLcTRy8vRWJ94FAmRVXYAACgkQcTRy8vRW\nJ95tiBAAoZwHGw4Kg7/CPeQdANUeWNplDXO2O9welOr+dYZYY4FjZQKn43KtNScl\nsd4KwOwYKL6ImRag5Xf899S6YK6mwyff1k5uoMW1V384HYj2RiZ38s81JoihuWCs\n8HmAR6+iMczzWn/1ieTn+OCVVM2Fm2v1LHUuFc1MA1S8cvEv6FQ33zR+koc0xaKb\nMItJhmSNB/LxE4xwkNogincj/l8/dQJ7jsLntNqL/FhVO27WvFFWs1AaD2RJSD24\n0QynREklryKdpLNofzCj4p3rduWkuQPK80+CSPiPaovL2S6PcNXJNtPXg7oPdzE4\nNtBjQLYFcyxiLy65Il1dXkh0pef73hR+6ZkAL2K8CYY0zyFok6IXEJJQgo9Si2wY\nLd8I1ag1BekHyiFChkLwawMQFSyipwPvOzQF9Y+RsyoIXwDqqGpzTt5KWvpCoKHQ\nuoXNcQk4L4c1vPOIzt2ItQLbILtCZFWL4vmJSApbOKCnqcexadooLuTv2CiMFLQK\n3GOxLqNDhakoVqIGit0umrZ4UlchtNgfA2WGu1Jr+9uuAbYRElBkxGxw+Kiy4JJK\nSDvhXmd+/WnlGPsiczhcl/HlPaOrEWKx35ZPttMVCE0km+MG88YNRnXHvwSWWJPh\nzmfQGVMZOnPSCqwKKlR57xkhHkdoj1IPFC+JJqF81z4UdKcWzSM=\n=B06q\n-----END PGP SIGNATURE-----", "payload": "tree fcb18e489a8cf7e8ff0beb2f4e9e0cd6b2fc67a6\nparent 4a18324a4df6bc98bec0b54d35908d7a9cdc7c32\nauthor Chris Denton <chris@chrisdenton.dev> 1681556227 +0100\ncommitter Chris Denton <chris@chrisdenton.dev> 1683316096 +0100\n\nGenerate windows-sys bindings\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b", "html_url": "https://github.com/rust-lang/rust/commit/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/comments", "author": {"login": "ChrisDenton", "id": 4459874, "node_id": "MDQ6VXNlcjQ0NTk4NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChrisDenton", "html_url": "https://github.com/ChrisDenton", "followers_url": "https://api.github.com/users/ChrisDenton/followers", "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}", "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions", "organizations_url": "https://api.github.com/users/ChrisDenton/orgs", "repos_url": "https://api.github.com/users/ChrisDenton/repos", "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}", "received_events_url": "https://api.github.com/users/ChrisDenton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ChrisDenton", "id": 4459874, "node_id": "MDQ6VXNlcjQ0NTk4NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChrisDenton", "html_url": "https://github.com/ChrisDenton", "followers_url": "https://api.github.com/users/ChrisDenton/followers", "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}", "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions", "organizations_url": "https://api.github.com/users/ChrisDenton/orgs", "repos_url": "https://api.github.com/users/ChrisDenton/repos", "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}", "received_events_url": "https://api.github.com/users/ChrisDenton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4a18324a4df6bc98bec0b54d35908d7a9cdc7c32", "url": "https://api.github.com/repos/rust-lang/rust/commits/4a18324a4df6bc98bec0b54d35908d7a9cdc7c32", "html_url": "https://github.com/rust-lang/rust/commit/4a18324a4df6bc98bec0b54d35908d7a9cdc7c32"}], "stats": {"total": 98, "additions": 98, "deletions": 0}, "files": [{"sha": "bd5af7b409ad5c0efe31077a2e0debf22e57693c", "filename": "Cargo.lock", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b", "patch": "@@ -1443,6 +1443,13 @@ dependencies = [\n  \"serde_json\",\n ]\n \n+[[package]]\n+name = \"generate-windows-sys\"\n+version = \"0.1.0\"\n+dependencies = [\n+ \"windows-bindgen\",\n+]\n+\n [[package]]\n name = \"generic-array\"\n version = \"0.14.4\"\n@@ -5505,6 +5512,22 @@ dependencies = [\n  \"windows-targets 0.48.0\",\n ]\n \n+[[package]]\n+name = \"windows-bindgen\"\n+version = \"0.49.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"b6935fb09b84ee57929ae92518b475f5dfdfbeb87c5334756acc28ee8e202b60\"\n+dependencies = [\n+ \"windows-metadata\",\n+ \"windows-tokens\",\n+]\n+\n+[[package]]\n+name = \"windows-metadata\"\n+version = \"0.49.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"2f5bca94a32bf1e6a376522b6601275a3b611ee885ec0f1b6a05f17e8cfd3385\"\n+\n [[package]]\n name = \"windows-sys\"\n version = \"0.42.0\"\n@@ -5568,6 +5591,12 @@ dependencies = [\n  \"windows_x86_64_msvc 0.48.0\",\n ]\n \n+[[package]]\n+name = \"windows-tokens\"\n+version = \"0.48.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"b34c9a3b28cb41db7385546f7f9a8179348dffc89923dde66857b1ba5312f6b4\"\n+\n [[package]]\n name = \"windows_aarch64_gnullvm\"\n version = \"0.42.2\""}, {"sha": "53331e2869f2e799adcce4808316f80dca012220", "filename": "Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b", "patch": "@@ -39,6 +39,7 @@ members = [\n   \"src/tools/collect-license-metadata\",\n   \"src/tools/generate-copyright\",\n   \"src/tools/suggest-tests\",\n+  \"src/tools/generate-windows-sys\",\n ]\n \n exclude = ["}, {"sha": "2cc89117ae5705e532cc3b8b409a14f0291807c2", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b", "patch": "@@ -832,6 +832,7 @@ impl<'a> Builder<'a> {\n                 run::Miri,\n                 run::CollectLicenseMetadata,\n                 run::GenerateCopyright,\n+                run::GenerateWindowsSys,\n             ),\n             Kind::Setup => describe!(setup::Profile, setup::Hook, setup::Link, setup::Vscode),\n             Kind::Clean => describe!(clean::CleanAll, clean::Rustc, clean::Std),"}, {"sha": "57f3119e32230f63c4059c0aa722e34ee43d3e17", "filename": "src/bootstrap/run.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/src%2Fbootstrap%2Frun.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/src%2Fbootstrap%2Frun.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Frun.rs?ref=f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b", "patch": "@@ -253,3 +253,25 @@ impl Step for GenerateCopyright {\n         dest\n     }\n }\n+\n+#[derive(Debug, PartialOrd, Ord, Copy, Clone, Hash, PartialEq, Eq)]\n+pub struct GenerateWindowsSys;\n+\n+impl Step for GenerateWindowsSys {\n+    type Output = ();\n+    const ONLY_HOSTS: bool = true;\n+\n+    fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n+        run.path(\"src/tools/generate-windows-sys\")\n+    }\n+\n+    fn make_run(run: RunConfig<'_>) {\n+        run.builder.ensure(GenerateWindowsSys);\n+    }\n+\n+    fn run(self, builder: &Builder<'_>) {\n+        let mut cmd = builder.tool_cmd(Tool::GenerateWindowsSys);\n+        cmd.arg(&builder.src);\n+        builder.run(&mut cmd);\n+    }\n+}"}, {"sha": "f13d365e3754db93e175aa919934387b34d9e4b5", "filename": "src/bootstrap/tool.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/src%2Fbootstrap%2Ftool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/src%2Fbootstrap%2Ftool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftool.rs?ref=f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b", "patch": "@@ -301,6 +301,7 @@ bootstrap_tool!(\n     CollectLicenseMetadata, \"src/tools/collect-license-metadata\", \"collect-license-metadata\";\n     GenerateCopyright, \"src/tools/generate-copyright\", \"generate-copyright\";\n     SuggestTests, \"src/tools/suggest-tests\", \"suggest-tests\";\n+    GenerateWindowsSys, \"src/tools/generate-windows-sys\", \"generate-windows-sys\";\n );\n \n #[derive(Debug, Copy, Clone, Hash, PartialEq, Eq, Ord, PartialOrd)]"}, {"sha": "23e88844bd0b8ded28ab90ce3bdfd5610561d92c", "filename": "src/tools/generate-windows-sys/Cargo.toml", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/src%2Ftools%2Fgenerate-windows-sys%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/src%2Ftools%2Fgenerate-windows-sys%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fgenerate-windows-sys%2FCargo.toml?ref=f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b", "patch": "@@ -0,0 +1,7 @@\n+[package]\n+name = \"generate-windows-sys\"\n+version = \"0.1.0\"\n+edition = \"2021\"\n+\n+[dependencies.windows-bindgen]\n+version = \"0.49\""}, {"sha": "0b091b1ebfa9018b9227a0b3b6bac824e35ae51d", "filename": "src/tools/generate-windows-sys/src/main.rs", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/src%2Ftools%2Fgenerate-windows-sys%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b/src%2Ftools%2Fgenerate-windows-sys%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fgenerate-windows-sys%2Fsrc%2Fmain.rs?ref=f9b3d6a5252e043b9a0f0347e8481a61d6b83b8b", "patch": "@@ -0,0 +1,37 @@\n+use std::fs;\n+use std::io::{self, Write};\n+use std::path::PathBuf;\n+\n+/// This is printed to the file before the rest of the contents.\n+const PRELUDE: &str = r#\"// This file is autogenerated.\n+//\n+// To add bindings, edit windows_sys.lst then use `./x run generate-windows-sys` to\n+// regenerate the bindings.\n+//\n+// ignore-tidy-filelength\n+\"#;\n+\n+fn main() -> io::Result<()> {\n+    let mut path: PathBuf =\n+        std::env::args_os().nth(1).expect(\"a path to the rust repository is required\").into();\n+    path.push(\"library/std/src/sys/windows/c/windows_sys.lst\");\n+\n+    // Load the list of APIs\n+    let buffer = fs::read_to_string(&path)?;\n+    let names: Vec<&str> = buffer\n+        .lines()\n+        .filter_map(|line| {\n+            let line = line.trim();\n+            if line.is_empty() || line.starts_with('#') { None } else { Some(line) }\n+        })\n+        .collect();\n+\n+    // Write the bindings to windows-sys.rs\n+    let bindings = windows_bindgen::standalone_std(&names);\n+    path.set_extension(\"rs\");\n+    let mut f = std::fs::File::create(&path)?;\n+    f.write_all(PRELUDE.as_bytes())?;\n+    f.write_all(bindings.as_bytes())?;\n+\n+    Ok(())\n+}"}]}