{"sha": "6fd4d67819a6eb8273768b6c3789ca70582cd703", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZmZDRkNjc4MTlhNmViODI3Mzc2OGI2YzM3ODljYTcwNTgyY2Q3MDM=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-03-16T15:35:03Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-03-17T17:59:41Z"}, "message": "rustbuild: Tweak where timing information goes\n\nThis commit tweaks where timing and step information is printed out as part of\nthe build, ensuring that we do it as close to the location where work happens as\npossible. In rustbuild various functions may perform long blocking work as\ndependencies are assembled, so if we print out timing information early on we\nmay accidentally time more than just the step we were intending to time!", "tree": {"sha": "3dde666a3249a36025794d88eba76c1295344ff3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3dde666a3249a36025794d88eba76c1295344ff3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6fd4d67819a6eb8273768b6c3789ca70582cd703", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6fd4d67819a6eb8273768b6c3789ca70582cd703", "html_url": "https://github.com/rust-lang/rust/commit/6fd4d67819a6eb8273768b6c3789ca70582cd703", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6fd4d67819a6eb8273768b6c3789ca70582cd703/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "61b6bf54fdf56195baf9a8ee7383551b0d468c81", "url": "https://api.github.com/repos/rust-lang/rust/commits/61b6bf54fdf56195baf9a8ee7383551b0d468c81", "html_url": "https://github.com/rust-lang/rust/commit/61b6bf54fdf56195baf9a8ee7383551b0d468c81"}], "stats": {"total": 114, "additions": 60, "deletions": 54}, "files": [{"sha": "a9dccea827b6e17434dc0e02b2583b099c903e49", "filename": "src/bootstrap/check.rs", "status": "modified", "additions": 12, "deletions": 8, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/6fd4d67819a6eb8273768b6c3789ca70582cd703/src%2Fbootstrap%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fd4d67819a6eb8273768b6c3789ca70582cd703/src%2Fbootstrap%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcheck.rs?ref=6fd4d67819a6eb8273768b6c3789ca70582cd703", "patch": "@@ -40,17 +40,18 @@ impl Step for Std {\n         let target = self.target;\n         let compiler = builder.compiler(0, build.build);\n \n-        let _folder = build.fold_output(|| format!(\"stage{}-std\", compiler.stage));\n-        println!(\"Checking std artifacts ({} -> {})\", &compiler.host, target);\n-\n         let out_dir = build.stage_out(compiler, Mode::Libstd);\n         build.clear_if_dirty(&out_dir, &builder.rustc(compiler));\n         let mut cargo = builder.cargo(compiler, Mode::Libstd, target, \"check\");\n         std_cargo(builder, &compiler, target, &mut cargo);\n+\n+        let _folder = build.fold_output(|| format!(\"stage{}-std\", compiler.stage));\n+        println!(\"Checking std artifacts ({} -> {})\", &compiler.host, target);\n         run_cargo(build,\n                   &mut cargo,\n                   &libstd_stamp(build, compiler, target),\n                   true);\n+\n         let libdir = builder.sysroot_libdir(compiler, target);\n         add_to_sysroot(&libdir, &libstd_stamp(build, compiler, target));\n     }\n@@ -86,19 +87,20 @@ impl Step for Rustc {\n         let compiler = builder.compiler(0, build.build);\n         let target = self.target;\n \n-        let _folder = build.fold_output(|| format!(\"stage{}-rustc\", compiler.stage));\n-        println!(\"Checking compiler artifacts ({} -> {})\", &compiler.host, target);\n-\n         let stage_out = builder.stage_out(compiler, Mode::Librustc);\n         build.clear_if_dirty(&stage_out, &libstd_stamp(build, compiler, target));\n         build.clear_if_dirty(&stage_out, &libtest_stamp(build, compiler, target));\n \n         let mut cargo = builder.cargo(compiler, Mode::Librustc, target, \"check\");\n         rustc_cargo(build, &mut cargo);\n+\n+        let _folder = build.fold_output(|| format!(\"stage{}-rustc\", compiler.stage));\n+        println!(\"Checking compiler artifacts ({} -> {})\", &compiler.host, target);\n         run_cargo(build,\n                   &mut cargo,\n                   &librustc_stamp(build, compiler, target),\n                   true);\n+\n         let libdir = builder.sysroot_libdir(compiler, target);\n         add_to_sysroot(&libdir, &librustc_stamp(build, compiler, target));\n     }\n@@ -128,16 +130,18 @@ impl Step for Test {\n         let target = self.target;\n         let compiler = builder.compiler(0, build.build);\n \n-        let _folder = build.fold_output(|| format!(\"stage{}-test\", compiler.stage));\n-        println!(\"Checking test artifacts ({} -> {})\", &compiler.host, target);\n         let out_dir = build.stage_out(compiler, Mode::Libtest);\n         build.clear_if_dirty(&out_dir, &libstd_stamp(build, compiler, target));\n         let mut cargo = builder.cargo(compiler, Mode::Libtest, target, \"check\");\n         test_cargo(build, &compiler, target, &mut cargo);\n+\n+        let _folder = build.fold_output(|| format!(\"stage{}-test\", compiler.stage));\n+        println!(\"Checking test artifacts ({} -> {})\", &compiler.host, target);\n         run_cargo(build,\n                   &mut cargo,\n                   &libtest_stamp(build, compiler, target),\n                   true);\n+\n         let libdir = builder.sysroot_libdir(compiler, target);\n         add_to_sysroot(&libdir, &libtest_stamp(build, compiler, target));\n     }"}, {"sha": "d697403180c18edcd1ce67d2e3c633dcd659cc66", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 14, "deletions": 13, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/6fd4d67819a6eb8273768b6c3789ca70582cd703/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fd4d67819a6eb8273768b6c3789ca70582cd703/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=6fd4d67819a6eb8273768b6c3789ca70582cd703", "patch": "@@ -93,10 +93,6 @@ impl Step for Std {\n             return;\n         }\n \n-        let _folder = build.fold_output(|| format!(\"stage{}-std\", compiler.stage));\n-        println!(\"Building stage{} std artifacts ({} -> {})\", compiler.stage,\n-                &compiler.host, target);\n-\n         if target.contains(\"musl\") {\n             let libdir = builder.sysroot_libdir(compiler, target);\n             copy_musl_third_party_objects(build, target, &libdir);\n@@ -106,6 +102,10 @@ impl Step for Std {\n         build.clear_if_dirty(&out_dir, &builder.rustc(compiler));\n         let mut cargo = builder.cargo(compiler, Mode::Libstd, target, \"build\");\n         std_cargo(builder, &compiler, target, &mut cargo);\n+\n+        let _folder = build.fold_output(|| format!(\"stage{}-std\", compiler.stage));\n+        println!(\"Building stage{} std artifacts ({} -> {})\", compiler.stage,\n+                &compiler.host, target);\n         run_cargo(build,\n                   &mut cargo,\n                   &libstd_stamp(build, compiler, target),\n@@ -360,13 +360,14 @@ impl Step for Test {\n             return;\n         }\n \n-        let _folder = build.fold_output(|| format!(\"stage{}-test\", compiler.stage));\n-        println!(\"Building stage{} test artifacts ({} -> {})\", compiler.stage,\n-                &compiler.host, target);\n         let out_dir = build.stage_out(compiler, Mode::Libtest);\n         build.clear_if_dirty(&out_dir, &libstd_stamp(build, compiler, target));\n         let mut cargo = builder.cargo(compiler, Mode::Libtest, target, \"build\");\n         test_cargo(build, &compiler, target, &mut cargo);\n+\n+        let _folder = build.fold_output(|| format!(\"stage{}-test\", compiler.stage));\n+        println!(\"Building stage{} test artifacts ({} -> {})\", compiler.stage,\n+                &compiler.host, target);\n         run_cargo(build,\n                   &mut cargo,\n                   &libtest_stamp(build, compiler, target),\n@@ -482,16 +483,16 @@ impl Step for Rustc {\n             target: build.build,\n         });\n \n-        let _folder = build.fold_output(|| format!(\"stage{}-rustc\", compiler.stage));\n-        println!(\"Building stage{} compiler artifacts ({} -> {})\",\n-                 compiler.stage, &compiler.host, target);\n-\n         let stage_out = builder.stage_out(compiler, Mode::Librustc);\n         build.clear_if_dirty(&stage_out, &libstd_stamp(build, compiler, target));\n         build.clear_if_dirty(&stage_out, &libtest_stamp(build, compiler, target));\n \n         let mut cargo = builder.cargo(compiler, Mode::Librustc, target, \"build\");\n         rustc_cargo(build, &mut cargo);\n+\n+        let _folder = build.fold_output(|| format!(\"stage{}-rustc\", compiler.stage));\n+        println!(\"Building stage{} compiler artifacts ({} -> {})\",\n+                 compiler.stage, &compiler.host, target);\n         run_cargo(build,\n                   &mut cargo,\n                   &librustc_stamp(build, compiler, target),\n@@ -634,8 +635,6 @@ impl Step for CodegenBackend {\n             .arg(build.src.join(\"src/librustc_trans/Cargo.toml\"));\n         rustc_cargo_env(build, &mut cargo);\n \n-        let _folder = build.fold_output(|| format!(\"stage{}-rustc_trans\", compiler.stage));\n-\n         match &*self.backend {\n             \"llvm\" | \"emscripten\" => {\n                 // Build LLVM for our target. This will implicitly build the\n@@ -685,6 +684,8 @@ impl Step for CodegenBackend {\n \n         let tmp_stamp = build.cargo_out(compiler, Mode::Librustc, target)\n             .join(\".tmp.stamp\");\n+\n+        let _folder = build.fold_output(|| format!(\"stage{}-rustc_trans\", compiler.stage));\n         let files = run_cargo(build,\n                               cargo.arg(\"--features\").arg(features),\n                               &tmp_stamp,"}, {"sha": "e129ae8c52105adaab4cf544ead53ea0b994ee88", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 28, "deletions": 27, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/6fd4d67819a6eb8273768b6c3789ca70582cd703/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fd4d67819a6eb8273768b6c3789ca70582cd703/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=6fd4d67819a6eb8273768b6c3789ca70582cd703", "patch": "@@ -530,8 +530,6 @@ impl Step for Tidy {\n     fn run(self, builder: &Builder) {\n         let build = builder.build;\n \n-        let _folder = build.fold_output(|| \"tidy\");\n-        println!(\"tidy check\");\n         let mut cmd = builder.tool_cmd(Tool::Tidy);\n         cmd.arg(build.src.join(\"src\"));\n         cmd.arg(&build.initial_cargo);\n@@ -541,6 +539,9 @@ impl Step for Tidy {\n         if build.config.quiet_tests {\n             cmd.arg(\"--quiet\");\n         }\n+\n+        let _folder = build.fold_output(|| \"tidy\");\n+        println!(\"tidy check\");\n         try_run(build, &mut cmd);\n     }\n \n@@ -836,9 +837,6 @@ impl Step for Compiletest {\n         builder.ensure(native::TestHelpers { target });\n         builder.ensure(RemoteCopyLibs { compiler, target });\n \n-        let _folder = build.fold_output(|| format!(\"test_{}\", suite));\n-        println!(\"Check compiletest suite={} mode={} ({} -> {})\",\n-                 suite, mode, &compiler.host, target);\n         let mut cmd = builder.tool_cmd(Tool::Compiletest);\n \n         // compiletest currently has... a lot of arguments, so let's just pass all\n@@ -998,6 +996,9 @@ impl Step for Compiletest {\n \n         build.ci_env.force_coloring_in_ci(&mut cmd);\n \n+        let _folder = build.fold_output(|| format!(\"test_{}\", suite));\n+        println!(\"Check compiletest suite={} mode={} ({} -> {})\",\n+                 suite, mode, &compiler.host, target);\n         let _time = util::timeit();\n         try_run(build, &mut cmd);\n     }\n@@ -1142,20 +1143,21 @@ impl Step for ErrorIndex {\n \n         builder.ensure(compile::Std { compiler, target: compiler.host });\n \n-        let _folder = build.fold_output(|| \"test_error_index\");\n-        println!(\"Testing error-index stage{}\", compiler.stage);\n-\n         let dir = testdir(build, compiler.host);\n         t!(fs::create_dir_all(&dir));\n         let output = dir.join(\"error-index.md\");\n \n-        let _time = util::timeit();\n-        build.run(builder.tool_cmd(Tool::ErrorIndex)\n-                    .arg(\"markdown\")\n-                    .arg(&output)\n-                    .env(\"CFG_BUILD\", &build.build)\n-                    .env(\"RUSTC_ERROR_METADATA_DST\", build.extended_error_dir()));\n+        let mut tool = builder.tool_cmd(Tool::ErrorIndex);\n+        tool.arg(\"markdown\")\n+            .arg(&output)\n+            .env(\"CFG_BUILD\", &build.build)\n+            .env(\"RUSTC_ERROR_METADATA_DST\", build.extended_error_dir());\n+\n \n+        let _folder = build.fold_output(|| \"test_error_index\");\n+        println!(\"Testing error-index stage{}\", compiler.stage);\n+        let _time = util::timeit();\n+        build.run(&mut tool);\n         markdown_test(builder, compiler, &output);\n     }\n }\n@@ -1400,11 +1402,6 @@ impl Step for Crate {\n             }\n             _ => panic!(\"can only test libraries\"),\n         };\n-        let _folder = build.fold_output(|| {\n-            format!(\"{}_stage{}-{}\", test_kind.subcommand(), compiler.stage, krate)\n-        });\n-        println!(\"{} {} stage{} ({} -> {})\", test_kind, krate, compiler.stage,\n-                &compiler.host, target);\n \n         // Build up the base `cargo test` command.\n         //\n@@ -1436,8 +1433,6 @@ impl Step for Crate {\n             cargo.arg(\"--quiet\");\n         }\n \n-        let _time = util::timeit();\n-\n         if target.contains(\"emscripten\") {\n             cargo.env(format!(\"CARGO_TARGET_{}_RUNNER\", envify(&target)),\n                       build.config.nodejs.as_ref().expect(\"nodejs not configured\"));\n@@ -1465,6 +1460,13 @@ impl Step for Crate {\n                       format!(\"{} run\",\n                               builder.tool_exe(Tool::RemoteTestClient).display()));\n         }\n+\n+        let _folder = build.fold_output(|| {\n+            format!(\"{}_stage{}-{}\", test_kind.subcommand(), compiler.stage, krate)\n+        });\n+        println!(\"{} {} stage{} ({} -> {})\", test_kind, krate, compiler.stage,\n+                &compiler.host, target);\n+        let _time = util::timeit();\n         try_run(build, &mut cargo);\n     }\n }\n@@ -1513,12 +1515,6 @@ impl Step for CrateRustdoc {\n                                                  target,\n                                                  test_kind.subcommand(),\n                                                  \"src/tools/rustdoc\");\n-        let _folder = build.fold_output(|| {\n-            format!(\"{}_stage{}-rustdoc\", test_kind.subcommand(), compiler.stage)\n-        });\n-        println!(\"{} rustdoc stage{} ({} -> {})\", test_kind, compiler.stage,\n-                &compiler.host, target);\n-\n         if test_kind.subcommand() == \"test\" && !build.fail_fast {\n             cargo.arg(\"--no-fail-fast\");\n         }\n@@ -1532,6 +1528,11 @@ impl Step for CrateRustdoc {\n             cargo.arg(\"--quiet\");\n         }\n \n+        let _folder = build.fold_output(|| {\n+            format!(\"{}_stage{}-rustdoc\", test_kind.subcommand(), compiler.stage)\n+        });\n+        println!(\"{} rustdoc stage{} ({} -> {})\", test_kind, compiler.stage,\n+                &compiler.host, target);\n         let _time = util::timeit();\n \n         try_run(build, &mut cargo);"}, {"sha": "d308cecb2752144e4bf8fc8872595c7c23ef3498", "filename": "src/bootstrap/tool.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/6fd4d67819a6eb8273768b6c3789ca70582cd703/src%2Fbootstrap%2Ftool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fd4d67819a6eb8273768b6c3789ca70582cd703/src%2Fbootstrap%2Ftool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftool.rs?ref=6fd4d67819a6eb8273768b6c3789ca70582cd703", "patch": "@@ -112,11 +112,11 @@ impl Step for ToolBuild {\n             Mode::Tool => panic!(\"unexpected Mode::Tool for tool build\")\n         }\n \n-        let _folder = build.fold_output(|| format!(\"stage{}-{}\", compiler.stage, tool));\n-        println!(\"Building stage{} tool {} ({})\", compiler.stage, tool, target);\n-\n         let mut cargo = prepare_tool_cargo(builder, compiler, target, \"build\", path);\n         cargo.arg(\"--features\").arg(self.extra_features.join(\" \"));\n+\n+        let _folder = build.fold_output(|| format!(\"stage{}-{}\", compiler.stage, tool));\n+        println!(\"Building stage{} tool {} ({})\", compiler.stage, tool, target);\n         let is_expected = build.try_run(&mut cargo);\n         build.save_toolstate(tool, if is_expected {\n             ToolState::TestFail\n@@ -339,9 +339,6 @@ impl Step for Rustdoc {\n \n         builder.ensure(compile::Rustc { compiler: build_compiler, target });\n \n-        let _folder = build.fold_output(|| format!(\"stage{}-rustdoc\", target_compiler.stage));\n-        println!(\"Building rustdoc for stage{} ({})\", target_compiler.stage, target_compiler.host);\n-\n         let mut cargo = prepare_tool_cargo(builder,\n                                            build_compiler,\n                                            target,\n@@ -352,7 +349,10 @@ impl Step for Rustdoc {\n         cargo.env(\"RUSTC_DEBUGINFO\", builder.config.rust_debuginfo.to_string())\n              .env(\"RUSTC_DEBUGINFO_LINES\", builder.config.rust_debuginfo_lines.to_string());\n \n+        let _folder = build.fold_output(|| format!(\"stage{}-rustdoc\", target_compiler.stage));\n+        println!(\"Building rustdoc for stage{} ({})\", target_compiler.stage, target_compiler.host);\n         build.run(&mut cargo);\n+\n         // Cargo adds a number of paths to the dylib search path on windows, which results in\n         // the wrong rustdoc being executed. To avoid the conflicting rustdocs, we name the \"tool\"\n         // rustdoc a different name."}]}