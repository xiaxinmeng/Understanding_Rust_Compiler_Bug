{"sha": "53196bb364426fb2b8db16f6748836779cd031c7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUzMTk2YmIzNjQ0MjZmYjJiOGRiMTZmNjc0ODgzNjc3OWNkMDMxYzc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-05-16T13:58:52Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-05-16T13:58:52Z"}, "message": "auto merge of #6530 : huonw/rust/deriving-deepclone, r=bstrie", "tree": {"sha": "f41ac73b63fe90b628884b5f919fbf4841c3f3a0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f41ac73b63fe90b628884b5f919fbf4841c3f3a0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/53196bb364426fb2b8db16f6748836779cd031c7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/53196bb364426fb2b8db16f6748836779cd031c7", "html_url": "https://github.com/rust-lang/rust/commit/53196bb364426fb2b8db16f6748836779cd031c7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/53196bb364426fb2b8db16f6748836779cd031c7/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f19883223cbf72ec28b503cae71f823fc2229708", "url": "https://api.github.com/repos/rust-lang/rust/commits/f19883223cbf72ec28b503cae71f823fc2229708", "html_url": "https://github.com/rust-lang/rust/commit/f19883223cbf72ec28b503cae71f823fc2229708"}, {"sha": "47c9157d872fed7a7ef422efe7176f8a29b949d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/47c9157d872fed7a7ef422efe7176f8a29b949d8", "html_url": "https://github.com/rust-lang/rust/commit/47c9157d872fed7a7ef422efe7176f8a29b949d8"}], "stats": {"total": 114, "additions": 95, "deletions": 19}, "files": [{"sha": "9839e9e8afd744b5d60412814cef335e209f5086", "filename": "doc/rust.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/53196bb364426fb2b8db16f6748836779cd031c7/doc%2Frust.md", "raw_url": "https://github.com/rust-lang/rust/raw/53196bb364426fb2b8db16f6748836779cd031c7/doc%2Frust.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/doc%2Frust.md?ref=53196bb364426fb2b8db16f6748836779cd031c7", "patch": "@@ -1562,7 +1562,7 @@ Supported traits for `deriving` are:\n \n * Comparison traits: `Eq`, `TotalEq`, `Ord`, `TotalOrd`.\n * Serialization: `Encodable`, `Decodable`. These require `std`.\n-* `Clone`, to perform deep copies.\n+* `Clone` and `DeepClone`, to perform (deep) copies.\n * `IterBytes`, to iterate over the bytes in a data type.\n * `Rand`, to create a random instance of a data type.\n * `ToStr`, to convert to a string. For a type with this instance,"}, {"sha": "a01423d3fd3fcca7950cbc1676bfae142a25902b", "filename": "doc/tutorial.md", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/53196bb364426fb2b8db16f6748836779cd031c7/doc%2Ftutorial.md", "raw_url": "https://github.com/rust-lang/rust/raw/53196bb364426fb2b8db16f6748836779cd031c7/doc%2Ftutorial.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/doc%2Ftutorial.md?ref=53196bb364426fb2b8db16f6748836779cd031c7", "patch": "@@ -2308,8 +2308,8 @@ enum ABC { A, B, C }\n ~~~\n \n The full list of derivable traits is `Eq`, `TotalEq`, `Ord`,\n-`TotalOrd`, `Encodable` `Decodable`, `Clone`, `IterBytes`, `Rand` and\n-`ToStr`.\n+`TotalOrd`, `Encodable` `Decodable`, `Clone`, `DeepClone`,\n+`IterBytes`, `Rand` and `ToStr`.\n \n # Modules and crates\n "}, {"sha": "aceb60ebbd7d6fb19c8574fc6de99f6b6afb90b0", "filename": "src/libsyntax/ext/deriving/clone.rs", "status": "modified", "additions": 42, "deletions": 7, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/53196bb364426fb2b8db16f6748836779cd031c7/src%2Flibsyntax%2Fext%2Fderiving%2Fclone.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53196bb364426fb2b8db16f6748836779cd031c7/src%2Flibsyntax%2Fext%2Fderiving%2Fclone.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fderiving%2Fclone.rs?ref=53196bb364426fb2b8db16f6748836779cd031c7", "patch": "@@ -32,7 +32,7 @@ pub fn expand_deriving_clone(cx: @ext_ctxt,\n                 args: ~[],\n                 ret_ty: Self,\n                 const_nonmatching: false,\n-                combine_substructure: cs_clone\n+                combine_substructure: |c, s, sub| cs_clone(\"Clone\", c, s, sub)\n             }\n         ]\n     };\n@@ -42,8 +42,39 @@ pub fn expand_deriving_clone(cx: @ext_ctxt,\n                             &trait_def)\n }\n \n-fn cs_clone(cx: @ext_ctxt, span: span,\n-            substr: &Substructure) -> @expr {\n+pub fn expand_deriving_deep_clone(cx: @ext_ctxt,\n+                                 span: span,\n+                                 mitem: @meta_item,\n+                                 in_items: ~[@item])\n+    -> ~[@item] {\n+    let trait_def = TraitDef {\n+        path: Path::new(~[~\"core\", ~\"clone\", ~\"DeepClone\"]),\n+        additional_bounds: ~[],\n+        generics: LifetimeBounds::empty(),\n+        methods: ~[\n+            MethodDef {\n+                name: ~\"deep_clone\",\n+                generics: LifetimeBounds::empty(),\n+                explicit_self: borrowed_explicit_self(),\n+                args: ~[],\n+                ret_ty: Self,\n+                const_nonmatching: false,\n+                // cs_clone uses the ident passed to it, i.e. it will\n+                // call deep_clone (not clone) here.\n+                combine_substructure: |c, s, sub| cs_clone(\"DeepClone\", c, s, sub)\n+            }\n+        ]\n+    };\n+\n+    expand_deriving_generic(cx, span,\n+                            mitem, in_items,\n+                            &trait_def)\n+}\n+\n+fn cs_clone(\n+    name: &str,\n+    cx: @ext_ctxt, span: span,\n+    substr: &Substructure) -> @expr {\n     let clone_ident = substr.method_ident;\n     let ctor_ident;\n     let all_fields;\n@@ -59,8 +90,12 @@ fn cs_clone(cx: @ext_ctxt, span: span,\n             ctor_ident = ~[ variant.node.name ];\n             all_fields = af;\n         },\n-        EnumNonMatching(*) => cx.span_bug(span, \"Non-matching enum variants in `deriving(Clone)`\"),\n-        StaticEnum(*) | StaticStruct(*) => cx.span_bug(span, \"Static method in `deriving(Clone)`\")\n+        EnumNonMatching(*) => cx.span_bug(span,\n+                                          fmt!(\"Non-matching enum variants in `deriving(%s)`\",\n+                                               name)),\n+        StaticEnum(*) | StaticStruct(*) => cx.span_bug(span,\n+                                                       fmt!(\"Static method in `deriving(%s)`\",\n+                                                            name))\n     }\n \n     match *all_fields {\n@@ -75,8 +110,8 @@ fn cs_clone(cx: @ext_ctxt, span: span,\n                 let ident = match o_id {\n                     Some(i) => i,\n                     None => cx.span_bug(span,\n-                                        ~\"unnamed field in normal struct \\\n-                                          in `deriving(Clone)`\")\n+                                        fmt!(\"unnamed field in normal struct in `deriving(%s)`\",\n+                                             name))\n                 };\n                 build::Field { ident: ident, ex: subcall(self_f) }\n             };"}, {"sha": "78cd5cdb423d9edae4348238a41d90b4c3b3b4a7", "filename": "src/libsyntax/ext/deriving/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/53196bb364426fb2b8db16f6748836779cd031c7/src%2Flibsyntax%2Fext%2Fderiving%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53196bb364426fb2b8db16f6748836779cd031c7/src%2Flibsyntax%2Fext%2Fderiving%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fderiving%2Fmod.rs?ref=53196bb364426fb2b8db16f6748836779cd031c7", "patch": "@@ -84,6 +84,7 @@ pub fn expand_meta_deriving(cx: @ext_ctxt,\n                                                                    titem, in_items)));\n                         match *tname {\n                             ~\"Clone\" => expand!(clone::expand_deriving_clone),\n+                            ~\"DeepClone\" => expand!(clone::expand_deriving_deep_clone),\n \n                             ~\"IterBytes\" => expand!(iter_bytes::expand_deriving_iter_bytes),\n "}, {"sha": "9ce965aa49f26cab0dda32c2ed38512820927722", "filename": "src/test/run-pass/deriving-clone-enum.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/53196bb364426fb2b8db16f6748836779cd031c7/src%2Ftest%2Frun-pass%2Fderiving-clone-enum.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53196bb364426fb2b8db16f6748836779cd031c7/src%2Ftest%2Frun-pass%2Fderiving-clone-enum.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fderiving-clone-enum.rs?ref=53196bb364426fb2b8db16f6748836779cd031c7", "patch": "@@ -8,11 +8,14 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-#[deriving(Clone)]\n+#[deriving(Clone, DeepClone)]\n enum E {\n     A,\n     B(()),\n     C\n }\n \n-pub fn main() {}\n+pub fn main() {\n+    let _ = A.clone();\n+    let _ = B(()).deep_clone();\n+}"}, {"sha": "78abbf504f36690a85b6403aaeb36c70dff81cbb", "filename": "src/test/run-pass/deriving-clone-generic-enum.rs", "status": "modified", "additions": 15, "deletions": 2, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/53196bb364426fb2b8db16f6748836779cd031c7/src%2Ftest%2Frun-pass%2Fderiving-clone-generic-enum.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53196bb364426fb2b8db16f6748836779cd031c7/src%2Ftest%2Frun-pass%2Fderiving-clone-generic-enum.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fderiving-clone-generic-enum.rs?ref=53196bb364426fb2b8db16f6748836779cd031c7", "patch": "@@ -1,8 +1,21 @@\n-#[deriving(Clone)]\n+// Copyright 2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[deriving(Clone, DeepClone)]\n enum E<T,U> {\n     A(T),\n     B(T,U),\n     C\n }\n \n-fn main() {}\n+fn main() {\n+    let _ = A::<int, int>(1i).clone();\n+    let _ = B(1i, 1.234).deep_clone();\n+}"}, {"sha": "fd300cbc8b74b9eafff402efadbe542e8ccef0eb", "filename": "src/test/run-pass/deriving-clone-generic-struct.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/53196bb364426fb2b8db16f6748836779cd031c7/src%2Ftest%2Frun-pass%2Fderiving-clone-generic-struct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53196bb364426fb2b8db16f6748836779cd031c7/src%2Ftest%2Frun-pass%2Fderiving-clone-generic-struct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fderiving-clone-generic-struct.rs?ref=53196bb364426fb2b8db16f6748836779cd031c7", "patch": "@@ -8,11 +8,13 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-#[deriving(Clone)]\n+#[deriving(Clone, DeepClone)]\n struct S<T> {\n     foo: (),\n     bar: (),\n     baz: T,\n }\n \n-pub fn main() {}\n+pub fn main() {\n+    let _ = S { foo: (), bar: (), baz: 1i }.clone().deep_clone();\n+}"}, {"sha": "c082a11eab84c859064c324a0d26fc137168a4f8", "filename": "src/test/run-pass/deriving-clone-generic-tuple-struct.rs", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/53196bb364426fb2b8db16f6748836779cd031c7/src%2Ftest%2Frun-pass%2Fderiving-clone-generic-tuple-struct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53196bb364426fb2b8db16f6748836779cd031c7/src%2Ftest%2Frun-pass%2Fderiving-clone-generic-tuple-struct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fderiving-clone-generic-tuple-struct.rs?ref=53196bb364426fb2b8db16f6748836779cd031c7", "patch": "@@ -1,4 +1,16 @@\n-#[deriving(Clone)]\n+// Copyright 2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[deriving(Clone, DeepClone)]\n struct S<T>(T, ());\n \n-fn main() {}\n+fn main() {\n+    let _ = S(1i, ()).clone().deep_clone();\n+}"}, {"sha": "d540b047af7f397c076b0750bd0dba8cae70aca1", "filename": "src/test/run-pass/deriving-clone-struct.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/53196bb364426fb2b8db16f6748836779cd031c7/src%2Ftest%2Frun-pass%2Fderiving-clone-struct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53196bb364426fb2b8db16f6748836779cd031c7/src%2Ftest%2Frun-pass%2Fderiving-clone-struct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fderiving-clone-struct.rs?ref=53196bb364426fb2b8db16f6748836779cd031c7", "patch": "@@ -1,4 +1,14 @@\n-#[deriving(Clone)]\n+// Copyright 2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[deriving(Clone, DeepClone)]\n struct S {\n     _int: int,\n     _i8: i8,"}]}