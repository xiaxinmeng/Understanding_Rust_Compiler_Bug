{"sha": "5914f86d473f34e0fa78dc150024b07bd26a2db9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU5MTRmODZkNDczZjM0ZTBmYTc4ZGMxNTAwMjRiMDdiZDI2YTJkYjk=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-02-02T17:02:12Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-02-02T17:02:12Z"}, "message": "Fix resolution of `crate` paths from within blocks\n\nThey resolve to the crate root, not the DefMap's root module (which\ncan be a block)", "tree": {"sha": "c8c20aff862d670f1baebd33d95e645a1281ca7f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c8c20aff862d670f1baebd33d95e645a1281ca7f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5914f86d473f34e0fa78dc150024b07bd26a2db9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5914f86d473f34e0fa78dc150024b07bd26a2db9", "html_url": "https://github.com/rust-lang/rust/commit/5914f86d473f34e0fa78dc150024b07bd26a2db9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5914f86d473f34e0fa78dc150024b07bd26a2db9/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "12e8cc4aa29f616e43b4951e18b1f1f231e539a3", "url": "https://api.github.com/repos/rust-lang/rust/commits/12e8cc4aa29f616e43b4951e18b1f1f231e539a3", "html_url": "https://github.com/rust-lang/rust/commit/12e8cc4aa29f616e43b4951e18b1f1f231e539a3"}], "stats": {"total": 9, "additions": 7, "deletions": 2}, "files": [{"sha": "0a15fc4704076c6bf346c87dcb359d01d66a0e65", "filename": "crates/hir_def/src/nameres.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5914f86d473f34e0fa78dc150024b07bd26a2db9/crates%2Fhir_def%2Fsrc%2Fnameres.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5914f86d473f34e0fa78dc150024b07bd26a2db9/crates%2Fhir_def%2Fsrc%2Fnameres.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres.rs?ref=5914f86d473f34e0fa78dc150024b07bd26a2db9", "patch": "@@ -275,6 +275,11 @@ impl DefMap {\n         ModuleId { krate: self.krate, local_id, block }\n     }\n \n+    pub(crate) fn crate_root(&self) -> ModuleId {\n+        let (root_map, _) = self.ancestor_maps(self.root).last().unwrap();\n+        root_map.module_id(root_map.root)\n+    }\n+\n     pub(crate) fn resolve_path(\n         &self,\n         db: &dyn DefDatabase,"}, {"sha": "ecf75c777cff129e1fe943e4d9351fd187713706", "filename": "crates/hir_def/src/nameres/path_resolution.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5914f86d473f34e0fa78dc150024b07bd26a2db9/crates%2Fhir_def%2Fsrc%2Fnameres%2Fpath_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5914f86d473f34e0fa78dc150024b07bd26a2db9/crates%2Fhir_def%2Fsrc%2Fnameres%2Fpath_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fpath_resolution.rs?ref=5914f86d473f34e0fa78dc150024b07bd26a2db9", "patch": "@@ -152,15 +152,15 @@ impl DefMap {\n             PathKind::DollarCrate(krate) => {\n                 if krate == self.krate {\n                     mark::hit!(macro_dollar_crate_self);\n-                    PerNs::types(self.module_id(self.root).into(), Visibility::Public)\n+                    PerNs::types(self.crate_root().into(), Visibility::Public)\n                 } else {\n                     let def_map = db.crate_def_map(krate);\n                     let module = def_map.module_id(def_map.root);\n                     mark::hit!(macro_dollar_crate_other);\n                     PerNs::types(module.into(), Visibility::Public)\n                 }\n             }\n-            PathKind::Crate => PerNs::types(self.module_id(self.root).into(), Visibility::Public),\n+            PathKind::Crate => PerNs::types(self.crate_root().into(), Visibility::Public),\n             // plain import or absolute path in 2015: crate-relative with\n             // fallback to extern prelude (with the simplification in\n             // rust-lang/rust#57745)"}]}