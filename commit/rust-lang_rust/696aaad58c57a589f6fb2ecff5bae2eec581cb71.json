{"sha": "696aaad58c57a589f6fb2ecff5bae2eec581cb71", "node_id": "C_kwDOAAsO6NoAKDY5NmFhYWQ1OGM1N2E1ODlmNmZiMmVjZmY1YmFlMmVlYzU4MWNiNzE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-09T20:57:06Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-09T20:57:06Z"}, "message": "Auto merge of #109760 - MaciejWas:struct-tuple-field-names-suggestion, r=jackh726\n\nBetter diagnostic when pattern matching tuple structs\n\nFixes #108284\n\nWhen trying to pattern match a tuple struct we might get a flawed error message if there are missing fields. E.g.\n\n```\nlet x = Foo(100, 200);\nif let Foo { 0: bar } = x { ... }\n```\n\nProduces this error:\n\n```\nerror[E0769]: tuple variant `Foo` written as struct variant\n --> hello.rs:5:12\n  |\n5 |     if let Foo { 0: foo } = x {\n  |            ^^^^^^^^^^^^^^\n  |\nhelp: use the tuple variant pattern syntax instead\n  |\n5 |     if let Foo(_, _) = x {\n  |               ~~~~~~\n```\n\nWhich doesn't highlight that we can still use the struct syntax but we need to fill missing fields. This pr changes this error to:\n\n```\nerror[E0027]: pattern does not mention field `1`\n --> hello.rs:5:12\n  |\n5 |     if let Foo { 0: foo } = x {\n  |            ^^^^^^^^^^^^^^ missing field `1`\n  |\nhelp: include the missing field in the pattern\n  |\n5 |     if let Foo { 0: foo, 1: _ } = x {\n  |                        ~~~~~~~~\nhelp: if you don't care about this missing field, you can explicitly ignore it\n  |\n5 |     if let Foo { 0: foo, .. } = x {\n  |                        ~~~~~~\n```", "tree": {"sha": "e7e3dba6b267106715eac55d28834b6dec753cc8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e7e3dba6b267106715eac55d28834b6dec753cc8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/696aaad58c57a589f6fb2ecff5bae2eec581cb71", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/696aaad58c57a589f6fb2ecff5bae2eec581cb71", "html_url": "https://github.com/rust-lang/rust/commit/696aaad58c57a589f6fb2ecff5bae2eec581cb71", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/696aaad58c57a589f6fb2ecff5bae2eec581cb71/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "39bf7777aab9ac1f6b0802cd52cd91d6e021aa91", "url": "https://api.github.com/repos/rust-lang/rust/commits/39bf7777aab9ac1f6b0802cd52cd91d6e021aa91", "html_url": "https://github.com/rust-lang/rust/commit/39bf7777aab9ac1f6b0802cd52cd91d6e021aa91"}, {"sha": "3b38dd91126a647334af07d772ad809422918e5a", "url": "https://api.github.com/repos/rust-lang/rust/commits/3b38dd91126a647334af07d772ad809422918e5a", "html_url": "https://github.com/rust-lang/rust/commit/3b38dd91126a647334af07d772ad809422918e5a"}], "stats": {"total": 46, "additions": 42, "deletions": 4}, "files": [{"sha": "af0bd26dec5f91983a811c2735b41e07d7be92f5", "filename": "compiler/rustc_hir_typeck/src/pat.rs", "status": "modified", "additions": 21, "deletions": 2, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/696aaad58c57a589f6fb2ecff5bae2eec581cb71/compiler%2Frustc_hir_typeck%2Fsrc%2Fpat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/696aaad58c57a589f6fb2ecff5bae2eec581cb71/compiler%2Frustc_hir_typeck%2Fsrc%2Fpat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fpat.rs?ref=696aaad58c57a589f6fb2ecff5bae2eec581cb71", "patch": "@@ -37,6 +37,10 @@ pointers. If you encounter this error you should try to avoid dereferencing the\n You can read more about trait objects in the Trait Objects section of the Reference: \\\n https://doc.rust-lang.org/reference/types.html#trait-objects\";\n \n+fn is_number(text: &str) -> bool {\n+    text.chars().all(|c: char| c.is_digit(10))\n+}\n+\n /// Information about the expected type at the top level of type checking a pattern.\n ///\n /// **NOTE:** This is only for use by diagnostics. Do NOT use for type checking logic!\n@@ -1673,7 +1677,15 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         fields: &'tcx [hir::PatField<'tcx>],\n         variant: &ty::VariantDef,\n     ) -> Option<DiagnosticBuilder<'tcx, ErrorGuaranteed>> {\n-        if let (Some(CtorKind::Fn), PatKind::Struct(qpath, ..)) = (variant.ctor_kind(), &pat.kind) {\n+        if let (Some(CtorKind::Fn), PatKind::Struct(qpath, pattern_fields, ..)) =\n+            (variant.ctor_kind(), &pat.kind)\n+        {\n+            let is_tuple_struct_match = !pattern_fields.is_empty()\n+                && pattern_fields.iter().map(|field| field.ident.name.as_str()).all(is_number);\n+            if is_tuple_struct_match {\n+                return None;\n+            }\n+\n             let path = rustc_hir_pretty::to_string(rustc_hir_pretty::NO_ANN, |s| {\n                 s.print_qpath(qpath, false)\n             });\n@@ -1895,7 +1907,14 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 prefix,\n                 unmentioned_fields\n                     .iter()\n-                    .map(|(_, name)| name.to_string())\n+                    .map(|(_, name)| {\n+                        let field_name = name.to_string();\n+                        if is_number(&field_name) {\n+                            format!(\"{}: _\", field_name)\n+                        } else {\n+                            field_name\n+                        }\n+                    })\n                     .collect::<Vec<_>>()\n                     .join(\", \"),\n                 if have_inaccessible_fields { \", ..\" } else { \"\" },"}, {"sha": "33f264aa25091739096eaddeafd24349cacf58c9", "filename": "tests/ui/structs/struct-tuple-field-names.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/696aaad58c57a589f6fb2ecff5bae2eec581cb71/tests%2Fui%2Fstructs%2Fstruct-tuple-field-names.rs", "raw_url": "https://github.com/rust-lang/rust/raw/696aaad58c57a589f6fb2ecff5bae2eec581cb71/tests%2Fui%2Fstructs%2Fstruct-tuple-field-names.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fstructs%2Fstruct-tuple-field-names.rs?ref=696aaad58c57a589f6fb2ecff5bae2eec581cb71", "patch": "@@ -12,4 +12,7 @@ fn main() {\n     match y {\n         S { } => {} //~ ERROR: tuple variant `S` written as struct variant [E0769]\n     }\n+\n+    if let E::S { 0: a } = x { //~ ERROR: pattern does not mention field `1`\n+    }\n }"}, {"sha": "0b837a47a82542d278e640b61333c6fa71c51500", "filename": "tests/ui/structs/struct-tuple-field-names.stderr", "status": "modified", "additions": 18, "deletions": 2, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/696aaad58c57a589f6fb2ecff5bae2eec581cb71/tests%2Fui%2Fstructs%2Fstruct-tuple-field-names.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/696aaad58c57a589f6fb2ecff5bae2eec581cb71/tests%2Fui%2Fstructs%2Fstruct-tuple-field-names.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fstructs%2Fstruct-tuple-field-names.stderr?ref=696aaad58c57a589f6fb2ecff5bae2eec581cb71", "patch": "@@ -20,6 +20,22 @@ help: use the tuple variant pattern syntax instead\n LL |         S(_, _) => {}\n    |          ~~~~~~\n \n-error: aborting due to 2 previous errors\n+error[E0027]: pattern does not mention field `1`\n+  --> $DIR/struct-tuple-field-names.rs:16:12\n+   |\n+LL |     if let E::S { 0: a } = x {\n+   |            ^^^^^^^^^^^^^ missing field `1`\n+   |\n+help: include the missing field in the pattern\n+   |\n+LL |     if let E::S { 0: a, 1: _ } = x {\n+   |                       ~~~~~~~~\n+help: if you don't care about this missing field, you can explicitly ignore it\n+   |\n+LL |     if let E::S { 0: a, .. } = x {\n+   |                       ~~~~~~\n+\n+error: aborting due to 3 previous errors\n \n-For more information about this error, try `rustc --explain E0769`.\n+Some errors have detailed explanations: E0027, E0769.\n+For more information about an error, try `rustc --explain E0027`."}]}