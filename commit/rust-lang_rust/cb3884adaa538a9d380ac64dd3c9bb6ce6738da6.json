{"sha": "cb3884adaa538a9d380ac64dd3c9bb6ce6738da6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNiMzg4NGFkYWE1MzhhOWQzODBhYzY0ZGQzYzliYjZjZTY3MzhkYTY=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-01-29T00:34:43Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-01-29T00:34:43Z"}, "message": "Rollup merge of #68289 - pnkfelix:issue-62649-dont-ice-on-path-collision-in-dep-graph, r=michaelwoerister\n\nDon't ICE on path-collision in dep-graph\n\nCollisions in the dep-graph due to path-reuse are rare but can occur.\n\nSo, instead of ICE'ing, just fail to mark green in such cases (for `DepKind::{Hir, HirBody, CrateMetadata}`).\n\nFix #62649.", "tree": {"sha": "fa27a4039a8a185b3ce23bcd596a2660481707e5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fa27a4039a8a185b3ce23bcd596a2660481707e5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cb3884adaa538a9d380ac64dd3c9bb6ce6738da6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeMNMkCRBK7hj4Ov3rIwAAdHIIABPZ0wQpNuPS0XEZlxXCSl+a\n+rm2cIGWbu1xXSLaHIuz+vvOzb+41M8dZjGYdMvrO3pIqTLUr6NtzKHqP8fANc3L\nTBJn0mLaSt1aYMqNHNoGR17wopGg21KXyaxAqwHI7v6UBFbtRxJppp5kAZXG02tM\nJxxDiuo47UldAq3Cy0LOB3r81V5gaQXqwX29/ywzN213AuZoPnvmc1U097pbOxaF\nRI9zsySH9f8pWcJ+ZkVOCCRTgY5s7f3APpgrt/iGd5mPO3GWxYHTP+7YBExBCMzF\n//gWaqg+sUfgYwQqgsC6pW7QYJ5QyphBWIi8aVGwt9xF6oM669bGl0TKeHHlNfs=\n=Gw6P\n-----END PGP SIGNATURE-----\n", "payload": "tree fa27a4039a8a185b3ce23bcd596a2660481707e5\nparent 3761dcd3467441f78939ccb3b341b03b6a7558d7\nparent 6f4b904aa999aded3b1ee317146387a8686715e3\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1580258083 +0900\ncommitter GitHub <noreply@github.com> 1580258083 +0900\n\nRollup merge of #68289 - pnkfelix:issue-62649-dont-ice-on-path-collision-in-dep-graph, r=michaelwoerister\n\nDon't ICE on path-collision in dep-graph\n\nCollisions in the dep-graph due to path-reuse are rare but can occur.\n\nSo, instead of ICE'ing, just fail to mark green in such cases (for `DepKind::{Hir, HirBody, CrateMetadata}`).\n\nFix #62649.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cb3884adaa538a9d380ac64dd3c9bb6ce6738da6", "html_url": "https://github.com/rust-lang/rust/commit/cb3884adaa538a9d380ac64dd3c9bb6ce6738da6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cb3884adaa538a9d380ac64dd3c9bb6ce6738da6/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3761dcd3467441f78939ccb3b341b03b6a7558d7", "url": "https://api.github.com/repos/rust-lang/rust/commits/3761dcd3467441f78939ccb3b341b03b6a7558d7", "html_url": "https://github.com/rust-lang/rust/commit/3761dcd3467441f78939ccb3b341b03b6a7558d7"}, {"sha": "6f4b904aa999aded3b1ee317146387a8686715e3", "url": "https://api.github.com/repos/rust-lang/rust/commits/6f4b904aa999aded3b1ee317146387a8686715e3", "html_url": "https://github.com/rust-lang/rust/commit/6f4b904aa999aded3b1ee317146387a8686715e3"}], "stats": {"total": 52, "additions": 43, "deletions": 9}, "files": [{"sha": "258723bb39d837308413b5c1c21a97d4b0ef3639", "filename": "src/librustc/dep_graph/graph.rs", "status": "modified", "additions": 30, "deletions": 9, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/cb3884adaa538a9d380ac64dd3c9bb6ce6738da6/src%2Flibrustc%2Fdep_graph%2Fgraph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb3884adaa538a9d380ac64dd3c9bb6ce6738da6/src%2Flibrustc%2Fdep_graph%2Fgraph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdep_graph%2Fgraph.rs?ref=cb3884adaa538a9d380ac64dd3c9bb6ce6738da6", "patch": "@@ -6,6 +6,7 @@ use rustc_data_structures::sharded::{self, Sharded};\n use rustc_data_structures::stable_hasher::{HashStable, StableHasher};\n use rustc_data_structures::sync::{AtomicU32, AtomicU64, Lock, Lrc, Ordering};\n use rustc_errors::Diagnostic;\n+use rustc_hir::def_id::DefId;\n use rustc_index::vec::{Idx, IndexVec};\n use smallvec::SmallVec;\n use std::collections::hash_map::Entry;\n@@ -677,18 +678,33 @@ impl DepGraph {\n                     } else {\n                         match dep_dep_node.kind {\n                             DepKind::Hir | DepKind::HirBody | DepKind::CrateMetadata => {\n-                                if dep_dep_node.extract_def_id(tcx).is_none() {\n+                                if let Some(def_id) = dep_dep_node.extract_def_id(tcx) {\n+                                    if def_id_corresponds_to_hir_dep_node(tcx, def_id) {\n+                                        // The `DefPath` has corresponding node,\n+                                        // and that node should have been marked\n+                                        // either red or green in `data.colors`.\n+                                        bug!(\n+                                            \"DepNode {:?} should have been \\\n+                                             pre-marked as red or green but wasn't.\",\n+                                            dep_dep_node\n+                                        );\n+                                    } else {\n+                                        // This `DefPath` does not have a\n+                                        // corresponding `DepNode` (e.g. a\n+                                        // struct field), and the ` DefPath`\n+                                        // collided with the `DefPath` of a\n+                                        // proper item that existed in the\n+                                        // previous compilation session.\n+                                        //\n+                                        // Since the given `DefPath` does not\n+                                        // denote the item that previously\n+                                        // existed, we just fail to mark green.\n+                                        return None;\n+                                    }\n+                                } else {\n                                     // If the node does not exist anymore, we\n                                     // just fail to mark green.\n                                     return None;\n-                                } else {\n-                                    // If the node does exist, it should have\n-                                    // been pre-allocated.\n-                                    bug!(\n-                                        \"DepNode {:?} should have been \\\n-                                          pre-allocated but wasn't.\",\n-                                        dep_dep_node\n-                                    )\n                                 }\n                             }\n                             _ => {\n@@ -899,6 +915,11 @@ impl DepGraph {\n     }\n }\n \n+fn def_id_corresponds_to_hir_dep_node(tcx: TyCtxt<'_>, def_id: DefId) -> bool {\n+    let hir_id = tcx.hir().as_local_hir_id(def_id).unwrap();\n+    def_id.index == hir_id.owner\n+}\n+\n /// A \"work product\" is an intermediate result that we save into the\n /// incremental directory for later re-use. The primary example are\n /// the object files that we save for each partition at code"}, {"sha": "ee81be76bafe340b041b2fb545b57cf5067a7127", "filename": "src/test/incremental/issue-62649-path-collisions-happen.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/cb3884adaa538a9d380ac64dd3c9bb6ce6738da6/src%2Ftest%2Fincremental%2Fissue-62649-path-collisions-happen.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb3884adaa538a9d380ac64dd3c9bb6ce6738da6/src%2Ftest%2Fincremental%2Fissue-62649-path-collisions-happen.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fissue-62649-path-collisions-happen.rs?ref=cb3884adaa538a9d380ac64dd3c9bb6ce6738da6", "patch": "@@ -0,0 +1,13 @@\n+// revisions: rpass1 rpass2\n+\n+#[cfg(rpass1)]\n+pub trait Something {\n+    fn foo();\n+}\n+\n+#[cfg(rpass2)]\n+pub struct Something {\n+    pub foo: u8,\n+}\n+\n+fn main() {}"}]}