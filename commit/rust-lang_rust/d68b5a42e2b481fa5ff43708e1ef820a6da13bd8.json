{"sha": "d68b5a42e2b481fa5ff43708e1ef820a6da13bd8", "node_id": "C_kwDOAAsO6NoAKGQ2OGI1YTQyZTJiNDgxZmE1ZmY0MzcwOGUxZWY4MjBhNmRhMTNiZDg", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2023-01-27T03:57:56Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-01-27T03:57:56Z"}, "message": "Rollup merge of #107284 - notriddle:notriddle/plus, r=jsha\n\nrustdoc: use smarter encoding for playground URL\n\nThe old way would compress okay with DEFLATE, but this version makes uncompressed docs smaller, which matters for memory usage and stuff like `cargo doc`.\n\nTry it out: <https://play.rust-lang.org/?code=fn+main()+{%0Alet+mut+v+=+Vec::new();%0Av.push(1+/+1);%0Aprintln!(%22{}%22,+v[0]);%0A}>\n\nIn local testing, this change shrinks sample pages by anywhere between 4.0% and 0.031%\n\n    $ du -b after.dir/std/vec/struct.Vec.html before.dir/std/vec/struct.Vec.html\n    759235  after.dir/std/vec/struct.Vec.html\n    781842  before.dir/std/vec/struct.Vec.html\n\n100*((759235-781842)/781842)=-2.8\n\n    $ du -b after.dir/std/num/struct.Wrapping.html before.dir/std/num/struct.Wrapping.html\n    3194173 after.dir/std/num/struct.Wrapping.html\n    3204351 before.dir/std/num/struct.Wrapping.html\n\n100*((3194173-3204351)/3204351)=-0.031\n\n    $ du -b after.dir/std/keyword.match.html before.dir/std/keyword.match.html\n    8151    after.dir/std/keyword.match.html\n    8495    before.dir/std/keyword.match.html\n\n100*((8151-8495)/8495)=-4.0\n\nGzipped tarball sizes seem shrunk, but not by much.\n\n    du -s before.tar.gz after.tar.gz\n    69600   before.tar.gz\n    69480   after.tar.gz\n\n100*((69480-69600)/69600)=-0.17", "tree": {"sha": "2f228a68944cc40176ce53404d624a9e1664618c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2f228a68944cc40176ce53404d624a9e1664618c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d68b5a42e2b481fa5ff43708e1ef820a6da13bd8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj00vECRBK7hj4Ov3rIwAAh5MIABx7jfalV+Ugh2Joag35KkUv\nCnTPWMU9O5kDiyAyhYHKn3YZxMWNzsvEzvmqTGFnq83kgaMQqJ2tbuRIN7YziUkB\noCG0TWg5/Sh03s0X03xfpXC4OdJvqcThkD9sSYD24WvFBXQdQMcoLAheZ4BbmyUD\noJMRVAXaFZRBh1qQawc7t9bLgeyHjwdgX2Osf/mwkCkthD1vf42Cn+W7aUbweAja\nHxW4akTfsFVw3aga1GBp5Y1hdb91WoB2di8yA6AxwSUk81XponpCFIaz6WCcEdHU\nHFk58xR737mO/RoPoBbsc4fE3vDIOqpfS+tOv4M52oMTH3/r9gbDOfBimAAE6io=\n=t9Zf\n-----END PGP SIGNATURE-----\n", "payload": "tree 2f228a68944cc40176ce53404d624a9e1664618c\nparent 5683915ca44f17e95d5049b943babbfdbca53961\nparent 51df99f3c2bac3ee7158b115ff6d54b687d018e1\nauthor Yuki Okushi <jtitor@2k36.org> 1674791876 +0900\ncommitter GitHub <noreply@github.com> 1674791876 +0900\n\nRollup merge of #107284 - notriddle:notriddle/plus, r=jsha\n\nrustdoc: use smarter encoding for playground URL\n\nThe old way would compress okay with DEFLATE, but this version makes uncompressed docs smaller, which matters for memory usage and stuff like `cargo doc`.\n\nTry it out: <https://play.rust-lang.org/?code=fn+main()+{%0Alet+mut+v+=+Vec::new();%0Av.push(1+/+1);%0Aprintln!(%22{}%22,+v[0]);%0A}>\n\nIn local testing, this change shrinks sample pages by anywhere between 4.0% and 0.031%\n\n    $ du -b after.dir/std/vec/struct.Vec.html before.dir/std/vec/struct.Vec.html\n    759235  after.dir/std/vec/struct.Vec.html\n    781842  before.dir/std/vec/struct.Vec.html\n\n100*((759235-781842)/781842)=-2.8\n\n    $ du -b after.dir/std/num/struct.Wrapping.html before.dir/std/num/struct.Wrapping.html\n    3194173 after.dir/std/num/struct.Wrapping.html\n    3204351 before.dir/std/num/struct.Wrapping.html\n\n100*((3194173-3204351)/3204351)=-0.031\n\n    $ du -b after.dir/std/keyword.match.html before.dir/std/keyword.match.html\n    8151    after.dir/std/keyword.match.html\n    8495    before.dir/std/keyword.match.html\n\n100*((8151-8495)/8495)=-4.0\n\nGzipped tarball sizes seem shrunk, but not by much.\n\n    du -s before.tar.gz after.tar.gz\n    69600   before.tar.gz\n    69480   after.tar.gz\n\n100*((69480-69600)/69600)=-0.17\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d68b5a42e2b481fa5ff43708e1ef820a6da13bd8", "html_url": "https://github.com/rust-lang/rust/commit/d68b5a42e2b481fa5ff43708e1ef820a6da13bd8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d68b5a42e2b481fa5ff43708e1ef820a6da13bd8/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5683915ca44f17e95d5049b943babbfdbca53961", "url": "https://api.github.com/repos/rust-lang/rust/commits/5683915ca44f17e95d5049b943babbfdbca53961", "html_url": "https://github.com/rust-lang/rust/commit/5683915ca44f17e95d5049b943babbfdbca53961"}, {"sha": "51df99f3c2bac3ee7158b115ff6d54b687d018e1", "url": "https://api.github.com/repos/rust-lang/rust/commits/51df99f3c2bac3ee7158b115ff6d54b687d018e1", "html_url": "https://github.com/rust-lang/rust/commit/51df99f3c2bac3ee7158b115ff6d54b687d018e1"}], "stats": {"total": 27, "additions": 22, "deletions": 5}, "files": [{"sha": "b1efbf4bdcaf787eac060c5a1492aa44d130e1ad", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/d68b5a42e2b481fa5ff43708e1ef820a6da13bd8/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d68b5a42e2b481fa5ff43708e1ef820a6da13bd8/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=d68b5a42e2b481fa5ff43708e1ef820a6da13bd8", "patch": "@@ -296,25 +296,42 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for CodeBlocks<'_, 'a, I> {\n             let channel = if test.contains(\"#![feature(\") { \"&amp;version=nightly\" } else { \"\" };\n \n             // These characters don't need to be escaped in a URI.\n-            // FIXME: use a library function for percent encoding.\n+            // See https://url.spec.whatwg.org/#query-percent-encode-set\n+            // and https://url.spec.whatwg.org/#urlencoded-parsing\n+            // and https://url.spec.whatwg.org/#url-code-points\n             fn dont_escape(c: u8) -> bool {\n                 (b'a' <= c && c <= b'z')\n                     || (b'A' <= c && c <= b'Z')\n                     || (b'0' <= c && c <= b'9')\n                     || c == b'-'\n                     || c == b'_'\n                     || c == b'.'\n+                    || c == b','\n                     || c == b'~'\n                     || c == b'!'\n                     || c == b'\\''\n                     || c == b'('\n                     || c == b')'\n                     || c == b'*'\n+                    || c == b'/'\n+                    || c == b';'\n+                    || c == b':'\n+                    || c == b'?'\n+                    // As described in urlencoded-parsing, the\n+                    // first `=` is the one that separates key from\n+                    // value. Following `=`s are part of the value.\n+                    || c == b'='\n             }\n             let mut test_escaped = String::new();\n             for b in test.bytes() {\n                 if dont_escape(b) {\n                     test_escaped.push(char::from(b));\n+                } else if b == b' ' {\n+                    // URL queries are decoded with + replaced with SP\n+                    test_escaped.push('+');\n+                } else if b == b'%' {\n+                    test_escaped.push('%');\n+                    test_escaped.push('%');\n                 } else {\n                     write!(test_escaped, \"%{:02X}\", b).unwrap();\n                 }"}, {"sha": "f3811fe0b0ad10781e70e9896016763f0e4886af", "filename": "tests/rustdoc/playground-arg.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d68b5a42e2b481fa5ff43708e1ef820a6da13bd8/tests%2Frustdoc%2Fplayground-arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d68b5a42e2b481fa5ff43708e1ef820a6da13bd8/tests%2Frustdoc%2Fplayground-arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc%2Fplayground-arg.rs?ref=d68b5a42e2b481fa5ff43708e1ef820a6da13bd8", "patch": "@@ -10,4 +10,4 @@\n pub fn dummy() {}\n \n // ensure that `extern crate foo;` was inserted into code snips automatically:\n-// @matches foo/index.html '//a[@class=\"test-arrow\"][@href=\"https://example.com/?code=%23!%5Ballow(unused)%5D%0Aextern%20crate%20r%23foo%3B%0Afn%20main()%20%7B%0Ause%20foo%3A%3Adummy%3B%0Adummy()%3B%0A%7D&edition=2015\"]' \"Run\"\n+// @matches foo/index.html '//a[@class=\"test-arrow\"][@href=\"https://example.com/?code=%23!%5Ballow(unused)%5D%0Aextern+crate+r%23foo;%0Afn+main()+%7B%0Ause+foo::dummy;%0Adummy();%0A%7D&edition=2015\"]' \"Run\""}, {"sha": "5c7fa33efc5e586a3be143e52174149497279edb", "filename": "tests/rustdoc/playground.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d68b5a42e2b481fa5ff43708e1ef820a6da13bd8/tests%2Frustdoc%2Fplayground.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d68b5a42e2b481fa5ff43708e1ef820a6da13bd8/tests%2Frustdoc%2Fplayground.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc%2Fplayground.rs?ref=d68b5a42e2b481fa5ff43708e1ef820a6da13bd8", "patch": "@@ -22,6 +22,6 @@\n //! }\n //! ```\n \n-// @matches foo/index.html '//a[@class=\"test-arrow\"][@href=\"https://www.example.com/?code=%23!%5Ballow(unused)%5D%0Afn%20main()%20%7B%0A%20%20%20%20println!(%22Hello%2C%20world!%22)%3B%0A%7D&edition=2015\"]' \"Run\"\n-// @matches foo/index.html '//a[@class=\"test-arrow\"][@href=\"https://www.example.com/?code=%23!%5Ballow(unused)%5D%0Afn%20main()%20%7B%0Aprintln!(%22Hello%2C%20world!%22)%3B%0A%7D&edition=2015\"]' \"Run\"\n-// @matches foo/index.html '//a[@class=\"test-arrow\"][@href=\"https://www.example.com/?code=%23!%5Ballow(unused)%5D%0A%23!%5Bfeature(something)%5D%0A%0Afn%20main()%20%7B%0A%20%20%20%20println!(%22Hello%2C%20world!%22)%3B%0A%7D&version=nightly&edition=2015\"]' \"Run\"\n+// @matches foo/index.html '//a[@class=\"test-arrow\"][@href=\"https://www.example.com/?code=%23!%5Ballow(unused)%5D%0Afn+main()+%7B%0Aprintln!(%22Hello,+world!%22);%0A%7D&edition=2015\"]' \"Run\"\n+// @matches foo/index.html '//a[@class=\"test-arrow\"][@href=\"https://www.example.com/?code=%23!%5Ballow(unused)%5D%0Afn+main()+%7B%0A++++println!(%22Hello,+world!%22);%0A%7D&edition=2015\"]' \"Run\"\n+// @matches foo/index.html '//a[@class=\"test-arrow\"][@href=\"https://www.example.com/?code=%23!%5Ballow(unused)%5D%0A%23!%5Bfeature(something)%5D%0A%0Afn+main()+%7B%0A++++println!(%22Hello,+world!%22);%0A%7D&version=nightly&edition=2015\"]' \"Run\""}]}