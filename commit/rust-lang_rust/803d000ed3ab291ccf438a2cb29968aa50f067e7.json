{"sha": "803d000ed3ab291ccf438a2cb29968aa50f067e7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgwM2QwMDBlZDNhYjI5MWNjZjQzOGEyY2IyOTk2OGFhNTBmMDY3ZTc=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2018-08-06T07:37:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-08-06T07:37:05Z"}, "message": "Merge pull request #2900 from topecongiro/combine-attrs\n\nCombine function-like attributes", "tree": {"sha": "3e68dc17d8eb6c82dc178553f3050ee534294a61", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3e68dc17d8eb6c82dc178553f3050ee534294a61"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/803d000ed3ab291ccf438a2cb29968aa50f067e7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbZ/qhCRBK7hj4Ov3rIwAAdHIIAAnQYGJUjmtg4TINuODY5ND8\neBqGiANHlP+6r/q9Mf6ZZHJyhoTu2K8zc7GdHapCgZicYRZPv4geQ21IkpG5qYAr\nPC4nHD0xIizncWUcz/hHw+mmOQ6LfI0gp/P1ro7S3EJs3Ypu6wuzTLZ4nNbkkxd6\nJGy2P14GNb9ilfwLYrAgp9SMAb7n11g0/van6782JqXpTmWtSesIZekZdRguQOkK\n4usPevckvSjcnTzSuSJJfn75fMrvbPi3fqvcsFC1bq8OKEov2LQlLfk/L2/c4BvQ\nr+3e2Vu2TgIv228JduZSqByTbW6666t41J2kt+nt1JBEkP+D2z+ZbC5VSyKpzx8=\n=xpJR\n-----END PGP SIGNATURE-----\n", "payload": "tree 3e68dc17d8eb6c82dc178553f3050ee534294a61\nparent e4d560b9148e62de6adb30bc0aa31c8432dabc54\nparent b1c241ea722b97f2fa8940a19f0ae7dc18fac41a\nauthor Nick Cameron <nrc@ncameron.org> 1533541025 +1200\ncommitter GitHub <noreply@github.com> 1533541025 +1200\n\nMerge pull request #2900 from topecongiro/combine-attrs\n\nCombine function-like attributes"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/803d000ed3ab291ccf438a2cb29968aa50f067e7", "html_url": "https://github.com/rust-lang/rust/commit/803d000ed3ab291ccf438a2cb29968aa50f067e7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/803d000ed3ab291ccf438a2cb29968aa50f067e7/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e4d560b9148e62de6adb30bc0aa31c8432dabc54", "url": "https://api.github.com/repos/rust-lang/rust/commits/e4d560b9148e62de6adb30bc0aa31c8432dabc54", "html_url": "https://github.com/rust-lang/rust/commit/e4d560b9148e62de6adb30bc0aa31c8432dabc54"}, {"sha": "b1c241ea722b97f2fa8940a19f0ae7dc18fac41a", "url": "https://api.github.com/repos/rust-lang/rust/commits/b1c241ea722b97f2fa8940a19f0ae7dc18fac41a", "html_url": "https://github.com/rust-lang/rust/commit/b1c241ea722b97f2fa8940a19f0ae7dc18fac41a"}], "stats": {"total": 61, "additions": 45, "deletions": 16}, "files": [{"sha": "b13c873a59862794681ccd2f3d971a81e7e91aee", "filename": "src/attr.rs", "status": "modified", "additions": 39, "deletions": 8, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/803d000ed3ab291ccf438a2cb29968aa50f067e7/src%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/803d000ed3ab291ccf438a2cb29968aa50f067e7/src%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fattr.rs?ref=803d000ed3ab291ccf438a2cb29968aa50f067e7", "patch": "@@ -61,15 +61,22 @@ fn get_derive_spans<'a>(attr: &ast::Attribute) -> Option<Vec<Span>> {\n fn argument_shape(\n     left: usize,\n     right: usize,\n+    combine: bool,\n     shape: Shape,\n     context: &RewriteContext,\n ) -> Option<Shape> {\n     match context.config.indent_style() {\n-        IndentStyle::Block => Some(\n-            shape\n-                .block_indent(context.config.tab_spaces())\n-                .with_max_width(context.config),\n-        ),\n+        IndentStyle::Block => {\n+            if combine {\n+                shape.offset_left(left)\n+            } else {\n+                Some(\n+                    shape\n+                        .block_indent(context.config.tab_spaces())\n+                        .with_max_width(context.config),\n+                )\n+            }\n+        }\n         IndentStyle::Visual => shape\n             .visual_indent(0)\n             .shrink_left(left)\n@@ -87,7 +94,7 @@ fn format_derive(\n     result.push_str(prefix);\n     result.push_str(\"[derive(\");\n \n-    let argument_shape = argument_shape(10 + prefix.len(), 2, shape, context)?;\n+    let argument_shape = argument_shape(10 + prefix.len(), 2, false, shape, context)?;\n     let item_str = format_arg_list(\n         derive_args.iter(),\n         |_| DUMMY_SP.lo(),\n@@ -99,6 +106,7 @@ fn format_derive(\n         // 10 = \"[derive()]\", 3 = \"()\" and \"]\"\n         shape.offset_left(10 + prefix.len())?.sub_width(3)?,\n         None,\n+        false,\n     )?;\n \n     result.push_str(&item_str);\n@@ -214,9 +222,29 @@ impl Rewrite for ast::MetaItem {\n                 // it's close enough).\n                 let snippet = snippet[..snippet.len() - 2].trim();\n                 let trailing_comma = if snippet.ends_with(',') { \",\" } else { \"\" };\n+                let combine = list.len() == 1 && match list[0].node {\n+                    ast::NestedMetaItemKind::Literal(..) => false,\n+                    ast::NestedMetaItemKind::MetaItem(ref inner_meta_item) => {\n+                        match inner_meta_item.node {\n+                            ast::MetaItemKind::List(..) => rewrite_path(\n+                                context,\n+                                PathContext::Type,\n+                                None,\n+                                &inner_meta_item.ident,\n+                                shape,\n+                            ).map_or(false, |s| s.len() + path.len() + 2 <= shape.width),\n+                            _ => false,\n+                        }\n+                    }\n+                };\n \n-                let argument_shape =\n-                    argument_shape(path.len() + 1, 2 + trailing_comma.len(), shape, context)?;\n+                let argument_shape = argument_shape(\n+                    path.len() + 1,\n+                    2 + trailing_comma.len(),\n+                    combine,\n+                    shape,\n+                    context,\n+                )?;\n                 let item_str = format_arg_list(\n                     list.iter(),\n                     |nested_meta_item| nested_meta_item.span.lo(),\n@@ -230,6 +258,7 @@ impl Rewrite for ast::MetaItem {\n                         .offset_left(path.len())?\n                         .sub_width(3 + trailing_comma.len())?,\n                     Some(context.config.width_heuristics().fn_call_width),\n+                    combine,\n                 )?;\n \n                 let indent = if item_str.starts_with('\\n') {\n@@ -268,6 +297,7 @@ fn format_arg_list<I, T, F1, F2, F3>(\n     shape: Shape,\n     one_line_shape: Shape,\n     one_line_limit: Option<usize>,\n+    combine: bool,\n ) -> Option<String>\n where\n     I: Iterator<Item = T>,\n@@ -302,6 +332,7 @@ where\n \n     let one_line_budget = one_line_shape.width;\n     if context.config.indent_style() == IndentStyle::Visual\n+        || combine\n         || (!item_str.contains('\\n') && item_str.len() <= one_line_budget)\n     {\n         Some(item_str)"}, {"sha": "3880d9cb876b4822481d0c0a8de092845015b8a6", "filename": "tests/target/attrib.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/803d000ed3ab291ccf438a2cb29968aa50f067e7/tests%2Ftarget%2Fattrib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/803d000ed3ab291ccf438a2cb29968aa50f067e7/tests%2Ftarget%2Fattrib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fattrib.rs?ref=803d000ed3ab291ccf438a2cb29968aa50f067e7", "patch": "@@ -76,14 +76,12 @@ struct Foo {\n // #1668\n \n /// Default path (*nix)\n-#[cfg(\n-    all(\n-        unix,\n-        not(target_os = \"macos\"),\n-        not(target_os = \"ios\"),\n-        not(target_os = \"android\")\n-    )\n-)]\n+#[cfg(all(\n+    unix,\n+    not(target_os = \"macos\"),\n+    not(target_os = \"ios\"),\n+    not(target_os = \"android\")\n+))]\n fn foo() {\n     #[cfg(target_os = \"freertos\")]\n     match port_id {"}]}