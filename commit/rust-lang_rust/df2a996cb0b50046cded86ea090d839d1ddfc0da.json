{"sha": "df2a996cb0b50046cded86ea090d839d1ddfc0da", "node_id": "C_kwDOAAsO6NoAKGRmMmE5OTZjYjBiNTAwNDZjZGVkODZlYTA5MGQ4MzlkMWRkZmMwZGE", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-12-27T18:13:55Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-12-28T14:00:55Z"}, "message": "add ssr fragment for expressions", "tree": {"sha": "5acd53c59df485d0da1fb144c5874c0ef7039e53", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5acd53c59df485d0da1fb144c5874c0ef7039e53"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/df2a996cb0b50046cded86ea090d839d1ddfc0da", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/df2a996cb0b50046cded86ea090d839d1ddfc0da", "html_url": "https://github.com/rust-lang/rust/commit/df2a996cb0b50046cded86ea090d839d1ddfc0da", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/df2a996cb0b50046cded86ea090d839d1ddfc0da/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2d373dc53cc0cbbcefcbe15bec4097ab57195703", "url": "https://api.github.com/repos/rust-lang/rust/commits/2d373dc53cc0cbbcefcbe15bec4097ab57195703", "html_url": "https://github.com/rust-lang/rust/commit/2d373dc53cc0cbbcefcbe15bec4097ab57195703"}], "stats": {"total": 18, "additions": 16, "deletions": 2}, "files": [{"sha": "512b3ace01a4140e7b21384d6ac67845bbafbe15", "filename": "crates/ide_ssr/src/fragments.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/df2a996cb0b50046cded86ea090d839d1ddfc0da/crates%2Fide_ssr%2Fsrc%2Ffragments.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df2a996cb0b50046cded86ea090d839d1ddfc0da/crates%2Fide_ssr%2Fsrc%2Ffragments.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_ssr%2Fsrc%2Ffragments.rs?ref=df2a996cb0b50046cded86ea090d839d1ddfc0da", "patch": "@@ -35,3 +35,17 @@ pub(crate) fn item(s: &str) -> Result<SyntaxNode, ()> {\n     }\n     Ok(node.syntax().clone())\n }\n+\n+pub(crate) fn expr(s: &str) -> Result<SyntaxNode, ()> {\n+    let template = \"const _: () = {};\";\n+    let input = template.replace(\"{}\", s);\n+    let parse = syntax::SourceFile::parse(&input);\n+    if !parse.errors().is_empty() {\n+        return Err(());\n+    }\n+    let node = parse.tree().syntax().descendants().find_map(ast::Expr::cast).ok_or(())?;\n+    if node.to_string() != s {\n+        return Err(());\n+    }\n+    Ok(node.syntax().clone())\n+}"}, {"sha": "03c7fed03959699e6f33c1a97d85b8b80dbc5962", "filename": "crates/ide_ssr/src/parsing.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/df2a996cb0b50046cded86ea090d839d1ddfc0da/crates%2Fide_ssr%2Fsrc%2Fparsing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df2a996cb0b50046cded86ea090d839d1ddfc0da/crates%2Fide_ssr%2Fsrc%2Fparsing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_ssr%2Fsrc%2Fparsing.rs?ref=df2a996cb0b50046cded86ea090d839d1ddfc0da", "patch": "@@ -74,8 +74,8 @@ impl ParsedRule {\n         };\n \n         let raw_template_stmt = raw_template.map(ast::Stmt::parse);\n-        if let raw_template_expr @ Some(Ok(_)) = raw_template.map(ast::Expr::parse) {\n-            builder.try_add(ast::Expr::parse(&raw_pattern), raw_template_expr);\n+        if let raw_template_expr @ Some(Ok(_)) = raw_template.map(fragments::expr) {\n+            builder.try_add2(fragments::expr(&raw_pattern), raw_template_expr);\n         } else {\n             builder.try_add(ast::Expr::parse(&raw_pattern), raw_template_stmt.clone());\n         }"}]}