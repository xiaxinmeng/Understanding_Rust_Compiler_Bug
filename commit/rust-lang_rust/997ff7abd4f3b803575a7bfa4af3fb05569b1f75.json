{"sha": "997ff7abd4f3b803575a7bfa4af3fb05569b1f75", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk5N2ZmN2FiZDRmM2I4MDM1NzVhN2JmYTRhZjNmYjA1NTY5YjFmNzU=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-03-01T19:09:30Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-03-02T07:36:28Z"}, "message": "rustc: Better error when loading invalid libraries\n\nWhen the metadata format changes, old libraries often cause librustc to abort\nwhen reading their metadata. This should all change with the introduction of SVH\nmarkers, but the loader for crates should gracefully handle libraries without\nSVH markers still.\n\nThis commit adds support for tripping fewer assertions when loading libraries by\nusing maybe_get_doc when initially parsing metadata. It's still possible for\nsome libraries to fall through the cracks, but this should deal with a fairly\nlarge number of them up front.", "tree": {"sha": "c48b58f690f7d92eefb7a13f8fde461bf4389556", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c48b58f690f7d92eefb7a13f8fde461bf4389556"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/997ff7abd4f3b803575a7bfa4af3fb05569b1f75", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/997ff7abd4f3b803575a7bfa4af3fb05569b1f75", "html_url": "https://github.com/rust-lang/rust/commit/997ff7abd4f3b803575a7bfa4af3fb05569b1f75", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/997ff7abd4f3b803575a7bfa4af3fb05569b1f75/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3d117cf3ca9dc091dd605b33617c32c6019b0e2b", "url": "https://api.github.com/repos/rust-lang/rust/commits/3d117cf3ca9dc091dd605b33617c32c6019b0e2b", "html_url": "https://github.com/rust-lang/rust/commit/3d117cf3ca9dc091dd605b33617c32c6019b0e2b"}], "stats": {"total": 46, "additions": 42, "deletions": 4}, "files": [{"sha": "8cfda93bd8451de84789b272084c4e60cefa9190", "filename": "src/librustc/metadata/decoder.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/997ff7abd4f3b803575a7bfa4af3fb05569b1f75/src%2Flibrustc%2Fmetadata%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/997ff7abd4f3b803575a7bfa4af3fb05569b1f75/src%2Flibrustc%2Fmetadata%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Fdecoder.rs?ref=997ff7abd4f3b803575a7bfa4af3fb05569b1f75", "patch": "@@ -1145,12 +1145,26 @@ fn list_crate_deps(data: &[u8], out: &mut io::Writer) -> io::IoResult<()> {\n     Ok(())\n }\n \n+pub fn maybe_get_crate_hash(data: &[u8]) -> Option<Svh> {\n+    let cratedoc = reader::Doc(data);\n+    reader::maybe_get_doc(cratedoc, tag_crate_hash).map(|doc| {\n+        Svh::new(doc.as_str_slice())\n+    })\n+}\n+\n pub fn get_crate_hash(data: &[u8]) -> Svh {\n     let cratedoc = reader::Doc(data);\n     let hashdoc = reader::get_doc(cratedoc, tag_crate_hash);\n     Svh::new(hashdoc.as_str_slice())\n }\n \n+pub fn maybe_get_crate_id(data: &[u8]) -> Option<CrateId> {\n+    let cratedoc = reader::Doc(data);\n+    reader::maybe_get_doc(cratedoc, tag_crate_crateid).map(|doc| {\n+        from_str(doc.as_str_slice()).unwrap()\n+    })\n+}\n+\n pub fn get_crate_id(data: &[u8]) -> CrateId {\n     let cratedoc = reader::Doc(data);\n     let hashdoc = reader::get_doc(cratedoc, tag_crate_crateid);"}, {"sha": "617a8654eedab2b30df8c898d8bafdc02c781c1c", "filename": "src/librustc/metadata/loader.rs", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/997ff7abd4f3b803575a7bfa4af3fb05569b1f75/src%2Flibrustc%2Fmetadata%2Floader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/997ff7abd4f3b803575a7bfa4af3fb05569b1f75/src%2Flibrustc%2Fmetadata%2Floader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Floader.rs?ref=997ff7abd4f3b803575a7bfa4af3fb05569b1f75", "patch": "@@ -318,12 +318,17 @@ impl<'a> Context<'a> {\n     }\n \n     fn crate_matches(&mut self, crate_data: &[u8]) -> bool {\n-        let other_id = decoder::get_crate_id(crate_data);\n-        if !self.crate_id.matches(&other_id) { return false }\n+        match decoder::maybe_get_crate_id(crate_data) {\n+            Some(ref id) if self.crate_id.matches(id) => {}\n+            _ => return false\n+        }\n+        let hash = match decoder::maybe_get_crate_hash(crate_data) {\n+            Some(hash) => hash, None => return false\n+        };\n         match self.hash {\n             None => true,\n-            Some(hash) => {\n-                if *hash != decoder::get_crate_hash(crate_data) {\n+            Some(myhash) => {\n+                if *myhash != hash {\n                     self.rejected_via_hash = true;\n                     false\n                 } else {"}, {"sha": "0dbe655b77dfd9c91ff5104b3e6fe81f80106281", "filename": "src/test/run-make/invalid-library/Makefile", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/997ff7abd4f3b803575a7bfa4af3fb05569b1f75/src%2Ftest%2Frun-make%2Finvalid-library%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/997ff7abd4f3b803575a7bfa4af3fb05569b1f75/src%2Ftest%2Frun-make%2Finvalid-library%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Finvalid-library%2FMakefile?ref=997ff7abd4f3b803575a7bfa4af3fb05569b1f75", "patch": "@@ -0,0 +1,6 @@\n+-include ../tools.mk\n+\n+all:\n+\ttouch $(TMPDIR)/rust.metadata.bin\n+\tar crus $(TMPDIR)/libfoo-ffffffff-1.0.rlib $(TMPDIR)/rust.metadata.bin\n+\t$(RUSTC) foo.rs 2>&1 | grep \"can't find crate for\""}, {"sha": "6316cfa3bba08c9efa9bedac15a71633e66bf7a0", "filename": "src/test/run-make/invalid-library/foo.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/997ff7abd4f3b803575a7bfa4af3fb05569b1f75/src%2Ftest%2Frun-make%2Finvalid-library%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/997ff7abd4f3b803575a7bfa4af3fb05569b1f75/src%2Ftest%2Frun-make%2Finvalid-library%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Finvalid-library%2Ffoo.rs?ref=997ff7abd4f3b803575a7bfa4af3fb05569b1f75", "patch": "@@ -0,0 +1,13 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+extern crate foo;\n+\n+fn main() {}"}]}