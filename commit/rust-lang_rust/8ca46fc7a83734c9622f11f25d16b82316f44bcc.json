{"sha": "8ca46fc7a83734c9622f11f25d16b82316f44bcc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhjYTQ2ZmM3YTgzNzM0Yzk2MjJmMTFmMjVkMTZiODIzMTZmNDRiY2M=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2020-11-26T21:24:34Z"}, "committer": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2020-12-23T18:35:22Z"}, "message": "bootstrap: convert rustc-docs to use Tarball", "tree": {"sha": "37b97a5b82fa306e1803afd1444805167fd206fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/37b97a5b82fa306e1803afd1444805167fd206fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8ca46fc7a83734c9622f11f25d16b82316f44bcc", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE1JbYPtLJAsc22U9xPgar6Auq8ZwFAl/jje0ACgkQPgar6Auq\n8ZyzzA/7BAtgj3mB+eB+RufqYhLmXjw5cO8YdMPO229qJRCkk0ENk9vGEX6QwV/s\n7fq/bVdNy5Ptalib0E4OjX0vxmm0tIVn7YQ46swCz46LS/wy12Cb5s8fvSfLMh2w\n8rNZIp5k6kvOz0MiLLDBPKZQmLqBuw+gj9EK2/K3qwS/S75fvlu7PxjhrQx2Ra59\nIMqFdrQkOlT5z8w5uETv95RmnjnnpfZ89LomkDAovYQ23MJp1FOBghMk2ViiFX5h\nsge3hvXhqvxaLRkjGT1pfSnMEkczCHcPI5PeWvtijLkSVuC1NxL+YKnB+R+21ZSn\n6UbpfXkbx0z7RuLzxTA3a5fNtat4BL2kh/E87i3WfNjUT04B1D3XHndsmuG887VX\nlaZ0ICIwiEE2tncgtCaStm1/r9gPjLpusbSLCFV94H1XbXmeaUQQC/2Djm7tp0u0\nOsO7G9YhkcoJBgziYC2URRGG5QwWDWuvKZQuwPF8Zq4CtZeDaeP16lyD+OOQVqLr\nEZ3yMqla+ioTCx49MbCOH9oCHfKgBrGY9to+mTZRHceYYmfhG8SgoVgCveeLIoGm\ny93Iw2fVzL24yrSk0d8aMsaZfNq/e4XGcu8f7VtHGQX16p1TTDQt/f9KzlPrCBH+\nPl3iQ5TMwVg7O59gzPZY0XtiRyAnRb5tyUyB2/Q6eqF31l//W4U=\n=HFaU\n-----END PGP SIGNATURE-----", "payload": "tree 37b97a5b82fa306e1803afd1444805167fd206fa\nparent c768ce138427b1844c1f6594daba9c0e33928032\nauthor Pietro Albini <pietro@pietroalbini.org> 1606425874 +0100\ncommitter Pietro Albini <pietro@pietroalbini.org> 1608748522 +0100\n\nbootstrap: convert rustc-docs to use Tarball\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8ca46fc7a83734c9622f11f25d16b82316f44bcc", "html_url": "https://github.com/rust-lang/rust/commit/8ca46fc7a83734c9622f11f25d16b82316f44bcc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8ca46fc7a83734c9622f11f25d16b82316f44bcc/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c768ce138427b1844c1f6594daba9c0e33928032", "url": "https://api.github.com/repos/rust-lang/rust/commits/c768ce138427b1844c1f6594daba9c0e33928032", "html_url": "https://github.com/rust-lang/rust/commit/c768ce138427b1844c1f6594daba9c0e33928032"}], "stats": {"total": 42, "additions": 8, "deletions": 34}, "files": [{"sha": "5a9c82c52a6fd693027dbf8468a6370cea172039", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 8, "deletions": 34, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/8ca46fc7a83734c9622f11f25d16b82316f44bcc/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ca46fc7a83734c9622f11f25d16b82316f44bcc/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=8ca46fc7a83734c9622f11f25d16b82316f44bcc", "patch": "@@ -95,7 +95,7 @@ pub struct RustcDocs {\n }\n \n impl Step for RustcDocs {\n-    type Output = PathBuf;\n+    type Output = Option<PathBuf>;\n     const DEFAULT: bool = true;\n \n     fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n@@ -107,47 +107,21 @@ impl Step for RustcDocs {\n     }\n \n     /// Builds the `rustc-docs` installer component.\n-    fn run(self, builder: &Builder<'_>) -> PathBuf {\n+    fn run(self, builder: &Builder<'_>) -> Option<PathBuf> {\n         let host = self.host;\n-\n-        let name = pkgname(builder, \"rustc-docs\");\n-\n         if !builder.config.compiler_docs {\n-            return distdir(builder).join(format!(\"{}-{}.tar.gz\", name, host.triple));\n+            return None;\n         }\n \n         builder.default_doc(None);\n-\n-        let image = tmpdir(builder).join(format!(\"{}-{}-image\", name, host.triple));\n-        let _ = fs::remove_dir_all(&image);\n-\n-        let dst = image.join(\"share/doc/rust/html/rustc\");\n-        t!(fs::create_dir_all(&dst));\n-        let src = builder.compiler_doc_out(host);\n-        builder.cp_r(&src, &dst);\n-\n-        let mut cmd = rust_installer(builder);\n-        cmd.arg(\"generate\")\n-            .arg(\"--product-name=Rustc-Documentation\")\n-            .arg(\"--rel-manifest-dir=rustlib\")\n-            .arg(\"--success-message=Rustc-documentation-is-installed.\")\n-            .arg(\"--image-dir\")\n-            .arg(&image)\n-            .arg(\"--work-dir\")\n-            .arg(&tmpdir(builder))\n-            .arg(\"--output-dir\")\n-            .arg(&distdir(builder))\n-            .arg(format!(\"--package-name={}-{}\", name, host.triple))\n-            .arg(\"--component-name=rustc-docs\")\n-            .arg(\"--legacy-manifest-dirs=rustlib,cargo\")\n-            .arg(\"--bulk-dirs=share/doc/rust/html/rustc\");\n-\n         builder.info(&format!(\"Dist compiler docs ({})\", host));\n         let _time = timeit(builder);\n-        builder.run(&mut cmd);\n-        builder.remove_dir(&image);\n \n-        distdir(builder).join(format!(\"{}-{}.tar.gz\", name, host.triple))\n+        let mut tarball = Tarball::new(builder, \"rustc-docs\", &host.triple);\n+        tarball.set_product_name(\"Rustc Documentation\");\n+        tarball.add_dir(&builder.compiler_doc_out(host), \"share/doc/rust/html/rustc\");\n+\n+        Some(tarball.generate())\n     }\n }\n "}]}