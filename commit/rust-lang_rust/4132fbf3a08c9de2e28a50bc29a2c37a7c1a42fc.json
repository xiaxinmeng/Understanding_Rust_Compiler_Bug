{"sha": "4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQxMzJmYmYzYTA4YzlkZTJlMjhhNTBiYzI5YTJjMzdhN2MxYTQyZmM=", "commit": {"author": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2019-03-25T07:42:30Z"}, "committer": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2019-03-25T07:42:30Z"}, "message": "Merge #1041\n\n1041: Add convenience functions to SourceChange for creating single edits r=matklad a=vipentti\n\nFixes #1018 \n\nCo-authored-by: Ville Penttinen <villem.penttinen@gmail.com>", "tree": {"sha": "6d4e43864187b101ee956d3fa25cb5346f5d0f1b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6d4e43864187b101ee956d3fa25cb5346f5d0f1b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc", "html_url": "https://github.com/rust-lang/rust/commit/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "parents": [{"sha": "8fd18fddea49ff988818a96f5f116ef660a3b6c4", "url": "https://api.github.com/repos/rust-lang/rust/commits/8fd18fddea49ff988818a96f5f116ef660a3b6c4", "html_url": "https://github.com/rust-lang/rust/commit/8fd18fddea49ff988818a96f5f116ef660a3b6c4"}, {"sha": "4d26bae46db1e4d7a72f9808e7d19ea11fd3bd7d", "url": "https://api.github.com/repos/rust-lang/rust/commits/4d26bae46db1e4d7a72f9808e7d19ea11fd3bd7d", "html_url": "https://github.com/rust-lang/rust/commit/4d26bae46db1e4d7a72f9808e7d19ea11fd3bd7d"}], "stats": {"total": 168, "additions": 105, "deletions": 63}, "files": [{"sha": "355c0a42aa23ff2bce47d87f1bc861df8f6e1a76", "filename": "crates/ra_ide_api/src/assists.rs", "status": "modified", "additions": 3, "deletions": 8, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc/crates%2Fra_ide_api%2Fsrc%2Fassists.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc/crates%2Fra_ide_api%2Fsrc%2Fassists.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fassists.rs?ref=4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc", "patch": "@@ -17,14 +17,9 @@ pub(crate) fn assists(db: &RootDatabase, frange: FileRange) -> Vec<Assist> {\n             let file_id = frange.file_id;\n             let file_edit = SourceFileEdit { file_id, edit: action.edit };\n             let id = label.id;\n-            let change = SourceChange {\n-                label: label.label,\n-                source_file_edits: vec![file_edit],\n-                file_system_edits: vec![],\n-                cursor_position: action\n-                    .cursor_position\n-                    .map(|offset| FilePosition { offset, file_id }),\n-            };\n+            let change = SourceChange::source_file_edit(label.label, file_edit).with_cursor_opt(\n+                action.cursor_position.map(|offset| FilePosition { offset, file_id }),\n+            );\n             Assist { id, change }\n         })\n         .collect()"}, {"sha": "156f28ca33a20cae7fd9f545498013dfdc458f6e", "filename": "crates/ra_ide_api/src/diagnostics.rs", "status": "modified", "additions": 9, "deletions": 18, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc/crates%2Fra_ide_api%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc/crates%2Fra_ide_api%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fdiagnostics.rs?ref=4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc", "patch": "@@ -71,12 +71,10 @@ fn check_unnecessary_braces_in_use_statement(\n             range,\n             message: format!(\"Unnecessary braces in use statement\"),\n             severity: Severity::WeakWarning,\n-            fix: Some(SourceChange {\n-                label: \"Remove unnecessary braces\".to_string(),\n-                source_file_edits: vec![SourceFileEdit { file_id, edit }],\n-                file_system_edits: Vec::new(),\n-                cursor_position: None,\n-            }),\n+            fix: Some(SourceChange::source_file_edit(\n+                \"Remove unnecessary braces\",\n+                SourceFileEdit { file_id, edit },\n+            )),\n         });\n     }\n \n@@ -119,12 +117,10 @@ fn check_struct_shorthand_initialization(\n                     range: named_field.syntax().range(),\n                     message: format!(\"Shorthand struct initialization\"),\n                     severity: Severity::WeakWarning,\n-                    fix: Some(SourceChange {\n-                        label: \"use struct shorthand initialization\".to_string(),\n-                        source_file_edits: vec![SourceFileEdit { file_id, edit }],\n-                        file_system_edits: Vec::new(),\n-                        cursor_position: None,\n-                    }),\n+                    fix: Some(SourceChange::source_file_edit(\n+                        \"use struct shorthand initialization\",\n+                        SourceFileEdit { file_id, edit },\n+                    )),\n                 });\n             }\n         }\n@@ -144,12 +140,7 @@ fn check_module(\n             Problem::UnresolvedModule { candidate } => {\n                 let create_file =\n                     FileSystemEdit::CreateFile { source_root, path: candidate.clone() };\n-                let fix = SourceChange {\n-                    label: \"create module\".to_string(),\n-                    source_file_edits: Vec::new(),\n-                    file_system_edits: vec![create_file],\n-                    cursor_position: None,\n-                };\n+                let fix = SourceChange::file_system_edit(\"create module\", create_file);\n                 Diagnostic {\n                     range: name_node.range(),\n                     message: \"unresolved module\".to_string(),"}, {"sha": "8aa3eb088b31b2efd1358429c08ff14e83b33675", "filename": "crates/ra_ide_api/src/lib.rs", "status": "modified", "additions": 78, "deletions": 12, "changes": 90, "blob_url": "https://github.com/rust-lang/rust/blob/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Flib.rs?ref=4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc", "patch": "@@ -97,6 +97,79 @@ pub struct SourceChange {\n     pub cursor_position: Option<FilePosition>,\n }\n \n+impl SourceChange {\n+    /// Creates a new SourceChange with the given label\n+    /// from the edits.\n+    pub(crate) fn from_edits<L: Into<String>>(\n+        label: L,\n+        source_file_edits: Vec<SourceFileEdit>,\n+        file_system_edits: Vec<FileSystemEdit>,\n+    ) -> Self {\n+        SourceChange {\n+            label: label.into(),\n+            source_file_edits,\n+            file_system_edits,\n+            cursor_position: None,\n+        }\n+    }\n+\n+    /// Creates a new SourceChange with the given label,\n+    /// containing only the given `SourceFileEdits`.\n+    pub(crate) fn source_file_edits<L: Into<String>>(label: L, edits: Vec<SourceFileEdit>) -> Self {\n+        SourceChange {\n+            label: label.into(),\n+            source_file_edits: edits,\n+            file_system_edits: vec![],\n+            cursor_position: None,\n+        }\n+    }\n+\n+    /// Creates a new SourceChange with the given label,\n+    /// containing only the given `FileSystemEdits`.\n+    pub(crate) fn file_system_edits<L: Into<String>>(label: L, edits: Vec<FileSystemEdit>) -> Self {\n+        SourceChange {\n+            label: label.into(),\n+            source_file_edits: vec![],\n+            file_system_edits: edits,\n+            cursor_position: None,\n+        }\n+    }\n+\n+    /// Creates a new SourceChange with the given label,\n+    /// containing only a single `SourceFileEdit`.\n+    pub(crate) fn source_file_edit<L: Into<String>>(label: L, edit: SourceFileEdit) -> Self {\n+        SourceChange::source_file_edits(label, vec![edit])\n+    }\n+\n+    /// Creates a new SourceChange with the given label\n+    /// from the given `FileId` and `TextEdit`\n+    pub(crate) fn source_file_edit_from<L: Into<String>>(\n+        label: L,\n+        file_id: FileId,\n+        edit: TextEdit,\n+    ) -> Self {\n+        SourceChange::source_file_edit(label, SourceFileEdit { file_id, edit })\n+    }\n+\n+    /// Creates a new SourceChange with the given label\n+    /// from the given `FileId` and `TextEdit`\n+    pub(crate) fn file_system_edit<L: Into<String>>(label: L, edit: FileSystemEdit) -> Self {\n+        SourceChange::file_system_edits(label, vec![edit])\n+    }\n+\n+    /// Sets the cursor position to the given `FilePosition`\n+    pub(crate) fn with_cursor(mut self, cursor_position: FilePosition) -> Self {\n+        self.cursor_position = Some(cursor_position);\n+        self\n+    }\n+\n+    /// Sets the cursor position to the given `FilePosition`\n+    pub(crate) fn with_cursor_opt(mut self, cursor_position: Option<FilePosition>) -> Self {\n+        self.cursor_position = cursor_position;\n+        self\n+    }\n+}\n+\n #[derive(Debug)]\n pub struct SourceFileEdit {\n     pub file_id: FileId,\n@@ -285,12 +358,7 @@ impl Analysis {\n             file_id: frange.file_id,\n             edit: join_lines::join_lines(&file, frange.range),\n         };\n-        SourceChange {\n-            label: \"join lines\".to_string(),\n-            source_file_edits: vec![file_edit],\n-            file_system_edits: vec![],\n-            cursor_position: None,\n-        }\n+        SourceChange::source_file_edit(\"join lines\", file_edit)\n     }\n \n     /// Returns an edit which should be applied when opening a new line, fixing\n@@ -305,12 +373,10 @@ impl Analysis {\n     pub fn on_eq_typed(&self, position: FilePosition) -> Option<SourceChange> {\n         let file = self.db.parse(position.file_id);\n         let edit = typing::on_eq_typed(&file, position.offset)?;\n-        Some(SourceChange {\n-            label: \"add semicolon\".to_string(),\n-            source_file_edits: vec![SourceFileEdit { edit, file_id: position.file_id }],\n-            file_system_edits: vec![],\n-            cursor_position: None,\n-        })\n+        Some(SourceChange::source_file_edit(\n+            \"add semicolon\",\n+            SourceFileEdit { edit, file_id: position.file_id },\n+        ))\n     }\n \n     /// Returns an edit which should be applied when a dot ('.') is typed on a blank line, indenting the line appropriately."}, {"sha": "22741445ad6b31ef2976d3d5c3385bf008962974", "filename": "crates/ra_ide_api/src/references.rs", "status": "modified", "additions": 2, "deletions": 12, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc/crates%2Fra_ide_api%2Fsrc%2Freferences.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc/crates%2Fra_ide_api%2Fsrc%2Freferences.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Freferences.rs?ref=4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc", "patch": "@@ -187,12 +187,7 @@ fn rename_mod(\n     };\n     source_file_edits.push(edit);\n \n-    Some(SourceChange {\n-        label: \"rename\".to_string(),\n-        source_file_edits,\n-        file_system_edits,\n-        cursor_position: None,\n-    })\n+    Some(SourceChange::from_edits(\"rename\", source_file_edits, file_system_edits))\n }\n \n fn rename_reference(\n@@ -211,12 +206,7 @@ fn rename_reference(\n         return None;\n     }\n \n-    Some(SourceChange {\n-        label: \"rename\".to_string(),\n-        source_file_edits: edit,\n-        file_system_edits: Vec::new(),\n-        cursor_position: None,\n-    })\n+    Some(SourceChange::source_file_edits(\"rename\", edit))\n }\n \n #[cfg(test)]"}, {"sha": "501d44dbbe0353e2566ce5f9c4a1c8856532a3c9", "filename": "crates/ra_ide_api/src/typing.rs", "status": "modified", "additions": 13, "deletions": 13, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc/crates%2Fra_ide_api%2Fsrc%2Ftyping.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc/crates%2Fra_ide_api%2Fsrc%2Ftyping.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Ftyping.rs?ref=4132fbf3a08c9de2e28a50bc29a2c37a7c1a42fc", "patch": "@@ -31,12 +31,14 @@ pub(crate) fn on_enter(db: &RootDatabase, position: FilePosition) -> Option<Sour\n     let cursor_position = position.offset + TextUnit::of_str(&inserted);\n     let mut edit = TextEditBuilder::default();\n     edit.insert(position.offset, inserted);\n-    Some(SourceChange {\n-        label: \"on enter\".to_string(),\n-        source_file_edits: vec![SourceFileEdit { edit: edit.finish(), file_id: position.file_id }],\n-        file_system_edits: vec![],\n-        cursor_position: Some(FilePosition { offset: cursor_position, file_id: position.file_id }),\n-    })\n+\n+    Some(\n+        SourceChange::source_file_edit(\n+            \"on enter\",\n+            SourceFileEdit { edit: edit.finish(), file_id: position.file_id },\n+        )\n+        .with_cursor(FilePosition { offset: cursor_position, file_id: position.file_id }),\n+    )\n }\n \n fn node_indent<'a>(file: &'a SourceFile, node: &SyntaxNode) -> Option<&'a str> {\n@@ -110,16 +112,14 @@ pub(crate) fn on_dot_typed(db: &RootDatabase, position: FilePosition) -> Option<\n         TextRange::from_to(position.offset - current_indent_len, position.offset),\n         target_indent.into(),\n     );\n-    let res = SourceChange {\n-        label: \"reindent dot\".to_string(),\n-        source_file_edits: vec![SourceFileEdit { edit: edit.finish(), file_id: position.file_id }],\n-        file_system_edits: vec![],\n-        cursor_position: Some(FilePosition {\n+\n+    let res = SourceChange::source_file_edit_from(\"reindent dot\", position.file_id, edit.finish())\n+        .with_cursor(FilePosition {\n             offset: position.offset + target_indent_len - current_indent_len\n                 + TextUnit::of_char('.'),\n             file_id: position.file_id,\n-        }),\n-    };\n+        });\n+\n     Some(res)\n }\n "}]}