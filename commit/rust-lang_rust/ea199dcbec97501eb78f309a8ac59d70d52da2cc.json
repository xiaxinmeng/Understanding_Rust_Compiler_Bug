{"sha": "ea199dcbec97501eb78f309a8ac59d70d52da2cc", "node_id": "C_kwDOAAsO6NoAKGVhMTk5ZGNiZWM5NzUwMWViNzhmMzA5YThhYzU5ZDcwZDUyZGEyY2M", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-12-03T23:27:50Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-12-03T23:27:50Z"}, "message": "Merge #10920\n\n10920: minor: Shorten spans of mismatched_arg_count diag r=Veykril a=Veykril\n\nFixes #5289\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "ef2dc93b757c573d43fccf70e17096ab39ceab9f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ef2dc93b757c573d43fccf70e17096ab39ceab9f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ea199dcbec97501eb78f309a8ac59d70d52da2cc", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhqqf2CRBK7hj4Ov3rIwAA7Y0IAGhRh5fHAKFRoKoOJpy01Cpl\nciBO0eoOoF4r78kZyRL5WfudhEgSOQ5bkICmA8J9rTAx8cYwvTpqscWEbg5YRbls\nkNLC1t5MN3jH65MnV3xh2Fg+YyEKbv8rvHG/QUXd6r9taVKitZhGD8CFX3xUZ8Ob\nCCeQQWGWmHblgcIhnSVi/87f2mvPUq2QszzNh7cz9TI1sW6Q9oqWeqOen92pomFt\nkR6Lg5D1WiNLJsBgNtfn1I8nbm7Xhj1ifMTdGC3jyQnGmywJV8Kb66f2ysVVofyF\nBXhrgwjuFnMyd4JWNe8cPvgGuY2jqIuy74uKxb4iimbGqlXS6/FCVZ80KXfN/1E=\n=ezEf\n-----END PGP SIGNATURE-----\n", "payload": "tree ef2dc93b757c573d43fccf70e17096ab39ceab9f\nparent 348110dcd9331d9a8aafbe72d016c214225e4f0f\nparent 045014c17e4d65c7479c8ba5237af1a10b0784d7\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1638574070 +0000\ncommitter GitHub <noreply@github.com> 1638574070 +0000\n\nMerge #10920\n\n10920: minor: Shorten spans of mismatched_arg_count diag r=Veykril a=Veykril\n\nFixes #5289\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ea199dcbec97501eb78f309a8ac59d70d52da2cc", "html_url": "https://github.com/rust-lang/rust/commit/ea199dcbec97501eb78f309a8ac59d70d52da2cc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ea199dcbec97501eb78f309a8ac59d70d52da2cc/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "348110dcd9331d9a8aafbe72d016c214225e4f0f", "url": "https://api.github.com/repos/rust-lang/rust/commits/348110dcd9331d9a8aafbe72d016c214225e4f0f", "html_url": "https://github.com/rust-lang/rust/commit/348110dcd9331d9a8aafbe72d016c214225e4f0f"}, {"sha": "045014c17e4d65c7479c8ba5237af1a10b0784d7", "url": "https://api.github.com/repos/rust-lang/rust/commits/045014c17e4d65c7479c8ba5237af1a10b0784d7", "html_url": "https://github.com/rust-lang/rust/commit/045014c17e4d65c7479c8ba5237af1a10b0784d7"}], "stats": {"total": 46, "additions": 22, "deletions": 24}, "files": [{"sha": "78716fc09936d6d0ed342b94729d2617470b5abe", "filename": "crates/ide_diagnostics/src/handlers/mismatched_arg_count.rs", "status": "modified", "additions": 22, "deletions": 24, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/ea199dcbec97501eb78f309a8ac59d70d52da2cc/crates%2Fide_diagnostics%2Fsrc%2Fhandlers%2Fmismatched_arg_count.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea199dcbec97501eb78f309a8ac59d70d52da2cc/crates%2Fide_diagnostics%2Fsrc%2Fhandlers%2Fmismatched_arg_count.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_diagnostics%2Fsrc%2Fhandlers%2Fmismatched_arg_count.rs?ref=ea199dcbec97501eb78f309a8ac59d70d52da2cc", "patch": "@@ -2,7 +2,7 @@ use ide_db::base_db::{FileRange, SourceDatabase};\n use syntax::{\n     algo::find_node_at_range,\n     ast::{self, HasArgList},\n-    AstNode,\n+    AstNode, TextRange,\n };\n \n use crate::{Diagnostic, DiagnosticsContext};\n@@ -16,46 +16,44 @@ pub(crate) fn mismatched_arg_count(\n ) -> Diagnostic {\n     let s = if d.expected == 1 { \"\" } else { \"s\" };\n     let message = format!(\"expected {} argument{}, found {}\", d.expected, s, d.found);\n-    Diagnostic::new(\n-        \"mismatched-arg-count\",\n-        message,\n-        invalid_args_range(ctx, d).unwrap_or_else(|it| it).range,\n-    )\n+    Diagnostic::new(\"mismatched-arg-count\", message, invalid_args_range(ctx, d))\n }\n \n-fn invalid_args_range(\n-    ctx: &DiagnosticsContext<'_>,\n-    d: &hir::MismatchedArgCount,\n-) -> Result<FileRange, FileRange> {\n-    let full_range = ctx.sema.diagnostics_display_range(d.call_expr.clone().map(|it| it.into()));\n+fn invalid_args_range(ctx: &DiagnosticsContext<'_>, d: &hir::MismatchedArgCount) -> TextRange {\n+    let FileRange { file_id, range } =\n+        ctx.sema.diagnostics_display_range(d.call_expr.clone().map(|it| it.into()));\n \n-    let source_file = ctx.sema.db.parse(full_range.file_id);\n-    let expr = find_node_at_range::<ast::Expr>(&source_file.syntax_node(), full_range.range)\n-        .filter(|it| it.syntax().text_range() == full_range.range);\n+    let source_file = ctx.sema.db.parse(file_id);\n+    let expr = find_node_at_range::<ast::Expr>(&source_file.syntax_node(), range)\n+        .filter(|it| it.syntax().text_range() == range);\n     let arg_list = match expr {\n         Some(ast::Expr::CallExpr(call)) => call.arg_list(),\n         Some(ast::Expr::MethodCallExpr(call)) => call.arg_list(),\n         _ => None,\n     };\n     let arg_list = match arg_list {\n         Some(it) => it,\n-        None => return Err(full_range),\n+        None => return range,\n     };\n-    let arg_list_range =\n-        FileRange { file_id: full_range.file_id, range: arg_list.syntax().text_range() };\n     if d.found < d.expected {\n         if d.found == 0 {\n-            return Ok(arg_list_range);\n+            return arg_list.syntax().text_range();\n         }\n         if let Some(r_paren) = arg_list.r_paren_token() {\n-            return Ok(FileRange { file_id: full_range.file_id, range: r_paren.text_range() });\n+            return r_paren.text_range();\n         }\n     }\n     if d.expected < d.found {\n-        return Ok(arg_list_range);\n+        if d.expected == 0 {\n+            return arg_list.syntax().text_range();\n+        }\n+        let zip = arg_list.args().nth(d.expected).zip(arg_list.r_paren_token());\n+        if let Some((arg, r_paren)) = zip {\n+            return arg.syntax().text_range().cover(r_paren.text_range());\n+        }\n     }\n \n-    Err(full_range)\n+    range\n }\n \n #[cfg(test)]\n@@ -204,7 +202,7 @@ impl Foo {\n     fn new() {\n         Foo::Bar(0);\n         Foo::Bar(0, 1);\n-              //^^^^^^ error: expected 1 argument, found 2\n+                  //^^ error: expected 1 argument, found 2\n         Foo::Bar();\n               //^^ error: expected 1 argument, found 0\n     }\n@@ -227,7 +225,7 @@ fn f() {\n     unsafe {\n         fixed(0);\n         fixed(0, 1);\n-           //^^^^^^ error: expected 1 argument, found 2\n+               //^^ error: expected 1 argument, found 2\n         varargs(0);\n         varargs(0, 1);\n         varargs2();\n@@ -249,7 +247,7 @@ fn main() {\n    //^^ error: expected 1 argument, found 0\n     f(());\n     f((), ());\n-   //^^^^^^^^ error: expected 1 argument, found 2\n+        //^^^ error: expected 1 argument, found 2\n }\n \"#,\n         )"}]}