{"sha": "52fe50a97b702f3e72600b19936f5f355d897d1e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUyZmU1MGE5N2I3MDJmM2U3MjYwMGIxOTkzNmY1ZjM1NWQ4OTdkMWU=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-01-19T18:49:19Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-01-19T18:49:19Z"}, "message": "Record `FileAstId`s for block expressiosn\n\nEvery block expression may contain inner items, so we need to be able\nto refer to any block expression and use it as a salsa key.", "tree": {"sha": "175a7be6d7cb335834b73cb9aba6d5dc4bcb1adf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/175a7be6d7cb335834b73cb9aba6d5dc4bcb1adf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/52fe50a97b702f3e72600b19936f5f355d897d1e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/52fe50a97b702f3e72600b19936f5f355d897d1e", "html_url": "https://github.com/rust-lang/rust/commit/52fe50a97b702f3e72600b19936f5f355d897d1e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/52fe50a97b702f3e72600b19936f5f355d897d1e/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "02edb4b31be02fdab9c970cafb38439f472c0696", "url": "https://api.github.com/repos/rust-lang/rust/commits/02edb4b31be02fdab9c970cafb38439f472c0696", "html_url": "https://github.com/rust-lang/rust/commit/02edb4b31be02fdab9c970cafb38439f472c0696"}], "stats": {"total": 20, "additions": 14, "deletions": 6}, "files": [{"sha": "0991fffd8581f2f8dd29791ec5857371816dd5de", "filename": "crates/hir_expand/src/ast_id_map.rs", "status": "modified", "additions": 14, "deletions": 6, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/52fe50a97b702f3e72600b19936f5f355d897d1e/crates%2Fhir_expand%2Fsrc%2Fast_id_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52fe50a97b702f3e72600b19936f5f355d897d1e/crates%2Fhir_expand%2Fsrc%2Fast_id_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fast_id_map.rs?ref=52fe50a97b702f3e72600b19936f5f355d897d1e", "patch": "@@ -13,7 +13,7 @@ use std::{\n };\n \n use la_arena::{Arena, Idx};\n-use syntax::{ast, AstNode, AstPtr, SyntaxNode, SyntaxNodePtr};\n+use syntax::{ast, match_ast, AstNode, AstPtr, SyntaxNode, SyntaxNodePtr};\n \n /// `AstId` points to an AST node in a specific file.\n pub struct FileAstId<N: AstNode> {\n@@ -72,12 +72,20 @@ impl AstIdMap {\n         // get lower ids then children. That is, adding a new child does not\n         // change parent's id. This means that, say, adding a new function to a\n         // trait does not change ids of top-level items, which helps caching.\n-        bdfs(node, |it| match ast::Item::cast(it) {\n-            Some(module_item) => {\n-                res.alloc(module_item.syntax());\n-                true\n+        bdfs(node, |it| {\n+            match_ast! {\n+                match it {\n+                    ast::Item(module_item) => {\n+                        res.alloc(module_item.syntax());\n+                        true\n+                    },\n+                    ast::BlockExpr(block) => {\n+                        res.alloc(block.syntax());\n+                        true\n+                    },\n+                    _ => false,\n+                }\n             }\n-            None => false,\n         });\n         res\n     }"}]}