{"sha": "379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "node_id": "C_kwDOAAsO6NoAKDM3OWU5NGY1YTRhZWJlN2RjMmQ4NzQyNjUzY2EyNDRkOTJiMDZmM2Q", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-05T14:32:25Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-05T14:32:25Z"}, "message": "Auto merge of #94480 - bjorn3:no_build_helper, r=Mark-Simulacrum\n\nRemove build_helper\n\nThe majority of the code is only used by either rustbuild or\nrustc_llvm's build script. Rust_build is compiled once for rustbuild and\nonce for every stage. This means that the majority of the code in this\ncrate is needlessly compiled multiple times. By moving only the code\nactually used by the respective crates to rustbuild and rustc_llvm's\nbuild script, this needless duplicate compilation is avoided.", "tree": {"sha": "5e905cb8bd2e883878d8e6fc8842b6284cd5a4bd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5e905cb8bd2e883878d8e6fc8842b6284cd5a4bd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "html_url": "https://github.com/rust-lang/rust/commit/379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c8a49fc90281d9a3227a547b5bac8e01d17325be", "url": "https://api.github.com/repos/rust-lang/rust/commits/c8a49fc90281d9a3227a547b5bac8e01d17325be", "html_url": "https://github.com/rust-lang/rust/commit/c8a49fc90281d9a3227a547b5bac8e01d17325be"}, {"sha": "e657da72aa4bd7ed5edda194b770903ea0cf1dd1", "url": "https://api.github.com/repos/rust-lang/rust/commits/e657da72aa4bd7ed5edda194b770903ea0cf1dd1", "html_url": "https://github.com/rust-lang/rust/commit/e657da72aa4bd7ed5edda194b770903ea0cf1dd1"}], "stats": {"total": 508, "additions": 236, "deletions": 272}, "files": [{"sha": "2ee9a872d3ee244a0ab1e5b32175a2d3db2fc355", "filename": "Cargo.lock", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -214,7 +214,6 @@ dependencies = [\n name = \"bootstrap\"\n version = \"0.0.0\"\n dependencies = [\n- \"build_helper\",\n  \"cc\",\n  \"cmake\",\n  \"filetime\",\n@@ -256,10 +255,6 @@ dependencies = [\n  \"toml\",\n ]\n \n-[[package]]\n-name = \"build_helper\"\n-version = \"0.1.0\"\n-\n [[package]]\n name = \"bump-stage0\"\n version = \"0.1.0\"\n@@ -3891,7 +3886,6 @@ dependencies = [\n name = \"rustc_llvm\"\n version = \"0.0.0\"\n dependencies = [\n- \"build_helper\",\n  \"cc\",\n  \"libc\",\n ]"}, {"sha": "34556df3c6d79e67e5004afbfdba234751caca68", "filename": "compiler/rustc_llvm/Cargo.toml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/compiler%2Frustc_llvm%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/compiler%2Frustc_llvm%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_llvm%2FCargo.toml?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -11,5 +11,4 @@ emscripten = []\n libc = \"0.2.73\"\n \n [build-dependencies]\n-build_helper = { path = \"../../src/build_helper\" }\n cc = \"1.0.69\""}, {"sha": "ac758c15cca7875fce627f5f92879c881d258307", "filename": "compiler/rustc_llvm/build.rs", "status": "modified", "additions": 66, "deletions": 5, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/compiler%2Frustc_llvm%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/compiler%2Frustc_llvm%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_llvm%2Fbuild.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -1,8 +1,8 @@\n use std::env;\n+use std::ffi::{OsStr, OsString};\n+use std::fmt::Display;\n use std::path::{Path, PathBuf};\n-use std::process::Command;\n-\n-use build_helper::{output, tracked_env_var_os};\n+use std::process::{Command, Stdio};\n \n fn detect_llvm_link() -> (&'static str, &'static str) {\n     // Force the link mode we want, preferring static by default, but\n@@ -14,13 +14,74 @@ fn detect_llvm_link() -> (&'static str, &'static str) {\n     }\n }\n \n+// Because Cargo adds the compiler's dylib path to our library search path, llvm-config may\n+// break: the dylib path for the compiler, as of this writing, contains a copy of the LLVM\n+// shared library, which means that when our freshly built llvm-config goes to load it's\n+// associated LLVM, it actually loads the compiler's LLVM. In particular when building the first\n+// compiler (i.e., in stage 0) that's a problem, as the compiler's LLVM is likely different from\n+// the one we want to use. As such, we restore the environment to what bootstrap saw. This isn't\n+// perfect -- we might actually want to see something from Cargo's added library paths -- but\n+// for now it works.\n+fn restore_library_path() {\n+    let key = tracked_env_var_os(\"REAL_LIBRARY_PATH_VAR\").expect(\"REAL_LIBRARY_PATH_VAR\");\n+    if let Some(env) = tracked_env_var_os(\"REAL_LIBRARY_PATH\") {\n+        env::set_var(&key, &env);\n+    } else {\n+        env::remove_var(&key);\n+    }\n+}\n+\n+/// Reads an environment variable and adds it to dependencies.\n+/// Supposed to be used for all variables except those set for build scripts by cargo\n+/// <https://doc.rust-lang.org/cargo/reference/environment-variables.html#environment-variables-cargo-sets-for-build-scripts>\n+fn tracked_env_var_os<K: AsRef<OsStr> + Display>(key: K) -> Option<OsString> {\n+    println!(\"cargo:rerun-if-env-changed={}\", key);\n+    env::var_os(key)\n+}\n+\n+fn rerun_if_changed_anything_in_dir(dir: &Path) {\n+    let mut stack = dir\n+        .read_dir()\n+        .unwrap()\n+        .map(|e| e.unwrap())\n+        .filter(|e| &*e.file_name() != \".git\")\n+        .collect::<Vec<_>>();\n+    while let Some(entry) = stack.pop() {\n+        let path = entry.path();\n+        if entry.file_type().unwrap().is_dir() {\n+            stack.extend(path.read_dir().unwrap().map(|e| e.unwrap()));\n+        } else {\n+            println!(\"cargo:rerun-if-changed={}\", path.display());\n+        }\n+    }\n+}\n+\n+#[track_caller]\n+fn output(cmd: &mut Command) -> String {\n+    let output = match cmd.stderr(Stdio::inherit()).output() {\n+        Ok(status) => status,\n+        Err(e) => {\n+            println!(\"\\n\\nfailed to execute command: {:?}\\nerror: {}\\n\\n\", cmd, e);\n+            std::process::exit(1);\n+        }\n+    };\n+    if !output.status.success() {\n+        panic!(\n+            \"command did not execute successfully: {:?}\\n\\\n+             expected success, got: {}\",\n+            cmd, output.status\n+        );\n+    }\n+    String::from_utf8(output.stdout).unwrap()\n+}\n+\n fn main() {\n     if tracked_env_var_os(\"RUST_CHECK\").is_some() {\n         // If we're just running `check`, there's no need for LLVM to be built.\n         return;\n     }\n \n-    build_helper::restore_library_path();\n+    restore_library_path();\n \n     let target = env::var(\"TARGET\").expect(\"TARGET was not set\");\n     let llvm_config =\n@@ -160,7 +221,7 @@ fn main() {\n         cfg.debug(false);\n     }\n \n-    build_helper::rerun_if_changed_anything_in_dir(Path::new(\"llvm-wrapper\"));\n+    rerun_if_changed_anything_in_dir(Path::new(\"llvm-wrapper\"));\n     cfg.file(\"llvm-wrapper/PassWrapper.cpp\")\n         .file(\"llvm-wrapper/RustWrapper.cpp\")\n         .file(\"llvm-wrapper/ArchiveWrapper.cpp\")"}, {"sha": "fe9d6a727ed1eceb86674ae0684c09b54f0218ed", "filename": "src/bootstrap/Cargo.toml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCargo.toml?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -34,7 +34,6 @@ path = \"bin/llvm-config-wrapper.rs\"\n test = false\n \n [dependencies]\n-build_helper = { path = \"../build_helper\" }\n cmake = \"0.1.38\"\n filetime = \"0.2\"\n getopts = \"0.2.19\""}, {"sha": "fc55c8626d99fe28ae72b851dc7cf9c83ca166df", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -11,8 +11,6 @@ use std::path::{Component, Path, PathBuf};\n use std::process::Command;\n use std::time::{Duration, Instant};\n \n-use build_helper::{output, t};\n-\n use crate::cache::{Cache, Interned, INTERNER};\n use crate::check;\n use crate::compile;\n@@ -25,7 +23,7 @@ use crate::native;\n use crate::run;\n use crate::test;\n use crate::tool::{self, SourceType};\n-use crate::util::{self, add_dylib_path, add_link_lib_path, exe, libdir};\n+use crate::util::{self, add_dylib_path, add_link_lib_path, exe, libdir, output, t};\n use crate::EXTRA_CHECK_CFGS;\n use crate::{Build, CLang, DocTests, GitRepo, Mode};\n "}, {"sha": "7ce446876118af13244c4c914dc2dfcdf1ca525a", "filename": "src/bootstrap/cc_detect.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fcc_detect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fcc_detect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcc_detect.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -26,9 +26,8 @@ use std::path::{Path, PathBuf};\n use std::process::Command;\n use std::{env, iter};\n \n-use build_helper::output;\n-\n use crate::config::{Target, TargetSelection};\n+use crate::util::output;\n use crate::{Build, CLang, GitRepo};\n \n // The `cc` crate doesn't provide a way to obtain a path to the detected archiver,"}, {"sha": "1932a0017ee255e5539b8901401c6ecd2efd9350", "filename": "src/bootstrap/channel.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fchannel.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fchannel.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fchannel.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -8,8 +8,7 @@\n use std::path::Path;\n use std::process::Command;\n \n-use build_helper::output;\n-\n+use crate::util::output;\n use crate::Build;\n \n pub enum GitInfo {"}, {"sha": "069f3d6acf158937d278a13a277bec4e90c762c6", "filename": "src/bootstrap/clean.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fclean.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fclean.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fclean.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -9,8 +9,7 @@ use std::fs;\n use std::io::{self, ErrorKind};\n use std::path::Path;\n \n-use build_helper::t;\n-\n+use crate::util::t;\n use crate::Build;\n \n pub fn clean(build: &Build, all: bool) {"}, {"sha": "9cfd9f92aa7cdb05021bd52027866660b480f171", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -16,7 +16,6 @@ use std::path::{Path, PathBuf};\n use std::process::{exit, Command, Stdio};\n use std::str;\n \n-use build_helper::{output, t, up_to_date};\n use serde::Deserialize;\n \n use crate::builder::Cargo;\n@@ -26,7 +25,7 @@ use crate::config::{LlvmLibunwind, TargetSelection};\n use crate::dist;\n use crate::native;\n use crate::tool::SourceType;\n-use crate::util::{exe, is_debug_info, is_dylib, symlink_dir};\n+use crate::util::{exe, is_debug_info, is_dylib, output, symlink_dir, t, up_to_date};\n use crate::LLVM_TOOLS;\n use crate::{CLang, Compiler, DependencyType, GitRepo, Mode};\n "}, {"sha": "b17b94f2893953a2cfa69ac79437ce7178e05fab", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -17,8 +17,7 @@ use crate::cache::{Interned, INTERNER};\n use crate::channel::GitInfo;\n pub use crate::flags::Subcommand;\n use crate::flags::{Color, Flags};\n-use crate::util::exe;\n-use build_helper::t;\n+use crate::util::{exe, t};\n use serde::Deserialize;\n \n macro_rules! check_ci_llvm {"}, {"sha": "5f92cc2ca6faddd2c004fffe8b3b1262c7529ce8", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 1, "deletions": 11, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -14,15 +14,13 @@ use std::fs;\n use std::path::{Path, PathBuf};\n use std::process::Command;\n \n-use build_helper::{output, t};\n-\n use crate::builder::{Builder, Kind, RunConfig, ShouldRun, Step};\n use crate::cache::{Interned, INTERNER};\n use crate::compile;\n use crate::config::TargetSelection;\n use crate::tarball::{GeneratedTarball, OverlayKind, Tarball};\n use crate::tool::{self, Tool};\n-use crate::util::{exe, is_dylib, timeit};\n+use crate::util::{exe, is_dylib, output, t, timeit};\n use crate::{Compiler, DependencyType, Mode, LLVM_TOOLS};\n \n pub fn pkgname(builder: &Builder<'_>, component: &str) -> String {\n@@ -635,14 +633,6 @@ impl Step for RustcDev {\n             &[],\n             &tarball.image_dir().join(\"lib/rustlib/rustc-src/rust\"),\n         );\n-        // This particular crate is used as a build dependency of the above.\n-        copy_src_dirs(\n-            builder,\n-            &builder.src,\n-            &[\"src/build_helper\"],\n-            &[],\n-            &tarball.image_dir().join(\"lib/rustlib/rustc-src/rust\"),\n-        );\n         for file in src_files {\n             tarball.add_file(builder.src.join(file), \"lib/rustlib/rustc-src/rust\", 0o644);\n         }"}, {"sha": "be55871b56a2801468606afae5fe615c50c52d1e", "filename": "src/bootstrap/doc.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdoc.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -12,15 +12,13 @@ use std::fs;\n use std::io;\n use std::path::{Path, PathBuf};\n \n-use crate::Mode;\n-use build_helper::{t, up_to_date};\n-\n use crate::builder::{Builder, Compiler, Kind, RunConfig, ShouldRun, Step};\n use crate::cache::{Interned, INTERNER};\n use crate::compile;\n use crate::config::{Config, TargetSelection};\n use crate::tool::{self, prepare_tool_cargo, SourceType, Tool};\n-use crate::util::symlink_dir;\n+use crate::util::{symlink_dir, t, up_to_date};\n+use crate::Mode;\n \n macro_rules! submodule_helper {\n     ($path:expr, submodule) => {"}, {"sha": "e34b40a93ff47c577e092cbdf1a95ecc2cbf2ee4", "filename": "src/bootstrap/flags.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fflags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fflags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fflags.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -7,12 +7,12 @@ use std::env;\n use std::path::PathBuf;\n use std::process;\n \n-use build_helper::t;\n use getopts::Options;\n \n use crate::builder::Builder;\n use crate::config::{Config, TargetSelection};\n use crate::setup::Profile;\n+use crate::util::t;\n use crate::{Build, DocTests};\n \n pub enum Color {"}, {"sha": "10b846e6db2087e67181242b2346663c09b4548e", "filename": "src/bootstrap/format.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fformat.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -1,7 +1,7 @@\n //! Runs rustfmt on the repository.\n \n+use crate::util::{output, t};\n use crate::Build;\n-use build_helper::{output, t};\n use ignore::WalkBuilder;\n use std::collections::VecDeque;\n use std::path::{Path, PathBuf};"}, {"sha": "27b9196d9868e10d23deb5cfb8682ef03f788397", "filename": "src/bootstrap/install.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Finstall.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Finstall.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Finstall.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -8,7 +8,7 @@ use std::fs;\n use std::path::{Component, PathBuf};\n use std::process::Command;\n \n-use build_helper::t;\n+use crate::util::t;\n \n use crate::dist::{self, sanitize_sh};\n use crate::tarball::GeneratedTarball;"}, {"sha": "ccc8516a89abf8014e888c3b6d43e1f3446a865b", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -116,12 +116,13 @@ use std::os::unix::fs::symlink as symlink_file;\n #[cfg(windows)]\n use std::os::windows::fs::symlink_file;\n \n-use build_helper::{mtime, output, run, run_suppressed, t, try_run, try_run_suppressed};\n use filetime::FileTime;\n \n use crate::builder::Kind;\n use crate::config::{LlvmLibunwind, TargetSelection};\n-use crate::util::{exe, libdir, CiEnv};\n+use crate::util::{\n+    exe, libdir, mtime, output, run, run_suppressed, t, try_run, try_run_suppressed, CiEnv,\n+};\n \n mod builder;\n mod cache;\n@@ -1301,13 +1302,10 @@ impl Build {\n                 }\n                 // Don't include optional deps if their features are not\n                 // enabled. Ideally this would be computed from `cargo\n-                // metadata --features \u2026`, but that is somewhat slow. Just\n-                // skip `build_helper` since there aren't any operations we\n-                // want to perform on it. In the future, we may want to\n-                // consider just filtering all build and dev dependencies in\n-                // metadata::build.\n+                // metadata --features \u2026`, but that is somewhat slow. In\n+                // the future, we may want to consider just filtering all\n+                // build and dev dependencies in metadata::build.\n                 if visited.insert(dep)\n-                    && dep != \"build_helper\"\n                     && (dep != \"profiler_builtins\"\n                         || target\n                             .map(|t| self.config.profiler_enabled(t))"}, {"sha": "59dc50be47f0685e6b89fcf7cc70e514f67ac1d1", "filename": "src/bootstrap/metadata.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fmetadata.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -1,10 +1,10 @@\n use std::path::PathBuf;\n use std::process::Command;\n \n-use build_helper::output;\n use serde::Deserialize;\n \n use crate::cache::INTERNER;\n+use crate::util::output;\n use crate::{Build, Crate};\n \n #[derive(Deserialize)]"}, {"sha": "d27ad9644b56c6038d0bb58e8077a98138d2e65d", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -16,13 +16,10 @@ use std::io;\n use std::path::{Path, PathBuf};\n use std::process::Command;\n \n-use build_helper::{output, t};\n-\n use crate::builder::{Builder, RunConfig, ShouldRun, Step};\n use crate::config::TargetSelection;\n-use crate::util::{self, exe};\n+use crate::util::{self, exe, output, t, up_to_date};\n use crate::{CLang, GitRepo};\n-use build_helper::up_to_date;\n \n pub struct Meta {\n     stamp: HashStamp,"}, {"sha": "25abe7a72fdc8d5b6512106406771b66bce3dd20", "filename": "src/bootstrap/run.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Frun.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Frun.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Frun.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -1,7 +1,7 @@\n use crate::builder::{Builder, RunConfig, ShouldRun, Step};\n use crate::dist::distdir;\n use crate::tool::Tool;\n-use build_helper::output;\n+use crate::util::output;\n use std::process::Command;\n \n #[derive(Debug, Copy, Clone, PartialEq, Eq, Hash)]"}, {"sha": "8c2899c1ac01e251d5178af6c401a8d3c985940b", "filename": "src/bootstrap/sanity.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fsanity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Fsanity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fsanity.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -15,10 +15,9 @@ use std::fs;\n use std::path::PathBuf;\n use std::process::Command;\n \n-use build_helper::output;\n-\n use crate::cache::INTERNER;\n use crate::config::Target;\n+use crate::util::output;\n use crate::Build;\n \n pub struct Finder {"}, {"sha": "c743c5188e7545f47d7f858b74005107e731c01e", "filename": "src/bootstrap/tarball.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Ftarball.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Ftarball.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftarball.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -3,9 +3,8 @@ use std::{\n     process::Command,\n };\n \n-use build_helper::t;\n-\n use crate::builder::Builder;\n+use crate::util::t;\n \n #[derive(Copy, Clone)]\n pub(crate) enum OverlayKind {"}, {"sha": "e4fcb287f1228545d44301e6d5f993a7b0571763", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -11,8 +11,6 @@ use std::iter;\n use std::path::{Path, PathBuf};\n use std::process::{Command, Stdio};\n \n-use build_helper::{self, output, t};\n-\n use crate::builder::{Builder, Compiler, Kind, RunConfig, ShouldRun, Step};\n use crate::cache::Interned;\n use crate::compile;\n@@ -22,7 +20,7 @@ use crate::flags::Subcommand;\n use crate::native;\n use crate::tool::{self, SourceType, Tool};\n use crate::toolstate::ToolState;\n-use crate::util::{self, add_link_lib_path, dylib_path, dylib_path_var};\n+use crate::util::{self, add_link_lib_path, dylib_path, dylib_path_var, output, t};\n use crate::Crate as CargoCrate;\n use crate::{envify, CLang, DocTests, GitRepo, Mode};\n \n@@ -2306,9 +2304,7 @@ impl Step for Distcheck {\n                 .current_dir(&dir),\n         );\n         builder.run(\n-            Command::new(build_helper::make(&builder.config.build.triple))\n-                .arg(\"check\")\n-                .current_dir(&dir),\n+            Command::new(util::make(&builder.config.build.triple)).arg(\"check\").current_dir(&dir),\n         );\n \n         // Now make sure that rust-src has all of libstd's dependencies"}, {"sha": "2ae4d830721e8ad2f22ab900cc998d62d7297fa4", "filename": "src/bootstrap/tool.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Ftool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Ftool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftool.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -4,14 +4,12 @@ use std::fs;\n use std::path::{Path, PathBuf};\n use std::process::{exit, Command};\n \n-use build_helper::t;\n-\n use crate::builder::{Builder, Cargo as CargoCommand, RunConfig, ShouldRun, Step};\n use crate::channel::GitInfo;\n use crate::compile;\n use crate::config::TargetSelection;\n use crate::toolstate::ToolState;\n-use crate::util::{add_dylib_path, exe};\n+use crate::util::{add_dylib_path, exe, t};\n use crate::Compiler;\n use crate::Mode;\n "}, {"sha": "c7ea254c5b1d7ac6a242493b56ebcc5bb4c5fad1", "filename": "src/bootstrap/toolstate.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Ftoolstate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Ftoolstate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftoolstate.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -1,5 +1,5 @@\n use crate::builder::{Builder, RunConfig, ShouldRun, Step};\n-use build_helper::t;\n+use crate::util::t;\n use serde::{Deserialize, Serialize};\n use std::collections::HashMap;\n use std::env;"}, {"sha": "8e770d4d57fa6efeedeceaa9392b020c483a9f2e", "filename": "src/bootstrap/util.rs", "status": "modified", "additions": 143, "deletions": 4, "changes": 147, "blob_url": "https://github.com/rust-lang/rust/blob/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/379e94f5a4aebe7dc2d8742653ca244d92b06f3d/src%2Fbootstrap%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Futil.rs?ref=379e94f5a4aebe7dc2d8742653ca244d92b06f3d", "patch": "@@ -7,15 +7,38 @@ use std::env;\n use std::fs;\n use std::io;\n use std::path::{Path, PathBuf};\n-use std::process::Command;\n+use std::process::{Command, Stdio};\n use std::str;\n-use std::time::Instant;\n-\n-use build_helper::t;\n+use std::time::{Instant, SystemTime, UNIX_EPOCH};\n \n use crate::builder::Builder;\n use crate::config::{Config, TargetSelection};\n \n+/// A helper macro to `unwrap` a result except also print out details like:\n+///\n+/// * The file/line of the panic\n+/// * The expression that failed\n+/// * The error itself\n+///\n+/// This is currently used judiciously throughout the build system rather than\n+/// using a `Result` with `try!`, but this may change one day...\n+macro_rules! t {\n+    ($e:expr) => {\n+        match $e {\n+            Ok(e) => e,\n+            Err(e) => panic!(\"{} failed with {}\", stringify!($e), e),\n+        }\n+    };\n+    // it can show extra info in the second parameter\n+    ($e:expr, $extra:expr) => {\n+        match $e {\n+            Ok(e) => e,\n+            Err(e) => panic!(\"{} failed with {} ({:?})\", stringify!($e), e, $extra),\n+        }\n+    };\n+}\n+pub(crate) use t;\n+\n /// Given an executable called `name`, return the filename for the\n /// executable for a particular target.\n pub fn exe(name: &str, target: TargetSelection) -> String {\n@@ -301,3 +324,119 @@ pub fn is_valid_test_suite_arg<'a, P: AsRef<Path>>(\n         _ => None,\n     }\n }\n+\n+pub fn run(cmd: &mut Command, print_cmd_on_fail: bool) {\n+    if !try_run(cmd, print_cmd_on_fail) {\n+        std::process::exit(1);\n+    }\n+}\n+\n+pub fn try_run(cmd: &mut Command, print_cmd_on_fail: bool) -> bool {\n+    let status = match cmd.status() {\n+        Ok(status) => status,\n+        Err(e) => fail(&format!(\"failed to execute command: {:?}\\nerror: {}\", cmd, e)),\n+    };\n+    if !status.success() && print_cmd_on_fail {\n+        println!(\n+            \"\\n\\ncommand did not execute successfully: {:?}\\n\\\n+             expected success, got: {}\\n\\n\",\n+            cmd, status\n+        );\n+    }\n+    status.success()\n+}\n+\n+pub fn run_suppressed(cmd: &mut Command) {\n+    if !try_run_suppressed(cmd) {\n+        std::process::exit(1);\n+    }\n+}\n+\n+pub fn try_run_suppressed(cmd: &mut Command) -> bool {\n+    let output = match cmd.output() {\n+        Ok(status) => status,\n+        Err(e) => fail(&format!(\"failed to execute command: {:?}\\nerror: {}\", cmd, e)),\n+    };\n+    if !output.status.success() {\n+        println!(\n+            \"\\n\\ncommand did not execute successfully: {:?}\\n\\\n+             expected success, got: {}\\n\\n\\\n+             stdout ----\\n{}\\n\\\n+             stderr ----\\n{}\\n\\n\",\n+            cmd,\n+            output.status,\n+            String::from_utf8_lossy(&output.stdout),\n+            String::from_utf8_lossy(&output.stderr)\n+        );\n+    }\n+    output.status.success()\n+}\n+\n+pub fn make(host: &str) -> PathBuf {\n+    if host.contains(\"dragonfly\")\n+        || host.contains(\"freebsd\")\n+        || host.contains(\"netbsd\")\n+        || host.contains(\"openbsd\")\n+    {\n+        PathBuf::from(\"gmake\")\n+    } else {\n+        PathBuf::from(\"make\")\n+    }\n+}\n+\n+#[track_caller]\n+pub fn output(cmd: &mut Command) -> String {\n+    let output = match cmd.stderr(Stdio::inherit()).output() {\n+        Ok(status) => status,\n+        Err(e) => fail(&format!(\"failed to execute command: {:?}\\nerror: {}\", cmd, e)),\n+    };\n+    if !output.status.success() {\n+        panic!(\n+            \"command did not execute successfully: {:?}\\n\\\n+             expected success, got: {}\",\n+            cmd, output.status\n+        );\n+    }\n+    String::from_utf8(output.stdout).unwrap()\n+}\n+\n+/// Returns the last-modified time for `path`, or zero if it doesn't exist.\n+pub fn mtime(path: &Path) -> SystemTime {\n+    fs::metadata(path).and_then(|f| f.modified()).unwrap_or(UNIX_EPOCH)\n+}\n+\n+/// Returns `true` if `dst` is up to date given that the file or files in `src`\n+/// are used to generate it.\n+///\n+/// Uses last-modified time checks to verify this.\n+pub fn up_to_date(src: &Path, dst: &Path) -> bool {\n+    if !dst.exists() {\n+        return false;\n+    }\n+    let threshold = mtime(dst);\n+    let meta = match fs::metadata(src) {\n+        Ok(meta) => meta,\n+        Err(e) => panic!(\"source {:?} failed to get metadata: {}\", src, e),\n+    };\n+    if meta.is_dir() {\n+        dir_up_to_date(src, threshold)\n+    } else {\n+        meta.modified().unwrap_or(UNIX_EPOCH) <= threshold\n+    }\n+}\n+\n+fn dir_up_to_date(src: &Path, threshold: SystemTime) -> bool {\n+    t!(fs::read_dir(src)).map(|e| t!(e)).all(|e| {\n+        let meta = t!(e.metadata());\n+        if meta.is_dir() {\n+            dir_up_to_date(&e.path(), threshold)\n+        } else {\n+            meta.modified().unwrap_or(UNIX_EPOCH) < threshold\n+        }\n+    })\n+}\n+\n+fn fail(s: &str) -> ! {\n+    println!(\"\\n\\n{}\\n\\n\", s);\n+    std::process::exit(1);\n+}"}, {"sha": "d88df0e08fab3e01ef9b596bcf58629a01710301", "filename": "src/build_helper/Cargo.toml", "status": "removed", "additions": 0, "deletions": 7, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c8a49fc90281d9a3227a547b5bac8e01d17325be/src%2Fbuild_helper%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c8a49fc90281d9a3227a547b5bac8e01d17325be/src%2Fbuild_helper%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbuild_helper%2FCargo.toml?ref=c8a49fc90281d9a3227a547b5bac8e01d17325be", "patch": "@@ -1,7 +0,0 @@\n-[package]\n-name = \"build_helper\"\n-version = \"0.1.0\"\n-edition = \"2021\"\n-\n-[lib]\n-path = \"lib.rs\""}, {"sha": "24aded547315e9828dd8a0a8e92b5457aaf9914e", "filename": "src/build_helper/lib.rs", "status": "removed", "additions": 0, "deletions": 189, "changes": 189, "blob_url": "https://github.com/rust-lang/rust/blob/c8a49fc90281d9a3227a547b5bac8e01d17325be/src%2Fbuild_helper%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c8a49fc90281d9a3227a547b5bac8e01d17325be/src%2Fbuild_helper%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbuild_helper%2Flib.rs?ref=c8a49fc90281d9a3227a547b5bac8e01d17325be", "patch": "@@ -1,189 +0,0 @@\n-use std::ffi::{OsStr, OsString};\n-use std::fmt::Display;\n-use std::path::{Path, PathBuf};\n-use std::process::{Command, Stdio};\n-use std::time::{SystemTime, UNIX_EPOCH};\n-use std::{env, fs};\n-\n-/// A helper macro to `unwrap` a result except also print out details like:\n-///\n-/// * The file/line of the panic\n-/// * The expression that failed\n-/// * The error itself\n-///\n-/// This is currently used judiciously throughout the build system rather than\n-/// using a `Result` with `try!`, but this may change one day...\n-#[macro_export]\n-macro_rules! t {\n-    ($e:expr) => {\n-        match $e {\n-            Ok(e) => e,\n-            Err(e) => panic!(\"{} failed with {}\", stringify!($e), e),\n-        }\n-    };\n-    // it can show extra info in the second parameter\n-    ($e:expr, $extra:expr) => {\n-        match $e {\n-            Ok(e) => e,\n-            Err(e) => panic!(\"{} failed with {} ({:?})\", stringify!($e), e, $extra),\n-        }\n-    };\n-}\n-\n-/// Reads an environment variable and adds it to dependencies.\n-/// Supposed to be used for all variables except those set for build scripts by cargo\n-/// <https://doc.rust-lang.org/cargo/reference/environment-variables.html#environment-variables-cargo-sets-for-build-scripts>\n-pub fn tracked_env_var_os<K: AsRef<OsStr> + Display>(key: K) -> Option<OsString> {\n-    println!(\"cargo:rerun-if-env-changed={}\", key);\n-    env::var_os(key)\n-}\n-\n-// Because Cargo adds the compiler's dylib path to our library search path, llvm-config may\n-// break: the dylib path for the compiler, as of this writing, contains a copy of the LLVM\n-// shared library, which means that when our freshly built llvm-config goes to load it's\n-// associated LLVM, it actually loads the compiler's LLVM. In particular when building the first\n-// compiler (i.e., in stage 0) that's a problem, as the compiler's LLVM is likely different from\n-// the one we want to use. As such, we restore the environment to what bootstrap saw. This isn't\n-// perfect -- we might actually want to see something from Cargo's added library paths -- but\n-// for now it works.\n-pub fn restore_library_path() {\n-    let key = tracked_env_var_os(\"REAL_LIBRARY_PATH_VAR\").expect(\"REAL_LIBRARY_PATH_VAR\");\n-    if let Some(env) = tracked_env_var_os(\"REAL_LIBRARY_PATH\") {\n-        env::set_var(&key, &env);\n-    } else {\n-        env::remove_var(&key);\n-    }\n-}\n-\n-pub fn run(cmd: &mut Command, print_cmd_on_fail: bool) {\n-    if !try_run(cmd, print_cmd_on_fail) {\n-        std::process::exit(1);\n-    }\n-}\n-\n-pub fn try_run(cmd: &mut Command, print_cmd_on_fail: bool) -> bool {\n-    let status = match cmd.status() {\n-        Ok(status) => status,\n-        Err(e) => fail(&format!(\"failed to execute command: {:?}\\nerror: {}\", cmd, e)),\n-    };\n-    if !status.success() && print_cmd_on_fail {\n-        println!(\n-            \"\\n\\ncommand did not execute successfully: {:?}\\n\\\n-             expected success, got: {}\\n\\n\",\n-            cmd, status\n-        );\n-    }\n-    status.success()\n-}\n-\n-pub fn run_suppressed(cmd: &mut Command) {\n-    if !try_run_suppressed(cmd) {\n-        std::process::exit(1);\n-    }\n-}\n-\n-pub fn try_run_suppressed(cmd: &mut Command) -> bool {\n-    let output = match cmd.output() {\n-        Ok(status) => status,\n-        Err(e) => fail(&format!(\"failed to execute command: {:?}\\nerror: {}\", cmd, e)),\n-    };\n-    if !output.status.success() {\n-        println!(\n-            \"\\n\\ncommand did not execute successfully: {:?}\\n\\\n-             expected success, got: {}\\n\\n\\\n-             stdout ----\\n{}\\n\\\n-             stderr ----\\n{}\\n\\n\",\n-            cmd,\n-            output.status,\n-            String::from_utf8_lossy(&output.stdout),\n-            String::from_utf8_lossy(&output.stderr)\n-        );\n-    }\n-    output.status.success()\n-}\n-\n-pub fn make(host: &str) -> PathBuf {\n-    if host.contains(\"dragonfly\")\n-        || host.contains(\"freebsd\")\n-        || host.contains(\"netbsd\")\n-        || host.contains(\"openbsd\")\n-    {\n-        PathBuf::from(\"gmake\")\n-    } else {\n-        PathBuf::from(\"make\")\n-    }\n-}\n-\n-#[track_caller]\n-pub fn output(cmd: &mut Command) -> String {\n-    let output = match cmd.stderr(Stdio::inherit()).output() {\n-        Ok(status) => status,\n-        Err(e) => fail(&format!(\"failed to execute command: {:?}\\nerror: {}\", cmd, e)),\n-    };\n-    if !output.status.success() {\n-        panic!(\n-            \"command did not execute successfully: {:?}\\n\\\n-             expected success, got: {}\",\n-            cmd, output.status\n-        );\n-    }\n-    String::from_utf8(output.stdout).unwrap()\n-}\n-\n-pub fn rerun_if_changed_anything_in_dir(dir: &Path) {\n-    let mut stack = dir\n-        .read_dir()\n-        .unwrap()\n-        .map(|e| e.unwrap())\n-        .filter(|e| &*e.file_name() != \".git\")\n-        .collect::<Vec<_>>();\n-    while let Some(entry) = stack.pop() {\n-        let path = entry.path();\n-        if entry.file_type().unwrap().is_dir() {\n-            stack.extend(path.read_dir().unwrap().map(|e| e.unwrap()));\n-        } else {\n-            println!(\"cargo:rerun-if-changed={}\", path.display());\n-        }\n-    }\n-}\n-\n-/// Returns the last-modified time for `path`, or zero if it doesn't exist.\n-pub fn mtime(path: &Path) -> SystemTime {\n-    fs::metadata(path).and_then(|f| f.modified()).unwrap_or(UNIX_EPOCH)\n-}\n-\n-/// Returns `true` if `dst` is up to date given that the file or files in `src`\n-/// are used to generate it.\n-///\n-/// Uses last-modified time checks to verify this.\n-pub fn up_to_date(src: &Path, dst: &Path) -> bool {\n-    if !dst.exists() {\n-        return false;\n-    }\n-    let threshold = mtime(dst);\n-    let meta = match fs::metadata(src) {\n-        Ok(meta) => meta,\n-        Err(e) => panic!(\"source {:?} failed to get metadata: {}\", src, e),\n-    };\n-    if meta.is_dir() {\n-        dir_up_to_date(src, threshold)\n-    } else {\n-        meta.modified().unwrap_or(UNIX_EPOCH) <= threshold\n-    }\n-}\n-\n-fn dir_up_to_date(src: &Path, threshold: SystemTime) -> bool {\n-    t!(fs::read_dir(src)).map(|e| t!(e)).all(|e| {\n-        let meta = t!(e.metadata());\n-        if meta.is_dir() {\n-            dir_up_to_date(&e.path(), threshold)\n-        } else {\n-            meta.modified().unwrap_or(UNIX_EPOCH) < threshold\n-        }\n-    })\n-}\n-\n-fn fail(s: &str) -> ! {\n-    println!(\"\\n\\n{}\\n\\n\", s);\n-    std::process::exit(1);\n-}"}]}