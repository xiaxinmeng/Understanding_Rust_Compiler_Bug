{"sha": "7a34d392787473f62dda3028a2c94fa88cc71c70", "node_id": "C_kwDOAAsO6NoAKDdhMzRkMzkyNzg3NDczZjYyZGRhMzAyOGEyYzk0ZmE4OGNjNzFjNzA", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-08-13T21:10:11Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-13T21:10:11Z"}, "message": "Rollup merge of #100464 - khyperia:lld-icf-on-windows, r=jyn514\n\nMake `[rust] use-lld=true` work on windows\n\nBefore, it would fail with \"error: ignoring unknown argument '-Wl,--icf=all'\"\n\nThis option was introduced in https://github.com/rust-lang/rust/pull/99062 (well, technically https://github.com/rust-lang/rust/pull/99680)\n\nSee zulip thread: https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/rust-lld.3A.20error.3A.20ignoring.20unknown.20argument.20'-Wl.2C--icf.3Dall'", "tree": {"sha": "ff28f96c6ccf24fb829d7e252297add2deb34afb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ff28f96c6ccf24fb829d7e252297add2deb34afb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7a34d392787473f62dda3028a2c94fa88cc71c70", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi+BMzCRBK7hj4Ov3rIwAAOIUIADcLPEhizJfYowfaGJJLbhtB\nXe4wdGd2ESrPg5eeQ8dMAqHhTwXQTSAhKqeiroFJy3ZebAe0jww/4SDeMAY929Vd\niw71GwQegIWmf95hfDyzmnOppjb6kxWCD9Buywt4IIqMALn7MImSaMBbig1zScXx\nNYesd8Tz2RZyYafNea7TfpPdaEhoUhxeNI8o6NVmXSX2jmgOHX6N6SSaOxpMnq5G\nYdXARwqLQpfnsFAYQSLAHMsJBTcF8PYhnAPz34FVol6Hqhc6RH9hEJLO6aW6HcIr\nOHfivwbR0XECX3VXPx7AIuqtL5wy6yICvm8CfpkR4TZwiQp2nlS/GlI0pmdvdR8=\n=tnVG\n-----END PGP SIGNATURE-----\n", "payload": "tree ff28f96c6ccf24fb829d7e252297add2deb34afb\nparent b1d77dd2dce200e2ca7b5cf1478d388dc1ae8a86\nparent dcead65e48bb4957f9f20bdb037806dfa6c2db66\nauthor Michael Goulet <michael@errs.io> 1660425011 -0700\ncommitter GitHub <noreply@github.com> 1660425011 -0700\n\nRollup merge of #100464 - khyperia:lld-icf-on-windows, r=jyn514\n\nMake `[rust] use-lld=true` work on windows\n\nBefore, it would fail with \"error: ignoring unknown argument '-Wl,--icf=all'\"\n\nThis option was introduced in https://github.com/rust-lang/rust/pull/99062 (well, technically https://github.com/rust-lang/rust/pull/99680)\n\nSee zulip thread: https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/rust-lld.3A.20error.3A.20ignoring.20unknown.20argument.20'-Wl.2C--icf.3Dall'\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7a34d392787473f62dda3028a2c94fa88cc71c70", "html_url": "https://github.com/rust-lang/rust/commit/7a34d392787473f62dda3028a2c94fa88cc71c70", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7a34d392787473f62dda3028a2c94fa88cc71c70/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b1d77dd2dce200e2ca7b5cf1478d388dc1ae8a86", "url": "https://api.github.com/repos/rust-lang/rust/commits/b1d77dd2dce200e2ca7b5cf1478d388dc1ae8a86", "html_url": "https://github.com/rust-lang/rust/commit/b1d77dd2dce200e2ca7b5cf1478d388dc1ae8a86"}, {"sha": "dcead65e48bb4957f9f20bdb037806dfa6c2db66", "url": "https://api.github.com/repos/rust-lang/rust/commits/dcead65e48bb4957f9f20bdb037806dfa6c2db66", "html_url": "https://github.com/rust-lang/rust/commit/dcead65e48bb4957f9f20bdb037806dfa6c2db66"}], "stats": {"total": 7, "additions": 6, "deletions": 1}, "files": [{"sha": "c3aabb16a9b9af131c70095d4ecc6e667efe5a07", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/7a34d392787473f62dda3028a2c94fa88cc71c70/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a34d392787473f62dda3028a2c94fa88cc71c70/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=7a34d392787473f62dda3028a2c94fa88cc71c70", "patch": "@@ -658,7 +658,12 @@ impl Step for Rustc {\n \n         // With LLD, we can use ICF (identical code folding) to reduce the executable size\n         // of librustc_driver/rustc and to improve i-cache utilization.\n-        if builder.config.use_lld {\n+        //\n+        // -Wl,[link options] doesn't work on MSVC. However, /OPT:ICF (technically /OPT:REF,ICF)\n+        // is already on by default in MSVC optimized builds, which is interpreted as --icf=all:\n+        // https://github.com/llvm/llvm-project/blob/3329cec2f79185bafd678f310fafadba2a8c76d2/lld/COFF/Driver.cpp#L1746\n+        // https://github.com/rust-lang/rust/blob/f22819bcce4abaff7d1246a56eec493418f9f4ee/compiler/rustc_codegen_ssa/src/back/linker.rs#L827\n+        if builder.config.use_lld && !compiler.host.contains(\"msvc\") {\n             cargo.rustflag(\"-Clink-args=-Wl,--icf=all\");\n         }\n "}]}