{"sha": "d381cc072a9c9c0fef605c56ed77d538a49c8ead", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQzODFjYzA3MmE5YzljMGZlZjYwNWM1NmVkNzdkNTM4YTQ5YzhlYWQ=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2011-12-15T05:02:47Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2011-12-15T21:44:06Z"}, "message": "resurrect tps_fn() and put it to use this time.", "tree": {"sha": "007a94af6e63fffb00c61b2def18155c2e7cba5d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/007a94af6e63fffb00c61b2def18155c2e7cba5d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d381cc072a9c9c0fef605c56ed77d538a49c8ead", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d381cc072a9c9c0fef605c56ed77d538a49c8ead", "html_url": "https://github.com/rust-lang/rust/commit/d381cc072a9c9c0fef605c56ed77d538a49c8ead", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d381cc072a9c9c0fef605c56ed77d538a49c8ead/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7694689044352a5dca9a7622f11fb0f3d601154e", "url": "https://api.github.com/repos/rust-lang/rust/commits/7694689044352a5dca9a7622f11fb0f3d601154e", "html_url": "https://github.com/rust-lang/rust/commit/7694689044352a5dca9a7622f11fb0f3d601154e"}], "stats": {"total": 8, "additions": 5, "deletions": 3}, "files": [{"sha": "ce106c78eace7bc47e8ff7f269d93e62a2f8f7a8", "filename": "src/comp/middle/trans.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d381cc072a9c9c0fef605c56ed77d538a49c8ead/src%2Fcomp%2Fmiddle%2Ftrans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d381cc072a9c9c0fef605c56ed77d538a49c8ead/src%2Fcomp%2Fmiddle%2Ftrans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans.rs?ref=d381cc072a9c9c0fef605c56ed77d538a49c8ead", "patch": "@@ -937,7 +937,7 @@ fn trans_stack_local_derived_tydesc(cx: @block_ctxt, llsz: ValueRef,\n \n // Objects and closures store their type parameters differently (in the object\n // or closure itself rather than in the type descriptor).\n-tag ty_param_storage { tps_normal; tps_obj(uint); }\n+tag ty_param_storage { tps_normal; tps_obj(uint); tps_fn(uint); }\n \n fn get_derived_tydesc(cx: @block_ctxt, t: ty::t, escapes: bool,\n                       storage: ty_param_storage,\n@@ -958,7 +958,7 @@ fn get_derived_tydesc(cx: @block_ctxt, t: ty::t, escapes: bool,\n     let is_obj_body;\n     alt storage {\n         tps_normal. { is_obj_body = false; }\n-        tps_obj(_) { is_obj_body = true; }\n+        tps_obj(_) | tps_fn(_) { is_obj_body = true; }\n     }\n \n     bcx_ccx(cx).stats.n_derived_tydescs += 1u;\n@@ -1006,6 +1006,7 @@ fn get_derived_tydesc(cx: @block_ctxt, t: ty::t, escapes: bool,\n     alt storage {\n       tps_normal. { obj_params = 0u; }\n       tps_obj(np) { obj_params = np; }\n+      tps_fn(np) { obj_params = 0x80000000u | np; }\n     }\n \n     let v;"}, {"sha": "8db1852357ed6901767d667019472e6d2c33eb89", "filename": "src/comp/middle/trans_closure.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d381cc072a9c9c0fef605c56ed77d538a49c8ead/src%2Fcomp%2Fmiddle%2Ftrans_closure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d381cc072a9c9c0fef605c56ed77d538a49c8ead/src%2Fcomp%2Fmiddle%2Ftrans_closure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans_closure.rs?ref=d381cc072a9c9c0fef605c56ed77d538a49c8ead", "patch": "@@ -131,8 +131,9 @@ fn build_environment(bcx: @block_ctxt, lltydescs: [ValueRef],\n       for_closure. | for_send. {\n         let bound_tydesc = GEPi(bcx, closure, [0, abi::closure_elt_tydesc]);\n         let ti = none;\n+        let tps = tps_fn(vec::len(lltydescs));\n         let {result:bindings_tydesc, _} =\n-            trans::get_tydesc(bcx, bindings_ty, true, trans::tps_normal, ti);\n+            trans::get_tydesc(bcx, bindings_ty, true, tps, ti);\n         trans::lazily_emit_tydesc_glue(bcx, abi::tydesc_field_drop_glue, ti);\n         trans::lazily_emit_tydesc_glue(bcx, abi::tydesc_field_free_glue, ti);\n         bcx = bindings_tydesc.bcx;"}]}