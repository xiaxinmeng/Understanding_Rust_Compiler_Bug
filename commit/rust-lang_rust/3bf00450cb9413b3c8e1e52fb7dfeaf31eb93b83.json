{"sha": "3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNiZjAwNDUwY2I5NDEzYjNjOGUxZTUyZmI3ZGZlYWYzMWViOTNiODM=", "commit": {"author": {"name": "Ariel Ben-Yehuda", "email": "arielb1@mail.tau.ac.il", "date": "2017-04-19T22:20:50Z"}, "committer": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2017-04-22T18:00:50Z"}, "message": "remove cleanup branches to the resume block\n\nThis improves LLVM performance by 10% lost during the shimmir transition.", "tree": {"sha": "9daf2ace5d0f2e5a9e4c6c6141acbfda33d1693e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9daf2ace5d0f2e5a9e4c6c6141acbfda33d1693e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83", "html_url": "https://github.com/rust-lang/rust/commit/3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83/comments", "author": null, "committer": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9cc77d7690fc723b264962a4d01a6221be87d80e", "url": "https://api.github.com/repos/rust-lang/rust/commits/9cc77d7690fc723b264962a4d01a6221be87d80e", "html_url": "https://github.com/rust-lang/rust/commit/9cc77d7690fc723b264962a4d01a6221be87d80e"}], "stats": {"total": 37, "additions": 36, "deletions": 1}, "files": [{"sha": "ef7990653ba982cc8de8319fad9e9401d1729535", "filename": "src/librustc_mir/transform/simplify.rs", "status": "modified", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs?ref=3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83", "patch": "@@ -124,6 +124,8 @@ impl<'a, 'tcx: 'a> CfgSimplifier<'a, 'tcx> {\n                     self.collapse_goto_chain(successor, &mut changed);\n                 }\n \n+                changed |= self.simplify_unwind(&mut terminator);\n+\n                 let mut new_stmts = vec![];\n                 let mut inner_changed = true;\n                 while inner_changed {\n@@ -238,6 +240,38 @@ impl<'a, 'tcx: 'a> CfgSimplifier<'a, 'tcx> {\n         true\n     }\n \n+    // turn an unwind branch to a resume block into a None\n+    fn simplify_unwind(&mut self, terminator: &mut Terminator<'tcx>) -> bool {\n+        let unwind = match terminator.kind {\n+            TerminatorKind::Drop { ref mut unwind, .. } |\n+            TerminatorKind::DropAndReplace { ref mut unwind, .. } |\n+            TerminatorKind::Call { cleanup: ref mut unwind, .. } |\n+            TerminatorKind::Assert { cleanup: ref mut unwind, .. } =>\n+                unwind,\n+            _ => return false\n+        };\n+\n+        if let &mut Some(unwind_block) = unwind {\n+            let is_resume_block = match self.basic_blocks[unwind_block] {\n+                BasicBlockData {\n+                    ref statements,\n+                    terminator: Some(Terminator {\n+                        kind: TerminatorKind::Resume, ..\n+                    }), ..\n+                } if statements.is_empty() => true,\n+                _ => false\n+            };\n+            if is_resume_block {\n+                debug!(\"simplifying unwind to {:?} from {:?}\",\n+                       unwind_block, terminator.source_info);\n+                *unwind = None;\n+            }\n+            return is_resume_block;\n+        }\n+\n+        false\n+    }\n+\n     fn strip_nops(&mut self) {\n         for blk in self.basic_blocks.iter_mut() {\n             blk.statements.retain(|stmt| if let StatementKind::Nop = stmt.kind {"}, {"sha": "d7e2cb6d9a50ba6c8e3fafe8034b62e7442d2569", "filename": "src/test/codegen/drop.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83/src%2Ftest%2Fcodegen%2Fdrop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83/src%2Ftest%2Fcodegen%2Fdrop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fdrop.rs?ref=3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83", "patch": "@@ -36,7 +36,7 @@ pub fn droppy() {\n // CHECK-NOT: call{{.*}}drop{{.*}}SomeUniqueName\n // CHECK: invoke{{.*}}drop{{.*}}SomeUniqueName\n // CHECK: invoke{{.*}}drop{{.*}}SomeUniqueName\n-// CHECK: invoke{{.*}}drop{{.*}}SomeUniqueName\n+// CHECK: call{{.*}}drop{{.*}}SomeUniqueName\n // CHECK-NOT: {{(call|invoke).*}}drop{{.*}}SomeUniqueName\n // The next line checks for the } that ends the function definition\n // CHECK-LABEL: {{^[}]}}"}, {"sha": "9fd600b32e6c71c6473d4c9878c43615a8f2483e", "filename": "src/test/codegen/personality_lifetimes.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83/src%2Ftest%2Fcodegen%2Fpersonality_lifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83/src%2Ftest%2Fcodegen%2Fpersonality_lifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fpersonality_lifetimes.rs?ref=3bf00450cb9413b3c8e1e52fb7dfeaf31eb93b83", "patch": "@@ -37,5 +37,6 @@ pub fn test() {\n     // CHECK: bitcast{{.*}}personalityslot\n     // CHECK-NEXT: call void @llvm.lifetime.start\n     might_unwind();\n+    let _t = S;\n     might_unwind();\n }"}]}