{"sha": "ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b", "node_id": "C_kwDOAAsO6NoAKGFkNTcyOTVmYzlmNWIwYzc0N2FlNGY3MmQ2MjA4Y2NmMDNiOTRiMGI", "commit": {"author": {"name": "Jack Huey", "email": "31162821+jackh726@users.noreply.github.com", "date": "2022-01-10T04:53:57Z"}, "committer": {"name": "Jack Huey", "email": "31162821+jackh726@users.noreply.github.com", "date": "2022-01-10T05:29:06Z"}, "message": "Elaborate param_env predicates when checking if type outlives involving projection holds", "tree": {"sha": "380ba40b4e3b4e27d83bdf9b4904019451a5fb84", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/380ba40b4e3b4e27d83bdf9b4904019451a5fb84"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b", "html_url": "https://github.com/rust-lang/rust/commit/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b/comments", "author": {"login": "jackh726", "id": 31162821, "node_id": "MDQ6VXNlcjMxMTYyODIx", "avatar_url": "https://avatars.githubusercontent.com/u/31162821?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jackh726", "html_url": "https://github.com/jackh726", "followers_url": "https://api.github.com/users/jackh726/followers", "following_url": "https://api.github.com/users/jackh726/following{/other_user}", "gists_url": "https://api.github.com/users/jackh726/gists{/gist_id}", "starred_url": "https://api.github.com/users/jackh726/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jackh726/subscriptions", "organizations_url": "https://api.github.com/users/jackh726/orgs", "repos_url": "https://api.github.com/users/jackh726/repos", "events_url": "https://api.github.com/users/jackh726/events{/privacy}", "received_events_url": "https://api.github.com/users/jackh726/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jackh726", "id": 31162821, "node_id": "MDQ6VXNlcjMxMTYyODIx", "avatar_url": "https://avatars.githubusercontent.com/u/31162821?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jackh726", "html_url": "https://github.com/jackh726", "followers_url": "https://api.github.com/users/jackh726/followers", "following_url": "https://api.github.com/users/jackh726/following{/other_user}", "gists_url": "https://api.github.com/users/jackh726/gists{/gist_id}", "starred_url": "https://api.github.com/users/jackh726/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jackh726/subscriptions", "organizations_url": "https://api.github.com/users/jackh726/orgs", "repos_url": "https://api.github.com/users/jackh726/repos", "events_url": "https://api.github.com/users/jackh726/events{/privacy}", "received_events_url": "https://api.github.com/users/jackh726/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e012a191d768adeda1ee36a99ef8b92d51920154", "url": "https://api.github.com/repos/rust-lang/rust/commits/e012a191d768adeda1ee36a99ef8b92d51920154", "html_url": "https://github.com/rust-lang/rust/commit/e012a191d768adeda1ee36a99ef8b92d51920154"}], "stats": {"total": 96, "additions": 90, "deletions": 6}, "files": [{"sha": "a5276afc5bfa7ed03b59fd2cc5ccecaa4378a70c", "filename": "compiler/rustc_infer/src/infer/outlives/obligations.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b/compiler%2Frustc_infer%2Fsrc%2Finfer%2Foutlives%2Fobligations.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b/compiler%2Frustc_infer%2Fsrc%2Finfer%2Foutlives%2Fobligations.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Foutlives%2Fobligations.rs?ref=ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b", "patch": "@@ -164,7 +164,7 @@ impl<'cx, 'tcx> InferCtxt<'cx, 'tcx> {\n             \"cannot process registered region obligations in a snapshot\"\n         );\n \n-        debug!(\"process_registered_region_obligations()\");\n+        debug!(?param_env, \"process_registered_region_obligations()\");\n \n         let my_region_obligations = self.take_registered_region_obligations();\n \n@@ -356,6 +356,8 @@ where\n         let trait_bounds: Vec<_> =\n             self.verify_bound.projection_declared_bounds_from_trait(projection_ty).collect();\n \n+        debug!(?trait_bounds);\n+\n         // Compute the bounds we can derive from the environment. This\n         // is an \"approximate\" match -- in some cases, these bounds\n         // may not apply."}, {"sha": "0833ebfd5f3330c81d31babf1c18a6b1101aaec6", "filename": "compiler/rustc_infer/src/traits/util.rs", "status": "modified", "additions": 13, "deletions": 4, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Futil.rs?ref=ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b", "patch": "@@ -241,10 +241,19 @@ impl<'tcx> Elaborator<'tcx> {\n \n                             Component::UnresolvedInferenceVariable(_) => None,\n \n-                            Component::Projection(_) | Component::EscapingProjection(_) => {\n-                                // We can probably do more here. This\n-                                // corresponds to a case like `<T as\n-                                // Foo<'a>>::U: 'b`.\n+                            Component::Projection(projection) => {\n+                                // We might end up here if we have `Foo<<Bar as Baz>::Assoc>: 'a`.\n+                                // With this, we can deduce that `<Bar as Baz>::Assoc: 'a`.\n+                                let ty =\n+                                    tcx.mk_projection(projection.item_def_id, projection.substs);\n+                                Some(ty::PredicateKind::TypeOutlives(ty::OutlivesPredicate(\n+                                    ty, r_min,\n+                                )))\n+                            }\n+\n+                            Component::EscapingProjection(_) => {\n+                                // We might be able to do more here, but we don't\n+                                // want to deal with escaping vars right now.\n                                 None\n                             }\n                         })"}, {"sha": "d7b92c64fd7a15e62713aa182a0acd78ca8b1048", "filename": "compiler/rustc_trait_selection/src/traits/select/confirmation.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fconfirmation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fconfirmation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fconfirmation.rs?ref=ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b", "patch": "@@ -206,7 +206,9 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             })?);\n \n             if let ty::Projection(..) = placeholder_self_ty.kind() {\n-                for predicate in tcx.predicates_of(def_id).instantiate_own(tcx, substs).predicates {\n+                let predicates = tcx.predicates_of(def_id).instantiate_own(tcx, substs).predicates;\n+                debug!(?predicates, \"projection predicates\");\n+                for predicate in predicates {\n                     let normalized = normalize_with_depth_to(\n                         self,\n                         obligation.param_env,"}, {"sha": "6c81babc0bccb1a0151a5ba36da1c6c6086b60b2", "filename": "src/test/ui/generic-associated-types/issue-92096.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-92096.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-92096.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-92096.rs?ref=ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b", "patch": "@@ -0,0 +1,27 @@\n+// edition:2018\n+// check-fail\n+// FIXME(generic_associated_types): this should pass, but we end up\n+// essentially requiring that `for<'s> C: 's`\n+\n+#![feature(generic_associated_types)]\n+\n+use std::future::Future;\n+\n+trait Client {\n+    type Connecting<'a>: Future + Send\n+    where\n+        Self: 'a;\n+\n+    fn connect(&'_ self) -> Self::Connecting<'_>;\n+}\n+\n+fn call_connect<C>(c: &'_ C) -> impl '_ + Future + Send\n+//~^ ERROR the parameter\n+//~| ERROR the parameter\n+where\n+    C: Client + Send + Sync,\n+{\n+    async move { c.connect().await }\n+}\n+\n+fn main() {}"}, {"sha": "a897ba5b966ec2dbfacb5b830a53e741610aaa4f", "filename": "src/test/ui/generic-associated-types/issue-92096.stderr", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-92096.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-92096.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-92096.stderr?ref=ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b", "patch": "@@ -0,0 +1,18 @@\n+error[E0311]: the parameter type `C` may not live long enough\n+  --> $DIR/issue-92096.rs:18:33\n+   |\n+LL | fn call_connect<C>(c: &'_ C) -> impl '_ + Future + Send\n+   |                 -               ^^^^^^^^^^^^^^^^^^^^^^^ ...so that the type `C` will meet its required lifetime bounds\n+   |                 |\n+   |                 help: consider adding an explicit lifetime bound...: `C: 'a`\n+\n+error[E0311]: the parameter type `C` may not live long enough\n+  --> $DIR/issue-92096.rs:18:33\n+   |\n+LL | fn call_connect<C>(c: &'_ C) -> impl '_ + Future + Send\n+   |                 -               ^^^^^^^^^^^^^^^^^^^^^^^ ...so that the type `C` will meet its required lifetime bounds\n+   |                 |\n+   |                 help: consider adding an explicit lifetime bound...: `C: 'a`\n+\n+error: aborting due to 2 previous errors\n+"}, {"sha": "db26493ecadfab926b1df9c68cf74ccba707e815", "filename": "src/test/ui/generic-associated-types/issue-92280.rs", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-92280.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-92280.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-92280.rs?ref=ad57295fc9f5b0c747ae4f72d6208ccf03b94b0b", "patch": "@@ -0,0 +1,26 @@\n+// check-pass\n+\n+#![feature(generic_associated_types)]\n+#![allow(non_camel_case_types)]\n+\n+trait HasAssoc {\n+    type Assoc;\n+}\n+\n+trait Iterate<S: HasAssoc> {\n+    type Iter<'a>\n+    where\n+        Self: 'a;\n+}\n+\n+struct KeySegment_Broken<T> {\n+    key: T,\n+}\n+impl<S: HasAssoc> Iterate<S> for KeySegment_Broken<S::Assoc> {\n+    type Iter<'a>\n+    where\n+        Self: 'a,\n+    = ();\n+}\n+\n+fn main() {}"}]}