{"sha": "4e9cf04c98dd65a7f4baedc2984fae18d5fecfd1", "node_id": "C_kwDOAAsO6NoAKDRlOWNmMDRjOThkZDY1YTdmNGJhZWRjMjk4NGZhZTE4ZDVmZWNmZDE", "commit": {"author": {"name": "Jubilee", "email": "46493976+workingjubilee@users.noreply.github.com", "date": "2021-10-04T20:58:06Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-10-04T20:58:06Z"}, "message": "Rollup merge of #83655 - sebpop:arm64-outline-atomics, r=workingjubilee\n\n[aarch64] add target feature outline-atomics\n\nEnable outline-atomics by default as enabled in clang by the following commit\nhttps://reviews.llvm.org/rGc5e7e649d537067dec7111f3de1430d0fc8a4d11\n\nPerformance improves by several orders of magnitude when using the LSE instructions\ninstead of the ARMv8.0 compatible load/store exclusive instructions.\n\nTested on Graviton2 aarch64-linux with\nx.py build && x.py install && x.py test", "tree": {"sha": "08e3d348f0cd16197d996b5fd27c549fabbac329", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/08e3d348f0cd16197d996b5fd27c549fabbac329"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4e9cf04c98dd65a7f4baedc2984fae18d5fecfd1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhW2reCRBK7hj4Ov3rIwAALJoIAH0y4x4o7RDDVvJWQQpjapge\nX+pSOpVcjSVHal+19PZHH7HgKXwe/OHc8UTQvU7QuUABFOIjPVMoMBcvL1MluXxb\nFgRu/RUwTw7O6o+bO8TbdADNpN8XTTCStm3s5vjM2YDddDCswCCHccZsaheN48hL\noLxUnCB6xJjHNLnh7km4PgJ7ZdUAXPlMyfZlT7qRAVie7rkBHyAYQBAsMrBY9gW9\nJIqw1iJj1a6xrNCDfbzdvtGVPWviks1CIiPW2jqGO9geTMwxyC2hEfCR6dq/uKk+\nMRVotseJFocRs7+M8Wi0toh8X210Pp3/cu6MIFaZseCNDKwY+xFXXC/oE9KW1qg=\n=IXCp\n-----END PGP SIGNATURE-----\n", "payload": "tree 08e3d348f0cd16197d996b5fd27c549fabbac329\nparent 175b8db73bfd078b4bcd3c28c8d6f51d5895ebf3\nparent 0f9f241aac21bc77fb9e757da18207abefdc841d\nauthor Jubilee <46493976+workingjubilee@users.noreply.github.com> 1633381086 -0700\ncommitter GitHub <noreply@github.com> 1633381086 -0700\n\nRollup merge of #83655 - sebpop:arm64-outline-atomics, r=workingjubilee\n\n[aarch64] add target feature outline-atomics\n\nEnable outline-atomics by default as enabled in clang by the following commit\nhttps://reviews.llvm.org/rGc5e7e649d537067dec7111f3de1430d0fc8a4d11\n\nPerformance improves by several orders of magnitude when using the LSE instructions\ninstead of the ARMv8.0 compatible load/store exclusive instructions.\n\nTested on Graviton2 aarch64-linux with\nx.py build && x.py install && x.py test\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4e9cf04c98dd65a7f4baedc2984fae18d5fecfd1", "html_url": "https://github.com/rust-lang/rust/commit/4e9cf04c98dd65a7f4baedc2984fae18d5fecfd1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4e9cf04c98dd65a7f4baedc2984fae18d5fecfd1/comments", "author": {"login": "workingjubilee", "id": 46493976, "node_id": "MDQ6VXNlcjQ2NDkzOTc2", "avatar_url": "https://avatars.githubusercontent.com/u/46493976?v=4", "gravatar_id": "", "url": "https://api.github.com/users/workingjubilee", "html_url": "https://github.com/workingjubilee", "followers_url": "https://api.github.com/users/workingjubilee/followers", "following_url": "https://api.github.com/users/workingjubilee/following{/other_user}", "gists_url": "https://api.github.com/users/workingjubilee/gists{/gist_id}", "starred_url": "https://api.github.com/users/workingjubilee/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/workingjubilee/subscriptions", "organizations_url": "https://api.github.com/users/workingjubilee/orgs", "repos_url": "https://api.github.com/users/workingjubilee/repos", "events_url": "https://api.github.com/users/workingjubilee/events{/privacy}", "received_events_url": "https://api.github.com/users/workingjubilee/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "175b8db73bfd078b4bcd3c28c8d6f51d5895ebf3", "url": "https://api.github.com/repos/rust-lang/rust/commits/175b8db73bfd078b4bcd3c28c8d6f51d5895ebf3", "html_url": "https://github.com/rust-lang/rust/commit/175b8db73bfd078b4bcd3c28c8d6f51d5895ebf3"}, {"sha": "0f9f241aac21bc77fb9e757da18207abefdc841d", "url": "https://api.github.com/repos/rust-lang/rust/commits/0f9f241aac21bc77fb9e757da18207abefdc841d", "html_url": "https://github.com/rust-lang/rust/commit/0f9f241aac21bc77fb9e757da18207abefdc841d"}], "stats": {"total": 21, "additions": 21, "deletions": 0}, "files": [{"sha": "b15efcd0dc2b1855504cc6823a69ed9b3cccf7bc", "filename": "compiler/rustc_codegen_llvm/src/llvm_util.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/4e9cf04c98dd65a7f4baedc2984fae18d5fecfd1/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e9cf04c98dd65a7f4baedc2984fae18d5fecfd1/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs?ref=4e9cf04c98dd65a7f4baedc2984fae18d5fecfd1", "patch": "@@ -416,6 +416,11 @@ pub fn llvm_global_features(sess: &Session) -> Vec<String> {\n     // -Ctarget-features\n     features.extend(sess.opts.cg.target_feature.split(',').flat_map(&filter));\n \n+    // FIXME: Move outline-atomics to target definition when earliest supported LLVM is 12.\n+    if get_version() >= (12, 0, 0) && sess.target.llvm_target.contains(\"aarch64-unknown-linux\") {\n+        features.push(\"+outline-atomics\".to_string());\n+    }\n+\n     features\n }\n "}, {"sha": "93dda712e1b9b3695f5fa6589ba7749fa1b45dc1", "filename": "src/test/assembly/asm/aarch64-outline-atomics.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/4e9cf04c98dd65a7f4baedc2984fae18d5fecfd1/src%2Ftest%2Fassembly%2Fasm%2Faarch64-outline-atomics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e9cf04c98dd65a7f4baedc2984fae18d5fecfd1/src%2Ftest%2Fassembly%2Fasm%2Faarch64-outline-atomics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fassembly%2Fasm%2Faarch64-outline-atomics.rs?ref=4e9cf04c98dd65a7f4baedc2984fae18d5fecfd1", "patch": "@@ -0,0 +1,16 @@\n+// min-llvm-version: 12.0\n+// assembly-output: emit-asm\n+// compile-flags: -O\n+// compile-flags: --target aarch64-unknown-linux-gnu\n+// needs-llvm-components: aarch64\n+// only-aarch64\n+\n+#![crate_type = \"rlib\"]\n+\n+use std::sync::atomic::{AtomicI32, Ordering::*};\n+\n+pub fn compare_exchange(a: &AtomicI32) {\n+    // On AArch64 LLVM should outline atomic operations.\n+    // CHECK: __aarch64_cas4_relax\n+    let _ = a.compare_exchange(0, 10, Relaxed, Relaxed);\n+}"}]}