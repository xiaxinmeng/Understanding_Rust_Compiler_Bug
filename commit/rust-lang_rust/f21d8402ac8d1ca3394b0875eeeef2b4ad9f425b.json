{"sha": "f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b", "node_id": "C_kwDOAAsO6NoAKGYyMWQ4NDAyYWM4ZDFjYTMzOTRiMDg3NWVlZWVmMmI0YWQ5ZjQyNWI", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-04-12T15:04:31Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-12T15:04:31Z"}, "message": "Rollup merge of #110182 - WaffleLapkin:neither, r=Nilstrieb\n\nUse `itertools::Either` instead of own impl\n\nYeah.", "tree": {"sha": "49cf9cf41d93d556bacca97f09570fe49b659aaf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/49cf9cf41d93d556bacca97f09570fe49b659aaf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkNsh/CRBK7hj4Ov3rIwAAoMkIAJP27Ab6Gj0t5sKHum4gRl89\ngYXpQEbyLYa3sGAWboz7LyB3Fn/5nyPvS4REbuQiWsoKzPFrR8O5IFQhLp5aqKcc\nyOVmfSqytIq+22SktIGHdkbn4teFFOwE+EG455CkUmteQMcwwIRY0uBKbyjeuMXq\naWzvKDO5igBM85klyL5hBpFb/4bLLLtNfZhmmU5yPlSzDQvDuNybp3xEFkT71oae\nsohsY2p641vh24iXC4L5X5Cvmu5NzdoxImq+SnfkdPHSYN0mJdrqFJT5Yjxufom8\nbelzWTCUg6rVxuKZUt0nuGGPTPrwQt9i6RPeo9Qfh2VKdZgvOvvFK6AomG3Ssxo=\n=PCFq\n-----END PGP SIGNATURE-----\n", "payload": "tree 49cf9cf41d93d556bacca97f09570fe49b659aaf\nparent 827b74c709398de95fbde4f1a35b57b181a476bf\nparent a32959263ca6b798fb02634d49e76c6abac41806\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1681311871 +0200\ncommitter GitHub <noreply@github.com> 1681311871 +0200\n\nRollup merge of #110182 - WaffleLapkin:neither, r=Nilstrieb\n\nUse `itertools::Either` instead of own impl\n\nYeah.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b", "html_url": "https://github.com/rust-lang/rust/commit/f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "827b74c709398de95fbde4f1a35b57b181a476bf", "url": "https://api.github.com/repos/rust-lang/rust/commits/827b74c709398de95fbde4f1a35b57b181a476bf", "html_url": "https://github.com/rust-lang/rust/commit/827b74c709398de95fbde4f1a35b57b181a476bf"}, {"sha": "a32959263ca6b798fb02634d49e76c6abac41806", "url": "https://api.github.com/repos/rust-lang/rust/commits/a32959263ca6b798fb02634d49e76c6abac41806", "html_url": "https://github.com/rust-lang/rust/commit/a32959263ca6b798fb02634d49e76c6abac41806"}], "stats": {"total": 146, "additions": 37, "deletions": 109}, "files": [{"sha": "b8d9502506e59c0155f3e26c44cc8d3bfe541695", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b", "patch": "@@ -4576,6 +4576,7 @@ dependencies = [\n  \"elsa\",\n  \"ena\",\n  \"indexmap\",\n+ \"itertools\",\n  \"jobserver\",\n  \"libc\",\n  \"measureme\","}, {"sha": "2102f09c56a03f5b168930bbf5d099f6133909dd", "filename": "compiler/rustc_data_structures/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b/compiler%2Frustc_data_structures%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b/compiler%2Frustc_data_structures%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2FCargo.toml?ref=f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b", "patch": "@@ -33,6 +33,7 @@ tempfile = \"3.2\"\n thin-vec = \"0.2.12\"\n tracing = \"0.1\"\n elsa = \"=1.7.1\"\n+itertools = \"0.10.1\"\n \n [dependencies.parking_lot]\n version = \"0.11\""}, {"sha": "bca6c0955b905f8732fb72b598fc75e62d924152", "filename": "compiler/rustc_data_structures/src/sso/either_iter.rs", "status": "removed", "additions": 0, "deletions": 73, "changes": 73, "blob_url": "https://github.com/rust-lang/rust/blob/827b74c709398de95fbde4f1a35b57b181a476bf/compiler%2Frustc_data_structures%2Fsrc%2Fsso%2Feither_iter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/827b74c709398de95fbde4f1a35b57b181a476bf/compiler%2Frustc_data_structures%2Fsrc%2Fsso%2Feither_iter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fsso%2Feither_iter.rs?ref=827b74c709398de95fbde4f1a35b57b181a476bf", "patch": "@@ -1,73 +0,0 @@\n-use std::fmt;\n-use std::iter::FusedIterator;\n-\n-/// Iterator which may contain instance of\n-/// one of two specific implementations.\n-///\n-/// Note: For most methods providing custom\n-///       implementation may marginally\n-///       improve performance by avoiding\n-///       doing Left/Right match on every step\n-///       and doing it only once instead.\n-#[derive(Clone)]\n-pub enum EitherIter<L, R> {\n-    Left(L),\n-    Right(R),\n-}\n-\n-impl<L, R> Iterator for EitherIter<L, R>\n-where\n-    L: Iterator,\n-    R: Iterator<Item = L::Item>,\n-{\n-    type Item = L::Item;\n-\n-    fn next(&mut self) -> Option<Self::Item> {\n-        match self {\n-            EitherIter::Left(l) => l.next(),\n-            EitherIter::Right(r) => r.next(),\n-        }\n-    }\n-\n-    fn size_hint(&self) -> (usize, Option<usize>) {\n-        match self {\n-            EitherIter::Left(l) => l.size_hint(),\n-            EitherIter::Right(r) => r.size_hint(),\n-        }\n-    }\n-}\n-\n-impl<L, R> ExactSizeIterator for EitherIter<L, R>\n-where\n-    L: ExactSizeIterator,\n-    R: ExactSizeIterator,\n-    EitherIter<L, R>: Iterator,\n-{\n-    fn len(&self) -> usize {\n-        match self {\n-            EitherIter::Left(l) => l.len(),\n-            EitherIter::Right(r) => r.len(),\n-        }\n-    }\n-}\n-\n-impl<L, R> FusedIterator for EitherIter<L, R>\n-where\n-    L: FusedIterator,\n-    R: FusedIterator,\n-    EitherIter<L, R>: Iterator,\n-{\n-}\n-\n-impl<L, R> fmt::Debug for EitherIter<L, R>\n-where\n-    L: fmt::Debug,\n-    R: fmt::Debug,\n-{\n-    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n-        match self {\n-            EitherIter::Left(l) => l.fmt(f),\n-            EitherIter::Right(r) => r.fmt(f),\n-        }\n-    }\n-}"}, {"sha": "89b8c852649691261b3e8080f926bd171c77eae9", "filename": "compiler/rustc_data_structures/src/sso/map.rs", "status": "modified", "additions": 35, "deletions": 35, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b/compiler%2Frustc_data_structures%2Fsrc%2Fsso%2Fmap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b/compiler%2Frustc_data_structures%2Fsrc%2Fsso%2Fmap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fsso%2Fmap.rs?ref=f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b", "patch": "@@ -1,24 +1,24 @@\n-use super::either_iter::EitherIter;\n use crate::fx::FxHashMap;\n use arrayvec::ArrayVec;\n+use itertools::Either;\n use std::fmt;\n use std::hash::Hash;\n use std::ops::Index;\n \n-// For pointer-sized arguments arrays\n-// are faster than set/map for up to 64\n-// arguments.\n-//\n-// On the other hand such a big array\n-// hurts cache performance, makes passing\n-// sso structures around very expensive.\n-//\n-// Biggest performance benefit is gained\n-// for reasonably small arrays that stay\n-// small in vast majority of cases.\n-//\n-// '8' is chosen as a sane default, to be\n-// reevaluated later.\n+/// For pointer-sized arguments arrays\n+/// are faster than set/map for up to 64\n+/// arguments.\n+///\n+/// On the other hand such a big array\n+/// hurts cache performance, makes passing\n+/// sso structures around very expensive.\n+///\n+/// Biggest performance benefit is gained\n+/// for reasonably small arrays that stay\n+/// small in vast majority of cases.\n+///\n+/// '8' is chosen as a sane default, to be\n+/// reevaluated later.\n const SSO_ARRAY_SIZE: usize = 8;\n \n /// Small-storage-optimized implementation of a map.\n@@ -138,35 +138,35 @@ impl<K, V> SsoHashMap<K, V> {\n     /// The iterator element type is `&'a K`.\n     pub fn keys(&self) -> impl Iterator<Item = &'_ K> {\n         match self {\n-            SsoHashMap::Array(array) => EitherIter::Left(array.iter().map(|(k, _v)| k)),\n-            SsoHashMap::Map(map) => EitherIter::Right(map.keys()),\n+            SsoHashMap::Array(array) => Either::Left(array.iter().map(|(k, _v)| k)),\n+            SsoHashMap::Map(map) => Either::Right(map.keys()),\n         }\n     }\n \n     /// An iterator visiting all values in arbitrary order.\n     /// The iterator element type is `&'a V`.\n     pub fn values(&self) -> impl Iterator<Item = &'_ V> {\n         match self {\n-            SsoHashMap::Array(array) => EitherIter::Left(array.iter().map(|(_k, v)| v)),\n-            SsoHashMap::Map(map) => EitherIter::Right(map.values()),\n+            SsoHashMap::Array(array) => Either::Left(array.iter().map(|(_k, v)| v)),\n+            SsoHashMap::Map(map) => Either::Right(map.values()),\n         }\n     }\n \n     /// An iterator visiting all values mutably in arbitrary order.\n     /// The iterator element type is `&'a mut V`.\n     pub fn values_mut(&mut self) -> impl Iterator<Item = &'_ mut V> {\n         match self {\n-            SsoHashMap::Array(array) => EitherIter::Left(array.iter_mut().map(|(_k, v)| v)),\n-            SsoHashMap::Map(map) => EitherIter::Right(map.values_mut()),\n+            SsoHashMap::Array(array) => Either::Left(array.iter_mut().map(|(_k, v)| v)),\n+            SsoHashMap::Map(map) => Either::Right(map.values_mut()),\n         }\n     }\n \n     /// Clears the map, returning all key-value pairs as an iterator. Keeps the\n     /// allocated memory for reuse.\n     pub fn drain(&mut self) -> impl Iterator<Item = (K, V)> + '_ {\n         match self {\n-            SsoHashMap::Array(array) => EitherIter::Left(array.drain(..)),\n-            SsoHashMap::Map(map) => EitherIter::Right(map.drain()),\n+            SsoHashMap::Array(array) => Either::Left(array.drain(..)),\n+            SsoHashMap::Map(map) => Either::Right(map.drain()),\n         }\n     }\n }\n@@ -406,16 +406,16 @@ where\n }\n \n impl<K, V> IntoIterator for SsoHashMap<K, V> {\n-    type IntoIter = EitherIter<\n-        <ArrayVec<(K, V), 8> as IntoIterator>::IntoIter,\n+    type IntoIter = Either<\n+        <ArrayVec<(K, V), SSO_ARRAY_SIZE> as IntoIterator>::IntoIter,\n         <FxHashMap<K, V> as IntoIterator>::IntoIter,\n     >;\n     type Item = <Self::IntoIter as Iterator>::Item;\n \n     fn into_iter(self) -> Self::IntoIter {\n         match self {\n-            SsoHashMap::Array(array) => EitherIter::Left(array.into_iter()),\n-            SsoHashMap::Map(map) => EitherIter::Right(map.into_iter()),\n+            SsoHashMap::Array(array) => Either::Left(array.into_iter()),\n+            SsoHashMap::Map(map) => Either::Right(map.into_iter()),\n         }\n     }\n }\n@@ -435,9 +435,9 @@ fn adapt_array_mut_it<K, V>(pair: &mut (K, V)) -> (&K, &mut V) {\n }\n \n impl<'a, K, V> IntoIterator for &'a SsoHashMap<K, V> {\n-    type IntoIter = EitherIter<\n+    type IntoIter = Either<\n         std::iter::Map<\n-            <&'a ArrayVec<(K, V), 8> as IntoIterator>::IntoIter,\n+            <&'a ArrayVec<(K, V), SSO_ARRAY_SIZE> as IntoIterator>::IntoIter,\n             fn(&'a (K, V)) -> (&'a K, &'a V),\n         >,\n         <&'a FxHashMap<K, V> as IntoIterator>::IntoIter,\n@@ -446,16 +446,16 @@ impl<'a, K, V> IntoIterator for &'a SsoHashMap<K, V> {\n \n     fn into_iter(self) -> Self::IntoIter {\n         match self {\n-            SsoHashMap::Array(array) => EitherIter::Left(array.into_iter().map(adapt_array_ref_it)),\n-            SsoHashMap::Map(map) => EitherIter::Right(map.iter()),\n+            SsoHashMap::Array(array) => Either::Left(array.into_iter().map(adapt_array_ref_it)),\n+            SsoHashMap::Map(map) => Either::Right(map.iter()),\n         }\n     }\n }\n \n impl<'a, K, V> IntoIterator for &'a mut SsoHashMap<K, V> {\n-    type IntoIter = EitherIter<\n+    type IntoIter = Either<\n         std::iter::Map<\n-            <&'a mut ArrayVec<(K, V), 8> as IntoIterator>::IntoIter,\n+            <&'a mut ArrayVec<(K, V), SSO_ARRAY_SIZE> as IntoIterator>::IntoIter,\n             fn(&'a mut (K, V)) -> (&'a K, &'a mut V),\n         >,\n         <&'a mut FxHashMap<K, V> as IntoIterator>::IntoIter,\n@@ -464,8 +464,8 @@ impl<'a, K, V> IntoIterator for &'a mut SsoHashMap<K, V> {\n \n     fn into_iter(self) -> Self::IntoIter {\n         match self {\n-            SsoHashMap::Array(array) => EitherIter::Left(array.into_iter().map(adapt_array_mut_it)),\n-            SsoHashMap::Map(map) => EitherIter::Right(map.iter_mut()),\n+            SsoHashMap::Array(array) => Either::Left(array.into_iter().map(adapt_array_mut_it)),\n+            SsoHashMap::Map(map) => Either::Right(map.iter_mut()),\n         }\n     }\n }"}, {"sha": "ef634b9adcec3fa25150eea8a8a844a6d243ec07", "filename": "compiler/rustc_data_structures/src/sso/mod.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b/compiler%2Frustc_data_structures%2Fsrc%2Fsso%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b/compiler%2Frustc_data_structures%2Fsrc%2Fsso%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fsso%2Fmod.rs?ref=f21d8402ac8d1ca3394b0875eeeef2b4ad9f425b", "patch": "@@ -1,4 +1,3 @@\n-mod either_iter;\n mod map;\n mod set;\n "}]}