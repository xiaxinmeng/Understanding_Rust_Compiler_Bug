{"sha": "20f3de5ab1151e68e727b5e1c22bcafca738bb7e", "node_id": "C_kwDOAAsO6NoAKDIwZjNkZTVhYjExNTFlNjhlNzI3YjVlMWMyMmJjYWZjYTczOGJiN2U", "commit": {"author": {"name": "Maybe Waffle", "email": "waffle.lapkin@gmail.com", "date": "2022-11-23T16:12:51Z"}, "committer": {"name": "Maybe Waffle", "email": "waffle.lapkin@gmail.com", "date": "2022-11-23T16:12:51Z"}, "message": "Use nicer spans for `deref_into_dyn_supertrait`", "tree": {"sha": "c9c2acc13a39f76bebb41125baa2c80e6c21a650", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c9c2acc13a39f76bebb41125baa2c80e6c21a650"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/20f3de5ab1151e68e727b5e1c22bcafca738bb7e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/20f3de5ab1151e68e727b5e1c22bcafca738bb7e", "html_url": "https://github.com/rust-lang/rust/commit/20f3de5ab1151e68e727b5e1c22bcafca738bb7e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/20f3de5ab1151e68e727b5e1c22bcafca738bb7e/comments", "author": {"login": "WaffleLapkin", "id": 38225716, "node_id": "MDQ6VXNlcjM4MjI1NzE2", "avatar_url": "https://avatars.githubusercontent.com/u/38225716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/WaffleLapkin", "html_url": "https://github.com/WaffleLapkin", "followers_url": "https://api.github.com/users/WaffleLapkin/followers", "following_url": "https://api.github.com/users/WaffleLapkin/following{/other_user}", "gists_url": "https://api.github.com/users/WaffleLapkin/gists{/gist_id}", "starred_url": "https://api.github.com/users/WaffleLapkin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/WaffleLapkin/subscriptions", "organizations_url": "https://api.github.com/users/WaffleLapkin/orgs", "repos_url": "https://api.github.com/users/WaffleLapkin/repos", "events_url": "https://api.github.com/users/WaffleLapkin/events{/privacy}", "received_events_url": "https://api.github.com/users/WaffleLapkin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "WaffleLapkin", "id": 38225716, "node_id": "MDQ6VXNlcjM4MjI1NzE2", "avatar_url": "https://avatars.githubusercontent.com/u/38225716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/WaffleLapkin", "html_url": "https://github.com/WaffleLapkin", "followers_url": "https://api.github.com/users/WaffleLapkin/followers", "following_url": "https://api.github.com/users/WaffleLapkin/following{/other_user}", "gists_url": "https://api.github.com/users/WaffleLapkin/gists{/gist_id}", "starred_url": "https://api.github.com/users/WaffleLapkin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/WaffleLapkin/subscriptions", "organizations_url": "https://api.github.com/users/WaffleLapkin/orgs", "repos_url": "https://api.github.com/users/WaffleLapkin/repos", "events_url": "https://api.github.com/users/WaffleLapkin/events{/privacy}", "received_events_url": "https://api.github.com/users/WaffleLapkin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0d4a5c725a3f0cbc2f2597be7e9dec9ba27409ff", "url": "https://api.github.com/repos/rust-lang/rust/commits/0d4a5c725a3f0cbc2f2597be7e9dec9ba27409ff", "html_url": "https://github.com/rust-lang/rust/commit/0d4a5c725a3f0cbc2f2597be7e9dec9ba27409ff"}], "stats": {"total": 30, "additions": 17, "deletions": 13}, "files": [{"sha": "1d29a234a3c882192c31cf9b81aabca6a8db9022", "filename": "compiler/rustc_lint/src/deref_into_dyn_supertrait.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/20f3de5ab1151e68e727b5e1c22bcafca738bb7e/compiler%2Frustc_lint%2Fsrc%2Fderef_into_dyn_supertrait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20f3de5ab1151e68e727b5e1c22bcafca738bb7e/compiler%2Frustc_lint%2Fsrc%2Fderef_into_dyn_supertrait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fderef_into_dyn_supertrait.rs?ref=20f3de5ab1151e68e727b5e1c22bcafca738bb7e", "patch": "@@ -3,6 +3,7 @@ use crate::{LateContext, LateLintPass, LintContext};\n use rustc_errors::DelayDm;\n use rustc_hir as hir;\n use rustc_middle::{traits::util::supertraits, ty};\n+use rustc_span::sym;\n \n declare_lint! {\n     /// The `deref_into_dyn_supertrait` lint is output whenever there is a use of the\n@@ -72,13 +73,19 @@ impl<'tcx> LateLintPass<'tcx> for DerefIntoDynSupertrait {\n         {\n             cx.struct_span_lint(\n                 DEREF_INTO_DYN_SUPERTRAIT,\n-                item.span,\n+                cx.tcx.def_span(item.owner_id.def_id),\n                 DelayDm(|| {\n                     format!(\n-                        \"`{t}` implements `Deref` with supertrait `{target_principal}` as output\"\n+                        \"`{t}` implements `Deref` with supertrait `{target_principal}` as target\"\n                     )\n                 }),\n-                |lint| lint,\n+                |lint| {\n+                    if let Some(target_span) = impl_.items.iter().find_map(|i| (i.ident.name == sym::Target).then_some(i.span)) {\n+                        lint.span_label(target_span, \"target type is set here\");\n+                    }\n+\n+                    lint\n+                },\n             )\n         }\n     }"}, {"sha": "d624187561ed7e0fbbe74ce9f738aa8a835e66dd", "filename": "src/test/ui/traits/trait-upcasting/migrate-lint-deny.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/20f3de5ab1151e68e727b5e1c22bcafca738bb7e/src%2Ftest%2Fui%2Ftraits%2Ftrait-upcasting%2Fmigrate-lint-deny.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20f3de5ab1151e68e727b5e1c22bcafca738bb7e/src%2Ftest%2Fui%2Ftraits%2Ftrait-upcasting%2Fmigrate-lint-deny.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Ftrait-upcasting%2Fmigrate-lint-deny.rs?ref=20f3de5ab1151e68e727b5e1c22bcafca738bb7e", "patch": "@@ -9,7 +9,7 @@ trait A {}\n trait B: A {}\n \n impl<'a> Deref for dyn 'a + B {\n-    //~^ ERROR `(dyn B + 'a)` implements `Deref` with supertrait `A` as output\n+    //~^ ERROR `(dyn B + 'a)` implements `Deref` with supertrait `A` as target\n     //~| WARN this was previously accepted by the compiler but is being phased out;\n \n     type Target = dyn A;"}, {"sha": "4533b1163425c61153440bff60afa6ab776be5c6", "filename": "src/test/ui/traits/trait-upcasting/migrate-lint-deny.stderr", "status": "modified", "additions": 6, "deletions": 9, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/20f3de5ab1151e68e727b5e1c22bcafca738bb7e/src%2Ftest%2Fui%2Ftraits%2Ftrait-upcasting%2Fmigrate-lint-deny.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/20f3de5ab1151e68e727b5e1c22bcafca738bb7e/src%2Ftest%2Fui%2Ftraits%2Ftrait-upcasting%2Fmigrate-lint-deny.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Ftrait-upcasting%2Fmigrate-lint-deny.stderr?ref=20f3de5ab1151e68e727b5e1c22bcafca738bb7e", "patch": "@@ -1,14 +1,11 @@\n-error: `(dyn B + 'a)` implements `Deref` with supertrait `A` as output\n+error: `(dyn B + 'a)` implements `Deref` with supertrait `A` as target\n   --> $DIR/migrate-lint-deny.rs:11:1\n    |\n-LL | / impl<'a> Deref for dyn 'a + B {\n-LL | |\n-LL | |\n-LL | |\n-...  |\n-LL | |     }\n-LL | | }\n-   | |_^\n+LL | impl<'a> Deref for dyn 'a + B {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+...\n+LL |     type Target = dyn A;\n+   |     -------------------- target type is set here\n    |\n    = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n    = note: for more information, see issue #89460 <https://github.com/rust-lang/rust/issues/89460>"}]}