{"sha": "d151ef7437cdedb1767d6369c2a3fe175c9971ca", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQxNTFlZjc0MzdjZGVkYjE3NjdkNjM2OWMyYTNmZTE3NWM5OTcxY2E=", "commit": {"author": {"name": "flip1995", "email": "hello@philkrones.com", "date": "2019-11-23T16:53:41Z"}, "committer": {"name": "flip1995", "email": "hello@philkrones.com", "date": "2019-11-23T16:53:41Z"}, "message": "Merge remote-tracking branch 'upstream/zst-offset' into rollup-new-lints", "tree": {"sha": "99066a516b504569e6cfd4022cd7bc221642a957", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/99066a516b504569e6cfd4022cd7bc221642a957"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d151ef7437cdedb1767d6369c2a3fe175c9971ca", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZxoS6lESXlRGMHWcaTCGhp1QZjcFAl3ZZBkACgkQaTCGhp1Q\nZjcXYRAAiisGBdiI5kSaXicA29adwm+AIb+/UlfRc3/z+pHB/fgtzq1zox0pH6/+\nq5IAi+U7MLHVOwrrFrsrKstChEhG98Qq/p5I16zZeA+UYiRYAXIOerJd3R0giCbZ\npZMWlBbKIfExtsbxeuoSGcGjLDy/52dIVZbOrSGJEC5H9LVQdi4VBxp+HbIRXydG\nsI0iwTFiBh/hdJGcVTOPzIwZ0K1TBBouVgy9AYpKgqE1Xmsb2zcCanR+McEsPOPT\n1ekwtDvd4VZwexE1mxgv0loQ/rKDew5GMyehc64sdU24wm7XyfbFOUklKDBZIokM\nRj5A/2kK5c3KLgovypcjZuFBZYAMa0m/UDFw5z46mZQLVmLLnyeyXIvtZdi2f0MZ\nYRWJmII3yqqeupKDxDr/Rzbgg20G04fJJ7sjZFJUs37I9GuaKzB/j3QOCS+ENB43\nHptzwTqWFBloMQfvDKUk3A2ERc5flO9hVuPpDLKQ8NQkzJSkjV0aV+aAcMZrObbn\nLxfkYeaqcaoQE0czOpOvlcIHmkAsd+FmbsdRWAYdnTaY6lZdC9EZkTxaIsZEtnpu\n3MPIKCkgAn37aXd3o0SfrrTFKXEoxlB4nNY3fuXS+B2jsz66OJtzFmHamO2EPfyt\n2Ibbv+mCq0Lv1H7L5Doc9W4PcAYsn6BMTOdU4iSGrbDKl/K4frg=\n=RZgL\n-----END PGP SIGNATURE-----", "payload": "tree 99066a516b504569e6cfd4022cd7bc221642a957\nparent 60e8413a4e5b7c67001176783893b12411ce355e\nparent c21b1985767f0a4cea6f7b504210300f0390f5d8\nauthor flip1995 <hello@philkrones.com> 1574528021 +0100\ncommitter flip1995 <hello@philkrones.com> 1574528021 +0100\n\nMerge remote-tracking branch 'upstream/zst-offset' into rollup-new-lints\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d151ef7437cdedb1767d6369c2a3fe175c9971ca", "html_url": "https://github.com/rust-lang/rust/commit/d151ef7437cdedb1767d6369c2a3fe175c9971ca", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d151ef7437cdedb1767d6369c2a3fe175c9971ca/comments", "author": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "60e8413a4e5b7c67001176783893b12411ce355e", "url": "https://api.github.com/repos/rust-lang/rust/commits/60e8413a4e5b7c67001176783893b12411ce355e", "html_url": "https://github.com/rust-lang/rust/commit/60e8413a4e5b7c67001176783893b12411ce355e"}, {"sha": "c21b1985767f0a4cea6f7b504210300f0390f5d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/c21b1985767f0a4cea6f7b504210300f0390f5d8", "html_url": "https://github.com/rust-lang/rust/commit/c21b1985767f0a4cea6f7b504210300f0390f5d8"}], "stats": {"total": 69, "additions": 67, "deletions": 2}, "files": [{"sha": "39ca3be04468ab2adecea6e74e4364294dc89014", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d151ef7437cdedb1767d6369c2a3fe175c9971ca/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/d151ef7437cdedb1767d6369c2a3fe175c9971ca/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=d151ef7437cdedb1767d6369c2a3fe175c9971ca", "patch": "@@ -1273,4 +1273,5 @@ Released 2018-09-13\n [`zero_prefixed_literal`]: https://rust-lang.github.io/rust-clippy/master/index.html#zero_prefixed_literal\n [`zero_ptr`]: https://rust-lang.github.io/rust-clippy/master/index.html#zero_ptr\n [`zero_width_space`]: https://rust-lang.github.io/rust-clippy/master/index.html#zero_width_space\n+[`zst_offset`]: https://rust-lang.github.io/rust-clippy/master/index.html#zst_offset\n <!-- end autogenerated links to lint list -->"}, {"sha": "c5106e074cbc53975799890eb5bd33159eb29202", "filename": "README.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d151ef7437cdedb1767d6369c2a3fe175c9971ca/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/d151ef7437cdedb1767d6369c2a3fe175c9971ca/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=d151ef7437cdedb1767d6369c2a3fe175c9971ca", "patch": "@@ -6,7 +6,7 @@\n \n A collection of lints to catch common mistakes and improve your [Rust](https://github.com/rust-lang/rust) code.\n \n-[There are 333 lints included in this crate!](https://rust-lang.github.io/rust-clippy/master/index.html)\n+[There are 334 lints included in this crate!](https://rust-lang.github.io/rust-clippy/master/index.html)\n \n We have a bunch of lint categories to allow you to choose how much Clippy is supposed to ~~annoy~~ help you:\n "}, {"sha": "3620bcd23a36d9476b2daa5440f0971f92d78988", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d151ef7437cdedb1767d6369c2a3fe175c9971ca/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d151ef7437cdedb1767d6369c2a3fe175c9971ca/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=d151ef7437cdedb1767d6369c2a3fe175c9971ca", "patch": "@@ -624,6 +624,7 @@ pub fn register_plugins(store: &mut lint::LintStore, sess: &Session, conf: &Conf\n         &methods::USELESS_ASREF,\n         &methods::WRONG_PUB_SELF_CONVENTION,\n         &methods::WRONG_SELF_CONVENTION,\n+        &methods::ZST_OFFSET,\n         &minmax::MIN_MAX,\n         &misc::CMP_NAN,\n         &misc::CMP_OWNED,\n@@ -1176,6 +1177,7 @@ pub fn register_plugins(store: &mut lint::LintStore, sess: &Session, conf: &Conf\n         LintId::of(&methods::UNNECESSARY_FOLD),\n         LintId::of(&methods::USELESS_ASREF),\n         LintId::of(&methods::WRONG_SELF_CONVENTION),\n+        LintId::of(&methods::ZST_OFFSET),\n         LintId::of(&minmax::MIN_MAX),\n         LintId::of(&misc::CMP_NAN),\n         LintId::of(&misc::CMP_OWNED),\n@@ -1497,6 +1499,7 @@ pub fn register_plugins(store: &mut lint::LintStore, sess: &Session, conf: &Conf\n         LintId::of(&methods::CLONE_DOUBLE_REF),\n         LintId::of(&methods::TEMPORARY_CSTRING_AS_PTR),\n         LintId::of(&methods::UNINIT_ASSUMED_INIT),\n+        LintId::of(&methods::ZST_OFFSET),\n         LintId::of(&minmax::MIN_MAX),\n         LintId::of(&misc::CMP_NAN),\n         LintId::of(&misc::FLOAT_CMP),"}, {"sha": "f20abeff0658253c71a7767b11e7725168c1c2f8", "filename": "clippy_lints/src/methods/mod.rs", "status": "modified", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/d151ef7437cdedb1767d6369c2a3fe175c9971ca/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d151ef7437cdedb1767d6369c2a3fe175c9971ca/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs?ref=d151ef7437cdedb1767d6369c2a3fe175c9971ca", "patch": "@@ -1065,6 +1065,23 @@ declare_clippy_lint! {\n     \"`.chcked_add/sub(x).unwrap_or(MAX/MIN)`\"\n }\n \n+declare_clippy_lint! {\n+    /// **What it does:** Checks for `offset(_)`, `wrapping_`{`add`, `sub`}, etc. on raw pointers to\n+    /// zero-sized types\n+    ///\n+    /// **Why is this bad?** This is a no-op, and likely unintended\n+    ///\n+    /// **Known problems:** None\n+    ///\n+    /// **Example:**\n+    /// ```ignore\n+    /// unsafe { (&() as *const ()).offest(1) };\n+    /// ```\n+    pub ZST_OFFSET,\n+    correctness,\n+    \"Check for offset calculations on raw pointers to zero-sized types\"\n+}\n+\n declare_lint_pass!(Methods => [\n     OPTION_UNWRAP_USED,\n     RESULT_UNWRAP_USED,\n@@ -1109,6 +1126,7 @@ declare_lint_pass!(Methods => [\n     SUSPICIOUS_MAP,\n     UNINIT_ASSUMED_INIT,\n     MANUAL_SATURATING_ARITHMETIC,\n+    ZST_OFFSET,\n ]);\n \n impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Methods {\n@@ -1167,6 +1185,9 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Methods {\n             | [\"unwrap_or\", arith @ \"checked_mul\"] => {\n                 manual_saturating_arithmetic::lint(cx, expr, &arg_lists, &arith[\"checked_\".len()..])\n             },\n+            [\"add\"] | [\"offset\"] | [\"sub\"] | [\"wrapping_offset\"] | [\"wrapping_add\"] | [\"wrapping_sub\"] => {\n+                check_pointer_offset(cx, expr, arg_lists[0])\n+            },\n             _ => {},\n         }\n \n@@ -3063,3 +3084,15 @@ fn contains_return(expr: &hir::Expr) -> bool {\n     visitor.visit_expr(expr);\n     visitor.found\n }\n+\n+fn check_pointer_offset(cx: &LateContext<'_, '_>, expr: &hir::Expr, args: &[hir::Expr]) {\n+    if_chain! {\n+        if args.len() == 2;\n+        if let ty::RawPtr(ty::TypeAndMut { ref ty, .. }) = cx.tables.expr_ty(&args[0]).kind;\n+        if let Ok(layout) = cx.tcx.layout_of(cx.param_env.and(ty));\n+        if layout.is_zst();\n+        then {\n+            span_lint(cx, ZST_OFFSET, expr.span, \"offset calculation on zero-sized value\");\n+        }\n+    }\n+}"}, {"sha": "8d046aa2b22e65a6342d30d6166d24c137d2dbfb", "filename": "src/lintlist/mod.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d151ef7437cdedb1767d6369c2a3fe175c9971ca/src%2Flintlist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d151ef7437cdedb1767d6369c2a3fe175c9971ca/src%2Flintlist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flintlist%2Fmod.rs?ref=d151ef7437cdedb1767d6369c2a3fe175c9971ca", "patch": "@@ -6,7 +6,7 @@ pub use lint::Lint;\n pub use lint::LINT_LEVELS;\n \n // begin lint list, do not remove this comment, it\u2019s used in `update_lints`\n-pub const ALL_LINTS: [Lint; 333] = [\n+pub const ALL_LINTS: [Lint; 334] = [\n     Lint {\n         name: \"absurd_extreme_comparisons\",\n         group: \"correctness\",\n@@ -2338,5 +2338,12 @@ pub const ALL_LINTS: [Lint; 333] = [\n         deprecation: None,\n         module: \"unicode\",\n     },\n+    Lint {\n+        name: \"zst_offset\",\n+        group: \"correctness\",\n+        desc: \"Check for offset calculations on raw pointers to zero-sized types\",\n+        deprecation: None,\n+        module: \"methods\",\n+    },\n ];\n // end lint list, do not remove this comment, it\u2019s used in `update_lints`"}, {"sha": "2de904376ad45b438ef580b99f2791fe7d5ea9bd", "filename": "tests/ui/zero_offset.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d151ef7437cdedb1767d6369c2a3fe175c9971ca/tests%2Fui%2Fzero_offset.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d151ef7437cdedb1767d6369c2a3fe175c9971ca/tests%2Fui%2Fzero_offset.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fzero_offset.rs?ref=d151ef7437cdedb1767d6369c2a3fe175c9971ca", "patch": "@@ -0,0 +1,12 @@\n+fn main() {\n+    unsafe {\n+        let x = &() as *const ();\n+        x.offset(0);\n+        x.wrapping_add(0);\n+        x.sub(0);\n+        x.wrapping_sub(0);\n+\n+        let y = &1 as *const u8;\n+        y.offset(0);\n+    }\n+}"}, {"sha": "cfcd7de2b3d2c6b4503cbb125ff03be2ee0896b8", "filename": "tests/ui/zero_offset.stderr", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d151ef7437cdedb1767d6369c2a3fe175c9971ca/tests%2Fui%2Fzero_offset.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d151ef7437cdedb1767d6369c2a3fe175c9971ca/tests%2Fui%2Fzero_offset.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fzero_offset.stderr?ref=d151ef7437cdedb1767d6369c2a3fe175c9971ca", "patch": "@@ -0,0 +1,9 @@\n+error[E0606]: casting `&i32` as `*const u8` is invalid\n+  --> $DIR/zero_offset.rs:9:17\n+   |\n+LL |         let y = &1 as *const u8;\n+   |                 ^^^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0606`."}]}