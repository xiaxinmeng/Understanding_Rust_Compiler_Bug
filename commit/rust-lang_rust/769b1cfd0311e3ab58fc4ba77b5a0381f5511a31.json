{"sha": "769b1cfd0311e3ab58fc4ba77b5a0381f5511a31", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc2OWIxY2ZkMDMxMWUzYWI1OGZjNGJhNzdiNWEwMzgxZjU1MTFhMzE=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2019-07-03T20:20:16Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2019-07-03T20:21:34Z"}, "message": "Normalize projections in opaque types", "tree": {"sha": "a4d65e5a445b85aa10e884d0b68cd131186288d2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a4d65e5a445b85aa10e884d0b68cd131186288d2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31", "html_url": "https://github.com/rust-lang/rust/commit/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "088b987307b91612ab164026e1dcdd0129fdb62b", "url": "https://api.github.com/repos/rust-lang/rust/commits/088b987307b91612ab164026e1dcdd0129fdb62b", "html_url": "https://github.com/rust-lang/rust/commit/088b987307b91612ab164026e1dcdd0129fdb62b"}], "stats": {"total": 214, "additions": 214, "deletions": 0}, "files": [{"sha": "0c660aab65df2240aed0760e54b06e1250c21cbc", "filename": "src/librustc/infer/opaque_types/mod.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Flibrustc%2Finfer%2Fopaque_types%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Flibrustc%2Finfer%2Fopaque_types%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Fopaque_types%2Fmod.rs?ref=769b1cfd0311e3ab58fc4ba77b5a0381f5511a31", "patch": "@@ -1037,6 +1037,12 @@ impl<'a, 'tcx> Instantiator<'a, 'tcx> {\n         let predicates_of = tcx.predicates_of(def_id);\n         debug!(\"instantiate_opaque_types: predicates={:#?}\", predicates_of,);\n         let bounds = predicates_of.instantiate(tcx, substs);\n+\n+        let param_env = tcx.param_env(def_id);\n+        let InferOk { value: bounds, obligations } =\n+            infcx.partially_normalize_associated_types_in(span, self.body_id, param_env, &bounds);\n+        self.obligations.extend(obligations);\n+\n         debug!(\"instantiate_opaque_types: bounds={:?}\", bounds);\n \n         let required_region_bounds = tcx.required_region_bounds(ty, bounds.predicates.clone());"}, {"sha": "05fdfaa9a806a4755f48eb3baaee2633db41d738", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=769b1cfd0311e3ab58fc4ba77b5a0381f5511a31", "patch": "@@ -1065,6 +1065,7 @@ fn check_fn<'a, 'tcx>(\n         &declared_ret_ty,\n         decl.output.span(),\n     );\n+    debug!(\"check_fn: declared_ret_ty: {}, revealed_ret_ty: {}\", declared_ret_ty, revealed_ret_ty);\n     fcx.ret_coercion = Some(RefCell::new(CoerceMany::new(revealed_ret_ty)));\n     fn_sig = fcx.tcx.mk_fn_sig(\n         fn_sig.inputs().iter().cloned(),"}, {"sha": "8026350aaf2fb00fed31e405bf19786c7e983425", "filename": "src/test/ui/async-await/bound-normalization.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Ftest%2Fui%2Fasync-await%2Fbound-normalization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Ftest%2Fui%2Fasync-await%2Fbound-normalization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fbound-normalization.rs?ref=769b1cfd0311e3ab58fc4ba77b5a0381f5511a31", "patch": "@@ -0,0 +1,16 @@\n+// check-pass\n+// edition:2018\n+\n+#![feature(async_await)]\n+\n+// See issue 60414\n+\n+trait Trait {\n+    type Assoc;\n+}\n+\n+async fn foo<T: Trait<Assoc=()>>() -> T::Assoc {\n+    ()\n+}\n+\n+fn main() {}"}, {"sha": "476ae62fa0fa47d783a79ddf9a3d4d91c3e81f66", "filename": "src/test/ui/impl-trait/bound-normalization-fail.rs", "status": "added", "additions": 53, "deletions": 0, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Ftest%2Fui%2Fimpl-trait%2Fbound-normalization-fail.rs", "raw_url": "https://github.com/rust-lang/rust/raw/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Ftest%2Fui%2Fimpl-trait%2Fbound-normalization-fail.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fbound-normalization-fail.rs?ref=769b1cfd0311e3ab58fc4ba77b5a0381f5511a31", "patch": "@@ -0,0 +1,53 @@\n+// compile-fail\n+// edition:2018\n+\n+#![feature(async_await)]\n+#![feature(existential_type)]\n+#![feature(impl_trait_in_bindings)]\n+//~^ WARNING the feature `impl_trait_in_bindings` is incomplete\n+\n+// See issue 60414\n+\n+/////////////////////////////////////////////\n+// Reduction to `impl Trait`\n+\n+struct Foo<T>(T);\n+\n+trait FooLike { type Output; }\n+\n+impl<T> FooLike for Foo<T> {\n+    type Output = T;\n+}\n+\n+mod impl_trait {\n+    use super::*;\n+\n+    trait Trait {\n+        type Assoc;\n+    }\n+\n+    /// `T::Assoc` can't be normalized any further here.\n+    fn foo_fail<T: Trait>() -> impl FooLike<Output=T::Assoc> {\n+        //~^ ERROR: type mismatch\n+        Foo(())\n+    }\n+}\n+\n+/////////////////////////////////////////////\n+// Same with lifetimes in the trait\n+\n+mod lifetimes {\n+    use super::*;\n+\n+    trait Trait<'a> {\n+        type Assoc;\n+    }\n+\n+    /// Missing bound constraining `Assoc`, `T::Assoc` can't be normalized further.\n+    fn foo2_fail<'a, T: Trait<'a>>() -> impl FooLike<Output=T::Assoc> {\n+        //~^ ERROR: type mismatch\n+        Foo(())\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "fa2dd20a6eed76b0f77651c550cdad2794096e8c", "filename": "src/test/ui/impl-trait/bound-normalization-fail.stderr", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Ftest%2Fui%2Fimpl-trait%2Fbound-normalization-fail.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Ftest%2Fui%2Fimpl-trait%2Fbound-normalization-fail.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fbound-normalization-fail.stderr?ref=769b1cfd0311e3ab58fc4ba77b5a0381f5511a31", "patch": "@@ -0,0 +1,29 @@\n+warning: the feature `impl_trait_in_bindings` is incomplete and may cause the compiler to crash\n+  --> $DIR/bound-normalization-fail.rs:6:12\n+   |\n+LL | #![feature(impl_trait_in_bindings)]\n+   |            ^^^^^^^^^^^^^^^^^^^^^^\n+\n+error[E0271]: type mismatch resolving `<Foo<()> as FooLike>::Output == <T as impl_trait::Trait>::Assoc`\n+  --> $DIR/bound-normalization-fail.rs:30:32\n+   |\n+LL |     fn foo_fail<T: Trait>() -> impl FooLike<Output=T::Assoc> {\n+   |                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ expected (), found associated type\n+   |\n+   = note: expected type `()`\n+              found type `<T as impl_trait::Trait>::Assoc`\n+   = note: the return type of a function must have a statically known size\n+\n+error[E0271]: type mismatch resolving `<Foo<()> as FooLike>::Output == <T as lifetimes::Trait<'static>>::Assoc`\n+  --> $DIR/bound-normalization-fail.rs:47:41\n+   |\n+LL |     fn foo2_fail<'a, T: Trait<'a>>() -> impl FooLike<Output=T::Assoc> {\n+   |                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ expected (), found associated type\n+   |\n+   = note: expected type `()`\n+              found type `<T as lifetimes::Trait<'static>>::Assoc`\n+   = note: the return type of a function must have a statically known size\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0271`."}, {"sha": "1c7e776a4798a2d64ec9c928c973e8961a91023b", "filename": "src/test/ui/impl-trait/bound-normalization-pass.rs", "status": "added", "additions": 103, "deletions": 0, "changes": 103, "blob_url": "https://github.com/rust-lang/rust/blob/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Ftest%2Fui%2Fimpl-trait%2Fbound-normalization-pass.rs", "raw_url": "https://github.com/rust-lang/rust/raw/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Ftest%2Fui%2Fimpl-trait%2Fbound-normalization-pass.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fbound-normalization-pass.rs?ref=769b1cfd0311e3ab58fc4ba77b5a0381f5511a31", "patch": "@@ -0,0 +1,103 @@\n+// check-pass\n+// edition:2018\n+\n+#![feature(async_await)]\n+#![feature(existential_type)]\n+#![feature(impl_trait_in_bindings)]\n+//~^ WARNING the feature `impl_trait_in_bindings` is incomplete\n+\n+// See issue 60414\n+\n+/////////////////////////////////////////////\n+// Reduction to `impl Trait`\n+\n+struct Foo<T>(T);\n+\n+trait FooLike { type Output; }\n+\n+impl<T> FooLike for Foo<T> {\n+    type Output = T;\n+}\n+\n+mod impl_trait {\n+    use super::*;\n+\n+    trait Trait {\n+        type Assoc;\n+    }\n+\n+    /// `T::Assoc` should be normalized to `()` here.\n+    fn foo_pass<T: Trait<Assoc=()>>() -> impl FooLike<Output=T::Assoc> {\n+        Foo(())\n+    }\n+}\n+\n+/////////////////////////////////////////////\n+// Same with lifetimes in the trait\n+\n+mod lifetimes {\n+    use super::*;\n+\n+    trait Trait<'a> {\n+        type Assoc;\n+    }\n+\n+    /// Like above.\n+    fn foo2_pass<'a, T: Trait<'a, Assoc=()> + 'a>() -> impl FooLike<Output=T::Assoc> + 'a {\n+        Foo(())\n+    }\n+\n+    /// Normalization to type containing bound region.\n+    fn foo2_pass2<'a, T: Trait<'a, Assoc=&'a ()> + 'a>() -> impl FooLike<Output=T::Assoc> + 'a {\n+        Foo(&())\n+    }\n+}\n+\n+/////////////////////////////////////////////\n+// Reduction using `impl Trait` in bindings\n+\n+mod impl_trait_in_bindings {\n+    struct Foo;\n+\n+    trait FooLike { type Output; }\n+\n+    impl FooLike for Foo {\n+        type Output = u32;\n+    }\n+\n+    trait Trait {\n+        type Assoc;\n+    }\n+\n+    fn foo<T: Trait<Assoc=u32>>() {\n+        let _: impl FooLike<Output=T::Assoc> = Foo;\n+    }\n+}\n+\n+/////////////////////////////////////////////\n+// The same applied to `existential type`s\n+\n+mod existential_types {\n+    trait Implemented {\n+        type Assoc;\n+    }\n+    impl<T> Implemented for T {\n+        type Assoc = u8;\n+    }\n+\n+    trait Trait {\n+        type Out;\n+    }\n+\n+    impl Trait for () {\n+        type Out = u8;\n+    }\n+\n+    existential type Ex: Trait<Out = <() as Implemented>::Assoc>;\n+\n+    fn define() -> Ex {\n+        ()\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "c1b7fb2c253a4e5c61cf2ea480c8e4415d371480", "filename": "src/test/ui/impl-trait/bound-normalization-pass.stderr", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Ftest%2Fui%2Fimpl-trait%2Fbound-normalization-pass.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/769b1cfd0311e3ab58fc4ba77b5a0381f5511a31/src%2Ftest%2Fui%2Fimpl-trait%2Fbound-normalization-pass.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fbound-normalization-pass.stderr?ref=769b1cfd0311e3ab58fc4ba77b5a0381f5511a31", "patch": "@@ -0,0 +1,6 @@\n+warning: the feature `impl_trait_in_bindings` is incomplete and may cause the compiler to crash\n+  --> $DIR/bound-normalization-pass.rs:6:12\n+   |\n+LL | #![feature(impl_trait_in_bindings)]\n+   |            ^^^^^^^^^^^^^^^^^^^^^^\n+"}]}