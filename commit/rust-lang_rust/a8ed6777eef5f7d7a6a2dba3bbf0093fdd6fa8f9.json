{"sha": "a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE4ZWQ2Nzc3ZWVmNWY3ZDdhNmEyZGJhM2JiZjAwOTNmZGQ2ZmE4Zjk=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2019-05-05T19:37:27Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-05-05T19:37:27Z"}, "message": "Rollup merge of #60426 - varkor:fix-duplicate-arg-handling, r=alexcrichton\n\nStop `-O`/`-C opt-level` and `-g`/`-C debuginfo` conflicting\n\nAllow `-O` and `-C opt-level`, and `-g` and `-C debuginfo` to be specified simultaneously without conflict. In such cases, the rightmost provided option is chosen.\n\nFixes https://github.com/rust-lang/rust/issues/7493.\nFixes https://github.com/rust-lang/rust/issues/32352.\n\n~Blocked on https://github.com/rust-lang-nursery/getopts/pull/79.~\n\nr? @alexcrichton", "tree": {"sha": "d00ea2d3a8ffacda4fa23288dde17adfb52e5fe1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d00ea2d3a8ffacda4fa23288dde17adfb52e5fe1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJczzt3CRBK7hj4Ov3rIwAAdHIIADNzY/P0KQybyKfpXBnYwQPP\n7gzKcipD+NZK9TZYWbB4Egp9weiB1a/HjhJHBJgn0x2gJnRH8pYz+q3CayrvqwXD\nxuXuYuv61++bmrm+rwjJ3hWwnUsWq2HEzyHEvmXK8ZcK3cJn00fv1mnOGeNQ5lb+\n4JcW/bJZbonfReHrHc1X+13Q7CVsG0nloRdT/BlW1gS1faCOPlXBfqOVxgm40mRn\njIphpvVzbxN6QSC9Y5ZWXFp/XW8TWnbBMJ0bFr0N8ooD5yOOFQ3Ng2nK9hfvYddV\nLIoRZtRWsFTjsadCsl7IJS6MJ7R/+FBvFmQERi6y1zogY19UFjSCWAwcwKYN39s=\n=wsU1\n-----END PGP SIGNATURE-----\n", "payload": "tree d00ea2d3a8ffacda4fa23288dde17adfb52e5fe1\nparent 577b0b9c627377665b6ff0339f5f66436f9b5c70\nparent 80f54ba8811901ae8de1cc9971f2eab418c76fdd\nauthor Manish Goregaokar <manishsmail@gmail.com> 1557085047 -0700\ncommitter GitHub <noreply@github.com> 1557085047 -0700\n\nRollup merge of #60426 - varkor:fix-duplicate-arg-handling, r=alexcrichton\n\nStop `-O`/`-C opt-level` and `-g`/`-C debuginfo` conflicting\n\nAllow `-O` and `-C opt-level`, and `-g` and `-C debuginfo` to be specified simultaneously without conflict. In such cases, the rightmost provided option is chosen.\n\nFixes https://github.com/rust-lang/rust/issues/7493.\nFixes https://github.com/rust-lang/rust/issues/32352.\n\n~Blocked on https://github.com/rust-lang-nursery/getopts/pull/79.~\n\nr? @alexcrichton\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9", "html_url": "https://github.com/rust-lang/rust/commit/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "577b0b9c627377665b6ff0339f5f66436f9b5c70", "url": "https://api.github.com/repos/rust-lang/rust/commits/577b0b9c627377665b6ff0339f5f66436f9b5c70", "html_url": "https://github.com/rust-lang/rust/commit/577b0b9c627377665b6ff0339f5f66436f9b5c70"}, {"sha": "80f54ba8811901ae8de1cc9971f2eab418c76fdd", "url": "https://api.github.com/repos/rust-lang/rust/commits/80f54ba8811901ae8de1cc9971f2eab418c76fdd", "html_url": "https://github.com/rust-lang/rust/commit/80f54ba8811901ae8de1cc9971f2eab418c76fdd"}], "stats": {"total": 78, "additions": 60, "deletions": 18}, "files": [{"sha": "c930b628f4b37cb50b49e6ffaa318c266703bf54", "filename": "Cargo.lock", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9", "patch": "@@ -169,7 +169,7 @@ dependencies = [\n  \"cc 1.0.35 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"cmake 0.1.38 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"filetime 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"getopts 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"getopts 0.2.19 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"lazy_static 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"num_cpus 1.8.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -463,7 +463,7 @@ dependencies = [\n  \"diff 0.1.11 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"env_logger 0.5.13 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"filetime 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"getopts 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"getopts 0.2.19 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"log 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -484,7 +484,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"diff 0.1.11 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"filetime 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"getopts 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"getopts 0.2.19 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"log 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"miow 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -974,7 +974,7 @@ dependencies = [\n \n [[package]]\n name = \"getopts\"\n-version = \"0.2.18\"\n+version = \"0.2.19\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"unicode-width 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -1989,7 +1989,7 @@ version = \"0.1.2\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"bitflags 0.9.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"getopts 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"getopts 0.2.19 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n@@ -2008,7 +2008,7 @@ version = \"0.5.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"getopts 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"getopts 0.2.19 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"memchr 2.2.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"unicase 2.3.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n@@ -3095,7 +3095,7 @@ dependencies = [\n  \"dirs 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"env_logger 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"failure 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"getopts 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"getopts 0.2.19 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"ignore 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"itertools 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -3522,7 +3522,7 @@ dependencies = [\n name = \"test\"\n version = \"0.0.0\"\n dependencies = [\n- \"getopts 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"getopts 0.2.19 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"proc_macro 0.0.0\",\n  \"term 0.0.0\",\n ]\n@@ -3532,7 +3532,7 @@ name = \"tester\"\n version = \"0.5.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n- \"getopts 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"getopts 0.2.19 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"term 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n@@ -4132,7 +4132,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum futures 0.1.21 (registry+https://github.com/rust-lang/crates.io-index)\" = \"1a70b146671de62ec8c8ed572219ca5d594d9b06c0b364d5e67b722fc559b48c\"\n \"checksum fwdansi 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"34dd4c507af68d37ffef962063dfa1944ce0dd4d5b82043dbab1dabe088610c3\"\n \"checksum generic-array 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"ef25c5683767570c2bbd7deba372926a55eaae9982d7726ee2a1050239d45b9d\"\n-\"checksum getopts 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)\" = \"0a7292d30132fb5424b354f5dc02512a86e4c516fe544bb7a25e7f266951b797\"\n+\"checksum getopts 0.2.19 (registry+https://github.com/rust-lang/crates.io-index)\" = \"72327b15c228bfe31f1390f93dd5e9279587f0463836393c9df719ce62a3e450\"\n \"checksum git2 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"c7339329bfa14a00223244311560d11f8f489b453fb90092af97f267a6090ab0\"\n \"checksum git2-curl 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"d58551e903ed7e2d6fe3a2f3c7efa3a784ec29b19d0fbb035aaf0497c183fbdd\"\n \"checksum glob 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"9b919933a397b79c37e33b77bb2aa3dc8eb6e165ad809e58ff75bc7db2e34574\""}, {"sha": "3151b56d8e84ed86691a28de86ff8067b7e6f8f9", "filename": "src/bootstrap/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9/src%2Fbootstrap%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9/src%2Fbootstrap%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCargo.toml?ref=a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9", "patch": "@@ -39,7 +39,7 @@ build_helper = { path = \"../build_helper\" }\n cmake = \"0.1.38\"\n filetime = \"0.2\"\n num_cpus = \"1.0\"\n-getopts = \"0.2.18\"\n+getopts = \"0.2.19\"\n cc = \"1.0.35\"\n libc = \"0.2\"\n serde = \"1.0.8\""}, {"sha": "084a5429f26fa89945b8f7596983cacd7dd1fdc5", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 25, "deletions": 6, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9", "patch": "@@ -2181,10 +2181,21 @@ pub fn build_session_options_and_crate_config(\n         TargetTriple::from_triple(host_triple())\n     };\n     let opt_level = {\n-        if matches.opt_present(\"O\") {\n-            if cg.opt_level.is_some() {\n-                early_error(error_format, \"-O and -C opt-level both provided\");\n+        // The `-O` and `-C opt-level` flags specify the same setting, so we want to be able\n+        // to use them interchangeably. However, because they're technically different flags,\n+        // we need to work out manually which should take precedence if both are supplied (i.e.\n+        // the rightmost flag). We do this by finding the (rightmost) position of both flags and\n+        // comparing them. Note that if a flag is not found, its position will be `None`, which\n+        // always compared less than `Some(_)`.\n+        let max_o = matches.opt_positions(\"O\").into_iter().max();\n+        let max_c = matches.opt_strs_pos(\"C\").into_iter().flat_map(|(i, s)| {\n+            if let Some(\"opt-level\") = s.splitn(2, '=').next() {\n+                Some(i)\n+            } else {\n+                None\n             }\n+        }).max();\n+        if max_o > max_c {\n             OptLevel::Default\n         } else {\n             match cg.opt_level.as_ref().map(String::as_ref) {\n@@ -2208,11 +2219,19 @@ pub fn build_session_options_and_crate_config(\n             }\n         }\n     };\n+    // The `-g` and `-C debuginfo` flags specify the same setting, so we want to be able\n+    // to use them interchangeably. See the note above (regarding `-O` and `-C opt-level`)\n+    // for more details.\n     let debug_assertions = cg.debug_assertions.unwrap_or(opt_level == OptLevel::No);\n-    let debuginfo = if matches.opt_present(\"g\") {\n-        if cg.debuginfo.is_some() {\n-            early_error(error_format, \"-g and -C debuginfo both provided\");\n+    let max_g = matches.opt_positions(\"g\").into_iter().max();\n+    let max_c = matches.opt_strs_pos(\"C\").into_iter().flat_map(|(i, s)| {\n+        if let Some(\"debuginfo\") = s.splitn(2, '=').next() {\n+            Some(i)\n+        } else {\n+            None\n         }\n+    }).max();\n+    let debuginfo = if max_g > max_c {\n         DebugInfo::Full\n     } else {\n         match cg.debuginfo {"}, {"sha": "a72e4c70502896df7782754e4dad0ee8aec8b9b6", "filename": "src/libtest/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9/src%2Flibtest%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9/src%2Flibtest%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2FCargo.toml?ref=a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9", "patch": "@@ -10,7 +10,7 @@ path = \"lib.rs\"\n crate-type = [\"dylib\", \"rlib\"]\n \n [dependencies]\n-getopts = \"0.2.18\"\n+getopts = \"0.2.19\"\n term = { path = \"../libterm\" }\n \n # not actually used but needed to always have proc_macro in the sysroot"}, {"sha": "bea610eeb9fd1b8b8de1e919b5d211a0d0e5b11f", "filename": "src/test/run-make-fulldeps/override-aliased-flags/Makefile", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9/src%2Ftest%2Frun-make-fulldeps%2Foverride-aliased-flags%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9/src%2Ftest%2Frun-make-fulldeps%2Foverride-aliased-flags%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Foverride-aliased-flags%2FMakefile?ref=a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9", "patch": "@@ -0,0 +1,22 @@\n+-include ../tools.mk\n+\n+# FIXME: it would be good to check that it's actually the rightmost flags\n+# that are used when multiple flags are specified, but I can't think of a\n+# reliable way to check this.\n+\n+all:\n+\t# Test that `-O` and `-C opt-level` can be specified multiple times.\n+\t# The rightmost flag will be used over any previous flags.\n+\t$(RUSTC) -O -O main.rs\n+\t$(RUSTC) -O -C opt-level=0 main.rs\n+\t$(RUSTC) -C opt-level=0 -O main.rs\n+\t$(RUSTC) -C opt-level=0 -C opt-level=2 main.rs\n+\t$(RUSTC) -C opt-level=2 -C opt-level=0 main.rs\n+\n+\t# Test that `-g` and `-C debuginfo` can be specified multiple times.\n+\t# The rightmost flag will be used over any previous flags.\n+\t$(RUSTC) -g -g main.rs\n+\t$(RUSTC) -g -C debuginfo=0 main.rs\n+\t$(RUSTC) -C debuginfo=0 -g main.rs\n+\t$(RUSTC) -C debuginfo=0 -C debuginfo=2 main.rs\n+\t$(RUSTC) -C debuginfo=2 -C debuginfo=0 main.rs"}, {"sha": "f328e4d9d04c31d0d70d16d21a07d1613be9d577", "filename": "src/test/run-make-fulldeps/override-aliased-flags/main.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9/src%2Ftest%2Frun-make-fulldeps%2Foverride-aliased-flags%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9/src%2Ftest%2Frun-make-fulldeps%2Foverride-aliased-flags%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Foverride-aliased-flags%2Fmain.rs?ref=a8ed6777eef5f7d7a6a2dba3bbf0093fdd6fa8f9", "patch": "@@ -0,0 +1 @@\n+fn main() {}"}]}