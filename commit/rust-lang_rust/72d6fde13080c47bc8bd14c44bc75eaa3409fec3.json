{"sha": "72d6fde13080c47bc8bd14c44bc75eaa3409fec3", "node_id": "C_kwDOAAsO6NoAKDcyZDZmZGUxMzA4MGM0N2JjOGJkMTRjNDRiYzc1ZWFhMzQwOWZlYzM", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-09-13T13:27:59Z"}, "committer": {"name": "R\u00e9my Rakic", "email": "remy.rakic+github@gmail.com", "date": "2022-10-20T22:44:10Z"}, "message": "Remove doc comments only for private items or some specific doc comments", "tree": {"sha": "3294ca880d6dd5cb0740fb28eae5210eeb331d25", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3294ca880d6dd5cb0740fb28eae5210eeb331d25"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/72d6fde13080c47bc8bd14c44bc75eaa3409fec3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/72d6fde13080c47bc8bd14c44bc75eaa3409fec3", "html_url": "https://github.com/rust-lang/rust/commit/72d6fde13080c47bc8bd14c44bc75eaa3409fec3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/72d6fde13080c47bc8bd14c44bc75eaa3409fec3/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lqd", "id": 247183, "node_id": "MDQ6VXNlcjI0NzE4Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/247183?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lqd", "html_url": "https://github.com/lqd", "followers_url": "https://api.github.com/users/lqd/followers", "following_url": "https://api.github.com/users/lqd/following{/other_user}", "gists_url": "https://api.github.com/users/lqd/gists{/gist_id}", "starred_url": "https://api.github.com/users/lqd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lqd/subscriptions", "organizations_url": "https://api.github.com/users/lqd/orgs", "repos_url": "https://api.github.com/users/lqd/repos", "events_url": "https://api.github.com/users/lqd/events{/privacy}", "received_events_url": "https://api.github.com/users/lqd/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b12b65c1b7f77bfd6b4155cc290b1654c09ef709", "url": "https://api.github.com/repos/rust-lang/rust/commits/b12b65c1b7f77bfd6b4155cc290b1654c09ef709", "html_url": "https://github.com/rust-lang/rust/commit/b12b65c1b7f77bfd6b4155cc290b1654c09ef709"}], "stats": {"total": 31, "additions": 27, "deletions": 4}, "files": [{"sha": "bd915d159a884c738e1c950fdd819f0005ba8a0c", "filename": "compiler/rustc_metadata/src/rmeta/encoder.rs", "status": "modified", "additions": 27, "deletions": 4, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/72d6fde13080c47bc8bd14c44bc75eaa3409fec3/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/72d6fde13080c47bc8bd14c44bc75eaa3409fec3/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs?ref=72d6fde13080c47bc8bd14c44bc75eaa3409fec3", "patch": "@@ -3,6 +3,7 @@ use crate::rmeta::def_path_hash_map::DefPathHashMapRef;\n use crate::rmeta::table::TableBuilder;\n use crate::rmeta::*;\n \n+use rustc_ast::Attribute;\n use rustc_data_structures::fingerprint::Fingerprint;\n use rustc_data_structures::fx::{FxHashMap, FxIndexSet};\n use rustc_data_structures::memmap::{Mmap, MmapMut};\n@@ -764,6 +765,26 @@ impl<'a, 'tcx> EncodeContext<'a, 'tcx> {\n     }\n }\n \n+#[inline]\n+fn should_encode_attr(\n+    tcx: TyCtxt<'_>,\n+    attr: &Attribute,\n+    def_id: LocalDefId,\n+    is_def_id_public: &mut Option<bool>,\n+) -> bool {\n+    if rustc_feature::is_builtin_only_local(attr.name_or_empty()) {\n+        false\n+    } else if attr.doc_str().is_some() {\n+        *is_def_id_public.get_or_insert_with(|| {\n+            tcx.privacy_access_levels(()).get_effective_vis(def_id).is_some()\n+        })\n+    } else if attr.has_name(sym::doc) {\n+        attr.meta_item_list().map(|l| l.iter().any(|l| !l.has_name(sym::inline))).unwrap_or(false)\n+    } else {\n+        true\n+    }\n+}\n+\n fn should_encode_visibility(def_kind: DefKind) -> bool {\n     match def_kind {\n         DefKind::Mod\n@@ -1126,12 +1147,14 @@ fn should_encode_trait_impl_trait_tys<'tcx>(tcx: TyCtxt<'tcx>, def_id: DefId) ->\n \n impl<'a, 'tcx> EncodeContext<'a, 'tcx> {\n     fn encode_attrs(&mut self, def_id: LocalDefId) {\n-        let mut attrs = self\n-            .tcx\n+        let tcx = self.tcx;\n+        let mut is_public: Option<bool> = None;\n+\n+        let mut attrs = tcx\n             .hir()\n-            .attrs(self.tcx.hir().local_def_id_to_hir_id(def_id))\n+            .attrs(tcx.hir().local_def_id_to_hir_id(def_id))\n             .iter()\n-            .filter(|attr| !rustc_feature::is_builtin_only_local(attr.name_or_empty()));\n+            .filter(move |attr| should_encode_attr(tcx, attr, def_id, &mut is_public));\n \n         record_array!(self.tables.attributes[def_id.to_def_id()] <- attrs.clone());\n         if attrs.any(|attr| attr.may_have_doc_links()) {"}]}