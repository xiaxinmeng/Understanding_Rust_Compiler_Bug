{"sha": "1cbd34faf226f55265822773a6a24892dfe3d044", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFjYmQzNGZhZjIyNmY1NTI2NTgyMjc3M2E2YTI0ODkyZGZlM2QwNDQ=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2019-11-13T13:09:23Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-11-13T13:09:23Z"}, "message": "Rollup merge of #66317 - cuviper:bindir_relative, r=Mark-Simulacrum\n\nUse a relative bindir for rustdoc to find rustc\n\nIn bootstrap, we set `RUSTC_INSTALL_BINDIR` to `config.bindir`, so\nrustdoc can find rustc relative to the toolchain sysroot. However, if a\ndistro script like Fedora's `%configure` sets an absolute path, then\nrustdoc's `sysroot.join(bin_path)` ignores that sysroot altogether.\n\nThat would be OK once the toolchain is actually installed, but it breaks\nthe in-tree doc tests during the build, since `/usr/bin/rustc` is still\nthe old version. So now we try to make `RUSTC_INSTALL_BINDIR` relative\nto the sysroot prefix in the first place.\n\nr? @Mark-Simulacrum", "tree": {"sha": "08ee0ac6cf95f4b97451723fc899e12fa4fcb41a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/08ee0ac6cf95f4b97451723fc899e12fa4fcb41a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1cbd34faf226f55265822773a6a24892dfe3d044", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdzACDCRBK7hj4Ov3rIwAAdHIIAA7yAVsZfAIfWm88kbOpgGuP\n8PmHkSKX5Vx4CBb+GFa04d0NTlAGjh73epZwET3B2YHlsiVfYjuQh7purzlv7kx4\n6+brC1PzfkH/aFPcsUMCfDWtwF6u/ekyT1PfVSzd5dHsuLcV0O4Oey7FnlMrNzjB\n/j57lfZ3oR0WWLJ26LGZZbBN/EMcvf2VQB9+vxZyJ++/xCy7vxVbz4yLFgcQlHnf\nibuE1jEdgFv/eADZR2I5ldPJtaniBTbu7DEl7EEIDv9PbWYKrnhoHA8N2dtvps3p\n58IVfkrmu5aN4z3OmAKblkSSr1y8XjB1ZS08aTt+T5ydZP10I1h7aqRthvtaoQM=\n=25N9\n-----END PGP SIGNATURE-----\n", "payload": "tree 08ee0ac6cf95f4b97451723fc899e12fa4fcb41a\nparent c75a48a924e195b5417c76f0d84ad4f002ed5fab\nparent bfa5e5f788593f3395cac9ba14cdefa5afd5e465\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1573650563 +0900\ncommitter GitHub <noreply@github.com> 1573650563 +0900\n\nRollup merge of #66317 - cuviper:bindir_relative, r=Mark-Simulacrum\n\nUse a relative bindir for rustdoc to find rustc\n\nIn bootstrap, we set `RUSTC_INSTALL_BINDIR` to `config.bindir`, so\nrustdoc can find rustc relative to the toolchain sysroot. However, if a\ndistro script like Fedora's `%configure` sets an absolute path, then\nrustdoc's `sysroot.join(bin_path)` ignores that sysroot altogether.\n\nThat would be OK once the toolchain is actually installed, but it breaks\nthe in-tree doc tests during the build, since `/usr/bin/rustc` is still\nthe old version. So now we try to make `RUSTC_INSTALL_BINDIR` relative\nto the sysroot prefix in the first place.\n\nr? @Mark-Simulacrum\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1cbd34faf226f55265822773a6a24892dfe3d044", "html_url": "https://github.com/rust-lang/rust/commit/1cbd34faf226f55265822773a6a24892dfe3d044", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1cbd34faf226f55265822773a6a24892dfe3d044/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c75a48a924e195b5417c76f0d84ad4f002ed5fab", "url": "https://api.github.com/repos/rust-lang/rust/commits/c75a48a924e195b5417c76f0d84ad4f002ed5fab", "html_url": "https://github.com/rust-lang/rust/commit/c75a48a924e195b5417c76f0d84ad4f002ed5fab"}, {"sha": "bfa5e5f788593f3395cac9ba14cdefa5afd5e465", "url": "https://api.github.com/repos/rust-lang/rust/commits/bfa5e5f788593f3395cac9ba14cdefa5afd5e465", "html_url": "https://github.com/rust-lang/rust/commit/bfa5e5f788593f3395cac9ba14cdefa5afd5e465"}], "stats": {"total": 17, "additions": 16, "deletions": 1}, "files": [{"sha": "99b8ddf7db1f0c704785a9fef9502150ac2e343d", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1cbd34faf226f55265822773a6a24892dfe3d044/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1cbd34faf226f55265822773a6a24892dfe3d044/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=1cbd34faf226f55265822773a6a24892dfe3d044", "patch": "@@ -1242,7 +1242,8 @@ impl<'a> Builder<'a> {\n             cargo.arg(\"--frozen\");\n         }\n \n-        cargo.env(\"RUSTC_INSTALL_BINDIR\", &self.config.bindir);\n+        // Try to use a sysroot-relative bindir, in case it was configured absolutely.\n+        cargo.env(\"RUSTC_INSTALL_BINDIR\", self.config.bindir_relative());\n \n         self.ci_env.force_coloring_in_ci(&mut cargo);\n "}, {"sha": "0c03b95c7b251035eb5f7ce4936877b65f481f14", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/1cbd34faf226f55265822773a6a24892dfe3d044/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1cbd34faf226f55265822773a6a24892dfe3d044/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=1cbd34faf226f55265822773a6a24892dfe3d044", "patch": "@@ -647,6 +647,20 @@ impl Config {\n         config\n     }\n \n+    /// Try to find the relative path of `bindir`, otherwise return it in full.\n+    pub fn bindir_relative(&self) -> &Path {\n+        let bindir = &self.bindir;\n+        if bindir.is_absolute() {\n+            // Try to make it relative to the prefix.\n+            if let Some(prefix) = &self.prefix {\n+                if let Ok(stripped) = bindir.strip_prefix(prefix) {\n+                    return stripped;\n+                }\n+            }\n+        }\n+        bindir\n+    }\n+\n     /// Try to find the relative path of `libdir`.\n     pub fn libdir_relative(&self) -> Option<&Path> {\n         let libdir = self.libdir.as_ref()?;"}]}