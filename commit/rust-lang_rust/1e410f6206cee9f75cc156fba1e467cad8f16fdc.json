{"sha": "1e410f6206cee9f75cc156fba1e467cad8f16fdc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFlNDEwZjYyMDZjZWU5Zjc1Y2MxNTZmYmExZTQ2N2NhZDhmMTZmZGM=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2012-04-30T23:44:34Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2012-05-03T01:32:20Z"}, "message": "rt: Fix some record alignment issues on windows", "tree": {"sha": "8955c65c74d209e9a99f0ba2f29d1d9c29fd659f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8955c65c74d209e9a99f0ba2f29d1d9c29fd659f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1e410f6206cee9f75cc156fba1e467cad8f16fdc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1e410f6206cee9f75cc156fba1e467cad8f16fdc", "html_url": "https://github.com/rust-lang/rust/commit/1e410f6206cee9f75cc156fba1e467cad8f16fdc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1e410f6206cee9f75cc156fba1e467cad8f16fdc/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e2910bf26492f2f0dce69287019138930705e417", "url": "https://api.github.com/repos/rust-lang/rust/commits/e2910bf26492f2f0dce69287019138930705e417", "html_url": "https://github.com/rust-lang/rust/commit/e2910bf26492f2f0dce69287019138930705e417"}], "stats": {"total": 126, "additions": 109, "deletions": 17}, "files": [{"sha": "ee9b6400cd4592167e143096f4400115d449d529", "filename": "src/rt/rust_shape.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1e410f6206cee9f75cc156fba1e467cad8f16fdc/src%2Frt%2Frust_shape.h", "raw_url": "https://github.com/rust-lang/rust/raw/1e410f6206cee9f75cc156fba1e467cad8f16fdc/src%2Frt%2Frust_shape.h", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_shape.h?ref=1e410f6206cee9f75cc156fba1e467cad8f16fdc", "patch": "@@ -127,13 +127,15 @@ rust_alignof<double>() {\n // On 32-bit x86 the alignment of 64-bit ints in structures is 4 bytes\n // Which is different from the preferred 8-byte alignment reported\n // by __alignof__ (at least on gcc).\n+#ifndef __WIN32__\n #ifdef __i386__\n template<>\n inline size_t\n rust_alignof<uint64_t>() {\n     return 4;\n }\n #endif\n+#endif\n \n \n // Utility classes"}, {"sha": "bc1d75172f096262ca51cc4aebfffbad6f0e9653", "filename": "src/test/run-pass/intrinsic-alignment.rs", "status": "modified", "additions": 23, "deletions": 9, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/1e410f6206cee9f75cc156fba1e467cad8f16fdc/src%2Ftest%2Frun-pass%2Fintrinsic-alignment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e410f6206cee9f75cc156fba1e467cad8f16fdc/src%2Ftest%2Frun-pass%2Fintrinsic-alignment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fintrinsic-alignment.rs?ref=1e410f6206cee9f75cc156fba1e467cad8f16fdc", "patch": "@@ -1,19 +1,33 @@\n-// xfail-win32 need to investigate alignment on windows\n+// xfail-fast Does not work with main in a submodule\n \n #[abi = \"rust-intrinsic\"]\n native mod rusti {\n     fn pref_align_of<T>() -> uint;\n     fn min_align_of<T>() -> uint;\n }\n \n-#[cfg(target_arch = \"x86\")]\n-fn main() {\n-    assert rusti::pref_align_of::<u64>() == 8u;\n-    assert rusti::min_align_of::<u64>() == 4u;\n+#[cfg(target_os = \"linux\")]\n+#[cfg(target_os = \"macos\")]\n+#[cfg(target_os = \"freebsd\")]\n+mod m {\n+    #[cfg(target_arch = \"x86\")]\n+    fn main() {\n+        assert rusti::pref_align_of::<u64>() == 8u;\n+        assert rusti::min_align_of::<u64>() == 4u;\n+    }\n+\n+    #[cfg(target_arch = \"x86_64\")]\n+    fn main() {\n+        assert rusti::pref_align_of::<u64>() == 8u;\n+        assert rusti::min_align_of::<u64>() == 8u;\n+    }\n }\n \n-#[cfg(target_arch = \"x86_64\")]\n-fn main() {\n-    assert rusti::pref_align_of::<u64>() == 8u;\n-    assert rusti::min_align_of::<u64>() == 8u;\n+#[cfg(target_os = \"win32\")]\n+mod m {\n+    #[cfg(target_arch = \"x86\")]\n+    fn main() {\n+        assert rusti::pref_align_of::<u64>() == 8u;\n+        assert rusti::min_align_of::<u64>() == 8u;\n+    }\n }"}, {"sha": "89f3305bf79d23ca11ebc645aef40bab34238f81", "filename": "src/test/run-pass/rec-align-u32.rs", "status": "renamed", "additions": 16, "deletions": 8, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/1e410f6206cee9f75cc156fba1e467cad8f16fdc/src%2Ftest%2Frun-pass%2Frec-align-u32.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e410f6206cee9f75cc156fba1e467cad8f16fdc/src%2Ftest%2Frun-pass%2Frec-align-u32.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Frec-align-u32.rs?ref=1e410f6206cee9f75cc156fba1e467cad8f16fdc", "patch": "@@ -1,5 +1,4 @@\n // xfail-pretty\n-// xfail-win32\n // Issue #2303\n \n #[abi = \"rust-intrinsic\"]\n@@ -10,7 +9,7 @@ native mod rusti {\n \n // This is the type with the questionable alignment\n type inner = {\n-    c64: u64\n+    c64: u32\n };\n \n // This is the type that contains the type with the\n@@ -20,10 +19,22 @@ type outer = {\n     t: inner\n };\n \n+\n #[cfg(target_arch = \"x86\")]\n+mod m {\n+    fn align() -> uint { 4u }\n+    fn size() -> uint { 8u }\n+}\n+\n+#[cfg(target_arch = \"x86_64\")]\n+mod m {\n+    fn align() -> uint { 4u }\n+    fn size() -> uint { 8u }\n+}\n+\n fn main() {\n \n-    let x = {c8: 22u8, t: {c64: 44u64}};\n+    let x = {c8: 22u8, t: {c64: 44u32}};\n \n     // Send it through the shape code\n     let y = #fmt[\"%?\", x];\n@@ -33,14 +44,11 @@ fn main() {\n     #debug(\"y = %s\", y);\n \n     // per clang/gcc the alignment of `inner` is 4 on x86.\n-    assert rusti::min_align_of::<inner>() == 4u;\n+    assert rusti::min_align_of::<inner>() == m::align();\n \n     // per clang/gcc the size of `outer` should be 12\n     // because `inner`s alignment was 4.\n-    assert sys::size_of::<outer>() == 12u;\n+    assert sys::size_of::<outer>() == m::size();\n \n     assert y == \"(22, (44))\";\n }\n-\n-#[cfg(target_arch = \"x86_64\")]\n-fn main() { }", "previous_filename": "src/test/run-pass/rec-align-32-bit.rs"}, {"sha": "39646bb04e0a320c48a64f4e9cf3289f341acb50", "filename": "src/test/run-pass/rec-align-u64.rs", "status": "added", "additions": 68, "deletions": 0, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/1e410f6206cee9f75cc156fba1e467cad8f16fdc/src%2Ftest%2Frun-pass%2Frec-align-u64.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e410f6206cee9f75cc156fba1e467cad8f16fdc/src%2Ftest%2Frun-pass%2Frec-align-u64.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Frec-align-u64.rs?ref=1e410f6206cee9f75cc156fba1e467cad8f16fdc", "patch": "@@ -0,0 +1,68 @@\n+// xfail-pretty\n+// Issue #2303\n+\n+#[abi = \"rust-intrinsic\"]\n+native mod rusti {\n+    fn pref_align_of<T>() -> uint;\n+    fn min_align_of<T>() -> uint;\n+}\n+\n+// This is the type with the questionable alignment\n+type inner = {\n+    c64: u64\n+};\n+\n+// This is the type that contains the type with the\n+// questionable alignment, for testing\n+type outer = {\n+    c8: u8,\n+    t: inner\n+};\n+\n+\n+#[cfg(target_os = \"linux\")]\n+#[cfg(target_os = \"macos\")]\n+#[cfg(target_os = \"freebsd\")]\n+mod m {\n+    #[cfg(target_arch = \"x86\")]\n+    mod m {\n+        fn align() -> uint { 4u }\n+        fn size() -> uint { 12u }\n+    }\n+\n+    #[cfg(target_arch = \"x86_64\")]\n+    mod m {\n+        fn align() -> uint { 8u }\n+        fn size() -> uint { 16u }\n+    }\n+}\n+\n+#[cfg(target_os = \"win32\")]\n+mod m {\n+    #[cfg(target_arch = \"x86\")]\n+    mod m {\n+        fn align() -> uint { 8u }\n+        fn size() -> uint { 16u }\n+    }\n+}\n+\n+fn main() {\n+\n+    let x = {c8: 22u8, t: {c64: 44u64}};\n+\n+    // Send it through the shape code\n+    let y = #fmt[\"%?\", x];\n+\n+    #debug(\"align inner = %?\", rusti::min_align_of::<inner>());\n+    #debug(\"size outer = %?\", sys::size_of::<outer>());\n+    #debug(\"y = %s\", y);\n+\n+    // per clang/gcc the alignment of `inner` is 4 on x86.\n+    assert rusti::min_align_of::<inner>() == m::m::align();\n+\n+    // per clang/gcc the size of `outer` should be 12\n+    // because `inner`s alignment was 4.\n+    assert sys::size_of::<outer>() == m::m::size();\n+\n+    assert y == \"(22, (44))\";\n+}"}]}