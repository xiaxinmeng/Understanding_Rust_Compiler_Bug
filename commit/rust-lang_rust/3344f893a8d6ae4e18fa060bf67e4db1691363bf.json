{"sha": "3344f893a8d6ae4e18fa060bf67e4db1691363bf", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMzNDRmODkzYThkNmFlNGUxOGZhMDYwYmY2N2U0ZGIxNjkxMzYzYmY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-09-09T08:43:46Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-09-09T08:43:46Z"}, "message": "Auto merge of #36324 - nrc:save-docs, r=eddyb\n\nsave-analysis bits and pieces", "tree": {"sha": "6725f5247f26137918c5e55c60ff3916801c8cd5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6725f5247f26137918c5e55c60ff3916801c8cd5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3344f893a8d6ae4e18fa060bf67e4db1691363bf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3344f893a8d6ae4e18fa060bf67e4db1691363bf", "html_url": "https://github.com/rust-lang/rust/commit/3344f893a8d6ae4e18fa060bf67e4db1691363bf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3344f893a8d6ae4e18fa060bf67e4db1691363bf/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5440a1fae7da4309f8fd85420a8b6596a662c121", "url": "https://api.github.com/repos/rust-lang/rust/commits/5440a1fae7da4309f8fd85420a8b6596a662c121", "html_url": "https://github.com/rust-lang/rust/commit/5440a1fae7da4309f8fd85420a8b6596a662c121"}, {"sha": "b58294e3289cdaca6ef07c77777e4787cad285ad", "url": "https://api.github.com/repos/rust-lang/rust/commits/b58294e3289cdaca6ef07c77777e4787cad285ad", "html_url": "https://github.com/rust-lang/rust/commit/b58294e3289cdaca6ef07c77777e4787cad285ad"}], "stats": {"total": 158, "additions": 139, "deletions": 19}, "files": [{"sha": "5f6e65e289fd5d266c92d2df29d23eea0b2e5a87", "filename": "src/librustc_save_analysis/data.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/3344f893a8d6ae4e18fa060bf67e4db1691363bf/src%2Flibrustc_save_analysis%2Fdata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3344f893a8d6ae4e18fa060bf67e4db1691363bf/src%2Flibrustc_save_analysis%2Fdata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fdata.rs?ref=3344f893a8d6ae4e18fa060bf67e4db1691363bf", "patch": "@@ -134,6 +134,7 @@ pub struct EnumData {\n     pub scope: NodeId,\n     pub variants: Vec<NodeId>,\n     pub visibility: Visibility,\n+    pub docs: String,\n }\n \n /// Data for extern crates.\n@@ -167,6 +168,7 @@ pub struct FunctionData {\n     pub value: String,\n     pub visibility: Visibility,\n     pub parent: Option<NodeId>,\n+    pub docs: String,\n }\n \n /// Data about a function call.\n@@ -213,6 +215,7 @@ pub struct MacroData {\n     pub span: Span,\n     pub name: String,\n     pub qualname: String,\n+    pub docs: String,\n }\n \n /// Data about a macro use.\n@@ -248,6 +251,7 @@ pub struct MethodData {\n     pub value: String,\n     pub decl_id: Option<DefId>,\n     pub visibility: Visibility,\n+    pub docs: String,\n }\n \n /// Data for modules.\n@@ -261,6 +265,7 @@ pub struct ModData {\n     pub filename: String,\n     pub items: Vec<NodeId>,\n     pub visibility: Visibility,\n+    pub docs: String,\n }\n \n /// Data for a reference to a module.\n@@ -283,6 +288,7 @@ pub struct StructData {\n     pub value: String,\n     pub fields: Vec<NodeId>,\n     pub visibility: Visibility,\n+    pub docs: String,\n }\n \n #[derive(Debug, RustcEncodable)]\n@@ -295,6 +301,7 @@ pub struct StructVariantData {\n     pub value: String,\n     pub scope: NodeId,\n     pub parent: Option<NodeId>,\n+    pub docs: String,\n }\n \n #[derive(Debug, RustcEncodable)]\n@@ -307,6 +314,7 @@ pub struct TraitData {\n     pub value: String,\n     pub items: Vec<NodeId>,\n     pub visibility: Visibility,\n+    pub docs: String,\n }\n \n #[derive(Debug, RustcEncodable)]\n@@ -319,6 +327,7 @@ pub struct TupleVariantData {\n     pub value: String,\n     pub scope: NodeId,\n     pub parent: Option<NodeId>,\n+    pub docs: String,\n }\n \n /// Data for a typedef.\n@@ -331,6 +340,7 @@ pub struct TypeDefData {\n     pub value: String,\n     pub visibility: Visibility,\n     pub parent: Option<NodeId>,\n+    pub docs: String,\n }\n \n /// Data for a reference to a type or trait.\n@@ -374,6 +384,7 @@ pub struct VariableData {\n     pub value: String,\n     pub type_value: String,\n     pub visibility: Visibility,\n+    pub docs: String,\n }\n \n #[derive(Debug, RustcEncodable)]"}, {"sha": "d8e2324559c55d6ff44ea734d9b27ee5e73c6c59", "filename": "src/librustc_save_analysis/dump_visitor.rs", "status": "modified", "additions": 32, "deletions": 9, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/3344f893a8d6ae4e18fa060bf67e4db1691363bf/src%2Flibrustc_save_analysis%2Fdump_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3344f893a8d6ae4e18fa060bf67e4db1691363bf/src%2Flibrustc_save_analysis%2Fdump_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fdump_visitor.rs?ref=3344f893a8d6ae4e18fa060bf67e4db1691363bf", "patch": "@@ -36,15 +36,15 @@ use rustc::ty::{self, TyCtxt, ImplOrTraitItem, ImplOrTraitItemContainer};\n use std::collections::HashSet;\n use std::hash::*;\n \n-use syntax::ast::{self, NodeId, PatKind};\n+use syntax::ast::{self, NodeId, PatKind, Attribute};\n use syntax::parse::token::{self, keywords};\n use syntax::visit::{self, Visitor};\n use syntax::print::pprust::{path_to_string, ty_to_string, bounds_to_string, generics_to_string};\n use syntax::ptr::P;\n use syntax::codemap::Spanned;\n use syntax_pos::*;\n \n-use super::{escape, generated_code, SaveContext, PathCollector};\n+use super::{escape, generated_code, SaveContext, PathCollector, docs_for_attrs};\n use super::data::*;\n use super::dump::Dump;\n use super::external_data::Lower;\n@@ -368,6 +368,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                         scope: 0,\n                         parent: None,\n                         visibility: Visibility::Inherited,\n+                        docs: String::new(),\n                     }.lower(self.tcx));\n                 }\n             }\n@@ -380,6 +381,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                       id: ast::NodeId,\n                       name: ast::Name,\n                       vis: Visibility,\n+                      attrs: &[Attribute],\n                       span: Span) {\n         debug!(\"process_method: {}:{}\", id, name);\n \n@@ -421,6 +423,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                     value: sig_str,\n                     decl_id: decl_id,\n                     visibility: vis,\n+                    docs: docs_for_attrs(attrs),\n                 }.lower(self.tcx));\n             }\n \n@@ -491,6 +494,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                     value: String::new(),\n                     visibility: Visibility::Inherited,\n                     parent: None,\n+                    docs: String::new(),\n                 }.lower(self.tcx));\n             }\n         }\n@@ -541,7 +545,8 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                            typ: &ast::Ty,\n                            expr: &ast::Expr,\n                            parent_id: NodeId,\n-                           vis: Visibility) {\n+                           vis: Visibility,\n+                           attrs: &[Attribute]) {\n         let qualname = format!(\"::{}\", self.tcx.node_path_str(id));\n \n         let sub_span = self.span.sub_span_after_keyword(span, keywords::Const);\n@@ -558,6 +563,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                 scope: self.cur_scope,\n                 parent: Some(parent_id),\n                 visibility: vis,\n+                docs: docs_for_attrs(attrs),\n             }.lower(self.tcx));\n         }\n \n@@ -600,6 +606,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                 value: val,\n                 fields: fields,\n                 visibility: From::from(&item.vis),\n+                docs: docs_for_attrs(&item.attrs),\n             }.lower(self.tcx));\n         }\n \n@@ -653,6 +660,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                             value: val,\n                             scope: enum_data.scope,\n                             parent: Some(item.id),\n+                            docs: docs_for_attrs(&variant.node.attrs),\n                         }.lower(self.tcx));\n                     }\n                 }\n@@ -677,6 +685,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                             value: val,\n                             scope: enum_data.scope,\n                             parent: Some(item.id),\n+                            docs: docs_for_attrs(&variant.node.attrs),\n                         }.lower(self.tcx));\n                     }\n                 }\n@@ -759,6 +768,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                 value: val,\n                 items: methods.iter().map(|i| i.id).collect(),\n                 visibility: From::from(&item.vis),\n+                docs: docs_for_attrs(&item.attrs),\n             }.lower(self.tcx));\n         }\n \n@@ -1015,6 +1025,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                     scope: 0,\n                     parent: None,\n                     visibility: Visibility::Inherited,\n+                    docs: String::new(),\n                 }.lower(self.tcx));\n             }\n         }\n@@ -1044,7 +1055,9 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                 self.dumper.macro_data(MacroData {\n                     span: sub_span,\n                     name: data.name.clone(),\n-                    qualname: qualname.clone()\n+                    qualname: qualname.clone(),\n+                    // FIXME where do macro docs come from?\n+                    docs: String::new(),\n                 }.lower(self.tcx));\n             }\n         }\n@@ -1057,7 +1070,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                     qualname: qualname,\n                     scope: data.scope,\n                     callee_span: data.callee_span,\n-                    imported: data.imported\n+                    imported: data.imported,\n                 }.lower(self.tcx));\n             }\n         }\n@@ -1073,14 +1086,16 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                                          &ty,\n                                          &expr,\n                                          trait_id,\n-                                         Visibility::Public);\n+                                         Visibility::Public,\n+                                         &trait_item.attrs);\n             }\n             ast::TraitItemKind::Method(ref sig, ref body) => {\n                 self.process_method(sig,\n                                     body.as_ref().map(|x| &**x),\n                                     trait_item.id,\n                                     trait_item.ident.name,\n                                     Visibility::Public,\n+                                    &trait_item.attrs,\n                                     trait_item.span);\n             }\n             ast::TraitItemKind::Const(_, None) |\n@@ -1099,14 +1114,16 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                                          &ty,\n                                          &expr,\n                                          impl_id,\n-                                         From::from(&impl_item.vis));\n+                                         From::from(&impl_item.vis),\n+                                         &impl_item.attrs);\n             }\n             ast::ImplItemKind::Method(ref sig, ref body) => {\n                 self.process_method(sig,\n                                     Some(body),\n                                     impl_item.id,\n                                     impl_item.ident.name,\n                                     From::from(&impl_item.vis),\n+                                    &impl_item.attrs,\n                                     impl_item.span);\n             }\n             ast::ImplItemKind::Type(_) |\n@@ -1248,6 +1265,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump +'ll> Visitor for DumpVisitor<'l, 'tcx, 'll, D>\n                         value: value,\n                         visibility: From::from(&item.vis),\n                         parent: None,\n+                        docs: docs_for_attrs(&item.attrs),\n                     }.lower(self.tcx));\n                 }\n \n@@ -1417,11 +1435,15 @@ impl<'l, 'tcx: 'l, 'll, D: Dump +'ll> Visitor for DumpVisitor<'l, 'tcx, 'll, D>\n         for &(id, ref p, immut, ref_kind) in &collector.collected_paths {\n             match self.tcx.expect_def(id) {\n                 Def::Local(_, id) => {\n-                    let value = if immut == ast::Mutability::Immutable {\n+                    let mut value = if immut == ast::Mutability::Immutable {\n                         self.span.snippet(p.span).to_string()\n                     } else {\n                         \"<mutable>\".to_string()\n                     };\n+                    let typ = self.tcx.node_types()\n+                                  .get(&id).map(|t| t.to_string()).unwrap_or(String::new());\n+                    value.push_str(\": \");\n+                    value.push_str(&typ);\n \n                     assert!(p.segments.len() == 1,\n                             \"qualified path for local variable def in arm\");\n@@ -1433,10 +1455,11 @@ impl<'l, 'tcx: 'l, 'll, D: Dump +'ll> Visitor for DumpVisitor<'l, 'tcx, 'll, D>\n                             name: path_to_string(p),\n                             qualname: format!(\"{}${}\", path_to_string(p), id),\n                             value: value,\n-                            type_value: String::new(),\n+                            type_value: typ,\n                             scope: 0,\n                             parent: None,\n                             visibility: Visibility::Inherited,\n+                            docs: String::new(),\n                         }.lower(self.tcx));\n                     }\n                 }"}, {"sha": "3642346582bb9877e1d8be15d83fa9686ed1046c", "filename": "src/librustc_save_analysis/external_data.rs", "status": "modified", "additions": 23, "deletions": 1, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/3344f893a8d6ae4e18fa060bf67e4db1691363bf/src%2Flibrustc_save_analysis%2Fexternal_data.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3344f893a8d6ae4e18fa060bf67e4db1691363bf/src%2Flibrustc_save_analysis%2Fexternal_data.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fexternal_data.rs?ref=3344f893a8d6ae4e18fa060bf67e4db1691363bf", "patch": "@@ -93,6 +93,7 @@ pub struct EnumData {\n     pub scope: DefId,\n     pub variants: Vec<DefId>,\n     pub visibility: Visibility,\n+    pub docs: String,\n }\n \n impl Lower for data::EnumData {\n@@ -108,6 +109,7 @@ impl Lower for data::EnumData {\n             scope: make_def_id(self.scope, &tcx.map),\n             variants: self.variants.into_iter().map(|id| make_def_id(id, &tcx.map)).collect(),\n             visibility: self.visibility,\n+            docs: self.docs,\n         }\n     }\n }\n@@ -170,6 +172,7 @@ pub struct FunctionData {\n     pub value: String,\n     pub visibility: Visibility,\n     pub parent: Option<DefId>,\n+    pub docs: String,\n }\n \n impl Lower for data::FunctionData {\n@@ -186,6 +189,7 @@ impl Lower for data::FunctionData {\n             value: self.value,\n             visibility: self.visibility,\n             parent: self.parent.map(|id| make_def_id(id, &tcx.map)),\n+            docs: self.docs,\n         }\n     }\n }\n@@ -257,6 +261,7 @@ pub struct MacroData {\n     pub span: SpanData,\n     pub name: String,\n     pub qualname: String,\n+    pub docs: String,\n }\n \n impl Lower for data::MacroData {\n@@ -267,6 +272,7 @@ impl Lower for data::MacroData {\n             span: SpanData::from_span(self.span, tcx.sess.codemap()),\n             name: self.name,\n             qualname: self.qualname,\n+            docs: self.docs,\n         }\n     }\n }\n@@ -330,7 +336,8 @@ pub struct MethodData {\n     pub value: String,\n     pub decl_id: Option<DefId>,\n     pub visibility: Visibility,\n-    pub parent: Option<DefId>\n+    pub parent: Option<DefId>,\n+    pub docs: String,\n }\n \n impl Lower for data::MethodData {\n@@ -347,6 +354,7 @@ impl Lower for data::MethodData {\n             decl_id: self.decl_id,\n             visibility: self.visibility,\n             parent: Some(make_def_id(self.scope, &tcx.map)),\n+            docs: self.docs,\n         }\n     }\n }\n@@ -362,6 +370,7 @@ pub struct ModData {\n     pub filename: String,\n     pub items: Vec<DefId>,\n     pub visibility: Visibility,\n+    pub docs: String,\n }\n \n impl Lower for data::ModData {\n@@ -377,6 +386,7 @@ impl Lower for data::ModData {\n             filename: self.filename,\n             items: self.items.into_iter().map(|id| make_def_id(id, &tcx.map)).collect(),\n             visibility: self.visibility,\n+            docs: self.docs,\n         }\n     }\n }\n@@ -414,6 +424,7 @@ pub struct StructData {\n     pub value: String,\n     pub fields: Vec<DefId>,\n     pub visibility: Visibility,\n+    pub docs: String,\n }\n \n impl Lower for data::StructData {\n@@ -430,6 +441,7 @@ impl Lower for data::StructData {\n             value: self.value,\n             fields: self.fields.into_iter().map(|id| make_def_id(id, &tcx.map)).collect(),\n             visibility: self.visibility,\n+            docs: self.docs,\n         }\n     }\n }\n@@ -444,6 +456,7 @@ pub struct StructVariantData {\n     pub value: String,\n     pub scope: DefId,\n     pub parent: Option<DefId>,\n+    pub docs: String,\n }\n \n impl Lower for data::StructVariantData {\n@@ -459,6 +472,7 @@ impl Lower for data::StructVariantData {\n             value: self.value,\n             scope: make_def_id(self.scope, &tcx.map),\n             parent: self.parent.map(|id| make_def_id(id, &tcx.map)),\n+            docs: self.docs,\n         }\n     }\n }\n@@ -473,6 +487,7 @@ pub struct TraitData {\n     pub value: String,\n     pub items: Vec<DefId>,\n     pub visibility: Visibility,\n+    pub docs: String,\n }\n \n impl Lower for data::TraitData {\n@@ -488,6 +503,7 @@ impl Lower for data::TraitData {\n             value: self.value,\n             items: self.items.into_iter().map(|id| make_def_id(id, &tcx.map)).collect(),\n             visibility: self.visibility,\n+            docs: self.docs,\n         }\n     }\n }\n@@ -502,6 +518,7 @@ pub struct TupleVariantData {\n     pub value: String,\n     pub scope: DefId,\n     pub parent: Option<DefId>,\n+    pub docs: String,\n }\n \n impl Lower for data::TupleVariantData {\n@@ -517,6 +534,7 @@ impl Lower for data::TupleVariantData {\n             value: self.value,\n             scope: make_def_id(self.scope, &tcx.map),\n             parent: self.parent.map(|id| make_def_id(id, &tcx.map)),\n+            docs: self.docs,\n         }\n     }\n }\n@@ -531,6 +549,7 @@ pub struct TypeDefData {\n     pub value: String,\n     pub visibility: Visibility,\n     pub parent: Option<DefId>,\n+    pub docs: String,\n }\n \n impl Lower for data::TypeDefData {\n@@ -545,6 +564,7 @@ impl Lower for data::TypeDefData {\n             value: self.value,\n             visibility: self.visibility,\n             parent: self.parent.map(|id| make_def_id(id, &tcx.map)),\n+            docs: self.docs,\n         }\n     }\n }\n@@ -632,6 +652,7 @@ pub struct VariableData {\n     pub type_value: String,\n     pub parent: Option<DefId>,\n     pub visibility: Visibility,\n+    pub docs: String,\n }\n \n impl Lower for data::VariableData {\n@@ -649,6 +670,7 @@ impl Lower for data::VariableData {\n             type_value: self.type_value,\n             parent: self.parent.map(|id| make_def_id(id, &tcx.map)),\n             visibility: self.visibility,\n+            docs: self.docs,\n         }\n     }\n }"}, {"sha": "78eaa65872a4c0b42e6c3b5509bf43048bd87c02", "filename": "src/librustc_save_analysis/json_api_dumper.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/3344f893a8d6ae4e18fa060bf67e4db1691363bf/src%2Flibrustc_save_analysis%2Fjson_api_dumper.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3344f893a8d6ae4e18fa060bf67e4db1691363bf/src%2Flibrustc_save_analysis%2Fjson_api_dumper.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fjson_api_dumper.rs?ref=3344f893a8d6ae4e18fa060bf67e4db1691363bf", "patch": "@@ -16,6 +16,8 @@ use rustc_serialize::json::as_json;\n use external_data::*;\n use data::{VariableKind, Visibility};\n use dump::Dump;\n+use super::Format;\n+\n \n // A dumper to dump a restricted set of JSON information, designed for use with\n // libraries distributed without their source. Clients are likely to use type\n@@ -81,17 +83,25 @@ impl<'b, W: Write + 'b> Dump for JsonApiDumper<'b, W> {\n \n #[derive(Debug, RustcEncodable)]\n struct Analysis {\n+    kind: Format,\n     prelude: Option<CratePreludeData>,\n     imports: Vec<Import>,\n     defs: Vec<Def>,\n+    // These two fields are dummies so that clients can parse the two kinds of\n+    // JSON data in the same way.\n+    refs: Vec<()>,\n+    macro_refs: Vec<()>,\n }\n \n impl Analysis {\n     fn new() -> Analysis {\n         Analysis {\n+            kind: Format::JsonApi,\n             prelude: None,\n             imports: vec![],\n             defs: vec![],\n+            refs: vec![],\n+            macro_refs: vec![],\n         }\n     }\n }\n@@ -168,6 +178,7 @@ struct Def {\n     parent: Option<Id>,\n     children: Vec<Id>,\n     decl_id: Option<Id>,\n+    docs: String,\n }\n \n #[derive(Debug, RustcEncodable)]\n@@ -209,6 +220,7 @@ impl From<EnumData> for Option<Def> {\n                 parent: None,\n                 children: data.variants.into_iter().map(|id| From::from(id)).collect(),\n                 decl_id: None,\n+                docs: data.docs,\n             }),\n             _ => None,\n         }\n@@ -227,6 +239,7 @@ impl From<TupleVariantData> for Option<Def> {\n             parent: data.parent.map(|id| From::from(id)),\n             children: vec![],\n             decl_id: None,\n+            docs: data.docs,\n         })\n     }\n }\n@@ -242,6 +255,7 @@ impl From<StructVariantData> for Option<Def> {\n             parent: data.parent.map(|id| From::from(id)),\n             children: vec![],\n             decl_id: None,\n+            docs: data.docs,\n         })\n     }\n }\n@@ -258,6 +272,7 @@ impl From<StructData> for Option<Def> {\n             parent: None,\n             children: data.fields.into_iter().map(|id| From::from(id)).collect(),\n             decl_id: None,\n+            docs: data.docs,\n         }),\n             _ => None,\n         }\n@@ -276,6 +291,7 @@ impl From<TraitData> for Option<Def> {\n                 children: data.items.into_iter().map(|id| From::from(id)).collect(),\n                 parent: None,\n                 decl_id: None,\n+                docs: data.docs,\n             }),\n             _ => None,\n         }\n@@ -294,6 +310,7 @@ impl From<FunctionData> for Option<Def> {\n                 children: vec![],\n                 parent: data.parent.map(|id| From::from(id)),\n                 decl_id: None,\n+                docs: data.docs,\n             }),\n             _ => None,\n         }\n@@ -312,6 +329,7 @@ impl From<MethodData> for Option<Def> {\n                 children: vec![],\n                 parent: data.parent.map(|id| From::from(id)),\n                 decl_id: data.decl_id.map(|id| From::from(id)),\n+                docs: data.docs,\n             }),\n             _ => None,\n         }\n@@ -329,6 +347,7 @@ impl From<MacroData> for Option<Def> {\n             children: vec![],\n             parent: None,\n             decl_id: None,\n+            docs: data.docs,\n         })\n     }\n }\n@@ -345,6 +364,7 @@ impl From<ModData> for Option<Def> {\n                 children: data.items.into_iter().map(|id| From::from(id)).collect(),\n                 parent: None,\n                 decl_id: None,\n+                docs: data.docs,\n             }),\n             _ => None,\n         }\n@@ -363,6 +383,7 @@ impl From<TypeDefData> for Option<Def> {\n                 children: vec![],\n                 parent: data.parent.map(|id| From::from(id)),\n                 decl_id: None,\n+                docs: String::new(),\n             }),\n             _ => None,\n         }\n@@ -386,6 +407,7 @@ impl From<VariableData> for Option<Def> {\n                 children: vec![],\n                 parent: data.parent.map(|id| From::from(id)),\n                 decl_id: None,\n+                docs: data.docs,\n             }),\n             _ => None,\n         }"}, {"sha": "75abff8d37edb9160bc3c4d55fdd0ebe266a6f61", "filename": "src/librustc_save_analysis/json_dumper.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/3344f893a8d6ae4e18fa060bf67e4db1691363bf/src%2Flibrustc_save_analysis%2Fjson_dumper.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3344f893a8d6ae4e18fa060bf67e4db1691363bf/src%2Flibrustc_save_analysis%2Fjson_dumper.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fjson_dumper.rs?ref=3344f893a8d6ae4e18fa060bf67e4db1691363bf", "patch": "@@ -16,6 +16,7 @@ use rustc_serialize::json::as_json;\n use external_data::*;\n use data::VariableKind;\n use dump::Dump;\n+use super::Format;\n \n pub struct JsonDumper<'b, W: Write + 'b> {\n     output: &'b mut W,\n@@ -87,6 +88,7 @@ impl<'b, W: Write + 'b> Dump for JsonDumper<'b, W> {\n \n #[derive(Debug, RustcEncodable)]\n struct Analysis {\n+    kind: Format,\n     prelude: Option<CratePreludeData>,\n     imports: Vec<Import>,\n     defs: Vec<Def>,\n@@ -97,6 +99,7 @@ struct Analysis {\n impl Analysis {\n     fn new() -> Analysis {\n         Analysis {\n+            kind: Format::Json,\n             prelude: None,\n             imports: vec![],\n             defs: vec![],\n@@ -183,6 +186,7 @@ struct Def {\n     value: String,\n     children: Vec<Id>,\n     decl_id: Option<Id>,\n+    docs: String,\n }\n \n #[derive(Debug, RustcEncodable)]\n@@ -223,6 +227,7 @@ impl From<EnumData> for Def {\n             value: data.value,\n             children: data.variants.into_iter().map(|id| From::from(id)).collect(),\n             decl_id: None,\n+            docs: data.docs,\n         }\n     }\n }\n@@ -238,6 +243,7 @@ impl From<TupleVariantData> for Def {\n             value: data.value,\n             children: vec![],\n             decl_id: None,\n+            docs: data.docs,\n         }\n     }\n }\n@@ -252,6 +258,7 @@ impl From<StructVariantData> for Def {\n             value: data.value,\n             children: vec![],\n             decl_id: None,\n+            docs: data.docs,\n         }\n     }\n }\n@@ -266,6 +273,7 @@ impl From<StructData> for Def {\n             value: data.value,\n             children: data.fields.into_iter().map(|id| From::from(id)).collect(),\n             decl_id: None,\n+            docs: data.docs,\n         }\n     }\n }\n@@ -280,6 +288,7 @@ impl From<TraitData> for Def {\n             value: data.value,\n             children: data.items.into_iter().map(|id| From::from(id)).collect(),\n             decl_id: None,\n+            docs: data.docs,\n         }\n     }\n }\n@@ -294,6 +303,7 @@ impl From<FunctionData> for Def {\n             value: data.value,\n             children: vec![],\n             decl_id: None,\n+            docs: data.docs,\n         }\n     }\n }\n@@ -308,6 +318,7 @@ impl From<MethodData> for Def {\n             value: data.value,\n             children: vec![],\n             decl_id: data.decl_id.map(|id| From::from(id)),\n+            docs: data.docs,\n         }\n     }\n }\n@@ -322,6 +333,7 @@ impl From<MacroData> for Def {\n             value: String::new(),\n             children: vec![],\n             decl_id: None,\n+            docs: data.docs,\n         }\n     }\n }\n@@ -336,6 +348,7 @@ impl From<ModData> for Def {\n             value: data.filename,\n             children: data.items.into_iter().map(|id| From::from(id)).collect(),\n             decl_id: None,\n+            docs: data.docs,\n         }\n     }\n }\n@@ -350,6 +363,7 @@ impl From<TypeDefData> for Def {\n             value: data.value,\n             children: vec![],\n             decl_id: None,\n+            docs: String::new(),\n         }\n     }\n }\n@@ -366,9 +380,10 @@ impl From<VariableData> for Def {\n             span: data.span,\n             name: data.name,\n             qualname: data.qualname,\n-            value: data.value,\n+            value: data.type_value,\n             children: vec![],\n             decl_id: None,\n+            docs: data.docs,\n         }\n     }\n }"}, {"sha": "354709ac9e1d5a12751d957e4980b2e7549a3384", "filename": "src/librustc_save_analysis/lib.rs", "status": "modified", "additions": 35, "deletions": 8, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/3344f893a8d6ae4e18fa060bf67e4db1691363bf/src%2Flibrustc_save_analysis%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3344f893a8d6ae4e18fa060bf67e4db1691363bf/src%2Flibrustc_save_analysis%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Flib.rs?ref=3344f893a8d6ae4e18fa060bf67e4db1691363bf", "patch": "@@ -30,6 +30,7 @@\n extern crate serialize as rustc_serialize;\n extern crate syntax_pos;\n \n+\n mod csv_dumper;\n mod json_api_dumper;\n mod json_dumper;\n@@ -51,8 +52,9 @@ use std::env;\n use std::fs::{self, File};\n use std::path::{Path, PathBuf};\n \n-use syntax::ast::{self, NodeId, PatKind};\n-use syntax::parse::token::{self, keywords};\n+use syntax::ast::{self, NodeId, PatKind, Attribute};\n+use syntax::parse::lexer::comments::strip_doc_comment_decoration;\n+use syntax::parse::token::{self, keywords, InternedString};\n use syntax::visit::{self, Visitor};\n use syntax::print::pprust::{ty_to_string, arg_to_string};\n use syntax::codemap::MacroAttribute;\n@@ -143,6 +145,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n                     value: make_signature(decl, generics),\n                     visibility: From::from(&item.vis),\n                     parent: None,\n+                    docs: docs_for_attrs(&item.attrs),\n                 }))\n             }\n             ast::ItemKind::Static(ref typ, mt, ref expr) => {\n@@ -169,6 +172,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n                     value: value,\n                     type_value: ty_to_string(&typ),\n                     visibility: From::from(&item.vis),\n+                    docs: docs_for_attrs(&item.attrs),\n                 }))\n             }\n             ast::ItemKind::Const(ref typ, ref expr) => {\n@@ -186,6 +190,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n                     value: self.span_utils.snippet(expr.span),\n                     type_value: ty_to_string(&typ),\n                     visibility: From::from(&item.vis),\n+                    docs: docs_for_attrs(&item.attrs),\n                 }))\n             }\n             ast::ItemKind::Mod(ref m) => {\n@@ -205,6 +210,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n                     filename: filename,\n                     items: m.items.iter().map(|i| i.id).collect(),\n                     visibility: From::from(&item.vis),\n+                    docs: docs_for_attrs(&item.attrs),\n                 }))\n             }\n             ast::ItemKind::Enum(ref def, _) => {\n@@ -226,6 +232,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n                     scope: self.enclosing_scope(item.id),\n                     variants: def.variants.iter().map(|v| v.node.data.id()).collect(),\n                     visibility: From::from(&item.vis),\n+                    docs: docs_for_attrs(&item.attrs),\n                 }))\n             }\n             ast::ItemKind::Impl(.., ref trait_ref, ref typ, _) => {\n@@ -292,6 +299,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n                 value: \"\".to_owned(),\n                 type_value: typ,\n                 visibility: From::from(&field.vis),\n+                docs: docs_for_attrs(&field.attrs),\n             })\n         } else {\n             None\n@@ -304,7 +312,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n                            name: ast::Name, span: Span) -> Option<FunctionData> {\n         // The qualname for a method is the trait name or name of the struct in an impl in\n         // which the method is declared in, followed by the method's name.\n-        let (qualname, vis) = match self.tcx.impl_of_method(self.tcx.map.local_def_id(id)) {\n+        let (qualname, vis, docs) = match self.tcx.impl_of_method(self.tcx.map.local_def_id(id)) {\n             Some(impl_id) => match self.tcx.map.get_if_local(impl_id) {\n                 Some(NodeItem(item)) => {\n                     match item.node {\n@@ -317,7 +325,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n                                 result.push_str(&self.tcx.item_path_str(def_id));\n                             }\n                             result.push_str(\">\");\n-                            (result, From::from(&item.vis))\n+                            (result, From::from(&item.vis), docs_for_attrs(&item.attrs))\n                         }\n                         _ => {\n                             span_bug!(span,\n@@ -339,7 +347,9 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n                 Some(def_id) => {\n                     match self.tcx.map.get_if_local(def_id) {\n                         Some(NodeItem(item)) => {\n-                            (format!(\"::{}\", self.tcx.item_path_str(def_id)), From::from(&item.vis))\n+                            (format!(\"::{}\", self.tcx.item_path_str(def_id)),\n+                             From::from(&item.vis),\n+                             docs_for_attrs(&item.attrs))\n                         }\n                         r => {\n                             span_bug!(span,\n@@ -383,6 +393,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n             value: String::new(),\n             visibility: vis,\n             parent: Some(parent_scope),\n+            docs: docs,\n         })\n     }\n \n@@ -667,7 +678,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n }\n \n fn make_signature(decl: &ast::FnDecl, generics: &ast::Generics) -> String {\n-    let mut sig = String::new();\n+    let mut sig = \"fn \".to_owned();\n     if !generics.lifetimes.is_empty() || !generics.ty_params.is_empty() {\n         sig.push('<');\n         sig.push_str(&generics.lifetimes.iter()\n@@ -687,7 +698,7 @@ fn make_signature(decl: &ast::FnDecl, generics: &ast::Generics) -> String {\n     sig.push_str(&decl.inputs.iter().map(arg_to_string).collect::<Vec<_>>().join(\", \"));\n     sig.push(')');\n     match decl.output {\n-        ast::FunctionRetTy::Default(_) => {}\n+        ast::FunctionRetTy::Default(_) => sig.push_str(\" -> ()\"),\n         ast::FunctionRetTy::Ty(ref t) => sig.push_str(&format!(\" -> {}\", ty_to_string(t))),\n     }\n \n@@ -740,7 +751,23 @@ impl Visitor for PathCollector {\n     }\n }\n \n-#[derive(Clone, Copy, Debug)]\n+fn docs_for_attrs(attrs: &[Attribute]) -> String {\n+    let doc = InternedString::new(\"doc\");\n+    let mut result = String::new();\n+\n+    for attr in attrs {\n+        if attr.name() == doc {\n+            if let Some(ref val) = attr.value_str() {\n+                result.push_str(&strip_doc_comment_decoration(val));\n+                result.push('\\n');\n+            }\n+        }\n+    }\n+\n+    result\n+}\n+\n+#[derive(Clone, Copy, Debug, RustcEncodable)]\n pub enum Format {\n     Csv,\n     Json,"}]}