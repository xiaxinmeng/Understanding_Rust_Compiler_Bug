{"sha": "24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f", "node_id": "C_kwDOAAsO6NoAKDI0ZmE4MGRiYjIwNjlmYjYyZjU1Yjk1ZmY4M2JkNGFlMjljMzVmNmY", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-04-09T10:52:04Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-04-09T10:52:04Z"}, "message": "Rollup merge of #95769 - fmease:fix-issue-95717, r=GuillaumeGomez\n\nHide cross-crate `#[doc(hidden)]` associated items in trait impls\n\nFixes #95717.\n\nr? ```@GuillaumeGomez```\nThis is the bug I ran into in #95316.\n\n```@rustbot``` label T-rustdoc A-cross-crate-reexports", "tree": {"sha": "64f942ace4e4c45a877ff7148543920825e571b8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/64f942ace4e4c45a877ff7148543920825e571b8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiUWVUCRBK7hj4Ov3rIwAALN0IAEW45cV/TXhZGyglw5SzyGMv\n57ggXO5agVB6nnX0P3uJ4qcZ2YMWHAVtDgTX0uVhjlohUE2MqWKc/VBPu664Vwv7\n6/gtMTzUcuQDtVe25scYBnajvwJoIjhw7T+XXvcdnsDe/LFsdLPvI09OZ8/NVoEl\nCDkm368vTzNOG94Iyn/6ogcgq+jjE6rzEZBTTBma6Xv0HAwFjIhHix3HRMhKfolV\ntbwN5odcVZXU6s48FOmji5Gh5uJG2+sZv64tDFLAKJwjv2Nbf5wv5+kd0kXSmHDw\nIUE3vbfrAvC97u/WwC7uTdINslyZfWfrhfPEJLdXmU953YEPB6jPIOORUnZasMM=\n=orAc\n-----END PGP SIGNATURE-----\n", "payload": "tree 64f942ace4e4c45a877ff7148543920825e571b8\nparent 0aaeb4dd1bd2c4ca844ccced8219d1fd269061e6\nparent 4623d51573b22c95ec25c2041aa43221a9e61597\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1649501524 +0200\ncommitter GitHub <noreply@github.com> 1649501524 +0200\n\nRollup merge of #95769 - fmease:fix-issue-95717, r=GuillaumeGomez\n\nHide cross-crate `#[doc(hidden)]` associated items in trait impls\n\nFixes #95717.\n\nr? ```@GuillaumeGomez```\nThis is the bug I ran into in #95316.\n\n```@rustbot``` label T-rustdoc A-cross-crate-reexports\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f", "html_url": "https://github.com/rust-lang/rust/commit/24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0aaeb4dd1bd2c4ca844ccced8219d1fd269061e6", "url": "https://api.github.com/repos/rust-lang/rust/commits/0aaeb4dd1bd2c4ca844ccced8219d1fd269061e6", "html_url": "https://github.com/rust-lang/rust/commit/0aaeb4dd1bd2c4ca844ccced8219d1fd269061e6"}, {"sha": "4623d51573b22c95ec25c2041aa43221a9e61597", "url": "https://api.github.com/repos/rust-lang/rust/commits/4623d51573b22c95ec25c2041aa43221a9e61597", "html_url": "https://github.com/rust-lang/rust/commit/4623d51573b22c95ec25c2041aa43221a9e61597"}], "stats": {"total": 63, "additions": 59, "deletions": 4}, "files": [{"sha": "d06e4fa1cc2f57cefef059ac9f2a1675fe3cc2c3", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 17, "deletions": 4, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f", "patch": "@@ -425,13 +425,26 @@ crate fn build_impl(\n         None => (\n             tcx.associated_items(did)\n                 .in_definition_order()\n-                .filter_map(|item| {\n-                    if associated_trait.is_some() || item.vis.is_public() {\n-                        Some(item.clean(cx))\n+                .filter(|item| {\n+                    // If this is a trait impl, filter out associated items whose corresponding item\n+                    // in the associated trait is marked `doc(hidden)`.\n+                    // If this is an inherent impl, filter out private associated items.\n+                    if let Some(associated_trait) = associated_trait {\n+                        let trait_item = tcx\n+                            .associated_items(associated_trait.def_id)\n+                            .find_by_name_and_kind(\n+                                tcx,\n+                                item.ident(tcx),\n+                                item.kind,\n+                                associated_trait.def_id,\n+                            )\n+                            .unwrap(); // corresponding associated item has to exist\n+                        !tcx.is_doc_hidden(trait_item.def_id)\n                     } else {\n-                        None\n+                        item.vis.is_public()\n                     }\n                 })\n+                .map(|item| item.clean(cx))\n                 .collect::<Vec<_>>(),\n             clean::enter_impl_trait(cx, |cx| {\n                 clean_ty_generics(cx, tcx.generics_of(did), predicates)"}, {"sha": "3baf8a6c07ee8e203311cc6abda56cf90e32dd94", "filename": "src/test/rustdoc/auxiliary/cross-crate-hidden-assoc-trait-items.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f/src%2Ftest%2Frustdoc%2Fauxiliary%2Fcross-crate-hidden-assoc-trait-items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f/src%2Ftest%2Frustdoc%2Fauxiliary%2Fcross-crate-hidden-assoc-trait-items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fauxiliary%2Fcross-crate-hidden-assoc-trait-items.rs?ref=24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f", "patch": "@@ -0,0 +1,19 @@\n+pub trait Tr {\n+    type VisibleAssoc;\n+    #[doc(hidden)]\n+    type HiddenAssoc;\n+\n+    const VISIBLE_ASSOC: ();\n+    #[doc(hidden)]\n+    const HIDDEN_ASSOC: ();\n+}\n+\n+pub struct Ty;\n+\n+impl Tr for Ty {\n+    type VisibleAssoc = ();\n+    type HiddenAssoc = ();\n+\n+    const VISIBLE_ASSOC: () = ();\n+    const HIDDEN_ASSOC: () = ();\n+}"}, {"sha": "d02bc4fe712505ea412efa34bb90fdf102c76cc4", "filename": "src/test/rustdoc/cross-crate-hidden-assoc-trait-items.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f/src%2Ftest%2Frustdoc%2Fcross-crate-hidden-assoc-trait-items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f/src%2Ftest%2Frustdoc%2Fcross-crate-hidden-assoc-trait-items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fcross-crate-hidden-assoc-trait-items.rs?ref=24fa80dbb2069fb62f55b95ff83bd4ae29c35f6f", "patch": "@@ -0,0 +1,23 @@\n+// Regression test for issue #95717\n+// Hide cross-crate `#[doc(hidden)]` associated items in trait impls.\n+\n+#![crate_name = \"dependent\"]\n+// edition:2021\n+// aux-crate:dependency=cross-crate-hidden-assoc-trait-items.rs\n+\n+// The trait `Tr` contains 2 hidden and 2 visisible associated items.\n+// Instead of checking for the absence of the hidden items, check for the presence of the\n+// visible items instead and assert that there are *exactly two* associated items\n+// (by counting the number of `section`s). This is more robust and future-proof.\n+\n+// @has dependent/struct.Ty.html\n+// @has - '//*[@id=\"associatedtype.VisibleAssoc\"]' 'type VisibleAssoc = ()'\n+// @has - '//*[@id=\"associatedconstant.VISIBLE_ASSOC\"]' 'const VISIBLE_ASSOC: ()'\n+// @count - '//*[@class=\"impl-items\"]/section' 2\n+\n+// @has dependent/trait.Tr.html\n+// @has - '//*[@id=\"associatedtype.VisibleAssoc-1\"]' 'type VisibleAssoc = ()'\n+// @has - '//*[@id=\"associatedconstant.VISIBLE_ASSOC-1\"]' 'const VISIBLE_ASSOC: ()'\n+// @count - '//*[@class=\"impl-items\"]/section' 2\n+\n+pub use dependency::{Tr, Ty};"}]}