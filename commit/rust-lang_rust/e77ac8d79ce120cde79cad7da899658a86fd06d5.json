{"sha": "e77ac8d79ce120cde79cad7da899658a86fd06d5", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU3N2FjOGQ3OWNlMTIwY2RlNzljYWQ3ZGE4OTk2NThhODZmZDA2ZDU=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-10-28T17:06:25Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-10-28T17:06:25Z"}, "message": "Merge #6396\n\n6396: refactor(hir_ty): do not override DisplayTarget in hir_fmt r=flodiebold a=bnjjj\n\nLinked to bug discovery from #6387\r\n\r\nThe main goal is to not use `display()` method inside `hir_fmt` to not override any parameters (like `DisplayTarget`). \r\ncc @flodiebold \n\nCo-authored-by: Benjamin Coenen <5719034+bnjjj@users.noreply.github.com>", "tree": {"sha": "82c718f0792907370b2a4aba9edfc8b56fb1e27f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/82c718f0792907370b2a4aba9edfc8b56fb1e27f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e77ac8d79ce120cde79cad7da899658a86fd06d5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfmaURCRBK7hj4Ov3rIwAAdHIIAA1qHGbcElOivPOMi+z0NjbH\nZKSvebligttpRXLMdLQC6zoXSn4rgPoixFH8X/IHqrSiFOU+TRdDGsGb2zC89/Zv\noIkHWUQmPHgpBakJO7UcoIpxwJnTghpg63ukgJHsEWN9dYUNOJvlpdqb3j5QhNB6\nqMOB8iRflpp/9HGyZD9JWxf7UQaGoZ2TbFI1EQX0oRZbsXGHUAOfNw0alGSjumSy\nHREdf47fvWciQw5c1RHicHpJOlprSBVxgusEra+inaUkLKMyioXuT7NrfpkF/Sq3\ngLOXB5V9dp2UJS4SnoEURzX83EiIcRp/BTh5ILaQ1kU8zRzAFfH9zboFI7Bf/a4=\n=PKtQ\n-----END PGP SIGNATURE-----\n", "payload": "tree 82c718f0792907370b2a4aba9edfc8b56fb1e27f\nparent 93fca7556a72ed437674c64494daf1f9e4981d2d\nparent 7322a69cf6947d22a07a0b6173dc50a3e4062916\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1603904785 +0000\ncommitter GitHub <noreply@github.com> 1603904785 +0000\n\nMerge #6396\n\n6396: refactor(hir_ty): do not override DisplayTarget in hir_fmt r=flodiebold a=bnjjj\n\nLinked to bug discovery from #6387\r\n\r\nThe main goal is to not use `display()` method inside `hir_fmt` to not override any parameters (like `DisplayTarget`). \r\ncc @flodiebold \n\nCo-authored-by: Benjamin Coenen <5719034+bnjjj@users.noreply.github.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e77ac8d79ce120cde79cad7da899658a86fd06d5", "html_url": "https://github.com/rust-lang/rust/commit/e77ac8d79ce120cde79cad7da899658a86fd06d5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e77ac8d79ce120cde79cad7da899658a86fd06d5/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "93fca7556a72ed437674c64494daf1f9e4981d2d", "url": "https://api.github.com/repos/rust-lang/rust/commits/93fca7556a72ed437674c64494daf1f9e4981d2d", "html_url": "https://github.com/rust-lang/rust/commit/93fca7556a72ed437674c64494daf1f9e4981d2d"}, {"sha": "7322a69cf6947d22a07a0b6173dc50a3e4062916", "url": "https://api.github.com/repos/rust-lang/rust/commits/7322a69cf6947d22a07a0b6173dc50a3e4062916", "html_url": "https://github.com/rust-lang/rust/commit/7322a69cf6947d22a07a0b6173dc50a3e4062916"}], "stats": {"total": 113, "additions": 68, "deletions": 45}, "files": [{"sha": "14e8c06332b18ae29db75f5dd411f6c18a039f80", "filename": "crates/hir_ty/src/display.rs", "status": "modified", "additions": 68, "deletions": 45, "changes": 113, "blob_url": "https://github.com/rust-lang/rust/blob/e77ac8d79ce120cde79cad7da899658a86fd06d5/crates%2Fhir_ty%2Fsrc%2Fdisplay.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e77ac8d79ce120cde79cad7da899658a86fd06d5/crates%2Fhir_ty%2Fsrc%2Fdisplay.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fdisplay.rs?ref=e77ac8d79ce120cde79cad7da899658a86fd06d5", "patch": "@@ -25,6 +25,20 @@ pub struct HirFormatter<'a> {\n pub trait HirDisplay {\n     fn hir_fmt(&self, f: &mut HirFormatter) -> Result<(), HirDisplayError>;\n \n+    /// Returns a `Display`able type that is human-readable.\n+    fn into_displayable<'a>(\n+        &'a self,\n+        db: &'a dyn HirDatabase,\n+        max_size: Option<usize>,\n+        omit_verbose_types: bool,\n+        display_target: DisplayTarget,\n+    ) -> HirDisplayWrapper<'a, Self>\n+    where\n+        Self: Sized,\n+    {\n+        HirDisplayWrapper { db, t: self, max_size, omit_verbose_types, display_target }\n+    }\n+\n     /// Returns a `Display`able type that is human-readable.\n     /// Use this for showing types to the user (e.g. diagnostics)\n     fn display<'a>(&'a self, db: &'a dyn HirDatabase) -> HirDisplayWrapper<'a, Self>\n@@ -140,7 +154,7 @@ impl<'a> HirFormatter<'a> {\n }\n \n #[derive(Clone, Copy)]\n-enum DisplayTarget {\n+pub enum DisplayTarget {\n     /// Display types for inlays, doc popups, autocompletion, etc...\n     /// Showing `{unknown}` or not qualifying paths is fine here.\n     /// There's no reason for this to fail.\n@@ -232,32 +246,32 @@ impl HirDisplay for ApplicationTy {\n             TypeCtor::Str => write!(f, \"str\")?,\n             TypeCtor::Slice => {\n                 let t = self.parameters.as_single();\n-                write!(f, \"[{}]\", t.display(f.db))?;\n+                write!(f, \"[\")?;\n+                t.hir_fmt(f)?;\n+                write!(f, \"]\")?;\n             }\n             TypeCtor::Array => {\n                 let t = self.parameters.as_single();\n-                write!(f, \"[{}; _]\", t.display(f.db))?;\n+                write!(f, \"[\")?;\n+                t.hir_fmt(f)?;\n+                write!(f, \"; _]\")?;\n             }\n             TypeCtor::RawPtr(m) => {\n                 let t = self.parameters.as_single();\n-                let ty_display = t.display(f.db);\n \n                 write!(f, \"*{}\", m.as_keyword_for_ptr())?;\n                 if matches!(t, Ty::Dyn(predicates) if predicates.len() > 1) {\n                     write!(f, \"(\")?;\n-                    write!(f, \"{}\", ty_display)?;\n+                    t.hir_fmt(f)?;\n                     write!(f, \")\")?;\n                 } else {\n-                    write!(f, \"{}\", ty_display)?;\n+                    t.hir_fmt(f)?;\n                 }\n             }\n             TypeCtor::Ref(m) => {\n                 let t = self.parameters.as_single();\n-                let ty_display = if f.omit_verbose_types() {\n-                    t.display_truncated(f.db, f.max_size)\n-                } else {\n-                    t.display(f.db)\n-                };\n+                let ty_display =\n+                    t.into_displayable(f.db, f.max_size, f.omit_verbose_types, f.display_target);\n \n                 write!(f, \"&{}\", m.as_keyword_for_ref())?;\n                 if matches!(t, Ty::Dyn(predicates) if predicates.len() > 1) {\n@@ -272,7 +286,9 @@ impl HirDisplay for ApplicationTy {\n             TypeCtor::Tuple { .. } => {\n                 let ts = &self.parameters;\n                 if ts.len() == 1 {\n-                    write!(f, \"({},)\", ts[0].display(f.db))?;\n+                    write!(f, \"(\")?;\n+                    ts[0].hir_fmt(f)?;\n+                    write!(f, \",)\")?;\n                 } else {\n                     write!(f, \"(\")?;\n                     f.write_joined(&*ts.0, \", \")?;\n@@ -293,11 +309,12 @@ impl HirDisplay for ApplicationTy {\n                 write!(f, \")\")?;\n                 let ret = sig.ret();\n                 if *ret != Ty::unit() {\n-                    let ret_display = if f.omit_verbose_types() {\n-                        ret.display_truncated(f.db, f.max_size)\n-                    } else {\n-                        ret.display(f.db)\n-                    };\n+                    let ret_display = ret.into_displayable(\n+                        f.db,\n+                        f.max_size,\n+                        f.omit_verbose_types,\n+                        f.display_target,\n+                    );\n                     write!(f, \" -> {}\", ret_display)?;\n                 }\n             }\n@@ -329,15 +346,13 @@ impl HirDisplay for ApplicationTy {\n                 write!(f, \")\")?;\n                 let ret = sig.ret();\n                 if *ret != Ty::unit() {\n-                    let ret_display = if f.omit_verbose_types() {\n-                        ret.display_truncated(f.db, f.max_size)\n-                    } else {\n-                        if f.display_target.is_test() {\n-                            ret.display_test(f.db)\n-                        } else {\n-                            ret.display(f.db)\n-                        }\n-                    };\n+                    let ret_display = ret.into_displayable(\n+                        f.db,\n+                        f.max_size,\n+                        f.omit_verbose_types,\n+                        f.display_target,\n+                    );\n+\n                     write!(f, \" -> {}\", ret_display)?;\n                 }\n             }\n@@ -473,15 +488,12 @@ impl HirDisplay for ApplicationTy {\n                         write!(f, \"|\")?;\n                     };\n \n-                    let ret_display = if f.omit_verbose_types() {\n-                        sig.ret().display_truncated(f.db, f.max_size)\n-                    } else {\n-                        if f.display_target.is_test() {\n-                            sig.ret().display_test(f.db)\n-                        } else {\n-                            sig.ret().display(f.db)\n-                        }\n-                    };\n+                    let ret_display = sig.ret().into_displayable(\n+                        f.db,\n+                        f.max_size,\n+                        f.omit_verbose_types,\n+                        f.display_target,\n+                    );\n                     write!(f, \" -> {}\", ret_display)?;\n                 } else {\n                     write!(f, \"{{closure}}\")?;\n@@ -499,7 +511,13 @@ impl HirDisplay for ProjectionTy {\n         }\n \n         let trait_ = f.db.trait_data(self.trait_(f.db));\n-        write!(f, \"<{} as {}\", self.parameters[0].display(f.db), trait_.name)?;\n+        let first_parameter = self.parameters[0].into_displayable(\n+            f.db,\n+            f.max_size,\n+            f.omit_verbose_types,\n+            f.display_target,\n+        );\n+        write!(f, \"<{} as {}\", first_parameter, trait_.name)?;\n         if self.parameters.len() > 1 {\n             write!(f, \"<\")?;\n             f.write_joined(&self.parameters[1..], \", \")?;\n@@ -678,10 +696,10 @@ impl HirDisplay for GenericPredicate {\n                 projection_pred.projection_ty.trait_ref(f.db).hir_fmt_ext(f, true)?;\n                 write!(\n                     f,\n-                    \">::{} = {}\",\n+                    \">::{} = \",\n                     f.db.type_alias_data(projection_pred.projection_ty.associated_ty).name,\n-                    projection_pred.ty.display(f.db)\n                 )?;\n+                projection_pred.ty.hir_fmt(f)?;\n             }\n             GenericPredicate::Error => write!(f, \"{{error}}\")?,\n         }\n@@ -692,13 +710,18 @@ impl HirDisplay for GenericPredicate {\n impl HirDisplay for Obligation {\n     fn hir_fmt(&self, f: &mut HirFormatter) -> Result<(), HirDisplayError> {\n         match self {\n-            Obligation::Trait(tr) => write!(f, \"Implements({})\", tr.display(f.db)),\n-            Obligation::Projection(proj) => write!(\n-                f,\n-                \"Normalize({} => {})\",\n-                proj.projection_ty.display(f.db),\n-                proj.ty.display(f.db)\n-            ),\n+            Obligation::Trait(tr) => {\n+                write!(f, \"Implements(\")?;\n+                tr.hir_fmt(f)?;\n+                write!(f, \")\")\n+            }\n+            Obligation::Projection(proj) => {\n+                write!(f, \"Normalize(\")?;\n+                proj.projection_ty.hir_fmt(f)?;\n+                write!(f, \" => \")?;\n+                proj.ty.hir_fmt(f)?;\n+                write!(f, \")\")\n+            }\n         }\n     }\n }"}]}