{"sha": "daecd152715b2f38482779211513e03c1745d25b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRhZWNkMTUyNzE1YjJmMzg0ODI3NzkyMTE1MTNlMDNjMTc0NWQyNWI=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-02-05T18:13:52Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-02-05T18:13:52Z"}, "message": "Rollup merge of #47959 - Manishearth:rustdoc-ice, r=Mark-Simulacrum\n\nFix rustdoc ICE on macros defined within functions\n\nfixes #47639", "tree": {"sha": "9c483b20dd627cdd97f09e38d43740531d5b7bad", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9c483b20dd627cdd97f09e38d43740531d5b7bad"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/daecd152715b2f38482779211513e03c1745d25b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJaeJ7gCRBK7hj4Ov3rIwAAdHIIALGEL2DSAArZ4rjk3rWozVtL\n31RdlhkCeSELT+MDsPfOIQoDbF/OQFpIqr1il/IepzGgRAkjM2qTxsq+ONBqxWCa\nqfaNuZgXHW9QIy3eZaYA6s2f21Cv14JGgZ/GYkiTb36ptmizwZ0erVdKTWtIzD/F\ne2u/8Zwyh91cedS9uLu5MVtl8YwvVmYxoDx5cXAZ5ss/0glfBtr1QeQ0ufAOzexc\nbqHlZPeYg9sNzC1ntNK0ujl1rJxX3wxBiY89R2+LvDyEc13DxYzf16EWS9CP7bZY\n29T7E1SkOVwEzUgo6oo3TN9jcOVB9u13Vl+qHiu969i79egCHS3MrR031zGCKNc=\n=XKDN\n-----END PGP SIGNATURE-----\n", "payload": "tree 9c483b20dd627cdd97f09e38d43740531d5b7bad\nparent 55aef3c9c77fbf36a1568630b97aa241a0d19441\nparent ee737c73a2ac2d02420df812ad36cf16856da67a\nauthor kennytm <kennytm@gmail.com> 1517854432 +0800\ncommitter GitHub <noreply@github.com> 1517854432 +0800\n\nRollup merge of #47959 - Manishearth:rustdoc-ice, r=Mark-Simulacrum\n\nFix rustdoc ICE on macros defined within functions\n\nfixes #47639\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/daecd152715b2f38482779211513e03c1745d25b", "html_url": "https://github.com/rust-lang/rust/commit/daecd152715b2f38482779211513e03c1745d25b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/daecd152715b2f38482779211513e03c1745d25b/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "55aef3c9c77fbf36a1568630b97aa241a0d19441", "url": "https://api.github.com/repos/rust-lang/rust/commits/55aef3c9c77fbf36a1568630b97aa241a0d19441", "html_url": "https://github.com/rust-lang/rust/commit/55aef3c9c77fbf36a1568630b97aa241a0d19441"}, {"sha": "ee737c73a2ac2d02420df812ad36cf16856da67a", "url": "https://api.github.com/repos/rust-lang/rust/commits/ee737c73a2ac2d02420df812ad36cf16856da67a", "html_url": "https://github.com/rust-lang/rust/commit/ee737c73a2ac2d02420df812ad36cf16856da67a"}], "stats": {"total": 35, "additions": 30, "deletions": 5}, "files": [{"sha": "ed937046e5ed747b6ece8e486bcfbc250e79140e", "filename": "src/librustc/lint/context.rs", "status": "modified", "additions": 14, "deletions": 5, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/daecd152715b2f38482779211513e03c1745d25b/src%2Flibrustc%2Flint%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/daecd152715b2f38482779211513e03c1745d25b/src%2Flibrustc%2Flint%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fcontext.rs?ref=daecd152715b2f38482779211513e03c1745d25b", "patch": "@@ -1042,11 +1042,20 @@ pub fn check_ast_crate(sess: &Session, krate: &ast::Crate) {\n     // Put the lint store levels and passes back in the session.\n     cx.lint_sess.restore(&sess.lint_store);\n \n-    // Emit all buffered lints from early on in the session now that we've\n-    // calculated the lint levels for all AST nodes.\n-    for (_id, lints) in cx.buffered.map {\n-        for early_lint in lints {\n-            span_bug!(early_lint.span, \"failed to process buffered lint here\");\n+    // All of the buffered lints should have been emitted at this point.\n+    // If not, that means that we somehow buffered a lint for a node id\n+    // that was not lint-checked (perhaps it doesn't exist?). This is a bug.\n+    //\n+    // Rustdoc runs everybody-loops before the early lints and removes\n+    // function bodies, so it's totally possible for linted\n+    // node ids to not exist (e.g. macros defined within functions for the\n+    // unused_macro lint) anymore. So we only run this check\n+    // when we're not in rustdoc mode. (see issue #47639)\n+    if !sess.opts.actually_rustdoc {\n+        for (_id, lints) in cx.buffered.map {\n+            for early_lint in lints {\n+                span_bug!(early_lint.span, \"failed to process buffered lint here\");\n+            }\n         }\n     }\n }"}, {"sha": "167c3aaec4ab6141795e361ba7f58da91a1b1a7f", "filename": "src/test/rustdoc/issue-47639.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/daecd152715b2f38482779211513e03c1745d25b/src%2Ftest%2Frustdoc%2Fissue-47639.rs", "raw_url": "https://github.com/rust-lang/rust/raw/daecd152715b2f38482779211513e03c1745d25b/src%2Ftest%2Frustdoc%2Fissue-47639.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fissue-47639.rs?ref=daecd152715b2f38482779211513e03c1745d25b", "patch": "@@ -0,0 +1,16 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// This should not ICE\n+pub fn test() {\n+    macro_rules! foo {\n+        () => ()\n+    }\n+}"}]}