{"sha": "7c900c9b457b232e0c189dba0871a50fd2daabf9", "node_id": "C_kwDOAAsO6NoAKDdjOTAwYzliNDU3YjIzMmUwYzE4OWRiYTA4NzFhNTBmZDJkYWFiZjk", "commit": {"author": {"name": "nils", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2022-07-18T16:17:27Z"}, "committer": {"name": "nils", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2022-07-19T14:02:59Z"}, "message": "Add flag to configure `noalias` on `Box<T>`\n\nTo aid making an informed decision about the aliasing\nrules of box, give users an option to remove `noalias`\nfrom box.", "tree": {"sha": "ca587cfbbb4430af1ffce2348798fd268df18c94", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ca587cfbbb4430af1ffce2348798fd268df18c94"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7c900c9b457b232e0c189dba0871a50fd2daabf9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7c900c9b457b232e0c189dba0871a50fd2daabf9", "html_url": "https://github.com/rust-lang/rust/commit/7c900c9b457b232e0c189dba0871a50fd2daabf9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7c900c9b457b232e0c189dba0871a50fd2daabf9/comments", "author": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9ed0bf9f2bd63933785fb8a380c177d2d70e88ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/9ed0bf9f2bd63933785fb8a380c177d2d70e88ec", "html_url": "https://github.com/rust-lang/rust/commit/9ed0bf9f2bd63933785fb8a380c177d2d70e88ec"}], "stats": {"total": 29, "additions": 27, "deletions": 2}, "files": [{"sha": "3eef3308770bee04c512e47296a0d401938f008b", "filename": "compiler/rustc_interface/src/tests.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7c900c9b457b232e0c189dba0871a50fd2daabf9/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c900c9b457b232e0c189dba0871a50fd2daabf9/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Ftests.rs?ref=7c900c9b457b232e0c189dba0871a50fd2daabf9", "patch": "@@ -718,6 +718,7 @@ fn test_unstable_options_tracking_hash() {\n     tracked!(asm_comments, true);\n     tracked!(assume_incomplete_release, true);\n     tracked!(binary_dep_depinfo, true);\n+    tracked!(box_noalias, Some(false));\n     tracked!(\n         branch_protection,\n         Some(BranchProtection {"}, {"sha": "4491965347bd66473b2791a9c752b81e09e5653b", "filename": "compiler/rustc_middle/src/ty/layout.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7c900c9b457b232e0c189dba0871a50fd2daabf9/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c900c9b457b232e0c189dba0871a50fd2daabf9/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs?ref=7c900c9b457b232e0c189dba0871a50fd2daabf9", "patch": "@@ -3266,7 +3266,12 @@ impl<'tcx> LayoutCx<'tcx, TyCtxt<'tcx>> {\n                     // this attribute doesn't make it UB for the pointed-to data to be undef.\n                     attrs.set(ArgAttribute::NoUndef);\n \n-                    // `Box` pointer parameters never alias because ownership is transferred\n+                    // The aliasing rules for `Box<T>` are still not decided, but currently we emit\n+                    // `noalias` for it. This can be turned off using an unstable flag.\n+                    // See https://github.com/rust-lang/unsafe-code-guidelines/issues/326\n+                    let noalias_for_box =\n+                        self.tcx().sess.opts.unstable_opts.box_noalias.unwrap_or(true);\n+\n                     // `&mut` pointer parameters never alias other parameters,\n                     // or mutable global data\n                     //\n@@ -3281,7 +3286,7 @@ impl<'tcx> LayoutCx<'tcx, TyCtxt<'tcx>> {\n                     // `-Zmutable-noalias` debugging option.\n                     let no_alias = match kind {\n                         PointerKind::Shared | PointerKind::UniqueBorrowed => false,\n-                        PointerKind::UniqueOwned => true,\n+                        PointerKind::UniqueOwned => noalias_for_box,\n                         PointerKind::Frozen => !is_return,\n                     };\n                     if no_alias {"}, {"sha": "5d365fc5246287040e780d8f7fea1badf0c5cc7e", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7c900c9b457b232e0c189dba0871a50fd2daabf9/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c900c9b457b232e0c189dba0871a50fd2daabf9/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=7c900c9b457b232e0c189dba0871a50fd2daabf9", "patch": "@@ -1209,6 +1209,8 @@ options! {\n     binary_dep_depinfo: bool = (false, parse_bool, [TRACKED],\n         \"include artifacts (sysroot, crate dependencies) used during compilation in dep-info \\\n         (default: no)\"),\n+    box_noalias: Option<bool> = (None, parse_opt_bool, [TRACKED],\n+        \"emit noalias metadata for box (default: yes)\"),\n     branch_protection: Option<BranchProtection> = (None, parse_branch_protection, [TRACKED],\n         \"set options for branch target identification and pointer authentication on AArch64\"),\n     cf_protection: CFProtection = (CFProtection::None, parse_cfprotection, [TRACKED],"}, {"sha": "afd17c7c160749badb7a83c100317022f29badb7", "filename": "src/test/codegen/noalias-box-off.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7c900c9b457b232e0c189dba0871a50fd2daabf9/src%2Ftest%2Fcodegen%2Fnoalias-box-off.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c900c9b457b232e0c189dba0871a50fd2daabf9/src%2Ftest%2Fcodegen%2Fnoalias-box-off.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fnoalias-box-off.rs?ref=7c900c9b457b232e0c189dba0871a50fd2daabf9", "patch": "@@ -0,0 +1,8 @@\n+// compile-flags: -O -Z box-noalias=no\n+\n+#![crate_type = \"lib\"]\n+\n+// CHECK-LABEL: @box_should_not_have_noalias_if_disabled(\n+// CHECK-NOT: noalias\n+#[no_mangle]\n+pub fn box_should_not_have_noalias_if_disabled(_b: Box<u8>) {}"}, {"sha": "a3d1f093d8bd3fb20af8ae6e896da1dbe6be8b9f", "filename": "src/test/codegen/noalias-box.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7c900c9b457b232e0c189dba0871a50fd2daabf9/src%2Ftest%2Fcodegen%2Fnoalias-box.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c900c9b457b232e0c189dba0871a50fd2daabf9/src%2Ftest%2Fcodegen%2Fnoalias-box.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fnoalias-box.rs?ref=7c900c9b457b232e0c189dba0871a50fd2daabf9", "patch": "@@ -0,0 +1,8 @@\n+// compile-flags: -O\n+\n+#![crate_type = \"lib\"]\n+\n+// CHECK-LABEL: @box_should_have_noalias_by_default(\n+// CHECK: noalias\n+#[no_mangle]\n+pub fn box_should_have_noalias_by_default(_b: Box<u8>) {}"}, {"sha": "6f5248f5b18ce3ea364701aca366c7a20e4a5741", "filename": "src/test/rustdoc-ui/z-help.stdout", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7c900c9b457b232e0c189dba0871a50fd2daabf9/src%2Ftest%2Frustdoc-ui%2Fz-help.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/7c900c9b457b232e0c189dba0871a50fd2daabf9/src%2Ftest%2Frustdoc-ui%2Fz-help.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fz-help.stdout?ref=7c900c9b457b232e0c189dba0871a50fd2daabf9", "patch": "@@ -4,6 +4,7 @@\n     -Z                            asm-comments=val -- generate comments into the assembly (may change behavior) (default: no)\n     -Z                       assert-incr-state=val -- assert that the incremental cache is in given state: either `loaded` or `not-loaded`.\n     -Z                      binary-dep-depinfo=val -- include artifacts (sysroot, crate dependencies) used during compilation in dep-info (default: no)\n+    -Z                             box-noalias=val -- emit noalias metadata for box (default: yes)\n     -Z                       branch-protection=val -- set options for branch target identification and pointer authentication on AArch64\n     -Z                           cf-protection=val -- instrument control-flow architecture protection\n     -Z               cgu-partitioning-strategy=val -- the codegen unit partitioning strategy to use"}]}