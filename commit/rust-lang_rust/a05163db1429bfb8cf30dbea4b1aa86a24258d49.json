{"sha": "a05163db1429bfb8cf30dbea4b1aa86a24258d49", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEwNTE2M2RiMTQyOWJmYjhjZjMwZGJlYTRiMWFhODZhMjQyNThkNDk=", "commit": {"author": {"name": "Kirill Bulatov", "email": "mail4score@gmail.com", "date": "2021-05-25T22:11:52Z"}, "committer": {"name": "Kirill Bulatov", "email": "mail4score@gmail.com", "date": "2021-05-25T22:11:52Z"}, "message": "Create tasks for all workspaces", "tree": {"sha": "66c7568f1c1ca8cb6defd22279c1a160afe79623", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/66c7568f1c1ca8cb6defd22279c1a160afe79623"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a05163db1429bfb8cf30dbea4b1aa86a24258d49", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a05163db1429bfb8cf30dbea4b1aa86a24258d49", "html_url": "https://github.com/rust-lang/rust/commit/a05163db1429bfb8cf30dbea4b1aa86a24258d49", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a05163db1429bfb8cf30dbea4b1aa86a24258d49/comments", "author": {"login": "SomeoneToIgnore", "id": 2690773, "node_id": "MDQ6VXNlcjI2OTA3NzM=", "avatar_url": "https://avatars.githubusercontent.com/u/2690773?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SomeoneToIgnore", "html_url": "https://github.com/SomeoneToIgnore", "followers_url": "https://api.github.com/users/SomeoneToIgnore/followers", "following_url": "https://api.github.com/users/SomeoneToIgnore/following{/other_user}", "gists_url": "https://api.github.com/users/SomeoneToIgnore/gists{/gist_id}", "starred_url": "https://api.github.com/users/SomeoneToIgnore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SomeoneToIgnore/subscriptions", "organizations_url": "https://api.github.com/users/SomeoneToIgnore/orgs", "repos_url": "https://api.github.com/users/SomeoneToIgnore/repos", "events_url": "https://api.github.com/users/SomeoneToIgnore/events{/privacy}", "received_events_url": "https://api.github.com/users/SomeoneToIgnore/received_events", "type": "User", "site_admin": false}, "committer": {"login": "SomeoneToIgnore", "id": 2690773, "node_id": "MDQ6VXNlcjI2OTA3NzM=", "avatar_url": "https://avatars.githubusercontent.com/u/2690773?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SomeoneToIgnore", "html_url": "https://github.com/SomeoneToIgnore", "followers_url": "https://api.github.com/users/SomeoneToIgnore/followers", "following_url": "https://api.github.com/users/SomeoneToIgnore/following{/other_user}", "gists_url": "https://api.github.com/users/SomeoneToIgnore/gists{/gist_id}", "starred_url": "https://api.github.com/users/SomeoneToIgnore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SomeoneToIgnore/subscriptions", "organizations_url": "https://api.github.com/users/SomeoneToIgnore/orgs", "repos_url": "https://api.github.com/users/SomeoneToIgnore/repos", "events_url": "https://api.github.com/users/SomeoneToIgnore/events{/privacy}", "received_events_url": "https://api.github.com/users/SomeoneToIgnore/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5587d0a3e3599063a8993e9a44a7628abbabae8b", "url": "https://api.github.com/repos/rust-lang/rust/commits/5587d0a3e3599063a8993e9a44a7628abbabae8b", "html_url": "https://github.com/rust-lang/rust/commit/5587d0a3e3599063a8993e9a44a7628abbabae8b"}], "stats": {"total": 42, "additions": 20, "deletions": 22}, "files": [{"sha": "f13ae07e148f33cbda21d19bfdaaad5b54b0cd13", "filename": "editors/code/src/client.ts", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a05163db1429bfb8cf30dbea4b1aa86a24258d49/editors%2Fcode%2Fsrc%2Fclient.ts", "raw_url": "https://github.com/rust-lang/rust/raw/a05163db1429bfb8cf30dbea4b1aa86a24258d49/editors%2Fcode%2Fsrc%2Fclient.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fclient.ts?ref=a05163db1429bfb8cf30dbea4b1aa86a24258d49", "patch": "@@ -32,14 +32,9 @@ export function createClient(serverPath: string, workspace: Workspace, extraEnv:\n     const newEnv = Object.assign({}, process.env);\n     Object.assign(newEnv, extraEnv);\n \n-    let cwd = undefined;\n-    if (workspace.kind === \"Workspace Folder\") {\n-        cwd = workspace.folder.fsPath;\n-    };\n-\n     const run: lc.Executable = {\n         command: serverPath,\n-        options: { cwd, env: newEnv },\n+        options: { env: newEnv },\n     };\n     const serverOptions: lc.ServerOptions = {\n         run,"}, {"sha": "cf67dd8cff4227e61f947483cfddcdcf05c0f2af", "filename": "editors/code/src/ctx.ts", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a05163db1429bfb8cf30dbea4b1aa86a24258d49/editors%2Fcode%2Fsrc%2Fctx.ts", "raw_url": "https://github.com/rust-lang/rust/raw/a05163db1429bfb8cf30dbea4b1aa86a24258d49/editors%2Fcode%2Fsrc%2Fctx.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fctx.ts?ref=a05163db1429bfb8cf30dbea4b1aa86a24258d49", "patch": "@@ -10,7 +10,6 @@ import { ServerStatusParams } from './lsp_ext';\n export type Workspace =\n     {\n         kind: 'Workspace Folder';\n-        folder: vscode.Uri;\n     }\n     | {\n         kind: 'Detached Files';"}, {"sha": "d26273246c9103fd5b09bddc06331d575132716c", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a05163db1429bfb8cf30dbea4b1aa86a24258d49/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/a05163db1429bfb8cf30dbea4b1aa86a24258d49/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=a05163db1429bfb8cf30dbea4b1aa86a24258d49", "patch": "@@ -45,8 +45,7 @@ async function tryActivate(context: vscode.ExtensionContext) {\n         throw new Error(message);\n     });\n \n-    const workspaceFolder = vscode.workspace.workspaceFolders?.[0];\n-    if (workspaceFolder === undefined) {\n+    if (vscode.workspace.workspaceFolders?.length === 0) {\n         const rustDocuments = vscode.workspace.textDocuments.filter(document => isRustDocument(document));\n         if (rustDocuments.length > 0) {\n             ctx = await Ctx.create(config, context, serverPath, { kind: 'Detached Files', files: rustDocuments });\n@@ -58,8 +57,8 @@ async function tryActivate(context: vscode.ExtensionContext) {\n         // registers its `onDidChangeDocument` handler before us.\n         //\n         // This a horribly, horribly wrong way to deal with this problem.\n-        ctx = await Ctx.create(config, context, serverPath, { kind: \"Workspace Folder\", folder: workspaceFolder.uri });\n-        ctx.pushCleanup(activateTaskProvider(workspaceFolder, ctx.config));\n+        ctx = await Ctx.create(config, context, serverPath, { kind: \"Workspace Folder\" });\n+        ctx.pushCleanup(activateTaskProvider(ctx.config));\n     }\n     await initCommonContext(context, ctx);\n "}, {"sha": "694ee1e41304e04d57e72499501e08e3054c5cfd", "filename": "editors/code/src/tasks.ts", "status": "modified", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/a05163db1429bfb8cf30dbea4b1aa86a24258d49/editors%2Fcode%2Fsrc%2Ftasks.ts", "raw_url": "https://github.com/rust-lang/rust/raw/a05163db1429bfb8cf30dbea4b1aa86a24258d49/editors%2Fcode%2Fsrc%2Ftasks.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Ftasks.ts?ref=a05163db1429bfb8cf30dbea4b1aa86a24258d49", "patch": "@@ -17,11 +17,9 @@ export interface CargoTaskDefinition extends vscode.TaskDefinition {\n }\n \n class CargoTaskProvider implements vscode.TaskProvider {\n-    private readonly target: vscode.WorkspaceFolder;\n     private readonly config: Config;\n \n-    constructor(target: vscode.WorkspaceFolder, config: Config) {\n-        this.target = target;\n+    constructor(config: Config) {\n         this.config = config;\n     }\n \n@@ -40,10 +38,12 @@ class CargoTaskProvider implements vscode.TaskProvider {\n         ];\n \n         const tasks: vscode.Task[] = [];\n-        for (const def of defs) {\n-            const vscodeTask = await buildCargoTask(this.target, { type: TASK_TYPE, command: def.command }, `cargo ${def.command}`, [def.command], this.config.cargoRunner);\n-            vscodeTask.group = def.group;\n-            tasks.push(vscodeTask);\n+        for (const workspaceTarget of vscode.workspace.workspaceFolders || []) {\n+            for (const def of defs) {\n+                const vscodeTask = await buildCargoTask(workspaceTarget, { type: TASK_TYPE, command: def.command }, `cargo ${def.command}`, [def.command], this.config.cargoRunner);\n+                vscodeTask.group = def.group;\n+                tasks.push(vscodeTask);\n+            }\n         }\n \n         return tasks;\n@@ -58,14 +58,19 @@ class CargoTaskProvider implements vscode.TaskProvider {\n \n         if (definition.type === TASK_TYPE && definition.command) {\n             const args = [definition.command].concat(definition.args ?? []);\n-\n-            return await buildCargoTask(this.target, definition, task.name, args, this.config.cargoRunner);\n+            if (isWorkspaceFolder(task.scope)) {\n+                return await buildCargoTask(task.scope, definition, task.name, args, this.config.cargoRunner);\n+            }\n         }\n \n         return undefined;\n     }\n }\n \n+function isWorkspaceFolder(scope?: any): scope is vscode.WorkspaceFolder {\n+    return (scope as vscode.WorkspaceFolder).name !== undefined;\n+}\n+\n export async function buildCargoTask(\n     target: vscode.WorkspaceFolder,\n     definition: CargoTaskDefinition,\n@@ -119,7 +124,7 @@ export async function buildCargoTask(\n     );\n }\n \n-export function activateTaskProvider(target: vscode.WorkspaceFolder, config: Config): vscode.Disposable {\n-    const provider = new CargoTaskProvider(target, config);\n+export function activateTaskProvider(config: Config): vscode.Disposable {\n+    const provider = new CargoTaskProvider(config);\n     return vscode.tasks.registerTaskProvider(TASK_TYPE, provider);\n }"}]}