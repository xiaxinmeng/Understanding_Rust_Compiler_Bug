{"sha": "c6a3fe051a7c4284821c12ffe922087fb8662f2b", "node_id": "C_kwDOAAsO6NoAKGM2YTNmZTA1MWE3YzQyODQ4MjFjMTJmZmU5MjIwODdmYjg2NjJmMmI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-06-05T07:26:30Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-06-05T07:26:30Z"}, "message": "Auto merge of #14978 - HKalbasi:lifetime-display, r=HKalbasi\n\nEmit `'_` for lifetime generics in `HirDisplay`\n\nThis makes the generated code not linted by `rust_2018_idioms` lint. But that is an allow by default lint, so should we do this? Maybe we should only do this for `DisplayTarget::SourceCode`?", "tree": {"sha": "d92e24198d1a85159023b524caf75f2e9308e421", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d92e24198d1a85159023b524caf75f2e9308e421"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c6a3fe051a7c4284821c12ffe922087fb8662f2b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c6a3fe051a7c4284821c12ffe922087fb8662f2b", "html_url": "https://github.com/rust-lang/rust/commit/c6a3fe051a7c4284821c12ffe922087fb8662f2b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c6a3fe051a7c4284821c12ffe922087fb8662f2b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2f1b7cedcf5044ba620646c6758bbb99f46b8d95", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f1b7cedcf5044ba620646c6758bbb99f46b8d95", "html_url": "https://github.com/rust-lang/rust/commit/2f1b7cedcf5044ba620646c6758bbb99f46b8d95"}, {"sha": "5531d46c95f4a2745458790a640abc0ec198fd78", "url": "https://api.github.com/repos/rust-lang/rust/commits/5531d46c95f4a2745458790a640abc0ec198fd78", "html_url": "https://github.com/rust-lang/rust/commit/5531d46c95f4a2745458790a640abc0ec198fd78"}], "stats": {"total": 71, "additions": 49, "deletions": 22}, "files": [{"sha": "f90e025c7cc624f06b9b3fd8e15d0625a29a8a64", "filename": "crates/hir-ty/src/display.rs", "status": "modified", "additions": 22, "deletions": 19, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/c6a3fe051a7c4284821c12ffe922087fb8662f2b/crates%2Fhir-ty%2Fsrc%2Fdisplay.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c6a3fe051a7c4284821c12ffe922087fb8662f2b/crates%2Fhir-ty%2Fsrc%2Fdisplay.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Fdisplay.rs?ref=c6a3fe051a7c4284821c12ffe922087fb8662f2b", "patch": "@@ -1223,7 +1223,8 @@ fn hir_fmt_generics(\n     generic_def: Option<hir_def::GenericDefId>,\n ) -> Result<(), HirDisplayError> {\n     let db = f.db;\n-    if parameters.len(Interner) > 0 {\n+    let lifetime_args_count = generic_def.map_or(0, |g| db.generic_params(g).lifetimes.len());\n+    if parameters.len(Interner) + lifetime_args_count > 0 {\n         let parameters_to_write = if f.display_target.is_source_code() || f.omit_verbose_types() {\n             match generic_def\n                 .map(|generic_def_id| db.generic_defaults(generic_def_id))\n@@ -1268,26 +1269,28 @@ fn hir_fmt_generics(\n         } else {\n             parameters.as_slice(Interner)\n         };\n-        if !parameters_to_write.is_empty() {\n+        if !parameters_to_write.is_empty() || lifetime_args_count != 0 {\n             write!(f, \"<\")?;\n-\n-            if f.display_target.is_source_code() {\n-                let mut first = true;\n-                for generic_arg in parameters_to_write {\n-                    if !first {\n-                        write!(f, \", \")?;\n-                    }\n-                    first = false;\n-\n-                    if generic_arg.ty(Interner).map(|ty| ty.kind(Interner)) == Some(&TyKind::Error)\n-                    {\n-                        write!(f, \"_\")?;\n-                    } else {\n-                        generic_arg.hir_fmt(f)?;\n-                    }\n+            let mut first = true;\n+            for _ in 0..lifetime_args_count {\n+                if !first {\n+                    write!(f, \", \")?;\n+                }\n+                first = false;\n+                write!(f, \"'_\")?;\n+            }\n+            for generic_arg in parameters_to_write {\n+                if !first {\n+                    write!(f, \", \")?;\n+                }\n+                first = false;\n+                if f.display_target.is_source_code()\n+                    && generic_arg.ty(Interner).map(|ty| ty.kind(Interner)) == Some(&TyKind::Error)\n+                {\n+                    write!(f, \"_\")?;\n+                } else {\n+                    generic_arg.hir_fmt(f)?;\n                 }\n-            } else {\n-                f.write_joined(parameters_to_write, \", \")?;\n             }\n \n             write!(f, \">\")?;"}, {"sha": "0f5a3e1752cf5f1269d39a5c790dbd3e6be941ad", "filename": "crates/hir-ty/src/tests/patterns.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c6a3fe051a7c4284821c12ffe922087fb8662f2b/crates%2Fhir-ty%2Fsrc%2Ftests%2Fpatterns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c6a3fe051a7c4284821c12ffe922087fb8662f2b/crates%2Fhir-ty%2Fsrc%2Ftests%2Fpatterns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Ftests%2Fpatterns.rs?ref=c6a3fe051a7c4284821c12ffe922087fb8662f2b", "patch": "@@ -1109,7 +1109,7 @@ fn var_args() {\n #[lang = \"va_list\"]\n pub struct VaListImpl<'f>;\n fn my_fn(foo: ...) {}\n-       //^^^ VaListImpl\n+       //^^^ VaListImpl<'_>\n \"#,\n     );\n }"}, {"sha": "f18c953a7afd2682ab90be68b61dec35a1453e1e", "filename": "crates/hir-ty/src/tests/regression.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c6a3fe051a7c4284821c12ffe922087fb8662f2b/crates%2Fhir-ty%2Fsrc%2Ftests%2Fregression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c6a3fe051a7c4284821c12ffe922087fb8662f2b/crates%2Fhir-ty%2Fsrc%2Ftests%2Fregression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Ftests%2Fregression.rs?ref=c6a3fe051a7c4284821c12ffe922087fb8662f2b", "patch": "@@ -896,13 +896,13 @@ fn flush(&self) {\n \"#,\n         expect![[r#\"\n             123..127 'self': &Mutex<T>\n-            150..152 '{}': MutexGuard<T>\n+            150..152 '{}': MutexGuard<'_, T>\n             234..238 'self': &{unknown}\n             240..290 '{     ...()); }': ()\n             250..251 'w': &Mutex<BufWriter>\n             276..287 '*(w.lock())': BufWriter\n             278..279 'w': &Mutex<BufWriter>\n-            278..286 'w.lock()': MutexGuard<BufWriter>\n+            278..286 'w.lock()': MutexGuard<'_, BufWriter>\n         \"#]],\n     );\n }"}, {"sha": "2a67909e6371945838fb71b3b6df7edbf72c7f6a", "filename": "crates/ide-assists/src/handlers/extract_function.rs", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/c6a3fe051a7c4284821c12ffe922087fb8662f2b/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fextract_function.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c6a3fe051a7c4284821c12ffe922087fb8662f2b/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fextract_function.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fextract_function.rs?ref=c6a3fe051a7c4284821c12ffe922087fb8662f2b", "patch": "@@ -5478,6 +5478,30 @@ fn $0fun_name<T: Debug>(i: T) {\n         );\n     }\n \n+    #[test]\n+    fn dont_emit_type_with_hidden_lifetime_parameter() {\n+        // FIXME: We should emit a `<T: Debug>` generic argument for the generated function\n+        check_assist(\n+            extract_function,\n+            r#\"\n+struct Struct<'a, T>(&'a T);\n+fn func<T: Debug>(i: Struct<'_, T>) {\n+    $0foo(i);$0\n+}\n+\"#,\n+            r#\"\n+struct Struct<'a, T>(&'a T);\n+fn func<T: Debug>(i: Struct<'_, T>) {\n+    fun_name(i);\n+}\n+\n+fn $0fun_name(i: Struct<'_, T>) {\n+    foo(i);\n+}\n+\"#,\n+        );\n+    }\n+\n     #[test]\n     fn preserve_generics_from_body() {\n         check_assist("}]}