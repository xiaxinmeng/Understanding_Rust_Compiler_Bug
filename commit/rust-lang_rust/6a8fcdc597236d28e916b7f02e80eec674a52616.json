{"sha": "6a8fcdc597236d28e916b7f02e80eec674a52616", "node_id": "C_kwDOAAsO6NoAKDZhOGZjZGM1OTcyMzZkMjhlOTE2YjdmMDJlODBlZWM2NzRhNTI2MTY", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2023-03-14T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2023-04-26T22:32:03Z"}, "message": "Don't validate constants before propagation\n\nValidation is neither necessary nor desirable.\n\nThe validation is already omitted at mir-opt-level >= 3, so there there\nare not changes in MIR test output (the propagation of invalid constants\nis covered by an existing test in tests/mir-opt/const_prop/invalid_constant.rs).", "tree": {"sha": "b4d6b79d9ee27bc901349325820578bb3b729cca", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b4d6b79d9ee27bc901349325820578bb3b729cca"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6a8fcdc597236d28e916b7f02e80eec674a52616", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6a8fcdc597236d28e916b7f02e80eec674a52616", "html_url": "https://github.com/rust-lang/rust/commit/6a8fcdc597236d28e916b7f02e80eec674a52616", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6a8fcdc597236d28e916b7f02e80eec674a52616/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9c044d77a334609513f3b615e0763a40cc02424d", "url": "https://api.github.com/repos/rust-lang/rust/commits/9c044d77a334609513f3b615e0763a40cc02424d", "html_url": "https://github.com/rust-lang/rust/commit/9c044d77a334609513f3b615e0763a40cc02424d"}], "stats": {"total": 18, "additions": 3, "deletions": 15}, "files": [{"sha": "c4e715ccca80200402e34f6a7f878300b0ace290", "filename": "compiler/rustc_mir_transform/src/const_prop.rs", "status": "modified", "additions": 3, "deletions": 15, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/6a8fcdc597236d28e916b7f02e80eec674a52616/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a8fcdc597236d28e916b7f02e80eec674a52616/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs?ref=6a8fcdc597236d28e916b7f02e80eec674a52616", "patch": "@@ -22,9 +22,9 @@ use rustc_trait_selection::traits;\n \n use crate::MirPass;\n use rustc_const_eval::interpret::{\n-    self, compile_time_machine, AllocId, ConstAllocation, ConstValue, CtfeValidationMode, Frame,\n-    ImmTy, Immediate, InterpCx, InterpResult, LocalValue, MemoryKind, OpTy, PlaceTy, Pointer,\n-    Scalar, StackPopCleanup,\n+    self, compile_time_machine, AllocId, ConstAllocation, ConstValue, Frame, ImmTy, Immediate,\n+    InterpCx, InterpResult, LocalValue, MemoryKind, OpTy, PlaceTy, Pointer, Scalar,\n+    StackPopCleanup,\n };\n \n /// The maximum number of bytes that we'll allocate space for a local or the return value.\n@@ -628,18 +628,6 @@ impl<'mir, 'tcx> ConstPropagator<'mir, 'tcx> {\n         }\n \n         trace!(\"attempting to replace {:?} with {:?}\", rval, value);\n-        if let Err(e) = self.ecx.const_validate_operand(\n-            value,\n-            vec![],\n-            // FIXME: is ref tracking too expensive?\n-            // FIXME: what is the point of ref tracking if we do not even check the tracked refs?\n-            &mut interpret::RefTracking::empty(),\n-            CtfeValidationMode::Regular,\n-        ) {\n-            trace!(\"validation error, attempt failed: {:?}\", e);\n-            return;\n-        }\n-\n         // FIXME> figure out what to do when read_immediate_raw fails\n         let imm = self.ecx.read_immediate_raw(value).ok();\n "}]}