{"sha": "4d1b5f0d997b567b558a3fb88bd4724ba6e32f32", "node_id": "C_kwDOAAsO6NoAKDRkMWI1ZjBkOTk3YjU2N2I1NThhM2ZiODhiZDQ3MjRiYTZlMzJmMzI", "commit": {"author": {"name": "Takayuki Maeda", "email": "takoyaki0316@gmail.com", "date": "2022-08-15T15:16:14Z"}, "committer": {"name": "Takayuki Maeda", "email": "takoyaki0316@gmail.com", "date": "2022-08-15T15:16:14Z"}, "message": "suggest adding an array length if possible", "tree": {"sha": "bb031ce4e221b32d848292a51ca79c00209b93cd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bb031ce4e221b32d848292a51ca79c00209b93cd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32", "html_url": "https://github.com/rust-lang/rust/commit/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/comments", "author": {"login": "TaKO8Ki", "id": 41065217, "node_id": "MDQ6VXNlcjQxMDY1MjE3", "avatar_url": "https://avatars.githubusercontent.com/u/41065217?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TaKO8Ki", "html_url": "https://github.com/TaKO8Ki", "followers_url": "https://api.github.com/users/TaKO8Ki/followers", "following_url": "https://api.github.com/users/TaKO8Ki/following{/other_user}", "gists_url": "https://api.github.com/users/TaKO8Ki/gists{/gist_id}", "starred_url": "https://api.github.com/users/TaKO8Ki/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TaKO8Ki/subscriptions", "organizations_url": "https://api.github.com/users/TaKO8Ki/orgs", "repos_url": "https://api.github.com/users/TaKO8Ki/repos", "events_url": "https://api.github.com/users/TaKO8Ki/events{/privacy}", "received_events_url": "https://api.github.com/users/TaKO8Ki/received_events", "type": "User", "site_admin": false}, "committer": {"login": "TaKO8Ki", "id": 41065217, "node_id": "MDQ6VXNlcjQxMDY1MjE3", "avatar_url": "https://avatars.githubusercontent.com/u/41065217?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TaKO8Ki", "html_url": "https://github.com/TaKO8Ki", "followers_url": "https://api.github.com/users/TaKO8Ki/followers", "following_url": "https://api.github.com/users/TaKO8Ki/following{/other_user}", "gists_url": "https://api.github.com/users/TaKO8Ki/gists{/gist_id}", "starred_url": "https://api.github.com/users/TaKO8Ki/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TaKO8Ki/subscriptions", "organizations_url": "https://api.github.com/users/TaKO8Ki/orgs", "repos_url": "https://api.github.com/users/TaKO8Ki/repos", "events_url": "https://api.github.com/users/TaKO8Ki/events{/privacy}", "received_events_url": "https://api.github.com/users/TaKO8Ki/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0068b8bf4b150b506ef0871be4e8652fd4308f84", "url": "https://api.github.com/repos/rust-lang/rust/commits/0068b8bf4b150b506ef0871be4e8652fd4308f84", "html_url": "https://github.com/rust-lang/rust/commit/0068b8bf4b150b506ef0871be4e8652fd4308f84"}], "stats": {"total": 176, "additions": 152, "deletions": 24}, "files": [{"sha": "bf9034850c9834fcc23c0f94257885a6348aae5f", "filename": "compiler/rustc_ast_lowering/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs?ref=4d1b5f0d997b567b558a3fb88bd4724ba6e32f32", "patch": "@@ -49,7 +49,7 @@ use rustc_data_structures::fx::FxHashMap;\n use rustc_data_structures::sorted_map::SortedMap;\n use rustc_data_structures::stable_hasher::{HashStable, StableHasher};\n use rustc_data_structures::sync::Lrc;\n-use rustc_errors::{struct_span_err, Applicability, Handler};\n+use rustc_errors::{struct_span_err, Applicability, Handler, StashKey};\n use rustc_hir as hir;\n use rustc_hir::def::{DefKind, LifetimeRes, Namespace, PartialRes, PerNS, Res};\n use rustc_hir::def_id::{LocalDefId, CRATE_DEF_ID};\n@@ -2236,7 +2236,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n                         c.value.span,\n                         \"using `_` for array lengths is unstable\",\n                     )\n-                    .emit();\n+                    .stash(c.value.span, StashKey::UnderscoreForArrayLengths);\n                     hir::ArrayLen::Body(self.lower_anon_const(c))\n                 }\n             }"}, {"sha": "4d4d44580b748e398ea68fbbcba95d9ab1148353", "filename": "compiler/rustc_errors/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/compiler%2Frustc_errors%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/compiler%2Frustc_errors%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Flib.rs?ref=4d1b5f0d997b567b558a3fb88bd4724ba6e32f32", "patch": "@@ -457,6 +457,7 @@ struct HandlerInner {\n #[derive(Copy, Clone, PartialEq, Eq, PartialOrd, Ord, Hash, Debug)]\n pub enum StashKey {\n     ItemNoType,\n+    UnderscoreForArrayLengths,\n }\n \n fn default_track_diagnostic(_: &Diagnostic) {}"}, {"sha": "34cc5be8ad5469f3c7047ce2bc9aed4e24286f1f", "filename": "compiler/rustc_typeck/src/check/expr.rs", "status": "modified", "additions": 38, "deletions": 3, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs?ref=4d1b5f0d997b567b558a3fb88bd4724ba6e32f32", "patch": "@@ -28,7 +28,7 @@ use rustc_data_structures::fx::FxHashMap;\n use rustc_data_structures::stack::ensure_sufficient_stack;\n use rustc_errors::{\n     pluralize, struct_span_err, Applicability, Diagnostic, DiagnosticBuilder, DiagnosticId,\n-    ErrorGuaranteed,\n+    ErrorGuaranteed, StashKey,\n };\n use rustc_hir as hir;\n use rustc_hir::def::{CtorKind, DefKind, Res};\n@@ -1307,7 +1307,39 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 span: expr.span,\n             })\n         };\n-        self.tcx.mk_array(element_ty, args.len() as u64)\n+        let array_len = args.len() as u64;\n+        self.suggest_array_len(expr, array_len);\n+        self.tcx.mk_array(element_ty, array_len)\n+    }\n+\n+    fn suggest_array_len(&self, expr: &'tcx hir::Expr<'tcx>, array_len: u64) {\n+        if let Some(parent_hir_id) = self.tcx.hir().find_parent_node(expr.hir_id) {\n+            let ty = match self.tcx.hir().find(parent_hir_id) {\n+                Some(\n+                    hir::Node::Local(hir::Local { ty: Some(ty), .. })\n+                    | hir::Node::Item(hir::Item { kind: hir::ItemKind::Const(ty, _), .. }),\n+                ) => Some(ty),\n+                _ => None,\n+            };\n+            if let Some(ty) = ty\n+                && let hir::TyKind::Array(_, length) = ty.kind\n+                && let hir::ArrayLen::Body(hir::AnonConst { hir_id, .. }) = length\n+                && let Some(span) = self.tcx.hir().opt_span(hir_id)\n+            {\n+                match self.tcx.sess.diagnostic().steal_diagnostic(span, StashKey::UnderscoreForArrayLengths) {\n+                    Some(mut err) => {\n+                        err.span_suggestion_verbose(\n+                            span,\n+                            \"consider adding an array length\",\n+                            array_len,\n+                            Applicability::MaybeIncorrect,\n+                        );\n+                        err.emit();\n+                    }\n+                    None => ()\n+                }\n+            }\n+        }\n     }\n \n     fn check_expr_const_block(\n@@ -1333,10 +1365,13 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         element: &'tcx hir::Expr<'tcx>,\n         count: &'tcx hir::ArrayLen,\n         expected: Expectation<'tcx>,\n-        _expr: &'tcx hir::Expr<'tcx>,\n+        expr: &'tcx hir::Expr<'tcx>,\n     ) -> Ty<'tcx> {\n         let tcx = self.tcx;\n         let count = self.array_length_to_const(count);\n+        if let Some(count) = count.try_eval_usize(tcx, self.param_env) {\n+            self.suggest_array_len(expr, count);\n+        }\n \n         let uty = match expected {\n             ExpectHasType(uty) => match *uty.kind() {"}, {"sha": "bae3ab74af676db8da8f3786edeff26580e41a3a", "filename": "src/test/ui/array-slice-vec/suggest-array-length.fixed", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/src%2Ftest%2Fui%2Farray-slice-vec%2Fsuggest-array-length.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/src%2Ftest%2Fui%2Farray-slice-vec%2Fsuggest-array-length.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Farray-slice-vec%2Fsuggest-array-length.fixed?ref=4d1b5f0d997b567b558a3fb88bd4724ba6e32f32", "patch": "@@ -0,0 +1,14 @@\n+// run-rustfix\n+#![allow(unused_variables, dead_code, non_upper_case_globals)]\n+\n+fn main() {\n+    const Foo: [i32; 3] = [1, 2, 3];\n+    //~^ ERROR in expressions, `_` can only be used on the left-hand side of an assignment\n+    //~| ERROR using `_` for array lengths is unstable\n+    let foo: [i32; 3] = [1, 2, 3];\n+    //~^ ERROR in expressions, `_` can only be used on the left-hand side of an assignment\n+    //~| ERROR using `_` for array lengths is unstable\n+    let bar: [i32; 3] = [0; 3];\n+    //~^ ERROR in expressions, `_` can only be used on the left-hand side of an assignment\n+    //~| ERROR using `_` for array lengths is unstable\n+}"}, {"sha": "b0867f4e39676f033b83cf0f984629c5fe3ea72b", "filename": "src/test/ui/array-slice-vec/suggest-array-length.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/src%2Ftest%2Fui%2Farray-slice-vec%2Fsuggest-array-length.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/src%2Ftest%2Fui%2Farray-slice-vec%2Fsuggest-array-length.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Farray-slice-vec%2Fsuggest-array-length.rs?ref=4d1b5f0d997b567b558a3fb88bd4724ba6e32f32", "patch": "@@ -0,0 +1,14 @@\n+// run-rustfix\n+#![allow(unused_variables, dead_code, non_upper_case_globals)]\n+\n+fn main() {\n+    const Foo: [i32; _] = [1, 2, 3];\n+    //~^ ERROR in expressions, `_` can only be used on the left-hand side of an assignment\n+    //~| ERROR using `_` for array lengths is unstable\n+    let foo: [i32; _] = [1, 2, 3];\n+    //~^ ERROR in expressions, `_` can only be used on the left-hand side of an assignment\n+    //~| ERROR using `_` for array lengths is unstable\n+    let bar: [i32; _] = [0; 3];\n+    //~^ ERROR in expressions, `_` can only be used on the left-hand side of an assignment\n+    //~| ERROR using `_` for array lengths is unstable\n+}"}, {"sha": "fdf6f82649af6d9d4acfbc149238017146c6ba82", "filename": "src/test/ui/array-slice-vec/suggest-array-length.stderr", "status": "added", "additions": 60, "deletions": 0, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/src%2Ftest%2Fui%2Farray-slice-vec%2Fsuggest-array-length.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/src%2Ftest%2Fui%2Farray-slice-vec%2Fsuggest-array-length.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Farray-slice-vec%2Fsuggest-array-length.stderr?ref=4d1b5f0d997b567b558a3fb88bd4724ba6e32f32", "patch": "@@ -0,0 +1,60 @@\n+error: in expressions, `_` can only be used on the left-hand side of an assignment\n+  --> $DIR/suggest-array-length.rs:8:20\n+   |\n+LL |     let foo: [i32; _] = [1, 2, 3];\n+   |                    ^ `_` not allowed here\n+\n+error: in expressions, `_` can only be used on the left-hand side of an assignment\n+  --> $DIR/suggest-array-length.rs:11:20\n+   |\n+LL |     let bar: [i32; _] = [0; 3];\n+   |                    ^ `_` not allowed here\n+\n+error: in expressions, `_` can only be used on the left-hand side of an assignment\n+  --> $DIR/suggest-array-length.rs:5:22\n+   |\n+LL |     const Foo: [i32; _] = [1, 2, 3];\n+   |                      ^ `_` not allowed here\n+\n+error[E0658]: using `_` for array lengths is unstable\n+  --> $DIR/suggest-array-length.rs:5:22\n+   |\n+LL |     const Foo: [i32; _] = [1, 2, 3];\n+   |                      ^\n+   |\n+   = note: see issue #85077 <https://github.com/rust-lang/rust/issues/85077> for more information\n+   = help: add `#![feature(generic_arg_infer)]` to the crate attributes to enable\n+help: consider adding an array length\n+   |\n+LL |     const Foo: [i32; 3] = [1, 2, 3];\n+   |                      ~\n+\n+error[E0658]: using `_` for array lengths is unstable\n+  --> $DIR/suggest-array-length.rs:8:20\n+   |\n+LL |     let foo: [i32; _] = [1, 2, 3];\n+   |                    ^\n+   |\n+   = note: see issue #85077 <https://github.com/rust-lang/rust/issues/85077> for more information\n+   = help: add `#![feature(generic_arg_infer)]` to the crate attributes to enable\n+help: consider adding an array length\n+   |\n+LL |     let foo: [i32; 3] = [1, 2, 3];\n+   |                    ~\n+\n+error[E0658]: using `_` for array lengths is unstable\n+  --> $DIR/suggest-array-length.rs:11:20\n+   |\n+LL |     let bar: [i32; _] = [0; 3];\n+   |                    ^\n+   |\n+   = note: see issue #85077 <https://github.com/rust-lang/rust/issues/85077> for more information\n+   = help: add `#![feature(generic_arg_infer)]` to the crate attributes to enable\n+help: consider adding an array length\n+   |\n+LL |     let bar: [i32; 3] = [0; 3];\n+   |                    ~\n+\n+error: aborting due to 6 previous errors\n+\n+For more information about this error, try `rustc --explain E0658`."}, {"sha": "29aebb719d66f506e61e68bb13c871be8456263e", "filename": "src/test/ui/async-await/issues/issue-95307.stderr", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-95307.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-95307.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-95307.stderr?ref=4d1b5f0d997b567b558a3fb88bd4724ba6e32f32", "patch": "@@ -9,6 +9,12 @@ LL |     async fn new() -> [u8; _];\n    = note: `async` trait functions are not currently supported\n    = note: consider using the `async-trait` crate: https://crates.io/crates/async-trait\n \n+error: in expressions, `_` can only be used on the left-hand side of an assignment\n+  --> $DIR/issue-95307.rs:7:28\n+   |\n+LL |     async fn new() -> [u8; _];\n+   |                            ^ `_` not allowed here\n+\n error[E0658]: using `_` for array lengths is unstable\n   --> $DIR/issue-95307.rs:7:28\n    |\n@@ -18,12 +24,6 @@ LL |     async fn new() -> [u8; _];\n    = note: see issue #85077 <https://github.com/rust-lang/rust/issues/85077> for more information\n    = help: add `#![feature(generic_arg_infer)]` to the crate attributes to enable\n \n-error: in expressions, `_` can only be used on the left-hand side of an assignment\n-  --> $DIR/issue-95307.rs:7:28\n-   |\n-LL |     async fn new() -> [u8; _];\n-   |                            ^ `_` not allowed here\n-\n error: aborting due to 3 previous errors\n \n Some errors have detailed explanations: E0658, E0706."}, {"sha": "4fca436827e8cb7ee9991a526c14f97f293640ba", "filename": "src/test/ui/feature-gates/feature-gate-generic_arg_infer.normal.stderr", "status": "modified", "additions": 17, "deletions": 13, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-generic_arg_infer.normal.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4d1b5f0d997b567b558a3fb88bd4724ba6e32f32/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-generic_arg_infer.normal.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-generic_arg_infer.normal.stderr?ref=4d1b5f0d997b567b558a3fb88bd4724ba6e32f32", "patch": "@@ -1,17 +1,14 @@\n-error[E0658]: using `_` for array lengths is unstable\n+error: in expressions, `_` can only be used on the left-hand side of an assignment\n   --> $DIR/feature-gate-generic_arg_infer.rs:11:27\n    |\n LL |     let _x: [u8; 3] = [0; _];\n-   |                           ^\n-   |\n-   = note: see issue #85077 <https://github.com/rust-lang/rust/issues/85077> for more information\n-   = help: add `#![feature(generic_arg_infer)]` to the crate attributes to enable\n+   |                           ^ `_` not allowed here\n \n error: in expressions, `_` can only be used on the left-hand side of an assignment\n-  --> $DIR/feature-gate-generic_arg_infer.rs:11:27\n+  --> $DIR/feature-gate-generic_arg_infer.rs:14:18\n    |\n-LL |     let _x: [u8; 3] = [0; _];\n-   |                           ^ `_` not allowed here\n+LL |     let _y: [u8; _] = [0; 3];\n+   |                  ^ `_` not allowed here\n \n error[E0658]: using `_` for array lengths is unstable\n   --> $DIR/feature-gate-generic_arg_infer.rs:14:18\n@@ -21,12 +18,10 @@ LL |     let _y: [u8; _] = [0; 3];\n    |\n    = note: see issue #85077 <https://github.com/rust-lang/rust/issues/85077> for more information\n    = help: add `#![feature(generic_arg_infer)]` to the crate attributes to enable\n-\n-error: in expressions, `_` can only be used on the left-hand side of an assignment\n-  --> $DIR/feature-gate-generic_arg_infer.rs:14:18\n+help: consider adding an array length\n    |\n-LL |     let _y: [u8; _] = [0; 3];\n-   |                  ^ `_` not allowed here\n+LL |     let _y: [u8; 3] = [0; 3];\n+   |                  ~\n \n error[E0747]: type provided when a constant was expected\n   --> $DIR/feature-gate-generic_arg_infer.rs:20:20\n@@ -37,6 +32,15 @@ LL |     let _x = foo::<_>([1,2]);\n    = help: const arguments cannot yet be inferred with `_`\n    = help: add `#![feature(generic_arg_infer)]` to the crate attributes to enable\n \n+error[E0658]: using `_` for array lengths is unstable\n+  --> $DIR/feature-gate-generic_arg_infer.rs:11:27\n+   |\n+LL |     let _x: [u8; 3] = [0; _];\n+   |                           ^\n+   |\n+   = note: see issue #85077 <https://github.com/rust-lang/rust/issues/85077> for more information\n+   = help: add `#![feature(generic_arg_infer)]` to the crate attributes to enable\n+\n error: aborting due to 5 previous errors\n \n Some errors have detailed explanations: E0658, E0747."}]}