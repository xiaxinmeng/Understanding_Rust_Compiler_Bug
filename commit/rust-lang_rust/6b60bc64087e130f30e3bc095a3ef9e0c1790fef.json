{"sha": "6b60bc64087e130f30e3bc095a3ef9e0c1790fef", "node_id": "C_kwDOAAsO6NoAKDZiNjBiYzY0MDg3ZTEzMGYzMGUzYmMwOTVhM2VmOWUwYzE3OTBmZWY", "commit": {"author": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-07-01T00:28:29Z"}, "committer": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-07-05T18:12:18Z"}, "message": "rustdoc: improve scroll locking in the rustdoc mobile sidebars\n\nThis commit ports the scroll locking behavior from the source sidebar to the\nregular sidebar, and also fixes some bad behavior where opening a \"mobile\"\nsidebar, and growing the viewport so that the \"desktop\" mode without scroll\nlocking is activated, could potentially leave the page stuck.\n\nThis does not affect the behavior on larger screens. Only small ones, where\nthe sidebar covers up the main content.", "tree": {"sha": "ca86c2f236a54f09a0ba7b69e07bd4db608d5be8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ca86c2f236a54f09a0ba7b69e07bd4db608d5be8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6b60bc64087e130f30e3bc095a3ef9e0c1790fef", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6b60bc64087e130f30e3bc095a3ef9e0c1790fef", "html_url": "https://github.com/rust-lang/rust/commit/6b60bc64087e130f30e3bc095a3ef9e0c1790fef", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6b60bc64087e130f30e3bc095a3ef9e0c1790fef/comments", "author": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "54f79babae06d3772c067f696e5b12db822ae25f", "url": "https://api.github.com/repos/rust-lang/rust/commits/54f79babae06d3772c067f696e5b12db822ae25f", "html_url": "https://github.com/rust-lang/rust/commit/54f79babae06d3772c067f696e5b12db822ae25f"}], "stats": {"total": 108, "additions": 101, "deletions": 7}, "files": [{"sha": "045dfe313dfe480a1cfa396cfb5deca90cb4d872", "filename": "src/librustdoc/html/static/js/main.js", "status": "modified", "additions": 42, "deletions": 4, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/6b60bc64087e130f30e3bc095a3ef9e0c1790fef/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/6b60bc64087e130f30e3bc095a3ef9e0c1790fef/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js?ref=6b60bc64087e130f30e3bc095a3ef9e0c1790fef", "patch": "@@ -348,8 +348,7 @@ function loadCss(cssFileName) {\n \n     function onHashChange(ev) {\n         // If we're in mobile mode, we should hide the sidebar in any case.\n-        const sidebar = document.getElementsByClassName(\"sidebar\")[0];\n-        removeClass(sidebar, \"shown\");\n+        hideSidebar();\n         handleHashes(ev);\n     }\n \n@@ -731,11 +730,50 @@ function loadCss(cssFileName) {\n         });\n     }());\n \n+    let oldSidebarScrollPosition = null;\n+\n+    function showSidebar() {\n+        if (window.innerWidth < window.RUSTDOC_MOBILE_BREAKPOINT) {\n+            // This is to keep the scroll position on mobile.\n+            oldSidebarScrollPosition = window.scrollY;\n+            document.body.style.width = `${document.body.offsetWidth}px`;\n+            document.body.style.position = \"fixed\";\n+            document.body.style.top = `-${oldSidebarScrollPosition}px`;\n+            document.querySelector(\".mobile-topbar\").style.top = `${oldSidebarScrollPosition}px`;\n+            document.querySelector(\".mobile-topbar\").style.position = \"relative\";\n+        } else {\n+            oldSidebarScrollPosition = null;\n+        }\n+        const sidebar = document.getElementsByClassName(\"sidebar\")[0];\n+        addClass(sidebar, \"shown\");\n+    }\n+\n     function hideSidebar() {\n+        if (oldSidebarScrollPosition !== null) {\n+            // This is to keep the scroll position on mobile.\n+            document.body.style.width = \"\";\n+            document.body.style.position = \"\";\n+            document.body.style.top = \"\";\n+            document.querySelector(\".mobile-topbar\").style.top = \"\";\n+            document.querySelector(\".mobile-topbar\").style.position = \"\";\n+            // The scroll position is lost when resetting the style, hence why we store it in\n+            // `oldSidebarScrollPosition`.\n+            window.scrollTo(0, oldSidebarScrollPosition);\n+            oldSidebarScrollPosition = null;\n+        }\n         const sidebar = document.getElementsByClassName(\"sidebar\")[0];\n         removeClass(sidebar, \"shown\");\n     }\n \n+    window.addEventListener(\"resize\", () => {\n+        if (window.innerWidth >= window.RUSTDOC_MOBILE_BREAKPOINT &&\n+            oldSidebarScrollPosition !== null) {\n+            // If the user opens the sidebar in \"mobile\" mode, and then grows the browser window,\n+            // we need to switch away from mobile mode and make the main content area scrollable.\n+            hideSidebar();\n+        }\n+    });\n+\n     function handleClick(id, f) {\n         const elem = document.getElementById(id);\n         if (elem) {\n@@ -778,9 +816,9 @@ function loadCss(cssFileName) {\n         sidebar_menu_toggle.addEventListener(\"click\", () => {\n             const sidebar = document.getElementsByClassName(\"sidebar\")[0];\n             if (!hasClass(sidebar, \"shown\")) {\n-                addClass(sidebar, \"shown\");\n+                showSidebar();\n             } else {\n-                removeClass(sidebar, \"shown\");\n+                hideSidebar();\n             }\n         });\n     }"}, {"sha": "c5bfc00c78b06efb388d0b51897e34afefd37318", "filename": "src/librustdoc/html/static/js/source-script.js", "status": "modified", "additions": 17, "deletions": 3, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/6b60bc64087e130f30e3bc095a3ef9e0c1790fef/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "raw_url": "https://github.com/rust-lang/rust/raw/6b60bc64087e130f30e3bc095a3ef9e0c1790fef/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js?ref=6b60bc64087e130f30e3bc095a3ef9e0c1790fef", "patch": "@@ -10,7 +10,7 @@\n (function() {\n \n const rootPath = document.getElementById(\"rustdoc-vars\").attributes[\"data-root-path\"].value;\n-let oldScrollPosition = 0;\n+let oldScrollPosition = null;\n \n function closeSidebarIfMobile() {\n     if (window.innerWidth < window.RUSTDOC_MOBILE_BREAKPOINT) {\n@@ -71,25 +71,39 @@ function toggleSidebar() {\n             oldScrollPosition = window.scrollY;\n             document.body.style.position = \"fixed\";\n             document.body.style.top = `-${oldScrollPosition}px`;\n+        } else {\n+            oldScrollPosition = null;\n         }\n         addClass(document.documentElement, \"source-sidebar-expanded\");\n         child.innerText = \"<\";\n         updateLocalStorage(\"source-sidebar-show\", \"true\");\n     } else {\n-        if (window.innerWidth < window.RUSTDOC_MOBILE_BREAKPOINT) {\n+        if (window.innerWidth < window.RUSTDOC_MOBILE_BREAKPOINT && oldScrollPosition !== null) {\n             // This is to keep the scroll position on mobile.\n             document.body.style.position = \"\";\n             document.body.style.top = \"\";\n             // The scroll position is lost when resetting the style, hence why we store it in\n-            // `oldScroll`.\n+            // `oldScrollPosition`.\n             window.scrollTo(0, oldScrollPosition);\n+            oldScrollPosition = null;\n         }\n         removeClass(document.documentElement, \"source-sidebar-expanded\");\n         child.innerText = \">\";\n         updateLocalStorage(\"source-sidebar-show\", \"false\");\n     }\n }\n \n+window.addEventListener(\"resize\", () => {\n+    if (window.innerWidth >= window.RUSTDOC_MOBILE_BREAKPOINT && oldScrollPosition !== null) {\n+        // If the user opens the sidebar in \"mobile\" mode, and then grows the browser window,\n+        // we need to switch away from mobile mode and make the main content area scrollable.\n+        document.body.style.position = \"\";\n+        document.body.style.top = \"\";\n+        window.scrollTo(0, oldScrollPosition);\n+        oldScrollPosition = null;\n+    }\n+});\n+\n function createSidebarToggle() {\n     const sidebarToggle = document.createElement(\"div\");\n     sidebarToggle.id = \"sidebar-toggle\";"}, {"sha": "b3bcea253388f0c00c955d9907c1d13f792aaf81", "filename": "src/test/rustdoc-gui/sidebar-mobile-scroll.goml", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/6b60bc64087e130f30e3bc095a3ef9e0c1790fef/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile-scroll.goml", "raw_url": "https://github.com/rust-lang/rust/raw/6b60bc64087e130f30e3bc095a3ef9e0c1790fef/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile-scroll.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile-scroll.goml?ref=6b60bc64087e130f30e3bc095a3ef9e0c1790fef", "patch": "@@ -0,0 +1,31 @@\n+// This test ensures that the mobile sidebar preserves scroll position.\n+goto: file://|DOC_PATH|/test_docs/struct.Foo.html\n+// Switching to \"mobile view\" by reducing the width to 600px.\n+size: (600, 600)\n+assert-css: (\".sidebar\", {\"display\": \"block\", \"left\": \"-1000px\"})\n+\n+// Scroll down.\n+scroll-to: \"//h2[@id='blanket-implementations']\"\n+assert-window-property: {\"pageYOffset\": \"702\"}\n+\n+// Open the sidebar menu.\n+click: \".sidebar-menu-toggle\"\n+wait-for-css: (\".sidebar\", {\"left\": \"0px\"})\n+\n+// We are no longer \"scrolled\". It's important that the user can't\n+// scroll the body at all, but these test scripts are run only in Chrome,\n+// and we need to use a more complicated solution to this problem because\n+// of Mobile Safari...\n+assert-window-property: {\"pageYOffset\": \"0\"}\n+\n+// Close the sidebar menu. Make sure the scroll position gets restored.\n+click: \".sidebar-menu-toggle\"\n+wait-for-css: (\".sidebar\", {\"left\": \"-1000px\"})\n+assert-window-property: {\"pageYOffset\": \"702\"}\n+\n+// Now test that scrollability returns when the browser window is just resized.\n+click: \".sidebar-menu-toggle\"\n+wait-for-css: (\".sidebar\", {\"left\": \"0px\"})\n+assert-window-property: {\"pageYOffset\": \"0\"}\n+size: (900, 900)\n+assert-window-property: {\"pageYOffset\": \"702\"}"}, {"sha": "e4662a10ed5da5c4c5c5789eda530d7cf808489a", "filename": "src/test/rustdoc-gui/sidebar-source-code-display.goml", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/6b60bc64087e130f30e3bc095a3ef9e0c1790fef/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code-display.goml", "raw_url": "https://github.com/rust-lang/rust/raw/6b60bc64087e130f30e3bc095a3ef9e0c1790fef/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code-display.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code-display.goml?ref=6b60bc64087e130f30e3bc095a3ef9e0c1790fef", "patch": "@@ -233,6 +233,17 @@ wait-for-css: (\".sidebar\", {\"width\": \"0px\"})\n // The \"scrollTop\" property should be the same.\n assert-window-property: {\"pageYOffset\": \"2519\"}\n \n+// We now check that the scroll position is restored if the window is resized.\n+size: (500, 700)\n+click: \"#sidebar-toggle\"\n+wait-for-css: (\"#source-sidebar\", {\"visibility\": \"visible\"})\n+assert-window-property: {\"pageYOffset\": \"0\"}\n+size: (900, 900)\n+assert-window-property: {\"pageYOffset\": \"2519\"}\n+size: (500, 700)\n+click: \"#sidebar-toggle\"\n+wait-for-css: (\"#source-sidebar\", {\"visibility\": \"hidden\"})\n+\n // We now check that opening the sidebar and clicking a link will close it.\n // The behavior here on mobile is different than the behavior on desktop,\n // but common sense dictates that if you have a list of files that fills the entire screen, and"}]}