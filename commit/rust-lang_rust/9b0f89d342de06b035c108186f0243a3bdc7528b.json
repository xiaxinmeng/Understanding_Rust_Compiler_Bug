{"sha": "9b0f89d342de06b035c108186f0243a3bdc7528b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjliMGY4OWQzNDJkZTA2YjAzNWMxMDgxODZmMDI0M2EzYmRjNzUyOGI=", "commit": {"author": {"name": "Jakub Wieczorek", "email": "jakub@jakub.cc", "date": "2014-08-17T13:30:59Z"}, "committer": {"name": "Jakub Wieczorek", "email": "jakub@jakub.cc", "date": "2014-08-17T19:34:01Z"}, "message": "Fix type checking of struct fields in patterns of type ty_err\n\nFixes #16338.\nFixed #16401.", "tree": {"sha": "825ac71953aac4ce80986cdf7f9a47ffcb731100", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/825ac71953aac4ce80986cdf7f9a47ffcb731100"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9b0f89d342de06b035c108186f0243a3bdc7528b", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9b0f89d342de06b035c108186f0243a3bdc7528b", "html_url": "https://github.com/rust-lang/rust/commit/9b0f89d342de06b035c108186f0243a3bdc7528b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9b0f89d342de06b035c108186f0243a3bdc7528b/comments", "author": null, "committer": null, "parents": [{"sha": "a12a4ddcfabb80d6224960f19d6043f88f47d1e6", "url": "https://api.github.com/repos/rust-lang/rust/commits/a12a4ddcfabb80d6224960f19d6043f88f47d1e6", "html_url": "https://github.com/rust-lang/rust/commit/a12a4ddcfabb80d6224960f19d6043f88f47d1e6"}], "stats": {"total": 56, "additions": 43, "deletions": 13}, "files": [{"sha": "ff49aa8a40b0387fc37fa1870644e3e42f1d6b29", "filename": "src/librustc/middle/typeck/check/_match.rs", "status": "modified", "additions": 7, "deletions": 13, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/9b0f89d342de06b035c108186f0243a3bdc7528b/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2F_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b0f89d342de06b035c108186f0243a3bdc7528b/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2F_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2F_match.rs?ref=9b0f89d342de06b035c108186f0243a3bdc7528b", "patch": "@@ -355,8 +355,7 @@ pub fn check_struct_pat_fields(pcx: &pat_ctxt,\n     }\n }\n \n-pub fn check_struct_pat(pcx: &pat_ctxt, _pat_id: ast::NodeId, span: Span,\n-                        _expected: ty::t, _path: &ast::Path,\n+pub fn check_struct_pat(pcx: &pat_ctxt, span: Span,\n                         fields: &[ast::FieldPat], etc: bool,\n                         struct_id: ast::DefId,\n                         substitutions: &subst::Substs) {\n@@ -529,8 +528,7 @@ pub fn check_pat(pcx: &pat_ctxt, pat: &ast::Pat, expected: ty::t) {\n                     },\n                 }\n \n-                check_struct_pat(pcx, pat.id, pat.span, expected, path,\n-                                 fields.as_slice(), etc, cid, substs);\n+                check_struct_pat(pcx, pat.span, fields.as_slice(), etc, cid, substs);\n             }\n             ty::ty_enum(eid, ref substs) => {\n                 check_struct_like_enum_variant_pat(pcx,\n@@ -557,15 +555,11 @@ pub fn check_pat(pcx: &pat_ctxt, pat: &ast::Pat, expected: ty::t) {\n                             None);\n                 match tcx.def_map.borrow().find(&pat.id) {\n                     Some(def) => {\n-                         check_struct_pat(pcx,\n-                                          pat.id,\n-                                          pat.span,\n-                                          ty::mk_err(),\n-                                          path,\n-                                          fields.as_slice(),\n-                                          etc,\n-                                          def.def_id(),\n-                                          &subst::Substs::empty());\n+                        let item_type = ty::lookup_item_type(tcx, def.def_id());\n+                        let substitutions = fcx.infcx().fresh_substs_for_type(\n+                            pat.span, &item_type.generics);\n+                        check_struct_pat(pcx, pat.span, fields.as_slice(),\n+                                         etc, def.def_id(), &substitutions);\n                     }\n                     None => {\n                         tcx.sess.span_bug(pat.span,"}, {"sha": "db0a0487687a8623463848bbfaa0bfb8816ccb98", "filename": "src/test/compile-fail/issue-16338.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/9b0f89d342de06b035c108186f0243a3bdc7528b/src%2Ftest%2Fcompile-fail%2Fissue-16338.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b0f89d342de06b035c108186f0243a3bdc7528b/src%2Ftest%2Fcompile-fail%2Fissue-16338.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-16338.rs?ref=9b0f89d342de06b035c108186f0243a3bdc7528b", "patch": "@@ -0,0 +1,17 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+use std::raw::Slice;\n+\n+fn main() {\n+    let Slice { data: data, len: len } = \"foo\";\n+    //~^ ERROR mismatched types: expected `&'static str` but found a structure pattern\n+}\n+"}, {"sha": "79a824bbf69215872dabfcae9b990a1b22403af7", "filename": "src/test/compile-fail/issue-16401.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/9b0f89d342de06b035c108186f0243a3bdc7528b/src%2Ftest%2Fcompile-fail%2Fissue-16401.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b0f89d342de06b035c108186f0243a3bdc7528b/src%2Ftest%2Fcompile-fail%2Fissue-16401.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-16401.rs?ref=9b0f89d342de06b035c108186f0243a3bdc7528b", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+use std::raw::Slice;\n+\n+fn main() {\n+    match () {\n+        Slice { data: data, len: len } => (),\n+        //~^ ERROR mismatched types: expected `()` but found a structure pattern\n+        _ => unreachable!()\n+    }\n+}"}]}