{"sha": "1a9d20b4305bf17c76e1c1b1b16781ddefe44222", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFhOWQyMGI0MzA1YmYxN2M3NmUxYzFiMWIxNjc4MWRkZWZlNDQyMjI=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2021-02-12T10:32:18Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-02-12T10:32:18Z"}, "message": "Rollup merge of #82004 - GuillaumeGomez:clean-static-struct, r=jyn514\n\nclean up clean::Static struct\n\nHaving a `String` for the expression didn't make much sense, and even less when it's actually not used (except in json so I kept it).\n\nr? ``@jyn514``", "tree": {"sha": "a2f5a1b05ce1ed9b70b10528349d9e65c2418e00", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a2f5a1b05ce1ed9b70b10528349d9e65c2418e00"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1a9d20b4305bf17c76e1c1b1b16781ddefe44222", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgJlkzCRBK7hj4Ov3rIwAAdHIIAEDr2KDOMMj5UwX5vgalvm1c\nJLzzAvu/DAlFPnYKWDxcOutFwQoFglzWnz+BWWd31sHWX/8b2o8XfESciShFIdnx\nqPAc96IJqeHD8emoZ3WkCPNd4QQGph1Q7Sm70KpTS5Cgk+dePue3TymLXdkjuh3F\n1AaumfpLN0Gn796X6qespufXf/9Vs3wCmD4wSFDnt58DuwzWcMbIHdIJlv6YneBt\nlJm+ryI+vfpcyq6Fp8NI2ynq5GT0r0lLcTKxxVo/Uyb8zsjiKt7dess3gByIyyCG\n7SPUvntdXugWpvV9qEoK++8Er2V9hOxYVne8aqX3Xa2arjD3cOq31Zz6J0nEHcM=\n=wtQ0\n-----END PGP SIGNATURE-----\n", "payload": "tree a2f5a1b05ce1ed9b70b10528349d9e65c2418e00\nparent 55539cbdc0611b9f8ee3c80521276fe7dc01644c\nparent 583563d86d88c1ab39c271d640d29a6c2a17a2dd\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1613125938 +0900\ncommitter GitHub <noreply@github.com> 1613125938 +0900\n\nRollup merge of #82004 - GuillaumeGomez:clean-static-struct, r=jyn514\n\nclean up clean::Static struct\n\nHaving a `String` for the expression didn't make much sense, and even less when it's actually not used (except in json so I kept it).\n\nr? ``@jyn514``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1a9d20b4305bf17c76e1c1b1b16781ddefe44222", "html_url": "https://github.com/rust-lang/rust/commit/1a9d20b4305bf17c76e1c1b1b16781ddefe44222", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1a9d20b4305bf17c76e1c1b1b16781ddefe44222/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "55539cbdc0611b9f8ee3c80521276fe7dc01644c", "url": "https://api.github.com/repos/rust-lang/rust/commits/55539cbdc0611b9f8ee3c80521276fe7dc01644c", "html_url": "https://github.com/rust-lang/rust/commit/55539cbdc0611b9f8ee3c80521276fe7dc01644c"}, {"sha": "583563d86d88c1ab39c271d640d29a6c2a17a2dd", "url": "https://api.github.com/repos/rust-lang/rust/commits/583563d86d88c1ab39c271d640d29a6c2a17a2dd", "html_url": "https://github.com/rust-lang/rust/commit/583563d86d88c1ab39c271d640d29a6c2a17a2dd"}], "stats": {"total": 134, "additions": 63, "deletions": 71}, "files": [{"sha": "cacca542284d96285b28e93ba34f79af1ad2d0dc", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1a9d20b4305bf17c76e1c1b1b16781ddefe44222/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a9d20b4305bf17c76e1c1b1b16781ddefe44222/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=1a9d20b4305bf17c76e1c1b1b16781ddefe44222", "patch": "@@ -510,7 +510,7 @@ fn build_static(cx: &DocContext<'_>, did: DefId, mutable: bool) -> clean::Static\n     clean::Static {\n         type_: cx.tcx.type_of(did).clean(cx),\n         mutability: if mutable { Mutability::Mut } else { Mutability::Not },\n-        expr: \"\\n\\n\\n\".to_string(), // trigger the \"[definition]\" links\n+        expr: None,\n     }\n }\n "}, {"sha": "a0ab6ed4a4c8834578e5bfd4c51cfdc022479568", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 10, "deletions": 14, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/1a9d20b4305bf17c76e1c1b1b16781ddefe44222/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a9d20b4305bf17c76e1c1b1b16781ddefe44222/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=1a9d20b4305bf17c76e1c1b1b16781ddefe44222", "patch": "@@ -408,7 +408,7 @@ impl Clean<Constant> for hir::ConstArg {\n                 .tcx\n                 .type_of(cx.tcx.hir().body_owner_def_id(self.value.body).to_def_id())\n                 .clean(cx),\n-            expr: print_const_expr(cx, self.value.body),\n+            expr: print_const_expr(cx.tcx, self.value.body),\n             value: None,\n             is_literal: is_literal_expr(cx, self.value.body.hir_id),\n         }\n@@ -1052,7 +1052,7 @@ impl Clean<Item> for hir::TraitItem<'_> {\n         cx.with_param_env(local_did, || {\n             let inner = match self.kind {\n                 hir::TraitItemKind::Const(ref ty, default) => {\n-                    AssocConstItem(ty.clean(cx), default.map(|e| print_const_expr(cx, e)))\n+                    AssocConstItem(ty.clean(cx), default.map(|e| print_const_expr(cx.tcx, e)))\n                 }\n                 hir::TraitItemKind::Fn(ref sig, hir::TraitFn::Provided(body)) => {\n                     let mut m = (sig, &self.generics, body).clean(cx);\n@@ -1093,7 +1093,7 @@ impl Clean<Item> for hir::ImplItem<'_> {\n         cx.with_param_env(local_did, || {\n             let inner = match self.kind {\n                 hir::ImplItemKind::Const(ref ty, expr) => {\n-                    AssocConstItem(ty.clean(cx), Some(print_const_expr(cx, expr)))\n+                    AssocConstItem(ty.clean(cx), Some(print_const_expr(cx.tcx, expr)))\n                 }\n                 hir::ImplItemKind::Fn(ref sig, body) => {\n                     let mut m = (sig, &self.generics, body).clean(cx);\n@@ -1954,14 +1954,12 @@ impl Clean<Vec<Item>> for (&hir::Item<'_>, Option<Symbol>) {\n         let mut name = renamed.unwrap_or_else(|| cx.tcx.hir().name(item.hir_id));\n         cx.with_param_env(def_id, || {\n             let kind = match item.kind {\n-                ItemKind::Static(ty, mutability, body_id) => StaticItem(Static {\n-                    type_: ty.clean(cx),\n-                    mutability,\n-                    expr: print_const_expr(cx, body_id),\n-                }),\n+                ItemKind::Static(ty, mutability, body_id) => {\n+                    StaticItem(Static { type_: ty.clean(cx), mutability, expr: Some(body_id) })\n+                }\n                 ItemKind::Const(ty, body_id) => ConstantItem(Constant {\n                     type_: ty.clean(cx),\n-                    expr: print_const_expr(cx, body_id),\n+                    expr: print_const_expr(cx.tcx, body_id),\n                     value: print_evaluated_const(cx, def_id),\n                     is_literal: is_literal_expr(cx, body_id.hir_id),\n                 }),\n@@ -2263,11 +2261,9 @@ impl Clean<Item> for (&hir::ForeignItem<'_>, Option<Symbol>) {\n                         },\n                     })\n                 }\n-                hir::ForeignItemKind::Static(ref ty, mutability) => ForeignStaticItem(Static {\n-                    type_: ty.clean(cx),\n-                    mutability,\n-                    expr: String::new(),\n-                }),\n+                hir::ForeignItemKind::Static(ref ty, mutability) => {\n+                    ForeignStaticItem(Static { type_: ty.clean(cx), mutability, expr: None })\n+                }\n                 hir::ForeignItemKind::Type => ForeignTypeItem,\n             };\n "}, {"sha": "9b8e04a1d239de7ffb9eca4ffebeba921ad4fce2", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/1a9d20b4305bf17c76e1c1b1b16781ddefe44222/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a9d20b4305bf17c76e1c1b1b16781ddefe44222/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=1a9d20b4305bf17c76e1c1b1b16781ddefe44222", "patch": "@@ -19,7 +19,7 @@ use rustc_hir as hir;\n use rustc_hir::def::{CtorKind, Res};\n use rustc_hir::def_id::{CrateNum, DefId, DefIndex};\n use rustc_hir::lang_items::LangItem;\n-use rustc_hir::Mutability;\n+use rustc_hir::{BodyId, Mutability};\n use rustc_index::vec::IndexVec;\n use rustc_middle::ty::{self, TyCtxt};\n use rustc_session::Session;\n@@ -1955,10 +1955,7 @@ crate struct BareFunctionDecl {\n crate struct Static {\n     crate type_: Type,\n     crate mutability: Mutability,\n-    /// It's useful to have the value of a static documented, but I have no\n-    /// desire to represent expressions (that'd basically be all of the AST,\n-    /// which is huge!). So, have a string.\n-    crate expr: String,\n+    crate expr: Option<BodyId>,\n }\n \n #[derive(Clone, PartialEq, Eq, Hash, Debug)]"}, {"sha": "59af49b0d8a283426d1f9bdf9d032d1e36e48d91", "filename": "src/librustdoc/clean/utils.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1a9d20b4305bf17c76e1c1b1b16781ddefe44222/src%2Flibrustdoc%2Fclean%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a9d20b4305bf17c76e1c1b1b16781ddefe44222/src%2Flibrustdoc%2Fclean%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Futils.rs?ref=1a9d20b4305bf17c76e1c1b1b16781ddefe44222", "patch": "@@ -304,7 +304,7 @@ crate fn print_const(cx: &DocContext<'_>, n: &'tcx ty::Const<'_>) -> String {\n         ty::ConstKind::Unevaluated(def, _, promoted) => {\n             let mut s = if let Some(def) = def.as_local() {\n                 let hir_id = cx.tcx.hir().local_def_id_to_hir_id(def.did);\n-                print_const_expr(cx, cx.tcx.hir().body_owned_by(hir_id))\n+                print_const_expr(cx.tcx, cx.tcx.hir().body_owned_by(hir_id))\n             } else {\n                 inline::print_inlined_const(cx, def.did)\n             };\n@@ -393,16 +393,17 @@ crate fn is_literal_expr(cx: &DocContext<'_>, hir_id: hir::HirId) -> bool {\n     false\n }\n \n-crate fn print_const_expr(cx: &DocContext<'_>, body: hir::BodyId) -> String {\n-    let value = &cx.tcx.hir().body(body).value;\n+crate fn print_const_expr(tcx: TyCtxt<'_>, body: hir::BodyId) -> String {\n+    let hir = tcx.hir();\n+    let value = &hir.body(body).value;\n \n     let snippet = if !value.span.from_expansion() {\n-        cx.sess().source_map().span_to_snippet(value.span).ok()\n+        tcx.sess.source_map().span_to_snippet(value.span).ok()\n     } else {\n         None\n     };\n \n-    snippet.unwrap_or_else(|| rustc_hir_pretty::id_to_string(&cx.tcx.hir(), body.hir_id))\n+    snippet.unwrap_or_else(|| rustc_hir_pretty::id_to_string(&hir, body.hir_id))\n }\n \n /// Given a type Path, resolve it to a Type using the TyCtxt"}, {"sha": "f96f6d52088a4c74413fc0ad4242a1a021c8753e", "filename": "src/librustdoc/json/conversions.rs", "status": "modified", "additions": 44, "deletions": 46, "changes": 90, "blob_url": "https://github.com/rust-lang/rust/blob/1a9d20b4305bf17c76e1c1b1b16781ddefe44222/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a9d20b4305bf17c76e1c1b1b16781ddefe44222/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson%2Fconversions.rs?ref=1a9d20b4305bf17c76e1c1b1b16781ddefe44222", "patch": "@@ -6,12 +6,14 @@ use std::convert::From;\n \n use rustc_ast::ast;\n use rustc_hir::def::CtorKind;\n+use rustc_middle::ty::TyCtxt;\n use rustc_span::def_id::{DefId, CRATE_DEF_INDEX};\n use rustc_span::Pos;\n \n use rustdoc_json_types::*;\n \n use crate::clean;\n+use crate::clean::utils::print_const_expr;\n use crate::formats::item_type::ItemType;\n use crate::json::JsonRenderer;\n \n@@ -43,7 +45,7 @@ impl JsonRenderer<'_> {\n                     .collect(),\n                 deprecation: deprecation.map(from_deprecation),\n                 kind: item_type.into(),\n-                inner: kind.into(),\n+                inner: from_clean_item_kind(kind, self.tcx),\n             }),\n         }\n     }\n@@ -144,44 +146,42 @@ crate fn from_def_id(did: DefId) -> Id {\n     Id(format!(\"{}:{}\", did.krate.as_u32(), u32::from(did.index)))\n }\n \n-impl From<clean::ItemKind> for ItemEnum {\n-    fn from(item: clean::ItemKind) -> Self {\n-        use clean::ItemKind::*;\n-        match item {\n-            ModuleItem(m) => ItemEnum::ModuleItem(m.into()),\n-            ExternCrateItem(c, a) => {\n-                ItemEnum::ExternCrateItem { name: c.to_string(), rename: a.map(|x| x.to_string()) }\n-            }\n-            ImportItem(i) => ItemEnum::ImportItem(i.into()),\n-            StructItem(s) => ItemEnum::StructItem(s.into()),\n-            UnionItem(u) => ItemEnum::UnionItem(u.into()),\n-            StructFieldItem(f) => ItemEnum::StructFieldItem(f.into()),\n-            EnumItem(e) => ItemEnum::EnumItem(e.into()),\n-            VariantItem(v) => ItemEnum::VariantItem(v.into()),\n-            FunctionItem(f) => ItemEnum::FunctionItem(f.into()),\n-            ForeignFunctionItem(f) => ItemEnum::FunctionItem(f.into()),\n-            TraitItem(t) => ItemEnum::TraitItem(t.into()),\n-            TraitAliasItem(t) => ItemEnum::TraitAliasItem(t.into()),\n-            MethodItem(m, _) => ItemEnum::MethodItem(from_function_method(m, true)),\n-            TyMethodItem(m) => ItemEnum::MethodItem(from_function_method(m, false)),\n-            ImplItem(i) => ItemEnum::ImplItem(i.into()),\n-            StaticItem(s) => ItemEnum::StaticItem(s.into()),\n-            ForeignStaticItem(s) => ItemEnum::StaticItem(s.into()),\n-            ForeignTypeItem => ItemEnum::ForeignTypeItem,\n-            TypedefItem(t, _) => ItemEnum::TypedefItem(t.into()),\n-            OpaqueTyItem(t) => ItemEnum::OpaqueTyItem(t.into()),\n-            ConstantItem(c) => ItemEnum::ConstantItem(c.into()),\n-            MacroItem(m) => ItemEnum::MacroItem(m.source),\n-            ProcMacroItem(m) => ItemEnum::ProcMacroItem(m.into()),\n-            AssocConstItem(t, s) => ItemEnum::AssocConstItem { type_: t.into(), default: s },\n-            AssocTypeItem(g, t) => ItemEnum::AssocTypeItem {\n-                bounds: g.into_iter().map(Into::into).collect(),\n-                default: t.map(Into::into),\n-            },\n-            StrippedItem(inner) => (*inner).into(),\n-            PrimitiveItem(_) | KeywordItem(_) => {\n-                panic!(\"{:?} is not supported for JSON output\", item)\n-            }\n+fn from_clean_item_kind(item: clean::ItemKind, tcx: TyCtxt<'_>) -> ItemEnum {\n+    use clean::ItemKind::*;\n+    match item {\n+        ModuleItem(m) => ItemEnum::ModuleItem(m.into()),\n+        ExternCrateItem(c, a) => {\n+            ItemEnum::ExternCrateItem { name: c.to_string(), rename: a.map(|x| x.to_string()) }\n+        }\n+        ImportItem(i) => ItemEnum::ImportItem(i.into()),\n+        StructItem(s) => ItemEnum::StructItem(s.into()),\n+        UnionItem(u) => ItemEnum::UnionItem(u.into()),\n+        StructFieldItem(f) => ItemEnum::StructFieldItem(f.into()),\n+        EnumItem(e) => ItemEnum::EnumItem(e.into()),\n+        VariantItem(v) => ItemEnum::VariantItem(v.into()),\n+        FunctionItem(f) => ItemEnum::FunctionItem(f.into()),\n+        ForeignFunctionItem(f) => ItemEnum::FunctionItem(f.into()),\n+        TraitItem(t) => ItemEnum::TraitItem(t.into()),\n+        TraitAliasItem(t) => ItemEnum::TraitAliasItem(t.into()),\n+        MethodItem(m, _) => ItemEnum::MethodItem(from_function_method(m, true)),\n+        TyMethodItem(m) => ItemEnum::MethodItem(from_function_method(m, false)),\n+        ImplItem(i) => ItemEnum::ImplItem(i.into()),\n+        StaticItem(s) => ItemEnum::StaticItem(from_clean_static(s, tcx)),\n+        ForeignStaticItem(s) => ItemEnum::StaticItem(from_clean_static(s, tcx)),\n+        ForeignTypeItem => ItemEnum::ForeignTypeItem,\n+        TypedefItem(t, _) => ItemEnum::TypedefItem(t.into()),\n+        OpaqueTyItem(t) => ItemEnum::OpaqueTyItem(t.into()),\n+        ConstantItem(c) => ItemEnum::ConstantItem(c.into()),\n+        MacroItem(m) => ItemEnum::MacroItem(m.source),\n+        ProcMacroItem(m) => ItemEnum::ProcMacroItem(m.into()),\n+        AssocConstItem(t, s) => ItemEnum::AssocConstItem { type_: t.into(), default: s },\n+        AssocTypeItem(g, t) => ItemEnum::AssocTypeItem {\n+            bounds: g.into_iter().map(Into::into).collect(),\n+            default: t.map(Into::into),\n+        },\n+        StrippedItem(inner) => from_clean_item_kind(*inner, tcx).into(),\n+        PrimitiveItem(_) | KeywordItem(_) => {\n+            panic!(\"{:?} is not supported for JSON output\", item)\n         }\n     }\n }\n@@ -535,13 +535,11 @@ impl From<clean::OpaqueTy> for OpaqueTy {\n     }\n }\n \n-impl From<clean::Static> for Static {\n-    fn from(stat: clean::Static) -> Self {\n-        Static {\n-            type_: stat.type_.into(),\n-            mutable: stat.mutability == ast::Mutability::Mut,\n-            expr: stat.expr,\n-        }\n+fn from_clean_static(stat: clean::Static, tcx: TyCtxt<'_>) -> Static {\n+    Static {\n+        type_: stat.type_.into(),\n+        mutable: stat.mutability == ast::Mutability::Mut,\n+        expr: stat.expr.map(|e| print_const_expr(tcx, e)).unwrap_or_default(),\n     }\n }\n "}]}