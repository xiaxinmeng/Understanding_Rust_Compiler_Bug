{"sha": "dd816a9c2e88b3e55c24991e356a9d13d683c545", "node_id": "C_kwDOAAsO6NoAKGRkODE2YTljMmU4OGIzZTU1YzI0OTkxZTM1NmE5ZDEzZDY4M2M1NDU", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-08-09T13:39:58Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-08-09T13:49:30Z"}, "message": "Prevent impl blocks containing only private items to be documented by default", "tree": {"sha": "6ba690ac79b59ae74bd8c2dfaba57ae20d88c8b0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6ba690ac79b59ae74bd8c2dfaba57ae20d88c8b0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dd816a9c2e88b3e55c24991e356a9d13d683c545", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dd816a9c2e88b3e55c24991e356a9d13d683c545", "html_url": "https://github.com/rust-lang/rust/commit/dd816a9c2e88b3e55c24991e356a9d13d683c545", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dd816a9c2e88b3e55c24991e356a9d13d683c545/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5af97e8b0b9649ed14b0b4528a610ff841b6365e", "url": "https://api.github.com/repos/rust-lang/rust/commits/5af97e8b0b9649ed14b0b4528a610ff841b6365e", "html_url": "https://github.com/rust-lang/rust/commit/5af97e8b0b9649ed14b0b4528a610ff841b6365e"}], "stats": {"total": 71, "additions": 54, "deletions": 17}, "files": [{"sha": "9914edf3036e431ba5bedd089b32b3b4cfb6b4e8", "filename": "src/librustdoc/passes/strip_hidden.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/dd816a9c2e88b3e55c24991e356a9d13d683c545/src%2Flibrustdoc%2Fpasses%2Fstrip_hidden.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd816a9c2e88b3e55c24991e356a9d13d683c545/src%2Flibrustdoc%2Fpasses%2Fstrip_hidden.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fstrip_hidden.rs?ref=dd816a9c2e88b3e55c24991e356a9d13d683c545", "patch": "@@ -17,6 +17,7 @@ pub(crate) const STRIP_HIDDEN: Pass = Pass {\n /// Strip items marked `#[doc(hidden)]`\n pub(crate) fn strip_hidden(krate: clean::Crate, cx: &mut DocContext<'_>) -> clean::Crate {\n     let mut retained = ItemIdSet::default();\n+    let is_json_output = cx.output_format.is_json() && !cx.show_coverage;\n \n     // strip all #[doc(hidden)] items\n     let krate = {\n@@ -25,7 +26,12 @@ pub(crate) fn strip_hidden(krate: clean::Crate, cx: &mut DocContext<'_>) -> clea\n     };\n \n     // strip all impls referencing stripped items\n-    let mut stripper = ImplStripper { retained: &retained, cache: &cx.cache };\n+    let mut stripper = ImplStripper {\n+        retained: &retained,\n+        cache: &cx.cache,\n+        is_json_output,\n+        document_private: cx.render_options.document_private,\n+    };\n     stripper.fold_crate(krate)\n }\n "}, {"sha": "f3aa3c7ce2459d4ac5b4fbc676d65d80e51a213c", "filename": "src/librustdoc/passes/strip_private.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/dd816a9c2e88b3e55c24991e356a9d13d683c545/src%2Flibrustdoc%2Fpasses%2Fstrip_private.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd816a9c2e88b3e55c24991e356a9d13d683c545/src%2Flibrustdoc%2Fpasses%2Fstrip_private.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fstrip_private.rs?ref=dd816a9c2e88b3e55c24991e356a9d13d683c545", "patch": "@@ -17,19 +17,25 @@ pub(crate) const STRIP_PRIVATE: Pass = Pass {\n pub(crate) fn strip_private(mut krate: clean::Crate, cx: &mut DocContext<'_>) -> clean::Crate {\n     // This stripper collects all *retained* nodes.\n     let mut retained = ItemIdSet::default();\n+    let is_json_output = cx.output_format.is_json() && !cx.show_coverage;\n \n     // strip all private items\n     {\n         let mut stripper = Stripper {\n             retained: &mut retained,\n             access_levels: &cx.cache.access_levels,\n             update_retained: true,\n-            is_json_output: cx.output_format.is_json() && !cx.show_coverage,\n+            is_json_output,\n         };\n         krate = ImportStripper.fold_crate(stripper.fold_crate(krate));\n     }\n \n     // strip all impls referencing private items\n-    let mut stripper = ImplStripper { retained: &retained, cache: &cx.cache };\n+    let mut stripper = ImplStripper {\n+        retained: &retained,\n+        cache: &cx.cache,\n+        is_json_output,\n+        document_private: cx.render_options.document_private,\n+    };\n     stripper.fold_crate(krate)\n }"}, {"sha": "3f069e8393f7e9667bfea7a05834ea86f21e0ee8", "filename": "src/librustdoc/passes/stripper.rs", "status": "modified", "additions": 39, "deletions": 14, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/dd816a9c2e88b3e55c24991e356a9d13d683c545/src%2Flibrustdoc%2Fpasses%2Fstripper.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd816a9c2e88b3e55c24991e356a9d13d683c545/src%2Flibrustdoc%2Fpasses%2Fstripper.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fstripper.rs?ref=dd816a9c2e88b3e55c24991e356a9d13d683c545", "patch": "@@ -14,17 +14,19 @@ pub(crate) struct Stripper<'a> {\n     pub(crate) is_json_output: bool,\n }\n \n-impl<'a> Stripper<'a> {\n-    // We need to handle this differently for the JSON output because some non exported items could\n-    // be used in public API. And so, we need these items as well. `is_exported` only checks if they\n-    // are in the public API, which is not enough.\n-    #[inline]\n-    fn is_item_reachable(&self, item_id: ItemId) -> bool {\n-        if self.is_json_output {\n-            self.access_levels.is_reachable(item_id.expect_def_id())\n-        } else {\n-            self.access_levels.is_exported(item_id.expect_def_id())\n-        }\n+// We need to handle this differently for the JSON output because some non exported items could\n+// be used in public API. And so, we need these items as well. `is_exported` only checks if they\n+// are in the public API, which is not enough.\n+#[inline]\n+fn is_item_reachable(\n+    is_json_output: bool,\n+    access_levels: &AccessLevels<DefId>,\n+    item_id: ItemId,\n+) -> bool {\n+    if is_json_output {\n+        access_levels.is_reachable(item_id.expect_def_id())\n+    } else {\n+        access_levels.is_exported(item_id.expect_def_id())\n     }\n }\n \n@@ -61,7 +63,9 @@ impl<'a> DocFolder for Stripper<'a> {\n             | clean::MacroItem(..)\n             | clean::ForeignTypeItem => {\n                 let item_id = i.item_id;\n-                if item_id.is_local() && !self.is_item_reachable(item_id) {\n+                if item_id.is_local()\n+                    && !is_item_reachable(self.is_json_output, self.access_levels, item_id)\n+                {\n                     debug!(\"Stripper: stripping {:?} {:?}\", i.type_(), i.name);\n                     return None;\n                 }\n@@ -133,15 +137,36 @@ impl<'a> DocFolder for Stripper<'a> {\n pub(crate) struct ImplStripper<'a> {\n     pub(crate) retained: &'a ItemIdSet,\n     pub(crate) cache: &'a Cache,\n+    pub(crate) is_json_output: bool,\n+    pub(crate) document_private: bool,\n }\n \n impl<'a> DocFolder for ImplStripper<'a> {\n     fn fold_item(&mut self, i: Item) -> Option<Item> {\n         if let clean::ImplItem(ref imp) = *i.kind {\n             // Impl blocks can be skipped if they are: empty; not a trait impl; and have no\n             // documentation.\n-            if imp.trait_.is_none() && imp.items.is_empty() && i.doc_value().is_none() {\n-                return None;\n+            //\n+            // There is one special case: if the impl block contains only private items.\n+            if imp.trait_.is_none() {\n+                // If the only items present are private ones and we're not rendering private items,\n+                // we don't document it.\n+                if !imp.items.is_empty()\n+                    && !self.document_private\n+                    && imp.items.iter().all(|i| {\n+                        let item_id = i.item_id;\n+                        item_id.is_local()\n+                            && !is_item_reachable(\n+                                self.is_json_output,\n+                                &self.cache.access_levels,\n+                                item_id,\n+                            )\n+                    })\n+                {\n+                    return None;\n+                } else if imp.items.is_empty() && i.doc_value().is_none() {\n+                    return None;\n+                }\n             }\n             if let Some(did) = imp.for_.def_id(self.cache) {\n                 if did.is_local() && !imp.for_.is_assoc_ty() && !self.retained.contains(&did.into())"}]}