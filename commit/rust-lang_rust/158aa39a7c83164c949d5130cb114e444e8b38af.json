{"sha": "158aa39a7c83164c949d5130cb114e444e8b38af", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE1OGFhMzlhN2M4MzE2NGM5NDlkNTEzMGNiMTE0ZTQ0NGU4YjM4YWY=", "commit": {"author": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2019-04-19T13:18:32Z"}, "committer": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2019-04-19T13:18:32Z"}, "message": "Allow allowing of toplevel_ref_arg lint\n\nI'm not sure why some lints need the `HirId` to be able to recognize the\nlint level attributes, but this commit makes the lint level attributes\nwork for `toplevel_ref_arg`.", "tree": {"sha": "c2f8f91ca62f330be9ff00a26bc2eefea33d11bd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c2f8f91ca62f330be9ff00a26bc2eefea33d11bd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/158aa39a7c83164c949d5130cb114e444e8b38af", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJEBAABCgAuFiEEj4U0bmbiMSg/mWqvgqphyqETl+YFAly5zH0QHGRldkBwaGFu\nc2NoLm5ldAAKCRCCqmHKoROX5sLaD/0VYWHKfg3C+SAl81acMm3j+svQagYrMc7Y\nx0dLh1ZkHHYVIuazJvuP6E5DoADvhGVEO3dze+Ljt7lpQeyDpMiPvix+DCW/pO6Q\nUzazDYeSVm+BYwtzGqkAFGoo0TulyFoWIb+dzwcv+ft8/VC4iTIvne9OoD31g+Qe\nP0Us3K/QA1hPHKb/fCcucoylc8B4Vloe7daqMXK1y7LSRD4RVXpN8PEaaClbQo32\nkUylqiIpRJWkB5hUEjS9tQ7pPCOTFxn1/iDSwrZG4MYepMCbhD42ztqg8DIZabNf\nV6WJCPBt6sb2tEX0SzP4Ix2eJScLOlkE8NM+4QV0t9PaIla2SqRKUcjahUdYC06Z\nhwFhwVnvFMG0VeO2B3RuaCoBhuMUSE2/QzOkzPNK47Q9mwARv4nk7N0tXR5YGVKj\n+RWwEYmTXBYUMZbnmThr9xIEAP44N2cHPjN7fX/rsJ/YW/X2tE4RCMajP0ZV0jvY\nqb3pB6gkmg0RWgbQfXb5C1oApvf/yaXPALlF9SjHGoG3ttn1mCiAg6eHBxojqYc6\nZfdQwbqMQIIN1iInyTiaOaxxi1hHPWYH9Gc0pphf9bBPfh0XtBJ31Wg0iZLyCfTZ\nFmG5orIALb+GjLbVv1nZ1S6tCnU0/0TneqocKjbZFZwEnLdFYFInR+CBVdPNw2mE\nrUSLHor+cw==\n=uEBj\n-----END PGP SIGNATURE-----", "payload": "tree c2f8f91ca62f330be9ff00a26bc2eefea33d11bd\nparent 0d9ef393b8c2596aca6a037d3efb513afdf17875\nauthor Philipp Hansch <dev@phansch.net> 1555679912 +0200\ncommitter Philipp Hansch <dev@phansch.net> 1555679912 +0200\n\nAllow allowing of toplevel_ref_arg lint\n\nI'm not sure why some lints need the `HirId` to be able to recognize the\nlint level attributes, but this commit makes the lint level attributes\nwork for `toplevel_ref_arg`.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/158aa39a7c83164c949d5130cb114e444e8b38af", "html_url": "https://github.com/rust-lang/rust/commit/158aa39a7c83164c949d5130cb114e444e8b38af", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/158aa39a7c83164c949d5130cb114e444e8b38af/comments", "author": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0d9ef393b8c2596aca6a037d3efb513afdf17875", "url": "https://api.github.com/repos/rust-lang/rust/commits/0d9ef393b8c2596aca6a037d3efb513afdf17875", "html_url": "https://github.com/rust-lang/rust/commit/0d9ef393b8c2596aca6a037d3efb513afdf17875"}], "stats": {"total": 17, "additions": 11, "deletions": 6}, "files": [{"sha": "6e41249ea6488e04aff575125225fe899095746b", "filename": "clippy_lints/src/misc.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/158aa39a7c83164c949d5130cb114e444e8b38af/clippy_lints%2Fsrc%2Fmisc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/158aa39a7c83164c949d5130cb114e444e8b38af/clippy_lints%2Fsrc%2Fmisc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmisc.rs?ref=158aa39a7c83164c949d5130cb114e444e8b38af", "patch": "@@ -13,8 +13,8 @@ use crate::consts::{constant, Constant};\n use crate::utils::sugg::Sugg;\n use crate::utils::{\n     get_item_name, get_parent_expr, implements_trait, in_constant, in_macro, is_integer_literal, iter_input_pats,\n-    last_path_segment, match_qpath, match_trait_method, paths, snippet, span_lint, span_lint_and_then, walk_ptrs_ty,\n-    SpanlessEq,\n+    last_path_segment, match_qpath, match_trait_method, paths, snippet, span_lint, span_lint_and_then,\n+    span_lint_hir_and_then, walk_ptrs_ty, SpanlessEq,\n };\n \n declare_clippy_lint! {\n@@ -282,19 +282,20 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for MiscLints {\n             if let Some(ref init) = l.init;\n             then {\n                 if an == BindingAnnotation::Ref || an == BindingAnnotation::RefMut {\n-                    let init = Sugg::hir(cx, init, \"..\");\n+                    let sugg_init = Sugg::hir(cx, init, \"..\");\n                     let (mutopt,initref) = if an == BindingAnnotation::RefMut {\n-                        (\"mut \", init.mut_addr())\n+                        (\"mut \", sugg_init.mut_addr())\n                     } else {\n-                        (\"\", init.addr())\n+                        (\"\", sugg_init.addr())\n                     };\n                     let tyopt = if let Some(ref ty) = l.ty {\n                         format!(\": &{mutopt}{ty}\", mutopt=mutopt, ty=snippet(cx, ty.span, \"_\"))\n                     } else {\n                         String::new()\n                     };\n-                    span_lint_and_then(cx,\n+                    span_lint_hir_and_then(cx,\n                         TOPLEVEL_REF_ARG,\n+                        init.hir_id,\n                         l.pat.span,\n                         \"`ref` on an entire `let` pattern is discouraged, take a reference with `&` instead\",\n                         |db| {"}, {"sha": "a412c387a0dd0814f32a7af1986cf49baa7185c0", "filename": "tests/ui/toplevel_ref_arg.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/158aa39a7c83164c949d5130cb114e444e8b38af/tests%2Fui%2Ftoplevel_ref_arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/158aa39a7c83164c949d5130cb114e444e8b38af/tests%2Fui%2Ftoplevel_ref_arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftoplevel_ref_arg.rs?ref=158aa39a7c83164c949d5130cb114e444e8b38af", "patch": "@@ -22,4 +22,8 @@ fn main() {\n \n     let (ref x, _) = (1, 2); // ok, not top level\n     println!(\"The answer is {}.\", x);\n+\n+    // Make sure that allowing the lint works\n+    #[allow(clippy::toplevel_ref_arg)]\n+    let ref mut x = 1_234_543;\n }"}]}