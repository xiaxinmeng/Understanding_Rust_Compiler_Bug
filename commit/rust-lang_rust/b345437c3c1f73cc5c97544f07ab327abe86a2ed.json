{"sha": "b345437c3c1f73cc5c97544f07ab327abe86a2ed", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIzNDU0MzdjM2MxZjczY2M1Yzk3NTQ0ZjA3YWIzMjdhYmU4NmEyZWQ=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-07-24T05:19:12Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-07-29T01:23:09Z"}, "message": "rustc: Add a --cap-lints flag to the compiler\n\nThis commit is an implementation of [RFC 1193][rfc] which adds the ability to\nthe compiler to cap the lint level for the entire compilation session. This flag\nwill ensure that no lints will go above this level, and Cargo will primarily use\nthis flag passing `--cap-lints allow` to all upstream dependencies.\n\n[rfc]: https://github.com/rust-lang/rfcs/pull/1193\n\nCloses #27259", "tree": {"sha": "cf193a65e365760ce0da47f02e264823ce6325f8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cf193a65e365760ce0da47f02e264823ce6325f8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b345437c3c1f73cc5c97544f07ab327abe86a2ed", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b345437c3c1f73cc5c97544f07ab327abe86a2ed", "html_url": "https://github.com/rust-lang/rust/commit/b345437c3c1f73cc5c97544f07ab327abe86a2ed", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b345437c3c1f73cc5c97544f07ab327abe86a2ed/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c85ba3e9cb4620c6ec8273a34cce6707e91778cb", "url": "https://api.github.com/repos/rust-lang/rust/commits/c85ba3e9cb4620c6ec8273a34cce6707e91778cb", "html_url": "https://github.com/rust-lang/rust/commit/c85ba3e9cb4620c6ec8273a34cce6707e91778cb"}], "stats": {"total": 98, "additions": 97, "deletions": 1}, "files": [{"sha": "40ee023b7e86110c0ce68ba2a3d3c391c20805ee", "filename": "src/librustc/lint/context.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/b345437c3c1f73cc5c97544f07ab327abe86a2ed/src%2Flibrustc%2Flint%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b345437c3c1f73cc5c97544f07ab327abe86a2ed/src%2Flibrustc%2Flint%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fcontext.rs?ref=b345437c3c1f73cc5c97544f07ab327abe86a2ed", "patch": "@@ -34,6 +34,7 @@ use lint::builtin;\n use util::nodemap::FnvHashMap;\n \n use std::cell::RefCell;\n+use std::cmp;\n use std::mem;\n use syntax::ast_util::IdVisitingOperation;\n use syntax::attr::AttrMetaMethods;\n@@ -66,6 +67,9 @@ pub struct LintStore {\n     /// Map of registered lint groups to what lints they expand to. The bool\n     /// is true if the lint group was added by a plugin.\n     lint_groups: FnvHashMap<&'static str, (Vec<LintId>, bool)>,\n+\n+    /// Maximum level a lint can be\n+    lint_cap: Option<Level>,\n }\n \n /// The targed of the `by_name` map, which accounts for renaming/deprecation.\n@@ -94,7 +98,10 @@ impl LintStore {\n         }\n     }\n \n-    fn set_level(&mut self, lint: LintId, lvlsrc: LevelSource) {\n+    fn set_level(&mut self, lint: LintId, mut lvlsrc: LevelSource) {\n+        if let Some(cap) = self.lint_cap {\n+            lvlsrc.0 = cmp::min(lvlsrc.0, cap);\n+        }\n         if lvlsrc.0 == Allow {\n             self.levels.remove(&lint);\n         } else {\n@@ -109,6 +116,7 @@ impl LintStore {\n             by_name: FnvHashMap(),\n             levels: FnvHashMap(),\n             lint_groups: FnvHashMap(),\n+            lint_cap: None,\n         }\n     }\n \n@@ -227,6 +235,13 @@ impl LintStore {\n                 }\n             }\n         }\n+\n+        self.lint_cap = sess.opts.lint_cap;\n+        if let Some(cap) = self.lint_cap {\n+            for level in self.levels.iter_mut().map(|p| &mut (p.1).0) {\n+                *level = cmp::min(*level, cap);\n+            }\n+        }\n     }\n }\n "}, {"sha": "c14a0595d5ac4ce79df49126f771b6f875a98814", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/b345437c3c1f73cc5c97544f07ab327abe86a2ed/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b345437c3c1f73cc5c97544f07ab327abe86a2ed/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=b345437c3c1f73cc5c97544f07ab327abe86a2ed", "patch": "@@ -84,6 +84,7 @@ pub struct Options {\n     pub debug_assertions: bool,\n     pub debuginfo: DebugInfoLevel,\n     pub lint_opts: Vec<(String, lint::Level)>,\n+    pub lint_cap: Option<lint::Level>,\n     pub describe_lints: bool,\n     pub output_types: Vec<OutputType>,\n     // This was mutable for rustpkg, which updates search paths based on the\n@@ -203,6 +204,7 @@ pub fn basic_options() -> Options {\n         optimize: No,\n         debuginfo: NoDebugInfo,\n         lint_opts: Vec::new(),\n+        lint_cap: None,\n         describe_lints: false,\n         output_types: Vec::new(),\n         search_paths: SearchPaths::new(),\n@@ -792,6 +794,9 @@ pub fn rustc_short_optgroups() -> Vec<RustcOptGroup> {\n         opt::multi(\"A\", \"allow\", \"Set lint allowed\", \"OPT\"),\n         opt::multi(\"D\", \"deny\", \"Set lint denied\", \"OPT\"),\n         opt::multi(\"F\", \"forbid\", \"Set lint forbidden\", \"OPT\"),\n+        opt::multi(\"\", \"cap-lints\", \"Set the most restrictive lint level. \\\n+                                     More restrictive lints are capped at this \\\n+                                     level\", \"LEVEL\"),\n         opt::multi(\"C\", \"codegen\", \"Set a codegen option\", \"OPT[=VALUE]\"),\n         opt::flag(\"V\", \"version\", \"Print version info and exit\"),\n         opt::flag(\"v\", \"verbose\", \"Use verbose output\"),\n@@ -860,6 +865,12 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n         }\n     }\n \n+    let lint_cap = matches.opt_str(\"cap-lints\").map(|cap| {\n+        lint::Level::from_str(&cap).unwrap_or_else(|| {\n+            early_error(&format!(\"unknown lint level: `{}`\", cap))\n+        })\n+    });\n+\n     let debugging_opts = build_debugging_options(matches);\n \n     let parse_only = debugging_opts.parse_only;\n@@ -1023,6 +1034,7 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n         optimize: opt_level,\n         debuginfo: debuginfo,\n         lint_opts: lint_opts,\n+        lint_cap: lint_cap,\n         describe_lints: describe_lints,\n         output_types: output_types,\n         search_paths: search_paths,"}, {"sha": "cb9c347af603c1e42e57170808a54ee94915ea8f", "filename": "src/test/compile-fail/bad-lint-cap.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/b345437c3c1f73cc5c97544f07ab327abe86a2ed/src%2Ftest%2Fcompile-fail%2Fbad-lint-cap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b345437c3c1f73cc5c97544f07ab327abe86a2ed/src%2Ftest%2Fcompile-fail%2Fbad-lint-cap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fbad-lint-cap.rs?ref=b345437c3c1f73cc5c97544f07ab327abe86a2ed", "patch": "@@ -0,0 +1,14 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags: --cap-lints test\n+// error-pattern: unknown lint level: `test`\n+\n+fn main() {}"}, {"sha": "5a97d7b1a79a186ad2a88f136a52f023ed2fc779", "filename": "src/test/compile-fail/bad-lint-cap2.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/b345437c3c1f73cc5c97544f07ab327abe86a2ed/src%2Ftest%2Fcompile-fail%2Fbad-lint-cap2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b345437c3c1f73cc5c97544f07ab327abe86a2ed/src%2Ftest%2Fcompile-fail%2Fbad-lint-cap2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fbad-lint-cap2.rs?ref=b345437c3c1f73cc5c97544f07ab327abe86a2ed", "patch": "@@ -0,0 +1,17 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags: --cap-lints deny\n+\n+#![deny(warnings)]\n+\n+use std::option; //~ ERROR\n+\n+fn main() {}"}, {"sha": "e03ba6ecb6440fd278bd82ddc9084770ab0ff3cb", "filename": "src/test/compile-fail/bad-lint-cap3.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/b345437c3c1f73cc5c97544f07ab327abe86a2ed/src%2Ftest%2Fcompile-fail%2Fbad-lint-cap3.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b345437c3c1f73cc5c97544f07ab327abe86a2ed/src%2Ftest%2Fcompile-fail%2Fbad-lint-cap3.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fbad-lint-cap3.rs?ref=b345437c3c1f73cc5c97544f07ab327abe86a2ed", "patch": "@@ -0,0 +1,20 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags: --cap-lints warn\n+\n+#![deny(warnings)]\n+#![feature(rustc_attrs)]\n+\n+use std::option; //~ WARN\n+\n+#[rustc_error]\n+fn main() {} //~ ERROR: compilation successful\n+"}, {"sha": "003a99f746a59b18f451ca47919dd2bf004edcf9", "filename": "src/test/run-pass/lint-cap.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/b345437c3c1f73cc5c97544f07ab327abe86a2ed/src%2Ftest%2Frun-pass%2Flint-cap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b345437c3c1f73cc5c97544f07ab327abe86a2ed/src%2Ftest%2Frun-pass%2Flint-cap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Flint-cap.rs?ref=b345437c3c1f73cc5c97544f07ab327abe86a2ed", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags: --cap-lints allow\n+\n+#![deny(warnings)]\n+\n+use std::option;\n+\n+fn main() {}\n+"}]}