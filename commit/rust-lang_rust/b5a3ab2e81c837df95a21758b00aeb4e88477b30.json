{"sha": "b5a3ab2e81c837df95a21758b00aeb4e88477b30", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI1YTNhYjJlODFjODM3ZGY5NWEyMTc1OGIwMGFlYjRlODg0NzdiMzA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-11-14T05:30:34Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-11-14T05:30:34Z"}, "message": "Auto merge of #45915 - michaelwoerister:removed-nodes-in-try-mark-green, r=alexcrichton\n\nincr.comp.: Don't crash in DepGraph::try_mark_green() when encountering a removed input node.\n\nFixes a small regression that was introduced in #45867.\n\nr? @nikomatsakis", "tree": {"sha": "8aaf678b9cc3447716d1ea10eefd7884db2d95a6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8aaf678b9cc3447716d1ea10eefd7884db2d95a6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b5a3ab2e81c837df95a21758b00aeb4e88477b30", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b5a3ab2e81c837df95a21758b00aeb4e88477b30", "html_url": "https://github.com/rust-lang/rust/commit/b5a3ab2e81c837df95a21758b00aeb4e88477b30", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b5a3ab2e81c837df95a21758b00aeb4e88477b30/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9b53f0a6620c3451a10573ea5c5a51b4c18088ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/9b53f0a6620c3451a10573ea5c5a51b4c18088ec", "html_url": "https://github.com/rust-lang/rust/commit/9b53f0a6620c3451a10573ea5c5a51b4c18088ec"}, {"sha": "67d2b1b7fd2d0efed9734bcab0f25528b9e37492", "url": "https://api.github.com/repos/rust-lang/rust/commits/67d2b1b7fd2d0efed9734bcab0f25528b9e37492", "html_url": "https://github.com/rust-lang/rust/commit/67d2b1b7fd2d0efed9734bcab0f25528b9e37492"}], "stats": {"total": 65, "additions": 60, "deletions": 5}, "files": [{"sha": "97ac1b256124d1b9337d140e4fbc261c71b42d83", "filename": "src/librustc/dep_graph/graph.rs", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/b5a3ab2e81c837df95a21758b00aeb4e88477b30/src%2Flibrustc%2Fdep_graph%2Fgraph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b5a3ab2e81c837df95a21758b00aeb4e88477b30/src%2Flibrustc%2Fdep_graph%2Fgraph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdep_graph%2Fgraph.rs?ref=b5a3ab2e81c837df95a21758b00aeb4e88477b30", "patch": "@@ -524,14 +524,22 @@ impl DepGraph {\n                             current_deps.push(node_index);\n                             continue;\n                         }\n-                    } else if cfg!(debug_assertions) {\n+                    } else {\n                         match dep_dep_node.kind {\n                             DepKind::Hir |\n                             DepKind::HirBody |\n                             DepKind::CrateMetadata => {\n-                                assert!(dep_dep_node.extract_def_id(tcx).is_none(),\n-                                    \"Input {:?} should have been pre-allocated but wasn't.\",\n-                                    dep_dep_node);\n+                                if dep_node.extract_def_id(tcx).is_none() {\n+                                    // If the node does not exist anymore, we\n+                                    // just fail to mark green.\n+                                    return None\n+                                } else {\n+                                    // If the node does exist, it should have\n+                                    // been pre-allocated.\n+                                    bug!(\"DepNode {:?} should have been \\\n+                                          pre-allocated but wasn't.\",\n+                                          dep_dep_node)\n+                                }\n                             }\n                             _ => {\n                                 // For other kinds of inputs it's OK to be"}, {"sha": "f5e1f384d60ea60dcc9054257fb8984a15608a95", "filename": "src/librustc/ty/maps/plumbing.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b5a3ab2e81c837df95a21758b00aeb4e88477b30/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b5a3ab2e81c837df95a21758b00aeb4e88477b30/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs?ref=b5a3ab2e81c837df95a21758b00aeb4e88477b30", "patch": "@@ -723,7 +723,7 @@ pub fn force_from_dep_node<'a, 'gcx, 'lcx>(tcx: TyCtxt<'a, 'gcx, 'lcx>,\n \n         // This one should never occur in this context\n         DepKind::Null => {\n-            bug!(\"force_from_dep_node() - Encountered {:?}\", dep_node.kind)\n+            bug!(\"force_from_dep_node() - Encountered {:?}\", dep_node)\n         }\n \n         // These are not queries"}, {"sha": "39543cd829d8a878c44dc3e7b98f7d1a23393684", "filename": "src/test/incremental/remove_crate/auxiliary/extern_crate.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/b5a3ab2e81c837df95a21758b00aeb4e88477b30/src%2Ftest%2Fincremental%2Fremove_crate%2Fauxiliary%2Fextern_crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b5a3ab2e81c837df95a21758b00aeb4e88477b30/src%2Ftest%2Fincremental%2Fremove_crate%2Fauxiliary%2Fextern_crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fremove_crate%2Fauxiliary%2Fextern_crate.rs?ref=b5a3ab2e81c837df95a21758b00aeb4e88477b30", "patch": "@@ -0,0 +1,13 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+pub fn foo(_: u8) {\n+\n+}"}, {"sha": "fafcb8bb0c83a22600f090db159e3bf3bb56b4c1", "filename": "src/test/incremental/remove_crate/main.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/b5a3ab2e81c837df95a21758b00aeb4e88477b30/src%2Ftest%2Fincremental%2Fremove_crate%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b5a3ab2e81c837df95a21758b00aeb4e88477b30/src%2Ftest%2Fincremental%2Fremove_crate%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fremove_crate%2Fmain.rs?ref=b5a3ab2e81c837df95a21758b00aeb4e88477b30", "patch": "@@ -0,0 +1,34 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Test that removing an upstream crate does not cause any trouble.\n+\n+// revisions:rpass1 rpass2\n+// aux-build:extern_crate.rs\n+\n+#[cfg(rpass1)]\n+extern crate extern_crate;\n+\n+pub fn main() {\n+    #[cfg(rpass1)]\n+    {\n+        extern_crate::foo(1);\n+    }\n+\n+    #[cfg(rpass2)]\n+    {\n+        foo(1);\n+    }\n+}\n+\n+#[cfg(rpass2)]\n+pub fn foo(_: u8) {\n+\n+}"}]}