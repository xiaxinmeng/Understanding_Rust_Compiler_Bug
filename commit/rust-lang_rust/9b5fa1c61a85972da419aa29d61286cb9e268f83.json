{"sha": "9b5fa1c61a85972da419aa29d61286cb9e268f83", "node_id": "MDY6Q29tbWl0NzI0NzEyOjliNWZhMWM2MWE4NTk3MmRhNDE5YWEyOWQ2MTI4NmNiOWUyNjhmODM=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-01-18T18:25:55Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-01-18T18:39:46Z"}, "message": "Add back jemalloc support", "tree": {"sha": "29704f0e4140261ed68bb5ea3cf52e7385bfc997", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/29704f0e4140261ed68bb5ea3cf52e7385bfc997"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9b5fa1c61a85972da419aa29d61286cb9e268f83", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9b5fa1c61a85972da419aa29d61286cb9e268f83", "html_url": "https://github.com/rust-lang/rust/commit/9b5fa1c61a85972da419aa29d61286cb9e268f83", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9b5fa1c61a85972da419aa29d61286cb9e268f83/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6764d790ac904533dc7618fd38724a135499f87c", "url": "https://api.github.com/repos/rust-lang/rust/commits/6764d790ac904533dc7618fd38724a135499f87c", "html_url": "https://github.com/rust-lang/rust/commit/6764d790ac904533dc7618fd38724a135499f87c"}], "stats": {"total": 98, "additions": 94, "deletions": 4}, "files": [{"sha": "35713a0c49592b4f487b01c4fe6a30d35e290808", "filename": "Cargo.lock", "status": "modified", "additions": 65, "deletions": 0, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/9b5fa1c61a85972da419aa29d61286cb9e268f83/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/9b5fa1c61a85972da419aa29d61286cb9e268f83/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=9b5fa1c61a85972da419aa29d61286cb9e268f83", "patch": "@@ -448,6 +448,12 @@ dependencies = [\n  \"percent-encoding\",\n ]\n \n+[[package]]\n+name = \"fs_extra\"\n+version = \"1.2.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"2022715d62ab30faffd124d40b76f4134a550a87792276512b18d63272333394\"\n+\n [[package]]\n name = \"fsevent\"\n version = \"2.0.2\"\n@@ -757,6 +763,38 @@ version = \"0.4.7\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"dd25036021b0de88a0aff6b850051563c6516d0bf53f8638938edbb9de732736\"\n \n+[[package]]\n+name = \"jemalloc-ctl\"\n+version = \"0.3.3\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"c502a5ff9dd2924f1ed32ba96e3b65735d837b4bfd978d3161b1702e66aca4b7\"\n+dependencies = [\n+ \"jemalloc-sys\",\n+ \"libc\",\n+ \"paste\",\n+]\n+\n+[[package]]\n+name = \"jemalloc-sys\"\n+version = \"0.3.2\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"0d3b9f3f5c9b31aa0f5ed3260385ac205db665baa41d49bb8338008ae94ede45\"\n+dependencies = [\n+ \"cc\",\n+ \"fs_extra\",\n+ \"libc\",\n+]\n+\n+[[package]]\n+name = \"jemallocator\"\n+version = \"0.3.2\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"43ae63fcfc45e99ab3d1b29a46782ad679e98436c3169d15a167a1108a724b69\"\n+dependencies = [\n+ \"jemalloc-sys\",\n+ \"libc\",\n+]\n+\n [[package]]\n name = \"jod-thread\"\n version = \"0.1.2\"\n@@ -1104,6 +1142,25 @@ dependencies = [\n  \"drop_bomb\",\n ]\n \n+[[package]]\n+name = \"paste\"\n+version = \"0.1.18\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"45ca20c77d80be666aef2b45486da86238fabe33e38306bd3118fe4af33fa880\"\n+dependencies = [\n+ \"paste-impl\",\n+ \"proc-macro-hack\",\n+]\n+\n+[[package]]\n+name = \"paste-impl\"\n+version = \"0.1.18\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"d95a7db200b97ef370c8e6de0088252f7e0dfff7d047a28528e47456c0fc98b6\"\n+dependencies = [\n+ \"proc-macro-hack\",\n+]\n+\n [[package]]\n name = \"paths\"\n version = \"0.0.0\"\n@@ -1164,6 +1221,12 @@ version = \"0.2.4\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"439697af366c49a6d0a010c56a0d97685bc140ce0d377b13a2ea2aa42d64a827\"\n \n+[[package]]\n+name = \"proc-macro-hack\"\n+version = \"0.5.19\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"dbf0c48bc1d91375ae5c3cd81e3722dff1abcf81a30960240640d223f59fe0e5\"\n+\n [[package]]\n name = \"proc-macro2\"\n version = \"1.0.24\"\n@@ -1212,6 +1275,7 @@ name = \"profile\"\n version = \"0.0.0\"\n dependencies = [\n  \"cfg-if 1.0.0\",\n+ \"jemalloc-ctl\",\n  \"la-arena\",\n  \"libc\",\n  \"once_cell\",\n@@ -1354,6 +1418,7 @@ dependencies = [\n  \"ide\",\n  \"ide_db\",\n  \"itertools 0.10.0\",\n+ \"jemallocator\",\n  \"jod-thread\",\n  \"log\",\n  \"lsp-server\","}, {"sha": "f7231c2b8eaab89606e1d4500b48ac02d5faa279", "filename": "crates/profile/Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9b5fa1c61a85972da419aa29d61286cb9e268f83/crates%2Fprofile%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/9b5fa1c61a85972da419aa29d61286cb9e268f83/crates%2Fprofile%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fprofile%2FCargo.toml?ref=9b5fa1c61a85972da419aa29d61286cb9e268f83", "patch": "@@ -14,12 +14,14 @@ once_cell = \"1.3.1\"\n cfg-if = \"1\"\n libc = \"0.2.73\"\n la-arena = { version = \"0.2.0\", path = \"../../lib/arena\" }\n+jemalloc-ctl = { version = \"0.3.3\", optional = true }\n \n [target.'cfg(target_os = \"linux\")'.dependencies]\n perf-event = \"0.4\"\n \n [features]\n cpu_profiler = []\n+jemalloc = [\"jemalloc-ctl\"]\n \n # Uncomment to enable for the whole crate graph\n # default = [ \"cpu_profiler\" ]"}, {"sha": "cb4e544477173759f9878a2a3cf3036acc71f8fc", "filename": "crates/profile/src/memory_usage.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/9b5fa1c61a85972da419aa29d61286cb9e268f83/crates%2Fprofile%2Fsrc%2Fmemory_usage.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b5fa1c61a85972da419aa29d61286cb9e268f83/crates%2Fprofile%2Fsrc%2Fmemory_usage.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fprofile%2Fsrc%2Fmemory_usage.rs?ref=9b5fa1c61a85972da419aa29d61286cb9e268f83", "patch": "@@ -24,7 +24,12 @@ impl std::ops::Sub for MemoryUsage {\n impl MemoryUsage {\n     pub fn current() -> MemoryUsage {\n         cfg_if! {\n-            if #[cfg(all(target_os = \"linux\", target_env = \"gnu\"))] {\n+            if #[cfg(all(feature = \"jemalloc\", not(target_env = \"msvc\")))] {\n+                jemalloc_ctl::epoch::advance().unwrap();\n+                MemoryUsage {\n+                    allocated: Bytes(jemalloc_ctl::stats::allocated::read().unwrap() as isize),\n+                }\n+            } else if #[cfg(all(target_os = \"linux\", target_env = \"gnu\"))] {\n                 // Note: This is incredibly slow.\n                 let alloc = unsafe { libc::mallinfo() }.uordblks as isize;\n                 MemoryUsage { allocated: Bytes(alloc) }"}, {"sha": "3cb45b030fd27e742bc06274083703b008f8fc47", "filename": "crates/rust-analyzer/Cargo.toml", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9b5fa1c61a85972da419aa29d61286cb9e268f83/crates%2Frust-analyzer%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/9b5fa1c61a85972da419aa29d61286cb9e268f83/crates%2Frust-analyzer%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2FCargo.toml?ref=9b5fa1c61a85972da419aa29d61286cb9e268f83", "patch": "@@ -61,8 +61,14 @@ proc_macro_srv = { path = \"../proc_macro_srv\", version = \"0.0.0\" }\n [target.'cfg(windows)'.dependencies]\n winapi = \"0.3.8\"\n \n+[target.'cfg(not(target_env = \"msvc\"))'.dependencies]\n+jemallocator = { version = \"0.3.2\", optional = true }\n+\n [dev-dependencies]\n expect-test = \"1.1\"\n test_utils = { path = \"../test_utils\" }\n mbe = { path = \"../mbe\" }\n tt = { path = \"../tt\" }\n+\n+[features]\n+jemalloc = [\"jemallocator\", \"profile/jemalloc\"]"}, {"sha": "2f7f94a39373de75201ddb4cb9878316410e2c19", "filename": "crates/rust-analyzer/src/bin/main.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9b5fa1c61a85972da419aa29d61286cb9e268f83/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b5fa1c61a85972da419aa29d61286cb9e268f83/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs?ref=9b5fa1c61a85972da419aa29d61286cb9e268f83", "patch": "@@ -15,6 +15,10 @@ use vfs::AbsPathBuf;\n #[global_allocator]\n static ALLOC: mimalloc::MiMalloc = mimalloc::MiMalloc;\n \n+#[cfg(all(feature = \"jemalloc\", not(target_env = \"msvc\")))]\n+#[global_allocator]\n+static ALLOC: jemallocator::Jemalloc = jemallocator::Jemalloc;\n+\n fn main() {\n     if let Err(err) = try_main() {\n         eprintln!(\"{}\", err);"}, {"sha": "202c74426689d9684306ea80b9efd8343ceaf678", "filename": "xtask/src/install.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9b5fa1c61a85972da419aa29d61286cb9e268f83/xtask%2Fsrc%2Finstall.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b5fa1c61a85972da419aa29d61286cb9e268f83/xtask%2Fsrc%2Finstall.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Finstall.rs?ref=9b5fa1c61a85972da419aa29d61286cb9e268f83", "patch": "@@ -67,6 +67,7 @@ pub struct ServerOpt {\n pub enum Malloc {\n     System,\n     Mimalloc,\n+    Jemalloc,\n }\n \n impl InstallCmd {\n@@ -176,6 +177,7 @@ fn install_server(opts: ServerOpt) -> Result<()> {\n     let features = match opts.malloc {\n         Malloc::System => &[][..],\n         Malloc::Mimalloc => &[\"--features\", \"mimalloc\"],\n+        Malloc::Jemalloc => &[\"--features\", \"jemalloc\"],\n     };\n \n     let cmd = cmd!(\"cargo install --path crates/rust-analyzer --locked --force {features...}\");"}, {"sha": "c3e5c732672503500d55e00c430d84ab2a729551", "filename": "xtask/src/main.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/9b5fa1c61a85972da419aa29d61286cb9e268f83/xtask%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b5fa1c61a85972da419aa29d61286cb9e268f83/xtask%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fmain.rs?ref=9b5fa1c61a85972da419aa29d61286cb9e268f83", "patch": "@@ -49,7 +49,8 @@ FLAGS:\n         --client[=CLIENT] Install only VS Code plugin.\n                           CLIENT is one of 'code', 'code-exploration', 'code-insiders', 'codium', or 'code-oss'\n         --server          Install only the language server\n-        --mimalloc        Use mimalloc for server\n+        --mimalloc        Use mimalloc allocator for server\n+        --jemalloc        Use jemalloc allocator for server\n     -h, --help            Prints help information\n         \"\n                 );\n@@ -65,8 +66,13 @@ FLAGS:\n                 return Ok(());\n             }\n \n-            let malloc =\n-                if args.contains(\"--mimalloc\") { Malloc::Mimalloc } else { Malloc::System };\n+            let malloc = if args.contains(\"--mimalloc\") {\n+                Malloc::Mimalloc\n+            } else if args.contains(\"--jemalloc\") {\n+                Malloc::Jemalloc\n+            } else {\n+                Malloc::System\n+            };\n \n             let client_opt = args.opt_value_from_str(\"--client\")?;\n "}]}