{"sha": "f404246ce261de89cd71a336128892114a969a48", "node_id": "C_kwDOAAsO6NoAKGY0MDQyNDZjZTI2MWRlODljZDcxYTMzNjEyODg5MjExNGE5NjlhNDg", "commit": {"author": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-10-31T02:31:38Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-31T02:31:38Z"}, "message": "Rollup merge of #102101 - BelovDV:new-check-lld-version, r=petrochenkov\n\ncheck lld version to choose correct option to disable multi-threading in tests\n\nTesting compiler with 'use-lld = true' may be incorrect with old lld.\nFlag, disabling multi-threading, should consider lld version.\n\nr? ``@petrochenkov``", "tree": {"sha": "c12624d8d12fe9106fff89a1b841e6fbe39325f8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c12624d8d12fe9106fff89a1b841e6fbe39325f8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f404246ce261de89cd71a336128892114a969a48", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjXzOKCRBK7hj4Ov3rIwAAYtwIAFO4CuJx1PGtURPmJmLGQFjU\nJjfwlBx4o7Uv6Gajzjrlsrf3XxssX4f2wDA7Hsp0Aa4TfhW8ut+qDZ4z0zuaq9IB\nOjfm3md3UyxnidEQBEKRFc6BmyvD5k4tVMyqEib2zYP71jhSLPNHzRjVJA6zDOWe\nECXhdzmxVoKwkRMt2+q3t/BQt4qXsYlLJApgZ/d+WlMnOMlMmZ/TTU20seTR5MI7\n90OQTaDqZX8mMINMi5CFzfSBZ6AFGXl5ewZ08L8s02Gd90m5E/fRdyvvyHNk14ZK\nGdWeU+Qog7EmXzzDnNhaksVOBnalqAwaQC6wXpX/1A8KH99RFgznAQ+rhje0RDI=\n=ejs4\n-----END PGP SIGNATURE-----\n", "payload": "tree c12624d8d12fe9106fff89a1b841e6fbe39325f8\nparent 8d6ed3edec11dab0c0f71cb528dda54510cddf2e\nparent 0c4a01af392d3c7b6206ae9726ac481a87ef1cdc\nauthor Michael Howell <michael@notriddle.com> 1667183498 -0700\ncommitter GitHub <noreply@github.com> 1667183498 -0700\n\nRollup merge of #102101 - BelovDV:new-check-lld-version, r=petrochenkov\n\ncheck lld version to choose correct option to disable multi-threading in tests\n\nTesting compiler with 'use-lld = true' may be incorrect with old lld.\nFlag, disabling multi-threading, should consider lld version.\n\nr? ``@petrochenkov``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f404246ce261de89cd71a336128892114a969a48", "html_url": "https://github.com/rust-lang/rust/commit/f404246ce261de89cd71a336128892114a969a48", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f404246ce261de89cd71a336128892114a969a48/comments", "author": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8d6ed3edec11dab0c0f71cb528dda54510cddf2e", "url": "https://api.github.com/repos/rust-lang/rust/commits/8d6ed3edec11dab0c0f71cb528dda54510cddf2e", "html_url": "https://github.com/rust-lang/rust/commit/8d6ed3edec11dab0c0f71cb528dda54510cddf2e"}, {"sha": "0c4a01af392d3c7b6206ae9726ac481a87ef1cdc", "url": "https://api.github.com/repos/rust-lang/rust/commits/0c4a01af392d3c7b6206ae9726ac481a87ef1cdc", "html_url": "https://github.com/rust-lang/rust/commit/0c4a01af392d3c7b6206ae9726ac481a87ef1cdc"}], "stats": {"total": 31, "additions": 22, "deletions": 9}, "files": [{"sha": "23828f4758d67db275cce6d942ecb6da11d962e9", "filename": "src/bootstrap/bin/rustdoc.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f404246ce261de89cd71a336128892114a969a48/src%2Fbootstrap%2Fbin%2Frustdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f404246ce261de89cd71a336128892114a969a48/src%2Fbootstrap%2Fbin%2Frustdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Frustdoc.rs?ref=f404246ce261de89cd71a336128892114a969a48", "patch": "@@ -55,13 +55,9 @@ fn main() {\n         arg.push(&linker);\n         cmd.arg(arg);\n     }\n-    if env::var_os(\"RUSTDOC_FUSE_LD_LLD\").is_some() {\n+    if let Ok(no_threads) = env::var(\"RUSTDOC_LLD_NO_THREADS\") {\n         cmd.arg(\"-Clink-arg=-fuse-ld=lld\");\n-        if cfg!(windows) {\n-            cmd.arg(\"-Clink-arg=-Wl,/threads:1\");\n-        } else {\n-            cmd.arg(\"-Clink-arg=-Wl,--threads=1\");\n-        }\n+        cmd.arg(format!(\"-Clink-arg=-Wl,{}\", no_threads));\n     }\n     // Cargo doesn't pass RUSTDOCFLAGS to proc_macros:\n     // https://github.com/rust-lang/cargo/issues/4423"}, {"sha": "f5def8ba8341f58b817afaedb9828e75a6ad0ff7", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f404246ce261de89cd71a336128892114a969a48/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f404246ce261de89cd71a336128892114a969a48/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=f404246ce261de89cd71a336128892114a969a48", "patch": "@@ -1152,8 +1152,8 @@ impl Build {\n                 options[0] = Some(\"-Clink-arg=-fuse-ld=lld\".to_string());\n             }\n \n-            let threads = if target.contains(\"windows\") { \"/threads:1\" } else { \"--threads=1\" };\n-            options[1] = Some(format!(\"-Clink-arg=-Wl,{}\", threads));\n+            let no_threads = util::lld_flag_no_threads(target.contains(\"windows\"));\n+            options[1] = Some(format!(\"-Clink-arg=-Wl,{}\", no_threads));\n         }\n \n         IntoIterator::into_iter(options).flatten()"}, {"sha": "38fd2e933f86317e98f908dc2343257a27a8bcd8", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f404246ce261de89cd71a336128892114a969a48/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f404246ce261de89cd71a336128892114a969a48/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=f404246ce261de89cd71a336128892114a969a48", "patch": "@@ -771,7 +771,10 @@ impl Step for RustdocTheme {\n             cmd.env(\"RUSTDOC_LINKER\", linker);\n         }\n         if builder.is_fuse_ld_lld(self.compiler.host) {\n-            cmd.env(\"RUSTDOC_FUSE_LD_LLD\", \"1\");\n+            cmd.env(\n+                \"RUSTDOC_LLD_NO_THREADS\",\n+                util::lld_flag_no_threads(self.compiler.host.contains(\"windows\")),\n+            );\n         }\n         try_run(builder, &mut cmd);\n     }"}, {"sha": "20c3801f0a50222cbcc792f98a2786a993d7b5c6", "filename": "src/bootstrap/util.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f404246ce261de89cd71a336128892114a969a48/src%2Fbootstrap%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f404246ce261de89cd71a336128892114a969a48/src%2Fbootstrap%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Futil.rs?ref=f404246ce261de89cd71a336128892114a969a48", "patch": "@@ -13,6 +13,7 @@ use std::time::{Instant, SystemTime, UNIX_EPOCH};\n \n use crate::builder::Builder;\n use crate::config::{Config, TargetSelection};\n+use crate::OnceCell;\n \n /// A helper macro to `unwrap` a result except also print out details like:\n ///\n@@ -607,3 +608,16 @@ pub fn get_clang_cl_resource_dir(clang_cl_path: &str) -> PathBuf {\n     let clang_rt_dir = clang_rt_builtins.parent().expect(\"The clang lib folder should exist\");\n     clang_rt_dir.to_path_buf()\n }\n+\n+pub fn lld_flag_no_threads(is_windows: bool) -> &'static str {\n+    static LLD_NO_THREADS: OnceCell<(&'static str, &'static str)> = OnceCell::new();\n+    let (windows, other) = LLD_NO_THREADS.get_or_init(|| {\n+        let out = output(Command::new(\"lld\").arg(\"-flavor\").arg(\"ld\").arg(\"--version\"));\n+        let newer = match (out.find(char::is_numeric), out.find('.')) {\n+            (Some(b), Some(e)) => out.as_str()[b..e].parse::<i32>().ok().unwrap_or(14) > 10,\n+            _ => true,\n+        };\n+        if newer { (\"/threads:1\", \"--threads=1\") } else { (\"/no-threads\", \"--no-threads\") }\n+    });\n+    if is_windows { windows } else { other }\n+}"}]}