{"sha": "05e67b510f2229095353522255b6f766a0e06dbb", "node_id": "C_kwDOAAsO6NoAKDA1ZTY3YjUxMGYyMjI5MDk1MzUzNTIyMjU1YjZmNzY2YTBlMDZkYmI", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-04-12T18:56:21Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-12T18:56:21Z"}, "message": "Rollup merge of #110165 - notriddle:notriddle/overscroll-behavior, r=GuillaumeGomez\n\nrustdoc: use CSS `overscroll-behavior` instead of JavaScript\n\nFixes the desktop scrolling weirdness mentioned in https://github.com/rust-lang/rust/pull/98775#issuecomment-1182575603\n\nPreview: https://notriddle.com/rustdoc-demo-html-3/overscroll-behavior/issue_107918/index.html\n\nAs described in the [MDN overscroll-behavior] page:\n\n* The current Firefox ESR is 102, and the first Firefox version to support this feature is 59.\n* The current Chrome version 112, and the first version to support this is 63.\n* Edge is described as having a minor bug in `none` mode, but we use `contain` mode anyway, so it doesn't matter.\n* Safari 16, released September 2022, is the last browser to add this feature, and is also the oldest version we officially support.\n\n[MDN overscroll-behavior]: https://developer.mozilla.org/en-US/docs/Web/CSS/overscroll-behavior", "tree": {"sha": "555e3945fd8d6e820ca66a1894b123333ca6a3af", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/555e3945fd8d6e820ca66a1894b123333ca6a3af"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/05e67b510f2229095353522255b6f766a0e06dbb", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkNv7VCRBK7hj4Ov3rIwAAWIQIALJQrDaV1fGHSLFPby7RJWDv\nPYtBx+CIKu6IHOKjD1rQvz7xRAIW0aLk3I0V1zQotOjF9ZQPWJxdOH6cpTn3VhNv\nbTEGOepr6hAlAnjosPkEYaIxcJQKGP9JHhzzQ/2jS+m/HXc2JDrNMnZIgGr7plca\nX91dwcHTX+4hI2ywiwIl73Q6EXn8BztLpcQaml6bNVDJsB86nbiQC1TuvFgj+ZEd\nMOvnd9gQPwSVDIiaEkSYAxKlgLKOZ1jsldkUpjZH1Ftb/XzUtc1/3vg2/pFIhCMA\nsDFeHxlnlCNnLnqt4PcFHDJOsoPhL7EVCFOaDeqohqwRi65Vs/r2WAlWvKZszk0=\n=yhCz\n-----END PGP SIGNATURE-----\n", "payload": "tree 555e3945fd8d6e820ca66a1894b123333ca6a3af\nparent 331e7c365962619f14f840eb4c6363a13717f148\nparent bb7ed64f457be500a74d53c9d12f1d0a8f7badf6\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1681325781 +0200\ncommitter GitHub <noreply@github.com> 1681325781 +0200\n\nRollup merge of #110165 - notriddle:notriddle/overscroll-behavior, r=GuillaumeGomez\n\nrustdoc: use CSS `overscroll-behavior` instead of JavaScript\n\nFixes the desktop scrolling weirdness mentioned in https://github.com/rust-lang/rust/pull/98775#issuecomment-1182575603\n\nPreview: https://notriddle.com/rustdoc-demo-html-3/overscroll-behavior/issue_107918/index.html\n\nAs described in the [MDN overscroll-behavior] page:\n\n* The current Firefox ESR is 102, and the first Firefox version to support this feature is 59.\n* The current Chrome version 112, and the first version to support this is 63.\n* Edge is described as having a minor bug in `none` mode, but we use `contain` mode anyway, so it doesn't matter.\n* Safari 16, released September 2022, is the last browser to add this feature, and is also the oldest version we officially support.\n\n[MDN overscroll-behavior]: https://developer.mozilla.org/en-US/docs/Web/CSS/overscroll-behavior\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/05e67b510f2229095353522255b6f766a0e06dbb", "html_url": "https://github.com/rust-lang/rust/commit/05e67b510f2229095353522255b6f766a0e06dbb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/05e67b510f2229095353522255b6f766a0e06dbb/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "331e7c365962619f14f840eb4c6363a13717f148", "url": "https://api.github.com/repos/rust-lang/rust/commits/331e7c365962619f14f840eb4c6363a13717f148", "html_url": "https://github.com/rust-lang/rust/commit/331e7c365962619f14f840eb4c6363a13717f148"}, {"sha": "bb7ed64f457be500a74d53c9d12f1d0a8f7badf6", "url": "https://api.github.com/repos/rust-lang/rust/commits/bb7ed64f457be500a74d53c9d12f1d0a8f7badf6", "html_url": "https://github.com/rust-lang/rust/commit/bb7ed64f457be500a74d53c9d12f1d0a8f7badf6"}], "stats": {"total": 117, "additions": 20, "deletions": 97}, "files": [{"sha": "6fbb4508662c7a1418492da0b5a904301371d77b", "filename": "src/librustdoc/html/static/css/rustdoc.css", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/05e67b510f2229095353522255b6f766a0e06dbb/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "raw_url": "https://github.com/rust-lang/rust/raw/05e67b510f2229095353522255b6f766a0e06dbb/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css?ref=05e67b510f2229095353522255b6f766a0e06dbb", "patch": "@@ -384,6 +384,7 @@ img {\n \tfont-size: 0.875rem;\n \tflex: 0 0 200px;\n \toverflow-y: scroll;\n+\toverscroll-behavior: contain;\n \tposition: sticky;\n \theight: 100vh;\n \ttop: 0;\n@@ -1531,7 +1532,7 @@ However, it's not needed with smaller screen width because the doc/code block is\n /*\n WARNING: RUSTDOC_MOBILE_BREAKPOINT MEDIA QUERY\n If you update this line, then you also need to update the line with the same warning\n-in main.js\n+in source-script.js\n */\n @media (max-width: 700px) {\n \t/* When linking to an item with an `id` (for instance, by clicking a link in the sidebar,"}, {"sha": "6f5987e68bf1c91654acbacf161257a56ec2c59f", "filename": "src/librustdoc/html/static/js/main.js", "status": "modified", "additions": 0, "deletions": 52, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/05e67b510f2229095353522255b6f766a0e06dbb/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/05e67b510f2229095353522255b6f766a0e06dbb/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js?ref=05e67b510f2229095353522255b6f766a0e06dbb", "patch": "@@ -4,11 +4,6 @@\n \n \"use strict\";\n \n-// WARNING: RUSTDOC_MOBILE_BREAKPOINT MEDIA QUERY\n-// If you update this line, then you also need to update the media query with the same\n-// warning in rustdoc.css\n-window.RUSTDOC_MOBILE_BREAKPOINT = 700;\n-\n // Given a basename (e.g. \"storage\") and an extension (e.g. \".js\"), return a URL\n // for a resource under the root-path, with the resource-suffix.\n function resourcePath(basename, extension) {\n@@ -730,65 +725,18 @@ function preLoadCss(cssUrl) {\n         window.rustdoc_add_line_numbers_to_examples();\n     }\n \n-    let oldSidebarScrollPosition = null;\n-\n-    // Scroll locking used both here and in source-script.js\n-\n-    window.rustdocMobileScrollLock = function() {\n-        const mobile_topbar = document.querySelector(\".mobile-topbar\");\n-        if (window.innerWidth <= window.RUSTDOC_MOBILE_BREAKPOINT) {\n-            // This is to keep the scroll position on mobile.\n-            oldSidebarScrollPosition = window.scrollY;\n-            document.body.style.width = `${document.body.offsetWidth}px`;\n-            document.body.style.position = \"fixed\";\n-            document.body.style.top = `-${oldSidebarScrollPosition}px`;\n-            if (mobile_topbar) {\n-                mobile_topbar.style.top = `${oldSidebarScrollPosition}px`;\n-                mobile_topbar.style.position = \"relative\";\n-            }\n-        } else {\n-            oldSidebarScrollPosition = null;\n-        }\n-    };\n-\n-    window.rustdocMobileScrollUnlock = function() {\n-        const mobile_topbar = document.querySelector(\".mobile-topbar\");\n-        if (oldSidebarScrollPosition !== null) {\n-            // This is to keep the scroll position on mobile.\n-            document.body.style.width = \"\";\n-            document.body.style.position = \"\";\n-            document.body.style.top = \"\";\n-            if (mobile_topbar) {\n-                mobile_topbar.style.top = \"\";\n-                mobile_topbar.style.position = \"\";\n-            }\n-            // The scroll position is lost when resetting the style, hence why we store it in\n-            // `oldSidebarScrollPosition`.\n-            window.scrollTo(0, oldSidebarScrollPosition);\n-            oldSidebarScrollPosition = null;\n-        }\n-    };\n-\n     function showSidebar() {\n         window.hideAllModals(false);\n-        window.rustdocMobileScrollLock();\n         const sidebar = document.getElementsByClassName(\"sidebar\")[0];\n         addClass(sidebar, \"shown\");\n     }\n \n     function hideSidebar() {\n-        window.rustdocMobileScrollUnlock();\n         const sidebar = document.getElementsByClassName(\"sidebar\")[0];\n         removeClass(sidebar, \"shown\");\n     }\n \n     window.addEventListener(\"resize\", () => {\n-        if (window.innerWidth > window.RUSTDOC_MOBILE_BREAKPOINT &&\n-            oldSidebarScrollPosition !== null) {\n-            // If the user opens the sidebar in \"mobile\" mode, and then grows the browser window,\n-            // we need to switch away from mobile mode and make the main content area scrollable.\n-            hideSidebar();\n-        }\n         if (window.CURRENT_TOOLTIP_ELEMENT) {\n             // As a workaround to the behavior of `contains: layout` used in doc togglers,\n             // tooltip popovers are positioned using javascript."}, {"sha": "9aa75517330cd5174c7c85ceba9b7793e1fbdaf8", "filename": "src/librustdoc/html/static/js/source-script.js", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/05e67b510f2229095353522255b6f766a0e06dbb/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "raw_url": "https://github.com/rust-lang/rust/raw/05e67b510f2229095353522255b6f766a0e06dbb/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js?ref=05e67b510f2229095353522255b6f766a0e06dbb", "patch": "@@ -15,8 +15,13 @@ const NAME_OFFSET = 0;\n const DIRS_OFFSET = 1;\n const FILES_OFFSET = 2;\n \n+// WARNING: RUSTDOC_MOBILE_BREAKPOINT MEDIA QUERY\n+// If you update this line, then you also need to update the media query with the same\n+// warning in rustdoc.css\n+const RUSTDOC_MOBILE_BREAKPOINT = 700;\n+\n function closeSidebarIfMobile() {\n-    if (window.innerWidth < window.RUSTDOC_MOBILE_BREAKPOINT) {\n+    if (window.innerWidth < RUSTDOC_MOBILE_BREAKPOINT) {\n         updateLocalStorage(\"source-sidebar-show\", \"false\");\n     }\n }\n@@ -69,12 +74,10 @@ function createDirEntry(elem, parent, fullPath, hasFoundFile) {\n function toggleSidebar() {\n     const child = this.parentNode.children[0];\n     if (child.innerText === \">\") {\n-        window.rustdocMobileScrollLock();\n         addClass(document.documentElement, \"source-sidebar-expanded\");\n         child.innerText = \"<\";\n         updateLocalStorage(\"source-sidebar-show\", \"true\");\n     } else {\n-        window.rustdocMobileScrollUnlock();\n         removeClass(document.documentElement, \"source-sidebar-expanded\");\n         child.innerText = \">\";\n         updateLocalStorage(\"source-sidebar-show\", \"false\");"}, {"sha": "d58d1d48726efc5c7e3b9dd7ab15bf3f4b11b1c5", "filename": "tests/rustdoc-gui/sidebar-mobile-scroll.goml", "status": "modified", "additions": 11, "deletions": 30, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/05e67b510f2229095353522255b6f766a0e06dbb/tests%2Frustdoc-gui%2Fsidebar-mobile-scroll.goml", "raw_url": "https://github.com/rust-lang/rust/raw/05e67b510f2229095353522255b6f766a0e06dbb/tests%2Frustdoc-gui%2Fsidebar-mobile-scroll.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-gui%2Fsidebar-mobile-scroll.goml?ref=05e67b510f2229095353522255b6f766a0e06dbb", "patch": "@@ -1,31 +1,12 @@\n-// This test ensures that the mobile sidebar preserves scroll position.\n+// This test ensures that the mobile disables scrolling the page.\n go-to: \"file://\" + |DOC_PATH| + \"/test_docs/struct.Foo.html\"\n-// Switching to \"mobile view\" by reducing the width to 600px.\n-set-window-size: (700, 600)\n-assert-css: (\".sidebar\", {\"display\": \"block\", \"left\": \"-1000px\"})\n-\n-// Scroll down.\n-scroll-to: \"//h2[@id='blanket-implementations']\"\n-assert-window-property: {\"pageYOffset\": \"622\"}\n-\n-// Open the sidebar menu.\n-click: \".sidebar-menu-toggle\"\n-wait-for-css: (\".sidebar\", {\"left\": \"0px\"})\n-\n-// We are no longer \"scrolled\". It's important that the user can't\n-// scroll the body at all, but these test scripts are run only in Chrome,\n-// and we need to use a more complicated solution to this problem because\n-// of Mobile Safari...\n-assert-window-property: {\"pageYOffset\": \"0\"}\n-\n-// Close the sidebar menu. Make sure the scroll position gets restored.\n-click: \".sidebar-menu-toggle\"\n-wait-for-css: (\".sidebar\", {\"left\": \"-1000px\"})\n-assert-window-property: {\"pageYOffset\": \"622\"}\n-\n-// Now test that scrollability returns when the browser window is just resized.\n-click: \".sidebar-menu-toggle\"\n-wait-for-css: (\".sidebar\", {\"left\": \"0px\"})\n-assert-window-property: {\"pageYOffset\": \"0\"}\n-set-window-size: (900, 600)\n-assert-window-property: {\"pageYOffset\": \"622\"}\n+set-window-size: (1280, 800) // desktop\n+assert-css: (\".sidebar\", {\"overscroll-behavior\": \"contain\"})\n+set-window-size: (700, 600) // mobile\n+assert-css: (\".sidebar\", {\"overscroll-behavior\": \"contain\"})\n+\n+go-to: \"file://\" + |DOC_PATH| + \"/src/test_docs/lib.rs.html\"\n+set-window-size: (1280, 800) // desktop\n+assert-css: (\".sidebar\", {\"overscroll-behavior\": \"contain\"})\n+set-window-size: (700, 600) // mobile\n+assert-css: (\".sidebar\", {\"overscroll-behavior\": \"contain\"})"}, {"sha": "20bf0596f9589ed6299190b229d22f6ca7fd634b", "filename": "tests/rustdoc-gui/sidebar-source-code-display.goml", "status": "modified", "additions": 1, "deletions": 11, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/05e67b510f2229095353522255b6f766a0e06dbb/tests%2Frustdoc-gui%2Fsidebar-source-code-display.goml", "raw_url": "https://github.com/rust-lang/rust/raw/05e67b510f2229095353522255b6f766a0e06dbb/tests%2Frustdoc-gui%2Fsidebar-source-code-display.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-gui%2Fsidebar-source-code-display.goml?ref=05e67b510f2229095353522255b6f766a0e06dbb", "patch": "@@ -183,22 +183,12 @@ wait-for-css: (\".sidebar\", {\"left\": \"-1000px\"})\n // The \"scrollTop\" property should be the same.\n assert-window-property: {\"pageYOffset\": \"2542\"}\n \n-// We now check that the scroll position is restored if the window is resized.\n-set-window-size: (500, 700)\n-click: \"#src-sidebar-toggle\"\n-wait-for-css: (\"#source-sidebar\", {\"visibility\": \"visible\"})\n-assert-window-property: {\"pageYOffset\": \"0\"}\n-set-window-size: (900, 900)\n-assert-window-property: {\"pageYOffset\": \"2542\"}\n-set-window-size: (500, 700)\n-click: \"#src-sidebar-toggle\"\n-wait-for-css: (\"#source-sidebar\", {\"visibility\": \"hidden\"})\n-\n // We now check that opening the sidebar and clicking a link will close it.\n // The behavior here on mobile is different than the behavior on desktop,\n // but common sense dictates that if you have a list of files that fills the entire screen, and\n // you click one of them, you probably want to actually see the file's contents, and not just\n // make it the current selection.\n+set-window-size: (500, 700)\n click: \"#src-sidebar-toggle\"\n wait-for-css: (\"#source-sidebar\", {\"visibility\": \"visible\"})\n assert-local-storage: {\"rustdoc-source-sidebar-show\": \"true\"}"}]}