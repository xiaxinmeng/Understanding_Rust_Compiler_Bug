{"sha": "d3578ab742129a8aae8461f015d6cc36d85e65cc", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQzNTc4YWI3NDIxMjlhOGFhZTg0NjFmMDE1ZDZjYzM2ZDg1ZTY1Y2M=", "commit": {"author": {"name": "Michael Woerister", "email": "michaelwoerister@posteo.net", "date": "2016-08-04T22:29:58Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo.net", "date": "2016-08-11T13:56:00Z"}, "message": "Save dep-tracking hash of commandline arguments in dep-graph file.\n\n.. and use it to purge the incremental compilation cache if necessary.", "tree": {"sha": "001ec5b2f20e1473936d34f37ebe2b251abff1f1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/001ec5b2f20e1473936d34f37ebe2b251abff1f1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d3578ab742129a8aae8461f015d6cc36d85e65cc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d3578ab742129a8aae8461f015d6cc36d85e65cc", "html_url": "https://github.com/rust-lang/rust/commit/d3578ab742129a8aae8461f015d6cc36d85e65cc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d3578ab742129a8aae8461f015d6cc36d85e65cc/comments", "author": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "32414310b7e0b93491ce6243e1ec0c92c6168557", "url": "https://api.github.com/repos/rust-lang/rust/commits/32414310b7e0b93491ce6243e1ec0c92c6168557", "html_url": "https://github.com/rust-lang/rust/commit/32414310b7e0b93491ce6243e1ec0c92c6168557"}], "stats": {"total": 57, "additions": 55, "deletions": 2}, "files": [{"sha": "89a79d1a487e0f8106d99270c5bec649f9bc6c61", "filename": "src/librustc_incremental/persist/directory.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d3578ab742129a8aae8461f015d6cc36d85e65cc/src%2Flibrustc_incremental%2Fpersist%2Fdirectory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3578ab742129a8aae8461f015d6cc36d85e65cc/src%2Flibrustc_incremental%2Fpersist%2Fdirectory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fdirectory.rs?ref=d3578ab742129a8aae8461f015d6cc36d85e65cc", "patch": "@@ -158,6 +158,10 @@ impl<'a,'tcx> DefIdDirectoryBuilder<'a,'tcx> {\n         }\n     }\n \n+    pub fn tcx(&self) -> TyCtxt<'a, 'tcx, 'tcx> {\n+        self.tcx\n+    }\n+\n     pub fn add(&mut self, def_id: DefId) -> DefPathIndex {\n         debug!(\"DefIdDirectoryBuilder: def_id={:?}\", def_id);\n         let tcx = self.tcx;"}, {"sha": "c736437df1a9e8b178f36e574bc98e425c128eb8", "filename": "src/librustc_incremental/persist/load.rs", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/d3578ab742129a8aae8461f015d6cc36d85e65cc/src%2Flibrustc_incremental%2Fpersist%2Fload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3578ab742129a8aae8461f015d6cc36d85e65cc/src%2Flibrustc_incremental%2Fpersist%2Fload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fload.rs?ref=d3578ab742129a8aae8461f015d6cc36d85e65cc", "patch": "@@ -101,8 +101,25 @@ pub fn decode_dep_graph<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n                                   work_products_data: &[u8])\n                                   -> Result<(), Error>\n {\n+    // Decode the list of work_products\n+    let mut work_product_decoder = Decoder::new(work_products_data, 0);\n+    let work_products = try!(<Vec<SerializedWorkProduct>>::decode(&mut work_product_decoder));\n+\n     // Deserialize the directory and dep-graph.\n     let mut dep_graph_decoder = Decoder::new(dep_graph_data, 0);\n+    let prev_commandline_args_hash = try!(u64::decode(&mut dep_graph_decoder));\n+\n+    if prev_commandline_args_hash != tcx.sess.opts.dep_tracking_hash() {\n+        // We can't reuse the cache, purge it.\n+        debug!(\"decode_dep_graph: differing commandline arg hashes\");\n+        for swp in work_products {\n+            delete_dirty_work_product(tcx, swp);\n+        }\n+\n+        // No need to do any further work\n+        return Ok(());\n+    }\n+\n     let directory = try!(DefIdDirectory::decode(&mut dep_graph_decoder));\n     let serialized_dep_graph = try!(SerializedDepGraph::decode(&mut dep_graph_decoder));\n \n@@ -179,8 +196,6 @@ pub fn decode_dep_graph<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n \n     // Add in work-products that are still clean, and delete those that are\n     // dirty.\n-    let mut work_product_decoder = Decoder::new(work_products_data, 0);\n-    let work_products = try!(<Vec<SerializedWorkProduct>>::decode(&mut work_product_decoder));\n     reconcile_work_products(tcx, work_products, &dirty_target_nodes);\n \n     dirty_clean::check_dirty_clean_annotations(tcx, &dirty_raw_source_nodes, &retraced);"}, {"sha": "a9523a81fbaf7b9da78a0f11056fde88b61677bb", "filename": "src/librustc_incremental/persist/save.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d3578ab742129a8aae8461f015d6cc36d85e65cc/src%2Flibrustc_incremental%2Fpersist%2Fsave.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3578ab742129a8aae8461f015d6cc36d85e65cc/src%2Flibrustc_incremental%2Fpersist%2Fsave.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fsave.rs?ref=d3578ab742129a8aae8461f015d6cc36d85e65cc", "patch": "@@ -105,6 +105,10 @@ pub fn encode_dep_graph(preds: &Predecessors,\n                         builder: &mut DefIdDirectoryBuilder,\n                         encoder: &mut Encoder)\n                         -> io::Result<()> {\n+    // First encode the commandline arguments hash\n+    let tcx = builder.tcx();\n+    try!(tcx.sess.opts.dep_tracking_hash().encode(encoder));\n+\n     // Create a flat list of (Input, WorkProduct) edges for\n     // serialization.\n     let mut edges = vec![];"}, {"sha": "a79fcd4f6af57abdee9375616d30c11d89158639", "filename": "src/test/incremental/commandline-args.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/d3578ab742129a8aae8461f015d6cc36d85e65cc/src%2Ftest%2Fincremental%2Fcommandline-args.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3578ab742129a8aae8461f015d6cc36d85e65cc/src%2Ftest%2Fincremental%2Fcommandline-args.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fcommandline-args.rs?ref=d3578ab742129a8aae8461f015d6cc36d85e65cc", "patch": "@@ -0,0 +1,30 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Test that changing a tracked commandline argument invalidates\n+// the cache while changing an untracked one doesn't.\n+\n+// revisions:rpass1 rpass2 rpass3\n+\n+#![feature(rustc_attrs)]\n+\n+#![rustc_partition_translated(module=\"commandline_args\", cfg=\"rpass2\")]\n+#![rustc_partition_reused(module=\"commandline_args\", cfg=\"rpass3\")]\n+\n+// Between revisions 1 and 2, we are changing the debuginfo-level, which should\n+// invalidate the cache. Between revisions 2 and 3, we are adding `--verbose`\n+// which should have no effect on the cache:\n+//[rpass1] compile-flags: -C debuginfo=0\n+//[rpass2] compile-flags: -C debuginfo=2\n+//[rpass3] compile-flags: -C debuginfo=2 --verbose\n+\n+pub fn main() {\n+    println!(\"hello world\");\n+}"}]}