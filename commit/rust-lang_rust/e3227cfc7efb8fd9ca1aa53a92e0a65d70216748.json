{"sha": "e3227cfc7efb8fd9ca1aa53a92e0a65d70216748", "node_id": "C_kwDOAAsO6NoAKGUzMjI3Y2ZjN2VmYjhmZDljYTFhYTUzYTkyZTBhNjVkNzAyMTY3NDg", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-22T16:17:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-22T16:17:17Z"}, "message": "Auto merge of #2141 - saethlin:early-diagnostics-ice, r=RalfJung\n\nAdjust diagnostics assertion so we don't ICE in setup\n\nFixes https://github.com/rust-lang/miri/issues/2076 just by handling diagnostics produced during setup. The tracking notes don't have any spans but it's better than an ICE.\n\nIt looks like we leak allocations 1..20, and allocations 13..19 don't have any creation notes, and 14 only has a `FreedAlloc` alloc tracking diagnostic.", "tree": {"sha": "6e68096f54376072aaaa3075280a65e499838619", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6e68096f54376072aaaa3075280a65e499838619"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e3227cfc7efb8fd9ca1aa53a92e0a65d70216748", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e3227cfc7efb8fd9ca1aa53a92e0a65d70216748", "html_url": "https://github.com/rust-lang/rust/commit/e3227cfc7efb8fd9ca1aa53a92e0a65d70216748", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e3227cfc7efb8fd9ca1aa53a92e0a65d70216748/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d58abab2e74004f54ebbd778a9602b28314b9a39", "url": "https://api.github.com/repos/rust-lang/rust/commits/d58abab2e74004f54ebbd778a9602b28314b9a39", "html_url": "https://github.com/rust-lang/rust/commit/d58abab2e74004f54ebbd778a9602b28314b9a39"}, {"sha": "73534a678dedc9f68d4dfdd8532eec664bdb1e3c", "url": "https://api.github.com/repos/rust-lang/rust/commits/73534a678dedc9f68d4dfdd8532eec664bdb1e3c", "html_url": "https://github.com/rust-lang/rust/commit/73534a678dedc9f68d4dfdd8532eec664bdb1e3c"}], "stats": {"total": 20, "additions": 20, "deletions": 0}, "files": [{"sha": "13dff22ea3cc50981f0348b24ce78c3c160e84ff", "filename": "src/eval.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e3227cfc7efb8fd9ca1aa53a92e0a65d70216748/src%2Feval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3227cfc7efb8fd9ca1aa53a92e0a65d70216748/src%2Feval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Feval.rs?ref=e3227cfc7efb8fd9ca1aa53a92e0a65d70216748", "patch": "@@ -168,6 +168,12 @@ pub fn create_ecx<'mir, 'tcx: 'mir>(\n         param_env,\n         Evaluator::new(config, layout_cx),\n     );\n+\n+    // Capture the current interpreter stack state (which should be empty) so that we can emit\n+    // allocation-tracking and tag-tracking diagnostics for allocations which are part of the\n+    // early runtime setup.\n+    let info = ecx.preprocess_diagnostics();\n+\n     // Some parts of initialization require a full `InterpCx`.\n     Evaluator::late_init(&mut ecx, config)?;\n \n@@ -287,6 +293,10 @@ pub fn create_ecx<'mir, 'tcx: 'mir>(\n         }\n     }\n \n+    // Emit any diagnostics related to the setup process for the runtime, so that when the\n+    // interpreter loop starts there are no unprocessed diagnostics.\n+    ecx.process_diagnostics(info);\n+\n     Ok((ecx, ret_place))\n }\n "}, {"sha": "7bb217309f944ee3d9dfe6299255d4ef09de270a", "filename": "tests/run-pass/track-alloc-1.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e3227cfc7efb8fd9ca1aa53a92e0a65d70216748/tests%2Frun-pass%2Ftrack-alloc-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3227cfc7efb8fd9ca1aa53a92e0a65d70216748/tests%2Frun-pass%2Ftrack-alloc-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Ftrack-alloc-1.rs?ref=e3227cfc7efb8fd9ca1aa53a92e0a65d70216748", "patch": "@@ -0,0 +1,5 @@\n+// Ensure that tracking early allocations doesn't ICE Miri.\n+// Early allocations are probably part of the runtime and therefore uninteresting, but they\n+// shouldn't cause a crash.\n+// compile-flags: -Zmiri-track-alloc-id=1\n+fn main() {}"}, {"sha": "3c5a55d986e3eb4d5a21c147aa28ce55bb8b6f2d", "filename": "tests/run-pass/track-alloc-1.stderr", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e3227cfc7efb8fd9ca1aa53a92e0a65d70216748/tests%2Frun-pass%2Ftrack-alloc-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e3227cfc7efb8fd9ca1aa53a92e0a65d70216748/tests%2Frun-pass%2Ftrack-alloc-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Ftrack-alloc-1.stderr?ref=e3227cfc7efb8fd9ca1aa53a92e0a65d70216748", "patch": "@@ -0,0 +1,5 @@\n+note: tracking was triggered\n+  |\n+  = note: created allocation with id 1\n+  = note: (no span available)\n+"}]}