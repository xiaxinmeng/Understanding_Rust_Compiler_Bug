{"sha": "05607476521732c5c71bc063c8be5056aa573b15", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA1NjA3NDc2NTIxNzMyYzVjNzFiYzA2M2M4YmU1MDU2YWE1NzNiMTU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-28T07:42:13Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-28T07:42:13Z"}, "message": "Auto merge of #52678 - matthewjasper:better-spans, r=nikomatsakis\n\n[NLL] Use better spans in some errors\n\n* Use the span of the discriminant and patterns for \"fake\" statements created to properly check matches. I plan to special case these soon, but this felt like a good first step\n* Use the span of the statement, rather than the initialization, when reporting move errors for `let x = ...`, which avoids giving an unhelpful suggestion to use `&{ }`.\n\nr? @nikomatsakis cc @pnkfelix", "tree": {"sha": "cb47ef452a0aeb4165f265aac52cc2b1c2ffe817", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cb47ef452a0aeb4165f265aac52cc2b1c2ffe817"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/05607476521732c5c71bc063c8be5056aa573b15", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/05607476521732c5c71bc063c8be5056aa573b15", "html_url": "https://github.com/rust-lang/rust/commit/05607476521732c5c71bc063c8be5056aa573b15", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/05607476521732c5c71bc063c8be5056aa573b15/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4f1e2357447ef7e8066c49560d66c3e18f25d982", "url": "https://api.github.com/repos/rust-lang/rust/commits/4f1e2357447ef7e8066c49560d66c3e18f25d982", "html_url": "https://github.com/rust-lang/rust/commit/4f1e2357447ef7e8066c49560d66c3e18f25d982"}, {"sha": "b32caef1ad605c8607ad0c3ccc682f6536f0e812", "url": "https://api.github.com/repos/rust-lang/rust/commits/b32caef1ad605c8607ad0c3ccc682f6536f0e812", "html_url": "https://github.com/rust-lang/rust/commit/b32caef1ad605c8607ad0c3ccc682f6536f0e812"}], "stats": {"total": 457, "additions": 295, "deletions": 162}, "files": [{"sha": "215ade5bd4dffe1e53d91566d7a577d9ec756c7f", "filename": "src/librustc_mir/borrow_check/move_errors.rs", "status": "modified", "additions": 19, "deletions": 24, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Flibrustc_mir%2Fborrow_check%2Fmove_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Flibrustc_mir%2Fborrow_check%2Fmove_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fmove_errors.rs?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -87,6 +87,10 @@ impl<'a, 'gcx, 'tcx> MirBorrowckCtxt<'a, 'gcx, 'tcx> {\n                 cannot_move_out_of: IllegalMoveOrigin { location, kind },\n             } => {\n                 let stmt_source_info = self.mir.source_info(location);\n+                // Note: that the only time we assign a place isn't a temporary\n+                // to a user variable is when initializing it.\n+                // If that ever stops being the case, then the ever initialized\n+                // flow could be used.\n                 if let Some(StatementKind::Assign(\n                     Place::Local(local),\n                     Rvalue::Use(Operand::Move(move_from)),\n@@ -109,26 +113,16 @@ impl<'a, 'gcx, 'tcx> MirBorrowckCtxt<'a, 'gcx, 'tcx> {\n                         opt_ty_info: _,\n                     }))) = local_decl.is_user_variable\n                     {\n-                        // HACK use scopes to determine if this assignment is\n-                        // the initialization of a variable.\n-                        // FIXME(matthewjasper) This would probably be more\n-                        // reliable if it used the ever initialized dataflow\n-                        // but move errors are currently reported before the\n-                        // rest of borrowck has run.\n-                        if self\n-                            .mir\n-                            .is_sub_scope(local_decl.source_info.scope, stmt_source_info.scope)\n-                        {\n-                            self.append_binding_error(\n-                                grouped_errors,\n-                                kind,\n-                                move_from,\n-                                *local,\n-                                opt_match_place,\n-                                match_span,\n-                            );\n-                            return;\n-                        }\n+                        self.append_binding_error(\n+                            grouped_errors,\n+                            kind,\n+                            move_from,\n+                            *local,\n+                            opt_match_place,\n+                            match_span,\n+                            stmt_source_info.span,\n+                        );\n+                        return;\n                     }\n                 }\n                 grouped_errors.push(GroupedMoveError::OtherIllegalMove {\n@@ -147,6 +141,7 @@ impl<'a, 'gcx, 'tcx> MirBorrowckCtxt<'a, 'gcx, 'tcx> {\n         bind_to: Local,\n         match_place: &Option<Place<'tcx>>,\n         match_span: Span,\n+        statement_span: Span,\n     ) {\n         debug!(\n             \"append_to_grouped_errors(match_place={:?}, match_span={:?})\",\n@@ -173,13 +168,13 @@ impl<'a, 'gcx, 'tcx> MirBorrowckCtxt<'a, 'gcx, 'tcx> {\n                 debug!(\"found a new move error location\");\n \n                 // Don't need to point to x in let x = ... .\n-                let binds_to = if from_simple_let {\n-                    vec![]\n+                let (binds_to, span) = if from_simple_let {\n+                    (vec![], statement_span)\n                 } else {\n-                    vec![bind_to]\n+                    (vec![bind_to], match_span)\n                 };\n                 grouped_errors.push(GroupedMoveError::MovesFromMatchPlace {\n-                    span: match_span,\n+                    span,\n                     move_from: match_place.clone(),\n                     kind,\n                     binds_to,"}, {"sha": "a509ec08a142e4cb93ac1dae54b53fe6bd117040", "filename": "src/librustc_mir/build/matches/mod.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fmod.rs?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -63,13 +63,13 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n         // injects a borrow of the matched input, which should have the same effect\n         // as eddyb's hack. Once NLL is the default, we can remove the hack.\n \n-        let dummy_source_info = self.source_info(span);\n+        let dummy_source_info = self.source_info(discriminant_span);\n         let dummy_access = Rvalue::Discriminant(discriminant_place.clone());\n         let dummy_ty = dummy_access.ty(&self.local_decls, tcx);\n         let dummy_temp = self.temp(dummy_ty, dummy_source_info.span);\n         self.cfg.push_assign(block, dummy_source_info, &dummy_temp, dummy_access);\n \n-        let source_info = self.source_info(span);\n+        let source_info = self.source_info(discriminant_span);\n         let borrowed_input_temp = if tcx.generate_borrow_of_any_match_input() {\n             // The region is unknown at this point; we rely on NLL\n             // inference to find an appropriate one. Therefore you can\n@@ -136,9 +136,9 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                         // This should ensure that you cannot change\n                         // the variant for an enum while you are in\n                         // the midst of matching on it.\n-\n+                        let pattern_source_info = self.source_info(pattern.span);\n                         self.cfg.push(*pre_binding_block, Statement {\n-                            source_info,\n+                            source_info: pattern_source_info,\n                             kind: StatementKind::ReadForMatch(borrow_temp.clone()),\n                         });\n                     }"}, {"sha": "4048243acfa2b12aa20b5757c75f411370c0b861", "filename": "src/test/ui/borrowck/issue-41962.stderr", "status": "modified", "additions": 10, "deletions": 14, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fborrowck%2Fissue-41962.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fborrowck%2Fissue-41962.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fissue-41962.stderr?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -17,26 +17,22 @@ LL |         if let Some(thing) = maybe {\n    = note: move occurs because the value has type `std::vec::Vec<bool>`, which does not implement the `Copy` trait\n \n error[E0382]: use of moved value: `maybe` (Mir)\n-  --> $DIR/issue-41962.rs:17:9\n+  --> $DIR/issue-41962.rs:17:30\n    |\n-LL |           if let Some(thing) = maybe {\n-   |           ^           ----- value moved here\n-   |  _________|\n-   | |\n-LL | |         }\n-   | |_________^ value used here after move\n+LL |         if let Some(thing) = maybe {\n+   |                     -----    ^^^^^ value used here after move\n+   |                     |\n+   |                     value moved here\n    |\n    = note: move occurs because value has type `std::vec::Vec<bool>`, which does not implement the `Copy` trait\n \n error[E0382]: borrow of moved value: `maybe` (Mir)\n-  --> $DIR/issue-41962.rs:17:9\n+  --> $DIR/issue-41962.rs:17:30\n    |\n-LL |           if let Some(thing) = maybe {\n-   |           ^           ----- value moved here\n-   |  _________|\n-   | |\n-LL | |         }\n-   | |_________^ value borrowed here after move\n+LL |         if let Some(thing) = maybe {\n+   |                     -----    ^^^^^ value borrowed here after move\n+   |                     |\n+   |                     value moved here\n    |\n    = note: move occurs because value has type `std::vec::Vec<bool>`, which does not implement the `Copy` trait\n "}, {"sha": "85924a75261685fecf5fdb72b129e693a39dffcb", "filename": "src/test/ui/issue-17385.nll.stderr", "status": "modified", "additions": 20, "deletions": 32, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fissue-17385.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fissue-17385.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-17385.nll.stderr?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -1,26 +1,20 @@\n error[E0382]: use of moved value: `foo`\n-  --> $DIR/issue-17385.rs:28:5\n+  --> $DIR/issue-17385.rs:28:11\n    |\n-LL |       drop(foo);\n-   |            --- value moved here\n-LL | /     match foo { //~ ERROR use of moved value\n-LL | |         X(1) => (),\n-LL | |         _ => unreachable!()\n-LL | |     }\n-   | |_____^ value used here after move\n+LL |     drop(foo);\n+   |          --- value moved here\n+LL |     match foo { //~ ERROR use of moved value\n+   |           ^^^ value used here after move\n    |\n    = note: move occurs because `foo` has type `X`, which does not implement the `Copy` trait\n \n error[E0382]: borrow of moved value: `foo`\n-  --> $DIR/issue-17385.rs:28:5\n+  --> $DIR/issue-17385.rs:28:11\n    |\n-LL |       drop(foo);\n-   |            --- value moved here\n-LL | /     match foo { //~ ERROR use of moved value\n-LL | |         X(1) => (),\n-LL | |         _ => unreachable!()\n-LL | |     }\n-   | |_____^ value borrowed here after move\n+LL |     drop(foo);\n+   |          --- value moved here\n+LL |     match foo { //~ ERROR use of moved value\n+   |           ^^^ value borrowed here after move\n    |\n    = note: move occurs because `foo` has type `X`, which does not implement the `Copy` trait\n \n@@ -36,28 +30,22 @@ LL |         X(1) => (),\n    = note: move occurs because `foo` has type `X`, which does not implement the `Copy` trait\n \n error[E0382]: use of moved value: `e`\n-  --> $DIR/issue-17385.rs:35:5\n+  --> $DIR/issue-17385.rs:35:11\n    |\n-LL |       drop(e);\n-   |            - value moved here\n-LL | /     match e { //~ ERROR use of moved value\n-LL | |         Enum::Variant1 => unreachable!(),\n-LL | |         Enum::Variant2 => ()\n-LL | |     }\n-   | |_____^ value used here after move\n+LL |     drop(e);\n+   |          - value moved here\n+LL |     match e { //~ ERROR use of moved value\n+   |           ^ value used here after move\n    |\n    = note: move occurs because `e` has type `Enum`, which does not implement the `Copy` trait\n \n error[E0382]: borrow of moved value: `e`\n-  --> $DIR/issue-17385.rs:35:5\n+  --> $DIR/issue-17385.rs:35:11\n    |\n-LL |       drop(e);\n-   |            - value moved here\n-LL | /     match e { //~ ERROR use of moved value\n-LL | |         Enum::Variant1 => unreachable!(),\n-LL | |         Enum::Variant2 => ()\n-LL | |     }\n-   | |_____^ value borrowed here after move\n+LL |     drop(e);\n+   |          - value moved here\n+LL |     match e { //~ ERROR use of moved value\n+   |           ^ value borrowed here after move\n    |\n    = note: move occurs because `e` has type `Enum`, which does not implement the `Copy` trait\n "}, {"sha": "fc94cc423c53138d3c35bcbbdfef22648835772e", "filename": "src/test/ui/issue-20801.nll.stderr", "status": "modified", "additions": 16, "deletions": 4, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fissue-20801.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fissue-20801.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-20801.nll.stderr?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -2,25 +2,37 @@ error[E0507]: cannot move out of borrowed content\n   --> $DIR/issue-20801.rs:36:22\n    |\n LL |     let a = unsafe { *mut_ref() };\n-   |                      ^^^^^^^^^^ cannot move out of borrowed content\n+   |                      ^^^^^^^^^^\n+   |                      |\n+   |                      cannot move out of borrowed content\n+   |                      help: consider using a reference instead: `&*mut_ref()`\n \n error[E0507]: cannot move out of borrowed content\n   --> $DIR/issue-20801.rs:39:22\n    |\n LL |     let b = unsafe { *imm_ref() };\n-   |                      ^^^^^^^^^^ cannot move out of borrowed content\n+   |                      ^^^^^^^^^^\n+   |                      |\n+   |                      cannot move out of borrowed content\n+   |                      help: consider using a reference instead: `&*imm_ref()`\n \n error[E0507]: cannot move out of borrowed content\n   --> $DIR/issue-20801.rs:42:22\n    |\n LL |     let c = unsafe { *mut_ptr() };\n-   |                      ^^^^^^^^^^ cannot move out of borrowed content\n+   |                      ^^^^^^^^^^\n+   |                      |\n+   |                      cannot move out of borrowed content\n+   |                      help: consider using a reference instead: `&*mut_ptr()`\n \n error[E0507]: cannot move out of borrowed content\n   --> $DIR/issue-20801.rs:45:22\n    |\n LL |     let d = unsafe { *const_ptr() };\n-   |                      ^^^^^^^^^^^^ cannot move out of borrowed content\n+   |                      ^^^^^^^^^^^^\n+   |                      |\n+   |                      cannot move out of borrowed content\n+   |                      help: consider using a reference instead: `&*const_ptr()`\n \n error: aborting due to 4 previous errors\n "}, {"sha": "d264bf8d2734df2146495a8e9120141e917f1603", "filename": "src/test/ui/issue-27282-move-match-input-into-guard.stderr", "status": "modified", "additions": 8, "deletions": 15, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fissue-27282-move-match-input-into-guard.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fissue-27282-move-match-input-into-guard.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-27282-move-match-input-into-guard.stderr?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -1,21 +1,14 @@\n error[E0505]: cannot move out of `b` because it is borrowed\n   --> $DIR/issue-27282-move-match-input-into-guard.rs:26:16\n    |\n-LL |        match b {\n-   |   _____-\n-   |  |_____|\n-   | ||\n-LL | ||         &mut false => {},\n-LL | ||         _ if { (|| { let bar = b; *bar = false; })();\n-   | ||                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ move out of `b` occurs here\n-LL | ||                      //~^ ERROR cannot move out of `b` because it is borrowed [E0505]\n-...  ||\n-LL | ||         _ => panic!(\"surely we could never get here, since rustc warns it is unreachable.\"),\n-LL | ||     }\n-   | ||     -\n-   | ||_____|\n-   | |______borrow of `b` occurs here\n-   |        borrow later used here\n+LL |     match b {\n+   |           - borrow of `b` occurs here\n+LL |         &mut false => {},\n+LL |         _ if { (|| { let bar = b; *bar = false; })();\n+   |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ move out of `b` occurs here\n+...\n+LL |         &mut true => { println!(\"You might think we should get here\"); },\n+   |         --------- borrow later used here\n \n error[E0382]: use of moved value: `*b`\n   --> $DIR/issue-27282-move-match-input-into-guard.rs:29:14"}, {"sha": "fb11090c222d073b570b60e1416726713a93e5b1", "filename": "src/test/ui/issue-27282-mutate-before-diverging-arm-1.stderr", "status": "modified", "additions": 10, "deletions": 18, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fissue-27282-mutate-before-diverging-arm-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fissue-27282-mutate-before-diverging-arm-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-27282-mutate-before-diverging-arm-1.stderr?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -1,24 +1,16 @@\n error[E0500]: closure requires unique access to `x` but it is already borrowed\n   --> $DIR/issue-27282-mutate-before-diverging-arm-1.rs:33:14\n    |\n-LL |        match x {\n-   |   _____-\n-   |  |_____|\n-   | ||\n-LL | ||         &mut None => panic!(\"unreachable\"),\n-LL | ||         &mut Some(&_) if {\n-LL | ||             // ForceFnOnce needed to exploit #27282\n-LL | ||             (|| { *x = None; drop(force_fn_once); })();\n-   | ||              ^^    - borrow occurs due to use of `x` in closure\n-   | ||              |\n-   | ||              closure construction occurs here\n-...  ||\n-LL | ||         _ => panic!(\"unreachable\"),\n-LL | ||     }\n-   | ||     -\n-   | ||_____|\n-   | |______borrow occurs here\n-   |        borrow later used here\n+LL |     match x {\n+   |           - borrow occurs here\n+...\n+LL |             (|| { *x = None; drop(force_fn_once); })();\n+   |              ^^    - borrow occurs due to use of `x` in closure\n+   |              |\n+   |              closure construction occurs here\n+...\n+LL |         &mut Some(&a) if { // this binds to garbage if we've corrupted discriminant\n+   |         ------------- borrow later used here\n \n error: aborting due to previous error\n "}, {"sha": "6e643d30185f9105ea9def4a08cc4645aec7f904", "filename": "src/test/ui/issue-27282-mutate-before-diverging-arm-2.stderr", "status": "modified", "additions": 10, "deletions": 19, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fissue-27282-mutate-before-diverging-arm-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fissue-27282-mutate-before-diverging-arm-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-27282-mutate-before-diverging-arm-2.stderr?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -1,25 +1,16 @@\n error[E0500]: closure requires unique access to `x` but it is already borrowed\n   --> $DIR/issue-27282-mutate-before-diverging-arm-2.rs:38:18\n    |\n-LL |        match x {\n-   |   _____-\n-   |  |_____|\n-   | ||\n-LL | ||         &mut None => panic!(\"unreachable\"),\n-LL | ||         &mut Some(&_)\n-LL | ||             if {\n-LL | ||                 // ForceFnOnce needed to exploit #27282\n-LL | ||                 (|| { *x = None; drop(force_fn_once); })();\n-   | ||                  ^^    - borrow occurs due to use of `x` in closure\n-   | ||                  |\n-   | ||                  closure construction occurs here\n-...  ||\n-LL | ||         _ => panic!(\"unreachable\"),\n-LL | ||     }\n-   | ||     -\n-   | ||_____|\n-   | |______borrow occurs here\n-   |        borrow later used here\n+LL |     match x {\n+   |           - borrow occurs here\n+...\n+LL |                 (|| { *x = None; drop(force_fn_once); })();\n+   |                  ^^    - borrow occurs due to use of `x` in closure\n+   |                  |\n+   |                  closure construction occurs here\n+...\n+LL |         &mut Some(&2)\n+   |         ------------- borrow later used here\n \n error: aborting due to previous error\n "}, {"sha": "d8a47efc0aaa43b4980d8ac580468ac7781ee634", "filename": "src/test/ui/issue-47412.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fissue-47412.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fissue-47412.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-47412.stderr?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -1,16 +1,16 @@\n error[E0133]: access to union field is unsafe and requires unsafe function or block\n-  --> $DIR/issue-47412.rs:21:5\n+  --> $DIR/issue-47412.rs:21:11\n    |\n LL |     match u.void {}\n-   |     ^^^^^^^^^^^^^^^ access to union field\n+   |           ^^^^^^ access to union field\n    |\n    = note: the field may not be properly initialized: using uninitialized data will cause undefined behavior\n \n error[E0133]: dereference of raw pointer is unsafe and requires unsafe function or block\n-  --> $DIR/issue-47412.rs:27:5\n+  --> $DIR/issue-47412.rs:27:11\n    |\n LL |     match *ptr {}\n-   |     ^^^^^^^^^^^^^ dereference of raw pointer\n+   |           ^^^^ dereference of raw pointer\n    |\n    = note: raw pointers may be NULL, dangling or unaligned; they can violate aliasing rules and cause data races: all of these are undefined behavior\n "}, {"sha": "e5b001def56f2cc5efa7ff0eac0faecbc94cf65a", "filename": "src/test/ui/lifetime-errors/ex1-return-one-existing-name-early-bound-in-struct.nll.stderr", "status": "modified", "additions": 5, "deletions": 11, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Flifetime-errors%2Fex1-return-one-existing-name-early-bound-in-struct.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Flifetime-errors%2Fex1-return-one-existing-name-early-bound-in-struct.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flifetime-errors%2Fex1-return-one-existing-name-early-bound-in-struct.nll.stderr?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -5,18 +5,12 @@ LL |                     other //~ ERROR explicit lifetime\n    |                     ^^^^^\n \n error[E0621]: explicit lifetime required in the type of `other`\n-  --> $DIR/ex1-return-one-existing-name-early-bound-in-struct.rs:18:9\n+  --> $DIR/ex1-return-one-existing-name-early-bound-in-struct.rs:18:15\n    |\n-LL |       fn bar(&self, other: Foo) -> Foo<'a> {\n-   |                     ----- consider changing the type of `other` to `Foo<'a>`\n-LL | /         match *self {\n-LL | |             Foo::Bar(s) => {\n-LL | |                 if s == \"test\" {\n-LL | |                     other //~ ERROR explicit lifetime\n-...  |\n-LL | |             }\n-LL | |         }\n-   | |_________^ lifetime `'a` required\n+LL |     fn bar(&self, other: Foo) -> Foo<'a> {\n+   |                   ----- consider changing the type of `other` to `Foo<'a>`\n+LL |         match *self {\n+   |               ^^^^^ lifetime `'a` required\n \n error: aborting due to previous error\n "}, {"sha": "acbba9ee18754d252f39ca3d91200e301dd68f0f", "filename": "src/test/ui/nll/borrowed-match-issue-45045.stderr", "status": "modified", "additions": 9, "deletions": 12, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fnll%2Fborrowed-match-issue-45045.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fnll%2Fborrowed-match-issue-45045.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fborrowed-match-issue-45045.stderr?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -1,17 +1,14 @@\n error[E0503]: cannot use `e` because it was mutably borrowed\n-  --> $DIR/borrowed-match-issue-45045.rs:24:5\n+  --> $DIR/borrowed-match-issue-45045.rs:24:11\n    |\n-LL |       let f = &mut e;\n-   |               ------ borrow of `e` occurs here\n-LL |       let g = f;\n-LL | /     match e { //~ cannot use `e` because it was mutably borrowed [E0503]\n-LL | |         Xyz::A => println!(\"a\"),\n-LL | |         //~^ cannot use `e` because it was mutably borrowed [E0503]\n-LL | |         Xyz::B => println!(\"b\"),\n-LL | |     };\n-   | |_____^ use of borrowed `e`\n-LL |       *g = Xyz::B;\n-   |       ----------- borrow later used here\n+LL |     let f = &mut e;\n+   |             ------ borrow of `e` occurs here\n+LL |     let g = f;\n+LL |     match e { //~ cannot use `e` because it was mutably borrowed [E0503]\n+   |           ^ use of borrowed `e`\n+...\n+LL |     *g = Xyz::B;\n+   |     ----------- borrow later used here\n \n error[E0503]: cannot use `e` because it was mutably borrowed\n   --> $DIR/borrowed-match-issue-45045.rs:25:9"}, {"sha": "814e11b6f0682f5feccb0a49fce9885b48d65dbd", "filename": "src/test/ui/nll/cannot-move-block-spans.nll.stderr", "status": "added", "additions": 85, "deletions": 0, "changes": 85, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fnll%2Fcannot-move-block-spans.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fnll%2Fcannot-move-block-spans.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fcannot-move-block-spans.nll.stderr?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -0,0 +1,85 @@\n+error[E0507]: cannot move out of borrowed content\n+  --> $DIR/cannot-move-block-spans.rs:15:15\n+   |\n+LL |     let x = { *r }; //~ ERROR\n+   |               ^^\n+   |               |\n+   |               cannot move out of borrowed content\n+   |               help: consider removing this dereference operator: `r`\n+\n+error[E0507]: cannot move out of borrowed content\n+  --> $DIR/cannot-move-block-spans.rs:16:22\n+   |\n+LL |     let y = unsafe { *r }; //~ ERROR\n+   |                      ^^\n+   |                      |\n+   |                      cannot move out of borrowed content\n+   |                      help: consider removing this dereference operator: `r`\n+\n+error[E0507]: cannot move out of borrowed content\n+  --> $DIR/cannot-move-block-spans.rs:17:26\n+   |\n+LL |     let z = loop { break *r; }; //~ ERROR\n+   |                          ^^\n+   |                          |\n+   |                          cannot move out of borrowed content\n+   |                          help: consider removing this dereference operator: `r`\n+\n+error[E0508]: cannot move out of type `[std::string::String; 2]`, a non-copy array\n+  --> $DIR/cannot-move-block-spans.rs:21:15\n+   |\n+LL |     let x = { arr[0] }; //~ ERROR\n+   |               ^^^^^^\n+   |               |\n+   |               cannot move out of here\n+   |               help: consider using a reference instead: `&arr[0]`\n+\n+error[E0508]: cannot move out of type `[std::string::String; 2]`, a non-copy array\n+  --> $DIR/cannot-move-block-spans.rs:22:22\n+   |\n+LL |     let y = unsafe { arr[0] }; //~ ERROR\n+   |                      ^^^^^^\n+   |                      |\n+   |                      cannot move out of here\n+   |                      help: consider using a reference instead: `&arr[0]`\n+\n+error[E0508]: cannot move out of type `[std::string::String; 2]`, a non-copy array\n+  --> $DIR/cannot-move-block-spans.rs:23:26\n+   |\n+LL |     let z = loop { break arr[0]; }; //~ ERROR\n+   |                          ^^^^^^\n+   |                          |\n+   |                          cannot move out of here\n+   |                          help: consider using a reference instead: `&arr[0]`\n+\n+error[E0507]: cannot move out of borrowed content\n+  --> $DIR/cannot-move-block-spans.rs:27:38\n+   |\n+LL |     let x = { let mut u = 0; u += 1; *r }; //~ ERROR\n+   |                                      ^^\n+   |                                      |\n+   |                                      cannot move out of borrowed content\n+   |                                      help: consider removing this dereference operator: `r`\n+\n+error[E0507]: cannot move out of borrowed content\n+  --> $DIR/cannot-move-block-spans.rs:28:45\n+   |\n+LL |     let y = unsafe { let mut u = 0; u += 1; *r }; //~ ERROR\n+   |                                             ^^\n+   |                                             |\n+   |                                             cannot move out of borrowed content\n+   |                                             help: consider removing this dereference operator: `r`\n+\n+error[E0507]: cannot move out of borrowed content\n+  --> $DIR/cannot-move-block-spans.rs:29:49\n+   |\n+LL |     let z = loop { let mut u = 0; u += 1; break *r; u += 2; }; //~ ERROR\n+   |                                                 ^^\n+   |                                                 |\n+   |                                                 cannot move out of borrowed content\n+   |                                                 help: consider removing this dereference operator: `r`\n+\n+error: aborting due to 9 previous errors\n+\n+Some errors occurred: E0507, E0508.\n+For more information about an error, try `rustc --explain E0507`."}, {"sha": "5a84a4ca48e26205ad90d09ab280a67fa25c6464", "filename": "src/test/ui/nll/cannot-move-block-spans.rs", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fnll%2Fcannot-move-block-spans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fnll%2Fcannot-move-block-spans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fcannot-move-block-spans.rs?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -0,0 +1,32 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Test that the we point to the inner expression when moving out to initialize\n+// a variable, and that we don't give a useless suggestion such as &{ *r }.\n+\n+pub fn deref(r: &String) {\n+    let x = { *r }; //~ ERROR\n+    let y = unsafe { *r }; //~ ERROR\n+    let z = loop { break *r; }; //~ ERROR\n+}\n+\n+pub fn index(arr: [String; 2]) {\n+    let x = { arr[0] }; //~ ERROR\n+    let y = unsafe { arr[0] }; //~ ERROR\n+    let z = loop { break arr[0]; }; //~ ERROR\n+}\n+\n+pub fn additional_statement_cases(r: &String) {\n+    let x = { let mut u = 0; u += 1; *r }; //~ ERROR\n+    let y = unsafe { let mut u = 0; u += 1; *r }; //~ ERROR\n+    let z = loop { let mut u = 0; u += 1; break *r; u += 2; }; //~ ERROR\n+}\n+\n+fn main() {}"}, {"sha": "d495690023959ea41f47340d8b0b5c3a11dc65d5", "filename": "src/test/ui/nll/cannot-move-block-spans.stderr", "status": "added", "additions": 58, "deletions": 0, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fnll%2Fcannot-move-block-spans.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fnll%2Fcannot-move-block-spans.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fcannot-move-block-spans.stderr?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -0,0 +1,58 @@\n+error[E0507]: cannot move out of borrowed content\n+  --> $DIR/cannot-move-block-spans.rs:15:15\n+   |\n+LL |     let x = { *r }; //~ ERROR\n+   |               ^^ cannot move out of borrowed content\n+\n+error[E0507]: cannot move out of borrowed content\n+  --> $DIR/cannot-move-block-spans.rs:16:22\n+   |\n+LL |     let y = unsafe { *r }; //~ ERROR\n+   |                      ^^ cannot move out of borrowed content\n+\n+error[E0507]: cannot move out of borrowed content\n+  --> $DIR/cannot-move-block-spans.rs:17:26\n+   |\n+LL |     let z = loop { break *r; }; //~ ERROR\n+   |                          ^^ cannot move out of borrowed content\n+\n+error[E0508]: cannot move out of type `[std::string::String; 2]`, a non-copy array\n+  --> $DIR/cannot-move-block-spans.rs:21:15\n+   |\n+LL |     let x = { arr[0] }; //~ ERROR\n+   |               ^^^^^^ cannot move out of here\n+\n+error[E0508]: cannot move out of type `[std::string::String; 2]`, a non-copy array\n+  --> $DIR/cannot-move-block-spans.rs:22:22\n+   |\n+LL |     let y = unsafe { arr[0] }; //~ ERROR\n+   |                      ^^^^^^ cannot move out of here\n+\n+error[E0508]: cannot move out of type `[std::string::String; 2]`, a non-copy array\n+  --> $DIR/cannot-move-block-spans.rs:23:26\n+   |\n+LL |     let z = loop { break arr[0]; }; //~ ERROR\n+   |                          ^^^^^^ cannot move out of here\n+\n+error[E0507]: cannot move out of borrowed content\n+  --> $DIR/cannot-move-block-spans.rs:27:38\n+   |\n+LL |     let x = { let mut u = 0; u += 1; *r }; //~ ERROR\n+   |                                      ^^ cannot move out of borrowed content\n+\n+error[E0507]: cannot move out of borrowed content\n+  --> $DIR/cannot-move-block-spans.rs:28:45\n+   |\n+LL |     let y = unsafe { let mut u = 0; u += 1; *r }; //~ ERROR\n+   |                                             ^^ cannot move out of borrowed content\n+\n+error[E0507]: cannot move out of borrowed content\n+  --> $DIR/cannot-move-block-spans.rs:29:49\n+   |\n+LL |     let z = loop { let mut u = 0; u += 1; break *r; u += 2; }; //~ ERROR\n+   |                                                 ^^ cannot move out of borrowed content\n+\n+error: aborting due to 9 previous errors\n+\n+Some errors occurred: E0507, E0508.\n+For more information about an error, try `rustc --explain E0507`."}, {"sha": "09e634ba725f40d806163b731262c2edc3aee69d", "filename": "src/test/ui/span/issue-40157.nll.stderr", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fspan%2Fissue-40157.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/05607476521732c5c71bc063c8be5056aa573b15/src%2Ftest%2Fui%2Fspan%2Fissue-40157.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fspan%2Fissue-40157.nll.stderr?ref=05607476521732c5c71bc063c8be5056aa573b15", "patch": "@@ -2,11 +2,11 @@ error[E0597]: `foo` does not live long enough\n   --> $DIR/issue-40157.rs:12:53\n    |\n LL |     {println!(\"{:?}\", match { let foo = vec![1, 2]; foo.get(1) } { x => x });}\n-   |                       ------------------------------^^^--------------------\n-   |                       |                             |          |\n-   |                       |                             |          `foo` dropped here while still borrowed\n-   |                       |                             borrowed value does not live long enough\n-   |                       borrow later used here\n+   |                             ------------------------^^^---------\n+   |                             |                       |          |\n+   |                             |                       |          `foo` dropped here while still borrowed\n+   |                             |                       borrowed value does not live long enough\n+   |                             borrow later used here\n \n error: aborting due to previous error\n "}]}