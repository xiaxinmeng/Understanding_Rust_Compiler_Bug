{"sha": "f8028b0b6c3c5c1d6498cf780366641a7c047abf", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY4MDI4YjBiNmMzYzVjMWQ2NDk4Y2Y3ODAzNjY2NDFhN2MwNDdhYmY=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-01-12T21:41:11Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-01-12T21:41:11Z"}, "message": "privacy: Fix private-in-public check for existential types", "tree": {"sha": "d4ad65f7a547496f7bf791317eae370f519e675b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d4ad65f7a547496f7bf791317eae370f519e675b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f8028b0b6c3c5c1d6498cf780366641a7c047abf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f8028b0b6c3c5c1d6498cf780366641a7c047abf", "html_url": "https://github.com/rust-lang/rust/commit/f8028b0b6c3c5c1d6498cf780366641a7c047abf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f8028b0b6c3c5c1d6498cf780366641a7c047abf/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d6525ef539a04cb43de40080bdabc5f2f5a4a197", "url": "https://api.github.com/repos/rust-lang/rust/commits/d6525ef539a04cb43de40080bdabc5f2f5a4a197", "html_url": "https://github.com/rust-lang/rust/commit/d6525ef539a04cb43de40080bdabc5f2f5a4a197"}], "stats": {"total": 26, "additions": 23, "deletions": 3}, "files": [{"sha": "4890369e13f2022975efea48ada74c49e40d473c", "filename": "src/librustc_privacy/lib.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/f8028b0b6c3c5c1d6498cf780366641a7c047abf/src%2Flibrustc_privacy%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8028b0b6c3c5c1d6498cf780366641a7c047abf/src%2Flibrustc_privacy%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_privacy%2Flib.rs?ref=f8028b0b6c3c5c1d6498cf780366641a7c047abf", "patch": "@@ -48,7 +48,7 @@ mod diagnostics;\n /// Default type visitor (`TypeVisitor`) does most of the job, but it has some shortcomings.\n /// First, it doesn't have overridable `fn visit_trait_ref`, so we have to catch trait def-ids\n /// manually. Second, it doesn't visit some type components like signatures of fn types, or traits\n-/// in `impl Trait`, see individual commits in `DefIdVisitorSkeleton::visit_ty`.\n+/// in `impl Trait`, see individual comments in `DefIdVisitorSkeleton::visit_ty`.\n trait DefIdVisitor<'a, 'tcx: 'a> {\n     fn tcx(&self) -> TyCtxt<'a, 'tcx, 'tcx>;\n     fn shallow(&self) -> bool { false }\n@@ -1579,10 +1579,15 @@ impl<'a, 'tcx> Visitor<'tcx> for PrivateItemsInPublicInterfacesVisitor<'a, 'tcx>\n             // No subitems.\n             hir::ItemKind::GlobalAsm(..) => {}\n             // Subitems of these items have inherited publicity.\n-            hir::ItemKind::Const(..) | hir::ItemKind::Static(..) | hir::ItemKind::Fn(..) |\n-            hir::ItemKind::Existential(..) | hir::ItemKind::Ty(..) => {\n+            hir::ItemKind::Const(..) | hir::ItemKind::Static(..) |\n+            hir::ItemKind::Fn(..) | hir::ItemKind::Ty(..) => {\n                 self.check(item.id, item_visibility).generics().predicates().ty();\n             }\n+            hir::ItemKind::Existential(..) => {\n+                // `ty()` for existential types is the underlying type,\n+                // it's not a part of interface, so we skip it.\n+                self.check(item.id, item_visibility).generics().predicates();\n+            }\n             hir::ItemKind::Trait(.., ref trait_item_refs) => {\n                 self.check(item.id, item_visibility).generics().predicates();\n "}, {"sha": "95658f45df6f5509db8f1f3f10a7362762670388", "filename": "src/test/ui/privacy/private-in-public-existential.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/f8028b0b6c3c5c1d6498cf780366641a7c047abf/src%2Ftest%2Fui%2Fprivacy%2Fprivate-in-public-existential.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8028b0b6c3c5c1d6498cf780366641a7c047abf/src%2Ftest%2Fui%2Fprivacy%2Fprivate-in-public-existential.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprivacy%2Fprivate-in-public-existential.rs?ref=f8028b0b6c3c5c1d6498cf780366641a7c047abf", "patch": "@@ -0,0 +1,15 @@\n+// compile-pass\n+\n+#![feature(existential_type)]\n+#![deny(private_in_public)]\n+\n+pub existential type Pub: Default;\n+\n+#[derive(Default)]\n+struct Priv;\n+\n+fn check() -> Pub {\n+    Priv\n+}\n+\n+fn main() {}"}]}