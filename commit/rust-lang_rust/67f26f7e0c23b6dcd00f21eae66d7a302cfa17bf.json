{"sha": "67f26f7e0c23b6dcd00f21eae66d7a302cfa17bf", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY3ZjI2ZjdlMGMyM2I2ZGNkMDBmMjFlYWU2NmQ3YTMwMmNmYTE3YmY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-10-25T13:20:02Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-10-25T13:20:02Z"}, "message": "Auto merge of #37360 - jseyfried:fix_label_scope, r=nrc\n\nresolve: fix label scopes\n\nFixes #37353 (turns an ICE back into an error).\nr? @nrc", "tree": {"sha": "573dca3c3d2f0009e646341afe4d8cdca06f6b8c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/573dca3c3d2f0009e646341afe4d8cdca06f6b8c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/67f26f7e0c23b6dcd00f21eae66d7a302cfa17bf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/67f26f7e0c23b6dcd00f21eae66d7a302cfa17bf", "html_url": "https://github.com/rust-lang/rust/commit/67f26f7e0c23b6dcd00f21eae66d7a302cfa17bf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/67f26f7e0c23b6dcd00f21eae66d7a302cfa17bf/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "affc3b7552324284ccd7042b5b23f6ecd391babc", "url": "https://api.github.com/repos/rust-lang/rust/commits/affc3b7552324284ccd7042b5b23f6ecd391babc", "html_url": "https://github.com/rust-lang/rust/commit/affc3b7552324284ccd7042b5b23f6ecd391babc"}, {"sha": "dcdab2df67c97a34dd7d6a361e4e7213033e1373", "url": "https://api.github.com/repos/rust-lang/rust/commits/dcdab2df67c97a34dd7d6a361e4e7213033e1373", "html_url": "https://github.com/rust-lang/rust/commit/dcdab2df67c97a34dd7d6a361e4e7213033e1373"}], "stats": {"total": 35, "additions": 16, "deletions": 19}, "files": [{"sha": "c6f73b804e3c1c6378bd93a81c1d2bec9d71a6f9", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 13, "deletions": 19, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/67f26f7e0c23b6dcd00f21eae66d7a302cfa17bf/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/67f26f7e0c23b6dcd00f21eae66d7a302cfa17bf/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=67f26f7e0c23b6dcd00f21eae66d7a302cfa17bf", "patch": "@@ -55,7 +55,7 @@ use rustc::util::nodemap::{NodeMap, NodeSet, FnvHashMap, FnvHashSet};\n \n use syntax::ext::hygiene::{Mark, SyntaxContext};\n use syntax::ast::{self, FloatTy};\n-use syntax::ast::{CRATE_NODE_ID, Name, NodeId, Ident, IntTy, UintTy};\n+use syntax::ast::{CRATE_NODE_ID, Name, NodeId, Ident, SpannedIdent, IntTy, UintTy};\n use syntax::ext::base::SyntaxExtension;\n use syntax::parse::token::{self, keywords};\n use syntax::util::lev_distance::find_best_match_for_name;\n@@ -2278,7 +2278,7 @@ impl<'a> Resolver<'a> {\n     }\n \n     fn fresh_binding(&mut self,\n-                     ident: &ast::SpannedIdent,\n+                     ident: &SpannedIdent,\n                      pat_id: NodeId,\n                      outer_pat_id: NodeId,\n                      pat_src: PatternSource,\n@@ -2842,11 +2842,11 @@ impl<'a> Resolver<'a> {\n         } SuggestionType::NotFound\n     }\n \n-    fn resolve_labeled_block(&mut self, label: Option<Ident>, id: NodeId, block: &Block) {\n+    fn resolve_labeled_block(&mut self, label: Option<SpannedIdent>, id: NodeId, block: &Block) {\n         if let Some(label) = label {\n             let def = Def::Label(id);\n             self.with_label_rib(|this| {\n-                this.label_ribs.last_mut().unwrap().bindings.insert(label, def);\n+                this.label_ribs.last_mut().unwrap().bindings.insert(label.node, def);\n                 this.visit_block(block);\n             });\n         } else {\n@@ -3039,19 +3039,6 @@ impl<'a> Resolver<'a> {\n                 visit::walk_expr(self, expr);\n             }\n \n-            ExprKind::Loop(_, Some(label)) | ExprKind::While(.., Some(label)) => {\n-                self.with_label_rib(|this| {\n-                    let def = Def::Label(expr.id);\n-\n-                    {\n-                        let rib = this.label_ribs.last_mut().unwrap();\n-                        rib.bindings.insert(label.node, def);\n-                    }\n-\n-                    visit::walk_expr(this, expr);\n-                })\n-            }\n-\n             ExprKind::Break(Some(label)) | ExprKind::Continue(Some(label)) => {\n                 match self.search_label(label.node) {\n                     None => {\n@@ -3081,12 +3068,19 @@ impl<'a> Resolver<'a> {\n                 optional_else.as_ref().map(|expr| self.visit_expr(expr));\n             }\n \n+            ExprKind::Loop(ref block, label) => self.resolve_labeled_block(label, expr.id, &block),\n+\n+            ExprKind::While(ref subexpression, ref block, label) => {\n+                self.visit_expr(subexpression);\n+                self.resolve_labeled_block(label, expr.id, &block);\n+            }\n+\n             ExprKind::WhileLet(ref pattern, ref subexpression, ref block, label) => {\n                 self.visit_expr(subexpression);\n                 self.value_ribs.push(Rib::new(NormalRibKind));\n                 self.resolve_pattern(pattern, PatternSource::WhileLet, &mut FnvHashMap());\n \n-                self.resolve_labeled_block(label.map(|l| l.node), expr.id, block);\n+                self.resolve_labeled_block(label, expr.id, block);\n \n                 self.value_ribs.pop();\n             }\n@@ -3096,7 +3090,7 @@ impl<'a> Resolver<'a> {\n                 self.value_ribs.push(Rib::new(NormalRibKind));\n                 self.resolve_pattern(pattern, PatternSource::For, &mut FnvHashMap());\n \n-                self.resolve_labeled_block(label.map(|l| l.node), expr.id, block);\n+                self.resolve_labeled_block(label, expr.id, block);\n \n                 self.value_ribs.pop();\n             }"}, {"sha": "ed2c3e0e9b86054433fd656c746988ab10c225fb", "filename": "src/test/compile-fail/resolve-label.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/67f26f7e0c23b6dcd00f21eae66d7a302cfa17bf/src%2Ftest%2Fcompile-fail%2Fresolve-label.rs", "raw_url": "https://github.com/rust-lang/rust/raw/67f26f7e0c23b6dcd00f21eae66d7a302cfa17bf/src%2Ftest%2Fcompile-fail%2Fresolve-label.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fresolve-label.rs?ref=67f26f7e0c23b6dcd00f21eae66d7a302cfa17bf", "patch": "@@ -16,6 +16,9 @@ fn f() {\n             }\n         }\n     }\n+\n+    // issue #37353\n+    loop { 'w: while break 'w { } } //~ ERROR use of undeclared label\n }\n \n fn main() {}"}]}