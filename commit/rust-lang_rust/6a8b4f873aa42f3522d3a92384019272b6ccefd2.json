{"sha": "6a8b4f873aa42f3522d3a92384019272b6ccefd2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZhOGI0Zjg3M2FhNDJmMzUyMmQzYTkyMzg0MDE5MjcyYjZjY2VmZDI=", "commit": {"author": {"name": "JasperDeSutter", "email": "jasper.desutter@gmail.com", "date": "2019-11-24T10:33:12Z"}, "committer": {"name": "JasperDeSutter", "email": "jasper.desutter@gmail.com", "date": "2019-11-24T15:55:56Z"}, "message": "add proc-macro crate type handling", "tree": {"sha": "23235e959e23796bb05c811742375aeaf8143953", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/23235e959e23796bb05c811742375aeaf8143953"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6a8b4f873aa42f3522d3a92384019272b6ccefd2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6a8b4f873aa42f3522d3a92384019272b6ccefd2", "html_url": "https://github.com/rust-lang/rust/commit/6a8b4f873aa42f3522d3a92384019272b6ccefd2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6a8b4f873aa42f3522d3a92384019272b6ccefd2/comments", "author": {"login": "JasperDeSutter", "id": 16452324, "node_id": "MDQ6VXNlcjE2NDUyMzI0", "avatar_url": "https://avatars.githubusercontent.com/u/16452324?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JasperDeSutter", "html_url": "https://github.com/JasperDeSutter", "followers_url": "https://api.github.com/users/JasperDeSutter/followers", "following_url": "https://api.github.com/users/JasperDeSutter/following{/other_user}", "gists_url": "https://api.github.com/users/JasperDeSutter/gists{/gist_id}", "starred_url": "https://api.github.com/users/JasperDeSutter/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JasperDeSutter/subscriptions", "organizations_url": "https://api.github.com/users/JasperDeSutter/orgs", "repos_url": "https://api.github.com/users/JasperDeSutter/repos", "events_url": "https://api.github.com/users/JasperDeSutter/events{/privacy}", "received_events_url": "https://api.github.com/users/JasperDeSutter/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JasperDeSutter", "id": 16452324, "node_id": "MDQ6VXNlcjE2NDUyMzI0", "avatar_url": "https://avatars.githubusercontent.com/u/16452324?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JasperDeSutter", "html_url": "https://github.com/JasperDeSutter", "followers_url": "https://api.github.com/users/JasperDeSutter/followers", "following_url": "https://api.github.com/users/JasperDeSutter/following{/other_user}", "gists_url": "https://api.github.com/users/JasperDeSutter/gists{/gist_id}", "starred_url": "https://api.github.com/users/JasperDeSutter/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JasperDeSutter/subscriptions", "organizations_url": "https://api.github.com/users/JasperDeSutter/orgs", "repos_url": "https://api.github.com/users/JasperDeSutter/repos", "events_url": "https://api.github.com/users/JasperDeSutter/events{/privacy}", "received_events_url": "https://api.github.com/users/JasperDeSutter/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ea3124c12a52f28163a6375b6a5e3c79fc14312d", "url": "https://api.github.com/repos/rust-lang/rust/commits/ea3124c12a52f28163a6375b6a5e3c79fc14312d", "html_url": "https://github.com/rust-lang/rust/commit/ea3124c12a52f28163a6375b6a5e3c79fc14312d"}], "stats": {"total": 31, "additions": 30, "deletions": 1}, "files": [{"sha": "351997dcdbeb7b3db9bcc35d8466ad0deca816b0", "filename": "crates/ra_project_model/src/cargo_workspace.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6a8b4f873aa42f3522d3a92384019272b6ccefd2/crates%2Fra_project_model%2Fsrc%2Fcargo_workspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a8b4f873aa42f3522d3a92384019272b6ccefd2/crates%2Fra_project_model%2Fsrc%2Fcargo_workspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_project_model%2Fsrc%2Fcargo_workspace.rs?ref=6a8b4f873aa42f3522d3a92384019272b6ccefd2", "patch": "@@ -54,11 +54,13 @@ struct TargetData {\n     name: String,\n     root: PathBuf,\n     kind: TargetKind,\n+    is_proc_macro: bool,\n }\n \n #[derive(Debug, Clone, Copy, PartialEq, Eq)]\n pub enum TargetKind {\n     Bin,\n+    /// Any kind of Cargo lib crate-type (dylib, rlib, proc-macro, ...).\n     Lib,\n     Example,\n     Test,\n@@ -74,6 +76,7 @@ impl TargetKind {\n                 \"test\" => TargetKind::Test,\n                 \"bench\" => TargetKind::Bench,\n                 \"example\" => TargetKind::Example,\n+                \"proc-macro\" => TargetKind::Lib,\n                 _ if kind.contains(\"lib\") => TargetKind::Lib,\n                 _ => continue,\n             };\n@@ -123,6 +126,9 @@ impl Target {\n     pub fn kind(self, ws: &CargoWorkspace) -> TargetKind {\n         ws.targets[self].kind\n     }\n+    pub fn is_proc_macro(self, ws: &CargoWorkspace) -> bool {\n+        ws.targets[self].is_proc_macro\n+    }\n }\n \n impl CargoWorkspace {\n@@ -155,11 +161,13 @@ impl CargoWorkspace {\n             let pkg_data = &mut packages[pkg];\n             pkg_by_id.insert(id, pkg);\n             for meta_tgt in meta_pkg.targets {\n+                let is_proc_macro = meta_tgt.kind.as_slice() == &[\"proc-macro\"];\n                 let tgt = targets.alloc(TargetData {\n                     pkg,\n                     name: meta_tgt.name,\n                     root: meta_tgt.src_path.clone(),\n                     kind: TargetKind::new(meta_tgt.kind.as_slice()),\n+                    is_proc_macro,\n                 });\n                 pkg_data.targets.push(tgt);\n             }"}, {"sha": "77f729a25f6e8a45bba346c9b35b2f5dda1c3903", "filename": "crates/ra_project_model/src/lib.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/6a8b4f873aa42f3522d3a92384019272b6ccefd2/crates%2Fra_project_model%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a8b4f873aa42f3522d3a92384019272b6ccefd2/crates%2Fra_project_model%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_project_model%2Fsrc%2Flib.rs?ref=6a8b4f873aa42f3522d3a92384019272b6ccefd2", "patch": "@@ -210,6 +210,8 @@ impl ProjectWorkspace {\n \n                 let libcore = sysroot.core().and_then(|it| sysroot_crates.get(&it).copied());\n                 let libstd = sysroot.std().and_then(|it| sysroot_crates.get(&it).copied());\n+                let libproc_macro =\n+                    sysroot.proc_macro().and_then(|it| sysroot_crates.get(&it).copied());\n \n                 let mut pkg_to_lib_crate = FxHashMap::default();\n                 let mut pkg_crates = FxHashMap::default();\n@@ -236,6 +238,21 @@ impl ProjectWorkspace {\n                                 lib_tgt = Some(crate_id);\n                                 pkg_to_lib_crate.insert(pkg, crate_id);\n                             }\n+                            if tgt.is_proc_macro(&cargo) {\n+                                if let Some(proc_macro) = libproc_macro {\n+                                    if let Err(_) = crate_graph.add_dep(\n+                                        crate_id,\n+                                        \"proc_macro\".into(),\n+                                        proc_macro,\n+                                    ) {\n+                                        log::error!(\n+                                            \"cyclic dependency on proc_macro for {}\",\n+                                            pkg.name(&cargo)\n+                                        )\n+                                    }\n+                                }\n+                            }\n+\n                             pkg_crates.entry(pkg).or_insert_with(Vec::new).push(crate_id);\n                         }\n                     }"}, {"sha": "8a7757c41160603016a12bbcd7e33764d3ea5385", "filename": "crates/ra_project_model/src/sysroot.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6a8b4f873aa42f3522d3a92384019272b6ccefd2/crates%2Fra_project_model%2Fsrc%2Fsysroot.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a8b4f873aa42f3522d3a92384019272b6ccefd2/crates%2Fra_project_model%2Fsrc%2Fsysroot.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_project_model%2Fsrc%2Fsysroot.rs?ref=6a8b4f873aa42f3522d3a92384019272b6ccefd2", "patch": "@@ -35,6 +35,10 @@ impl Sysroot {\n         self.by_name(\"std\")\n     }\n \n+    pub fn proc_macro(&self) -> Option<SysrootCrate> {\n+        self.by_name(\"proc_macro\")\n+    }\n+\n     pub fn crates<'a>(&'a self) -> impl Iterator<Item = SysrootCrate> + ExactSizeIterator + 'a {\n         self.crates.iter().map(|(id, _data)| id)\n     }\n@@ -70,7 +74,7 @@ impl Sysroot {\n             }\n         }\n         if let Some(alloc) = sysroot.by_name(\"alloc\") {\n-            if let Some(core) = sysroot.by_name(\"core\") {\n+            if let Some(core) = sysroot.core() {\n                 sysroot.crates[alloc].deps.push(core);\n             }\n         }"}]}