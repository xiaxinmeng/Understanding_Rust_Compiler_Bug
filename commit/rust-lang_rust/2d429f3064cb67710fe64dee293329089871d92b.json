{"sha": "2d429f3064cb67710fe64dee293329089871d92b", "node_id": "C_kwDOAAsO6NoAKDJkNDI5ZjMwNjRjYjY3NzEwZmU2NGRlZTI5MzMyOTA4OTg3MWQ5MmI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-25T17:06:43Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-25T17:06:43Z"}, "message": "Auto merge of #109458 - Nilstrieb:smol-cute-little-bits, r=wesleywiser\n\nUse `SmallVec` in bitsets\n\nThis doesn't increase their size and means that we don't have to heap allocate for small sets.", "tree": {"sha": "c3218c73b866c054ab84911c6189be2138d717ff", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c3218c73b866c054ab84911c6189be2138d717ff"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2d429f3064cb67710fe64dee293329089871d92b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2d429f3064cb67710fe64dee293329089871d92b", "html_url": "https://github.com/rust-lang/rust/commit/2d429f3064cb67710fe64dee293329089871d92b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2d429f3064cb67710fe64dee293329089871d92b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "96bd50dd47b645efa52d1312b9cc32e507d9cd76", "url": "https://api.github.com/repos/rust-lang/rust/commits/96bd50dd47b645efa52d1312b9cc32e507d9cd76", "html_url": "https://github.com/rust-lang/rust/commit/96bd50dd47b645efa52d1312b9cc32e507d9cd76"}, {"sha": "29c11327c703f59ad39d5840768864106b7c27b7", "url": "https://api.github.com/repos/rust-lang/rust/commits/29c11327c703f59ad39d5840768864106b7c27b7", "html_url": "https://github.com/rust-lang/rust/commit/29c11327c703f59ad39d5840768864106b7c27b7"}], "stats": {"total": 12, "additions": 7, "deletions": 5}, "files": [{"sha": "eba5b3ed882a1073db91a67782f4cf1aafbd3e9f", "filename": "compiler/rustc_index/src/bit_set.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/2d429f3064cb67710fe64dee293329089871d92b/compiler%2Frustc_index%2Fsrc%2Fbit_set.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d429f3064cb67710fe64dee293329089871d92b/compiler%2Frustc_index%2Fsrc%2Fbit_set.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_index%2Fsrc%2Fbit_set.rs?ref=2d429f3064cb67710fe64dee293329089871d92b", "patch": "@@ -1,5 +1,6 @@\n use crate::vec::{Idx, IndexVec};\n use arrayvec::ArrayVec;\n+use smallvec::{smallvec, SmallVec};\n use std::fmt;\n use std::iter;\n use std::marker::PhantomData;\n@@ -111,7 +112,7 @@ macro_rules! bit_relations_inherent_impls {\n #[derive(Eq, PartialEq, Hash, Decodable, Encodable)]\n pub struct BitSet<T> {\n     domain_size: usize,\n-    words: Vec<Word>,\n+    words: SmallVec<[Word; 2]>,\n     marker: PhantomData<T>,\n }\n \n@@ -127,14 +128,15 @@ impl<T: Idx> BitSet<T> {\n     #[inline]\n     pub fn new_empty(domain_size: usize) -> BitSet<T> {\n         let num_words = num_words(domain_size);\n-        BitSet { domain_size, words: vec![0; num_words], marker: PhantomData }\n+        BitSet { domain_size, words: smallvec![0; num_words], marker: PhantomData }\n     }\n \n     /// Creates a new, filled bitset with a given `domain_size`.\n     #[inline]\n     pub fn new_filled(domain_size: usize) -> BitSet<T> {\n         let num_words = num_words(domain_size);\n-        let mut result = BitSet { domain_size, words: vec![!0; num_words], marker: PhantomData };\n+        let mut result =\n+            BitSet { domain_size, words: smallvec![!0; num_words], marker: PhantomData };\n         result.clear_excess_bits();\n         result\n     }\n@@ -1571,7 +1573,7 @@ impl<T: Idx> From<BitSet<T>> for GrowableBitSet<T> {\n pub struct BitMatrix<R: Idx, C: Idx> {\n     num_rows: usize,\n     num_columns: usize,\n-    words: Vec<Word>,\n+    words: SmallVec<[Word; 2]>,\n     marker: PhantomData<(R, C)>,\n }\n \n@@ -1584,7 +1586,7 @@ impl<R: Idx, C: Idx> BitMatrix<R, C> {\n         BitMatrix {\n             num_rows,\n             num_columns,\n-            words: vec![0; num_rows * words_per_row],\n+            words: smallvec![0; num_rows * words_per_row],\n             marker: PhantomData,\n         }\n     }"}]}