{"sha": "dfddc2f9183b38183791f11887a1d608bb220878", "node_id": "C_kwDOAAsO6NoAKGRmZGRjMmY5MTgzYjM4MTgzNzkxZjExODg3YTFkNjA4YmIyMjA4Nzg", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-08-11T17:16:56Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-11T17:16:56Z"}, "message": "Rollup merge of #92744 - lambinoo:I-91161-non-exhaustive-foreign-variants, r=scottmcm\n\nCheck if enum from foreign crate has any non exhaustive variants when attempting a cast\n\nFixes #91161\n\nAs stated in the issue, this will require a crater run as it might break other people's stuff.", "tree": {"sha": "5c32775a4511538b653c327e4def1411c8444729", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5c32775a4511538b653c327e4def1411c8444729"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dfddc2f9183b38183791f11887a1d608bb220878", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi9TmICRBK7hj4Ov3rIwAAMKgIAAPwJlN4OdnEBvg7ZBcwU9bG\nYx8TZg01xd9uae9CIJm64HOx5zvr42pjqiAwnA2YNIuIn2CzGNWRITqgZSn9/JHI\nwoext20Wz5hAMYUpqrf149C9IQO9mijCM5ADjtgi3vxb4xJ9XNnRB9rV3F+BQ1+m\nUuv8ibKEKeJxPHSPYUnsiCNs1t6tTgqFo1TWd8Hdnezzxd0VPSHiRGnF7hMWCuAw\nkFiDstmMRXHeuxrwP9m8D8Oe96zKzYdPTDOEEe39rmWaqK2W7Yblf8CVRCxkYWqM\nKDtFdAZCOXYaTPdXyQR3HallpVBqWb38sAIwWBUMZX2aLUKoizJ6W2wBXL/UJ7s=\n=OIr2\n-----END PGP SIGNATURE-----\n", "payload": "tree 5c32775a4511538b653c327e4def1411c8444729\nparent aeb5067967ef58e4a324b19dd0dba2f385d5959f\nparent dfb3713cdb7303a250d8b23792fe801319edf36c\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1660238216 +0530\ncommitter GitHub <noreply@github.com> 1660238216 +0530\n\nRollup merge of #92744 - lambinoo:I-91161-non-exhaustive-foreign-variants, r=scottmcm\n\nCheck if enum from foreign crate has any non exhaustive variants when attempting a cast\n\nFixes #91161\n\nAs stated in the issue, this will require a crater run as it might break other people's stuff.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dfddc2f9183b38183791f11887a1d608bb220878", "html_url": "https://github.com/rust-lang/rust/commit/dfddc2f9183b38183791f11887a1d608bb220878", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dfddc2f9183b38183791f11887a1d608bb220878/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aeb5067967ef58e4a324b19dd0dba2f385d5959f", "url": "https://api.github.com/repos/rust-lang/rust/commits/aeb5067967ef58e4a324b19dd0dba2f385d5959f", "html_url": "https://github.com/rust-lang/rust/commit/aeb5067967ef58e4a324b19dd0dba2f385d5959f"}, {"sha": "dfb3713cdb7303a250d8b23792fe801319edf36c", "url": "https://api.github.com/repos/rust-lang/rust/commits/dfb3713cdb7303a250d8b23792fe801319edf36c", "html_url": "https://github.com/rust-lang/rust/commit/dfb3713cdb7303a250d8b23792fe801319edf36c"}], "stats": {"total": 42, "additions": 34, "deletions": 8}, "files": [{"sha": "6c7b2a2889fa49526241835a6ef0c43c6c358b83", "filename": "compiler/rustc_typeck/src/check/cast.rs", "status": "modified", "additions": 22, "deletions": 1, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/dfddc2f9183b38183791f11887a1d608bb220878/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dfddc2f9183b38183791f11887a1d608bb220878/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcast.rs?ref=dfddc2f9183b38183791f11887a1d608bb220878", "patch": "@@ -32,6 +32,7 @@ use super::FnCtxt;\n \n use crate::hir::def_id::DefId;\n use crate::type_error_struct;\n+use hir::def_id::LOCAL_CRATE;\n use rustc_errors::{struct_span_err, Applicability, DiagnosticBuilder, ErrorGuaranteed};\n use rustc_hir as hir;\n use rustc_hir::lang_items::LangItem;\n@@ -40,7 +41,7 @@ use rustc_middle::ty::adjustment::AllowTwoPhase;\n use rustc_middle::ty::cast::{CastKind, CastTy};\n use rustc_middle::ty::error::TypeError;\n use rustc_middle::ty::subst::SubstsRef;\n-use rustc_middle::ty::{self, Ty, TypeAndMut, TypeVisitable};\n+use rustc_middle::ty::{self, Ty, TypeAndMut, TypeVisitable, VariantDef};\n use rustc_session::lint;\n use rustc_session::Session;\n use rustc_span::symbol::sym;\n@@ -173,6 +174,7 @@ pub enum CastError {\n     /// or \"a length\". If this argument is None, then the metadata is unknown, for example,\n     /// when we're typechecking a type parameter with a ?Sized bound.\n     IntToFatCast(Option<&'static str>),\n+    ForeignNonExhaustiveAdt,\n }\n \n impl From<ErrorGuaranteed> for CastError {\n@@ -591,6 +593,17 @@ impl<'a, 'tcx> CastCheck<'tcx> {\n                 }\n                 err.emit();\n             }\n+            CastError::ForeignNonExhaustiveAdt => {\n+                make_invalid_casting_error(\n+                    fcx.tcx.sess,\n+                    self.span,\n+                    self.expr_ty,\n+                    self.cast_ty,\n+                    fcx,\n+                )\n+                .note(\"cannot cast an enum with a non-exhaustive variant when it's defined in another crate\")\n+                .emit();\n+            }\n         }\n     }\n \n@@ -789,6 +802,14 @@ impl<'a, 'tcx> CastCheck<'tcx> {\n             _ => return Err(CastError::NonScalar),\n         };\n \n+        if let ty::Adt(adt_def, _) = *self.expr_ty.kind() {\n+            if adt_def.did().krate != LOCAL_CRATE {\n+                if adt_def.variants().iter().any(VariantDef::is_field_list_non_exhaustive) {\n+                    return Err(CastError::ForeignNonExhaustiveAdt);\n+                }\n+            }\n+        }\n+\n         match (t_from, t_cast) {\n             // These types have invariants! can't cast into them.\n             (_, Int(CEnum) | FnPtr) => Err(CastError::NonScalar),"}, {"sha": "5dce8180f59206ecd1968ebdb635cdacee400c36", "filename": "src/test/ui/rfc-2008-non-exhaustive/enum-as-cast.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/dfddc2f9183b38183791f11887a1d608bb220878/src%2Ftest%2Fui%2Frfc-2008-non-exhaustive%2Fenum-as-cast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dfddc2f9183b38183791f11887a1d608bb220878/src%2Ftest%2Fui%2Frfc-2008-non-exhaustive%2Fenum-as-cast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2008-non-exhaustive%2Fenum-as-cast.rs?ref=dfddc2f9183b38183791f11887a1d608bb220878", "patch": "@@ -1,17 +1,11 @@\n // aux-build:enums.rs\n-// run-pass\n \n extern crate enums;\n \n use enums::FieldLessWithNonExhaustiveVariant;\n \n fn main() {\n     let e = FieldLessWithNonExhaustiveVariant::default();\n-    // FIXME: https://github.com/rust-lang/rust/issues/91161\n-    // This `as` cast *should* be an error, since it would fail\n-    // if the non-exhaustive variant got fields.  But today it\n-    // doesn't.  The fix for that will update this test to\n-    // show an error (and not be run-pass any more).\n-    let d = e as u8;\n+    let d = e as u8; //~ ERROR casting `FieldLessWithNonExhaustiveVariant` as `u8` is invalid [E0606]\n     assert_eq!(d, 0);\n }"}, {"sha": "a61dcf8399f17094d8ae373f2b8acb1d365243b4", "filename": "src/test/ui/rfc-2008-non-exhaustive/enum-as-cast.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/dfddc2f9183b38183791f11887a1d608bb220878/src%2Ftest%2Fui%2Frfc-2008-non-exhaustive%2Fenum-as-cast.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dfddc2f9183b38183791f11887a1d608bb220878/src%2Ftest%2Fui%2Frfc-2008-non-exhaustive%2Fenum-as-cast.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2008-non-exhaustive%2Fenum-as-cast.stderr?ref=dfddc2f9183b38183791f11887a1d608bb220878", "patch": "@@ -0,0 +1,11 @@\n+error[E0606]: casting `FieldLessWithNonExhaustiveVariant` as `u8` is invalid\n+  --> $DIR/enum-as-cast.rs:9:13\n+   |\n+LL |     let d = e as u8;\n+   |             ^^^^^^^\n+   |\n+   = note: cannot cast an enum with a non-exhaustive variant when it's defined in another crate\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0606`."}]}