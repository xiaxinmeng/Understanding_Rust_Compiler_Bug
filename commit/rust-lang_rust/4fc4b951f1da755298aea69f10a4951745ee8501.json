{"sha": "4fc4b951f1da755298aea69f10a4951745ee8501", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRmYzRiOTUxZjFkYTc1NTI5OGFlYTY5ZjEwYTQ5NTE3NDVlZTg1MDE=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-02-05T00:43:03Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-02-05T00:43:03Z"}, "message": "Make associated item lookup a query", "tree": {"sha": "c91774733d42e3de6a5587bd328977815e141695", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c91774733d42e3de6a5587bd328977815e141695"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4fc4b951f1da755298aea69f10a4951745ee8501", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4fc4b951f1da755298aea69f10a4951745ee8501", "html_url": "https://github.com/rust-lang/rust/commit/4fc4b951f1da755298aea69f10a4951745ee8501", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4fc4b951f1da755298aea69f10a4951745ee8501/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8417d68de5e063426ab6bb7f383df6117d1beeed", "url": "https://api.github.com/repos/rust-lang/rust/commits/8417d68de5e063426ab6bb7f383df6117d1beeed", "html_url": "https://github.com/rust-lang/rust/commit/8417d68de5e063426ab6bb7f383df6117d1beeed"}], "stats": {"total": 45, "additions": 24, "deletions": 21}, "files": [{"sha": "228271e0c4c3ae609cda636264dc978d55d560fd", "filename": "src/librustc/query/mod.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/4fc4b951f1da755298aea69f10a4951745ee8501/src%2Flibrustc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fc4b951f1da755298aea69f10a4951745ee8501/src%2Flibrustc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fquery%2Fmod.rs?ref=4fc4b951f1da755298aea69f10a4951745ee8501", "patch": "@@ -310,6 +310,11 @@ rustc_queries! {\n         /// Maps from a trait item to the trait item \"descriptor\".\n         query associated_item(_: DefId) -> ty::AssocItem {}\n \n+        /// Collects the associated items defined on a trait or impl.\n+        query associated_items(key: DefId) -> ty::AssocItemsIterator<'tcx> {\n+            desc { |tcx| \"collecting associated items of {}\", tcx.def_path_str(key) }\n+        }\n+\n         query impl_trait_ref(_: DefId) -> Option<ty::TraitRef<'tcx>> {}\n         query impl_polarity(_: DefId) -> ty::ImplPolarity {}\n "}, {"sha": "028a88a6c82b3c0fe422250bad15f73695bfdd60", "filename": "src/librustc/ty/mod.rs", "status": "modified", "additions": 10, "deletions": 21, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/4fc4b951f1da755298aea69f10a4951745ee8501/src%2Flibrustc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fc4b951f1da755298aea69f10a4951745ee8501/src%2Flibrustc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmod.rs?ref=4fc4b951f1da755298aea69f10a4951745ee8501", "patch": "@@ -2741,19 +2741,6 @@ impl<'tcx> TyCtxt<'tcx> {\n         variant.fields.iter().position(|field| self.hygienic_eq(ident, field.ident, variant.def_id))\n     }\n \n-    pub fn associated_items(self, def_id: DefId) -> AssocItemsIterator<'tcx> {\n-        // Ideally, we would use `-> impl Iterator` here, but it falls\n-        // afoul of the conservative \"capture [restrictions]\" we put\n-        // in place, so we use a hand-written iterator.\n-        //\n-        // [restrictions]: https://github.com/rust-lang/rust/issues/34511#issuecomment-373423999\n-        AssocItemsIterator {\n-            tcx: self,\n-            def_ids: self.associated_item_def_ids(def_id),\n-            next_index: 0,\n-        }\n-    }\n-\n     /// Returns `true` if the impls are the same polarity and the trait either\n     /// has no items or is annotated #[marker] and prevents item overrides.\n     pub fn impls_are_allowed_to_overlap(\n@@ -2993,20 +2980,22 @@ impl<'tcx> TyCtxt<'tcx> {\n     }\n }\n \n-#[derive(Clone)]\n+#[derive(Copy, Clone, HashStable)]\n pub struct AssocItemsIterator<'tcx> {\n-    tcx: TyCtxt<'tcx>,\n-    def_ids: &'tcx [DefId],\n-    next_index: usize,\n+    pub items: &'tcx [AssocItem],\n }\n \n-impl Iterator for AssocItemsIterator<'_> {\n+impl<'tcx> Iterator for AssocItemsIterator<'tcx> {\n     type Item = AssocItem;\n \n+    #[inline]\n     fn next(&mut self) -> Option<AssocItem> {\n-        let def_id = self.def_ids.get(self.next_index)?;\n-        self.next_index += 1;\n-        Some(self.tcx.associated_item(*def_id))\n+        if let Some((first, rest)) = self.items.split_first() {\n+            self.items = rest;\n+            Some(*first)\n+        } else {\n+            None\n+        }\n     }\n }\n "}, {"sha": "e2a9b821b4a0aa52922e58451a833f3b5ba65ab4", "filename": "src/librustc_ty/ty.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/4fc4b951f1da755298aea69f10a4951745ee8501/src%2Flibrustc_ty%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fc4b951f1da755298aea69f10a4951745ee8501/src%2Flibrustc_ty%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_ty%2Fty.rs?ref=4fc4b951f1da755298aea69f10a4951745ee8501", "patch": "@@ -206,6 +206,14 @@ fn associated_item_def_ids(tcx: TyCtxt<'_>, def_id: DefId) -> &[DefId] {\n     }\n }\n \n+fn associated_items<'tcx>(tcx: TyCtxt<'tcx>, def_id: DefId) -> ty::AssocItemsIterator<'tcx> {\n+    ty::AssocItemsIterator {\n+        items: tcx.arena.alloc_from_iter(\n+            tcx.associated_item_def_ids(def_id).iter().map(|did| tcx.associated_item(*did)),\n+        ),\n+    }\n+}\n+\n fn def_span(tcx: TyCtxt<'_>, def_id: DefId) -> Span {\n     tcx.hir().span_if_local(def_id).unwrap()\n }\n@@ -356,6 +364,7 @@ pub fn provide(providers: &mut ty::query::Providers<'_>) {\n         asyncness,\n         associated_item,\n         associated_item_def_ids,\n+        associated_items,\n         adt_sized_constraint,\n         def_span,\n         param_env,"}]}