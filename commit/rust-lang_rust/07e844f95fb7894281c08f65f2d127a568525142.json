{"sha": "07e844f95fb7894281c08f65f2d127a568525142", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA3ZTg0NGY5NWZiNzg5NDI4MWMwOGY2NWYyZDEyN2E1Njg1MjUxNDI=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2017-01-04T06:29:15Z"}, "committer": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2017-01-04T10:42:10Z"}, "message": "Add more docs for CoerceUnsized and Unsize", "tree": {"sha": "3ac737d707e24a1419f08287012fad6e9250cabf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3ac737d707e24a1419f08287012fad6e9250cabf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/07e844f95fb7894281c08f65f2d127a568525142", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/07e844f95fb7894281c08f65f2d127a568525142", "html_url": "https://github.com/rust-lang/rust/commit/07e844f95fb7894281c08f65f2d127a568525142", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/07e844f95fb7894281c08f65f2d127a568525142/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "75f5981d4500e52de767d61ec50a34b97be2a301", "url": "https://api.github.com/repos/rust-lang/rust/commits/75f5981d4500e52de767d61ec50a34b97be2a301", "html_url": "https://github.com/rust-lang/rust/commit/75f5981d4500e52de767d61ec50a34b97be2a301"}], "stats": {"total": 48, "additions": 46, "deletions": 2}, "files": [{"sha": "b699946cecaa2314d94072b1ef644ab3cc2b4f11", "filename": "src/doc/nomicon/coercions.md", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/07e844f95fb7894281c08f65f2d127a568525142/src%2Fdoc%2Fnomicon%2Fcoercions.md", "raw_url": "https://github.com/rust-lang/rust/raw/07e844f95fb7894281c08f65f2d127a568525142/src%2Fdoc%2Fnomicon%2Fcoercions.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Fnomicon%2Fcoercions.md?ref=07e844f95fb7894281c08f65f2d127a568525142", "patch": "@@ -17,6 +17,7 @@ Coercion is allowed between the following types:\n     * `&T` to `*const T`\n     * `&mut T` to `*mut T`\n * Unsizing: `T` to `U` if `T` implements `CoerceUnsized<U>`\n+* Deref coercion: Expression `&x` of type `&T` to `&*x` of type `&U` if `T` derefs to `U` (i.e. `T: Deref<Target=U>`)\n \n `CoerceUnsized<Pointer<U>> for Pointer<T> where T: Unsize<U>` is implemented\n for all pointer types (including smart pointers like Box and Rc). Unsize is\n@@ -27,8 +28,9 @@ only implemented automatically, and enables the following transformations:\n * `Foo<..., T, ...>` => `Foo<..., U, ...>` where:\n     * `T: Unsize<U>`\n     * `Foo` is a struct\n-    * Only the last field of `Foo` has type `T`\n+    * Only the last field of `Foo` has type involving `T`\n     * `T` is not part of the type of any other fields\n+    * `Bar<T>: Unsize<Bar<U>>`, if the last field of `Foo` has type `Bar<T>`\n \n Coercions occur at a *coercion site*. Any location that is explicitly typed\n will cause a coercion to its type. If inference is necessary, the coercion will"}, {"sha": "a9e2bff5906f50ae012aa4b714b06efed6df94b9", "filename": "src/libcore/marker.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/07e844f95fb7894281c08f65f2d127a568525142/src%2Flibcore%2Fmarker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/07e844f95fb7894281c08f65f2d127a568525142/src%2Flibcore%2Fmarker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fmarker.rs?ref=07e844f95fb7894281c08f65f2d127a568525142", "patch": "@@ -100,13 +100,26 @@ pub trait Sized {\n ///\n /// All implementations of `Unsize` are provided automatically by the compiler.\n ///\n+/// `Unsize` is implemented for:\n+///\n+/// - `[T; N]` is `Unsize<[T]>`\n+/// - `T` is `Unsize<Trait>` when `T: Trait`\n+/// - `Foo<..., T, ...>` is `Unsize<Foo<..., U, ...>>` if:\n+///   - `T: Unsize<U>`\n+///   - Foo is a struct\n+///   - Only the last field of `Foo` has a type involving `T`\n+///   - `T` is not part of the type of any other fields\n+///   - `Bar<T>: Unsize<Bar<U>>`, if the last field of `Foo` has type `Bar<T>`\n+///\n /// `Unsize` is used along with [`ops::CoerceUnsized`][coerceunsized] to allow\n /// \"user-defined\" containers such as [`rc::Rc`][rc] to contain dynamically-sized\n-/// types. See the [DST coercion RFC][RFC982] for more details.\n+/// types. See the [DST coercion RFC][RFC982] and [the nomicon entry on coercion][nomicon-coerce]\n+/// for more details.\n ///\n /// [coerceunsized]: ../ops/trait.CoerceUnsized.html\n /// [rc]: ../../std/rc/struct.Rc.html\n /// [RFC982]: https://github.com/rust-lang/rfcs/blob/master/text/0982-dst-coercion.md\n+\n #[unstable(feature = \"unsize\", issue = \"27732\")]\n #[lang=\"unsize\"]\n pub trait Unsize<T: ?Sized> {"}, {"sha": "7477195433338fc96e85a70aa8b5b79ff4a0026d", "filename": "src/libcore/ops.rs", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/07e844f95fb7894281c08f65f2d127a568525142/src%2Flibcore%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/07e844f95fb7894281c08f65f2d127a568525142/src%2Flibcore%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fops.rs?ref=07e844f95fb7894281c08f65f2d127a568525142", "patch": "@@ -2649,6 +2649,35 @@ mod impls {\n \n /// Trait that indicates that this is a pointer or a wrapper for one,\n /// where unsizing can be performed on the pointee.\n+///\n+/// See the [DST coercion RfC][dst-coerce] and [the nomicon entry on coercion][nomicon-coerce]\n+/// for more details.\n+///\n+/// For builtin pointer types, pointers to `T` will coerce to pointers to `U` if `T: Unsize<U>`\n+/// by converting from a thin pointer to a fat pointer.\n+///\n+/// For custom types, the coercion here works by coercing `Foo<T>` to `Foo<U>`\n+/// provided an impl of `CoerceUnsized<Foo<U>> for Foo<T>` exists.\n+/// Such an impl can only be written if `Foo<T>` has only a single non-phantomdata\n+/// field involving `T`. If the type of that field is `Bar<T>`, an implementation\n+/// of `CoerceUnsized<Bar<U>> for Bar<T>` must exist. The coercion will work by\n+/// by coercing the `Bar<T>` field into `Bar<U>` and filling in the rest of the fields\n+/// from `Foo<T>` to create a `Foo<U>`. This will effectively drill down to a pointer\n+/// field and coerce that.\n+///\n+/// Generally, for smart pointers you will implement\n+/// `CoerceUnsized<Ptr<U>> for Ptr<T> where T: Unsize<U>, U: ?Sized`, with an\n+/// optional `?Sized` bound on `T` itself. For wrapper types that directly embed `T`\n+/// like `Cell<T>` and `RefCell<T>`, you\n+/// can directly implement `CoerceUnsized<Wrap<U>> for Wrap<T> where T: CoerceUnsized<U>`.\n+/// This will let coercions of types like `Cell<Box<T>>` work.\n+///\n+/// [`Unsize`][unsize] is used to mark types which can be coerced to DSTs if behind\n+/// pointers. It is implemented automatically by the compiler.\n+///\n+/// [dst-coerce]: https://github.com/rust-lang/rfcs/blob/master/text/0982-dst-coercion.md\n+/// [unsize]: ../marker/trait.Unsize.html\n+/// [nomicon-coerce]: ../../nomicon/coercions.html\n #[unstable(feature = \"coerce_unsized\", issue = \"27732\")]\n #[lang=\"coerce_unsized\"]\n pub trait CoerceUnsized<T> {"}]}