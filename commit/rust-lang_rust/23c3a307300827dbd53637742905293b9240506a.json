{"sha": "23c3a307300827dbd53637742905293b9240506a", "node_id": "C_kwDOAAsO6NoAKDIzYzNhMzA3MzAwODI3ZGJkNTM2Mzc3NDI5MDUyOTNiOTI0MDUwNmE", "commit": {"author": {"name": "clubby789", "email": "jamie@hill-daniel.co.uk", "date": "2023-01-03T17:02:25Z"}, "committer": {"name": "clubby789", "email": "jamie@hill-daniel.co.uk", "date": "2023-01-05T16:51:30Z"}, "message": "Explain error with `&mut self` for unsized trait impls", "tree": {"sha": "2822c55caaffa970407231c3c8286f1415e709dc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2822c55caaffa970407231c3c8286f1415e709dc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/23c3a307300827dbd53637742905293b9240506a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/23c3a307300827dbd53637742905293b9240506a", "html_url": "https://github.com/rust-lang/rust/commit/23c3a307300827dbd53637742905293b9240506a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/23c3a307300827dbd53637742905293b9240506a/comments", "author": {"login": "clubby789", "id": 13556931, "node_id": "MDQ6VXNlcjEzNTU2OTMx", "avatar_url": "https://avatars.githubusercontent.com/u/13556931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/clubby789", "html_url": "https://github.com/clubby789", "followers_url": "https://api.github.com/users/clubby789/followers", "following_url": "https://api.github.com/users/clubby789/following{/other_user}", "gists_url": "https://api.github.com/users/clubby789/gists{/gist_id}", "starred_url": "https://api.github.com/users/clubby789/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/clubby789/subscriptions", "organizations_url": "https://api.github.com/users/clubby789/orgs", "repos_url": "https://api.github.com/users/clubby789/repos", "events_url": "https://api.github.com/users/clubby789/events{/privacy}", "received_events_url": "https://api.github.com/users/clubby789/received_events", "type": "User", "site_admin": false}, "committer": {"login": "clubby789", "id": 13556931, "node_id": "MDQ6VXNlcjEzNTU2OTMx", "avatar_url": "https://avatars.githubusercontent.com/u/13556931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/clubby789", "html_url": "https://github.com/clubby789", "followers_url": "https://api.github.com/users/clubby789/followers", "following_url": "https://api.github.com/users/clubby789/following{/other_user}", "gists_url": "https://api.github.com/users/clubby789/gists{/gist_id}", "starred_url": "https://api.github.com/users/clubby789/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/clubby789/subscriptions", "organizations_url": "https://api.github.com/users/clubby789/orgs", "repos_url": "https://api.github.com/users/clubby789/repos", "events_url": "https://api.github.com/users/clubby789/events{/privacy}", "received_events_url": "https://api.github.com/users/clubby789/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b435960c4cfd3975651c7051be56d7f5d6c201ab", "url": "https://api.github.com/repos/rust-lang/rust/commits/b435960c4cfd3975651c7051be56d7f5d6c201ab", "html_url": "https://github.com/rust-lang/rust/commit/b435960c4cfd3975651c7051be56d7f5d6c201ab"}], "stats": {"total": 54, "additions": 43, "deletions": 11}, "files": [{"sha": "bf830e276999ca5dde7c01a09a7edabd8965e7a2", "filename": "compiler/rustc_borrowck/src/diagnostics/mutability_errors.rs", "status": "modified", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/23c3a307300827dbd53637742905293b9240506a/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmutability_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/23c3a307300827dbd53637742905293b9240506a/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmutability_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmutability_errors.rs?ref=23c3a307300827dbd53637742905293b9240506a", "patch": "@@ -344,20 +344,25 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n                     } else {\n                         err.span_help(source_info.span, \"try removing `&mut` here\");\n                     }\n-                } else if decl.mutability == Mutability::Not\n-                    && !matches!(\n+                } else if decl.mutability == Mutability::Not {\n+                    if matches!(\n                         decl.local_info,\n                         Some(box LocalInfo::User(ClearCrossCrate::Set(BindingForm::ImplicitSelf(\n                             hir::ImplicitSelfKind::MutRef\n-                        ))))\n-                    )\n-                {\n-                    err.span_suggestion_verbose(\n-                        decl.source_info.span.shrink_to_lo(),\n-                        \"consider making the binding mutable\",\n-                        \"mut \",\n-                        Applicability::MachineApplicable,\n-                    );\n+                        ),)))\n+                    ) {\n+                        err.note(\n+                            \"as `Self` may be unsized, this call attempts to take `&mut &mut self`\",\n+                        );\n+                        err.note(\"however, `&mut self` expands to `self: &mut Self`, therefore `self` cannot be borrowed mutably\");\n+                    } else {\n+                        err.span_suggestion_verbose(\n+                            decl.source_info.span.shrink_to_lo(),\n+                            \"consider making the binding mutable\",\n+                            \"mut \",\n+                            Applicability::MachineApplicable,\n+                        );\n+                    };\n                 }\n             }\n "}, {"sha": "2e608c5db3e1d160c6548ce81bad3c92a1a91494", "filename": "src/test/ui/borrowck/issue-93078.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/23c3a307300827dbd53637742905293b9240506a/src%2Ftest%2Fui%2Fborrowck%2Fissue-93078.rs", "raw_url": "https://github.com/rust-lang/rust/raw/23c3a307300827dbd53637742905293b9240506a/src%2Ftest%2Fui%2Fborrowck%2Fissue-93078.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fissue-93078.rs?ref=23c3a307300827dbd53637742905293b9240506a", "patch": "@@ -0,0 +1,15 @@\n+trait Modify {\n+    fn modify(&mut self) ;\n+}\n+\n+impl<T> Modify for T  {\n+    fn modify(&mut self)  {}\n+}\n+\n+trait Foo {\n+    fn mute(&mut self) {\n+        self.modify(); //~ ERROR cannot borrow `self` as mutable\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "771a652a1739cfb1c2f461d9da0afb7d656b07f8", "filename": "src/test/ui/borrowck/issue-93078.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/23c3a307300827dbd53637742905293b9240506a/src%2Ftest%2Fui%2Fborrowck%2Fissue-93078.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/23c3a307300827dbd53637742905293b9240506a/src%2Ftest%2Fui%2Fborrowck%2Fissue-93078.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fissue-93078.stderr?ref=23c3a307300827dbd53637742905293b9240506a", "patch": "@@ -0,0 +1,12 @@\n+error[E0596]: cannot borrow `self` as mutable, as it is not declared as mutable\n+  --> $DIR/issue-93078.rs:11:9\n+   |\n+LL |         self.modify();\n+   |         ^^^^^^^^^^^^^ cannot borrow as mutable\n+   |\n+   = note: as `Self` may be unsized, this call attempts to take `&mut &mut self`\n+   = note: however, `&mut self` expands to `self: &mut Self`, therefore `self` cannot be borrowed mutably\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0596`."}]}