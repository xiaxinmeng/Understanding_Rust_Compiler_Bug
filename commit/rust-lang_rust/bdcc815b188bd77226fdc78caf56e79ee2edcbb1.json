{"sha": "bdcc815b188bd77226fdc78caf56e79ee2edcbb1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJkY2M4MTViMTg4YmQ3NzIyNmZkYzc4Y2FmNTZlNzllZTJlZGNiYjE=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2016-01-12T01:49:59Z"}, "committer": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2016-01-12T01:49:59Z"}, "message": "Merge pull request #762 from ConnorGBrewster/fix-#760\n\nWhere clause is on same line as fn if fn is empty Fixes #760", "tree": {"sha": "f221fa2ca7bcf15792456a2abae0b0bb45baeddd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f221fa2ca7bcf15792456a2abae0b0bb45baeddd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bdcc815b188bd77226fdc78caf56e79ee2edcbb1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bdcc815b188bd77226fdc78caf56e79ee2edcbb1", "html_url": "https://github.com/rust-lang/rust/commit/bdcc815b188bd77226fdc78caf56e79ee2edcbb1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bdcc815b188bd77226fdc78caf56e79ee2edcbb1/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b236819f7222c43749e500970b52ee671d68a67a", "url": "https://api.github.com/repos/rust-lang/rust/commits/b236819f7222c43749e500970b52ee671d68a67a", "html_url": "https://github.com/rust-lang/rust/commit/b236819f7222c43749e500970b52ee671d68a67a"}, {"sha": "749697d84594c78650f34dada25ee0c012a6b418", "url": "https://api.github.com/repos/rust-lang/rust/commits/749697d84594c78650f34dada25ee0c012a6b418", "html_url": "https://github.com/rust-lang/rust/commit/749697d84594c78650f34dada25ee0c012a6b418"}], "stats": {"total": 37, "additions": 21, "deletions": 16}, "files": [{"sha": "d81ff776126a82d11612d5fc3a0e9bebf33710ac", "filename": "src/items.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/bdcc815b188bd77226fdc78caf56e79ee2edcbb1/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdcc815b188bd77226fdc78caf56e79ee2edcbb1/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=bdcc815b188bd77226fdc78caf56e79ee2edcbb1", "patch": "@@ -21,6 +21,7 @@ use comment::{FindUncommented, contains_comment};\n use visitor::FmtVisitor;\n use rewrite::{Rewrite, RewriteContext};\n use config::{Config, BlockIndentStyle, Density, ReturnIndent, BraceStyle, StructLitStyle};\n+use syntax::codemap;\n \n use syntax::{ast, abi};\n use syntax::codemap::{Span, BytePos, mk_sp};\n@@ -180,6 +181,10 @@ impl<'a> FmtVisitor<'a> {\n         let mut newline_brace = newline_for_brace(self.config, &generics.where_clause);\n         let context = self.get_context();\n \n+        let block_snippet = self.snippet(codemap::mk_sp(block.span.lo, block.span.hi));\n+        let has_body = !block_snippet[1..block_snippet.len() - 1].trim().is_empty() ||\n+                       !context.config.fn_empty_single_line;\n+\n         let (mut result, force_newline_brace) = try_opt!(rewrite_fn_base(&context,\n                                                                          indent,\n                                                                          ident,\n@@ -192,7 +197,7 @@ impl<'a> FmtVisitor<'a> {\n                                                                          vis,\n                                                                          span,\n                                                                          newline_brace,\n-                                                                         true));\n+                                                                         has_body));\n \n         if self.config.fn_brace_style != BraceStyle::AlwaysNextLine && !result.contains('\\n') {\n             newline_brace = false;\n@@ -1196,7 +1201,7 @@ fn rewrite_fn_base(context: &RewriteContext,\n                            (context.config.fn_args_layout == StructLitStyle::Block &&\n                             ret_str.is_empty()) ||\n                            (context.config.where_density == Density::CompressedIfEmpty &&\n-                            !has_body) {\n+                            !has_body && !result.contains('\\n')) {\n         Density::Compressed\n     } else {\n         Density::Tall\n@@ -1213,6 +1218,12 @@ fn rewrite_fn_base(context: &RewriteContext,\n                                                          where_density,\n                                                          \"{\",\n                                                          Some(span.hi)));\n+\n+    if last_line_width(&result) + where_clause_str.len() > context.config.max_width &&\n+       !where_clause_str.contains('\\n') {\n+        result.push('\\n');\n+    }\n+\n     result.push_str(&where_clause_str);\n \n     Some((result, force_new_line_for_brace))"}, {"sha": "6d7f764d28002150f69a6e58e1cbccafce703263", "filename": "tests/source/fn-single-line.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/bdcc815b188bd77226fdc78caf56e79ee2edcbb1/tests%2Fsource%2Ffn-single-line.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdcc815b188bd77226fdc78caf56e79ee2edcbb1/tests%2Fsource%2Ffn-single-line.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Ffn-single-line.rs?ref=bdcc815b188bd77226fdc78caf56e79ee2edcbb1", "patch": "@@ -74,3 +74,6 @@ trait CoolTypes {\n trait CoolerTypes { fn dummy(&self) { \n }\n }\n+\n+fn Foo<T>() where T: Bar {\n+}"}, {"sha": "049206b60c8b21b6c859308125f062e6fa2f87d0", "filename": "tests/target/fn-single-line.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/bdcc815b188bd77226fdc78caf56e79ee2edcbb1/tests%2Ftarget%2Ffn-single-line.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdcc815b188bd77226fdc78caf56e79ee2edcbb1/tests%2Ftarget%2Ffn-single-line.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Ffn-single-line.rs?ref=bdcc815b188bd77226fdc78caf56e79ee2edcbb1", "patch": "@@ -61,3 +61,5 @@ trait CoolTypes {\n trait CoolerTypes {\n     fn dummy(&self) {}\n }\n+\n+fn Foo<T>() where T: Bar {}"}, {"sha": "02600f43f2a695195d427019269bc56fcdae6d05", "filename": "tests/target/fn.rs", "status": "modified", "additions": 3, "deletions": 14, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/bdcc815b188bd77226fdc78caf56e79ee2edcbb1/tests%2Ftarget%2Ffn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdcc815b188bd77226fdc78caf56e79ee2edcbb1/tests%2Ftarget%2Ffn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Ffn.rs?ref=bdcc815b188bd77226fdc78caf56e79ee2edcbb1", "patch": "@@ -2,17 +2,9 @@\n \n fn foo(a: AAAA, b: BBB, c: CCC) -> RetType {}\n \n-fn foo(a: AAAA, b: BBB /* some, weird, inline comment */, c: CCC) -> RetType\n-    where T: Blah\n-{\n+fn foo(a: AAAA, b: BBB /* some, weird, inline comment */, c: CCC) -> RetType where T: Blah {}\n \n-}\n-\n-fn foo(a: AAA /* (comment) */)\n-    where T: Blah\n-{\n-\n-}\n+fn foo(a: AAA /* (comment) */) where T: Blah {}\n \n fn foo(a: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,\n        b: BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB)\n@@ -35,10 +27,7 @@ fn foo<U, T>(a: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,\n fn foo<U: Fn(A) -> B /* paren inside generics */>() {}\n \n impl Foo {\n-    fn with_no_errors<T, F>(&mut self, f: F) -> T\n-        where F: FnOnce(&mut Resolver) -> T\n-    {\n-    }\n+    fn with_no_errors<T, F>(&mut self, f: F) -> T where F: FnOnce(&mut Resolver) -> T {}\n \n     fn foo(mut self, mut bar: u32) {}\n "}]}