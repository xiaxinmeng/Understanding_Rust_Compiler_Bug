{"sha": "a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEwZmYzZGIyNThkZWU0YWE2MDE3ZDFiYjFiZDhiNmY1MjM5NGE1YzA=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-11-02T00:09:44Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-11-05T20:23:11Z"}, "message": "LLVM build cleanup", "tree": {"sha": "4af8df862f0f201b53cd9c657cd19bce26b7ebda", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4af8df862f0f201b53cd9c657cd19bce26b7ebda"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0", "html_url": "https://github.com/rust-lang/rust/commit/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e47f410536899d2653f86ff374809f1c63ec8ae6", "url": "https://api.github.com/repos/rust-lang/rust/commits/e47f410536899d2653f86ff374809f1c63ec8ae6", "html_url": "https://github.com/rust-lang/rust/commit/e47f410536899d2653f86ff374809f1c63ec8ae6"}], "stats": {"total": 53, "additions": 35, "deletions": 18}, "files": [{"sha": "7e84f9a49f91c38f079e4e7c28b485e8d94c0d5a", "filename": "Makefile.in", "status": "modified", "additions": 17, "deletions": 6, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0/Makefile.in", "raw_url": "https://github.com/rust-lang/rust/raw/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0/Makefile.in", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Makefile.in?ref=a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0", "patch": "@@ -62,8 +62,6 @@ CFG_INFO := $(info cfg: make restarts: $(MAKE_RESTARTS))\n endif\n \n CFG_INFO := $(info cfg: shell host triple $(CFG_HOST_TRIPLE))\n-CFG_INFO := $(info cfg: llvm host triple $(CFG_LLVM_TRIPLE))\n-CFG_INFO := $(info cfg: llvm target triples $(CFG_TARGET_TRIPLES))\n \n ifdef CFG_DISABLE_OPTIMIZE\n   $(info cfg: disabling rustc optimization (CFG_DISABLE_OPTIMIZE))\n@@ -194,6 +192,23 @@ COMPILER_CRATE := $(S)src/comp/rustc.rc\n COMPILER_INPUTS := $(wildcard $(addprefix $(S)src/comp/, \\\n                                 rustc.rc *.rs */*.rs */*/*.rs))\n \n+######################################################################\n+# LLVM macros\n+######################################################################\n+\n+LLVM_CONFIG:=$(CFG_LLVM_INST_DIR)/bin/llvm-config\n+LLVM_VERSION=$(shell \"$(LLVM_CONFIG)\" --version)\n+LLVM_BINDIR=$(shell \"$(LLVM_CONFIG)\" --bindir)\n+LLVM_INCDIR=$(shell \"$(LLVM_CONFIG)\" --includedir)\n+LLVM_LIBDIR=$(shell \"$(LLVM_CONFIG)\" --libdir)\n+LLVM_LIBS=$(shell \"$(LLVM_CONFIG)\" --libs)\n+LLVM_LDFLAGS=$(shell \"$(LLVM_CONFIG)\" --ldflags)\n+LLVM_CXXFLAGS=$(shell \"$(LLVM_CONFIG)\" --cxxflags)\n+LLVM_HOST_TRIPLE=$(shell \"$(LLVM_CONFIG)\" --host-target)\n+\n+LLVM_AS=$(CFG_LLVM_BINDIR)/llvm-as$(X)\n+LLC=$(CFG_LLVM_BINDIR)/llc$(X)\n+\n ######################################################################\n # Exports for sub-utilities\n ######################################################################\n@@ -213,10 +228,6 @@ export CFG_PREFIX\n # Subprograms\n ######################################################################\n \n-LLVM_AS := $(CFG_LLVM_BINDIR)/llvm-as$(X)\n-\n-LLC := $(CFG_LLVM_BINDIR)/llc$(X)\n-\n ######################################################################\n # Per-stage targets and runner\n ######################################################################"}, {"sha": "3a5017a59c7f810eef80fdcfdc073ee6418632c2", "filename": "configure", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0/configure", "raw_url": "https://github.com/rust-lang/rust/raw/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0/configure", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/configure?ref=a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0", "patch": "@@ -498,13 +498,14 @@ step_msg \"configuring LLVM\"\n \n CFG_LLVM_SRC_DIR=${CFG_SRC_DIR}src/llvm\n CFG_LLVM_BUILD_DIR=${CFG_BUILD_DIR}/llvm\n+# Just use LLVM straight from its build directory to avoid 'make install' time\n CFG_LLVM_INST_DIR=${CFG_LLVM_BUILD_DIR}/Release+Asserts\n \n LLVM_TARGETS=\"--enable-targets=x86,x86_64\"\n-LLVM_DISABLE=\"--disable-docs\"\n LLVM_BUILD=\"--build=${CFG_HOST_TRIPLE}\"\n LLVM_HOST=\"--host=${CFG_HOST_TRIPLE}\"\n LLVM_TARGET=\"--target=${CFG_HOST_TRIPLE}\"\n+LLVM_OPTS=\"--enable-optimized --disable-docs\"\n \n LLVM_CXX_32=\"g++ -m32\"\n LLVM_CC_32=\"gcc -m32\"\n@@ -525,7 +526,10 @@ CFLAGS=$LLVM_CFLAGS\n CXXFLAGS=$LLVM_CXXFLAGS\n LDFLAGS=$LLVM_LDFLAGS\n \n-LLVM_FLAGS=\"$LLVM_TARGETS $LLVM_DISABLE $LLVM_BUILD $LLVM_HOST $LLVM_TARGET\"\n+LLVM_FLAGS=\"$LLVM_TARGETS $LLVM_OPTS $LLVM_BUILD $LLVM_HOST $LLVM_TARGET\"\n+\n+msg \"configuring LLVM with:\"\n+msg \"$LLVM_FLAGS\"\n \n export CXX\n export CC"}, {"sha": "04d7a5c77e6bda80b29cda3a877b125714bb29d7", "filename": "mk/autodep.mk", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0/mk%2Fautodep.mk", "raw_url": "https://github.com/rust-lang/rust/raw/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0/mk%2Fautodep.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fautodep.mk?ref=a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0", "patch": "@@ -14,11 +14,11 @@ rt/%.d: rt/%.cpp $(MKFILES)\n \t$(Q)rm -f $@.tmp.bak\n \t$(Q)mv $@.tmp $@\n \n-rustllvm/%.d: rustllvm/%.cpp $(MKFILES)\n+rustllvm/%.d: rustllvm/%.cpp $(MKFILES) $(LLVM_CONFIG)\n \t@$(call E, dep: $@)\n \t$(Q)$(call CFG_DEPEND_C, $@ \\\n       $(subst $(S)src/,,$(patsubst %.cpp, %.o, $<)), \\\n-      $(CFG_LLVM_CXXFLAGS) $(RUSTLLVM_INCS)) $< >$@.tmp\n+      $(LLVM_CXXFLAGS) $(RUSTLLVM_INCS)) $< >$@.tmp\n \t$(Q)$(CFG_PATH_MUNGE) $@.tmp\n \t$(Q)rm -f $@.tmp.bak\n \t$(Q)mv $@.tmp $@"}, {"sha": "d807565e384a0b97893cf965d3e61efe4637ef89", "filename": "mk/llvm.mk", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0/mk%2Fllvm.mk", "raw_url": "https://github.com/rust-lang/rust/raw/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0/mk%2Fllvm.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fllvm.mk?ref=a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0", "patch": "@@ -1,5 +1,7 @@\n-.PHONY: $(CFG_LLVM_INST_DIR)/bin/llc\n+# This is just a rough approximation of LLVM deps\n+LLVM_DEPS:=$(wildcard $(addprefix $(CFG_LLVM_SRC_DIR)/, \\\n+                        * */*h */*/*h */*/*/*h */*cpp */*/*cpp */*/*/*cpp))\n \n-$(CFG_LLVM_INST_DIR)/bin/llc:\n+$(LLVM_CONFIG): $(LLVM_DEPS)\n \t@$(call E, make: llvm)\n \t$(Q)make -C $(CFG_LLVM_BUILD_DIR)\n\\ No newline at end of file"}, {"sha": "f712e043cd414ac91c9bb1923997259465896af1", "filename": "mk/platform.mk", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0/mk%2Fplatform.mk", "raw_url": "https://github.com/rust-lang/rust/raw/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0/mk%2Fplatform.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fplatform.mk?ref=a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0", "patch": "@@ -154,7 +154,6 @@ ifdef CFG_WINDOWSY\n   CFG_EXE_SUFFIX := .exe\n   CFG_LIB_NAME=$(1).dll\n   CFG_DEF_SUFFIX := .def\n-  CFG_LDPATH :=$(CFG_LLVM_BINDIR)\n   CFG_LDPATH :=$(CFG_LDPATH):$$PATH\n   CFG_RUN=PATH=\"$(CFG_LDPATH):$(1)\" $(2)\n   CFG_RUN_TARG=$(call CFG_RUN,$(HOST_LIB$(1)),$(2))"}, {"sha": "4b16bff7d305fad3575f93270bf28aa584365433", "filename": "mk/rustllvm.mk", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0/mk%2Frustllvm.mk", "raw_url": "https://github.com/rust-lang/rust/raw/a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0/mk%2Frustllvm.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Frustllvm.mk?ref=a0ff3db258dee4aa6017d1bb1bd8b6f52394a5c0", "patch": "@@ -14,21 +14,22 @@ endif\n \n RUSTLLVM_DEF_$(1) := rustllvm/rustllvm$$(CFG_DEF_SUFFIX)\n \n-RUSTLLVM_INCS_$(1) := -iquote $$(CFG_LLVM_INCDIR) \\\n+RUSTLLVM_INCS_$(1) := -iquote $$(LLVM_INCDIR) \\\n                       -iquote $$(S)src/rustllvm/include\n RUSTLLVM_OBJS_OBJS_$(1) := $$(RUSTLLVM_OBJS_CS_$(1):rustllvm/%.cpp=rustllvm/$(1)/%.o)\n \n rustllvm/$(1)/$(CFG_RUSTLLVM): $$(RUSTLLVM_OBJS_OBJS_$(1)) \\\n                           $$(MKFILES) $$(RUSTLLVM_DEF_$(1))\n \t@$$(call E, link: $$@)\n \t$$(Q)$$(call CFG_LINK_C_$(1),$$@,$$(RUSTLLVM_OBJS_OBJS_$(1)) \\\n-\t  $$(CFG_GCCISH_PRE_LIB_FLAGS) $$(CFG_LLVM_LIBS) \\\n+\t  $$(CFG_GCCISH_PRE_LIB_FLAGS) $$(LLVM_LIBS) \\\n           $$(CFG_GCCISH_POST_LIB_FLAGS) \\\n-          $$(CFG_LLVM_LDFLAGS),$$(RUSTLLVM_DEF_$(1)),$$(CFG_RUSTLLVM))\n+          $$(LLVM_LDFLAGS),$$(RUSTLLVM_DEF_$(1)),$$(CFG_RUSTLLVM))\n \n-rustllvm/$(1)/%.o: rustllvm/%.cpp $$(MKFILES) $$(CFG_LLVM_INST_DIR)/bin/llc\n+rustllvm/$(1)/%.o: rustllvm/%.cpp $$(MKFILES) \\\n+\t\t$$(CFG_LLVM_INST_DIR)/bin/llvm-config\n \t@$$(call E, compile: $$@)\n-\t$$(Q)$$(call CFG_COMPILE_C_$(1), $$@, $$(CFG_LLVM_CXXFLAGS) $$(RUSTLLVM_INCS_$(1))) $$<\n+\t$$(Q)$$(call CFG_COMPILE_C_$(1), $$@, $$(LLVM_CXXFLAGS) $$(RUSTLLVM_INCS_$(1))) $$<\n endef\n \n # Instantiate template for all stages"}]}