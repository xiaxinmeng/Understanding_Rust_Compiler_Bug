{"sha": "34c0f4698bda7e06d66ee9040a2923250b0c12d0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM0YzBmNDY5OGJkYTdlMDZkNjZlZTkwNDBhMjkyMzI1MGIwYzEyZDA=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-07-28T01:01:55Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-07-28T01:01:55Z"}, "message": "Rollup merge of #63050 - pietroalbini:vendor-awscli, r=Mark-Simulacrum\n\nci: download awscli from our mirror\n\nThis fixes multiple network issues we had when downloading awscli from PyPI on Azure Pipelines by vendoring awscli itself and its dependencies in our S3 bucket. Instructions on how to update the cache are present at the top of `src/ci/install-awscli.sh`.\n\nr? @alexcrichton or @Mark-Simulacrum\nfixes #62967", "tree": {"sha": "ddecacf7cf04b32211999b7d65dae0bbf2012102", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ddecacf7cf04b32211999b7d65dae0bbf2012102"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/34c0f4698bda7e06d66ee9040a2923250b0c12d0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdPPQDCRBK7hj4Ov3rIwAAdHIIAE/6ArVhgtMqqZZk/avlYhSI\n9OoDyp5fIg/p0gE80d+3lZuc0+ITiPeWXSlKZDakYbzeThmon+VUUDitJpMqpmbA\nANkEMVOWzXM5ixQ82XCpEBxpVIDoTi2j+YyH5vETF639kp57Pv4V6lWNOwr8QHHh\ncRQ5Zmva45KYOK8Ks3QlSJin7ReAFQVfhXTDN5EvCKdeHLtAP2HFycQf1EzFxXVm\nCZo8SDKl9Name2CuU6OQBk57Miu3v0JpO7uRvzphWZ/aMiNDyRlDZKv0/cTCXxTW\nau/9xkv6yN0fzUlosB91G2WHt/vDbm1S33qewncTgvUt1FMHz7mO3wg6twc0fPo=\n=F8Ta\n-----END PGP SIGNATURE-----\n", "payload": "tree ddecacf7cf04b32211999b7d65dae0bbf2012102\nparent 5c7008540d9e7939d51f7582e13c4d3fefdcd170\nparent 75dfdcb065231811bc9977da1aaf0e66889cbbce\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1564275715 +0200\ncommitter GitHub <noreply@github.com> 1564275715 +0200\n\nRollup merge of #63050 - pietroalbini:vendor-awscli, r=Mark-Simulacrum\n\nci: download awscli from our mirror\n\nThis fixes multiple network issues we had when downloading awscli from PyPI on Azure Pipelines by vendoring awscli itself and its dependencies in our S3 bucket. Instructions on how to update the cache are present at the top of `src/ci/install-awscli.sh`.\n\nr? @alexcrichton or @Mark-Simulacrum\nfixes #62967\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/34c0f4698bda7e06d66ee9040a2923250b0c12d0", "html_url": "https://github.com/rust-lang/rust/commit/34c0f4698bda7e06d66ee9040a2923250b0c12d0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/34c0f4698bda7e06d66ee9040a2923250b0c12d0/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5c7008540d9e7939d51f7582e13c4d3fefdcd170", "url": "https://api.github.com/repos/rust-lang/rust/commits/5c7008540d9e7939d51f7582e13c4d3fefdcd170", "html_url": "https://github.com/rust-lang/rust/commit/5c7008540d9e7939d51f7582e13c4d3fefdcd170"}, {"sha": "75dfdcb065231811bc9977da1aaf0e66889cbbce", "url": "https://api.github.com/repos/rust-lang/rust/commits/75dfdcb065231811bc9977da1aaf0e66889cbbce", "html_url": "https://github.com/rust-lang/rust/commit/75dfdcb065231811bc9977da1aaf0e66889cbbce"}], "stats": {"total": 90, "additions": 40, "deletions": 50}, "files": [{"sha": "1e49cc00921cd7ad5a6ff17828aa814eb93df8a4", "filename": ".azure-pipelines/steps/run.yml", "status": "modified", "additions": 5, "deletions": 37, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/34c0f4698bda7e06d66ee9040a2923250b0c12d0/.azure-pipelines%2Fsteps%2Frun.yml", "raw_url": "https://github.com/rust-lang/rust/raw/34c0f4698bda7e06d66ee9040a2923250b0c12d0/.azure-pipelines%2Fsteps%2Frun.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Frun.yml?ref=34c0f4698bda7e06d66ee9040a2923250b0c12d0", "patch": "@@ -138,43 +138,11 @@ steps:\n \n # Ensure the `aws` CLI is installed so we can deploy later on, cache docker\n # images, etc.\n-- bash: |\n-    set -e\n-    # Temporary code to debug #62967.\n-    debug_failed_connections() {\n-        echo \"trying to ping pypi.org\"\n-        ping pypi.org -c10 || true\n-        echo \"trying to ping google.com\"\n-        ping google.com -c10 || true\n-        echo \"trying to ping 8.8.8.8\"\n-        ping 8.8.8.8 -c10 || true\n-        echo \"trying to download pypi.org\"\n-        curl https://pypi.org || true\n-        echo \"trying to download from our S3 bucket\"\n-        curl https://rust-lang-ci2.s3.amazonaws.com || true\n-        echo \"trying to dig pypi.org\"\n-        dig pypi.org || true\n-        echo \"trying to dig files.pythonhosted.org\"\n-        dig files.pythonhosted.org || true\n-        echo \"trying to connect to pypi.org with openssl\"\n-        echo | openssl s_client -connect pypi.org:443 || true\n-        echo \"trying to connect to files.pythonhosted.org with openssl\"\n-        echo | openssl s_client -connect files.pythonhosted.org:443 || true\n-    }\n-    debug_failed_connections_and_fail() {\n-        debug_failed_connections\n-        return 1\n-    }\n-    source src/ci/shared.sh\n-    sudo apt-get install -y python3-setuptools\n-    debug_failed_connections\n-    retry pip3 install -r src/ci/awscli-requirements.txt --upgrade --user || debug_failed_connections_and_fail\n-    echo \"##vso[task.prependpath]$HOME/.local/bin\"\n-  displayName: Install awscli (Linux)\n-  condition: and(succeeded(), not(variables.SKIP_JOB), eq(variables['Agent.OS'], 'Linux'))\n-- script: pip install -r src/ci/awscli-requirements.txt\n-  displayName: Install awscli (non-Linux)\n-  condition: and(succeeded(), not(variables.SKIP_JOB), ne(variables['Agent.OS'], 'Linux'))\n+- bash: src/ci/install-awscli.sh\n+  env:\n+    AGENT_OS: $(Agent.OS)\n+  condition: and(succeeded(), not(variables.SKIP_JOB))\n+  displayName: Install awscli\n \n # Configure our CI_JOB_NAME variable which log analyzers can use for the main\n # step to see what's going on."}, {"sha": "c1ffa525a1b41509a20416831ce605c4670f2815", "filename": "src/ci/awscli-requirements.txt", "status": "removed", "additions": 0, "deletions": 13, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/5c7008540d9e7939d51f7582e13c4d3fefdcd170/src%2Fci%2Fawscli-requirements.txt", "raw_url": "https://github.com/rust-lang/rust/raw/5c7008540d9e7939d51f7582e13c4d3fefdcd170/src%2Fci%2Fawscli-requirements.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fawscli-requirements.txt?ref=5c7008540d9e7939d51f7582e13c4d3fefdcd170", "patch": "@@ -1,13 +0,0 @@\n-awscli==1.16.201\n-botocore==1.12.191\n-colorama==0.3.9\n-docutils==0.14\n-jmespath==0.9.4\n-pyasn1==0.4.5\n-python-dateutil==2.8.0\n-PyYAML==5.1\n-rsa==3.4.2\n-s3transfer==0.2.1\n-six==1.12.0\n-urllib3==1.25.3\n-futures==3.3.0; python_version < '3.0'"}, {"sha": "d491b9fbcdcf81a6ae67ac5496fe05b5f8635fb2", "filename": "src/ci/install-awscli.sh", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/34c0f4698bda7e06d66ee9040a2923250b0c12d0/src%2Fci%2Finstall-awscli.sh", "raw_url": "https://github.com/rust-lang/rust/raw/34c0f4698bda7e06d66ee9040a2923250b0c12d0/src%2Fci%2Finstall-awscli.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Finstall-awscli.sh?ref=34c0f4698bda7e06d66ee9040a2923250b0c12d0", "patch": "@@ -0,0 +1,35 @@\n+#!/bin/bash\n+# This script downloads and installs awscli from the packages mirrored in our\n+# own S3 bucket. This follows the recommendations at:\n+#\n+#    https://packaging.python.org/guides/index-mirrors-and-caches/#caching-with-pip\n+#\n+# To create a new mirrored copy you can run the command:\n+#\n+#    pip wheel awscli\n+#\n+# Before compressing please make sure all the wheels end with `-none-any.whl`.\n+# If that's not the case you'll need to remove the non-cross-platform ones and\n+# replace them with the .tar.gz downloaded from https://pypi.org. Also make\n+# sure it's possible to call this script with both Python 2 and Python 3.\n+\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+MIRROR=\"https://rust-lang-ci2.s3.amazonaws.com/rust-ci-mirror/2019-07-27-awscli.tar\"\n+DEPS_DIR=\"/tmp/awscli-deps\"\n+\n+pip=\"pip\"\n+pipflags=\"\"\n+if [[ \"${AGENT_OS}\" == \"Linux\" ]]; then\n+    pip=\"pip3\"\n+    pipflags=\"--user\"\n+\n+    sudo apt-get install -y python3-setuptools\n+    echo \"##vso[task.prependpath]$HOME/.local/bin\"\n+fi\n+\n+mkdir -p \"${DEPS_DIR}\"\n+curl \"${MIRROR}\" | tar xf - -C \"${DEPS_DIR}\"\n+\"${pip}\" install ${pipflags} --no-index \"--find-links=${DEPS_DIR}\" awscli\n+rm -rf \"${DEPS_DIR}\""}]}