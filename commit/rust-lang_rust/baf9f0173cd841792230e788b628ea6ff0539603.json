{"sha": "baf9f0173cd841792230e788b628ea6ff0539603", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJhZjlmMDE3M2NkODQxNzkyMjMwZTc4OGI2MjhlYTZmZjA1Mzk2MDM=", "commit": {"author": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2018-12-15T22:00:46Z"}, "committer": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2018-12-15T22:00:46Z"}, "message": "fix trait objects with a Self-having projection va\n\nThis follows ALT2 in the issue.\n\nFixes #56288.", "tree": {"sha": "9bce33c027da05db0e2bea2e7b3aadbf222802dd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9bce33c027da05db0e2bea2e7b3aadbf222802dd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/baf9f0173cd841792230e788b628ea6ff0539603", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/baf9f0173cd841792230e788b628ea6ff0539603", "html_url": "https://github.com/rust-lang/rust/commit/baf9f0173cd841792230e788b628ea6ff0539603", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/baf9f0173cd841792230e788b628ea6ff0539603/comments", "author": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0a1b2267e45ed0a5bdbfcbe522024729c8bd1387", "url": "https://api.github.com/repos/rust-lang/rust/commits/0a1b2267e45ed0a5bdbfcbe522024729c8bd1387", "html_url": "https://github.com/rust-lang/rust/commit/0a1b2267e45ed0a5bdbfcbe522024729c8bd1387"}], "stats": {"total": 106, "additions": 103, "deletions": 3}, "files": [{"sha": "fe40141a5e12352ed43dbda110f5e9dd15f42a28", "filename": "src/librustc/traits/object_safety.rs", "status": "modified", "additions": 20, "deletions": 1, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/baf9f0173cd841792230e788b628ea6ff0539603/src%2Flibrustc%2Ftraits%2Fobject_safety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/baf9f0173cd841792230e788b628ea6ff0539603/src%2Flibrustc%2Ftraits%2Fobject_safety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fobject_safety.rs?ref=baf9f0173cd841792230e788b628ea6ff0539603", "patch": "@@ -190,7 +190,26 @@ impl<'a, 'tcx> TyCtxt<'a, 'tcx, 'tcx> {\n                         // In the case of a trait predicate, we can skip the \"self\" type.\n                         data.skip_binder().input_types().skip(1).any(|t| t.has_self_ty())\n                     }\n-                    ty::Predicate::Projection(..) |\n+                    ty::Predicate::Projection(ref data) => {\n+                        // And similarly for projections. This should be redundant with\n+                        // the previous check because any projection should have a\n+                        // matching `Trait` predicate with the same inputs, but we do\n+                        // the check to be safe.\n+                        //\n+                        // Note that we *do* allow projection *outputs* to contain\n+                        // `self` (i.e., `trait Foo: Bar<Output=Self::Result> { type Result; }`),\n+                        // we just require the user to specify *both* outputs\n+                        // in the object type (i.e., `dyn Foo<Output=(), Result=()>`).\n+                        //\n+                        // This is ALT2 in issue #56288, see that for discussion of the\n+                        // possible alternatives.\n+                        data.skip_binder()\n+                            .projection_ty\n+                            .trait_ref(self)\n+                            .input_types()\n+                            .skip(1)\n+                            .any(|t| t.has_self_ty())\n+                    }\n                     ty::Predicate::WellFormed(..) |\n                     ty::Predicate::ObjectSafe(..) |\n                     ty::Predicate::TypeOutlives(..) |"}, {"sha": "ab1eeffc6217aea6fd1fa63be96a91fbd9d5417a", "filename": "src/librustc_typeck/astconv.rs", "status": "modified", "additions": 26, "deletions": 2, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/baf9f0173cd841792230e788b628ea6ff0539603/src%2Flibrustc_typeck%2Fastconv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/baf9f0173cd841792230e788b628ea6ff0539603/src%2Flibrustc_typeck%2Fastconv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fastconv.rs?ref=baf9f0173cd841792230e788b628ea6ff0539603", "patch": "@@ -1013,15 +1013,39 @@ impl<'o, 'gcx: 'tcx, 'tcx> dyn AstConv<'gcx, 'tcx> + 'o {\n         let mut associated_types = BTreeSet::default();\n \n         for tr in traits::elaborate_trait_ref(tcx, principal) {\n+            debug!(\"conv_object_ty_poly_trait_ref: observing object predicate `{:?}`\", tr);\n             match tr {\n                 ty::Predicate::Trait(pred) => {\n                     associated_types.extend(tcx.associated_items(pred.def_id())\n                                     .filter(|item| item.kind == ty::AssociatedKind::Type)\n                                     .map(|item| item.def_id));\n                 }\n                 ty::Predicate::Projection(pred) => {\n-                    // Include projections defined on supertraits.\n-                    projection_bounds.push((pred, DUMMY_SP))\n+                    // A `Self` within the original bound will be substituted with a\n+                    // `TRAIT_OBJECT_DUMMY_SELF`, so check for that.\n+                    let references_self =\n+                        pred.skip_binder().ty.walk().any(|t| t == dummy_self);\n+\n+                    // If the projection output contains `Self`, force the user to\n+                    // elaborate it explicitly to avoid a bunch of complexity.\n+                    //\n+                    // The \"classicaly useful\" case is the following:\n+                    // ```\n+                    //     trait MyTrait: FnMut() -> <Self as MyTrait>::MyOutput {\n+                    //         type MyOutput;\n+                    //     }\n+                    // ```\n+                    //\n+                    // Here, the user could theoretically write `dyn MyTrait<Output=X>`,\n+                    // but actually supporting that would \"expand\" to an infinitely-long type\n+                    // `fix $ \u03c4 \u2192 dyn MyTrait<MyOutput=X, Output=<\u03c4 as MyTrait>::MyOutput`.\n+                    //\n+                    // Instead, we force the user to write `dyn MyTrait<MyOutput=X, Output=X>`,\n+                    // which is uglier but works. See the discussion in #56288 for alternatives.\n+                    if !references_self {\n+                        // Include projections defined on supertraits,\n+                        projection_bounds.push((pred, DUMMY_SP))\n+                    }\n                 }\n                 _ => ()\n             }"}, {"sha": "b157ef6ed5d99a57aaa55110fa8cfdc203e87d24", "filename": "src/test/ui/traits/trait-object-with-self-in-projection-output-bad.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/baf9f0173cd841792230e788b628ea6ff0539603/src%2Ftest%2Fui%2Ftraits%2Ftrait-object-with-self-in-projection-output-bad.rs", "raw_url": "https://github.com/rust-lang/rust/raw/baf9f0173cd841792230e788b628ea6ff0539603/src%2Ftest%2Fui%2Ftraits%2Ftrait-object-with-self-in-projection-output-bad.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Ftrait-object-with-self-in-projection-output-bad.rs?ref=baf9f0173cd841792230e788b628ea6ff0539603", "patch": "@@ -0,0 +1,22 @@\n+trait Base {\n+    type Output;\n+}\n+\n+trait Helper: Base<Output=<Self as Helper>::Target> {\n+    type Target;\n+}\n+\n+impl Base for u32\n+{\n+    type Output = i32;\n+}\n+\n+impl Helper for u32\n+{\n+    type Target = i32;\n+}\n+\n+fn main() {\n+    let _x: Box<dyn Helper<Target=i32>> = Box::new(2u32);\n+    //~^ ERROR the value of the associated type `Output` (from the trait `Base`) must be specified\n+}"}, {"sha": "c2e274b0245f7d1b42753471df91e25c23c2692b", "filename": "src/test/ui/traits/trait-object-with-self-in-projection-output-bad.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/baf9f0173cd841792230e788b628ea6ff0539603/src%2Ftest%2Fui%2Ftraits%2Ftrait-object-with-self-in-projection-output-bad.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/baf9f0173cd841792230e788b628ea6ff0539603/src%2Ftest%2Fui%2Ftraits%2Ftrait-object-with-self-in-projection-output-bad.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Ftrait-object-with-self-in-projection-output-bad.stderr?ref=baf9f0173cd841792230e788b628ea6ff0539603", "patch": "@@ -0,0 +1,12 @@\n+error[E0191]: the value of the associated type `Output` (from the trait `Base`) must be specified\n+  --> $DIR/trait-object-with-self-in-projection-output-bad.rs:20:17\n+   |\n+LL |     type Output;\n+   |     ------------ `Output` defined here\n+...\n+LL |     let _x: Box<dyn Helper<Target=i32>> = Box::new(2u32);\n+   |                 ^^^^^^^^^^^^^^^^^^^^^^ associated type `Output` must be specified\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0191`."}, {"sha": "07681086e16ef6e997770658cca84e4821bce229", "filename": "src/test/ui/traits/trait-object-with-self-in-projection-output-good.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/baf9f0173cd841792230e788b628ea6ff0539603/src%2Ftest%2Fui%2Ftraits%2Ftrait-object-with-self-in-projection-output-good.rs", "raw_url": "https://github.com/rust-lang/rust/raw/baf9f0173cd841792230e788b628ea6ff0539603/src%2Ftest%2Fui%2Ftraits%2Ftrait-object-with-self-in-projection-output-good.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Ftrait-object-with-self-in-projection-output-good.rs?ref=baf9f0173cd841792230e788b628ea6ff0539603", "patch": "@@ -0,0 +1,23 @@\n+// compile-pass\n+\n+trait Base {\n+    type Output;\n+}\n+\n+trait Helper: Base<Output=<Self as Helper>::Target> {\n+    type Target;\n+}\n+\n+impl Base for u32\n+{\n+    type Output = i32;\n+}\n+\n+impl Helper for u32\n+{\n+    type Target = i32;\n+}\n+\n+fn main() {\n+    let _x: Box<dyn Helper<Target=i32, Output=i32>> = Box::new(2u32);\n+}"}]}