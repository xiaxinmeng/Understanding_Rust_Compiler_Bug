{"sha": "2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJjYmQ1ZDFkZjU0NDAwYjhiZDcxOGI3ZTBkYWRjNGMzOGM2Zjk5MzI=", "commit": {"author": {"name": "Beno\u00eet du Garreau", "email": "bdgdlm@outlook.com", "date": "2021-06-10T17:09:04Z"}, "committer": {"name": "Beno\u00eet du Garreau", "email": "bdgdlm@outlook.com", "date": "2021-06-10T17:16:55Z"}, "message": "Specialize `io::Bytes::size_hint` for more types", "tree": {"sha": "a7c9656ab869d5514c93b72061e7ee930a7d9c4b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a7c9656ab869d5514c93b72061e7ee930a7d9c4b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932", "html_url": "https://github.com/rust-lang/rust/commit/2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932/comments", "author": {"login": "a1phyr", "id": 47725341, "node_id": "MDQ6VXNlcjQ3NzI1MzQx", "avatar_url": "https://avatars.githubusercontent.com/u/47725341?v=4", "gravatar_id": "", "url": "https://api.github.com/users/a1phyr", "html_url": "https://github.com/a1phyr", "followers_url": "https://api.github.com/users/a1phyr/followers", "following_url": "https://api.github.com/users/a1phyr/following{/other_user}", "gists_url": "https://api.github.com/users/a1phyr/gists{/gist_id}", "starred_url": "https://api.github.com/users/a1phyr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/a1phyr/subscriptions", "organizations_url": "https://api.github.com/users/a1phyr/orgs", "repos_url": "https://api.github.com/users/a1phyr/repos", "events_url": "https://api.github.com/users/a1phyr/events{/privacy}", "received_events_url": "https://api.github.com/users/a1phyr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "a1phyr", "id": 47725341, "node_id": "MDQ6VXNlcjQ3NzI1MzQx", "avatar_url": "https://avatars.githubusercontent.com/u/47725341?v=4", "gravatar_id": "", "url": "https://api.github.com/users/a1phyr", "html_url": "https://github.com/a1phyr", "followers_url": "https://api.github.com/users/a1phyr/followers", "following_url": "https://api.github.com/users/a1phyr/following{/other_user}", "gists_url": "https://api.github.com/users/a1phyr/gists{/gist_id}", "starred_url": "https://api.github.com/users/a1phyr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/a1phyr/subscriptions", "organizations_url": "https://api.github.com/users/a1phyr/orgs", "repos_url": "https://api.github.com/users/a1phyr/repos", "events_url": "https://api.github.com/users/a1phyr/events{/privacy}", "received_events_url": "https://api.github.com/users/a1phyr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0279cb11ed98bdc589c66572477fd27f1dd3e0ac", "url": "https://api.github.com/repos/rust-lang/rust/commits/0279cb11ed98bdc589c66572477fd27f1dd3e0ac", "html_url": "https://github.com/rust-lang/rust/commit/0279cb11ed98bdc589c66572477fd27f1dd3e0ac"}], "stats": {"total": 99, "additions": 96, "deletions": 3}, "files": [{"sha": "32d194d9616523c6ae46a426acf602139ade7fbe", "filename": "library/std/src/io/buffered/bufreader.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932/library%2Fstd%2Fsrc%2Fio%2Fbuffered%2Fbufreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932/library%2Fstd%2Fsrc%2Fio%2Fbuffered%2Fbufreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fio%2Fbuffered%2Fbufreader.rs?ref=2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932", "patch": "@@ -438,7 +438,13 @@ impl<R: Seek> Seek for BufReader<R> {\n }\n \n impl<T> SizeHint for BufReader<T> {\n+    #[inline]\n     fn lower_bound(&self) -> usize {\n-        self.buffer().len()\n+        SizeHint::lower_bound(self.get_ref()) + self.buffer().len()\n+    }\n+\n+    #[inline]\n+    fn upper_bound(&self) -> Option<usize> {\n+        SizeHint::upper_bound(self.get_ref()).and_then(|up| self.buffer().len().checked_add(up))\n     }\n }"}, {"sha": "95aef0bd0fc429c7bff6ae62b481d6a296931f44", "filename": "library/std/src/io/mod.rs", "status": "modified", "additions": 57, "deletions": 1, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932/library%2Fstd%2Fsrc%2Fio%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932/library%2Fstd%2Fsrc%2Fio%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fio%2Fmod.rs?ref=2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932", "patch": "@@ -252,6 +252,7 @@\n mod tests;\n \n use crate::cmp;\n+use crate::convert::TryInto;\n use crate::fmt;\n use crate::ops::{Deref, DerefMut};\n use crate::ptr;\n@@ -2291,13 +2292,15 @@ impl<T: BufRead, U: BufRead> BufRead for Chain<T, U> {\n }\n \n impl<T, U> SizeHint for Chain<T, U> {\n+    #[inline]\n     fn lower_bound(&self) -> usize {\n         SizeHint::lower_bound(&self.first) + SizeHint::lower_bound(&self.second)\n     }\n \n+    #[inline]\n     fn upper_bound(&self) -> Option<usize> {\n         match (SizeHint::upper_bound(&self.first), SizeHint::upper_bound(&self.second)) {\n-            (Some(first), Some(second)) => Some(first + second),\n+            (Some(first), Some(second)) => first.checked_add(second),\n             _ => None,\n         }\n     }\n@@ -2502,6 +2505,21 @@ impl<T: BufRead> BufRead for Take<T> {\n     }\n }\n \n+impl<T> SizeHint for Take<T> {\n+    #[inline]\n+    fn lower_bound(&self) -> usize {\n+        cmp::min(SizeHint::lower_bound(&self.inner) as u64, self.limit) as usize\n+    }\n+\n+    #[inline]\n+    fn upper_bound(&self) -> Option<usize> {\n+        match SizeHint::upper_bound(&self.inner) {\n+            Some(upper_bound) => Some(cmp::min(upper_bound as u64, self.limit) as usize),\n+            None => self.limit.try_into().ok(),\n+        }\n+    }\n+}\n+\n /// An iterator over `u8` values of a reader.\n ///\n /// This struct is generally created by calling [`bytes`] on a reader.\n@@ -2546,15 +2564,53 @@ trait SizeHint {\n }\n \n impl<T> SizeHint for T {\n+    #[inline]\n     default fn lower_bound(&self) -> usize {\n         0\n     }\n \n+    #[inline]\n     default fn upper_bound(&self) -> Option<usize> {\n         None\n     }\n }\n \n+impl<T> SizeHint for &mut T {\n+    #[inline]\n+    fn lower_bound(&self) -> usize {\n+        SizeHint::lower_bound(*self)\n+    }\n+\n+    #[inline]\n+    fn upper_bound(&self) -> Option<usize> {\n+        SizeHint::upper_bound(*self)\n+    }\n+}\n+\n+impl<T> SizeHint for Box<T> {\n+    #[inline]\n+    fn lower_bound(&self) -> usize {\n+        SizeHint::lower_bound(&**self)\n+    }\n+\n+    #[inline]\n+    fn upper_bound(&self) -> Option<usize> {\n+        SizeHint::upper_bound(&**self)\n+    }\n+}\n+\n+impl SizeHint for &[u8] {\n+    #[inline]\n+    fn lower_bound(&self) -> usize {\n+        self.len()\n+    }\n+\n+    #[inline]\n+    fn upper_bound(&self) -> Option<usize> {\n+        Some(self.len())\n+    }\n+}\n+\n /// An iterator over the contents of an instance of `BufRead` split on a\n /// particular byte.\n ///"}, {"sha": "a483847fb26c87f4feb82828d7e256bb59dbc7b3", "filename": "library/std/src/io/tests.rs", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932/library%2Fstd%2Fsrc%2Fio%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932/library%2Fstd%2Fsrc%2Fio%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fio%2Ftests.rs?ref=2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932", "patch": "@@ -224,6 +224,24 @@ fn empty_size_hint() {\n     assert_eq!(size_hint, (0, Some(0)));\n }\n \n+#[test]\n+fn slice_size_hint() {\n+    let size_hint = (&[1, 2, 3]).bytes().size_hint();\n+    assert_eq!(size_hint, (3, Some(3)));\n+}\n+\n+#[test]\n+fn take_size_hint() {\n+    let size_hint = (&[1, 2, 3]).take(2).bytes().size_hint();\n+    assert_eq!(size_hint, (2, Some(2)));\n+\n+    let size_hint = (&[1, 2, 3]).take(4).bytes().size_hint();\n+    assert_eq!(size_hint, (3, Some(3)));\n+\n+    let size_hint = io::repeat(0).take(3).bytes().size_hint();\n+    assert_eq!(size_hint, (3, Some(3)));\n+}\n+\n #[test]\n fn chain_empty_size_hint() {\n     let chain = io::empty().chain(io::empty());\n@@ -242,7 +260,7 @@ fn chain_size_hint() {\n \n     let chain = buf_reader_1.chain(buf_reader_2);\n     let size_hint = chain.bytes().size_hint();\n-    assert_eq!(size_hint, (testdata.len(), None));\n+    assert_eq!(size_hint, (testdata.len(), Some(testdata.len())));\n }\n \n #[test]"}, {"sha": "f3bff391fb3eaef60cca23ec8b1efb4fd89f7a07", "filename": "library/std/src/io/util.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932/library%2Fstd%2Fsrc%2Fio%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932/library%2Fstd%2Fsrc%2Fio%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fio%2Futil.rs?ref=2cbd5d1df54400b8bd718b7e0dadc4c38c6f9932", "patch": "@@ -83,6 +83,7 @@ impl fmt::Debug for Empty {\n }\n \n impl SizeHint for Empty {\n+    #[inline]\n     fn upper_bound(&self) -> Option<usize> {\n         Some(0)\n     }\n@@ -147,6 +148,18 @@ impl Read for Repeat {\n     }\n }\n \n+impl SizeHint for Repeat {\n+    #[inline]\n+    fn lower_bound(&self) -> usize {\n+        usize::MAX\n+    }\n+\n+    #[inline]\n+    fn upper_bound(&self) -> Option<usize> {\n+        None\n+    }\n+}\n+\n #[stable(feature = \"std_debug\", since = \"1.16.0\")]\n impl fmt::Debug for Repeat {\n     fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {"}]}