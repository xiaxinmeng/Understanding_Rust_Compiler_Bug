{"sha": "b9463510837598256a067438ebb854e6fed4f707", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI5NDYzNTEwODM3NTk4MjU2YTA2NzQzOGViYjg1NGU2ZmVkNGY3MDc=", "commit": {"author": {"name": "Oliver Schneider", "email": "oli-obk@users.noreply.github.com", "date": "2017-05-31T21:24:39Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-05-31T21:24:39Z"}, "message": "Merge pull request #174 from RalfJung/xargo-test\n\nrun test suite also against libstd with full MIR", "tree": {"sha": "f7c21a64d9cdf686959af874c889783f666b8efd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f7c21a64d9cdf686959af874c889783f666b8efd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b9463510837598256a067438ebb854e6fed4f707", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b9463510837598256a067438ebb854e6fed4f707", "html_url": "https://github.com/rust-lang/rust/commit/b9463510837598256a067438ebb854e6fed4f707", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b9463510837598256a067438ebb854e6fed4f707/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1ba426a5053143093aeb88dfcede1c25673c4dec", "url": "https://api.github.com/repos/rust-lang/rust/commits/1ba426a5053143093aeb88dfcede1c25673c4dec", "html_url": "https://github.com/rust-lang/rust/commit/1ba426a5053143093aeb88dfcede1c25673c4dec"}, {"sha": "44a45f7c34e600c81c965794919efc15327f5eda", "url": "https://api.github.com/repos/rust-lang/rust/commits/44a45f7c34e600c81c965794919efc15327f5eda", "html_url": "https://github.com/rust-lang/rust/commit/44a45f7c34e600c81c965794919efc15327f5eda"}], "stats": {"total": 59, "additions": 36, "deletions": 23}, "files": [{"sha": "7cc14234efd580eab7183f1ab46ee0ae95787375", "filename": ".travis.yml", "status": "modified", "additions": 15, "deletions": 2, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/b9463510837598256a067438ebb854e6fed4f707/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/b9463510837598256a067438ebb854e6fed4f707/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=b9463510837598256a067438ebb854e6fed4f707", "patch": "@@ -6,16 +6,29 @@ before_script:\n - rustup target add i686-unknown-linux-gnu\n - rustup target add i686-pc-windows-gnu\n - rustup target add i686-pc-windows-msvc\n+- rustup component add rust-src\n+- chmod +x -R ~/.rustup/toolchains/*/lib/rustlib/src/rust/src/jemalloc/include/jemalloc/\n+- cargo install xargo\n+- export RUST_SYSROOT=$HOME/rust\n script:\n - |\n-  export RUST_SYSROOT=$HOME/rust &&\n+  # Test plain miri\n   cargo build &&\n   cargo test &&\n-  cargo install &&\n+  cargo install\n+- |\n+  # Test cargo miri\n   cd cargo-miri-test &&\n   cargo miri &&\n   cargo miri test &&\n   cd ..\n+- |\n+  # get ourselves a MIR-ful libstd\n+  cd xargo &&\n+  RUSTFLAGS='-Zalways-encode-mir' xargo build &&\n+  cd .. &&\n+  # and run the tests with it\n+  MIRI_SYSROOT=~/.xargo/HOST cargo test\n notifications:\n   email:\n     on_success: never"}, {"sha": "d5873c986815dfd771ae727c079e2a33d2c73c4b", "filename": "README.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b9463510837598256a067438ebb854e6fed4f707/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/b9463510837598256a067438ebb854e6fed4f707/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=b9463510837598256a067438ebb854e6fed4f707", "patch": "@@ -71,7 +71,7 @@ RUSTFLAGS='-Zalways-encode-mir' xargo build\n Now you can run miri against the libstd compiled by xargo:\n \n ```sh\n-cargo run --bin miri -- --sysroot ~/.xargo/HOST tests/run-pass/vecs.rs\n+MIRI_SYSROOT=~/.xargo/HOST cargo run --bin miri tests/run-pass/vecs.rs\n ```\n \n Notice that you will have to re-run the last step of the preparations above when"}, {"sha": "f67bbd39a7482d8b0e0b785f6e18d4dde35714f1", "filename": "src/bin/cargo-miri.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b9463510837598256a067438ebb854e6fed4f707/src%2Fbin%2Fcargo-miri.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9463510837598256a067438ebb854e6fed4f707/src%2Fbin%2Fcargo-miri.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fcargo-miri.rs?ref=b9463510837598256a067438ebb854e6fed4f707", "patch": "@@ -103,7 +103,7 @@ fn main() {\n         let sys_root = if let (Some(home), Some(toolchain)) = (home, toolchain) {\n             format!(\"{}/toolchains/{}\", home, toolchain)\n         } else {\n-            option_env!(\"SYSROOT\")\n+            option_env!(\"RUST_SYSROOT\")\n                 .map(|s| s.to_owned())\n                 .or_else(|| {\n                     Command::new(\"rustc\")\n@@ -114,7 +114,7 @@ fn main() {\n                         .and_then(|out| String::from_utf8(out.stdout).ok())\n                         .map(|s| s.trim().to_owned())\n                 })\n-                .expect(\"need to specify SYSROOT env var during miri compilation, or use rustup or multirust\")\n+                .expect(\"need to specify RUST_SYSROOT env var during miri compilation, or use rustup or multirust\")\n         };\n \n         // this conditional check for the --sysroot flag is there so users can call `cargo-clippy` directly"}, {"sha": "8d27f9057f5404d66f01401e2d58a8c124124cf3", "filename": "src/bin/miri.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b9463510837598256a067438ebb854e6fed4f707/src%2Fbin%2Fmiri.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9463510837598256a067438ebb854e6fed4f707/src%2Fbin%2Fmiri.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fmiri.rs?ref=b9463510837598256a067438ebb854e6fed4f707", "patch": "@@ -175,6 +175,10 @@ fn init_logger() {\n }\n \n fn find_sysroot() -> String {\n+    if let Ok(sysroot) = std::env::var(\"MIRI_SYSROOT\") {\n+        return sysroot;\n+    }\n+\n     // Taken from https://github.com/Manishearth/rust-clippy/pull/911.\n     let home = option_env!(\"RUSTUP_HOME\").or(option_env!(\"MULTIRUST_HOME\"));\n     let toolchain = option_env!(\"RUSTUP_TOOLCHAIN\").or(option_env!(\"MULTIRUST_TOOLCHAIN\"));"}, {"sha": "c6aaf80e6ac00bc34febec7d704d105444bf8d97", "filename": "tests/compile-fail/stack_limit.rs", "status": "modified", "additions": 4, "deletions": 10, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/b9463510837598256a067438ebb854e6fed4f707/tests%2Fcompile-fail%2Fstack_limit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9463510837598256a067438ebb854e6fed4f707/tests%2Fcompile-fail%2Fstack_limit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fstack_limit.rs?ref=b9463510837598256a067438ebb854e6fed4f707", "patch": "@@ -1,24 +1,18 @@\n #![feature(custom_attribute, attr_literals)]\n #![miri(stack_limit=16)]\n \n+//error-pattern: reached the configured maximum number of stack frames\n+\n fn bar() {\n     foo();\n }\n \n fn foo() {\n-    cake(); //~ ERROR reached the configured maximum number of stack frames\n+    cake();\n }\n \n fn cake() {\n-    flubber(3);\n-}\n-\n-fn flubber(i: u32) {\n-    if i > 0 {\n-        flubber(i-1);\n-    } else {\n-        bar();\n-    }\n+    bar();\n }\n \n fn main() {"}, {"sha": "e6535ef0212b544418834d738dc092d79f6a1047", "filename": "tests/compiletest.rs", "status": "modified", "additions": 10, "deletions": 8, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/b9463510837598256a067438ebb854e6fed4f707/tests%2Fcompiletest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9463510837598256a067438ebb854e6fed4f707/tests%2Fcompiletest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompiletest.rs?ref=b9463510837598256a067438ebb854e6fed4f707", "patch": "@@ -65,14 +65,16 @@ fn for_all_targets<F: FnMut(String)>(sysroot: &Path, mut f: F) {\n \n #[test]\n fn compile_test() {\n-    let sysroot = std::process::Command::new(\"rustc\")\n-        .arg(\"--print\")\n-        .arg(\"sysroot\")\n-        .output()\n-        .expect(\"rustc not found\")\n-        .stdout;\n-    let sysroot = std::str::from_utf8(&sysroot).expect(\"sysroot is not utf8\").trim();\n-    let sysroot = &Path::new(&sysroot);\n+    let sysroot = std::env::var(\"MIRI_SYSROOT\").unwrap_or_else(|_| {\n+        let sysroot = std::process::Command::new(\"rustc\")\n+            .arg(\"--print\")\n+            .arg(\"sysroot\")\n+            .output()\n+            .expect(\"rustc not found\")\n+            .stdout;\n+        String::from_utf8(sysroot).expect(\"sysroot is not utf8\")\n+    });\n+    let sysroot = &Path::new(sysroot.trim());\n     let host = std::process::Command::new(\"rustc\")\n         .arg(\"-vV\")\n         .output()"}]}