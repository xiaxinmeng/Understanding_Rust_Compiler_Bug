{"sha": "b92073dd521515a902c6354ad94f0adf4cf5c8a5", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI5MjA3M2RkNTIxNTE1YTkwMmM2MzU0YWQ5NGYwYWRmNGNmNWM4YTU=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-03-10T22:51:14Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-03-10T22:51:14Z"}, "message": "Rollup merge of #39918 - petrhosek:fuchsia-ci, r=alexcrichton\n\ntravis: Fuchsia builder\n\nThis change introduces a Dockerfile and script which builds a complete\nFuchsia toolchain which can be used to build Rust distribution for\nFuchsia. We only support cross-compiling at the moment, hence only\nsetting the target.", "tree": {"sha": "cc7a95e75e6bdede4a02a114bfc985f96ce8b398", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cc7a95e75e6bdede4a02a114bfc985f96ce8b398"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b92073dd521515a902c6354ad94f0adf4cf5c8a5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b92073dd521515a902c6354ad94f0adf4cf5c8a5", "html_url": "https://github.com/rust-lang/rust/commit/b92073dd521515a902c6354ad94f0adf4cf5c8a5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b92073dd521515a902c6354ad94f0adf4cf5c8a5/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3b7a534d85e6a07ff1a0db7b7e4cfdb02edc528a", "url": "https://api.github.com/repos/rust-lang/rust/commits/3b7a534d85e6a07ff1a0db7b7e4cfdb02edc528a", "html_url": "https://github.com/rust-lang/rust/commit/3b7a534d85e6a07ff1a0db7b7e4cfdb02edc528a"}, {"sha": "9a8461104e1520c7194f8b4589262c9e292c6988", "url": "https://api.github.com/repos/rust-lang/rust/commits/9a8461104e1520c7194f8b4589262c9e292c6988", "html_url": "https://github.com/rust-lang/rust/commit/9a8461104e1520c7194f8b4589262c9e292c6988"}], "stats": {"total": 194, "additions": 191, "deletions": 3}, "files": [{"sha": "7fcf128ff0b031a468a6770a85aa42d2ce73e425", "filename": ".travis.yml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b92073dd521515a902c6354ad94f0adf4cf5c8a5/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/b92073dd521515a902c6354ad94f0adf4cf5c8a5/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=b92073dd521515a902c6354ad94f0adf4cf5c8a5", "patch": "@@ -20,6 +20,7 @@ matrix:\n     - env: IMAGE=dist-armv7-aarch64-linux DEPLOY=1\n     - env: IMAGE=dist-freebsd DEPLOY=1\n     - env: IMAGE=dist-i586-gnu-i686-musl DEPLOY=1\n+    - env: IMAGE=dist-fuchsia DEPLOY=1\n     - env: IMAGE=dist-mips-linux DEPLOY=1\n     - env: IMAGE=dist-mips64-linux DEPLOY=1\n     - env: IMAGE=dist-powerpc-linux DEPLOY=1"}, {"sha": "25a47c5be1cb345c94da6eb18543691908c232f7", "filename": "src/ci/docker/dist-fuchsia/Dockerfile", "status": "added", "additions": 47, "deletions": 0, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/b92073dd521515a902c6354ad94f0adf4cf5c8a5/src%2Fci%2Fdocker%2Fdist-fuchsia%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/b92073dd521515a902c6354ad94f0adf4cf5c8a5/src%2Fci%2Fdocker%2Fdist-fuchsia%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-fuchsia%2FDockerfile?ref=b92073dd521515a902c6354ad94f0adf4cf5c8a5", "patch": "@@ -0,0 +1,47 @@\n+FROM ubuntu:16.04\n+\n+RUN apt-get update && apt-get install -y --no-install-recommends \\\n+  g++ \\\n+  make \\\n+  ninja-build \\\n+  file \\\n+  curl \\\n+  ca-certificates \\\n+  python2.7-dev \\\n+  git \\\n+  sudo \\\n+  bzip2 \\\n+  xz-utils \\\n+  swig \\\n+  libedit-dev \\\n+  libncurses5-dev\n+\n+RUN curl -L https://cmake.org/files/v3.8/cmake-3.8.0-rc1-Linux-x86_64.tar.gz | \\\n+      tar xzf - -C /usr/local --strip-components=1\n+\n+WORKDIR /tmp\n+COPY shared.sh build-toolchain.sh /tmp/\n+RUN /tmp/build-toolchain.sh\n+\n+RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\\n+    dpkg -i dumb-init_*.deb && \\\n+    rm dumb-init_*.deb\n+ENTRYPOINT [\"/usr/bin/dumb-init\", \"--\"]\n+\n+RUN curl -o /usr/local/bin/sccache \\\n+      https://s3.amazonaws.com/rust-lang-ci/rust-ci-mirror/2017-02-25-sccache-x86_64-unknown-linux-musl && \\\n+      chmod +x /usr/local/bin/sccache\n+\n+ENV \\\n+    AR_x86_64_unknown_fuchsia=x86_64-unknown-fuchsia-ar \\\n+    CC_x86_64_unknown_fuchsia=x86_64-unknown-fuchsia-clang \\\n+    CXX_x86_64_unknown_fuchsia=x86_64-unknown-fuchsia-clang++ \\\n+    AR_aarch64_unknown_fuchsia=aarch64-unknown-fuchsia-ar \\\n+    CC_aarch64_unknown_fuchsia=aarch64-unknown-fuchsia-clang \\\n+    CXX_aarch64_unknown_fuchsia=aarch64-unknown-fuchsia-clang++\n+\n+ENV TARGETS=x86_64-unknown-fuchsia\n+ENV TARGETS=$TARGETS,aarch64-unknown-fuchsia\n+\n+ENV RUST_CONFIGURE_ARGS --target=$TARGETS\n+ENV SCRIPT python2.7 ../x.py dist --target $TARGETS"}, {"sha": "cad73eee1e0130546bc34f574cde6500f15652de", "filename": "src/ci/docker/dist-fuchsia/build-toolchain.sh", "status": "added", "additions": 116, "deletions": 0, "changes": 116, "blob_url": "https://github.com/rust-lang/rust/blob/b92073dd521515a902c6354ad94f0adf4cf5c8a5/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fbuild-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/b92073dd521515a902c6354ad94f0adf4cf5c8a5/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fbuild-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fbuild-toolchain.sh?ref=b92073dd521515a902c6354ad94f0adf4cf5c8a5", "patch": "@@ -0,0 +1,116 @@\n+#!/bin/bash\n+# Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+# file at the top-level directory of this distribution and at\n+# http://rust-lang.org/COPYRIGHT.\n+#\n+# Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+# http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+# <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+# option. This file may not be copied, modified, or distributed\n+# except according to those terms.\n+\n+set -ex\n+source shared.sh\n+\n+# Download sources\n+SRCS=(\n+  \"https://fuchsia.googlesource.com/magenta magenta ac69119\"\n+  \"https://fuchsia.googlesource.com/third_party/llvm llvm 5463083\"\n+  \"https://fuchsia.googlesource.com/third_party/clang llvm/tools/clang 4ff7b4b\"\n+  \"https://fuchsia.googlesource.com/third_party/lld llvm/tools/lld fd465a3\"\n+  \"https://fuchsia.googlesource.com/third_party/lldb llvm/tools/lldb 6bb11f8\"\n+  \"https://fuchsia.googlesource.com/third_party/compiler-rt llvm/runtimes/compiler-rt 52d4ecc\"\n+  \"https://fuchsia.googlesource.com/third_party/libcxx llvm/runtimes/libcxx e891cc8\"\n+  \"https://fuchsia.googlesource.com/third_party/libcxxabi llvm/runtimes/libcxxabi f0f0257\"\n+  \"https://fuchsia.googlesource.com/third_party/libunwind llvm/runtimes/libunwind 50bddc1\"\n+)\n+\n+fetch() {\n+  mkdir -p $2\n+  pushd $2 > /dev/null\n+  curl -sL $1/+archive/$3.tar.gz | tar xzf -\n+  popd > /dev/null\n+}\n+\n+for i in \"${SRCS[@]}\"; do\n+  fetch $i\n+done\n+\n+# Build toolchain\n+cd llvm\n+mkdir build\n+cd build\n+hide_output cmake -GNinja \\\n+  -DFUCHSIA_SYSROOT=${PWD}/../../magenta/third_party/ulib/musl \\\n+  -DLLVM_ENABLE_LTO=OFF \\\n+  -DCLANG_BOOTSTRAP_PASSTHROUGH=LLVM_ENABLE_LTO \\\n+  -C ../tools/clang/cmake/caches/Fuchsia.cmake \\\n+  ..\n+hide_output ninja stage2-distribution\n+hide_output ninja stage2-install-distribution\n+cd ../..\n+\n+# Build sysroot\n+rm -rf llvm/runtimes/compiler-rt\n+./magenta/scripts/download-toolchain\n+\n+build_sysroot() {\n+  local arch=\"$1\"\n+\n+  case \"${arch}\" in\n+    x86_64) tgt=\"magenta-pc-x86-64\" ;;\n+    aarch64) tgt=\"magenta-qemu-arm64\" ;;\n+  esac\n+\n+  hide_output make -C magenta -j$(getconf _NPROCESSORS_ONLN) $tgt\n+  dst=/usr/local/${arch}-unknown-fuchsia\n+  mkdir -p $dst\n+  cp -r magenta/build-${tgt}/sysroot/include $dst/\n+  cp -r magenta/build-${tgt}/sysroot/lib $dst/\n+\n+  cd llvm\n+  mkdir build-runtimes-${arch}\n+  cd build-runtimes-${arch}\n+  hide_output cmake -GNinja \\\n+    -DCMAKE_C_COMPILER=clang \\\n+    -DCMAKE_CXX_COMPILER=clang++ \\\n+    -DCMAKE_AR=/usr/local/bin/llvm-ar \\\n+    -DCMAKE_RANLIB=/usr/local/bin/llvm-ranlib \\\n+    -DCMAKE_INSTALL_PREFIX= \\\n+    -DLLVM_MAIN_SRC_DIR=${PWD}/.. \\\n+    -DLLVM_BINARY_DIR=${PWD}/../build \\\n+    -DLLVM_ENABLE_WERROR=OFF \\\n+    -DCMAKE_BUILD_TYPE=Release \\\n+    -DLLVM_INCLUDE_TESTS=ON \\\n+    -DCMAKE_SYSTEM_NAME=Fuchsia \\\n+    -DCMAKE_C_COMPILER_TARGET=${arch}-fuchsia \\\n+    -DCMAKE_CXX_COMPILER_TARGET=${arch}-fuchsia \\\n+    -DUNIX=1 \\\n+    -DLIBCXX_HAS_MUSL_LIBC=ON \\\n+    -DLIBCXXABI_USE_LLVM_UNWINDER=ON \\\n+    -DCMAKE_SYSROOT=${dst} \\\n+    -DCMAKE_C_COMPILER_FORCED=TRUE \\\n+    -DCMAKE_CXX_COMPILER_FORCED=TRUE \\\n+    -DLLVM_ENABLE_LIBCXX=ON \\\n+    -DCMAKE_EXE_LINKER_FLAGS=\"-nodefaultlibs -lc\" \\\n+    -DCMAKE_SHARED_LINKER_FLAGS=\"$(clang --target=${arch}-fuchsia -print-libgcc-file-name)\" \\\n+    ../runtimes\n+  hide_output env DESTDIR=\"${dst}\" ninja install\n+  cd ../..\n+}\n+\n+build_sysroot \"x86_64\"\n+build_sysroot \"aarch64\"\n+\n+rm -rf magenta llvm\n+\n+for arch in x86_64 aarch64; do\n+  for tool in clang clang++; do\n+    cat >/usr/local/bin/${arch}-unknown-fuchsia-${tool} <<EOF\n+#!/bin/sh\n+${tool} --target=${arch}-unknown-fuchsia --sysroot=/usr/local/${arch}-unknown-fuchsia \"\\$@\"\n+EOF\n+    chmod +x /usr/local/bin/${arch}-unknown-fuchsia-${tool}\n+  done\n+  ln -s /usr/local/bin/llvm-ar /usr/local/bin/${arch}-unknown-fuchsia-ar\n+done"}, {"sha": "e26c6eb6645781c70b1948a53b8b5e1532d359d7", "filename": "src/ci/docker/dist-fuchsia/shared.sh", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/b92073dd521515a902c6354ad94f0adf4cf5c8a5/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fshared.sh", "raw_url": "https://github.com/rust-lang/rust/raw/b92073dd521515a902c6354ad94f0adf4cf5c8a5/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fshared.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fshared.sh?ref=b92073dd521515a902c6354ad94f0adf4cf5c8a5", "patch": "@@ -0,0 +1,25 @@\n+# Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+# file at the top-level directory of this distribution and at\n+# http://rust-lang.org/COPYRIGHT.\n+#\n+# Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+# http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+# <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+# option. This file may not be copied, modified, or distributed\n+# except according to those terms.\n+\n+hide_output() {\n+  set +x\n+  on_err=\"\n+echo ERROR: An error was encountered with the build.\n+cat /tmp/build.log\n+exit 1\n+\"\n+  trap \"$on_err\" ERR\n+  bash -c \"while true; do sleep 30; echo \\$(date) - building ...; done\" &\n+  PING_LOOP_PID=$!\n+  \"$@\" &> /tmp/build.log\n+  trap - ERR\n+  kill $PING_LOOP_PID\n+  set -x\n+}"}, {"sha": "14c0e8699bc060b2cbbf9255e4fbff86701ce1b7", "filename": "src/libstd/sys_common/gnu/libbacktrace.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b92073dd521515a902c6354ad94f0adf4cf5c8a5/src%2Flibstd%2Fsys_common%2Fgnu%2Flibbacktrace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b92073dd521515a902c6354ad94f0adf4cf5c8a5/src%2Flibstd%2Fsys_common%2Fgnu%2Flibbacktrace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys_common%2Fgnu%2Flibbacktrace.rs?ref=b92073dd521515a902c6354ad94f0adf4cf5c8a5", "patch": "@@ -105,9 +105,6 @@ extern \"C\" fn(data: *mut libc::c_void,\n               msg: *const libc::c_char,\n               errnum: libc::c_int);\n enum backtrace_state {}\n-#[link(name = \"backtrace\", kind = \"static\")]\n-#[cfg(all(not(test), not(cargobuild)))]\n-extern {}\n \n extern {\n     fn backtrace_create_state(filename: *const libc::c_char,"}, {"sha": "9449fac2197df9cf161b510c28bdb49884305224", "filename": "src/tools/build-manifest/src/main.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b92073dd521515a902c6354ad94f0adf4cf5c8a5/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b92073dd521515a902c6354ad94f0adf4cf5c8a5/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs?ref=b92073dd521515a902c6354ad94f0adf4cf5c8a5", "patch": "@@ -45,6 +45,7 @@ static HOSTS: &'static [&'static str] = &[\n \n static TARGETS: &'static [&'static str] = &[\n     \"aarch64-apple-ios\",\n+    \"aarch64-unknown-fuchsia\",\n     \"aarch64-linux-android\",\n     \"aarch64-unknown-linux-gnu\",\n     \"arm-linux-androideabi\",\n@@ -86,6 +87,7 @@ static TARGETS: &'static [&'static str] = &[\n     \"x86_64-pc-windows-msvc\",\n     \"x86_64-rumprun-netbsd\",\n     \"x86_64-unknown-freebsd\",\n+    \"x86_64-unknown-fuchsia\",\n     \"x86_64-unknown-linux-gnu\",\n     \"x86_64-unknown-linux-musl\",\n     \"x86_64-unknown-netbsd\","}]}