{"sha": "5d584516b223e3a92fffa2c7e175734c23882340", "node_id": "C_kwDOAAsO6NoAKDVkNTg0NTE2YjIyM2UzYTkyZmZmYTJjN2UxNzU3MzRjMjM4ODIzNDA", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-10-04T16:26:39Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-04T16:26:39Z"}, "message": "Rollup merge of #102488 - compiler-errors:gat-compatibility, r=oli-obk\n\nCheck generic argument compatibility when projecting assoc ty\n\nFixes #102114", "tree": {"sha": "082eeea8157b3b35c3b58c92bfdf4b212b32232d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/082eeea8157b3b35c3b58c92bfdf4b212b32232d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5d584516b223e3a92fffa2c7e175734c23882340", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjPF6/CRBK7hj4Ov3rIwAAJSAIAK2BwJMxz7SEoq2DIh2UavoK\n7LsFKZs85GhjVNv5aUJESAgCCJNQ8Ygtf/t+MHfBIe0MyEz8+Kx0F0/os/29Hd5u\n9Odw9Wk4MCX91JILAic4OvSEdh/NbqKbgEulRgi306PgP7BtePGaZVNF9GaWXsM5\nJ1IZUmtiu5ABp6LQ3qs3xYo2IyA24Oa6EVEESK6JwAmnnPEQhHqR2wzOgYyqUDv/\n2+oxo0M1ig8OI/1IGHyP85zSfDkl8FX5g76nDw6UVznSnoaiefTw89Y8DJBoHnT5\nKiMpR06QebIEwWqsp3s3gB9vC4xKInADmQnsQftCJ3WJqYDndmemdx5l/voS4qk=\n=/ncH\n-----END PGP SIGNATURE-----\n", "payload": "tree 082eeea8157b3b35c3b58c92bfdf4b212b32232d\nparent b9ff789506ed668009da1715d3b6db84f0c8ab85\nparent ee713f3d4350c75bae85749619b0e1508f433e02\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1664900799 +0200\ncommitter GitHub <noreply@github.com> 1664900799 +0200\n\nRollup merge of #102488 - compiler-errors:gat-compatibility, r=oli-obk\n\nCheck generic argument compatibility when projecting assoc ty\n\nFixes #102114\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5d584516b223e3a92fffa2c7e175734c23882340", "html_url": "https://github.com/rust-lang/rust/commit/5d584516b223e3a92fffa2c7e175734c23882340", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5d584516b223e3a92fffa2c7e175734c23882340/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b9ff789506ed668009da1715d3b6db84f0c8ab85", "url": "https://api.github.com/repos/rust-lang/rust/commits/b9ff789506ed668009da1715d3b6db84f0c8ab85", "html_url": "https://github.com/rust-lang/rust/commit/b9ff789506ed668009da1715d3b6db84f0c8ab85"}, {"sha": "ee713f3d4350c75bae85749619b0e1508f433e02", "url": "https://api.github.com/repos/rust-lang/rust/commits/ee713f3d4350c75bae85749619b0e1508f433e02", "html_url": "https://github.com/rust-lang/rust/commit/ee713f3d4350c75bae85749619b0e1508f433e02"}], "stats": {"total": 70, "additions": 68, "deletions": 2}, "files": [{"sha": "29172d6caaff678cfe72dc32d8af71289f43da14", "filename": "compiler/rustc_trait_selection/src/traits/project.rs", "status": "modified", "additions": 40, "deletions": 2, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/5d584516b223e3a92fffa2c7e175734c23882340/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d584516b223e3a92fffa2c7e175734c23882340/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs?ref=5d584516b223e3a92fffa2c7e175734c23882340", "patch": "@@ -2146,10 +2146,10 @@ fn confirm_impl_candidate<'cx, 'tcx>(\n     } else {\n         ty.map_bound(|ty| ty.into())\n     };\n-    if substs.len() != tcx.generics_of(assoc_ty.item.def_id).count() {\n+    if !check_substs_compatible(tcx, &assoc_ty.item, substs) {\n         let err = tcx.ty_error_with_message(\n             obligation.cause.span,\n-            \"impl item and trait item have different parameter counts\",\n+            \"impl item and trait item have different parameters\",\n         );\n         Progress { term: err.into(), obligations: nested }\n     } else {\n@@ -2158,6 +2158,44 @@ fn confirm_impl_candidate<'cx, 'tcx>(\n     }\n }\n \n+// Verify that the trait item and its implementation have compatible substs lists\n+fn check_substs_compatible<'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    assoc_ty: &ty::AssocItem,\n+    substs: ty::SubstsRef<'tcx>,\n+) -> bool {\n+    fn check_substs_compatible_inner<'tcx>(\n+        tcx: TyCtxt<'tcx>,\n+        generics: &'tcx ty::Generics,\n+        args: &'tcx [ty::GenericArg<'tcx>],\n+    ) -> bool {\n+        if generics.count() != args.len() {\n+            return false;\n+        }\n+\n+        let (parent_args, own_args) = args.split_at(generics.parent_count);\n+\n+        if let Some(parent) = generics.parent\n+            && let parent_generics = tcx.generics_of(parent)\n+            && !check_substs_compatible_inner(tcx, parent_generics, parent_args) {\n+            return false;\n+        }\n+\n+        for (param, arg) in std::iter::zip(&generics.params, own_args) {\n+            match (&param.kind, arg.unpack()) {\n+                (ty::GenericParamDefKind::Type { .. }, ty::GenericArgKind::Type(_))\n+                | (ty::GenericParamDefKind::Lifetime, ty::GenericArgKind::Lifetime(_))\n+                | (ty::GenericParamDefKind::Const { .. }, ty::GenericArgKind::Const(_)) => {}\n+                _ => return false,\n+            }\n+        }\n+\n+        true\n+    }\n+\n+    check_substs_compatible_inner(tcx, tcx.generics_of(assoc_ty.def_id), substs.as_slice())\n+}\n+\n fn confirm_impl_trait_in_trait_candidate<'tcx>(\n     selcx: &mut SelectionContext<'_, 'tcx>,\n     obligation: &ProjectionTyObligation<'tcx>,"}, {"sha": "de31737efef52915773a3db1250159b261dbdab9", "filename": "src/test/ui/generic-associated-types/issue-102114.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/5d584516b223e3a92fffa2c7e175734c23882340/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-102114.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d584516b223e3a92fffa2c7e175734c23882340/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-102114.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-102114.rs?ref=5d584516b223e3a92fffa2c7e175734c23882340", "patch": "@@ -0,0 +1,16 @@\n+trait A {\n+    type B<'b>;\n+    fn a() -> Self::B<'static>;\n+}\n+\n+struct C;\n+\n+struct Wrapper<T>(T);\n+\n+impl A for C {\n+    type B<T> = Wrapper<T>;\n+    //~^ ERROR type `B` has 1 type parameter but its trait declaration has 0 type parameters\n+    fn a() -> Self::B<'static> {}\n+}\n+\n+fn main() {}"}, {"sha": "8e41dee54d7e4675e2f927a99e42dad23cf88a07", "filename": "src/test/ui/generic-associated-types/issue-102114.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5d584516b223e3a92fffa2c7e175734c23882340/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-102114.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5d584516b223e3a92fffa2c7e175734c23882340/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-102114.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-102114.stderr?ref=5d584516b223e3a92fffa2c7e175734c23882340", "patch": "@@ -0,0 +1,12 @@\n+error[E0049]: type `B` has 1 type parameter but its trait declaration has 0 type parameters\n+  --> $DIR/issue-102114.rs:11:12\n+   |\n+LL |     type B<'b>;\n+   |            -- expected 0 type parameters\n+...\n+LL |     type B<T> = Wrapper<T>;\n+   |            ^ found 1 type parameter\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0049`."}]}