{"sha": "e080804f72fe937ed36cd6656f5f119959529945", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUwODA4MDRmNzJmZTkzN2VkMzZjZDY2NTZmNWYxMTk5NTk1Mjk5NDU=", "commit": {"author": {"name": "Dylan McKay", "email": "dylanmckay34@gmail.com", "date": "2016-12-11T09:08:20Z"}, "committer": {"name": "Dylan McKay", "email": "dylanmckay34@gmail.com", "date": "2016-12-14T08:39:13Z"}, "message": "Update LLVM global variable debug info API for 4.0\n\nThis teaches Rust about an LLVM 4.0 API change for creating debug info\nfor global variables.\n\nThis change was made in upstream LLVM patch https://reviews.llvm.org/D20147\n\nThis is almost 1:1 copy of how clang did it in http://reviews.llvm.org/D20415", "tree": {"sha": "bca194bbdcf14d7b84cc9c339fc601fe868124bb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bca194bbdcf14d7b84cc9c339fc601fe868124bb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e080804f72fe937ed36cd6656f5f119959529945", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e080804f72fe937ed36cd6656f5f119959529945", "html_url": "https://github.com/rust-lang/rust/commit/e080804f72fe937ed36cd6656f5f119959529945", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e080804f72fe937ed36cd6656f5f119959529945/comments", "author": null, "committer": null, "parents": [{"sha": "aa7a2e9e61cfb9469c7eb88308fa2e1a087ebdb4", "url": "https://api.github.com/repos/rust-lang/rust/commits/aa7a2e9e61cfb9469c7eb88308fa2e1a087ebdb4", "html_url": "https://github.com/rust-lang/rust/commit/aa7a2e9e61cfb9469c7eb88308fa2e1a087ebdb4"}], "stats": {"total": 25, "additions": 20, "deletions": 5}, "files": [{"sha": "f5fa66f1b0e5ae79ed948db604cca268696355a6", "filename": "src/rustllvm/RustWrapper.cpp", "status": "modified", "additions": 20, "deletions": 5, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/e080804f72fe937ed36cd6656f5f119959529945/src%2Frustllvm%2FRustWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/e080804f72fe937ed36cd6656f5f119959529945/src%2Frustllvm%2FRustWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustllvm%2FRustWrapper.cpp?ref=e080804f72fe937ed36cd6656f5f119959529945", "patch": "@@ -651,17 +651,32 @@ extern \"C\" LLVMRustMetadataRef LLVMRustDIBuilderCreateStaticVariable(\n     bool isLocalToUnit,\n     LLVMValueRef Val,\n     LLVMRustMetadataRef Decl = NULL,\n-    uint64_t AlignInBits = 0)\n-{\n-    return wrap(Builder->createGlobalVariable(\n-        unwrapDI<DIDescriptor>(Context),\n+    uint64_t AlignInBits = 0) {\n+    Constant *InitVal = cast<Constant>(unwrap(Val));\n+\n+#if LLVM_VERSION_GE(4, 0)\n+    llvm::DIExpression *InitExpr = nullptr;\n+    if (llvm::ConstantInt *IntVal = llvm::dyn_cast<llvm::ConstantInt>(InitVal)) {\n+      InitExpr = Builder->createConstantValueExpression(\n+          IntVal->getValue().getSExtValue());\n+    } else if (llvm::ConstantFP *FPVal = llvm::dyn_cast<llvm::ConstantFP>(InitVal)) {\n+        InitExpr = Builder->createConstantValueExpression(\n+                FPVal->getValueAPF().bitcastToAPInt().getZExtValue());\n+    }\n+#endif\n+\n+    return wrap(Builder->createGlobalVariable(unwrapDI<DIDescriptor>(Context),\n         Name,\n         LinkageName,\n         unwrapDI<DIFile>(File),\n         LineNo,\n         unwrapDI<DIType>(Ty),\n         isLocalToUnit,\n-        cast<Constant>(unwrap(Val)),\n+#if LLVM_VERSION_GE(4, 0)\n+        InitExpr,\n+#else\n+        InitVal,\n+#endif\n         unwrapDIptr<MDNode>(Decl)\n #if LLVM_VERSION_GE(4, 0)\n         , AlignInBits"}]}