{"sha": "f6194f33d23a90d56dcb00634109d0fa9b92cd3f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY2MTk0ZjMzZDIzYTkwZDU2ZGNiMDA2MzQxMDlkMGZhOWI5MmNkM2Y=", "commit": {"author": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2018-11-04T21:05:12Z"}, "committer": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2018-11-05T06:18:47Z"}, "message": "Fix false positive in check mode caused by `gen_deprecated`\n\n`gen_deprecated` should never have created the string with linebreaks.\n\nUsing a single string broke the check because the changed lines were\ndifferent.", "tree": {"sha": "644f65cabaa12b433b4b31a6c02dadfa4bd7e05d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/644f65cabaa12b433b4b31a6c02dadfa4bd7e05d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f6194f33d23a90d56dcb00634109d0fa9b92cd3f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEvUKv4zqIn2RHUgCKtvoGpuDiZlsFAlvf4McACgkQtvoGpuDi\nZlsRKA/8Cg92RSILNQEhZNxELYJw6rxKW6hUkHS9DAaHs5wu8jXE5eqUUK1TGs36\nqWBzqrcZAVBPHw5j8uBlVjclGNKiYzOhgSjkBBZL3yNulVP84GUX7pHr8qfWcnrQ\nnaDQZN40ol+R299k29Ch1w8knHavBlVmJmgaFB86vOOBUD+z/trA/zC+FUcXowQd\nJSb1NZ0BQr0vwSV1vFSEbJNFGtaWFwpeApKyMBo0UjqCStgzX8jTeTlsVf1apHs9\nvek7sQA/7Xlyv/v7FefoJra4b15lc13TIsQBywtND9tr6D9qVBRZfmlCZU8hxpc7\nGpjwy4iM+h9MKcCAGwldoLxnWJTSX+0IE8EavfIQFZNWs4T/1GHsAdOW8d2iBcxb\n4AefGlm96q6UOBaVHNTtNoztEdwOD7w4e/bWwdeUQvnYSIFn2uziJECwFgAX0ejk\nF5Tr/qWmsqtmJLas/+yZV0l5hZ8XoGQCNxBxg9m7JL4A9aZN7i3k31rpdfXZ5PMw\n/sJkATO2V1nphABUSGTFkZr8RsS5zQNYjkAM6BhXfobA1lftqiF3VTfShcaFLtjH\nxg8BeGTVqWakl2xZPvJhSL0tQB/ZSlSoimmIDpWTmrkxD7kMysT1G6eoIyGS9H7V\ncdxlRNcdeuR1t12jv5qN+cqPL8ri+E1teFJCJJj74IqOSkrX2dw=\n=UJCT\n-----END PGP SIGNATURE-----", "payload": "tree 644f65cabaa12b433b4b31a6c02dadfa4bd7e05d\nparent 90f31e21ab1e3b0b3cd3887094a705217f67bdfa\nauthor Philipp Hansch <dev@phansch.net> 1541365512 +0100\ncommitter Philipp Hansch <dev@phansch.net> 1541398727 +0100\n\nFix false positive in check mode caused by `gen_deprecated`\n\n`gen_deprecated` should never have created the string with linebreaks.\n\nUsing a single string broke the check because the changed lines were\ndifferent.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f6194f33d23a90d56dcb00634109d0fa9b92cd3f", "html_url": "https://github.com/rust-lang/rust/commit/f6194f33d23a90d56dcb00634109d0fa9b92cd3f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f6194f33d23a90d56dcb00634109d0fa9b92cd3f/comments", "author": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "90f31e21ab1e3b0b3cd3887094a705217f67bdfa", "url": "https://api.github.com/repos/rust-lang/rust/commits/90f31e21ab1e3b0b3cd3887094a705217f67bdfa", "html_url": "https://github.com/rust-lang/rust/commit/90f31e21ab1e3b0b3cd3887094a705217f67bdfa"}], "stats": {"total": 89, "additions": 50, "deletions": 39}, "files": [{"sha": "5e1a454195e4f33670a57cec32781bc95f56fa55", "filename": "clippy_dev/src/lib.rs", "status": "modified", "additions": 50, "deletions": 39, "changes": 89, "blob_url": "https://github.com/rust-lang/rust/blob/f6194f33d23a90d56dcb00634109d0fa9b92cd3f/clippy_dev%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f6194f33d23a90d56dcb00634109d0fa9b92cd3f/clippy_dev%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Flib.rs?ref=f6194f33d23a90d56dcb00634109d0fa9b92cd3f", "patch": "@@ -114,19 +114,22 @@ pub fn gen_changelog_lint_list(lints: Vec<Lint>) -> Vec<String> {\n \n /// Generates the `register_removed` code in `./clippy_lints/src/lib.rs`.\n pub fn gen_deprecated(lints: &[Lint]) -> Vec<String> {\n-    lints.iter()\n-        .filter_map(|l| {\n-            l.clone().deprecation.and_then(|depr_text| {\n-                Some(\n-                    format!(\n-                        \"    store.register_removed(\\n        \\\"{}\\\",\\n        \\\"{}\\\",\\n    );\",\n-                        l.name,\n-                        depr_text\n+    itertools::flatten(\n+        lints\n+            .iter()\n+            .filter_map(|l| {\n+                l.clone().deprecation.and_then(|depr_text| {\n+                    Some(\n+                        vec![\n+                            \"    store.register_removed(\".to_string(),\n+                            format!(\"        \\\"{}\\\",\", l.name),\n+                            format!(\"        \\\"{}\\\",\", depr_text),\n+                            \"    );\".to_string()\n+                        ]\n                     )\n-                )\n+                })\n             })\n-        })\n-        .collect()\n+    ).collect()\n }\n \n /// Gathers all files in `src/clippy_lints` and gathers all lints inside\n@@ -258,6 +261,7 @@ pub fn replace_region_in_text<F>(text: &str, start: &str, end: &str, replace_sta\n         // is incorrect.\n         eprintln!(\"error: regex `{:?}` not found. You may have to update it.\", start);\n     }\n+\n     FileChange {\n         changed: lines.ne(new_lines.clone()),\n         new_lines: new_lines.join(\"\\n\")\n@@ -305,38 +309,40 @@ declare_deprecated_lint! {\n \n #[test]\n fn test_replace_region() {\n-    let text = r#\"\n-abc\n-123\n-789\n-def\n-ghi\"#;\n-    let expected = r#\"\n-abc\n-hello world\n-def\n-ghi\"#;\n+    let text = \"\\nabc\\n123\\n789\\ndef\\nghi\";\n+    let expected = FileChange {\n+        changed: true,\n+        new_lines: \"\\nabc\\nhello world\\ndef\\nghi\".to_string()\n+    };\n     let result = replace_region_in_text(text, r#\"^\\s*abc$\"#, r#\"^\\s*def\"#, false, || {\n         vec![\"hello world\".to_string()]\n-    }).new_lines;\n+    });\n     assert_eq!(expected, result);\n }\n \n #[test]\n fn test_replace_region_with_start() {\n-    let text = r#\"\n-abc\n-123\n-789\n-def\n-ghi\"#;\n-    let expected = r#\"\n-hello world\n-def\n-ghi\"#;\n+    let text = \"\\nabc\\n123\\n789\\ndef\\nghi\";\n+    let expected = FileChange {\n+        changed: true,\n+        new_lines: \"\\nhello world\\ndef\\nghi\".to_string()\n+    };\n     let result = replace_region_in_text(text, r#\"^\\s*abc$\"#, r#\"^\\s*def\"#, true, || {\n         vec![\"hello world\".to_string()]\n-    }).new_lines;\n+    });\n+    assert_eq!(expected, result);\n+}\n+\n+#[test]\n+fn test_replace_region_no_changes() {\n+    let text = \"123\\n456\\n789\";\n+    let expected = FileChange {\n+        changed: false,\n+        new_lines: \"123\\n456\\n789\".to_string()\n+    };\n+    let result = replace_region_in_text(text, r#\"^\\s*123$\"#, r#\"^\\s*456\"#, false, || {\n+        vec![]\n+    });\n     assert_eq!(expected, result);\n }\n \n@@ -390,14 +396,19 @@ fn test_gen_changelog_lint_list() {\n fn test_gen_deprecated() {\n     let lints = vec![\n         Lint::new(\"should_assert_eq\", \"group1\", \"abc\", Some(\"has been superseeded by should_assert_eq2\"), \"module_name\"),\n+        Lint::new(\"another_deprecated\", \"group2\", \"abc\", Some(\"will be removed\"), \"module_name\"),\n         Lint::new(\"should_assert_eq2\", \"group2\", \"abc\", None, \"module_name\")\n     ];\n     let expected: Vec<String> = vec![\n-        r#\"    store.register_removed(\n-        \"should_assert_eq\",\n-        \"has been superseeded by should_assert_eq2\",\n-    );\"#.to_string()\n-    ];\n+        \"    store.register_removed(\",\n+        \"        \\\"should_assert_eq\\\",\",\n+        \"        \\\"has been superseeded by should_assert_eq2\\\",\",\n+        \"    );\",\n+        \"    store.register_removed(\",\n+        \"        \\\"another_deprecated\\\",\",\n+        \"        \\\"will be removed\\\",\",\n+        \"    );\"\n+    ].into_iter().map(String::from).collect();\n     assert_eq!(expected, gen_deprecated(&lints));\n }\n "}]}