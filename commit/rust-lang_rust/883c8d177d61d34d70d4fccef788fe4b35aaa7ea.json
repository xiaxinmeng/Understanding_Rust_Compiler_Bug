{"sha": "883c8d177d61d34d70d4fccef788fe4b35aaa7ea", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg4M2M4ZDE3N2Q2MWQzNGQ3MGQ0ZmNjZWY3ODhmZTRiMzVhYWE3ZWE=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-12-03T14:31:04Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-12-03T14:48:29Z"}, "message": "Make `compile_error!` lazy and emit a diagnostic", "tree": {"sha": "a7b245d83180d37ec2dacdaf46714db0e4d9a628", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a7b245d83180d37ec2dacdaf46714db0e4d9a628"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/883c8d177d61d34d70d4fccef788fe4b35aaa7ea", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/883c8d177d61d34d70d4fccef788fe4b35aaa7ea", "html_url": "https://github.com/rust-lang/rust/commit/883c8d177d61d34d70d4fccef788fe4b35aaa7ea", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/883c8d177d61d34d70d4fccef788fe4b35aaa7ea/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4634bfb332897f8478ed885970e7cb21bb9c4fce", "url": "https://api.github.com/repos/rust-lang/rust/commits/4634bfb332897f8478ed885970e7cb21bb9c4fce", "html_url": "https://github.com/rust-lang/rust/commit/4634bfb332897f8478ed885970e7cb21bb9c4fce"}], "stats": {"total": 55, "additions": 34, "deletions": 21}, "files": [{"sha": "7e78340ee4b3ecb2e0b893b6568baff5deb105a9", "filename": "crates/hir_def/src/body/tests.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/883c8d177d61d34d70d4fccef788fe4b35aaa7ea/crates%2Fhir_def%2Fsrc%2Fbody%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/883c8d177d61d34d70d4fccef788fe4b35aaa7ea/crates%2Fhir_def%2Fsrc%2Fbody%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fbody%2Ftests.rs?ref=883c8d177d61d34d70d4fccef788fe4b35aaa7ea", "patch": "@@ -84,6 +84,9 @@ macro_rules! env {}\n #[rustc_builtin_macro]\n macro_rules! include {}\n \n+#[rustc_builtin_macro]\n+macro_rules! compile_error {}\n+\n #[rustc_builtin_macro]\n macro_rules! format_args {\n     () => {}\n@@ -103,6 +106,9 @@ fn f() {\n     env!(\"OUT_DIR\");\n   //^^^^^^^^^^^^^^^ `OUT_DIR` not set, enable \"load out dirs from check\" to fix\n \n+    compile_error!(\"compile_error works\");\n+  //^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `compile_error!` called: compile_error works\n+\n     // Lazy:\n \n     format_args!();"}, {"sha": "16c3c4d69c17c16d7c8a71ea09e1cf7f14519d3a", "filename": "crates/hir_expand/src/builtin_macro.rs", "status": "modified", "additions": 27, "deletions": 21, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/883c8d177d61d34d70d4fccef788fe4b35aaa7ea/crates%2Fhir_expand%2Fsrc%2Fbuiltin_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/883c8d177d61d34d70d4fccef788fe4b35aaa7ea/crates%2Fhir_expand%2Fsrc%2Fbuiltin_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fbuiltin_macro.rs?ref=883c8d177d61d34d70d4fccef788fe4b35aaa7ea", "patch": "@@ -86,7 +86,6 @@ pub fn find_builtin_macro(\n register_builtin! {\n     LAZY:\n     (column, Column) => column_expand,\n-    (compile_error, CompileError) => compile_error_expand,\n     (file, File) => file_expand,\n     (line, Line) => line_expand,\n     (assert, Assert) => assert_expand,\n@@ -97,6 +96,7 @@ register_builtin! {\n     (format_args_nl, FormatArgsNl) => format_args_expand,\n \n     EAGER:\n+    (compile_error, CompileError) => compile_error_expand,\n     (concat, Concat) => concat_expand,\n     (include, Include) => include_expand,\n     (include_bytes, IncludeBytes) => include_bytes_expand,\n@@ -213,25 +213,6 @@ fn file_expand(\n     ExpandResult::ok(expanded)\n }\n \n-fn compile_error_expand(\n-    _db: &dyn AstDatabase,\n-    _id: LazyMacroId,\n-    tt: &tt::Subtree,\n-) -> ExpandResult<tt::Subtree> {\n-    if tt.count() == 1 {\n-        if let tt::TokenTree::Leaf(tt::Leaf::Literal(it)) = &tt.token_trees[0] {\n-            let s = it.text.as_str();\n-            if s.contains('\"') {\n-                return ExpandResult::ok(quote! { loop { #it }});\n-            }\n-        };\n-    }\n-\n-    ExpandResult::only_err(mbe::ExpandError::BindingError(\n-        \"`compile_error!` argument be a string\".into(),\n-    ))\n-}\n-\n fn format_args_expand(\n     _db: &dyn AstDatabase,\n     _id: LazyMacroId,\n@@ -280,6 +261,30 @@ fn unquote_str(lit: &tt::Literal) -> Option<String> {\n     token.value().map(|it| it.into_owned())\n }\n \n+fn compile_error_expand(\n+    _db: &dyn AstDatabase,\n+    _id: EagerMacroId,\n+    tt: &tt::Subtree,\n+) -> ExpandResult<Option<(tt::Subtree, FragmentKind)>> {\n+    let err = match &*tt.token_trees {\n+        [tt::TokenTree::Leaf(tt::Leaf::Literal(it))] => {\n+            let text = it.text.as_str();\n+            if text.starts_with('\"') && text.ends_with('\"') {\n+                // FIXME: does not handle raw strings\n+                mbe::ExpandError::Other(format!(\n+                    \"`compile_error!` called: {}\",\n+                    &text[1..text.len() - 1]\n+                ))\n+            } else {\n+                mbe::ExpandError::BindingError(\"`compile_error!` argument must be a string\".into())\n+            }\n+        }\n+        _ => mbe::ExpandError::BindingError(\"`compile_error!` argument must be a string\".into()),\n+    };\n+\n+    ExpandResult { value: Some((quote! {}, FragmentKind::Items)), err: Some(err) }\n+}\n+\n fn concat_expand(\n     _db: &dyn AstDatabase,\n     _arg_id: EagerMacroId,\n@@ -646,7 +651,8 @@ mod tests {\n             \"#,\n         );\n \n-        assert_eq!(expanded, r#\"loop{\"error!\"}\"#);\n+        // This expands to nothing (since it's in item position), but emits an error.\n+        assert_eq!(expanded, \"\");\n     }\n \n     #[test]"}, {"sha": "842a177db3fd1a4bb5fcb759dd8f28c626770882", "filename": "crates/hir_expand/src/db.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/883c8d177d61d34d70d4fccef788fe4b35aaa7ea/crates%2Fhir_expand%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/883c8d177d61d34d70d4fccef788fe4b35aaa7ea/crates%2Fhir_expand%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fdb.rs?ref=883c8d177d61d34d70d4fccef788fe4b35aaa7ea", "patch": "@@ -207,6 +207,7 @@ fn macro_expand_with_arg(\n             } else {\n                 return ExpandResult {\n                     value: Some(db.lookup_intern_eager_expansion(id).subtree),\n+                    // FIXME: There could be errors here!\n                     err: None,\n                 };\n             }"}]}