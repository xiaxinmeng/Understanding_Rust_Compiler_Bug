{"sha": "9d4422e1fc2d579b1f7f28837c2cc78f453d818a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlkNDQyMmUxZmMyZDU3OWIxZjdmMjg4MzdjMmNjNzhmNDUzZDgxOGE=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2016-03-02T01:31:15Z"}, "committer": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2016-03-02T01:31:15Z"}, "message": "Rollup merge of #31919 - petrochenkov:blockpub, r=nikomatsakis\n\nCloses https://github.com/rust-lang/rust/issues/31776\n\nr? @nikomatsakis", "tree": {"sha": "a7025bb377ab4fb9b47d15662622cb294f71811d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a7025bb377ab4fb9b47d15662622cb294f71811d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9d4422e1fc2d579b1f7f28837c2cc78f453d818a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9d4422e1fc2d579b1f7f28837c2cc78f453d818a", "html_url": "https://github.com/rust-lang/rust/commit/9d4422e1fc2d579b1f7f28837c2cc78f453d818a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9d4422e1fc2d579b1f7f28837c2cc78f453d818a/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "84d8fec9b014975145eb0d9d6ec29216593e10f6", "url": "https://api.github.com/repos/rust-lang/rust/commits/84d8fec9b014975145eb0d9d6ec29216593e10f6", "html_url": "https://github.com/rust-lang/rust/commit/84d8fec9b014975145eb0d9d6ec29216593e10f6"}, {"sha": "b6f441d9861868eefd81460e0c3e4295fca12ffe", "url": "https://api.github.com/repos/rust-lang/rust/commits/b6f441d9861868eefd81460e0c3e4295fca12ffe", "html_url": "https://github.com/rust-lang/rust/commit/b6f441d9861868eefd81460e0c3e4295fca12ffe"}], "stats": {"total": 226, "additions": 97, "deletions": 129}, "files": [{"sha": "e0ede288523b436c0295bc995dd315ddd27b6f60", "filename": "src/librustc_privacy/lib.rs", "status": "modified", "additions": 15, "deletions": 70, "changes": 85, "blob_url": "https://github.com/rust-lang/rust/blob/9d4422e1fc2d579b1f7f28837c2cc78f453d818a/src%2Flibrustc_privacy%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9d4422e1fc2d579b1f7f28837c2cc78f453d818a/src%2Flibrustc_privacy%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_privacy%2Flib.rs?ref=9d4422e1fc2d579b1f7f28837c2cc78f453d818a", "patch": "@@ -1129,43 +1129,19 @@ impl<'a, 'tcx, 'v> Visitor<'v> for PrivacyVisitor<'a, 'tcx> {\n \n struct SanePrivacyVisitor<'a, 'tcx: 'a> {\n     tcx: &'a ty::ctxt<'tcx>,\n-    in_block: bool,\n }\n \n impl<'a, 'tcx, 'v> Visitor<'v> for SanePrivacyVisitor<'a, 'tcx> {\n-    /// We want to visit items in the context of their containing\n-    /// module and so forth, so supply a crate for doing a deep walk.\n-    fn visit_nested_item(&mut self, item: hir::ItemId) {\n-        self.visit_item(self.tcx.map.expect_item(item.id))\n-    }\n-\n     fn visit_item(&mut self, item: &hir::Item) {\n         self.check_sane_privacy(item);\n-        if self.in_block {\n-            self.check_all_inherited(item);\n-        }\n-\n-        let orig_in_block = self.in_block;\n-\n-        // Modules turn privacy back on, otherwise we inherit\n-        self.in_block = if let hir::ItemMod(..) = item.node { false } else { orig_in_block };\n-\n         intravisit::walk_item(self, item);\n-        self.in_block = orig_in_block;\n-    }\n-\n-    fn visit_block(&mut self, b: &'v hir::Block) {\n-        let orig_in_block = replace(&mut self.in_block, true);\n-        intravisit::walk_block(self, b);\n-        self.in_block = orig_in_block;\n     }\n }\n \n impl<'a, 'tcx> SanePrivacyVisitor<'a, 'tcx> {\n-    /// Validates all of the visibility qualifiers placed on the item given. This\n-    /// ensures that there are no extraneous qualifiers that don't actually do\n-    /// anything. In theory these qualifiers wouldn't parse, but that may happen\n-    /// later on down the road...\n+    /// Validate that items that shouldn't have visibility qualifiers don't have them.\n+    /// Such qualifiers can be set by syntax extensions even if the parser doesn't allow them,\n+    /// so we check things like variant fields too.\n     fn check_sane_privacy(&self, item: &hir::Item) {\n         let check_inherited = |sp, vis, note: &str| {\n             if vis != hir::Inherited {\n@@ -1179,13 +1155,12 @@ impl<'a, 'tcx> SanePrivacyVisitor<'a, 'tcx> {\n         };\n \n         match item.node {\n-            // implementations of traits don't need visibility qualifiers because\n-            // that's controlled by having the trait in scope.\n             hir::ItemImpl(_, _, _, Some(..), _, ref impl_items) => {\n                 check_inherited(item.span, item.vis,\n                                 \"visibility qualifiers have no effect on trait impls\");\n                 for impl_item in impl_items {\n-                    check_inherited(impl_item.span, impl_item.vis, \"\");\n+                    check_inherited(impl_item.span, impl_item.vis,\n+                                    \"visibility qualifiers have no effect on trait impl items\");\n                 }\n             }\n             hir::ItemImpl(_, _, _, None, _, _) => {\n@@ -1200,41 +1175,15 @@ impl<'a, 'tcx> SanePrivacyVisitor<'a, 'tcx> {\n                 check_inherited(item.span, item.vis,\n                                 \"place qualifiers on individual functions instead\");\n             }\n-            hir::ItemStruct(..) | hir::ItemEnum(..) | hir::ItemTrait(..) |\n-            hir::ItemConst(..) | hir::ItemStatic(..) | hir::ItemFn(..) |\n-            hir::ItemMod(..) | hir::ItemExternCrate(..) |\n-            hir::ItemUse(..) | hir::ItemTy(..) => {}\n-        }\n-    }\n-\n-    /// When inside of something like a function or a method, visibility has no\n-    /// control over anything so this forbids any mention of any visibility\n-    fn check_all_inherited(&self, item: &hir::Item) {\n-        let check_inherited = |sp, vis| {\n-            if vis != hir::Inherited {\n-                span_err!(self.tcx.sess, sp, E0447,\n-                          \"visibility has no effect inside functions or block expressions\");\n-            }\n-        };\n-\n-        check_inherited(item.span, item.vis);\n-        match item.node {\n-            hir::ItemImpl(_, _, _, _, _, ref impl_items) => {\n-                for impl_item in impl_items {\n-                    check_inherited(impl_item.span, impl_item.vis);\n-                }\n-            }\n-            hir::ItemForeignMod(ref fm) => {\n-                for fi in &fm.items {\n-                    check_inherited(fi.span, fi.vis);\n-                }\n-            }\n-            hir::ItemStruct(ref vdata, _) => {\n-                for f in vdata.fields() {\n-                    check_inherited(f.span, f.node.kind.visibility());\n+            hir::ItemEnum(ref def, _) => {\n+                for variant in &def.variants {\n+                    for field in variant.node.data.fields() {\n+                        check_inherited(field.span, field.node.kind.visibility(),\n+                                        \"visibility qualifiers have no effect on variant fields\");\n+                    }\n                 }\n             }\n-            hir::ItemDefaultImpl(..) | hir::ItemEnum(..) | hir::ItemTrait(..) |\n+            hir::ItemStruct(..) | hir::ItemTrait(..) |\n             hir::ItemConst(..) | hir::ItemStatic(..) | hir::ItemFn(..) |\n             hir::ItemMod(..) | hir::ItemExternCrate(..) |\n             hir::ItemUse(..) | hir::ItemTy(..) => {}\n@@ -1821,13 +1770,9 @@ pub fn check_crate(tcx: &ty::ctxt,\n \n     let krate = tcx.map.krate();\n \n-    // Sanity check to make sure that all privacy usage and controls are\n-    // reasonable.\n-    let mut visitor = SanePrivacyVisitor {\n-        tcx: tcx,\n-        in_block: false,\n-    };\n-    intravisit::walk_crate(&mut visitor, krate);\n+    // Sanity check to make sure that all privacy usage is reasonable.\n+    let mut visitor = SanePrivacyVisitor { tcx: tcx };\n+    krate.visit_all_items(&mut visitor);\n \n     // Figure out who everyone's parent is\n     let mut visitor = ParentVisitor {"}, {"sha": "063848f62aa9ee9f23c5cd100fd0ce657586cd36", "filename": "src/test/compile-fail/privacy-sanity.rs", "status": "modified", "additions": 18, "deletions": 32, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/9d4422e1fc2d579b1f7f28837c2cc78f453d818a/src%2Ftest%2Fcompile-fail%2Fprivacy-sanity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9d4422e1fc2d579b1f7f28837c2cc78f453d818a/src%2Ftest%2Fcompile-fail%2Fprivacy-sanity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fprivacy-sanity.rs?ref=9d4422e1fc2d579b1f7f28837c2cc78f453d818a", "patch": "@@ -40,74 +40,60 @@ pub extern \"C\" { //~ ERROR unnecessary visibility qualifier\n \n const MAIN: u8 = {\n     trait MarkerTr {}\n-    pub trait Tr { //~ ERROR visibility has no effect inside functions or block\n+    pub trait Tr {\n         fn f();\n         const C: u8;\n         type T;\n     }\n-    pub struct S { //~ ERROR visibility has no effect inside functions or block\n-        pub a: u8 //~ ERROR visibility has no effect inside functions or block\n+    pub struct S {\n+        pub a: u8\n     }\n-    struct Ts(pub u8); //~ ERROR visibility has no effect inside functions or block\n+    struct Ts(pub u8);\n \n     pub impl MarkerTr for .. {} //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n     pub impl Tr for S {  //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n         pub fn f() {} //~ ERROR unnecessary visibility qualifier\n-        //~^ ERROR visibility has no effect inside functions or block\n         pub const C: u8 = 0; //~ ERROR unnecessary visibility qualifier\n-        //~^ ERROR visibility has no effect inside functions or block\n         pub type T = u8; //~ ERROR unnecessary visibility qualifier\n-        //~^ ERROR visibility has no effect inside functions or block\n     }\n     pub impl S { //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n-        pub fn f() {} //~ ERROR visibility has no effect inside functions or block\n-        pub const C: u8 = 0; //~ ERROR visibility has no effect inside functions or block\n-        // pub type T = u8; // ERROR visibility has no effect inside functions or block\n+        pub fn f() {}\n+        pub const C: u8 = 0;\n+        // pub type T = u8;\n     }\n     pub extern \"C\" { //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n-        pub fn f(); //~ ERROR visibility has no effect inside functions or block\n-        pub static St: u8; //~ ERROR visibility has no effect inside functions or block\n+        pub fn f();\n+        pub static St: u8;\n     }\n \n     0\n };\n \n fn main() {\n     trait MarkerTr {}\n-    pub trait Tr { //~ ERROR visibility has no effect inside functions or block\n+    pub trait Tr {\n         fn f();\n         const C: u8;\n         type T;\n     }\n-    pub struct S { //~ ERROR visibility has no effect inside functions or block\n-        pub a: u8 //~ ERROR visibility has no effect inside functions or block\n+    pub struct S {\n+        pub a: u8\n     }\n-    struct Ts(pub u8); //~ ERROR visibility has no effect inside functions or block\n+    struct Ts(pub u8);\n \n     pub impl MarkerTr for .. {} //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n     pub impl Tr for S {  //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n         pub fn f() {} //~ ERROR unnecessary visibility qualifier\n-        //~^ ERROR visibility has no effect inside functions or block\n         pub const C: u8 = 0; //~ ERROR unnecessary visibility qualifier\n-        //~^ ERROR visibility has no effect inside functions or block\n         pub type T = u8; //~ ERROR unnecessary visibility qualifier\n-        //~^ ERROR visibility has no effect inside functions or block\n     }\n     pub impl S { //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n-        pub fn f() {} //~ ERROR visibility has no effect inside functions or block\n-        pub const C: u8 = 0; //~ ERROR visibility has no effect inside functions or block\n-        // pub type T = u8; // ERROR visibility has no effect inside functions or block\n+        pub fn f() {}\n+        pub const C: u8 = 0;\n+        // pub type T = u8;\n     }\n     pub extern \"C\" { //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n-        pub fn f(); //~ ERROR visibility has no effect inside functions or block\n-        pub static St: u8; //~ ERROR visibility has no effect inside functions or block\n+        pub fn f();\n+        pub static St: u8;\n     }\n }"}, {"sha": "113393490cb6de18fb5c3c60dcdcaeca9a530a01", "filename": "src/test/compile-fail/unnecessary-private.rs", "status": "removed", "additions": 0, "deletions": 27, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/84d8fec9b014975145eb0d9d6ec29216593e10f6/src%2Ftest%2Fcompile-fail%2Funnecessary-private.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84d8fec9b014975145eb0d9d6ec29216593e10f6/src%2Ftest%2Fcompile-fail%2Funnecessary-private.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Funnecessary-private.rs?ref=84d8fec9b014975145eb0d9d6ec29216593e10f6", "patch": "@@ -1,27 +0,0 @@\n-// Copyright 2013-2014 The Rust Project Developers. See the COPYRIGHT\n-// file at the top-level directory of this distribution and at\n-// http://rust-lang.org/COPYRIGHT.\n-//\n-// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n-// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n-// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n-// option. This file may not be copied, modified, or distributed\n-// except according to those terms.\n-\n-fn main() {\n-    pub use std::usize; //~ ERROR: visibility has no effect\n-    pub struct A; //~ ERROR: visibility has no effect\n-    pub enum B {} //~ ERROR: visibility has no effect\n-    pub trait C { //~ ERROR: visibility has no effect\n-        fn foo(&self) {}\n-    }\n-    impl A {\n-        pub fn foo(&self) {} //~ ERROR: visibility has no effect\n-    }\n-\n-    struct D {\n-        pub foo: isize, //~ ERROR: visibility has no effect\n-    }\n-    pub fn foo() {} //~ ERROR: visibility has no effect\n-    pub mod bar {} //~ ERROR: visibility has no effect\n-}"}, {"sha": "a12e569df2bc925625ec8094a0085f60d2509521", "filename": "src/test/run-pass/issue-31776.rs", "status": "added", "additions": 64, "deletions": 0, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/9d4422e1fc2d579b1f7f28837c2cc78f453d818a/src%2Ftest%2Frun-pass%2Fissue-31776.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9d4422e1fc2d579b1f7f28837c2cc78f453d818a/src%2Ftest%2Frun-pass%2Fissue-31776.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-31776.rs?ref=9d4422e1fc2d579b1f7f28837c2cc78f453d818a", "patch": "@@ -0,0 +1,64 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Various scenarios in which `pub` is required in blocks\n+\n+struct S;\n+\n+mod m {\n+    fn f() {\n+        impl ::S {\n+            pub fn s(&self) {}\n+        }\n+    }\n+}\n+\n+// ------------------------------------------------------\n+\n+pub trait Tr {\n+    type A;\n+}\n+pub struct S1;\n+\n+fn f() {\n+    pub struct Z;\n+\n+    impl ::Tr for ::S1 {\n+        type A = Z; // Private-in-public error unless `struct Z` is pub\n+    }\n+}\n+\n+// ------------------------------------------------------\n+\n+trait Tr1 {\n+    type A;\n+    fn pull(&self) -> Self::A;\n+}\n+struct S2;\n+\n+mod m1 {\n+    fn f() {\n+        struct Z {\n+            pub field: u8\n+        }\n+\n+        impl ::Tr1 for ::S2 {\n+            type A = Z;\n+            fn pull(&self) -> Self::A { Z{field: 10} }\n+        }\n+    }\n+}\n+\n+// ------------------------------------------------------\n+\n+fn main() {\n+    S.s(); // Privacy error, unless `fn s` is pub\n+    let a = S2.pull().field; // Privacy error unless `field: u8` is pub\n+}"}]}