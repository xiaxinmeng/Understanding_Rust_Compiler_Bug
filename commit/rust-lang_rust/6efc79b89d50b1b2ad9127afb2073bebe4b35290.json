{"sha": "6efc79b89d50b1b2ad9127afb2073bebe4b35290", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZlZmM3OWI4OWQ1MGIxYjJhZDkxMjdhZmIyMDczYmViZTRiMzUyOTA=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-08-07T13:14:22Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-08-07T13:14:22Z"}, "message": "implement while let desugaring", "tree": {"sha": "c7209226fc680c545a02b0deb6da25c61a64500f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c7209226fc680c545a02b0deb6da25c61a64500f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6efc79b89d50b1b2ad9127afb2073bebe4b35290", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6efc79b89d50b1b2ad9127afb2073bebe4b35290", "html_url": "https://github.com/rust-lang/rust/commit/6efc79b89d50b1b2ad9127afb2073bebe4b35290", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6efc79b89d50b1b2ad9127afb2073bebe4b35290/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "39967a85e1f04676062d46b04e7ac8399c57df66", "url": "https://api.github.com/repos/rust-lang/rust/commits/39967a85e1f04676062d46b04e7ac8399c57df66", "html_url": "https://github.com/rust-lang/rust/commit/39967a85e1f04676062d46b04e7ac8399c57df66"}], "stats": {"total": 97, "additions": 76, "deletions": 21}, "files": [{"sha": "f33676655b2359da89d4d635b6f1a21b12f80e42", "filename": "crates/ra_hir/src/expr.rs", "status": "modified", "additions": 26, "deletions": 14, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/6efc79b89d50b1b2ad9127afb2073bebe4b35290/crates%2Fra_hir%2Fsrc%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6efc79b89d50b1b2ad9127afb2073bebe4b35290/crates%2Fra_hir%2Fsrc%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fexpr.rs?ref=6efc79b89d50b1b2ad9127afb2073bebe4b35290", "patch": "@@ -11,17 +11,16 @@ use ra_syntax::{\n     },\n     AstNode, AstPtr, SyntaxNodePtr,\n };\n+use test_utils::tested_by;\n \n use crate::{\n     name::{AsName, SELF_PARAM},\n+    path::GenericArgs,\n+    ty::primitive::{FloatTy, IntTy, UncertainFloatTy, UncertainIntTy},\n     type_ref::{Mutability, TypeRef},\n     DefWithBody, Either, HasSource, HirDatabase, HirFileId, MacroCallLoc, MacroFileKind, Name,\n     Path, Resolver,\n };\n-use crate::{\n-    path::GenericArgs,\n-    ty::primitive::{FloatTy, IntTy, UncertainFloatTy, UncertainIntTy},\n-};\n \n pub use self::scope::ExprScopes;\n \n@@ -603,17 +602,30 @@ where\n                 self.alloc_expr(Expr::Loop { body }, syntax_ptr)\n             }\n             ast::ExprKind::WhileExpr(e) => {\n-                let condition = if let Some(condition) = e.condition() {\n-                    if condition.pat().is_none() {\n-                        self.collect_expr_opt(condition.expr())\n-                    } else {\n-                        // FIXME handle while let\n-                        return self.alloc_expr(Expr::Missing, syntax_ptr);\n-                    }\n-                } else {\n-                    self.exprs.alloc(Expr::Missing)\n-                };\n                 let body = self.collect_block_opt(e.loop_body());\n+\n+                let condition = match e.condition() {\n+                    None => self.exprs.alloc(Expr::Missing),\n+                    Some(condition) => match condition.pat() {\n+                        None => self.collect_expr_opt(condition.expr()),\n+                        // if let -- desugar to match\n+                        Some(pat) => {\n+                            tested_by!(infer_while_let);\n+                            let pat = self.collect_pat(pat);\n+                            let match_expr = self.collect_expr_opt(condition.expr());\n+                            let placeholder_pat = self.pats.alloc(Pat::Missing);\n+                            let break_ = self.exprs.alloc(Expr::Break { expr: None });\n+                            let arms = vec![\n+                                MatchArm { pats: vec![pat], expr: body, guard: None },\n+                                MatchArm { pats: vec![placeholder_pat], expr: break_, guard: None },\n+                            ];\n+                            let match_expr =\n+                                self.exprs.alloc(Expr::Match { expr: match_expr, arms });\n+                            return self.alloc_expr(Expr::Loop { body: match_expr }, syntax_ptr);\n+                        }\n+                    },\n+                };\n+\n                 self.alloc_expr(Expr::While { condition, body }, syntax_ptr)\n             }\n             ast::ExprKind::ForExpr(e) => {"}, {"sha": "5b15eee901a9bde788ff3be6c76b9e800fde1a2a", "filename": "crates/ra_hir/src/marks.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6efc79b89d50b1b2ad9127afb2073bebe4b35290/crates%2Fra_hir%2Fsrc%2Fmarks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6efc79b89d50b1b2ad9127afb2073bebe4b35290/crates%2Fra_hir%2Fsrc%2Fmarks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fmarks.rs?ref=6efc79b89d50b1b2ad9127afb2073bebe4b35290", "patch": "@@ -10,4 +10,5 @@ test_utils::marks!(\n     std_prelude\n     match_ergonomics_ref\n     trait_resolution_on_fn_type\n+    infer_while_let\n );"}, {"sha": "d5f7a4d2503b71fdc68905a786b3213a2e9ef907", "filename": "crates/ra_hir/src/ty/tests.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/6efc79b89d50b1b2ad9127afb2073bebe4b35290/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6efc79b89d50b1b2ad9127afb2073bebe4b35290/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs?ref=6efc79b89d50b1b2ad9127afb2073bebe4b35290", "patch": "@@ -144,6 +144,26 @@ mod collections {\n     assert_eq!(\"&str\", type_at_pos(&db, pos));\n }\n \n+#[test]\n+fn infer_while_let() {\n+    covers!(infer_while_let);\n+    let (db, pos) = MockDatabase::with_position(\n+        r#\"\n+//- /main.rs\n+enum Option<T> { Some(T), None }\n+\n+fn test() {\n+    let foo: Option<f32> = None;\n+    while let Option::Some(x) = foo {\n+        <|>x\n+    }\n+}\n+\n+\"#,\n+    );\n+    assert_eq!(\"f32\", type_at_pos(&db, pos));\n+}\n+\n #[test]\n fn infer_basics() {\n     assert_snapshot_matches!("}, {"sha": "0b3c96d26aa63a179040d72d19975b149b6721b4", "filename": "crates/ra_ide_api/src/inlay_hints.rs", "status": "modified", "additions": 29, "deletions": 7, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/6efc79b89d50b1b2ad9127afb2073bebe4b35290/crates%2Fra_ide_api%2Fsrc%2Finlay_hints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6efc79b89d50b1b2ad9127afb2073bebe4b35290/crates%2Fra_ide_api%2Fsrc%2Finlay_hints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Finlay_hints.rs?ref=6efc79b89d50b1b2ad9127afb2073bebe4b35290", "patch": "@@ -414,13 +414,35 @@ fn main() {\n }\"#,\n         );\n \n-        assert_debug_snapshot_matches!(analysis.inlay_hints(file_id).unwrap(), @r#\"[\n-    InlayHint {\n-        range: [166; 170),\n-        kind: TypeHint,\n-        label: \"CustomOption<Test>\",\n-    },\n-]\"#\n+        assert_debug_snapshot_matches!(analysis.inlay_hints(file_id).unwrap(), @r###\"\n+       \u22ee[\n+       \u22ee    InlayHint {\n+       \u22ee        range: [166; 170),\n+       \u22ee        kind: TypeHint,\n+       \u22ee        label: \"CustomOption<Test>\",\n+       \u22ee    },\n+       \u22ee    InlayHint {\n+       \u22ee        range: [343; 347),\n+       \u22ee        kind: TypeHint,\n+       \u22ee        label: \"&Test\",\n+       \u22ee    },\n+       \u22ee    InlayHint {\n+       \u22ee        range: [401; 402),\n+       \u22ee        kind: TypeHint,\n+       \u22ee        label: \"&CustomOption<u32>\",\n+       \u22ee    },\n+       \u22ee    InlayHint {\n+       \u22ee        range: [404; 405),\n+       \u22ee        kind: TypeHint,\n+       \u22ee        label: \"&u8\",\n+       \u22ee    },\n+       \u22ee    InlayHint {\n+       \u22ee        range: [549; 550),\n+       \u22ee        kind: TypeHint,\n+       \u22ee        label: \"&u32\",\n+       \u22ee    },\n+       \u22ee]\n+        \"###\n         );\n     }\n "}]}