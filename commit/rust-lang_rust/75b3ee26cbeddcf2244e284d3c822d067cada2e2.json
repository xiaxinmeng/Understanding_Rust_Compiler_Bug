{"sha": "75b3ee26cbeddcf2244e284d3c822d067cada2e2", "node_id": "C_kwDOAAsO6NoAKDc1YjNlZTI2Y2JlZGRjZjIyNDRlMjg0ZDNjODIyZDA2N2NhZGEyZTI", "commit": {"author": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2022-12-30T11:23:05Z"}, "committer": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2022-12-30T20:47:11Z"}, "message": "Make tidy errors red\n\nThis makes it easier to see them (and makes people go owo).", "tree": {"sha": "5165ca83d0b39c542ebf681c13e38a62256f3363", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5165ca83d0b39c542ebf681c13e38a62256f3363"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/75b3ee26cbeddcf2244e284d3c822d067cada2e2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/75b3ee26cbeddcf2244e284d3c822d067cada2e2", "html_url": "https://github.com/rust-lang/rust/commit/75b3ee26cbeddcf2244e284d3c822d067cada2e2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/75b3ee26cbeddcf2244e284d3c822d067cada2e2/comments", "author": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f9cc01126954e2fde28162fd83b4ef3e447526a6", "url": "https://api.github.com/repos/rust-lang/rust/commits/f9cc01126954e2fde28162fd83b4ef3e447526a6", "html_url": "https://github.com/rust-lang/rust/commit/f9cc01126954e2fde28162fd83b4ef3e447526a6"}], "stats": {"total": 41, "additions": 28, "deletions": 13}, "files": [{"sha": "f99e58e59b8e55d48bcb40f6153be3a1ed397531", "filename": "Cargo.lock", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/75b3ee26cbeddcf2244e284d3c822d067cada2e2/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/75b3ee26cbeddcf2244e284d3c822d067cada2e2/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=75b3ee26cbeddcf2244e284d3c822d067cada2e2", "patch": "@@ -2675,9 +2675,9 @@ dependencies = [\n \n [[package]]\n name = \"owo-colors\"\n-version = \"3.4.0\"\n+version = \"3.5.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"decf7381921fea4dcb2549c5667eda59b3ec297ab7e2b5fc33eac69d2e7da87b\"\n+checksum = \"c1b04fb49957986fdce4d6ee7a65027d55d4b6d2265e5848bbb507b58ccfdb6f\"\n \n [[package]]\n name = \"packed_simd_2\"\n@@ -5203,9 +5203,9 @@ dependencies = [\n \n [[package]]\n name = \"termcolor\"\n-version = \"1.1.2\"\n+version = \"1.1.3\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"2dfed899f0eb03f32ee8c6a0aabdb8a7949659e3466561fc0adf54e26d88c5f4\"\n+checksum = \"bab24d30b911b2376f3a13cc2cd443142f0c81dda04c118693e35b3835757755\"\n dependencies = [\n  \"winapi-util\",\n ]\n@@ -5309,6 +5309,7 @@ dependencies = [\n  \"lazy_static\",\n  \"miropt-test-tools\",\n  \"regex\",\n+ \"termcolor\",\n  \"walkdir\",\n ]\n "}, {"sha": "fff83a1d097b3f6364c180781b8bfdb6ec886dc6", "filename": "src/tools/tidy/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/75b3ee26cbeddcf2244e284d3c822d067cada2e2/src%2Ftools%2Ftidy%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/75b3ee26cbeddcf2244e284d3c822d067cada2e2/src%2Ftools%2Ftidy%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2FCargo.toml?ref=75b3ee26cbeddcf2244e284d3c822d067cada2e2", "patch": "@@ -11,6 +11,7 @@ miropt-test-tools = { path = \"../miropt-test-tools\" }\n lazy_static = \"1\"\n walkdir = \"2\"\n ignore = \"0.4.18\"\n+termcolor = \"1.1.3\"\n \n [[bin]]\n name = \"rust-tidy\""}, {"sha": "ce7e7ac5cd4caad70a7754c6b02054352ee3eb06", "filename": "src/tools/tidy/src/lib.rs", "status": "modified", "additions": 22, "deletions": 9, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/75b3ee26cbeddcf2244e284d3c822d067cada2e2/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75b3ee26cbeddcf2244e284d3c822d067cada2e2/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs?ref=75b3ee26cbeddcf2244e284d3c822d067cada2e2", "patch": "@@ -3,6 +3,10 @@\n //! This library contains the tidy lints and exposes it\n //! to be used by tools.\n \n+use std::fmt::Display;\n+\n+use termcolor::WriteColor;\n+\n /// A helper macro to `unwrap` a result except also print out details like:\n ///\n /// * The expression that failed\n@@ -26,18 +30,27 @@ macro_rules! t {\n }\n \n macro_rules! tidy_error {\n-    ($bad:expr, $fmt:expr) => ({\n-        *$bad = true;\n-        eprint!(\"tidy error: \");\n-        eprintln!($fmt);\n-    });\n-    ($bad:expr, $fmt:expr, $($arg:tt)*) => ({\n-        *$bad = true;\n-        eprint!(\"tidy error: \");\n-        eprintln!($fmt, $($arg)*);\n+    ($bad:expr, $($fmt:tt)*) => ({\n+        $crate::tidy_error($bad, format_args!($($fmt)*)).expect(\"failed to output error\");\n     });\n }\n \n+fn tidy_error(bad: &mut bool, args: impl Display) -> std::io::Result<()> {\n+    use std::io::Write;\n+    use termcolor::{Color, ColorChoice, ColorSpec, StandardStream};\n+\n+    *bad = true;\n+\n+    let mut stderr = StandardStream::stdout(ColorChoice::Auto);\n+    stderr.set_color(ColorSpec::new().set_fg(Some(Color::Red)))?;\n+\n+    write!(&mut stderr, \"tidy error\")?;\n+    stderr.set_color(&ColorSpec::new())?;\n+\n+    writeln!(&mut stderr, \": {args}\")?;\n+    Ok(())\n+}\n+\n pub mod alphabetical;\n pub mod bins;\n pub mod debug_artifacts;"}]}