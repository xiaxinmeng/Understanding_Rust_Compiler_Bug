{"sha": "16cc5ddacbde23a71d05535f6b51298d295535df", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE2Y2M1ZGRhY2JkZTIzYTcxZDA1NTM1ZjZiNTEyOThkMjk1NTM1ZGY=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-05-29T07:39:49Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-05-29T07:39:49Z"}, "message": "tweak logic for determining rustc default target", "tree": {"sha": "ba4351d5d4be8ff4f1a899f4226c8790df521154", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ba4351d5d4be8ff4f1a899f4226c8790df521154"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/16cc5ddacbde23a71d05535f6b51298d295535df", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/16cc5ddacbde23a71d05535f6b51298d295535df", "html_url": "https://github.com/rust-lang/rust/commit/16cc5ddacbde23a71d05535f6b51298d295535df", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/16cc5ddacbde23a71d05535f6b51298d295535df/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "35b4d9fd8ac260bdfee5204ec2590420ca0782b2", "url": "https://api.github.com/repos/rust-lang/rust/commits/35b4d9fd8ac260bdfee5204ec2590420ca0782b2", "html_url": "https://github.com/rust-lang/rust/commit/35b4d9fd8ac260bdfee5204ec2590420ca0782b2"}], "stats": {"total": 12, "additions": 9, "deletions": 3}, "files": [{"sha": "2181403b7bde94745c5955323bffedfe9c4e856c", "filename": "miri", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/16cc5ddacbde23a71d05535f6b51298d295535df/miri", "raw_url": "https://github.com/rust-lang/rust/raw/16cc5ddacbde23a71d05535f6b51298d295535df/miri", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/miri?ref=16cc5ddacbde23a71d05535f6b51298d295535df", "patch": "@@ -33,13 +33,19 @@ EOF\n )\n \n ## Preparation\n-# I'd love to use `jq` for parsing the JSON properly, but macOS is totally underequipped for this kind of work.\n-TARGET=$(rustc --print target-spec-json -Z unstable-options | grep llvm-target | cut -d '\"' -f 4)\n+TARGET=$(rustc --version --verbose | grep \"^host:\" | cut -d ' ' -f 2)\n SYSROOT=$(rustc --print sysroot)\n+LIBDIR=$SYSROOT/lib/rustlib/$TARGET/lib\n+if ! test -d \"$LIBDIR\"; then\n+    echo \"Something went wrong determining the library dir.\"\n+    echo \"I got $LIBDIR but that does not exist.\"\n+    echo \"Please report a bug at https://github.com/rust-lang/miri/issues.\"\n+    exit 2\n+fi\n # We set the rpath so that Miri finds the private rustc libraries it needs.\n # We enable debug-assertions to get tracing.\n # We enable line-only debuginfo for backtraces.\n-export RUSTFLAGS=\"-C link-args=-Wl,-rpath,$SYSROOT/lib/rustlib/$TARGET/lib -C debug-assertions -C debuginfo=1\"\n+export RUSTFLAGS=\"-C link-args=-Wl,-rpath,$LIBDIR -C debug-assertions -C debuginfo=1\"\n \n ## Helper functions\n "}]}