{"sha": "62effcbd5bfaf74e99def3e9a660dba9728b0b47", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYyZWZmY2JkNWJmYWY3NGU5OWRlZjNlOWE2NjBkYmE5NzI4YjBiNDc=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2020-08-31T17:24:37Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2020-09-14T19:06:51Z"}, "message": "Detect turbofish with multiple type params missing leading `::`\n\nFix #76072.", "tree": {"sha": "de190792a8eafc51d915e96d2145810a42d8372c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/de190792a8eafc51d915e96d2145810a42d8372c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/62effcbd5bfaf74e99def3e9a660dba9728b0b47", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/62effcbd5bfaf74e99def3e9a660dba9728b0b47", "html_url": "https://github.com/rust-lang/rust/commit/62effcbd5bfaf74e99def3e9a660dba9728b0b47", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/62effcbd5bfaf74e99def3e9a660dba9728b0b47/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "85fbf49ce0e2274d0acf798f6e703747674feec3", "url": "https://api.github.com/repos/rust-lang/rust/commits/85fbf49ce0e2274d0acf798f6e703747674feec3", "html_url": "https://github.com/rust-lang/rust/commit/85fbf49ce0e2274d0acf798f6e703747674feec3"}], "stats": {"total": 176, "additions": 167, "deletions": 9}, "files": [{"sha": "002d8baf03ff0a1868ba9983e4e95573b617c6bd", "filename": "compiler/rustc_parse/src/parser/diagnostics.rs", "status": "modified", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/62effcbd5bfaf74e99def3e9a660dba9728b0b47/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62effcbd5bfaf74e99def3e9a660dba9728b0b47/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs?ref=62effcbd5bfaf74e99def3e9a660dba9728b0b47", "patch": "@@ -548,6 +548,52 @@ impl<'a> Parser<'a> {\n         }\n     }\n \n+    /// When writing a turbofish with multiple type parameters missing the leading `::`, we will\n+    /// encounter a parse error when encountering the first `,`.\n+    pub(super) fn check_mistyped_turbofish_with_multiple_type_params(\n+        &mut self,\n+        mut e: DiagnosticBuilder<'a>,\n+        expr: &mut P<Expr>,\n+    ) -> PResult<'a, ()> {\n+        if let ExprKind::Binary(binop, _, _) = &expr.kind {\n+            if let ast::BinOpKind::Lt = binop.node {\n+                if self.eat(&token::Comma) {\n+                    let x = self.parse_seq_to_before_end(\n+                        &token::Gt,\n+                        SeqSep::trailing_allowed(token::Comma),\n+                        |p| p.parse_ty(),\n+                    );\n+                    match x {\n+                        Ok((_, _, false)) => {\n+                            self.bump(); // `>`\n+                            match self.parse_expr() {\n+                                Ok(_) => {\n+                                    e.span_suggestion_verbose(\n+                                        binop.span.shrink_to_lo(),\n+                                        \"use `::<...>` instead of `<...>` to specify type arguments\",\n+                                        \"::\".to_string(),\n+                                        Applicability::MaybeIncorrect,\n+                                    );\n+                                    e.emit();\n+                                    *expr = self.mk_expr_err(expr.span.to(self.prev_token.span));\n+                                    return Ok(());\n+                                }\n+                                Err(mut err) => {\n+                                    err.cancel();\n+                                }\n+                            }\n+                        }\n+                        Err(mut err) => {\n+                            err.cancel();\n+                        }\n+                        _ => {}\n+                    }\n+                }\n+            }\n+        }\n+        Err(e)\n+    }\n+\n     /// Check to see if a pair of chained operators looks like an attempt at chained comparison,\n     /// e.g. `1 < x <= 3`. If so, suggest either splitting the comparison into two, or\n     /// parenthesising the leftmost comparison."}, {"sha": "d8a2e106dc0868e5344cabe63243ac83ddb41858", "filename": "compiler/rustc_parse/src/parser/stmt.rs", "status": "modified", "additions": 20, "deletions": 6, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/62effcbd5bfaf74e99def3e9a660dba9728b0b47/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fstmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62effcbd5bfaf74e99def3e9a660dba9728b0b47/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fstmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fstmt.rs?ref=62effcbd5bfaf74e99def3e9a660dba9728b0b47", "patch": "@@ -363,7 +363,7 @@ impl<'a> Parser<'a> {\n         let mut eat_semi = true;\n         match stmt.kind {\n             // Expression without semicolon.\n-            StmtKind::Expr(ref expr)\n+            StmtKind::Expr(ref mut expr)\n                 if self.token != token::Eof && classify::expr_requires_semi_to_be_stmt(expr) =>\n             {\n                 // Just check for errors and recover; do not eat semicolon yet.\n@@ -387,15 +387,29 @@ impl<'a> Parser<'a> {\n                             );\n                         }\n                     }\n-                    e.emit();\n-                    self.recover_stmt();\n+                    if let Err(mut e) =\n+                        self.check_mistyped_turbofish_with_multiple_type_params(e, expr)\n+                    {\n+                        e.emit();\n+                        self.recover_stmt();\n+                    }\n                     // Don't complain about type errors in body tail after parse error (#57383).\n                     let sp = expr.span.to(self.prev_token.span);\n-                    stmt.kind = StmtKind::Expr(self.mk_expr_err(sp));\n+                    *expr = self.mk_expr_err(sp);\n                 }\n             }\n-            StmtKind::Local(..) => {\n-                self.expect_semi()?;\n+            StmtKind::Local(ref mut local) => {\n+                if let Err(e) = self.expect_semi() {\n+                    // We might be at the `,` in `let x = foo<bar, baz>;`. Try to recover.\n+                    match &mut local.init {\n+                        Some(ref mut expr) => {\n+                            self.check_mistyped_turbofish_with_multiple_type_params(e, expr)?;\n+                            // We found `foo<bar, baz>`, have we fully recovered?\n+                            self.expect_semi()?;\n+                        }\n+                        None => return Err(e),\n+                    }\n+                }\n                 eat_semi = false;\n             }\n             StmtKind::Empty => eat_semi = false,"}, {"sha": "5497ba2e11f7325bbecaff305b7ef5ec3823aeae", "filename": "src/test/ui/did_you_mean/issue-40396.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/62effcbd5bfaf74e99def3e9a660dba9728b0b47/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-40396.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62effcbd5bfaf74e99def3e9a660dba9728b0b47/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-40396.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-40396.rs?ref=62effcbd5bfaf74e99def3e9a660dba9728b0b47", "patch": "@@ -1,8 +1,29 @@\n fn main() {\n     (0..13).collect<Vec<i32>>();\n     //~^ ERROR comparison operators cannot be chained\n+    //~| HELP use `::<...>` instead\n     Vec<i32>::new();\n     //~^ ERROR comparison operators cannot be chained\n+    //~| HELP use `::<...>` instead\n     (0..13).collect<Vec<i32>();\n     //~^ ERROR comparison operators cannot be chained\n+    //~| HELP use `::<...>` instead\n+    let x = std::collections::HashMap<i128, i128>::new(); //~ ERROR expected one of\n+    //~^ HELP use `::<...>` instead\n+    let x: () = 42; //~ ERROR mismatched types\n+    let x = {\n+        std::collections::HashMap<i128, i128>::new() //~ ERROR expected one of\n+        //~^ HELP use `::<...>` instead\n+    };\n+    let x: () = 42; //~ ERROR mismatched types\n+    let x = {\n+        std::collections::HashMap<i128, i128>::new(); //~ ERROR expected one of\n+        //~^ HELP use `::<...>` instead\n+        let x: () = 42; //~ ERROR mismatched types\n+    };\n+    {\n+        std::collections::HashMap<i128, i128>::new(1, 2); //~ ERROR expected one of\n+        //~^ HELP use `::<...>` instead\n+        let x: () = 32; //~ ERROR mismatched types\n+    };\n }"}, {"sha": "184bcf0c74b1428cc1896e562a5a411c4d759743", "filename": "src/test/ui/did_you_mean/issue-40396.stderr", "status": "modified", "additions": 80, "deletions": 3, "changes": 83, "blob_url": "https://github.com/rust-lang/rust/blob/62effcbd5bfaf74e99def3e9a660dba9728b0b47/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-40396.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/62effcbd5bfaf74e99def3e9a660dba9728b0b47/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-40396.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-40396.stderr?ref=62effcbd5bfaf74e99def3e9a660dba9728b0b47", "patch": "@@ -10,7 +10,7 @@ LL |     (0..13).collect::<Vec<i32>>();\n    |                    ^^\n \n error: comparison operators cannot be chained\n-  --> $DIR/issue-40396.rs:4:8\n+  --> $DIR/issue-40396.rs:5:8\n    |\n LL |     Vec<i32>::new();\n    |        ^   ^\n@@ -21,7 +21,7 @@ LL |     Vec::<i32>::new();\n    |        ^^\n \n error: comparison operators cannot be chained\n-  --> $DIR/issue-40396.rs:6:20\n+  --> $DIR/issue-40396.rs:8:20\n    |\n LL |     (0..13).collect<Vec<i32>();\n    |                    ^   ^\n@@ -31,5 +31,82 @@ help: use `::<...>` instead of `<...>` to specify type arguments\n LL |     (0..13).collect::<Vec<i32>();\n    |                    ^^\n \n-error: aborting due to 3 previous errors\n+error: expected one of `!`, `.`, `::`, `;`, `?`, `{`, or an operator, found `,`\n+  --> $DIR/issue-40396.rs:11:43\n+   |\n+LL |     let x = std::collections::HashMap<i128, i128>::new();\n+   |                                           ^ expected one of 7 possible tokens\n+   |\n+help: use `::<...>` instead of `<...>` to specify type arguments\n+   |\n+LL |     let x = std::collections::HashMap::<i128, i128>::new();\n+   |                                      ^^\n+\n+error: expected one of `!`, `.`, `::`, `;`, `?`, `{`, `}`, or an operator, found `,`\n+  --> $DIR/issue-40396.rs:15:39\n+   |\n+LL |         std::collections::HashMap<i128, i128>::new()\n+   |                                       ^ expected one of 8 possible tokens\n+   |\n+help: use `::<...>` instead of `<...>` to specify type arguments\n+   |\n+LL |         std::collections::HashMap::<i128, i128>::new()\n+   |                                  ^^\n+\n+error: expected one of `!`, `.`, `::`, `;`, `?`, `{`, `}`, or an operator, found `,`\n+  --> $DIR/issue-40396.rs:20:39\n+   |\n+LL |         std::collections::HashMap<i128, i128>::new();\n+   |                                       ^ expected one of 8 possible tokens\n+   |\n+help: use `::<...>` instead of `<...>` to specify type arguments\n+   |\n+LL |         std::collections::HashMap::<i128, i128>::new();\n+   |                                  ^^\n+\n+error: expected one of `!`, `.`, `::`, `;`, `?`, `{`, `}`, or an operator, found `,`\n+  --> $DIR/issue-40396.rs:25:39\n+   |\n+LL |         std::collections::HashMap<i128, i128>::new(1, 2);\n+   |                                       ^ expected one of 8 possible tokens\n+   |\n+help: use `::<...>` instead of `<...>` to specify type arguments\n+   |\n+LL |         std::collections::HashMap::<i128, i128>::new(1, 2);\n+   |                                  ^^\n+\n+error[E0308]: mismatched types\n+  --> $DIR/issue-40396.rs:13:17\n+   |\n+LL |     let x: () = 42;\n+   |            --   ^^ expected `()`, found integer\n+   |            |\n+   |            expected due to this\n+\n+error[E0308]: mismatched types\n+  --> $DIR/issue-40396.rs:18:17\n+   |\n+LL |     let x: () = 42;\n+   |            --   ^^ expected `()`, found integer\n+   |            |\n+   |            expected due to this\n+\n+error[E0308]: mismatched types\n+  --> $DIR/issue-40396.rs:22:21\n+   |\n+LL |         let x: () = 42;\n+   |                --   ^^ expected `()`, found integer\n+   |                |\n+   |                expected due to this\n+\n+error[E0308]: mismatched types\n+  --> $DIR/issue-40396.rs:27:21\n+   |\n+LL |         let x: () = 32;\n+   |                --   ^^ expected `()`, found integer\n+   |                |\n+   |                expected due to this\n+\n+error: aborting due to 11 previous errors\n \n+For more information about this error, try `rustc --explain E0308`."}]}