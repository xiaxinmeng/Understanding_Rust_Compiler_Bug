{"sha": "f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY2OTZiMjFjNWYxMDE3ZWJiNDUxZDFlOWQyZDhmZTI2MWIyNjUwN2Y=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-11-11T22:15:36Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-11-12T17:48:04Z"}, "message": "Move self-profile infrastructure to data structures\n\nThe single dependency on queries (QueryName) can be fairly easily\nabstracted via a trait and this further decouples Session from librustc\n(the primary goal).", "tree": {"sha": "2e28dbc81056ffa51c76a9834226f12b63529159", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2e28dbc81056ffa51c76a9834226f12b63529159"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "html_url": "https://github.com/rust-lang/rust/commit/f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5dda3ee9314cfee9c4e30a7b17dcd5ebdec081a7", "url": "https://api.github.com/repos/rust-lang/rust/commits/5dda3ee9314cfee9c4e30a7b17dcd5ebdec081a7", "html_url": "https://github.com/rust-lang/rust/commit/5dda3ee9314cfee9c4e30a7b17dcd5ebdec081a7"}], "stats": {"total": 56, "additions": 35, "deletions": 21}, "files": [{"sha": "7c074fb18a6f16b62f584de5fcfcab6df0caf159", "filename": "Cargo.lock", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "patch": "@@ -3120,7 +3120,6 @@ dependencies = [\n  \"graphviz\",\n  \"jobserver\",\n  \"log\",\n- \"measureme\",\n  \"num_cpus\",\n  \"parking_lot 0.9.0\",\n  \"polonius-engine\",\n@@ -3470,6 +3469,7 @@ dependencies = [\n name = \"rustc_data_structures\"\n version = \"0.0.0\"\n dependencies = [\n+ \"bitflags\",\n  \"cfg-if\",\n  \"crossbeam-utils 0.6.5\",\n  \"ena\",\n@@ -3478,6 +3478,7 @@ dependencies = [\n  \"jobserver\",\n  \"lazy_static 1.3.0\",\n  \"log\",\n+ \"measureme\",\n  \"parking_lot 0.9.0\",\n  \"rustc-hash\",\n  \"rustc-rayon 0.3.0\","}, {"sha": "bcbe765b85073cef280a035248e9939cc341a7dd", "filename": "src/librustc/Cargo.toml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2FCargo.toml?ref=f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "patch": "@@ -40,4 +40,3 @@ byteorder = { version = \"1.3\" }\n chalk-engine = { version = \"0.9.0\", default-features=false }\n rustc_fs_util = { path = \"../librustc_fs_util\" }\n smallvec = { version = \"1.0\", features = [\"union\", \"may_dangle\"] }\n-measureme = \"0.4\""}, {"sha": "1fd5bcb4915b8e62f4cc1717be258fac1af5e275", "filename": "src/librustc/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flib.rs?ref=f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "patch": "@@ -126,7 +126,6 @@ pub mod util {\n     pub mod captures;\n     pub mod common;\n     pub mod nodemap;\n-    pub mod profiling;\n     pub mod bug;\n }\n "}, {"sha": "bba377392b43306eaa3d2406114c1d28d4553d7b", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "patch": "@@ -29,11 +29,11 @@ use syntax::source_map;\n use syntax::sess::{ParseSess, ProcessCfgMod};\n use syntax::symbol::Symbol;\n use syntax_pos::{MultiSpan, Span};\n-use crate::util::profiling::{SelfProfiler, SelfProfilerRef};\n \n use rustc_target::spec::{PanicStrategy, RelroLevel, Target, TargetTriple};\n use rustc_data_structures::flock;\n use rustc_data_structures::jobserver;\n+use rustc_data_structures::profiling::{SelfProfiler, SelfProfilerRef};\n use ::jobserver::Client;\n \n use std;"}, {"sha": "2ba670f509f80d75c78762e5ec395a552487cdba", "filename": "src/librustc/ty/context.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fcontext.rs?ref=f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "patch": "@@ -46,11 +46,11 @@ use crate::ty::CanonicalPolyFnSig;\n use crate::util::common::ErrorReported;\n use crate::util::nodemap::{DefIdMap, DefIdSet, ItemLocalMap, ItemLocalSet, NodeMap};\n use crate::util::nodemap::{FxHashMap, FxHashSet};\n-use crate::util::profiling::SelfProfilerRef;\n \n use errors::DiagnosticBuilder;\n use arena::SyncDroplessArena;\n use smallvec::SmallVec;\n+use rustc_data_structures::profiling::SelfProfilerRef;\n use rustc_data_structures::stable_hasher::{\n     HashStable, StableHasher, StableVec, hash_stable_hashmap,\n };"}, {"sha": "7e126459dcc731aa8d8d690d6d30158edc68735b", "filename": "src/librustc/ty/query/config.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2Fty%2Fquery%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2Fty%2Fquery%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fquery%2Fconfig.rs?ref=f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "patch": "@@ -6,7 +6,7 @@ use crate::ty::query::queries;\n use crate::ty::query::{Query, QueryName};\n use crate::ty::query::QueryCache;\n use crate::ty::query::plumbing::CycleError;\n-use crate::util::profiling::ProfileCategory;\n+use rustc_data_structures::profiling::ProfileCategory;\n \n use std::borrow::Cow;\n use std::hash::Hash;"}, {"sha": "a1eb1c43335b1caac4c3f31a4bde61f0ed77147d", "filename": "src/librustc/ty/query/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2Fty%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2Fty%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fquery%2Fmod.rs?ref=f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "patch": "@@ -39,7 +39,7 @@ use crate::ty::util::NeedsDrop;\n use crate::ty::subst::SubstsRef;\n use crate::util::nodemap::{DefIdSet, DefIdMap};\n use crate::util::common::ErrorReported;\n-use crate::util::profiling::ProfileCategory::*;\n+use rustc_data_structures::profiling::ProfileCategory::*;\n \n use rustc_data_structures::svh::Svh;\n use rustc_index::vec::IndexVec;"}, {"sha": "0f77a637b4d03253ed803e311ecea9d18810c240", "filename": "src/librustc/ty/query/plumbing.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2Fty%2Fquery%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc%2Fty%2Fquery%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fquery%2Fplumbing.rs?ref=f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "patch": "@@ -672,7 +672,7 @@ macro_rules! define_queries_inner {\n             rustc_data_structures::stable_hasher::StableHasher,\n             ich::StableHashingContext\n         };\n-        use crate::util::profiling::ProfileCategory;\n+        use rustc_data_structures::profiling::ProfileCategory;\n \n         define_queries_struct! {\n             tcx: $tcx,\n@@ -816,8 +816,18 @@ macro_rules! define_queries_inner {\n             $($name),*\n         }\n \n+        impl rustc_data_structures::profiling::QueryName for QueryName {\n+            fn discriminant(self) -> std::mem::Discriminant<QueryName> {\n+                std::mem::discriminant(&self)\n+            }\n+\n+            fn as_str(self) -> &'static str {\n+                QueryName::as_str(&self)\n+            }\n+        }\n+\n         impl QueryName {\n-            pub fn register_with_profiler(profiler: &crate::util::profiling::SelfProfiler) {\n+            pub fn register_with_profiler(profiler: &rustc_data_structures::profiling::SelfProfiler) {\n                 $(profiler.register_query_name(QueryName::$name);)*\n             }\n "}, {"sha": "ed901fa064a4e3e7064fabb5908cff5240afeb83", "filename": "src/librustc_codegen_ssa/back/write.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs?ref=f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "patch": "@@ -19,7 +19,7 @@ use rustc::util::nodemap::FxHashMap;\n use rustc::hir::def_id::{CrateNum, LOCAL_CRATE};\n use rustc::ty::TyCtxt;\n use rustc::util::common::{time_depth, set_time_depth, print_time_passes_entry};\n-use rustc::util::profiling::SelfProfilerRef;\n+use rustc_data_structures::profiling::SelfProfilerRef;\n use rustc_fs_util::link_or_copy;\n use rustc_data_structures::svh::Svh;\n use rustc_data_structures::sync::Lrc;"}, {"sha": "0fd47115022c2ce63d74f0cf6df7c1d076bdfdb4", "filename": "src/librustc_data_structures/Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc_data_structures%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc_data_structures%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2FCargo.toml?ref=f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "patch": "@@ -25,6 +25,8 @@ rayon-core = { version = \"0.3.0\", package = \"rustc-rayon-core\" }\n rustc-hash = \"1.0.1\"\n smallvec = { version = \"1.0\", features = [\"union\", \"may_dangle\"] }\n rustc_index = { path = \"../librustc_index\", package = \"rustc_index\" }\n+bitflags = \"1.2.1\"\n+measureme = \"0.4\"\n \n [dependencies.parking_lot]\n version = \"0.9\""}, {"sha": "fb541637e5f79da6c267ea39fc4b67493ee26e3c", "filename": "src/librustc_data_structures/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc_data_structures%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc_data_structures%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Flib.rs?ref=f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "patch": "@@ -94,6 +94,7 @@ pub use ena::unify;\n pub mod vec_linked_list;\n pub mod work_queue;\n pub mod fingerprint;\n+pub mod profiling;\n \n pub struct OnDrop<F: Fn()>(pub F);\n "}, {"sha": "b89170cccdb70a38afc9b0b03b78f5b4516c096a", "filename": "src/librustc_data_structures/profiling.rs", "status": "renamed", "additions": 13, "deletions": 11, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc_data_structures%2Fprofiling.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f696b21c5f1017ebb451d1e9d2d8fe261b26507f/src%2Flibrustc_data_structures%2Fprofiling.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Fprofiling.rs?ref=f696b21c5f1017ebb451d1e9d2d8fe261b26507f", "patch": "@@ -7,8 +7,6 @@ use std::sync::Arc;\n use std::thread::ThreadId;\n use std::u32;\n \n-use crate::ty::query::QueryName;\n-\n use measureme::{StringId, TimestampKind};\n \n /// MmapSerializatioSink is faster on macOS and Linux\n@@ -20,6 +18,10 @@ type SerializationSink = measureme::FileSerializationSink;\n \n type Profiler = measureme::Profiler<SerializationSink>;\n \n+pub trait QueryName: Sized + Copy {\n+    fn discriminant(self) -> Discriminant<Self>;\n+    fn as_str(self) -> &'static str;\n+}\n \n #[derive(Clone, Copy, Debug, PartialEq, Eq, Ord, PartialOrd)]\n pub enum ProfileCategory {\n@@ -32,7 +34,7 @@ pub enum ProfileCategory {\n     Other,\n }\n \n-bitflags! {\n+bitflags::bitflags! {\n     struct EventFilter: u32 {\n         const GENERIC_ACTIVITIES = 1 << 0;\n         const QUERY_PROVIDERS    = 1 << 1;\n@@ -137,7 +139,7 @@ impl SelfProfilerRef {\n     /// Start profiling a query provider. Profiling continues until the\n     /// TimingGuard returned from this call is dropped.\n     #[inline(always)]\n-    pub fn query_provider(&self, query_name: QueryName) -> TimingGuard<'_> {\n+    pub fn query_provider(&self, query_name: impl QueryName) -> TimingGuard<'_> {\n         self.exec(EventFilter::QUERY_PROVIDERS, |profiler| {\n             let event_id = SelfProfiler::get_query_name_string_id(query_name);\n             TimingGuard::start(profiler, profiler.query_event_kind, event_id)\n@@ -146,7 +148,7 @@ impl SelfProfilerRef {\n \n     /// Record a query in-memory cache hit.\n     #[inline(always)]\n-    pub fn query_cache_hit(&self, query_name: QueryName) {\n+    pub fn query_cache_hit(&self, query_name: impl QueryName) {\n         self.non_guard_query_event(\n             |profiler| profiler.query_cache_hit_event_kind,\n             query_name,\n@@ -159,7 +161,7 @@ impl SelfProfilerRef {\n     /// Profiling continues until the TimingGuard returned from this call is\n     /// dropped.\n     #[inline(always)]\n-    pub fn query_blocked(&self, query_name: QueryName) -> TimingGuard<'_> {\n+    pub fn query_blocked(&self, query_name: impl QueryName) -> TimingGuard<'_> {\n         self.exec(EventFilter::QUERY_BLOCKED, |profiler| {\n             let event_id = SelfProfiler::get_query_name_string_id(query_name);\n             TimingGuard::start(profiler, profiler.query_blocked_event_kind, event_id)\n@@ -170,7 +172,7 @@ impl SelfProfilerRef {\n     /// incremental compilation on-disk cache. Profiling continues until the\n     /// TimingGuard returned from this call is dropped.\n     #[inline(always)]\n-    pub fn incr_cache_loading(&self, query_name: QueryName) -> TimingGuard<'_> {\n+    pub fn incr_cache_loading(&self, query_name: impl QueryName) -> TimingGuard<'_> {\n         self.exec(EventFilter::INCR_CACHE_LOADS, |profiler| {\n             let event_id = SelfProfiler::get_query_name_string_id(query_name);\n             TimingGuard::start(\n@@ -185,7 +187,7 @@ impl SelfProfilerRef {\n     fn non_guard_query_event(\n         &self,\n         event_kind: fn(&SelfProfiler) -> StringId,\n-        query_name: QueryName,\n+        query_name: impl QueryName,\n         event_filter: EventFilter,\n         timestamp_kind: TimestampKind\n     ) {\n@@ -274,15 +276,15 @@ impl SelfProfiler {\n         })\n     }\n \n-    fn get_query_name_string_id(query_name: QueryName) -> StringId {\n+    fn get_query_name_string_id(query_name: impl QueryName) -> StringId {\n         let discriminant = unsafe {\n-            mem::transmute::<Discriminant<QueryName>, u64>(mem::discriminant(&query_name))\n+            mem::transmute::<Discriminant<_>, u64>(query_name.discriminant())\n         };\n \n         StringId::reserved(discriminant as u32)\n     }\n \n-    pub fn register_query_name(&self, query_name: QueryName) {\n+    pub fn register_query_name(&self, query_name: impl QueryName) {\n         let id = SelfProfiler::get_query_name_string_id(query_name);\n         self.profiler.alloc_string_with_reserved_id(id, query_name.as_str());\n     }", "previous_filename": "src/librustc/util/profiling.rs"}]}