{"sha": "ed5e5df596aff90b4147869e3464330f7833f81e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVkNWU1ZGY1OTZhZmY5MGI0MTQ3ODY5ZTM0NjQzMzBmNzgzM2Y4MWU=", "commit": {"author": {"name": "Federico Ravasio", "email": "ravasio.federico@gmail.com", "date": "2016-09-02T09:44:46Z"}, "committer": {"name": "Federico Ravasio", "email": "ravasio.federico@gmail.com", "date": "2016-09-02T09:44:46Z"}, "message": "E0493: showing a label where the destructor is defined.", "tree": {"sha": "115ace90f0c553a8f432e77909544ba76dbc0319", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/115ace90f0c553a8f432e77909544ba76dbc0319"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ed5e5df596aff90b4147869e3464330f7833f81e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ed5e5df596aff90b4147869e3464330f7833f81e", "html_url": "https://github.com/rust-lang/rust/commit/ed5e5df596aff90b4147869e3464330f7833f81e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ed5e5df596aff90b4147869e3464330f7833f81e/comments", "author": {"login": "razielgn", "id": 237493, "node_id": "MDQ6VXNlcjIzNzQ5Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/237493?v=4", "gravatar_id": "", "url": "https://api.github.com/users/razielgn", "html_url": "https://github.com/razielgn", "followers_url": "https://api.github.com/users/razielgn/followers", "following_url": "https://api.github.com/users/razielgn/following{/other_user}", "gists_url": "https://api.github.com/users/razielgn/gists{/gist_id}", "starred_url": "https://api.github.com/users/razielgn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/razielgn/subscriptions", "organizations_url": "https://api.github.com/users/razielgn/orgs", "repos_url": "https://api.github.com/users/razielgn/repos", "events_url": "https://api.github.com/users/razielgn/events{/privacy}", "received_events_url": "https://api.github.com/users/razielgn/received_events", "type": "User", "site_admin": false}, "committer": {"login": "razielgn", "id": 237493, "node_id": "MDQ6VXNlcjIzNzQ5Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/237493?v=4", "gravatar_id": "", "url": "https://api.github.com/users/razielgn", "html_url": "https://github.com/razielgn", "followers_url": "https://api.github.com/users/razielgn/followers", "following_url": "https://api.github.com/users/razielgn/following{/other_user}", "gists_url": "https://api.github.com/users/razielgn/gists{/gist_id}", "starred_url": "https://api.github.com/users/razielgn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/razielgn/subscriptions", "organizations_url": "https://api.github.com/users/razielgn/orgs", "repos_url": "https://api.github.com/users/razielgn/repos", "events_url": "https://api.github.com/users/razielgn/events{/privacy}", "received_events_url": "https://api.github.com/users/razielgn/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "638b7c89e6c3de5c21cf10ea28b8b8ea259b5f27", "url": "https://api.github.com/repos/rust-lang/rust/commits/638b7c89e6c3de5c21cf10ea28b8b8ea259b5f27", "html_url": "https://github.com/rust-lang/rust/commit/638b7c89e6c3de5c21cf10ea28b8b8ea259b5f27"}], "stats": {"total": 38, "additions": 38, "deletions": 0}, "files": [{"sha": "14a432cbb895b3054fc01fa9efa3eb1d95f6437e", "filename": "src/librustc_mir/transform/qualify_consts.rs", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/ed5e5df596aff90b4147869e3464330f7833f81e/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed5e5df596aff90b4147869e3464330f7833f81e/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs?ref=ed5e5df596aff90b4147869e3464330f7833f81e", "patch": "@@ -18,6 +18,7 @@ use rustc_data_structures::bitvec::BitVector;\n use rustc_data_structures::indexed_vec::{IndexVec, Idx};\n use rustc::dep_graph::DepNode;\n use rustc::hir;\n+use rustc::hir::map as hir_map;\n use rustc::hir::def_id::DefId;\n use rustc::hir::intravisit::FnKind;\n use rustc::hir::map::blocks::FnLikeNode;\n@@ -258,12 +259,40 @@ impl<'a, 'tcx> Qualifier<'a, 'tcx, 'tcx> {\n                   \"in Nightly builds, add `#![feature(drop_types_in_const)]` \\\n                    to the crate attributes to enable\");\n         } else {\n+            self.find_drop_implementation_method_span()\n+                .map(|span| err.span_label(span, &format!(\"destructor defined here\")));\n+\n             err.span_label(self.span, &format!(\"constants cannot have destructors\"));\n         }\n \n         err.emit();\n     }\n \n+    fn find_drop_implementation_method_span(&self) -> Option<Span> {\n+        self.tcx.lang_items\n+            .drop_trait()\n+            .and_then(|drop_trait_id| {\n+                let mut span = None;\n+\n+                self.tcx\n+                    .lookup_trait_def(drop_trait_id)\n+                    .for_each_relevant_impl(self.tcx, self.mir.return_ty, |impl_did| {\n+                        self.tcx.map\n+                            .as_local_node_id(impl_did)\n+                            .and_then(|impl_node_id| self.tcx.map.find(impl_node_id))\n+                            .map(|node| {\n+                                if let hir_map::NodeItem(item) = node {\n+                                    if let hir::ItemImpl(_, _, _, _, _, ref methods) = item.node {\n+                                        span = methods.first().map(|method| method.span);\n+                                    }\n+                                }\n+                            });\n+                    });\n+\n+                span\n+            })\n+    }\n+\n     /// Check if an Lvalue with the current qualifications could\n     /// be consumed, by either an operand or a Deref projection.\n     fn try_consume(&mut self) -> bool {"}, {"sha": "e06da5ca7c55c448684a40f2eb0e0c087dcba548", "filename": "src/test/compile-fail/E0493.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ed5e5df596aff90b4147869e3464330f7833f81e/src%2Ftest%2Fcompile-fail%2FE0493.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed5e5df596aff90b4147869e3464330f7833f81e/src%2Ftest%2Fcompile-fail%2FE0493.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2FE0493.rs?ref=ed5e5df596aff90b4147869e3464330f7833f81e", "patch": "@@ -14,6 +14,15 @@ struct Foo {\n \n impl Drop for Foo {\n     fn drop(&mut self) {}\n+    //~^ NOTE destructor defined here\n+}\n+\n+struct Bar {\n+    a: u32\n+}\n+\n+impl Drop for Bar {\n+    fn drop(&mut self) {}\n }\n \n const F : Foo = Foo { a : 0 };"}]}