{"sha": "24d241a8845fa29b8115ba9b5340cb05c9759371", "node_id": "C_kwDOAAsO6NoAKDI0ZDI0MWE4ODQ1ZmEyOWI4MTE1YmE5YjUzNDBjYjA1Yzk3NTkzNzE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-07-11T20:39:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-11T20:39:07Z"}, "message": "Rollup merge of #99142 - notriddle:notriddle/doctest-multiline-crate-attributes, r=GuillaumeGomez\n\nfix(doctest): treat fatal parse errors as incomplete attributes\n\nFixes #99089", "tree": {"sha": "b90e2e822ac9d913112e81066c71fefeb03d5043", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b90e2e822ac9d913112e81066c71fefeb03d5043"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/24d241a8845fa29b8115ba9b5340cb05c9759371", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJizIpsCRBK7hj4Ov3rIwAAnOEIAHSlAfFzqn0NQvNRQe3QpvII\nOHTpxr/kqgAQvg6AI8a1qjvw9uYJZ/4Q1ztVT5wseAGcWvibaEC5bgr0yXLmm18y\nZzE6ZtStEvokXaIROJXw6+XZ1hU2fTD2HHjlYqBv9b9mG8eVWC1YSMJszgmFFmly\n8S1MMeZBGJXnPU72EJZtpQPv41ojT3bzvhyy6RRbVw31n26YABgHjEitvdbEU2GM\nPJI1eo1EncH94pmIGNcaLT5/PZqgsl/YXlcSImDvGUB0z4L9nI9LJcv4waEP6rum\nyZCLzGXf5uaK3rQaIDWIQtsB2ubxfc11aM0qH0bjHYtaxZxHiHZ7yQ5SPDuFVwk=\n=rRxa\n-----END PGP SIGNATURE-----\n", "payload": "tree b90e2e822ac9d913112e81066c71fefeb03d5043\nparent 7151aaf94004915a50a70eaecfe76e4b0a33bade\nparent 6c44357e14465443acc3be46560271c3c8f656fe\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1657571947 +0200\ncommitter GitHub <noreply@github.com> 1657571947 +0200\n\nRollup merge of #99142 - notriddle:notriddle/doctest-multiline-crate-attributes, r=GuillaumeGomez\n\nfix(doctest): treat fatal parse errors as incomplete attributes\n\nFixes #99089\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/24d241a8845fa29b8115ba9b5340cb05c9759371", "html_url": "https://github.com/rust-lang/rust/commit/24d241a8845fa29b8115ba9b5340cb05c9759371", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/24d241a8845fa29b8115ba9b5340cb05c9759371/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7151aaf94004915a50a70eaecfe76e4b0a33bade", "url": "https://api.github.com/repos/rust-lang/rust/commits/7151aaf94004915a50a70eaecfe76e4b0a33bade", "html_url": "https://github.com/rust-lang/rust/commit/7151aaf94004915a50a70eaecfe76e4b0a33bade"}, {"sha": "6c44357e14465443acc3be46560271c3c8f656fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/6c44357e14465443acc3be46560271c3c8f656fe", "html_url": "https://github.com/rust-lang/rust/commit/6c44357e14465443acc3be46560271c3c8f656fe"}], "stats": {"total": 89, "additions": 66, "deletions": 23}, "files": [{"sha": "39ec6a6085640509a9b4895153bad362bcd5edd9", "filename": "src/librustdoc/doctest.rs", "status": "modified", "additions": 50, "deletions": 23, "changes": 73, "blob_url": "https://github.com/rust-lang/rust/blob/24d241a8845fa29b8115ba9b5340cb05c9759371/src%2Flibrustdoc%2Fdoctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24d241a8845fa29b8115ba9b5340cb05c9759371/src%2Flibrustdoc%2Fdoctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fdoctest.rs?ref=24d241a8845fa29b8115ba9b5340cb05c9759371", "patch": "@@ -726,31 +726,58 @@ fn check_if_attr_is_complete(source: &str, edition: Edition) -> bool {\n         // Empty content so nothing to check in here...\n         return true;\n     }\n-    rustc_span::create_session_if_not_set_then(edition, |_| {\n-        let filename = FileName::anon_source_code(source);\n-        let sess = ParseSess::with_silent_emitter(None);\n-        let mut parser = match maybe_new_parser_from_source_str(&sess, filename, source.to_owned())\n-        {\n-            Ok(p) => p,\n-            Err(_) => {\n-                debug!(\"Cannot build a parser to check mod attr so skipping...\");\n-                return true;\n+    rustc_driver::catch_fatal_errors(|| {\n+        rustc_span::create_session_if_not_set_then(edition, |_| {\n+            use rustc_errors::emitter::EmitterWriter;\n+            use rustc_errors::Handler;\n+            use rustc_span::source_map::FilePathMapping;\n+\n+            let filename = FileName::anon_source_code(source);\n+            // Any errors in parsing should also appear when the doctest is compiled for real, so just\n+            // send all the errors that librustc_ast emits directly into a `Sink` instead of stderr.\n+            let sm = Lrc::new(SourceMap::new(FilePathMapping::empty()));\n+            let fallback_bundle =\n+                rustc_errors::fallback_fluent_bundle(rustc_errors::DEFAULT_LOCALE_RESOURCES, false);\n+\n+            let emitter = EmitterWriter::new(\n+                box io::sink(),\n+                None,\n+                None,\n+                fallback_bundle,\n+                false,\n+                false,\n+                false,\n+                None,\n+                false,\n+            );\n+\n+            let handler = Handler::with_emitter(false, None, box emitter);\n+            let sess = ParseSess::with_span_handler(handler, sm);\n+            let mut parser =\n+                match maybe_new_parser_from_source_str(&sess, filename, source.to_owned()) {\n+                    Ok(p) => p,\n+                    Err(_) => {\n+                        debug!(\"Cannot build a parser to check mod attr so skipping...\");\n+                        return true;\n+                    }\n+                };\n+            // If a parsing error happened, it's very likely that the attribute is incomplete.\n+            if let Err(e) = parser.parse_attribute(InnerAttrPolicy::Permitted) {\n+                e.cancel();\n+                return false;\n             }\n-        };\n-        // If a parsing error happened, it's very likely that the attribute is incomplete.\n-        if parser.parse_attribute(InnerAttrPolicy::Permitted).is_err() {\n-            return false;\n-        }\n-        // We now check if there is an unclosed delimiter for the attribute. To do so, we look at\n-        // the `unclosed_delims` and see if the opening square bracket was closed.\n-        parser\n-            .unclosed_delims()\n-            .get(0)\n-            .map(|unclosed| {\n-                unclosed.unclosed_span.map(|s| s.lo()).unwrap_or(BytePos(0)) != BytePos(2)\n-            })\n-            .unwrap_or(true)\n+            // We now check if there is an unclosed delimiter for the attribute. To do so, we look at\n+            // the `unclosed_delims` and see if the opening square bracket was closed.\n+            parser\n+                .unclosed_delims()\n+                .get(0)\n+                .map(|unclosed| {\n+                    unclosed.unclosed_span.map(|s| s.lo()).unwrap_or(BytePos(0)) != BytePos(2)\n+                })\n+                .unwrap_or(true)\n+        })\n     })\n+    .unwrap_or(false)\n }\n \n fn partition_source(s: &str, edition: Edition) -> (String, String, String) {"}, {"sha": "a30472ac56b24aa1e59edc438fe5ff6be8578a14", "filename": "src/test/rustdoc-ui/doctest-multiline-crate-attribute.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/24d241a8845fa29b8115ba9b5340cb05c9759371/src%2Ftest%2Frustdoc-ui%2Fdoctest-multiline-crate-attribute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24d241a8845fa29b8115ba9b5340cb05c9759371/src%2Ftest%2Frustdoc-ui%2Fdoctest-multiline-crate-attribute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fdoctest-multiline-crate-attribute.rs?ref=24d241a8845fa29b8115ba9b5340cb05c9759371", "patch": "@@ -0,0 +1,10 @@\n+// compile-flags:--test --test-args=--test-threads=1\n+// normalize-stdout-test: \"src/test/rustdoc-ui\" -> \"$$DIR\"\n+// normalize-stdout-test \"finished in \\d+\\.\\d+s\" -> \"finished in $$TIME\"\n+// check-pass\n+\n+/// ```\n+/// #![deprecated(since = \"5.2\", note = \"foo was rarely used. \\\n+///    Users should instead use bar\")]\n+/// ```\n+pub fn f() {}"}, {"sha": "07a4f657dea6a15405d7ad22a0b570f1d20814f9", "filename": "src/test/rustdoc-ui/doctest-multiline-crate-attribute.stdout", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/24d241a8845fa29b8115ba9b5340cb05c9759371/src%2Ftest%2Frustdoc-ui%2Fdoctest-multiline-crate-attribute.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/24d241a8845fa29b8115ba9b5340cb05c9759371/src%2Ftest%2Frustdoc-ui%2Fdoctest-multiline-crate-attribute.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fdoctest-multiline-crate-attribute.stdout?ref=24d241a8845fa29b8115ba9b5340cb05c9759371", "patch": "@@ -0,0 +1,6 @@\n+\n+running 1 test\n+test $DIR/doctest-multiline-crate-attribute.rs - f (line 6) ... ok\n+\n+test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in $TIME\n+"}]}