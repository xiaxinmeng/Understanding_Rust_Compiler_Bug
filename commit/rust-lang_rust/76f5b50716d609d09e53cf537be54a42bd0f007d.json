{"sha": "76f5b50716d609d09e53cf537be54a42bd0f007d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc2ZjViNTA3MTZkNjA5ZDA5ZTUzY2Y1MzdiZTU0YTQyYmQwZjAwN2Q=", "commit": {"author": {"name": "varkor", "email": "github@varkor.com", "date": "2019-06-29T15:23:15Z"}, "committer": {"name": "varkor", "email": "github@varkor.com", "date": "2019-06-30T17:20:49Z"}, "message": "Extend #[must_use] lint to arrays", "tree": {"sha": "f1b451617644d1ed7eb2444d092fb56638057bc5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f1b451617644d1ed7eb2444d092fb56638057bc5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/76f5b50716d609d09e53cf537be54a42bd0f007d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/76f5b50716d609d09e53cf537be54a42bd0f007d", "html_url": "https://github.com/rust-lang/rust/commit/76f5b50716d609d09e53cf537be54a42bd0f007d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/76f5b50716d609d09e53cf537be54a42bd0f007d/comments", "author": {"login": "varkor", "id": 3943692, "node_id": "MDQ6VXNlcjM5NDM2OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/3943692?v=4", "gravatar_id": "", "url": "https://api.github.com/users/varkor", "html_url": "https://github.com/varkor", "followers_url": "https://api.github.com/users/varkor/followers", "following_url": "https://api.github.com/users/varkor/following{/other_user}", "gists_url": "https://api.github.com/users/varkor/gists{/gist_id}", "starred_url": "https://api.github.com/users/varkor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/varkor/subscriptions", "organizations_url": "https://api.github.com/users/varkor/orgs", "repos_url": "https://api.github.com/users/varkor/repos", "events_url": "https://api.github.com/users/varkor/events{/privacy}", "received_events_url": "https://api.github.com/users/varkor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "varkor", "id": 3943692, "node_id": "MDQ6VXNlcjM5NDM2OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/3943692?v=4", "gravatar_id": "", "url": "https://api.github.com/users/varkor", "html_url": "https://github.com/varkor", "followers_url": "https://api.github.com/users/varkor/followers", "following_url": "https://api.github.com/users/varkor/following{/other_user}", "gists_url": "https://api.github.com/users/varkor/gists{/gist_id}", "starred_url": "https://api.github.com/users/varkor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/varkor/subscriptions", "organizations_url": "https://api.github.com/users/varkor/orgs", "repos_url": "https://api.github.com/users/varkor/repos", "events_url": "https://api.github.com/users/varkor/events{/privacy}", "received_events_url": "https://api.github.com/users/varkor/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "400fd6055fea43ccd89769a4ddb85586c70bf8ae", "url": "https://api.github.com/repos/rust-lang/rust/commits/400fd6055fea43ccd89769a4ddb85586c70bf8ae", "html_url": "https://github.com/rust-lang/rust/commit/400fd6055fea43ccd89769a4ddb85586c70bf8ae"}], "stats": {"total": 139, "additions": 127, "deletions": 12}, "files": [{"sha": "2db2e0bc0da96b5b0100e41ce5526556bdfd455f", "filename": "src/librustc_lint/unused.rs", "status": "modified", "additions": 36, "deletions": 12, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/76f5b50716d609d09e53cf537be54a42bd0f007d/src%2Flibrustc_lint%2Funused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/76f5b50716d609d09e53cf537be54a42bd0f007d/src%2Flibrustc_lint%2Funused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Funused.rs?ref=76f5b50716d609d09e53cf537be54a42bd0f007d", "patch": "@@ -48,7 +48,7 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for UnusedResults {\n         }\n \n         let ty = cx.tables.expr_ty(&expr);\n-        let type_permits_lack_of_use = check_must_use_ty(cx, ty, &expr, s.span, \"\", \"\");\n+        let type_permits_lack_of_use = check_must_use_ty(cx, ty, &expr, s.span, \"\", \"\", false);\n \n         let mut fn_warned = false;\n         let mut op_warned = false;\n@@ -133,32 +133,39 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for UnusedResults {\n             ty: Ty<'tcx>,\n             expr: &hir::Expr,\n             span: Span,\n-            descr_pre_path: &str,\n-            descr_post_path: &str,\n+            descr_pre: &str,\n+            descr_post: &str,\n+            plural: bool,\n         ) -> bool {\n             if ty.is_unit() || cx.tcx.is_ty_uninhabited_from(\n                 cx.tcx.hir().get_module_parent(expr.hir_id), ty)\n             {\n                 return true;\n             }\n \n+            let plural_suffix = if plural { \"s\" } else { \"\" };\n+\n             match ty.sty {\n                 ty::Adt(..) if ty.is_box() => {\n                     let boxed_ty = ty.boxed_ty();\n-                    let descr_pre_path = &format!(\"{}boxed \", descr_pre_path);\n-                    check_must_use_ty(cx, boxed_ty, expr, span, descr_pre_path, descr_post_path)\n+                    let descr_pre = &format!(\"{}boxed \", descr_pre);\n+                    check_must_use_ty(cx, boxed_ty, expr, span, descr_pre, descr_post, plural)\n                 }\n                 ty::Adt(def, _) => {\n-                    check_must_use_def(cx, def.did, span, descr_pre_path, descr_post_path)\n+                    check_must_use_def(cx, def.did, span, descr_pre, descr_post)\n                 }\n                 ty::Opaque(def, _) => {\n                     let mut has_emitted = false;\n                     for (predicate, _) in &cx.tcx.predicates_of(def).predicates {\n                         if let ty::Predicate::Trait(ref poly_trait_predicate) = predicate {\n                             let trait_ref = poly_trait_predicate.skip_binder().trait_ref;\n                             let def_id = trait_ref.def_id;\n-                            let descr_pre = &format!(\"{}implementer of \", descr_pre_path);\n-                            if check_must_use_def(cx, def_id, span, descr_pre, descr_post_path) {\n+                            let descr_pre = &format!(\n+                                \"{}implementer{} of \",\n+                                descr_pre,\n+                                plural_suffix,\n+                            );\n+                            if check_must_use_def(cx, def_id, span, descr_pre, descr_post) {\n                                 has_emitted = true;\n                                 break;\n                             }\n@@ -171,8 +178,12 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for UnusedResults {\n                     for predicate in binder.skip_binder().iter() {\n                         if let ty::ExistentialPredicate::Trait(ref trait_ref) = predicate {\n                             let def_id = trait_ref.def_id;\n-                            let descr_post = &format!(\" trait object{}\", descr_post_path);\n-                            if check_must_use_def(cx, def_id, span, descr_pre_path, descr_post) {\n+                            let descr_post = &format!(\n+                                \" trait object{}{}\",\n+                                plural_suffix,\n+                                descr_post,\n+                            );\n+                            if check_must_use_def(cx, def_id, span, descr_pre, descr_post) {\n                                 has_emitted = true;\n                                 break;\n                             }\n@@ -189,14 +200,27 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for UnusedResults {\n                         vec![]\n                     };\n                     for (i, ty) in tys.iter().map(|k| k.expect_ty()).enumerate() {\n-                        let descr_post_path = &format!(\" in tuple element {}\", i);\n+                        let descr_post = &format!(\" in tuple element {}\", i);\n                         let span = *spans.get(i).unwrap_or(&span);\n-                        if check_must_use_ty(cx, ty, expr, span, descr_pre_path, descr_post_path) {\n+                        if check_must_use_ty(cx, ty, expr, span, descr_pre, descr_post, plural) {\n                             has_emitted = true;\n                         }\n                     }\n                     has_emitted\n                 }\n+                ty::Array(ty, len) => match len.assert_usize(cx.tcx) {\n+                    // If the array is definitely non-empty, we can do `#[must_use]` checking.\n+                    Some(n) if n != 0 => {\n+                        let descr_pre = &format!(\n+                            \"{}array{} of \",\n+                            descr_pre,\n+                            plural_suffix,\n+                        );\n+                        check_must_use_ty(cx, ty, expr, span, descr_pre, descr_post, true)\n+                    }\n+                    // Otherwise, we don't lint, to avoid false positives.\n+                    _ => false,\n+                }\n                 _ => false,\n             }\n         }"}, {"sha": "97825dd2f6c43d5c17993bcbbf8083557ccc6f7c", "filename": "src/test/ui/lint/must_use-array.rs", "status": "added", "additions": 47, "deletions": 0, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/76f5b50716d609d09e53cf537be54a42bd0f007d/src%2Ftest%2Fui%2Flint%2Fmust_use-array.rs", "raw_url": "https://github.com/rust-lang/rust/raw/76f5b50716d609d09e53cf537be54a42bd0f007d/src%2Ftest%2Fui%2Flint%2Fmust_use-array.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_use-array.rs?ref=76f5b50716d609d09e53cf537be54a42bd0f007d", "patch": "@@ -0,0 +1,47 @@\n+#![deny(unused_must_use)]\n+\n+#[must_use]\n+struct S;\n+\n+struct A;\n+\n+#[must_use]\n+trait T {}\n+\n+impl T for A {}\n+\n+fn empty() -> [S; 0] {\n+    []\n+}\n+\n+fn singleton() -> [S; 1] {\n+    [S]\n+}\n+\n+fn many() -> [S; 4] {\n+    [S, S, S, S]\n+}\n+\n+fn array_of_impl_trait() -> [impl T; 2] {\n+    [A, A]\n+}\n+\n+fn impl_array() -> [(u8, Box<dyn T>); 2] {\n+    [(0, Box::new(A)), (0, Box::new(A))]\n+}\n+\n+fn array_of_arrays_of_arrays() -> [[[S; 1]; 2]; 1] {\n+    [[[S], [S]]]\n+}\n+\n+fn main() {\n+    empty(); // ok\n+    singleton(); //~ ERROR unused array of `S` that must be used\n+    many(); //~ ERROR unused array of `S` that must be used\n+    ([S], 0, ()); //~ ERROR unused array of `S` in tuple element 0 that must be used\n+    array_of_impl_trait(); //~ ERROR unused array of implementers of `T` that must be used\n+    impl_array();\n+    //~^ ERROR unused array of boxed `T` trait objects in tuple element 1 that must be used\n+    array_of_arrays_of_arrays();\n+    //~^ ERROR unused array of arrays of arrays of `S` that must be used\n+}"}, {"sha": "a6dbd8e93d4d323f071c51a0d3928c6b10f3a04d", "filename": "src/test/ui/lint/must_use-array.stderr", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/76f5b50716d609d09e53cf537be54a42bd0f007d/src%2Ftest%2Fui%2Flint%2Fmust_use-array.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/76f5b50716d609d09e53cf537be54a42bd0f007d/src%2Ftest%2Fui%2Flint%2Fmust_use-array.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_use-array.stderr?ref=76f5b50716d609d09e53cf537be54a42bd0f007d", "patch": "@@ -0,0 +1,44 @@\n+error: unused array of `S` that must be used\n+  --> $DIR/must_use-array.rs:39:5\n+   |\n+LL |     singleton();\n+   |     ^^^^^^^^^^^^\n+   |\n+note: lint level defined here\n+  --> $DIR/must_use-array.rs:1:9\n+   |\n+LL | #![deny(unused_must_use)]\n+   |         ^^^^^^^^^^^^^^^\n+\n+error: unused array of `S` that must be used\n+  --> $DIR/must_use-array.rs:40:5\n+   |\n+LL |     many();\n+   |     ^^^^^^^\n+\n+error: unused array of `S` in tuple element 0 that must be used\n+  --> $DIR/must_use-array.rs:41:6\n+   |\n+LL |     ([S], 0, ());\n+   |      ^^^\n+\n+error: unused array of implementers of `T` that must be used\n+  --> $DIR/must_use-array.rs:42:5\n+   |\n+LL |     array_of_impl_trait();\n+   |     ^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: unused array of boxed `T` trait objects in tuple element 1 that must be used\n+  --> $DIR/must_use-array.rs:43:5\n+   |\n+LL |     impl_array();\n+   |     ^^^^^^^^^^^^^\n+\n+error: unused array of arrays of arrays of `S` that must be used\n+  --> $DIR/must_use-array.rs:45:5\n+   |\n+LL |     array_of_arrays_of_arrays();\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 6 previous errors\n+"}]}