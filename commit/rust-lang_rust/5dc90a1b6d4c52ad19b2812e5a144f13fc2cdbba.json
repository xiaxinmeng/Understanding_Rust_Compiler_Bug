{"sha": "5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba", "node_id": "C_kwDOAAsO6NoAKDVkYzkwYTFiNmQ0YzUyYWQxOWIyODEyZTVhMTQ0ZjEzZmMyY2RiYmE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-03T07:37:43Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-03T07:37:43Z"}, "message": "Auto merge of #9282 - macovedj:clone-on-copy-try-precedence, r=flip1995\n\nadd paren before '?' when suggesting deref for clone_on_copy\n\nchangelog: none\n\nfixes #9277", "tree": {"sha": "5b9705da257dc7b2035ca0915236e2fc36e5bf20", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5b9705da257dc7b2035ca0915236e2fc36e5bf20"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba", "html_url": "https://github.com/rust-lang/rust/commit/5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "05e7d5481b7d405f0ebb04f3c83fb19618871c19", "url": "https://api.github.com/repos/rust-lang/rust/commits/05e7d5481b7d405f0ebb04f3c83fb19618871c19", "html_url": "https://github.com/rust-lang/rust/commit/05e7d5481b7d405f0ebb04f3c83fb19618871c19"}, {"sha": "503c03c5584bb697071f3585953ed6e5b16d2e10", "url": "https://api.github.com/repos/rust-lang/rust/commits/503c03c5584bb697071f3585953ed6e5b16d2e10", "html_url": "https://github.com/rust-lang/rust/commit/503c03c5584bb697071f3585953ed6e5b16d2e10"}], "stats": {"total": 29, "additions": 25, "deletions": 4}, "files": [{"sha": "60e1355f9b92d889036ae7b2c67e4d510e4305c0", "filename": "clippy_lints/src/methods/clone_on_copy.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba/clippy_lints%2Fsrc%2Fmethods%2Fclone_on_copy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba/clippy_lints%2Fsrc%2Fmethods%2Fclone_on_copy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fclone_on_copy.rs?ref=5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba", "patch": "@@ -4,7 +4,7 @@ use clippy_utils::source::snippet_with_context;\n use clippy_utils::sugg;\n use clippy_utils::ty::is_copy;\n use rustc_errors::Applicability;\n-use rustc_hir::{BindingAnnotation, Expr, ExprKind, MatchSource, Node, PatKind};\n+use rustc_hir::{BindingAnnotation, Expr, ExprKind, MatchSource, Node, PatKind, QPath};\n use rustc_lint::LateContext;\n use rustc_middle::ty::{self, adjustment::Adjust};\n use rustc_span::symbol::{sym, Symbol};\n@@ -86,6 +86,11 @@ pub(super) fn check(cx: &LateContext<'_>, expr: &Expr<'_>, method_name: Symbol,\n                 {\n                     return;\n                 },\n+                // ? is a Call, makes sure not to rec *x?, but rather (*x)?\n+                ExprKind::Call(hir_callee, _) => matches!(\n+                    hir_callee.kind,\n+                    ExprKind::Path(QPath::LangItem(rustc_hir::LangItem::TryTraitBranch, _, _))\n+                ),\n                 ExprKind::MethodCall(_, [self_arg, ..], _) if expr.hir_id == self_arg.hir_id => true,\n                 ExprKind::Match(_, _, MatchSource::TryDesugar | MatchSource::AwaitDesugar)\n                 | ExprKind::Field(..)"}, {"sha": "72b1222709819447cd8a4589f6e9c92a7dbc546a", "filename": "tests/ui/clone_on_copy.fixed", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba/tests%2Fui%2Fclone_on_copy.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba/tests%2Fui%2Fclone_on_copy.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fclone_on_copy.fixed?ref=5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba", "patch": "@@ -21,7 +21,7 @@ fn is_ascii(ch: char) -> bool {\n     ch.is_ascii()\n }\n \n-fn clone_on_copy() {\n+fn clone_on_copy() -> Option<(i32)> {\n     42;\n \n     vec![1].clone(); // ok, not a Copy type\n@@ -71,4 +71,9 @@ fn clone_on_copy() {\n     // Issue #5436\n     let mut vec = Vec::new();\n     vec.push(42);\n+\n+    //  Issue #9277\n+    let opt: &Option<i32> = &None;\n+    let value = (*opt)?; // operator precedence needed (*opt)?\n+    None\n }"}, {"sha": "03e210ebad98c302819ab8b8ed9c5426fa9a6a34", "filename": "tests/ui/clone_on_copy.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba/tests%2Fui%2Fclone_on_copy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba/tests%2Fui%2Fclone_on_copy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fclone_on_copy.rs?ref=5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba", "patch": "@@ -21,7 +21,7 @@ fn is_ascii(ch: char) -> bool {\n     ch.is_ascii()\n }\n \n-fn clone_on_copy() {\n+fn clone_on_copy() -> Option<(i32)> {\n     42.clone();\n \n     vec![1].clone(); // ok, not a Copy type\n@@ -71,4 +71,9 @@ fn clone_on_copy() {\n     // Issue #5436\n     let mut vec = Vec::new();\n     vec.push(42.clone());\n+\n+    //  Issue #9277\n+    let opt: &Option<i32> = &None;\n+    let value = opt.clone()?; // operator precedence needed (*opt)?\n+    None\n }"}, {"sha": "42ae227777c7082a20849bfb489b2332850a6ac9", "filename": "tests/ui/clone_on_copy.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba/tests%2Fui%2Fclone_on_copy.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba/tests%2Fui%2Fclone_on_copy.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fclone_on_copy.stderr?ref=5dc90a1b6d4c52ad19b2812e5a144f13fc2cdbba", "patch": "@@ -48,5 +48,11 @@ error: using `clone` on type `i32` which implements the `Copy` trait\n LL |     vec.push(42.clone());\n    |              ^^^^^^^^^^ help: try removing the `clone` call: `42`\n \n-error: aborting due to 8 previous errors\n+error: using `clone` on type `std::option::Option<i32>` which implements the `Copy` trait\n+  --> $DIR/clone_on_copy.rs:77:17\n+   |\n+LL |     let value = opt.clone()?; // operator precedence needed (*opt)?\n+   |                 ^^^^^^^^^^^ help: try dereferencing it: `(*opt)`\n+\n+error: aborting due to 9 previous errors\n "}]}