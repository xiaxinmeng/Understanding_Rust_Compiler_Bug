{"sha": "b71e627b26a5ef932c9e1c10813a500a70211810", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI3MWU2MjdiMjZhNWVmOTMyYzllMWMxMDgxM2E1MDBhNzAyMTE4MTA=", "commit": {"author": {"name": "Tyson Nottingham", "email": "tgnottingham@gmail.com", "date": "2020-09-02T04:50:07Z"}, "committer": {"name": "Tyson Nottingham", "email": "tgnottingham@gmail.com", "date": "2020-11-04T09:37:18Z"}, "message": "incr-comp: hash span end line/column\n\nHash both the length and the end location (line/column) of a span. If we\nhash only the length, for example, then two otherwise equal spans with\ndifferent end locations will have the same hash. This can cause a\nproblem during incremental compilation wherein a previous result for a\nquery that depends on the end location of a span will be incorrectly\nreused when the end location of the span it depends on has changed. A\nsimilar analysis applies if some query depends specifically on the\nlength of the span, but we only hash the end location. So hash both.\n\nFix #46744, fix #59954, fix #63161, fix #73640, fix #73967, fix #74890, fix #75900", "tree": {"sha": "16c8f36b19bdb04f5fae3626a5d9d9a4ccfa6562", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/16c8f36b19bdb04f5fae3626a5d9d9a4ccfa6562"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b71e627b26a5ef932c9e1c10813a500a70211810", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b71e627b26a5ef932c9e1c10813a500a70211810", "html_url": "https://github.com/rust-lang/rust/commit/b71e627b26a5ef932c9e1c10813a500a70211810", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b71e627b26a5ef932c9e1c10813a500a70211810/comments", "author": {"login": "tgnottingham", "id": 3668166, "node_id": "MDQ6VXNlcjM2NjgxNjY=", "avatar_url": "https://avatars.githubusercontent.com/u/3668166?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tgnottingham", "html_url": "https://github.com/tgnottingham", "followers_url": "https://api.github.com/users/tgnottingham/followers", "following_url": "https://api.github.com/users/tgnottingham/following{/other_user}", "gists_url": "https://api.github.com/users/tgnottingham/gists{/gist_id}", "starred_url": "https://api.github.com/users/tgnottingham/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tgnottingham/subscriptions", "organizations_url": "https://api.github.com/users/tgnottingham/orgs", "repos_url": "https://api.github.com/users/tgnottingham/repos", "events_url": "https://api.github.com/users/tgnottingham/events{/privacy}", "received_events_url": "https://api.github.com/users/tgnottingham/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tgnottingham", "id": 3668166, "node_id": "MDQ6VXNlcjM2NjgxNjY=", "avatar_url": "https://avatars.githubusercontent.com/u/3668166?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tgnottingham", "html_url": "https://github.com/tgnottingham", "followers_url": "https://api.github.com/users/tgnottingham/followers", "following_url": "https://api.github.com/users/tgnottingham/following{/other_user}", "gists_url": "https://api.github.com/users/tgnottingham/gists{/gist_id}", "starred_url": "https://api.github.com/users/tgnottingham/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tgnottingham/subscriptions", "organizations_url": "https://api.github.com/users/tgnottingham/orgs", "repos_url": "https://api.github.com/users/tgnottingham/repos", "events_url": "https://api.github.com/users/tgnottingham/events{/privacy}", "received_events_url": "https://api.github.com/users/tgnottingham/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0dce3f606e05cffab7361c132a399d3550ab0df8", "url": "https://api.github.com/repos/rust-lang/rust/commits/0dce3f606e05cffab7361c132a399d3550ab0df8", "html_url": "https://github.com/rust-lang/rust/commit/0dce3f606e05cffab7361c132a399d3550ab0df8"}], "stats": {"total": 71, "additions": 66, "deletions": 5}, "files": [{"sha": "480c08291b4b9cbafcb2b5bd94fdc8c5c0f3bd7e", "filename": "compiler/rustc_span/src/lib.rs", "status": "modified", "additions": 26, "deletions": 5, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/b71e627b26a5ef932c9e1c10813a500a70211810/compiler%2Frustc_span%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b71e627b26a5ef932c9e1c10813a500a70211810/compiler%2Frustc_span%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Flib.rs?ref=b71e627b26a5ef932c9e1c10813a500a70211810", "patch": "@@ -1878,16 +1878,37 @@ where\n             return;\n         }\n \n+        let (_, line_hi, col_hi) = match ctx.byte_pos_to_line_and_col(span.hi) {\n+            Some(pos) => pos,\n+            None => {\n+                Hash::hash(&TAG_INVALID_SPAN, hasher);\n+                span.ctxt.hash_stable(ctx, hasher);\n+                return;\n+            }\n+        };\n+\n         Hash::hash(&TAG_VALID_SPAN, hasher);\n         // We truncate the stable ID hash and line and column numbers. The chances\n         // of causing a collision this way should be minimal.\n         Hash::hash(&(file_lo.name_hash as u64), hasher);\n \n-        let col = (col_lo.0 as u64) & 0xFF;\n-        let line = ((line_lo as u64) & 0xFF_FF_FF) << 8;\n-        let len = ((span.hi - span.lo).0 as u64) << 32;\n-        let line_col_len = col | line | len;\n-        Hash::hash(&line_col_len, hasher);\n+        // Hash both the length and the end location (line/column) of a span. If we\n+        // hash only the length, for example, then two otherwise equal spans with\n+        // different end locations will have the same hash. This can cause a problem\n+        // during incremental compilation wherein a previous result for a query that\n+        // depends on the end location of a span will be incorrectly reused when the\n+        // end location of the span it depends on has changed (see issue #74890). A\n+        // similar analysis applies if some query depends specifically on the length\n+        // of the span, but we only hash the end location. So hash both.\n+\n+        let col_lo_trunc = (col_lo.0 as u64) & 0xFF;\n+        let line_lo_trunc = ((line_lo as u64) & 0xFF_FF_FF) << 8;\n+        let col_hi_trunc = (col_hi.0 as u64) & 0xFF << 32;\n+        let line_hi_trunc = ((line_hi as u64) & 0xFF_FF_FF) << 40;\n+        let col_line = col_lo_trunc | line_lo_trunc | col_hi_trunc | line_hi_trunc;\n+        let len = (span.hi - span.lo).0;\n+        Hash::hash(&col_line, hasher);\n+        Hash::hash(&len, hasher);\n         span.ctxt.hash_stable(ctx, hasher);\n     }\n }"}, {"sha": "428f5f17f91a3d054b78e278febb4cac64ffc47a", "filename": "src/test/run-make/incr-prev-body-beyond-eof/Makefile", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/b71e627b26a5ef932c9e1c10813a500a70211810/src%2Ftest%2Frun-make%2Fincr-prev-body-beyond-eof%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/b71e627b26a5ef932c9e1c10813a500a70211810/src%2Ftest%2Frun-make%2Fincr-prev-body-beyond-eof%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fincr-prev-body-beyond-eof%2FMakefile?ref=b71e627b26a5ef932c9e1c10813a500a70211810", "patch": "@@ -0,0 +1,16 @@\n+-include ../../run-make-fulldeps/tools.mk\n+\n+# Tests that we don't ICE during incremental compilation after modifying a\n+# function span such that its previous end line exceeds the number of lines\n+# in the new file, but its start line/column and length remain the same.\n+\n+SRC=$(TMPDIR)/src\n+INCR=$(TMPDIR)/incr\n+\n+all:\n+\tmkdir $(SRC)\n+\tmkdir $(INCR)\n+\tcp a.rs $(SRC)/main.rs\n+\t$(RUSTC) -C incremental=$(INCR) $(SRC)/main.rs\n+\tcp b.rs $(SRC)/main.rs\n+\t$(RUSTC) -C incremental=$(INCR) $(SRC)/main.rs"}, {"sha": "a12bb96ba5a7ce4d362fb385611bf7402fdc7d19", "filename": "src/test/run-make/incr-prev-body-beyond-eof/a.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/b71e627b26a5ef932c9e1c10813a500a70211810/src%2Ftest%2Frun-make%2Fincr-prev-body-beyond-eof%2Fa.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b71e627b26a5ef932c9e1c10813a500a70211810/src%2Ftest%2Frun-make%2Fincr-prev-body-beyond-eof%2Fa.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fincr-prev-body-beyond-eof%2Fa.rs?ref=b71e627b26a5ef932c9e1c10813a500a70211810", "patch": "@@ -0,0 +1,14 @@\n+fn main() {\n+    // foo must be used.\n+    foo();\n+}\n+\n+fn foo() {\n+    // foo's span in a.rs and b.rs must be identical\n+    // with respect to start line/column and length.\n+    assert_eq!(1, 1);\n+\n+\n+\n+\n+}"}, {"sha": "23e007d0f1c2b36417a30ae9f4d2dd7c230ab99f", "filename": "src/test/run-make/incr-prev-body-beyond-eof/b.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/b71e627b26a5ef932c9e1c10813a500a70211810/src%2Ftest%2Frun-make%2Fincr-prev-body-beyond-eof%2Fb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b71e627b26a5ef932c9e1c10813a500a70211810/src%2Ftest%2Frun-make%2Fincr-prev-body-beyond-eof%2Fb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fincr-prev-body-beyond-eof%2Fb.rs?ref=b71e627b26a5ef932c9e1c10813a500a70211810", "patch": "@@ -0,0 +1,10 @@\n+fn main() {\n+    // foo must be used.\n+    foo();\n+}\n+\n+fn foo() {\n+    // foo's span in a.rs and b.rs must be identical\n+    // with respect to start line/column and length.\n+    assert_eq!(1, 1);////\n+}"}]}