{"sha": "3f4f253028e59ed79f1a461e39381ce3a360b7ef", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNmNGYyNTMwMjhlNTllZDc5ZjFhNDYxZTM5MzgxY2UzYTM2MGI3ZWY=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-01-21T18:04:31Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-21T18:04:31Z"}, "message": "Revert \"Make use of `block_def_map` in body lowering\"", "tree": {"sha": "faf5ddeff96cb7bb864657e9275cd639adb8f386", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/faf5ddeff96cb7bb864657e9275cd639adb8f386"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3f4f253028e59ed79f1a461e39381ce3a360b7ef", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgCcIvCRBK7hj4Ov3rIwAAdHIIAE6GwxBsBzFDxDHUcqoBg+lB\nHp3Sfgy8ytFG+/wChvU2UEzbHYQXFF2vQhZ9/LCIqKCY7rW5FVm/iAEgtmd1CiBO\ng+hWeRJwZqZt13vZyN1cWpUkM7bAOfjfb3S6xkZF3FZaJAHnuNzxHR4ze9egT/sn\nPfFxakSobr0cl1And9qnPE5iRBVlJkunu13Ee4Z1StYQDtz40WaWkiqsK/k0zcyw\nqPpTJkd2HTlNEL2I2N2O0sOsIqjZH82MxfDRA7MPpH+Ucylc+guEO7HMFwjAIESm\nGaBhILUDEzrTuE9CKG+0B9gj3nKUoU9Ih9dSoxo10HzwWqnJom1WS+vRe7M74N0=\n=IWpw\n-----END PGP SIGNATURE-----\n", "payload": "tree faf5ddeff96cb7bb864657e9275cd639adb8f386\nparent e76d8c1d9af2a78a16d25f348c1d69c331349c1f\nauthor Jonas Schievink <jonasschievink@gmail.com> 1611252271 +0100\ncommitter GitHub <noreply@github.com> 1611252271 +0100\n\nRevert \"Make use of `block_def_map` in body lowering\"\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3f4f253028e59ed79f1a461e39381ce3a360b7ef", "html_url": "https://github.com/rust-lang/rust/commit/3f4f253028e59ed79f1a461e39381ce3a360b7ef", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3f4f253028e59ed79f1a461e39381ce3a360b7ef/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e76d8c1d9af2a78a16d25f348c1d69c331349c1f", "url": "https://api.github.com/repos/rust-lang/rust/commits/e76d8c1d9af2a78a16d25f348c1d69c331349c1f", "html_url": "https://github.com/rust-lang/rust/commit/e76d8c1d9af2a78a16d25f348c1d69c331349c1f"}], "stats": {"total": 37, "additions": 18, "deletions": 19}, "files": [{"sha": "2c2c999dd0a7ca2b56b6235080b119ea77bdb156", "filename": "crates/hir_def/src/body.rs", "status": "modified", "additions": 13, "deletions": 6, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/3f4f253028e59ed79f1a461e39381ce3a360b7ef/crates%2Fhir_def%2Fsrc%2Fbody.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f4f253028e59ed79f1a461e39381ce3a360b7ef/crates%2Fhir_def%2Fsrc%2Fbody.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fbody.rs?ref=3f4f253028e59ed79f1a461e39381ce3a360b7ef", "patch": "@@ -45,7 +45,7 @@ pub(crate) struct CfgExpander {\n \n pub(crate) struct Expander {\n     cfg_expander: CfgExpander,\n-    def_map: Arc<DefMap>,\n+    crate_def_map: Arc<DefMap>,\n     current_file_id: HirFileId,\n     ast_id_map: Arc<AstIdMap>,\n     module: ModuleId,\n@@ -90,7 +90,7 @@ impl Expander {\n         let ast_id_map = db.ast_id_map(current_file_id);\n         Expander {\n             cfg_expander,\n-            def_map: crate_def_map,\n+            crate_def_map,\n             current_file_id,\n             ast_id_map,\n             module,\n@@ -101,6 +101,7 @@ impl Expander {\n     pub(crate) fn enter_expand<T: ast::AstNode>(\n         &mut self,\n         db: &dyn DefDatabase,\n+        local_scope: Option<&ItemScope>,\n         macro_call: ast::MacroCall,\n     ) -> ExpandResult<Option<(Mark, T)>> {\n         if self.recursion_limit + 1 > EXPANSION_RECURSION_LIMIT {\n@@ -110,12 +111,18 @@ impl Expander {\n \n         let macro_call = InFile::new(self.current_file_id, &macro_call);\n \n-        let resolver =\n-            |path: ModPath| -> Option<MacroDefId> { self.resolve_path_as_macro(db, &path) };\n+        let resolver = |path: ModPath| -> Option<MacroDefId> {\n+            if let Some(local_scope) = local_scope {\n+                if let Some(def) = path.as_ident().and_then(|n| local_scope.get_legacy_macro(n)) {\n+                    return Some(def);\n+                }\n+            }\n+            self.resolve_path_as_macro(db, &path)\n+        };\n \n         let mut err = None;\n         let call_id =\n-            macro_call.as_call_id_with_errors(db, self.def_map.krate(), resolver, &mut |e| {\n+            macro_call.as_call_id_with_errors(db, self.crate_def_map.krate(), resolver, &mut |e| {\n                 err.get_or_insert(e);\n             });\n         let call_id = match call_id {\n@@ -196,7 +203,7 @@ impl Expander {\n     }\n \n     fn resolve_path_as_macro(&self, db: &dyn DefDatabase, path: &ModPath) -> Option<MacroDefId> {\n-        self.def_map\n+        self.crate_def_map\n             .resolve_path(db, self.module.local_id, path, BuiltinShadowMode::Other)\n             .0\n             .take_macros()"}, {"sha": "4ce5e5b72c319b9db9d1f35c8a49f501ebfeec5c", "filename": "crates/hir_def/src/body/lower.rs", "status": "modified", "additions": 4, "deletions": 12, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/3f4f253028e59ed79f1a461e39381ce3a360b7ef/crates%2Fhir_def%2Fsrc%2Fbody%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f4f253028e59ed79f1a461e39381ce3a360b7ef/crates%2Fhir_def%2Fsrc%2Fbody%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fbody%2Flower.rs?ref=3f4f253028e59ed79f1a461e39381ce3a360b7ef", "patch": "@@ -1,7 +1,7 @@\n //! Transforms `ast::Expr` into an equivalent `hir_def::expr::Expr`\n //! representation.\n \n-use std::{any::type_name, mem, sync::Arc};\n+use std::{any::type_name, sync::Arc};\n \n use either::Either;\n use hir_expand::{\n@@ -559,7 +559,7 @@ impl ExprCollector<'_> {\n         let outer_file = self.expander.current_file_id;\n \n         let macro_call = self.expander.to_source(AstPtr::new(&e));\n-        let res = self.expander.enter_expand(self.db, e);\n+        let res = self.expander.enter_expand(self.db, Some(&self.body.item_scope), e);\n \n         match &res.err {\n             Some(ExpandError::UnresolvedProcMacro) => {\n@@ -696,19 +696,11 @@ impl ExprCollector<'_> {\n \n     fn collect_block(&mut self, block: ast::BlockExpr) -> ExprId {\n         let syntax_node_ptr = AstPtr::new(&block.clone().into());\n-        let ast_id = self.expander.ast_id(&block);\n-        let def_map = self.db.block_def_map(self.expander.module.krate, ast_id);\n-        let prev_def_map = mem::replace(&mut self.expander.def_map, def_map);\n-\n         self.collect_stmts_items(block.statements());\n         let statements =\n             block.statements().filter_map(|s| self.collect_stmt(s)).flatten().collect();\n         let tail = block.tail_expr().map(|e| self.collect_expr(e));\n-        let expr_id =\n-            self.alloc_expr(Expr::Block { statements, tail, label: None }, syntax_node_ptr);\n-\n-        self.expander.def_map = prev_def_map;\n-        expr_id\n+        self.alloc_expr(Expr::Block { statements, tail, label: None }, syntax_node_ptr)\n     }\n \n     fn collect_stmts_items(&mut self, stmts: ast::AstChildren<ast::Stmt>) {\n@@ -838,7 +830,7 @@ impl ExprCollector<'_> {\n                 if annotation == BindingAnnotation::Unannotated && subpat.is_none() {\n                     // This could also be a single-segment path pattern. To\n                     // decide that, we need to try resolving the name.\n-                    let (resolved, _) = self.expander.def_map.resolve_path(\n+                    let (resolved, _) = self.expander.crate_def_map.resolve_path(\n                         self.db,\n                         self.expander.module.local_id,\n                         &name.clone().into(),"}, {"sha": "e7b7724f75fb245157d55f4d7e144673b0c17560", "filename": "crates/hir_def/src/data.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3f4f253028e59ed79f1a461e39381ce3a360b7ef/crates%2Fhir_def%2Fsrc%2Fdata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f4f253028e59ed79f1a461e39381ce3a360b7ef/crates%2Fhir_def%2Fsrc%2Fdata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fdata.rs?ref=3f4f253028e59ed79f1a461e39381ce3a360b7ef", "patch": "@@ -262,7 +262,7 @@ fn collect_items(\n                 let root = db.parse_or_expand(file_id).unwrap();\n                 let call = ast_id_map.get(call.ast_id).to_node(&root);\n \n-                if let Some((mark, mac)) = expander.enter_expand(db, call).value {\n+                if let Some((mark, mac)) = expander.enter_expand(db, None, call).value {\n                     let src: InFile<ast::MacroItems> = expander.to_source(mac);\n                     let item_tree = db.item_tree(src.file_id);\n                     let iter ="}]}