{"sha": "88900895562e0ab5e0642724fe9dd71eeda79a7a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg4OTAwODk1NTYyZTBhYjVlMDY0MjcyNGZlOWRkNzFlZWRhNzlhN2E=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-06-29T16:46:35Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-07-01T05:34:16Z"}, "message": "std: Avoid the WSA_FLAG_NO_HANDLE_INHERIT option\n\nThis was added after Windows 7 SP1, so it's not always available. Instead use\nthe `SetHandleInformation` function to flag a socket as not inheritable. This is\nnot atomic with respect to creating new processes, but it mirrors what Unix does\nwith respect to possibly using the atomic option in the future.\n\nCloses #26543", "tree": {"sha": "72d3f13632ddc99e0c71590e94f800cf4bf15b74", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/72d3f13632ddc99e0c71590e94f800cf4bf15b74"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/88900895562e0ab5e0642724fe9dd71eeda79a7a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/88900895562e0ab5e0642724fe9dd71eeda79a7a", "html_url": "https://github.com/rust-lang/rust/commit/88900895562e0ab5e0642724fe9dd71eeda79a7a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/88900895562e0ab5e0642724fe9dd71eeda79a7a/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c1b8bd2d6fd4a00522635112d3f7b28501552a65", "url": "https://api.github.com/repos/rust-lang/rust/commits/c1b8bd2d6fd4a00522635112d3f7b28501552a65", "html_url": "https://github.com/rust-lang/rust/commit/c1b8bd2d6fd4a00522635112d3f7b28501552a65"}], "stats": {"total": 50, "additions": 34, "deletions": 16}, "files": [{"sha": "2ddf685729bcba2d013997c660013b46d66e1815", "filename": "src/libstd/sys/windows/c.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/88900895562e0ab5e0642724fe9dd71eeda79a7a/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88900895562e0ab5e0642724fe9dd71eeda79a7a/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs?ref=88900895562e0ab5e0642724fe9dd71eeda79a7a", "patch": "@@ -64,6 +64,8 @@ pub const STD_INPUT_HANDLE: libc::DWORD = -10i32 as libc::DWORD;\n pub const STD_OUTPUT_HANDLE: libc::DWORD = -11i32 as libc::DWORD;\n pub const STD_ERROR_HANDLE: libc::DWORD = -12i32 as libc::DWORD;\n \n+pub const HANDLE_FLAG_INHERIT: libc::DWORD = 0x00000001;\n+\n #[repr(C)]\n #[cfg(target_arch = \"x86\")]\n pub struct WSADATA {\n@@ -408,6 +410,9 @@ extern \"system\" {\n     pub fn GetUserProfileDirectoryW(hToken: libc::HANDLE,\n                                     lpProfileDir: libc::LPCWSTR,\n                                     lpcchSize: *mut libc::DWORD) -> libc::BOOL;\n+    pub fn SetHandleInformation(hObject: libc::HANDLE,\n+                                dwMask: libc::DWORD,\n+                                dwFlags: libc::DWORD) -> libc::BOOL;\n }\n \n // Functions that aren't available on Windows XP, but we still use them and just"}, {"sha": "b765bc6e50085c174da39fe8a8f085b4829e929d", "filename": "src/libstd/sys/windows/net.rs", "status": "modified", "additions": 29, "deletions": 16, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/88900895562e0ab5e0642724fe9dd71eeda79a7a/src%2Flibstd%2Fsys%2Fwindows%2Fnet.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88900895562e0ab5e0642724fe9dd71eeda79a7a/src%2Flibstd%2Fsys%2Fwindows%2Fnet.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Fnet.rs?ref=88900895562e0ab5e0642724fe9dd71eeda79a7a", "patch": "@@ -82,26 +82,31 @@ impl Socket {\n             SocketAddr::V4(..) => libc::AF_INET,\n             SocketAddr::V6(..) => libc::AF_INET6,\n         };\n-        let socket = unsafe {\n-            c::WSASocketW(fam, ty, 0, 0 as *mut _, 0,\n-                          c::WSA_FLAG_OVERLAPPED | c::WSA_FLAG_NO_HANDLE_INHERIT)\n-        };\n-        match socket {\n-            INVALID_SOCKET => Err(last_error()),\n-            n => Ok(Socket(n)),\n-        }\n+        let socket = try!(unsafe {\n+            match c::WSASocketW(fam, ty, 0, 0 as *mut _, 0,\n+                                c::WSA_FLAG_OVERLAPPED) {\n+                INVALID_SOCKET => Err(last_error()),\n+                n => Ok(Socket(n)),\n+            }\n+        });\n+        try!(socket.set_no_inherit());\n+        Ok(socket)\n     }\n \n     pub fn accept(&self, storage: *mut libc::sockaddr,\n                   len: *mut libc::socklen_t) -> io::Result<Socket> {\n-        match unsafe { libc::accept(self.0, storage, len) } {\n-            INVALID_SOCKET => Err(last_error()),\n-            n => Ok(Socket(n)),\n-        }\n+        let socket = try!(unsafe {\n+            match libc::accept(self.0, storage, len) {\n+                INVALID_SOCKET => Err(last_error()),\n+                n => Ok(Socket(n)),\n+            }\n+        });\n+        try!(socket.set_no_inherit());\n+        Ok(socket)\n     }\n \n     pub fn duplicate(&self) -> io::Result<Socket> {\n-        unsafe {\n+        let socket = try!(unsafe {\n             let mut info: c::WSAPROTOCOL_INFO = mem::zeroed();\n             try!(cvt(c::WSADuplicateSocketW(self.0,\n                                             c::GetCurrentProcessId(),\n@@ -110,12 +115,13 @@ impl Socket {\n                                 info.iSocketType,\n                                 info.iProtocol,\n                                 &mut info, 0,\n-                                c::WSA_FLAG_OVERLAPPED |\n-                                    c::WSA_FLAG_NO_HANDLE_INHERIT) {\n+                                c::WSA_FLAG_OVERLAPPED) {\n                 INVALID_SOCKET => Err(last_error()),\n                 n => Ok(Socket(n)),\n             }\n-        }\n+        });\n+        try!(socket.set_no_inherit());\n+        Ok(socket)\n     }\n \n     pub fn read(&self, buf: &mut [u8]) -> io::Result<usize> {\n@@ -156,6 +162,13 @@ impl Socket {\n             Ok(Some(Duration::new(secs as u64, nsec as u32)))\n         }\n     }\n+\n+    fn set_no_inherit(&self) -> io::Result<()> {\n+        sys::cvt(unsafe {\n+            c::SetHandleInformation(self.0 as libc::HANDLE,\n+                                    c::HANDLE_FLAG_INHERIT, 0)\n+        }).map(|_| ())\n+    }\n }\n \n impl Drop for Socket {"}]}