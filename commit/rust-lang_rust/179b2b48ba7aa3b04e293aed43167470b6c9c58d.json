{"sha": "179b2b48ba7aa3b04e293aed43167470b6c9c58d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE3OWIyYjQ4YmE3YWEzYjA0ZTI5M2FlZDQzMTY3NDcwYjZjOWM1OGQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-07-07T04:46:31Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-07-07T04:46:31Z"}, "message": "auto merge of #15411 : mitchmindtree/rust/master, r=alexcrichton\n\nI ran `make check` and everything went smoothly. I also tested `#[deriving(Decodable, Encodable)]` on a struct containing both Cell<T> and RefCell<T> and everything now seems to work fine.", "tree": {"sha": "7be1280a27c58b5b7b7b98ae683d50e5f31ef37d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7be1280a27c58b5b7b7b98ae683d50e5f31ef37d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/179b2b48ba7aa3b04e293aed43167470b6c9c58d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/179b2b48ba7aa3b04e293aed43167470b6c9c58d", "html_url": "https://github.com/rust-lang/rust/commit/179b2b48ba7aa3b04e293aed43167470b6c9c58d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/179b2b48ba7aa3b04e293aed43167470b6c9c58d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d9db7f6137122c1cf174518cc402e04d54c3c8c3", "url": "https://api.github.com/repos/rust-lang/rust/commits/d9db7f6137122c1cf174518cc402e04d54c3c8c3", "html_url": "https://github.com/rust-lang/rust/commit/d9db7f6137122c1cf174518cc402e04d54c3c8c3"}, {"sha": "0e84d6fc1ae1267eaf38b9c518a6d8f68ff6305c", "url": "https://api.github.com/repos/rust-lang/rust/commits/0e84d6fc1ae1267eaf38b9c518a6d8f68ff6305c", "html_url": "https://github.com/rust-lang/rust/commit/0e84d6fc1ae1267eaf38b9c518a6d8f68ff6305c"}], "stats": {"total": 85, "additions": 85, "deletions": 0}, "files": [{"sha": "03d9445b9b94bae73032dd1e2bfdd73f43b38177", "filename": "src/libserialize/serialize.rs", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/179b2b48ba7aa3b04e293aed43167470b6c9c58d/src%2Flibserialize%2Fserialize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/179b2b48ba7aa3b04e293aed43167470b6c9c58d/src%2Flibserialize%2Fserialize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibserialize%2Fserialize.rs?ref=179b2b48ba7aa3b04e293aed43167470b6c9c58d", "patch": "@@ -17,6 +17,7 @@ Core encoding and decoding interfaces.\n use std::path;\n use std::rc::Rc;\n use std::gc::{Gc, GC};\n+use std::cell::{Cell, RefCell};\n \n pub trait Encoder<E> {\n     // Primitive types:\n@@ -536,6 +537,35 @@ impl<E, D: Decoder<E>> Decodable<D, E> for path::windows::Path {\n     }\n }\n \n+impl<E, S: Encoder<E>, T: Encodable<S, E> + Copy> Encodable<S, E> for Cell<T> {\n+    fn encode(&self, s: &mut S) -> Result<(), E> {\n+        self.get().encode(s)\n+    }\n+}\n+\n+impl<E, D: Decoder<E>, T: Decodable<D, E> + Copy> Decodable<D, E> for Cell<T> {\n+    fn decode(d: &mut D) -> Result<Cell<T>, E> {\n+        Ok(Cell::new(try!(Decodable::decode(d))))\n+    }\n+}\n+\n+// FIXME: #15036\n+// Should use `try_borrow`, returning a\n+// `encoder.error(\"attempting to Encode borrowed RefCell\")`\n+// from `encode` when `try_borrow` returns `None`.\n+\n+impl<E, S: Encoder<E>, T: Encodable<S, E>> Encodable<S, E> for RefCell<T> {\n+    fn encode(&self, s: &mut S) -> Result<(), E> {\n+        self.borrow().encode(s)\n+    }\n+}\n+\n+impl<E, D: Decoder<E>, T: Decodable<D, E>> Decodable<D, E> for RefCell<T> {\n+    fn decode(d: &mut D) -> Result<RefCell<T>, E> {\n+        Ok(RefCell::new(try!(Decodable::decode(d))))\n+    }\n+}\n+\n // ___________________________________________________________________________\n // Helper routines\n //"}, {"sha": "a7738bb803cf5cae24f1531f9d8c9977c3841ea2", "filename": "src/test/run-pass/deriving-encodable-decodable-cell-refcell.rs", "status": "added", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/179b2b48ba7aa3b04e293aed43167470b6c9c58d/src%2Ftest%2Frun-pass%2Fderiving-encodable-decodable-cell-refcell.rs", "raw_url": "https://github.com/rust-lang/rust/raw/179b2b48ba7aa3b04e293aed43167470b6c9c58d/src%2Ftest%2Frun-pass%2Fderiving-encodable-decodable-cell-refcell.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fderiving-encodable-decodable-cell-refcell.rs?ref=179b2b48ba7aa3b04e293aed43167470b6c9c58d", "patch": "@@ -0,0 +1,55 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// This briefuly tests the capability of `Cell` and `RefCell` to implement the\n+// `Encodable` and `Decodable` traits via `#[deriving(Encodable, Decodable)]`\n+\n+extern crate serialize;\n+\n+use std::cell::{Cell, RefCell};\n+use std::io::MemWriter;\n+use serialize::{Encodable, Decodable};\n+use serialize::ebml;\n+use serialize::ebml::writer::Encoder;\n+use serialize::ebml::reader::Decoder;\n+\n+#[deriving(Encodable, Decodable)]\n+struct A {\n+    baz: int\n+}\n+\n+#[deriving(Encodable, Decodable)]\n+struct B {\n+    foo: Cell<bool>,\n+    bar: RefCell<A>,\n+}\n+\n+fn main() {\n+    let obj = B {\n+        foo: Cell::new(true),\n+        bar: RefCell::new( A { baz: 2 } )\n+    };\n+    let mut w = MemWriter::new();\n+    {\n+        let mut e = Encoder::new(&mut w);\n+        match obj.encode(&mut e) {\n+            Ok(()) => (),\n+            Err(e) => fail!(\"Failed to encode: {}\", e)\n+        };\n+    }\n+    let doc = ebml::Doc::new(w.get_ref());\n+    let mut dec = Decoder::new(doc);\n+    let obj2: B = match Decodable::decode(&mut dec) {\n+        Ok(v) => v,\n+        Err(e) => fail!(\"Failed to decode: {}\", e)\n+    };\n+    assert!(obj.foo.get() == obj2.foo.get());\n+    assert!(obj.bar.borrow().baz == obj2.bar.borrow().baz);\n+}"}]}