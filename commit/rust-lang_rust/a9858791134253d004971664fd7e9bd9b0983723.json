{"sha": "a9858791134253d004971664fd7e9bd9b0983723", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE5ODU4NzkxMTM0MjUzZDAwNDk3MTY2NGZkN2U5YmQ5YjA5ODM3MjM=", "commit": {"author": {"name": "Donough Liu", "email": "ldm2993593805@163.com", "date": "2020-04-29T03:41:34Z"}, "committer": {"name": "Donough Liu", "email": "ldm2993593805@163.com", "date": "2020-04-29T14:21:33Z"}, "message": "Suggest deref when coercing `ty::Ref` to `ty::RawPtr`", "tree": {"sha": "68b109b32491ee2f86bcc847d1d805dfdd50a882", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/68b109b32491ee2f86bcc847d1d805dfdd50a882"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a9858791134253d004971664fd7e9bd9b0983723", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a9858791134253d004971664fd7e9bd9b0983723", "html_url": "https://github.com/rust-lang/rust/commit/a9858791134253d004971664fd7e9bd9b0983723", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a9858791134253d004971664fd7e9bd9b0983723/comments", "author": {"login": "ldm0", "id": 31354274, "node_id": "MDQ6VXNlcjMxMzU0Mjc0", "avatar_url": "https://avatars.githubusercontent.com/u/31354274?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ldm0", "html_url": "https://github.com/ldm0", "followers_url": "https://api.github.com/users/ldm0/followers", "following_url": "https://api.github.com/users/ldm0/following{/other_user}", "gists_url": "https://api.github.com/users/ldm0/gists{/gist_id}", "starred_url": "https://api.github.com/users/ldm0/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ldm0/subscriptions", "organizations_url": "https://api.github.com/users/ldm0/orgs", "repos_url": "https://api.github.com/users/ldm0/repos", "events_url": "https://api.github.com/users/ldm0/events{/privacy}", "received_events_url": "https://api.github.com/users/ldm0/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ldm0", "id": 31354274, "node_id": "MDQ6VXNlcjMxMzU0Mjc0", "avatar_url": "https://avatars.githubusercontent.com/u/31354274?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ldm0", "html_url": "https://github.com/ldm0", "followers_url": "https://api.github.com/users/ldm0/followers", "following_url": "https://api.github.com/users/ldm0/following{/other_user}", "gists_url": "https://api.github.com/users/ldm0/gists{/gist_id}", "starred_url": "https://api.github.com/users/ldm0/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ldm0/subscriptions", "organizations_url": "https://api.github.com/users/ldm0/orgs", "repos_url": "https://api.github.com/users/ldm0/repos", "events_url": "https://api.github.com/users/ldm0/events{/privacy}", "received_events_url": "https://api.github.com/users/ldm0/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a9340b1f69b0a301214934cd9b24dcf348522988", "url": "https://api.github.com/repos/rust-lang/rust/commits/a9340b1f69b0a301214934cd9b24dcf348522988", "html_url": "https://github.com/rust-lang/rust/commit/a9340b1f69b0a301214934cd9b24dcf348522988"}], "stats": {"total": 166, "additions": 162, "deletions": 4}, "files": [{"sha": "5d1a1a164855df6f84e4adea0204e4aa01d34d08", "filename": "src/librustc_typeck/check/coercion.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a9858791134253d004971664fd7e9bd9b0983723/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a9858791134253d004971664fd7e9bd9b0983723/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs?ref=a9858791134253d004971664fd7e9bd9b0983723", "patch": "@@ -74,7 +74,7 @@ use rustc_trait_selection::traits::{self, ObligationCause, ObligationCauseCode};\n use smallvec::{smallvec, SmallVec};\n use std::ops::Deref;\n \n-struct Coerce<'a, 'tcx> {\n+pub struct Coerce<'a, 'tcx> {\n     fcx: &'a FnCtxt<'a, 'tcx>,\n     cause: ObligationCause<'tcx>,\n     use_lub: bool,\n@@ -124,15 +124,15 @@ fn success<'tcx>(\n }\n \n impl<'f, 'tcx> Coerce<'f, 'tcx> {\n-    fn new(\n+    pub fn new(\n         fcx: &'f FnCtxt<'f, 'tcx>,\n         cause: ObligationCause<'tcx>,\n         allow_two_phase: AllowTwoPhase,\n     ) -> Self {\n         Coerce { fcx, cause, allow_two_phase, use_lub: false }\n     }\n \n-    fn unify(&self, a: Ty<'tcx>, b: Ty<'tcx>) -> InferResult<'tcx, Ty<'tcx>> {\n+    pub fn unify(&self, a: Ty<'tcx>, b: Ty<'tcx>) -> InferResult<'tcx, Ty<'tcx>> {\n         self.commit_if_ok(|_| {\n             if self.use_lub {\n                 self.at(&self.cause, self.fcx.param_env).lub(b, a)"}, {"sha": "bfc5419cc92bfaa7b3eebd2da71391c25163d861", "filename": "src/librustc_typeck/check/demand.rs", "status": "modified", "additions": 37, "deletions": 1, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/a9858791134253d004971664fd7e9bd9b0983723/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a9858791134253d004971664fd7e9bd9b0983723/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs?ref=a9858791134253d004971664fd7e9bd9b0983723", "patch": "@@ -1,3 +1,4 @@\n+use crate::check::coercion::Coerce;\n use crate::check::FnCtxt;\n use rustc_infer::infer::InferOk;\n use rustc_trait_selection::infer::InferCtxtExt as _;\n@@ -8,8 +9,9 @@ use rustc_ast::util::parser::PREC_POSTFIX;\n use rustc_errors::{Applicability, DiagnosticBuilder};\n use rustc_hir as hir;\n use rustc_hir::{is_range_literal, Node};\n+use rustc_middle::traits::ObligationCauseCode;\n use rustc_middle::ty::adjustment::AllowTwoPhase;\n-use rustc_middle::ty::{self, AssocItem, Ty};\n+use rustc_middle::ty::{self, AssocItem, Ty, TypeAndMut};\n use rustc_span::symbol::sym;\n use rustc_span::Span;\n \n@@ -539,6 +541,40 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                     return Some((sp, \"consider removing the borrow\", code));\n                 }\n             }\n+            (\n+                _,\n+                &ty::RawPtr(TypeAndMut { ty: _, mutbl: hir::Mutability::Not }),\n+                &ty::Ref(_, _, hir::Mutability::Not),\n+            ) => {\n+                let cause = self.cause(rustc_span::DUMMY_SP, ObligationCauseCode::ExprAssignable);\n+                // We don't ever need two-phase here since we throw out the result of the coercion\n+                let coerce = Coerce::new(self, cause, AllowTwoPhase::No);\n+\n+                if let Some(steps) =\n+                    coerce.autoderef(sp, checked_ty).skip(1).find_map(|(referent_ty, steps)| {\n+                        coerce\n+                            .unify(\n+                                coerce.tcx.mk_ptr(ty::TypeAndMut {\n+                                    mutbl: hir::Mutability::Not,\n+                                    ty: referent_ty,\n+                                }),\n+                                expected,\n+                            )\n+                            .ok()\n+                            .map(|_| steps)\n+                    })\n+                {\n+                    // The pointer type implements `Copy` trait so the suggestion is always valid.\n+                    if let Ok(code) = sm.span_to_snippet(sp) {\n+                        if code.starts_with('&') {\n+                            let derefs = \"*\".repeat(steps - 1);\n+                            let message = \"consider dereferencing the reference\";\n+                            let suggestion = format!(\"&{}{}\", derefs, code[1..].to_string());\n+                            return Some((sp, message, suggestion));\n+                        }\n+                    }\n+                }\n+            }\n             _ if sp == expr.span && !is_macro => {\n                 // Check for `Deref` implementations by constructing a predicate to\n                 // prove: `<T as Deref>::Output == U`"}, {"sha": "4fc5f64ff9a4500c389738659413d7dca1012c0f", "filename": "src/test/ui/issues/issue-32122-1.fixed", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/a9858791134253d004971664fd7e9bd9b0983723/src%2Ftest%2Fui%2Fissues%2Fissue-32122-1.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/a9858791134253d004971664fd7e9bd9b0983723/src%2Ftest%2Fui%2Fissues%2Fissue-32122-1.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-32122-1.fixed?ref=a9858791134253d004971664fd7e9bd9b0983723", "patch": "@@ -0,0 +1,17 @@\n+// run-rustfix\n+use std::ops::Deref;\n+\n+struct Foo(u8);\n+\n+impl Deref for Foo {\n+    type Target = u8;\n+    fn deref(&self) -> &Self::Target {\n+        &self.0\n+    }\n+}\n+\n+fn main() {\n+    let a = Foo(0);\n+    // Should suggest `&*` when coercing &ty to *const ty\n+    let _: *const u8 = &*a; //~ ERROR mismatched types\n+}"}, {"sha": "3c4859f07a2e7cc92e96b80732d4534b6901d760", "filename": "src/test/ui/issues/issue-32122-1.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/a9858791134253d004971664fd7e9bd9b0983723/src%2Ftest%2Fui%2Fissues%2Fissue-32122-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a9858791134253d004971664fd7e9bd9b0983723/src%2Ftest%2Fui%2Fissues%2Fissue-32122-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-32122-1.rs?ref=a9858791134253d004971664fd7e9bd9b0983723", "patch": "@@ -0,0 +1,17 @@\n+// run-rustfix\n+use std::ops::Deref;\n+\n+struct Foo(u8);\n+\n+impl Deref for Foo {\n+    type Target = u8;\n+    fn deref(&self) -> &Self::Target {\n+        &self.0\n+    }\n+}\n+\n+fn main() {\n+    let a = Foo(0);\n+    // Should suggest `&*` when coercing &ty to *const ty\n+    let _: *const u8 = &a; //~ ERROR mismatched types\n+}"}, {"sha": "313de275c53ee625a74c0bec0ec01390d98414d2", "filename": "src/test/ui/issues/issue-32122-1.stderr", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/a9858791134253d004971664fd7e9bd9b0983723/src%2Ftest%2Fui%2Fissues%2Fissue-32122-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a9858791134253d004971664fd7e9bd9b0983723/src%2Ftest%2Fui%2Fissues%2Fissue-32122-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-32122-1.stderr?ref=a9858791134253d004971664fd7e9bd9b0983723", "patch": "@@ -0,0 +1,16 @@\n+error[E0308]: mismatched types\n+  --> $DIR/issue-32122-1.rs:16:24\n+   |\n+LL |     let _: *const u8 = &a;\n+   |            ---------   ^^\n+   |            |           |\n+   |            |           expected `u8`, found struct `Foo`\n+   |            |           help: consider dereferencing the reference: `&*a`\n+   |            expected due to this\n+   |\n+   = note: expected raw pointer `*const u8`\n+                found reference `&Foo`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0308`."}, {"sha": "cee0e59297657dcd37b55295abad0cf2274373bc", "filename": "src/test/ui/issues/issue-32122-2.fixed", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/a9858791134253d004971664fd7e9bd9b0983723/src%2Ftest%2Fui%2Fissues%2Fissue-32122-2.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/a9858791134253d004971664fd7e9bd9b0983723/src%2Ftest%2Fui%2Fissues%2Fissue-32122-2.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-32122-2.fixed?ref=a9858791134253d004971664fd7e9bd9b0983723", "patch": "@@ -0,0 +1,28 @@\n+// run-rustfix\n+use std::ops::Deref;\n+struct Bar(u8);\n+struct Foo(Bar);\n+struct Emm(Foo);\n+impl Deref for Bar{\n+    type Target = u8;\n+    fn deref(&self) -> &Self::Target {\n+        &self.0\n+    }\n+}\n+impl Deref for Foo {\n+    type Target = Bar;\n+    fn deref(&self) -> &Self::Target {\n+        &self.0\n+    }\n+}\n+impl Deref for Emm {\n+    type Target = Foo;\n+    fn deref(&self) -> &Self::Target {\n+        &self.0\n+    }\n+}\n+fn main() {\n+    let a = Emm(Foo(Bar(0)));\n+    // Should suggest `&***` even when deref is pretty deep\n+    let _: *const u8 = &***a; //~ ERROR mismatched types\n+}"}, {"sha": "39e9df4224e74a4beb436769e07d00107ef90062", "filename": "src/test/ui/issues/issue-32122-2.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/a9858791134253d004971664fd7e9bd9b0983723/src%2Ftest%2Fui%2Fissues%2Fissue-32122-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a9858791134253d004971664fd7e9bd9b0983723/src%2Ftest%2Fui%2Fissues%2Fissue-32122-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-32122-2.rs?ref=a9858791134253d004971664fd7e9bd9b0983723", "patch": "@@ -0,0 +1,28 @@\n+// run-rustfix\n+use std::ops::Deref;\n+struct Bar(u8);\n+struct Foo(Bar);\n+struct Emm(Foo);\n+impl Deref for Bar{\n+    type Target = u8;\n+    fn deref(&self) -> &Self::Target {\n+        &self.0\n+    }\n+}\n+impl Deref for Foo {\n+    type Target = Bar;\n+    fn deref(&self) -> &Self::Target {\n+        &self.0\n+    }\n+}\n+impl Deref for Emm {\n+    type Target = Foo;\n+    fn deref(&self) -> &Self::Target {\n+        &self.0\n+    }\n+}\n+fn main() {\n+    let a = Emm(Foo(Bar(0)));\n+    // Should suggest `&***` even when deref is pretty deep\n+    let _: *const u8 = &a; //~ ERROR mismatched types\n+}"}, {"sha": "959a49507e4f510006710e42bd038bbf602269ed", "filename": "src/test/ui/issues/issue-32122-2.stderr", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/a9858791134253d004971664fd7e9bd9b0983723/src%2Ftest%2Fui%2Fissues%2Fissue-32122-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a9858791134253d004971664fd7e9bd9b0983723/src%2Ftest%2Fui%2Fissues%2Fissue-32122-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-32122-2.stderr?ref=a9858791134253d004971664fd7e9bd9b0983723", "patch": "@@ -0,0 +1,16 @@\n+error[E0308]: mismatched types\n+  --> $DIR/issue-32122-2.rs:27:24\n+   |\n+LL |     let _: *const u8 = &a;\n+   |            ---------   ^^\n+   |            |           |\n+   |            |           expected `u8`, found struct `Emm`\n+   |            |           help: consider dereferencing the reference: `&***a`\n+   |            expected due to this\n+   |\n+   = note: expected raw pointer `*const u8`\n+                found reference `&Emm`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0308`."}]}