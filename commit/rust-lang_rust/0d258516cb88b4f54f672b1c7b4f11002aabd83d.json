{"sha": "0d258516cb88b4f54f672b1c7b4f11002aabd83d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBkMjU4NTE2Y2I4OGI0ZjU0ZjY3MmIxYzdiNGYxMTAwMmFhYmQ4M2Q=", "commit": {"author": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2015-05-06T07:17:01Z"}, "committer": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2015-05-12T00:43:40Z"}, "message": "Proper spans for for loop expansion", "tree": {"sha": "7d8e203a257c012423df638e9f7bc68b49f6c6b3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7d8e203a257c012423df638e9f7bc68b49f6c6b3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0d258516cb88b4f54f672b1c7b4f11002aabd83d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0d258516cb88b4f54f672b1c7b4f11002aabd83d", "html_url": "https://github.com/rust-lang/rust/commit/0d258516cb88b4f54f672b1c7b4f11002aabd83d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0d258516cb88b4f54f672b1c7b4f11002aabd83d/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4b88e8f63eeaf557c916a0a1e73150b028c44c52", "url": "https://api.github.com/repos/rust-lang/rust/commits/4b88e8f63eeaf557c916a0a1e73150b028c44c52", "html_url": "https://github.com/rust-lang/rust/commit/4b88e8f63eeaf557c916a0a1e73150b028c44c52"}], "stats": {"total": 66, "additions": 52, "deletions": 14}, "files": [{"sha": "c692babfacc4455d4badfaaa2a91f5d5f9f7c960", "filename": "src/libsyntax/codemap.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0d258516cb88b4f54f672b1c7b4f11002aabd83d/src%2Flibsyntax%2Fcodemap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d258516cb88b4f54f672b1c7b4f11002aabd83d/src%2Flibsyntax%2Fcodemap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fcodemap.rs?ref=0d258516cb88b4f54f672b1c7b4f11002aabd83d", "patch": "@@ -235,7 +235,9 @@ pub enum MacroFormat {\n     /// e.g. #[derive(...)] <item>\n     MacroAttribute,\n     /// e.g. `format!()`\n-    MacroBang\n+    MacroBang,\n+    /// Expansion performed by the compiler (libsyntax::expand).\n+    CompilerExpansion,\n }\n \n #[derive(Clone, Hash, Debug)]"}, {"sha": "66ddd73101e26667832f4c6aa1793e1086eca4a0", "filename": "src/libsyntax/diagnostic.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/0d258516cb88b4f54f672b1c7b4f11002aabd83d/src%2Flibsyntax%2Fdiagnostic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d258516cb88b4f54f672b1c7b4f11002aabd83d/src%2Flibsyntax%2Fdiagnostic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fdiagnostic.rs?ref=0d258516cb88b4f54f672b1c7b4f11002aabd83d", "patch": "@@ -770,12 +770,15 @@ fn print_macro_backtrace(w: &mut EmitterWriter,\n                                                |span| cm.span_to_string(span));\n                 let (pre, post) = match ei.callee.format {\n                     codemap::MacroAttribute => (\"#[\", \"]\"),\n-                    codemap::MacroBang => (\"\", \"!\")\n+                    codemap::MacroBang => (\"\", \"!\"),\n+                    codemap::CompilerExpansion => (\"\", \"\"),\n                 };\n                 try!(print_diagnostic(w, &ss, Note,\n-                                      &format!(\"in expansion of {}{}{}\", pre,\n-                                              ei.callee.name,\n-                                              post), None));\n+                                      &format!(\"in expansion of {}{}{}\",\n+                                               pre,\n+                                               ei.callee.name,\n+                                               post),\n+                                      None));\n                 let ss = cm.span_to_string(ei.call_site);\n                 try!(print_diagnostic(w, &ss, Note, \"expansion site\", None));\n                 Ok(Some(ei.call_site))"}, {"sha": "c49e094152b7076b98977da906f4a6835f6729ad", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 42, "deletions": 9, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/0d258516cb88b4f54f672b1c7b4f11002aabd83d/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d258516cb88b4f54f672b1c7b4f11002aabd83d/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=0d258516cb88b4f54f672b1c7b4f11002aabd83d", "patch": "@@ -19,7 +19,7 @@ use ext::build::AstBuilder;\n use attr;\n use attr::AttrMetaMethods;\n use codemap;\n-use codemap::{Span, Spanned, ExpnInfo, NameAndSpan, MacroBang, MacroAttribute};\n+use codemap::{Span, Spanned, ExpnInfo, NameAndSpan, MacroBang, MacroAttribute, CompilerExpansion};\n use ext::base::*;\n use feature_gate::{self, Features};\n use fold;\n@@ -34,6 +34,18 @@ use visit::Visitor;\n use std_inject;\n \n pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n+    fn push_compiler_expansion(fld: &mut MacroExpander, span: Span, expansion_desc: &str) {\n+        fld.cx.bt_push(ExpnInfo {\n+            call_site: span,\n+            callee: NameAndSpan {\n+                name: expansion_desc.to_string(),\n+                format: CompilerExpansion,\n+                allow_internal_unstable: true,\n+                span: None,\n+            },\n+        });\n+    }\n+\n     e.and_then(|ast::Expr {id, node, span}| match node {\n         // expr_mac should really be expr_ext or something; it's the\n         // entry-point for all syntax extensions.\n@@ -77,6 +89,8 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n             //     }\n             //   }\n \n+            push_compiler_expansion(fld, span, \"while let expansion\");\n+\n             // `<pat> => <body>`\n             let pat_arm = {\n                 let body_expr = fld.cx.expr_block(body);\n@@ -98,7 +112,9 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n             // `[opt_ident]: loop { ... }`\n             let loop_block = fld.cx.block_expr(match_expr);\n             let (loop_block, opt_ident) = expand_loop_block(loop_block, opt_ident, fld);\n-            fld.cx.expr(span, ast::ExprLoop(loop_block, opt_ident))\n+            let result = fld.cx.expr(span, ast::ExprLoop(loop_block, opt_ident));\n+            fld.cx.bt_pop();\n+            result\n         }\n \n         // Desugar ExprIfLet\n@@ -112,6 +128,8 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n             //     _ => [<elseopt> | ()]\n             //   }\n \n+            push_compiler_expansion(fld, span, \"if let expansion\");\n+\n             // `<pat> => <body>`\n             let pat_arm = {\n                 let body_expr = fld.cx.expr_block(body);\n@@ -173,13 +191,16 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n                                                 ast::MatchSource::IfLetDesugar {\n                                                     contains_else_clause: contains_else_clause,\n                                                 }));\n-            fld.fold_expr(match_expr)\n+            let result = fld.fold_expr(match_expr);\n+            fld.cx.bt_pop();\n+            result\n         }\n \n         // Desugar support for ExprIfLet in the ExprIf else position\n         ast::ExprIf(cond, blk, elseopt) => {\n             let elseopt = elseopt.map(|els| els.and_then(|els| match els.node {\n                 ast::ExprIfLet(..) => {\n+                    push_compiler_expansion(fld, span, \"if let expansion\");\n                     // wrap the if-let expr in a block\n                     let span = els.span;\n                     let blk = P(ast::Block {\n@@ -189,7 +210,9 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n                         rules: ast::DefaultBlock,\n                         span: span\n                     });\n-                    fld.cx.expr_block(blk)\n+                    let result = fld.cx.expr_block(blk);\n+                    fld.cx.bt_pop();\n+                    result\n                 }\n                 _ => P(els)\n             }));\n@@ -221,6 +244,10 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n             //     result\n             //   }\n \n+            push_compiler_expansion(fld, span, \"for loop expansion\");\n+\n+            let span = fld.new_span(span);\n+\n             // expand <head>\n             let head = fld.fold_expr(head);\n \n@@ -235,10 +262,11 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n                 rename_fld.fold_ident(ident)\n             };\n \n-            let pat_span = pat.span;\n-            // `:;std::option::Option::Some(<pat>) => <body>`\n+            let pat_span = fld.new_span(pat.span);\n+            // `::std::option::Option::Some(<pat>) => <body>`\n             let pat_arm = {\n                 let body_expr = fld.cx.expr_block(body);\n+                let pat = noop_fold_pat(pat, fld);\n                 let some_pat = fld.cx.pat_some(pat_span, pat);\n \n                 fld.cx.arm(pat_span, vec![some_pat], body_expr)\n@@ -304,20 +332,25 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n \n             // `{ let result = ...; result }`\n             let result_ident = token::gensym_ident(\"result\");\n-            fld.cx.expr_block(\n+            let result = fld.cx.expr_block(\n                 fld.cx.block_all(\n                     span,\n                     vec![fld.cx.stmt_let(span, false, result_ident, match_expr)],\n-                    Some(fld.cx.expr_ident(span, result_ident))))\n+                    Some(fld.cx.expr_ident(span, result_ident))));\n+            fld.cx.bt_pop();\n+            result\n         }\n \n         ast::ExprClosure(capture_clause, fn_decl, block) => {\n+            push_compiler_expansion(fld, span, \"closure expansion\");\n             let (rewritten_fn_decl, rewritten_block)\n                 = expand_and_rename_fn_decl_and_block(fn_decl, block, fld);\n             let new_node = ast::ExprClosure(capture_clause,\n                                             rewritten_fn_decl,\n                                             rewritten_block);\n-            P(ast::Expr{id:id, node: new_node, span: fld.new_span(span)})\n+            let result = P(ast::Expr{id:id, node: new_node, span: fld.new_span(span)});\n+            fld.cx.bt_pop();\n+            result\n         }\n \n         _ => {"}]}