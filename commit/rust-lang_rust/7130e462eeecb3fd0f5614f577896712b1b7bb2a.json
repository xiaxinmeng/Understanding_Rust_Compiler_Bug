{"sha": "7130e462eeecb3fd0f5614f577896712b1b7bb2a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcxMzBlNDYyZWVlY2IzZmQwZjU2MTRmNTc3ODk2NzEyYjFiN2JiMmE=", "commit": {"author": {"name": "Simonas Kazlauskas", "email": "git@kazlauskas.me", "date": "2021-02-21T22:22:15Z"}, "committer": {"name": "Simonas Kazlauskas", "email": "git@kazlauskas.me", "date": "2021-02-21T23:05:17Z"}, "message": "Fix sizes of repr(C) enums on hexagon\n\nEnums on hexagon use a smallest size (but at least 1 byte) that fits all\nthe enumeration values. This is unlike many other ABIs where enums are\nat least 32 bits.", "tree": {"sha": "084f4008c249c1927041f70be4d8434e452533b1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/084f4008c249c1927041f70be4d8434e452533b1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7130e462eeecb3fd0f5614f577896712b1b7bb2a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7130e462eeecb3fd0f5614f577896712b1b7bb2a", "html_url": "https://github.com/rust-lang/rust/commit/7130e462eeecb3fd0f5614f577896712b1b7bb2a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7130e462eeecb3fd0f5614f577896712b1b7bb2a/comments", "author": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3e826bb11228508fbe749e594038d6727208aa94", "url": "https://api.github.com/repos/rust-lang/rust/commits/3e826bb11228508fbe749e594038d6727208aa94", "html_url": "https://github.com/rust-lang/rust/commit/3e826bb11228508fbe749e594038d6727208aa94"}], "stats": {"total": 476, "additions": 476, "deletions": 0}, "files": [{"sha": "12dcb95187cff4b32ae52ada59f6448a0ca0fddd", "filename": "compiler/rustc_middle/src/ty/layout.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7130e462eeecb3fd0f5614f577896712b1b7bb2a/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7130e462eeecb3fd0f5614f577896712b1b7bb2a/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs?ref=7130e462eeecb3fd0f5614f577896712b1b7bb2a", "patch": "@@ -130,6 +130,7 @@ impl IntegerExt for Integer {\n \n         if repr.c() {\n             match &tcx.sess.target.arch[..] {\n+                \"hexagon\" => min_from_extern = Some(I8),\n                 // WARNING: the ARM EABI has two variants; the one corresponding\n                 // to `at_least == I32` appears to be used on Linux and NetBSD,\n                 // but some systems may use the variant corresponding to no"}, {"sha": "4bcfa58f7cf1595036815140fc862d56edf54c1e", "filename": "src/test/ui/layout/hexagon-enum.rs", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/7130e462eeecb3fd0f5614f577896712b1b7bb2a/src%2Ftest%2Fui%2Flayout%2Fhexagon-enum.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7130e462eeecb3fd0f5614f577896712b1b7bb2a/src%2Ftest%2Fui%2Flayout%2Fhexagon-enum.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flayout%2Fhexagon-enum.rs?ref=7130e462eeecb3fd0f5614f577896712b1b7bb2a", "patch": "@@ -0,0 +1,33 @@\n+// compile-flags: --target hexagon-unknown-linux-musl\n+//\n+// Verify that the hexagon targets implement the repr(C) for enums correctly.\n+//\n+// See #82100\n+#![feature(never_type, rustc_attrs, type_alias_impl_trait, no_core, lang_items)]\n+#![crate_type = \"lib\"]\n+#![no_core]\n+\n+#[lang=\"sized\"]\n+trait Sized {}\n+\n+#[rustc_layout(debug)]\n+#[repr(C)]\n+enum A { Apple } //~ ERROR: layout_of\n+\n+#[rustc_layout(debug)]\n+#[repr(C)]\n+enum B { Banana = 255, } //~ ERROR: layout_of\n+\n+#[rustc_layout(debug)]\n+#[repr(C)]\n+enum C { Chaenomeles = 256, } //~ ERROR: layout_of\n+\n+#[rustc_layout(debug)]\n+#[repr(C)]\n+enum P { Peach = 0x1000_0000isize, } //~ ERROR: layout_of\n+\n+const TANGERINE: usize = 0x8100_0000; // hack to get negative numbers without negation operator!\n+\n+#[rustc_layout(debug)]\n+#[repr(C)]\n+enum T { Tangerine = TANGERINE as isize } //~ ERROR: layout_of"}, {"sha": "390eff6e5b957b96e11e3c43c400a8d329026029", "filename": "src/test/ui/layout/hexagon-enum.stderr", "status": "added", "additions": 442, "deletions": 0, "changes": 442, "blob_url": "https://github.com/rust-lang/rust/blob/7130e462eeecb3fd0f5614f577896712b1b7bb2a/src%2Ftest%2Fui%2Flayout%2Fhexagon-enum.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7130e462eeecb3fd0f5614f577896712b1b7bb2a/src%2Ftest%2Fui%2Flayout%2Fhexagon-enum.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flayout%2Fhexagon-enum.stderr?ref=7130e462eeecb3fd0f5614f577896712b1b7bb2a", "patch": "@@ -0,0 +1,442 @@\n+error: layout_of(A) = Layout {\n+    fields: Arbitrary {\n+        offsets: [\n+            Size {\n+                raw: 0,\n+            },\n+        ],\n+        memory_index: [\n+            0,\n+        ],\n+    },\n+    variants: Multiple {\n+        tag: Scalar {\n+            value: Int(\n+                I8,\n+                false,\n+            ),\n+            valid_range: 0..=0,\n+        },\n+        tag_encoding: Direct,\n+        tag_field: 0,\n+        variants: [\n+            Layout {\n+                fields: Arbitrary {\n+                    offsets: [],\n+                    memory_index: [],\n+                },\n+                variants: Single {\n+                    index: 0,\n+                },\n+                abi: Aggregate {\n+                    sized: true,\n+                },\n+                largest_niche: None,\n+                align: AbiAndPrefAlign {\n+                    abi: Align {\n+                        pow2: 0,\n+                    },\n+                    pref: Align {\n+                        pow2: 0,\n+                    },\n+                },\n+                size: Size {\n+                    raw: 1,\n+                },\n+            },\n+        ],\n+    },\n+    abi: Scalar(\n+        Scalar {\n+            value: Int(\n+                I8,\n+                false,\n+            ),\n+            valid_range: 0..=0,\n+        },\n+    ),\n+    largest_niche: Some(\n+        Niche {\n+            offset: Size {\n+                raw: 0,\n+            },\n+            scalar: Scalar {\n+                value: Int(\n+                    I8,\n+                    false,\n+                ),\n+                valid_range: 0..=0,\n+            },\n+        },\n+    ),\n+    align: AbiAndPrefAlign {\n+        abi: Align {\n+            pow2: 0,\n+        },\n+        pref: Align {\n+            pow2: 0,\n+        },\n+    },\n+    size: Size {\n+        raw: 1,\n+    },\n+}\n+  --> $DIR/hexagon-enum.rs:15:1\n+   |\n+LL | enum A { Apple }\n+   | ^^^^^^^^^^^^^^^^\n+\n+error: layout_of(B) = Layout {\n+    fields: Arbitrary {\n+        offsets: [\n+            Size {\n+                raw: 0,\n+            },\n+        ],\n+        memory_index: [\n+            0,\n+        ],\n+    },\n+    variants: Multiple {\n+        tag: Scalar {\n+            value: Int(\n+                I8,\n+                false,\n+            ),\n+            valid_range: 255..=255,\n+        },\n+        tag_encoding: Direct,\n+        tag_field: 0,\n+        variants: [\n+            Layout {\n+                fields: Arbitrary {\n+                    offsets: [],\n+                    memory_index: [],\n+                },\n+                variants: Single {\n+                    index: 0,\n+                },\n+                abi: Aggregate {\n+                    sized: true,\n+                },\n+                largest_niche: None,\n+                align: AbiAndPrefAlign {\n+                    abi: Align {\n+                        pow2: 0,\n+                    },\n+                    pref: Align {\n+                        pow2: 0,\n+                    },\n+                },\n+                size: Size {\n+                    raw: 1,\n+                },\n+            },\n+        ],\n+    },\n+    abi: Scalar(\n+        Scalar {\n+            value: Int(\n+                I8,\n+                false,\n+            ),\n+            valid_range: 255..=255,\n+        },\n+    ),\n+    largest_niche: Some(\n+        Niche {\n+            offset: Size {\n+                raw: 0,\n+            },\n+            scalar: Scalar {\n+                value: Int(\n+                    I8,\n+                    false,\n+                ),\n+                valid_range: 255..=255,\n+            },\n+        },\n+    ),\n+    align: AbiAndPrefAlign {\n+        abi: Align {\n+            pow2: 0,\n+        },\n+        pref: Align {\n+            pow2: 0,\n+        },\n+    },\n+    size: Size {\n+        raw: 1,\n+    },\n+}\n+  --> $DIR/hexagon-enum.rs:19:1\n+   |\n+LL | enum B { Banana = 255, }\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: layout_of(C) = Layout {\n+    fields: Arbitrary {\n+        offsets: [\n+            Size {\n+                raw: 0,\n+            },\n+        ],\n+        memory_index: [\n+            0,\n+        ],\n+    },\n+    variants: Multiple {\n+        tag: Scalar {\n+            value: Int(\n+                I16,\n+                false,\n+            ),\n+            valid_range: 256..=256,\n+        },\n+        tag_encoding: Direct,\n+        tag_field: 0,\n+        variants: [\n+            Layout {\n+                fields: Arbitrary {\n+                    offsets: [],\n+                    memory_index: [],\n+                },\n+                variants: Single {\n+                    index: 0,\n+                },\n+                abi: Aggregate {\n+                    sized: true,\n+                },\n+                largest_niche: None,\n+                align: AbiAndPrefAlign {\n+                    abi: Align {\n+                        pow2: 1,\n+                    },\n+                    pref: Align {\n+                        pow2: 1,\n+                    },\n+                },\n+                size: Size {\n+                    raw: 2,\n+                },\n+            },\n+        ],\n+    },\n+    abi: Scalar(\n+        Scalar {\n+            value: Int(\n+                I16,\n+                false,\n+            ),\n+            valid_range: 256..=256,\n+        },\n+    ),\n+    largest_niche: Some(\n+        Niche {\n+            offset: Size {\n+                raw: 0,\n+            },\n+            scalar: Scalar {\n+                value: Int(\n+                    I16,\n+                    false,\n+                ),\n+                valid_range: 256..=256,\n+            },\n+        },\n+    ),\n+    align: AbiAndPrefAlign {\n+        abi: Align {\n+            pow2: 1,\n+        },\n+        pref: Align {\n+            pow2: 1,\n+        },\n+    },\n+    size: Size {\n+        raw: 2,\n+    },\n+}\n+  --> $DIR/hexagon-enum.rs:23:1\n+   |\n+LL | enum C { Chaenomeles = 256, }\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: layout_of(P) = Layout {\n+    fields: Arbitrary {\n+        offsets: [\n+            Size {\n+                raw: 0,\n+            },\n+        ],\n+        memory_index: [\n+            0,\n+        ],\n+    },\n+    variants: Multiple {\n+        tag: Scalar {\n+            value: Int(\n+                I32,\n+                false,\n+            ),\n+            valid_range: 268435456..=268435456,\n+        },\n+        tag_encoding: Direct,\n+        tag_field: 0,\n+        variants: [\n+            Layout {\n+                fields: Arbitrary {\n+                    offsets: [],\n+                    memory_index: [],\n+                },\n+                variants: Single {\n+                    index: 0,\n+                },\n+                abi: Aggregate {\n+                    sized: true,\n+                },\n+                largest_niche: None,\n+                align: AbiAndPrefAlign {\n+                    abi: Align {\n+                        pow2: 2,\n+                    },\n+                    pref: Align {\n+                        pow2: 2,\n+                    },\n+                },\n+                size: Size {\n+                    raw: 4,\n+                },\n+            },\n+        ],\n+    },\n+    abi: Scalar(\n+        Scalar {\n+            value: Int(\n+                I32,\n+                false,\n+            ),\n+            valid_range: 268435456..=268435456,\n+        },\n+    ),\n+    largest_niche: Some(\n+        Niche {\n+            offset: Size {\n+                raw: 0,\n+            },\n+            scalar: Scalar {\n+                value: Int(\n+                    I32,\n+                    false,\n+                ),\n+                valid_range: 268435456..=268435456,\n+            },\n+        },\n+    ),\n+    align: AbiAndPrefAlign {\n+        abi: Align {\n+            pow2: 2,\n+        },\n+        pref: Align {\n+            pow2: 2,\n+        },\n+    },\n+    size: Size {\n+        raw: 4,\n+    },\n+}\n+  --> $DIR/hexagon-enum.rs:27:1\n+   |\n+LL | enum P { Peach = 0x1000_0000isize, }\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: layout_of(T) = Layout {\n+    fields: Arbitrary {\n+        offsets: [\n+            Size {\n+                raw: 0,\n+            },\n+        ],\n+        memory_index: [\n+            0,\n+        ],\n+    },\n+    variants: Multiple {\n+        tag: Scalar {\n+            value: Int(\n+                I32,\n+                true,\n+            ),\n+            valid_range: 2164260864..=2164260864,\n+        },\n+        tag_encoding: Direct,\n+        tag_field: 0,\n+        variants: [\n+            Layout {\n+                fields: Arbitrary {\n+                    offsets: [],\n+                    memory_index: [],\n+                },\n+                variants: Single {\n+                    index: 0,\n+                },\n+                abi: Aggregate {\n+                    sized: true,\n+                },\n+                largest_niche: None,\n+                align: AbiAndPrefAlign {\n+                    abi: Align {\n+                        pow2: 2,\n+                    },\n+                    pref: Align {\n+                        pow2: 2,\n+                    },\n+                },\n+                size: Size {\n+                    raw: 4,\n+                },\n+            },\n+        ],\n+    },\n+    abi: Scalar(\n+        Scalar {\n+            value: Int(\n+                I32,\n+                true,\n+            ),\n+            valid_range: 2164260864..=2164260864,\n+        },\n+    ),\n+    largest_niche: Some(\n+        Niche {\n+            offset: Size {\n+                raw: 0,\n+            },\n+            scalar: Scalar {\n+                value: Int(\n+                    I32,\n+                    true,\n+                ),\n+                valid_range: 2164260864..=2164260864,\n+            },\n+        },\n+    ),\n+    align: AbiAndPrefAlign {\n+        abi: Align {\n+            pow2: 2,\n+        },\n+        pref: Align {\n+            pow2: 2,\n+        },\n+    },\n+    size: Size {\n+        raw: 4,\n+    },\n+}\n+  --> $DIR/hexagon-enum.rs:33:1\n+   |\n+LL | enum T { Tangerine = TANGERINE as isize }\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 5 previous errors\n+"}]}