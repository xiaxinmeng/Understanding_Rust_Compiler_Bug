{"sha": "067e97d149edc5eccdd0a30079f313325e87e449", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA2N2U5N2QxNDllZGM1ZWNjZGQwYTMwMDc5ZjMxMzMyNWU4N2U0NDk=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-06-15T13:54:43Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-06-15T13:54:43Z"}, "message": "internal: enforce no #[ignore] and no #[should_panic]", "tree": {"sha": "18d39b0aedee752543e5fdd4f73d4108694cae2b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/18d39b0aedee752543e5fdd4f73d4108694cae2b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/067e97d149edc5eccdd0a30079f313325e87e449", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/067e97d149edc5eccdd0a30079f313325e87e449", "html_url": "https://github.com/rust-lang/rust/commit/067e97d149edc5eccdd0a30079f313325e87e449", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/067e97d149edc5eccdd0a30079f313325e87e449/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4584868a7a23ea640694f34ed9e8c907473c66b4", "url": "https://api.github.com/repos/rust-lang/rust/commits/4584868a7a23ea640694f34ed9e8c907473c66b4", "html_url": "https://github.com/rust-lang/rust/commit/4584868a7a23ea640694f34ed9e8c907473c66b4"}], "stats": {"total": 35, "additions": 33, "deletions": 2}, "files": [{"sha": "31f76589dea8668aa47d5e398ea00f81d9da0322", "filename": "crates/syntax/test_data/parser/ok/0011_outer_attribute.rast", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/067e97d149edc5eccdd0a30079f313325e87e449/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0011_outer_attribute.rast", "raw_url": "https://github.com/rust-lang/rust/raw/067e97d149edc5eccdd0a30079f313325e87e449/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0011_outer_attribute.rast", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0011_outer_attribute.rast?ref=067e97d149edc5eccdd0a30079f313325e87e449", "patch": "@@ -21,7 +21,7 @@ SOURCE_FILE@0..60\n         PATH@15..21\n           PATH_SEGMENT@15..21\n             NAME_REF@15..21\n-              IDENT@15..21 \"ignore\"\n+              IDENT@15..21 \"Ignore\"\n       R_BRACK@21..22 \"]\"\n     WHITESPACE@22..23 \"\\n\"\n     FN_KW@23..25 \"fn\""}, {"sha": "6f04cb1717f6bdfe9a51a973b92cbd7eaaedf170", "filename": "crates/syntax/test_data/parser/ok/0011_outer_attribute.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/067e97d149edc5eccdd0a30079f313325e87e449/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0011_outer_attribute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/067e97d149edc5eccdd0a30079f313325e87e449/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0011_outer_attribute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0011_outer_attribute.rs?ref=067e97d149edc5eccdd0a30079f313325e87e449", "patch": "@@ -1,5 +1,5 @@\n #[cfg(test)]\n-#[ignore]\n+#[Ignore]\n fn foo() {}\n \n #[path = \"a.rs\"]"}, {"sha": "25ddb43b20fe2ee0cd84c46dfb5556e4a6e8af7f", "filename": "xtask/src/tidy.rs", "status": "modified", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/067e97d149edc5eccdd0a30079f313325e87e449/xtask%2Fsrc%2Ftidy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/067e97d149edc5eccdd0a30079f313325e87e449/xtask%2Fsrc%2Ftidy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Ftidy.rs?ref=067e97d149edc5eccdd0a30079f313325e87e449", "patch": "@@ -89,6 +89,7 @@ fn rust_files_are_tidy() {\n         let text = read_file(&path).unwrap();\n         check_todo(&path, &text);\n         check_dbg(&path, &text);\n+        check_test_attrs(&path, &text);\n         check_trailing_ws(&path, &text);\n         deny_clippy(&path, &text);\n         tidy_docs.visit(&path, &text);\n@@ -334,6 +335,36 @@ fn check_dbg(path: &Path, text: &str) {\n     }\n }\n \n+fn check_test_attrs(path: &Path, text: &str) {\n+    let ignore_rule =\n+        \"https://github.com/rust-analyzer/rust-analyzer/blob/master/docs/dev/style.md#ignore\";\n+    let need_ignore: &[&str] = &[\n+        // Special case to run `#[ignore]` tests\n+        \"ide/src/runnables.rs\",\n+        // A legit test which needs to be ignored, as it takes too long to run\n+        // :(\n+        \"hir_def/src/nameres/collector.rs\",\n+        // Obviously needs ignore.\n+        \"ide_assists/src/handlers/toggle_ignore.rs\",\n+        // See above.\n+        \"ide_assists/src/tests/generated.rs\",\n+    ];\n+    if text.contains(\"#[ignore\") && !need_ignore.iter().any(|p| path.ends_with(p)) {\n+        panic!(\"\\ndon't `#[ignore]` tests, see:\\n\\n    {}\\n\\n   {}\\n\", ignore_rule, path.display(),)\n+    }\n+\n+    let panic_rule =\n+        \"https://github.com/rust-analyzer/rust-analyzer/blob/master/docs/dev/style.md#panic\";\n+    let need_panic: &[&str] = &[\"test_utils/src/fixture.rs\"];\n+    if text.contains(\"#[should_panic\") && !need_panic.iter().any(|p| path.ends_with(p)) {\n+        panic!(\n+            \"\\ndon't add `#[should_panic]` tests, see:\\n\\n    {}\\n\\n   {}\\n\",\n+            panic_rule,\n+            path.display(),\n+        )\n+    }\n+}\n+\n fn check_trailing_ws(path: &Path, text: &str) {\n     if is_exclude_dir(path, &[\"test_data\"]) {\n         return;"}]}