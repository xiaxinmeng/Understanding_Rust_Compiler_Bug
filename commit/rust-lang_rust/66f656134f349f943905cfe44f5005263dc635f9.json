{"sha": "66f656134f349f943905cfe44f5005263dc635f9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY2ZjY1NjEzNGYzNDlmOTQzOTA1Y2ZlNDRmNTAwNTI2M2RjNjM1Zjk=", "commit": {"author": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-12-06T20:57:04Z"}, "committer": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-12-06T20:57:04Z"}, "message": "Merge #261\n\n261: Add heavy test for code actions r=matklad a=flodiebold\n\nHere's the test for the code actions; I didn't find anything fitting on crates.io ([assert-json-diff](https://crates.io/crates/assert-json-diff) looks kind of nice, but doesn't have anything like the wildcards), so I copied the cargo code as you suggested.\n\nCo-authored-by: Florian Diebold <florian.diebold@freiheit.com>", "tree": {"sha": "513b56d0c4757f37fa318b964ac1f630e246680b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/513b56d0c4757f37fa318b964ac1f630e246680b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/66f656134f349f943905cfe44f5005263dc635f9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/66f656134f349f943905cfe44f5005263dc635f9", "html_url": "https://github.com/rust-lang/rust/commit/66f656134f349f943905cfe44f5005263dc635f9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/66f656134f349f943905cfe44f5005263dc635f9/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "parents": [{"sha": "8e60e751cbcfa47c7bed788dfe2ab5cebfcb78b3", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e60e751cbcfa47c7bed788dfe2ab5cebfcb78b3", "html_url": "https://github.com/rust-lang/rust/commit/8e60e751cbcfa47c7bed788dfe2ab5cebfcb78b3"}, {"sha": "29793e7de978c9f0fa2d46bad624fc49d2506b11", "url": "https://api.github.com/repos/rust-lang/rust/commits/29793e7de978c9f0fa2d46bad624fc49d2506b11", "html_url": "https://github.com/rust-lang/rust/commit/29793e7de978c9f0fa2d46bad624fc49d2506b11"}], "stats": {"total": 196, "additions": 177, "deletions": 19}, "files": [{"sha": "4f46e26fb7bf5d50c1e97d61e80f7f8b639723af", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/66f656134f349f943905cfe44f5005263dc635f9/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/66f656134f349f943905cfe44f5005263dc635f9/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=66f656134f349f943905cfe44f5005263dc635f9", "patch": "@@ -1075,6 +1075,7 @@ version = \"0.1.0\"\n dependencies = [\n  \"difference 2.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"itertools 0.7.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"serde_json 1.0.32 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n "}, {"sha": "26f5e3f200a809decc210d6cc73e45a3a54d93ff", "filename": "crates/ra_lsp_server/tests/heavy_tests/main.rs", "status": "modified", "additions": 66, "deletions": 5, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/66f656134f349f943905cfe44f5005263dc635f9/crates%2Fra_lsp_server%2Ftests%2Fheavy_tests%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/66f656134f349f943905cfe44f5005263dc635f9/crates%2Fra_lsp_server%2Ftests%2Fheavy_tests%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Ftests%2Fheavy_tests%2Fmain.rs?ref=66f656134f349f943905cfe44f5005263dc635f9", "patch": "@@ -1,6 +1,10 @@\n mod support;\n \n-use ra_lsp_server::req::{Runnables, RunnablesParams};\n+use serde_json::json;\n+\n+use ra_lsp_server::req::{Runnables, RunnablesParams, CodeActionRequest, CodeActionParams};\n+\n+use languageserver_types::{Position, Range, CodeActionContext};\n \n use crate::support::project;\n \n@@ -21,7 +25,7 @@ fn foo() {\n             text_document: server.doc_id(\"lib.rs\"),\n             position: None,\n         },\n-        r#\"[\n+        json!([\n           {\n             \"args\": [ \"test\", \"--\", \"foo\", \"--nocapture\" ],\n             \"bin\": \"cargo\",\n@@ -51,7 +55,7 @@ fn foo() {\n               }\n             }\n           }\n-        ]\"#,\n+        ]),\n     );\n }\n \n@@ -78,7 +82,7 @@ fn test_eggs() {}\n             text_document: server.doc_id(\"tests/spam.rs\"),\n             position: None,\n         },\n-        r#\"[\n+        json!([\n           {\n             \"args\": [ \"test\", \"--package\", \"foo\", \"--test\", \"spam\", \"--\", \"test_eggs\", \"--nocapture\" ],\n             \"bin\": \"cargo\",\n@@ -111,6 +115,63 @@ fn test_eggs() {}\n               }\n             }\n           }\n-        ]\"#\n+        ])\n+    );\n+}\n+\n+#[test]\n+fn test_missing_module_code_action() {\n+    let server = project(\n+        r#\"\n+//- Cargo.toml\n+[package]\n+name = \"foo\"\n+version = \"0.0.0\"\n+\n+//- src/lib.rs\n+mod bar;\n+\n+fn main() {}\n+\"#,\n+    );\n+    server.wait_for_feedback(\"workspace loaded\");\n+    let empty_context = || CodeActionContext {\n+        diagnostics: Vec::new(),\n+        only: None,\n+    };\n+    server.request::<CodeActionRequest>(\n+        CodeActionParams {\n+            text_document: server.doc_id(\"src/lib.rs\"),\n+            range: Range::new(Position::new(0, 0), Position::new(0, 7)),\n+            context: empty_context(),\n+        },\n+        json!([\n+            {\n+              \"arguments\": [\n+                {\n+                  \"cursorPosition\": null,\n+                  \"fileSystemEdits\": [\n+                    {\n+                        \"type\": \"createFile\",\n+                        \"uri\": \"file:///[..]/src/bar.rs\"\n+                    }\n+                  ],\n+                  \"label\": \"create module\",\n+                  \"sourceFileEdits\": []\n+                }\n+              ],\n+              \"command\": \"ra-lsp.applySourceChange\",\n+              \"title\": \"create module\"\n+            }\n+        ]),\n+    );\n+\n+    server.request::<CodeActionRequest>(\n+        CodeActionParams {\n+            text_document: server.doc_id(\"src/lib.rs\"),\n+            range: Range::new(Position::new(2, 0), Position::new(2, 7)),\n+            context: empty_context(),\n+        },\n+        json!([]),\n     );\n }"}, {"sha": "4b75be3ee74c198c91b4da17955dbc9cb6e49437", "filename": "crates/ra_lsp_server/tests/heavy_tests/support.rs", "status": "modified", "additions": 14, "deletions": 13, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/66f656134f349f943905cfe44f5005263dc635f9/crates%2Fra_lsp_server%2Ftests%2Fheavy_tests%2Fsupport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/66f656134f349f943905cfe44f5005263dc635f9/crates%2Fra_lsp_server%2Ftests%2Fheavy_tests%2Fsupport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Ftests%2Fheavy_tests%2Fsupport.rs?ref=66f656134f349f943905cfe44f5005263dc635f9", "patch": "@@ -15,9 +15,9 @@ use languageserver_types::{\n     DidOpenTextDocumentParams, TextDocumentIdentifier, TextDocumentItem, Url,\n };\n use serde::Serialize;\n-use serde_json::{from_str, to_string_pretty, Value};\n+use serde_json::{to_string_pretty, Value};\n use tempdir::TempDir;\n-use test_utils::parse_fixture;\n+use test_utils::{parse_fixture, find_mismatch};\n \n use ra_lsp_server::{\n     main_loop, req,\n@@ -88,23 +88,24 @@ impl Server {\n         }\n     }\n \n-    pub fn request<R>(&self, params: R::Params, expected_resp: &str)\n+    pub fn request<R>(&self, params: R::Params, expected_resp: Value)\n     where\n         R: Request,\n         R::Params: Serialize,\n     {\n         let id = self.req_id.get();\n         self.req_id.set(id + 1);\n-        let expected_resp: Value = from_str(expected_resp).unwrap();\n         let actual = self.send_request::<R>(id, params);\n-        assert_eq!(\n-            expected_resp,\n-            actual,\n-            \"Expected:\\n{}\\n\\\n-             Actual:\\n{}\\n\",\n-            to_string_pretty(&expected_resp).unwrap(),\n-            to_string_pretty(&actual).unwrap(),\n-        );\n+        match find_mismatch(&expected_resp, &actual) {\n+            Some((expected_part, actual_part)) => panic!(\n+                \"JSON mismatch\\nExpected:\\n{}\\nWas:\\n{}\\nExpected part:\\n{}\\nActual part:\\n{}\\n\",\n+                to_string_pretty(&expected_resp).unwrap(),\n+                to_string_pretty(&actual).unwrap(),\n+                to_string_pretty(expected_part).unwrap(),\n+                to_string_pretty(actual_part).unwrap(),\n+            ),\n+            None => {}\n+        }\n     }\n \n     fn send_request<R>(&self, id: u64, params: R::Params) -> Value\n@@ -139,7 +140,7 @@ impl Server {\n     pub fn wait_for_feedback_n(&self, feedback: &str, n: usize) {\n         let f = |msg: &RawMessage| match msg {\n             RawMessage::Notification(n) if n.method == \"internalFeedback\" => {\n-                return n.clone().cast::<req::InternalFeedback>().unwrap() == feedback\n+                return n.clone().cast::<req::InternalFeedback>().unwrap() == feedback;\n             }\n             _ => false,\n         };"}, {"sha": "4473c2fab9677646fc5e08464d8dd887b690db26", "filename": "crates/ra_syntax/src/grammar/items/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/66f656134f349f943905cfe44f5005263dc635f9/crates%2Fra_syntax%2Fsrc%2Fgrammar%2Fitems%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/66f656134f349f943905cfe44f5005263dc635f9/crates%2Fra_syntax%2Fsrc%2Fgrammar%2Fitems%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fgrammar%2Fitems%2Fmod.rs?ref=66f656134f349f943905cfe44f5005263dc635f9", "patch": "@@ -159,7 +159,7 @@ pub(super) fn maybe_item(p: &mut Parser, flavor: ItemFlavor) -> MaybeItem {\n                 MaybeItem::Modifiers\n             } else {\n                 MaybeItem::None\n-            }\n+            };\n         }\n     };\n "}, {"sha": "8c8fcd7ae72e43595d596294118d09d59aedf434", "filename": "crates/test_utils/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/66f656134f349f943905cfe44f5005263dc635f9/crates%2Ftest_utils%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/66f656134f349f943905cfe44f5005263dc635f9/crates%2Ftest_utils%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Ftest_utils%2FCargo.toml?ref=66f656134f349f943905cfe44f5005263dc635f9", "patch": "@@ -8,3 +8,4 @@ authors = [\"Aleksey Kladov <aleksey.kladov@gmail.com>\"]\n difference = \"2.0.0\"\n itertools = \"0.7.8\"\n text_unit = \"0.1.2\"\n+serde_json = \"1.0.24\""}, {"sha": "0a94adb740dff7b958debc20eb7d8efb98f65b04", "filename": "crates/test_utils/src/lib.rs", "status": "modified", "additions": 94, "deletions": 0, "changes": 94, "blob_url": "https://github.com/rust-lang/rust/blob/66f656134f349f943905cfe44f5005263dc635f9/crates%2Ftest_utils%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/66f656134f349f943905cfe44f5005263dc635f9/crates%2Ftest_utils%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Ftest_utils%2Fsrc%2Flib.rs?ref=66f656134f349f943905cfe44f5005263dc635f9", "patch": "@@ -2,6 +2,7 @@ use std::fmt;\n \n use itertools::Itertools;\n use text_unit::{TextRange, TextUnit};\n+use serde_json::Value;\n \n pub use difference::Changeset as __Changeset;\n \n@@ -145,3 +146,96 @@ pub fn parse_fixture(fixture: &str) -> Vec<FixtureEntry> {\n     flush!();\n     res\n }\n+\n+// Comparison functionality borrowed from cargo:\n+\n+/// Compare a line with an expected pattern.\n+/// - Use `[..]` as a wildcard to match 0 or more characters on the same line\n+///   (similar to `.*` in a regex).\n+pub fn lines_match(expected: &str, actual: &str) -> bool {\n+    // Let's not deal with / vs \\ (windows...)\n+    // First replace backslash-escaped backslashes with forward slashes\n+    // which can occur in, for example, JSON output\n+    let expected = expected.replace(\"\\\\\\\\\", \"/\").replace(\"\\\\\", \"/\");\n+    let mut actual: &str = &actual.replace(\"\\\\\\\\\", \"/\").replace(\"\\\\\", \"/\");\n+    for (i, part) in expected.split(\"[..]\").enumerate() {\n+        match actual.find(part) {\n+            Some(j) => {\n+                if i == 0 && j != 0 {\n+                    return false;\n+                }\n+                actual = &actual[j + part.len()..];\n+            }\n+            None => return false,\n+        }\n+    }\n+    actual.is_empty() || expected.ends_with(\"[..]\")\n+}\n+\n+#[test]\n+fn lines_match_works() {\n+    assert!(lines_match(\"a b\", \"a b\"));\n+    assert!(lines_match(\"a[..]b\", \"a b\"));\n+    assert!(lines_match(\"a[..]\", \"a b\"));\n+    assert!(lines_match(\"[..]\", \"a b\"));\n+    assert!(lines_match(\"[..]b\", \"a b\"));\n+\n+    assert!(!lines_match(\"[..]b\", \"c\"));\n+    assert!(!lines_match(\"b\", \"c\"));\n+    assert!(!lines_match(\"b\", \"cb\"));\n+}\n+\n+// Compares JSON object for approximate equality.\n+// You can use `[..]` wildcard in strings (useful for OS dependent things such\n+// as paths).  You can use a `\"{...}\"` string literal as a wildcard for\n+// arbitrary nested JSON (useful for parts of object emitted by other programs\n+// (e.g. rustc) rather than Cargo itself).  Arrays are sorted before comparison.\n+pub fn find_mismatch<'a>(expected: &'a Value, actual: &'a Value) -> Option<(&'a Value, &'a Value)> {\n+    use serde_json::Value::*;\n+    match (expected, actual) {\n+        (&Number(ref l), &Number(ref r)) if l == r => None,\n+        (&Bool(l), &Bool(r)) if l == r => None,\n+        (&String(ref l), &String(ref r)) if lines_match(l, r) => None,\n+        (&Array(ref l), &Array(ref r)) => {\n+            if l.len() != r.len() {\n+                return Some((expected, actual));\n+            }\n+\n+            let mut l = l.iter().collect::<Vec<_>>();\n+            let mut r = r.iter().collect::<Vec<_>>();\n+\n+            l.retain(\n+                |l| match r.iter().position(|r| find_mismatch(l, r).is_none()) {\n+                    Some(i) => {\n+                        r.remove(i);\n+                        false\n+                    }\n+                    None => true,\n+                },\n+            );\n+\n+            if !l.is_empty() {\n+                assert!(!r.is_empty());\n+                Some((&l[0], &r[0]))\n+            } else {\n+                assert_eq!(r.len(), 0);\n+                None\n+            }\n+        }\n+        (&Object(ref l), &Object(ref r)) => {\n+            let same_keys = l.len() == r.len() && l.keys().all(|k| r.contains_key(k));\n+            if !same_keys {\n+                return Some((expected, actual));\n+            }\n+\n+            l.values()\n+                .zip(r.values())\n+                .filter_map(|(l, r)| find_mismatch(l, r))\n+                .nth(0)\n+        }\n+        (&Null, &Null) => None,\n+        // magic string literal \"{...}\" acts as wildcard for any sub-JSON\n+        (&String(ref l), _) if l == \"{...}\" => None,\n+        _ => Some((expected, actual)),\n+    }\n+}"}]}