{"sha": "ccdc26fd42dfccc5832114baa275f0936738095a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNjZGMyNmZkNDJkZmNjYzU4MzIxMTRiYWEyNzVmMDkzNjczODA5NWE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-11-23T07:21:45Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-11-23T07:21:45Z"}, "message": "Auto merge of #37886 - Stebalien:set-perm, r=alexcrichton\n\nAdd a method for setting permissions directly on an open file.\n\nOn unix like systems, the underlying file corresponding to any given path may change at any time. This function makes it possible to set the permissions of the a file corresponding to a `File` object even if its path changes.\n\n@retep998, what's the best way to do this on Windows? I looked into `SetFileInformationByHandle` but couldn't find a way to do it atomically risking clobbering access time information.\n\nThis is a first step towards fixing #37885. This function doesn't *have* to be public but this is useful functionality that should probably be exposed.", "tree": {"sha": "d43904e10eb9fb0a67eec6b6cbbb5ece34257038", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d43904e10eb9fb0a67eec6b6cbbb5ece34257038"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ccdc26fd42dfccc5832114baa275f0936738095a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ccdc26fd42dfccc5832114baa275f0936738095a", "html_url": "https://github.com/rust-lang/rust/commit/ccdc26fd42dfccc5832114baa275f0936738095a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ccdc26fd42dfccc5832114baa275f0936738095a/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5196ca85189291adbb488339b321026a95330c45", "url": "https://api.github.com/repos/rust-lang/rust/commits/5196ca85189291adbb488339b321026a95330c45", "html_url": "https://github.com/rust-lang/rust/commit/5196ca85189291adbb488339b321026a95330c45"}, {"sha": "1aaca5f29069a05e1aed73e33dd314c069fde756", "url": "https://api.github.com/repos/rust-lang/rust/commits/1aaca5f29069a05e1aed73e33dd314c069fde756", "html_url": "https://github.com/rust-lang/rust/commit/1aaca5f29069a05e1aed73e33dd314c069fde756"}], "stats": {"total": 85, "additions": 85, "deletions": 0}, "files": [{"sha": "e91e808c5489a48a6a2d2cd03929e73384996a8d", "filename": "src/libstd/fs.rs", "status": "modified", "additions": 53, "deletions": 0, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/ccdc26fd42dfccc5832114baa275f0936738095a/src%2Flibstd%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ccdc26fd42dfccc5832114baa275f0936738095a/src%2Flibstd%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Ffs.rs?ref=ccdc26fd42dfccc5832114baa275f0936738095a", "patch": "@@ -348,6 +348,41 @@ impl File {\n             inner: self.inner.duplicate()?\n         })\n     }\n+\n+    /// Changes the permissions on the underlying file.\n+    ///\n+    /// # Platform-specific behavior\n+    ///\n+    /// This function currently corresponds to the `fchmod` function on Unix and\n+    /// the `SetFileInformationByHandle` function on Windows. Note that, this\n+    /// [may change in the future][changes].\n+    ///\n+    /// [changes]: ../io/index.html#platform-specific-behavior\n+    ///\n+    /// # Errors\n+    ///\n+    /// This function will return an error if the user lacks permission change\n+    /// attributes on the underlying file. It may also return an error in other\n+    /// os-specific unspecified cases.\n+    ///\n+    /// # Examples\n+    ///\n+    /// ```\n+    /// #![feature(set_permissions_atomic)]\n+    /// # fn foo() -> std::io::Result<()> {\n+    /// use std::fs::File;\n+    ///\n+    /// let file = File::open(\"foo.txt\")?;\n+    /// let mut perms = file.metadata()?.permissions();\n+    /// perms.set_readonly(true);\n+    /// file.set_permissions(perms)?;\n+    /// # Ok(())\n+    /// # }\n+    /// ```\n+    #[unstable(feature = \"set_permissions_atomic\", issue=\"37916\")]\n+    pub fn set_permissions(&self, perm: Permissions) -> io::Result<()> {\n+        self.inner.set_permissions(perm.0)\n+    }\n }\n \n impl AsInner<fs_imp::File> for File {\n@@ -2469,6 +2504,24 @@ mod tests {\n         check!(fs::set_permissions(&file, p));\n     }\n \n+    #[test]\n+    fn fchmod_works() {\n+        let tmpdir = tmpdir();\n+        let path = tmpdir.join(\"in.txt\");\n+\n+        let file = check!(File::create(&path));\n+        let attr = check!(fs::metadata(&path));\n+        assert!(!attr.permissions().readonly());\n+        let mut p = attr.permissions();\n+        p.set_readonly(true);\n+        check!(file.set_permissions(p.clone()));\n+        let attr = check!(fs::metadata(&path));\n+        assert!(attr.permissions().readonly());\n+\n+        p.set_readonly(false);\n+        check!(file.set_permissions(p));\n+    }\n+\n     #[test]\n     fn sync_doesnt_kill_anything() {\n         let tmpdir = tmpdir();"}, {"sha": "9ee0458b5da365d1fae1c99bfa17fbdf0d20113f", "filename": "src/libstd/sys/unix/fs.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ccdc26fd42dfccc5832114baa275f0936738095a/src%2Flibstd%2Fsys%2Funix%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ccdc26fd42dfccc5832114baa275f0936738095a/src%2Flibstd%2Fsys%2Funix%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Funix%2Ffs.rs?ref=ccdc26fd42dfccc5832114baa275f0936738095a", "patch": "@@ -526,6 +526,11 @@ impl File {\n     pub fn fd(&self) -> &FileDesc { &self.0 }\n \n     pub fn into_fd(self) -> FileDesc { self.0 }\n+\n+    pub fn set_permissions(&self, perm: FilePermissions) -> io::Result<()> {\n+        cvt_r(|| unsafe { libc::fchmod(self.0.raw(), perm.mode) })?;\n+        Ok(())\n+    }\n }\n \n impl DirBuilder {"}, {"sha": "1a563127f7f0668d69ba11485abdadfd5f49aa7d", "filename": "src/libstd/sys/windows/c.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ccdc26fd42dfccc5832114baa275f0936738095a/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ccdc26fd42dfccc5832114baa275f0936738095a/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs?ref=ccdc26fd42dfccc5832114baa275f0936738095a", "patch": "@@ -389,6 +389,15 @@ pub enum FILE_INFO_BY_HANDLE_CLASS {\n     MaximumFileInfoByHandlesClass\n }\n \n+#[repr(C)]\n+pub struct FILE_BASIC_INFO {\n+    pub CreationTime: LARGE_INTEGER,\n+    pub LastAccessTime: LARGE_INTEGER,\n+    pub LastWriteTime: LARGE_INTEGER,\n+    pub ChangeTime: LARGE_INTEGER,\n+    pub FileAttributes: DWORD,\n+}\n+\n #[repr(C)]\n pub struct FILE_END_OF_FILE_INFO {\n     pub EndOfFile: LARGE_INTEGER,"}, {"sha": "7d7d78bbd87308315d75551a88c9ac5ef4558ac1", "filename": "src/libstd/sys/windows/fs.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ccdc26fd42dfccc5832114baa275f0936738095a/src%2Flibstd%2Fsys%2Fwindows%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ccdc26fd42dfccc5832114baa275f0936738095a/src%2Flibstd%2Fsys%2Fwindows%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Ffs.rs?ref=ccdc26fd42dfccc5832114baa275f0936738095a", "patch": "@@ -417,6 +417,24 @@ impl File {\n             Ok(PathBuf::from(OsString::from_wide(subst)))\n         }\n     }\n+\n+    pub fn set_permissions(&self, perm: FilePermissions) -> io::Result<()> {\n+        let mut info = c::FILE_BASIC_INFO {\n+            CreationTime: 0,\n+            LastAccessTime: 0,\n+            LastWriteTime: 0,\n+            ChangeTime: 0,\n+            FileAttributes: perm.attrs,\n+        };\n+        let size = mem::size_of_val(&info);\n+        cvt(unsafe {\n+            c::SetFileInformationByHandle(self.handle.raw(),\n+                                          c::FileBasicInfo,\n+                                          &mut info as *mut _ as *mut _,\n+                                          size as c::DWORD)\n+        })?;\n+        Ok(())\n+    }\n }\n \n impl FromInner<c::HANDLE> for File {"}]}