{"sha": "9ba55bad4f37edb58379ca72f4bcd6684c36e9e1", "node_id": "C_kwDOAAsO6NoAKDliYTU1YmFkNGYzN2VkYjU4Mzc5Y2E3MmY0YmNkNjY4NGMzNmU5ZTE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-27T15:43:57Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-27T15:43:57Z"}, "message": "Auto merge of #13202 - Veykril:cancelled-retry, r=Veykril\n\nDon't retry requests that have already been cancelled", "tree": {"sha": "e70f84ca744794c271e42f83c0e97a039c807850", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e70f84ca744794c271e42f83c0e97a039c807850"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1", "html_url": "https://github.com/rust-lang/rust/commit/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b16b0413dc088f5daa5fd1800d016a31bd2cfecf", "url": "https://api.github.com/repos/rust-lang/rust/commits/b16b0413dc088f5daa5fd1800d016a31bd2cfecf", "html_url": "https://github.com/rust-lang/rust/commit/b16b0413dc088f5daa5fd1800d016a31bd2cfecf"}, {"sha": "1a6c1595fe6645f4dda511465e41f781c3206d09", "url": "https://api.github.com/repos/rust-lang/rust/commits/1a6c1595fe6645f4dda511465e41f781c3206d09", "html_url": "https://github.com/rust-lang/rust/commit/1a6c1595fe6645f4dda511465e41f781c3206d09"}], "stats": {"total": 43, "additions": 28, "deletions": 15}, "files": [{"sha": "93b7f746e01bc7c3834b572cb0e4a5159ec24b24", "filename": "Cargo.lock", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=9ba55bad4f37edb58379ca72f4bcd6684c36e9e1", "patch": "@@ -863,7 +863,7 @@ dependencies = [\n \n [[package]]\n name = \"lsp-server\"\n-version = \"0.6.0\"\n+version = \"0.7.0\"\n dependencies = [\n  \"crossbeam-channel\",\n  \"log\",\n@@ -1502,18 +1502,18 @@ dependencies = [\n \n [[package]]\n name = \"serde\"\n-version = \"1.0.143\"\n+version = \"1.0.144\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"53e8e5d5b70924f74ff5c6d64d9a5acd91422117c60f48c4e07855238a254553\"\n+checksum = \"0f747710de3dcd43b88c9168773254e809d8ddbdf9653b84e2554ab219f17860\"\n dependencies = [\n  \"serde_derive\",\n ]\n \n [[package]]\n name = \"serde_derive\"\n-version = \"1.0.143\"\n+version = \"1.0.144\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"d3d8e8de557aee63c26b85b947f5e59b690d0454c753f3adeb5cd7835ab88391\"\n+checksum = \"94ed3a816fb1d101812f83e789f888322c34e291f894f19590dc310963e87a00\"\n dependencies = [\n  \"proc-macro2\",\n  \"quote\",\n@@ -1522,9 +1522,9 @@ dependencies = [\n \n [[package]]\n name = \"serde_json\"\n-version = \"1.0.83\"\n+version = \"1.0.85\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"38dd04e3c8279e75b31ef29dbdceebfe5ad89f4d0937213c53f7d49d01b3d5a7\"\n+checksum = \"e55a28e3aaef9d5ce0506d0a14dbba8054ddc7e499ef522dd8b26859ec9d4a44\"\n dependencies = [\n  \"indexmap\",\n  \"itoa\","}, {"sha": "71566d5de6e6f3680d4f815cfda27d77ec4bf4f1", "filename": "crates/rust-analyzer/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/crates%2Frust-analyzer%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/crates%2Frust-analyzer%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2FCargo.toml?ref=9ba55bad4f37edb58379ca72f4bcd6684c36e9e1", "patch": "@@ -34,7 +34,7 @@ threadpool = \"1.8.1\"\n rayon = \"1.5.3\"\n num_cpus = \"1.13.1\"\n mimalloc = { version = \"0.1.29\", default-features = false, optional = true }\n-lsp-server = { version = \"0.6.0\", path = \"../../lib/lsp-server\" }\n+lsp-server = { version = \"0.7.0\", path = \"../../lib/lsp-server\" }\n tracing = \"0.1.35\"\n tracing-subscriber = { version = \"0.3.14\", default-features = false, features = [\n     \"env-filter\","}, {"sha": "000ff88e458f6e4256a227138490369d9cbbbfb1", "filename": "crates/rust-analyzer/src/global_state.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs?ref=9ba55bad4f37edb58379ca72f4bcd6684c36e9e1", "patch": "@@ -354,6 +354,10 @@ impl GlobalState {\n         }\n     }\n \n+    pub(crate) fn is_completed(&self, request: &lsp_server::Request) -> bool {\n+        self.req_queue.incoming.is_completed(&request.id)\n+    }\n+\n     fn send(&mut self, message: lsp_server::Message) {\n         self.sender.send(message).unwrap()\n     }"}, {"sha": "c64d557a118f266097557f7a55c4ea98bc56b55e", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=9ba55bad4f37edb58379ca72f4bcd6684c36e9e1", "patch": "@@ -425,7 +425,9 @@ impl GlobalState {\n     fn handle_task(&mut self, prime_caches_progress: &mut Vec<PrimeCachesProgress>, task: Task) {\n         match task {\n             Task::Response(response) => self.respond(response),\n-            Task::Retry(req) => self.on_request(req),\n+            // Only retry requests that haven't been cancelled. Otherwise we do unnecessary work.\n+            Task::Retry(req) if self.is_completed(&req) => self.on_request(req),\n+            Task::Retry(_) => (),\n             Task::Diagnostics(diagnostics_per_file) => {\n                 for (file_id, diagnostics) in diagnostics_per_file {\n                     self.diagnostics.set_native_diagnostics(file_id, diagnostics)"}, {"sha": "b236b156cf99a505fec68c9302328211480b1e78", "filename": "lib/lsp-server/Cargo.toml", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/lib%2Flsp-server%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/lib%2Flsp-server%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/lib%2Flsp-server%2FCargo.toml?ref=9ba55bad4f37edb58379ca72f4bcd6684c36e9e1", "patch": "@@ -1,16 +1,16 @@\n [package]\n name = \"lsp-server\"\n-version = \"0.6.0\"\n+version = \"0.7.0\"\n description = \"Generic LSP server scaffold.\"\n license = \"MIT OR Apache-2.0\"\n repository = \"https://github.com/rust-lang/rust-analyzer/tree/master/lib/lsp-server\"\n edition = \"2021\"\n \n [dependencies]\n log = \"0.4.17\"\n-serde_json = \"1.0.81\"\n-serde = { version = \"1.0.137\", features = [\"derive\"] }\n-crossbeam-channel = \"0.5.5\"\n+serde_json = \"1.0.85\"\n+serde = { version = \"1.0.144\", features = [\"derive\"] }\n+crossbeam-channel = \"0.5.6\"\n \n [dev-dependencies]\n-lsp-types = \"0.93.0\"\n+lsp-types = \"0.93.1\""}, {"sha": "b241561f9c0ddc80f4b821a01a46ddece489e8b4", "filename": "lib/lsp-server/src/msg.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/lib%2Flsp-server%2Fsrc%2Fmsg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/lib%2Flsp-server%2Fsrc%2Fmsg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/lib%2Flsp-server%2Fsrc%2Fmsg.rs?ref=9ba55bad4f37edb58379ca72f4bcd6684c36e9e1", "patch": "@@ -98,7 +98,7 @@ pub struct ResponseError {\n }\n \n #[derive(Clone, Copy, Debug)]\n-#[allow(unused)]\n+#[non_exhaustive]\n pub enum ErrorCode {\n     // Defined by JSON RPC:\n     ParseError = -32700,"}, {"sha": "e5f19be20b069d5a7df710fe1fcf6a0a6913dccf", "filename": "lib/lsp-server/src/req_queue.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/lib%2Flsp-server%2Fsrc%2Freq_queue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ba55bad4f37edb58379ca72f4bcd6684c36e9e1/lib%2Flsp-server%2Fsrc%2Freq_queue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/lib%2Flsp-server%2Fsrc%2Freq_queue.rs?ref=9ba55bad4f37edb58379ca72f4bcd6684c36e9e1", "patch": "@@ -35,6 +35,7 @@ impl<I> Incoming<I> {\n     pub fn register(&mut self, id: RequestId, data: I) {\n         self.pending.insert(id, data);\n     }\n+\n     pub fn cancel(&mut self, id: RequestId) -> Option<Response> {\n         let _data = self.complete(id.clone())?;\n         let error = ResponseError {\n@@ -44,9 +45,14 @@ impl<I> Incoming<I> {\n         };\n         Some(Response { id, result: None, error: Some(error) })\n     }\n+\n     pub fn complete(&mut self, id: RequestId) -> Option<I> {\n         self.pending.remove(&id)\n     }\n+\n+    pub fn is_completed(&self, id: &RequestId) -> bool {\n+        !self.pending.contains_key(id)\n+    }\n }\n \n impl<O> Outgoing<O> {\n@@ -56,6 +62,7 @@ impl<O> Outgoing<O> {\n         self.next_id += 1;\n         Request::new(id, method, params)\n     }\n+\n     pub fn complete(&mut self, id: RequestId) -> Option<O> {\n         self.pending.remove(&id)\n     }"}]}