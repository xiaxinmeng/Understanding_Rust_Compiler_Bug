{"sha": "cbcbba24ac3e435e870499e833606880e039f33c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNiY2JiYTI0YWMzZTQzNWU4NzA0OTllODMzNjA2ODgwZTAzOWYzM2M=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-10-25T11:12:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-10-25T11:12:54Z"}, "message": "Rollup merge of #65789 - Centril:with-desugared-doc, r=davidtwco\n\nmove Attribute::with_desugared_doc to librustdoc\n\nFrom https://github.com/rust-lang/rust/pull/65324.\n\nr? @varkor", "tree": {"sha": "14874ef711ef794637041f8aba332cf27160a6c8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/14874ef711ef794637041f8aba332cf27160a6c8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cbcbba24ac3e435e870499e833606880e039f33c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdsti2CRBK7hj4Ov3rIwAAdHIIAAgFoRydr3aF9Bn5hjiqsLvb\nHJE/hJsxGy68E31/0Ggka+Mju4KvURm2mHR6gcLUjDxrEJRest6OyhK4wPmcJX7d\nn9rjsDtYHp1E7mc14tgpXC/IZTw169BnN2GxSkzYNkIm6nH1lWX+uAG4fuxjMIeT\n0JsJrOSXcpqrJb3o8+0XN0wzFgmHvf8UuJM/mUxnwcNZEArLIdC2/8tPxkbSHnA3\nlTPNWTdkwVn4nND5JUITxg7U/KzRvUJaQqIcdrVWyARRIP8JzFsSnVtUM6eSmK9U\n5Y0xwaDyoCrt9HhiqWIRb4aVYv9TS1L1BkpyTio55KGG4sX80R9l10FJwtYQ9dE=\n=siSi\n-----END PGP SIGNATURE-----\n", "payload": "tree 14874ef711ef794637041f8aba332cf27160a6c8\nparent 0bfe483c5c5c89d4ea6e703f06b05863ea8429fe\nparent 9e3e3a470e4e04ff72148e94ead8d50272842da1\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1572001974 +0200\ncommitter GitHub <noreply@github.com> 1572001974 +0200\n\nRollup merge of #65789 - Centril:with-desugared-doc, r=davidtwco\n\nmove Attribute::with_desugared_doc to librustdoc\n\nFrom https://github.com/rust-lang/rust/pull/65324.\n\nr? @varkor\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cbcbba24ac3e435e870499e833606880e039f33c", "html_url": "https://github.com/rust-lang/rust/commit/cbcbba24ac3e435e870499e833606880e039f33c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cbcbba24ac3e435e870499e833606880e039f33c/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0bfe483c5c5c89d4ea6e703f06b05863ea8429fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/0bfe483c5c5c89d4ea6e703f06b05863ea8429fe", "html_url": "https://github.com/rust-lang/rust/commit/0bfe483c5c5c89d4ea6e703f06b05863ea8429fe"}, {"sha": "9e3e3a470e4e04ff72148e94ead8d50272842da1", "url": "https://api.github.com/repos/rust-lang/rust/commits/9e3e3a470e4e04ff72148e94ead8d50272842da1", "html_url": "https://github.com/rust-lang/rust/commit/9e3e3a470e4e04ff72148e94ead8d50272842da1"}], "stats": {"total": 62, "additions": 31, "deletions": 31}, "files": [{"sha": "a642491b28181145e59f4b4f01b68f3ba9fa9918", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 26, "deletions": 2, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/cbcbba24ac3e435e870499e833606880e039f33c/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbcbba24ac3e435e870499e833606880e039f33c/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=cbcbba24ac3e435e870499e833606880e039f33c", "patch": "@@ -26,9 +26,10 @@ use rustc::ty::{self, DefIdTree, TyCtxt, Region, RegionVid, Ty, AdtKind};\n use rustc::ty::fold::TypeFolder;\n use rustc::ty::layout::VariantIdx;\n use rustc::util::nodemap::{FxHashMap, FxHashSet};\n-use syntax::ast::{self, AttrStyle, Ident};\n+use syntax::ast::{self, Attribute, AttrStyle, AttrItem, Ident};\n use syntax::attr;\n use syntax_expand::base::MacroKind;\n+use syntax::parse::lexer::comments;\n use syntax::source_map::DUMMY_SP;\n use syntax::symbol::{Symbol, kw, sym};\n use syntax_pos::{self, Pos, FileName};\n@@ -858,8 +859,31 @@ impl Attributes {\n         let mut cfg = Cfg::True;\n         let mut doc_line = 0;\n \n+        /// Converts `attr` to a normal `#[doc=\"foo\"]` comment, if it is a\n+        /// comment like `///` or `/** */`. (Returns `attr` unchanged for\n+        /// non-sugared doc attributes.)\n+        pub fn with_desugared_doc<T>(attr: &Attribute, f: impl FnOnce(&Attribute) -> T) -> T {\n+            if attr.is_sugared_doc {\n+                let comment = attr.value_str().unwrap();\n+                let meta = attr::mk_name_value_item_str(\n+                    Ident::with_dummy_span(sym::doc),\n+                    Symbol::intern(&comments::strip_doc_comment_decoration(&comment.as_str())),\n+                    DUMMY_SP,\n+                );\n+                f(&Attribute {\n+                    item: AttrItem { path: meta.path, tokens: meta.kind.tokens(meta.span) },\n+                    id: attr.id,\n+                    style: attr.style,\n+                    is_sugared_doc: true,\n+                    span: attr.span,\n+                })\n+            } else {\n+                f(attr)\n+            }\n+        }\n+\n         let other_attrs = attrs.iter().filter_map(|attr| {\n-            attr.with_desugared_doc(|attr| {\n+            with_desugared_doc(attr, |attr| {\n                 if attr.check_name(sym::doc) {\n                     if let Some(mi) = attr.meta() {\n                         if let Some(value) = mi.value_str() {"}, {"sha": "27de084ae98ca25fc688eddc3d42f261c18721c3", "filename": "src/libsyntax/attr/mod.rs", "status": "modified", "additions": 2, "deletions": 27, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/cbcbba24ac3e435e870499e833606880e039f33c/src%2Flibsyntax%2Fattr%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbcbba24ac3e435e870499e833606880e039f33c/src%2Flibsyntax%2Fattr%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fattr%2Fmod.rs?ref=cbcbba24ac3e435e870499e833606880e039f33c", "patch": "@@ -13,8 +13,8 @@ use crate::ast::{AttrItem, AttrId, AttrStyle, Name, Ident, Path, PathSegment};\n use crate::ast::{MetaItem, MetaItemKind, NestedMetaItem};\n use crate::ast::{Lit, LitKind, Expr, Item, Local, Stmt, StmtKind, GenericParam};\n use crate::mut_visit::visit_clobber;\n-use crate::source_map::{BytePos, Spanned, DUMMY_SP};\n-use crate::parse::lexer::comments::{doc_comment_style, strip_doc_comment_decoration};\n+use crate::source_map::{BytePos, Spanned};\n+use crate::parse::lexer::comments::doc_comment_style;\n use crate::parse::parser::Parser;\n use crate::parse::PResult;\n use crate::parse::token::{self, Token};\n@@ -312,31 +312,6 @@ impl Attribute {\n             span: self.span,\n         })\n     }\n-\n-    /// Converts `self` to a normal `#[doc=\"foo\"]` comment, if it is a\n-    /// comment like `///` or `/** */`. (Returns `self` unchanged for\n-    /// non-sugared doc attributes.)\n-    pub fn with_desugared_doc<T, F>(&self, f: F) -> T where\n-        F: FnOnce(&Attribute) -> T,\n-    {\n-        if self.is_sugared_doc {\n-            let comment = self.value_str().unwrap();\n-            let meta = mk_name_value_item_str(\n-                Ident::with_dummy_span(sym::doc),\n-                Symbol::intern(&strip_doc_comment_decoration(&comment.as_str())),\n-                DUMMY_SP,\n-            );\n-            f(&Attribute {\n-                item: AttrItem { path: meta.path, tokens: meta.kind.tokens(meta.span) },\n-                id: self.id,\n-                style: self.style,\n-                is_sugared_doc: true,\n-                span: self.span,\n-            })\n-        } else {\n-            f(self)\n-        }\n-    }\n }\n \n /* Constructors */"}, {"sha": "ac79ce323bf97ef36e903f2ec4e31f79ff424722", "filename": "src/libsyntax/parse/lexer/comments.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cbcbba24ac3e435e870499e833606880e039f33c/src%2Flibsyntax%2Fparse%2Flexer%2Fcomments.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbcbba24ac3e435e870499e833606880e039f33c/src%2Flibsyntax%2Fparse%2Flexer%2Fcomments.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Flexer%2Fcomments.rs?ref=cbcbba24ac3e435e870499e833606880e039f33c", "patch": "@@ -176,7 +176,7 @@ fn split_block_comment_into_lines(\n \n // it appears this function is called only from pprust... that's\n // probably not a good thing.\n-pub fn gather_comments(sess: &ParseSess, path: FileName, src: String) -> Vec<Comment> {\n+crate fn gather_comments(sess: &ParseSess, path: FileName, src: String) -> Vec<Comment> {\n     let cm = SourceMap::new(sess.source_map().path_mapping().clone());\n     let source_file = cm.new_source_file(path, src);\n     let text = (*source_file.src.as_ref().unwrap()).clone();"}, {"sha": "853723de14f44b2b7870f369b5dccedd5c8a26f6", "filename": "src/libsyntax/parse/lexer/tokentrees.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cbcbba24ac3e435e870499e833606880e039f33c/src%2Flibsyntax%2Fparse%2Flexer%2Ftokentrees.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbcbba24ac3e435e870499e833606880e039f33c/src%2Flibsyntax%2Fparse%2Flexer%2Ftokentrees.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Flexer%2Ftokentrees.rs?ref=cbcbba24ac3e435e870499e833606880e039f33c", "patch": "@@ -1,8 +1,9 @@\n use rustc_data_structures::fx::FxHashMap;\n use syntax_pos::Span;\n \n+use super::{StringReader, UnmatchedBrace};\n+\n use crate::print::pprust::token_to_string;\n-use crate::parse::lexer::{StringReader, UnmatchedBrace};\n use crate::parse::token::{self, Token};\n use crate::parse::PResult;\n use crate::tokenstream::{DelimSpan, IsJoint::{self, *}, TokenStream, TokenTree, TreeAndJoint};"}]}