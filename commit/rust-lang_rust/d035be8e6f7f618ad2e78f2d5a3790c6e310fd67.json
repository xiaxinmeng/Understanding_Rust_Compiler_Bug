{"sha": "d035be8e6f7f618ad2e78f2d5a3790c6e310fd67", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQwMzViZThlNmY3ZjYxOGFkMmU3OGYyZDVhMzc5MGM2ZTMxMGZkNjc=", "commit": {"author": {"name": "\u00d6mer Sinan A\u011facan", "email": "omeragacan@gmail.com", "date": "2021-01-24T07:32:24Z"}, "committer": {"name": "\u00d6mer Sinan A\u011facan", "email": "omeragacan@gmail.com", "date": "2021-01-26T06:09:15Z"}, "message": "typeck: Don't suggest converting LHS exprs\n\nConverting LHS of an assignment does not work, so avoid suggesting that.\n\nFixes #81293", "tree": {"sha": "f87fb1f031a9585f2256ed9001a9428b5f91ba81", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f87fb1f031a9585f2256ed9001a9428b5f91ba81"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d035be8e6f7f618ad2e78f2d5a3790c6e310fd67", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d035be8e6f7f618ad2e78f2d5a3790c6e310fd67", "html_url": "https://github.com/rust-lang/rust/commit/d035be8e6f7f618ad2e78f2d5a3790c6e310fd67", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d035be8e6f7f618ad2e78f2d5a3790c6e310fd67/comments", "author": {"login": "osa1", "id": 448274, "node_id": "MDQ6VXNlcjQ0ODI3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/448274?v=4", "gravatar_id": "", "url": "https://api.github.com/users/osa1", "html_url": "https://github.com/osa1", "followers_url": "https://api.github.com/users/osa1/followers", "following_url": "https://api.github.com/users/osa1/following{/other_user}", "gists_url": "https://api.github.com/users/osa1/gists{/gist_id}", "starred_url": "https://api.github.com/users/osa1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/osa1/subscriptions", "organizations_url": "https://api.github.com/users/osa1/orgs", "repos_url": "https://api.github.com/users/osa1/repos", "events_url": "https://api.github.com/users/osa1/events{/privacy}", "received_events_url": "https://api.github.com/users/osa1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "osa1", "id": 448274, "node_id": "MDQ6VXNlcjQ0ODI3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/448274?v=4", "gravatar_id": "", "url": "https://api.github.com/users/osa1", "html_url": "https://github.com/osa1", "followers_url": "https://api.github.com/users/osa1/followers", "following_url": "https://api.github.com/users/osa1/following{/other_user}", "gists_url": "https://api.github.com/users/osa1/gists{/gist_id}", "starred_url": "https://api.github.com/users/osa1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/osa1/subscriptions", "organizations_url": "https://api.github.com/users/osa1/orgs", "repos_url": "https://api.github.com/users/osa1/repos", "events_url": "https://api.github.com/users/osa1/events{/privacy}", "received_events_url": "https://api.github.com/users/osa1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ff6ee2a70218543f410e557f390e246131847572", "url": "https://api.github.com/repos/rust-lang/rust/commits/ff6ee2a70218543f410e557f390e246131847572", "html_url": "https://github.com/rust-lang/rust/commit/ff6ee2a70218543f410e557f390e246131847572"}], "stats": {"total": 51, "additions": 51, "deletions": 0}, "files": [{"sha": "3598a4cb4898d2f51515941d4297adcb96ad42dc", "filename": "compiler/rustc_middle/src/hir/map/mod.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/d035be8e6f7f618ad2e78f2d5a3790c6e310fd67/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d035be8e6f7f618ad2e78f2d5a3790c6e310fd67/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs?ref=d035be8e6f7f618ad2e78f2d5a3790c6e310fd67", "patch": "@@ -564,6 +564,17 @@ impl<'hir> Map<'hir> {\n         )\n     }\n \n+    /// Checks if the node is left-hand side of an assignment.\n+    pub fn is_lhs(&self, id: HirId) -> bool {\n+        match self.find(self.get_parent_node(id)) {\n+            Some(Node::Expr(expr)) => match expr.kind {\n+                ExprKind::Assign(lhs, _rhs, _span) => lhs.hir_id == id,\n+                _ => false,\n+            },\n+            _ => false,\n+        }\n+    }\n+\n     /// Whether the expression pointed at by `hir_id` belongs to a `const` evaluation context.\n     /// Used exclusively for diagnostics, to avoid suggestion function calls.\n     pub fn is_inside_const_context(&self, hir_id: HirId) -> bool {"}, {"sha": "3c9c683f4b0cb4c89bcc75da7aa18c3673734af4", "filename": "compiler/rustc_typeck/src/check/demand.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d035be8e6f7f618ad2e78f2d5a3790c6e310fd67/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fdemand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d035be8e6f7f618ad2e78f2d5a3790c6e310fd67/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fdemand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fdemand.rs?ref=d035be8e6f7f618ad2e78f2d5a3790c6e310fd67", "patch": "@@ -816,6 +816,13 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             |err: &mut DiagnosticBuilder<'_>,\n              found_to_exp_is_fallible: bool,\n              exp_to_found_is_fallible: bool| {\n+                let exp_is_lhs =\n+                    expected_ty_expr.map(|e| self.tcx.hir().is_lhs(e.hir_id)).unwrap_or(false);\n+\n+                if exp_is_lhs {\n+                    return;\n+                }\n+\n                 let always_fallible = found_to_exp_is_fallible\n                     && (exp_to_found_is_fallible || expected_ty_expr.is_none());\n                 let msg = if literal_is_ty_suffixed(expr) {"}, {"sha": "076b8c944b8a4d79869e1058f148dd72ca5428e8", "filename": "src/test/ui/typeck/issue-81293.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d035be8e6f7f618ad2e78f2d5a3790c6e310fd67/src%2Ftest%2Fui%2Ftypeck%2Fissue-81293.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d035be8e6f7f618ad2e78f2d5a3790c6e310fd67/src%2Ftest%2Fui%2Ftypeck%2Fissue-81293.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-81293.rs?ref=d035be8e6f7f618ad2e78f2d5a3790c6e310fd67", "patch": "@@ -0,0 +1,9 @@\n+fn main() {\n+    let a: u16;\n+    let b: u16 = 42;\n+    let c: usize = 5;\n+\n+    a = c + b * 5; //~ ERROR: mismatched types [E0308]\n+                   //~| ERROR: mismatched types [E0308]\n+                   //~| ERROR: cannot add `u16` to `usize` [E0277]\n+}"}, {"sha": "1e6ff3b5f9ee752ed72fc8dc2a7bdb11d1dc056c", "filename": "src/test/ui/typeck/issue-81293.stderr", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/d035be8e6f7f618ad2e78f2d5a3790c6e310fd67/src%2Ftest%2Fui%2Ftypeck%2Fissue-81293.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d035be8e6f7f618ad2e78f2d5a3790c6e310fd67/src%2Ftest%2Fui%2Ftypeck%2Fissue-81293.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-81293.stderr?ref=d035be8e6f7f618ad2e78f2d5a3790c6e310fd67", "patch": "@@ -0,0 +1,24 @@\n+error[E0308]: mismatched types\n+  --> $DIR/issue-81293.rs:6:13\n+   |\n+LL |     a = c + b * 5;\n+   |             ^^^^^ expected `usize`, found `u16`\n+\n+error[E0308]: mismatched types\n+  --> $DIR/issue-81293.rs:6:9\n+   |\n+LL |     a = c + b * 5;\n+   |         ^^^^^^^^^ expected `u16`, found `usize`\n+\n+error[E0277]: cannot add `u16` to `usize`\n+  --> $DIR/issue-81293.rs:6:11\n+   |\n+LL |     a = c + b * 5;\n+   |           ^ no implementation for `usize + u16`\n+   |\n+   = help: the trait `Add<u16>` is not implemented for `usize`\n+\n+error: aborting due to 3 previous errors\n+\n+Some errors have detailed explanations: E0277, E0308.\n+For more information about an error, try `rustc --explain E0277`."}]}