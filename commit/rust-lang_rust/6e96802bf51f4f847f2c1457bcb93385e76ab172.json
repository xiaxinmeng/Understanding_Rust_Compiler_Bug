{"sha": "6e96802bf51f4f847f2c1457bcb93385e76ab172", "node_id": "C_kwDOAAsO6NoAKDZlOTY4MDJiZjUxZjRmODQ3ZjJjMTQ1N2JjYjkzMzg1ZTc2YWIxNzI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-06T04:20:18Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-06T04:20:18Z"}, "message": "Auto merge of #107129 - wesleywiser:musl_1.2_upgrade, r=petrochenkov\n\nUpdate the version of musl used on `*-linux-musl` targets to 1.2.3\n\nUpdate the version of musl used on our Linux musl targets from 1.1.24 to 1.2.3 as proposed in rust-lang/compiler-team#572. musl 1.2.3 is the latest version of musl and supports the same range of Linux kernels as the 1.1 series. As such, it does not affect the minimum supported version of Linux for any of the musl targets.\n\nOne of the major musl 1.2 features is support for [time64](https://musl.libc.org/time64.html). This support is both source and ABI compatible with programs built against musl 1.1 and so updating the musl version for these targets should not cause Rust programs to fail to run or compile (a [crater run](https://github.com/rust-lang/rust/pull/107129#issuecomment-1407196104) has been completed which demonstrates this for the `i686-unknown-linux-musl` target).\n\nOnce this change reaches stable, the `libc` crate will then be able to [update their definitions to support 64-bit time](https://github.com/rust-lang/libc/pull/3068), matching the default musl 1.2 APIs exactly.\n\nFixes #91178", "tree": {"sha": "64f1a7080d3137b56a379b78dbf2f198422103bc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/64f1a7080d3137b56a379b78dbf2f198422103bc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6e96802bf51f4f847f2c1457bcb93385e76ab172", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6e96802bf51f4f847f2c1457bcb93385e76ab172", "html_url": "https://github.com/rust-lang/rust/commit/6e96802bf51f4f847f2c1457bcb93385e76ab172", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6e96802bf51f4f847f2c1457bcb93385e76ab172/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6d140d59bb957903b02ddb993450509d8d92b448", "url": "https://api.github.com/repos/rust-lang/rust/commits/6d140d59bb957903b02ddb993450509d8d92b448", "html_url": "https://github.com/rust-lang/rust/commit/6d140d59bb957903b02ddb993450509d8d92b448"}, {"sha": "cb93f92b84d34f4e84748848690359a54ed14df7", "url": "https://api.github.com/repos/rust-lang/rust/commits/cb93f92b84d34f4e84748848690359a54ed14df7", "html_url": "https://github.com/rust-lang/rust/commit/cb93f92b84d34f4e84748848690359a54ed14df7"}], "stats": {"total": 23, "additions": 7, "deletions": 16}, "files": [{"sha": "3ac5343aa575dabb04798c111eff89676dbc56c7", "filename": "src/ci/docker/host-x86_64/dist-arm-linux/Dockerfile", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6e96802bf51f4f847f2c1457bcb93385e76ab172/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-arm-linux%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/6e96802bf51f4f847f2c1457bcb93385e76ab172/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-arm-linux%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-arm-linux%2FDockerfile?ref=6e96802bf51f4f847f2c1457bcb93385e76ab172", "patch": "@@ -8,7 +8,6 @@ RUN sh /scripts/crosstool-ng.sh\n \n WORKDIR /build\n \n-COPY scripts/musl-patch-configure.diff /build/\n COPY scripts/musl-toolchain.sh /build/\n # We need to mitigate rust-lang/rust#34978 when compiling musl itself as well\n RUN CFLAGS=\"-Wa,--compress-debug-sections=none -Wl,--compress-debug-sections=none\" \\"}, {"sha": "6f04dcad9a54fe44cb307e55e312aad5cb4a7123", "filename": "src/ci/docker/host-x86_64/dist-x86_64-musl/Dockerfile", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6e96802bf51f4f847f2c1457bcb93385e76ab172/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-musl%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/6e96802bf51f4f847f2c1457bcb93385e76ab172/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-musl%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-musl%2FDockerfile?ref=6e96802bf51f4f847f2c1457bcb93385e76ab172", "patch": "@@ -25,7 +25,6 @@ WORKDIR /build/\n COPY scripts/cmake.sh /scripts/\n RUN /scripts/cmake.sh\n \n-COPY scripts/musl-patch-configure.diff /build/\n COPY scripts/musl-toolchain.sh /build/\n # We need to mitigate rust-lang/rust#34978 when compiling musl itself as well\n RUN CFLAGS=\"-Wa,-mrelax-relocations=no -Wa,--compress-debug-sections=none -Wl,--compress-debug-sections=none\" \\"}, {"sha": "1dc7b7987243887529959bb90f94a64a4918df85", "filename": "src/ci/docker/host-x86_64/test-various/Dockerfile", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6e96802bf51f4f847f2c1457bcb93385e76ab172/src%2Fci%2Fdocker%2Fhost-x86_64%2Ftest-various%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/6e96802bf51f4f847f2c1457bcb93385e76ab172/src%2Fci%2Fdocker%2Fhost-x86_64%2Ftest-various%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Ftest-various%2FDockerfile?ref=6e96802bf51f4f847f2c1457bcb93385e76ab172", "patch": "@@ -33,7 +33,6 @@ RUN curl -sL --output ovmf-ia32.deb http://mirrors.kernel.org/ubuntu/pool/univer\n RUN dpkg -i ovmf-ia32.deb && rm ovmf-ia32.deb\n \n WORKDIR /build/\n-COPY scripts/musl-patch-configure.diff /build/\n COPY scripts/musl-toolchain.sh /build/\n RUN bash musl-toolchain.sh x86_64 && rm -rf build\n WORKDIR /"}, {"sha": "bc1b30e2d31ae204857f1202b9dc17efe14042a8", "filename": "src/ci/docker/scripts/musl-toolchain.sh", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/6e96802bf51f4f847f2c1457bcb93385e76ab172/src%2Fci%2Fdocker%2Fscripts%2Fmusl-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/6e96802bf51f4f847f2c1457bcb93385e76ab172/src%2Fci%2Fdocker%2Fscripts%2Fmusl-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fmusl-toolchain.sh?ref=6e96802bf51f4f847f2c1457bcb93385e76ab172", "patch": "@@ -4,7 +4,7 @@\n #\n # Versions of the toolchain components are configurable in `musl-cross-make/Makefile` and\n # musl unlike GLIBC is forward compatible so upgrading it shouldn't break old distributions.\n-# Right now we have: Binutils 2.31.1, GCC 9.2.0, musl 1.1.24.\n+# Right now we have: Binutils 2.31.1, GCC 9.2.0, musl 1.2.3.\n \n # ignore-tidy-linelength\n \n@@ -32,6 +32,7 @@ TARGET=$ARCH-linux-musl\n \n # Don't depend on the mirrors of sabotage linux that musl-cross-make uses.\n LINUX_HEADERS_SITE=https://ci-mirrors.rust-lang.org/rustc/sabotage-linux-tarballs\n+LINUX_VER=headers-4.19.88\n \n OUTPUT=/usr/local\n shift\n@@ -44,18 +45,11 @@ export CFLAGS=\"-fPIC -g1 $CFLAGS\"\n \n git clone https://github.com/richfelker/musl-cross-make # -b v0.9.9\n cd musl-cross-make\n-# A few commits ahead of v0.9.9 to include the cowpatch fix:\n-git checkout a54eb56f33f255dfca60be045f12a5cfaf5a72a9\n+# A version that includes support for building musl 1.2.3\n+git checkout fe915821b652a7fa37b34a596f47d8e20bc72338\n \n-# Fix the cfi detection script in musl's configure so cfi is generated\n-# when debug info is asked for. This patch is derived from\n-# https://git.musl-libc.org/cgit/musl/commit/?id=c4d4028dde90562f631edf559fbc42d8ec1b29de.\n-# When we upgrade to a version that includes this commit, we can remove the patch.\n-mkdir patches/musl-1.1.24\n-cp ../musl-patch-configure.diff patches/musl-1.1.24/0001-fix-cfi-detection.diff\n-\n-hide_output make -j$(nproc) TARGET=$TARGET MUSL_VER=1.1.24 LINUX_HEADERS_SITE=$LINUX_HEADERS_SITE\n-hide_output make install TARGET=$TARGET MUSL_VER=1.1.24 LINUX_HEADERS_SITE=$LINUX_HEADERS_SITE OUTPUT=$OUTPUT\n+hide_output make -j$(nproc) TARGET=$TARGET MUSL_VER=1.2.3 LINUX_HEADERS_SITE=$LINUX_HEADERS_SITE LINUX_VER=$LINUX_VER\n+hide_output make install TARGET=$TARGET MUSL_VER=1.2.3 LINUX_HEADERS_SITE=$LINUX_HEADERS_SITE LINUX_VER=$LINUX_VER OUTPUT=$OUTPUT\n \n cd -\n "}, {"sha": "ece8e6c15c0cbd3260168a228b4c376883e0bd26", "filename": "src/ci/docker/scripts/musl.sh", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6e96802bf51f4f847f2c1457bcb93385e76ab172/src%2Fci%2Fdocker%2Fscripts%2Fmusl.sh", "raw_url": "https://github.com/rust-lang/rust/raw/6e96802bf51f4f847f2c1457bcb93385e76ab172/src%2Fci%2Fdocker%2Fscripts%2Fmusl.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fmusl.sh?ref=6e96802bf51f4f847f2c1457bcb93385e76ab172", "patch": "@@ -25,7 +25,7 @@ shift\n # Apparently applying `-fPIC` everywhere allows them to link successfully.\n export CFLAGS=\"-fPIC $CFLAGS\"\n \n-MUSL=musl-1.1.24\n+MUSL=musl-1.2.3\n \n # may have been downloaded in a previous run\n if [ ! -d $MUSL ]; then"}]}