{"sha": "5d39f6a357a519226165af5614f381054f3c33ea", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVkMzlmNmEzNTdhNTE5MjI2MTY1YWY1NjE0ZjM4MTA1NGYzYzMzZWE=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2020-11-20T15:44:52Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2020-11-20T16:28:56Z"}, "message": "Don't wrap parens around expr in remove_dbg assist if its in conditions", "tree": {"sha": "696c39c005c76f9e718782d7c18152a84ca6f4dc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/696c39c005c76f9e718782d7c18152a84ca6f4dc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5d39f6a357a519226165af5614f381054f3c33ea", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5d39f6a357a519226165af5614f381054f3c33ea", "html_url": "https://github.com/rust-lang/rust/commit/5d39f6a357a519226165af5614f381054f3c33ea", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5d39f6a357a519226165af5614f381054f3c33ea/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "66db0d3cadd4fefd70543aba8eae57e8db99935a", "url": "https://api.github.com/repos/rust-lang/rust/commits/66db0d3cadd4fefd70543aba8eae57e8db99935a", "html_url": "https://github.com/rust-lang/rust/commit/66db0d3cadd4fefd70543aba8eae57e8db99935a"}], "stats": {"total": 71, "additions": 64, "deletions": 7}, "files": [{"sha": "eae6367c112e2091e18c254d84f86a72bb2d395e", "filename": "crates/assists/src/handlers/remove_dbg.rs", "status": "modified", "additions": 64, "deletions": 7, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/5d39f6a357a519226165af5614f381054f3c33ea/crates%2Fassists%2Fsrc%2Fhandlers%2Fremove_dbg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d39f6a357a519226165af5614f381054f3c33ea/crates%2Fassists%2Fsrc%2Fhandlers%2Fremove_dbg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Fhandlers%2Fremove_dbg.rs?ref=5d39f6a357a519226165af5614f381054f3c33ea", "patch": "@@ -1,6 +1,6 @@\n use syntax::{\n     ast::{self, AstNode},\n-    SyntaxElement, SyntaxKind, TextRange, TextSize, T,\n+    match_ast, SyntaxElement, SyntaxKind, TextRange, TextSize, T,\n };\n \n use crate::{AssistContext, AssistId, AssistKind, Assists};\n@@ -49,12 +49,29 @@ fn adjusted_macro_contents(macro_call: &ast::MacroCall) -> Option<String> {\n         macro_text_with_brackets.len() - TextSize::of(')'),\n     ));\n \n-    let is_leaf = macro_call.syntax().next_sibling().is_none();\n-    Some(if !is_leaf && needs_parentheses_around_macro_contents(contents) {\n-        format!(\"({})\", macro_text_in_brackets)\n-    } else {\n-        macro_text_in_brackets.to_string()\n-    })\n+    Some(\n+        if !is_leaf_or_control_flow_expr(macro_call)\n+            && needs_parentheses_around_macro_contents(contents)\n+        {\n+            format!(\"({})\", macro_text_in_brackets)\n+        } else {\n+            macro_text_in_brackets.to_string()\n+        },\n+    )\n+}\n+\n+fn is_leaf_or_control_flow_expr(macro_call: &ast::MacroCall) -> bool {\n+    macro_call.syntax().next_sibling().is_none()\n+        || match macro_call.syntax().parent() {\n+            Some(parent) => match_ast! {\n+                match parent {\n+                    ast::Condition(_it) => true,\n+                    ast::MatchExpr(_it) => true,\n+                    _ => false,\n+                }\n+            },\n+            None => false,\n+        }\n }\n \n /// Verifies that the given macro_call actually matches the given name\n@@ -361,4 +378,44 @@ fn main() {\n             r#\"let res = (foo..=bar).foo();\"#,\n         );\n     }\n+\n+    #[test]\n+    fn test_remove_dbg_followed_by_block() {\n+        check_assist(\n+            remove_dbg,\n+            r#\"fn foo() {\n+    if <|>dbg!(x || y) {}\n+}\"#,\n+            r#\"fn foo() {\n+    if x || y {}\n+}\"#,\n+        );\n+        check_assist(\n+            remove_dbg,\n+            r#\"fn foo() {\n+    while let foo = <|>dbg!(&x) {}\n+}\"#,\n+            r#\"fn foo() {\n+    while let foo = &x {}\n+}\"#,\n+        );\n+        check_assist(\n+            remove_dbg,\n+            r#\"fn foo() {\n+    if let foo = <|>dbg!(&x) {}\n+}\"#,\n+            r#\"fn foo() {\n+    if let foo = &x {}\n+}\"#,\n+        );\n+        check_assist(\n+            remove_dbg,\n+            r#\"fn foo() {\n+    match <|>dbg!(&x) {}\n+}\"#,\n+            r#\"fn foo() {\n+    match &x {}\n+}\"#,\n+        );\n+    }\n }"}]}