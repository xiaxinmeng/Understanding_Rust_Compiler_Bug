{"sha": "3312a3053bb9996e56a5ed58b6b9306224ada727", "node_id": "C_kwDOAAsO6NoAKDMzMTJhMzA1M2JiOTk5NmU1NmE1ZWQ1OGI2YjkzMDYyMjRhZGE3Mjc", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-15T02:23:32Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-15T02:23:32Z"}, "message": "Auto merge of #109802 - notriddle:notriddle/rustdoc-search-generics-nested, r=GuillaumeGomez\n\nrustdoc-search: add support for nested generics\n\nThis change allows `search.js` to parse nested generics (which look `Like<This<Example>>`) and match them. It maintains the existing \"bag semantics\", so that the order of type parameters is ignored but the number is required to be greater than or equal to what's in the query.\n\nFor example, a function with the signature `fn read_all(&mut self: impl Read) -> Result<Vec<u8>, Error>` will match these queries:\n\n* `Read -> Result<Vec<u8>, Error>`\n* `Read -> Result<Error, Vec>`\n* `Read -> Result<Vec<u8>>`\n\nBut it *does not* match `Result<Vec, u8>` or `Result<u8<Vec>>`.", "tree": {"sha": "83c3d3b4d996988e966b6f24886f1e2171973679", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/83c3d3b4d996988e966b6f24886f1e2171973679"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3312a3053bb9996e56a5ed58b6b9306224ada727", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3312a3053bb9996e56a5ed58b6b9306224ada727", "html_url": "https://github.com/rust-lang/rust/commit/3312a3053bb9996e56a5ed58b6b9306224ada727", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3312a3053bb9996e56a5ed58b6b9306224ada727/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fef27e038ee9886722548b70d0c7f75d7e666c72", "url": "https://api.github.com/repos/rust-lang/rust/commits/fef27e038ee9886722548b70d0c7f75d7e666c72", "html_url": "https://github.com/rust-lang/rust/commit/fef27e038ee9886722548b70d0c7f75d7e666c72"}, {"sha": "6ce53278e191f8047addc7f44b98e180bc80d66d", "url": "https://api.github.com/repos/rust-lang/rust/commits/6ce53278e191f8047addc7f44b98e180bc80d66d", "html_url": "https://github.com/rust-lang/rust/commit/6ce53278e191f8047addc7f44b98e180bc80d66d"}], "stats": {"total": 208, "additions": 195, "deletions": 13}, "files": [{"sha": "56342f65d9998e995197f912acf4a2ef2d2d7ca2", "filename": "src/doc/rustdoc/src/how-to-read-rustdoc.md", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/3312a3053bb9996e56a5ed58b6b9306224ada727/src%2Fdoc%2Frustdoc%2Fsrc%2Fhow-to-read-rustdoc.md", "raw_url": "https://github.com/rust-lang/rust/raw/3312a3053bb9996e56a5ed58b6b9306224ada727/src%2Fdoc%2Frustdoc%2Fsrc%2Fhow-to-read-rustdoc.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Fhow-to-read-rustdoc.md?ref=3312a3053bb9996e56a5ed58b6b9306224ada727", "patch": "@@ -94,6 +94,17 @@ can be matched with the following queries:\n * `trait:Iterator<primitive:u32> -> primitive:usize`\n * `Iterator -> usize`\n \n+Generics and function parameters are order-agnostic, but sensitive to nesting\n+and number of matches. For example, a function with the signature\n+`fn read_all(&mut self: impl Read) -> Result<Vec<u8>, Error>`\n+will match these queries:\n+\n+* `Read -> Result<Vec<u8>, Error>`\n+* `Read -> Result<Error, Vec>`\n+* `Read -> Result<Vec<u8>>`\n+\n+But it *does not* match `Result<Vec, u8>` or `Result<u8<Vec>>`.\n+\n ### Changing displayed theme\n \n You can change the displayed theme by opening the settings menu (the gear"}, {"sha": "929dae81c8de4d3af9bfd7ce6c3eba6b46712567", "filename": "src/librustdoc/html/static/js/search.js", "status": "modified", "additions": 10, "deletions": 11, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/3312a3053bb9996e56a5ed58b6b9306224ada727/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsearch.js", "raw_url": "https://github.com/rust-lang/rust/raw/3312a3053bb9996e56a5ed58b6b9306224ada727/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsearch.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsearch.js?ref=3312a3053bb9996e56a5ed58b6b9306224ada727", "patch": "@@ -461,9 +461,7 @@ function initSearch(rawSearchIndex) {\n         if (parserState.pos < parserState.length &&\n             parserState.userQuery[parserState.pos] === \"<\"\n         ) {\n-            if (isInGenerics) {\n-                throw [\"Unexpected \", \"<\", \" after \", \"<\"];\n-            } else if (start >= end) {\n+            if (start >= end) {\n                 throw [\"Found generics without a path\"];\n             }\n             parserState.pos += 1;\n@@ -765,13 +763,10 @@ function initSearch(rawSearchIndex) {\n      * ident = *(ALPHA / DIGIT / \"_\")\n      * path = ident *(DOUBLE-COLON ident) [!]\n      * arg = [type-filter *WS COLON *WS] path [generics]\n-     * arg-without-generic = [type-filter *WS COLON *WS] path\n      * type-sep = COMMA/WS *(COMMA/WS)\n      * nonempty-arg-list = *(type-sep) arg *(type-sep arg) *(type-sep)\n-     * nonempty-arg-list-without-generics = *(type-sep) arg-without-generic\n-     *                                      *(type-sep arg-without-generic) *(type-sep)\n-     * generics = OPEN-ANGLE-BRACKET [ nonempty-arg-list-without-generics ] *(type-sep)\n-     *            CLOSE-ANGLE-BRACKET/EOF\n+     * generics = OPEN-ANGLE-BRACKET [ nonempty-arg-list ] *(type-sep)\n+     *            CLOSE-ANGLE-BRACKET\n      * return-args = RETURN-ARROW *(type-sep) nonempty-arg-list\n      *\n      * exact-search = [type-filter *WS COLON] [ RETURN-ARROW ] *WS QUOTE ident QUOTE [ generics ]\n@@ -1127,7 +1122,7 @@ function initSearch(rawSearchIndex) {\n                         currentEntryElems = [];\n                         elems.set(entry.name, currentEntryElems);\n                     }\n-                    currentEntryElems.push(entry.ty);\n+                    currentEntryElems.push(entry);\n                 }\n                 // We need to find the type that matches the most to remove it in order\n                 // to move forward.\n@@ -1136,8 +1131,12 @@ function initSearch(rawSearchIndex) {\n                         return false;\n                     }\n                     const matchElems = elems.get(generic.name);\n-                    const matchIdx = matchElems.findIndex(tmp_elem =>\n-                        typePassesFilter(generic.typeFilter, tmp_elem));\n+                    const matchIdx = matchElems.findIndex(tmp_elem => {\n+                        if (checkGenerics(tmp_elem, generic, 0, maxEditDistance) !== 0) {\n+                            return false;\n+                        }\n+                        return typePassesFilter(generic.typeFilter, tmp_elem.ty);\n+                    });\n                     if (matchIdx === -1) {\n                         return false;\n                     }"}, {"sha": "5a2266dbe3697293bba4c820ad47eeac5b5e81cb", "filename": "tests/rustdoc-js-std/parser-generics.js", "status": "modified", "additions": 122, "deletions": 2, "changes": 124, "blob_url": "https://github.com/rust-lang/rust/blob/3312a3053bb9996e56a5ed58b6b9306224ada727/tests%2Frustdoc-js-std%2Fparser-generics.js", "raw_url": "https://github.com/rust-lang/rust/raw/3312a3053bb9996e56a5ed58b6b9306224ada727/tests%2Frustdoc-js-std%2Fparser-generics.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-js-std%2Fparser-generics.js?ref=3312a3053bb9996e56a5ed58b6b9306224ada727", "patch": "@@ -1,4 +1,11 @@\n-const QUERY = ['A<B<C<D>,  E>', 'p<> u8', '\"p\"<a>'];\n+const QUERY = [\n+    'A<B<C<D>,  E>',\n+    'p<> u8',\n+    '\"p\"<a>',\n+    'p<u<x>>',\n+    'p<u<x>, r>',\n+    'p<u<x, r>>',\n+];\n \n const PARSED = [\n     {\n@@ -7,7 +14,7 @@ const PARSED = [\n         original: 'A<B<C<D>,  E>',\n         returned: [],\n         userQuery: 'a<b<c<d>,  e>',\n-        error: 'Unexpected `<` after `<`',\n+        error: 'Unclosed `<`',\n     },\n     {\n         elems: [\n@@ -59,4 +66,117 @@ const PARSED = [\n         userQuery: '\"p\"<a>',\n         error: null,\n     },\n+    {\n+        elems: [\n+            {\n+                name: \"p\",\n+                fullPath: [\"p\"],\n+                pathWithoutLast: [],\n+                pathLast: \"p\",\n+                generics: [\n+                    {\n+                        name: \"u\",\n+                        fullPath: [\"u\"],\n+                        pathWithoutLast: [],\n+                        pathLast: \"u\",\n+                        generics: [\n+                            {\n+                                name: \"x\",\n+                                fullPath: [\"x\"],\n+                                pathWithoutLast: [],\n+                                pathLast: \"x\",\n+                                generics: [],\n+                            },\n+                        ],\n+                    },\n+                ],\n+                typeFilter: -1,\n+            },\n+        ],\n+        foundElems: 1,\n+        original: 'p<u<x>>',\n+        returned: [],\n+        userQuery: 'p<u<x>>',\n+        error: null,\n+    },\n+    {\n+        elems: [\n+            {\n+                name: \"p\",\n+                fullPath: [\"p\"],\n+                pathWithoutLast: [],\n+                pathLast: \"p\",\n+                generics: [\n+                    {\n+                        name: \"u\",\n+                        fullPath: [\"u\"],\n+                        pathWithoutLast: [],\n+                        pathLast: \"u\",\n+                        generics: [\n+                            {\n+                                name: \"x\",\n+                                fullPath: [\"x\"],\n+                                pathWithoutLast: [],\n+                                pathLast: \"x\",\n+                                generics: [],\n+                            },\n+                        ],\n+                    },\n+                    {\n+                        name: \"r\",\n+                        fullPath: [\"r\"],\n+                        pathWithoutLast: [],\n+                        pathLast: \"r\",\n+                        generics: [],\n+                    },\n+                ],\n+                typeFilter: -1,\n+            },\n+        ],\n+        foundElems: 1,\n+        original: 'p<u<x>, r>',\n+        returned: [],\n+        userQuery: 'p<u<x>, r>',\n+        error: null,\n+    },\n+    {\n+        elems: [\n+            {\n+                name: \"p\",\n+                fullPath: [\"p\"],\n+                pathWithoutLast: [],\n+                pathLast: \"p\",\n+                generics: [\n+                    {\n+                        name: \"u\",\n+                        fullPath: [\"u\"],\n+                        pathWithoutLast: [],\n+                        pathLast: \"u\",\n+                        generics: [\n+                            {\n+                                name: \"x\",\n+                                fullPath: [\"x\"],\n+                                pathWithoutLast: [],\n+                                pathLast: \"x\",\n+                                generics: [],\n+                            },\n+                            {\n+                                name: \"r\",\n+                                fullPath: [\"r\"],\n+                                pathWithoutLast: [],\n+                                pathLast: \"r\",\n+                                generics: [],\n+                            },\n+                        ],\n+                    },\n+                ],\n+                typeFilter: -1,\n+            },\n+        ],\n+        foundElems: 1,\n+        original: 'p<u<x, r>>',\n+        returned: [],\n+        userQuery: 'p<u<x, r>>',\n+        error: null,\n+    },\n ];"}, {"sha": "8701f2d49861a625f529b441eff4d24730f432c4", "filename": "tests/rustdoc-js/generics-nested.js", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/3312a3053bb9996e56a5ed58b6b9306224ada727/tests%2Frustdoc-js%2Fgenerics-nested.js", "raw_url": "https://github.com/rust-lang/rust/raw/3312a3053bb9996e56a5ed58b6b9306224ada727/tests%2Frustdoc-js%2Fgenerics-nested.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-js%2Fgenerics-nested.js?ref=3312a3053bb9996e56a5ed58b6b9306224ada727", "patch": "@@ -0,0 +1,33 @@\n+// exact-check\n+\n+const QUERY = [\n+    '-> Out<First<Second>>',\n+    '-> Out<Second<First>>',\n+    '-> Out<First, Second>',\n+    '-> Out<Second, First>',\n+];\n+\n+const EXPECTED = [\n+    {\n+        // -> Out<First<Second>>\n+        'others': [\n+            { 'path': 'generics_nested', 'name': 'alef' },\n+        ],\n+    },\n+    {\n+        // -> Out<Second<First>>\n+        'others': [],\n+    },\n+    {\n+        // -> Out<First, Second>\n+        'others': [\n+            { 'path': 'generics_nested', 'name': 'bet' },\n+        ],\n+    },\n+    {\n+        // -> Out<Second, First>\n+        'others': [\n+            { 'path': 'generics_nested', 'name': 'bet' },\n+        ],\n+    },\n+];"}, {"sha": "5140422e38492ae06805e31f1b457f62ee16d581", "filename": "tests/rustdoc-js/generics-nested.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/3312a3053bb9996e56a5ed58b6b9306224ada727/tests%2Frustdoc-js%2Fgenerics-nested.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3312a3053bb9996e56a5ed58b6b9306224ada727/tests%2Frustdoc-js%2Fgenerics-nested.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-js%2Fgenerics-nested.rs?ref=3312a3053bb9996e56a5ed58b6b9306224ada727", "patch": "@@ -0,0 +1,19 @@\n+pub struct Out<A, B = ()> {\n+    a: A,\n+    b: B,\n+}\n+\n+pub struct First<In = ()> {\n+    in_: In,\n+}\n+\n+pub struct Second;\n+\n+// Out<First<Second>>\n+pub fn alef() -> Out<First<Second>> {\n+    loop {}\n+}\n+\n+pub fn bet() -> Out<First, Second> {\n+    loop {}\n+}"}]}