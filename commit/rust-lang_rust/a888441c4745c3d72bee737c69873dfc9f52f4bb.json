{"sha": "a888441c4745c3d72bee737c69873dfc9f52f4bb", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE4ODg0NDFjNDc0NWMzZDcyYmVlNzM3YzY5ODczZGZjOWY1MmY0YmI=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2019-11-25T02:42:17Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-11-25T02:42:17Z"}, "message": "Merge #2392\n\n2392: Fix panic during the expansion of `column!` r=edwin0cheng a=marcogroppo\n\nFixes #2379. Well, this isn't the \"proper\" fix but it doesn't hurt, IMHO.\r\n\r\nThe problem is that `to_col_number`, called by `column_expand`, receives a position number that isn't included in the text range of the file. My (very limited) understanding is that the text is the one of the original file, while `pos` is relative to something else, probably the text of the macro. Notice that in this case the `column!` expansion seems to be triggered by `assert_eq!`, so we're in the middle of another expansion. This PR simply avoids the panic by checking the length of the text.\r\n\r\nr? @edwin0cheng \r\n\n\nCo-authored-by: Marco Groppo <marco.groppo@gmail.com>", "tree": {"sha": "c1593cd79a2c0d111f62898f62126c5b01cf9692", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c1593cd79a2c0d111f62898f62126c5b01cf9692"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a888441c4745c3d72bee737c69873dfc9f52f4bb", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJd2z+JCRBK7hj4Ov3rIwAAdHIIAHJsyWsQnex2jhSq7Cq7Y0oj\nFNTYJjwEHZywpxdwZOTy3yGrY2C0ZdeVk2dTZZ9HikhXMoy9FREjVTd0FgPTv7oo\nwe7pC6wdApVsIiohV6Q/HGDo+BnQYZalmEZumuhsfln7ntLhVOLw4JFjJbFpgXNu\n5+PB1GWRa7LyIa1zvdQNFGM7ui5qsIc1PsebTFUFS7rRu5lJmIHkybwGBXPN9gQd\nXOXZpNn0V0tHNldIvKUSKap2FdWkX12a+wdQ5wWHIMTjM3baTGescqq+iW/MbNug\nwPxJvPOfIk9Dhjq1TrkH8ZdH1uYvT4M/tVHmmhNBlV6lUhkTUngvjldiVUY9GHs=\n=svfg\n-----END PGP SIGNATURE-----\n", "payload": "tree c1593cd79a2c0d111f62898f62126c5b01cf9692\nparent f7f9757b6b144385ab8ce57b15764473b1f57331\nparent ceb13a0494bed37b233bcaaeee70bfae5fefeccc\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1574649737 +0000\ncommitter GitHub <noreply@github.com> 1574649737 +0000\n\nMerge #2392\n\n2392: Fix panic during the expansion of `column!` r=edwin0cheng a=marcogroppo\n\nFixes #2379. Well, this isn't the \"proper\" fix but it doesn't hurt, IMHO.\r\n\r\nThe problem is that `to_col_number`, called by `column_expand`, receives a position number that isn't included in the text range of the file. My (very limited) understanding is that the text is the one of the original file, while `pos` is relative to something else, probably the text of the macro. Notice that in this case the `column!` expansion seems to be triggered by `assert_eq!`, so we're in the middle of another expansion. This PR simply avoids the panic by checking the length of the text.\r\n\r\nr? @edwin0cheng \r\n\n\nCo-authored-by: Marco Groppo <marco.groppo@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a888441c4745c3d72bee737c69873dfc9f52f4bb", "html_url": "https://github.com/rust-lang/rust/commit/a888441c4745c3d72bee737c69873dfc9f52f4bb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a888441c4745c3d72bee737c69873dfc9f52f4bb/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f7f9757b6b144385ab8ce57b15764473b1f57331", "url": "https://api.github.com/repos/rust-lang/rust/commits/f7f9757b6b144385ab8ce57b15764473b1f57331", "html_url": "https://github.com/rust-lang/rust/commit/f7f9757b6b144385ab8ce57b15764473b1f57331"}, {"sha": "ceb13a0494bed37b233bcaaeee70bfae5fefeccc", "url": "https://api.github.com/repos/rust-lang/rust/commits/ceb13a0494bed37b233bcaaeee70bfae5fefeccc", "html_url": "https://github.com/rust-lang/rust/commit/ceb13a0494bed37b233bcaaeee70bfae5fefeccc"}], "stats": {"total": 21, "additions": 16, "deletions": 5}, "files": [{"sha": "9b5305a80d2e4f2f1637b1bb4633c7397a5d4b1a", "filename": "crates/ra_hir_expand/src/builtin_macro.rs", "status": "modified", "additions": 16, "deletions": 5, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/a888441c4745c3d72bee737c69873dfc9f52f4bb/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a888441c4745c3d72bee737c69873dfc9f52f4bb/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_macro.rs?ref=a888441c4745c3d72bee737c69873dfc9f52f4bb", "patch": "@@ -57,16 +57,21 @@ fn to_line_number(db: &dyn AstDatabase, file: HirFileId, pos: TextUnit) -> usize\n     let text = db.file_text(file_id);\n     let mut line_num = 1;\n \n+    let pos = pos.to_usize();\n+    if pos > text.len() {\n+        // FIXME: `pos` at the moment could be an offset inside the \"wrong\" file\n+        // in this case, when we know it's wrong, we return a dummy value\n+        return 0;\n+    }\n     // Count line end\n     for (i, c) in text.chars().enumerate() {\n-        if i == pos.to_usize() {\n+        if i == pos {\n             break;\n         }\n         if c == '\\n' {\n             line_num += 1;\n         }\n     }\n-\n     line_num\n }\n \n@@ -118,15 +123,21 @@ fn to_col_number(db: &dyn AstDatabase, file: HirFileId, pos: TextUnit) -> usize\n     // FIXME: Use expansion info\n     let file_id = file.original_file(db);\n     let text = db.file_text(file_id);\n-    let mut col_num = 1;\n \n-    for c in text[..pos.to_usize()].chars().rev() {\n+    let pos = pos.to_usize();\n+    if pos > text.len() {\n+        // FIXME: `pos` at the moment could be an offset inside the \"wrong\" file\n+        // in this case we return a dummy value so that we don't `panic!`\n+        return 0;\n+    }\n+\n+    let mut col_num = 1;\n+    for c in text[..pos].chars().rev() {\n         if c == '\\n' {\n             break;\n         }\n         col_num = col_num + 1;\n     }\n-\n     col_num\n }\n "}]}