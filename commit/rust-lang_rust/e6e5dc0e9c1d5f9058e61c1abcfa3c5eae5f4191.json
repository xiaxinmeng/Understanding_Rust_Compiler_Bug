{"sha": "e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU2ZTVkYzBlOWMxZDVmOTA1OGU2MWMxYWJjZmEzYzVlYWU1ZjQxOTE=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2017-05-17T16:33:20Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2017-06-01T17:14:26Z"}, "message": "ci: Improve log output (mainly Travis).\n\n* Bring back colors on Travis, which was disabled since #39036.\n  Append --color=always to cargo when running in CI environment.\n* Removed `set -x` in the shell scripts. The `retry` function already\n  prints which command it is running, add `-x` just add noise to the\n  output.\n* Support travis_fold/travis_time. Matching pairs of these allow Travis CI\n  to collapse the output in between. This greatly cut down the unnecessary\n  \"successful\" output one need to scroll through before finding the failed\n  statement.", "tree": {"sha": "6640bf4adcdbcd66c95f1e283805b888bdbdc2ed", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6640bf4adcdbcd66c95f1e283805b888bdbdc2ed"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIcBAABCAAGBQJZMEtyAAoJEP72yAUdDgE8k8sQAJODfpUi8JPwAcgRfXEocI89\nV1Iogji8HWyndgF6Jp8y6j1kmfDwJV61iFGDxzpYtOABGxz2rw1KUlaMhXOWpxTz\nbDy8vD11wA/DfjOSdpr+piF9jhrNpdwrO/rN1sohlXQxjLV4NDUVNWabhWDZ7YU7\nKOQ0bBzbV7ImaAgsTO+07Jdxd7pdwjdV3xDp8XlPdpRtxK+7YpWyfSo9SfTqRBnf\nDd+wPM8H89vWciBF6V7d8rB1RpITUgeLN4uMIRndbDRmXRrIHtQzpENjiccMitts\n4EB7eF5jRxDA3xVkvaMOcRmgWs7eF0VQsiZlzKVAV66qgpLpxZR3qjwsQ7CbDvkw\ngGz0ccee0hAbADyhba1cuqgiO0PLBaXCW/Va90gdDenwar9tBcI3RvpA9+Rjir3W\n8zWQb9mJ4mOnDD8r1dXXST3tJdLGR6V5eTC06Q52Du/I1FQ3sxfjIxkyb3R8BALT\nWqUwnr8ju5lst+66pSyBvqZSxOunVD0BhrJJy9xmB2RTz5Mr5ZEr/uH23c0Jkx5Z\nMz5Z9UfmZ+CKx6SXWLL/kFXDt6LhvZJg+1M1m/xzspm47dHd2Bny1maR5d+Uvegu\nRsOKAZh9J8+NRHn2RS0YSSJJ4KTDu4n3XaDeVhIUMVhNb6iA5H3f5no9pMPgtT+o\nIzTFeN2vl4eDVPkjWD+C\n=f39Q\n-----END PGP SIGNATURE-----", "payload": "tree 6640bf4adcdbcd66c95f1e283805b888bdbdc2ed\nparent 1a1ea253f2b92179333e0042d63dcfca45a947f0\nauthor kennytm <kennytm@gmail.com> 1495038800 +0800\ncommitter kennytm <kennytm@gmail.com> 1496337266 +0800\n\nci: Improve log output (mainly Travis).\n\n* Bring back colors on Travis, which was disabled since #39036.\n  Append --color=always to cargo when running in CI environment.\n* Removed `set -x` in the shell scripts. The `retry` function already\n  prints which command it is running, add `-x` just add noise to the\n  output.\n* Support travis_fold/travis_time. Matching pairs of these allow Travis CI\n  to collapse the output in between. This greatly cut down the unnecessary\n  \"successful\" output one need to scroll through before finding the failed\n  statement.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "html_url": "https://github.com/rust-lang/rust/commit/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1a1ea253f2b92179333e0042d63dcfca45a947f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/1a1ea253f2b92179333e0042d63dcfca45a947f0", "html_url": "https://github.com/rust-lang/rust/commit/1a1ea253f2b92179333e0042d63dcfca45a947f0"}], "stats": {"total": 241, "additions": 225, "deletions": 16}, "files": [{"sha": "b3db18dfbe4c0a03776d21e668daebf88d5f7501", "filename": ".travis.yml", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "patch": "@@ -152,20 +152,21 @@ before_script:\n       echo \"#### Disk usage before running script:\";\n       df -h;\n       du . | sort -nr | head -n100\n-\n-script:\n   - >\n       if [ \"$ALLOW_PR\" = \"\" ] && [ \"$TRAVIS_BRANCH\" != \"auto\" ]; then\n-          echo skipping, not a full build\n+          export RUN_SCRIPT=\"echo 'skipping, not a full build'\";\n       else\n-          stamp src/ci/init_repo.sh . \"$HOME/rustsrc\" &&\n+          RUN_SCRIPT=\"stamp src/ci/init_repo.sh . $HOME/rustsrc\";\n           if [ \"$TRAVIS_OS_NAME\" = \"osx\" ]; then\n-              stamp src/ci/run.sh;\n+              export RUN_SCRIPT=\"$RUN_SCRIPT && stamp src/ci/run.sh\";\n           else\n-              stamp src/ci/docker/run.sh $IMAGE;\n+              export RUN_SCRIPT=\"$RUN_SCRIPT && stamp src/ci/docker/run.sh $IMAGE\";\n           fi\n       fi\n \n+script:\n+  - sh -x -c \"$RUN_SCRIPT\"\n+\n after_success:\n   - >\n       echo \"#### Build successful; Disk usage after running script:\";"}, {"sha": "dc0f79a32c2fce5fee496b656a9ab51da4332d21", "filename": "src/bootstrap/check.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fbootstrap%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fbootstrap%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcheck.rs?ref=e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "patch": "@@ -124,6 +124,7 @@ pub fn cargo(build: &Build, stage: u32, host: &str) {\n /// otherwise just implements a few lint-like checks that are specific to the\n /// compiler itself.\n pub fn tidy(build: &Build, host: &str) {\n+    let _folder = build.fold_output(|| \"tidy\");\n     println!(\"tidy check ({})\", host);\n     let compiler = Compiler::new(0, host);\n     let mut cmd = build.tool_cmd(&compiler, \"tidy\");\n@@ -148,6 +149,7 @@ pub fn compiletest(build: &Build,\n                    target: &str,\n                    mode: &str,\n                    suite: &str) {\n+    let _folder = build.fold_output(|| format!(\"test_{}\", suite));\n     println!(\"Check compiletest suite={} mode={} ({} -> {})\",\n              suite, mode, compiler.host, target);\n     let mut cmd = Command::new(build.tool(&Compiler::new(0, compiler.host),\n@@ -278,6 +280,8 @@ pub fn compiletest(build: &Build,\n         cmd.arg(\"--android-cross-path\").arg(\"\");\n     }\n \n+    build.ci_env.force_coloring_in_ci(&mut cmd);\n+\n     let _time = util::timeit();\n     build.run(&mut cmd);\n }\n@@ -292,6 +296,7 @@ pub fn docs(build: &Build, compiler: &Compiler) {\n     // tests for all files that end in `*.md`\n     let mut stack = vec![build.src.join(\"src/doc\")];\n     let _time = util::timeit();\n+    let _folder = build.fold_output(|| \"test_docs\");\n \n     while let Some(p) = stack.pop() {\n         if p.is_dir() {\n@@ -325,6 +330,7 @@ pub fn docs(build: &Build, compiler: &Compiler) {\n /// generate a markdown file from the error indexes of the code base which is\n /// then passed to `rustdoc --test`.\n pub fn error_index(build: &Build, compiler: &Compiler) {\n+    let _folder = build.fold_output(|| \"test_error_index\");\n     println!(\"Testing error-index stage{}\", compiler.stage);\n \n     let dir = testdir(build, compiler.host);\n@@ -384,6 +390,9 @@ pub fn krate(build: &Build,\n         }\n         _ => panic!(\"can only test libraries\"),\n     };\n+    let _folder = build.fold_output(|| {\n+        format!(\"{}_stage{}-{}\", test_kind.subcommand(), compiler.stage, name)\n+    });\n     println!(\"{} {} stage{} ({} -> {})\", test_kind, name, compiler.stage,\n              compiler.host, target);\n "}, {"sha": "9946c93913fe7292fd502c6d2e726831a6af3e5c", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "patch": "@@ -41,6 +41,7 @@ pub fn std(build: &Build, target: &str, compiler: &Compiler) {\n     let libdir = build.sysroot_libdir(compiler, target);\n     t!(fs::create_dir_all(&libdir));\n \n+    let _folder = build.fold_output(|| format!(\"stage{}-std\", compiler.stage));\n     println!(\"Building stage{} std artifacts ({} -> {})\", compiler.stage,\n              compiler.host, target);\n \n@@ -192,6 +193,7 @@ pub fn build_startup_objects(build: &Build, for_compiler: &Compiler, target: &st\n /// the build using the `compiler` targeting the `target` architecture. The\n /// artifacts created will also be linked into the sysroot directory.\n pub fn test(build: &Build, target: &str, compiler: &Compiler) {\n+    let _folder = build.fold_output(|| format!(\"stage{}-test\", compiler.stage));\n     println!(\"Building stage{} test artifacts ({} -> {})\", compiler.stage,\n              compiler.host, target);\n     let out_dir = build.cargo_out(compiler, Mode::Libtest, target);\n@@ -228,6 +230,7 @@ pub fn test_link(build: &Build,\n /// the `compiler` targeting the `target` architecture. The artifacts\n /// created will also be linked into the sysroot directory.\n pub fn rustc(build: &Build, target: &str, compiler: &Compiler) {\n+    let _folder = build.fold_output(|| format!(\"stage{}-rustc\", compiler.stage));\n     println!(\"Building stage{} compiler artifacts ({} -> {})\",\n              compiler.stage, compiler.host, target);\n \n@@ -435,6 +438,7 @@ pub fn maybe_clean_tools(build: &Build, stage: u32, target: &str, mode: Mode) {\n /// This will build the specified tool with the specified `host` compiler in\n /// `stage` into the normal cargo output directory.\n pub fn tool(build: &Build, stage: u32, target: &str, tool: &str) {\n+    let _folder = build.fold_output(|| format!(\"stage{}-{}\", stage, tool));\n     println!(\"Building stage{} tool {} ({})\", stage, tool, target);\n \n     let compiler = Compiler::new(stage, &build.config.build);"}, {"sha": "01235fe30bd65a5f886e0e71540b6bd5a788a274", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "patch": "@@ -90,7 +90,7 @@ use std::process::Command;\n \n use build_helper::{run_silent, run_suppressed, output, mtime};\n \n-use util::{exe, libdir, add_lib_path};\n+use util::{exe, libdir, add_lib_path, OutputFolder, CiEnv};\n \n mod cc;\n mod channel;\n@@ -179,6 +179,7 @@ pub struct Build {\n     crates: HashMap<String, Crate>,\n     is_sudo: bool,\n     src_is_git: bool,\n+    ci_env: CiEnv,\n }\n \n #[derive(Debug)]\n@@ -272,6 +273,7 @@ impl Build {\n             lldb_python_dir: None,\n             is_sudo: is_sudo,\n             src_is_git: src_is_git,\n+            ci_env: CiEnv::current(),\n         }\n     }\n \n@@ -507,6 +509,9 @@ impl Build {\n         if self.config.vendor || self.is_sudo {\n             cargo.arg(\"--frozen\");\n         }\n+\n+        self.ci_env.force_coloring_in_ci(&mut cargo);\n+\n         return cargo\n     }\n \n@@ -1011,6 +1016,19 @@ impl Build {\n             \"nightly\" | _ => true,\n         }\n     }\n+\n+    /// Fold the output of the commands after this method into a group. The fold\n+    /// ends when the returned object is dropped. Folding can only be used in\n+    /// the Travis CI environment.\n+    pub fn fold_output<D, F>(&self, name: F) -> Option<OutputFolder>\n+        where D: Into<String>, F: FnOnce() -> D\n+    {\n+        if self.ci_env == CiEnv::Travis {\n+            Some(OutputFolder::new(name().into()))\n+        } else {\n+            None\n+        }\n+    }\n }\n \n impl<'a> Compiler<'a> {"}, {"sha": "ce1f63b4233e229261ac4c7088792959abe06709", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "patch": "@@ -63,6 +63,7 @@ pub fn llvm(build: &Build, target: &str) {\n         drop(fs::remove_dir_all(&out_dir));\n     }\n \n+    let _folder = build.fold_output(|| \"llvm\");\n     println!(\"Building LLVM for {}\", target);\n     let _time = util::timeit();\n     t!(fs::create_dir_all(&out_dir));\n@@ -218,6 +219,7 @@ pub fn test_helpers(build: &Build, target: &str) {\n         return\n     }\n \n+    let _folder = build.fold_output(|| \"build_test_helpers\");\n     println!(\"Building test helpers\");\n     t!(fs::create_dir_all(&dst));\n     let mut cfg = gcc::Config::new();"}, {"sha": "61bd85e76c59882b9967746f8bbba3a76ec9382e", "filename": "src/bootstrap/util.rs", "status": "modified", "additions": 101, "deletions": 2, "changes": 103, "blob_url": "https://github.com/rust-lang/rust/blob/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fbootstrap%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fbootstrap%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Futil.rs?ref=e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "patch": "@@ -16,10 +16,10 @@\n use std::env;\n use std::ffi::OsString;\n use std::fs;\n-use std::io;\n+use std::io::{self, Write};\n use std::path::{Path, PathBuf};\n use std::process::Command;\n-use std::time::Instant;\n+use std::time::{SystemTime, Instant};\n \n use filetime::{self, FileTime};\n \n@@ -324,3 +324,102 @@ pub fn symlink_dir(src: &Path, dest: &Path) -> io::Result<()> {\n         }\n     }\n }\n+\n+/// An RAII structure that indicates all output until this instance is dropped\n+/// is part of the same group.\n+///\n+/// On Travis CI, these output will be folded by default, together with the\n+/// elapsed time in this block. This reduces noise from unnecessary logs,\n+/// allowing developers to quickly identify the error.\n+///\n+/// Travis CI supports folding by printing `travis_fold:start:<name>` and\n+/// `travis_fold:end:<name>` around the block. Time elapsed is recognized\n+/// similarly with `travis_time:[start|end]:<name>`. These are undocumented, but\n+/// can easily be deduced from source code of the [Travis build commands].\n+///\n+/// [Travis build commands]:\n+/// https://github.com/travis-ci/travis-build/blob/f603c0089/lib/travis/build/templates/header.sh\n+pub struct OutputFolder {\n+    name: String,\n+    start_time: SystemTime, // we need SystemTime to get the UNIX timestamp.\n+}\n+\n+impl OutputFolder {\n+    /// Creates a new output folder with the given group name.\n+    pub fn new(name: String) -> OutputFolder {\n+        // \"\\r\" moves the cursor to the beginning of the line, and \"\\x1b[0K\" is\n+        // the ANSI escape code to clear from the cursor to end of line.\n+        // Travis seems to have trouble when _not_ using \"\\r\\x1b[0K\", that will\n+        // randomly put lines to the top of the webpage.\n+        print!(\"travis_fold:start:{0}\\r\\x1b[0Ktravis_time:start:{0}\\r\\x1b[0K\", name);\n+        OutputFolder {\n+            name,\n+            start_time: SystemTime::now(),\n+        }\n+    }\n+}\n+\n+impl Drop for OutputFolder {\n+    fn drop(&mut self) {\n+        use std::time::*;\n+        use std::u64;\n+\n+        fn to_nanos(duration: Result<Duration, SystemTimeError>) -> u64 {\n+            match duration {\n+                Ok(d) => d.as_secs() * 1_000_000_000 + d.subsec_nanos() as u64,\n+                Err(_) => u64::MAX,\n+            }\n+        }\n+\n+        let end_time = SystemTime::now();\n+        let duration = end_time.duration_since(self.start_time);\n+        let start = self.start_time.duration_since(UNIX_EPOCH);\n+        let finish = end_time.duration_since(UNIX_EPOCH);\n+        println!(\n+            \"travis_fold:end:{0}\\r\\x1b[0K\\n\\\n+                travis_time:end:{0}:start={1},finish={2},duration={3}\\r\\x1b[0K\",\n+            self.name,\n+            to_nanos(start),\n+            to_nanos(finish),\n+            to_nanos(duration)\n+        );\n+        io::stdout().flush().unwrap();\n+    }\n+}\n+\n+/// The CI environment rustbuild is running in. This mainly affects how the logs\n+/// are printed.\n+#[derive(Copy, Clone, PartialEq, Eq, Debug)]\n+pub enum CiEnv {\n+    /// Not a CI environment.\n+    None,\n+    /// The Travis CI environment, for Linux (including Docker) and macOS builds.\n+    Travis,\n+    /// The AppVeyor environment, for Windows builds.\n+    AppVeyor,\n+}\n+\n+impl CiEnv {\n+    /// Obtains the current CI environment.\n+    pub fn current() -> CiEnv {\n+        if env::var(\"TRAVIS\").ok().map_or(false, |e| &*e == \"true\") {\n+            CiEnv::Travis\n+        } else if env::var(\"APPVEYOR\").ok().map_or(false, |e| &*e == \"True\") {\n+            CiEnv::AppVeyor\n+        } else {\n+            CiEnv::None\n+        }\n+    }\n+\n+    /// If in a CI environment, forces the command to run with colors.\n+    pub fn force_coloring_in_ci(self, cmd: &mut Command) {\n+        if self != CiEnv::None {\n+            // Due to use of stamp/docker, the output stream of rustbuild is not\n+            // a TTY in CI, so coloring is by-default turned off.\n+            // The explicit `TERM=xterm` environment is needed for\n+            // `--color always` to actually work. This env var was lost when\n+            // compiling through the Makefile. Very strange.\n+            cmd.env(\"TERM\", \"xterm\").args(&[\"--color\", \"always\"]);\n+        }\n+    }\n+}\n\\ No newline at end of file"}, {"sha": "a9b1167b6faf7460eb19e2b374c551cc6218c076", "filename": "src/ci/docker/run.sh", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fci%2Fdocker%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fci%2Fdocker%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Frun.sh?ref=e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "patch": "@@ -21,6 +21,9 @@ root_dir=\"`dirname $src_dir`\"\n \n source \"$ci_dir/shared.sh\"\n \n+travis_fold start build_docker\n+travis_time_start\n+\n if [ -f \"$docker_dir/$image/Dockerfile\" ]; then\n     retry docker \\\n       build \\\n@@ -44,6 +47,9 @@ else\n     exit 1\n fi\n \n+travis_fold end build_docker\n+travis_time_finish\n+\n objdir=$root_dir/obj\n \n mkdir -p $HOME/.cargo\n@@ -72,6 +78,7 @@ exec docker \\\n   --env DEPLOY=$DEPLOY \\\n   --env DEPLOY_ALT=$DEPLOY_ALT \\\n   --env LOCAL_USER_ID=`id -u` \\\n+  --env TRAVIS=${TRAVIS-false} \\\n   --volume \"$HOME/.cargo:/cargo\" \\\n   --volume \"$HOME/rustsrc:$HOME/rustsrc\" \\\n   --privileged \\"}, {"sha": "282da009eac35c3f3e29c88b1e4e70c7c2ae1214", "filename": "src/ci/init_repo.sh", "status": "modified", "additions": 19, "deletions": 2, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fci%2Finit_repo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fci%2Finit_repo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Finit_repo.sh?ref=e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "patch": "@@ -13,11 +13,11 @@ set -o errexit\n set -o pipefail\n set -o nounset\n \n-set -o xtrace\n-\n ci_dir=$(cd $(dirname $0) && pwd)\n . \"$ci_dir/shared.sh\"\n \n+travis_fold start init_repo\n+\n REPO_DIR=\"$1\"\n CACHE_DIR=\"$2\"\n \n@@ -38,6 +38,7 @@ fi\n \n # Wipe the cache if it's not valid, or mark it as invalid while we update it\n if [ ! -f \"$cache_valid_file\" ]; then\n+    echo \"Invalid cache, wiping ($cache_valid_file missing)\"\n     rm -rf \"$CACHE_DIR\"\n     mkdir \"$CACHE_DIR\"\n else\n@@ -54,10 +55,14 @@ else\n         rm -rf \"$CACHE_DIR\"\n         mkdir \"$CACHE_DIR\"\n     else\n+        echo \"Valid cache ($cache_valid_file exists)\"\n         rm \"$cache_valid_file\"\n     fi\n fi\n \n+travis_fold start update_cache\n+travis_time_start\n+\n # Update the cache (a pristine copy of the rust source master)\n if [ ! -d \"$cache_src_dir/.git\" ]; then\n     retry sh -c \"rm -rf $cache_src_dir && mkdir -p $cache_src_dir && \\\n@@ -69,8 +74,15 @@ retry sh -c \"cd $cache_src_dir && \\\n     git submodule deinit -f . && git submodule sync && git submodule update --init\"\n \n # Cache was updated without errors, mark it as valid\n+echo \"Refreshed cache (touch $cache_valid_file)\"\n touch \"$cache_valid_file\"\n \n+travis_fold end update_cache\n+travis_time_finish\n+\n+travis_fold start update_submodules\n+travis_time_start\n+\n # Update the submodules of the repo we're in, using the pristine repo as\n # a cache for any object files\n # No, `git submodule foreach` won't work:\n@@ -94,3 +106,8 @@ for module in $modules; do\n     retry sh -c \"git submodule deinit -f $module && \\\n         git submodule update --init --reference $cache_src_dir/$module $module\"\n done\n+\n+travis_fold end update_submodules\n+travis_time_finish\n+\n+travis_fold end init_repo"}, {"sha": "08f5939ef7908406e25cb0beeb1f4681fb9d06ea", "filename": "src/ci/run.sh", "status": "modified", "additions": 23, "deletions": 5, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fci%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fci%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Frun.sh?ref=e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "patch": "@@ -58,21 +58,39 @@ else\n   fi\n fi\n \n+travis_fold start configure\n+travis_time_start\n $SRC/configure $RUST_CONFIGURE_ARGS\n+travis_fold end configure\n+travis_time_finish\n+\n+travis_fold start make-prepare\n+travis_time_start\n retry make prepare\n+travis_fold end make-prepare\n+travis_time_finish\n \n if [ \"$TRAVIS_OS_NAME\" = \"osx\" ]; then\n     ncpus=$(sysctl -n hw.ncpu)\n else\n     ncpus=$(grep processor /proc/cpuinfo | wc -l)\n fi\n \n-set -x\n-\n if [ ! -z \"$SCRIPT\" ]; then\n   sh -x -c \"$SCRIPT\"\n else\n-  make -j $ncpus tidy\n-  make -j $ncpus\n-  make $RUST_CHECK_TARGET -j $ncpus\n+  do_make() {\n+    travis_fold start \"make-$1\"\n+    travis_time_start\n+    echo \"make -j $ncpus $1\"\n+    make -j $ncpus \"$1\"\n+    local retval=$?\n+    travis_fold end \"make-$1\"\n+    travis_time_finish\n+    return $retval\n+  }\n+\n+  do_make tidy\n+  do_make all\n+  do_make \"$RUST_CHECK_TARGET\"\n fi"}, {"sha": "4a08683e3ee86511f505d16a88f00b39d3a2fe5d", "filename": "src/ci/shared.sh", "status": "modified", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fci%2Fshared.sh", "raw_url": "https://github.com/rust-lang/rust/raw/e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191/src%2Fci%2Fshared.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fshared.sh?ref=e6e5dc0e9c1d5f9058e61c1abcfa3c5eae5f4191", "patch": "@@ -30,3 +30,37 @@ function retry {\n     }\n   done\n }\n+\n+if ! declare -F travis_fold; then\n+  if [ \"${TRAVIS-false}\" = 'true' ]; then\n+    # This is a trimmed down copy of\n+    # https://github.com/travis-ci/travis-build/blob/master/lib/travis/build/templates/header.sh\n+    travis_fold() {\n+      echo -en \"travis_fold:$1:$2\\r\\033[0K\"\n+    }\n+    travis_time_start() {\n+      travis_timer_id=$(printf %08x $(( RANDOM * RANDOM )))\n+      travis_start_time=$(travis_nanoseconds)\n+      echo -en \"travis_time:start:$travis_timer_id\\r\\033[0K\"\n+    }\n+    travis_time_finish() {\n+      travis_end_time=$(travis_nanoseconds)\n+      local duration=$(($travis_end_time-$travis_start_time))\n+      local msg=\"travis_time:end:$travis_timer_id\"\n+      echo -en \"\\n$msg:start=$travis_start_time,finish=$travis_end_time,duration=$duration\\r\\033[0K\"\n+    }\n+    if [ $(uname) = 'Darwin' ]; then\n+      travis_nanoseconds() {\n+        date -u '+%s000000000'\n+      }\n+    else\n+      travis_nanoseconds() {\n+        date -u '+%s%N'\n+      }\n+    fi\n+  else\n+    travis_fold() { return 0; }\n+    travis_time_start() { return 0; }\n+    travis_time_finish() { return 0; }\n+  fi\n+fi"}]}