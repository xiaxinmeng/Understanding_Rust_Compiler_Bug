{"sha": "8026a95a2a8a4f1518bacb8c7dd082964daf1193", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgwMjZhOTVhMmE4YTRmMTUxOGJhY2I4YzdkZDA4Mjk2NGRhZjExOTM=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-04-23T08:55:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-04-23T08:55:07Z"}, "message": "Merge #4096\n\n4096: tasks.json Support r=matklad a=jcdickinson\n\nMove the task provider anonymous class into a real class, as this seems to be how Microsoft do this in their documentation.\r\n\r\nresolveTask is now implemented, which is used by VSCode to determine how to execute tasks that the user has defined in tasks.json.\r\n\r\nResolves #3983\n\nCo-authored-by: Jonathan Dickinson <jonathanD@k2.com>", "tree": {"sha": "8fe05af7781ee1b7134bc36e31ec9f34ce2ead4f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8fe05af7781ee1b7134bc36e31ec9f34ce2ead4f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8026a95a2a8a4f1518bacb8c7dd082964daf1193", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeoVfrCRBK7hj4Ov3rIwAAdHIIAEI0YQ1uOssQnzH38h/IlF0E\n0TbdqMBOMqz72x831whC6Cdi3jRBjdg84IawbvfoGf8LOq6J77StgcKRjo5NOn5a\n9zsggSiRQdire3Tz/cfmuRR286XmoptTzX9z74JZUkFGHZStOMUBrohRq/IwejMq\nqjYA/NlBoy2A6KwAF5T8x7ziMHl0xvgj/JI+ol8vzI0mA+pgXc0RAuGzEfxxiTzS\nRTmLAaNU+pyPCJzOjsny2Y5Vla+mlDcG8Chsl+GIQpTjrlZOHMfAYvcx7E3nDqTQ\n61TKXxZUen6UZo9XZdG9lWAAinzC2nhnFw67ikDbNSxKAzP091CYQAW8ui3v+p0=\n=jkem\n-----END PGP SIGNATURE-----\n", "payload": "tree 8fe05af7781ee1b7134bc36e31ec9f34ce2ead4f\nparent ad3f1da2eae62c81ac317364171e18b1e546f095\nparent 1d8c25b75c3df04099501403126104d49ab36e7c\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1587632107 +0000\ncommitter GitHub <noreply@github.com> 1587632107 +0000\n\nMerge #4096\n\n4096: tasks.json Support r=matklad a=jcdickinson\n\nMove the task provider anonymous class into a real class, as this seems to be how Microsoft do this in their documentation.\r\n\r\nresolveTask is now implemented, which is used by VSCode to determine how to execute tasks that the user has defined in tasks.json.\r\n\r\nResolves #3983\n\nCo-authored-by: Jonathan Dickinson <jonathanD@k2.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8026a95a2a8a4f1518bacb8c7dd082964daf1193", "html_url": "https://github.com/rust-lang/rust/commit/8026a95a2a8a4f1518bacb8c7dd082964daf1193", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8026a95a2a8a4f1518bacb8c7dd082964daf1193/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ad3f1da2eae62c81ac317364171e18b1e546f095", "url": "https://api.github.com/repos/rust-lang/rust/commits/ad3f1da2eae62c81ac317364171e18b1e546f095", "html_url": "https://github.com/rust-lang/rust/commit/ad3f1da2eae62c81ac317364171e18b1e546f095"}, {"sha": "1d8c25b75c3df04099501403126104d49ab36e7c", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d8c25b75c3df04099501403126104d49ab36e7c", "html_url": "https://github.com/rust-lang/rust/commit/1d8c25b75c3df04099501403126104d49ab36e7c"}], "stats": {"total": 103, "additions": 67, "deletions": 36}, "files": [{"sha": "1366c76d6bdaa5dd37b2ba2ea274f74b4015a9e5", "filename": "editors/code/src/tasks.ts", "status": "modified", "additions": 67, "deletions": 36, "changes": 103, "blob_url": "https://github.com/rust-lang/rust/blob/8026a95a2a8a4f1518bacb8c7dd082964daf1193/editors%2Fcode%2Fsrc%2Ftasks.ts", "raw_url": "https://github.com/rust-lang/rust/raw/8026a95a2a8a4f1518bacb8c7dd082964daf1193/editors%2Fcode%2Fsrc%2Ftasks.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Ftasks.ts?ref=8026a95a2a8a4f1518bacb8c7dd082964daf1193", "patch": "@@ -4,49 +4,80 @@ import * as vscode from 'vscode';\n // our configuration should be compatible with it so use the same key.\n const TASK_TYPE = 'cargo';\n \n-export function activateTaskProvider(target: vscode.WorkspaceFolder): vscode.Disposable {\n-    const provider: vscode.TaskProvider = {\n+interface CargoTaskDefinition extends vscode.TaskDefinition {\n+    command?: string;\n+    args?: string[];\n+    cwd?: string;\n+    env?: { [key: string]: string };\n+}\n+\n+class CargoTaskProvider implements vscode.TaskProvider {\n+    private readonly target: vscode.WorkspaceFolder;\n+\n+    constructor(target: vscode.WorkspaceFolder) {\n+        this.target = target;\n+    }\n+\n+    provideTasks(): vscode.Task[] {\n         // Detect Rust tasks. Currently we do not do any actual detection\n         // of tasks (e.g. aliases in .cargo/config) and just return a fixed\n         // set of tasks that always exist. These tasks cannot be removed in\n         // tasks.json - only tweaked.\n-        provideTasks: () => getStandardCargoTasks(target),\n \n-        // We don't need to implement this.\n-        resolveTask: () => undefined,\n-    };\n+        return [\n+            { command: 'build', group: vscode.TaskGroup.Build },\n+            { command: 'check', group: vscode.TaskGroup.Build },\n+            { command: 'test', group: vscode.TaskGroup.Test },\n+            { command: 'clean', group: vscode.TaskGroup.Clean },\n+            { command: 'run', group: undefined },\n+        ]\n+            .map(({ command, group }) => {\n+                const vscodeTask = new vscode.Task(\n+                    // The contents of this object end up in the tasks.json entries.\n+                    {\n+                        type: TASK_TYPE,\n+                        command,\n+                    },\n+                    // The scope of the task - workspace or specific folder (global\n+                    // is not supported).\n+                    this.target,\n+                    // The task name, and task source. These are shown in the UI as\n+                    // `${source}: ${name}`, e.g. `rust: cargo build`.\n+                    `cargo ${command}`,\n+                    'rust',\n+                    // What to do when this command is executed.\n+                    new vscode.ShellExecution('cargo', [command]),\n+                    // Problem matchers.\n+                    ['$rustc'],\n+                );\n+                vscodeTask.group = group;\n+                return vscodeTask;\n+            });\n+    }\n \n-    return vscode.tasks.registerTaskProvider(TASK_TYPE, provider);\n-}\n+    resolveTask(task: vscode.Task): vscode.Task | undefined {\n+        // VSCode calls this for every cargo task in the user's tasks.json,\n+        // we need to inform VSCode how to execute that command by creating\n+        // a ShellExecution for it.\n \n-function getStandardCargoTasks(target: vscode.WorkspaceFolder): vscode.Task[] {\n-    return [\n-        { command: 'build', group: vscode.TaskGroup.Build },\n-        { command: 'check', group: vscode.TaskGroup.Build },\n-        { command: 'test', group: vscode.TaskGroup.Test },\n-        { command: 'clean', group: vscode.TaskGroup.Clean },\n-        { command: 'run', group: undefined },\n-    ]\n-        .map(({ command, group }) => {\n-            const vscodeTask = new vscode.Task(\n-                // The contents of this object end up in the tasks.json entries.\n-                {\n-                    type: TASK_TYPE,\n-                    command,\n-                },\n-                // The scope of the task - workspace or specific folder (global\n-                // is not supported).\n-                target,\n-                // The task name, and task source. These are shown in the UI as\n-                // `${source}: ${name}`, e.g. `rust: cargo build`.\n-                `cargo ${command}`,\n+        const definition = task.definition as CargoTaskDefinition;\n+\n+        if (definition.type === 'cargo' && definition.command) {\n+            const args = [definition.command].concat(definition.args ?? []);\n+\n+            return new vscode.Task(\n+                definition,\n+                task.name,\n                 'rust',\n-                // What to do when this command is executed.\n-                new vscode.ShellExecution('cargo', [command]),\n-                // Problem matchers.\n-                ['$rustc'],\n+                new vscode.ShellExecution('cargo', args, definition),\n             );\n-            vscodeTask.group = group;\n-            return vscodeTask;\n-        });\n+        }\n+\n+        return undefined;\n+    }\n }\n+\n+export function activateTaskProvider(target: vscode.WorkspaceFolder): vscode.Disposable {\n+    const provider = new CargoTaskProvider(target);\n+    return vscode.tasks.registerTaskProvider(TASK_TYPE, provider);\n+}\n\\ No newline at end of file"}]}