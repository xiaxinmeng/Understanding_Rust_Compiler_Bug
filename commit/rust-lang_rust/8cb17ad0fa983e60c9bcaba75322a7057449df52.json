{"sha": "8cb17ad0fa983e60c9bcaba75322a7057449df52", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhjYjE3YWQwZmE5ODNlNjBjOWJjYWJhNzUzMjJhNzA1NzQ0OWRmNTI=", "commit": {"author": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2013-01-29T18:54:44Z"}, "committer": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2013-01-29T18:54:44Z"}, "message": "Merge pull request #4668 from ILyoan/i2673\n\nfix #2673: avoid visiting the same crate twice", "tree": {"sha": "0b5f8c8f14a200ed0c3bbcd67584570406b36999", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0b5f8c8f14a200ed0c3bbcd67584570406b36999"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8cb17ad0fa983e60c9bcaba75322a7057449df52", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8cb17ad0fa983e60c9bcaba75322a7057449df52", "html_url": "https://github.com/rust-lang/rust/commit/8cb17ad0fa983e60c9bcaba75322a7057449df52", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8cb17ad0fa983e60c9bcaba75322a7057449df52/comments", "author": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "committer": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "226cd68f13339ae02e606957ebd1d2a3fb1e7aad", "url": "https://api.github.com/repos/rust-lang/rust/commits/226cd68f13339ae02e606957ebd1d2a3fb1e7aad", "html_url": "https://github.com/rust-lang/rust/commit/226cd68f13339ae02e606957ebd1d2a3fb1e7aad"}, {"sha": "8ec36d779b760eed8625ec69a983461e2ffe3914", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ec36d779b760eed8625ec69a983461e2ffe3914", "html_url": "https://github.com/rust-lang/rust/commit/8ec36d779b760eed8625ec69a983461e2ffe3914"}], "stats": {"total": 28, "additions": 19, "deletions": 9}, "files": [{"sha": "7faae196000ef5d93aa3ed534ab83b9b4f18f07d", "filename": "src/rt/rust_crate_map.cpp", "status": "modified", "additions": 19, "deletions": 9, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/8cb17ad0fa983e60c9bcaba75322a7057449df52/src%2Frt%2Frust_crate_map.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/8cb17ad0fa983e60c9bcaba75322a7057449df52/src%2Frt%2Frust_crate_map.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_crate_map.cpp?ref=8cb17ad0fa983e60c9bcaba75322a7057449df52", "patch": "@@ -9,6 +9,7 @@\n // except according to those terms.\n \n #include \"rust_crate_map.h\"\n+#include <set>\n \n void iter_module_map(const mod_entry* map,\n                      void (*fn)(const mod_entry* entry, void *cookie),\n@@ -20,18 +21,27 @@ void iter_module_map(const mod_entry* map,\n \n void iter_crate_map(const cratemap* map,\n                     void (*fn)(const mod_entry* map, void *cookie),\n-                    void *cookie) {\n-    // First iterate this crate\n-    iter_module_map(map->entries(), fn, cookie);\n-    // Then recurse on linked crates\n-    // FIXME (#2673) this does double work in diamond-shaped deps. could\n-    //   keep a set of visited addresses, if it turns out to be actually\n-    //   slow\n-    for (cratemap::iterator i = map->begin(), e = map->end(); i != e; ++i) {\n-        iter_crate_map(*i, fn, cookie);\n+                    void *cookie,\n+                    std::set<const cratemap*>& visited) {\n+    if (visited.find(map) == visited.end()) {\n+        // Mark this crate visited\n+        visited.insert(map);\n+        // First iterate this crate\n+        iter_module_map(map->entries(), fn, cookie);\n+        // Then recurse on linked crates\n+        for (cratemap::iterator i = map->begin(),\n+                e = map->end(); i != e; ++i) {\n+            iter_crate_map(*i, fn, cookie, visited);\n+        }\n     }\n }\n \n+void iter_crate_map(const cratemap* map,\n+                    void (*fn)(const mod_entry* map, void *cookie),\n+                    void *cookie) {\n+    std::set<const cratemap*> visited;\n+    iter_crate_map(map, fn, cookie, visited);\n+}\n //\n // Local Variables:\n // mode: C++"}]}