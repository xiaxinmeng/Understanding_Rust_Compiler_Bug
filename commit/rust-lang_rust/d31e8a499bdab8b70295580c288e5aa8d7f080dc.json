{"sha": "d31e8a499bdab8b70295580c288e5aa8d7f080dc", "node_id": "C_kwDOAAsO6NoAKGQzMWU4YTQ5OWJkYWI4YjcwMjk1NTgwYzI4OGU1YWE4ZDdmMDgwZGM", "commit": {"author": {"name": "Ezra Shaw", "email": "ezrasure@outlook.com", "date": "2023-04-22T04:55:59Z"}, "committer": {"name": "Ezra Shaw", "email": "ezrasure@outlook.com", "date": "2023-04-23T07:28:50Z"}, "message": "allow array-style simd in inline asm", "tree": {"sha": "345b3bb18895f9a5713ed284fe4a9e61f5c9f3c2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/345b3bb18895f9a5713ed284fe4a9e61f5c9f3c2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d31e8a499bdab8b70295580c288e5aa8d7f080dc", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJJBAABCAAzFiEEYSWD6p+RIeSP1N2eF81cKtrg00QFAmRE3jIVHGV6cmFzdXJl\nQG91dGxvb2suY29tAAoJEBfNXCra4NNEeV4P/1oqk2845OFA1C89tMIAx6a2o9cy\n2yVFIaBIq9cgKvRrOgjGC1mE0iKpdeVCViwr8mtGOcNbATYGACDz23lIZaL5nOGN\nqZ8H68Qf0//RlZbK/w+Fu+bdrwzcyy4ewMI57i7LDRzbgUVZjAQju+9fbM8Q+R4+\niljqmHGjVbc7rSGhBeNjCb7cEMsbj2z584k2LhlMDdfEl4QueF40Q0jjoauUJ89H\nDE0EJ1KWmI1Co6Kf27VmAlaHxdoI0zsgn/VxfImXT2mhb67uw8CtnEol0NIzkdm6\nGZJpiD1Fi1tjOwBYF0IAT69SJtIGev7O1lwbJkNLsJUABy2FL8NuViKnrHlxmL0h\nNyHNjZPmvgJ36Tx/PKJ5o8E6obcRNys2Szeya6XtZVQt1a559mDQJ1AMrCWu+O2v\nuIDJEBzkdni9XTTXKa2cH9usX8P7yRaiWkuFnT8ZXU4vddxU2K+MraGtUZlLUjaF\n3vZ2JGR9cGQzKbqwcTIevkt+WCt91m6oETw/Eist6EdsZ1wSLKpNN/+/kiOoFhpf\nQ6ssEVbRZP7gbO3ziS0gaz2l67QpRutCunLnW5X2F2N25tKY9Fj8IdmyqAM8aAxw\nokbzrwT0WrS4PWN/OYBG6eHDxaeCJJZnhuTlZHSomN8EH1t9AYuvawTlLgzmd7I8\nf8I0YnBSn4zRzXPm\n=raO0\n-----END PGP SIGNATURE-----", "payload": "tree 345b3bb18895f9a5713ed284fe4a9e61f5c9f3c2\nparent c7815840793b980d0aae7d5a2f5d9bb1fd6c0d1e\nauthor Ezra Shaw <ezrasure@outlook.com> 1682139359 +1200\ncommitter Ezra Shaw <ezrasure@outlook.com> 1682234930 +1200\n\nallow array-style simd in inline asm\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d31e8a499bdab8b70295580c288e5aa8d7f080dc", "html_url": "https://github.com/rust-lang/rust/commit/d31e8a499bdab8b70295580c288e5aa8d7f080dc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d31e8a499bdab8b70295580c288e5aa8d7f080dc/comments", "author": {"login": "Ezrashaw", "id": 38062690, "node_id": "MDQ6VXNlcjM4MDYyNjkw", "avatar_url": "https://avatars.githubusercontent.com/u/38062690?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Ezrashaw", "html_url": "https://github.com/Ezrashaw", "followers_url": "https://api.github.com/users/Ezrashaw/followers", "following_url": "https://api.github.com/users/Ezrashaw/following{/other_user}", "gists_url": "https://api.github.com/users/Ezrashaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/Ezrashaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Ezrashaw/subscriptions", "organizations_url": "https://api.github.com/users/Ezrashaw/orgs", "repos_url": "https://api.github.com/users/Ezrashaw/repos", "events_url": "https://api.github.com/users/Ezrashaw/events{/privacy}", "received_events_url": "https://api.github.com/users/Ezrashaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Ezrashaw", "id": 38062690, "node_id": "MDQ6VXNlcjM4MDYyNjkw", "avatar_url": "https://avatars.githubusercontent.com/u/38062690?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Ezrashaw", "html_url": "https://github.com/Ezrashaw", "followers_url": "https://api.github.com/users/Ezrashaw/followers", "following_url": "https://api.github.com/users/Ezrashaw/following{/other_user}", "gists_url": "https://api.github.com/users/Ezrashaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/Ezrashaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Ezrashaw/subscriptions", "organizations_url": "https://api.github.com/users/Ezrashaw/orgs", "repos_url": "https://api.github.com/users/Ezrashaw/repos", "events_url": "https://api.github.com/users/Ezrashaw/events{/privacy}", "received_events_url": "https://api.github.com/users/Ezrashaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c7815840793b980d0aae7d5a2f5d9bb1fd6c0d1e", "url": "https://api.github.com/repos/rust-lang/rust/commits/c7815840793b980d0aae7d5a2f5d9bb1fd6c0d1e", "html_url": "https://github.com/rust-lang/rust/commit/c7815840793b980d0aae7d5a2f5d9bb1fd6c0d1e"}], "stats": {"total": 63, "additions": 50, "deletions": 13}, "files": [{"sha": "a28814681dbf66a9a0e728a7a3a4662bfc5d65fe", "filename": "compiler/rustc_hir_analysis/src/check/intrinsicck.rs", "status": "modified", "additions": 25, "deletions": 13, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/d31e8a499bdab8b70295580c288e5aa8d7f080dc/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fintrinsicck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d31e8a499bdab8b70295580c288e5aa8d7f080dc/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fintrinsicck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fintrinsicck.rs?ref=d31e8a499bdab8b70295580c288e5aa8d7f080dc", "patch": "@@ -84,33 +84,45 @@ impl<'a, 'tcx> InlineAsmCtxt<'a, 'tcx> {\n             ty::Adt(adt, substs) if adt.repr().simd() => {\n                 let fields = &adt.non_enum_variant().fields;\n                 let elem_ty = fields[FieldIdx::from_u32(0)].ty(self.tcx, substs);\n-                match elem_ty.kind() {\n-                    ty::Never | ty::Error(_) => return None,\n-                    ty::Int(IntTy::I8) | ty::Uint(UintTy::U8) => {\n-                        Some(InlineAsmType::VecI8(fields.len() as u64))\n+\n+                let (size, ty) = match elem_ty.kind() {\n+                    ty::Array(ty, len) => {\n+                        if let Some(len) =\n+                            len.try_eval_target_usize(self.tcx, self.tcx.param_env(adt.did()))\n+                        {\n+                            (len, *ty)\n+                        } else {\n+                            return None;\n+                        }\n                     }\n+                    _ => (fields.len() as u64, elem_ty),\n+                };\n+\n+                match ty.kind() {\n+                    ty::Never | ty::Error(_) => return None,\n+                    ty::Int(IntTy::I8) | ty::Uint(UintTy::U8) => Some(InlineAsmType::VecI8(size)),\n                     ty::Int(IntTy::I16) | ty::Uint(UintTy::U16) => {\n-                        Some(InlineAsmType::VecI16(fields.len() as u64))\n+                        Some(InlineAsmType::VecI16(size))\n                     }\n                     ty::Int(IntTy::I32) | ty::Uint(UintTy::U32) => {\n-                        Some(InlineAsmType::VecI32(fields.len() as u64))\n+                        Some(InlineAsmType::VecI32(size))\n                     }\n                     ty::Int(IntTy::I64) | ty::Uint(UintTy::U64) => {\n-                        Some(InlineAsmType::VecI64(fields.len() as u64))\n+                        Some(InlineAsmType::VecI64(size))\n                     }\n                     ty::Int(IntTy::I128) | ty::Uint(UintTy::U128) => {\n-                        Some(InlineAsmType::VecI128(fields.len() as u64))\n+                        Some(InlineAsmType::VecI128(size))\n                     }\n                     ty::Int(IntTy::Isize) | ty::Uint(UintTy::Usize) => {\n                         Some(match self.tcx.sess.target.pointer_width {\n-                            16 => InlineAsmType::VecI16(fields.len() as u64),\n-                            32 => InlineAsmType::VecI32(fields.len() as u64),\n-                            64 => InlineAsmType::VecI64(fields.len() as u64),\n+                            16 => InlineAsmType::VecI16(size),\n+                            32 => InlineAsmType::VecI32(size),\n+                            64 => InlineAsmType::VecI64(size),\n                             _ => unreachable!(),\n                         })\n                     }\n-                    ty::Float(FloatTy::F32) => Some(InlineAsmType::VecF32(fields.len() as u64)),\n-                    ty::Float(FloatTy::F64) => Some(InlineAsmType::VecF64(fields.len() as u64)),\n+                    ty::Float(FloatTy::F32) => Some(InlineAsmType::VecF32(size)),\n+                    ty::Float(FloatTy::F64) => Some(InlineAsmType::VecF64(size)),\n                     _ => None,\n                 }\n             }"}, {"sha": "c2875f3e0a44446b541799a37d74240a0667e41c", "filename": "tests/assembly/asm/inline-asm-avx.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/d31e8a499bdab8b70295580c288e5aa8d7f080dc/tests%2Fassembly%2Fasm%2Finline-asm-avx.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d31e8a499bdab8b70295580c288e5aa8d7f080dc/tests%2Fassembly%2Fasm%2Finline-asm-avx.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fassembly%2Fasm%2Finline-asm-avx.rs?ref=d31e8a499bdab8b70295580c288e5aa8d7f080dc", "patch": "@@ -0,0 +1,25 @@\n+// assembly-output: emit-asm\n+// compile-flags: --crate-type=lib\n+// only-x86_64\n+// ignore-sgx\n+\n+#![feature(portable_simd)]\n+\n+use std::simd::Simd;\n+use std::arch::asm;\n+\n+#[target_feature(enable = \"avx\")]\n+#[no_mangle]\n+// CHECK-LABEL: convert:\n+pub unsafe fn convert(a: *const f32) -> Simd<f32, 8> {\n+    // CHECK: vbroadcastss (%{{[er][a-ds0-9][xpi0-9]?}}), {{%ymm[0-7]}}\n+    let b: Simd<f32, 8>;\n+    unsafe {\n+        asm!(\n+            \"vbroadcastss {b}, [{a}]\",\n+            a = in(reg) a,\n+            b = out(ymm_reg) b,\n+        );\n+    }\n+    b\n+}"}]}