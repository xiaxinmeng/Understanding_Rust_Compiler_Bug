{"sha": "9b67cba4f6294e0db900397cdf5c59c1dc901ade", "node_id": "MDY6Q29tbWl0NzI0NzEyOjliNjdjYmE0ZjYyOTRlMGRiOTAwMzk3Y2RmNWM1OWMxZGM5MDFhZGU=", "commit": {"author": {"name": "Simonas Kazlauskas", "email": "git@kazlauskas.me", "date": "2021-06-26T20:53:35Z"}, "committer": {"name": "Simonas Kazlauskas", "email": "git@kazlauskas.me", "date": "2021-06-30T16:45:17Z"}, "message": "Add support for leaf fn frame pointer elimination\n\nThis PR adds ability for the target specifications to specify frame\npointer emission type that's not just \u201calways\u201d or \u201cwhatever cg decides\u201d.\n\nIn particular there's a new mode that allows omission of the frame\npointer for leaf functions (those that don't call any other functions).\n\nWe then set this new mode for Aarch64-based Apple targets.\n\nFixes #86196", "tree": {"sha": "5f9e9ce96b1e1c32d448d8daa1ba0c9f18bb947e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5f9e9ce96b1e1c32d448d8daa1ba0c9f18bb947e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9b67cba4f6294e0db900397cdf5c59c1dc901ade", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9b67cba4f6294e0db900397cdf5c59c1dc901ade", "html_url": "https://github.com/rust-lang/rust/commit/9b67cba4f6294e0db900397cdf5c59c1dc901ade", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9b67cba4f6294e0db900397cdf5c59c1dc901ade/comments", "author": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3ddb78a34608848a60f6ca5b6ccfde8340302372", "url": "https://api.github.com/repos/rust-lang/rust/commits/3ddb78a34608848a60f6ca5b6ccfde8340302372", "html_url": "https://github.com/rust-lang/rust/commit/3ddb78a34608848a60f6ca5b6ccfde8340302372"}], "stats": {"total": 209, "additions": 149, "deletions": 60}, "files": [{"sha": "56b93f83466805d32302878c4fbfa5923ae71f4f", "filename": "compiler/rustc_codegen_llvm/src/attributes.rs", "status": "modified", "additions": 20, "deletions": 10, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_codegen_llvm%2Fsrc%2Fattributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_codegen_llvm%2Fsrc%2Fattributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fattributes.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -12,7 +12,7 @@ use rustc_middle::ty::{self, TyCtxt};\n use rustc_session::config::OptLevel;\n use rustc_session::Session;\n use rustc_target::spec::abi::Abi;\n-use rustc_target::spec::{SanitizerSet, StackProbeType};\n+use rustc_target::spec::{FramePointer, SanitizerSet, StackProbeType};\n \n use crate::attributes;\n use crate::llvm::AttributePlace::Function;\n@@ -69,15 +69,25 @@ fn naked(val: &'ll Value, is_naked: bool) {\n     Attribute::Naked.toggle_llfn(Function, val, is_naked);\n }\n \n-pub fn set_frame_pointer_elimination(cx: &CodegenCx<'ll, '_>, llfn: &'ll Value) {\n-    if cx.sess().must_not_eliminate_frame_pointers() {\n-        llvm::AddFunctionAttrStringValue(\n-            llfn,\n-            llvm::AttributePlace::Function,\n-            cstr!(\"frame-pointer\"),\n-            cstr!(\"all\"),\n-        );\n+pub fn set_frame_pointer_type(cx: &CodegenCx<'ll, '_>, llfn: &'ll Value) {\n+    let mut fp = cx.sess().target.frame_pointer;\n+    // \"mcount\" function relies on stack pointer.\n+    // See <https://sourceware.org/binutils/docs/gprof/Implementation.html>.\n+    if cx.sess().instrument_mcount() || matches!(cx.sess().opts.cg.force_frame_pointers, Some(true))\n+    {\n+        fp = FramePointer::Always;\n     }\n+    let attr_value = match fp {\n+        FramePointer::Always => cstr!(\"all\"),\n+        FramePointer::NonLeaf => cstr!(\"non-leaf\"),\n+        FramePointer::MayOmit => return,\n+    };\n+    llvm::AddFunctionAttrStringValue(\n+        llfn,\n+        llvm::AttributePlace::Function,\n+        cstr!(\"frame-pointer\"),\n+        attr_value,\n+    );\n }\n \n /// Tell LLVM what instrument function to insert.\n@@ -254,7 +264,7 @@ pub fn from_fn_attrs(cx: &CodegenCx<'ll, 'tcx>, llfn: &'ll Value, instance: ty::\n     }\n \n     // FIXME: none of these three functions interact with source level attributes.\n-    set_frame_pointer_elimination(cx, llfn);\n+    set_frame_pointer_type(cx, llfn);\n     set_instrument_function(cx, llfn);\n     set_probestack(cx, llfn);\n "}, {"sha": "f662887abf82025aff4ed7ef19f100e5cca4a360", "filename": "compiler/rustc_codegen_llvm/src/context.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -410,8 +410,8 @@ impl MiscMethods<'tcx> for CodegenCx<'ll, 'tcx> {\n         &self.used_statics\n     }\n \n-    fn set_frame_pointer_elimination(&self, llfn: &'ll Value) {\n-        attributes::set_frame_pointer_elimination(self, llfn)\n+    fn set_frame_pointer_type(&self, llfn: &'ll Value) {\n+        attributes::set_frame_pointer_type(self, llfn)\n     }\n \n     fn apply_target_cpu_attr(&self, llfn: &'ll Value) {"}, {"sha": "1fb201eda6bb0478d83dafe9fe35505be11382ea", "filename": "compiler/rustc_codegen_llvm/src/intrinsic.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -674,7 +674,7 @@ fn gen_fn<'ll, 'tcx>(\n ) -> &'ll Value {\n     let fn_abi = FnAbi::of_fn_ptr(cx, rust_fn_sig, &[]);\n     let llfn = cx.declare_fn(name, &fn_abi);\n-    cx.set_frame_pointer_elimination(llfn);\n+    cx.set_frame_pointer_type(llfn);\n     cx.apply_target_cpu_attr(llfn);\n     // FIXME(eddyb) find a nicer way to do this.\n     unsafe { llvm::LLVMRustSetLinkage(llfn, llvm::Linkage::InternalLinkage) };"}, {"sha": "9e1e4c0c817fd101848ca7e67b29503ec45902c9", "filename": "compiler/rustc_codegen_ssa/src/base.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_codegen_ssa%2Fsrc%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_codegen_ssa%2Fsrc%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fbase.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -406,7 +406,7 @@ pub fn maybe_create_entry_wrapper<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n         };\n \n         // `main` should respect same config for frame pointer elimination as rest of code\n-        cx.set_frame_pointer_elimination(llfn);\n+        cx.set_frame_pointer_type(llfn);\n         cx.apply_target_cpu_attr(llfn);\n \n         let llbb = Bx::append_block(&cx, llfn, \"top\");"}, {"sha": "46f2adbe55209aa7aea62dbc7c8e2e13e346cf4b", "filename": "compiler/rustc_codegen_ssa/src/traits/misc.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fmisc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fmisc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fmisc.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -16,7 +16,7 @@ pub trait MiscMethods<'tcx>: BackendTypes {\n     fn sess(&self) -> &Session;\n     fn codegen_unit(&self) -> &'tcx CodegenUnit<'tcx>;\n     fn used_statics(&self) -> &RefCell<Vec<Self::Value>>;\n-    fn set_frame_pointer_elimination(&self, llfn: Self::Function);\n+    fn set_frame_pointer_type(&self, llfn: Self::Function);\n     fn apply_target_cpu_attr(&self, llfn: Self::Function);\n     fn create_used_variable(&self);\n     /// Declares the extern \"C\" main function for the entry point. Returns None if the symbol already exists."}, {"sha": "f792e319867792eac94c2dc63501ff2750e6ba98", "filename": "compiler/rustc_session/src/session.rs", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fsession.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -792,18 +792,6 @@ impl Session {\n         !self.target.is_like_windows && !self.target.is_like_osx\n     }\n \n-    pub fn must_not_eliminate_frame_pointers(&self) -> bool {\n-        // \"mcount\" function relies on stack pointer.\n-        // See <https://sourceware.org/binutils/docs/gprof/Implementation.html>.\n-        if self.instrument_mcount() {\n-            true\n-        } else if let Some(x) = self.opts.cg.force_frame_pointers {\n-            x\n-        } else {\n-            !self.target.eliminate_frame_pointer\n-        }\n-    }\n-\n     pub fn must_emit_unwind_tables(&self) -> bool {\n         // This is used to control the emission of the `uwtable` attribute on\n         // LLVM functions."}, {"sha": "bf3ec8f9160b08aac80284106fdf342b9eef2efc", "filename": "compiler/rustc_target/src/spec/aarch64_apple_darwin.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_darwin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_darwin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_darwin.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,4 +1,4 @@\n-use crate::spec::{LinkerFlavor, SanitizerSet, Target, TargetOptions};\n+use crate::spec::{FramePointer, LinkerFlavor, SanitizerSet, Target, TargetOptions};\n \n pub fn target() -> Target {\n     let mut base = super::apple_base::opts(\"macos\");\n@@ -20,6 +20,10 @@ pub fn target() -> Target {\n         pointer_width: 64,\n         data_layout: \"e-m:o-i64:64-i128:128-n32:64-S128\".to_string(),\n         arch: arch.to_string(),\n-        options: TargetOptions { mcount: \"\\u{1}mcount\".to_string(), ..base },\n+        options: TargetOptions {\n+            mcount: \"\\u{1}mcount\".to_string(),\n+            frame_pointer: FramePointer::NonLeaf,\n+            ..base\n+        },\n     }\n }"}, {"sha": "9fa8ef69d8131e6be8d71a6cc2876fd496a0c832", "filename": "compiler/rustc_target/src/spec/aarch64_apple_ios.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,5 +1,5 @@\n use super::apple_sdk_base::{opts, Arch};\n-use crate::spec::{Target, TargetOptions};\n+use crate::spec::{FramePointer, Target, TargetOptions};\n \n pub fn target() -> Target {\n     let base = opts(\"ios\", Arch::Arm64);\n@@ -13,6 +13,7 @@ pub fn target() -> Target {\n             max_atomic_width: Some(128),\n             unsupported_abis: super::arm_base::unsupported_abis(),\n             forces_embed_bitcode: true,\n+            frame_pointer: FramePointer::NonLeaf,\n             // Taken from a clang build on Xcode 11.4.1.\n             // These arguments are not actually invoked - they just have\n             // to look right to pass App Store validation."}, {"sha": "a43eb99a1d73f5d48ca7a150b2b413c6359d74d6", "filename": "compiler/rustc_target/src/spec/aarch64_apple_ios_macabi.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_macabi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_macabi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_macabi.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,5 +1,5 @@\n use super::apple_sdk_base::{opts, Arch};\n-use crate::spec::{Target, TargetOptions};\n+use crate::spec::{FramePointer, Target, TargetOptions};\n \n pub fn target() -> Target {\n     let base = opts(\"ios\", Arch::Arm64_macabi);\n@@ -13,6 +13,7 @@ pub fn target() -> Target {\n             max_atomic_width: Some(128),\n             unsupported_abis: super::arm_base::unsupported_abis(),\n             forces_embed_bitcode: true,\n+            frame_pointer: FramePointer::NonLeaf,\n             // Taken from a clang build on Xcode 11.4.1.\n             // These arguments are not actually invoked - they just have\n             // to look right to pass App Store validation."}, {"sha": "586e4043d79def6f46c62d4bd23642701e33c33d", "filename": "compiler/rustc_target/src/spec/aarch64_apple_ios_sim.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_sim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_sim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_sim.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,5 +1,5 @@\n use super::apple_sdk_base::{opts, Arch};\n-use crate::spec::{Target, TargetOptions};\n+use crate::spec::{FramePointer, Target, TargetOptions};\n \n pub fn target() -> Target {\n     let base = opts(\"ios\", Arch::Arm64_sim);\n@@ -21,6 +21,7 @@ pub fn target() -> Target {\n             max_atomic_width: Some(128),\n             unsupported_abis: super::arm_base::unsupported_abis(),\n             forces_embed_bitcode: true,\n+            frame_pointer: FramePointer::NonLeaf,\n             // Taken from a clang build on Xcode 11.4.1.\n             // These arguments are not actually invoked - they just have\n             // to look right to pass App Store validation."}, {"sha": "934f33703690f6b85af5a606a36422cece9d91ed", "filename": "compiler/rustc_target/src/spec/aarch64_apple_tvos.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_tvos.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_tvos.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_tvos.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,5 +1,5 @@\n use super::apple_sdk_base::{opts, Arch};\n-use crate::spec::{Target, TargetOptions};\n+use crate::spec::{FramePointer, Target, TargetOptions};\n \n pub fn target() -> Target {\n     let base = opts(\"tvos\", Arch::Arm64);\n@@ -13,6 +13,7 @@ pub fn target() -> Target {\n             max_atomic_width: Some(128),\n             unsupported_abis: super::arm_base::unsupported_abis(),\n             forces_embed_bitcode: true,\n+            frame_pointer: FramePointer::NonLeaf,\n             ..base\n         },\n     }"}, {"sha": "0c8a89210ffcdcf32a39d1eec5b6441b5fd77037", "filename": "compiler/rustc_target/src/spec/apple_base.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_base.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,6 +1,6 @@\n use std::env;\n \n-use crate::spec::{SplitDebuginfo, TargetOptions};\n+use crate::spec::{FramePointer, SplitDebuginfo, TargetOptions};\n \n pub fn opts(os: &str) -> TargetOptions {\n     // ELF TLS is only available in macOS 10.7+. If you try to compile for 10.6\n@@ -27,7 +27,7 @@ pub fn opts(os: &str) -> TargetOptions {\n         families: vec![\"unix\".to_string()],\n         is_like_osx: true,\n         dwarf_version: Some(2),\n-        eliminate_frame_pointer: false,\n+        frame_pointer: FramePointer::Always,\n         has_rpath: true,\n         dll_suffix: \".dylib\".to_string(),\n         archive_format: \"darwin\".to_string(),"}, {"sha": "998d6ffe0fc668652b9a2d65ac07d93df7aba1a0", "filename": "compiler/rustc_target/src/spec/freebsd_base.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Ffreebsd_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Ffreebsd_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Ffreebsd_base.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,4 +1,4 @@\n-use crate::spec::{RelroLevel, TargetOptions};\n+use crate::spec::{FramePointer, RelroLevel, TargetOptions};\n \n pub fn opts() -> TargetOptions {\n     TargetOptions {\n@@ -8,7 +8,7 @@ pub fn opts() -> TargetOptions {\n         families: vec![\"unix\".to_string()],\n         has_rpath: true,\n         position_independent_executables: true,\n-        eliminate_frame_pointer: false, // FIXME 43575\n+        frame_pointer: FramePointer::Always, // FIXME 43575: should be MayOmit...\n         relro_level: RelroLevel::Full,\n         abi_return_struct_as_int: true,\n         dwarf_version: Some(2),"}, {"sha": "f2635f0656d7a738445df4d41d1dda6302f935ed", "filename": "compiler/rustc_target/src/spec/i686_apple_darwin.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fi686_apple_darwin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fi686_apple_darwin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fi686_apple_darwin.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,4 +1,4 @@\n-use crate::spec::{LinkerFlavor, StackProbeType, Target, TargetOptions};\n+use crate::spec::{FramePointer, LinkerFlavor, StackProbeType, Target, TargetOptions};\n \n pub fn target() -> Target {\n     let mut base = super::apple_base::opts(\"macos\");\n@@ -8,7 +8,7 @@ pub fn target() -> Target {\n     base.link_env_remove.extend(super::apple_base::macos_link_env_remove());\n     // don't use probe-stack=inline-asm until rust#83139 and rust#84667 are resolved\n     base.stack_probes = StackProbeType::Call;\n-    base.eliminate_frame_pointer = false;\n+    base.frame_pointer = FramePointer::Always;\n \n     // Clang automatically chooses a more specific target based on\n     // MACOSX_DEPLOYMENT_TARGET.  To enable cross-language LTO to work"}, {"sha": "92c3a1554ac544286cfe96d423ee023b8dd1e5e4", "filename": "compiler/rustc_target/src/spec/i686_pc_windows_gnu.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fi686_pc_windows_gnu.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fi686_pc_windows_gnu.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fi686_pc_windows_gnu.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,12 +1,12 @@\n-use crate::spec::{LinkerFlavor, LldFlavor, Target};\n+use crate::spec::{FramePointer, LinkerFlavor, LldFlavor, Target};\n \n pub fn target() -> Target {\n     let mut base = super::windows_gnu_base::opts();\n     base.cpu = \"pentium4\".to_string();\n     base.pre_link_args\n         .insert(LinkerFlavor::Lld(LldFlavor::Ld), vec![\"-m\".to_string(), \"i386pe\".to_string()]);\n     base.max_atomic_width = Some(64);\n-    base.eliminate_frame_pointer = false; // Required for backtraces\n+    base.frame_pointer = FramePointer::Always; // Required for backtraces\n     base.linker = Some(\"i686-w64-mingw32-gcc\".to_string());\n \n     // Mark all dynamic libraries and executables as compatible with the larger 4GiB address"}, {"sha": "d95cb6a82d558014b7fe66c66a4743747e4a27ed", "filename": "compiler/rustc_target/src/spec/i686_unknown_linux_musl.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fi686_unknown_linux_musl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fi686_unknown_linux_musl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fi686_unknown_linux_musl.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,4 +1,4 @@\n-use crate::spec::{LinkerFlavor, StackProbeType, Target};\n+use crate::spec::{FramePointer, LinkerFlavor, StackProbeType, Target};\n \n pub fn target() -> Target {\n     let mut base = super::linux_musl_base::opts();\n@@ -21,7 +21,7 @@ pub fn target() -> Target {\n     //\n     // This may or may not be related to this bug:\n     // https://llvm.org/bugs/show_bug.cgi?id=30879\n-    base.eliminate_frame_pointer = false;\n+    base.frame_pointer = FramePointer::Always;\n \n     Target {\n         llvm_target: \"i686-unknown-linux-musl\".to_string(),"}, {"sha": "27a0ac585e3919d052447ae396e032537458af75", "filename": "compiler/rustc_target/src/spec/i686_uwp_windows_gnu.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fi686_uwp_windows_gnu.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fi686_uwp_windows_gnu.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fi686_uwp_windows_gnu.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,12 +1,12 @@\n-use crate::spec::{LinkerFlavor, LldFlavor, Target};\n+use crate::spec::{FramePointer, LinkerFlavor, LldFlavor, Target};\n \n pub fn target() -> Target {\n     let mut base = super::windows_uwp_gnu_base::opts();\n     base.cpu = \"pentium4\".to_string();\n     base.pre_link_args\n         .insert(LinkerFlavor::Lld(LldFlavor::Ld), vec![\"-m\".to_string(), \"i386pe\".to_string()]);\n     base.max_atomic_width = Some(64);\n-    base.eliminate_frame_pointer = false; // Required for backtraces\n+    base.frame_pointer = FramePointer::Always; // Required for backtraces\n \n     // Mark all dynamic libraries and executables as compatible with the larger 4GiB address\n     // space available to x86 Windows binaries on x86_64."}, {"sha": "f598f0f38f305c866948831697fcaa2a01cccb12", "filename": "compiler/rustc_target/src/spec/illumos_base.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fillumos_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fillumos_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fillumos_base.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,4 +1,4 @@\n-use crate::spec::{LinkArgs, LinkerFlavor, TargetOptions};\n+use crate::spec::{FramePointer, LinkArgs, LinkerFlavor, TargetOptions};\n use std::default::Default;\n \n pub fn opts() -> TargetOptions {\n@@ -35,7 +35,7 @@ pub fn opts() -> TargetOptions {\n         is_like_solaris: true,\n         linker_is_gnu: false,\n         limit_rdylib_exports: false, // Linker doesn't support this\n-        eliminate_frame_pointer: false,\n+        frame_pointer: FramePointer::Always,\n         eh_frame_header: false,\n         late_link_args,\n "}, {"sha": "a332e3b847a2931af37b42fdb7da436a02157b7f", "filename": "compiler/rustc_target/src/spec/linux_kernel_base.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Flinux_kernel_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Flinux_kernel_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Flinux_kernel_base.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,4 +1,5 @@\n-use crate::spec::{PanicStrategy, RelocModel, RelroLevel, StackProbeType, TargetOptions};\n+use crate::spec::TargetOptions;\n+use crate::spec::{FramePointer, PanicStrategy, RelocModel, RelroLevel, StackProbeType};\n \n pub fn opts() -> TargetOptions {\n     TargetOptions {\n@@ -7,7 +8,7 @@ pub fn opts() -> TargetOptions {\n         panic_strategy: PanicStrategy::Abort,\n         // don't use probe-stack=inline-asm until rust#83139 and rust#84667 are resolved\n         stack_probes: StackProbeType::Call,\n-        eliminate_frame_pointer: false,\n+        frame_pointer: FramePointer::Always,\n         position_independent_executables: true,\n         needs_plt: true,\n         relro_level: RelroLevel::Full,"}, {"sha": "cfdae9623f34a7768a8960099377f11d6fc63e39", "filename": "compiler/rustc_target/src/spec/mod.rs", "status": "modified", "additions": 50, "deletions": 5, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -671,6 +671,42 @@ impl ToJson for SanitizerSet {\n     }\n }\n \n+#[derive(Clone, Copy, PartialEq, Hash, Debug)]\n+pub enum FramePointer {\n+    /// Forces the machine code generator to always preserve the frame pointers.\n+    Always,\n+    /// Forces the machine code generator to preserve the frame pointers except for the leaf\n+    /// functions (i.e. those that don't call other functions).\n+    NonLeaf,\n+    /// Allows the machine code generator to omit the frame pointers.\n+    ///\n+    /// This option does not guarantee that the frame pointers will be omitted.\n+    MayOmit,\n+}\n+\n+impl FromStr for FramePointer {\n+    type Err = ();\n+    fn from_str(s: &str) -> Result<Self, ()> {\n+        Ok(match s {\n+            \"always\" => Self::Always,\n+            \"non-leaf\" => Self::NonLeaf,\n+            \"may-omit\" => Self::MayOmit,\n+            _ => return Err(()),\n+        })\n+    }\n+}\n+\n+impl ToJson for FramePointer {\n+    fn to_json(&self) -> Json {\n+        match *self {\n+            Self::Always => \"always\",\n+            Self::NonLeaf => \"non-leaf\",\n+            Self::MayOmit => \"may-omit\",\n+        }\n+        .to_json()\n+    }\n+}\n+\n macro_rules! supported_targets {\n     ( $(($( $triple:literal, )+ $module:ident ),)+ ) => {\n         $(mod $module;)+\n@@ -1068,8 +1104,8 @@ pub struct TargetOptions {\n     pub tls_model: TlsModel,\n     /// Do not emit code that uses the \"red zone\", if the ABI has one. Defaults to false.\n     pub disable_redzone: bool,\n-    /// Eliminate frame pointers from stack frames if possible. Defaults to true.\n-    pub eliminate_frame_pointer: bool,\n+    /// Frame pointer mode for this target. Defaults to `MayOmit`.\n+    pub frame_pointer: FramePointer,\n     /// Emit each function in its own section. Defaults to true.\n     pub function_sections: bool,\n     /// String to prepend to the name of every dynamic library. Defaults to \"lib\".\n@@ -1330,7 +1366,7 @@ impl Default for TargetOptions {\n             code_model: None,\n             tls_model: TlsModel::GeneralDynamic,\n             disable_redzone: false,\n-            eliminate_frame_pointer: true,\n+            frame_pointer: FramePointer::MayOmit,\n             function_sections: true,\n             dll_prefix: \"lib\".to_string(),\n             dll_suffix: \".so\".to_string(),\n@@ -1833,6 +1869,16 @@ impl Target {\n             }\n         }\n \n+        if let Some(fp) = obj.remove_key(\"frame-pointer\") {\n+            if let Some(s) = Json::as_string(&fp) {\n+                base.frame_pointer = s\n+                    .parse()\n+                    .map_err(|()| format!(\"'{}' is not a valid value for frame-pointer\", s))?;\n+            } else {\n+                incorrect_type.push(\"frame-pointer\".to_string())\n+            }\n+        }\n+\n         key!(is_builtin, bool);\n         key!(c_int_width = \"target-c-int-width\");\n         key!(os);\n@@ -1864,7 +1910,6 @@ impl Target {\n         key!(code_model, CodeModel)?;\n         key!(tls_model, TlsModel)?;\n         key!(disable_redzone, bool);\n-        key!(eliminate_frame_pointer, bool);\n         key!(function_sections, bool);\n         key!(dll_prefix);\n         key!(dll_suffix);\n@@ -2128,7 +2173,7 @@ impl ToJson for Target {\n         target_option_val!(code_model);\n         target_option_val!(tls_model);\n         target_option_val!(disable_redzone);\n-        target_option_val!(eliminate_frame_pointer);\n+        target_option_val!(frame_pointer);\n         target_option_val!(function_sections);\n         target_option_val!(dll_prefix);\n         target_option_val!(dll_suffix);"}, {"sha": "70e9e4aed92495605b2bf338b69a35099b43176e", "filename": "compiler/rustc_target/src/spec/openbsd_base.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fopenbsd_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fopenbsd_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fopenbsd_base.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,4 +1,4 @@\n-use crate::spec::{RelroLevel, TargetOptions};\n+use crate::spec::{FramePointer, RelroLevel, TargetOptions};\n \n pub fn opts() -> TargetOptions {\n     TargetOptions {\n@@ -9,7 +9,7 @@ pub fn opts() -> TargetOptions {\n         has_rpath: true,\n         abi_return_struct_as_int: true,\n         position_independent_executables: true,\n-        eliminate_frame_pointer: false, // FIXME 43575\n+        frame_pointer: FramePointer::Always, // FIXME 43575: should be MayOmit...\n         relro_level: RelroLevel::Full,\n         dwarf_version: Some(2),\n         ..Default::default()"}, {"sha": "fbe4dd5b501801250031909865b2d6dd86b36f96", "filename": "compiler/rustc_target/src/spec/thumb_base.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fthumb_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fthumb_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fthumb_base.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -27,7 +27,8 @@\n // differentiate these targets from our other `arm(v7)-*-*-gnueabi(hf)` targets in the context of\n // build scripts / gcc flags.\n \n-use crate::spec::{LinkerFlavor, LldFlavor, PanicStrategy, RelocModel, TargetOptions};\n+use crate::spec::TargetOptions;\n+use crate::spec::{FramePointer, LinkerFlavor, LldFlavor, PanicStrategy, RelocModel};\n \n pub fn opts() -> TargetOptions {\n     // See rust-lang/rfcs#1645 for a discussion about these defaults\n@@ -52,7 +53,7 @@ pub fn opts() -> TargetOptions {\n         emit_debug_gdb_scripts: false,\n         // LLVM is eager to trash the link register when calling `noreturn` functions, which\n         // breaks debugging. Preserve LR by default to prevent that from happening.\n-        eliminate_frame_pointer: false,\n+        frame_pointer: FramePointer::Always,\n         ..Default::default()\n     }\n }"}, {"sha": "60fd42970c7d6c908ee152473841654081a9bf6d", "filename": "compiler/rustc_target/src/spec/x86_64_apple_darwin.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fx86_64_apple_darwin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/compiler%2Frustc_target%2Fsrc%2Fspec%2Fx86_64_apple_darwin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fx86_64_apple_darwin.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -1,10 +1,11 @@\n-use crate::spec::{LinkerFlavor, SanitizerSet, StackProbeType, Target, TargetOptions};\n+use crate::spec::TargetOptions;\n+use crate::spec::{FramePointer, LinkerFlavor, SanitizerSet, StackProbeType, Target};\n \n pub fn target() -> Target {\n     let mut base = super::apple_base::opts(\"macos\");\n     base.cpu = \"core2\".to_string();\n     base.max_atomic_width = Some(128); // core2 support cmpxchg16b\n-    base.eliminate_frame_pointer = false;\n+    base.frame_pointer = FramePointer::Always;\n     base.pre_link_args.insert(\n         LinkerFlavor::Gcc,\n         vec![\"-m64\".to_string(), \"-arch\".to_string(), \"x86_64\".to_string()],"}, {"sha": "367591dcb9617843bee42b6884a9507254e0e32c", "filename": "src/test/codegen/frame-pointer.rs", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/9b67cba4f6294e0db900397cdf5c59c1dc901ade/src%2Ftest%2Fcodegen%2Fframe-pointer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b67cba4f6294e0db900397cdf5c59c1dc901ade/src%2Ftest%2Fcodegen%2Fframe-pointer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fframe-pointer.rs?ref=9b67cba4f6294e0db900397cdf5c59c1dc901ade", "patch": "@@ -0,0 +1,35 @@\n+// compile-flags: --crate-type=rlib\n+// revisions: aarch64-apple aarch64-linux force x64-apple x64-linux\n+// [aarch64-apple] needs-llvm-components: aarch64\n+// [aarch64-apple] compile-flags: --target=aarch64-apple-darwin\n+// [aarch64-linux] needs-llvm-components: aarch64\n+// [aarch64-linux] compile-flags: --target=aarch64-unknown-linux-gnu\n+// [force] needs-llvm-components: x86\n+// [force] compile-flags: --target=x86_64-unknown-linux-gnu -Cforce-frame-pointers=yes\n+// [x64-apple] needs-llvm-components: x86\n+// [x64-apple] compile-flags: --target=x86_64-apple-darwin\n+// [x64-linux] needs-llvm-components: x86\n+// [x64-linux] compile-flags: --target=x86_64-unknown-linux-gnu\n+\n+#![feature(no_core, lang_items)]\n+#![no_core]\n+#[lang=\"sized\"]\n+trait Sized { }\n+#[lang=\"copy\"]\n+trait Copy { }\n+\n+\n+\n+// CHECK: define i32 @peach{{.*}}[[PEACH_ATTRS:\\#[0-9]+]] {\n+#[no_mangle]\n+pub fn peach(x: u32) -> u32 {\n+    x\n+}\n+\n+// CHECK: attributes [[PEACH_ATTRS]] = {\n+// x64-linux-NOT: {{.*}}\"frame-pointer\"{{.*}}\n+// aarch64-linux-NOT: {{.*}}\"frame-pointer\"{{.*}}\n+// x64-apple-SAME: {{.*}}\"frame-pointer\"=\"all\"\n+// force-SAME: {{.*}}\"frame-pointer\"=\"all\"\n+// aarch64-apple-SAME: {{.*}}\"frame-pointer\"=\"non-leaf\"\n+// CHECK-SAME: }"}]}