{"sha": "84d6c68822bc7c6312a00226de90fb7cdf79494c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg0ZDZjNjg4MjJiYzdjNjMxMmEwMDIyNmRlOTBmYjdjZGY3OTQ5NGM=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-06-19T01:14:14Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-19T01:14:14Z"}, "message": "Rollup merge of #86444 - FabianWolff:issue-83505, r=LeSeulArtichaut\n\nFix ICE with `#[repr(simd)]` on enum\n\nThis pull request fixes #83505. `#[repr(simd)]` may only be applied to structs, which correctly causes `E0517` for the example given in #83505, but the compiler attempts to recover from this error, which leads to an ICE later, when `.non_enum_variant()` is called on the `AdtDef`. I have added a check that prevents this from happening.", "tree": {"sha": "f6be3106e2402ceefee0f8ae32cb8792c043558d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f6be3106e2402ceefee0f8ae32cb8792c043558d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/84d6c68822bc7c6312a00226de90fb7cdf79494c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgzUTnCRBK7hj4Ov3rIwAAaB4IAIW8LYZNs+qVI+nwpxGTXPUM\n7DWOrCS01TulbdN0r1iSe663u05rflCI/kiqKtHBkRK+xnK/giolM7BPp1x9QRec\nbBfdJAKn+1FNZdHSy/k0xe3azwvUmDEylYWou17CBBi/tq/AehJVJknQ+aP4B24k\numHjKNtDUTqLJXyH4oaXERnS9hb7XO5AEH6GftjX12ghqNgt20DWmVtr+RA2TudF\n4R6nagUGf1UC0+W15w+lCjShqN+qfTNiHCgdYhR0US463Z+CAIvnPGSFQpJPbcnx\nLfct9FJjolwctNEQseWMvGmMWfXrXL/Y8YxnXM2PD4GhEz0Kvvqd2qSKNTDN6p8=\n=dhVx\n-----END PGP SIGNATURE-----\n", "payload": "tree f6be3106e2402ceefee0f8ae32cb8792c043558d\nparent 90e5fe5f86a65fbd102e76f439f8c8d284d309d0\nparent e7a1186c6d4793a5265690dfd17fb05b15bf04ec\nauthor Yuki Okushi <jtitor@2k36.org> 1624065254 +0900\ncommitter GitHub <noreply@github.com> 1624065254 +0900\n\nRollup merge of #86444 - FabianWolff:issue-83505, r=LeSeulArtichaut\n\nFix ICE with `#[repr(simd)]` on enum\n\nThis pull request fixes #83505. `#[repr(simd)]` may only be applied to structs, which correctly causes `E0517` for the example given in #83505, but the compiler attempts to recover from this error, which leads to an ICE later, when `.non_enum_variant()` is called on the `AdtDef`. I have added a check that prevents this from happening.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/84d6c68822bc7c6312a00226de90fb7cdf79494c", "html_url": "https://github.com/rust-lang/rust/commit/84d6c68822bc7c6312a00226de90fb7cdf79494c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/84d6c68822bc7c6312a00226de90fb7cdf79494c/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "90e5fe5f86a65fbd102e76f439f8c8d284d309d0", "url": "https://api.github.com/repos/rust-lang/rust/commits/90e5fe5f86a65fbd102e76f439f8c8d284d309d0", "html_url": "https://github.com/rust-lang/rust/commit/90e5fe5f86a65fbd102e76f439f8c8d284d309d0"}, {"sha": "e7a1186c6d4793a5265690dfd17fb05b15bf04ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7a1186c6d4793a5265690dfd17fb05b15bf04ec", "html_url": "https://github.com/rust-lang/rust/commit/e7a1186c6d4793a5265690dfd17fb05b15bf04ec"}], "stats": {"total": 49, "additions": 49, "deletions": 0}, "files": [{"sha": "6b1ec1b0646aec1354d6ade066bd2539fae58b32", "filename": "compiler/rustc_middle/src/ty/layout.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/84d6c68822bc7c6312a00226de90fb7cdf79494c/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84d6c68822bc7c6312a00226de90fb7cdf79494c/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs?ref=84d6c68822bc7c6312a00226de90fb7cdf79494c", "patch": "@@ -672,6 +672,15 @@ impl<'tcx> LayoutCx<'tcx, TyCtxt<'tcx>> {\n \n             // SIMD vector types.\n             ty::Adt(def, substs) if def.repr.simd() => {\n+                if !def.is_struct() {\n+                    // Should have yielded E0517 by now.\n+                    tcx.sess.delay_span_bug(\n+                        DUMMY_SP,\n+                        \"#[repr(simd)] was applied to an ADT that is not a struct\",\n+                    );\n+                    return Err(LayoutError::Unknown(ty));\n+                }\n+\n                 // Supported SIMD vectors are homogeneous ADTs with at least one field:\n                 //\n                 // * #[repr(simd)] struct S(T, T, T, T);"}, {"sha": "280b771d0153925fe3f0cc394af6c72a7eec8468", "filename": "src/test/ui/repr/issue-83505-repr-simd.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/84d6c68822bc7c6312a00226de90fb7cdf79494c/src%2Ftest%2Fui%2Frepr%2Fissue-83505-repr-simd.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84d6c68822bc7c6312a00226de90fb7cdf79494c/src%2Ftest%2Fui%2Frepr%2Fissue-83505-repr-simd.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frepr%2Fissue-83505-repr-simd.rs?ref=84d6c68822bc7c6312a00226de90fb7cdf79494c", "patch": "@@ -0,0 +1,10 @@\n+// Regression test for the ICE described in #83505.\n+\n+#![crate_type=\"lib\"]\n+\n+#[repr(simd)]\n+//~^ ERROR: attribute should be applied to a struct [E0517]\n+//~| ERROR: unsupported representation for zero-variant enum [E0084]\n+enum Es {}\n+static CLs: Es;\n+//~^ ERROR: free static item without body"}, {"sha": "f1390a652016b2e1b4a8048c1ee612f6949215cb", "filename": "src/test/ui/repr/issue-83505-repr-simd.stderr", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/84d6c68822bc7c6312a00226de90fb7cdf79494c/src%2Ftest%2Fui%2Frepr%2Fissue-83505-repr-simd.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/84d6c68822bc7c6312a00226de90fb7cdf79494c/src%2Ftest%2Fui%2Frepr%2Fissue-83505-repr-simd.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frepr%2Fissue-83505-repr-simd.stderr?ref=84d6c68822bc7c6312a00226de90fb7cdf79494c", "patch": "@@ -0,0 +1,30 @@\n+error: free static item without body\n+  --> $DIR/issue-83505-repr-simd.rs:9:1\n+   |\n+LL | static CLs: Es;\n+   | ^^^^^^^^^^^^^^-\n+   |               |\n+   |               help: provide a definition for the static: `= <expr>;`\n+\n+error[E0517]: attribute should be applied to a struct\n+  --> $DIR/issue-83505-repr-simd.rs:5:8\n+   |\n+LL | #[repr(simd)]\n+   |        ^^^^\n+...\n+LL | enum Es {}\n+   | ---------- not a struct\n+\n+error[E0084]: unsupported representation for zero-variant enum\n+  --> $DIR/issue-83505-repr-simd.rs:5:1\n+   |\n+LL | #[repr(simd)]\n+   | ^^^^^^^^^^^^^\n+...\n+LL | enum Es {}\n+   | ---------- zero-variant enum\n+\n+error: aborting due to 3 previous errors\n+\n+Some errors have detailed explanations: E0084, E0517.\n+For more information about an error, try `rustc --explain E0084`."}]}