{"sha": "025481a5eb519f3f9e34e61cd67bbbcc2591e1a8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAyNTQ4MWE1ZWI1MTlmM2Y5ZTM0ZTYxY2Q2N2JiYmNjMjU5MWUxYTg=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-10-23T09:26:32Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-10-23T09:26:32Z"}, "message": "Rollup merge of #78153 - est31:downloaded_llvm_maybe_sync, r=Mark-Simulacrum\n\nSync LLVM submodule if it has been initialized\n\nSince having enabled the download-ci-llvm option,\nand having rebased on top of #76864,\nI've noticed that I had to update the llvm-project\nsubmodule manually if it was checked out.\nOrignally, the submodule update logic was\nintroduced to reduce the friction for contributors\nto manage the submodules, or in other words, to prevent\ngetting PRs that have unwanted submodule rollbacks\nbecause the contributors didn't run git submodule update.\n\nThis commit adds logic to ensure there is no inadvertent\nLLVM submodule rollback in a PR if download-ci-llvm\n(or llvm-config) is enabled. It will detect whether the\nllvm-project submodule is initialized, and if so, update\nit in any case. If it is not initialized, behaviour is\nkept to not do any update/initialization.\n\nAn alternative to the chosen implementation would\nbe to not pass the --init command line arg to\n`git submodule update` for the src/llvm-project\nsubmodule. This would show a confusing error message\nhowever on all builds with an uninitialized repo.\nWe could pass the --silent param, but we still want\nit to print something if it is initialized and has\nto update something.\nSo we just do a manual check for whether the\nsubmodule is initialized.", "tree": {"sha": "2363ae80c82edeec700461329c282c09b23ee86e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2363ae80c82edeec700461329c282c09b23ee86e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/025481a5eb519f3f9e34e61cd67bbbcc2591e1a8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfkqHICRBK7hj4Ov3rIwAAdHIIAIw8Z+ZYw2VPWkExylFJfJ9N\nOz/Xge0p+LqkXMjhm2GdKdybyI3gOUvU+NVcj/kYS9Mjv1Q0fS25iFEru2+wVUK/\nU6caQZy85q+SmMrA2rfPozHGSqfXGIrLGF5TlJf/DrfifNsDtuCQxIoD4fFn2OJL\n8SiJNXzviszYCDOwJpV56fHw2sKxBt1+nN5PqcF0pTnPcU/W7cAO1iXHv+nFezw8\nCkUNsLf/pbgJ6C2XBbebt4DKr/T17GcGnmTpj++pdQ2Zksxm0OQhqr5X2HYXv+gb\nexLj5XuiTgoc8rl1JgSVfBLtROZL9SBSRxiPETJ0ugJYaxEgaGpSYMqbOczbQ/s=\n=QbyJ\n-----END PGP SIGNATURE-----\n", "payload": "tree 2363ae80c82edeec700461329c282c09b23ee86e\nparent 982c4b3081118806f6ce3ca77dcaf28fcc1555d7\nparent 5948e62f3443df626cc803fd3a08bc24e42209e8\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1603445192 +0900\ncommitter GitHub <noreply@github.com> 1603445192 +0900\n\nRollup merge of #78153 - est31:downloaded_llvm_maybe_sync, r=Mark-Simulacrum\n\nSync LLVM submodule if it has been initialized\n\nSince having enabled the download-ci-llvm option,\nand having rebased on top of #76864,\nI've noticed that I had to update the llvm-project\nsubmodule manually if it was checked out.\nOrignally, the submodule update logic was\nintroduced to reduce the friction for contributors\nto manage the submodules, or in other words, to prevent\ngetting PRs that have unwanted submodule rollbacks\nbecause the contributors didn't run git submodule update.\n\nThis commit adds logic to ensure there is no inadvertent\nLLVM submodule rollback in a PR if download-ci-llvm\n(or llvm-config) is enabled. It will detect whether the\nllvm-project submodule is initialized, and if so, update\nit in any case. If it is not initialized, behaviour is\nkept to not do any update/initialization.\n\nAn alternative to the chosen implementation would\nbe to not pass the --init command line arg to\n`git submodule update` for the src/llvm-project\nsubmodule. This would show a confusing error message\nhowever on all builds with an uninitialized repo.\nWe could pass the --silent param, but we still want\nit to print something if it is initialized and has\nto update something.\nSo we just do a manual check for whether the\nsubmodule is initialized.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/025481a5eb519f3f9e34e61cd67bbbcc2591e1a8", "html_url": "https://github.com/rust-lang/rust/commit/025481a5eb519f3f9e34e61cd67bbbcc2591e1a8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/025481a5eb519f3f9e34e61cd67bbbcc2591e1a8/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "982c4b3081118806f6ce3ca77dcaf28fcc1555d7", "url": "https://api.github.com/repos/rust-lang/rust/commits/982c4b3081118806f6ce3ca77dcaf28fcc1555d7", "html_url": "https://github.com/rust-lang/rust/commit/982c4b3081118806f6ce3ca77dcaf28fcc1555d7"}, {"sha": "5948e62f3443df626cc803fd3a08bc24e42209e8", "url": "https://api.github.com/repos/rust-lang/rust/commits/5948e62f3443df626cc803fd3a08bc24e42209e8", "html_url": "https://github.com/rust-lang/rust/commit/5948e62f3443df626cc803fd3a08bc24e42209e8"}], "stats": {"total": 7, "additions": 6, "deletions": 1}, "files": [{"sha": "8fe0d2584f7a91d1d355913ffa5c21e20e1d27ef", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/025481a5eb519f3f9e34e61cd67bbbcc2591e1a8/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/025481a5eb519f3f9e34e61cd67bbbcc2591e1a8/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=025481a5eb519f3f9e34e61cd67bbbcc2591e1a8", "patch": "@@ -893,10 +893,15 @@ def update_submodules(self):\n         ).decode(default_encoding).splitlines()]\n         filtered_submodules = []\n         submodules_names = []\n+        llvm_checked_out = os.path.exists(os.path.join(self.rust_root, \"src/llvm-project/.git\"))\n         for module in submodules:\n             if module.endswith(\"llvm-project\"):\n+                # Don't sync the llvm-project submodule either if an external LLVM\n+                # was provided, or if we are downloading LLVM. Also, if the\n+                # submodule has been initialized already, sync it anyways so that\n+                # it doesn't mess up contributor pull requests.\n                 if self.get_toml('llvm-config') or self.downloading_llvm():\n-                    if self.get_toml('lld') != 'true':\n+                    if self.get_toml('lld') != 'true' and not llvm_checked_out:\n                         continue\n             check = self.check_submodule(module, slow_submodules)\n             filtered_submodules.append((module, check))"}]}