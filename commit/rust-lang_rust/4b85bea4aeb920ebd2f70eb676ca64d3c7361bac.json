{"sha": "4b85bea4aeb920ebd2f70eb676ca64d3c7361bac", "node_id": "C_kwDOAAsO6NoAKDRiODViZWE0YWViOTIwZWJkMmY3MGViNjc2Y2E2NGQzYzczNjFiYWM", "commit": {"author": {"name": "Santiago Pastorino", "email": "spastorino@gmail.com", "date": "2023-04-24T20:53:51Z"}, "committer": {"name": "Santiago Pastorino", "email": "spastorino@gmail.com", "date": "2023-05-05T13:34:52Z"}, "message": "Add Assert terminator to SMIR", "tree": {"sha": "ee6356fdc4b1b0785d69f3bc2bcb463c4b69f890", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ee6356fdc4b1b0785d69f3bc2bcb463c4b69f890"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEF0ntrgrd9qf9uuThgTGiTgx5768FAmRVBf0ACgkQgTGiTgx5\n76+h6A/9F893+REeHA4dtoSX5ihvpI89/Yvh6MBs7pXQd6sjR3mVZ5p/9UJIf8wX\n8uPYzOjfjSC393OoUmhfC1lSZLBUiPgsu2yn6/nuUnGg7g+kVMGDkUA4zRNan6NP\na1f2EGi+N2xH/KE48bHqmjxe+1is8l24sp2vO3J8TgO+JO08cyJ9eBreyd/L8PMx\n0uTsyOXFIgOd0z+cnUZTI3W+lskO4WumJ9UXg6Uva7PX2253F/fHbO3nD2U0NXQh\nL433L8ca+zNfue6ecW6HEsgTEVvONDrdXdyxXaWraaIC/uES+1ceyQWGafgQSap/\n+i6e+wdW7biWig9i8DZF/EGFV9cbr5mvDbwrvw8VFYsB4saBiLbXFezDbXDUk4MG\n2PxOJ8HL8nh98cQI6+zaoxTaRiP/XCnJt8rcUZsH77eCDwJILnS4DgONFqOvj3yy\nPYPQKqUf9pbEs7ezufmWET/Mritmo6NW2gyM2gO+uwiwdwJzPhMd4zwrinr61XSF\n/o82zAMQUz2vQ8gqvQet3cKb3YbSluP+19W9yUeWETp55klZSiR7qwp6niWT2foz\nIfFWa023Q0osAhTuGdQIDG1koehkGkmrGIhKCy1OHYn2t+9JtwNNxY3D3OGkP2rv\nyNOJL3yQlfPF2V8sNuy0PKYVsZsAah97BW2tlpascT1GnzWeNBw=\n=swlT\n-----END PGP SIGNATURE-----", "payload": "tree ee6356fdc4b1b0785d69f3bc2bcb463c4b69f890\nparent 7dd59fceef202e6849f575dd057bb90351362eba\nauthor Santiago Pastorino <spastorino@gmail.com> 1682369631 -0300\ncommitter Santiago Pastorino <spastorino@gmail.com> 1683293692 -0300\n\nAdd Assert terminator to SMIR\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac", "html_url": "https://github.com/rust-lang/rust/commit/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac/comments", "author": {"login": "spastorino", "id": 52642, "node_id": "MDQ6VXNlcjUyNjQy", "avatar_url": "https://avatars.githubusercontent.com/u/52642?v=4", "gravatar_id": "", "url": "https://api.github.com/users/spastorino", "html_url": "https://github.com/spastorino", "followers_url": "https://api.github.com/users/spastorino/followers", "following_url": "https://api.github.com/users/spastorino/following{/other_user}", "gists_url": "https://api.github.com/users/spastorino/gists{/gist_id}", "starred_url": "https://api.github.com/users/spastorino/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/spastorino/subscriptions", "organizations_url": "https://api.github.com/users/spastorino/orgs", "repos_url": "https://api.github.com/users/spastorino/repos", "events_url": "https://api.github.com/users/spastorino/events{/privacy}", "received_events_url": "https://api.github.com/users/spastorino/received_events", "type": "User", "site_admin": false}, "committer": {"login": "spastorino", "id": 52642, "node_id": "MDQ6VXNlcjUyNjQy", "avatar_url": "https://avatars.githubusercontent.com/u/52642?v=4", "gravatar_id": "", "url": "https://api.github.com/users/spastorino", "html_url": "https://github.com/spastorino", "followers_url": "https://api.github.com/users/spastorino/followers", "following_url": "https://api.github.com/users/spastorino/following{/other_user}", "gists_url": "https://api.github.com/users/spastorino/gists{/gist_id}", "starred_url": "https://api.github.com/users/spastorino/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/spastorino/subscriptions", "organizations_url": "https://api.github.com/users/spastorino/orgs", "repos_url": "https://api.github.com/users/spastorino/repos", "events_url": "https://api.github.com/users/spastorino/events{/privacy}", "received_events_url": "https://api.github.com/users/spastorino/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7dd59fceef202e6849f575dd057bb90351362eba", "url": "https://api.github.com/repos/rust-lang/rust/commits/7dd59fceef202e6849f575dd057bb90351362eba", "html_url": "https://github.com/rust-lang/rust/commit/7dd59fceef202e6849f575dd057bb90351362eba"}], "stats": {"total": 202, "additions": 191, "deletions": 11}, "files": [{"sha": "c7a91ef71166d4e0b5f247c14466bde6229b0550", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=4b85bea4aeb920ebd2f70eb676ca64d3c7361bac", "patch": "@@ -4090,6 +4090,7 @@ dependencies = [\n name = \"rustc_smir\"\n version = \"0.0.0\"\n dependencies = [\n+ \"rustc_hir\",\n  \"rustc_middle\",\n  \"rustc_span\",\n  \"tracing\","}, {"sha": "80360a3c73f8dcfddbff2b5ab5c324f9f0c0662f", "filename": "compiler/rustc_smir/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac/compiler%2Frustc_smir%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac/compiler%2Frustc_smir%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_smir%2FCargo.toml?ref=4b85bea4aeb920ebd2f70eb676ca64d3c7361bac", "patch": "@@ -4,6 +4,7 @@ version = \"0.0.0\"\n edition = \"2021\"\n \n [dependencies]\n+rustc_hir = { path = \"../rustc_hir\" }\n rustc_middle = { path = \"../rustc_middle\", optional = true }\n rustc_span = { path = \"../rustc_span\", optional = true }\n tracing = \"0.1\""}, {"sha": "efbb3b321d5a7ddb8f23783194fd7cd131cdb78a", "filename": "compiler/rustc_smir/src/rustc_smir/mod.rs", "status": "modified", "additions": 111, "deletions": 7, "changes": 118, "blob_url": "https://github.com/rust-lang/rust/blob/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac/compiler%2Frustc_smir%2Fsrc%2Frustc_smir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac/compiler%2Frustc_smir%2Fsrc%2Frustc_smir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_smir%2Fsrc%2Frustc_smir%2Fmod.rs?ref=4b85bea4aeb920ebd2f70eb676ca64d3c7361bac", "patch": "@@ -93,20 +93,26 @@ fn rustc_statement_to_statement(\n     }\n }\n \n-fn rustc_rvalue_to_rvalue(rvalue: &rustc_middle::mir::Rvalue<'_>) -> stable_mir::mir::Operand {\n+fn rustc_rvalue_to_rvalue(rvalue: &rustc_middle::mir::Rvalue<'_>) -> stable_mir::mir::Rvalue {\n     use rustc_middle::mir::Rvalue::*;\n     match rvalue {\n-        Use(op) => rustc_op_to_op(op),\n+        Use(op) => stable_mir::mir::Rvalue::Use(rustc_op_to_op(op)),\n         Repeat(_, _) => todo!(),\n         Ref(_, _, _) => todo!(),\n         ThreadLocalRef(_) => todo!(),\n         AddressOf(_, _) => todo!(),\n         Len(_) => todo!(),\n         Cast(_, _, _) => todo!(),\n         BinaryOp(_, _) => todo!(),\n-        CheckedBinaryOp(_, _) => todo!(),\n+        CheckedBinaryOp(bin_op, ops) => stable_mir::mir::Rvalue::CheckedBinaryOp(\n+            rustc_bin_op_to_bin_op(bin_op),\n+            rustc_op_to_op(&ops.0),\n+            rustc_op_to_op(&ops.1),\n+        ),\n         NullaryOp(_, _) => todo!(),\n-        UnaryOp(_, _) => todo!(),\n+        UnaryOp(un_op, op) => {\n+            stable_mir::mir::Rvalue::UnaryOp(rustc_un_op_to_un_op(un_op), rustc_op_to_op(op))\n+        }\n         Discriminant(_) => todo!(),\n         Aggregate(_, _) => todo!(),\n         ShallowInitBox(_, _) => todo!(),\n@@ -124,8 +130,10 @@ fn rustc_op_to_op(op: &rustc_middle::mir::Operand<'_>) -> stable_mir::mir::Opera\n }\n \n fn rustc_place_to_place(place: &rustc_middle::mir::Place<'_>) -> stable_mir::mir::Place {\n-    assert_eq!(&place.projection[..], &[]);\n-    stable_mir::mir::Place { local: place.local.as_usize() }\n+    stable_mir::mir::Place {\n+        local: place.local.as_usize(),\n+        projection: format!(\"{:?}\", place.projection),\n+    }\n }\n \n fn rustc_unwind_to_unwind(\n@@ -140,6 +148,96 @@ fn rustc_unwind_to_unwind(\n     }\n }\n \n+fn rustc_assert_msg_to_msg<'tcx>(\n+    assert_message: &rustc_middle::mir::AssertMessage<'tcx>,\n+) -> stable_mir::mir::AssertMessage {\n+    use rustc_middle::mir::AssertKind;\n+    match assert_message {\n+        AssertKind::BoundsCheck { len, index } => stable_mir::mir::AssertMessage::BoundsCheck {\n+            len: rustc_op_to_op(len),\n+            index: rustc_op_to_op(index),\n+        },\n+        AssertKind::Overflow(bin_op, op1, op2) => stable_mir::mir::AssertMessage::Overflow(\n+            rustc_bin_op_to_bin_op(bin_op),\n+            rustc_op_to_op(op1),\n+            rustc_op_to_op(op2),\n+        ),\n+        AssertKind::OverflowNeg(op) => {\n+            stable_mir::mir::AssertMessage::OverflowNeg(rustc_op_to_op(op))\n+        }\n+        AssertKind::DivisionByZero(op) => {\n+            stable_mir::mir::AssertMessage::DivisionByZero(rustc_op_to_op(op))\n+        }\n+        AssertKind::RemainderByZero(op) => {\n+            stable_mir::mir::AssertMessage::RemainderByZero(rustc_op_to_op(op))\n+        }\n+        AssertKind::ResumedAfterReturn(generator) => {\n+            stable_mir::mir::AssertMessage::ResumedAfterReturn(rustc_generator_to_generator(\n+                generator,\n+            ))\n+        }\n+        AssertKind::ResumedAfterPanic(generator) => {\n+            stable_mir::mir::AssertMessage::ResumedAfterPanic(rustc_generator_to_generator(\n+                generator,\n+            ))\n+        }\n+        AssertKind::MisalignedPointerDereference { required, found } => {\n+            stable_mir::mir::AssertMessage::MisalignedPointerDereference {\n+                required: rustc_op_to_op(required),\n+                found: rustc_op_to_op(found),\n+            }\n+        }\n+    }\n+}\n+\n+fn rustc_bin_op_to_bin_op(bin_op: &rustc_middle::mir::BinOp) -> stable_mir::mir::BinOp {\n+    use rustc_middle::mir::BinOp;\n+    match bin_op {\n+        BinOp::Add => stable_mir::mir::BinOp::Add,\n+        BinOp::Sub => stable_mir::mir::BinOp::Sub,\n+        BinOp::Mul => stable_mir::mir::BinOp::Mul,\n+        BinOp::Div => stable_mir::mir::BinOp::Div,\n+        BinOp::Rem => stable_mir::mir::BinOp::Rem,\n+        BinOp::BitXor => stable_mir::mir::BinOp::BitXor,\n+        BinOp::BitAnd => stable_mir::mir::BinOp::BitAnd,\n+        BinOp::BitOr => stable_mir::mir::BinOp::BitOr,\n+        BinOp::Shl => stable_mir::mir::BinOp::Shl,\n+        BinOp::Shr => stable_mir::mir::BinOp::Shr,\n+        BinOp::Eq => stable_mir::mir::BinOp::Eq,\n+        BinOp::Lt => stable_mir::mir::BinOp::Lt,\n+        BinOp::Le => stable_mir::mir::BinOp::Le,\n+        BinOp::Ne => stable_mir::mir::BinOp::Ne,\n+        BinOp::Ge => stable_mir::mir::BinOp::Ge,\n+        BinOp::Gt => stable_mir::mir::BinOp::Gt,\n+        BinOp::Offset => stable_mir::mir::BinOp::Offset,\n+    }\n+}\n+\n+fn rustc_un_op_to_un_op(unary_op: &rustc_middle::mir::UnOp) -> stable_mir::mir::UnOp {\n+    use rustc_middle::mir::UnOp;\n+    match unary_op {\n+        UnOp::Not => stable_mir::mir::UnOp::Not,\n+        UnOp::Neg => stable_mir::mir::UnOp::Neg,\n+    }\n+}\n+\n+fn rustc_generator_to_generator(\n+    generator: &rustc_hir::GeneratorKind,\n+) -> stable_mir::mir::GeneratorKind {\n+    use rustc_hir::{AsyncGeneratorKind, GeneratorKind};\n+    match generator {\n+        GeneratorKind::Async(async_gen) => {\n+            let async_gen = match async_gen {\n+                AsyncGeneratorKind::Block => stable_mir::mir::AsyncGeneratorKind::Block,\n+                AsyncGeneratorKind::Closure => stable_mir::mir::AsyncGeneratorKind::Closure,\n+                AsyncGeneratorKind::Fn => stable_mir::mir::AsyncGeneratorKind::Fn,\n+            };\n+            stable_mir::mir::GeneratorKind::Async(async_gen)\n+        }\n+        GeneratorKind::Gen => stable_mir::mir::GeneratorKind::Gen,\n+    }\n+}\n+\n fn rustc_terminator_to_terminator(\n     terminator: &rustc_middle::mir::Terminator<'_>,\n ) -> stable_mir::mir::Terminator {\n@@ -176,7 +274,13 @@ fn rustc_terminator_to_terminator(\n                 unwind: rustc_unwind_to_unwind(unwind),\n             }\n         }\n-        Assert { .. } => todo!(),\n+        Assert { cond, expected, msg, target, unwind } => Terminator::Assert {\n+            cond: rustc_op_to_op(cond),\n+            expected: *expected,\n+            msg: rustc_assert_msg_to_msg(msg),\n+            target: target.as_usize(),\n+            unwind: rustc_unwind_to_unwind(unwind),\n+        },\n         Yield { .. } => todo!(),\n         GeneratorDrop => todo!(),\n         FalseEdge { .. } => todo!(),"}, {"sha": "699c94573810332482560ec2997ae6329f2cac9b", "filename": "compiler/rustc_smir/src/stable_mir/mir/body.rs", "status": "modified", "additions": 64, "deletions": 3, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac/compiler%2Frustc_smir%2Fsrc%2Fstable_mir%2Fmir%2Fbody.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac/compiler%2Frustc_smir%2Fsrc%2Fstable_mir%2Fmir%2Fbody.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_smir%2Fsrc%2Fstable_mir%2Fmir%2Fbody.rs?ref=4b85bea4aeb920ebd2f70eb676ca64d3c7361bac", "patch": "@@ -38,9 +38,9 @@ pub enum Terminator {\n     Assert {\n         cond: Operand,\n         expected: bool,\n-        msg: String,\n+        msg: AssertMessage,\n         target: usize,\n-        cleanup: Option<usize>,\n+        unwind: UnwindAction,\n     },\n }\n \n@@ -52,12 +52,72 @@ pub enum UnwindAction {\n     Cleanup(usize),\n }\n \n+#[derive(Clone, Debug)]\n+pub enum AssertMessage {\n+    BoundsCheck { len: Operand, index: Operand },\n+    Overflow(BinOp, Operand, Operand),\n+    OverflowNeg(Operand),\n+    DivisionByZero(Operand),\n+    RemainderByZero(Operand),\n+    ResumedAfterReturn(GeneratorKind),\n+    ResumedAfterPanic(GeneratorKind),\n+    MisalignedPointerDereference { required: Operand, found: Operand },\n+}\n+\n+#[derive(Clone, Debug)]\n+pub enum BinOp {\n+    Add,\n+    Sub,\n+    Mul,\n+    Div,\n+    Rem,\n+    BitXor,\n+    BitAnd,\n+    BitOr,\n+    Shl,\n+    Shr,\n+    Eq,\n+    Lt,\n+    Le,\n+    Ne,\n+    Ge,\n+    Gt,\n+    Offset,\n+}\n+\n+#[derive(Clone, Debug)]\n+pub enum UnOp {\n+    Not,\n+    Neg,\n+}\n+\n+#[derive(Clone, Debug)]\n+pub enum GeneratorKind {\n+    Async(AsyncGeneratorKind),\n+    Gen,\n+}\n+\n+#[derive(Clone, Debug)]\n+pub enum AsyncGeneratorKind {\n+    Block,\n+    Closure,\n+    Fn,\n+}\n+\n #[derive(Clone, Debug)]\n pub enum Statement {\n-    Assign(Place, Operand),\n+    Assign(Place, Rvalue),\n     Nop,\n }\n \n+// FIXME this is incomplete\n+#[derive(Clone, Debug)]\n+pub enum Rvalue {\n+    Use(Operand),\n+    CheckedBinaryOp(BinOp, Operand, Operand),\n+    UnaryOp(UnOp, Operand),\n+}\n+\n #[derive(Clone, Debug)]\n pub enum Operand {\n     Copy(Place),\n@@ -68,6 +128,7 @@ pub enum Operand {\n #[derive(Clone, Debug)]\n pub struct Place {\n     pub local: usize,\n+    pub projection: String,\n }\n \n #[derive(Clone, Debug)]"}, {"sha": "1454d6dde6c979402019acd911dc4ee7cfe94cab", "filename": "tests/ui-fulldeps/stable-mir/crate-info.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac/tests%2Fui-fulldeps%2Fstable-mir%2Fcrate-info.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b85bea4aeb920ebd2f70eb676ca64d3c7361bac/tests%2Fui-fulldeps%2Fstable-mir%2Fcrate-info.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-fulldeps%2Fstable-mir%2Fcrate-info.rs?ref=4b85bea4aeb920ebd2f70eb676ca64d3c7361bac", "patch": "@@ -69,6 +69,15 @@ fn test_stable_mir(tcx: TyCtxt<'_>) {\n         stable_mir::mir::Terminator::Drop { .. } => {}\n         other => panic!(\"{other:?}\"),\n     }\n+\n+    let assert = get_item(tcx, &items, (DefKind::Fn, \"assert\")).unwrap();\n+    let body = assert.body();\n+    assert_eq!(body.blocks.len(), 2);\n+    let block = &body.blocks[0];\n+    match &block.terminator {\n+        stable_mir::mir::Terminator::Assert { .. } => {}\n+        other => panic!(\"{other:?}\"),\n+    }\n }\n \n // Use internal API to find a function in a crate.\n@@ -142,7 +151,11 @@ fn generate_input(path: &str) -> std::io::Result<()> {\n         x_64.wrapping_add(y_64)\n     }}\n \n-    pub fn drop(_: String) {{}}\"#\n+    pub fn drop(_: String) {{}}\n+\n+    pub fn assert(x: i32) -> i32 {{\n+        x + 1\n+    }}\"#\n     )?;\n     Ok(())\n }"}]}