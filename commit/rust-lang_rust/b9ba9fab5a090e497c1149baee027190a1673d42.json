{"sha": "b9ba9fab5a090e497c1149baee027190a1673d42", "node_id": "C_kwDOAAsO6NoAKGI5YmE5ZmFiNWEwOTBlNDk3YzExNDliYWVlMDI3MTkwYTE2NzNkNDI", "commit": {"author": {"name": "hi-rustin", "email": "rustin.liu@gmail.com", "date": "2022-07-05T14:43:38Z"}, "committer": {"name": "hi-rustin", "email": "rustin.liu@gmail.com", "date": "2022-07-05T14:47:18Z"}, "message": "Add str_ref_to_string fix\n\nSigned-off-by: hi-rustin <rustin.liu@gmail.com>", "tree": {"sha": "13aaf4c4227b917d0fd4aac79726d0bee9366a89", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/13aaf4c4227b917d0fd4aac79726d0bee9366a89"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b9ba9fab5a090e497c1149baee027190a1673d42", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b9ba9fab5a090e497c1149baee027190a1673d42", "html_url": "https://github.com/rust-lang/rust/commit/b9ba9fab5a090e497c1149baee027190a1673d42", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b9ba9fab5a090e497c1149baee027190a1673d42/comments", "author": {"login": "hi-rustin", "id": 29879298, "node_id": "MDQ6VXNlcjI5ODc5Mjk4", "avatar_url": "https://avatars.githubusercontent.com/u/29879298?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hi-rustin", "html_url": "https://github.com/hi-rustin", "followers_url": "https://api.github.com/users/hi-rustin/followers", "following_url": "https://api.github.com/users/hi-rustin/following{/other_user}", "gists_url": "https://api.github.com/users/hi-rustin/gists{/gist_id}", "starred_url": "https://api.github.com/users/hi-rustin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hi-rustin/subscriptions", "organizations_url": "https://api.github.com/users/hi-rustin/orgs", "repos_url": "https://api.github.com/users/hi-rustin/repos", "events_url": "https://api.github.com/users/hi-rustin/events{/privacy}", "received_events_url": "https://api.github.com/users/hi-rustin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "hi-rustin", "id": 29879298, "node_id": "MDQ6VXNlcjI5ODc5Mjk4", "avatar_url": "https://avatars.githubusercontent.com/u/29879298?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hi-rustin", "html_url": "https://github.com/hi-rustin", "followers_url": "https://api.github.com/users/hi-rustin/followers", "following_url": "https://api.github.com/users/hi-rustin/following{/other_user}", "gists_url": "https://api.github.com/users/hi-rustin/gists{/gist_id}", "starred_url": "https://api.github.com/users/hi-rustin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hi-rustin/subscriptions", "organizations_url": "https://api.github.com/users/hi-rustin/orgs", "repos_url": "https://api.github.com/users/hi-rustin/repos", "events_url": "https://api.github.com/users/hi-rustin/events{/privacy}", "received_events_url": "https://api.github.com/users/hi-rustin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6edf624cbe75cb77723d9f62f1f6ba4a5fa8fc74", "url": "https://api.github.com/repos/rust-lang/rust/commits/6edf624cbe75cb77723d9f62f1f6ba4a5fa8fc74", "html_url": "https://github.com/rust-lang/rust/commit/6edf624cbe75cb77723d9f62f1f6ba4a5fa8fc74"}], "stats": {"total": 43, "additions": 43, "deletions": 0}, "files": [{"sha": "500a18ffb6e8977712507d6920a5be531d5ef070", "filename": "crates/ide-diagnostics/src/handlers/type_mismatch.rs", "status": "modified", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/b9ba9fab5a090e497c1149baee027190a1673d42/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Ftype_mismatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9ba9fab5a090e497c1149baee027190a1673d42/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Ftype_mismatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Ftype_mismatch.rs?ref=b9ba9fab5a090e497c1149baee027190a1673d42", "patch": "@@ -35,6 +35,7 @@ fn fixes(ctx: &DiagnosticsContext<'_>, d: &hir::TypeMismatch) -> Option<Vec<Assi\n     add_reference(ctx, d, &mut fixes);\n     add_missing_ok_or_some(ctx, d, &mut fixes);\n     remove_semicolon(ctx, d, &mut fixes);\n+    str_ref_to_string(ctx, d, &mut fixes);\n \n     if fixes.is_empty() {\n         None\n@@ -134,6 +135,32 @@ fn remove_semicolon(\n     Some(())\n }\n \n+fn str_ref_to_string(\n+    ctx: &DiagnosticsContext<'_>,\n+    d: &hir::TypeMismatch,\n+    acc: &mut Vec<Assist>,\n+) -> Option<()> {\n+    let expected = d.expected.display(ctx.sema.db);\n+    let actual = d.actual.display(ctx.sema.db);\n+\n+    if expected.to_string() != \"String\" || actual.to_string() != \"&str\" {\n+        return None;\n+    }\n+\n+    let root = ctx.sema.db.parse_or_expand(d.expr.file_id)?;\n+    let expr = d.expr.value.to_node(&root);\n+    let expr_range = expr.syntax().text_range();\n+\n+    let to_string = format!(\".to_string()\");\n+\n+    let edit = TextEdit::insert(expr.syntax().text_range().end(), to_string);\n+    let source_change =\n+        SourceChange::from_text_edit(d.expr.file_id.original_file(ctx.sema.db), edit);\n+    acc.push(fix(\"str_ref_to_string\", \"Use to_string() here\", source_change, expr_range));\n+\n+    Some(())\n+}\n+\n #[cfg(test)]\n mod tests {\n     use crate::tests::{check_diagnostics, check_fix, check_no_fix};\n@@ -498,4 +525,20 @@ fn foo() -> SomeOtherEnum { 0$0 }\n     fn remove_semicolon() {\n         check_fix(r#\"fn f() -> i32 { 92$0; }\"#, r#\"fn f() -> i32 { 92 }\"#);\n     }\n+\n+    #[test]\n+    fn str_ref_to_string() {\n+        check_fix(\n+            r#\"\n+fn test() -> String {\n+    \"a\"$0\n+}\n+            \"#,\n+            r#\"\n+fn test() -> String {\n+    \"a\".to_string()\n+}\n+            \"#,\n+        );\n+    }\n }"}]}