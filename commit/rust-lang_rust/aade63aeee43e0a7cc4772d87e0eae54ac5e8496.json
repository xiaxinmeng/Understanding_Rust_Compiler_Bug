{"sha": "aade63aeee43e0a7cc4772d87e0eae54ac5e8496", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFhZGU2M2FlZWU0M2UwYTdjYzQ3NzJkODdlMGVhZTU0YWM1ZTg0OTY=", "commit": {"author": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-09-15T13:26:12Z"}, "committer": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-09-15T13:26:12Z"}, "message": "Fast reject for NeedsNonConstDrop", "tree": {"sha": "ff949946a00abd7114676048f03463c351516e7e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ff949946a00abd7114676048f03463c351516e7e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aade63aeee43e0a7cc4772d87e0eae54ac5e8496", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEQ7Fl7qPq2YcWF1dqAn35M4hird0FAmFB9HQACgkQAn35M4hi\nrd3okg//dRBrVNIyvFVvXrdRzlOmkSWr+2uluuK4jpTKEWq5W4Ip5sMAWM3DFZAY\nW2iLMahUOgvDor4Ugd6274GoW6AD6n8b7wu+thA/ZztYBrcU9Swo6o7GUIVfe3tw\nGxc2onzREoWt9AwbYBDeqLWffphRIqo/3iXnvya3XzhxLMy55BWEQ85WJbDb+EGU\n510fiz5U/g9bHOulG/9yuuLke0amvlZjQrN6xLVMQIR7loiKSZLLkcSfMpsbCP32\neypGGi04Jn1iHZeuxhkbDwZMRdbNFb9ZJcFpqOaeGWefsyxpyBF5y54gdeMe9DHP\ndVmzttIaQ0D/gLCq7+MjGtz4lsFtXtxb/O5Vyr5KWWG/5Kee397CVxMhpw8fHsLh\n9wFh/0Np7dfbE72V8j/awl5S8dlw81WvDjvxW1hFWKmWz7tdxrO1HhDt6EF+MD8M\nPvH6fRIR9cu5U47VjbUuYb/W6y3sdKgEVhC9LaWR+q+Qh5kCqYCBHMM8HPQfB73X\n1vhzGnXkyQLwkoPPFOpdz+1szA32EvA9FFZ3g8IWfXixMYafBqozdQPlrm5JoCQk\n4pXKwFo2FJGLfLIaw8AcwI2anY2M4H7o2v4CaSiqzeXbfFNQE9hNbMK+5UBxGqez\n3fTp0NKIH66HKcZsxeYL6QB1pRG8Ib6k25r3qOPMB/p3B/NLeig=\n=Yy28\n-----END PGP SIGNATURE-----", "payload": "tree ff949946a00abd7114676048f03463c351516e7e\nparent cdeba02ff71416e014f7130f75166890688be986\nauthor Deadbeef <ent3rm4n@gmail.com> 1631712372 +0000\ncommitter Deadbeef <ent3rm4n@gmail.com> 1631712372 +0000\n\nFast reject for NeedsNonConstDrop\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aade63aeee43e0a7cc4772d87e0eae54ac5e8496", "html_url": "https://github.com/rust-lang/rust/commit/aade63aeee43e0a7cc4772d87e0eae54ac5e8496", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aade63aeee43e0a7cc4772d87e0eae54ac5e8496/comments", "author": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cdeba02ff71416e014f7130f75166890688be986", "url": "https://api.github.com/repos/rust-lang/rust/commits/cdeba02ff71416e014f7130f75166890688be986", "html_url": "https://github.com/rust-lang/rust/commit/cdeba02ff71416e014f7130f75166890688be986"}], "stats": {"total": 12, "additions": 11, "deletions": 1}, "files": [{"sha": "cb9b4bcb77a8574ea8baa50bd54b1c3e95587de1", "filename": "compiler/rustc_const_eval/src/transform/check_consts/qualifs.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/aade63aeee43e0a7cc4772d87e0eae54ac5e8496/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fqualifs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aade63aeee43e0a7cc4772d87e0eae54ac5e8496/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fqualifs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fqualifs.rs?ref=aade63aeee43e0a7cc4772d87e0eae54ac5e8496", "patch": "@@ -111,7 +111,17 @@ impl Qualif for NeedsNonConstDrop {\n         qualifs.needs_drop\n     }\n \n-    fn in_any_value_of_ty(cx: &ConstCx<'_, 'tcx>, ty: Ty<'tcx>) -> bool {\n+    fn in_any_value_of_ty(cx: &ConstCx<'_, 'tcx>, mut ty: Ty<'tcx>) -> bool {\n+        // Avoid selecting for simple cases.\n+        match ty::util::needs_drop_components(ty, &cx.tcx.data_layout).as_deref() {\n+            Ok([]) => return false,\n+            Err(ty::util::AlwaysRequiresDrop) => return true,\n+            // If we've got a single component, select with that\n+            // to increase the chance that we hit the selection cache.\n+            Ok([t]) => ty = t,\n+            Ok([..]) => {}\n+        }\n+\n         let drop_trait = if let Some(did) = cx.tcx.lang_items().drop_trait() {\n             did\n         } else {"}]}