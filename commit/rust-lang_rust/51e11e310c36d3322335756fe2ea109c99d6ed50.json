{"sha": "51e11e310c36d3322335756fe2ea109c99d6ed50", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUxZTExZTMxMGMzNmQzMzIyMzM1NzU2ZmUyZWExMDljOTlkNmVkNTA=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2020-06-12T15:06:26Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2020-06-15T17:56:11Z"}, "message": "Avoid prematurely recording toolstates\n\nWhen we're running with dry_run enabled (i.e. all builds do this initially), we're\nguaranteed to save of a toolstate of TestFail for tools that aren't tested. In practice,\nwe do test tools as well, so for those tools we would initially record them as being\nTestPass, and then later on re-record the correct state after actually testing them.\nHowever, this would not work well if the build failed for whatever reason (e.g. panicking\nin bootstrap, or as was the case in 73097, clippy failing to test successfully), we would\njust go on believing that things passed when they in practice did not.\n\nThis commit also adjusts saving toolstate to never record clippy explicitly (otherwise, it\nwould be recorded when building it); eventually that'll likely move to other tools as well\nbut not yet. This is deemed simpler than checking everywhere we generically save\ntoolstate.\n\nWe also move clippy out of the \"toolstate\" no-fail-fast build into a separate x.py\ninvocation; this should no longer be technically required but provides the nice state of\nletting us check toolstate for all tools and only then check clippy (giving full results\non every build).", "tree": {"sha": "5bd3ff2ba4c486f3f8c2828db1d5a896f030bf85", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5bd3ff2ba4c486f3f8c2828db1d5a896f030bf85"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/51e11e310c36d3322335756fe2ea109c99d6ed50", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/51e11e310c36d3322335756fe2ea109c99d6ed50", "html_url": "https://github.com/rust-lang/rust/commit/51e11e310c36d3322335756fe2ea109c99d6ed50", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/51e11e310c36d3322335756fe2ea109c99d6ed50/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ff4a2533a0720f9cdd86e02eafa3725f07aa7752", "url": "https://api.github.com/repos/rust-lang/rust/commits/ff4a2533a0720f9cdd86e02eafa3725f07aa7752", "html_url": "https://github.com/rust-lang/rust/commit/ff4a2533a0720f9cdd86e02eafa3725f07aa7752"}], "stats": {"total": 16, "additions": 15, "deletions": 1}, "files": [{"sha": "8740393288c48021800631de542eec2b15064587", "filename": "src/bootstrap/toolstate.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/51e11e310c36d3322335756fe2ea109c99d6ed50/src%2Fbootstrap%2Ftoolstate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51e11e310c36d3322335756fe2ea109c99d6ed50/src%2Fbootstrap%2Ftoolstate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftoolstate.rs?ref=51e11e310c36d3322335756fe2ea109c99d6ed50", "patch": "@@ -272,6 +272,18 @@ impl Builder<'_> {\n     /// `rust.save-toolstates` in `config.toml`. If unspecified, nothing will be\n     /// done. The file is updated immediately after this function completes.\n     pub fn save_toolstate(&self, tool: &str, state: ToolState) {\n+        // If we're in a dry run setting we don't want to save toolstates as\n+        // that means if we e.g. panic down the line it'll look like we tested\n+        // everything (but we actually haven't).\n+        if self.config.dry_run {\n+            return;\n+        }\n+        // Toolstate isn't tracked for clippy, but since most tools do, we avoid\n+        // checking in all the places we could save toolstate and just do so\n+        // here.\n+        if tool == \"clippy-driver\" {\n+            return;\n+        }\n         if let Some(ref path) = self.config.save_toolstates {\n             if let Some(parent) = path.parent() {\n                 // Ensure the parent directory always exists"}, {"sha": "b4b23a245e0aa928b0d7689e9ba8b07ba953f25c", "filename": "src/ci/docker/x86_64-gnu-tools/checktools.sh", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/51e11e310c36d3322335756fe2ea109c99d6ed50/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "raw_url": "https://github.com/rust-lang/rust/raw/51e11e310c36d3322335756fe2ea109c99d6ed50/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh?ref=51e11e310c36d3322335756fe2ea109c99d6ed50", "patch": "@@ -14,11 +14,13 @@ python3 \"$X_PY\" test --no-fail-fast \\\n     src/doc/rust-by-example \\\n     src/doc/embedded-book \\\n     src/doc/edition-guide \\\n-    src/tools/clippy \\\n     src/tools/rls \\\n     src/tools/rustfmt \\\n     src/tools/miri \\\n \n set -e\n \n+# debugging: print out the saved toolstates\n+cat /tmp/toolstate/toolstates.json\n python3 \"$X_PY\" test check-tools\n+python3 \"$X_PY\" test src/tools/clippy"}]}