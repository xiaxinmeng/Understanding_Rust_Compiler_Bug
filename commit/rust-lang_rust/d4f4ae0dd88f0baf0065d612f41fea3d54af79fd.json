{"sha": "d4f4ae0dd88f0baf0065d612f41fea3d54af79fd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ0ZjRhZTBkZDg4ZjBiYWYwMDY1ZDYxMmY0MWZlYTNkNTRhZjc5ZmQ=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-11-22T15:46:39Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-11-22T15:46:39Z"}, "message": "Move const&static date to hir_def", "tree": {"sha": "a08c33528a8a1579c9017e43ad3b28042e77f8fe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a08c33528a8a1579c9017e43ad3b28042e77f8fe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd", "html_url": "https://github.com/rust-lang/rust/commit/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b841c53a0c93cdca3f08b1c917c9fa8a63d31604", "url": "https://api.github.com/repos/rust-lang/rust/commits/b841c53a0c93cdca3f08b1c917c9fa8a63d31604", "html_url": "https://github.com/rust-lang/rust/commit/b841c53a0c93cdca3f08b1c917c9fa8a63d31604"}], "stats": {"total": 130, "additions": 58, "deletions": 72}, "files": [{"sha": "1b65eefe547a26ee7e2038e4a109efa493a68930", "filename": "crates/ra_hir/src/code_model.rs", "status": "modified", "additions": 6, "deletions": 45, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fcode_model.rs?ref=d4f4ae0dd88f0baf0065d612f41fea3d54af79fd", "patch": "@@ -10,7 +10,7 @@ use hir_def::{\n     adt::VariantData,\n     body::scope::ExprScopes,\n     builtin_type::BuiltinType,\n-    data::TraitData,\n+    data::{ConstData, TraitData},\n     nameres::per_ns::PerNs,\n     resolver::{HasResolver, TypeNs},\n     type_ref::TypeRef,\n@@ -22,10 +22,10 @@ use hir_expand::{\n     name::{self, AsName},\n };\n use ra_db::{CrateId, Edition};\n-use ra_syntax::ast::{self, NameOwner, TypeAscriptionOwner};\n+use ra_syntax::ast;\n \n use crate::{\n-    db::{AstDatabase, DefDatabase, HirDatabase},\n+    db::{DefDatabase, HirDatabase},\n     expr::{BindingAnnotation, Body, BodySourceMap, ExprValidator, Pat, PatId},\n     ids::{\n         AstItemDef, ConstId, EnumId, FunctionId, MacroDefId, StaticId, StructId, TraitId,\n@@ -645,11 +645,11 @@ impl Const {\n     }\n \n     pub fn data(self, db: &impl HirDatabase) -> Arc<ConstData> {\n-        db.const_data(self)\n+        db.const_data(self.id)\n     }\n \n     pub fn name(self, db: &impl HirDatabase) -> Option<Name> {\n-        self.data(db).name().cloned()\n+        self.data(db).name.clone()\n     }\n \n     pub fn infer(self, db: &impl HirDatabase) -> Arc<InferenceResult> {\n@@ -681,45 +681,6 @@ impl Const {\n     }\n }\n \n-#[derive(Debug, Clone, PartialEq, Eq)]\n-pub struct ConstData {\n-    pub(crate) name: Option<Name>,\n-    pub(crate) type_ref: TypeRef,\n-}\n-\n-impl ConstData {\n-    pub fn name(&self) -> Option<&Name> {\n-        self.name.as_ref()\n-    }\n-\n-    pub fn type_ref(&self) -> &TypeRef {\n-        &self.type_ref\n-    }\n-\n-    pub(crate) fn const_data_query(\n-        db: &(impl DefDatabase + AstDatabase),\n-        konst: Const,\n-    ) -> Arc<ConstData> {\n-        let node = konst.source(db).value;\n-        const_data_for(&node)\n-    }\n-\n-    pub(crate) fn static_data_query(\n-        db: &(impl DefDatabase + AstDatabase),\n-        konst: Static,\n-    ) -> Arc<ConstData> {\n-        let node = konst.source(db).value;\n-        const_data_for(&node)\n-    }\n-}\n-\n-fn const_data_for<N: NameOwner + TypeAscriptionOwner>(node: &N) -> Arc<ConstData> {\n-    let name = node.name().map(|n| n.as_name());\n-    let type_ref = TypeRef::from_ast_opt(node.ascribed_type());\n-    let sig = ConstData { name, type_ref };\n-    Arc::new(sig)\n-}\n-\n #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\n pub struct Static {\n     pub(crate) id: StaticId,\n@@ -735,7 +696,7 @@ impl Static {\n     }\n \n     pub fn data(self, db: &impl HirDatabase) -> Arc<ConstData> {\n-        db.static_data(self)\n+        db.static_data(self.id)\n     }\n \n     pub fn infer(self, db: &impl HirDatabase) -> Arc<InferenceResult> {"}, {"sha": "85d46b485f47e246456fe163faf6aaa1557b4007", "filename": "crates/ra_hir/src/db.rs", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fdb.rs?ref=d4f4ae0dd88f0baf0065d612f41fea3d54af79fd", "patch": "@@ -16,15 +16,15 @@ use crate::{\n         CallableDef, FnSig, GenericPredicate, InferenceResult, Namespace, Substs, Ty, TypableDef,\n         TypeCtor,\n     },\n-    Const, ConstData, Crate, DefWithBody, GenericDef, ImplBlock, Module, Static, StructField,\n-    Trait,\n+    Crate, DefWithBody, GenericDef, ImplBlock, Module, StructField, Trait,\n };\n \n pub use hir_def::db::{\n-    BodyQuery, BodyWithSourceMapQuery, CrateDefMapQuery, DefDatabase2, DefDatabase2Storage,\n-    EnumDataQuery, ExprScopesQuery, FunctionDataQuery, GenericParamsQuery, ImplDataQuery,\n-    InternDatabase, InternDatabaseStorage, RawItemsQuery, RawItemsWithSourceMapQuery,\n-    StructDataQuery, TraitDataQuery, TypeAliasDataQuery,\n+    BodyQuery, BodyWithSourceMapQuery, ConstDataQuery, CrateDefMapQuery, DefDatabase2,\n+    DefDatabase2Storage, EnumDataQuery, ExprScopesQuery, FunctionDataQuery, GenericParamsQuery,\n+    ImplDataQuery, InternDatabase, InternDatabaseStorage, RawItemsQuery,\n+    RawItemsWithSourceMapQuery, StaticDataQuery, StructDataQuery, TraitDataQuery,\n+    TypeAliasDataQuery,\n };\n pub use hir_expand::db::{\n     AstDatabase, AstDatabaseStorage, AstIdMapQuery, MacroArgQuery, MacroDefQuery, MacroExpandQuery,\n@@ -35,12 +35,6 @@ pub use hir_expand::db::{\n #[salsa::query_group(DefDatabaseStorage)]\n #[salsa::requires(AstDatabase)]\n pub trait DefDatabase: HirDebugDatabase + DefDatabase2 {\n-    #[salsa::invoke(ConstData::const_data_query)]\n-    fn const_data(&self, konst: Const) -> Arc<ConstData>;\n-\n-    #[salsa::invoke(ConstData::static_data_query)]\n-    fn static_data(&self, konst: Static) -> Arc<ConstData>;\n-\n     #[salsa::invoke(LangItems::module_lang_items_query)]\n     fn module_lang_items(&self, module: Module) -> Option<Arc<LangItems>>;\n "}, {"sha": "e164c9b3275fc17a1f889954db25335d528bf319", "filename": "crates/ra_hir/src/lib.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Flib.rs?ref=d4f4ae0dd88f0baf0065d612f41fea3d54af79fd", "patch": "@@ -54,10 +54,10 @@ pub use crate::{\n         attrs::{AttrDef, HasAttrs},\n         docs::{DocDef, Docs, Documentation},\n         src::{HasBodySource, HasSource},\n-        Adt, AssocItem, Const, ConstData, Container, Crate, CrateDependency, DefWithBody, Enum,\n-        EnumVariant, FieldSource, Function, GenericDef, GenericParam, HasBody, ImplBlock, Local,\n-        MacroDef, Module, ModuleDef, ModuleSource, ScopeDef, Static, Struct, StructField, Trait,\n-        TypeAlias, Union, VariantDef,\n+        Adt, AssocItem, Const, Container, Crate, CrateDependency, DefWithBody, Enum, EnumVariant,\n+        FieldSource, Function, GenericDef, GenericParam, HasBody, ImplBlock, Local, MacroDef,\n+        Module, ModuleDef, ModuleSource, ScopeDef, Static, Struct, StructField, Trait, TypeAlias,\n+        Union, VariantDef,\n     },\n     expr::ExprScopes,\n     from_source::FromSource,"}, {"sha": "39976a359ed4736d16e5798bca76610f178af247", "filename": "crates/ra_hir/src/ty/infer.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir%2Fsrc%2Fty%2Finfer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir%2Fsrc%2Fty%2Finfer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Finfer.rs?ref=d4f4ae0dd88f0baf0065d612f41fea3d54af79fd", "patch": "@@ -22,7 +22,7 @@ use ena::unify::{InPlaceUnificationTable, NoError, UnifyKey, UnifyValue};\n use rustc_hash::FxHashMap;\n \n use hir_def::{\n-    data::FunctionData,\n+    data::{ConstData, FunctionData},\n     path::known,\n     resolver::{HasResolver, Resolver, TypeNs},\n     type_ref::{Mutability, TypeRef},\n@@ -44,8 +44,8 @@ use crate::{\n     db::HirDatabase,\n     expr::{BindingAnnotation, Body, ExprId, PatId},\n     ty::infer::diagnostics::InferenceDiagnostic,\n-    Adt, AssocItem, ConstData, DefWithBody, FloatTy, Function, HasBody, IntTy, Path, StructField,\n-    Trait, VariantDef,\n+    Adt, AssocItem, DefWithBody, FloatTy, Function, HasBody, IntTy, Path, StructField, Trait,\n+    VariantDef,\n };\n \n macro_rules! ty_app {\n@@ -560,7 +560,7 @@ impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n     }\n \n     fn collect_const(&mut self, data: &ConstData) {\n-        self.return_ty = self.make_ty(data.type_ref());\n+        self.return_ty = self.make_ty(&data.type_ref);\n     }\n \n     fn collect_fn(&mut self, data: &FunctionData) {"}, {"sha": "ac7f3f77520a006105cb091ca94676f092ad7319", "filename": "crates/ra_hir/src/ty/lower.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir%2Fsrc%2Fty%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir%2Fsrc%2Fty%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Flower.rs?ref=d4f4ae0dd88f0baf0065d612f41fea3d54af79fd", "patch": "@@ -642,15 +642,15 @@ fn type_for_const(db: &impl HirDatabase, def: Const) -> Ty {\n     let data = def.data(db);\n     let resolver = def.id.resolver(db);\n \n-    Ty::from_hir(db, &resolver, data.type_ref())\n+    Ty::from_hir(db, &resolver, &data.type_ref)\n }\n \n /// Build the declared type of a static.\n fn type_for_static(db: &impl HirDatabase, def: Static) -> Ty {\n     let data = def.data(db);\n     let resolver = def.id.resolver(db);\n \n-    Ty::from_hir(db, &resolver, data.type_ref())\n+    Ty::from_hir(db, &resolver, &data.type_ref)\n }\n \n /// Build the declared type of a static."}, {"sha": "91bac7415a647d981e9e263901aca8a86005ac2a", "filename": "crates/ra_hir_def/src/data.rs", "status": "modified", "additions": 27, "deletions": 2, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir_def%2Fsrc%2Fdata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir_def%2Fsrc%2Fdata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fdata.rs?ref=d4f4ae0dd88f0baf0065d612f41fea3d54af79fd", "patch": "@@ -11,8 +11,8 @@ use ra_syntax::ast::{self, NameOwner, TypeAscriptionOwner};\n use crate::{\n     db::DefDatabase2,\n     type_ref::{Mutability, TypeRef},\n-    AssocItemId, AstItemDef, ConstLoc, ContainerId, FunctionId, FunctionLoc, HasSource, ImplId,\n-    Intern, Lookup, TraitId, TypeAliasId, TypeAliasLoc,\n+    AssocItemId, AstItemDef, ConstId, ConstLoc, ContainerId, FunctionId, FunctionLoc, HasSource,\n+    ImplId, Intern, Lookup, StaticId, TraitId, TypeAliasId, TypeAliasLoc,\n };\n \n #[derive(Debug, Clone, PartialEq, Eq)]\n@@ -190,3 +190,28 @@ impl ImplData {\n         Arc::new(res)\n     }\n }\n+\n+#[derive(Debug, Clone, PartialEq, Eq)]\n+pub struct ConstData {\n+    pub name: Option<Name>,\n+    pub type_ref: TypeRef,\n+}\n+\n+impl ConstData {\n+    pub(crate) fn const_data_query(db: &impl DefDatabase2, konst: ConstId) -> Arc<ConstData> {\n+        let node = konst.lookup(db).source(db).value;\n+        const_data_for(&node)\n+    }\n+\n+    pub(crate) fn static_data_query(db: &impl DefDatabase2, konst: StaticId) -> Arc<ConstData> {\n+        let node = konst.source(db).value;\n+        const_data_for(&node)\n+    }\n+}\n+\n+fn const_data_for<N: NameOwner + TypeAscriptionOwner>(node: &N) -> Arc<ConstData> {\n+    let name = node.name().map(|n| n.as_name());\n+    let type_ref = TypeRef::from_ast_opt(node.ascribed_type());\n+    let sig = ConstData { name, type_ref };\n+    Arc::new(sig)\n+}"}, {"sha": "2c660ab88bd73207d26e29dba6f968de86186a58", "filename": "crates/ra_hir_def/src/db.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir_def%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4f4ae0dd88f0baf0065d612f41fea3d54af79fd/crates%2Fra_hir_def%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fdb.rs?ref=d4f4ae0dd88f0baf0065d612f41fea3d54af79fd", "patch": "@@ -8,14 +8,14 @@ use ra_syntax::ast;\n use crate::{\n     adt::{EnumData, StructData},\n     body::{scope::ExprScopes, Body, BodySourceMap},\n-    data::{FunctionData, ImplData, TraitData, TypeAliasData},\n+    data::{ConstData, FunctionData, ImplData, TraitData, TypeAliasData},\n     generics::GenericParams,\n     nameres::{\n         raw::{ImportSourceMap, RawItems},\n         CrateDefMap,\n     },\n-    DefWithBodyId, EnumId, FunctionId, GenericDefId, ImplId, ItemLoc, StructOrUnionId, TraitId,\n-    TypeAliasId,\n+    ConstId, DefWithBodyId, EnumId, FunctionId, GenericDefId, ImplId, ItemLoc, StaticId,\n+    StructOrUnionId, TraitId, TypeAliasId,\n };\n \n #[salsa::query_group(InternDatabaseStorage)]\n@@ -70,6 +70,12 @@ pub trait DefDatabase2: InternDatabase + AstDatabase {\n     #[salsa::invoke(FunctionData::fn_data_query)]\n     fn function_data(&self, func: FunctionId) -> Arc<FunctionData>;\n \n+    #[salsa::invoke(ConstData::const_data_query)]\n+    fn const_data(&self, konst: ConstId) -> Arc<ConstData>;\n+\n+    #[salsa::invoke(ConstData::static_data_query)]\n+    fn static_data(&self, konst: StaticId) -> Arc<ConstData>;\n+\n     #[salsa::invoke(Body::body_with_source_map_query)]\n     fn body_with_source_map(&self, def: DefWithBodyId) -> (Arc<Body>, Arc<BodySourceMap>);\n "}]}