{"sha": "8a633fe9866d198e0cc63f648fe3525b5e83bb88", "node_id": "C_kwDOAAsO6NoAKDhhNjMzZmU5ODY2ZDE5OGUwY2M2M2Y2NDhmZTM1MjViNWU4M2JiODg", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-11-07T14:52:05Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-11-07T14:52:05Z"}, "message": "Auto merge of #13570 - Veykril:dedup-crates-for, r=Veykril\n\nminor: Remove code duplication", "tree": {"sha": "f5ca2b8ff518f35dbd09bb5c26a4fd07cec36140", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f5ca2b8ff518f35dbd09bb5c26a4fd07cec36140"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8a633fe9866d198e0cc63f648fe3525b5e83bb88", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8a633fe9866d198e0cc63f648fe3525b5e83bb88", "html_url": "https://github.com/rust-lang/rust/commit/8a633fe9866d198e0cc63f648fe3525b5e83bb88", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8a633fe9866d198e0cc63f648fe3525b5e83bb88/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b0e56ef5e82791a9d41757d0c6c0067109f1c752", "url": "https://api.github.com/repos/rust-lang/rust/commits/b0e56ef5e82791a9d41757d0c6c0067109f1c752", "html_url": "https://github.com/rust-lang/rust/commit/b0e56ef5e82791a9d41757d0c6c0067109f1c752"}, {"sha": "b169e1e5decbbda7ad09a8fa07fb32ca83ec7a50", "url": "https://api.github.com/repos/rust-lang/rust/commits/b169e1e5decbbda7ad09a8fa07fb32ca83ec7a50", "html_url": "https://github.com/rust-lang/rust/commit/b169e1e5decbbda7ad09a8fa07fb32ca83ec7a50"}], "stats": {"total": 25, "additions": 7, "deletions": 18}, "files": [{"sha": "fcbf6d8e58c4b07fd66cda4e0b3f8f49f696bfda", "filename": "crates/ide/src/moniker.rs", "status": "modified", "additions": 4, "deletions": 16, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/8a633fe9866d198e0cc63f648fe3525b5e83bb88/crates%2Fide%2Fsrc%2Fmoniker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a633fe9866d198e0cc63f648fe3525b5e83bb88/crates%2Fide%2Fsrc%2Fmoniker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fmoniker.rs?ref=8a633fe9866d198e0cc63f648fe3525b5e83bb88", "patch": "@@ -1,17 +1,17 @@\n //! This module generates [moniker](https://microsoft.github.io/language-server-protocol/specifications/lsif/0.6.0/specification/#exportsImports)\n //! for LSIF and LSP.\n \n-use hir::{db::DefDatabase, AsAssocItem, AssocItemContainer, Crate, Name, Semantics};\n+use hir::{AsAssocItem, AssocItemContainer, Crate, Name, Semantics};\n use ide_db::{\n-    base_db::{CrateOrigin, FileId, FileLoader, FilePosition, LangCrateOrigin},\n+    base_db::{CrateOrigin, FilePosition, LangCrateOrigin},\n     defs::{Definition, IdentClass},\n     helpers::pick_best_token,\n     RootDatabase,\n };\n use itertools::Itertools;\n use syntax::{AstNode, SyntaxKind::*, T};\n \n-use crate::{doc_links::token_as_doc_comment, RangeInfo};\n+use crate::{doc_links::token_as_doc_comment, parent_module::crates_for, RangeInfo};\n \n #[derive(Debug, Clone, PartialEq, Eq, PartialOrd, Ord, Hash)]\n pub enum MonikerDescriptorKind {\n@@ -77,25 +77,13 @@ pub struct PackageInformation {\n     pub version: Option<String>,\n }\n \n-pub(crate) fn crate_for_file(db: &RootDatabase, file_id: FileId) -> Option<Crate> {\n-    for &krate in db.relevant_crates(file_id).iter() {\n-        let crate_def_map = db.crate_def_map(krate);\n-        for (_, data) in crate_def_map.modules() {\n-            if data.origin.file_id() == Some(file_id) {\n-                return Some(krate.into());\n-            }\n-        }\n-    }\n-    None\n-}\n-\n pub(crate) fn moniker(\n     db: &RootDatabase,\n     FilePosition { file_id, offset }: FilePosition,\n ) -> Option<RangeInfo<Vec<MonikerResult>>> {\n     let sema = &Semantics::new(db);\n     let file = sema.parse(file_id).syntax().clone();\n-    let current_crate = crate_for_file(db, file_id)?;\n+    let current_crate: hir::Crate = crates_for(db, file_id).pop()?.into();\n     let original_token = pick_best_token(file.token_at_offset(offset), |kind| match kind {\n         IDENT\n         | INT_NUMBER"}, {"sha": "2380cf7381c1ceb5223fcaeba8a22e837e92717e", "filename": "crates/ide/src/static_index.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/8a633fe9866d198e0cc63f648fe3525b5e83bb88/crates%2Fide%2Fsrc%2Fstatic_index.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a633fe9866d198e0cc63f648fe3525b5e83bb88/crates%2Fide%2Fsrc%2Fstatic_index.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fstatic_index.rs?ref=8a633fe9866d198e0cc63f648fe3525b5e83bb88", "patch": "@@ -13,7 +13,8 @@ use syntax::{AstNode, SyntaxKind::*, SyntaxToken, TextRange, T};\n \n use crate::{\n     hover::hover_for_definition,\n-    moniker::{crate_for_file, def_to_moniker, MonikerResult},\n+    moniker::{def_to_moniker, MonikerResult},\n+    parent_module::crates_for,\n     Analysis, Fold, HoverConfig, HoverDocFormat, HoverResult, InlayHint, InlayHintsConfig,\n     TryToNav,\n };\n@@ -99,7 +100,7 @@ fn all_modules(db: &dyn HirDatabase) -> Vec<Module> {\n \n impl StaticIndex<'_> {\n     fn add_file(&mut self, file_id: FileId) {\n-        let current_crate = crate_for_file(self.db, file_id);\n+        let current_crate = crates_for(self.db, file_id).pop().map(Into::into);\n         let folds = self.analysis.folding_ranges(file_id).unwrap();\n         let inlay_hints = self\n             .analysis"}]}