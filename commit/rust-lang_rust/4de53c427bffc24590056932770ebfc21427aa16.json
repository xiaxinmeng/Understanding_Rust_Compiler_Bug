{"sha": "4de53c427bffc24590056932770ebfc21427aa16", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRkZTUzYzQyN2JmZmMyNDU5MDA1NjkzMjc3MGViZmMyMTQyN2FhMTY=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2021-08-16T21:37:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-08-16T21:37:34Z"}, "message": "Rollup merge of #88080 - fee1-dead:iterator-const, r=oli-obk\n\nSkip assert ICE with default_method_body_is_const\n\nfunctions marked with #[default_method_body_is_const] would\nICE when being const checked due to it not being a const function:\n`tcx.is_const_fn_raw(did)` returns false. We should skip this assert\nwhen it is marked with that attribute.\n\nr? `@oli-obk`", "tree": {"sha": "a5197ca1e86a2b302ca12914eea0a15eb511f52e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a5197ca1e86a2b302ca12914eea0a15eb511f52e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4de53c427bffc24590056932770ebfc21427aa16", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhGtqeCRBK7hj4Ov3rIwAAKSgIAACljv5pGWw18b7WxN3P7icT\n2v2If2GZh1N6pmwLtWMNMGmiOgGMpEzdrwrKJV+ayFEkOG90I+NTem5pp/1VqvUW\nOWZuNrzb0qDiEofOci28qhpeKsMTN2tauKs7Uy8WoiGzerPgnIdRaab6d3+bQlqr\nFYGblDSx/kS+DyNs4PxQhcpadMftAx+ER+2VNnPKyC4rI04OIunz4RswOPt8YNWf\ng7CGA8yW1xoBUJlfj8GPIX4nXiJuWNO6SV5zcfp6s3fi+TFqm5gMsHFsPPVq+GDp\n4hsedwKHHr8xsX6qPnNGR0O8rwn5TnNgEt8uuppdYdH7H+A2IDFku1RkrtC1CJA=\n=P2fO\n-----END PGP SIGNATURE-----\n", "payload": "tree a5197ca1e86a2b302ca12914eea0a15eb511f52e\nparent 18a7b6d32a07f26010ee25f0ae50b04cf2cac27d\nparent 85abdf07578f14b9c07b3aed9f6b23b1bbf23f8f\nauthor Mara Bos <m-ou.se@m-ou.se> 1629149854 +0200\ncommitter GitHub <noreply@github.com> 1629149854 +0200\n\nRollup merge of #88080 - fee1-dead:iterator-const, r=oli-obk\n\nSkip assert ICE with default_method_body_is_const\n\nfunctions marked with #[default_method_body_is_const] would\nICE when being const checked due to it not being a const function:\n`tcx.is_const_fn_raw(did)` returns false. We should skip this assert\nwhen it is marked with that attribute.\n\nr? `@oli-obk`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4de53c427bffc24590056932770ebfc21427aa16", "html_url": "https://github.com/rust-lang/rust/commit/4de53c427bffc24590056932770ebfc21427aa16", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4de53c427bffc24590056932770ebfc21427aa16/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "18a7b6d32a07f26010ee25f0ae50b04cf2cac27d", "url": "https://api.github.com/repos/rust-lang/rust/commits/18a7b6d32a07f26010ee25f0ae50b04cf2cac27d", "html_url": "https://github.com/rust-lang/rust/commit/18a7b6d32a07f26010ee25f0ae50b04cf2cac27d"}, {"sha": "85abdf07578f14b9c07b3aed9f6b23b1bbf23f8f", "url": "https://api.github.com/repos/rust-lang/rust/commits/85abdf07578f14b9c07b3aed9f6b23b1bbf23f8f", "html_url": "https://github.com/rust-lang/rust/commit/85abdf07578f14b9c07b3aed9f6b23b1bbf23f8f"}], "stats": {"total": 27, "additions": 26, "deletions": 1}, "files": [{"sha": "a5cb0f4e14b178547dc1c1f6ae305f748b3d8183", "filename": "compiler/rustc_mir/src/transform/check_consts/mod.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/4de53c427bffc24590056932770ebfc21427aa16/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4de53c427bffc24590056932770ebfc21427aa16/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fmod.rs?ref=4de53c427bffc24590056932770ebfc21427aa16", "patch": "@@ -9,7 +9,7 @@ use rustc_hir as hir;\n use rustc_hir::def_id::{DefId, LocalDefId};\n use rustc_middle::mir;\n use rustc_middle::ty::{self, TyCtxt};\n-use rustc_span::Symbol;\n+use rustc_span::{sym, Symbol};\n \n pub use self::qualifs::Qualif;\n \n@@ -104,6 +104,13 @@ pub fn rustc_allow_const_fn_unstable(\n pub fn is_const_stable_const_fn(tcx: TyCtxt<'tcx>, def_id: DefId) -> bool {\n     use attr::{ConstStability, Stability, StabilityLevel};\n \n+    // A default body marked const is not const-stable because const\n+    // trait fns currently cannot be const-stable. We shouldn't\n+    // restrict default bodies to only call const-stable functions.\n+    if tcx.has_attr(def_id, sym::default_method_body_is_const) {\n+        return false;\n+    }\n+\n     // Const-stability is only relevant for `const fn`.\n     assert!(tcx.is_const_fn_raw(def_id));\n "}, {"sha": "d5b1a9073acea92b177c663d134bb5e154401f1b", "filename": "src/test/ui/rfc-2632-const-trait-impl/default-method-body-is-const-with-staged-api.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/4de53c427bffc24590056932770ebfc21427aa16/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fdefault-method-body-is-const-with-staged-api.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4de53c427bffc24590056932770ebfc21427aa16/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fdefault-method-body-is-const-with-staged-api.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fdefault-method-body-is-const-with-staged-api.rs?ref=4de53c427bffc24590056932770ebfc21427aa16", "patch": "@@ -0,0 +1,18 @@\n+// check-pass\n+\n+// This was an ICE, because the compiler ensures the\n+// function to be const when performing const checking,\n+// but functions marked with the attribute are not const\n+// *and* subject to const checking.\n+\n+#![feature(staged_api)]\n+#![feature(const_trait_impl)]\n+#![feature(const_fn_trait_bound)]\n+#![stable(since = \"1\", feature = \"foo\")]\n+\n+trait Tr {\n+    #[default_method_body_is_const]\n+    fn a() {}\n+}\n+\n+fn main() {}"}]}