{"sha": "01acfef1a40e6bfd014b01e481431c699a6b6846", "node_id": "C_kwDOAAsO6NoAKDAxYWNmZWYxYTQwZTZiZmQwMTRiMDFlNDgxNDMxYzY5OWE2YjY4NDY", "commit": {"author": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2022-08-29T17:49:30Z"}, "committer": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2022-08-29T17:49:30Z"}, "message": "Migrate stable let_chains error to session diagnostics", "tree": {"sha": "595fe9a6f88be12758cc4fa76e460dd90d2895ec", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/595fe9a6f88be12758cc4fa76e460dd90d2895ec"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/01acfef1a40e6bfd014b01e481431c699a6b6846", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/01acfef1a40e6bfd014b01e481431c699a6b6846", "html_url": "https://github.com/rust-lang/rust/commit/01acfef1a40e6bfd014b01e481431c699a6b6846", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/01acfef1a40e6bfd014b01e481431c699a6b6846/comments", "author": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d1ef8180f956c9f1a7267e32491d65188f0aefd7", "url": "https://api.github.com/repos/rust-lang/rust/commits/d1ef8180f956c9f1a7267e32491d65188f0aefd7", "html_url": "https://github.com/rust-lang/rust/commit/d1ef8180f956c9f1a7267e32491d65188f0aefd7"}], "stats": {"total": 37, "additions": 14, "deletions": 23}, "files": [{"sha": "c36c4ad54da4878c4c8b25ebb01d7196bd2fe2c2", "filename": "compiler/rustc_ast_passes/src/ast_validation.rs", "status": "modified", "additions": 2, "deletions": 23, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/01acfef1a40e6bfd014b01e481431c699a6b6846/compiler%2Frustc_ast_passes%2Fsrc%2Fast_validation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/01acfef1a40e6bfd014b01e481431c699a6b6846/compiler%2Frustc_ast_passes%2Fsrc%2Fast_validation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_passes%2Fsrc%2Fast_validation.rs?ref=01acfef1a40e6bfd014b01e481431c699a6b6846", "patch": "@@ -121,30 +121,9 @@ impl<'a> AstValidator<'a> {\n     fn ban_let_expr(&self, expr: &'a Expr, forbidden_let_reason: ForbiddenLetReason) {\n         let sess = &self.session;\n         if sess.opts.unstable_features.is_nightly_build() {\n-            let err = \"`let` expressions are not supported here\";\n-            let mut diag = sess.struct_span_err(expr.span, err);\n-            diag.note(\"only supported directly in conditions of `if` and `while` expressions\");\n-            match forbidden_let_reason {\n-                ForbiddenLetReason::GenericForbidden => {}\n-                ForbiddenLetReason::NotSupportedOr(span) => {\n-                    diag.span_note(\n-                        span,\n-                        \"`||` operators are not supported in let chain expressions\",\n-                    );\n-                }\n-                ForbiddenLetReason::NotSupportedParentheses(span) => {\n-                    diag.span_note(\n-                        span,\n-                        \"`let`s wrapped in parentheses are not supported in a context with let \\\n-                        chains\",\n-                    );\n-                }\n-            }\n-            diag.emit();\n+            sess.emit_err(ForbiddenLet { span: expr.span, reason: forbidden_let_reason });\n         } else {\n-            sess.struct_span_err(expr.span, \"expected expression, found statement (`let`)\")\n-                .note(\"variable declaration using `let` is a statement\")\n-                .emit();\n+            sess.emit_err(ForbiddenLetStable { span: expr.span });\n         }\n     }\n "}, {"sha": "21467e57651983fc78b918370d749af62bb78372", "filename": "compiler/rustc_ast_passes/src/errors.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/01acfef1a40e6bfd014b01e481431c699a6b6846/compiler%2Frustc_ast_passes%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/01acfef1a40e6bfd014b01e481431c699a6b6846/compiler%2Frustc_ast_passes%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_passes%2Fsrc%2Ferrors.rs?ref=01acfef1a40e6bfd014b01e481431c699a6b6846", "patch": "@@ -30,6 +30,14 @@ impl AddSubdiagnostic for ForbiddenLetReason {\n     }\n }\n \n+#[derive(SessionDiagnostic)]\n+#[diag(ast_passes::forbidden_let_stable)]\n+#[note]\n+pub struct ForbiddenLetStable {\n+    #[primary_span]\n+    pub span: Span,\n+}\n+\n #[derive(SessionDiagnostic)]\n #[diag(ast_passes::forbidden_assoc_constraint)]\n pub struct ForbiddenAssocConstraint {"}, {"sha": "d7108e1e2de35e5dbc22da59213a42b39cf8388b", "filename": "compiler/rustc_error_messages/locales/en-US/ast_passes.ftl", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/01acfef1a40e6bfd014b01e481431c699a6b6846/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fast_passes.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/01acfef1a40e6bfd014b01e481431c699a6b6846/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fast_passes.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fast_passes.ftl?ref=01acfef1a40e6bfd014b01e481431c699a6b6846", "patch": "@@ -4,6 +4,10 @@ ast_passes_forbidden_let =\n     .not_supported_or = `||` operators are not supported in let chain expressions\n     .not_supported_parentheses = `let`s wrapped in parentheses are not supported in a context with let chains\n \n+ast_passes_forbidden_let_stable =\n+    expected expression, found statement (`let`)\n+    .note = variable declaration using `let` is a statement\n+\n ast_passes_deprecated_where_clause_location =\n     where clause not allowed here\n "}]}