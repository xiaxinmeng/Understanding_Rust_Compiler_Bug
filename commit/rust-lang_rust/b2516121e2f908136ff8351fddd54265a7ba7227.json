{"sha": "b2516121e2f908136ff8351fddd54265a7ba7227", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIyNTE2MTIxZTJmOTA4MTM2ZmY4MzUxZmRkZDU0MjY1YTdiYTcyMjc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-12-24T15:22:28Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-12-24T15:22:28Z"}, "message": "Auto merge of #79742 - GuillaumeGomez:move-tooltips-messages-out-of-html, r=Nemo157\n\nMove tooltips messages out of html\n\nFirst thing first: nothing in the output has changed. You still have the \"i\" on the left of code blocks examples when they have `ignore`, `compile_fail`, `should_panic` and `edition`. The behavior also remains the same: when you hover the \"i\", you have the corresponding message showing up.\n\nSo now, why this PR then? I realized recently that we were actually generating those messages into the HTML every time whereas all messages are the same (except for the edition ones, I'll come back to it later). So instead of generating more content, I simply moved it inside the CSS thanks to pseudo elements (`::before` and `::after`). The message is now inside `::after` and we use the `::before` to have the small triangle on the left of the message. So now, we have less HTML generated which is seems pretty nice.\n\nSo now, back to the `edition` change: the message is globally the same, but the \"edition\" itself can be different (2015 or 2018 currently, I expect 2021 to arrive not too far in the future). So the only difference for it is that I added a new attribute on the tooltip called `edition` which contains this information. Then, the `::after` uses it inside its `content` (you can get the content of an element's attribute by using `attr` and concat different strings by simply having them after the other).\n\nDon't hesitate if a part of my explanations isn't clear.\n\nr? `@jyn514`", "tree": {"sha": "7f85be79c3c37b7989a2067d876ffc6eb676a836", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7f85be79c3c37b7989a2067d876ffc6eb676a836"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b2516121e2f908136ff8351fddd54265a7ba7227", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b2516121e2f908136ff8351fddd54265a7ba7227", "html_url": "https://github.com/rust-lang/rust/commit/b2516121e2f908136ff8351fddd54265a7ba7227", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b2516121e2f908136ff8351fddd54265a7ba7227/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2acf6ee6d2ab3acf3f4d2117591ac1143c8232fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/2acf6ee6d2ab3acf3f4d2117591ac1143c8232fe", "html_url": "https://github.com/rust-lang/rust/commit/2acf6ee6d2ab3acf3f4d2117591ac1143c8232fe"}, {"sha": "152d4e74bec46c08e388b47f3c5693929caf377f", "url": "https://api.github.com/repos/rust-lang/rust/commits/152d4e74bec46c08e388b47f3c5693929caf377f", "html_url": "https://github.com/rust-lang/rust/commit/152d4e74bec46c08e388b47f3c5693929caf377f"}], "stats": {"total": 123, "additions": 52, "deletions": 71}, "files": [{"sha": "077481c89895ed08c8e4639a5df33a51458cdcfc", "filename": "src/librustdoc/html/highlight.rs", "status": "modified", "additions": 10, "deletions": 5, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs?ref=b2516121e2f908136ff8351fddd54265a7ba7227", "patch": "@@ -11,6 +11,7 @@ use std::fmt::{Display, Write};\n use std::iter::Peekable;\n \n use rustc_lexer::{LiteralKind, TokenKind};\n+use rustc_span::edition::Edition;\n use rustc_span::symbol::Ident;\n use rustc_span::with_default_session_globals;\n \n@@ -19,16 +20,20 @@ crate fn render_with_highlighting(\n     src: String,\n     class: Option<&str>,\n     playground_button: Option<&str>,\n-    tooltip: Option<(&str, &str)>,\n+    tooltip: Option<(Option<Edition>, &str)>,\n ) -> String {\n     debug!(\"highlighting: ================\\n{}\\n==============\", src);\n     let mut out = String::with_capacity(src.len());\n-    if let Some((tooltip, class)) = tooltip {\n+    if let Some((edition_info, class)) = tooltip {\n         write!(\n             out,\n-            \"<div class='information'><div class='tooltip {}'>\u24d8<span \\\n-                  class='tooltiptext'>{}</span></div></div>\",\n-            class, tooltip\n+            \"<div class='information'><div class='tooltip {}'{}>\u24d8</div></div>\",\n+            class,\n+            if let Some(edition_info) = edition_info {\n+                format!(\" data-edition=\\\"{}\\\"\", edition_info)\n+            } else {\n+                String::new()\n+            },\n         )\n         .unwrap();\n     }"}, {"sha": "23cf10fe3857e983cddc4074afdd4df61c7e1506", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 14, "deletions": 47, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=b2516121e2f908136ff8351fddd54265a7ba7227", "patch": "@@ -284,60 +284,27 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for CodeBlocks<'_, 'a, I> {\n         });\n \n         let tooltip = if ignore != Ignore::None {\n-            Some((\"This example is not tested\".to_owned(), \"ignore\"))\n+            Some((None, \"ignore\"))\n         } else if compile_fail {\n-            Some((\"This example deliberately fails to compile\".to_owned(), \"compile_fail\"))\n+            Some((None, \"compile_fail\"))\n         } else if should_panic {\n-            Some((\"This example panics\".to_owned(), \"should_panic\"))\n+            Some((None, \"should_panic\"))\n         } else if explicit_edition {\n-            Some((format!(\"This code runs with edition {}\", edition), \"edition\"))\n+            Some((Some(edition), \"edition\"))\n         } else {\n             None\n         };\n \n-        if let Some((s1, s2)) = tooltip {\n-            s.push_str(&highlight::render_with_highlighting(\n-                text,\n-                Some(&format!(\n-                    \"rust-example-rendered{}\",\n-                    if ignore != Ignore::None {\n-                        \" ignore\"\n-                    } else if compile_fail {\n-                        \" compile_fail\"\n-                    } else if should_panic {\n-                        \" should_panic\"\n-                    } else if explicit_edition {\n-                        \" edition \"\n-                    } else {\n-                        \"\"\n-                    }\n-                )),\n-                playground_button.as_deref(),\n-                Some((s1.as_str(), s2)),\n-            ));\n-            Some(Event::Html(s.into()))\n-        } else {\n-            s.push_str(&highlight::render_with_highlighting(\n-                text,\n-                Some(&format!(\n-                    \"rust-example-rendered{}\",\n-                    if ignore != Ignore::None {\n-                        \" ignore\"\n-                    } else if compile_fail {\n-                        \" compile_fail\"\n-                    } else if should_panic {\n-                        \" should_panic\"\n-                    } else if explicit_edition {\n-                        \" edition \"\n-                    } else {\n-                        \"\"\n-                    }\n-                )),\n-                playground_button.as_deref(),\n-                None,\n-            ));\n-            Some(Event::Html(s.into()))\n-        }\n+        s.push_str(&highlight::render_with_highlighting(\n+            text,\n+            Some(&format!(\n+                \"rust-example-rendered{}\",\n+                if let Some((_, class)) = tooltip { format!(\" {}\", class) } else { String::new() }\n+            )),\n+            playground_button.as_deref(),\n+            tooltip,\n+        ));\n+        Some(Event::Html(s.into()))\n     }\n }\n "}, {"sha": "77bb7f31f4a824e50c7261e77425f69bcdbae1ff", "filename": "src/librustdoc/html/static/rustdoc.css", "status": "modified", "additions": 17, "deletions": 7, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Flibrustdoc%2Fhtml%2Fstatic%2Frustdoc.css", "raw_url": "https://github.com/rust-lang/rust/raw/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Flibrustdoc%2Fhtml%2Fstatic%2Frustdoc.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Frustdoc.css?ref=b2516121e2f908136ff8351fddd54265a7ba7227", "patch": "@@ -1079,30 +1079,40 @@ h3 > .collapse-toggle, h4 > .collapse-toggle {\n \tcursor: pointer;\n }\n \n-.tooltip .tooltiptext {\n-\twidth: 120px;\n+.tooltip::after {\n \tdisplay: none;\n \ttext-align: center;\n \tpadding: 5px 3px 3px 3px;\n \tborder-radius: 6px;\n \tmargin-left: 5px;\n-\ttop: -5px;\n-\tleft: 105%;\n-\tz-index: 10;\n \tfont-size: 16px;\n }\n \n-.tooltip .tooltiptext::after {\n+.tooltip.ignore::after {\n+\tcontent: \"This example is not tested\";\n+}\n+.tooltip.compile_fail::after {\n+\tcontent: \"This example deliberately fails to compile\";\n+}\n+.tooltip.should_panic::after {\n+\tcontent: \"This example panics\";\n+}\n+.tooltip.edition::after {\n+\tcontent: \"This code runs with edition \" attr(data-edition);\n+}\n+\n+.tooltip::before {\n \tcontent: \" \";\n \tposition: absolute;\n \ttop: 50%;\n \tleft: 16px;\n \tmargin-top: -5px;\n \tborder-width: 5px;\n \tborder-style: solid;\n+\tdisplay: none;\n }\n \n-.tooltip:hover .tooltiptext {\n+.tooltip:hover::before, .tooltip:hover::after {\n \tdisplay: inline;\n }\n "}, {"sha": "fd8153519afaf1757da297c079de51d0d53bdef0", "filename": "src/librustdoc/html/static/themes/ayu.css", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fayu.css", "raw_url": "https://github.com/rust-lang/rust/raw/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fayu.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fayu.css?ref=b2516121e2f908136ff8351fddd54265a7ba7227", "patch": "@@ -388,13 +388,13 @@ pre.ignore:hover, .information:hover + pre.ignore {\n \tcolor: #39AFD7;\n }\n \n-.tooltip .tooltiptext {\n+.tooltip::after {\n \tbackground-color: #314559;\n \tcolor: #c5c5c5;\n \tborder: 1px solid #5c6773;\n }\n \n-.tooltip .tooltiptext::after {\n+.tooltip::before {\n \tborder-color: transparent #314559 transparent transparent;\n }\n "}, {"sha": "8c7794479a70a35fc3c08a287aaa355c960fe5f0", "filename": "src/librustdoc/html/static/themes/dark.css", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fdark.css", "raw_url": "https://github.com/rust-lang/rust/raw/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fdark.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fdark.css?ref=b2516121e2f908136ff8351fddd54265a7ba7227", "patch": "@@ -337,13 +337,13 @@ pre.ignore:hover, .information:hover + pre.ignore {\n \tcolor: #0089ff;\n }\n \n-.tooltip .tooltiptext {\n+.tooltip::after {\n \tbackground-color: #000;\n \tcolor: #fff;\n \tborder-color: #000;\n }\n \n-.tooltip .tooltiptext::after {\n+.tooltip::before {\n \tborder-color: transparent black transparent transparent;\n }\n "}, {"sha": "814043b35ae61fe9082249df41b78da4def241b4", "filename": "src/librustdoc/html/static/themes/light.css", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Flight.css", "raw_url": "https://github.com/rust-lang/rust/raw/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Flight.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Flight.css?ref=b2516121e2f908136ff8351fddd54265a7ba7227", "patch": "@@ -329,12 +329,12 @@ pre.ignore:hover, .information:hover + pre.ignore {\n \tcolor: #0089ff;\n }\n \n-.tooltip .tooltiptext {\n+.tooltip::after {\n \tbackground-color: #000;\n \tcolor: #fff;\n }\n \n-.tooltip .tooltiptext::after {\n+.tooltip::before {\n \tborder-color: transparent black transparent transparent;\n }\n "}, {"sha": "140c5b3a67203cd3016de0d23e3e0f30a491e6d0", "filename": "src/test/rustdoc/codeblock-title.rs", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Ftest%2Frustdoc%2Fcodeblock-title.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2516121e2f908136ff8351fddd54265a7ba7227/src%2Ftest%2Frustdoc%2Fcodeblock-title.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fcodeblock-title.rs?ref=b2516121e2f908136ff8351fddd54265a7ba7227", "patch": "@@ -1,10 +1,9 @@\n #![crate_name = \"foo\"]\n \n-// ignore-tidy-linelength\n-\n-// @has foo/fn.bar.html '//*[@class=\"tooltip compile_fail\"]/span' \"This example deliberately fails to compile\"\n-// @has foo/fn.bar.html '//*[@class=\"tooltip ignore\"]/span' \"This example is not tested\"\n-// @has foo/fn.bar.html '//*[@class=\"tooltip should_panic\"]/span' \"This example panics\"\n+// @has foo/fn.bar.html '//*[@class=\"tooltip compile_fail\"]' \"\u24d8\"\n+// @has foo/fn.bar.html '//*[@class=\"tooltip ignore\"]' \"\u24d8\"\n+// @has foo/fn.bar.html '//*[@class=\"tooltip should_panic\"]' \"\u24d8\"\n+// @has foo/fn.bar.html '//*[@data-edition=\"2018\"]' \"\u24d8\"\n \n /// foo\n ///\n@@ -20,7 +19,7 @@\n /// hoo();\n /// ```\n ///\n-/// ```\n+/// ```edition2018\n /// let x = 0;\n /// ```\n pub fn bar() -> usize { 2 }"}]}