{"sha": "09134982e53830a4268a95b57fda2b9e39c1908b", "node_id": "C_kwDOAAsO6NoAKDA5MTM0OTgyZTUzODMwYTQyNjhhOTViNTdmZGEyYjllMzljMTkwOGI", "commit": {"author": {"name": "ouz-a", "email": "oguz.agcayazi@gmail.com", "date": "2022-07-24T11:40:43Z"}, "committer": {"name": "ouz-a", "email": "oguz.agcayazi@gmail.com", "date": "2022-07-24T11:40:43Z"}, "message": "optimize un_derefer", "tree": {"sha": "3f33c1658c58a8b5302e0be5f424ce9cdf4e8211", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3f33c1658c58a8b5302e0be5f424ce9cdf4e8211"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/09134982e53830a4268a95b57fda2b9e39c1908b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/09134982e53830a4268a95b57fda2b9e39c1908b", "html_url": "https://github.com/rust-lang/rust/commit/09134982e53830a4268a95b57fda2b9e39c1908b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/09134982e53830a4268a95b57fda2b9e39c1908b/comments", "author": {"login": "ouz-a", "id": 90461915, "node_id": "MDQ6VXNlcjkwNDYxOTE1", "avatar_url": "https://avatars.githubusercontent.com/u/90461915?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ouz-a", "html_url": "https://github.com/ouz-a", "followers_url": "https://api.github.com/users/ouz-a/followers", "following_url": "https://api.github.com/users/ouz-a/following{/other_user}", "gists_url": "https://api.github.com/users/ouz-a/gists{/gist_id}", "starred_url": "https://api.github.com/users/ouz-a/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ouz-a/subscriptions", "organizations_url": "https://api.github.com/users/ouz-a/orgs", "repos_url": "https://api.github.com/users/ouz-a/repos", "events_url": "https://api.github.com/users/ouz-a/events{/privacy}", "received_events_url": "https://api.github.com/users/ouz-a/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ouz-a", "id": 90461915, "node_id": "MDQ6VXNlcjkwNDYxOTE1", "avatar_url": "https://avatars.githubusercontent.com/u/90461915?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ouz-a", "html_url": "https://github.com/ouz-a", "followers_url": "https://api.github.com/users/ouz-a/followers", "following_url": "https://api.github.com/users/ouz-a/following{/other_user}", "gists_url": "https://api.github.com/users/ouz-a/gists{/gist_id}", "starred_url": "https://api.github.com/users/ouz-a/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ouz-a/subscriptions", "organizations_url": "https://api.github.com/users/ouz-a/orgs", "repos_url": "https://api.github.com/users/ouz-a/repos", "events_url": "https://api.github.com/users/ouz-a/events{/privacy}", "received_events_url": "https://api.github.com/users/ouz-a/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b4c3a2af7ba0199e99de8ef64a3b112824efebb6", "url": "https://api.github.com/repos/rust-lang/rust/commits/b4c3a2af7ba0199e99de8ef64a3b112824efebb6", "html_url": "https://github.com/rust-lang/rust/commit/b4c3a2af7ba0199e99de8ef64a3b112824efebb6"}], "stats": {"total": 53, "additions": 26, "deletions": 27}, "files": [{"sha": "5bda6a41cedb9df01833bfb49da6eddff7e11468", "filename": "compiler/rustc_borrowck/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_borrowck%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_borrowck%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Flib.rs?ref=09134982e53830a4268a95b57fda2b9e39c1908b", "patch": "@@ -212,7 +212,7 @@ fn do_mir_borrowck<'a, 'tcx>(\n \n     let (move_data, move_errors): (MoveData<'tcx>, Vec<(Place<'tcx>, MoveError<'tcx>)>) =\n         match MoveData::gather_moves(&body, tcx, param_env) {\n-            Ok(move_data) => (move_data, Vec::new()),\n+            Ok((_, move_data)) => (move_data, Vec::new()),\n             Err((move_data, move_errors)) => (move_data, move_errors),\n         };\n     let promoted_errors = promoted"}, {"sha": "462429d1a2281017d5b5cfe4eb8d4b5d19d5af3a", "filename": "compiler/rustc_mir_dataflow/src/move_paths/builder.rs", "status": "modified", "additions": 14, "deletions": 3, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_mir_dataflow%2Fsrc%2Fmove_paths%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_mir_dataflow%2Fsrc%2Fmove_paths%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Fmove_paths%2Fbuilder.rs?ref=09134982e53830a4268a95b57fda2b9e39c1908b", "patch": "@@ -1,4 +1,5 @@\n use crate::un_derefer::UnDerefer;\n+use rustc_data_structures::stable_map::FxHashMap;\n use rustc_index::vec::IndexVec;\n use rustc_middle::mir::tcx::RvalueInitializationState;\n use rustc_middle::mir::*;\n@@ -209,7 +210,10 @@ impl<'b, 'a, 'tcx> Gatherer<'b, 'a, 'tcx> {\n impl<'a, 'tcx> MoveDataBuilder<'a, 'tcx> {\n     fn finalize(\n         self,\n-    ) -> Result<MoveData<'tcx>, (MoveData<'tcx>, Vec<(Place<'tcx>, MoveError<'tcx>)>)> {\n+    ) -> Result<\n+        (FxHashMap<rustc_middle::mir::Local, rustc_middle::mir::Place<'tcx>>, MoveData<'tcx>),\n+        (MoveData<'tcx>, Vec<(Place<'tcx>, MoveError<'tcx>)>),\n+    > {\n         debug!(\"{}\", {\n             debug!(\"moves for {:?}:\", self.body.span);\n             for (j, mo) in self.data.moves.iter_enumerated() {\n@@ -222,15 +226,22 @@ impl<'a, 'tcx> MoveDataBuilder<'a, 'tcx> {\n             \"done dumping moves\"\n         });\n \n-        if !self.errors.is_empty() { Err((self.data, self.errors)) } else { Ok(self.data) }\n+        if !self.errors.is_empty() {\n+            Err((self.data, self.errors))\n+        } else {\n+            Ok((self.un_derefer.derefer_sidetable.clone(), self.data))\n+        }\n     }\n }\n \n pub(super) fn gather_moves<'tcx>(\n     body: &Body<'tcx>,\n     tcx: TyCtxt<'tcx>,\n     param_env: ty::ParamEnv<'tcx>,\n-) -> Result<MoveData<'tcx>, (MoveData<'tcx>, Vec<(Place<'tcx>, MoveError<'tcx>)>)> {\n+) -> Result<\n+    (FxHashMap<rustc_middle::mir::Local, rustc_middle::mir::Place<'tcx>>, MoveData<'tcx>),\n+    (MoveData<'tcx>, Vec<(Place<'tcx>, MoveError<'tcx>)>),\n+> {\n     let mut builder = MoveDataBuilder::new(body, tcx, param_env);\n \n     builder.gather_args();"}, {"sha": "b6050a1ccaa053854d6a7bf22dd14c430530c287", "filename": "compiler/rustc_mir_dataflow/src/move_paths/mod.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_mir_dataflow%2Fsrc%2Fmove_paths%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_mir_dataflow%2Fsrc%2Fmove_paths%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Fmove_paths%2Fmod.rs?ref=09134982e53830a4268a95b57fda2b9e39c1908b", "patch": "@@ -386,7 +386,10 @@ impl<'tcx> MoveData<'tcx> {\n         body: &Body<'tcx>,\n         tcx: TyCtxt<'tcx>,\n         param_env: ParamEnv<'tcx>,\n-    ) -> Result<Self, (Self, Vec<(Place<'tcx>, MoveError<'tcx>)>)> {\n+    ) -> Result<\n+        (FxHashMap<rustc_middle::mir::Local, rustc_middle::mir::Place<'tcx>>, MoveData<'tcx>),\n+        (MoveData<'tcx>, Vec<(Place<'tcx>, MoveError<'tcx>)>),\n+    > {\n         builder::gather_moves(body, tcx, param_env)\n     }\n "}, {"sha": "98671a8681635cc1dad4f7894a5cd80415276938", "filename": "compiler/rustc_mir_dataflow/src/rustc_peek.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_mir_dataflow%2Fsrc%2Frustc_peek.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_mir_dataflow%2Fsrc%2Frustc_peek.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Frustc_peek.rs?ref=09134982e53830a4268a95b57fda2b9e39c1908b", "patch": "@@ -30,8 +30,8 @@ impl<'tcx> MirPass<'tcx> for SanityCheck {\n         }\n \n         let param_env = tcx.param_env(def_id);\n-        let move_data = MoveData::gather_moves(body, tcx, param_env).unwrap();\n-        let mdpe = MoveDataParamEnv { move_data, param_env };\n+        let (_, move_data) = MoveData::gather_moves(body, tcx, param_env).unwrap();\n+        let mdpe = MoveDataParamEnv { move_data: move_data, param_env };\n \n         if has_rustc_mir_with(tcx, def_id, sym::rustc_peek_maybe_init).is_some() {\n             let flow_inits = MaybeInitializedPlaces::new(tcx, body, &mdpe)"}, {"sha": "04f626b49e841a9cc7675a1052abebd12e36f552", "filename": "compiler/rustc_mir_dataflow/src/un_derefer.rs", "status": "modified", "additions": 1, "deletions": 15, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_mir_dataflow%2Fsrc%2Fun_derefer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_mir_dataflow%2Fsrc%2Fun_derefer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Fun_derefer.rs?ref=09134982e53830a4268a95b57fda2b9e39c1908b", "patch": "@@ -9,6 +9,7 @@ pub struct UnDerefer<'tcx> {\n }\n \n impl<'tcx> UnDerefer<'tcx> {\n+    #[inline]\n     pub fn derefer(&self, place: PlaceRef<'tcx>, body: &Body<'tcx>) -> Option<Place<'tcx>> {\n         let reffed = self.derefer_sidetable.get(&place.local)?;\n \n@@ -18,19 +19,4 @@ impl<'tcx> UnDerefer<'tcx> {\n         }\n         Some(new_place)\n     }\n-\n-    pub fn ref_finder(&mut self, body: &Body<'tcx>) {\n-        for (_bb, data) in body.basic_blocks().iter_enumerated() {\n-            for stmt in data.statements.iter() {\n-                match stmt.kind {\n-                    StatementKind::Assign(box (place, Rvalue::CopyForDeref(reffed))) => {\n-                        if body.local_decls[place.local].is_deref_temp() {\n-                            self.derefer_sidetable.insert(place.local, reffed);\n-                        }\n-                    }\n-                    _ => (),\n-                }\n-            }\n-        }\n-    }\n }"}, {"sha": "9c1fcbaa69d6b45f523c8071b31053c18b1bafed", "filename": "compiler/rustc_mir_transform/src/elaborate_drops.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_mir_transform%2Fsrc%2Felaborate_drops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_mir_transform%2Fsrc%2Felaborate_drops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Felaborate_drops.rs?ref=09134982e53830a4268a95b57fda2b9e39c1908b", "patch": "@@ -28,20 +28,19 @@ impl<'tcx> MirPass<'tcx> for ElaborateDrops {\n     fn run_pass(&self, tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>) {\n         debug!(\"elaborate_drops({:?} @ {:?})\", body.source, body.span);\n \n-        let mut un_derefer = UnDerefer { tcx: tcx, derefer_sidetable: Default::default() };\n-        un_derefer.ref_finder(body);\n         let def_id = body.source.def_id();\n         let param_env = tcx.param_env_reveal_all_normalized(def_id);\n-        let move_data = match MoveData::gather_moves(body, tcx, param_env) {\n+        let (side_table, move_data) = match MoveData::gather_moves(body, tcx, param_env) {\n             Ok(move_data) => move_data,\n             Err((move_data, _)) => {\n                 tcx.sess.delay_span_bug(\n                     body.span,\n                     \"No `move_errors` should be allowed in MIR borrowck\",\n                 );\n-                move_data\n+                (Default::default(), move_data)\n             }\n         };\n+        let un_derefer = UnDerefer { tcx: tcx, derefer_sidetable: side_table };\n         let elaborate_patch = {\n             let body = &*body;\n             let env = MoveDataParamEnv { move_data, param_env };"}, {"sha": "4c33f839f9b8bc5812832544e6a3cd3667d05764", "filename": "compiler/rustc_mir_transform/src/remove_uninit_drops.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_mir_transform%2Fsrc%2Fremove_uninit_drops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09134982e53830a4268a95b57fda2b9e39c1908b/compiler%2Frustc_mir_transform%2Fsrc%2Fremove_uninit_drops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fremove_uninit_drops.rs?ref=09134982e53830a4268a95b57fda2b9e39c1908b", "patch": "@@ -21,7 +21,7 @@ pub struct RemoveUninitDrops;\n impl<'tcx> MirPass<'tcx> for RemoveUninitDrops {\n     fn run_pass(&self, tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>) {\n         let param_env = tcx.param_env(body.source.def_id());\n-        let Ok(move_data) = MoveData::gather_moves(body, tcx, param_env) else {\n+        let Ok((_,move_data)) = MoveData::gather_moves(body, tcx, param_env) else {\n             // We could continue if there are move errors, but there's not much point since our\n             // init data isn't complete.\n             return;"}]}