{"sha": "03d1644acc4e4cf69cde361564982c468ce92efa", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAzZDE2NDRhY2M0ZTRjZjY5Y2RlMzYxNTY0OTgyYzQ2OGNlOTJlZmE=", "commit": {"author": {"name": "Haitao Li", "email": "lihaitao@gmail.com", "date": "2011-12-08T16:02:25Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2011-12-13T00:15:29Z"}, "message": "Update snapshot scripts to pick up the versioned libraries", "tree": {"sha": "89cda32deab18dc90eda48776c799cc2ffd689ea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/89cda32deab18dc90eda48776c799cc2ffd689ea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/03d1644acc4e4cf69cde361564982c468ce92efa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/03d1644acc4e4cf69cde361564982c468ce92efa", "html_url": "https://github.com/rust-lang/rust/commit/03d1644acc4e4cf69cde361564982c468ce92efa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/03d1644acc4e4cf69cde361564982c468ce92efa/comments", "author": {"login": "lht", "id": 19508, "node_id": "MDQ6VXNlcjE5NTA4", "avatar_url": "https://avatars.githubusercontent.com/u/19508?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lht", "html_url": "https://github.com/lht", "followers_url": "https://api.github.com/users/lht/followers", "following_url": "https://api.github.com/users/lht/following{/other_user}", "gists_url": "https://api.github.com/users/lht/gists{/gist_id}", "starred_url": "https://api.github.com/users/lht/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lht/subscriptions", "organizations_url": "https://api.github.com/users/lht/orgs", "repos_url": "https://api.github.com/users/lht/repos", "events_url": "https://api.github.com/users/lht/events{/privacy}", "received_events_url": "https://api.github.com/users/lht/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6dbd4c21e9cc0fd3bb337ad2d9f10e206cf3e575", "url": "https://api.github.com/repos/rust-lang/rust/commits/6dbd4c21e9cc0fd3bb337ad2d9f10e206cf3e575", "html_url": "https://github.com/rust-lang/rust/commit/6dbd4c21e9cc0fd3bb337ad2d9f10e206cf3e575"}], "stats": {"total": 30, "additions": 21, "deletions": 9}, "files": [{"sha": "22dce4b8781d88ecaff26867c90e704b12a4e8e9", "filename": "src/etc/snapshot.py", "status": "modified", "additions": 21, "deletions": 9, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/03d1644acc4e4cf69cde361564982c468ce92efa/src%2Fetc%2Fsnapshot.py", "raw_url": "https://github.com/rust-lang/rust/raw/03d1644acc4e4cf69cde361564982c468ce92efa/src%2Fetc%2Fsnapshot.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fsnapshot.py?ref=03d1644acc4e4cf69cde361564982c468ce92efa", "patch": "@@ -1,4 +1,4 @@\n-import re, os, sys, hashlib, tarfile, shutil, subprocess, tempfile\n+import re, os, sys, glob, hashlib, tarfile, shutil, subprocess, tempfile\n \n def scrub(b):\n   if sys.version_info >= (3,) and type(b) == bytes:\n@@ -17,18 +17,18 @@ def scrub(b):\n \n snapshot_files = {\n     \"linux\": [\"bin/rustc\",\n-              \"lib/libcore.so\",\n-              \"lib/libruststd.so\",\n+              \"lib/libcore-*.so\",\n+              \"lib/libstd-*.so\",\n               \"lib/librustrt.so\",\n               \"lib/librustllvm.so\"],\n     \"macos\": [\"bin/rustc\",\n-              \"lib/libcore.dylib\",\n-              \"lib/libruststd.dylib\",\n+              \"lib/libcore-*.dylib\",\n+              \"lib/libstd-*.dylib\",\n               \"lib/librustrt.dylib\",\n               \"lib/librustllvm.dylib\"],\n     \"winnt\": [\"bin/rustc.exe\",\n-              \"lib/core.dll\",\n-              \"lib/ruststd.dll\",\n+              \"lib/core-*.dll\",\n+              \"lib/std-*.dll\",\n               \"lib/rustrt.dll\",\n               \"lib/rustllvm.dll\"]\n     }\n@@ -128,13 +128,25 @@ def make_snapshot(stage, triple, flag):\n \n     file0 = partial_snapshot_name(date, rev, platform)\n \n+    def in_tar_name(fn):\n+      cs = fn.split(os.sep)\n+      if len(cs) >= 2:\n+        return os.sep.join(cs[-2:])\n+\n     tar = tarfile.open(file0, \"w:bz2\")\n     for name in snapshot_files[kernel]:\n       dir = stage\n       if stage == \"stage1\" and re.match(r\"^lib/(lib)?std.*\", name):\n         dir = \"stage0\"\n-      tar.add(os.path.join(triple, os.path.join(dir, name)),\n-              \"rust-stage0/\" + name)\n+      fn_glob = os.path.join(triple, dir, name)\n+      matches = glob.glob(fn_glob)\n+      if not matches:\n+        raise Exception(\"Not found file with name like \" + fn_glob)\n+      if len(matches) == 1:\n+        tar.add(matches[0], \"rust-stage0/\" + in_tar_name(matches[0]))\n+      else:\n+        raise Exception(\"Found stale files: \\n  %s\\n\\\n+Please make a clean build.\" % \"\\n  \".join(matches))\n     tar.close()\n \n     h = hash_file(file0)"}]}