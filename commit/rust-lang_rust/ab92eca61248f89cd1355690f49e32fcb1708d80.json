{"sha": "ab92eca61248f89cd1355690f49e32fcb1708d80", "node_id": "C_kwDOAAsO6NoAKGFiOTJlY2E2MTI0OGY4OWNkMTM1NTY5MGY0OWUzMmZjYjE3MDhkODA", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2021-12-09T04:08:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-12-09T04:08:34Z"}, "message": "Rollup merge of #91685 - Aaron1011:install-llvm-tools, r=Mark-Simulacrum\n\nInstall llvm tools to sysroot when assembling local toolchain\n\nSome projects (e.g. the `bootimage` crate) may require the\nuser to install the `llvm-tools-preview` rustup component.\nHowever, this cannot be easily done with a locally built toolchain.\n\nTo allow a local toolchain to be used a drop-in replacement for\na normal rustup toolchain in more cases, this PR copies the built\nLLVM tools to the sysoot. From the perspective a tool looking\nat the sysroot, this is equivalent to installing `llvm-tools-preview`.", "tree": {"sha": "da8890b541689eb48a50771a02bd4407340eaca5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/da8890b541689eb48a50771a02bd4407340eaca5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ab92eca61248f89cd1355690f49e32fcb1708d80", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhsYFDCRBK7hj4Ov3rIwAANAIIAHm3FY4ASgcQhkdV7aE+AS16\nnC7FpdoL/Xz/qp+6mrvoW+m72kd/g29GkOTKjX08jhvWKczySgXUBFFwSsGi8ewH\nqwuElYncYz3ho5oVNAVKrNFhpHT8emce/fU/fV7YL/yoK4YX7HSWxGXK1G63+iDq\nhxxt/QabW2ToBn6Pi0f2xsjkq32dRBZjrmhhodj0gZUbYsS0HQX0QsELENog5fr9\nRG3BtphVCVMHLFgkHRL6j6FD66VkMFCFYTWgsJ7uGFCC3fzcM6KCVympMTKr/qvW\nU5zl6fQWfgjsbTSEfruWxzr1Oek67QN/vWp1YDiF0z0TJZgH+cNAzVlmHh2iAjc=\n=5+8T\n-----END PGP SIGNATURE-----\n", "payload": "tree da8890b541689eb48a50771a02bd4407340eaca5\nparent 8c94b2c375d89d55787d3f97e6080c9d164e8414\nparent 9bcbc58eba8563e6b829941d65c42a24476e7048\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1639022914 +0100\ncommitter GitHub <noreply@github.com> 1639022914 +0100\n\nRollup merge of #91685 - Aaron1011:install-llvm-tools, r=Mark-Simulacrum\n\nInstall llvm tools to sysroot when assembling local toolchain\n\nSome projects (e.g. the `bootimage` crate) may require the\nuser to install the `llvm-tools-preview` rustup component.\nHowever, this cannot be easily done with a locally built toolchain.\n\nTo allow a local toolchain to be used a drop-in replacement for\na normal rustup toolchain in more cases, this PR copies the built\nLLVM tools to the sysoot. From the perspective a tool looking\nat the sysroot, this is equivalent to installing `llvm-tools-preview`.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ab92eca61248f89cd1355690f49e32fcb1708d80", "html_url": "https://github.com/rust-lang/rust/commit/ab92eca61248f89cd1355690f49e32fcb1708d80", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ab92eca61248f89cd1355690f49e32fcb1708d80/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8c94b2c375d89d55787d3f97e6080c9d164e8414", "url": "https://api.github.com/repos/rust-lang/rust/commits/8c94b2c375d89d55787d3f97e6080c9d164e8414", "html_url": "https://github.com/rust-lang/rust/commit/8c94b2c375d89d55787d3f97e6080c9d164e8414"}, {"sha": "9bcbc58eba8563e6b829941d65c42a24476e7048", "url": "https://api.github.com/repos/rust-lang/rust/commits/9bcbc58eba8563e6b829941d65c42a24476e7048", "html_url": "https://github.com/rust-lang/rust/commit/9bcbc58eba8563e6b829941d65c42a24476e7048"}], "stats": {"total": 11, "additions": 11, "deletions": 0}, "files": [{"sha": "186b5e92d33e35dfa5c31fe79798e7d565b2b99d", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ab92eca61248f89cd1355690f49e32fcb1708d80/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ab92eca61248f89cd1355690f49e32fcb1708d80/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=ab92eca61248f89cd1355690f49e32fcb1708d80", "patch": "@@ -28,6 +28,7 @@ use crate::dist;\n use crate::native;\n use crate::tool::SourceType;\n use crate::util::{exe, is_debug_info, is_dylib, symlink_dir};\n+use crate::LLVM_TOOLS;\n use crate::{Compiler, DependencyType, GitRepo, Mode};\n \n #[derive(Debug, PartialOrd, Ord, Copy, Clone, PartialEq, Eq, Hash)]\n@@ -1164,6 +1165,16 @@ impl Step for Assemble {\n                 let llvm_bin_dir = output(Command::new(llvm_config_bin).arg(\"--bindir\"));\n                 let llvm_bin_dir = Path::new(llvm_bin_dir.trim());\n                 builder.copy(&llvm_bin_dir.join(&src_exe), &libdir_bin.join(&dst_exe));\n+\n+                // Since we've already built the LLVM tools, install them to the sysroot.\n+                // This is the equivalent of installing the `llvm-tools-preview` component via\n+                // rustup, and lets developers use a locally built toolchain to\n+                // build projects that expect llvm tools to be present in the sysroot\n+                // (e.g. the `bootimage` crate).\n+                for tool in LLVM_TOOLS {\n+                    let tool_exe = exe(tool, target_compiler.host);\n+                    builder.copy(&llvm_bin_dir.join(&tool_exe), &libdir_bin.join(&tool_exe));\n+                }\n             }\n         }\n "}]}