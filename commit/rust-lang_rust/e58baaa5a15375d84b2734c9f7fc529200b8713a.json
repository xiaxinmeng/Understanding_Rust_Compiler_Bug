{"sha": "e58baaa5a15375d84b2734c9f7fc529200b8713a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU1OGJhYWE1YTE1Mzc1ZDg0YjI3MzRjOWY3ZmM1MjkyMDBiODcxM2E=", "commit": {"author": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2019-08-03T18:11:58Z"}, "committer": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2019-08-03T18:21:09Z"}, "message": "Avoid cloning a TtToken in SubtreeTokenSource::mk_token", "tree": {"sha": "236869459ac06a902f3b39625c1f4b8977fed9d0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/236869459ac06a902f3b39625c1f4b8977fed9d0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e58baaa5a15375d84b2734c9f7fc529200b8713a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e58baaa5a15375d84b2734c9f7fc529200b8713a", "html_url": "https://github.com/rust-lang/rust/commit/e58baaa5a15375d84b2734c9f7fc529200b8713a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e58baaa5a15375d84b2734c9f7fc529200b8713a/comments", "author": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0ca30b6c4bb717e3cc54bfc98ffaa7a6d8c2cdfd", "url": "https://api.github.com/repos/rust-lang/rust/commits/0ca30b6c4bb717e3cc54bfc98ffaa7a6d8c2cdfd", "html_url": "https://github.com/rust-lang/rust/commit/0ca30b6c4bb717e3cc54bfc98ffaa7a6d8c2cdfd"}], "stats": {"total": 24, "additions": 15, "deletions": 9}, "files": [{"sha": "31e0df3ec9679cd462e6f59e5d52795137f85f74", "filename": "crates/ra_mbe/src/subtree_source.rs", "status": "modified", "additions": 15, "deletions": 9, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/e58baaa5a15375d84b2734c9f7fc529200b8713a/crates%2Fra_mbe%2Fsrc%2Fsubtree_source.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e58baaa5a15375d84b2734c9f7fc529200b8713a/crates%2Fra_mbe%2Fsrc%2Fsubtree_source.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_mbe%2Fsrc%2Fsubtree_source.rs?ref=e58baaa5a15375d84b2734c9f7fc529200b8713a", "patch": "@@ -20,8 +20,10 @@ impl<'a> SubtreeTokenSource<'a> {\n     // Helper function used in test\n     #[cfg(test)]\n     pub fn text(&self) -> SmolStr {\n-        match self.get(self.curr.1) {\n-            Some(tt) => tt.text,\n+        let idx = self.get(self.curr.1);\n+        let cached = self.cached.borrow();\n+        match cached[idx] {\n+            Some(ref tt) => tt.text.clone(),\n             _ => SmolStr::new(\"\"),\n         }\n     }\n@@ -41,16 +43,18 @@ impl<'a> SubtreeTokenSource<'a> {\n     }\n \n     fn mk_token(&self, pos: usize) -> Token {\n-        match self.get(pos) {\n-            Some(tt) => Token { kind: tt.kind, is_jointed_to_next: tt.is_joint_to_next },\n+        let idx = self.get(pos);\n+        let cached = self.cached.borrow();\n+        match cached[idx] {\n+            Some(ref tt) => Token { kind: tt.kind, is_jointed_to_next: tt.is_joint_to_next },\n             None => Token { kind: EOF, is_jointed_to_next: false },\n         }\n     }\n \n-    fn get(&self, pos: usize) -> Option<TtToken> {\n+    fn get(&self, pos: usize) -> usize {\n         let mut cached = self.cached.borrow_mut();\n         if pos < cached.len() {\n-            return cached[pos].clone();\n+            return pos;\n         }\n \n         while pos >= cached.len() {\n@@ -78,7 +82,7 @@ impl<'a> SubtreeTokenSource<'a> {\n             }\n         }\n \n-        cached[pos].clone()\n+        pos\n     }\n }\n \n@@ -103,8 +107,10 @@ impl<'a> TokenSource for SubtreeTokenSource<'a> {\n \n     /// Is the current token a specified keyword?\n     fn is_keyword(&self, kw: &str) -> bool {\n-        match self.get(self.curr.1) {\n-            Some(t) => t.text == *kw,\n+        let idx = self.get(self.curr.1);\n+        let cached = self.cached.borrow();\n+        match cached[idx] {\n+            Some(ref t) => t.text == *kw,\n             _ => false,\n         }\n     }"}]}