{"sha": "56161b2982a4e6513e6765d6cc951ccc0f297a89", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU2MTYxYjI5ODJhNGU2NTEzZTY3NjVkNmNjOTUxY2NjMGYyOTdhODk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-17T04:34:15Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-17T04:34:15Z"}, "message": "Auto merge of #6917 - MysteryJump:fix-manual-unwrap-or-const-fn, r=giraffate\n\nFix false-positive `manual_unwrap_or` inside const fn\n\nFixes #6898\n\nchangelog:  Fix false-positive for manual_unwrap_or in const fn.", "tree": {"sha": "a063b8722e8c5ff9cfa331a4b3c166894e26ff8d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a063b8722e8c5ff9cfa331a4b3c166894e26ff8d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/56161b2982a4e6513e6765d6cc951ccc0f297a89", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/56161b2982a4e6513e6765d6cc951ccc0f297a89", "html_url": "https://github.com/rust-lang/rust/commit/56161b2982a4e6513e6765d6cc951ccc0f297a89", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/56161b2982a4e6513e6765d6cc951ccc0f297a89/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5b3e61d62fef8a486bf42bf80b450c116189f3ef", "url": "https://api.github.com/repos/rust-lang/rust/commits/5b3e61d62fef8a486bf42bf80b450c116189f3ef", "html_url": "https://github.com/rust-lang/rust/commit/5b3e61d62fef8a486bf42bf80b450c116189f3ef"}, {"sha": "02ceeb59d4853eecec3a52a7fbd9f6acc1c3f91c", "url": "https://api.github.com/repos/rust-lang/rust/commits/02ceeb59d4853eecec3a52a7fbd9f6acc1c3f91c", "html_url": "https://github.com/rust-lang/rust/commit/02ceeb59d4853eecec3a52a7fbd9f6acc1c3f91c"}], "stats": {"total": 34, "additions": 32, "deletions": 2}, "files": [{"sha": "615e2d5c2af4ee41b59a5759e93b2b29967f65d2", "filename": "clippy_lints/src/manual_unwrap_or.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/56161b2982a4e6513e6765d6cc951ccc0f297a89/clippy_lints%2Fsrc%2Fmanual_unwrap_or.rs", "raw_url": "https://github.com/rust-lang/rust/raw/56161b2982a4e6513e6765d6cc951ccc0f297a89/clippy_lints%2Fsrc%2Fmanual_unwrap_or.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmanual_unwrap_or.rs?ref=56161b2982a4e6513e6765d6cc951ccc0f297a89", "patch": "@@ -1,6 +1,6 @@\n use crate::consts::constant_simple;\n use crate::utils;\n-use crate::utils::{path_to_local_id, sugg};\n+use crate::utils::{in_constant, path_to_local_id, sugg};\n use clippy_utils::diagnostics::span_lint_and_sugg;\n use clippy_utils::source::{indent_of, reindent_multiline, snippet_opt};\n use clippy_utils::ty::is_type_diagnostic_item;\n@@ -45,7 +45,7 @@ declare_lint_pass!(ManualUnwrapOr => [MANUAL_UNWRAP_OR]);\n \n impl LateLintPass<'_> for ManualUnwrapOr {\n     fn check_expr(&mut self, cx: &LateContext<'tcx>, expr: &'tcx Expr<'tcx>) {\n-        if in_external_macro(cx.sess(), expr.span) {\n+        if in_external_macro(cx.sess(), expr.span) || in_constant(cx, expr.hir_id) {\n             return;\n         }\n         lint_manual_unwrap_or(cx, expr);"}, {"sha": "f1d3252230bc2b7a23c57fa0037c7daa05df0040", "filename": "tests/ui/manual_unwrap_or.fixed", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/56161b2982a4e6513e6765d6cc951ccc0f297a89/tests%2Fui%2Fmanual_unwrap_or.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/56161b2982a4e6513e6765d6cc951ccc0f297a89/tests%2Fui%2Fmanual_unwrap_or.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_unwrap_or.fixed?ref=56161b2982a4e6513e6765d6cc951ccc0f297a89", "patch": "@@ -136,4 +136,19 @@ fn result_unwrap_or() {\n     };\n }\n \n+// don't lint in const fn\n+const fn const_fn_option_unwrap_or() {\n+    match Some(1) {\n+        Some(s) => s,\n+        None => 0,\n+    };\n+}\n+\n+const fn const_fn_result_unwrap_or() {\n+    match Ok::<&str, &str>(\"Alice\") {\n+        Ok(s) => s,\n+        Err(_) => \"Bob\",\n+    };\n+}\n+\n fn main() {}"}, {"sha": "c9eee25a5b1538d96a38e36d8922f44ea1bae6ff", "filename": "tests/ui/manual_unwrap_or.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/56161b2982a4e6513e6765d6cc951ccc0f297a89/tests%2Fui%2Fmanual_unwrap_or.rs", "raw_url": "https://github.com/rust-lang/rust/raw/56161b2982a4e6513e6765d6cc951ccc0f297a89/tests%2Fui%2Fmanual_unwrap_or.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_unwrap_or.rs?ref=56161b2982a4e6513e6765d6cc951ccc0f297a89", "patch": "@@ -175,4 +175,19 @@ fn result_unwrap_or() {\n     };\n }\n \n+// don't lint in const fn\n+const fn const_fn_option_unwrap_or() {\n+    match Some(1) {\n+        Some(s) => s,\n+        None => 0,\n+    };\n+}\n+\n+const fn const_fn_result_unwrap_or() {\n+    match Ok::<&str, &str>(\"Alice\") {\n+        Ok(s) => s,\n+        Err(_) => \"Bob\",\n+    };\n+}\n+\n fn main() {}"}]}