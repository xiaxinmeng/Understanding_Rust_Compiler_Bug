{"sha": "d21d5e42c4d3841bca0871148d69637646c38ff3", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQyMWQ1ZTQyYzRkMzg0MWJjYTA4NzExNDhkNjk2Mzc2NDZjMzhmZjM=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-08-18T15:22:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-08-18T15:22:12Z"}, "message": "Merge #5800\n\n5800: Speedup ty tests\n r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "c1c515841eb0256b807f415ceea5691ccd56e651", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c1c515841eb0256b807f415ceea5691ccd56e651"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d21d5e42c4d3841bca0871148d69637646c38ff3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfO/IkCRBK7hj4Ov3rIwAAdHIIABSIsiUUCZ8aQbGTi3+sOnR9\n07StzoC8i5ipczDu/AtWA1ALPgmXjeUAQqvTL0chXkcL2+51dPFlUBpYUSCAB1Iu\ny9ODU7cpoik41bNPjylR/mRcm4iR1E25tSf5YNe/xVOIykaZ1GlVABrAp5U7lcZr\nJiNgC3BqcLaAymivP7GAvsStepLsIsJpXp7IECmP36gViOk3HrtJLfG4or9U2tLX\n/HrAQYuLrdMpf3P+tcHINRPPl/rQlCRk/vKIsGt5hRiMbplTuEh9pHBw4onyJBLh\nEFXngK0rsV0SqC+LzBPrfl4Oty58KTMSd0qerypCwvMTgXns9ArKRZA6ZDyzc0Y=\n=JefQ\n-----END PGP SIGNATURE-----\n", "payload": "tree c1c515841eb0256b807f415ceea5691ccd56e651\nparent 0df9ecedb4ecd667007457c88eaf4748cd627449\nparent aad911fb0cd772e809270be3e0a526d4738b9dd5\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1597764132 +0000\ncommitter GitHub <noreply@github.com> 1597764132 +0000\n\nMerge #5800\n\n5800: Speedup ty tests\n r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d21d5e42c4d3841bca0871148d69637646c38ff3", "html_url": "https://github.com/rust-lang/rust/commit/d21d5e42c4d3841bca0871148d69637646c38ff3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d21d5e42c4d3841bca0871148d69637646c38ff3/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0df9ecedb4ecd667007457c88eaf4748cd627449", "url": "https://api.github.com/repos/rust-lang/rust/commits/0df9ecedb4ecd667007457c88eaf4748cd627449", "html_url": "https://github.com/rust-lang/rust/commit/0df9ecedb4ecd667007457c88eaf4748cd627449"}, {"sha": "aad911fb0cd772e809270be3e0a526d4738b9dd5", "url": "https://api.github.com/repos/rust-lang/rust/commits/aad911fb0cd772e809270be3e0a526d4738b9dd5", "html_url": "https://github.com/rust-lang/rust/commit/aad911fb0cd772e809270be3e0a526d4738b9dd5"}], "stats": {"total": 47, "additions": 40, "deletions": 7}, "files": [{"sha": "91c9d38c52c3a4941d5221f8a31afb4d5e75055b", "filename": "crates/hir_ty/src/tests.rs", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d21d5e42c4d3841bca0871148d69637646c38ff3/crates%2Fhir_ty%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d21d5e42c4d3841bca0871148d69637646c38ff3/crates%2Fhir_ty%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests.rs?ref=d21d5e42c4d3841bca0871148d69637646c38ff3", "patch": "@@ -8,7 +8,7 @@ mod method_resolution;\n mod macros;\n mod display_source_code;\n \n-use std::sync::Arc;\n+use std::{env, sync::Arc};\n \n use base_db::{fixture::WithFixture, FileRange, SourceDatabase, SourceDatabaseExt};\n use expect::Expect;\n@@ -22,12 +22,14 @@ use hir_def::{\n     AssocItemId, DefWithBodyId, LocalModuleId, Lookup, ModuleDefId,\n };\n use hir_expand::{db::AstDatabase, InFile};\n-use stdx::format_to;\n+use stdx::{format_to, RacyFlag};\n use syntax::{\n     algo,\n     ast::{self, AstNode},\n     SyntaxNode,\n };\n+use tracing_subscriber::{layer::SubscriberExt, EnvFilter, Registry};\n+use tracing_tree::HierarchicalLayer;\n \n use crate::{\n     db::HirDatabase, display::HirDisplay, infer::TypeMismatch, test_db::TestDB, InferenceResult, Ty,\n@@ -37,17 +39,20 @@ use crate::{\n // against snapshots of the expected results using expect. Use\n // `env UPDATE_EXPECT=1 cargo test -p hir_ty` to update the snapshots.\n \n-fn setup_tracing() -> tracing::subscriber::DefaultGuard {\n-    use tracing_subscriber::{layer::SubscriberExt, EnvFilter, Registry};\n-    use tracing_tree::HierarchicalLayer;\n+fn setup_tracing() -> Option<tracing::subscriber::DefaultGuard> {\n+    static ENABLE: RacyFlag = RacyFlag::new();\n+    if !ENABLE.get(|| env::var(\"CHALK_DEBUG\").is_ok()) {\n+        return None;\n+    }\n+\n     let filter = EnvFilter::from_env(\"CHALK_DEBUG\");\n     let layer = HierarchicalLayer::default()\n         .with_indent_lines(true)\n         .with_ansi(false)\n         .with_indent_amount(2)\n         .with_writer(std::io::stderr);\n     let subscriber = Registry::default().with(filter).with(layer);\n-    tracing::subscriber::set_default(subscriber)\n+    Some(tracing::subscriber::set_default(subscriber))\n }\n \n fn check_types(ra_fixture: &str) {"}, {"sha": "5d60f02190ce65782ae600902b87436580dc05d7", "filename": "crates/stdx/src/lib.rs", "status": "modified", "additions": 29, "deletions": 1, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/d21d5e42c4d3841bca0871148d69637646c38ff3/crates%2Fstdx%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d21d5e42c4d3841bca0871148d69637646c38ff3/crates%2Fstdx%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fstdx%2Fsrc%2Flib.rs?ref=d21d5e42c4d3841bca0871148d69637646c38ff3", "patch": "@@ -1,5 +1,8 @@\n //! Missing batteries for standard libraries.\n-use std::time::Instant;\n+use std::{\n+    sync::atomic::{AtomicUsize, Ordering},\n+    time::Instant,\n+};\n \n mod macros;\n \n@@ -134,6 +137,31 @@ where\n     left\n }\n \n+pub struct RacyFlag(AtomicUsize);\n+\n+impl RacyFlag {\n+    pub const fn new() -> RacyFlag {\n+        RacyFlag(AtomicUsize::new(0))\n+    }\n+\n+    pub fn get(&self, init: impl FnMut() -> bool) -> bool {\n+        let mut init = Some(init);\n+        self.get_impl(&mut || init.take().map_or(false, |mut f| f()))\n+    }\n+\n+    fn get_impl(&self, init: &mut dyn FnMut() -> bool) -> bool {\n+        match self.0.load(Ordering::Relaxed) {\n+            0 => false,\n+            1 => true,\n+            _ => {\n+                let res = init();\n+                self.0.store(if res { 1 } else { 0 }, Ordering::Relaxed);\n+                res\n+            }\n+        }\n+    }\n+}\n+\n #[cfg(test)]\n mod tests {\n     use super::*;"}]}