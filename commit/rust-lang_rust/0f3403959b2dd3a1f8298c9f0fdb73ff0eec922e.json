{"sha": "0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e", "node_id": "C_kwDOAAsO6NoAKDBmMzQwMzk1OWIyZGQzYTFmODI5OGM5ZjBmZGI3M2ZmMGVlYzkyMmU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-06T12:32:58Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-06T12:32:58Z"}, "message": "Auto merge of #2748 - Aaron1011:wasm32-support, r=RalfJung\n\nIgnore symbol shim clash when symbol is provided by compiler_builtins\n\nWhen this happens, we ignore the symbol from `compiler_builtins`\nin favor of Miri's builtin support.\n\nThis allows Miri to target platforms like wasm32-unknown-unknown,\nwhere functions like `memcmp` are provided by `compiler_builtins`.", "tree": {"sha": "7c6db6c05be10658181a17a779d30aa67dc2b41c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7c6db6c05be10658181a17a779d30aa67dc2b41c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e", "html_url": "https://github.com/rust-lang/rust/commit/0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e1968dd6120935055e138ab10c6e0a3f3f2288b9", "url": "https://api.github.com/repos/rust-lang/rust/commits/e1968dd6120935055e138ab10c6e0a3f3f2288b9", "html_url": "https://github.com/rust-lang/rust/commit/e1968dd6120935055e138ab10c6e0a3f3f2288b9"}, {"sha": "a474872b5d6ffc323647808bbf8fb10ad611cd8b", "url": "https://api.github.com/repos/rust-lang/rust/commits/a474872b5d6ffc323647808bbf8fb10ad611cd8b", "html_url": "https://github.com/rust-lang/rust/commit/a474872b5d6ffc323647808bbf8fb10ad611cd8b"}], "stats": {"total": 93, "additions": 90, "deletions": 3}, "files": [{"sha": "e01bfbc74d98acaccc77489e6d823024732fab4d", "filename": "src/tools/miri/ci.sh", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e/src%2Ftools%2Fmiri%2Fci.sh", "raw_url": "https://github.com/rust-lang/rust/raw/0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e/src%2Ftools%2Fmiri%2Fci.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Fci.sh?ref=0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e", "patch": "@@ -108,7 +108,8 @@ case $HOST_TARGET in\n     MIRI_TEST_TARGET=i686-pc-windows-msvc run_tests\n     MIRI_TEST_TARGET=x86_64-unknown-freebsd run_tests_minimal hello integer vec panic/panic concurrency/simple atomic data_race env/var\n     MIRI_TEST_TARGET=aarch64-linux-android run_tests_minimal hello integer vec panic/panic\n-    MIRI_TEST_TARGET=wasm32-wasi run_tests_minimal no_std integer\n+    MIRI_TEST_TARGET=wasm32-wasi run_tests_minimal no_std integer strings\n+    MIRI_TEST_TARGET=wasm32-unknown-unknown run_tests_minimal no_std integer strings\n     MIRI_TEST_TARGET=thumbv7em-none-eabihf MIRI_NO_STD=1 run_tests_minimal no_std # no_std embedded architecture\n     MIRI_TEST_TARGET=tests/avr.json MIRI_NO_STD=1 run_tests_minimal no_std # JSON target file\n     ;;"}, {"sha": "527d31d1f0ae8acc199671562b425742a8a0eb15", "filename": "src/tools/miri/src/helpers.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e/src%2Ftools%2Fmiri%2Fsrc%2Fhelpers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e/src%2Ftools%2Fmiri%2Fsrc%2Fhelpers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Fsrc%2Fhelpers.rs?ref=0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e", "patch": "@@ -943,7 +943,16 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriInterpCxExt<'mir, 'tcx> {\n         link_name: Symbol,\n     ) -> InterpResult<'tcx, ()> {\n         self.check_abi(abi, exp_abi)?;\n-        if let Some((body, _)) = self.eval_context_mut().lookup_exported_symbol(link_name)? {\n+        if let Some((body, instance)) = self.eval_context_mut().lookup_exported_symbol(link_name)? {\n+            // If compiler-builtins is providing the symbol, then don't treat it as a clash.\n+            // We'll use our built-in implementation in `emulate_foreign_item_by_name` for increased\n+            // performance. Note that this means we won't catch any undefined behavior in\n+            // compiler-builtins when running other crates, but Miri can still be run on\n+            // compiler-builtins itself (or any crate that uses it as a normal dependency)\n+            if self.eval_context_ref().tcx.is_compiler_builtins(instance.def_id().krate) {\n+                return Ok(());\n+            }\n+\n             throw_machine_stop!(TerminationInfo::SymbolShimClashing {\n                 link_name,\n                 span: body.span.data(),"}, {"sha": "d1389c5e71daa608edcc5f7877e74a2dc0af5c7d", "filename": "src/tools/miri/test_dependencies/Cargo.lock", "status": "modified", "additions": 77, "deletions": 0, "changes": 77, "blob_url": "https://github.com/rust-lang/rust/blob/0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e/src%2Ftools%2Fmiri%2Ftest_dependencies%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e/src%2Ftools%2Fmiri%2Ftest_dependencies%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Ftest_dependencies%2FCargo.lock?ref=0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e", "patch": "@@ -14,6 +14,12 @@ version = \"1.3.2\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"bef38d45163c2f1dde094a7dfd33ccf595c92905c8f8f4fdc18d06fb1037718a\"\n \n+[[package]]\n+name = \"bumpalo\"\n+version = \"3.11.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"572f695136211188308f16ad2ca5c851a712c464060ae6974944458eb83880ba\"\n+\n [[package]]\n name = \"bytes\"\n version = \"1.3.0\"\n@@ -44,8 +50,10 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"c05aeb6a22b8f62540c194aac980f2115af067bfe15a0734d7277a768d396b31\"\n dependencies = [\n  \"cfg-if\",\n+ \"js-sys\",\n  \"libc\",\n  \"wasi 0.11.0+wasi-snapshot-preview1\",\n+ \"wasm-bindgen\",\n ]\n \n [[package]]\n@@ -57,6 +65,15 @@ dependencies = [\n  \"libc\",\n ]\n \n+[[package]]\n+name = \"js-sys\"\n+version = \"0.3.60\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"49409df3e3bf0856b916e2ceaca09ee28e6871cf7d9ce97a692cacfdb2a25a47\"\n+dependencies = [\n+ \"wasm-bindgen\",\n+]\n+\n [[package]]\n name = \"libc\"\n version = \"0.2.139\"\n@@ -123,6 +140,12 @@ dependencies = [\n  \"libc\",\n ]\n \n+[[package]]\n+name = \"once_cell\"\n+version = \"1.17.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"6f61fba1741ea2b3d6a1e3178721804bb716a68a6aeba1149b5d52e3d464ea66\"\n+\n [[package]]\n name = \"page_size\"\n version = \"0.5.0\"\n@@ -316,6 +339,60 @@ version = \"0.11.0+wasi-snapshot-preview1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"9c8d87e72b64a3b4db28d11ce29237c246188f4f51057d65a7eab63b7987e423\"\n \n+[[package]]\n+name = \"wasm-bindgen\"\n+version = \"0.2.83\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"eaf9f5aceeec8be17c128b2e93e031fb8a4d469bb9c4ae2d7dc1888b26887268\"\n+dependencies = [\n+ \"cfg-if\",\n+ \"wasm-bindgen-macro\",\n+]\n+\n+[[package]]\n+name = \"wasm-bindgen-backend\"\n+version = \"0.2.83\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"4c8ffb332579b0557b52d268b91feab8df3615f265d5270fec2a8c95b17c1142\"\n+dependencies = [\n+ \"bumpalo\",\n+ \"log\",\n+ \"once_cell\",\n+ \"proc-macro2\",\n+ \"quote\",\n+ \"syn\",\n+ \"wasm-bindgen-shared\",\n+]\n+\n+[[package]]\n+name = \"wasm-bindgen-macro\"\n+version = \"0.2.83\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"052be0f94026e6cbc75cdefc9bae13fd6052cdcaf532fa6c45e7ae33a1e6c810\"\n+dependencies = [\n+ \"quote\",\n+ \"wasm-bindgen-macro-support\",\n+]\n+\n+[[package]]\n+name = \"wasm-bindgen-macro-support\"\n+version = \"0.2.83\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"07bc0c051dc5f23e307b13285f9d75df86bfdf816c5721e573dec1f9b8aa193c\"\n+dependencies = [\n+ \"proc-macro2\",\n+ \"quote\",\n+ \"syn\",\n+ \"wasm-bindgen-backend\",\n+ \"wasm-bindgen-shared\",\n+]\n+\n+[[package]]\n+name = \"wasm-bindgen-shared\"\n+version = \"0.2.83\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"1c38c045535d93ec4f0b4defec448e4291638ee608530863b1e2ba115d4fff7f\"\n+\n [[package]]\n name = \"winapi\"\n version = \"0.3.9\""}, {"sha": "91b6ca49a56648d425e2ec5b20fd5fc091e24505", "filename": "src/tools/miri/test_dependencies/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e/src%2Ftools%2Fmiri%2Ftest_dependencies%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e/src%2Ftools%2Fmiri%2Ftest_dependencies%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Ftest_dependencies%2FCargo.toml?ref=0f3403959b2dd3a1f8298c9f0fdb73ff0eec922e", "patch": "@@ -13,7 +13,7 @@ libc = \"0.2\"\n num_cpus = \"1.10.1\"\n \n getrandom_1 = { package = \"getrandom\", version = \"0.1\" }\n-getrandom = { version = \"0.2\" }\n+getrandom = { version = \"0.2\", features = [\"js\"] }\n rand = { version = \"0.8\", features = [\"small_rng\"] }\n \n [target.'cfg(not(any(target_arch = \"wasm32\", target_arch = \"wasm64\")))'.dependencies]"}]}