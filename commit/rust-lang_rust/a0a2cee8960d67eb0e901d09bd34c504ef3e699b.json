{"sha": "a0a2cee8960d67eb0e901d09bd34c504ef3e699b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEwYTJjZWU4OTYwZDY3ZWIwZTkwMWQwOWJkMzRjNTA0ZWYzZTY5OWI=", "commit": {"author": {"name": "Michael Sullivan", "email": "sully@msully.net", "date": "2011-07-21T21:58:39Z"}, "committer": {"name": "Michael Sullivan", "email": "sully@msully.net", "date": "2011-07-22T01:19:07Z"}, "message": "Clean up build_environment by having it return a rec with usefully named fields.", "tree": {"sha": "125910fb0037edaee306f39cb441c682a4cab8ee", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/125910fb0037edaee306f39cb441c682a4cab8ee"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a0a2cee8960d67eb0e901d09bd34c504ef3e699b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a0a2cee8960d67eb0e901d09bd34c504ef3e699b", "html_url": "https://github.com/rust-lang/rust/commit/a0a2cee8960d67eb0e901d09bd34c504ef3e699b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a0a2cee8960d67eb0e901d09bd34c504ef3e699b/comments", "author": {"login": "msullivan", "id": 340349, "node_id": "MDQ6VXNlcjM0MDM0OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/340349?v=4", "gravatar_id": "", "url": "https://api.github.com/users/msullivan", "html_url": "https://github.com/msullivan", "followers_url": "https://api.github.com/users/msullivan/followers", "following_url": "https://api.github.com/users/msullivan/following{/other_user}", "gists_url": "https://api.github.com/users/msullivan/gists{/gist_id}", "starred_url": "https://api.github.com/users/msullivan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/msullivan/subscriptions", "organizations_url": "https://api.github.com/users/msullivan/orgs", "repos_url": "https://api.github.com/users/msullivan/repos", "events_url": "https://api.github.com/users/msullivan/events{/privacy}", "received_events_url": "https://api.github.com/users/msullivan/received_events", "type": "User", "site_admin": false}, "committer": {"login": "msullivan", "id": 340349, "node_id": "MDQ6VXNlcjM0MDM0OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/340349?v=4", "gravatar_id": "", "url": "https://api.github.com/users/msullivan", "html_url": "https://github.com/msullivan", "followers_url": "https://api.github.com/users/msullivan/followers", "following_url": "https://api.github.com/users/msullivan/following{/other_user}", "gists_url": "https://api.github.com/users/msullivan/gists{/gist_id}", "starred_url": "https://api.github.com/users/msullivan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/msullivan/subscriptions", "organizations_url": "https://api.github.com/users/msullivan/orgs", "repos_url": "https://api.github.com/users/msullivan/repos", "events_url": "https://api.github.com/users/msullivan/events{/privacy}", "received_events_url": "https://api.github.com/users/msullivan/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4170390cb6cd26e7491968b4383b0e93317ec112", "url": "https://api.github.com/repos/rust-lang/rust/commits/4170390cb6cd26e7491968b4383b0e93317ec112", "html_url": "https://github.com/rust-lang/rust/commit/4170390cb6cd26e7491968b4383b0e93317ec112"}], "stats": {"total": 12, "additions": 5, "deletions": 7}, "files": [{"sha": "176d47c70f284aa68ac733cf9c04c17960c426f1", "filename": "src/comp/middle/trans.rs", "status": "modified", "additions": 5, "deletions": 7, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/a0a2cee8960d67eb0e901d09bd34c504ef3e699b/src%2Fcomp%2Fmiddle%2Ftrans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0a2cee8960d67eb0e901d09bd34c504ef3e699b/src%2Fcomp%2Fmiddle%2Ftrans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans.rs?ref=a0a2cee8960d67eb0e901d09bd34c504ef3e699b", "patch": "@@ -3793,7 +3793,7 @@ fn find_variable(&@fn_ctxt fcx, ast::node_id nid) -> ValueRef {\n // contains pointers to all of the upvars and all of the tydescs in\n // scope. Return the ValueRef and TypeRef corresponding to the closure.\n fn build_environment(&@block_ctxt cx, &ast::node_id[] upvars) ->\n-    tup(ValueRef, TypeRef) {\n+    rec(ValueRef ptr, TypeRef ptrty) {\n     auto upvar_count = std::ivec::len(upvars);\n     auto has_iterbody = !option::is_none(cx.fcx.lliterbody);\n     if (has_iterbody) { upvar_count += 1u; }\n@@ -3852,7 +3852,7 @@ fn build_environment(&@block_ctxt cx, &ast::node_id[] upvars) ->\n         i += 1u;\n     }\n \n-    ret tup(llenvptr, llenvptrty);\n+    ret rec(ptr=llenvptr, ptrty=llenvptrty);\n }\n \n // Given an enclosing block context, a new function context, a closure type,\n@@ -3943,9 +3943,7 @@ fn trans_for_each(&@block_ctxt cx, &@ast::local local, &@ast::expr seq,\n     auto decl_id = local.node.id;\n     auto upvars = get_freevars(lcx.ccx.tcx, body.node.id);\n \n-    auto environment_data = build_environment(cx, *upvars);\n-    auto llenvptr = environment_data._0;\n-    auto llenvptrty = environment_data._1;\n+    auto llenv = build_environment(cx, *upvars);\n \n     // Step 2: Declare foreach body function.\n     let str s =\n@@ -3966,7 +3964,7 @@ fn trans_for_each(&@block_ctxt cx, &@ast::local local, &@ast::expr seq,\n \n     // Generate code to load the environment out of the\n     // environment pointer.\n-    load_environment(cx, fcx, llenvptrty, *upvars);\n+    load_environment(cx, fcx, llenv.ptrty, *upvars);\n \n     // Add an upvar for the loop variable alias.\n     fcx.llupvars.insert(decl_id, llvm::LLVMGetParam(fcx.llfn, 3u));\n@@ -3984,7 +3982,7 @@ fn trans_for_each(&@block_ctxt cx, &@ast::local local, &@ast::expr seq,\n     alt (seq.node) {\n         case (ast::expr_call(?f, ?args)) {\n             auto pair = create_real_fn_pair(cx, iter_body_llty,\n-                                            lliterbody, llenvptr);\n+                                            lliterbody, llenv.ptr);\n             r = trans_call(cx, f, some[ValueRef](cx.build.Load(pair)),\n                            args, seq.id);\n             ret rslt(r.bcx, C_nil());"}]}