{"sha": "b740cdcf43f6d686f52d3f85100a0ff5ff0c043d", "node_id": "C_kwDOAAsO6NoAKGI3NDBjZGNmNDNmNmQ2ODZmNTJkM2Y4NTEwMGEwZmY1ZmYwYzA0M2Q", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-12-02T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-12-03T00:04:42Z"}, "message": "Mark naked functions as never inline in codegen_fn_attrs\n\nUse code generation attributes to ensure that naked functions are never\ninline, replacing separate checks in MIR inliner and LLVM code\ngeneration.", "tree": {"sha": "2061c143decbf92494365d20a914e0ab41d21137", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2061c143decbf92494365d20a914e0ab41d21137"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b740cdcf43f6d686f52d3f85100a0ff5ff0c043d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b740cdcf43f6d686f52d3f85100a0ff5ff0c043d", "html_url": "https://github.com/rust-lang/rust/commit/b740cdcf43f6d686f52d3f85100a0ff5ff0c043d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b740cdcf43f6d686f52d3f85100a0ff5ff0c043d/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c955add18c88427eaf09ec2086e3f8a9ccd30021", "url": "https://api.github.com/repos/rust-lang/rust/commits/c955add18c88427eaf09ec2086e3f8a9ccd30021", "html_url": "https://github.com/rust-lang/rust/commit/c955add18c88427eaf09ec2086e3f8a9ccd30021"}], "stats": {"total": 18, "additions": 7, "deletions": 11}, "files": [{"sha": "f3bdacf6085552109871140a10cacd1e2757d24b", "filename": "compiler/rustc_codegen_llvm/src/attributes.rs", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/b740cdcf43f6d686f52d3f85100a0ff5ff0c043d/compiler%2Frustc_codegen_llvm%2Fsrc%2Fattributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b740cdcf43f6d686f52d3f85100a0ff5ff0c043d/compiler%2Frustc_codegen_llvm%2Fsrc%2Fattributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fattributes.rs?ref=b740cdcf43f6d686f52d3f85100a0ff5ff0c043d", "patch": "@@ -258,13 +258,12 @@ pub fn from_fn_attrs<'ll, 'tcx>(\n         OptimizeAttr::Speed => {}\n     }\n \n-    let inline = if codegen_fn_attrs.flags.contains(CodegenFnAttrFlags::NAKED) {\n-        InlineAttr::Never\n-    } else if codegen_fn_attrs.inline == InlineAttr::None && instance.def.requires_inline(cx.tcx) {\n-        InlineAttr::Hint\n-    } else {\n-        codegen_fn_attrs.inline\n-    };\n+    let inline =\n+        if codegen_fn_attrs.inline == InlineAttr::None && instance.def.requires_inline(cx.tcx) {\n+            InlineAttr::Hint\n+        } else {\n+            codegen_fn_attrs.inline\n+        };\n     to_add.extend(inline_attr(cx, inline));\n \n     // The `uwtable` attribute according to LLVM is:"}, {"sha": "b7084303aafb1d0b85c1c0f2c0423b30c6e519f5", "filename": "compiler/rustc_hir_analysis/src/collect.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b740cdcf43f6d686f52d3f85100a0ff5ff0c043d/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b740cdcf43f6d686f52d3f85100a0ff5ff0c043d/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect.rs?ref=b740cdcf43f6d686f52d3f85100a0ff5ff0c043d", "patch": "@@ -2075,6 +2075,7 @@ fn codegen_fn_attrs(tcx: TyCtxt<'_>, did: DefId) -> CodegenFnAttrs {\n \n     if codegen_fn_attrs.flags.contains(CodegenFnAttrFlags::NAKED) {\n         codegen_fn_attrs.flags |= CodegenFnAttrFlags::NO_COVERAGE;\n+        codegen_fn_attrs.inline = InlineAttr::Never;\n     }\n \n     // Weak lang items have the same semantics as \"std internal\" symbols in the"}, {"sha": "bf670c5c26a7753394e631bca6d73d77ccaf664d", "filename": "compiler/rustc_mir_transform/src/inline.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b740cdcf43f6d686f52d3f85100a0ff5ff0c043d/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b740cdcf43f6d686f52d3f85100a0ff5ff0c043d/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs?ref=b740cdcf43f6d686f52d3f85100a0ff5ff0c043d", "patch": "@@ -363,10 +363,6 @@ impl<'tcx> Inliner<'tcx> {\n             return Err(\"C variadic\");\n         }\n \n-        if callee_attrs.flags.contains(CodegenFnAttrFlags::NAKED) {\n-            return Err(\"naked\");\n-        }\n-\n         if callee_attrs.flags.contains(CodegenFnAttrFlags::COLD) {\n             return Err(\"cold\");\n         }"}]}