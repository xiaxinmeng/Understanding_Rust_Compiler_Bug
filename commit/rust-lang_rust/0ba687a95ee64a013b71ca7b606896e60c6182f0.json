{"sha": "0ba687a95ee64a013b71ca7b606896e60c6182f0", "node_id": "C_kwDOAAsO6NoAKDBiYTY4N2E5NWVlNjRhMDEzYjcxY2E3YjYwNjg5NmU2MGM2MTgyZjA", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2023-02-02T16:42:21Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2023-02-02T17:18:48Z"}, "message": "Parse and recover from type ascription in patterns", "tree": {"sha": "5f1eda6c98e922e31b9777896fcac5b5335e07e7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5f1eda6c98e922e31b9777896fcac5b5335e07e7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0ba687a95ee64a013b71ca7b606896e60c6182f0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0ba687a95ee64a013b71ca7b606896e60c6182f0", "html_url": "https://github.com/rust-lang/rust/commit/0ba687a95ee64a013b71ca7b606896e60c6182f0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0ba687a95ee64a013b71ca7b606896e60c6182f0/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "97872b792c9dd6a9bc5c3f4e62a0bd5958b09cdc", "url": "https://api.github.com/repos/rust-lang/rust/commits/97872b792c9dd6a9bc5c3f4e62a0bd5958b09cdc", "html_url": "https://github.com/rust-lang/rust/commit/97872b792c9dd6a9bc5c3f4e62a0bd5958b09cdc"}], "stats": {"total": 203, "additions": 164, "deletions": 39}, "files": [{"sha": "cd9d85b1d919c9c3f45541e83a9223857550be9c", "filename": "compiler/rustc_parse/src/parser/diagnostics.rs", "status": "modified", "additions": 39, "deletions": 12, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/0ba687a95ee64a013b71ca7b606896e60c6182f0/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ba687a95ee64a013b71ca7b606896e60c6182f0/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs?ref=0ba687a95ee64a013b71ca7b606896e60c6182f0", "patch": "@@ -2405,26 +2405,42 @@ impl<'a> Parser<'a> {\n         if !matches!(first_pat.kind, PatKind::Ident(_, _, None) | PatKind::Path(..))\n             || !self.look_ahead(1, |token| token.is_ident() && !token.is_reserved_ident())\n         {\n+            let mut snapshot_type = self.create_snapshot_for_diagnostic();\n+            snapshot_type.bump(); // `:`\n+            match snapshot_type.parse_ty() {\n+                Err(inner_err) => {\n+                    inner_err.cancel();\n+                }\n+                Ok(ty) => {\n+                    let Err(mut err) = self.expected_one_of_not_found(&[], &[]) else {\n+                        return first_pat;\n+                    };\n+                    err.span_label(ty.span, \"specifying the type of a pattern isn't supported\");\n+                    self.restore_snapshot(snapshot_type);\n+                    let span = first_pat.span.to(ty.span);\n+                    first_pat = self.mk_pat(span, PatKind::Wild);\n+                    err.emit();\n+                }\n+            }\n             return first_pat;\n         }\n         // The pattern looks like it might be a path with a `::` -> `:` typo:\n         // `match foo { bar:baz => {} }`\n-        let span = self.token.span;\n+        let colon_span = self.token.span;\n         // We only emit \"unexpected `:`\" error here if we can successfully parse the\n         // whole pattern correctly in that case.\n-        let snapshot = self.create_snapshot_for_diagnostic();\n+        let mut snapshot_pat = self.create_snapshot_for_diagnostic();\n+        let mut snapshot_type = self.create_snapshot_for_diagnostic();\n \n         // Create error for \"unexpected `:`\".\n         match self.expected_one_of_not_found(&[], &[]) {\n             Err(mut err) => {\n-                self.bump(); // Skip the `:`.\n-                match self.parse_pat_no_top_alt(expected) {\n+                // Skip the `:`.\n+                snapshot_pat.bump();\n+                snapshot_type.bump();\n+                match snapshot_pat.parse_pat_no_top_alt(expected) {\n                     Err(inner_err) => {\n-                        // Carry on as if we had not done anything, callers will emit a\n-                        // reasonable error.\n                         inner_err.cancel();\n-                        err.cancel();\n-                        self.restore_snapshot(snapshot);\n                     }\n                     Ok(mut pat) => {\n                         // We've parsed the rest of the pattern.\n@@ -2488,22 +2504,33 @@ impl<'a> Parser<'a> {\n                             _ => {}\n                         }\n                         if show_sugg {\n-                            err.span_suggestion(\n-                                span,\n+                            err.span_suggestion_verbose(\n+                                colon_span.until(self.look_ahead(1, |t| t.span)),\n                                 \"maybe write a path separator here\",\n                                 \"::\",\n                                 Applicability::MaybeIncorrect,\n                             );\n                         } else {\n                             first_pat = self.mk_pat(new_span, PatKind::Wild);\n                         }\n-                        err.emit();\n+                        self.restore_snapshot(snapshot_pat);\n                     }\n                 }\n+                match snapshot_type.parse_ty() {\n+                    Err(inner_err) => {\n+                        inner_err.cancel();\n+                    }\n+                    Ok(ty) => {\n+                        err.span_label(ty.span, \"specifying the type of a pattern isn't supported\");\n+                        self.restore_snapshot(snapshot_type);\n+                        let new_span = first_pat.span.to(ty.span);\n+                        first_pat = self.mk_pat(new_span, PatKind::Wild);\n+                    }\n+                }\n+                err.emit();\n             }\n             _ => {\n                 // Carry on as if we had not done anything. This should be unreachable.\n-                self.restore_snapshot(snapshot);\n             }\n         };\n         first_pat"}, {"sha": "e1ea38f2795df698983f335bbf6b77f13d29dad1", "filename": "tests/ui/parser/issues/issue-87086-colon-path-sep.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0ba687a95ee64a013b71ca7b606896e60c6182f0/tests%2Fui%2Fparser%2Fissues%2Fissue-87086-colon-path-sep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ba687a95ee64a013b71ca7b606896e60c6182f0/tests%2Fui%2Fparser%2Fissues%2Fissue-87086-colon-path-sep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Fissues%2Fissue-87086-colon-path-sep.rs?ref=0ba687a95ee64a013b71ca7b606896e60c6182f0", "patch": "@@ -68,7 +68,6 @@ fn main() {\n         Foo:Bar::Baz => {}\n         //~^ ERROR: expected one of\n         //~| HELP: maybe write a path separator here\n-        //~| ERROR: failed to resolve: `Bar` is a variant, not a module\n     }\n     match myfoo {\n         Foo::Bar => {}"}, {"sha": "63b072ac4cdc68c6c4f9ec8734f49945c45de38e", "filename": "tests/ui/parser/issues/issue-87086-colon-path-sep.stderr", "status": "modified", "additions": 55, "deletions": 26, "changes": 81, "blob_url": "https://github.com/rust-lang/rust/blob/0ba687a95ee64a013b71ca7b606896e60c6182f0/tests%2Fui%2Fparser%2Fissues%2Fissue-87086-colon-path-sep.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0ba687a95ee64a013b71ca7b606896e60c6182f0/tests%2Fui%2Fparser%2Fissues%2Fissue-87086-colon-path-sep.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Fissues%2Fissue-87086-colon-path-sep.stderr?ref=0ba687a95ee64a013b71ca7b606896e60c6182f0", "patch": "@@ -2,89 +2,118 @@ error: expected one of `@` or `|`, found `:`\n   --> $DIR/issue-87086-colon-path-sep.rs:17:12\n    |\n LL |         Foo:Bar => {}\n-   |            ^\n+   |            ^--- specifying the type of a pattern isn't supported\n    |            |\n    |            expected one of `@` or `|`\n-   |            help: maybe write a path separator here: `::`\n+   |\n+help: maybe write a path separator here\n+   |\n+LL |         Foo::Bar => {}\n+   |            ~~\n \n error: expected one of `!`, `(`, `...`, `..=`, `..`, `::`, `{`, or `|`, found `:`\n   --> $DIR/issue-87086-colon-path-sep.rs:23:17\n    |\n LL |         qux::Foo:Bar => {}\n-   |                 ^\n+   |                 ^--- specifying the type of a pattern isn't supported\n    |                 |\n    |                 expected one of 8 possible tokens\n-   |                 help: maybe write a path separator here: `::`\n+   |\n+help: maybe write a path separator here\n+   |\n+LL |         qux::Foo::Bar => {}\n+   |                 ~~\n \n error: expected one of `@` or `|`, found `:`\n   --> $DIR/issue-87086-colon-path-sep.rs:29:12\n    |\n LL |         qux:Foo::Baz => {}\n-   |            ^\n+   |            ^-------- specifying the type of a pattern isn't supported\n    |            |\n    |            expected one of `@` or `|`\n-   |            help: maybe write a path separator here: `::`\n+   |\n+help: maybe write a path separator here\n+   |\n+LL |         qux::Foo::Baz => {}\n+   |            ~~\n \n error: expected one of `@` or `|`, found `:`\n   --> $DIR/issue-87086-colon-path-sep.rs:35:12\n    |\n LL |         qux: Foo::Baz if true => {}\n-   |            ^\n+   |            ^ -------- specifying the type of a pattern isn't supported\n    |            |\n    |            expected one of `@` or `|`\n-   |            help: maybe write a path separator here: `::`\n+   |\n+help: maybe write a path separator here\n+   |\n+LL |         qux::Foo::Baz if true => {}\n+   |            ~~\n \n error: expected one of `@` or `|`, found `:`\n   --> $DIR/issue-87086-colon-path-sep.rs:40:15\n    |\n LL |     if let Foo:Bar = f() {\n-   |               ^\n+   |               ^--- specifying the type of a pattern isn't supported\n    |               |\n    |               expected one of `@` or `|`\n-   |               help: maybe write a path separator here: `::`\n+   |\n+help: maybe write a path separator here\n+   |\n+LL |     if let Foo::Bar = f() {\n+   |               ~~\n \n error: expected one of `@` or `|`, found `:`\n   --> $DIR/issue-87086-colon-path-sep.rs:48:16\n    |\n LL |         ref qux: Foo::Baz => {}\n-   |                ^\n+   |                ^ -------- specifying the type of a pattern isn't supported\n    |                |\n    |                expected one of `@` or `|`\n-   |                help: maybe write a path separator here: `::`\n+   |\n+help: maybe write a path separator here\n+   |\n+LL |         ref qux::Foo::Baz => {}\n+   |                ~~\n \n error: expected one of `@` or `|`, found `:`\n   --> $DIR/issue-87086-colon-path-sep.rs:57:16\n    |\n LL |         mut qux: Foo::Baz => {}\n-   |                ^\n+   |                ^ -------- specifying the type of a pattern isn't supported\n    |                |\n    |                expected one of `@` or `|`\n-   |                help: maybe write a path separator here: `::`\n+   |\n+help: maybe write a path separator here\n+   |\n+LL |         mut qux::Foo::Baz => {}\n+   |                ~~\n \n error: expected one of `@` or `|`, found `:`\n   --> $DIR/issue-87086-colon-path-sep.rs:68:12\n    |\n LL |         Foo:Bar::Baz => {}\n-   |            ^\n+   |            ^-------- specifying the type of a pattern isn't supported\n    |            |\n    |            expected one of `@` or `|`\n-   |            help: maybe write a path separator here: `::`\n+   |\n+help: maybe write a path separator here\n+   |\n+LL |         Foo::Bar::Baz => {}\n+   |            ~~\n \n error: expected one of `@` or `|`, found `:`\n-  --> $DIR/issue-87086-colon-path-sep.rs:75:12\n+  --> $DIR/issue-87086-colon-path-sep.rs:74:12\n    |\n LL |         Foo:Bar => {}\n-   |            ^\n+   |            ^--- specifying the type of a pattern isn't supported\n    |            |\n    |            expected one of `@` or `|`\n-   |            help: maybe write a path separator here: `::`\n-\n-error[E0433]: failed to resolve: `Bar` is a variant, not a module\n-  --> $DIR/issue-87086-colon-path-sep.rs:68:13\n    |\n-LL |         Foo:Bar::Baz => {}\n-   |             ^^^ `Bar` is a variant, not a module\n+help: maybe write a path separator here\n+   |\n+LL |         Foo::Bar => {}\n+   |            ~~\n \n-error: aborting due to 10 previous errors\n+error: aborting due to 9 previous errors\n \n-For more information about this error, try `rustc --explain E0433`."}, {"sha": "fec168afba1dde5484db1fc8e8817147a3c3189c", "filename": "tests/ui/parser/type-ascription-in-pattern.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/0ba687a95ee64a013b71ca7b606896e60c6182f0/tests%2Fui%2Fparser%2Ftype-ascription-in-pattern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ba687a95ee64a013b71ca7b606896e60c6182f0/tests%2Fui%2Fparser%2Ftype-ascription-in-pattern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Ftype-ascription-in-pattern.rs?ref=0ba687a95ee64a013b71ca7b606896e60c6182f0", "patch": "@@ -0,0 +1,16 @@\n+fn foo(x: bool) -> i32 {\n+    match x {\n+        x: i32 => x, //~ ERROR expected\n+        //~^ ERROR mismatched types\n+        true => 42.,\n+        false => 0.333,\n+    }\n+}\n+\n+fn main() {\n+    match foo(true) {\n+        42: i32 => (), //~ ERROR expected\n+        _: f64 => (), //~ ERROR expected\n+        x: i32 => (), //~ ERROR expected\n+    }\n+}"}, {"sha": "0919075499368fc6c6fa8b67a0ed960579593d12", "filename": "tests/ui/parser/type-ascription-in-pattern.stderr", "status": "added", "additions": 54, "deletions": 0, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/0ba687a95ee64a013b71ca7b606896e60c6182f0/tests%2Fui%2Fparser%2Ftype-ascription-in-pattern.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0ba687a95ee64a013b71ca7b606896e60c6182f0/tests%2Fui%2Fparser%2Ftype-ascription-in-pattern.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Ftype-ascription-in-pattern.stderr?ref=0ba687a95ee64a013b71ca7b606896e60c6182f0", "patch": "@@ -0,0 +1,54 @@\n+error: expected one of `@` or `|`, found `:`\n+  --> $DIR/type-ascription-in-pattern.rs:3:10\n+   |\n+LL |         x: i32 => x,\n+   |          ^ --- specifying the type of a pattern isn't supported\n+   |          |\n+   |          expected one of `@` or `|`\n+   |\n+help: maybe write a path separator here\n+   |\n+LL |         x::i32 => x,\n+   |          ~~\n+\n+error: expected one of `...`, `..=`, `..`, or `|`, found `:`\n+  --> $DIR/type-ascription-in-pattern.rs:12:11\n+   |\n+LL |         42: i32 => (),\n+   |           ^ --- specifying the type of a pattern isn't supported\n+   |           |\n+   |           expected one of `...`, `..=`, `..`, or `|`\n+\n+error: expected `|`, found `:`\n+  --> $DIR/type-ascription-in-pattern.rs:13:10\n+   |\n+LL |         _: f64 => (),\n+   |          ^ --- specifying the type of a pattern isn't supported\n+   |          |\n+   |          expected `|`\n+\n+error: expected one of `@` or `|`, found `:`\n+  --> $DIR/type-ascription-in-pattern.rs:14:10\n+   |\n+LL |         x: i32 => (),\n+   |          ^ --- specifying the type of a pattern isn't supported\n+   |          |\n+   |          expected one of `@` or `|`\n+   |\n+help: maybe write a path separator here\n+   |\n+LL |         x::i32 => (),\n+   |          ~~\n+\n+error[E0308]: mismatched types\n+  --> $DIR/type-ascription-in-pattern.rs:3:19\n+   |\n+LL | fn foo(x: bool) -> i32 {\n+   |                    --- expected `i32` because of return type\n+LL |     match x {\n+LL |         x: i32 => x,\n+   |                   ^ expected `i32`, found `bool`\n+\n+error: aborting due to 5 previous errors\n+\n+For more information about this error, try `rustc --explain E0308`."}]}