{"sha": "69035f20b92870a7ad5dbc22c65aee971d8f8698", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY5MDM1ZjIwYjkyODcwYTdhZDVkYmMyMmM2NWFlZTk3MWQ4Zjg2OTg=", "commit": {"author": {"name": "Austin Bonander", "email": "austin.bonander@gmail.com", "date": "2018-02-25T03:11:06Z"}, "committer": {"name": "Austin Bonander", "email": "austin.bonander@gmail.com", "date": "2018-03-08T00:52:28Z"}, "message": "check stability of macro invocations", "tree": {"sha": "a9cf77112ebc776b84824a270c8407b739b311d9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a9cf77112ebc776b84824a270c8407b739b311d9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/69035f20b92870a7ad5dbc22c65aee971d8f8698", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/69035f20b92870a7ad5dbc22c65aee971d8f8698", "html_url": "https://github.com/rust-lang/rust/commit/69035f20b92870a7ad5dbc22c65aee971d8f8698", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/69035f20b92870a7ad5dbc22c65aee971d8f8698/comments", "author": {"login": "abonander", "id": 3198595, "node_id": "MDQ6VXNlcjMxOTg1OTU=", "avatar_url": "https://avatars.githubusercontent.com/u/3198595?v=4", "gravatar_id": "", "url": "https://api.github.com/users/abonander", "html_url": "https://github.com/abonander", "followers_url": "https://api.github.com/users/abonander/followers", "following_url": "https://api.github.com/users/abonander/following{/other_user}", "gists_url": "https://api.github.com/users/abonander/gists{/gist_id}", "starred_url": "https://api.github.com/users/abonander/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/abonander/subscriptions", "organizations_url": "https://api.github.com/users/abonander/orgs", "repos_url": "https://api.github.com/users/abonander/repos", "events_url": "https://api.github.com/users/abonander/events{/privacy}", "received_events_url": "https://api.github.com/users/abonander/received_events", "type": "User", "site_admin": false}, "committer": {"login": "abonander", "id": 3198595, "node_id": "MDQ6VXNlcjMxOTg1OTU=", "avatar_url": "https://avatars.githubusercontent.com/u/3198595?v=4", "gravatar_id": "", "url": "https://api.github.com/users/abonander", "html_url": "https://github.com/abonander", "followers_url": "https://api.github.com/users/abonander/followers", "following_url": "https://api.github.com/users/abonander/following{/other_user}", "gists_url": "https://api.github.com/users/abonander/gists{/gist_id}", "starred_url": "https://api.github.com/users/abonander/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/abonander/subscriptions", "organizations_url": "https://api.github.com/users/abonander/orgs", "repos_url": "https://api.github.com/users/abonander/repos", "events_url": "https://api.github.com/users/abonander/events{/privacy}", "received_events_url": "https://api.github.com/users/abonander/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4a7206323b70f6b146e54ae41652efbb61112024", "url": "https://api.github.com/repos/rust-lang/rust/commits/4a7206323b70f6b146e54ae41652efbb61112024", "html_url": "https://github.com/rust-lang/rust/commit/4a7206323b70f6b146e54ae41652efbb61112024"}], "stats": {"total": 160, "additions": 141, "deletions": 19}, "files": [{"sha": "ebfd8785a0a0c8e0866fae9b2a979d11158cc09d", "filename": "src/librustc_plugin/registry.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Flibrustc_plugin%2Fregistry.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Flibrustc_plugin%2Fregistry.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_plugin%2Fregistry.rs?ref=69035f20b92870a7ad5dbc22c65aee971d8f8698", "patch": "@@ -106,14 +106,16 @@ impl<'a> Registry<'a> {\n                 expander,\n                 def_info: _,\n                 allow_internal_unstable,\n-                allow_internal_unsafe\n+                allow_internal_unsafe,\n+                unstable_feature\n             } => {\n                 let nid = ast::CRATE_NODE_ID;\n                 NormalTT {\n                     expander,\n                     def_info: Some((nid, self.krate_span)),\n                     allow_internal_unstable,\n-                    allow_internal_unsafe\n+                    allow_internal_unsafe,\n+                    unstable_feature\n                 }\n             }\n             IdentTT(ext, _, allow_internal_unstable) => {\n@@ -149,6 +151,7 @@ impl<'a> Registry<'a> {\n             def_info: None,\n             allow_internal_unstable: false,\n             allow_internal_unsafe: false,\n+            unstable_feature: None,\n         });\n     }\n "}, {"sha": "23c42972912a149ec22b563c04189f046bcb74e6", "filename": "src/libsyntax/ext/base.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Flibsyntax%2Fext%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Flibsyntax%2Fext%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbase.rs?ref=69035f20b92870a7ad5dbc22c65aee971d8f8698", "patch": "@@ -555,6 +555,8 @@ pub enum SyntaxExtension {\n         /// Whether the contents of the macro can use `unsafe`\n         /// without triggering the `unsafe_code` lint.\n         allow_internal_unsafe: bool,\n+        /// The macro's feature name if it is unstable, and the stability feature\n+        unstable_feature: Option<(Symbol, u32)>,\n     },\n \n     /// A function-like syntax extension that has an extra ident before\n@@ -670,6 +672,7 @@ pub struct ExpansionData {\n     pub depth: usize,\n     pub module: Rc<ModuleData>,\n     pub directory_ownership: DirectoryOwnership,\n+    pub crate_span: Option<Span>,\n }\n \n /// One of these is made during expansion and incrementally updated as we go;\n@@ -701,6 +704,7 @@ impl<'a> ExtCtxt<'a> {\n                 depth: 0,\n                 module: Rc::new(ModuleData { mod_path: Vec::new(), directory: PathBuf::new() }),\n                 directory_ownership: DirectoryOwnership::Owned { relative: None },\n+                crate_span: None,\n             },\n             expansions: HashMap::new(),\n         }"}, {"sha": "2cca37a3c939490e3980f748422bc7c272f85cdb", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 40, "deletions": 16, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=69035f20b92870a7ad5dbc22c65aee971d8f8698", "patch": "@@ -18,7 +18,7 @@ use ext::base::*;\n use ext::derive::{add_derived_markers, collect_derives};\n use ext::hygiene::{Mark, SyntaxContext};\n use ext::placeholders::{placeholder, PlaceholderExpander};\n-use feature_gate::{self, Features, is_builtin_attr};\n+use feature_gate::{self, Features, GateIssue, is_builtin_attr, emit_feature_err};\n use fold;\n use fold::*;\n use parse::{DirectoryOwnership, PResult};\n@@ -229,6 +229,7 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n         module.directory.pop();\n         self.cx.root_path = module.directory.clone();\n         self.cx.current_expansion.module = Rc::new(module);\n+        self.cx.current_expansion.crate_span = Some(krate.span);\n \n         let orig_mod_span = krate.module.inner;\n \n@@ -531,11 +532,36 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n         let path = &mac.node.path;\n \n         let ident = ident.unwrap_or_else(|| keywords::Invalid.ident());\n-        let validate_and_set_expn_info = |def_site_span,\n+        let validate_and_set_expn_info = |this: &mut Self, // arg instead of capture\n+                                          def_site_span: Option<Span>,\n                                           allow_internal_unstable,\n-                                          allow_internal_unsafe| {\n+                                          allow_internal_unsafe,\n+                                          // can't infer this type\n+                                          unstable_feature: Option<(Symbol, u32)>| {\n+\n+            // feature-gate the macro invocation\n+            if let Some((feature, issue)) = unstable_feature {\n+                let crate_span = this.cx.current_expansion.crate_span.unwrap();\n+                // don't stability-check macros in the same crate\n+                // (the only time this is null is for syntax extensions registered as macros)\n+                if def_site_span.map_or(false, |def_span| !crate_span.contains(def_span))\n+                    && !span.allows_unstable() && this.cx.ecfg.features.map_or(true, |feats| {\n+                    // macro features will count as lib features\n+                    !feats.declared_lib_features.iter().any(|&(feat, _)| feat == feature)\n+                }) {\n+                    let explain = format!(\"macro {}! is unstable\", path);\n+                    emit_feature_err(this.cx.parse_sess, &*feature.as_str(), span,\n+                                     GateIssue::Library(Some(issue)), &explain);\n+                    this.cx.trace_macros_diag();\n+                    return Err(kind.dummy(span));\n+                }\n+            }\n+\n             if ident.name != keywords::Invalid.name() {\n-                return Err(format!(\"macro {}! expects no ident argument, given '{}'\", path, ident));\n+                let msg = format!(\"macro {}! expects no ident argument, given '{}'\", path, ident);\n+                this.cx.span_err(path.span, &msg);\n+                this.cx.trace_macros_diag();\n+                return Err(kind.dummy(span));\n             }\n             mark.set_expn_info(ExpnInfo {\n                 call_site: span,\n@@ -551,11 +577,9 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n \n         let opt_expanded = match *ext {\n             DeclMacro(ref expand, def_span) => {\n-                if let Err(msg) = validate_and_set_expn_info(def_span.map(|(_, s)| s),\n-                                                             false, false) {\n-                    self.cx.span_err(path.span, &msg);\n-                    self.cx.trace_macros_diag();\n-                    kind.dummy(span)\n+                if let Err(dummy_span) = validate_and_set_expn_info(self, def_span.map(|(_, s)| s),\n+                                                                    false, false, None) {\n+                    dummy_span\n                 } else {\n                     kind.make_from(expand.expand(self.cx, span, mac.node.stream()))\n                 }\n@@ -565,14 +589,14 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n                 ref expander,\n                 def_info,\n                 allow_internal_unstable,\n-                allow_internal_unsafe\n+                allow_internal_unsafe,\n+                unstable_feature,\n             } => {\n-                if let Err(msg) = validate_and_set_expn_info(def_info.map(|(_, s)| s),\n-                                                             allow_internal_unstable,\n-                                                             allow_internal_unsafe) {\n-                    self.cx.span_err(path.span, &msg);\n-                    self.cx.trace_macros_diag();\n-                    kind.dummy(span)\n+                if let Err(dummy_span) = validate_and_set_expn_info(self, def_info.map(|(_, s)| s),\n+                                                                    allow_internal_unstable,\n+                                                                    allow_internal_unsafe,\n+                                                                    unstable_feature) {\n+                    dummy_span\n                 } else {\n                     kind.make_from(expander.expand(self.cx, span, mac.node.stream()))\n                 }"}, {"sha": "3b0d1d498994a54114a5f3e4d0582df3df49867d", "filename": "src/libsyntax/ext/tt/macro_rules.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_rules.rs?ref=69035f20b92870a7ad5dbc22c65aee971d8f8698", "patch": "@@ -284,11 +284,22 @@ pub fn compile(sess: &ParseSess, features: &RefCell<Features>, def: &ast::Item)\n     if body.legacy {\n         let allow_internal_unstable = attr::contains_name(&def.attrs, \"allow_internal_unstable\");\n         let allow_internal_unsafe = attr::contains_name(&def.attrs, \"allow_internal_unsafe\");\n+\n+        let unstable_feature = attr::find_stability(&sess.span_diagnostic,\n+                                                    &def.attrs, def.span).and_then(|stability| {\n+            if let attr::StabilityLevel::Unstable { issue, .. } = stability.level {\n+                Some((stability.feature, issue))\n+            } else {\n+                None\n+            }\n+        });\n+\n         NormalTT {\n             expander,\n             def_info: Some((def.id, def.span)),\n             allow_internal_unstable,\n-            allow_internal_unsafe\n+            allow_internal_unsafe,\n+            unstable_feature\n         }\n     } else {\n         SyntaxExtension::DeclMacro(expander, Some((def.id, def.span)))"}, {"sha": "5b078535852f48ec7869eddbd1555dc290b1611d", "filename": "src/libsyntax_ext/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Flibsyntax_ext%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Flibsyntax_ext%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Flib.rs?ref=69035f20b92870a7ad5dbc22c65aee971d8f8698", "patch": "@@ -67,6 +67,7 @@ pub fn register_builtins(resolver: &mut syntax::ext::base::Resolver,\n                         def_info: None,\n                         allow_internal_unstable: false,\n                         allow_internal_unsafe: false,\n+                        unstable_feature: None,\n                     });\n         )* }\n     }\n@@ -120,6 +121,7 @@ pub fn register_builtins(resolver: &mut syntax::ext::base::Resolver,\n                 def_info: None,\n                 allow_internal_unstable: true,\n                 allow_internal_unsafe: false,\n+                unstable_feature: None\n             });\n \n     for (name, ext) in user_exts {"}, {"sha": "6462c11af481fe659b6b4e93059a56706fb7e156", "filename": "src/test/compile-fail/auxiliary/unstable-macros.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Ftest%2Fcompile-fail%2Fauxiliary%2Funstable-macros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Ftest%2Fcompile-fail%2Fauxiliary%2Funstable-macros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fauxiliary%2Funstable-macros.rs?ref=69035f20b92870a7ad5dbc22c65aee971d8f8698", "patch": "@@ -0,0 +1,16 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(staged_api)]\n+#![stable(feature = \"unit_test\", since = \"0.0.0\")]\n+\n+#[unstable(feature = \"unstable_macros\", issue = \"0\")]\n+#[macro_export]\n+macro_rules! unstable_macro{ () => () }"}, {"sha": "a4b922c0fe19cf4000b422416cf7ef13d8322c7e", "filename": "src/test/compile-fail/macro-stability.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Ftest%2Fcompile-fail%2Fmacro-stability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Ftest%2Fcompile-fail%2Fmacro-stability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fmacro-stability.rs?ref=69035f20b92870a7ad5dbc22c65aee971d8f8698", "patch": "@@ -0,0 +1,22 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:unstable-macros.rs\n+\n+#![feature(staged_api)]\n+#[macro_use] extern crate unstable_macros;\n+\n+#[unstable(feature = \"local_unstable\", issue = \"0\")]\n+macro_rules! local_unstable { () => () }\n+\n+fn main() {\n+    local_unstable!();\n+    unstable_macro!(); //~ ERROR: macro unstable_macro! is unstable\n+}"}, {"sha": "231ed2898f1db6af7ebf332911343c57e5284fd3", "filename": "src/test/run-pass-fulldeps/auxiliary/plugin_args.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fplugin_args.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fplugin_args.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fplugin_args.rs?ref=69035f20b92870a7ad5dbc22c65aee971d8f8698", "patch": "@@ -53,5 +53,6 @@ pub fn plugin_registrar(reg: &mut Registry) {\n             def_info: None,\n             allow_internal_unstable: false,\n             allow_internal_unsafe: false,\n+            unstable_feature: None,\n         });\n }"}, {"sha": "6462c11af481fe659b6b4e93059a56706fb7e156", "filename": "src/test/run-pass/auxiliary/unstable-macros.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Ftest%2Frun-pass%2Fauxiliary%2Funstable-macros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Ftest%2Frun-pass%2Fauxiliary%2Funstable-macros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fauxiliary%2Funstable-macros.rs?ref=69035f20b92870a7ad5dbc22c65aee971d8f8698", "patch": "@@ -0,0 +1,16 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(staged_api)]\n+#![stable(feature = \"unit_test\", since = \"0.0.0\")]\n+\n+#[unstable(feature = \"unstable_macros\", issue = \"0\")]\n+#[macro_export]\n+macro_rules! unstable_macro{ () => () }"}, {"sha": "9afcd51aa85af16f7efe818ce47a5bae38749aa7", "filename": "src/test/run-pass/macro-stability.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Ftest%2Frun-pass%2Fmacro-stability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69035f20b92870a7ad5dbc22c65aee971d8f8698/src%2Ftest%2Frun-pass%2Fmacro-stability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fmacro-stability.rs?ref=69035f20b92870a7ad5dbc22c65aee971d8f8698", "patch": "@@ -0,0 +1,23 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:unstable-macros.rs\n+\n+#![feature(unstable_macros)]\n+\n+#[macro_use] extern crate unstable_macros;\n+\n+#[unstable(feature = \"local_unstable\", issue = \"0\")]\n+macro_rules! local_unstable { () => () }\n+\n+fn main() {\n+    unstable_macro!();\n+    local_unstable!();\n+}"}]}