{"sha": "58c996c3a768446a39d72265bac626bc0a89adee", "node_id": "C_kwDOAAsO6NoAKDU4Yzk5NmMzYTc2ODQ0NmEzOWQ3MjI2NWJhYzYyNmJjMGE4OWFkZWU", "commit": {"author": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2021-12-01T01:05:40Z"}, "committer": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2021-12-01T01:25:30Z"}, "message": "Move post-elaboration const-checking earlier in the pipeline\n\nInstead we run `RemoveFalseEdges` and `RemoveUninitDrops` at the\nappropriate time. The extra `SimplifyCfg` avoids visiting unreachable\nblocks during `RemoveUninitDrops`.", "tree": {"sha": "09f3224d8023aa990b7c578dbf29c74d8a63e04e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/09f3224d8023aa990b7c578dbf29c74d8a63e04e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/58c996c3a768446a39d72265bac626bc0a89adee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/58c996c3a768446a39d72265bac626bc0a89adee", "html_url": "https://github.com/rust-lang/rust/commit/58c996c3a768446a39d72265bac626bc0a89adee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/58c996c3a768446a39d72265bac626bc0a89adee/comments", "author": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3e0e8be037f79a8d2da521e75e52795727474beb", "url": "https://api.github.com/repos/rust-lang/rust/commits/3e0e8be037f79a8d2da521e75e52795727474beb", "html_url": "https://github.com/rust-lang/rust/commit/3e0e8be037f79a8d2da521e75e52795727474beb"}], "stats": {"total": 16, "additions": 14, "deletions": 2}, "files": [{"sha": "d15ee3e32b785844db2802dc684cc354a1121083", "filename": "compiler/rustc_mir_transform/src/lib.rs", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/58c996c3a768446a39d72265bac626bc0a89adee/compiler%2Frustc_mir_transform%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/58c996c3a768446a39d72265bac626bc0a89adee/compiler%2Frustc_mir_transform%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Flib.rs?ref=58c996c3a768446a39d72265bac626bc0a89adee", "patch": "@@ -77,7 +77,7 @@ mod simplify_try;\n mod uninhabited_enum_branching;\n mod unreachable_prop;\n \n-use rustc_const_eval::transform::check_consts;\n+use rustc_const_eval::transform::check_consts::{self, ConstCx};\n use rustc_const_eval::transform::promote_consts;\n use rustc_const_eval::transform::validate;\n pub use rustc_const_eval::transform::MirPass;\n@@ -447,8 +447,20 @@ fn mir_drops_elaborated_and_const_checked<'tcx>(\n     let (body, _) = tcx.mir_promoted(def);\n     let mut body = body.steal();\n \n+    // IMPORTANT\n+    remove_false_edges::RemoveFalseEdges.run_pass(tcx, &mut body);\n+\n+    // Do a little drop elaboration before const-checking if `const_precise_live_drops` is enabled.\n+    //\n+    // FIXME: Can't use `run_passes` for these, since `run_passes` SILENTLY DOES NOTHING IF THE MIR\n+    // PHASE DOESN'T CHANGE.\n+    if check_consts::post_drop_elaboration::checking_enabled(&ConstCx::new(tcx, &body)) {\n+        simplify::SimplifyCfg::new(\"remove-false-edges\").run_pass(tcx, &mut body);\n+        remove_uninit_drops::RemoveUninitDrops.run_pass(tcx, &mut body);\n+        check_consts::post_drop_elaboration::check_live_drops(tcx, &body);\n+    }\n+\n     run_post_borrowck_cleanup_passes(tcx, &mut body);\n-    check_consts::post_drop_elaboration::check_live_drops(tcx, &body);\n     tcx.alloc_steal_mir(body)\n }\n "}]}