{"sha": "8272d2a18dff6de74a687884fb357490ee29450c", "node_id": "C_kwDOAAsO6NoAKDgyNzJkMmExOGRmZjZkZTc0YTY4Nzg4NGZiMzU3NDkwZWUyOTQ1MGM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-22T22:18:05Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-22T22:18:05Z"}, "message": "Auto merge of #12847 - Veykril:vscode-downgrade, r=Veykril\n\nfix: Fix restart server duplicating language clients\n\nReverts 03a62c180e6a7300d0d7b8c4d680b749c101bcbb\nvscode-languageclient@8.0.0-next.15 and beyond changed the behaviour of language clients to be automatically started if a request comes in while they are not running. Currently when we restart the server via the restart command we recreate the language client, which causes VSCode to restart the stopped server, effectively duplicating our language clients...\n\nReverting the commit is simpler right now, the proper fix would be to only create a language client once and then use the `restart` functionality on it instead.\n\nFixes https://github.com/rust-lang/rust-analyzer/issues/12836", "tree": {"sha": "8703262f63dea70244cdaccdf73832b917318ef8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8703262f63dea70244cdaccdf73832b917318ef8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8272d2a18dff6de74a687884fb357490ee29450c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8272d2a18dff6de74a687884fb357490ee29450c", "html_url": "https://github.com/rust-lang/rust/commit/8272d2a18dff6de74a687884fb357490ee29450c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8272d2a18dff6de74a687884fb357490ee29450c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d469e0de9acc38b2e63796fb105369e567773cfb", "url": "https://api.github.com/repos/rust-lang/rust/commits/d469e0de9acc38b2e63796fb105369e567773cfb", "html_url": "https://github.com/rust-lang/rust/commit/d469e0de9acc38b2e63796fb105369e567773cfb"}, {"sha": "f1b5e3856317a38db996fe3e01b119aa0f2c3144", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1b5e3856317a38db996fe3e01b119aa0f2c3144", "html_url": "https://github.com/rust-lang/rust/commit/f1b5e3856317a38db996fe3e01b119aa0f2c3144"}], "stats": {"total": 4013, "additions": 30, "deletions": 3983}, "files": [{"sha": "0436681b1a0a90fb3416949e9be6904ad2feb09a", "filename": "editors/code/package-lock.json", "status": "modified", "additions": 27, "deletions": 3977, "changes": 4004, "blob_url": "https://github.com/rust-lang/rust/blob/8272d2a18dff6de74a687884fb357490ee29450c/editors%2Fcode%2Fpackage-lock.json", "raw_url": "https://github.com/rust-lang/rust/raw/8272d2a18dff6de74a687884fb357490ee29450c/editors%2Fcode%2Fpackage-lock.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage-lock.json?ref=8272d2a18dff6de74a687884fb357490ee29450c"}, {"sha": "a13798d8b36c90e4afe7618c3b24e772263d9bc9", "filename": "editors/code/package.json", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8272d2a18dff6de74a687884fb357490ee29450c/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/8272d2a18dff6de74a687884fb357490ee29450c/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=8272d2a18dff6de74a687884fb357490ee29450c", "patch": "@@ -37,7 +37,7 @@\n     \"dependencies\": {\n         \"d3\": \"^7.6.1\",\n         \"d3-graphviz\": \"^4.1.1\",\n-        \"vscode-languageclient\": \"^8.0.1\"\n+        \"vscode-languageclient\": \"^8.0.0-next.14\"\n     },\n     \"devDependencies\": {\n         \"@types/node\": \"~16.11.7\","}, {"sha": "8a2dea6b35b76a5760508399b670630ed277958a", "filename": "editors/code/src/client.ts", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8272d2a18dff6de74a687884fb357490ee29450c/editors%2Fcode%2Fsrc%2Fclient.ts", "raw_url": "https://github.com/rust-lang/rust/raw/8272d2a18dff6de74a687884fb357490ee29450c/editors%2Fcode%2Fsrc%2Fclient.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fclient.ts?ref=8272d2a18dff6de74a687884fb357490ee29450c", "patch": "@@ -261,10 +261,6 @@ export async function createClient(\n }\n \n class ExperimentalFeatures implements lc.StaticFeature {\n-    getState(): lc.FeatureState {\n-        return { kind: \"static\" };\n-    }\n-\n     fillClientCapabilities(capabilities: lc.ClientCapabilities): void {\n         const caps: any = capabilities.experimental ?? {};\n         caps.snippetTextEdit = true;"}, {"sha": "0dea1b87b2f7017ee94219ce0ff801ee0c0e03ca", "filename": "editors/code/src/ctx.ts", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/8272d2a18dff6de74a687884fb357490ee29450c/editors%2Fcode%2Fsrc%2Fctx.ts", "raw_url": "https://github.com/rust-lang/rust/raw/8272d2a18dff6de74a687884fb357490ee29450c/editors%2Fcode%2Fsrc%2Fctx.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fctx.ts?ref=8272d2a18dff6de74a687884fb357490ee29450c", "patch": "@@ -42,7 +42,8 @@ export class Ctx {\n \n         const res = new Ctx(config, extCtx, client, serverPath, statusBar);\n \n-        await client.start();\n+        res.pushCleanup(client.start());\n+        await client.onReady();\n         client.onNotification(ra.serverStatus, (params) => res.setServerStatus(params));\n         return res;\n     }"}]}