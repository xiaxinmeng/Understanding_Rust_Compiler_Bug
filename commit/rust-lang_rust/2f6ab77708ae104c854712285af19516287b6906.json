{"sha": "2f6ab77708ae104c854712285af19516287b6906", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJmNmFiNzc3MDhhZTEwNGM4NTQ3MTIyODVhZjE5NTE2Mjg3YjY5MDY=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-06-02T20:44:56Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-02T20:44:56Z"}, "message": "Merge #4710\n\n4710: New runnables r=matklad a=matklad\n\nbors d=@vsrs\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "7e86855582629a88f7002f01bbc67bf41b0513bf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7e86855582629a88f7002f01bbc67bf41b0513bf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2f6ab77708ae104c854712285af19516287b6906", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe1rpICRBK7hj4Ov3rIwAAdHIIAIeU0HTouKxPyulwGtPo0OnB\nEPVYgAVq38sV9x0pNHm4K5PF8JUGWpohjFnsPn0ZeIfwkgZ6Dr8vEuadM7bI32h3\n4pypFKp2t8VEdXj42mBfE5tZIh06sCohZ0QkKcnPkkevcyr8nmxcZNiwZGM67fH7\nCgev5q+nZE1KMkGYcbDcU/bQGXe1wEKMqkGOymmOC4Blf3AV8HbDZAYVNk90z2sa\nq6K31I4oWOLlGooA4OaF9HJb0Y/zXOPwQTH2ldIy4wT85y6lRTS0GhWMBGTU90W8\nu6IaMzaST5Qi24lbXCU+/+lnisJxiTmlu0zc3WpTLH3iQ+QWW7cgr0qXEXuA/Ic=\n=fneT\n-----END PGP SIGNATURE-----\n", "payload": "tree 7e86855582629a88f7002f01bbc67bf41b0513bf\nparent 0035dafbfa563921e2cfe41f5592fc37bff92294\nparent bc3db7c1ded0db2d3804b5ac3e5c35dd53350228\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1591130696 +0000\ncommitter GitHub <noreply@github.com> 1591130696 +0000\n\nMerge #4710\n\n4710: New runnables r=matklad a=matklad\n\nbors d=@vsrs\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2f6ab77708ae104c854712285af19516287b6906", "html_url": "https://github.com/rust-lang/rust/commit/2f6ab77708ae104c854712285af19516287b6906", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2f6ab77708ae104c854712285af19516287b6906/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0035dafbfa563921e2cfe41f5592fc37bff92294", "url": "https://api.github.com/repos/rust-lang/rust/commits/0035dafbfa563921e2cfe41f5592fc37bff92294", "html_url": "https://github.com/rust-lang/rust/commit/0035dafbfa563921e2cfe41f5592fc37bff92294"}, {"sha": "bc3db7c1ded0db2d3804b5ac3e5c35dd53350228", "url": "https://api.github.com/repos/rust-lang/rust/commits/bc3db7c1ded0db2d3804b5ac3e5c35dd53350228", "html_url": "https://github.com/rust-lang/rust/commit/bc3db7c1ded0db2d3804b5ac3e5c35dd53350228"}], "stats": {"total": 652, "additions": 427, "deletions": 225}, "files": [{"sha": "c7bb1e69f8a575765da2aeb9b82d7dbb25904577", "filename": "crates/ra_ide/src/display/navigation_target.rs", "status": "modified", "additions": 23, "deletions": 43, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/2f6ab77708ae104c854712285af19516287b6906/crates%2Fra_ide%2Fsrc%2Fdisplay%2Fnavigation_target.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f6ab77708ae104c854712285af19516287b6906/crates%2Fra_ide%2Fsrc%2Fdisplay%2Fnavigation_target.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fdisplay%2Fnavigation_target.rs?ref=2f6ab77708ae104c854712285af19516287b6906", "patch": "@@ -92,15 +92,16 @@ impl NavigationTarget {\n         let name = module.name(db).map(|it| it.to_string().into()).unwrap_or_default();\n         if let Some(src) = module.declaration_source(db) {\n             let frange = original_range(db, src.as_ref().map(|it| it.syntax()));\n-            return NavigationTarget::from_syntax(\n+            let mut res = NavigationTarget::from_syntax(\n                 frange.file_id,\n                 name,\n                 None,\n                 frange.range,\n                 src.value.syntax().kind(),\n-                src.value.doc_comment_text(),\n-                src.value.short_label(),\n             );\n+            res.docs = src.value.doc_comment_text();\n+            res.description = src.value.short_label();\n+            return res;\n         }\n         module.to_nav(db)\n     }\n@@ -130,11 +131,9 @@ impl NavigationTarget {\n     }\n \n     /// Allows `NavigationTarget` to be created from a `NameOwner`\n-    fn from_named(\n+    pub(crate) fn from_named(\n         db: &RootDatabase,\n         node: InFile<&dyn ast::NameOwner>,\n-        docs: Option<String>,\n-        description: Option<String>,\n     ) -> NavigationTarget {\n         //FIXME: use `_` instead of empty string\n         let name = node.value.name().map(|it| it.text().clone()).unwrap_or_default();\n@@ -148,8 +147,6 @@ impl NavigationTarget {\n             focus_range,\n             frange.range,\n             node.value.syntax().kind(),\n-            docs,\n-            description,\n         )\n     }\n \n@@ -159,8 +156,6 @@ impl NavigationTarget {\n         focus_range: Option<TextRange>,\n         full_range: TextRange,\n         kind: SyntaxKind,\n-        docs: Option<String>,\n-        description: Option<String>,\n     ) -> NavigationTarget {\n         NavigationTarget {\n             file_id,\n@@ -169,8 +164,8 @@ impl NavigationTarget {\n             full_range,\n             focus_range,\n             container_name: None,\n-            description,\n-            docs,\n+            description: None,\n+            docs: None,\n         }\n     }\n }\n@@ -238,12 +233,11 @@ where\n {\n     fn to_nav(&self, db: &RootDatabase) -> NavigationTarget {\n         let src = self.source(db);\n-        NavigationTarget::from_named(\n-            db,\n-            src.as_ref().map(|it| it as &dyn ast::NameOwner),\n-            src.value.doc_comment_text(),\n-            src.value.short_label(),\n-        )\n+        let mut res =\n+            NavigationTarget::from_named(db, src.as_ref().map(|it| it as &dyn ast::NameOwner));\n+        res.docs = src.value.doc_comment_text();\n+        res.description = src.value.short_label();\n+        res\n     }\n }\n \n@@ -258,15 +252,7 @@ impl ToNav for hir::Module {\n             }\n         };\n         let frange = original_range(db, src.with_value(syntax));\n-        NavigationTarget::from_syntax(\n-            frange.file_id,\n-            name,\n-            focus,\n-            frange.range,\n-            syntax.kind(),\n-            None,\n-            None,\n-        )\n+        NavigationTarget::from_syntax(frange.file_id, name, focus, frange.range, syntax.kind())\n     }\n }\n \n@@ -285,8 +271,6 @@ impl ToNav for hir::ImplDef {\n             None,\n             frange.range,\n             src.value.syntax().kind(),\n-            None,\n-            None,\n         )\n     }\n }\n@@ -296,12 +280,12 @@ impl ToNav for hir::Field {\n         let src = self.source(db);\n \n         match &src.value {\n-            FieldSource::Named(it) => NavigationTarget::from_named(\n-                db,\n-                src.with_value(it),\n-                it.doc_comment_text(),\n-                it.short_label(),\n-            ),\n+            FieldSource::Named(it) => {\n+                let mut res = NavigationTarget::from_named(db, src.with_value(it));\n+                res.docs = it.doc_comment_text();\n+                res.description = it.short_label();\n+                res\n+            }\n             FieldSource::Pos(it) => {\n                 let frange = original_range(db, src.with_value(it.syntax()));\n                 NavigationTarget::from_syntax(\n@@ -310,8 +294,6 @@ impl ToNav for hir::Field {\n                     None,\n                     frange.range,\n                     it.syntax().kind(),\n-                    None,\n-                    None,\n                 )\n             }\n         }\n@@ -322,12 +304,10 @@ impl ToNav for hir::MacroDef {\n     fn to_nav(&self, db: &RootDatabase) -> NavigationTarget {\n         let src = self.source(db);\n         log::debug!(\"nav target {:#?}\", src.value.syntax());\n-        NavigationTarget::from_named(\n-            db,\n-            src.as_ref().map(|it| it as &dyn ast::NameOwner),\n-            src.value.doc_comment_text(),\n-            None,\n-        )\n+        let mut res =\n+            NavigationTarget::from_named(db, src.as_ref().map(|it| it as &dyn ast::NameOwner));\n+        res.docs = src.value.doc_comment_text();\n+        res\n     }\n }\n "}, {"sha": "f32ce0d229b84247246fa46f103604f771f4fc2e", "filename": "crates/ra_ide/src/runnables.rs", "status": "modified", "additions": 223, "deletions": 27, "changes": 250, "blob_url": "https://github.com/rust-lang/rust/blob/2f6ab77708ae104c854712285af19516287b6906/crates%2Fra_ide%2Fsrc%2Frunnables.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f6ab77708ae104c854712285af19516287b6906/crates%2Fra_ide%2Fsrc%2Frunnables.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Frunnables.rs?ref=2f6ab77708ae104c854712285af19516287b6906", "patch": "@@ -1,19 +1,19 @@\n+use std::fmt;\n+\n use hir::{AsAssocItem, Attrs, HirFileId, InFile, Semantics};\n use itertools::Itertools;\n+use ra_cfg::CfgExpr;\n use ra_ide_db::RootDatabase;\n use ra_syntax::{\n-    ast::{self, AstNode, AttrsOwner, ModuleItemOwner, NameOwner},\n-    match_ast, SyntaxNode, TextRange,\n+    ast::{self, AstNode, AttrsOwner, DocCommentsOwner, ModuleItemOwner, NameOwner},\n+    match_ast, SyntaxNode,\n };\n \n-use crate::FileId;\n-use ast::DocCommentsOwner;\n-use ra_cfg::CfgExpr;\n-use std::fmt::Display;\n+use crate::{display::ToNav, FileId, NavigationTarget};\n \n #[derive(Debug)]\n pub struct Runnable {\n-    pub range: TextRange,\n+    pub nav: NavigationTarget,\n     pub kind: RunnableKind,\n     pub cfg_exprs: Vec<CfgExpr>,\n }\n@@ -24,8 +24,8 @@ pub enum TestId {\n     Path(String),\n }\n \n-impl Display for TestId {\n-    fn fmt(&self, f: &mut std::fmt::Formatter) -> std::fmt::Result {\n+impl fmt::Display for TestId {\n+    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n         match self {\n             TestId::Name(name) => write!(f, \"{}\", name),\n             TestId::Path(path) => write!(f, \"{}\", path),\n@@ -131,7 +131,8 @@ fn runnable_fn(\n     let cfg_exprs =\n         attrs.by_key(\"cfg\").tt_values().map(|subtree| ra_cfg::parse_cfg(subtree)).collect();\n \n-    Some(Runnable { range: fn_def.syntax().text_range(), kind, cfg_exprs })\n+    let nav = NavigationTarget::from_named(sema.db, InFile::new(file_id.into(), &fn_def));\n+    Some(Runnable { nav, kind, cfg_exprs })\n }\n \n #[derive(Debug)]\n@@ -183,7 +184,6 @@ fn runnable_mod(\n     if !has_test_function {\n         return None;\n     }\n-    let range = module.syntax().text_range();\n     let module_def = sema.to_def(&module)?;\n \n     let path = module_def\n@@ -197,7 +197,8 @@ fn runnable_mod(\n     let cfg_exprs =\n         attrs.by_key(\"cfg\").tt_values().map(|subtree| ra_cfg::parse_cfg(subtree)).collect();\n \n-    Some(Runnable { range, kind: RunnableKind::TestMod { path }, cfg_exprs })\n+    let nav = module_def.to_nav(sema.db);\n+    Some(Runnable { nav, kind: RunnableKind::TestMod { path }, cfg_exprs })\n }\n \n #[cfg(test)]\n@@ -227,12 +228,38 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 1..21,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 1..21,\n+                    name: \"main\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        12..16,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Bin,\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 22..46,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 22..46,\n+                    name: \"test_foo\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        33..41,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"test_foo\",\n@@ -244,7 +271,20 @@ mod tests {\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 47..81,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 47..81,\n+                    name: \"test_foo\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        68..76,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"test_foo\",\n@@ -279,12 +319,38 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 1..21,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 1..21,\n+                    name: \"main\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        12..16,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Bin,\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 22..64,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 22..64,\n+                    name: \"foo\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        56..59,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: DocTest {\n                     test_id: Path(\n                         \"foo\",\n@@ -319,12 +385,38 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 1..21,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 1..21,\n+                    name: \"main\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        12..16,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Bin,\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 51..105,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 51..105,\n+                    name: \"foo\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        97..100,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: DocTest {\n                     test_id: Path(\n                         \"Data::foo\",\n@@ -354,14 +446,40 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 1..59,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 1..59,\n+                    name: \"test_mod\",\n+                    kind: MODULE,\n+                    focus_range: Some(\n+                        13..21,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: TestMod {\n                     path: \"test_mod\",\n                 },\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 28..57,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 28..57,\n+                    name: \"test_foo1\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        43..52,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"test_mod::test_foo1\",\n@@ -396,14 +514,40 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 23..85,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 23..85,\n+                    name: \"test_mod\",\n+                    kind: MODULE,\n+                    focus_range: Some(\n+                        27..35,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: TestMod {\n                     path: \"foo::test_mod\",\n                 },\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 46..79,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 46..79,\n+                    name: \"test_foo1\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        65..74,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"foo::test_mod::test_foo1\",\n@@ -440,14 +584,40 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 41..115,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 41..115,\n+                    name: \"test_mod\",\n+                    kind: MODULE,\n+                    focus_range: Some(\n+                        45..53,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: TestMod {\n                     path: \"foo::bar::test_mod\",\n                 },\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 68..105,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 68..105,\n+                    name: \"test_foo1\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        91..100,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"foo::bar::test_mod::test_foo1\",\n@@ -479,7 +649,20 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 1..58,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 1..58,\n+                    name: \"test_foo1\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        44..53,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"test_foo1\",\n@@ -516,7 +699,20 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 1..80,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 1..80,\n+                    name: \"test_foo1\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        66..75,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"test_foo1\","}, {"sha": "673795e781e679dc675284b1f552ce4663fdd0e3", "filename": "crates/rust-analyzer/src/caps.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/2f6ab77708ae104c854712285af19516287b6906/crates%2Frust-analyzer%2Fsrc%2Fcaps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f6ab77708ae104c854712285af19516287b6906/crates%2Frust-analyzer%2Fsrc%2Fcaps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcaps.rs?ref=2f6ab77708ae104c854712285af19516287b6906", "patch": "@@ -87,6 +87,9 @@ pub fn server_capabilities(client_caps: &ClientCapabilities) -> ServerCapabiliti\n             \"ssr\": true,\n             \"onEnter\": true,\n             \"parentModule\": true,\n+            \"runnables\": {\n+                \"kinds\": [ \"cargo\" ],\n+            },\n         })),\n     }\n }"}, {"sha": "ec24ce5e0f5f0009ad128fb6f57c32d823556130", "filename": "crates/rust-analyzer/src/lsp_ext.rs", "status": "modified", "additions": 18, "deletions": 13, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/2f6ab77708ae104c854712285af19516287b6906/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f6ab77708ae104c854712285af19516287b6906/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs?ref=2f6ab77708ae104c854712285af19516287b6906", "patch": "@@ -4,7 +4,6 @@ use std::{collections::HashMap, path::PathBuf};\n \n use lsp_types::request::Request;\n use lsp_types::{Position, Range, TextDocumentIdentifier};\n-use rustc_hash::FxHashMap;\n use serde::{Deserialize, Serialize};\n \n pub enum AnalyzerStatus {}\n@@ -111,7 +110,7 @@ pub enum Runnables {}\n impl Request for Runnables {\n     type Params = RunnablesParams;\n     type Result = Vec<Runnable>;\n-    const METHOD: &'static str = \"rust-analyzer/runnables\";\n+    const METHOD: &'static str = \"experimental/runnables\";\n }\n \n #[derive(Serialize, Deserialize, Debug)]\n@@ -121,25 +120,31 @@ pub struct RunnablesParams {\n     pub position: Option<Position>,\n }\n \n-// Must strictly correspond to the executable name\n+#[derive(Deserialize, Serialize, Debug)]\n+#[serde(rename_all = \"camelCase\")]\n+pub struct Runnable {\n+    pub label: String,\n+    #[serde(skip_serializing_if = \"Option::is_none\")]\n+    pub location: Option<lsp_types::LocationLink>,\n+    pub kind: RunnableKind,\n+    pub args: CargoRunnable,\n+}\n+\n #[derive(Serialize, Deserialize, Debug)]\n #[serde(rename_all = \"lowercase\")]\n pub enum RunnableKind {\n     Cargo,\n-    Rustc,\n-    Rustup,\n }\n \n #[derive(Deserialize, Serialize, Debug)]\n #[serde(rename_all = \"camelCase\")]\n-pub struct Runnable {\n-    pub range: Range,\n-    pub label: String,\n-    pub kind: RunnableKind,\n-    pub args: Vec<String>,\n-    pub extra_args: Vec<String>,\n-    pub env: FxHashMap<String, String>,\n-    pub cwd: Option<PathBuf>,\n+pub struct CargoRunnable {\n+    #[serde(skip_serializing_if = \"Option::is_none\")]\n+    pub workspace_root: Option<PathBuf>,\n+    // command, --package and --lib stuff\n+    pub cargo_args: Vec<String>,\n+    // stuff after --\n+    pub executable_args: Vec<String>,\n }\n \n pub enum InlayHints {}"}, {"sha": "7fd6917649a3eeeb5a069dc3f0f83a61bc9cd5be", "filename": "crates/rust-analyzer/src/main_loop/handlers.rs", "status": "modified", "additions": 21, "deletions": 20, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/2f6ab77708ae104c854712285af19516287b6906/crates%2Frust-analyzer%2Fsrc%2Fmain_loop%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f6ab77708ae104c854712285af19516287b6906/crates%2Frust-analyzer%2Fsrc%2Fmain_loop%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop%2Fhandlers.rs?ref=2f6ab77708ae104c854712285af19516287b6906", "patch": "@@ -23,7 +23,6 @@ use ra_ide::{\n use ra_prof::profile;\n use ra_project_model::TargetKind;\n use ra_syntax::{AstNode, SyntaxKind, TextRange, TextSize};\n-use rustc_hash::FxHashMap;\n use serde::{Deserialize, Serialize};\n use serde_json::to_value;\n use stdx::format_to;\n@@ -401,7 +400,7 @@ pub fn handle_runnables(\n     let cargo_spec = CargoTargetSpec::for_file(&world, file_id)?;\n     for runnable in world.analysis().runnables(file_id)? {\n         if let Some(offset) = offset {\n-            if !runnable.range.contains_inclusive(offset) {\n+            if !runnable.nav.full_range().contains_inclusive(offset) {\n                 continue;\n             }\n         }\n@@ -422,25 +421,31 @@ pub fn handle_runnables(\n         Some(spec) => {\n             for &cmd in [\"check\", \"test\"].iter() {\n                 res.push(lsp_ext::Runnable {\n-                    range: Default::default(),\n                     label: format!(\"cargo {} -p {}\", cmd, spec.package),\n+                    location: None,\n                     kind: lsp_ext::RunnableKind::Cargo,\n-                    args: vec![cmd.to_string(), \"--package\".to_string(), spec.package.clone()],\n-                    extra_args: Vec::new(),\n-                    env: FxHashMap::default(),\n-                    cwd: workspace_root.map(|root| root.to_owned()),\n+                    args: lsp_ext::CargoRunnable {\n+                        workspace_root: workspace_root.map(|root| root.to_owned()),\n+                        cargo_args: vec![\n+                            cmd.to_string(),\n+                            \"--package\".to_string(),\n+                            spec.package.clone(),\n+                        ],\n+                        executable_args: Vec::new(),\n+                    },\n                 })\n             }\n         }\n         None => {\n             res.push(lsp_ext::Runnable {\n-                range: Default::default(),\n                 label: \"cargo check --workspace\".to_string(),\n+                location: None,\n                 kind: lsp_ext::RunnableKind::Cargo,\n-                args: vec![\"check\".to_string(), \"--workspace\".to_string()],\n-                extra_args: Vec::new(),\n-                env: FxHashMap::default(),\n-                cwd: workspace_root.map(|root| root.to_owned()),\n+                args: lsp_ext::CargoRunnable {\n+                    workspace_root: workspace_root.map(|root| root.to_owned()),\n+                    cargo_args: vec![\"check\".to_string(), \"--workspace\".to_string()],\n+                    executable_args: Vec::new(),\n+                },\n             });\n         }\n     }\n@@ -782,10 +787,11 @@ pub fn handle_code_lens(\n                 }\n             };\n \n-            let mut r = to_proto::runnable(&world, file_id, runnable)?;\n+            let range = to_proto::range(&line_index, runnable.nav.range());\n+            let r = to_proto::runnable(&world, file_id, runnable)?;\n             if world.config.lens.run {\n                 let lens = CodeLens {\n-                    range: r.range,\n+                    range,\n                     command: Some(Command {\n                         title: run_title.to_string(),\n                         command: \"rust-analyzer.runSingle\".into(),\n@@ -797,13 +803,8 @@ pub fn handle_code_lens(\n             }\n \n             if debugee && world.config.lens.debug {\n-                if r.args[0] == \"run\" {\n-                    r.args[0] = \"build\".into();\n-                } else {\n-                    r.args.push(\"--no-run\".into());\n-                }\n                 let debug_lens = CodeLens {\n-                    range: r.range,\n+                    range,\n                     command: Some(Command {\n                         title: \"Debug\".into(),\n                         command: \"rust-analyzer.debugSingle\".into(),"}, {"sha": "85304aa8778e11c0b54f09abf56bf0f02859b9ab", "filename": "crates/rust-analyzer/src/to_proto.rs", "status": "modified", "additions": 7, "deletions": 11, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/2f6ab77708ae104c854712285af19516287b6906/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f6ab77708ae104c854712285af19516287b6906/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs?ref=2f6ab77708ae104c854712285af19516287b6906", "patch": "@@ -8,7 +8,6 @@ use ra_ide::{\n };\n use ra_syntax::{SyntaxKind, TextRange, TextSize};\n use ra_vfs::LineEndings;\n-use rustc_hash::FxHashMap;\n \n use crate::{\n     cargo_target_spec::CargoTargetSpec, lsp_ext, semantic_tokens, world::WorldSnapshot, Result,\n@@ -638,9 +637,8 @@ pub(crate) fn runnable(\n ) -> Result<lsp_ext::Runnable> {\n     let spec = CargoTargetSpec::for_file(world, file_id)?;\n     let target = spec.as_ref().map(|s| s.target.clone());\n-    let (args, extra_args) =\n+    let (cargo_args, executable_args) =\n         CargoTargetSpec::runnable_args(spec, &runnable.kind, &runnable.cfg_exprs)?;\n-    let line_index = world.analysis().file_line_index(file_id)?;\n     let label = match &runnable.kind {\n         RunnableKind::Test { test_id, .. } => format!(\"test {}\", test_id),\n         RunnableKind::TestMod { path } => format!(\"test-mod {}\", path),\n@@ -650,18 +648,16 @@ pub(crate) fn runnable(\n             target.map_or_else(|| \"run binary\".to_string(), |t| format!(\"run {}\", t))\n         }\n     };\n+    let location = location_link(world, None, runnable.nav)?;\n \n     Ok(lsp_ext::Runnable {\n-        range: range(&line_index, runnable.range),\n         label,\n+        location: Some(location),\n         kind: lsp_ext::RunnableKind::Cargo,\n-        args,\n-        extra_args,\n-        env: {\n-            let mut m = FxHashMap::default();\n-            m.insert(\"RUST_BACKTRACE\".to_string(), \"short\".to_string());\n-            m\n+        args: lsp_ext::CargoRunnable {\n+            workspace_root: world.workspace_root_for(file_id).map(|root| root.to_owned()),\n+            cargo_args,\n+            executable_args,\n         },\n-        cwd: world.workspace_root_for(file_id).map(|root| root.to_owned()),\n     })\n }"}, {"sha": "e18f973b824ca6a64c98ef014f2df6791c829a55", "filename": "crates/rust-analyzer/tests/heavy_tests/main.rs", "status": "modified", "additions": 59, "deletions": 54, "changes": 113, "blob_url": "https://github.com/rust-lang/rust/blob/2f6ab77708ae104c854712285af19516287b6906/crates%2Frust-analyzer%2Ftests%2Fheavy_tests%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f6ab77708ae104c854712285af19516287b6906/crates%2Frust-analyzer%2Ftests%2Fheavy_tests%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Ftests%2Fheavy_tests%2Fmain.rs?ref=2f6ab77708ae104c854712285af19516287b6906", "patch": "@@ -76,30 +76,33 @@ fn foo() {\n     server.request::<Runnables>(\n         RunnablesParams { text_document: server.doc_id(\"lib.rs\"), position: None },\n         json!([\n-          {\n-            \"args\": [ \"test\" ],\n-            \"extraArgs\": [ \"foo\", \"--nocapture\" ],\n-            \"kind\": \"cargo\",\n-            \"env\": { \"RUST_BACKTRACE\": \"short\" },\n-            \"cwd\": null,\n-            \"label\": \"test foo\",\n-            \"range\": {\n-              \"end\": { \"character\": 1, \"line\": 2 },\n-              \"start\": { \"character\": 0, \"line\": 0 }\n-            }\n-          },\n-          {\n-            \"args\": [\"check\", \"--workspace\"],\n-            \"extraArgs\": [],\n-            \"kind\": \"cargo\",\n-            \"env\": {},\n-            \"cwd\": null,\n-            \"label\": \"cargo check --workspace\",\n-            \"range\": {\n-              \"end\": { \"character\": 0, \"line\": 0 },\n-              \"start\": { \"character\": 0, \"line\": 0 }\n+            {\n+              \"args\": {\n+                \"cargoArgs\": [\"test\"],\n+                \"executableArgs\": [\"foo\", \"--nocapture\"],\n+              },\n+              \"kind\": \"cargo\",\n+              \"label\": \"test foo\",\n+              \"location\": {\n+                \"targetRange\": {\n+                  \"end\": { \"character\": 1, \"line\": 2 },\n+                  \"start\": { \"character\": 0, \"line\": 0 }\n+                },\n+                \"targetSelectionRange\": {\n+                  \"end\": { \"character\": 6, \"line\": 1 },\n+                  \"start\": { \"character\": 3, \"line\": 1 }\n+                },\n+                \"targetUri\": \"file:///[..]/lib.rs\"\n+              }\n+            },\n+            {\n+              \"args\": {\n+                \"cargoArgs\": [\"check\", \"--workspace\"],\n+                \"executableArgs\": [],\n+              },\n+              \"kind\": \"cargo\",\n+              \"label\": \"cargo check --workspace\"\n             }\n-          }\n         ]),\n     );\n }\n@@ -138,42 +141,44 @@ fn main() {}\n     server.request::<Runnables>(\n         RunnablesParams { text_document: server.doc_id(\"foo/tests/spam.rs\"), position: None },\n         json!([\n-            {\n-              \"args\": [ \"test\", \"--package\", \"foo\", \"--test\", \"spam\" ],\n-              \"extraArgs\": [ \"test_eggs\", \"--exact\", \"--nocapture\" ],\n-              \"kind\": \"cargo\",\n-              \"env\": { \"RUST_BACKTRACE\": \"short\" },\n-              \"label\": \"test test_eggs\",\n-              \"range\": {\n-                \"end\": { \"character\": 17, \"line\": 1 },\n-                \"start\": { \"character\": 0, \"line\": 0 }\n-              },\n-              \"cwd\": server.path().join(\"foo\")\n+          {\n+            \"args\": {\n+              \"cargoArgs\": [\"test\", \"--package\", \"foo\", \"--test\", \"spam\"],\n+              \"executableArgs\": [\"test_eggs\", \"--exact\", \"--nocapture\"],\n+              \"workspaceRoot\": server.path().join(\"foo\")\n             },\n-            {\n-              \"args\": [ \"check\", \"--package\", \"foo\" ],\n-              \"extraArgs\": [],\n-              \"kind\": \"cargo\",\n-              \"env\": {},\n-              \"label\": \"cargo check -p foo\",\n-              \"range\": {\n-                \"end\": { \"character\": 0, \"line\": 0 },\n+            \"kind\": \"cargo\",\n+            \"label\": \"test test_eggs\",\n+            \"location\": {\n+              \"targetRange\": {\n+                \"end\": { \"character\": 17, \"line\": 1 },\n                 \"start\": { \"character\": 0, \"line\": 0 }\n               },\n-              \"cwd\": server.path().join(\"foo\")\n-            },\n-            {\n-              \"args\": [ \"test\", \"--package\", \"foo\" ],\n-              \"extraArgs\": [],\n-              \"kind\": \"cargo\",\n-              \"env\": {},\n-              \"label\": \"cargo test -p foo\",\n-              \"range\": {\n-                \"end\": { \"character\": 0, \"line\": 0 },\n-                \"start\": { \"character\": 0, \"line\": 0 }\n+              \"targetSelectionRange\": {\n+                \"end\": { \"character\": 12, \"line\": 1 },\n+                \"start\": { \"character\": 3, \"line\": 1 }\n               },\n-              \"cwd\": server.path().join(\"foo\")\n+              \"targetUri\": \"file:///[..]/tests/spam.rs\"\n             }\n+          },\n+          {\n+            \"args\": {\n+              \"cargoArgs\": [\"check\", \"--package\", \"foo\"],\n+              \"executableArgs\": [],\n+              \"workspaceRoot\": server.path().join(\"foo\")\n+            },\n+            \"kind\": \"cargo\",\n+            \"label\": \"cargo check -p foo\"\n+          },\n+          {\n+            \"args\": {\n+              \"cargoArgs\": [\"test\", \"--package\", \"foo\"],\n+              \"executableArgs\": [],\n+              \"workspaceRoot\": server.path().join(\"foo\")\n+            },\n+            \"kind\": \"cargo\",\n+            \"label\": \"cargo test -p foo\"\n+          }\n         ]),\n     );\n }"}, {"sha": "647cf6107565c3e6d19829a28908a88e8d85a3b1", "filename": "docs/dev/lsp-extensions.md", "status": "modified", "additions": 44, "deletions": 36, "changes": 80, "blob_url": "https://github.com/rust-lang/rust/blob/2f6ab77708ae104c854712285af19516287b6906/docs%2Fdev%2Flsp-extensions.md", "raw_url": "https://github.com/rust-lang/rust/raw/2f6ab77708ae104c854712285af19516287b6906/docs%2Fdev%2Flsp-extensions.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fdev%2Flsp-extensions.md?ref=2f6ab77708ae104c854712285af19516287b6906", "patch": "@@ -311,6 +311,50 @@ Moreover, it would be cool if editors didn't need to implement even basic langua\n   This is how `SelectionRange` request works.\n * Alternatively, should we perhaps flag certain `SelectionRange`s as being brace pairs?\n \n+## Runnables\n+\n+**Issue:** https://github.com/microsoft/language-server-protocol/issues/944\n+\n+**Server Capability:** `{ \"runnables\": { \"kinds\": string[] } }`\n+\n+This request is send from client to server to get the list of things that can be run (tests, binaries, `cargo check -p`).\n+\n+**Method:** `experimental/runnables`\n+\n+**Request:**\n+\n+```typescript\n+interface RunnablesParams {\n+    textDocument: TextDocumentIdentifier;\n+    /// If null, compute runnables for the whole file.\n+    position?: Position;\n+}\n+```\n+\n+**Response:** `Runnable[]`\n+\n+```typescript\n+interface Runnable {\n+    label: string;\n+    /// If this Runnable is associated with a specific function/module, etc, the location of this item\n+    location?: LocationLink;\n+    /// Running things is necessary technology specific, `kind` needs to be advertised via server capabilities,\n+    // the type of `args` is specific to `kind`. The actual running is handled by the client.\n+    kind: string;\n+    args: any;\n+}\n+```\n+\n+rust-analyzer supports only one `kind`, `\"cargo\"`. The `args` for `\"cargo\"` look like this:\n+\n+```typescript\n+{\n+    workspaceRoot?: string;\n+    cargoArgs: string[];\n+    executableArgs: string[];\n+}\n+```\n+\n ## Analyzer Status\n \n **Method:** `rust-analyzer/analyzerStatus`\n@@ -399,39 +443,3 @@ interface InlayHint {\n     label: string,\n }\n ```\n-\n-## Runnables\n-\n-**Method:** `rust-analyzer/runnables`\n-\n-This request is send from client to server to get the list of things that can be run (tests, binaries, `cargo check -p`).\n-Note that we plan to move this request to `experimental/runnables`, as it is not really Rust-specific, but the current API is not necessary the right one.\n-Upstream issue: https://github.com/microsoft/language-server-protocol/issues/944\n-\n-**Request:**\n-\n-```typescript\n-interface RunnablesParams {\n-    textDocument: TextDocumentIdentifier;\n-    /// If null, compute runnables for the whole file.\n-    position?: Position;\n-}\n-```\n-\n-**Response:** `Runnable[]`\n-\n-```typescript\n-interface Runnable {\n-    /// The range this runnable is applicable for.\n-    range: lc.Range;\n-    /// The label to show in the UI.\n-    label: string;\n-    /// The following fields describe a process to spawn.\n-    kind: \"cargo\" | \"rustc\" | \"rustup\";\n-    args: string[];\n-    /// Args for cargo after `--`.\n-    extraArgs: string[];\n-    env: { [key: string]: string };\n-    cwd: string | null;\n-}\n-```"}, {"sha": "a0c9b3ab2e64a04414e6641b14e7fc74bbae44c5", "filename": "editors/code/src/debug.ts", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/2f6ab77708ae104c854712285af19516287b6906/editors%2Fcode%2Fsrc%2Fdebug.ts", "raw_url": "https://github.com/rust-lang/rust/raw/2f6ab77708ae104c854712285af19516287b6906/editors%2Fcode%2Fsrc%2Fdebug.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fdebug.ts?ref=2f6ab77708ae104c854712285af19516287b6906", "patch": "@@ -114,8 +114,8 @@ async function getDebugConfiguration(ctx: Ctx, runnable: ra.Runnable): Promise<v\n }\n \n async function getDebugExecutable(runnable: ra.Runnable): Promise<string> {\n-    const cargo = new Cargo(runnable.cwd || '.', debugOutput);\n-    const executable = await cargo.executableFromArgs(runnable.args);\n+    const cargo = new Cargo(runnable.args.workspaceRoot || '.', debugOutput);\n+    const executable = await cargo.executableFromArgs(runnable.args.cargoArgs);\n \n     // if we are here, there were no compilation errors.\n     return executable;\n@@ -127,8 +127,8 @@ function getLldbDebugConfig(runnable: ra.Runnable, executable: string, sourceFil\n         request: \"launch\",\n         name: runnable.label,\n         program: executable,\n-        args: runnable.extraArgs,\n-        cwd: runnable.cwd,\n+        args: runnable.args.executableArgs,\n+        cwd: runnable.args.workspaceRoot,\n         sourceMap: sourceFileMap,\n         sourceLanguages: [\"rust\"]\n     };\n@@ -140,8 +140,8 @@ function getCppvsDebugConfig(runnable: ra.Runnable, executable: string, sourceFi\n         request: \"launch\",\n         name: runnable.label,\n         program: executable,\n-        args: runnable.extraArgs,\n-        cwd: runnable.cwd,\n+        args: runnable.args.executableArgs,\n+        cwd: runnable.args.workspaceRoot,\n         sourceFileMap: sourceFileMap,\n     };\n }"}, {"sha": "c51acfccb90a664271b147ffe31d447ddd6df467", "filename": "editors/code/src/lsp_ext.ts", "status": "modified", "additions": 8, "deletions": 9, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/2f6ab77708ae104c854712285af19516287b6906/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "raw_url": "https://github.com/rust-lang/rust/raw/2f6ab77708ae104c854712285af19516287b6906/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Flsp_ext.ts?ref=2f6ab77708ae104c854712285af19516287b6906", "patch": "@@ -46,18 +46,17 @@ export interface RunnablesParams {\n     position: lc.Position | null;\n }\n \n-export type RunnableKind = \"cargo\" | \"rustc\" | \"rustup\";\n-\n export interface Runnable {\n-    range: lc.Range;\n     label: string;\n-    kind: RunnableKind;\n-    args: string[];\n-    extraArgs: string[];\n-    env: { [key: string]: string };\n-    cwd: string | null;\n+    location?: lc.LocationLink;\n+    kind: \"cargo\";\n+    args: {\n+        workspaceRoot?: string;\n+        cargoArgs: string[];\n+        executableArgs: string[];\n+    };\n }\n-export const runnables = new lc.RequestType<RunnablesParams, Runnable[], void>(\"rust-analyzer/runnables\");\n+export const runnables = new lc.RequestType<RunnablesParams, Runnable[], void>(\"experimental/runnables\");\n \n export type InlayHint = InlayHint.TypeHint | InlayHint.ParamHint | InlayHint.ChainingHint;\n "}, {"sha": "5c790741f3874b7017741e9f68f65b63359f301d", "filename": "editors/code/src/run.ts", "status": "modified", "additions": 15, "deletions": 6, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/2f6ab77708ae104c854712285af19516287b6906/editors%2Fcode%2Fsrc%2Frun.ts", "raw_url": "https://github.com/rust-lang/rust/raw/2f6ab77708ae104c854712285af19516287b6906/editors%2Fcode%2Fsrc%2Frun.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Frun.ts?ref=2f6ab77708ae104c854712285af19516287b6906", "patch": "@@ -103,18 +103,27 @@ interface CargoTaskDefinition extends vscode.TaskDefinition {\n     env?: { [key: string]: string };\n }\n \n-export function createTask(spec: ra.Runnable): vscode.Task {\n+export function createTask(runnable: ra.Runnable): vscode.Task {\n     const TASK_SOURCE = 'Rust';\n+\n+    let command;\n+    switch (runnable.kind) {\n+        case \"cargo\": command = toolchain.getPathForExecutable(\"cargo\");\n+    }\n+    const args = runnable.args.cargoArgs;\n+    if (runnable.args.executableArgs.length > 0) {\n+        args.push('--', ...runnable.args.executableArgs);\n+    }\n     const definition: CargoTaskDefinition = {\n         type: 'cargo',\n-        label: spec.label,\n-        command: toolchain.getPathForExecutable(spec.kind),\n-        args: spec.extraArgs ? [...spec.args, '--', ...spec.extraArgs] : spec.args,\n-        env: Object.assign({}, process.env, spec.env),\n+        label: runnable.label,\n+        command,\n+        args,\n+        env: Object.assign({}, process.env as { [key: string]: string }, { \"RUST_BACKTRACE\": \"short\" }),\n     };\n \n     const execOption: vscode.ShellExecutionOptions = {\n-        cwd: spec.cwd || '.',\n+        cwd: runnable.args.workspaceRoot || '.',\n         env: definition.env,\n     };\n     const exec = new vscode.ShellExecution("}]}