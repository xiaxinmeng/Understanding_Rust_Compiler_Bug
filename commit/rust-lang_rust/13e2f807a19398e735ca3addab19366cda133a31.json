{"sha": "13e2f807a19398e735ca3addab19366cda133a31", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEzZTJmODA3YTE5Mzk4ZTczNWNhM2FkZGFiMTkzNjZjZGExMzNhMzE=", "commit": {"author": {"name": "kit", "email": "kit@hastur.io", "date": "2021-08-16T05:35:53Z"}, "committer": {"name": "kit", "email": "kit@hastur.io", "date": "2021-08-16T07:31:37Z"}, "message": "Generate an iOS LLVM target with a specific version\n\nWithout the specific version, the mach-o header will be missing the\nminimum supported operating system version. This is mandatory for\nrunning Rust binaries on iOS devices.", "tree": {"sha": "bb7faad05311e5676aaa49f219189b56159a2587", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bb7faad05311e5676aaa49f219189b56159a2587"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/13e2f807a19398e735ca3addab19366cda133a31", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/13e2f807a19398e735ca3addab19366cda133a31", "html_url": "https://github.com/rust-lang/rust/commit/13e2f807a19398e735ca3addab19366cda133a31", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/13e2f807a19398e735ca3addab19366cda133a31/comments", "author": {"login": "kit-981", "id": 86507480, "node_id": "MDQ6VXNlcjg2NTA3NDgw", "avatar_url": "https://avatars.githubusercontent.com/u/86507480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kit-981", "html_url": "https://github.com/kit-981", "followers_url": "https://api.github.com/users/kit-981/followers", "following_url": "https://api.github.com/users/kit-981/following{/other_user}", "gists_url": "https://api.github.com/users/kit-981/gists{/gist_id}", "starred_url": "https://api.github.com/users/kit-981/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kit-981/subscriptions", "organizations_url": "https://api.github.com/users/kit-981/orgs", "repos_url": "https://api.github.com/users/kit-981/repos", "events_url": "https://api.github.com/users/kit-981/events{/privacy}", "received_events_url": "https://api.github.com/users/kit-981/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kit-981", "id": 86507480, "node_id": "MDQ6VXNlcjg2NTA3NDgw", "avatar_url": "https://avatars.githubusercontent.com/u/86507480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kit-981", "html_url": "https://github.com/kit-981", "followers_url": "https://api.github.com/users/kit-981/followers", "following_url": "https://api.github.com/users/kit-981/following{/other_user}", "gists_url": "https://api.github.com/users/kit-981/gists{/gist_id}", "starred_url": "https://api.github.com/users/kit-981/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kit-981/subscriptions", "organizations_url": "https://api.github.com/users/kit-981/orgs", "repos_url": "https://api.github.com/users/kit-981/repos", "events_url": "https://api.github.com/users/kit-981/events{/privacy}", "received_events_url": "https://api.github.com/users/kit-981/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2a6fb9a4c0e5ca7a81999065943b211c226fe9d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/2a6fb9a4c0e5ca7a81999065943b211c226fe9d8", "html_url": "https://github.com/rust-lang/rust/commit/2a6fb9a4c0e5ca7a81999065943b211c226fe9d8"}], "stats": {"total": 14, "additions": 13, "deletions": 1}, "files": [{"sha": "6468419fce7c3e5b973dad2b43552dc4c62a50e8", "filename": "compiler/rustc_target/src/spec/aarch64_apple_ios.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/13e2f807a19398e735ca3addab19366cda133a31/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13e2f807a19398e735ca3addab19366cda133a31/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios.rs?ref=13e2f807a19398e735ca3addab19366cda133a31", "patch": "@@ -2,8 +2,15 @@ use super::apple_sdk_base::{opts, Arch};\n use crate::spec::{FramePointer, Target, TargetOptions};\n \n pub fn target() -> Target {\n+    // Clang automatically chooses a more specific target based on\n+    // IPHONEOS_DEPLOYMENT_TARGET.\n+    // This is required for the target to pick the right\n+    // MACH-O commands, so we do too.\n+    let arch = \"arm64\";\n+    let llvm_target = super::apple_base::ios_llvm_target(arch);\n+\n     Target {\n-        llvm_target: \"arm64-apple-ios\".to_string(),\n+        llvm_target,\n         pointer_width: 64,\n         data_layout: \"e-m:o-i64:64-i128:128-n32:64-S128\".to_string(),\n         arch: \"aarch64\".to_string(),"}, {"sha": "cff0b3651e170b683ff7652d24ff8256f7c0f567", "filename": "compiler/rustc_target/src/spec/apple_base.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/13e2f807a19398e735ca3addab19366cda133a31/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13e2f807a19398e735ca3addab19366cda133a31/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_base.rs?ref=13e2f807a19398e735ca3addab19366cda133a31", "patch": "@@ -91,6 +91,11 @@ fn ios_deployment_target() -> (u32, u32) {\n     deployment_target(\"IPHONEOS_DEPLOYMENT_TARGET\").unwrap_or((7, 0))\n }\n \n+pub fn ios_llvm_target(arch: &str) -> String {\n+    let (major, minor) = ios_deployment_target();\n+    format!(\"{}-apple-ios{}.{}.0\", arch, major, minor)\n+}\n+\n pub fn ios_sim_llvm_target(arch: &str) -> String {\n     let (major, minor) = ios_deployment_target();\n     format!(\"{}-apple-ios{}.{}.0-simulator\", arch, major, minor)"}]}