{"sha": "9a78dc93db551f325b3b3d90540de6ebe7873b4b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlhNzhkYzkzZGI1NTFmMzI1YjNiM2Q5MDU0MGRlNmViZTc4NzNiNGI=", "commit": {"author": {"name": "Chris Peterson", "email": "cpeterson@mozilla.com", "date": "2013-02-14T09:11:59Z"}, "committer": {"name": "Chris Peterson", "email": "cpeterson@mozilla.com", "date": "2013-02-15T06:33:12Z"}, "message": "reseed rust_rng after generating 32KB", "tree": {"sha": "33caee6103c8e1f56163da7050369454471a5d6a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/33caee6103c8e1f56163da7050369454471a5d6a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9a78dc93db551f325b3b3d90540de6ebe7873b4b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9a78dc93db551f325b3b3d90540de6ebe7873b4b", "html_url": "https://github.com/rust-lang/rust/commit/9a78dc93db551f325b3b3d90540de6ebe7873b4b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9a78dc93db551f325b3b3d90540de6ebe7873b4b/comments", "author": {"login": "cpeterso", "id": 629193, "node_id": "MDQ6VXNlcjYyOTE5Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/629193?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cpeterso", "html_url": "https://github.com/cpeterso", "followers_url": "https://api.github.com/users/cpeterso/followers", "following_url": "https://api.github.com/users/cpeterso/following{/other_user}", "gists_url": "https://api.github.com/users/cpeterso/gists{/gist_id}", "starred_url": "https://api.github.com/users/cpeterso/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cpeterso/subscriptions", "organizations_url": "https://api.github.com/users/cpeterso/orgs", "repos_url": "https://api.github.com/users/cpeterso/repos", "events_url": "https://api.github.com/users/cpeterso/events{/privacy}", "received_events_url": "https://api.github.com/users/cpeterso/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cpeterso", "id": 629193, "node_id": "MDQ6VXNlcjYyOTE5Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/629193?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cpeterso", "html_url": "https://github.com/cpeterso", "followers_url": "https://api.github.com/users/cpeterso/followers", "following_url": "https://api.github.com/users/cpeterso/following{/other_user}", "gists_url": "https://api.github.com/users/cpeterso/gists{/gist_id}", "starred_url": "https://api.github.com/users/cpeterso/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cpeterso/subscriptions", "organizations_url": "https://api.github.com/users/cpeterso/orgs", "repos_url": "https://api.github.com/users/cpeterso/repos", "events_url": "https://api.github.com/users/cpeterso/events{/privacy}", "received_events_url": "https://api.github.com/users/cpeterso/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "665e900edeb611a7bfc9b0b911489cb802740945", "url": "https://api.github.com/repos/rust-lang/rust/commits/665e900edeb611a7bfc9b0b911489cb802740945", "html_url": "https://github.com/rust-lang/rust/commit/665e900edeb611a7bfc9b0b911489cb802740945"}], "stats": {"total": 36, "additions": 31, "deletions": 5}, "files": [{"sha": "85caf7b2e5381ba48ad76fb655e62829ea969e35", "filename": "src/rt/rust_builtin.cpp", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9a78dc93db551f325b3b3d90540de6ebe7873b4b/src%2Frt%2Frust_builtin.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/9a78dc93db551f325b3b3d90540de6ebe7873b4b/src%2Frt%2Frust_builtin.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_builtin.cpp?ref=9a78dc93db551f325b3b3d90540de6ebe7873b4b", "patch": "@@ -173,7 +173,8 @@ rand_new_seeded2(rust_vec_box** seed) {\n \n extern \"C\" CDECL uint32_t\n rand_next(rust_rng *rng) {\n-    return rng_gen_u32(rng);\n+    rust_task *task = rust_get_current_task();\n+    return rng_gen_u32(task->kernel, rng);\n }\n \n extern \"C\" CDECL void"}, {"sha": "3d6bfdf7dbb1f06c5ecb0bae45c0ae7438aaea27", "filename": "src/rt/rust_rng.cpp", "status": "modified", "additions": 26, "deletions": 2, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/9a78dc93db551f325b3b3d90540de6ebe7873b4b/src%2Frt%2Frust_rng.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/9a78dc93db551f325b3b3d90540de6ebe7873b4b/src%2Frt%2Frust_rng.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_rng.cpp?ref=9a78dc93db551f325b3b3d90540de6ebe7873b4b", "patch": "@@ -73,11 +73,35 @@ isaac_init(rust_kernel *kernel, randctx *rctx, rust_vec_box* user_seed) {\n void\n rng_init(rust_kernel* kernel, rust_rng* rng, rust_vec_box* user_seed) {\n     isaac_init(kernel, &rng->rctx, user_seed);\n+    rng->reseedable = !user_seed && !kernel->env->rust_seed;\n+}\n+\n+static void\n+rng_maybe_reseed(rust_kernel* kernel, rust_rng* rng) {\n+    // If this RNG has generated more than 32KB of random data and was not\n+    // seeded by the user or RUST_SEED, then we should reseed now.\n+    const size_t RESEED_THRESHOLD = 32 * 1024;\n+    size_t bytes_generated = rng->rctx.randc * sizeof(ub4);\n+    if (bytes_generated < RESEED_THRESHOLD || !rng->reseedable) {\n+        return;\n+    }\n+\n+    uint32_t new_seed[RANDSIZ];\n+    rng_gen_seed(kernel, (uint8_t*) new_seed, RANDSIZ * sizeof(uint32_t));\n+\n+    // Stir new seed into PRNG's entropy pool.\n+    for (size_t i = 0; i < RANDSIZ; i++) {\n+        rng->rctx.randrsl[i] ^= new_seed[i];\n+    }\n+\n+    randinit(&rng->rctx, 1);\n }\n \n uint32_t\n-rng_gen_u32(rust_rng* rng) {\n-    return isaac_rand(&rng->rctx);\n+rng_gen_u32(rust_kernel* kernel, rust_rng* rng) {\n+    uint32_t x = isaac_rand(&rng->rctx);\n+    rng_maybe_reseed(kernel, rng);\n+    return x;\n }\n \n //"}, {"sha": "2f1e680623febd56784d018f06bf2ceded768bad", "filename": "src/rt/rust_rng.h", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9a78dc93db551f325b3b3d90540de6ebe7873b4b/src%2Frt%2Frust_rng.h", "raw_url": "https://github.com/rust-lang/rust/raw/9a78dc93db551f325b3b3d90540de6ebe7873b4b/src%2Frt%2Frust_rng.h", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_rng.h?ref=9a78dc93db551f325b3b3d90540de6ebe7873b4b", "patch": "@@ -20,11 +20,12 @@ struct rust_vec_box;\n \n struct rust_rng {\n     randctx rctx;\n+    bool reseedable;\n };\n \n void rng_gen_seed(rust_kernel* kernel, uint8_t* dest, size_t size);\n void rng_init(rust_kernel *kernel, rust_rng *rng, rust_vec_box* user_seed);\n-uint32_t rng_gen_u32(rust_rng *rng);\n+uint32_t rng_gen_u32(rust_kernel *kernel, rust_rng *rng);\n \n //\n // Local Variables:"}, {"sha": "01c377356a38c2941db8042ebda4ba1fdc6b4a06", "filename": "src/rt/rust_sched_loop.cpp", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9a78dc93db551f325b3b3d90540de6ebe7873b4b/src%2Frt%2Frust_sched_loop.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/9a78dc93db551f325b3b3d90540de6ebe7873b4b/src%2Frt%2Frust_sched_loop.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_sched_loop.cpp?ref=9a78dc93db551f325b3b3d90540de6ebe7873b4b", "patch": "@@ -151,7 +151,7 @@ rust_task *\n rust_sched_loop::schedule_task() {\n     lock.must_have_lock();\n     if (running_tasks.length() > 0) {\n-        size_t k = rng_gen_u32(&rng);\n+        size_t k = rng_gen_u32(kernel, &rng);\n         size_t i = k % running_tasks.length();\n         return (rust_task *)running_tasks[i];\n     }"}]}