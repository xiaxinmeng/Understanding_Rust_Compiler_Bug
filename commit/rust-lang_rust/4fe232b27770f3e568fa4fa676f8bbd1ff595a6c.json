{"sha": "4fe232b27770f3e568fa4fa676f8bbd1ff595a6c", "node_id": "C_kwDOAAsO6NoAKDRmZTIzMmIyNzc3MGYzZTU2OGZhNGZhNjc2ZjhiYmQxZmY1OTVhNmM", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-03-06T23:30:34Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-03-06T23:33:07Z"}, "message": "Do not ICE when we have fn pointer Fn obligations with bound vars in the self type", "tree": {"sha": "f0993bd5a0e5b1b8b4f515fe24bfb21956c2a40c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f0993bd5a0e5b1b8b4f515fe24bfb21956c2a40c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4fe232b27770f3e568fa4fa676f8bbd1ff595a6c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4fe232b27770f3e568fa4fa676f8bbd1ff595a6c", "html_url": "https://github.com/rust-lang/rust/commit/4fe232b27770f3e568fa4fa676f8bbd1ff595a6c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4fe232b27770f3e568fa4fa676f8bbd1ff595a6c/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f63ccaf25f74151a5d8ce057904cd944074b01d2", "url": "https://api.github.com/repos/rust-lang/rust/commits/f63ccaf25f74151a5d8ce057904cd944074b01d2", "html_url": "https://github.com/rust-lang/rust/commit/f63ccaf25f74151a5d8ce057904cd944074b01d2"}], "stats": {"total": 47, "additions": 44, "deletions": 3}, "files": [{"sha": "ee41d840bae926e17bf4860c91352508870fbabe", "filename": "compiler/rustc_trait_selection/src/traits/select/confirmation.rs", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4fe232b27770f3e568fa4fa676f8bbd1ff595a6c/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fconfirmation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fe232b27770f3e568fa4fa676f8bbd1ff595a6c/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fconfirmation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fconfirmation.rs?ref=4fe232b27770f3e568fa4fa676f8bbd1ff595a6c", "patch": "@@ -601,10 +601,18 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         debug!(?obligation, \"confirm_fn_pointer_candidate\");\n \n         let tcx = self.tcx();\n-        let self_ty = self\n+\n+        let Some(self_ty) = self\n             .infcx\n-            .shallow_resolve(obligation.self_ty().no_bound_vars())\n-            .expect(\"fn pointer should not capture bound vars from predicate\");\n+            .shallow_resolve(obligation.self_ty().no_bound_vars()) else\n+        {\n+            // FIXME: Ideally we'd support `for<'a> fn(&'a ()): Fn(&'a ())`,\n+            // but we do not currently. Luckily, such a bound is not\n+            // particularly useful, so we don't expect users to write\n+            // them often.\n+            return Err(SelectionError::Unimplemented);\n+        };\n+\n         let sig = self_ty.fn_sig(tcx);\n         let trait_ref = closure_trait_ref_and_return_type(\n             tcx,"}, {"sha": "9af6bc45c7a060c14ff3f875983ce0bdaf2ef3a8", "filename": "tests/ui/higher-rank-trait-bounds/fn-ptr.classic.stderr", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/4fe232b27770f3e568fa4fa676f8bbd1ff595a6c/tests%2Fui%2Fhigher-rank-trait-bounds%2Ffn-ptr.classic.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4fe232b27770f3e568fa4fa676f8bbd1ff595a6c/tests%2Fui%2Fhigher-rank-trait-bounds%2Ffn-ptr.classic.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fhigher-rank-trait-bounds%2Ffn-ptr.classic.stderr?ref=4fe232b27770f3e568fa4fa676f8bbd1ff595a6c", "patch": "@@ -0,0 +1,19 @@\n+error[E0277]: expected a `Fn<(&'w (),)>` closure, found `fn(&'w ())`\n+  --> $DIR/fn-ptr.rs:12:5\n+   |\n+LL |     ice();\n+   |     ^^^ expected an `Fn<(&'w (),)>` closure, found `fn(&'w ())`\n+   |\n+   = help: the trait `for<'w> Fn<(&'w (),)>` is not implemented for `fn(&'w ())`\n+note: required by a bound in `ice`\n+  --> $DIR/fn-ptr.rs:7:25\n+   |\n+LL | fn ice()\n+   |    --- required by a bound in this function\n+LL | where\n+LL |     for<'w> fn(&'w ()): Fn(&'w ()),\n+   |                         ^^^^^^^^^^ required by this bound in `ice`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0277`."}, {"sha": "853160f961245ce3388972fd4c4e68f27fb0c767", "filename": "tests/ui/higher-rank-trait-bounds/fn-ptr.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4fe232b27770f3e568fa4fa676f8bbd1ff595a6c/tests%2Fui%2Fhigher-rank-trait-bounds%2Ffn-ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fe232b27770f3e568fa4fa676f8bbd1ff595a6c/tests%2Fui%2Fhigher-rank-trait-bounds%2Ffn-ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fhigher-rank-trait-bounds%2Ffn-ptr.rs?ref=4fe232b27770f3e568fa4fa676f8bbd1ff595a6c", "patch": "@@ -0,0 +1,14 @@\n+// revisions: classic next\n+//[next] compile-flags: -Ztrait-solver=next\n+//[next] check-pass\n+\n+fn ice()\n+where\n+    for<'w> fn(&'w ()): Fn(&'w ()),\n+{\n+}\n+\n+fn main() {\n+    ice();\n+    //[classic]~^ ERROR expected a `Fn<(&'w (),)>` closure, found `fn(&'w ())`\n+}"}]}