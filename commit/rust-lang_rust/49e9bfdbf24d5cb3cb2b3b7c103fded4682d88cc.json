{"sha": "49e9bfdbf24d5cb3cb2b3b7c103fded4682d88cc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ5ZTliZmRiZjI0ZDVjYjNjYjJiM2I3YzEwM2ZkZWQ0NjgyZDg4Y2M=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-09-03T18:24:01Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-09-03T18:24:01Z"}, "message": "Auto merge of #36104 - KiChjang:issue-35847, r=brson\n\nFix illegal instruction caused by overflow in channel cloning\n\nFixes #35847.\n\nr? @alexcrichton", "tree": {"sha": "d127376c1be4101e36b189ee6016a940d27b8bf8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d127376c1be4101e36b189ee6016a940d27b8bf8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/49e9bfdbf24d5cb3cb2b3b7c103fded4682d88cc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/49e9bfdbf24d5cb3cb2b3b7c103fded4682d88cc", "html_url": "https://github.com/rust-lang/rust/commit/49e9bfdbf24d5cb3cb2b3b7c103fded4682d88cc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/49e9bfdbf24d5cb3cb2b3b7c103fded4682d88cc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d748fa6ecccf6f5b4c7ae4abee0a2d206b165de2", "url": "https://api.github.com/repos/rust-lang/rust/commits/d748fa6ecccf6f5b4c7ae4abee0a2d206b165de2", "html_url": "https://github.com/rust-lang/rust/commit/d748fa6ecccf6f5b4c7ae4abee0a2d206b165de2"}, {"sha": "899c2891e6be24100db723f2b5464969bcebe0f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/899c2891e6be24100db723f2b5464969bcebe0f0", "html_url": "https://github.com/rust-lang/rust/commit/899c2891e6be24100db723f2b5464969bcebe0f0"}], "stats": {"total": 28, "additions": 24, "deletions": 4}, "files": [{"sha": "2a9618251ff52ef21597c733eeae677ff9c2f8a2", "filename": "src/libstd/sync/mpsc/shared.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/49e9bfdbf24d5cb3cb2b3b7c103fded4682d88cc/src%2Flibstd%2Fsync%2Fmpsc%2Fshared.rs", "raw_url": "https://github.com/rust-lang/rust/raw/49e9bfdbf24d5cb3cb2b3b7c103fded4682d88cc/src%2Flibstd%2Fsync%2Fmpsc%2Fshared.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsync%2Fmpsc%2Fshared.rs?ref=49e9bfdbf24d5cb3cb2b3b7c103fded4682d88cc", "patch": "@@ -21,6 +21,7 @@\n pub use self::Failure::*;\n \n use core::cmp;\n+use core::intrinsics::abort;\n use core::isize;\n \n use sync::atomic::{AtomicUsize, AtomicIsize, AtomicBool, Ordering};\n@@ -34,6 +35,7 @@ use time::Instant;\n \n const DISCONNECTED: isize = isize::MIN;\n const FUDGE: isize = 1024;\n+const MAX_REFCOUNT: usize = (isize::MAX) as usize;\n #[cfg(test)]\n const MAX_STEALS: isize = 5;\n #[cfg(not(test))]\n@@ -46,7 +48,7 @@ pub struct Packet<T> {\n     to_wake: AtomicUsize, // SignalToken for wake up\n \n     // The number of channels which are currently using this packet.\n-    channels: AtomicIsize,\n+    channels: AtomicUsize,\n \n     // See the discussion in Port::drop and the channel send methods for what\n     // these are used for\n@@ -72,7 +74,7 @@ impl<T> Packet<T> {\n             cnt: AtomicIsize::new(0),\n             steals: 0,\n             to_wake: AtomicUsize::new(0),\n-            channels: AtomicIsize::new(2),\n+            channels: AtomicUsize::new(2),\n             port_dropped: AtomicBool::new(false),\n             sender_drain: AtomicIsize::new(0),\n             select_lock: Mutex::new(()),\n@@ -340,7 +342,14 @@ impl<T> Packet<T> {\n     // Prepares this shared packet for a channel clone, essentially just bumping\n     // a refcount.\n     pub fn clone_chan(&mut self) {\n-        self.channels.fetch_add(1, Ordering::SeqCst);\n+        let old_count = self.channels.fetch_add(1, Ordering::SeqCst);\n+\n+        // See comments on Arc::clone() on why we do this (for `mem::forget`).\n+        if old_count > MAX_REFCOUNT {\n+            unsafe {\n+                abort();\n+            }\n+        }\n     }\n \n     // Decrement the reference count on a channel. This is called whenever a"}, {"sha": "1d16e002a2bef460ce2d1cdb16397606e49f035e", "filename": "src/libstd/sync/mpsc/sync.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/49e9bfdbf24d5cb3cb2b3b7c103fded4682d88cc/src%2Flibstd%2Fsync%2Fmpsc%2Fsync.rs", "raw_url": "https://github.com/rust-lang/rust/raw/49e9bfdbf24d5cb3cb2b3b7c103fded4682d88cc/src%2Flibstd%2Fsync%2Fmpsc%2Fsync.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsync%2Fmpsc%2Fsync.rs?ref=49e9bfdbf24d5cb3cb2b3b7c103fded4682d88cc", "patch": "@@ -36,6 +36,8 @@\n pub use self::Failure::*;\n use self::Blocker::*;\n \n+use core::intrinsics::abort;\n+use core::isize;\n use core::mem;\n use core::ptr;\n \n@@ -45,6 +47,8 @@ use sync::mpsc::select::StartResult::{self, Installed, Abort};\n use sync::{Mutex, MutexGuard};\n use time::Instant;\n \n+const MAX_REFCOUNT: usize = (isize::MAX) as usize;\n+\n pub struct Packet<T> {\n     /// Only field outside of the mutex. Just done for kicks, but mainly because\n     /// the other shared channel already had the code implemented\n@@ -350,7 +354,14 @@ impl<T> Packet<T> {\n     // Prepares this shared packet for a channel clone, essentially just bumping\n     // a refcount.\n     pub fn clone_chan(&self) {\n-        self.channels.fetch_add(1, Ordering::SeqCst);\n+        let old_count = self.channels.fetch_add(1, Ordering::SeqCst);\n+\n+        // See comments on Arc::clone() on why we do this (for `mem::forget`).\n+        if old_count > MAX_REFCOUNT {\n+            unsafe {\n+                abort();\n+            }\n+        }\n     }\n \n     pub fn drop_chan(&self) {"}]}