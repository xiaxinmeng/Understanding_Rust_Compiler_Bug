{"sha": "30ffbc492354392bc4db1a7508e7be272ba8f605", "node_id": "C_kwDOAAsO6NoAKDMwZmZiYzQ5MjM1NDM5MmJjNGRiMWE3NTA4ZTdiZTI3MmJhOGY2MDU", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2023-04-05T11:47:23Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-05T11:47:23Z"}, "message": "Rollup merge of #109848 - ozkanonur:fix-96188, r=albertlarsan68\n\nsubmodule detection for proper fix on #96188\n\nThis commit resolves an internal FIXME note within the bootstrap by implementing submodule detection. This is accomplished through an iterative process over the `.gitmodules` file.\n\nr? `@albertlarsan68`", "tree": {"sha": "ba76ca42442f5e8995ade499040e752ca4d128dc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ba76ca42442f5e8995ade499040e752ca4d128dc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/30ffbc492354392bc4db1a7508e7be272ba8f605", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkLV/LCRBK7hj4Ov3rIwAA4mMIABY5NFBSJ64fRcqypaFmlJJ6\n9boZaedwtb7BybElnx1QtoUtJB479IewuN5Fyrd+3YIhiRsIhA2nYIFoYOzsJXBP\n5wm5sKqoT1SqKPS9rxzHWCWq9TQYyHz50bFD+e/sHdU2QkXWalmgETvSI1eZh3T2\naL7hUyHYMrpQamEU6MxjYA3GupbmKDtwCRaJPSrHKyvCS+JB3KP70wTqD7Fz4eag\nL7Jzt1cLn90rUSZP9hjqcO8fBxKO11e02xhuOUp3Z+MEvTaJAJT4ZHtm/2VpPXkC\nKAoXQ8blwcFKZ3YZZwBTGvzxnmmAqoQCPDm36Zgzc6OyNcBYlRRO7QhoeX2nXaI=\n=oFMl\n-----END PGP SIGNATURE-----\n", "payload": "tree ba76ca42442f5e8995ade499040e752ca4d128dc\nparent 4e0662c8a7c61a4346536bb06aefb4fe2a455ac2\nparent 5a4066ebb788a81eaee6057bcd9c6487d210d8ca\nauthor Yuki Okushi <jtitor@2k36.org> 1680695243 +0900\ncommitter GitHub <noreply@github.com> 1680695243 +0900\n\nRollup merge of #109848 - ozkanonur:fix-96188, r=albertlarsan68\n\nsubmodule detection for proper fix on #96188\n\nThis commit resolves an internal FIXME note within the bootstrap by implementing submodule detection. This is accomplished through an iterative process over the `.gitmodules` file.\n\nr? `@albertlarsan68`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/30ffbc492354392bc4db1a7508e7be272ba8f605", "html_url": "https://github.com/rust-lang/rust/commit/30ffbc492354392bc4db1a7508e7be272ba8f605", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/30ffbc492354392bc4db1a7508e7be272ba8f605/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4e0662c8a7c61a4346536bb06aefb4fe2a455ac2", "url": "https://api.github.com/repos/rust-lang/rust/commits/4e0662c8a7c61a4346536bb06aefb4fe2a455ac2", "html_url": "https://github.com/rust-lang/rust/commit/4e0662c8a7c61a4346536bb06aefb4fe2a455ac2"}, {"sha": "5a4066ebb788a81eaee6057bcd9c6487d210d8ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/5a4066ebb788a81eaee6057bcd9c6487d210d8ca", "html_url": "https://github.com/rust-lang/rust/commit/5a4066ebb788a81eaee6057bcd9c6487d210d8ca"}], "stats": {"total": 50, "additions": 40, "deletions": 10}, "files": [{"sha": "ade8fa4c74dcb5fd35539dc79cc0d9b289e43d77", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 40, "deletions": 10, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/30ffbc492354392bc4db1a7508e7be272ba8f605/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/30ffbc492354392bc4db1a7508e7be272ba8f605/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=30ffbc492354392bc4db1a7508e7be272ba8f605", "patch": "@@ -4,8 +4,9 @@ use std::collections::BTreeSet;\n use std::env;\n use std::ffi::OsStr;\n use std::fmt::{Debug, Write};\n-use std::fs::{self};\n+use std::fs::{self, File};\n use std::hash::Hash;\n+use std::io::{BufRead, BufReader};\n use std::ops::Deref;\n use std::path::{Component, Path, PathBuf};\n use std::process::Command;\n@@ -28,8 +29,11 @@ use crate::{clean, dist};\n use crate::{Build, CLang, DocTests, GitRepo, Mode};\n \n pub use crate::Compiler;\n-// FIXME: replace with std::lazy after it gets stabilized and reaches beta\n-use once_cell::sync::Lazy;\n+// FIXME:\n+// - use std::lazy for `Lazy`\n+// - use std::cell for `OnceCell`\n+// Once they get stabilized and reach beta.\n+use once_cell::sync::{Lazy, OnceCell};\n \n pub struct Builder<'a> {\n     pub build: &'a Build,\n@@ -484,17 +488,43 @@ impl<'a> ShouldRun<'a> {\n \n     // multiple aliases for the same job\n     pub fn paths(mut self, paths: &[&str]) -> Self {\n+        static SUBMODULES_PATHS: OnceCell<Vec<String>> = OnceCell::new();\n+\n+        let init_submodules_paths = |src: &PathBuf| {\n+            let file = File::open(src.join(\".gitmodules\")).unwrap();\n+\n+            let mut submodules_paths = vec![];\n+            for line in BufReader::new(file).lines() {\n+                if let Ok(line) = line {\n+                    let line = line.trim();\n+\n+                    if line.starts_with(\"path\") {\n+                        let actual_path =\n+                            line.split(' ').last().expect(\"Couldn't get value of path\");\n+                        submodules_paths.push(actual_path.to_owned());\n+                    }\n+                }\n+            }\n+\n+            submodules_paths\n+        };\n+\n+        let submodules_paths =\n+            SUBMODULES_PATHS.get_or_init(|| init_submodules_paths(&self.builder.src));\n+\n         self.paths.insert(PathSet::Set(\n             paths\n                 .iter()\n                 .map(|p| {\n-                    // FIXME(#96188): make sure this is actually a path.\n-                    // This currently breaks for paths within submodules.\n-                    //assert!(\n-                    //    self.builder.src.join(p).exists(),\n-                    //    \"`should_run.paths` should correspond to real on-disk paths - use `alias` if there is no relevant path: {}\",\n-                    //    p\n-                    //);\n+                    // assert only if `p` isn't submodule\n+                    if !submodules_paths.iter().find(|sm_p| p.contains(*sm_p)).is_some() {\n+                        assert!(\n+                            self.builder.src.join(p).exists(),\n+                            \"`should_run.paths` should correspond to real on-disk paths - use `alias` if there is no relevant path: {}\",\n+                            p\n+                        );\n+                    }\n+\n                     TaskPath { path: p.into(), kind: Some(self.kind) }\n                 })\n                 .collect(),"}]}