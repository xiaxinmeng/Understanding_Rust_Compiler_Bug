{"sha": "7d01aa8a4815207d83664353895ac168b7564e4b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdkMDFhYThhNDgxNTIwN2Q4MzY2NDM1Mzg5NWFjMTY4Yjc1NjRlNGI=", "commit": {"author": {"name": "Matthew Jasper", "email": "mjjasper1@gmail.com", "date": "2019-02-23T14:25:03Z"}, "committer": {"name": "Matthew Jasper", "email": "mjjasper1@gmail.com", "date": "2019-02-23T14:25:03Z"}, "message": "Type check coercions to pointer types", "tree": {"sha": "e33843a87c084e84ee927300919392ea8458eb79", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e33843a87c084e84ee927300919392ea8458eb79"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7d01aa8a4815207d83664353895ac168b7564e4b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7d01aa8a4815207d83664353895ac168b7564e4b", "html_url": "https://github.com/rust-lang/rust/commit/7d01aa8a4815207d83664353895ac168b7564e4b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7d01aa8a4815207d83664353895ac168b7564e4b/comments", "author": {"login": "matthewjasper", "id": 20113453, "node_id": "MDQ6VXNlcjIwMTEzNDUz", "avatar_url": "https://avatars.githubusercontent.com/u/20113453?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthewjasper", "html_url": "https://github.com/matthewjasper", "followers_url": "https://api.github.com/users/matthewjasper/followers", "following_url": "https://api.github.com/users/matthewjasper/following{/other_user}", "gists_url": "https://api.github.com/users/matthewjasper/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthewjasper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthewjasper/subscriptions", "organizations_url": "https://api.github.com/users/matthewjasper/orgs", "repos_url": "https://api.github.com/users/matthewjasper/repos", "events_url": "https://api.github.com/users/matthewjasper/events{/privacy}", "received_events_url": "https://api.github.com/users/matthewjasper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matthewjasper", "id": 20113453, "node_id": "MDQ6VXNlcjIwMTEzNDUz", "avatar_url": "https://avatars.githubusercontent.com/u/20113453?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthewjasper", "html_url": "https://github.com/matthewjasper", "followers_url": "https://api.github.com/users/matthewjasper/followers", "following_url": "https://api.github.com/users/matthewjasper/following{/other_user}", "gists_url": "https://api.github.com/users/matthewjasper/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthewjasper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthewjasper/subscriptions", "organizations_url": "https://api.github.com/users/matthewjasper/orgs", "repos_url": "https://api.github.com/users/matthewjasper/repos", "events_url": "https://api.github.com/users/matthewjasper/events{/privacy}", "received_events_url": "https://api.github.com/users/matthewjasper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "082c86175fcf72c355e6a889956fbea59e65bcdb", "url": "https://api.github.com/repos/rust-lang/rust/commits/082c86175fcf72c355e6a889956fbea59e65bcdb", "html_url": "https://github.com/rust-lang/rust/commit/082c86175fcf72c355e6a889956fbea59e65bcdb"}], "stats": {"total": 289, "additions": 274, "deletions": 15}, "files": [{"sha": "69a1e2d8a1ef40edaedfd9ef0b0305c9d8969a34", "filename": "src/librustc/ich/impls_mir.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc%2Fich%2Fimpls_mir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc%2Fich%2Fimpls_mir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_mir.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -373,6 +373,7 @@ impl_stable_hash_for!(enum mir::CastKind {\n     ReifyFnPointer,\n     ClosureFnPointer,\n     UnsafeFnPointer,\n+    MutToConstPointer,\n     Unsize\n });\n "}, {"sha": "5d596f81099f7e845b8110304095451315a611c6", "filename": "src/librustc/mir/mod.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fmod.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -2220,6 +2220,9 @@ pub enum CastKind {\n     /// Converts safe fn() to unsafe fn()\n     UnsafeFnPointer,\n \n+    /// Coerces *mut T to *const T, preserving T.\n+    MutToConstPointer,\n+\n     /// \"Unsize\" -- convert a thin-or-fat pointer to a fat pointer.\n     /// codegen must figure out the details once full monomorphization\n     /// is known. For example, this could be used to cast from a"}, {"sha": "02a7be121cca7c6ba8278a3d09c6e49b57246282", "filename": "src/librustc/ty/context.rs", "status": "modified", "additions": 12, "deletions": 8, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fcontext.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -59,7 +59,6 @@ use std::hash::{Hash, Hasher};\n use std::fmt;\n use std::mem;\n use std::ops::{Deref, Bound};\n-use std::ptr;\n use std::iter;\n use std::sync::mpsc;\n use std::sync::Arc;\n@@ -171,7 +170,7 @@ impl<'gcx: 'tcx, 'tcx> CtxtInterners<'tcx> {\n \n                 // Make sure we don't end up with inference\n                 // types/regions in the global interner\n-                if ptr::eq(local, global) {\n+                if ptr_eq(local, global) {\n                     bug!(\"Attempted to intern `{:?}` which contains \\\n                         inference types/regions in the global type context\",\n                         &ty_struct);\n@@ -1163,7 +1162,7 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n \n     /// Returns `true` if self is the same as self.global_tcx().\n     fn is_global(self) -> bool {\n-        ptr::eq(self.interners, &self.global_interners)\n+        ptr_eq(self.interners, &self.global_interners)\n     }\n \n     /// Creates a type context and call the closure with a `TyCtxt` reference\n@@ -1819,12 +1818,11 @@ impl<'a, 'tcx> Lift<'tcx> for &'a mir::interpret::Allocation {\n }\n \n pub mod tls {\n-    use super::{GlobalCtxt, TyCtxt};\n+    use super::{GlobalCtxt, TyCtxt, ptr_eq};\n \n     use std::fmt;\n     use std::mem;\n     use std::marker::PhantomData;\n-    use std::ptr;\n     use syntax_pos;\n     use crate::ty::query;\n     use errors::{Diagnostic, TRACK_DIAGNOSTICS};\n@@ -2067,7 +2065,7 @@ pub mod tls {\n     {\n         with_context(|context| {\n             unsafe {\n-                assert!(ptr::eq(context.tcx.gcx, tcx.gcx));\n+                assert!(ptr_eq(context.tcx.gcx, tcx.gcx));\n                 let context: &ImplicitCtxt<'_, '_, '_> = mem::transmute(context);\n                 f(context)\n             }\n@@ -2085,8 +2083,8 @@ pub mod tls {\n     {\n         with_context(|context| {\n             unsafe {\n-                assert!(ptr::eq(context.tcx.gcx, tcx.gcx));\n-                assert!(ptr::eq(context.tcx.interners, tcx.interners));\n+                assert!(ptr_eq(context.tcx.gcx, tcx.gcx));\n+                assert!(ptr_eq(context.tcx.interners, tcx.interners));\n                 let context: &ImplicitCtxt<'_, '_, '_> = mem::transmute(context);\n                 f(context)\n             }\n@@ -2993,6 +2991,12 @@ impl<T, R, E> InternIteratorElement<T, R> for Result<T, E> {\n     }\n }\n \n+// We are comparing types with different invariant lifetimes, so `ptr::eq`\n+// won't work for us.\n+fn ptr_eq<T, U>(t: *const T, u: *const U) -> bool {\n+    t as *const () == u as *const ()\n+}\n+\n pub fn provide(providers: &mut ty::query::Providers<'_>) {\n     providers.in_scope_traits_map = |tcx, id| tcx.gcx.trait_map.get(&id).cloned();\n     providers.module_exports = |tcx, id| tcx.gcx.export_map.get(&id).cloned();"}, {"sha": "c8b7216e29778bc4db10ccaffc743274f15b48ea", "filename": "src/librustc_codegen_ssa/mir/rvalue.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_codegen_ssa%2Fmir%2Frvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_codegen_ssa%2Fmir%2Frvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Frvalue.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -257,7 +257,8 @@ impl<'a, 'tcx: 'a, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                             }\n                         }\n                     }\n-                    mir::CastKind::Misc if bx.cx().is_backend_scalar_pair(operand.layout) => {\n+                    mir::CastKind::MutToConstPointer\n+                    | mir::CastKind::Misc if bx.cx().is_backend_scalar_pair(operand.layout) => {\n                         if let OperandValue::Pair(data_ptr, meta) = operand.val {\n                             if bx.cx().is_backend_scalar_pair(cast) {\n                                 let data_cast = bx.pointercast(data_ptr,\n@@ -274,7 +275,8 @@ impl<'a, 'tcx: 'a, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                             bug!(\"Unexpected non-Pair operand\")\n                         }\n                     }\n-                    mir::CastKind::Misc => {\n+                    mir::CastKind::MutToConstPointer\n+                    | mir::CastKind::Misc => {\n                         assert!(bx.cx().is_backend_immediate(cast));\n                         let ll_t_out = bx.cx().immediate_backend_type(cast);\n                         if operand.layout.abi.is_uninhabited() {"}, {"sha": "6b948e40bfbb843372c157658b63d497b4f55650", "filename": "src/librustc_mir/borrow_check/nll/type_check/mod.rs", "status": "modified", "additions": 112, "deletions": 1, "changes": 113, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fmod.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -1984,7 +1984,118 @@ impl<'a, 'gcx, 'tcx> TypeChecker<'a, 'gcx, 'tcx> {\n                         );\n                     }\n \n-                    CastKind::Misc => {}\n+                    CastKind::MutToConstPointer => {\n+                        let ty_from = match op.ty(mir, tcx).sty {\n+                            ty::RawPtr(ty::TypeAndMut {\n+                                ty: ty_from,\n+                                mutbl: hir::MutMutable,\n+                            }) => ty_from,\n+                            _ => {\n+                                span_mirbug!(\n+                                    self,\n+                                    rvalue,\n+                                    \"unexpected base type for cast {:?}\",\n+                                    ty,\n+                                );\n+                                return;\n+                            }\n+                        };\n+                        let ty_to = match ty.sty {\n+                            ty::RawPtr(ty::TypeAndMut {\n+                                ty: ty_to,\n+                                mutbl: hir::MutImmutable,\n+                            }) => ty_to,\n+                            _ => {\n+                                span_mirbug!(\n+                                    self,\n+                                    rvalue,\n+                                    \"unexpected target type for cast {:?}\",\n+                                    ty,\n+                                );\n+                                return;\n+                            }\n+                        };\n+                        if let Err(terr) = self.sub_types(\n+                            ty_from,\n+                            ty_to,\n+                            location.to_locations(),\n+                            ConstraintCategory::Cast,\n+                        ) {\n+                            span_mirbug!(\n+                                self,\n+                                rvalue,\n+                                \"relating {:?} with {:?} yields {:?}\",\n+                                ty_from,\n+                                ty_to,\n+                                terr\n+                            )\n+                        }\n+                    }\n+\n+                    CastKind::Misc => {\n+                        if let ty::Ref(_, mut ty_from, _) = op.ty(mir, tcx).sty {\n+                            let (mut ty_to, mutability) = if let ty::RawPtr(ty::TypeAndMut {\n+                                ty: ty_to,\n+                                mutbl,\n+                            }) = ty.sty {\n+                                (ty_to, mutbl)\n+                            } else {\n+                                span_mirbug!(\n+                                    self,\n+                                    rvalue,\n+                                    \"invalid cast types {:?} -> {:?}\",\n+                                    op.ty(mir, tcx),\n+                                    ty,\n+                                );\n+                                return;\n+                            };\n+\n+                            // Handle the direct cast from `&[T; N]` to `*const T` by unwrapping\n+                            // any array we find.\n+                            while let ty::Array(ty_elem_from, _) = ty_from.sty {\n+                                ty_from = ty_elem_from;\n+                                if let ty::Array(ty_elem_to, _) = ty_to.sty {\n+                                    ty_to = ty_elem_to;\n+                                } else {\n+                                    break;\n+                                }\n+                            }\n+\n+                            if let hir::MutMutable = mutability {\n+                                if let Err(terr) = self.eq_types(\n+                                    ty_from,\n+                                    ty_to,\n+                                    location.to_locations(),\n+                                    ConstraintCategory::Cast,\n+                                ) {\n+                                    span_mirbug!(\n+                                        self,\n+                                        rvalue,\n+                                        \"equating {:?} with {:?} yields {:?}\",\n+                                        ty_from,\n+                                        ty_to,\n+                                        terr\n+                                    )\n+                                }\n+                            } else {\n+                                if let Err(terr) = self.sub_types(\n+                                    ty_from,\n+                                    ty_to,\n+                                    location.to_locations(),\n+                                    ConstraintCategory::Cast,\n+                                ) {\n+                                    span_mirbug!(\n+                                        self,\n+                                        rvalue,\n+                                        \"relating {:?} with {:?} yields {:?}\",\n+                                        ty_from,\n+                                        ty_to,\n+                                        terr\n+                                    )\n+                                }\n+                            }\n+                        }\n+                    }\n                 }\n             }\n "}, {"sha": "7f30d9f92514d9d78439ac3c8cdee0509d1641b5", "filename": "src/librustc_mir/build/expr/as_place.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_place.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_place.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_place.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -196,6 +196,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n             | ExprKind::ReifyFnPointer { .. }\n             | ExprKind::ClosureFnPointer { .. }\n             | ExprKind::UnsafeFnPointer { .. }\n+            | ExprKind::MutToConstPointer { .. }\n             | ExprKind::Unsize { .. }\n             | ExprKind::Repeat { .. }\n             | ExprKind::Borrow { .. }"}, {"sha": "6fa7393ee53e56a92919a84845ddfa86bbad8feb", "filename": "src/librustc_mir/build/expr/as_rvalue.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_rvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_rvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_rvalue.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -142,8 +142,6 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                 block.and(Rvalue::Use(Operand::Move(Place::Local(result))))\n             }\n             ExprKind::Cast { source } => {\n-                let source = this.hir.mirror(source);\n-\n                 let source = unpack!(block = this.as_operand(block, scope, source));\n                 block.and(Rvalue::Cast(CastKind::Misc, source, expr.ty))\n             }\n@@ -163,6 +161,10 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                 let source = unpack!(block = this.as_operand(block, scope, source));\n                 block.and(Rvalue::Cast(CastKind::ClosureFnPointer, source, expr.ty))\n             }\n+            ExprKind::MutToConstPointer { source } => {\n+                let source = unpack!(block = this.as_operand(block, scope, source));\n+                block.and(Rvalue::Cast(CastKind::MutToConstPointer, source, expr.ty))\n+            }\n             ExprKind::Unsize { source } => {\n                 let source = unpack!(block = this.as_operand(block, scope, source));\n                 block.and(Rvalue::Cast(CastKind::Unsize, source, expr.ty))"}, {"sha": "c8c30ac3ce4d075a0c2238e1193a844a4a2a2695", "filename": "src/librustc_mir/build/expr/category.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fcategory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fcategory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fcategory.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -62,6 +62,7 @@ impl Category {\n             | ExprKind::ReifyFnPointer { .. }\n             | ExprKind::ClosureFnPointer { .. }\n             | ExprKind::UnsafeFnPointer { .. }\n+            | ExprKind::MutToConstPointer { .. }\n             | ExprKind::Unsize { .. }\n             | ExprKind::Repeat { .. }\n             | ExprKind::Borrow { .. }"}, {"sha": "ed27fc38c2a06e683b4e0bb17ecb70820187f631", "filename": "src/librustc_mir/build/expr/into.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Finto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Finto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Finto.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -383,6 +383,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n             | ExprKind::ReifyFnPointer { .. }\n             | ExprKind::ClosureFnPointer { .. }\n             | ExprKind::UnsafeFnPointer { .. }\n+            | ExprKind::MutToConstPointer { .. }\n             | ExprKind::Unsize { .. }\n             | ExprKind::Repeat { .. }\n             | ExprKind::Borrow { .. }"}, {"sha": "a08be74afbe83c61cf7d2ee3a9377ac1679eba5c", "filename": "src/librustc_mir/hair/cx/expr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -88,7 +88,7 @@ fn apply_adjustment<'a, 'gcx, 'tcx>(cx: &mut Cx<'a, 'gcx, 'tcx>,\n             ExprKind::NeverToAny { source: expr.to_ref() }\n         }\n         Adjust::MutToConstPointer => {\n-            ExprKind::Cast { source: expr.to_ref() }\n+            ExprKind::MutToConstPointer { source: expr.to_ref() }\n         }\n         Adjust::Deref(None) => {\n             // Adjust the span from the block, to the last expression of the"}, {"sha": "966549b42fa952bb50d455343ec4868222a52e49", "filename": "src/librustc_mir/hair/mod.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fhair%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Fhair%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fmod.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -190,6 +190,9 @@ pub enum ExprKind<'tcx> {\n     UnsafeFnPointer {\n         source: ExprRef<'tcx>,\n     },\n+    MutToConstPointer {\n+        source: ExprRef<'tcx>,\n+    },\n     Unsize {\n         source: ExprRef<'tcx>,\n     },"}, {"sha": "73c73cc23dcf0cc90dd98f0440075c0882aab228", "filename": "src/librustc_mir/interpret/cast.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Finterpret%2Fcast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Finterpret%2Fcast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fcast.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -33,7 +33,7 @@ impl<'a, 'mir, 'tcx, M: Machine<'a, 'mir, 'tcx>> EvalContext<'a, 'mir, 'tcx, M>\n                 self.unsize_into(src, dest)?;\n             }\n \n-            Misc => {\n+            Misc | MutToConstPointer => {\n                 let src = self.read_immediate(src)?;\n \n                 if self.type_is_fat_ptr(src.layout.ty) {"}, {"sha": "fb4c64bd5f55fd377056ea82260dbfcb142288d1", "filename": "src/librustc_mir/transform/qualify_consts.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -1091,6 +1091,7 @@ impl<'a, 'tcx> Visitor<'tcx> for Checker<'a, 'tcx> {\n             Rvalue::Cast(CastKind::UnsafeFnPointer, ..) |\n             Rvalue::Cast(CastKind::ClosureFnPointer, ..) |\n             Rvalue::Cast(CastKind::Unsize, ..) |\n+            Rvalue::Cast(CastKind::MutToConstPointer, ..) |\n             Rvalue::Discriminant(..) |\n             Rvalue::Len(_) |\n             Rvalue::Ref(..) |"}, {"sha": "d0d627549930379d7fd5618fb92f72bdb7f5ebe3", "filename": "src/librustc_mir/transform/qualify_min_const_fn.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Ftransform%2Fqualify_min_const_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Flibrustc_mir%2Ftransform%2Fqualify_min_const_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fqualify_min_const_fn.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -152,6 +152,9 @@ fn check_rvalue(\n                 _ => check_operand(tcx, mir, operand, span),\n             }\n         }\n+        Rvalue::Cast(CastKind::MutToConstPointer, operand, _) => {\n+            check_operand(tcx, mir, operand, span)\n+        }\n         Rvalue::Cast(CastKind::UnsafeFnPointer, _, _) |\n         Rvalue::Cast(CastKind::ClosureFnPointer, _, _) |\n         Rvalue::Cast(CastKind::ReifyFnPointer, _, _) => Err(("}, {"sha": "b6a25eddb866d337e3a446337940d3b4232a9499", "filename": "src/test/ui/nll/type-check-pointer-coercions.rs", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Ftest%2Fui%2Fnll%2Ftype-check-pointer-coercions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Ftest%2Fui%2Fnll%2Ftype-check-pointer-coercions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Ftype-check-pointer-coercions.rs?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -0,0 +1,39 @@\n+#![feature(nll)]\n+\n+fn shared_to_const<'a, 'b>(x: &&'a i32) -> *const &'b i32 {\n+    x   //~ ERROR\n+}\n+\n+fn unique_to_const<'a, 'b>(x: &mut &'a i32) -> *const &'b i32 {\n+    x   //~ ERROR\n+}\n+\n+fn unique_to_mut<'a, 'b>(x: &mut &'a i32) -> *mut &'b i32 {\n+    // Two errors because *mut is invariant\n+    x   //~ ERROR\n+        //~| ERROR\n+}\n+\n+fn mut_to_const<'a, 'b>(x: *mut &'a i32) -> *const &'b i32 {\n+    x   //~ ERROR\n+}\n+\n+fn array_elem<'a, 'b>(x: &'a i32) -> *const &'b i32 {\n+    let z = &[x; 3];\n+    let y = z as *const &i32;\n+    y   //~ ERROR\n+}\n+\n+fn array_coerce<'a, 'b>(x: &'a i32) -> *const [&'b i32; 3] {\n+    let z = &[x; 3];\n+    let y = z as *const [&i32; 3];\n+    y   //~ ERROR\n+}\n+\n+fn nested_array<'a, 'b>(x: &'a i32) -> *const [&'b i32; 2] {\n+    let z = &[[x; 2]; 3];\n+    let y = z as *const [&i32; 2];\n+    y   //~ ERROR\n+}\n+\n+fn main() {}"}, {"sha": "3b8d99421242e7e0f153596b4a6892ec82e095b3", "filename": "src/test/ui/nll/type-check-pointer-coercions.stderr", "status": "added", "additions": 87, "deletions": 0, "changes": 87, "blob_url": "https://github.com/rust-lang/rust/blob/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Ftest%2Fui%2Fnll%2Ftype-check-pointer-coercions.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7d01aa8a4815207d83664353895ac168b7564e4b/src%2Ftest%2Fui%2Fnll%2Ftype-check-pointer-coercions.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Ftype-check-pointer-coercions.stderr?ref=7d01aa8a4815207d83664353895ac168b7564e4b", "patch": "@@ -0,0 +1,87 @@\n+error: lifetime may not live long enough\n+  --> $DIR/type-check-pointer-coercions.rs:4:5\n+   |\n+LL | fn shared_to_const<'a, 'b>(x: &&'a i32) -> *const &'b i32 {\n+   |                    --  -- lifetime `'b` defined here\n+   |                    |\n+   |                    lifetime `'a` defined here\n+LL |     x   //~ ERROR\n+   |     ^ returning this value requires that `'a` must outlive `'b`\n+\n+error: lifetime may not live long enough\n+  --> $DIR/type-check-pointer-coercions.rs:8:5\n+   |\n+LL | fn unique_to_const<'a, 'b>(x: &mut &'a i32) -> *const &'b i32 {\n+   |                    --  -- lifetime `'b` defined here\n+   |                    |\n+   |                    lifetime `'a` defined here\n+LL |     x   //~ ERROR\n+   |     ^ returning this value requires that `'a` must outlive `'b`\n+\n+error: lifetime may not live long enough\n+  --> $DIR/type-check-pointer-coercions.rs:13:5\n+   |\n+LL | fn unique_to_mut<'a, 'b>(x: &mut &'a i32) -> *mut &'b i32 {\n+   |                  --  -- lifetime `'b` defined here\n+   |                  |\n+   |                  lifetime `'a` defined here\n+LL |     // Two errors because *mut is invariant\n+LL |     x   //~ ERROR\n+   |     ^ function was supposed to return data with lifetime `'a` but it is returning data with lifetime `'b`\n+\n+error: lifetime may not live long enough\n+  --> $DIR/type-check-pointer-coercions.rs:13:5\n+   |\n+LL | fn unique_to_mut<'a, 'b>(x: &mut &'a i32) -> *mut &'b i32 {\n+   |                  --  -- lifetime `'b` defined here\n+   |                  |\n+   |                  lifetime `'a` defined here\n+LL |     // Two errors because *mut is invariant\n+LL |     x   //~ ERROR\n+   |     ^ returning this value requires that `'a` must outlive `'b`\n+\n+error: lifetime may not live long enough\n+  --> $DIR/type-check-pointer-coercions.rs:18:5\n+   |\n+LL | fn mut_to_const<'a, 'b>(x: *mut &'a i32) -> *const &'b i32 {\n+   |                 --  -- lifetime `'b` defined here\n+   |                 |\n+   |                 lifetime `'a` defined here\n+LL |     x   //~ ERROR\n+   |     ^ returning this value requires that `'a` must outlive `'b`\n+\n+error: lifetime may not live long enough\n+  --> $DIR/type-check-pointer-coercions.rs:24:5\n+   |\n+LL | fn array_elem<'a, 'b>(x: &'a i32) -> *const &'b i32 {\n+   |               --  -- lifetime `'b` defined here\n+   |               |\n+   |               lifetime `'a` defined here\n+...\n+LL |     y   //~ ERROR\n+   |     ^ returning this value requires that `'a` must outlive `'b`\n+\n+error: lifetime may not live long enough\n+  --> $DIR/type-check-pointer-coercions.rs:30:5\n+   |\n+LL | fn array_coerce<'a, 'b>(x: &'a i32) -> *const [&'b i32; 3] {\n+   |                 --  -- lifetime `'b` defined here\n+   |                 |\n+   |                 lifetime `'a` defined here\n+...\n+LL |     y   //~ ERROR\n+   |     ^ returning this value requires that `'a` must outlive `'b`\n+\n+error: lifetime may not live long enough\n+  --> $DIR/type-check-pointer-coercions.rs:36:5\n+   |\n+LL | fn nested_array<'a, 'b>(x: &'a i32) -> *const [&'b i32; 2] {\n+   |                 --  -- lifetime `'b` defined here\n+   |                 |\n+   |                 lifetime `'a` defined here\n+...\n+LL |     y   //~ ERROR\n+   |     ^ returning this value requires that `'a` must outlive `'b`\n+\n+error: aborting due to 8 previous errors\n+"}]}