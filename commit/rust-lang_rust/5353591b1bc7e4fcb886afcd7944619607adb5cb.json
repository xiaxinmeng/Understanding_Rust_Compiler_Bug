{"sha": "5353591b1bc7e4fcb886afcd7944619607adb5cb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUzNTM1OTFiMWJjN2U0ZmNiODg2YWZjZDc5NDQ2MTk2MDdhZGI1Y2I=", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2020-12-18T13:14:15Z"}, "committer": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2021-01-23T01:18:11Z"}, "message": "cargo dev crater: work on downloading and extracting crate sources", "tree": {"sha": "c4c445e85b91c662cba4d2389398797681c98c11", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c4c445e85b91c662cba4d2389398797681c98c11"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5353591b1bc7e4fcb886afcd7944619607adb5cb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5353591b1bc7e4fcb886afcd7944619607adb5cb", "html_url": "https://github.com/rust-lang/rust/commit/5353591b1bc7e4fcb886afcd7944619607adb5cb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5353591b1bc7e4fcb886afcd7944619607adb5cb/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bec916d02dc3e330e0dc055080207d708978b41d", "url": "https://api.github.com/repos/rust-lang/rust/commits/bec916d02dc3e330e0dc055080207d708978b41d", "html_url": "https://github.com/rust-lang/rust/commit/bec916d02dc3e330e0dc055080207d708978b41d"}], "stats": {"total": 46, "additions": 38, "deletions": 8}, "files": [{"sha": "517e9d250bca5e9543d218a8d28aa25d6c8de596", "filename": "clippy_dev/Cargo.toml", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5353591b1bc7e4fcb886afcd7944619607adb5cb/clippy_dev%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/5353591b1bc7e4fcb886afcd7944619607adb5cb/clippy_dev%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2FCargo.toml?ref=5353591b1bc7e4fcb886afcd7944619607adb5cb", "patch": "@@ -1,16 +1,19 @@\n [package]\n-name = \"clippy_dev\"\n-version = \"0.0.1\"\n authors = [\"Philipp Hansch <dev@phansch.net>\"]\n edition = \"2018\"\n+name = \"clippy_dev\"\n+version = \"0.0.1\"\n \n [dependencies]\n bytecount = \"0.6\"\n clap = \"2.33\"\n+flate2 = \"1.0.19\"\n itertools = \"0.9\"\n opener = \"0.4\"\n regex = \"1\"\n shell-escape = \"0.1\"\n+tar = \"0.4.30\"\n+ureq = \"2.0.0-rc3\"\n walkdir = \"2\"\n \n [features]"}, {"sha": "22b04242885f0e6a6ad1a83b67151f98e9321633", "filename": "clippy_dev/src/crater.rs", "status": "modified", "additions": 33, "deletions": 6, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/5353591b1bc7e4fcb886afcd7944619607adb5cb/clippy_dev%2Fsrc%2Fcrater.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5353591b1bc7e4fcb886afcd7944619607adb5cb/clippy_dev%2Fsrc%2Fcrater.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Fcrater.rs?ref=5353591b1bc7e4fcb886afcd7944619607adb5cb", "patch": "@@ -2,15 +2,18 @@ use std::path::PathBuf;\n use std::process::Command;\n \n // represents an archive we download from crates.io\n+#[derive(Debug)]\n struct KrateSource {\n     version: String,\n     name: String,\n }\n \n // represents the extracted sourcecode of a crate\n+#[derive(Debug)]\n struct Krate {\n     version: String,\n     name: String,\n+    path: PathBuf,\n }\n \n impl KrateSource {\n@@ -20,13 +23,34 @@ impl KrateSource {\n             name: name.into(),\n         }\n     }\n-    fn download_and_extract(self) -> Krate {\n+    fn download_and_extract(&self) -> Krate {\n+        let extract_dir = PathBuf::from(\"target/crater/crates\");\n+\n         // download\n+        let krate_download_dir = PathBuf::from(\"target/crater/downloads\");\n+\n+        let url = format!(\n+            \"https://crates.io/api/v1/crates/{}/{}/download\",\n+            self.name, self.version\n+        );\n+        print!(\"Downloading {}, {}\", self.name, self.version);\n+\n+        let krate_name = format!(\"{}-{}.crate\", &self.name, &self.version);\n+        let mut krate_dest = std::fs::File::create(krate_download_dir.join(krate_name)).unwrap();\n+        let mut krate_req = ureq::get(&url).call().unwrap().into_reader();\n+        std::io::copy(&mut krate_req, &mut krate_dest).unwrap();\n+\n         // extract\n+        let krate = krate_dest;\n+        let tar = flate2::read::GzDecoder::new(krate);\n+        let mut archiv = tar::Archive::new(tar);\n+        let extracted_path = extract_dir.join(format!(\"{}-{}/\", self.name, self.version));\n+        archiv.unpack(&extracted_path).expect(\"Failed to extract!\");\n \n         Krate {\n-            version: self.version,\n-            name: self.name,\n+            version: self.version.clone(),\n+            name: self.name.clone(),\n+            path: extracted_path,\n         }\n     }\n }\n@@ -35,8 +59,6 @@ impl Krate {\n     fn run_clippy_lints(&self) -> String {\n         todo!();\n     }\n-\n-\n }\n \n fn build_clippy() {\n@@ -65,5 +87,10 @@ pub(crate) fn run() {\n         \"target/debug/clippy-driver binary not found!\"\n     );\n \n-  let clippy_lint_results: Vec<String> = krates.into_iter().map(|krate|  krate.download_and_extract()).map(|krate| krate.run_clippy_lints()).collect::<Vec<String>>();\n+    // download and extract the crates, then run clippy on them and collect clippys warnings\n+    let clippy_lint_results: Vec<String> = krates\n+        .into_iter()\n+        .map(|krate| krate.download_and_extract())\n+        .map(|krate| krate.run_clippy_lints())\n+        .collect::<Vec<String>>();\n }"}]}