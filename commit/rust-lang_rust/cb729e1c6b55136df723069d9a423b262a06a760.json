{"sha": "cb729e1c6b55136df723069d9a423b262a06a760", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNiNzI5ZTFjNmI1NTEzNmRmNzIzMDY5ZDlhNDIzYjI2MmEwNmE3NjA=", "commit": {"author": {"name": "llogiq", "email": "bogusandre@gmail.com", "date": "2015-10-31T01:07:20Z"}, "committer": {"name": "llogiq", "email": "bogusandre@gmail.com", "date": "2015-10-31T01:07:20Z"}, "message": "Merge pull request #426 from Manishearth/fix-ptr-arg\n\nFix ptr-arg false positive for trait impls", "tree": {"sha": "88fc4c2803049b298fdbf84523ab7456e24f9144", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/88fc4c2803049b298fdbf84523ab7456e24f9144"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cb729e1c6b55136df723069d9a423b262a06a760", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cb729e1c6b55136df723069d9a423b262a06a760", "html_url": "https://github.com/rust-lang/rust/commit/cb729e1c6b55136df723069d9a423b262a06a760", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cb729e1c6b55136df723069d9a423b262a06a760/comments", "author": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "committer": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "555328cc7b93118ba8e65a29e24f133649fa022b", "url": "https://api.github.com/repos/rust-lang/rust/commits/555328cc7b93118ba8e65a29e24f133649fa022b", "html_url": "https://github.com/rust-lang/rust/commit/555328cc7b93118ba8e65a29e24f133649fa022b"}, {"sha": "dbb8a872a3aea4bb9510d109f5f7dbe5273446da", "url": "https://api.github.com/repos/rust-lang/rust/commits/dbb8a872a3aea4bb9510d109f5f7dbe5273446da", "html_url": "https://github.com/rust-lang/rust/commit/dbb8a872a3aea4bb9510d109f5f7dbe5273446da"}], "stats": {"total": 25, "additions": 23, "deletions": 2}, "files": [{"sha": "78a3c146c0f210eefc929932c25ebc8eb26037a4", "filename": "src/ptr_arg.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/cb729e1c6b55136df723069d9a423b262a06a760/src%2Fptr_arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb729e1c6b55136df723069d9a423b262a06a760/src%2Fptr_arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fptr_arg.rs?ref=cb729e1c6b55136df723069d9a423b262a06a760", "patch": "@@ -5,6 +5,7 @@\n use rustc::lint::*;\n use rustc_front::hir::*;\n use rustc::middle::ty;\n+use rustc::front::map::Node;\n \n use utils::{span_lint, match_type};\n use utils::{STRING_PATH, VEC_PATH};\n@@ -34,6 +35,11 @@ impl LateLintPass for PtrArg {\n \n     fn check_impl_item(&mut self, cx: &LateContext, item: &ImplItem) {\n         if let &MethodImplItem(ref sig, _) = &item.node {\n+            if let Some(Node::NodeItem(it)) = cx.tcx.map.find(cx.tcx.map.get_parent(item.id)) {\n+                if let ItemImpl(_, _, _, Some(_), _, _) = it.node {\n+                    return; // ignore trait impls\n+                }\n+            }\n             check_fn(cx, &sig.decl);\n         }\n     }\n@@ -47,8 +53,8 @@ impl LateLintPass for PtrArg {\n \n fn check_fn(cx: &LateContext, decl: &FnDecl) {\n     for arg in &decl.inputs {\n-        if let Some(pat_ty) = cx.tcx.pat_ty_opt(&arg.pat) {\n-            if let ty::TyRef(_, ty::TypeAndMut { ty, mutbl: MutImmutable }) = pat_ty.sty {\n+        if let Some(ty) = cx.tcx.ast_ty_to_ty_cache.borrow().get(&arg.ty.id) {\n+            if let ty::TyRef(_, ty::TypeAndMut { ty, mutbl: MutImmutable }) = ty.sty {\n                 if match_type(cx, ty, &VEC_PATH) {\n                     span_lint(cx, PTR_ARG, arg.ty.span,\n                               \"writing `&Vec<_>` instead of `&[_]` involves one more reference \\"}, {"sha": "e4971208747a77041916cf0646e80934613fa4e6", "filename": "tests/compile-fail/ptr_arg.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/cb729e1c6b55136df723069d9a423b262a06a760/tests%2Fcompile-fail%2Fptr_arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb729e1c6b55136df723069d9a423b262a06a760/tests%2Fcompile-fail%2Fptr_arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fptr_arg.rs?ref=cb729e1c6b55136df723069d9a423b262a06a760", "patch": "@@ -21,3 +21,18 @@ fn do_str_mut(x: &mut String) { // no error here\n \n fn main() {\n }\n+\n+trait Foo {\n+    type Item;\n+    fn do_vec(x: &Vec<i64>); //~ERROR writing `&Vec<_>`\n+    fn do_item(x: &Self::Item);\n+}\n+\n+struct Bar;\n+\n+// no error, in trait impl (#425)\n+impl Foo for Bar {\n+    type Item = Vec<u8>;\n+    fn do_vec(x: &Vec<i64>) {}\n+    fn do_item(x: &Vec<u8>) {}  \n+}"}]}