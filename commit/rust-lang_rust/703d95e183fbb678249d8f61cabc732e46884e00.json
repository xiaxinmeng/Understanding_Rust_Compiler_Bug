{"sha": "703d95e183fbb678249d8f61cabc732e46884e00", "node_id": "C_kwDOAAsO6NoAKDcwM2Q5NWUxODNmYmI2NzgyNDlkOGY2MWNhYmM3MzJlNDY4ODRlMDA", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-03T08:17:46Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-03T08:17:46Z"}, "message": "Auto merge of #105133 - oli-obk:promoted_def_ids, r=cjgillot\n\nEnsure query backtraces work for `DefId`s created after ast lowering\n\nr? `@cjgillot`", "tree": {"sha": "b0c489b9ab5610928cc980ca49484aee15d93b7f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0c489b9ab5610928cc980ca49484aee15d93b7f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/703d95e183fbb678249d8f61cabc732e46884e00", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/703d95e183fbb678249d8f61cabc732e46884e00", "html_url": "https://github.com/rust-lang/rust/commit/703d95e183fbb678249d8f61cabc732e46884e00", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/703d95e183fbb678249d8f61cabc732e46884e00/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "24f2704e96c9d3a4f887d2d0a7d79ecffd79bd65", "url": "https://api.github.com/repos/rust-lang/rust/commits/24f2704e96c9d3a4f887d2d0a7d79ecffd79bd65", "html_url": "https://github.com/rust-lang/rust/commit/24f2704e96c9d3a4f887d2d0a7d79ecffd79bd65"}, {"sha": "ab75d777de8e01d8e8265626654f24a8c971278d", "url": "https://api.github.com/repos/rust-lang/rust/commits/ab75d777de8e01d8e8265626654f24a8c971278d", "html_url": "https://github.com/rust-lang/rust/commit/ab75d777de8e01d8e8265626654f24a8c971278d"}], "stats": {"total": 43, "additions": 31, "deletions": 12}, "files": [{"sha": "dfef6ec70fcf772c5f1186200f76709dff5cd5e2", "filename": "compiler/rustc_ast_lowering/src/asm.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_ast_lowering%2Fsrc%2Fasm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_ast_lowering%2Fsrc%2Fasm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Fasm.rs?ref=703d95e183fbb678249d8f61cabc732e46884e00", "patch": "@@ -222,7 +222,12 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n                             // Wrap the expression in an AnonConst.\n                             let parent_def_id = self.current_hir_id_owner;\n                             let node_id = self.next_node_id();\n-                            self.create_def(parent_def_id.def_id, node_id, DefPathData::AnonConst);\n+                            self.create_def(\n+                                parent_def_id.def_id,\n+                                node_id,\n+                                DefPathData::AnonConst,\n+                                *op_sp,\n+                            );\n                             let anon_const = AnonConst { id: node_id, value: P(expr) };\n                             hir::InlineAsmOperand::SymFn {\n                                 anon_const: self.lower_anon_const(&anon_const),"}, {"sha": "87cc1708fc33b8f3bc6b58137bcc596d59f4b5a1", "filename": "compiler/rustc_ast_lowering/src/expr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs?ref=703d95e183fbb678249d8f61cabc732e46884e00", "patch": "@@ -365,7 +365,7 @@ impl<'hir> LoweringContext<'_, 'hir> {\n                 let node_id = self.next_node_id();\n \n                 // Add a definition for the in-band const def.\n-                self.create_def(parent_def_id.def_id, node_id, DefPathData::AnonConst);\n+                self.create_def(parent_def_id.def_id, node_id, DefPathData::AnonConst, f.span);\n \n                 let anon_const = AnonConst { id: node_id, value: arg };\n                 generic_args.push(AngleBracketedArg::Arg(GenericArg::Const(anon_const)));"}, {"sha": "0258f8fd2d9ab12ad7b1cf45b0abad80b954f526", "filename": "compiler/rustc_ast_lowering/src/lib.rs", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs?ref=703d95e183fbb678249d8f61cabc732e46884e00", "patch": "@@ -487,6 +487,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n         parent: LocalDefId,\n         node_id: ast::NodeId,\n         data: DefPathData,\n+        span: Span,\n     ) -> LocalDefId {\n         debug_assert_ne!(node_id, ast::DUMMY_NODE_ID);\n         assert!(\n@@ -497,7 +498,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n             self.tcx.hir().def_key(self.local_def_id(node_id)),\n         );\n \n-        let def_id = self.tcx.create_def(parent, data).def_id();\n+        let def_id = self.tcx.at(span).create_def(parent, data).def_id();\n \n         debug!(\"create_def: def_id_to_node_id[{:?}] <-> {:?}\", def_id, node_id);\n         self.resolver.node_id_to_def_id.insert(node_id, def_id);\n@@ -823,6 +824,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n                     self.current_hir_id_owner.def_id,\n                     param,\n                     DefPathData::LifetimeNs(kw::UnderscoreLifetime),\n+                    ident.span,\n                 );\n                 debug!(?_def_id);\n \n@@ -1151,15 +1153,16 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n \n                                 let parent_def_id = self.current_hir_id_owner;\n                                 let node_id = self.next_node_id();\n+                                let span = self.lower_span(ty.span);\n \n                                 // Add a definition for the in-band const def.\n                                 let def_id = self.create_def(\n                                     parent_def_id.def_id,\n                                     node_id,\n                                     DefPathData::AnonConst,\n+                                    span,\n                                 );\n \n-                                let span = self.lower_span(ty.span);\n                                 let path_expr = Expr {\n                                     id: ty.id,\n                                     kind: ExprKind::Path(qself.clone(), path.clone()),\n@@ -1353,12 +1356,13 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n                         itctx,\n                     ),\n                     ImplTraitContext::Universal => {\n+                        let span = t.span;\n                         self.create_def(\n                             self.current_hir_id_owner.def_id,\n                             *def_node_id,\n                             DefPathData::ImplTrait,\n+                            span,\n                         );\n-                        let span = t.span;\n                         let ident = Ident::from_str_and_span(&pprust::ty_to_string(t), span);\n                         let (param, bounds, path) =\n                             self.lower_generic_and_bounds(*def_node_id, span, ident, bounds);\n@@ -1455,6 +1459,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n             self.current_hir_id_owner.def_id,\n             opaque_ty_node_id,\n             DefPathData::ImplTrait,\n+            opaque_ty_span,\n         );\n         debug!(?opaque_ty_def_id);\n \n@@ -1608,6 +1613,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n                             parent_def_id,\n                             node_id,\n                             DefPathData::LifetimeNs(lifetime.ident.name),\n+                            lifetime.ident.span,\n                         );\n                         remapping.insert(old_def_id, new_def_id);\n \n@@ -1624,6 +1630,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n                             parent_def_id,\n                             node_id,\n                             DefPathData::LifetimeNs(kw::UnderscoreLifetime),\n+                            lifetime.ident.span,\n                         );\n                         remapping.insert(old_def_id, new_def_id);\n \n@@ -1806,7 +1813,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n         let fn_def_id = self.local_def_id(fn_node_id);\n \n         let opaque_ty_def_id =\n-            self.create_def(fn_def_id, opaque_ty_node_id, DefPathData::ImplTrait);\n+            self.create_def(fn_def_id, opaque_ty_node_id, DefPathData::ImplTrait, opaque_ty_span);\n \n         // When we create the opaque type for this async fn, it is going to have\n         // to capture all the lifetimes involved in the signature (including in the\n@@ -1866,6 +1873,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n                 opaque_ty_def_id,\n                 inner_node_id,\n                 DefPathData::LifetimeNs(ident.name),\n+                ident.span,\n             );\n             new_remapping.insert(outer_def_id, inner_def_id);\n "}, {"sha": "d6dea0e9f30fa06649c9de4cfb341cae9ffeaa96", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=703d95e183fbb678249d8f61cabc732e46884e00", "patch": "@@ -1109,6 +1109,7 @@ rustc_queries! {\n         desc { |tcx| \"looking up span for `{}`\", tcx.def_path_str(def_id) }\n         cache_on_disk_if { def_id.is_local() }\n         separate_provide_extern\n+        feedable\n     }\n \n     /// Gets the span for the identifier of the definition."}, {"sha": "c5683a9db94737402b8c5c9242b1eba9236dd842", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=703d95e183fbb678249d8f61cabc732e46884e00", "patch": "@@ -1507,7 +1507,9 @@ impl<'tcx> TyCtxt<'tcx> {\n             self.def_path(def_id).to_string_no_crate_verbose()\n         )\n     }\n+}\n \n+impl<'tcx> TyCtxtAt<'tcx> {\n     /// Create a new definition within the incr. comp. engine.\n     pub fn create_def(\n         self,\n@@ -1536,9 +1538,13 @@ impl<'tcx> TyCtxt<'tcx> {\n         // - this write will have happened before these queries are called.\n         let def_id = self.definitions.write().create_def(parent, data);\n \n-        TyCtxtFeed { tcx: self, def_id }\n+        let feed = TyCtxtFeed { tcx: self.tcx, def_id };\n+        feed.def_span(self.span);\n+        feed\n     }\n+}\n \n+impl<'tcx> TyCtxt<'tcx> {\n     pub fn iter_local_def_id(self) -> impl Iterator<Item = LocalDefId> + 'tcx {\n         // Create a dependency to the red node to be sure we re-execute this when the amount of\n         // definitions change."}, {"sha": "a7fd1754960ab8d901ead70b35f3e0ba26fcf106", "filename": "compiler/rustc_middle/src/ty/query.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery.rs?ref=703d95e183fbb678249d8f61cabc732e46884e00", "patch": "@@ -344,12 +344,10 @@ macro_rules! define_feedable {\n \n                 match cached {\n                     Ok(old) => {\n-                        assert_eq!(\n-                            value, old,\n-                            \"Trying to feed an already recorded value for query {} key={key:?}\",\n+                        bug!(\n+                            \"Trying to feed an already recorded value for query {} key={key:?}:\\nold value: {old:?}\\nnew value: {value:?}\",\n                             stringify!($name),\n                         );\n-                        return old;\n                     }\n                     Err(()) => (),\n                 }"}, {"sha": "30d28ff34550375ad50f0db0af318ab8c2fba13f", "filename": "compiler/rustc_query_system/src/dep_graph/graph.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_query_system%2Fsrc%2Fdep_graph%2Fgraph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/703d95e183fbb678249d8f61cabc732e46884e00/compiler%2Frustc_query_system%2Fsrc%2Fdep_graph%2Fgraph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fdep_graph%2Fgraph.rs?ref=703d95e183fbb678249d8f61cabc732e46884e00", "patch": "@@ -532,7 +532,8 @@ impl<K: DepKind> DepGraph<K> {\n             let mut edges = SmallVec::new();\n             K::read_deps(|task_deps| match task_deps {\n                 TaskDepsRef::Allow(deps) => edges.extend(deps.lock().reads.iter().copied()),\n-                TaskDepsRef::Ignore | TaskDepsRef::Forbid => {\n+                TaskDepsRef::Ignore => {} // During HIR lowering, we have no dependencies.\n+                TaskDepsRef::Forbid => {\n                     panic!(\"Cannot summarize when dependencies are not recorded.\")\n                 }\n             });"}]}