{"sha": "db1e49257e84f065bf14d547c36cb76178b03971", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRiMWU0OTI1N2U4NGYwNjViZjE0ZDU0N2MzNmNiNzYxNzhiMDM5NzE=", "commit": {"author": {"name": "Andy-Python-Programmer", "email": "andypythonappdeveloper@gmail.com", "date": "2021-07-14T09:19:27Z"}, "committer": {"name": "Andy-Python-Programmer", "email": "andypythonappdeveloper@gmail.com", "date": "2021-07-17T04:08:40Z"}, "message": "Use small code model for UEFI targets\n\n* Since the code model only applies to the code and not the data and the code model\nonly applies to functions you call through using `call`, `jmp` and data with `lea`, etc\u2026\n\nIf you are calling functions using the function pointers from the UEFI structures the code\nmodel does not apply in that case. It\u2019s just related to the address space size of your own binary.\nSince UEFI (uefi is all relocatable) uses relocatable PEs (relocatable code does not care about the\ncode model) so, we use the small code model here.\n\n* Since applications don't usually take gigabytes of memory, setting the\ntarget to use the small code model should result in better codegen (comparable\nwith majority of other targets).\n\nLarge code models are also known for generating horrible code, for\nexample 16 bytes of code to load a single 8-byte value.\n\n* Use the LLVM default code model for the architecture for the\nx86_64-unknown-uefi targets. For reference small is the default\ncode model on x86 in LLVM: <https://github.com/llvm/llvm-project/blob/7de2173c2a4c45711831cfee3ccf53690c76ff07/llvm/lib/Target/X86/X86TargetMachine.cpp#L204>\n\n* Remove the comments too as they are not UEFI-specific and applies\nto pretty much any target. I added them before as I was explicitily\nsetting the code model to small.\n\nSigned-off-by: Andy-Python-Programmer <andypythonappdeveloper@gmail.com>", "tree": {"sha": "0b78c42f1a77a775358a81acc80d395c96e9db34", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0b78c42f1a77a775358a81acc80d395c96e9db34"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/db1e49257e84f065bf14d547c36cb76178b03971", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEERh4YP5GYs6WFBkXNgOA1c0dVS4kFAmDyV/cACgkQgOA1c0dV\nS4mG2w/+N7DOXz1vjmOtsm/rHcjaJYJBjg1IcWESCxAQtIvOW2L1C9tH977GJAMk\n9A/SwNb03MkV24Qg3gDMrO0BeNgdppIuM12DhlZxlTRrtG+BSFb+vtYyc8tUSZ0R\nfuPmmi6kfZP8jxqGx4ricvCGf63k9qa1FRJ/L6TlInJ1v7ZjXRQgQPqVsY3fADtv\nJaJFeP3mRcAVh47akI5IVFTzV4lZGlBe+x2SpMJtW6g6cplmuMlkEPPK1zH832vT\ngIQbp3cjSk4YHAgN0EjTWl953HBNtz0RsDnNTgKrctcm0E5n1ItFy2agDTHjZoXm\nzk+b4p9bfyZYRU8/pcm+HF3KhCk+mxB6CaeNHHS6wIFankc11JkOHGic8bOLOdyl\ngqflnVExXo0KJuk6OReHcCzNdh9k2ESY1UZN2aXM0bgJljXomnOPYgSII9aGaR4M\nAk2KYKiMKAb0J94urNLHNRdpR69VbfgLfrycvQxDOCazta4uP7kZWQTEwafai68m\n4JtkRnnkJcdbITslG94UcIkxb3tWmXnN7xHiEwqXo80H07BmOYHkQ0V7nbVp3ymW\nO58sUMEWt1MGpfkgyyc+36Y2PBy/0ElT7PS8u25XSCHHfHimjEhNdvYAW6xTNJdx\n52QStrlEUsTDrAUBmBjvVNiYXAzHm0Smn+XyrWc8oHRHAxhWk+4=\n=3ieY\n-----END PGP SIGNATURE-----", "payload": "tree 0b78c42f1a77a775358a81acc80d395c96e9db34\nparent a08f25a7ef2800af5525762e981c24d96c14febe\nauthor Andy-Python-Programmer <andypythonappdeveloper@gmail.com> 1626254367 +1000\ncommitter Andy-Python-Programmer <andypythonappdeveloper@gmail.com> 1626494920 +1000\n\nUse small code model for UEFI targets\n\n* Since the code model only applies to the code and not the data and the code model\nonly applies to functions you call through using `call`, `jmp` and data with `lea`, etc\u2026\n\nIf you are calling functions using the function pointers from the UEFI structures the code\nmodel does not apply in that case. It\u2019s just related to the address space size of your own binary.\nSince UEFI (uefi is all relocatable) uses relocatable PEs (relocatable code does not care about the\ncode model) so, we use the small code model here.\n\n* Since applications don't usually take gigabytes of memory, setting the\ntarget to use the small code model should result in better codegen (comparable\nwith majority of other targets).\n\nLarge code models are also known for generating horrible code, for\nexample 16 bytes of code to load a single 8-byte value.\n\n* Use the LLVM default code model for the architecture for the\nx86_64-unknown-uefi targets. For reference small is the default\ncode model on x86 in LLVM: <https://github.com/llvm/llvm-project/blob/7de2173c2a4c45711831cfee3ccf53690c76ff07/llvm/lib/Target/X86/X86TargetMachine.cpp#L204>\n\n* Remove the comments too as they are not UEFI-specific and applies\nto pretty much any target. I added them before as I was explicitily\nsetting the code model to small.\n\nSigned-off-by: Andy-Python-Programmer <andypythonappdeveloper@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/db1e49257e84f065bf14d547c36cb76178b03971", "html_url": "https://github.com/rust-lang/rust/commit/db1e49257e84f065bf14d547c36cb76178b03971", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/db1e49257e84f065bf14d547c36cb76178b03971/comments", "author": {"login": "Andy-Python-Programmer", "id": 62820092, "node_id": "MDQ6VXNlcjYyODIwMDky", "avatar_url": "https://avatars.githubusercontent.com/u/62820092?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Andy-Python-Programmer", "html_url": "https://github.com/Andy-Python-Programmer", "followers_url": "https://api.github.com/users/Andy-Python-Programmer/followers", "following_url": "https://api.github.com/users/Andy-Python-Programmer/following{/other_user}", "gists_url": "https://api.github.com/users/Andy-Python-Programmer/gists{/gist_id}", "starred_url": "https://api.github.com/users/Andy-Python-Programmer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Andy-Python-Programmer/subscriptions", "organizations_url": "https://api.github.com/users/Andy-Python-Programmer/orgs", "repos_url": "https://api.github.com/users/Andy-Python-Programmer/repos", "events_url": "https://api.github.com/users/Andy-Python-Programmer/events{/privacy}", "received_events_url": "https://api.github.com/users/Andy-Python-Programmer/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Andy-Python-Programmer", "id": 62820092, "node_id": "MDQ6VXNlcjYyODIwMDky", "avatar_url": "https://avatars.githubusercontent.com/u/62820092?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Andy-Python-Programmer", "html_url": "https://github.com/Andy-Python-Programmer", "followers_url": "https://api.github.com/users/Andy-Python-Programmer/followers", "following_url": "https://api.github.com/users/Andy-Python-Programmer/following{/other_user}", "gists_url": "https://api.github.com/users/Andy-Python-Programmer/gists{/gist_id}", "starred_url": "https://api.github.com/users/Andy-Python-Programmer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Andy-Python-Programmer/subscriptions", "organizations_url": "https://api.github.com/users/Andy-Python-Programmer/orgs", "repos_url": "https://api.github.com/users/Andy-Python-Programmer/repos", "events_url": "https://api.github.com/users/Andy-Python-Programmer/events{/privacy}", "received_events_url": "https://api.github.com/users/Andy-Python-Programmer/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a08f25a7ef2800af5525762e981c24d96c14febe", "url": "https://api.github.com/repos/rust-lang/rust/commits/a08f25a7ef2800af5525762e981c24d96c14febe", "html_url": "https://github.com/rust-lang/rust/commit/a08f25a7ef2800af5525762e981c24d96c14febe"}], "stats": {"total": 8, "additions": 2, "deletions": 6}, "files": [{"sha": "be0e62bea0228055fd6be794f760415e48f4bf80", "filename": "compiler/rustc_target/src/spec/x86_64_unknown_uefi.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/db1e49257e84f065bf14d547c36cb76178b03971/compiler%2Frustc_target%2Fsrc%2Fspec%2Fx86_64_unknown_uefi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db1e49257e84f065bf14d547c36cb76178b03971/compiler%2Frustc_target%2Fsrc%2Fspec%2Fx86_64_unknown_uefi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fx86_64_unknown_uefi.rs?ref=db1e49257e84f065bf14d547c36cb76178b03971", "patch": "@@ -5,7 +5,7 @@\n // The win64 ABI is used. It differs from the sysv64 ABI, so we must use a windows target with\n // LLVM. \"x86_64-unknown-windows\" is used to get the minimal subset of windows-specific features.\n \n-use crate::spec::{CodeModel, Target};\n+use crate::spec::Target;\n \n pub fn target() -> Target {\n     let mut base = super::uefi_msvc_base::opts();\n@@ -19,15 +19,11 @@ pub fn target() -> Target {\n     // to leave these uninitialized, thus triggering exceptions if we make use of them. Which is\n     // why we avoid them and instead use soft-floats. This is also what GRUB and friends did so\n     // far.\n+    //\n     // If you initialize FP units yourself, you can override these flags with custom linker\n     // arguments, thus giving you access to full MMX/SSE acceleration.\n     base.features = \"-mmx,-sse,+soft-float\".to_string();\n \n-    // UEFI systems run without a host OS, hence we cannot assume any code locality. We must tell\n-    // LLVM to expect code to reference any address in the address-space. The \"large\" code-model\n-    // places no locality-restrictions, so it fits well here.\n-    base.code_model = Some(CodeModel::Large);\n-\n     Target {\n         llvm_target: \"x86_64-unknown-windows\".to_string(),\n         pointer_width: 64,"}]}