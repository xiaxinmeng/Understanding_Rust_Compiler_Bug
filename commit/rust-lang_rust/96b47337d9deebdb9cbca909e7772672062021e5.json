{"sha": "96b47337d9deebdb9cbca909e7772672062021e5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk2YjQ3MzM3ZDlkZWViZGI5Y2JjYTkwOWU3NzcyNjcyMDYyMDIxZTU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-06-30T14:00:24Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-06-30T14:00:24Z"}, "message": "Auto merge of #51828 - kennytm:no-simd-swap-for-mac, r=alexcrichton\n\nDo not allow LLVM to increase a TLS's alignment on macOS.\n\nThis addresses the various TLS segfault on macOS 10.10.\n\nFix #51794.\nFix #51758.\nFix #50867.\nFix #48866.\nFix #46355.\nFix #44056.", "tree": {"sha": "fa065105fbddb6fb9da3ce67e896355bf66559d4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fa065105fbddb6fb9da3ce67e896355bf66559d4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/96b47337d9deebdb9cbca909e7772672062021e5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/96b47337d9deebdb9cbca909e7772672062021e5", "html_url": "https://github.com/rust-lang/rust/commit/96b47337d9deebdb9cbca909e7772672062021e5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/96b47337d9deebdb9cbca909e7772672062021e5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bfc1ee4968ff5778cd80e12150f379ddfe6c2767", "url": "https://api.github.com/repos/rust-lang/rust/commits/bfc1ee4968ff5778cd80e12150f379ddfe6c2767", "html_url": "https://github.com/rust-lang/rust/commit/bfc1ee4968ff5778cd80e12150f379ddfe6c2767"}, {"sha": "e3d113eca91d639c697d925d9de38b5efde70c1b", "url": "https://api.github.com/repos/rust-lang/rust/commits/e3d113eca91d639c697d925d9de38b5efde70c1b", "html_url": "https://github.com/rust-lang/rust/commit/e3d113eca91d639c697d925d9de38b5efde70c1b"}], "stats": {"total": 99, "additions": 96, "deletions": 3}, "files": [{"sha": "199c40bb704ea3d62ec2e10e469b5a5a4bae5a94", "filename": "src/librustc_codegen_llvm/consts.rs", "status": "modified", "additions": 39, "deletions": 1, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/96b47337d9deebdb9cbca909e7772672062021e5/src%2Flibrustc_codegen_llvm%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96b47337d9deebdb9cbca909e7772672062021e5/src%2Flibrustc_codegen_llvm%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fconsts.rs?ref=96b47337d9deebdb9cbca909e7772672062021e5", "patch": "@@ -250,7 +250,7 @@ pub fn codegen_static<'a, 'tcx>(cx: &CodegenCx<'a, 'tcx>,\n     unsafe {\n         let g = get_static(cx, def_id);\n \n-        let v = match ::mir::codegen_static_initializer(cx, def_id) {\n+        let (v, alloc) = match ::mir::codegen_static_initializer(cx, def_id) {\n             Ok(v) => v,\n             // Error has already been reported\n             Err(_) => return,\n@@ -309,6 +309,44 @@ pub fn codegen_static<'a, 'tcx>(cx: &CodegenCx<'a, 'tcx>,\n \n         if attr::contains_name(attrs, \"thread_local\") {\n             llvm::set_thread_local_mode(g, cx.tls_model);\n+\n+            // Do not allow LLVM to change the alignment of a TLS on macOS.\n+            //\n+            // By default a global's alignment can be freely increased.\n+            // This allows LLVM to generate more performant instructions\n+            // e.g. using load-aligned into a SIMD register.\n+            //\n+            // However, on macOS 10.10 or below, the dynamic linker does not\n+            // respect any alignment given on the TLS (radar 24221680).\n+            // This will violate the alignment assumption, and causing segfault at runtime.\n+            //\n+            // This bug is very easy to trigger. In `println!` and `panic!`,\n+            // the `LOCAL_STDOUT`/`LOCAL_STDERR` handles are stored in a TLS,\n+            // which the values would be `mem::replace`d on initialization.\n+            // The implementation of `mem::replace` will use SIMD\n+            // whenever the size is 32 bytes or higher. LLVM notices SIMD is used\n+            // and tries to align `LOCAL_STDOUT`/`LOCAL_STDERR` to a 32-byte boundary,\n+            // which macOS's dyld disregarded and causing crashes\n+            // (see issues #51794, #51758, #50867, #48866 and #44056).\n+            //\n+            // To workaround the bug, we trick LLVM into not increasing\n+            // the global's alignment by explicitly assigning a section to it\n+            // (equivalent to automatically generating a `#[link_section]` attribute).\n+            // See the comment in the `GlobalValue::canIncreaseAlignment()` function\n+            // of `lib/IR/Globals.cpp` for why this works.\n+            //\n+            // When the alignment is not increased, the optimized `mem::replace`\n+            // will use load-unaligned instructions instead, and thus avoiding the crash.\n+            //\n+            // We could remove this hack whenever we decide to drop macOS 10.10 support.\n+            if cx.tcx.sess.target.target.options.is_like_osx {\n+                let sect_name = if alloc.bytes.iter().all(|b| *b == 0) {\n+                    CStr::from_bytes_with_nul_unchecked(b\"__DATA,__thread_bss\\0\")\n+                } else {\n+                    CStr::from_bytes_with_nul_unchecked(b\"__DATA,__thread_data\\0\")\n+                };\n+                llvm::LLVMSetSection(g, sect_name.as_ptr());\n+            }\n         }\n \n         base::set_link_section(cx, g, attrs);"}, {"sha": "d7939bd2ab224d547f35705e0957de4a9d80c696", "filename": "src/librustc_codegen_llvm/mir/constant.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/96b47337d9deebdb9cbca909e7772672062021e5/src%2Flibrustc_codegen_llvm%2Fmir%2Fconstant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96b47337d9deebdb9cbca909e7772672062021e5/src%2Flibrustc_codegen_llvm%2Fmir%2Fconstant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fmir%2Fconstant.rs?ref=96b47337d9deebdb9cbca909e7772672062021e5", "patch": "@@ -118,7 +118,7 @@ pub fn const_alloc_to_llvm(cx: &CodegenCx, alloc: &Allocation) -> ValueRef {\n pub fn codegen_static_initializer<'a, 'tcx>(\n     cx: &CodegenCx<'a, 'tcx>,\n     def_id: DefId)\n-    -> Result<ValueRef, Lrc<ConstEvalErr<'tcx>>>\n+    -> Result<(ValueRef, &'tcx Allocation), Lrc<ConstEvalErr<'tcx>>>\n {\n     let instance = ty::Instance::mono(cx.tcx, def_id);\n     let cid = GlobalId {\n@@ -132,7 +132,7 @@ pub fn codegen_static_initializer<'a, 'tcx>(\n         ConstValue::ByRef(alloc, n) if n.bytes() == 0 => alloc,\n         _ => bug!(\"static const eval returned {:#?}\", static_),\n     };\n-    Ok(const_alloc_to_llvm(cx, alloc))\n+    Ok((const_alloc_to_llvm(cx, alloc), alloc))\n }\n \n impl<'a, 'tcx> FunctionCx<'a, 'tcx> {"}, {"sha": "3235ef0bb3335134f6a250aa0d618b6b042504c1", "filename": "src/test/codegen/issue-44056-macos-tls-align.rs", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/96b47337d9deebdb9cbca909e7772672062021e5/src%2Ftest%2Fcodegen%2Fissue-44056-macos-tls-align.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96b47337d9deebdb9cbca909e7772672062021e5/src%2Ftest%2Fcodegen%2Fissue-44056-macos-tls-align.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fissue-44056-macos-tls-align.rs?ref=96b47337d9deebdb9cbca909e7772672062021e5", "patch": "@@ -0,0 +1,40 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// ignore-tidy-linelength\n+// only-macos\n+// no-system-llvm\n+// min-llvm-version 6.0\n+// compile-flags: -O\n+\n+#![crate_type = \"rlib\"]\n+#![feature(thread_local)]\n+\n+// CHECK: @STATIC_VAR_1 = internal thread_local unnamed_addr global <{ [32 x i8] }> zeroinitializer, section \"__DATA,__thread_bss\", align 4\n+#[no_mangle]\n+#[allow(private_no_mangle_statics)]\n+#[thread_local]\n+static mut STATIC_VAR_1: [u32; 8] = [0; 8];\n+\n+// CHECK: @STATIC_VAR_2 = internal thread_local unnamed_addr global <{ [32 x i8] }> <{{[^>]*}}>, section \"__DATA,__thread_data\", align 4\n+#[no_mangle]\n+#[allow(private_no_mangle_statics)]\n+#[thread_local]\n+static mut STATIC_VAR_2: [u32; 8] = [4; 8];\n+\n+#[no_mangle]\n+pub unsafe fn f(x: &mut [u32; 8]) {\n+    std::mem::swap(x, &mut STATIC_VAR_1)\n+}\n+\n+#[no_mangle]\n+pub unsafe fn g(x: &mut [u32; 8]) {\n+    std::mem::swap(x, &mut STATIC_VAR_2)\n+}"}, {"sha": "dcaa0bf86294a4f6a7aa3fe8209dc527ce739449", "filename": "src/test/run-pass/issue-44056.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/96b47337d9deebdb9cbca909e7772672062021e5/src%2Ftest%2Frun-pass%2Fissue-44056.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96b47337d9deebdb9cbca909e7772672062021e5/src%2Ftest%2Frun-pass%2Fissue-44056.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-44056.rs?ref=96b47337d9deebdb9cbca909e7772672062021e5", "patch": "@@ -0,0 +1,15 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// only-x86_64\n+// no-prefer-dynamic\n+// compile-flags: -Ctarget-feature=+avx -Clto\n+\n+fn main() {}"}]}