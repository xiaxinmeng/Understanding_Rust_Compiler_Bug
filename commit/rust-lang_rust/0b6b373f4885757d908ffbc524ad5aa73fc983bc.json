{"sha": "0b6b373f4885757d908ffbc524ad5aa73fc983bc", "node_id": "C_kwDOAAsO6NoAKDBiNmIzNzNmNDg4NTc1N2Q5MDhmZmJjNTI0YWQ1YWE3M2ZjOTgzYmM", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-02-25T19:53:10Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-25T19:53:10Z"}, "message": "Rollup merge of #108229 - lionellloh:issue-107049, r=Mark-Simulacrum\n\n[107049] Recognise top level keys in config.toml.example\n\nCloses #107049\n\nTest Plan\n\nConfigure changelog-seen\n```\nlionellloh@lionellloh-mbp rust % ./configure --set changelog-seen=1\nconfigure: processing command line\nconfigure:\nconfigure: changelog-seen       := 1\nconfigure: build.configure-args := ['--set', 'changelog-seen=1']\nconfigure:\nconfigure: writing `config.toml` in current directory\nconfigure:\nconfigure: run `python /Users/lionellloh/rust/x.py --help`\nlionellloh@lionellloh-mbp rust % diff config.toml config.toml.example\n16c16\n< changelog-seen = 1\n---\n> changelog-seen = 2\n331c331\n< configure-args = ['--set', 'changelog-seen=1']\n---\n> #configure-args = []\n675c675\n< [target.x86_64-apple-darwin]\n---\n> [target.x86_64-unknown-linux-gnu]\n809d808\n<\n```\n\nConfigure profile\n\n```\nlionellloh@lionellloh-mbp rust % ./configure --set profile=xyz\nconfigure: processing command line\nconfigure:\nconfigure: profile              := xyz\nconfigure: build.configure-args := ['--set', 'profile=xyz']\nconfigure:\nconfigure: writing `config.toml` in current directory\nconfigure:\nconfigure: run `python /Users/lionellloh/rust/x.py --help`\nlionellloh@lionellloh-mbp rust % diff config.toml config.toml.example\n26c26\n< profile = xyz\n---\n> #profile = <none>\n331c331\n< configure-args = ['--set', 'profile=xyz']\n---\n> #configure-args = []\n675c675\n< [target.x86_64-apple-darwin]\n---\n> [target.x86_64-unknown-linux-gnu]\n809d808\n<\n```", "tree": {"sha": "b49f714ea25191e7db4f36384cd80f1fcdd5b735", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b49f714ea25191e7db4f36384cd80f1fcdd5b735"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0b6b373f4885757d908ffbc524ad5aa73fc983bc", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj+mcmCRBK7hj4Ov3rIwAASOAIAG6gFqjkqXo9+Z9P6kGdrVV+\ncPWJnvZjj7ZqvT51A0LJ6qQMnoSdRe+37gESQQCkciZOo7YfzApaOfflA0cqqRf9\nz+F880A4GDRlwEb6CeSByP1b0Ljn41gOhwuSENjDzSVXTdTkNlVwuDbLs5DI80Vl\nXeH5Qoae6WWK5O0R0pfPgTOJRS7Erii+2/hcJpdCLTLWs3Y6I/s3XtiUl3WIEhou\n2lxXrV4DnBd9spt4fcABzKcskrRGhriupPgfKmCcwHhPvaPBKvrCty68nQV/gmE0\nyDU6cjQlSAKmtgN+HGrvSJk7yJqWvNc9xSEVs4Ug1Lj02ZC+NLxEv4U9h4eL7bs=\n=S0Yr\n-----END PGP SIGNATURE-----\n", "payload": "tree b49f714ea25191e7db4f36384cd80f1fcdd5b735\nparent cf049ac2af24eb899b38082d46cec491013b3175\nparent 5643706ca2ca59a47966c03104d4b8d931adb2dd\nauthor Michael Goulet <michael@errs.io> 1677354790 -0800\ncommitter GitHub <noreply@github.com> 1677354790 -0800\n\nRollup merge of #108229 - lionellloh:issue-107049, r=Mark-Simulacrum\n\n[107049] Recognise top level keys in config.toml.example\n\nCloses #107049\n\nTest Plan\n\nConfigure changelog-seen\n```\nlionellloh@lionellloh-mbp rust % ./configure --set changelog-seen=1\nconfigure: processing command line\nconfigure:\nconfigure: changelog-seen       := 1\nconfigure: build.configure-args := ['--set', 'changelog-seen=1']\nconfigure:\nconfigure: writing `config.toml` in current directory\nconfigure:\nconfigure: run `python /Users/lionellloh/rust/x.py --help`\nlionellloh@lionellloh-mbp rust % diff config.toml config.toml.example\n16c16\n< changelog-seen = 1\n---\n> changelog-seen = 2\n331c331\n< configure-args = ['--set', 'changelog-seen=1']\n---\n> #configure-args = []\n675c675\n< [target.x86_64-apple-darwin]\n---\n> [target.x86_64-unknown-linux-gnu]\n809d808\n<\n```\n\nConfigure profile\n\n```\nlionellloh@lionellloh-mbp rust % ./configure --set profile=xyz\nconfigure: processing command line\nconfigure:\nconfigure: profile              := xyz\nconfigure: build.configure-args := ['--set', 'profile=xyz']\nconfigure:\nconfigure: writing `config.toml` in current directory\nconfigure:\nconfigure: run `python /Users/lionellloh/rust/x.py --help`\nlionellloh@lionellloh-mbp rust % diff config.toml config.toml.example\n26c26\n< profile = xyz\n---\n> #profile = <none>\n331c331\n< configure-args = ['--set', 'profile=xyz']\n---\n> #configure-args = []\n675c675\n< [target.x86_64-apple-darwin]\n---\n> [target.x86_64-unknown-linux-gnu]\n809d808\n<\n```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0b6b373f4885757d908ffbc524ad5aa73fc983bc", "html_url": "https://github.com/rust-lang/rust/commit/0b6b373f4885757d908ffbc524ad5aa73fc983bc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0b6b373f4885757d908ffbc524ad5aa73fc983bc/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cf049ac2af24eb899b38082d46cec491013b3175", "url": "https://api.github.com/repos/rust-lang/rust/commits/cf049ac2af24eb899b38082d46cec491013b3175", "html_url": "https://github.com/rust-lang/rust/commit/cf049ac2af24eb899b38082d46cec491013b3175"}, {"sha": "5643706ca2ca59a47966c03104d4b8d931adb2dd", "url": "https://api.github.com/repos/rust-lang/rust/commits/5643706ca2ca59a47966c03104d4b8d931adb2dd", "html_url": "https://github.com/rust-lang/rust/commit/5643706ca2ca59a47966c03104d4b8d931adb2dd"}], "stats": {"total": 26, "additions": 21, "deletions": 5}, "files": [{"sha": "04e798e3949d9a5a9316e0e55aa3bee743121e4c", "filename": "src/bootstrap/configure.py", "status": "modified", "additions": 21, "deletions": 5, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/0b6b373f4885757d908ffbc524ad5aa73fc983bc/src%2Fbootstrap%2Fconfigure.py", "raw_url": "https://github.com/rust-lang/rust/raw/0b6b373f4885757d908ffbc524ad5aa73fc983bc/src%2Fbootstrap%2Fconfigure.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfigure.py?ref=0b6b373f4885757d908ffbc524ad5aa73fc983bc", "patch": "@@ -379,8 +379,14 @@ def set(key, value):\n sections[None] = []\n section_order = [None]\n targets = {}\n+top_level_keys = []\n \n for line in open(rust_dir + '/config.toml.example').read().split(\"\\n\"):\n+    if cur_section == None:\n+        if line.count('=') == 1:\n+            top_level_key = line.split('=')[0]\n+            top_level_key = top_level_key.strip(' #')\n+            top_level_keys.append(top_level_key)\n     if line.startswith('['):\n         cur_section = line[1:-1]\n         if cur_section.startswith('target'):\n@@ -459,12 +465,22 @@ def configure_section(lines, config):\n                 raise RuntimeError(\"failed to find config line for {}\".format(key))\n \n \n-for section_key in config:\n-    section_config = config[section_key]\n-    if section_key not in sections:\n-        raise RuntimeError(\"config key {} not in sections\".format(section_key))\n+def configure_top_level_key(lines, top_level_key, value):\n+    for i, line in enumerate(lines):\n+        if line.startswith('#' + top_level_key + ' = ') or line.startswith(top_level_key + ' = '):\n+            lines[i] = \"{} = {}\".format(top_level_key, value)\n+            return\n \n-    if section_key == 'target':\n+    raise RuntimeError(\"failed to find config line for {}\".format(top_level_key))\n+\n+\n+for section_key, section_config in config.items():\n+    if section_key not in sections and section_key not in top_level_keys:\n+        raise RuntimeError(\"config key {} not in sections or top_level_keys\".format(section_key))\n+    if section_key in top_level_keys:\n+        configure_top_level_key(sections[None], section_key, section_config)\n+\n+    elif  section_key == 'target':\n         for target in section_config:\n             configure_section(targets[target], section_config[target])\n     else:"}]}