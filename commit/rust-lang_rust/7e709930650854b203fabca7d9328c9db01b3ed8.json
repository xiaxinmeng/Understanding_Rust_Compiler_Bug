{"sha": "7e709930650854b203fabca7d9328c9db01b3ed8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdlNzA5OTMwNjUwODU0YjIwM2ZhYmNhN2Q5MzI4YzlkYjAxYjNlZDg=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-01-17T17:57:18Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-01-17T17:57:18Z"}, "message": "Rollup merge of #47427 - EdSchouten:cloudabi-ci, r=alexcrichton\n\nAdd a Docker container for doing automated builds for CloudABI.\n\nSetting up a cross compilation toolchain for CloudABI is relatively\neasy. It's just a matter of installing a somewhat recent version of\nClang (5.0 preferred) and installing the corresponding\n`${target}-cxx-runtime` package, containing a set of core C/C++ libraries\n(libc, libc++, libunwind, etc).\n\nEventually it would be nice if we could also run `x.py test`. That,\nhowever still requires some more work. Both libtest and compiletest\nwould need to be adjusted to deal with CloudABI's requirement of having\nall of an application's dependencies injected. Let's settle for just\ndoing `x.py dist` for now.", "tree": {"sha": "b535c507c06a63e08c1cdf90f8828cd36df5efaf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b535c507c06a63e08c1cdf90f8828cd36df5efaf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7e709930650854b203fabca7d9328c9db01b3ed8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7e709930650854b203fabca7d9328c9db01b3ed8", "html_url": "https://github.com/rust-lang/rust/commit/7e709930650854b203fabca7d9328c9db01b3ed8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7e709930650854b203fabca7d9328c9db01b3ed8/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "01749e1b3428aed5848f88c1307152a7912c2678", "url": "https://api.github.com/repos/rust-lang/rust/commits/01749e1b3428aed5848f88c1307152a7912c2678", "html_url": "https://github.com/rust-lang/rust/commit/01749e1b3428aed5848f88c1307152a7912c2678"}, {"sha": "dcf0cd0ac00a91afcc24e4c073dd99befa188091", "url": "https://api.github.com/repos/rust-lang/rust/commits/dcf0cd0ac00a91afcc24e4c073dd99befa188091", "html_url": "https://github.com/rust-lang/rust/commit/dcf0cd0ac00a91afcc24e4c073dd99befa188091"}], "stats": {"total": 72, "additions": 69, "deletions": 3}, "files": [{"sha": "d8f09bf47a4919bbcb852380381cb8841d02abb9", "filename": "src/ci/docker/dist-various-2/Dockerfile", "status": "modified", "additions": 14, "deletions": 3, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/7e709930650854b203fabca7d9328c9db01b3ed8/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/7e709930650854b203fabca7d9328c9db01b3ed8/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile?ref=7e709930650854b203fabca7d9328c9db01b3ed8", "patch": "@@ -1,4 +1,4 @@\n-FROM ubuntu:16.04\n+FROM ubuntu:17.10\n \n COPY scripts/cross-apt-packages.sh /scripts/\n RUN sh /scripts/cross-apt-packages.sh\n@@ -21,9 +21,12 @@ RUN apt-key adv --batch --yes --keyserver keyserver.ubuntu.com --recv-keys 74DA7\n RUN add-apt-repository -y 'deb http://apt.dilos.org/dilos dilos2-testing main'\n \n WORKDIR /tmp\n-COPY dist-various-2/shared.sh dist-various-2/build-fuchsia-toolchain.sh /tmp/\n-COPY dist-various-2/build-solaris-toolchain.sh /tmp/\n+COPY dist-various-2/shared.sh /tmp/\n+COPY dist-various-2/build-cloudabi-toolchain.sh /tmp/\n+RUN /tmp/build-cloudabi-toolchain.sh x86_64-unknown-cloudabi\n+COPY dist-various-2/build-fuchsia-toolchain.sh /tmp/\n RUN /tmp/build-fuchsia-toolchain.sh\n+COPY dist-various-2/build-solaris-toolchain.sh /tmp/\n RUN /tmp/build-solaris-toolchain.sh x86_64  amd64   solaris-i386\n RUN /tmp/build-solaris-toolchain.sh sparcv9 sparcv9 solaris-sparc\n \n@@ -44,12 +47,20 @@ ENV \\\n     CC_x86_64_sun_solaris=x86_64-sun-solaris2.10-gcc \\\n     CXX_x86_64_sun_solaris=x86_64-sun-solaris2.10-g++\n \n+# FIXME(EdSchouten): Remove this once cc \u22651.0.4 has been merged. It can\n+# automatically pick the right compiler path.\n+ENV \\\n+    AR_x86_64_unknown_cloudabi=x86_64-unknown-cloudabi-ar \\\n+    CC_x86_64_unknown_cloudabi=x86_64-unknown-cloudabi-clang \\\n+    CXX_x86_64_unknown_cloudabi=x86_64-unknown-cloudabi-clang++\n+\n ENV TARGETS=x86_64-unknown-fuchsia\n ENV TARGETS=$TARGETS,aarch64-unknown-fuchsia\n ENV TARGETS=$TARGETS,sparcv9-sun-solaris\n ENV TARGETS=$TARGETS,wasm32-unknown-unknown\n ENV TARGETS=$TARGETS,x86_64-sun-solaris\n ENV TARGETS=$TARGETS,x86_64-unknown-linux-gnux32\n+ENV TARGETS=$TARGETS,x86_64-unknown-cloudabi\n \n ENV RUST_CONFIGURE_ARGS --target=$TARGETS --enable-extended\n ENV SCRIPT python2.7 ../x.py dist --target $TARGETS"}, {"sha": "d64da4366399701498446545d683c6030c32c291", "filename": "src/ci/docker/dist-various-2/build-cloudabi-toolchain.sh", "status": "added", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/7e709930650854b203fabca7d9328c9db01b3ed8/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-cloudabi-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/7e709930650854b203fabca7d9328c9db01b3ed8/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-cloudabi-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-cloudabi-toolchain.sh?ref=7e709930650854b203fabca7d9328c9db01b3ed8", "patch": "@@ -0,0 +1,55 @@\n+#!/bin/bash\n+# Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+# file at the top-level directory of this distribution and at\n+# http://rust-lang.org/COPYRIGHT.\n+#\n+# Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+# http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+# <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+# option. This file may not be copied, modified, or distributed\n+# except according to those terms.\n+\n+set -eux\n+\n+# Install prerequisites.\n+apt-get update\n+apt-get install -y --no-install-recommends \\\n+  apt-transport-https \\\n+  ca-certificates \\\n+  clang-5.0 \\\n+  cmake \\\n+  curl \\\n+  file \\\n+  g++ \\\n+  gdb \\\n+  git \\\n+  lld-5.0 \\\n+  make \\\n+  python \\\n+  sudo \\\n+  xz-utils\n+\n+# Set up a Clang-based cross compiler toolchain.\n+# Based on the steps described at https://nuxi.nl/cloudabi/debian/\n+target=$1\n+for tool in ar nm objdump ranlib size; do\n+  ln -s ../lib/llvm-5.0/bin/llvm-${tool} /usr/bin/${target}-${tool}\n+done\n+ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-cc\n+ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-c++\n+ln -s ../lib/llvm-5.0/bin/lld /usr/bin/${target}-ld\n+ln -s ../../${target} /usr/lib/llvm-5.0/${target}\n+\n+# FIXME(EdSchouten): Remove this once cc \u22651.0.4 has been merged. It\n+# can make use of ${target}-cc and ${target}-c++, without incorrectly\n+# assuming it's MSVC.\n+ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-clang\n+ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-clang++\n+\n+# Install the C++ runtime libraries from CloudABI Ports.\n+echo deb https://nuxi.nl/distfiles/cloudabi-ports/debian/ cloudabi cloudabi > \\\n+    /etc/apt/sources.list.d/cloudabi.list\n+curl 'https://pgp.mit.edu/pks/lookup?op=get&search=0x0DA51B8531344B15' | \\\n+    apt-key add -\n+apt-get update\n+apt-get install -y $(echo ${target} | sed -e s/_/-/g)-cxx-runtime"}]}