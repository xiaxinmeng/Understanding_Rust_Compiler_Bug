{"sha": "940ec1e51725a63c80f42f02735e87a12c9c5edb", "node_id": "C_kwDOAAsO6NoAKDk0MGVjMWU1MTcyNWE2M2M4MGY0MmYwMjczNWU4N2ExMmM5YzVlZGI", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-07-29T05:44:05Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-07-29T05:44:05Z"}, "message": "Remove parent_pat from TopInfo", "tree": {"sha": "b23c10950413e24a02dc7710f7c9aa0bb3ae588d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b23c10950413e24a02dc7710f7c9aa0bb3ae588d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/940ec1e51725a63c80f42f02735e87a12c9c5edb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/940ec1e51725a63c80f42f02735e87a12c9c5edb", "html_url": "https://github.com/rust-lang/rust/commit/940ec1e51725a63c80f42f02735e87a12c9c5edb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/940ec1e51725a63c80f42f02735e87a12c9c5edb/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9de747483029ec3b0c050f7af0dc56765035ff98", "url": "https://api.github.com/repos/rust-lang/rust/commits/9de747483029ec3b0c050f7af0dc56765035ff98", "html_url": "https://github.com/rust-lang/rust/commit/9de747483029ec3b0c050f7af0dc56765035ff98"}], "stats": {"total": 54, "additions": 18, "deletions": 36}, "files": [{"sha": "837c323553c60e698349a6023a7162fae81824b7", "filename": "compiler/rustc_typeck/src/check/pat.rs", "status": "modified", "additions": 18, "deletions": 36, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/940ec1e51725a63c80f42f02735e87a12c9c5edb/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fpat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/940ec1e51725a63c80f42f02735e87a12c9c5edb/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fpat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fpat.rs?ref=940ec1e51725a63c80f42f02735e87a12c9c5edb", "patch": "@@ -72,22 +72,6 @@ struct TopInfo<'tcx> {\n     ///              found type `std::result::Result<_, _>`\n     /// ```\n     span: Option<Span>,\n-    /// This refers to the parent pattern. Used to provide extra diagnostic information on errors.\n-    /// ```text\n-    /// error[E0308]: mismatched types\n-    ///   --> $DIR/const-in-struct-pat.rs:8:17\n-    ///   |\n-    /// L | struct f;\n-    ///   | --------- unit struct defined here\n-    /// ...\n-    /// L |     let Thing { f } = t;\n-    ///   |                 ^\n-    ///   |                 |\n-    ///   |                 expected struct `std::string::String`, found struct `f`\n-    ///   |                 `f` is interpreted as a unit struct, not a new binding\n-    ///   |                 help: bind the struct field to a different name instead: `f: other_f`\n-    /// ```\n-    parent_pat: Option<&'tcx Pat<'tcx>>,\n }\n \n impl<'tcx> FnCtxt<'_, 'tcx> {\n@@ -147,7 +131,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         span: Option<Span>,\n         origin_expr: bool,\n     ) {\n-        let info = TopInfo { expected, origin_expr, span, parent_pat: None };\n+        let info = TopInfo { expected, origin_expr, span };\n         self.check_pat(pat, expected, INITIAL_BM, info);\n     }\n \n@@ -190,9 +174,8 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 self.check_pat_struct(pat, qpath, fields, has_rest_pat, expected, def_bm, ti)\n             }\n             PatKind::Or(pats) => {\n-                let parent_pat = Some(pat);\n                 for pat in pats {\n-                    self.check_pat(pat, expected, def_bm, TopInfo { parent_pat, ..ti });\n+                    self.check_pat(pat, expected, def_bm, ti);\n                 }\n                 expected\n             }\n@@ -621,7 +604,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         }\n \n         if let Some(p) = sub {\n-            self.check_pat(p, expected, def_bm, TopInfo { parent_pat: Some(pat), ..ti });\n+            self.check_pat(p, expected, def_bm, ti);\n         }\n \n         local_ty\n@@ -782,7 +765,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         let Some((variant, pat_ty)) = self.check_struct_path(qpath, pat.hir_id) else {\n             let err = self.tcx.ty_error();\n             for field in fields {\n-                let ti = TopInfo { parent_pat: Some(pat), ..ti };\n+                let ti = ti;\n                 self.check_pat(field.pat, err, def_bm, ti);\n             }\n             return err;\n@@ -799,11 +782,11 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         }\n     }\n \n-    fn check_pat_path<'b>(\n+    fn check_pat_path(\n         &self,\n-        pat: &Pat<'_>,\n+        pat: &Pat<'tcx>,\n         qpath: &hir::QPath<'_>,\n-        path_resolution: (Res, Option<Ty<'tcx>>, &'b [hir::PathSegment<'b>]),\n+        path_resolution: (Res, Option<Ty<'tcx>>, &'tcx [hir::PathSegment<'tcx>]),\n         expected: Ty<'tcx>,\n         ti: TopInfo<'tcx>,\n     ) -> Ty<'tcx> {\n@@ -837,7 +820,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         if let Some(err) =\n             self.demand_suptype_with_origin(&self.pattern_cause(ti, pat.span), expected, pat_ty)\n         {\n-            self.emit_bad_pat_path(err, pat.span, res, pat_res, pat_ty, segments, ti.parent_pat);\n+            self.emit_bad_pat_path(err, pat, res, pat_res, pat_ty, segments);\n         }\n         pat_ty\n     }\n@@ -876,16 +859,16 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         false\n     }\n \n-    fn emit_bad_pat_path<'b>(\n+    fn emit_bad_pat_path(\n         &self,\n         mut e: DiagnosticBuilder<'_, ErrorGuaranteed>,\n-        pat_span: Span,\n+        pat: &hir::Pat<'tcx>,\n         res: Res,\n         pat_res: Res,\n         pat_ty: Ty<'tcx>,\n-        segments: &'b [hir::PathSegment<'b>],\n-        parent_pat: Option<&Pat<'_>>,\n+        segments: &'tcx [hir::PathSegment<'tcx>],\n     ) {\n+        let pat_span = pat.span;\n         if let Some(span) = self.tcx.hir().res_span(pat_res) {\n             e.span_label(span, &format!(\"{} defined here\", res.descr()));\n             if let [hir::PathSegment { ident, .. }] = &*segments {\n@@ -898,8 +881,8 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                         res.descr(),\n                     ),\n                 );\n-                match parent_pat {\n-                    Some(Pat { kind: hir::PatKind::Struct(..), .. }) => {\n+                match self.tcx.hir().get(self.tcx.hir().get_parent_node(pat.hir_id)) {\n+                    hir::Node::Pat(Pat { kind: hir::PatKind::Struct(..), .. }) => {\n                         e.span_suggestion_verbose(\n                             ident.span.shrink_to_hi(),\n                             \"bind the struct field to a different name instead\",\n@@ -960,9 +943,8 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n     ) -> Ty<'tcx> {\n         let tcx = self.tcx;\n         let on_error = || {\n-            let parent_pat = Some(pat);\n             for pat in subpats {\n-                self.check_pat(pat, tcx.ty_error(), def_bm, TopInfo { parent_pat, ..ti });\n+                self.check_pat(pat, tcx.ty_error(), def_bm, ti);\n             }\n         };\n         let report_unexpected_res = |res: Res| {\n@@ -1046,7 +1028,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             };\n             for (i, subpat) in subpats.iter().enumerate_and_adjust(variant.fields.len(), ddpos) {\n                 let field_ty = self.field_ty(subpat.span, &variant.fields[i], substs);\n-                self.check_pat(subpat, field_ty, def_bm, TopInfo { parent_pat: Some(pat), ..ti });\n+                self.check_pat(subpat, field_ty, def_bm, ti);\n \n                 self.tcx.check_stability(\n                     variant.fields[i].did,\n@@ -1324,7 +1306,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 }\n             };\n \n-            self.check_pat(field.pat, field_ty, def_bm, TopInfo { parent_pat: Some(pat), ..ti });\n+            self.check_pat(field.pat, field_ty, def_bm, ti);\n         }\n \n         let mut unmentioned_fields = variant\n@@ -1936,7 +1918,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             let err = tcx.ty_error();\n             (err, err)\n         };\n-        self.check_pat(inner, inner_ty, def_bm, TopInfo { parent_pat: Some(pat), ..ti });\n+        self.check_pat(inner, inner_ty, def_bm, ti);\n         rptr_ty\n     }\n "}]}