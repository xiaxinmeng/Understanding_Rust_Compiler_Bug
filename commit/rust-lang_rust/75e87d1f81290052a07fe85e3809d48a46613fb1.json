{"sha": "75e87d1f81290052a07fe85e3809d48a46613fb1", "node_id": "C_kwDOAAsO6NoAKDc1ZTg3ZDFmODEyOTAwNTJhMDdmZTg1ZTM4MDlkNDhhNDY2MTNmYjE", "commit": {"author": {"name": "Nicholas Nethercote", "email": "n.nethercote@gmail.com", "date": "2023-01-30T05:29:52Z"}, "committer": {"name": "Nicholas Nethercote", "email": "n.nethercote@gmail.com", "date": "2023-02-01T04:14:05Z"}, "message": "Fix syntax in `-Zunpretty-expanded` output for derived `PartialEq`.\n\nIf you do `derive(PartialEq)` on a packed struct, the output shown by\n`-Zunpretty=expanded` includes expressions like this:\n```\n{ self.x } == { other.x }\n```\nThis is invalid syntax. This doesn't break compilation, because the AST\nnodes are constructed within the compiler. But it does mean anyone using\n`-Zunpretty=expanded` output as a guide for hand-written impls could get\na nasty surprise.\n\nThis commit fixes things by instead using this form:\n```\n({ self.x }) == ({ other.x })\n```", "tree": {"sha": "8633a95bf924cc7c67a4bbb0fda71d1d7526dab9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8633a95bf924cc7c67a4bbb0fda71d1d7526dab9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/75e87d1f81290052a07fe85e3809d48a46613fb1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/75e87d1f81290052a07fe85e3809d48a46613fb1", "html_url": "https://github.com/rust-lang/rust/commit/75e87d1f81290052a07fe85e3809d48a46613fb1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/75e87d1f81290052a07fe85e3809d48a46613fb1/comments", "author": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a322848c6b0e037c1f0209387558ecb6ab763714", "url": "https://api.github.com/repos/rust-lang/rust/commits/a322848c6b0e037c1f0209387558ecb6ab763714", "html_url": "https://github.com/rust-lang/rust/commit/a322848c6b0e037c1f0209387558ecb6ab763714"}], "stats": {"total": 34, "additions": 26, "deletions": 8}, "files": [{"sha": "bad47db0de1d4e16103d6724d786eb479d480ab7", "filename": "compiler/rustc_builtin_macros/src/deriving/cmp/partial_eq.rs", "status": "modified", "additions": 19, "deletions": 5, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/75e87d1f81290052a07fe85e3809d48a46613fb1/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fcmp%2Fpartial_eq.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75e87d1f81290052a07fe85e3809d48a46613fb1/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fcmp%2Fpartial_eq.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fcmp%2Fpartial_eq.rs?ref=75e87d1f81290052a07fe85e3809d48a46613fb1", "patch": "@@ -29,16 +29,30 @@ pub fn expand_deriving_partial_eq(\n                         cx.span_bug(field.span, \"not exactly 2 arguments in `derive(PartialEq)`\");\n                     };\n \n-                    // We received `&T` arguments. Convert them to `T` by\n-                    // stripping `&` or adding `*`. This isn't necessary for\n-                    // type checking, but it results in much better error\n-                    // messages if something goes wrong.\n+                    // We received arguments of type `&T`. Convert them to type `T` by stripping\n+                    // any leading `&` or adding `*`. This isn't necessary for type checking, but\n+                    // it results in better error messages if something goes wrong.\n+                    //\n+                    // Note: for arguments that look like `&{ x }`, which occur with packed\n+                    // structs, this would cause expressions like `{ self.x } == { other.x }`,\n+                    // which isn't valid Rust syntax. This wouldn't break compilation because these\n+                    // AST nodes are constructed within the compiler. But it would mean that code\n+                    // printed by `-Zunpretty=expanded` (or `cargo expand`) would have invalid\n+                    // syntax, which would be suboptimal. So we wrap these in parens, giving\n+                    // `({ self.x }) == ({ other.x })`, which is valid syntax.\n                     let convert = |expr: &P<Expr>| {\n                         if let ExprKind::AddrOf(BorrowKind::Ref, Mutability::Not, inner) =\n                             &expr.kind\n                         {\n-                            inner.clone()\n+                            if let ExprKind::Block(..) = &inner.kind {\n+                                // `&{ x }` form: remove the `&`, add parens.\n+                                cx.expr_paren(field.span, inner.clone())\n+                            } else {\n+                                // `&x` form: remove the `&`.\n+                                inner.clone()\n+                            }\n                         } else {\n+                            // No leading `&`: add a leading `*`.\n                             cx.expr_deref(field.span, expr.clone())\n                         }\n                     };"}, {"sha": "6cd56852f9d686942633ce3b258358c310d56469", "filename": "compiler/rustc_expand/src/build.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/75e87d1f81290052a07fe85e3809d48a46613fb1/compiler%2Frustc_expand%2Fsrc%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75e87d1f81290052a07fe85e3809d48a46613fb1/compiler%2Frustc_expand%2Fsrc%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fbuild.rs?ref=75e87d1f81290052a07fe85e3809d48a46613fb1", "patch": "@@ -272,6 +272,10 @@ impl<'a> ExtCtxt<'a> {\n         self.expr(sp, ast::ExprKind::AddrOf(ast::BorrowKind::Ref, ast::Mutability::Not, e))\n     }\n \n+    pub fn expr_paren(&self, sp: Span, e: P<ast::Expr>) -> P<ast::Expr> {\n+        self.expr(sp, ast::ExprKind::Paren(e))\n+    }\n+\n     pub fn expr_call(\n         &self,\n         span: Span,"}, {"sha": "8e238a509d2fd5193ac460241b91a1a763e4688c", "filename": "tests/ui/deriving/deriving-all-codegen.stdout", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/75e87d1f81290052a07fe85e3809d48a46613fb1/tests%2Fui%2Fderiving%2Fderiving-all-codegen.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/75e87d1f81290052a07fe85e3809d48a46613fb1/tests%2Fui%2Fderiving%2Fderiving-all-codegen.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fderiving%2Fderiving-all-codegen.stdout?ref=75e87d1f81290052a07fe85e3809d48a46613fb1", "patch": "@@ -209,7 +209,7 @@ impl ::core::marker::StructuralPartialEq for PackedPoint { }\n impl ::core::cmp::PartialEq for PackedPoint {\n     #[inline]\n     fn eq(&self, other: &PackedPoint) -> bool {\n-        { self.x } == { other.x } && { self.y } == { other.y }\n+        ({ self.x }) == ({ other.x }) && ({ self.y }) == ({ other.y })\n     }\n }\n #[automatically_derived]\n@@ -718,8 +718,8 @@ impl<T: ::core::cmp::PartialEq + ::core::marker::Copy + Trait,\n     ::core::marker::Copy {\n     #[inline]\n     fn eq(&self, other: &PackedGeneric<T, U>) -> bool {\n-        { self.0 } == { other.0 } && { self.1 } == { other.1 } &&\n-            { self.2 } == { other.2 }\n+        ({ self.0 }) == ({ other.0 }) && ({ self.1 }) == ({ other.1 }) &&\n+            ({ self.2 }) == ({ other.2 })\n     }\n }\n #[automatically_derived]"}]}