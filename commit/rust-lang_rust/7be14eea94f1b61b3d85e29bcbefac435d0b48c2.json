{"sha": "7be14eea94f1b61b3d85e29bcbefac435d0b48c2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdiZTE0ZWVhOTRmMWI2MWIzZDg1ZTI5YmNiZWZhYzQzNWQwYjQ4YzI=", "commit": {"author": {"name": "Corey Farwell", "email": "coreyf@rwell.org", "date": "2016-10-09T02:55:40Z"}, "committer": {"name": "Corey Farwell", "email": "coreyf@rwell.org", "date": "2016-10-09T04:17:46Z"}, "message": "Refactor away `load_or_return` macro.", "tree": {"sha": "57857561fc4bd7f9be6e06796d5261d1165d18d3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/57857561fc4bd7f9be6e06796d5261d1165d18d3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7be14eea94f1b61b3d85e29bcbefac435d0b48c2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7be14eea94f1b61b3d85e29bcbefac435d0b48c2", "html_url": "https://github.com/rust-lang/rust/commit/7be14eea94f1b61b3d85e29bcbefac435d0b48c2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7be14eea94f1b61b3d85e29bcbefac435d0b48c2/comments", "author": {"login": "frewsxcv", "id": 416575, "node_id": "MDQ6VXNlcjQxNjU3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/416575?v=4", "gravatar_id": "", "url": "https://api.github.com/users/frewsxcv", "html_url": "https://github.com/frewsxcv", "followers_url": "https://api.github.com/users/frewsxcv/followers", "following_url": "https://api.github.com/users/frewsxcv/following{/other_user}", "gists_url": "https://api.github.com/users/frewsxcv/gists{/gist_id}", "starred_url": "https://api.github.com/users/frewsxcv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/frewsxcv/subscriptions", "organizations_url": "https://api.github.com/users/frewsxcv/orgs", "repos_url": "https://api.github.com/users/frewsxcv/repos", "events_url": "https://api.github.com/users/frewsxcv/events{/privacy}", "received_events_url": "https://api.github.com/users/frewsxcv/received_events", "type": "User", "site_admin": false}, "committer": {"login": "frewsxcv", "id": 416575, "node_id": "MDQ6VXNlcjQxNjU3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/416575?v=4", "gravatar_id": "", "url": "https://api.github.com/users/frewsxcv", "html_url": "https://github.com/frewsxcv", "followers_url": "https://api.github.com/users/frewsxcv/followers", "following_url": "https://api.github.com/users/frewsxcv/following{/other_user}", "gists_url": "https://api.github.com/users/frewsxcv/gists{/gist_id}", "starred_url": "https://api.github.com/users/frewsxcv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/frewsxcv/subscriptions", "organizations_url": "https://api.github.com/users/frewsxcv/orgs", "repos_url": "https://api.github.com/users/frewsxcv/repos", "events_url": "https://api.github.com/users/frewsxcv/events{/privacy}", "received_events_url": "https://api.github.com/users/frewsxcv/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f410da5cbed620836df663a18350211093be686d", "url": "https://api.github.com/repos/rust-lang/rust/commits/f410da5cbed620836df663a18350211093be686d", "html_url": "https://github.com/rust-lang/rust/commit/f410da5cbed620836df663a18350211093be686d"}], "stats": {"total": 63, "additions": 37, "deletions": 26}, "files": [{"sha": "79e30b0d6aad31dee3aea4c35d36d1513ce910b1", "filename": "src/librustdoc/externalfiles.rs", "status": "modified", "additions": 26, "deletions": 23, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/7be14eea94f1b61b3d85e29bcbefac435d0b48c2/src%2Flibrustdoc%2Fexternalfiles.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7be14eea94f1b61b3d85e29bcbefac435d0b48c2/src%2Flibrustdoc%2Fexternalfiles.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fexternalfiles.rs?ref=7be14eea94f1b61b3d85e29bcbefac435d0b48c2", "patch": "@@ -43,38 +43,41 @@ impl ExternalHtml {\n     }\n }\n \n-pub fn load_string(input: &Path) -> io::Result<Option<String>> {\n-    let mut f = File::open(input)?;\n-    let mut d = Vec::new();\n-    f.read_to_end(&mut d)?;\n-    Ok(str::from_utf8(&d).map(|s| s.to_string()).ok())\n+pub enum LoadStringError {\n+    ReadFail,\n+    BadUtf8,\n }\n \n-macro_rules! load_or_return {\n-    ($input: expr, $cant_read: expr, $not_utf8: expr) => {\n-        {\n-            let input = Path::new(&$input[..]);\n-            match ::externalfiles::load_string(input) {\n-                Err(e) => {\n-                    let _ = writeln!(&mut io::stderr(),\n-                                     \"error reading `{}`: {}\", input.display(), e);\n-                    return $cant_read;\n-                }\n-                Ok(None) => {\n-                    let _ = writeln!(&mut io::stderr(),\n-                                     \"error reading `{}`: not UTF-8\", input.display());\n-                    return $not_utf8;\n-                }\n-                Ok(Some(s)) => s\n-            }\n+pub fn load_string<P: AsRef<Path>>(file_path: P) -> Result<String, LoadStringError> {\n+    let file_path = file_path.as_ref();\n+    let mut contents = vec![];\n+    let result = File::open(file_path)\n+                      .and_then(|mut f| f.read_to_end(&mut contents));\n+    if let Err(e) = result {\n+        let _ = writeln!(&mut io::stderr(),\n+                         \"error reading `{}`: {}\",\n+                         file_path.display(), e);\n+        return Err(LoadStringError::ReadFail);\n+    }\n+    match str::from_utf8(&contents) {\n+        Ok(s) => Ok(s.to_string()),\n+        Err(_) => {\n+            let _ = writeln!(&mut io::stderr(),\n+                             \"error reading `{}`: not UTF-8\",\n+                             file_path.display());\n+            Err(LoadStringError::BadUtf8)\n         }\n     }\n }\n \n pub fn load_external_files(names: &[String]) -> Option<String> {\n     let mut out = String::new();\n     for name in names {\n-        out.push_str(&*load_or_return!(&name, None, None));\n+        let s = match load_string(name) {\n+            Ok(s) => s,\n+            Err(_) => return None,\n+        };\n+        out.push_str(&s);\n         out.push('\\n');\n     }\n     Some(out)"}, {"sha": "f708aa5461999be4de11f6e424e78f849dee9e6e", "filename": "src/librustdoc/markdown.rs", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/7be14eea94f1b61b3d85e29bcbefac435d0b48c2/src%2Flibrustdoc%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7be14eea94f1b61b3d85e29bcbefac435d0b48c2/src%2Flibrustdoc%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fmarkdown.rs?ref=7be14eea94f1b61b3d85e29bcbefac435d0b48c2", "patch": "@@ -19,7 +19,7 @@ use testing;\n use rustc::session::search_paths::SearchPaths;\n use rustc::session::config::Externs;\n \n-use externalfiles::ExternalHtml;\n+use externalfiles::{ExternalHtml, LoadStringError, load_string};\n \n use html::render::reset_ids;\n use html::escape::Escape;\n@@ -58,7 +58,11 @@ pub fn render(input: &str, mut output: PathBuf, matches: &getopts::Matches,\n         css.push_str(&s)\n     }\n \n-    let input_str = load_or_return!(input, 1, 2);\n+    let input_str = match load_string(input) {\n+        Ok(s) => s,\n+        Err(LoadStringError::ReadFail) => return 1,\n+        Err(LoadStringError::BadUtf8) => return 2,\n+    };\n     let playground = matches.opt_str(\"markdown-playground-url\");\n     if playground.is_some() {\n         markdown::PLAYGROUND_KRATE.with(|s| { *s.borrow_mut() = Some(None); });\n@@ -144,7 +148,11 @@ pub fn render(input: &str, mut output: PathBuf, matches: &getopts::Matches,\n /// Run any tests/code examples in the markdown file `input`.\n pub fn test(input: &str, cfgs: Vec<String>, libs: SearchPaths, externs: Externs,\n             mut test_args: Vec<String>) -> isize {\n-    let input_str = load_or_return!(input, 1, 2);\n+    let input_str = match load_string(input) {\n+        Ok(s) => s,\n+        Err(LoadStringError::ReadFail) => return 1,\n+        Err(LoadStringError::BadUtf8) => return 2,\n+    };\n \n     let mut opts = TestOptions::default();\n     opts.no_crate_inject = true;"}]}