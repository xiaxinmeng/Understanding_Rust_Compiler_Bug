{"sha": "e9475b57be66a16e8a7c2b796dc60dff04f86fe9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU5NDc1YjU3YmU2NmExNmU4YTdjMmI3OTZkYzYwZGZmMDRmODZmZTk=", "commit": {"author": {"name": "Huon Wilson", "email": "dbau.pp+github@gmail.com", "date": "2014-03-22T07:12:22Z"}, "committer": {"name": "Huon Wilson", "email": "dbau.pp+github@gmail.com", "date": "2014-03-25T13:25:17Z"}, "message": "std: expand the `Share` docs to make them more precise.\n\nAnd give some examples about exactly what's `Share` and what's not.", "tree": {"sha": "e9fd5ce85335f978ca2f9961bd6aad23f2518648", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e9fd5ce85335f978ca2f9961bd6aad23f2518648"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e9475b57be66a16e8a7c2b796dc60dff04f86fe9", "comment_count": 9, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e9475b57be66a16e8a7c2b796dc60dff04f86fe9", "html_url": "https://github.com/rust-lang/rust/commit/e9475b57be66a16e8a7c2b796dc60dff04f86fe9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e9475b57be66a16e8a7c2b796dc60dff04f86fe9/comments", "author": {"login": "huonw", "id": 1203825, "node_id": "MDQ6VXNlcjEyMDM4MjU=", "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4", "gravatar_id": "", "url": "https://api.github.com/users/huonw", "html_url": "https://github.com/huonw", "followers_url": "https://api.github.com/users/huonw/followers", "following_url": "https://api.github.com/users/huonw/following{/other_user}", "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}", "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/huonw/subscriptions", "organizations_url": "https://api.github.com/users/huonw/orgs", "repos_url": "https://api.github.com/users/huonw/repos", "events_url": "https://api.github.com/users/huonw/events{/privacy}", "received_events_url": "https://api.github.com/users/huonw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "huonw", "id": 1203825, "node_id": "MDQ6VXNlcjEyMDM4MjU=", "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4", "gravatar_id": "", "url": "https://api.github.com/users/huonw", "html_url": "https://github.com/huonw", "followers_url": "https://api.github.com/users/huonw/followers", "following_url": "https://api.github.com/users/huonw/following{/other_user}", "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}", "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/huonw/subscriptions", "organizations_url": "https://api.github.com/users/huonw/orgs", "repos_url": "https://api.github.com/users/huonw/repos", "events_url": "https://api.github.com/users/huonw/events{/privacy}", "received_events_url": "https://api.github.com/users/huonw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2c7f3b850ce11c70d5bef2b2d5155a1f0fdaa421", "url": "https://api.github.com/repos/rust-lang/rust/commits/2c7f3b850ce11c70d5bef2b2d5155a1f0fdaa421", "html_url": "https://github.com/rust-lang/rust/commit/2c7f3b850ce11c70d5bef2b2d5155a1f0fdaa421"}], "stats": {"total": 46, "additions": 45, "deletions": 1}, "files": [{"sha": "f116f61509e11c91c09a5483945077c08438216a", "filename": "src/libstd/kinds.rs", "status": "modified", "additions": 45, "deletions": 1, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/e9475b57be66a16e8a7c2b796dc60dff04f86fe9/src%2Flibstd%2Fkinds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e9475b57be66a16e8a7c2b796dc60dff04f86fe9/src%2Flibstd%2Fkinds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fkinds.rs?ref=e9475b57be66a16e8a7c2b796dc60dff04f86fe9", "patch": "@@ -40,7 +40,51 @@ pub trait Pod {\n     // Empty.\n }\n \n-/// Types that can be safely shared between threads, hence thread-safe.\n+/// Types that can be safely shared between tasks when aliased.\n+///\n+/// The precise definition is: a type `T` is `Share` if `&T` is\n+/// thread-safe. In other words, there is no possibility of data races\n+/// when passing `&T` references between tasks.\n+///\n+/// As one would expect, primitive types like `u8` and `f64` are all\n+/// `Share`, and so are simple aggregate types containing them (like\n+/// tuples, structs and enums). More instances of basic `Share` types\n+/// include \"immutable\" types like `&T` and those with simple\n+/// inherited mutability, such as `~T`, `Vec<T>` and most other\n+/// collection types. (Generic parameters need to be `Share` for their\n+/// container to be `Share`.)\n+///\n+/// A somewhat surprising consequence of the definition is `&mut T` is\n+/// `Share` (if `T` is `Share`) even though it seems that it might\n+/// provide unsynchronised mutation. The trick is a mutable reference\n+/// stored in an aliasable reference (that is, `& &mut T`) becomes\n+/// read-only, as if it were a `& &T`, hence there is no risk of a data\n+/// race.\n+///\n+/// Types that are not `Share` are those that have \"interior\n+/// mutability\" in a non-thread-safe way, such as `Cell` and `RefCell`\n+/// in `std::cell`. These types allow for mutation of their contents\n+/// even when in an immutable, aliasable slot, e.g. the contents of\n+/// `&Cell<T>` can be `.set`, and do not ensure data races are\n+/// impossible, hence they cannot be `Share`. A higher level example\n+/// of a non-`Share` type is the reference counted pointer\n+/// `std::rc::Rc`, because any reference `&Rc<T>` can clone a new\n+/// reference, which modifies the reference counts in a non-atomic\n+/// way.\n+///\n+/// For cases when one does need thread-safe interior mutability,\n+/// types like the atomics in `std::sync` and `Mutex` & `RWLock` in\n+/// the `sync` crate do ensure that any mutation cannot cause data\n+/// races.  Hence these types are `Share`.\n+///\n+/// Users writing their own types with interior mutability (or anything\n+/// else that is not thread-safe) should use the `NoShare` marker type\n+/// (from `std::kinds::marker`) to ensure that the compiler doesn't\n+/// consider the user-defined type to be `Share`.  Any types with\n+/// interior mutability must also use the `std::ty::Unsafe` wrapper\n+/// around the value(s) which can be mutated when behind a `&`\n+/// reference; not doing this is undefined behaviour (for example,\n+/// `transmute`-ing from `&T` to `&mut T` is illegal).\n #[lang=\"share\"]\n pub trait Share {\n     // Empty"}]}