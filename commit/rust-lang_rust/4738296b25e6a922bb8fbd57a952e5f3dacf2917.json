{"sha": "4738296b25e6a922bb8fbd57a952e5f3dacf2917", "node_id": "C_kwDOAAsO6NoAKDQ3MzgyOTZiMjVlNmE5MjJiYjhmYmQ1N2E5NTJlNWYzZGFjZjI5MTc", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-09-29T11:23:44Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-10-02T13:05:54Z"}, "message": "use rustc_tools_util instead of vergen", "tree": {"sha": "90419c1ff46c11121d320905cf8e2d35d1ec774a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/90419c1ff46c11121d320905cf8e2d35d1ec774a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4738296b25e6a922bb8fbd57a952e5f3dacf2917", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4738296b25e6a922bb8fbd57a952e5f3dacf2917", "html_url": "https://github.com/rust-lang/rust/commit/4738296b25e6a922bb8fbd57a952e5f3dacf2917", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4738296b25e6a922bb8fbd57a952e5f3dacf2917/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "386628b70781f0186328ee13dae5e18dded9dd1c", "url": "https://api.github.com/repos/rust-lang/rust/commits/386628b70781f0186328ee13dae5e18dded9dd1c", "html_url": "https://github.com/rust-lang/rust/commit/386628b70781f0186328ee13dae5e18dded9dd1c"}], "stats": {"total": 289, "additions": 23, "deletions": 266}, "files": [{"sha": "0608553dd196493768531ee920e0e658eb6dd4b7", "filename": "src/tools/miri/cargo-miri/Cargo.lock", "status": "modified", "additions": 7, "deletions": 247, "changes": 254, "blob_url": "https://github.com/rust-lang/rust/blob/4738296b25e6a922bb8fbd57a952e5f3dacf2917/src%2Ftools%2Fmiri%2Fcargo-miri%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/4738296b25e6a922bb8fbd57a952e5f3dacf2917/src%2Ftools%2Fmiri%2Fcargo-miri%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Fcargo-miri%2FCargo.lock?ref=4738296b25e6a922bb8fbd57a952e5f3dacf2917", "patch": "@@ -31,10 +31,10 @@ dependencies = [\n  \"directories\",\n  \"rustc-build-sysroot\",\n  \"rustc-workspace-hack\",\n+ \"rustc_tools_util\",\n  \"rustc_version\",\n  \"serde\",\n  \"serde_json\",\n- \"vergen\",\n ]\n \n [[package]]\n@@ -59,15 +59,6 @@ dependencies = [\n  \"serde_json\",\n ]\n \n-[[package]]\n-name = \"cc\"\n-version = \"1.0.73\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"2fff2a6927b3bb87f9595d67196a70493f627687a71d87a0d692242c33f58c11\"\n-dependencies = [\n- \"jobserver\",\n-]\n-\n [[package]]\n name = \"cfg-if\"\n version = \"1.0.0\"\n@@ -94,26 +85,6 @@ dependencies = [\n  \"winapi\",\n ]\n \n-[[package]]\n-name = \"enum-iterator\"\n-version = \"1.1.3\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"45a0ac4aeb3a18f92eaf09c6bb9b3ac30ff61ca95514fc58cbead1c9a6bf5401\"\n-dependencies = [\n- \"enum-iterator-derive\",\n-]\n-\n-[[package]]\n-name = \"enum-iterator-derive\"\n-version = \"1.1.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"828de45d0ca18782232dfb8f3ea9cc428e8ced380eb26a520baaacfc70de39ce\"\n-dependencies = [\n- \"proc-macro2\",\n- \"quote\",\n- \"syn\",\n-]\n-\n [[package]]\n name = \"fastrand\"\n version = \"1.8.0\"\n@@ -123,15 +94,6 @@ dependencies = [\n  \"instant\",\n ]\n \n-[[package]]\n-name = \"form_urlencoded\"\n-version = \"1.1.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"a9c384f161156f5260c24a097c56119f9be8c798586aecc13afbcbe7b7e26bf8\"\n-dependencies = [\n- \"percent-encoding\",\n-]\n-\n [[package]]\n name = \"getrandom\"\n version = \"0.2.7\"\n@@ -143,41 +105,6 @@ dependencies = [\n  \"wasi\",\n ]\n \n-[[package]]\n-name = \"getset\"\n-version = \"0.1.2\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"e45727250e75cc04ff2846a66397da8ef2b3db8e40e0cef4df67950a07621eb9\"\n-dependencies = [\n- \"proc-macro-error\",\n- \"proc-macro2\",\n- \"quote\",\n- \"syn\",\n-]\n-\n-[[package]]\n-name = \"git2\"\n-version = \"0.14.4\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"d0155506aab710a86160ddb504a480d2964d7ab5b9e62419be69e0032bc5931c\"\n-dependencies = [\n- \"bitflags\",\n- \"libc\",\n- \"libgit2-sys\",\n- \"log\",\n- \"url\",\n-]\n-\n-[[package]]\n-name = \"idna\"\n-version = \"0.3.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"e14ddfc70884202db2244c223200c204c2bda1bc6e0998d11b5e024d657209e6\"\n-dependencies = [\n- \"unicode-bidi\",\n- \"unicode-normalization\",\n-]\n-\n [[package]]\n name = \"instant\"\n version = \"0.1.12\"\n@@ -193,99 +120,12 @@ version = \"1.0.3\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"6c8af84674fe1f223a982c933a0ee1086ac4d4052aa0fb8060c12c6ad838e754\"\n \n-[[package]]\n-name = \"jobserver\"\n-version = \"0.1.25\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"068b1ee6743e4d11fb9c6a1e6064b3693a1b600e7f5f5988047d98b3dc9fb90b\"\n-dependencies = [\n- \"libc\",\n-]\n-\n [[package]]\n name = \"libc\"\n version = \"0.2.133\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"c0f80d65747a3e43d1596c7c5492d95d5edddaabd45a7fcdb02b95f644164966\"\n \n-[[package]]\n-name = \"libgit2-sys\"\n-version = \"0.13.4+1.4.2\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"d0fa6563431ede25f5cc7f6d803c6afbc1c5d3ad3d4925d12c882bf2b526f5d1\"\n-dependencies = [\n- \"cc\",\n- \"libc\",\n- \"libz-sys\",\n- \"pkg-config\",\n-]\n-\n-[[package]]\n-name = \"libz-sys\"\n-version = \"1.1.8\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"9702761c3935f8cc2f101793272e202c72b99da8f4224a19ddcf1279a6450bbf\"\n-dependencies = [\n- \"cc\",\n- \"libc\",\n- \"pkg-config\",\n- \"vcpkg\",\n-]\n-\n-[[package]]\n-name = \"log\"\n-version = \"0.4.17\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"abb12e687cfb44aa40f41fc3978ef76448f9b6038cad6aef4259d3c095a2382e\"\n-dependencies = [\n- \"cfg-if\",\n-]\n-\n-[[package]]\n-name = \"num_threads\"\n-version = \"0.1.6\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"2819ce041d2ee131036f4fc9d6ae7ae125a3a40e97ba64d04fe799ad9dabbb44\"\n-dependencies = [\n- \"libc\",\n-]\n-\n-[[package]]\n-name = \"percent-encoding\"\n-version = \"2.2.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"478c572c3d73181ff3c2539045f6eb99e5491218eae919370993b890cdbdd98e\"\n-\n-[[package]]\n-name = \"pkg-config\"\n-version = \"0.3.25\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"1df8c4ec4b0627e53bdf214615ad287367e482558cf84b109250b37464dc03ae\"\n-\n-[[package]]\n-name = \"proc-macro-error\"\n-version = \"1.0.4\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"da25490ff9892aab3fcf7c36f08cfb902dd3e71ca0f9f9517bea02a73a5ce38c\"\n-dependencies = [\n- \"proc-macro-error-attr\",\n- \"proc-macro2\",\n- \"quote\",\n- \"syn\",\n- \"version_check\",\n-]\n-\n-[[package]]\n-name = \"proc-macro-error-attr\"\n-version = \"1.0.4\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"a1be40180e52ecc98ad80b184934baf3d0d29f979574e439af5a55274b35f869\"\n-dependencies = [\n- \"proc-macro2\",\n- \"quote\",\n- \"version_check\",\n-]\n-\n [[package]]\n name = \"proc-macro2\"\n version = \"1.0.45\"\n@@ -350,6 +190,12 @@ version = \"1.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"fc71d2faa173b74b232dedc235e3ee1696581bb132fc116fa3626d6151a1a8fb\"\n \n+[[package]]\n+name = \"rustc_tools_util\"\n+version = \"0.2.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"b725dadae9fabc488df69a287f5a99c5eaf5d10853842a8a3dfac52476f544ee\"\n+\n [[package]]\n name = \"rustc_version\"\n version = \"0.4.0\"\n@@ -359,12 +205,6 @@ dependencies = [\n  \"semver\",\n ]\n \n-[[package]]\n-name = \"rustversion\"\n-version = \"1.0.9\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"97477e48b4cf8603ad5f7aaf897467cf42ab4218a38ef76fb14c2d6773a6d6a8\"\n-\n [[package]]\n name = \"ryu\"\n version = \"1.0.11\"\n@@ -456,92 +296,12 @@ dependencies = [\n  \"syn\",\n ]\n \n-[[package]]\n-name = \"time\"\n-version = \"0.3.14\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"3c3f9a28b618c3a6b9251b6908e9c99e04b9e5c02e6581ccbb67d59c34ef7f9b\"\n-dependencies = [\n- \"itoa\",\n- \"libc\",\n- \"num_threads\",\n-]\n-\n-[[package]]\n-name = \"tinyvec\"\n-version = \"1.6.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"87cc5ceb3875bb20c2890005a4e226a4651264a5c75edb2421b52861a0a0cb50\"\n-dependencies = [\n- \"tinyvec_macros\",\n-]\n-\n-[[package]]\n-name = \"tinyvec_macros\"\n-version = \"0.1.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"cda74da7e1a664f795bb1f8a87ec406fb89a02522cf6e50620d016add6dbbf5c\"\n-\n-[[package]]\n-name = \"unicode-bidi\"\n-version = \"0.3.8\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"099b7128301d285f79ddd55b9a83d5e6b9e97c92e0ea0daebee7263e932de992\"\n-\n [[package]]\n name = \"unicode-ident\"\n version = \"1.0.4\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"dcc811dc4066ac62f84f11307873c4850cb653bfa9b1719cee2bd2204a4bc5dd\"\n \n-[[package]]\n-name = \"unicode-normalization\"\n-version = \"0.1.22\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"5c5713f0fc4b5db668a2ac63cdb7bb4469d8c9fed047b1d0292cc7b0ce2ba921\"\n-dependencies = [\n- \"tinyvec\",\n-]\n-\n-[[package]]\n-name = \"url\"\n-version = \"2.3.1\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"0d68c799ae75762b8c3fe375feb6600ef5602c883c5d21eb51c09f22b83c4643\"\n-dependencies = [\n- \"form_urlencoded\",\n- \"idna\",\n- \"percent-encoding\",\n-]\n-\n-[[package]]\n-name = \"vcpkg\"\n-version = \"0.2.15\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"accd4ea62f7bb7a82fe23066fb0957d48ef677f6eeb8215f372f52e48bb32426\"\n-\n-[[package]]\n-name = \"vergen\"\n-version = \"7.4.2\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"73ba753d713ec3844652ad2cb7eb56bc71e34213a14faddac7852a10ba88f61e\"\n-dependencies = [\n- \"anyhow\",\n- \"cfg-if\",\n- \"enum-iterator\",\n- \"getset\",\n- \"git2\",\n- \"rustversion\",\n- \"thiserror\",\n- \"time\",\n-]\n-\n-[[package]]\n-name = \"version_check\"\n-version = \"0.9.4\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"49874b5167b65d7193b8aba1567f5c7d93d001cafc34600cee003eda787e483f\"\n-\n [[package]]\n name = \"wasi\"\n version = \"0.11.0+wasi-snapshot-preview1\""}, {"sha": "fcdd122747da57a25b1ccc856c428155221e22b3", "filename": "src/tools/miri/cargo-miri/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4738296b25e6a922bb8fbd57a952e5f3dacf2917/src%2Ftools%2Fmiri%2Fcargo-miri%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/4738296b25e6a922bb8fbd57a952e5f3dacf2917/src%2Ftools%2Fmiri%2Fcargo-miri%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Fcargo-miri%2FCargo.toml?ref=4738296b25e6a922bb8fbd57a952e5f3dacf2917", "patch": "@@ -30,4 +30,4 @@ rustc-workspace-hack = \"1.0.0\"\n serde = { version = \"*\", features = [\"derive\"] }\n \n [build-dependencies]\n-vergen = { version = \"7\", default_features = false, features = [\"git\"] }\n+rustc_tools_util = \"0.2\""}, {"sha": "c1110115455904e04d71665a9cfe89351bf72934", "filename": "src/tools/miri/cargo-miri/build.rs", "status": "modified", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/4738296b25e6a922bb8fbd57a952e5f3dacf2917/src%2Ftools%2Fmiri%2Fcargo-miri%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4738296b25e6a922bb8fbd57a952e5f3dacf2917/src%2Ftools%2Fmiri%2Fcargo-miri%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Fcargo-miri%2Fbuild.rs?ref=4738296b25e6a922bb8fbd57a952e5f3dacf2917", "patch": "@@ -1,11 +1,13 @@\n-use vergen::vergen;\n-\n fn main() {\n     // Don't rebuild miri when nothing changed.\n     println!(\"cargo:rerun-if-changed=build.rs\");\n-    // vergen\n-    let mut gen_config = vergen::Config::default();\n-    *gen_config.git_mut().sha_kind_mut() = vergen::ShaKind::Short;\n-    *gen_config.git_mut().commit_timestamp_kind_mut() = vergen::TimestampKind::DateOnly;\n-    vergen(gen_config).ok(); // Ignore failure (in case we are built outside a git repo)\n+    // gather version info\n+    println!(\n+        \"cargo:rustc-env=GIT_HASH={}\",\n+        rustc_tools_util::get_commit_hash().unwrap_or_default()\n+    );\n+    println!(\n+        \"cargo:rustc-env=COMMIT_DATE={}\",\n+        rustc_tools_util::get_commit_date().unwrap_or_default()\n+    );\n }"}, {"sha": "0c1f039d6cc097541638d53a4eb7691774ec777a", "filename": "src/tools/miri/cargo-miri/src/phases.rs", "status": "modified", "additions": 6, "deletions": 11, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/4738296b25e6a922bb8fbd57a952e5f3dacf2917/src%2Ftools%2Fmiri%2Fcargo-miri%2Fsrc%2Fphases.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4738296b25e6a922bb8fbd57a952e5f3dacf2917/src%2Ftools%2Fmiri%2Fcargo-miri%2Fsrc%2Fphases.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Fcargo-miri%2Fsrc%2Fphases.rs?ref=4738296b25e6a922bb8fbd57a952e5f3dacf2917", "patch": "@@ -1,7 +1,6 @@\n //! Implements the various phases of `cargo miri run/test`.\n \n use std::env;\n-use std::fmt::Write as _;\n use std::fs::{self, File};\n use std::io::BufReader;\n use std::path::PathBuf;\n@@ -39,17 +38,13 @@ fn show_help() {\n }\n \n fn show_version() {\n-    let mut version = format!(\"miri {}\", env!(\"CARGO_PKG_VERSION\"));\n-    // Only use `option_env` on vergen variables to ensure the build succeeds\n-    // when vergen failed to find the git info.\n-    if let Some(sha) = option_env!(\"VERGEN_GIT_SHA_SHORT\") {\n-        // This `unwrap` can never fail because if VERGEN_GIT_SHA_SHORT exists, then so does\n-        // VERGEN_GIT_COMMIT_DATE.\n-        #[allow(clippy::option_env_unwrap)]\n-        write!(&mut version, \" ({} {})\", sha, option_env!(\"VERGEN_GIT_COMMIT_DATE\").unwrap())\n-            .unwrap();\n+    print!(\"miri {}\", env!(\"CARGO_PKG_VERSION\"));\n+    let version = format!(\"{} {}\", env!(\"GIT_HASH\"), env!(\"COMMIT_DATE\"));\n+    if version.len() > 1 {\n+        // If there is actually something here, print it.\n+        print!(\" ({version})\");\n     }\n-    println!(\"{}\", version);\n+    println!();\n }\n \n fn forward_patched_extern_arg(args: &mut impl Iterator<Item = String>, cmd: &mut Command) {"}]}