{"sha": "619f29646379dd9d3001804f4d73993f7099ab91", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYxOWYyOTY0NjM3OWRkOWQzMDAxODA0ZjRkNzM5OTNmNzA5OWFiOTE=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-06-09T12:31:05Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-06-09T12:31:05Z"}, "message": "explain why we always set a sysroot; make sure we error if both MIRI_SYSROOT and --sysroot are set", "tree": {"sha": "d9eae7caada3d3cd91f5971664bb71373d395ce9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d9eae7caada3d3cd91f5971664bb71373d395ce9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/619f29646379dd9d3001804f4d73993f7099ab91", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/619f29646379dd9d3001804f4d73993f7099ab91", "html_url": "https://github.com/rust-lang/rust/commit/619f29646379dd9d3001804f4d73993f7099ab91", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/619f29646379dd9d3001804f4d73993f7099ab91/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "05b7e61977a0f7cc1b4bddab0275b5cc7deae660", "url": "https://api.github.com/repos/rust-lang/rust/commits/05b7e61977a0f7cc1b4bddab0275b5cc7deae660", "html_url": "https://github.com/rust-lang/rust/commit/05b7e61977a0f7cc1b4bddab0275b5cc7deae660"}], "stats": {"total": 24, "additions": 15, "deletions": 9}, "files": [{"sha": "660f1bec2d6240a091334170d9c66a27b117b059", "filename": "src/bin/miri.rs", "status": "modified", "additions": 15, "deletions": 9, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/619f29646379dd9d3001804f4d73993f7099ab91/src%2Fbin%2Fmiri.rs", "raw_url": "https://github.com/rust-lang/rust/raw/619f29646379dd9d3001804f4d73993f7099ab91/src%2Fbin%2Fmiri.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fmiri.rs?ref=619f29646379dd9d3001804f4d73993f7099ab91", "patch": "@@ -100,11 +100,7 @@ fn init_late_loggers() {\n     }\n }\n \n-fn find_sysroot() -> String {\n-    if let Ok(sysroot) = std::env::var(\"MIRI_SYSROOT\") {\n-        return sysroot;\n-    }\n-\n+fn compile_time_sysroot() -> String {\n     // Taken from PR <https://github.com/Manishearth/rust-clippy/pull/911>.\n     let home = option_env!(\"RUSTUP_HOME\").or(option_env!(\"MULTIRUST_HOME\"));\n     let toolchain = option_env!(\"RUSTUP_TOOLCHAIN\").or(option_env!(\"MULTIRUST_TOOLCHAIN\"));\n@@ -167,12 +163,22 @@ fn main() {\n         }\n     }\n \n-    // Determine sysroot and let rustc know about it.\n-    let sysroot_flag = String::from(\"--sysroot\");\n-    if !rustc_args.contains(&sysroot_flag) {\n+    // Determine sysroot.\n+    let sysroot_flag = \"--sysroot\".to_string();\n+    if let Ok(sysroot) = std::env::var(\"MIRI_SYSROOT\") {\n+        // MIRI_SYSROOT takes priority. rustc will ensure for us that this errors if there\n+        // already is a \"--sysroot\" flag (because now there would be two).\n+        rustc_args.push(sysroot_flag);\n+        rustc_args.push(sysroot);\n+    } else if !rustc_args.contains(&sysroot_flag) {\n+        // We need to *always* set a --sysroot, as the \"default\" rustc uses is\n+        // somewhere in the directory miri was built in.\n+        // If neither MIRI_SYSROOT nor --sysroot are given, fall back to env\n+        // vars that are read at *compile-time*.\n         rustc_args.push(sysroot_flag);\n-        rustc_args.push(find_sysroot());\n+        rustc_args.push(compile_time_sysroot());\n     }\n+\n     // Finally, add the default flags all the way in the beginning, but after the binary name.\n     rustc_args.splice(1..1, miri::miri_default_args().iter().map(ToString::to_string));\n "}]}