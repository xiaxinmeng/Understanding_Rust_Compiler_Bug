{"sha": "dc30b92cc576ed9e097db7fece0af13662de8d8d", "node_id": "C_kwDOAAsO6NoAKGRjMzBiOTJjYzU3NmVkOWUwOTdkYjdmZWNlMGFmMTM2NjJkZThkOGQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-14T06:51:50Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-14T06:51:50Z"}, "message": "Auto merge of #105221 - alex:fat-archive-cleanup, r=bjorn3\n\nAvoid a temporary file when processing macOS fat archives\n\nr? `@bjorn3`", "tree": {"sha": "5596f3454cf826d3c3765f8ca00c223be67a168f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5596f3454cf826d3c3765f8ca00c223be67a168f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dc30b92cc576ed9e097db7fece0af13662de8d8d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dc30b92cc576ed9e097db7fece0af13662de8d8d", "html_url": "https://github.com/rust-lang/rust/commit/dc30b92cc576ed9e097db7fece0af13662de8d8d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dc30b92cc576ed9e097db7fece0af13662de8d8d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "309c469eece74cd9b83328d18302f1a177d0df7f", "url": "https://api.github.com/repos/rust-lang/rust/commits/309c469eece74cd9b83328d18302f1a177d0df7f", "html_url": "https://github.com/rust-lang/rust/commit/309c469eece74cd9b83328d18302f1a177d0df7f"}, {"sha": "bd8e476d8bd85b6d60a0de7694d154b4a74f5133", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd8e476d8bd85b6d60a0de7694d154b4a74f5133", "html_url": "https://github.com/rust-lang/rust/commit/bd8e476d8bd85b6d60a0de7694d154b4a74f5133"}], "stats": {"total": 84, "additions": 38, "deletions": 46}, "files": [{"sha": "36aba5bb740bd6120030c0cbf0e5d6654fa0afc8", "filename": "compiler/rustc_codegen_llvm/src/back/archive.rs", "status": "modified", "additions": 4, "deletions": 10, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/dc30b92cc576ed9e097db7fece0af13662de8d8d/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Farchive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc30b92cc576ed9e097db7fece0af13662de8d8d/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Farchive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Farchive.rs?ref=dc30b92cc576ed9e097db7fece0af13662de8d8d", "patch": "@@ -15,8 +15,8 @@ use crate::errors::{\n use crate::llvm::archive_ro::{ArchiveRO, Child};\n use crate::llvm::{self, ArchiveKind, LLVMMachineType, LLVMRustCOFFShortExport};\n use rustc_codegen_ssa::back::archive::{\n-    get_native_object_symbols, try_extract_macho_fat_archive, ArArchiveBuilder,\n-    ArchiveBuildFailure, ArchiveBuilder, ArchiveBuilderBuilder, UnknownArchiveKind,\n+    get_native_object_symbols, ArArchiveBuilder, ArchiveBuildFailure, ArchiveBuilder,\n+    ArchiveBuilderBuilder, UnknownArchiveKind,\n };\n \n use rustc_session::cstore::DllImport;\n@@ -66,21 +66,15 @@ impl<'a> ArchiveBuilder<'a> for LlvmArchiveBuilder<'a> {\n         archive: &Path,\n         skip: Box<dyn FnMut(&str) -> bool + 'static>,\n     ) -> io::Result<()> {\n-        let mut archive = archive.to_path_buf();\n-        if self.sess.target.llvm_target.contains(\"-apple-macosx\") {\n-            if let Some(new_archive) = try_extract_macho_fat_archive(&self.sess, &archive)? {\n-                archive = new_archive\n-            }\n-        }\n-        let archive_ro = match ArchiveRO::open(&archive) {\n+        let archive_ro = match ArchiveRO::open(archive) {\n             Ok(ar) => ar,\n             Err(e) => return Err(io::Error::new(io::ErrorKind::Other, e)),\n         };\n         if self.additions.iter().any(|ar| ar.path() == archive) {\n             return Ok(());\n         }\n         self.additions.push(Addition::Archive {\n-            path: archive,\n+            path: archive.to_path_buf(),\n             archive: archive_ro,\n             skip: Box::new(skip),\n         });"}, {"sha": "5266d8858d47d35dcc9c12e0e935bb9327b1d4f0", "filename": "compiler/rustc_codegen_ssa/src/back/archive.rs", "status": "modified", "additions": 34, "deletions": 36, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/dc30b92cc576ed9e097db7fece0af13662de8d8d/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Farchive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc30b92cc576ed9e097db7fece0af13662de8d8d/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Farchive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Farchive.rs?ref=dc30b92cc576ed9e097db7fece0af13662de8d8d", "patch": "@@ -14,7 +14,7 @@ use tempfile::Builder as TempFileBuilder;\n \n use std::error::Error;\n use std::fs::File;\n-use std::io::{self, Write};\n+use std::io;\n use std::path::{Path, PathBuf};\n \n // Re-exporting for rustc_codegen_llvm::back::archive\n@@ -116,51 +116,42 @@ impl<'a> ArArchiveBuilder<'a> {\n     }\n }\n \n-fn try_filter_fat_archs(\n+fn try_filter_fat_archs<'a>(\n     archs: object::read::Result<&[impl FatArch]>,\n     target_arch: object::Architecture,\n-    archive_path: &Path,\n-    archive_map_data: &[u8],\n-) -> io::Result<Option<PathBuf>> {\n+    archive_map_data: &'a [u8],\n+) -> io::Result<Option<(&'a [u8], u64)>> {\n     let archs = archs.map_err(|e| io::Error::new(io::ErrorKind::Other, e))?;\n \n     let desired = match archs.iter().filter(|a| a.architecture() == target_arch).next() {\n         Some(a) => a,\n         None => return Ok(None),\n     };\n \n-    let (mut new_f, extracted_path) = tempfile::Builder::new()\n-        .suffix(archive_path.file_name().unwrap())\n-        .tempfile()?\n-        .keep()\n-        .unwrap();\n-\n-    new_f.write_all(\n+    Ok(Some((\n         desired.data(archive_map_data).map_err(|e| io::Error::new(io::ErrorKind::Other, e))?,\n-    )?;\n-\n-    Ok(Some(extracted_path))\n+        desired.offset().into(),\n+    )))\n }\n \n-pub fn try_extract_macho_fat_archive(\n+pub fn try_extract_macho_fat_archive<'a>(\n     sess: &Session,\n-    archive_path: &Path,\n-) -> io::Result<Option<PathBuf>> {\n-    let archive_map = unsafe { Mmap::map(File::open(&archive_path)?)? };\n+    archive_bytes: &'a [u8],\n+) -> io::Result<Option<(&'a [u8], u64)>> {\n     let target_arch = match sess.target.arch.as_ref() {\n         \"aarch64\" => object::Architecture::Aarch64,\n         \"x86_64\" => object::Architecture::X86_64,\n         _ => return Ok(None),\n     };\n \n-    match object::macho::FatHeader::parse(&*archive_map) {\n+    match object::macho::FatHeader::parse(archive_bytes) {\n         Ok(h) if h.magic.get(object::endian::BigEndian) == object::macho::FAT_MAGIC => {\n-            let archs = object::macho::FatHeader::parse_arch32(&*archive_map);\n-            try_filter_fat_archs(archs, target_arch, archive_path, &*archive_map)\n+            let archs = object::macho::FatHeader::parse_arch32(archive_bytes);\n+            try_filter_fat_archs(archs, target_arch, archive_bytes)\n         }\n         Ok(h) if h.magic.get(object::endian::BigEndian) == object::macho::FAT_MAGIC_64 => {\n-            let archs = object::macho::FatHeader::parse_arch64(&*archive_map);\n-            try_filter_fat_archs(archs, target_arch, archive_path, &*archive_map)\n+            let archs = object::macho::FatHeader::parse_arch64(archive_bytes);\n+            try_filter_fat_archs(archs, target_arch, archive_bytes)\n         }\n         // Not a FatHeader at all, just return None.\n         _ => Ok(None),\n@@ -173,21 +164,24 @@ impl<'a> ArchiveBuilder<'a> for ArArchiveBuilder<'a> {\n         archive_path: &Path,\n         mut skip: Box<dyn FnMut(&str) -> bool + 'static>,\n     ) -> io::Result<()> {\n-        let mut archive_path = archive_path.to_path_buf();\n-        if self.sess.target.llvm_target.contains(\"-apple-macosx\") {\n-            if let Some(new_archive_path) =\n-                try_extract_macho_fat_archive(&self.sess, &archive_path)?\n-            {\n-                archive_path = new_archive_path\n-            }\n-        }\n-\n+        let archive_map = unsafe { Mmap::map(File::open(&archive_path)?)? };\n         if self.src_archives.iter().any(|archive| archive.0 == archive_path) {\n             return Ok(());\n         }\n \n-        let archive_map = unsafe { Mmap::map(File::open(&archive_path)?)? };\n-        let archive = ArchiveFile::parse(&*archive_map)\n+        let (archive_bytes, offset) = if self.sess.target.llvm_target.contains(\"-apple-macosx\") {\n+            if let Some((sub_archive, archive_offset)) =\n+                try_extract_macho_fat_archive(&self.sess, &*archive_map)?\n+            {\n+                (sub_archive, Some(archive_offset))\n+            } else {\n+                (&*archive_map, None)\n+            }\n+        } else {\n+            (&*archive_map, None)\n+        };\n+\n+        let archive = ArchiveFile::parse(&*archive_bytes)\n             .map_err(|err| io::Error::new(io::ErrorKind::InvalidData, err))?;\n         let archive_index = self.src_archives.len();\n \n@@ -196,9 +190,13 @@ impl<'a> ArchiveBuilder<'a> for ArArchiveBuilder<'a> {\n             let file_name = String::from_utf8(entry.name().to_vec())\n                 .map_err(|err| io::Error::new(io::ErrorKind::InvalidData, err))?;\n             if !skip(&file_name) {\n+                let mut range = entry.file_range();\n+                if let Some(offset) = offset {\n+                    range.0 += offset;\n+                }\n                 self.entries.push((\n                     file_name.into_bytes(),\n-                    ArchiveEntry::FromArchive { archive_index, file_range: entry.file_range() },\n+                    ArchiveEntry::FromArchive { archive_index, file_range: range },\n                 ));\n             }\n         }"}]}