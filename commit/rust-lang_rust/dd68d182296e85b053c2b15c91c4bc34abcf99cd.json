{"sha": "dd68d182296e85b053c2b15c91c4bc34abcf99cd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRkNjhkMTgyMjk2ZTg1YjA1M2MyYjE1YzkxYzRiYzM0YWJjZjk5Y2Q=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-08-09T16:04:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-08-09T16:04:03Z"}, "message": "Merge #9826\n\n9826: internal: drop latest requests tracking r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "c98b4418ad206d6fbdf4e84b2d4aef439174b9b1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c98b4418ad206d6fbdf4e84b2d4aef439174b9b1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dd68d182296e85b053c2b15c91c4bc34abcf99cd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhEVHzCRBK7hj4Ov3rIwAAfj0IAG6FKrko9ui3VALSk6T5tZM3\nOPRwcLS9V/MX36/Fp+8xcLo1J/RWdOm0C4y9i95RPSz0zGfN40dzLVd6CdvLjUCc\nlqpj8ymRVHNgShxMf4e+GEAuFxiXl721CvCWPPu7nkQbUlISGcaQ8AFLu0pe6c7Y\nP226KRfjgAX3YskPz6zucb2tXll8+xBxgVNe945xfuZ2suCSEWa1+1lEUMwH+hlQ\nEXhCe4hG89T8yvc8t3H+V2ewBWpjngj2Wqck70I7hP43IK8uNMvAFTmwcFRF6C1J\nbIxK/IoAyXIKJ9ZXmAdXQqsR1bi6Eii8/k9mjya/1ChIT0+mNRYtpBa9UTdE4v4=\n=vfxW\n-----END PGP SIGNATURE-----\n", "payload": "tree c98b4418ad206d6fbdf4e84b2d4aef439174b9b1\nparent d0648494e61b1ab277697ff4cc799f98f516a07d\nparent ce8400bbfd8786003a112633992a3ec2b003859b\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1628525043 +0000\ncommitter GitHub <noreply@github.com> 1628525043 +0000\n\nMerge #9826\n\n9826: internal: drop latest requests tracking r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dd68d182296e85b053c2b15c91c4bc34abcf99cd", "html_url": "https://github.com/rust-lang/rust/commit/dd68d182296e85b053c2b15c91c4bc34abcf99cd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dd68d182296e85b053c2b15c91c4bc34abcf99cd/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d0648494e61b1ab277697ff4cc799f98f516a07d", "url": "https://api.github.com/repos/rust-lang/rust/commits/d0648494e61b1ab277697ff4cc799f98f516a07d", "html_url": "https://github.com/rust-lang/rust/commit/d0648494e61b1ab277697ff4cc799f98f516a07d"}, {"sha": "ce8400bbfd8786003a112633992a3ec2b003859b", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce8400bbfd8786003a112633992a3ec2b003859b", "html_url": "https://github.com/rust-lang/rust/commit/ce8400bbfd8786003a112633992a3ec2b003859b"}], "stats": {"total": 54, "additions": 1, "deletions": 53}, "files": [{"sha": "a7ebbcd28bc92520acdcb307cacb9a6aa7c4c93a", "filename": "crates/rust-analyzer/src/global_state.rs", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/dd68d182296e85b053c2b15c91c4bc34abcf99cd/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd68d182296e85b053c2b15c91c4bc34abcf99cd/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs?ref=dd68d182296e85b053c2b15c91c4bc34abcf99cd", "patch": "@@ -27,7 +27,6 @@ use crate::{\n     mem_docs::MemDocs,\n     op_queue::OpQueue,\n     reload::SourceRootConfig,\n-    request_metrics::{LatestRequests, RequestMetrics},\n     thread_pool::TaskPool,\n     to_proto::url_from_abs_path,\n     Result,\n@@ -105,16 +104,13 @@ pub(crate) struct GlobalState {\n         OpQueue<(Arc<Vec<ProjectWorkspace>>, Vec<anyhow::Result<WorkspaceBuildScripts>>)>,\n \n     pub(crate) prime_caches_queue: OpQueue<()>,\n-\n-    latest_requests: Arc<RwLock<LatestRequests>>,\n }\n \n /// An immutable snapshot of the world's state at a point in time.\n pub(crate) struct GlobalStateSnapshot {\n     pub(crate) config: Arc<Config>,\n     pub(crate) analysis: Analysis,\n     pub(crate) check_fixes: CheckFixes,\n-    pub(crate) latest_requests: Arc<RwLock<LatestRequests>>,\n     mem_docs: MemDocs,\n     pub(crate) semantic_tokens_cache: Arc<Mutex<FxHashMap<Url, SemanticTokens>>>,\n     vfs: Arc<RwLock<(vfs::Vfs, FxHashMap<FileId, LineEndings>)>>,\n@@ -169,7 +165,6 @@ impl GlobalState {\n             prime_caches_queue: OpQueue::default(),\n \n             fetch_build_data_queue: OpQueue::default(),\n-            latest_requests: Default::default(),\n         };\n         // Apply any required database inputs from the config.\n         this.update_configuration(config);\n@@ -230,7 +225,6 @@ impl GlobalState {\n             workspaces: Arc::clone(&self.workspaces),\n             analysis: self.analysis_host.analysis(),\n             vfs: Arc::clone(&self.vfs),\n-            latest_requests: Arc::clone(&self.latest_requests),\n             check_fixes: Arc::clone(&self.diagnostics.check_fixes),\n             mem_docs: self.mem_docs.clone(),\n             semantic_tokens_cache: Arc::clone(&self.semantic_tokens_cache),\n@@ -270,9 +264,7 @@ impl GlobalState {\n     pub(crate) fn respond(&mut self, response: lsp_server::Response) {\n         if let Some((method, start)) = self.req_queue.incoming.complete(response.id.clone()) {\n             let duration = start.elapsed();\n-            log::info!(\"handled req#{} in {:?}\", response.id, duration);\n-            let metrics = RequestMetrics { id: response.id.clone(), method, duration };\n-            self.latest_requests.write().record(metrics);\n+            log::info!(\"handled {} - ({}) in {:0.2?}\", method, response.id, duration);\n             self.send(response.into());\n         }\n     }"}, {"sha": "460271a269f253b3b05390557240906476074fe6", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/dd68d182296e85b053c2b15c91c4bc34abcf99cd/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd68d182296e85b053c2b15c91c4bc34abcf99cd/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=dd68d182296e85b053c2b15c91c4bc34abcf99cd", "patch": "@@ -79,12 +79,6 @@ pub(crate) fn handle_analyzer_status(\n             .status(file_id)\n             .unwrap_or_else(|_| \"Analysis retrieval was cancelled\".to_owned()),\n     );\n-    format_to!(buf, \"\\n\\nRequests:\\n\");\n-    let requests = snap.latest_requests.read();\n-    for (is_last, r) in requests.iter() {\n-        let mark = if is_last { \"*\" } else { \" \" };\n-        format_to!(buf, \"{}{:4} {:<36}{}ms\\n\", mark, r.id, r.method, r.duration.as_millis());\n-    }\n     Ok(buf)\n }\n "}, {"sha": "c8c996f0da569d9bc76ba37f44943d9aa29f24eb", "filename": "crates/rust-analyzer/src/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dd68d182296e85b053c2b15c91c4bc34abcf99cd/crates%2Frust-analyzer%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd68d182296e85b053c2b15c91c4bc34abcf99cd/crates%2Frust-analyzer%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flib.rs?ref=dd68d182296e85b053c2b15c91c4bc34abcf99cd", "patch": "@@ -30,7 +30,6 @@ mod semantic_tokens;\n mod markdown;\n mod diagnostics;\n mod line_index;\n-mod request_metrics;\n mod lsp_utils;\n mod thread_pool;\n mod mem_docs;"}, {"sha": "b1019e2d6fc5b5de87d53f83451a98b694e283d9", "filename": "crates/rust-analyzer/src/request_metrics.rs", "status": "removed", "additions": 0, "deletions": 37, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/d0648494e61b1ab277697ff4cc799f98f516a07d/crates%2Frust-analyzer%2Fsrc%2Frequest_metrics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d0648494e61b1ab277697ff4cc799f98f516a07d/crates%2Frust-analyzer%2Fsrc%2Frequest_metrics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Frequest_metrics.rs?ref=d0648494e61b1ab277697ff4cc799f98f516a07d", "patch": "@@ -1,37 +0,0 @@\n-//! Records stats about requests\n-use std::time::Duration;\n-\n-use lsp_server::RequestId;\n-\n-#[derive(Debug)]\n-pub(crate) struct RequestMetrics {\n-    pub(crate) id: RequestId,\n-    pub(crate) method: String,\n-    pub(crate) duration: Duration,\n-}\n-\n-const N_COMPLETED_REQUESTS: usize = 10;\n-\n-#[derive(Debug, Default)]\n-pub(crate) struct LatestRequests {\n-    // hand-rolling VecDeque here to print things in a nicer way\n-    buf: [Option<RequestMetrics>; N_COMPLETED_REQUESTS],\n-    idx: usize,\n-}\n-\n-impl LatestRequests {\n-    pub(crate) fn record(&mut self, request: RequestMetrics) {\n-        // special case: don't track status request itself\n-        if request.method == \"rust-analyzer/analyzerStatus\" {\n-            return;\n-        }\n-        let idx = self.idx;\n-        self.buf[idx] = Some(request);\n-        self.idx = (idx + 1) % N_COMPLETED_REQUESTS;\n-    }\n-\n-    pub(crate) fn iter(&self) -> impl Iterator<Item = (bool, &RequestMetrics)> {\n-        let idx = self.idx;\n-        self.buf.iter().enumerate().filter_map(move |(i, req)| Some((i == idx, req.as_ref()?)))\n-    }\n-}"}]}