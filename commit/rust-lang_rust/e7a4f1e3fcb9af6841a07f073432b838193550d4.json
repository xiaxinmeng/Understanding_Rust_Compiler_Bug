{"sha": "e7a4f1e3fcb9af6841a07f073432b838193550d4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU3YTRmMWUzZmNiOWFmNjg0MWEwN2YwNzM0MzJiODM4MTkzNTUwZDQ=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-06-21T00:42:15Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-21T00:42:15Z"}, "message": "Rollup merge of #86152 - the8472:lazify-npm-queries, r=Mark-Simulacrum\n\nLazify is_really_default condition in the RustdocGUI bootstrap step\n\nThe `RustdocGUI::should_run` condition spawns `npm list` several times which adds up to seconds of wall-time.\nEvaluate the condition lazily to to keep `./x.py test tidy` and similar short-running tasks fast.\n\nFixes #86147", "tree": {"sha": "2e946f1ab83131e2ef09f8721377199b34a9ccf9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2e946f1ab83131e2ef09f8721377199b34a9ccf9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e7a4f1e3fcb9af6841a07f073432b838193550d4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgz+BnCRBK7hj4Ov3rIwAAfVMIAK1D3dqucVjmSjooU3bz7ZFK\nv3FETxltWaijz3CK978LX6oBzlhA3bH2M9jd8Y8WKzJdiqj8W0PqfxUIycyFJJ/l\nwtypR5N8gehrs38Tsl+9voDZFM7EftalV9CozsQSkmcGP5m5zHwbiH3hxFaku8yy\ngNZjgTl6lD2zh9fHOAMdG0wdkTXcASsYrMbBQpqPgczUVGJOdPerc72DK9MUzr20\naA3va/I9uuXszyBMDq4d98EoqflUKbOAKOyRY63kcDGpPhAeZTKihd6Wuu8LvLT9\nGjjGb0wJFc69jB/afRAWppi2TSe7mI8jeKuzR9XFElj71uBELDpbwqYKdOQ7PSM=\n=+r35\n-----END PGP SIGNATURE-----\n", "payload": "tree 2e946f1ab83131e2ef09f8721377199b34a9ccf9\nparent e6732e05e4ff7af66084bf2c212a7fbf1ec6a574\nparent bde95700691cad1c508eb396e190a9d8638f024f\nauthor Yuki Okushi <jtitor@2k36.org> 1624236135 +0900\ncommitter GitHub <noreply@github.com> 1624236135 +0900\n\nRollup merge of #86152 - the8472:lazify-npm-queries, r=Mark-Simulacrum\n\nLazify is_really_default condition in the RustdocGUI bootstrap step\n\nThe `RustdocGUI::should_run` condition spawns `npm list` several times which adds up to seconds of wall-time.\nEvaluate the condition lazily to to keep `./x.py test tidy` and similar short-running tasks fast.\n\nFixes #86147\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e7a4f1e3fcb9af6841a07f073432b838193550d4", "html_url": "https://github.com/rust-lang/rust/commit/e7a4f1e3fcb9af6841a07f073432b838193550d4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e7a4f1e3fcb9af6841a07f073432b838193550d4/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e6732e05e4ff7af66084bf2c212a7fbf1ec6a574", "url": "https://api.github.com/repos/rust-lang/rust/commits/e6732e05e4ff7af66084bf2c212a7fbf1ec6a574", "html_url": "https://github.com/rust-lang/rust/commit/e6732e05e4ff7af66084bf2c212a7fbf1ec6a574"}, {"sha": "bde95700691cad1c508eb396e190a9d8638f024f", "url": "https://api.github.com/repos/rust-lang/rust/commits/bde95700691cad1c508eb396e190a9d8638f024f", "html_url": "https://github.com/rust-lang/rust/commit/bde95700691cad1c508eb396e190a9d8638f024f"}], "stats": {"total": 36, "additions": 28, "deletions": 8}, "files": [{"sha": "5e2987ee8267ed21a8e3aeca2eaa44bb5f3704a8", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e7a4f1e3fcb9af6841a07f073432b838193550d4/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/e7a4f1e3fcb9af6841a07f073432b838193550d4/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=e7a4f1e3fcb9af6841a07f073432b838193550d4", "patch": "@@ -179,6 +179,7 @@ dependencies = [\n  \"libc\",\n  \"merge\",\n  \"num_cpus\",\n+ \"once_cell\",\n  \"opener\",\n  \"pretty_assertions\",\n  \"serde\","}, {"sha": "d1e666936f88a3b778bbd33574c38061a3297cd7", "filename": "src/bootstrap/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e7a4f1e3fcb9af6841a07f073432b838193550d4/src%2Fbootstrap%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/e7a4f1e3fcb9af6841a07f073432b838193550d4/src%2Fbootstrap%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCargo.toml?ref=e7a4f1e3fcb9af6841a07f073432b838193550d4", "patch": "@@ -50,6 +50,7 @@ time = \"0.1\"\n ignore = \"0.4.10\"\n opener = \"0.4\"\n merge = \"0.1.0\"\n+once_cell = \"1.7.2\"\n \n [target.'cfg(windows)'.dependencies.winapi]\n version = \"0.3\""}, {"sha": "e2f605257bd9548235776640c268f435708d3851", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 23, "deletions": 5, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/e7a4f1e3fcb9af6841a07f073432b838193550d4/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e7a4f1e3fcb9af6841a07f073432b838193550d4/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=e7a4f1e3fcb9af6841a07f073432b838193550d4", "patch": "@@ -29,6 +29,8 @@ use crate::util::{self, add_dylib_path, add_link_lib_path, exe, libdir};\n use crate::{Build, DocTests, GitRepo, Mode};\n \n pub use crate::Compiler;\n+// FIXME: replace with std::lazy after it gets stabilized and reaches beta\n+use once_cell::sync::Lazy;\n \n pub struct Builder<'a> {\n     pub build: &'a Build,\n@@ -195,7 +197,7 @@ impl StepDescription {\n \n         if paths.is_empty() || builder.config.include_default_paths {\n             for (desc, should_run) in v.iter().zip(&should_runs) {\n-                if desc.default && should_run.is_really_default {\n+                if desc.default && should_run.is_really_default() {\n                     for pathset in &should_run.paths {\n                         desc.maybe_run(builder, pathset);\n                     }\n@@ -228,31 +230,47 @@ impl StepDescription {\n     }\n }\n \n-#[derive(Clone)]\n+enum ReallyDefault<'a> {\n+    Bool(bool),\n+    Lazy(Lazy<bool, Box<dyn Fn() -> bool + 'a>>),\n+}\n+\n pub struct ShouldRun<'a> {\n     pub builder: &'a Builder<'a>,\n     // use a BTreeSet to maintain sort order\n     paths: BTreeSet<PathSet>,\n \n     // If this is a default rule, this is an additional constraint placed on\n     // its run. Generally something like compiler docs being enabled.\n-    is_really_default: bool,\n+    is_really_default: ReallyDefault<'a>,\n }\n \n impl<'a> ShouldRun<'a> {\n     fn new(builder: &'a Builder<'_>) -> ShouldRun<'a> {\n         ShouldRun {\n             builder,\n             paths: BTreeSet::new(),\n-            is_really_default: true, // by default no additional conditions\n+            is_really_default: ReallyDefault::Bool(true), // by default no additional conditions\n         }\n     }\n \n     pub fn default_condition(mut self, cond: bool) -> Self {\n-        self.is_really_default = cond;\n+        self.is_really_default = ReallyDefault::Bool(cond);\n+        self\n+    }\n+\n+    pub fn lazy_default_condition(mut self, lazy_cond: Box<dyn Fn() -> bool + 'a>) -> Self {\n+        self.is_really_default = ReallyDefault::Lazy(Lazy::new(lazy_cond));\n         self\n     }\n \n+    pub fn is_really_default(&self) -> bool {\n+        match &self.is_really_default {\n+            ReallyDefault::Bool(val) => *val,\n+            ReallyDefault::Lazy(lazy) => *lazy.deref(),\n+        }\n+    }\n+\n     /// Indicates it should run if the command-line selects the given crate or\n     /// any of its (local) dependencies.\n     ///"}, {"sha": "319b56a0b7006af83d377c14cce669ef6ac26983", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e7a4f1e3fcb9af6841a07f073432b838193550d4/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e7a4f1e3fcb9af6841a07f073432b838193550d4/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=e7a4f1e3fcb9af6841a07f073432b838193550d4", "patch": "@@ -806,15 +806,15 @@ impl Step for RustdocGUI {\n     fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n         let builder = run.builder;\n         let run = run.suite_path(\"src/test/rustdoc-gui\");\n-        run.default_condition(\n+        run.lazy_default_condition(Box::new(move || {\n             builder.config.nodejs.is_some()\n                 && builder\n                     .config\n                     .npm\n                     .as_ref()\n                     .map(|p| check_if_browser_ui_test_is_installed(p))\n-                    .unwrap_or(false),\n-        )\n+                    .unwrap_or(false)\n+        }))\n     }\n \n     fn make_run(run: RunConfig<'_>) {"}]}