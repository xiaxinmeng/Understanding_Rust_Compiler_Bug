{"sha": "84b1d859c8caa6049bfe728b219f679286151bb2", "node_id": "C_kwDOAAsO6NoAKDg0YjFkODU5YzhjYWE2MDQ5YmZlNzI4YjIxOWY2NzkyODYxNTFiYjI", "commit": {"author": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-12-12T04:34:46Z"}, "committer": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-12-12T04:34:46Z"}, "message": "Revert \"Auto merge of #91491 - spastorino:revert-91354, r=oli-obk\"\n\nThis reverts commit ff2439b7b9bafcfdff86b7847128014699df8442, reversing\nchanges made to 2a9e0831d6603d87220cedd1b1293e2eb82ef55c.", "tree": {"sha": "472c311c437160a1bc2dd88d43d134e735e4a94b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/472c311c437160a1bc2dd88d43d134e735e4a94b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/84b1d859c8caa6049bfe728b219f679286151bb2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE3RQPHNISvvEnSKtjbQF6ltjmwvkFAmG1e+oACgkQbQF6ltjm\nwvnBWQ//VX+pHFh1J+dS55eKYM4FrzJPQgoukcisKeP9k72uuVZl5CYFvEiisr3b\nYfSfUjT9n/pobnyED1XCCT091Cmj7zqVR8fOWbS56eSWpUmcd6+cmyMU8oqRblvk\nIlB2zGvF9W1WPi1Tu54jaepg5z0NUq1t0++D8efRMBfrJOcaj40FrK+pyHQRCQsI\nUe3AEKqEJyQ42cTKGRAR1pDL7AJ6TxcX3NJp4bQbKEwUkMZygL31vy2Qee60Ah/b\n11jj0RiPrdtO2PQA/YSBFnq42pdHzkXrh79akM7tyyxk3xKosph63poJgMB9b66m\nm7xST78oP0VV33wGsYt/jo5KtPdcH6zomEuLRWXJobSbemjB+LQkoV1hRAH6wW6l\nQPwPDzZpS6HqrTlbgRVHhQCAeoO5QhXFdBM9/IdSTUSxYGqYlL7kqttrcii/WEQT\nOIMQ9ISC8EJR1jAmRt9ls6T1osPvtq+Vt/526P1eAE3l54hvktJvFHNEtuIFWO8C\naql3U8/xsy1w3FTry+k4HcVl+MteBsoPOyjs73zekGcdWdXw9dPVpyaDGO6PaG5i\nhVrPmZcf0Hp5wwljmow7Q3JHFe2vQVnQHvDS6BlxwFjY/qXx/fpqZMlLe3VHfAfx\nNoDEOsx9FAslGyfHKnYrZ9WHzwrUC11MXU8q/xD6HHFyV18FExA=\n=z8t1\n-----END PGP SIGNATURE-----", "payload": "tree 472c311c437160a1bc2dd88d43d134e735e4a94b\nparent c5f8788d8d3c158173450e21fe17c4034819816d\nauthor Deadbeef <ent3rm4n@gmail.com> 1639283686 +0800\ncommitter Deadbeef <ent3rm4n@gmail.com> 1639283686 +0800\n\nRevert \"Auto merge of #91491 - spastorino:revert-91354, r=oli-obk\"\n\nThis reverts commit ff2439b7b9bafcfdff86b7847128014699df8442, reversing\nchanges made to 2a9e0831d6603d87220cedd1b1293e2eb82ef55c.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/84b1d859c8caa6049bfe728b219f679286151bb2", "html_url": "https://github.com/rust-lang/rust/commit/84b1d859c8caa6049bfe728b219f679286151bb2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/84b1d859c8caa6049bfe728b219f679286151bb2/comments", "author": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c5f8788d8d3c158173450e21fe17c4034819816d", "url": "https://api.github.com/repos/rust-lang/rust/commits/c5f8788d8d3c158173450e21fe17c4034819816d", "html_url": "https://github.com/rust-lang/rust/commit/c5f8788d8d3c158173450e21fe17c4034819816d"}], "stats": {"total": 824, "additions": 400, "deletions": 424}, "files": [{"sha": "195ed13a02705455b8dd91566f10c427bd05fc3b", "filename": "compiler/rustc_borrowck/src/type_check/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -31,7 +31,7 @@ use rustc_middle::ty::fold::TypeFoldable;\n use rustc_middle::ty::subst::{GenericArgKind, SubstsRef, UserSubsts};\n use rustc_middle::ty::{\n     self, CanonicalUserTypeAnnotation, CanonicalUserTypeAnnotations, OpaqueTypeKey, RegionVid,\n-    ToPredicate, Ty, TyCtxt, UserType, UserTypeAnnotationIndex, WithConstness,\n+    ToPredicate, Ty, TyCtxt, UserType, UserTypeAnnotationIndex,\n };\n use rustc_span::def_id::CRATE_DEF_ID;\n use rustc_span::{Span, DUMMY_SP};"}, {"sha": "c5412affafe231797d1d3579f367a679c702dc5b", "filename": "compiler/rustc_const_eval/src/const_eval/eval_queries.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_const_eval%2Fsrc%2Fconst_eval%2Feval_queries.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_const_eval%2Fsrc%2Fconst_eval%2Feval_queries.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Fconst_eval%2Feval_queries.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -7,6 +7,7 @@ use crate::interpret::{\n };\n \n use rustc_errors::ErrorReported;\n+use rustc_hir as hir;\n use rustc_hir::def::DefKind;\n use rustc_middle::mir;\n use rustc_middle::mir::interpret::ErrorHandled;\n@@ -215,6 +216,7 @@ pub fn eval_to_const_value_raw_provider<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     key: ty::ParamEnvAnd<'tcx, GlobalId<'tcx>>,\n ) -> ::rustc_middle::mir::interpret::EvalToConstValueResult<'tcx> {\n+    assert!(key.param_env.constness() == hir::Constness::Const);\n     // see comment in eval_to_allocation_raw_provider for what we're doing here\n     if key.param_env.reveal() == Reveal::All {\n         let mut key = key;\n@@ -249,6 +251,7 @@ pub fn eval_to_allocation_raw_provider<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     key: ty::ParamEnvAnd<'tcx, GlobalId<'tcx>>,\n ) -> ::rustc_middle::mir::interpret::EvalToAllocationRawResult<'tcx> {\n+    assert!(key.param_env.constness() == hir::Constness::Const);\n     // Because the constant is computed twice (once per value of `Reveal`), we are at risk of\n     // reporting the same error twice here. To resolve this, we check whether we can evaluate the\n     // constant in the more restrictive `Reveal::UserFacing`, which most likely already was"}, {"sha": "39637d6c254647a6fbbc0cf8b2d01e0d5984fdd3", "filename": "compiler/rustc_const_eval/src/interpret/eval_context.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Feval_context.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Feval_context.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Feval_context.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -929,6 +929,7 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n         } else {\n             self.param_env\n         };\n+        let param_env = param_env.with_const();\n         let val = self.tcx.eval_to_allocation_raw(param_env.and(gid))?;\n         self.raw_const_to_mplace(val)\n     }"}, {"sha": "5a4aa06f3bbae10784f1a0835346debd13298b0d", "filename": "compiler/rustc_const_eval/src/transform/check_consts/check.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -817,8 +817,7 @@ impl Visitor<'tcx> for Checker<'mir, 'tcx> {\n                     );\n \n                     let implsrc = tcx.infer_ctxt().enter(|infcx| {\n-                        let mut selcx =\n-                            SelectionContext::with_constness(&infcx, hir::Constness::Const);\n+                        let mut selcx = SelectionContext::new(&infcx);\n                         selcx.select(&obligation)\n                     });\n "}, {"sha": "43612292f5283eb3937490e1fd6e7d86564d9383", "filename": "compiler/rustc_const_eval/src/transform/check_consts/qualifs.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fqualifs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fqualifs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fqualifs.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -3,7 +3,6 @@\n //! See the `Qualif` trait for more info.\n \n use rustc_errors::ErrorReported;\n-use rustc_hir as hir;\n use rustc_infer::infer::TyCtxtInferExt;\n use rustc_middle::mir::*;\n use rustc_middle::ty::{self, subst::SubstsRef, AdtDef, Ty};\n@@ -167,7 +166,7 @@ impl Qualif for NeedsNonConstDrop {\n         );\n \n         let implsrc = cx.tcx.infer_ctxt().enter(|infcx| {\n-            let mut selcx = SelectionContext::with_constness(&infcx, hir::Constness::Const);\n+            let mut selcx = SelectionContext::new(&infcx);\n             selcx.select(&obligation)\n         });\n         !matches!("}, {"sha": "28e1773a7502dc7be7e067a1d569dc7b12564373", "filename": "compiler/rustc_hir/src/hir.rs", "status": "modified", "additions": 24, "deletions": 21, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fhir.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -3210,28 +3210,31 @@ impl<'hir> Node<'hir> {\n         }\n     }\n \n-    /// Returns `Constness::Const` when this node is a const fn/impl/item.\n-    pub fn constness_for_typeck(&self) -> Constness {\n+    pub fn hir_id(&self) -> Option<HirId> {\n         match self {\n-            Node::Item(Item {\n-                kind: ItemKind::Fn(FnSig { header: FnHeader { constness, .. }, .. }, ..),\n-                ..\n-            })\n-            | Node::TraitItem(TraitItem {\n-                kind: TraitItemKind::Fn(FnSig { header: FnHeader { constness, .. }, .. }, ..),\n-                ..\n-            })\n-            | Node::ImplItem(ImplItem {\n-                kind: ImplItemKind::Fn(FnSig { header: FnHeader { constness, .. }, .. }, ..),\n-                ..\n-            })\n-            | Node::Item(Item { kind: ItemKind::Impl(Impl { constness, .. }), .. }) => *constness,\n-\n-            Node::Item(Item { kind: ItemKind::Const(..), .. })\n-            | Node::TraitItem(TraitItem { kind: TraitItemKind::Const(..), .. })\n-            | Node::ImplItem(ImplItem { kind: ImplItemKind::Const(..), .. }) => Constness::Const,\n-\n-            _ => Constness::NotConst,\n+            Node::Item(Item { def_id, .. })\n+            | Node::TraitItem(TraitItem { def_id, .. })\n+            | Node::ImplItem(ImplItem { def_id, .. })\n+            | Node::ForeignItem(ForeignItem { def_id, .. }) => Some(HirId::make_owner(*def_id)),\n+            Node::Field(FieldDef { hir_id, .. })\n+            | Node::AnonConst(AnonConst { hir_id, .. })\n+            | Node::Expr(Expr { hir_id, .. })\n+            | Node::Stmt(Stmt { hir_id, .. })\n+            | Node::Ty(Ty { hir_id, .. })\n+            | Node::Binding(Pat { hir_id, .. })\n+            | Node::Pat(Pat { hir_id, .. })\n+            | Node::Arm(Arm { hir_id, .. })\n+            | Node::Block(Block { hir_id, .. })\n+            | Node::Local(Local { hir_id, .. })\n+            | Node::Lifetime(Lifetime { hir_id, .. })\n+            | Node::Param(Param { hir_id, .. })\n+            | Node::Infer(InferArg { hir_id, .. })\n+            | Node::GenericParam(GenericParam { hir_id, .. }) => Some(*hir_id),\n+            Node::TraitRef(TraitRef { hir_ref_id, .. }) => Some(*hir_ref_id),\n+            Node::PathSegment(PathSegment { hir_id, .. }) => *hir_id,\n+            Node::Variant(Variant { id, .. }) => Some(*id),\n+            Node::Ctor(variant) => variant.ctor_hir_id(),\n+            Node::Crate(_) | Node::Visibility(_) => None,\n         }\n     }\n "}, {"sha": "822f2365e023f4dce34597087d7cb386e89cf3e3", "filename": "compiler/rustc_infer/src/traits/engine.rs", "status": "modified", "additions": 1, "deletions": 19, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Fengine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Fengine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Fengine.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -1,9 +1,8 @@\n use crate::infer::InferCtxt;\n use crate::traits::Obligation;\n use rustc_data_structures::fx::FxHashMap;\n-use rustc_hir as hir;\n use rustc_hir::def_id::DefId;\n-use rustc_middle::ty::{self, ToPredicate, Ty, WithConstness};\n+use rustc_middle::ty::{self, ToPredicate, Ty};\n \n use super::FulfillmentError;\n use super::{ObligationCause, PredicateObligation};\n@@ -48,26 +47,9 @@ pub trait TraitEngine<'tcx>: 'tcx {\n \n     fn select_all_or_error(&mut self, infcx: &InferCtxt<'_, 'tcx>) -> Vec<FulfillmentError<'tcx>>;\n \n-    fn select_all_with_constness_or_error(\n-        &mut self,\n-        infcx: &InferCtxt<'_, 'tcx>,\n-        _constness: hir::Constness,\n-    ) -> Vec<FulfillmentError<'tcx>> {\n-        self.select_all_or_error(infcx)\n-    }\n-\n     fn select_where_possible(&mut self, infcx: &InferCtxt<'_, 'tcx>)\n     -> Vec<FulfillmentError<'tcx>>;\n \n-    // FIXME(fee1-dead) this should not provide a default body for chalk as chalk should be updated\n-    fn select_with_constness_where_possible(\n-        &mut self,\n-        infcx: &InferCtxt<'_, 'tcx>,\n-        _constness: hir::Constness,\n-    ) -> Vec<FulfillmentError<'tcx>> {\n-        self.select_where_possible(infcx)\n-    }\n-\n     fn pending_obligations(&self) -> Vec<PredicateObligation<'tcx>>;\n \n     fn relationships(&mut self) -> &mut FxHashMap<ty::TyVid, ty::FoundRelationships>;"}, {"sha": "7e30f859dae4eaa52d4131bb839ff4bdfd95e03a", "filename": "compiler/rustc_infer/src/traits/mod.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Fmod.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -69,6 +69,16 @@ impl PredicateObligation<'tcx> {\n     }\n }\n \n+impl TraitObligation<'tcx> {\n+    /// Returns `true` if the trait predicate is considered `const` in its ParamEnv.\n+    pub fn is_const(&self) -> bool {\n+        match (self.predicate.skip_binder().constness, self.param_env.constness()) {\n+            (ty::BoundConstness::ConstIfConst, hir::Constness::Const) => true,\n+            _ => false,\n+        }\n+    }\n+}\n+\n // `PredicateObligation` is used a lot. Make sure it doesn't unintentionally get bigger.\n #[cfg(all(target_arch = \"x86_64\", target_pointer_width = \"64\"))]\n static_assert_size!(PredicateObligation<'_>, 32);"}, {"sha": "61588147364a9c37aaecb053fffb7dc62a8a5c70", "filename": "compiler/rustc_infer/src/traits/util.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Futil.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -3,7 +3,7 @@ use smallvec::smallvec;\n use crate::infer::outlives::components::{push_outlives_components, Component};\n use crate::traits::{Obligation, ObligationCause, PredicateObligation};\n use rustc_data_structures::fx::{FxHashSet, FxIndexSet};\n-use rustc_middle::ty::{self, ToPredicate, TyCtxt, WithConstness};\n+use rustc_middle::ty::{self, ToPredicate, TyCtxt};\n use rustc_span::symbol::Ident;\n use rustc_span::Span;\n \n@@ -328,8 +328,8 @@ pub fn transitive_bounds_that_define_assoc_type<'tcx>(\n                 ));\n                 for (super_predicate, _) in super_predicates.predicates {\n                     let subst_predicate = super_predicate.subst_supertrait(tcx, &trait_ref);\n-                    if let Some(binder) = subst_predicate.to_opt_poly_trait_ref() {\n-                        stack.push(binder.value);\n+                    if let Some(binder) = subst_predicate.to_opt_poly_trait_pred() {\n+                        stack.push(binder.map_bound(|t| t.trait_ref));\n                     }\n                 }\n \n@@ -362,8 +362,8 @@ impl<'tcx, I: Iterator<Item = PredicateObligation<'tcx>>> Iterator for FilterToT\n \n     fn next(&mut self) -> Option<ty::PolyTraitRef<'tcx>> {\n         while let Some(obligation) = self.base_iterator.next() {\n-            if let Some(data) = obligation.predicate.to_opt_poly_trait_ref() {\n-                return Some(data.value);\n+            if let Some(data) = obligation.predicate.to_opt_poly_trait_pred() {\n+                return Some(data.map_bound(|t| t.trait_ref));\n             }\n         }\n         None"}, {"sha": "394a1fc227095ba0a6125ae3f8adeb5e91c7e8a2", "filename": "compiler/rustc_middle/src/hir/map/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -474,7 +474,8 @@ impl<'hir> Map<'hir> {\n     /// Panics if `LocalDefId` does not have an associated body.\n     ///\n     /// This should only be used for determining the context of a body, a return\n-    /// value of `Some` does not always suggest that the owner of the body is `const`.\n+    /// value of `Some` does not always suggest that the owner of the body is `const`,\n+    /// just that it has to be checked as if it were.\n     pub fn body_const_context(&self, did: LocalDefId) -> Option<ConstContext> {\n         let hir_id = self.local_def_id_to_hir_id(did);\n         let ccx = match self.body_owner_kind(hir_id) {"}, {"sha": "f9831855633151ad1cf368d865dee4d2252900a8", "filename": "compiler/rustc_middle/src/mir/interpret/queries.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Fmir%2Finterpret%2Fqueries.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Fmir%2Finterpret%2Fqueries.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Finterpret%2Fqueries.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -64,6 +64,7 @@ impl<'tcx> TyCtxt<'tcx> {\n         cid: GlobalId<'tcx>,\n         span: Option<Span>,\n     ) -> EvalToConstValueResult<'tcx> {\n+        let param_env = param_env.with_const();\n         // Const-eval shouldn't depend on lifetimes at all, so we can erase them, which should\n         // improve caching of queries.\n         let inputs = self.erase_regions(param_env.and(cid));\n@@ -92,6 +93,7 @@ impl<'tcx> TyCtxt<'tcx> {\n         gid: GlobalId<'tcx>,\n         param_env: ty::ParamEnv<'tcx>,\n     ) -> Result<&'tcx mir::Allocation, ErrorHandled> {\n+        let param_env = param_env.with_const();\n         trace!(\"eval_to_allocation: Need to compute {:?}\", gid);\n         let raw_const = self.eval_to_allocation_raw(param_env.and(gid))?;\n         Ok(self.global_alloc(raw_const.alloc_id).unwrap_memory())"}, {"sha": "71ee00c602a3d158a603809007463a960cd49b48", "filename": "compiler/rustc_middle/src/traits/select.rs", "status": "modified", "additions": 4, "deletions": 6, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fselect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fselect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fselect.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -12,14 +12,12 @@ use rustc_hir::def_id::DefId;\n use rustc_query_system::cache::Cache;\n \n pub type SelectionCache<'tcx> = Cache<\n-    (ty::ConstnessAnd<ty::ParamEnvAnd<'tcx, ty::TraitRef<'tcx>>>, ty::ImplPolarity),\n+    ty::ParamEnvAnd<'tcx, ty::TraitPredicate<'tcx>>,\n     SelectionResult<'tcx, SelectionCandidate<'tcx>>,\n >;\n \n-pub type EvaluationCache<'tcx> = Cache<\n-    (ty::ParamEnvAnd<'tcx, ty::ConstnessAnd<ty::PolyTraitRef<'tcx>>>, ty::ImplPolarity),\n-    EvaluationResult,\n->;\n+pub type EvaluationCache<'tcx> =\n+    Cache<ty::ParamEnvAnd<'tcx, ty::PolyTraitPredicate<'tcx>>, EvaluationResult>;\n \n /// The selection process begins by considering all impls, where\n /// clauses, and so forth that might resolve an obligation. Sometimes\n@@ -103,7 +101,7 @@ pub enum SelectionCandidate<'tcx> {\n         /// `false` if there are no *further* obligations.\n         has_nested: bool,\n     },\n-    ParamCandidate((ty::ConstnessAnd<ty::PolyTraitRef<'tcx>>, ty::ImplPolarity)),\n+    ParamCandidate(ty::PolyTraitPredicate<'tcx>),\n     ImplCandidate(DefId),\n     AutoImplCandidate(DefId),\n "}, {"sha": "815f4824bc134f8dfbd9fd8b918298236c257fa9", "filename": "compiler/rustc_middle/src/traits/util.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Futil.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -26,9 +26,9 @@ impl<'tcx> Elaborator<'tcx> {\n             .predicates\n             .into_iter()\n             .flat_map(|(pred, _)| {\n-                pred.subst_supertrait(self.tcx, &trait_ref).to_opt_poly_trait_ref()\n+                pred.subst_supertrait(self.tcx, &trait_ref).to_opt_poly_trait_pred()\n             })\n-            .map(|t| t.value)\n+            .map(|t| t.map_bound(|pred| pred.trait_ref))\n             .filter(|supertrait_ref| self.visited.insert(*supertrait_ref));\n \n         self.stack.extend(supertrait_refs);"}, {"sha": "8d277240e6163bd96120f874520e502c37e017e2", "filename": "compiler/rustc_middle/src/ty/mod.rs", "status": "modified", "additions": 77, "deletions": 53, "changes": 130, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -230,6 +230,19 @@ pub enum BoundConstness {\n     ConstIfConst,\n }\n \n+impl BoundConstness {\n+    /// Reduce `self` and `constness` to two possible combined states instead of four.\n+    pub fn and(&mut self, constness: hir::Constness) -> hir::Constness {\n+        match (constness, self) {\n+            (hir::Constness::Const, BoundConstness::ConstIfConst) => hir::Constness::Const,\n+            (_, this) => {\n+                *this = BoundConstness::NotConst;\n+                hir::Constness::NotConst\n+            }\n+        }\n+    }\n+}\n+\n impl fmt::Display for BoundConstness {\n     fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n         match self {\n@@ -846,20 +859,6 @@ impl ToPredicate<'tcx> for Binder<'tcx, PredicateKind<'tcx>> {\n     }\n }\n \n-impl<'tcx> ToPredicate<'tcx> for ConstnessAnd<PolyTraitRef<'tcx>> {\n-    fn to_predicate(self, tcx: TyCtxt<'tcx>) -> Predicate<'tcx> {\n-        self.value\n-            .map_bound(|trait_ref| {\n-                PredicateKind::Trait(ty::TraitPredicate {\n-                    trait_ref,\n-                    constness: self.constness,\n-                    polarity: ty::ImplPolarity::Positive,\n-                })\n-            })\n-            .to_predicate(tcx)\n-    }\n-}\n-\n impl<'tcx> ToPredicate<'tcx> for PolyTraitPredicate<'tcx> {\n     fn to_predicate(self, tcx: TyCtxt<'tcx>) -> Predicate<'tcx> {\n         self.map_bound(PredicateKind::Trait).to_predicate(tcx)\n@@ -885,12 +884,10 @@ impl<'tcx> ToPredicate<'tcx> for PolyProjectionPredicate<'tcx> {\n }\n \n impl<'tcx> Predicate<'tcx> {\n-    pub fn to_opt_poly_trait_ref(self) -> Option<ConstnessAnd<PolyTraitRef<'tcx>>> {\n+    pub fn to_opt_poly_trait_pred(self) -> Option<PolyTraitPredicate<'tcx>> {\n         let predicate = self.kind();\n         match predicate.skip_binder() {\n-            PredicateKind::Trait(t) => {\n-                Some(ConstnessAnd { constness: t.constness, value: predicate.rebind(t.trait_ref) })\n-            }\n+            PredicateKind::Trait(t) => Some(predicate.rebind(t)),\n             PredicateKind::Projection(..)\n             | PredicateKind::Subtype(..)\n             | PredicateKind::Coerce(..)\n@@ -1221,23 +1218,33 @@ pub struct ParamEnv<'tcx> {\n     /// want `Reveal::All`.\n     ///\n     /// Note: This is packed, use the reveal() method to access it.\n-    packed: CopyTaggedPtr<&'tcx List<Predicate<'tcx>>, traits::Reveal, true>,\n+    packed: CopyTaggedPtr<&'tcx List<Predicate<'tcx>>, ParamTag, true>,\n }\n \n-unsafe impl rustc_data_structures::tagged_ptr::Tag for traits::Reveal {\n-    const BITS: usize = 1;\n+#[derive(Copy, Clone)]\n+struct ParamTag {\n+    reveal: traits::Reveal,\n+    constness: hir::Constness,\n+}\n+\n+unsafe impl rustc_data_structures::tagged_ptr::Tag for ParamTag {\n+    const BITS: usize = 2;\n     #[inline]\n     fn into_usize(self) -> usize {\n         match self {\n-            traits::Reveal::UserFacing => 0,\n-            traits::Reveal::All => 1,\n+            Self { reveal: traits::Reveal::UserFacing, constness: hir::Constness::NotConst } => 0,\n+            Self { reveal: traits::Reveal::All, constness: hir::Constness::NotConst } => 1,\n+            Self { reveal: traits::Reveal::UserFacing, constness: hir::Constness::Const } => 2,\n+            Self { reveal: traits::Reveal::All, constness: hir::Constness::Const } => 3,\n         }\n     }\n     #[inline]\n     unsafe fn from_usize(ptr: usize) -> Self {\n         match ptr {\n-            0 => traits::Reveal::UserFacing,\n-            1 => traits::Reveal::All,\n+            0 => Self { reveal: traits::Reveal::UserFacing, constness: hir::Constness::NotConst },\n+            1 => Self { reveal: traits::Reveal::All, constness: hir::Constness::NotConst },\n+            2 => Self { reveal: traits::Reveal::UserFacing, constness: hir::Constness::Const },\n+            3 => Self { reveal: traits::Reveal::All, constness: hir::Constness::Const },\n             _ => std::hint::unreachable_unchecked(),\n         }\n     }\n@@ -1248,6 +1255,7 @@ impl<'tcx> fmt::Debug for ParamEnv<'tcx> {\n         f.debug_struct(\"ParamEnv\")\n             .field(\"caller_bounds\", &self.caller_bounds())\n             .field(\"reveal\", &self.reveal())\n+            .field(\"constness\", &self.constness())\n             .finish()\n     }\n }\n@@ -1256,6 +1264,7 @@ impl<'a, 'tcx> HashStable<StableHashingContext<'a>> for ParamEnv<'tcx> {\n     fn hash_stable(&self, hcx: &mut StableHashingContext<'a>, hasher: &mut StableHasher) {\n         self.caller_bounds().hash_stable(hcx, hasher);\n         self.reveal().hash_stable(hcx, hasher);\n+        self.constness().hash_stable(hcx, hasher);\n     }\n }\n \n@@ -1267,12 +1276,14 @@ impl<'tcx> TypeFoldable<'tcx> for ParamEnv<'tcx> {\n         Ok(ParamEnv::new(\n             self.caller_bounds().try_fold_with(folder)?,\n             self.reveal().try_fold_with(folder)?,\n+            self.constness().try_fold_with(folder)?,\n         ))\n     }\n \n     fn super_visit_with<V: TypeVisitor<'tcx>>(&self, visitor: &mut V) -> ControlFlow<V::BreakTy> {\n         self.caller_bounds().visit_with(visitor)?;\n-        self.reveal().visit_with(visitor)\n+        self.reveal().visit_with(visitor)?;\n+        self.constness().visit_with(visitor)\n     }\n }\n \n@@ -1283,7 +1294,7 @@ impl<'tcx> ParamEnv<'tcx> {\n     /// type-checking.\n     #[inline]\n     pub fn empty() -> Self {\n-        Self::new(List::empty(), Reveal::UserFacing)\n+        Self::new(List::empty(), Reveal::UserFacing, hir::Constness::NotConst)\n     }\n \n     #[inline]\n@@ -1293,7 +1304,12 @@ impl<'tcx> ParamEnv<'tcx> {\n \n     #[inline]\n     pub fn reveal(self) -> traits::Reveal {\n-        self.packed.tag()\n+        self.packed.tag().reveal\n+    }\n+\n+    #[inline]\n+    pub fn constness(self) -> hir::Constness {\n+        self.packed.tag().constness\n     }\n \n     /// Construct a trait environment with no where-clauses in scope\n@@ -1305,17 +1321,31 @@ impl<'tcx> ParamEnv<'tcx> {\n     /// or invoke `param_env.with_reveal_all()`.\n     #[inline]\n     pub fn reveal_all() -> Self {\n-        Self::new(List::empty(), Reveal::All)\n+        Self::new(List::empty(), Reveal::All, hir::Constness::NotConst)\n     }\n \n     /// Construct a trait environment with the given set of predicates.\n     #[inline]\n-    pub fn new(caller_bounds: &'tcx List<Predicate<'tcx>>, reveal: Reveal) -> Self {\n-        ty::ParamEnv { packed: CopyTaggedPtr::new(caller_bounds, reveal) }\n+    pub fn new(\n+        caller_bounds: &'tcx List<Predicate<'tcx>>,\n+        reveal: Reveal,\n+        constness: hir::Constness,\n+    ) -> Self {\n+        ty::ParamEnv { packed: CopyTaggedPtr::new(caller_bounds, ParamTag { reveal, constness }) }\n     }\n \n     pub fn with_user_facing(mut self) -> Self {\n-        self.packed.set_tag(Reveal::UserFacing);\n+        self.packed.set_tag(ParamTag { reveal: Reveal::UserFacing, ..self.packed.tag() });\n+        self\n+    }\n+\n+    pub fn with_constness(mut self, constness: hir::Constness) -> Self {\n+        self.packed.set_tag(ParamTag { constness, ..self.packed.tag() });\n+        self\n+    }\n+\n+    pub fn with_const(mut self) -> Self {\n+        self.packed.set_tag(ParamTag { constness: hir::Constness::Const, ..self.packed.tag() });\n         self\n     }\n \n@@ -1334,17 +1364,21 @@ impl<'tcx> ParamEnv<'tcx> {\n     /// will be normalized to their underlying types.\n     /// See PR #65989 and issue #65918 for more details\n     pub fn with_reveal_all_normalized(self, tcx: TyCtxt<'tcx>) -> Self {\n-        if self.packed.tag() == traits::Reveal::All {\n+        if self.packed.tag().reveal == traits::Reveal::All {\n             return self;\n         }\n \n-        ParamEnv::new(tcx.normalize_opaque_types(self.caller_bounds()), Reveal::All)\n+        ParamEnv::new(\n+            tcx.normalize_opaque_types(self.caller_bounds()),\n+            Reveal::All,\n+            self.constness(),\n+        )\n     }\n \n     /// Returns this same environment but with no caller bounds.\n     #[inline]\n     pub fn without_caller_bounds(self) -> Self {\n-        Self::new(List::empty(), self.reveal())\n+        Self::new(List::empty(), self.reveal(), self.constness())\n     }\n \n     /// Creates a suitable environment in which to perform trait\n@@ -1374,33 +1408,23 @@ impl<'tcx> ParamEnv<'tcx> {\n     }\n }\n \n-#[derive(Copy, Clone, Debug, PartialEq, Eq, Hash, TypeFoldable)]\n-pub struct ConstnessAnd<T> {\n-    pub constness: BoundConstness,\n-    pub value: T,\n-}\n-\n // FIXME(ecstaticmorse): Audit all occurrences of `without_const().to_predicate(tcx)` to ensure that\n // the constness of trait bounds is being propagated correctly.\n-pub trait WithConstness: Sized {\n-    #[inline]\n-    fn with_constness(self, constness: BoundConstness) -> ConstnessAnd<Self> {\n-        ConstnessAnd { constness, value: self }\n-    }\n-\n+impl PolyTraitRef<'tcx> {\n     #[inline]\n-    fn with_const_if_const(self) -> ConstnessAnd<Self> {\n-        self.with_constness(BoundConstness::ConstIfConst)\n+    pub fn with_constness(self, constness: BoundConstness) -> PolyTraitPredicate<'tcx> {\n+        self.map_bound(|trait_ref| ty::TraitPredicate {\n+            trait_ref,\n+            constness,\n+            polarity: ty::ImplPolarity::Positive,\n+        })\n     }\n-\n     #[inline]\n-    fn without_const(self) -> ConstnessAnd<Self> {\n+    pub fn without_const(self) -> PolyTraitPredicate<'tcx> {\n         self.with_constness(BoundConstness::NotConst)\n     }\n }\n \n-impl<T> WithConstness for T {}\n-\n #[derive(Copy, Clone, Debug, PartialEq, Eq, Hash, TypeFoldable)]\n pub struct ParamEnvAnd<'tcx, T> {\n     pub param_env: ParamEnv<'tcx>,"}, {"sha": "b6aadf27bb08b728ce2b06e564c0f572af4749f3", "filename": "compiler/rustc_middle/src/ty/relate.rs", "status": "modified", "additions": 0, "deletions": 13, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Fty%2Frelate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Fty%2Frelate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Frelate.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -218,19 +218,6 @@ impl<'tcx> Relate<'tcx> for ty::BoundConstness {\n     }\n }\n \n-impl<'tcx, T: Relate<'tcx>> Relate<'tcx> for ty::ConstnessAnd<T> {\n-    fn relate<R: TypeRelation<'tcx>>(\n-        relation: &mut R,\n-        a: ty::ConstnessAnd<T>,\n-        b: ty::ConstnessAnd<T>,\n-    ) -> RelateResult<'tcx, ty::ConstnessAnd<T>> {\n-        Ok(ty::ConstnessAnd {\n-            constness: relation.relate(a.constness, b.constness)?,\n-            value: relation.relate(a.value, b.value)?,\n-        })\n-    }\n-}\n-\n impl<'tcx> Relate<'tcx> for ast::Unsafety {\n     fn relate<R: TypeRelation<'tcx>>(\n         relation: &mut R,"}, {"sha": "30ed008a5deeb9d7737d7582d83abbdf7d300a86", "filename": "compiler/rustc_middle/src/ty/structural_impls.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Fty%2Fstructural_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Fty%2Fstructural_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fstructural_impls.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -480,7 +480,7 @@ impl<'a, 'tcx> Lift<'tcx> for ty::ParamEnv<'a> {\n     type Lifted = ty::ParamEnv<'tcx>;\n     fn lift_to_tcx(self, tcx: TyCtxt<'tcx>) -> Option<Self::Lifted> {\n         tcx.lift(self.caller_bounds())\n-            .map(|caller_bounds| ty::ParamEnv::new(caller_bounds, self.reveal()))\n+            .map(|caller_bounds| ty::ParamEnv::new(caller_bounds, self.reveal(), self.constness()))\n     }\n }\n "}, {"sha": "a80fe6a3362b4821955cd99c1da7044c8e54b12d", "filename": "compiler/rustc_middle/src/ty/sty.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -8,9 +8,7 @@ use crate::infer::canonical::Canonical;\n use crate::ty::fold::ValidateBoundVars;\n use crate::ty::subst::{GenericArg, InternalSubsts, Subst, SubstsRef};\n use crate::ty::InferTy::{self, *};\n-use crate::ty::{\n-    self, AdtDef, DefIdTree, Discr, Ty, TyCtxt, TypeFlags, TypeFoldable, WithConstness,\n-};\n+use crate::ty::{self, AdtDef, DefIdTree, Discr, Ty, TyCtxt, TypeFlags, TypeFoldable};\n use crate::ty::{DelaySpanBugEmitted, List, ParamEnv, TyS};\n use polonius_engine::Atom;\n use rustc_data_structures::captures::Captures;"}, {"sha": "46c74660f86a1364b21959744cfde3f75cad92b0", "filename": "compiler/rustc_trait_selection/src/autoderef.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Fautoderef.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Fautoderef.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Fautoderef.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -3,7 +3,7 @@ use crate::traits::{self, TraitEngine};\n use rustc_errors::struct_span_err;\n use rustc_hir as hir;\n use rustc_infer::infer::InferCtxt;\n-use rustc_middle::ty::{self, TraitRef, Ty, TyCtxt, WithConstness};\n+use rustc_middle::ty::{self, TraitRef, Ty, TyCtxt};\n use rustc_middle::ty::{ToPredicate, TypeFoldable};\n use rustc_session::{DiagnosticMessageId, Limit};\n use rustc_span::def_id::LOCAL_CRATE;"}, {"sha": "f135f0c1b13d2d0da0707eead4c68b82d33bce60", "filename": "compiler/rustc_trait_selection/src/infer.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Finfer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Finfer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Finfer.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -9,7 +9,6 @@ use rustc_middle::infer::canonical::{Canonical, CanonicalizedQueryResponse, Quer\n use rustc_middle::traits::query::Fallible;\n use rustc_middle::ty::subst::SubstsRef;\n use rustc_middle::ty::ToPredicate;\n-use rustc_middle::ty::WithConstness;\n use rustc_middle::ty::{self, Ty, TypeFoldable};\n use rustc_span::{Span, DUMMY_SP};\n "}, {"sha": "3642aebaec2fb50245fabc556a8ee08ee48c10fc", "filename": "compiler/rustc_trait_selection/src/traits/auto_trait.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fauto_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fauto_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fauto_trait.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -370,12 +370,17 @@ impl AutoTraitFinder<'tcx> {\n                 computed_preds.clone().chain(user_computed_preds.iter().cloned()),\n             )\n             .map(|o| o.predicate);\n-            new_env = ty::ParamEnv::new(tcx.mk_predicates(normalized_preds), param_env.reveal());\n+            new_env = ty::ParamEnv::new(\n+                tcx.mk_predicates(normalized_preds),\n+                param_env.reveal(),\n+                param_env.constness(),\n+            );\n         }\n \n         let final_user_env = ty::ParamEnv::new(\n             tcx.mk_predicates(user_computed_preds.into_iter()),\n             user_env.reveal(),\n+            user_env.constness(),\n         );\n         debug!(\n             \"evaluate_nested_obligations(ty={:?}, trait_did={:?}): succeeded with '{:?}' \\"}, {"sha": "310eecc6e85f27ed3ea64e0b0b868e5cacaa0cc2", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -24,7 +24,7 @@ use rustc_middle::ty::error::ExpectedFound;\n use rustc_middle::ty::fold::TypeFolder;\n use rustc_middle::ty::{\n     self, fast_reject, AdtKind, SubtypePredicate, ToPolyTraitRef, ToPredicate, Ty, TyCtxt,\n-    TypeFoldable, WithConstness,\n+    TypeFoldable,\n };\n use rustc_session::DiagnosticMessageId;\n use rustc_span::symbol::{kw, sym};"}, {"sha": "286c9c9900b95d24a63138ad91fd9f02c54d23b0", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -21,7 +21,7 @@ use rustc_hir::lang_items::LangItem;\n use rustc_hir::{AsyncGeneratorKind, GeneratorKind, Node};\n use rustc_middle::ty::{\n     self, suggest_arbitrary_trait_bound, suggest_constraining_type_param, AdtKind, DefIdTree,\n-    Infer, InferTy, ToPredicate, Ty, TyCtxt, TypeFoldable, WithConstness,\n+    Infer, InferTy, ToPredicate, Ty, TyCtxt, TypeFoldable,\n };\n use rustc_middle::ty::{TypeAndMut, TypeckResults};\n use rustc_session::Limit;"}, {"sha": "8a60f9b8602f6ed407236baa65ee4dde4fcc2861", "filename": "compiler/rustc_trait_selection/src/traits/fulfill.rs", "status": "modified", "additions": 2, "deletions": 37, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ffulfill.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ffulfill.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ffulfill.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -4,7 +4,6 @@ use rustc_data_structures::obligation_forest::ProcessResult;\n use rustc_data_structures::obligation_forest::{Error, ForestObligation, Outcome};\n use rustc_data_structures::obligation_forest::{ObligationForest, ObligationProcessor};\n use rustc_errors::ErrorReported;\n-use rustc_hir as hir;\n use rustc_infer::traits::{SelectionError, TraitEngine, TraitEngineExt as _, TraitObligation};\n use rustc_middle::mir::interpret::ErrorHandled;\n use rustc_middle::thir::abstract_const::NotConstEvaluatable;\n@@ -231,21 +230,6 @@ impl<'tcx> TraitEngine<'tcx> for FulfillmentContext<'tcx> {\n         self.predicates.to_errors(CodeAmbiguity).into_iter().map(to_fulfillment_error).collect()\n     }\n \n-    fn select_all_with_constness_or_error(\n-        &mut self,\n-        infcx: &InferCtxt<'_, 'tcx>,\n-        constness: rustc_hir::Constness,\n-    ) -> Vec<FulfillmentError<'tcx>> {\n-        {\n-            let errors = self.select_with_constness_where_possible(infcx, constness);\n-            if !errors.is_empty() {\n-                return errors;\n-            }\n-        }\n-\n-        self.predicates.to_errors(CodeAmbiguity).into_iter().map(to_fulfillment_error).collect()\n-    }\n-\n     fn select_where_possible(\n         &mut self,\n         infcx: &InferCtxt<'_, 'tcx>,\n@@ -254,15 +238,6 @@ impl<'tcx> TraitEngine<'tcx> for FulfillmentContext<'tcx> {\n         self.select(&mut selcx)\n     }\n \n-    fn select_with_constness_where_possible(\n-        &mut self,\n-        infcx: &InferCtxt<'_, 'tcx>,\n-        constness: hir::Constness,\n-    ) -> Vec<FulfillmentError<'tcx>> {\n-        let mut selcx = SelectionContext::with_constness(infcx, constness);\n-        self.select(&mut selcx)\n-    }\n-\n     fn pending_obligations(&self) -> Vec<PredicateObligation<'tcx>> {\n         self.predicates.map_pending_obligations(|o| o.obligation.clone())\n     }\n@@ -679,12 +654,7 @@ impl<'a, 'b, 'tcx> FulfillProcessor<'a, 'b, 'tcx> {\n         if obligation.predicate.is_known_global() {\n             // no type variables present, can use evaluation for better caching.\n             // FIXME: consider caching errors too.\n-            //\n-            // If the predicate is considered const, then we cannot use this because\n-            // it will cause false negatives in the ui tests.\n-            if !self.selcx.is_predicate_const(obligation.predicate)\n-                && infcx.predicate_must_hold_considering_regions(obligation)\n-            {\n+            if infcx.predicate_must_hold_considering_regions(obligation) {\n                 debug!(\n                     \"selecting trait at depth {} evaluated to holds\",\n                     obligation.recursion_depth\n@@ -738,12 +708,7 @@ impl<'a, 'b, 'tcx> FulfillProcessor<'a, 'b, 'tcx> {\n         if obligation.predicate.is_global(tcx) {\n             // no type variables present, can use evaluation for better caching.\n             // FIXME: consider caching errors too.\n-            //\n-            // If the predicate is considered const, then we cannot use this because\n-            // it will cause false negatives in the ui tests.\n-            if !self.selcx.is_predicate_const(obligation.predicate)\n-                && self.selcx.infcx().predicate_must_hold_considering_regions(obligation)\n-            {\n+            if self.selcx.infcx().predicate_must_hold_considering_regions(obligation) {\n                 return ProcessResult::Changed(vec![]);\n             } else {\n                 tracing::debug!(\"Does NOT hold: {:?}\", obligation);"}, {"sha": "d81b6949cae62a7a0462bf4c27ab5c619be16696", "filename": "compiler/rustc_trait_selection/src/traits/mod.rs", "status": "modified", "additions": 26, "deletions": 10, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -33,8 +33,7 @@ use rustc_hir::lang_items::LangItem;\n use rustc_middle::ty::fold::TypeFoldable;\n use rustc_middle::ty::subst::{InternalSubsts, SubstsRef};\n use rustc_middle::ty::{\n-    self, GenericParamDefKind, ToPredicate, Ty, TyCtxt, VtblEntry, WithConstness,\n-    COMMON_VTABLE_ENTRIES,\n+    self, GenericParamDefKind, ToPredicate, Ty, TyCtxt, VtblEntry, COMMON_VTABLE_ENTRIES,\n };\n use rustc_span::{sym, Span};\n use smallvec::SmallVec;\n@@ -307,8 +306,11 @@ pub fn normalize_param_env_or_error<'tcx>(\n \n     debug!(\"normalize_param_env_or_error: elaborated-predicates={:?}\", predicates);\n \n-    let elaborated_env =\n-        ty::ParamEnv::new(tcx.intern_predicates(&predicates), unnormalized_env.reveal());\n+    let elaborated_env = ty::ParamEnv::new(\n+        tcx.intern_predicates(&predicates),\n+        unnormalized_env.reveal(),\n+        unnormalized_env.constness(),\n+    );\n \n     // HACK: we are trying to normalize the param-env inside *itself*. The problem is that\n     // normalization expects its param-env to be already normalized, which means we have\n@@ -360,8 +362,11 @@ pub fn normalize_param_env_or_error<'tcx>(\n     // predicates here anyway. Keeping them here anyway because it seems safer.\n     let outlives_env: Vec<_> =\n         non_outlives_predicates.iter().chain(&outlives_predicates).cloned().collect();\n-    let outlives_env =\n-        ty::ParamEnv::new(tcx.intern_predicates(&outlives_env), unnormalized_env.reveal());\n+    let outlives_env = ty::ParamEnv::new(\n+        tcx.intern_predicates(&outlives_env),\n+        unnormalized_env.reveal(),\n+        unnormalized_env.constness(),\n+    );\n     let outlives_predicates = match do_normalize_predicates(\n         tcx,\n         region_context,\n@@ -381,7 +386,11 @@ pub fn normalize_param_env_or_error<'tcx>(\n     let mut predicates = non_outlives_predicates;\n     predicates.extend(outlives_predicates);\n     debug!(\"normalize_param_env_or_error: final predicates={:?}\", predicates);\n-    ty::ParamEnv::new(tcx.intern_predicates(&predicates), unnormalized_env.reveal())\n+    ty::ParamEnv::new(\n+        tcx.intern_predicates(&predicates),\n+        unnormalized_env.reveal(),\n+        unnormalized_env.constness(),\n+    )\n }\n \n pub fn fully_normalize<'a, 'tcx, T>(\n@@ -564,14 +573,17 @@ fn prepare_vtable_segments<'tcx, T>(\n                     .predicates\n                     .into_iter()\n                     .filter_map(move |(pred, _)| {\n-                        pred.subst_supertrait(tcx, &inner_most_trait_ref).to_opt_poly_trait_ref()\n+                        pred.subst_supertrait(tcx, &inner_most_trait_ref).to_opt_poly_trait_pred()\n                     });\n \n                 'diving_in_skip_visited_traits: loop {\n                     if let Some(next_super_trait) = direct_super_traits_iter.next() {\n                         if visited.insert(next_super_trait.to_predicate(tcx)) {\n+                            // We're throwing away potential constness of super traits here.\n+                            // FIXME: handle ~const super traits\n+                            let next_super_trait = next_super_trait.map_bound(|t| t.trait_ref);\n                             stack.push((\n-                                next_super_trait.value,\n+                                next_super_trait,\n                                 emit_vptr_on_new_entry,\n                                 Some(direct_super_traits_iter),\n                             ));\n@@ -603,7 +615,11 @@ fn prepare_vtable_segments<'tcx, T>(\n                     if let Some(siblings) = siblings_opt {\n                         if let Some(next_inner_most_trait_ref) = siblings.next() {\n                             if visited.insert(next_inner_most_trait_ref.to_predicate(tcx)) {\n-                                *inner_most_trait_ref = next_inner_most_trait_ref.value;\n+                                // We're throwing away potential constness of super traits here.\n+                                // FIXME: handle ~const super traits\n+                                let next_inner_most_trait_ref =\n+                                    next_inner_most_trait_ref.map_bound(|t| t.trait_ref);\n+                                *inner_most_trait_ref = next_inner_most_trait_ref;\n                                 *emit_vptr = emit_vptr_on_new_entry;\n                                 break 'exiting_out;\n                             } else {"}, {"sha": "c9afd93af7103e46ded982d441a6e45cbdd2f39b", "filename": "compiler/rustc_trait_selection/src/traits/object_safety.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fobject_safety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fobject_safety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fobject_safety.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -18,7 +18,7 @@ use rustc_errors::FatalError;\n use rustc_hir as hir;\n use rustc_hir::def_id::DefId;\n use rustc_middle::ty::subst::{GenericArg, InternalSubsts, Subst};\n-use rustc_middle::ty::{self, Ty, TyCtxt, TypeFoldable, TypeVisitor, WithConstness};\n+use rustc_middle::ty::{self, Ty, TyCtxt, TypeFoldable, TypeVisitor};\n use rustc_middle::ty::{Predicate, ToPredicate};\n use rustc_session::lint::builtin::WHERE_CLAUSES_OBJECT_SAFETY;\n use rustc_span::symbol::Symbol;\n@@ -694,7 +694,11 @@ fn receiver_is_dispatchable<'tcx>(\n         let caller_bounds: Vec<Predicate<'tcx>> =\n             param_env.caller_bounds().iter().chain([unsize_predicate, trait_predicate]).collect();\n \n-        ty::ParamEnv::new(tcx.intern_predicates(&caller_bounds), param_env.reveal())\n+        ty::ParamEnv::new(\n+            tcx.intern_predicates(&caller_bounds),\n+            param_env.reveal(),\n+            param_env.constness(),\n+        )\n     };\n \n     // Receiver: DispatchFromDyn<Receiver[Self => U]>"}, {"sha": "79ed6656819517be45657913fce23d3036349fac", "filename": "compiler/rustc_trait_selection/src/traits/project.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -27,7 +27,7 @@ use rustc_hir::lang_items::LangItem;\n use rustc_infer::infer::resolve::OpportunisticRegionResolver;\n use rustc_middle::ty::fold::{TypeFoldable, TypeFolder};\n use rustc_middle::ty::subst::Subst;\n-use rustc_middle::ty::{self, ToPredicate, Ty, TyCtxt, WithConstness};\n+use rustc_middle::ty::{self, ToPredicate, Ty, TyCtxt};\n use rustc_span::symbol::sym;\n \n use std::collections::BTreeMap;"}, {"sha": "017f47d4357fb9aa79f5a4064aca2ae50bdb797d", "filename": "compiler/rustc_trait_selection/src/traits/select/candidate_assembly.rs", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -11,7 +11,7 @@ use rustc_infer::traits::TraitEngine;\n use rustc_infer::traits::{Obligation, SelectionError, TraitObligation};\n use rustc_lint_defs::builtin::DEREF_INTO_DYN_SUPERTRAIT;\n use rustc_middle::ty::print::with_no_trimmed_paths;\n-use rustc_middle::ty::{self, ToPredicate, Ty, TypeFoldable, WithConstness};\n+use rustc_middle::ty::{self, ToPredicate, Ty, TypeFoldable};\n use rustc_target::spec::abi::Abi;\n \n use crate::traits;\n@@ -303,7 +303,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             } else if lang_items.drop_trait() == Some(def_id)\n                 && obligation.predicate.skip_binder().constness == ty::BoundConstness::ConstIfConst\n             {\n-                if self.is_in_const_context {\n+                if obligation.param_env.constness() == hir::Constness::Const {\n                     self.assemble_const_drop_candidates(obligation, stack, &mut candidates)?;\n                 } else {\n                     debug!(\"passing ~const Drop bound; in non-const context\");\n@@ -381,17 +381,19 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             .param_env\n             .caller_bounds()\n             .iter()\n-            .filter_map(|o| o.to_opt_poly_trait_ref());\n+            .filter_map(|o| o.to_opt_poly_trait_pred());\n \n         // Micro-optimization: filter out predicates relating to different traits.\n         let matching_bounds =\n-            all_bounds.filter(|p| p.value.def_id() == stack.obligation.predicate.def_id());\n+            all_bounds.filter(|p| p.def_id() == stack.obligation.predicate.def_id());\n \n         // Keep only those bounds which may apply, and propagate overflow if it occurs.\n         for bound in matching_bounds {\n-            let wc = self.evaluate_where_clause(stack, bound.value)?;\n+            // FIXME(oli-obk): it is suspicious that we are dropping the constness and\n+            // polarity here.\n+            let wc = self.evaluate_where_clause(stack, bound.map_bound(|t| t.trait_ref))?;\n             if wc.may_apply() {\n-                candidates.vec.push(ParamCandidate((bound, stack.obligation.polarity())));\n+                candidates.vec.push(ParamCandidate(bound));\n             }\n         }\n "}, {"sha": "e9b368f683e5b8fd8ea1832488afc52f2b80247e", "filename": "compiler/rustc_trait_selection/src/traits/select/confirmation.rs", "status": "modified", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fconfirmation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fconfirmation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fconfirmation.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -13,7 +13,7 @@ use rustc_infer::infer::InferOk;\n use rustc_infer::infer::LateBoundRegionConversionTime::HigherRankedType;\n use rustc_middle::ty::subst::{GenericArg, GenericArgKind, Subst, SubstsRef};\n use rustc_middle::ty::{self, Ty};\n-use rustc_middle::ty::{ToPolyTraitRef, ToPredicate, WithConstness};\n+use rustc_middle::ty::{ToPolyTraitRef, ToPredicate};\n use rustc_span::def_id::DefId;\n \n use crate::traits::project::{normalize_with_depth, normalize_with_depth_to};\n@@ -58,8 +58,9 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             }\n \n             ParamCandidate(param) => {\n-                let obligations = self.confirm_param_candidate(obligation, param.0.value);\n-                Ok(ImplSource::Param(obligations, param.0.constness))\n+                let obligations =\n+                    self.confirm_param_candidate(obligation, param.map_bound(|t| t.trait_ref));\n+                Ok(ImplSource::Param(obligations, param.skip_binder().constness))\n             }\n \n             ImplCandidate(impl_def_id) => {\n@@ -139,7 +140,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n \n             let trait_predicate = self.infcx.shallow_resolve(obligation.predicate);\n             let placeholder_trait_predicate =\n-                self.infcx().replace_bound_vars_with_placeholders(trait_predicate);\n+                self.infcx().replace_bound_vars_with_placeholders(trait_predicate).trait_ref;\n             let placeholder_self_ty = placeholder_trait_predicate.self_ty();\n             let placeholder_trait_predicate = ty::Binder::dummy(placeholder_trait_predicate);\n             let (def_id, substs) = match *placeholder_self_ty.kind() {\n@@ -150,8 +151,9 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n \n             let candidate_predicate = tcx.item_bounds(def_id)[idx].subst(tcx, substs);\n             let candidate = candidate_predicate\n-                .to_opt_poly_trait_ref()\n-                .expect(\"projection candidate is not a trait predicate\");\n+                .to_opt_poly_trait_pred()\n+                .expect(\"projection candidate is not a trait predicate\")\n+                .map_bound(|t| t.trait_ref);\n             let mut obligations = Vec::new();\n             let candidate = normalize_with_depth_to(\n                 self,\n@@ -165,7 +167,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             obligations.extend(self.infcx.commit_if_ok(|_| {\n                 self.infcx\n                     .at(&obligation.cause, obligation.param_env)\n-                    .sup(placeholder_trait_predicate.to_poly_trait_ref(), candidate.value)\n+                    .sup(placeholder_trait_predicate, candidate)\n                     .map(|InferOk { obligations, .. }| obligations)\n                     .map_err(|_| Unimplemented)\n             })?);"}, {"sha": "2b120e855eb5a914b41ab85a46347fb5beea6039", "filename": "compiler/rustc_trait_selection/src/traits/select/mod.rs", "status": "modified", "additions": 84, "deletions": 152, "changes": 236, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -39,7 +39,6 @@ use rustc_middle::ty::fast_reject;\n use rustc_middle::ty::print::with_no_trimmed_paths;\n use rustc_middle::ty::relate::TypeRelation;\n use rustc_middle::ty::subst::{GenericArgKind, Subst, SubstsRef};\n-use rustc_middle::ty::WithConstness;\n use rustc_middle::ty::{self, PolyProjectionPredicate, ToPolyTraitRef, ToPredicate};\n use rustc_middle::ty::{Ty, TyCtxt, TypeFoldable};\n use rustc_span::symbol::sym;\n@@ -128,9 +127,6 @@ pub struct SelectionContext<'cx, 'tcx> {\n     /// and a negative impl\n     allow_negative_impls: bool,\n \n-    /// Are we in a const context that needs `~const` bounds to be const?\n-    is_in_const_context: bool,\n-\n     /// The mode that trait queries run in, which informs our error handling\n     /// policy. In essence, canonicalized queries need their errors propagated\n     /// rather than immediately reported because we do not have accurate spans.\n@@ -141,9 +137,9 @@ pub struct SelectionContext<'cx, 'tcx> {\n struct TraitObligationStack<'prev, 'tcx> {\n     obligation: &'prev TraitObligation<'tcx>,\n \n-    /// The trait ref from `obligation` but \"freshened\" with the\n+    /// The trait predicate from `obligation` but \"freshened\" with the\n     /// selection-context's freshener. Used to check for recursion.\n-    fresh_trait_ref: ty::ConstnessAnd<ty::PolyTraitRef<'tcx>>,\n+    fresh_trait_pred: ty::PolyTraitPredicate<'tcx>,\n \n     /// Starts out equal to `depth` -- if, during evaluation, we\n     /// encounter a cycle, then we will set this flag to the minimum\n@@ -222,7 +218,6 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             intercrate: false,\n             intercrate_ambiguity_causes: None,\n             allow_negative_impls: false,\n-            is_in_const_context: false,\n             query_mode: TraitQueryMode::Standard,\n         }\n     }\n@@ -234,7 +229,6 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             intercrate: true,\n             intercrate_ambiguity_causes: None,\n             allow_negative_impls: false,\n-            is_in_const_context: false,\n             query_mode: TraitQueryMode::Standard,\n         }\n     }\n@@ -250,7 +244,6 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             intercrate: false,\n             intercrate_ambiguity_causes: None,\n             allow_negative_impls,\n-            is_in_const_context: false,\n             query_mode: TraitQueryMode::Standard,\n         }\n     }\n@@ -266,26 +259,10 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             intercrate: false,\n             intercrate_ambiguity_causes: None,\n             allow_negative_impls: false,\n-            is_in_const_context: false,\n             query_mode,\n         }\n     }\n \n-    pub fn with_constness(\n-        infcx: &'cx InferCtxt<'cx, 'tcx>,\n-        constness: hir::Constness,\n-    ) -> SelectionContext<'cx, 'tcx> {\n-        SelectionContext {\n-            infcx,\n-            freshener: infcx.freshener_keep_static(),\n-            intercrate: false,\n-            intercrate_ambiguity_causes: None,\n-            allow_negative_impls: false,\n-            is_in_const_context: matches!(constness, hir::Constness::Const),\n-            query_mode: TraitQueryMode::Standard,\n-        }\n-    }\n-\n     /// Enables tracking of intercrate ambiguity causes. These are\n     /// used in coherence to give improved diagnostics. We don't do\n     /// this until we detect a coherence error because it can lead to\n@@ -318,20 +295,6 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         self.intercrate\n     }\n \n-    /// Returns `true` if the trait predicate is considerd `const` to this selection context.\n-    pub fn is_trait_predicate_const(&self, pred: ty::TraitPredicate<'_>) -> bool {\n-        matches!(pred.constness, ty::BoundConstness::ConstIfConst) && self.is_in_const_context\n-    }\n-\n-    /// Returns `true` if the predicate is considered `const` to\n-    /// this selection context.\n-    pub fn is_predicate_const(&self, pred: ty::Predicate<'_>) -> bool {\n-        match pred.kind().skip_binder() {\n-            ty::PredicateKind::Trait(pred) => self.is_trait_predicate_const(pred),\n-            _ => false,\n-        }\n-    }\n-\n     ///////////////////////////////////////////////////////////////////////////\n     // Selection\n     //\n@@ -716,20 +679,22 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         }\n \n         let stack = self.push_stack(previous_stack, &obligation);\n-        let fresh_trait_ref = stack.fresh_trait_ref;\n+        let mut fresh_trait_pred = stack.fresh_trait_pred;\n+        let mut param_env = obligation.param_env;\n+\n+        fresh_trait_pred = fresh_trait_pred.map_bound(|mut pred| {\n+            param_env = param_env.with_constness(pred.constness.and(param_env.constness()));\n+            pred\n+        });\n \n-        debug!(?fresh_trait_ref);\n+        debug!(?fresh_trait_pred);\n \n-        if let Some(result) = self.check_evaluation_cache(\n-            obligation.param_env,\n-            fresh_trait_ref,\n-            obligation.polarity(),\n-        ) {\n+        if let Some(result) = self.check_evaluation_cache(param_env, fresh_trait_pred) {\n             debug!(?result, \"CACHE HIT\");\n             return Ok(result);\n         }\n \n-        if let Some(result) = stack.cache().get_provisional(fresh_trait_ref) {\n+        if let Some(result) = stack.cache().get_provisional(fresh_trait_pred) {\n             debug!(?result, \"PROVISIONAL CACHE HIT\");\n             stack.update_reached_depth(result.reached_depth);\n             return Ok(result.result);\n@@ -754,19 +719,12 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         let reached_depth = stack.reached_depth.get();\n         if reached_depth >= stack.depth {\n             debug!(?result, \"CACHE MISS\");\n-            self.insert_evaluation_cache(\n-                obligation.param_env,\n-                fresh_trait_ref,\n-                obligation.polarity(),\n-                dep_node,\n-                result,\n-            );\n+            self.insert_evaluation_cache(param_env, fresh_trait_pred, dep_node, result);\n \n-            stack.cache().on_completion(stack.dfn, |fresh_trait_ref, provisional_result| {\n+            stack.cache().on_completion(stack.dfn, |fresh_trait_pred, provisional_result| {\n                 self.insert_evaluation_cache(\n-                    obligation.param_env,\n-                    fresh_trait_ref,\n-                    obligation.polarity(),\n+                    param_env,\n+                    fresh_trait_pred,\n                     dep_node,\n                     provisional_result.max(result),\n                 );\n@@ -776,10 +734,10 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             debug!(\n                 \"caching provisionally because {:?} \\\n                  is a cycle participant (at depth {}, reached depth {})\",\n-                fresh_trait_ref, stack.depth, reached_depth,\n+                fresh_trait_pred, stack.depth, reached_depth,\n             );\n \n-            stack.cache().insert_provisional(stack.dfn, reached_depth, fresh_trait_ref, result);\n+            stack.cache().insert_provisional(stack.dfn, reached_depth, fresh_trait_pred, result);\n         }\n \n         Ok(result)\n@@ -813,7 +771,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             .skip(1) // Skip top-most frame.\n             .find(|prev| {\n                 stack.obligation.param_env == prev.obligation.param_env\n-                    && stack.fresh_trait_ref == prev.fresh_trait_ref\n+                    && stack.fresh_trait_pred == prev.fresh_trait_pred\n             })\n             .map(|stack| stack.depth)\n         {\n@@ -876,7 +834,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         // terms of `Fn` etc, but we could probably make this more\n         // precise still.\n         let unbound_input_types =\n-            stack.fresh_trait_ref.value.skip_binder().substs.types().any(|ty| ty.is_fresh());\n+            stack.fresh_trait_pred.skip_binder().trait_ref.substs.types().any(|ty| ty.is_fresh());\n \n         if stack.obligation.polarity() != ty::ImplPolarity::Negative {\n             // This check was an imperfect workaround for a bug in the old\n@@ -914,8 +872,8 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             && stack.iter().skip(1).any(|prev| {\n                 stack.obligation.param_env == prev.obligation.param_env\n                     && self.match_fresh_trait_refs(\n-                        stack.fresh_trait_ref,\n-                        prev.fresh_trait_ref,\n+                        stack.fresh_trait_pred,\n+                        prev.fresh_trait_pred,\n                         prev.obligation.param_env,\n                     )\n             })\n@@ -993,7 +951,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         // not just the lifetime choice for this particular (non-erased)\n         // predicate.\n         // See issue #80691\n-        if stack.fresh_trait_ref.has_erased_regions() {\n+        if stack.fresh_trait_pred.has_erased_regions() {\n             result = result.max(EvaluatedToOkModuloRegions);\n         }\n \n@@ -1004,8 +962,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n     fn check_evaluation_cache(\n         &self,\n         param_env: ty::ParamEnv<'tcx>,\n-        trait_ref: ty::ConstnessAnd<ty::PolyTraitRef<'tcx>>,\n-        polarity: ty::ImplPolarity,\n+        trait_pred: ty::PolyTraitPredicate<'tcx>,\n     ) -> Option<EvaluationResult> {\n         // Neither the global nor local cache is aware of intercrate\n         // mode, so don't do any caching. In particular, we might\n@@ -1017,19 +974,17 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n \n         let tcx = self.tcx();\n         if self.can_use_global_caches(param_env) {\n-            if let Some(res) = tcx.evaluation_cache.get(&(param_env.and(trait_ref), polarity), tcx)\n-            {\n+            if let Some(res) = tcx.evaluation_cache.get(&param_env.and(trait_pred), tcx) {\n                 return Some(res);\n             }\n         }\n-        self.infcx.evaluation_cache.get(&(param_env.and(trait_ref), polarity), tcx)\n+        self.infcx.evaluation_cache.get(&param_env.and(trait_pred), tcx)\n     }\n \n     fn insert_evaluation_cache(\n         &mut self,\n         param_env: ty::ParamEnv<'tcx>,\n-        trait_ref: ty::ConstnessAnd<ty::PolyTraitRef<'tcx>>,\n-        polarity: ty::ImplPolarity,\n+        trait_pred: ty::PolyTraitPredicate<'tcx>,\n         dep_node: DepNodeIndex,\n         result: EvaluationResult,\n     ) {\n@@ -1048,23 +1003,19 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         }\n \n         if self.can_use_global_caches(param_env) {\n-            if !trait_ref.needs_infer() {\n-                debug!(?trait_ref, ?result, \"insert_evaluation_cache global\");\n+            if !trait_pred.needs_infer() {\n+                debug!(?trait_pred, ?result, \"insert_evaluation_cache global\");\n                 // This may overwrite the cache with the same value\n                 // FIXME: Due to #50507 this overwrites the different values\n                 // This should be changed to use HashMapExt::insert_same\n                 // when that is fixed\n-                self.tcx().evaluation_cache.insert(\n-                    (param_env.and(trait_ref), polarity),\n-                    dep_node,\n-                    result,\n-                );\n+                self.tcx().evaluation_cache.insert(param_env.and(trait_pred), dep_node, result);\n                 return;\n             }\n         }\n \n-        debug!(?trait_ref, ?result, \"insert_evaluation_cache\");\n-        self.infcx.evaluation_cache.insert((param_env.and(trait_ref), polarity), dep_node, result);\n+        debug!(?trait_pred, ?result, \"insert_evaluation_cache\");\n+        self.infcx.evaluation_cache.insert(param_env.and(trait_pred), dep_node, result);\n     }\n \n     /// For various reasons, it's possible for a subobligation\n@@ -1142,16 +1093,15 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n \n         for candidate in candidates {\n             // Respect const trait obligations\n-            if self.is_trait_predicate_const(obligation.predicate.skip_binder()) {\n+            if obligation.is_const() {\n                 match candidate {\n                     // const impl\n                     ImplCandidate(def_id)\n                         if tcx.impl_constness(def_id) == hir::Constness::Const => {}\n                     // const param\n-                    ParamCandidate((\n-                        ty::ConstnessAnd { constness: ty::BoundConstness::ConstIfConst, .. },\n-                        _,\n-                    )) => {}\n+                    ParamCandidate(trait_pred)\n+                        if trait_pred.skip_binder().constness\n+                            == ty::BoundConstness::ConstIfConst => {}\n                     // auto trait impl\n                     AutoImplCandidate(..) => {}\n                     // generator, this will raise error in other places\n@@ -1260,7 +1210,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n \n     fn check_candidate_cache(\n         &mut self,\n-        param_env: ty::ParamEnv<'tcx>,\n+        mut param_env: ty::ParamEnv<'tcx>,\n         cache_fresh_trait_pred: ty::PolyTraitPredicate<'tcx>,\n     ) -> Option<SelectionResult<'tcx, SelectionCandidate<'tcx>>> {\n         // Neither the global nor local cache is aware of intercrate\n@@ -1271,19 +1221,15 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             return None;\n         }\n         let tcx = self.tcx();\n-        let pred = &cache_fresh_trait_pred.skip_binder();\n-        let trait_ref = pred.trait_ref;\n+        let mut pred = cache_fresh_trait_pred.skip_binder();\n+        param_env = param_env.with_constness(pred.constness.and(param_env.constness()));\n+\n         if self.can_use_global_caches(param_env) {\n-            if let Some(res) = tcx\n-                .selection_cache\n-                .get(&(param_env.and(trait_ref).with_constness(pred.constness), pred.polarity), tcx)\n-            {\n+            if let Some(res) = tcx.selection_cache.get(&param_env.and(pred), tcx) {\n                 return Some(res);\n             }\n         }\n-        self.infcx\n-            .selection_cache\n-            .get(&(param_env.and(trait_ref).with_constness(pred.constness), pred.polarity), tcx)\n+        self.infcx.selection_cache.get(&param_env.and(pred), tcx)\n     }\n \n     /// Determines whether can we safely cache the result\n@@ -1321,43 +1267,36 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n \n     fn insert_candidate_cache(\n         &mut self,\n-        param_env: ty::ParamEnv<'tcx>,\n+        mut param_env: ty::ParamEnv<'tcx>,\n         cache_fresh_trait_pred: ty::PolyTraitPredicate<'tcx>,\n         dep_node: DepNodeIndex,\n         candidate: SelectionResult<'tcx, SelectionCandidate<'tcx>>,\n     ) {\n         let tcx = self.tcx();\n-        let pred = cache_fresh_trait_pred.skip_binder();\n-        let trait_ref = pred.trait_ref;\n+        let mut pred = cache_fresh_trait_pred.skip_binder();\n+\n+        param_env = param_env.with_constness(pred.constness.and(param_env.constness()));\n \n         if !self.can_cache_candidate(&candidate) {\n-            debug!(?trait_ref, ?candidate, \"insert_candidate_cache - candidate is not cacheable\");\n+            debug!(?pred, ?candidate, \"insert_candidate_cache - candidate is not cacheable\");\n             return;\n         }\n \n         if self.can_use_global_caches(param_env) {\n             if let Err(Overflow) = candidate {\n                 // Don't cache overflow globally; we only produce this in certain modes.\n-            } else if !trait_ref.needs_infer() {\n+            } else if !pred.needs_infer() {\n                 if !candidate.needs_infer() {\n-                    debug!(?trait_ref, ?candidate, \"insert_candidate_cache global\");\n+                    debug!(?pred, ?candidate, \"insert_candidate_cache global\");\n                     // This may overwrite the cache with the same value.\n-                    tcx.selection_cache.insert(\n-                        (param_env.and(trait_ref).with_constness(pred.constness), pred.polarity),\n-                        dep_node,\n-                        candidate,\n-                    );\n+                    tcx.selection_cache.insert(param_env.and(pred), dep_node, candidate);\n                     return;\n                 }\n             }\n         }\n \n-        debug!(?trait_ref, ?candidate, \"insert_candidate_cache local\");\n-        self.infcx.selection_cache.insert(\n-            (param_env.and(trait_ref).with_constness(pred.constness), pred.polarity),\n-            dep_node,\n-            candidate,\n-        );\n+        debug!(?pred, ?candidate, \"insert_candidate_cache local\");\n+        self.infcx.selection_cache.insert(param_env.and(pred), dep_node, candidate);\n     }\n \n     /// Matches a predicate against the bounds of its self type.\n@@ -1548,7 +1487,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         // Check if a bound would previously have been removed when normalizing\n         // the param_env so that it can be given the lowest priority. See\n         // #50825 for the motivation for this.\n-        let is_global = |cand: &ty::PolyTraitRef<'tcx>| {\n+        let is_global = |cand: &ty::PolyTraitPredicate<'tcx>| {\n             cand.is_global(self.infcx.tcx) && !cand.has_late_bound_regions()\n         };\n \n@@ -1581,25 +1520,22 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n                 | ConstDropCandidate,\n             ) => false,\n \n-            (\n-                ParamCandidate((other, other_polarity)),\n-                ParamCandidate((victim, victim_polarity)),\n-            ) => {\n-                let same_except_bound_vars = other.value.skip_binder()\n-                    == victim.value.skip_binder()\n-                    && other.constness == victim.constness\n-                    && other_polarity == victim_polarity\n-                    && !other.value.skip_binder().has_escaping_bound_vars();\n+            (ParamCandidate(other), ParamCandidate(victim)) => {\n+                let same_except_bound_vars = other.skip_binder().trait_ref\n+                    == victim.skip_binder().trait_ref\n+                    && other.skip_binder().constness == victim.skip_binder().constness\n+                    && other.skip_binder().polarity == victim.skip_binder().polarity\n+                    && !other.skip_binder().trait_ref.has_escaping_bound_vars();\n                 if same_except_bound_vars {\n                     // See issue #84398. In short, we can generate multiple ParamCandidates which are\n                     // the same except for unused bound vars. Just pick the one with the fewest bound vars\n                     // or the current one if tied (they should both evaluate to the same answer). This is\n                     // probably best characterized as a \"hack\", since we might prefer to just do our\n                     // best to *not* create essentially duplicate candidates in the first place.\n-                    other.value.bound_vars().len() <= victim.value.bound_vars().len()\n-                } else if other.value == victim.value\n-                    && victim.constness == ty::BoundConstness::NotConst\n-                    && other_polarity == victim_polarity\n+                    other.bound_vars().len() <= victim.bound_vars().len()\n+                } else if other.skip_binder().trait_ref == victim.skip_binder().trait_ref\n+                    && victim.skip_binder().constness == ty::BoundConstness::NotConst\n+                    && other.skip_binder().polarity == victim.skip_binder().polarity\n                 {\n                     // Drop otherwise equivalent non-const candidates in favor of const candidates.\n                     true\n@@ -1629,11 +1565,11 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n                 | TraitAliasCandidate(..)\n                 | ObjectCandidate(_)\n                 | ProjectionCandidate(_),\n-            ) => !is_global(&cand.0.value),\n+            ) => !is_global(cand),\n             (ObjectCandidate(_) | ProjectionCandidate(_), ParamCandidate(ref cand)) => {\n                 // Prefer these to a global where-clause bound\n                 // (see issue #50825).\n-                is_global(&cand.0.value)\n+                is_global(cand)\n             }\n             (\n                 ImplCandidate(_)\n@@ -1649,7 +1585,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             ) => {\n                 // Prefer these to a global where-clause bound\n                 // (see issue #50825).\n-                is_global(&cand.0.value) && other.evaluation.must_apply_modulo_regions()\n+                is_global(cand) && other.evaluation.must_apply_modulo_regions()\n             }\n \n             (ProjectionCandidate(i), ProjectionCandidate(j))\n@@ -2209,8 +2145,8 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n \n     fn match_fresh_trait_refs(\n         &self,\n-        previous: ty::ConstnessAnd<ty::PolyTraitRef<'tcx>>,\n-        current: ty::ConstnessAnd<ty::PolyTraitRef<'tcx>>,\n+        previous: ty::PolyTraitPredicate<'tcx>,\n+        current: ty::PolyTraitPredicate<'tcx>,\n         param_env: ty::ParamEnv<'tcx>,\n     ) -> bool {\n         let mut matcher = ty::_match::Match::new(self.tcx(), param_env);\n@@ -2222,17 +2158,13 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         previous_stack: TraitObligationStackList<'o, 'tcx>,\n         obligation: &'o TraitObligation<'tcx>,\n     ) -> TraitObligationStack<'o, 'tcx> {\n-        let fresh_trait_ref = obligation\n-            .predicate\n-            .to_poly_trait_ref()\n-            .fold_with(&mut self.freshener)\n-            .with_constness(obligation.predicate.skip_binder().constness);\n+        let fresh_trait_pred = obligation.predicate.fold_with(&mut self.freshener);\n \n         let dfn = previous_stack.cache.next_dfn();\n         let depth = previous_stack.depth() + 1;\n         TraitObligationStack {\n             obligation,\n-            fresh_trait_ref,\n+            fresh_trait_pred,\n             reached_depth: Cell::new(depth),\n             previous: previous_stack,\n             dfn,\n@@ -2426,7 +2358,7 @@ impl<'o, 'tcx> TraitObligationStack<'o, 'tcx> {\n         debug!(reached_depth, \"update_reached_depth\");\n         let mut p = self;\n         while reached_depth < p.depth {\n-            debug!(?p.fresh_trait_ref, \"update_reached_depth: marking as cycle participant\");\n+            debug!(?p.fresh_trait_pred, \"update_reached_depth: marking as cycle participant\");\n             p.reached_depth.set(p.reached_depth.get().min(reached_depth));\n             p = p.previous.head.unwrap();\n         }\n@@ -2505,7 +2437,7 @@ struct ProvisionalEvaluationCache<'tcx> {\n     /// - then we determine that `E` is in error -- we will then clear\n     ///   all cache values whose DFN is >= 4 -- in this case, that\n     ///   means the cached value for `F`.\n-    map: RefCell<FxHashMap<ty::ConstnessAnd<ty::PolyTraitRef<'tcx>>, ProvisionalEvaluation>>,\n+    map: RefCell<FxHashMap<ty::PolyTraitPredicate<'tcx>, ProvisionalEvaluation>>,\n }\n \n /// A cache value for the provisional cache: contains the depth-first\n@@ -2537,28 +2469,28 @@ impl<'tcx> ProvisionalEvaluationCache<'tcx> {\n     /// `reached_depth` (from the returned value).\n     fn get_provisional(\n         &self,\n-        fresh_trait_ref: ty::ConstnessAnd<ty::PolyTraitRef<'tcx>>,\n+        fresh_trait_pred: ty::PolyTraitPredicate<'tcx>,\n     ) -> Option<ProvisionalEvaluation> {\n         debug!(\n-            ?fresh_trait_ref,\n+            ?fresh_trait_pred,\n             \"get_provisional = {:#?}\",\n-            self.map.borrow().get(&fresh_trait_ref),\n+            self.map.borrow().get(&fresh_trait_pred),\n         );\n-        Some(*self.map.borrow().get(&fresh_trait_ref)?)\n+        Some(*self.map.borrow().get(&fresh_trait_pred)?)\n     }\n \n     /// Insert a provisional result into the cache. The result came\n     /// from the node with the given DFN. It accessed a minimum depth\n-    /// of `reached_depth` to compute. It evaluated `fresh_trait_ref`\n+    /// of `reached_depth` to compute. It evaluated `fresh_trait_pred`\n     /// and resulted in `result`.\n     fn insert_provisional(\n         &self,\n         from_dfn: usize,\n         reached_depth: usize,\n-        fresh_trait_ref: ty::ConstnessAnd<ty::PolyTraitRef<'tcx>>,\n+        fresh_trait_pred: ty::PolyTraitPredicate<'tcx>,\n         result: EvaluationResult,\n     ) {\n-        debug!(?from_dfn, ?fresh_trait_ref, ?result, \"insert_provisional\");\n+        debug!(?from_dfn, ?fresh_trait_pred, ?result, \"insert_provisional\");\n \n         let mut map = self.map.borrow_mut();\n \n@@ -2582,7 +2514,7 @@ impl<'tcx> ProvisionalEvaluationCache<'tcx> {\n             }\n         }\n \n-        map.insert(fresh_trait_ref, ProvisionalEvaluation { from_dfn, reached_depth, result });\n+        map.insert(fresh_trait_pred, ProvisionalEvaluation { from_dfn, reached_depth, result });\n     }\n \n     /// Invoked when the node with dfn `dfn` does not get a successful\n@@ -2633,16 +2565,16 @@ impl<'tcx> ProvisionalEvaluationCache<'tcx> {\n     fn on_completion(\n         &self,\n         dfn: usize,\n-        mut op: impl FnMut(ty::ConstnessAnd<ty::PolyTraitRef<'tcx>>, EvaluationResult),\n+        mut op: impl FnMut(ty::PolyTraitPredicate<'tcx>, EvaluationResult),\n     ) {\n         debug!(?dfn, \"on_completion\");\n \n-        for (fresh_trait_ref, eval) in\n+        for (fresh_trait_pred, eval) in\n             self.map.borrow_mut().drain_filter(|_k, eval| eval.from_dfn >= dfn)\n         {\n-            debug!(?fresh_trait_ref, ?eval, \"on_completion\");\n+            debug!(?fresh_trait_pred, ?eval, \"on_completion\");\n \n-            op(fresh_trait_ref, eval.result);\n+            op(fresh_trait_pred, eval.result);\n         }\n     }\n }"}, {"sha": "ab732f510ff92c73d9c739485ac4f00d1388387b", "filename": "compiler/rustc_trait_selection/src/traits/specialize/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fspecialize%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fspecialize%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fspecialize%2Fmod.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -508,9 +508,9 @@ crate fn to_pretty_impl_header(tcx: TyCtxt<'_>, impl_def_id: DefId) -> Option<St\n         Vec::with_capacity(predicates.len() + types_without_default_bounds.len());\n \n     for (p, _) in predicates {\n-        if let Some(poly_trait_ref) = p.to_opt_poly_trait_ref() {\n-            if Some(poly_trait_ref.value.def_id()) == sized_trait {\n-                types_without_default_bounds.remove(poly_trait_ref.value.self_ty().skip_binder());\n+        if let Some(poly_trait_ref) = p.to_opt_poly_trait_pred() {\n+            if Some(poly_trait_ref.def_id()) == sized_trait {\n+                types_without_default_bounds.remove(poly_trait_ref.self_ty().skip_binder());\n                 continue;\n             }\n         }"}, {"sha": "5577e98e89321fe5ee0265cddc311dc6d112a5f1", "filename": "compiler/rustc_trait_selection/src/traits/util.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Futil.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -6,7 +6,7 @@ use smallvec::SmallVec;\n use rustc_data_structures::fx::FxHashSet;\n use rustc_hir::def_id::DefId;\n use rustc_middle::ty::subst::{GenericArg, Subst, SubstsRef};\n-use rustc_middle::ty::{self, ToPredicate, Ty, TyCtxt, TypeFoldable, WithConstness};\n+use rustc_middle::ty::{self, ToPredicate, Ty, TyCtxt, TypeFoldable};\n \n use super::{Normalized, Obligation, ObligationCause, PredicateObligation, SelectionContext};\n pub use rustc_infer::traits::{self, util::*};\n@@ -126,8 +126,8 @@ impl<'tcx> TraitAliasExpander<'tcx> {\n \n         let items = predicates.predicates.iter().rev().filter_map(|(pred, span)| {\n             pred.subst_supertrait(tcx, &trait_ref)\n-                .to_opt_poly_trait_ref()\n-                .map(|trait_ref| item.clone_and_push(trait_ref.value, *span))\n+                .to_opt_poly_trait_pred()\n+                .map(|trait_ref| item.clone_and_push(trait_ref.map_bound(|t| t.trait_ref), *span))\n         });\n         debug!(\"expand_trait_aliases: items={:?}\", items.clone());\n \n@@ -183,8 +183,8 @@ impl Iterator for SupertraitDefIds<'tcx> {\n             predicates\n                 .predicates\n                 .iter()\n-                .filter_map(|(pred, _)| pred.to_opt_poly_trait_ref())\n-                .map(|trait_ref| trait_ref.value.def_id())\n+                .filter_map(|(pred, _)| pred.to_opt_poly_trait_pred())\n+                .map(|trait_ref| trait_ref.def_id())\n                 .filter(|&super_def_id| visited.insert(super_def_id)),\n         );\n         Some(def_id)"}, {"sha": "5875b764e9f3693de41cc79f6768912a3b5c724d", "filename": "compiler/rustc_trait_selection/src/traits/wf.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fwf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fwf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fwf.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -6,7 +6,7 @@ use rustc_hir as hir;\n use rustc_hir::def_id::DefId;\n use rustc_hir::lang_items::LangItem;\n use rustc_middle::ty::subst::{GenericArg, GenericArgKind, SubstsRef};\n-use rustc_middle::ty::{self, ToPredicate, Ty, TyCtxt, TypeFoldable, WithConstness};\n+use rustc_middle::ty::{self, ToPredicate, Ty, TyCtxt, TypeFoldable};\n use rustc_span::Span;\n \n use std::iter;\n@@ -298,9 +298,10 @@ impl<'a, 'tcx> WfPredicates<'a, 'tcx> {\n \n         let extend = |obligation: traits::PredicateObligation<'tcx>| {\n             let mut cause = cause.clone();\n-            if let Some(parent_trait_ref) = obligation.predicate.to_opt_poly_trait_ref() {\n+            if let Some(parent_trait_ref) = obligation.predicate.to_opt_poly_trait_pred() {\n                 let derived_cause = traits::DerivedObligationCause {\n-                    parent_trait_ref: parent_trait_ref.value,\n+                    // FIXME(fee1-dead): when improving error messages, change this to PolyTraitPredicate\n+                    parent_trait_ref: parent_trait_ref.map_bound(|t| t.trait_ref),\n                     parent_code: Lrc::new(obligation.cause.code.clone()),\n                 };\n                 cause.make_mut().code ="}, {"sha": "a2d14545916b77bf4245c48da94fe771cecff2a0", "filename": "compiler/rustc_ty_utils/src/ty.rs", "status": "modified", "additions": 73, "deletions": 12, "changes": 85, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_ty_utils%2Fsrc%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_ty_utils%2Fsrc%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Fty.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -2,9 +2,7 @@ use rustc_data_structures::fx::FxIndexSet;\n use rustc_hir as hir;\n use rustc_hir::def_id::{DefId, LocalDefId};\n use rustc_middle::ty::subst::Subst;\n-use rustc_middle::ty::{\n-    self, Binder, Predicate, PredicateKind, ToPredicate, Ty, TyCtxt, WithConstness,\n-};\n+use rustc_middle::ty::{self, Binder, Predicate, PredicateKind, ToPredicate, Ty, TyCtxt};\n use rustc_span::Span;\n use rustc_trait_selection::traits;\n \n@@ -282,16 +280,79 @@ fn param_env(tcx: TyCtxt<'_>, def_id: DefId) -> ty::ParamEnv<'_> {\n     // issue #89334\n     predicates = tcx.expose_default_const_substs(predicates);\n \n-    let unnormalized_env =\n-        ty::ParamEnv::new(tcx.intern_predicates(&predicates), traits::Reveal::UserFacing);\n+    let local_did = def_id.as_local();\n+    let hir_id = local_did.map(|def_id| tcx.hir().local_def_id_to_hir_id(def_id));\n \n-    debug!(\"unnormalized_env caller bounds: {:?}\", unnormalized_env.caller_bounds());\n-    let body_id = def_id\n-        .as_local()\n-        .map(|def_id| tcx.hir().local_def_id_to_hir_id(def_id))\n-        .map_or(hir::CRATE_HIR_ID, |id| {\n-            tcx.hir().maybe_body_owned_by(id).map_or(id, |body| body.hir_id)\n-        });\n+    let constness = match hir_id {\n+        Some(hir_id) => match tcx.hir().get(hir_id) {\n+            hir::Node::Item(hir::Item { kind: hir::ItemKind::Const(..), .. })\n+            | hir::Node::Item(hir::Item { kind: hir::ItemKind::Static(..), .. })\n+            | hir::Node::TraitItem(hir::TraitItem {\n+                kind: hir::TraitItemKind::Const(..), ..\n+            })\n+            | hir::Node::AnonConst(_)\n+            | hir::Node::ImplItem(hir::ImplItem { kind: hir::ImplItemKind::Const(..), .. })\n+            | hir::Node::ImplItem(hir::ImplItem {\n+                kind:\n+                    hir::ImplItemKind::Fn(\n+                        hir::FnSig {\n+                            header: hir::FnHeader { constness: hir::Constness::Const, .. },\n+                            ..\n+                        },\n+                        ..,\n+                    ),\n+                ..\n+            }) => hir::Constness::Const,\n+\n+            hir::Node::ImplItem(hir::ImplItem {\n+                kind: hir::ImplItemKind::TyAlias(..) | hir::ImplItemKind::Fn(..),\n+                ..\n+            }) => {\n+                let parent_hir_id = tcx.hir().get_parent_node(hir_id);\n+                match tcx.hir().get(parent_hir_id) {\n+                    hir::Node::Item(hir::Item {\n+                        kind: hir::ItemKind::Impl(hir::Impl { constness, .. }),\n+                        ..\n+                    }) => *constness,\n+                    _ => span_bug!(\n+                        tcx.def_span(parent_hir_id.owner),\n+                        \"impl item's parent node is not an impl\",\n+                    ),\n+                }\n+            }\n+\n+            hir::Node::Item(hir::Item {\n+                kind:\n+                    hir::ItemKind::Fn(hir::FnSig { header: hir::FnHeader { constness, .. }, .. }, ..),\n+                ..\n+            })\n+            | hir::Node::TraitItem(hir::TraitItem {\n+                kind:\n+                    hir::TraitItemKind::Fn(\n+                        hir::FnSig { header: hir::FnHeader { constness, .. }, .. },\n+                        ..,\n+                    ),\n+                ..\n+            })\n+            | hir::Node::Item(hir::Item {\n+                kind: hir::ItemKind::Impl(hir::Impl { constness, .. }),\n+                ..\n+            }) => *constness,\n+\n+            _ => hir::Constness::NotConst,\n+        },\n+        None => hir::Constness::NotConst,\n+    };\n+\n+    let unnormalized_env = ty::ParamEnv::new(\n+        tcx.intern_predicates(&predicates),\n+        traits::Reveal::UserFacing,\n+        constness,\n+    );\n+\n+    let body_id = hir_id.map_or(hir::CRATE_HIR_ID, |id| {\n+        tcx.hir().maybe_body_owned_by(id).map_or(id, |body| body.hir_id)\n+    });\n     let cause = traits::ObligationCause::misc(tcx.def_span(def_id), body_id);\n     traits::normalize_param_env_or_error(tcx, def_id, unnormalized_env, cause)\n }"}, {"sha": "752183365d654b9e4fe41c413ad990a799b77aa5", "filename": "compiler/rustc_typeck/src/astconv/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fastconv%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fastconv%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fastconv%2Fmod.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -1587,7 +1587,7 @@ impl<'o, 'tcx> dyn AstConv<'tcx> + 'o {\n                 traits::transitive_bounds_that_define_assoc_type(\n                     tcx,\n                     predicates.iter().filter_map(|(p, _)| {\n-                        p.to_opt_poly_trait_ref().map(|trait_ref| trait_ref.value)\n+                        Some(p.to_opt_poly_trait_pred()?.map_bound(|t| t.trait_ref))\n                     }),\n                     assoc_name,\n                 )"}, {"sha": "8bc3a48e5b506d4d406f02062893c2cff081b2b7", "filename": "compiler/rustc_typeck/src/bounds.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fbounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fbounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fbounds.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -1,7 +1,7 @@\n //! Bounds are restrictions applied to some types after they've been converted into the\n //! `ty` form from the HIR.\n \n-use rustc_middle::ty::{self, ToPredicate, Ty, TyCtxt, WithConstness};\n+use rustc_middle::ty::{self, ToPredicate, Ty, TyCtxt};\n use rustc_span::Span;\n \n /// Collects together a list of type bounds. These lists of bounds occur in many places"}, {"sha": "11560f51822f88b3172c8421b1ec944b41012696", "filename": "compiler/rustc_typeck/src/check/compare_method.rs", "status": "modified", "additions": 17, "deletions": 14, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcompare_method.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcompare_method.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcompare_method.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -208,8 +208,11 @@ fn compare_predicate_entailment<'tcx>(\n     // The key step here is to update the caller_bounds's predicates to be\n     // the new hybrid bounds we computed.\n     let normalize_cause = traits::ObligationCause::misc(impl_m_span, impl_m_hir_id);\n-    let param_env =\n-        ty::ParamEnv::new(tcx.intern_predicates(&hybrid_preds.predicates), Reveal::UserFacing);\n+    let param_env = ty::ParamEnv::new(\n+        tcx.intern_predicates(&hybrid_preds.predicates),\n+        Reveal::UserFacing,\n+        hir::Constness::NotConst,\n+    );\n     let param_env =\n         traits::normalize_param_env_or_error(tcx, impl_m.def_id, param_env, normalize_cause);\n \n@@ -1167,8 +1170,11 @@ fn compare_type_predicate_entailment<'tcx>(\n     debug!(\"compare_type_predicate_entailment: bounds={:?}\", hybrid_preds);\n \n     let normalize_cause = traits::ObligationCause::misc(impl_ty_span, impl_ty_hir_id);\n-    let param_env =\n-        ty::ParamEnv::new(tcx.intern_predicates(&hybrid_preds.predicates), Reveal::UserFacing);\n+    let param_env = ty::ParamEnv::new(\n+        tcx.intern_predicates(&hybrid_preds.predicates),\n+        Reveal::UserFacing,\n+        hir::Constness::NotConst,\n+    );\n     let param_env = traits::normalize_param_env_or_error(\n         tcx,\n         impl_ty.def_id,\n@@ -1353,7 +1359,11 @@ pub fn check_type_bounds<'tcx>(\n                 .to_predicate(tcx),\n             ),\n         };\n-        ty::ParamEnv::new(tcx.intern_predicates(&predicates), Reveal::UserFacing)\n+        ty::ParamEnv::new(\n+            tcx.intern_predicates(&predicates),\n+            Reveal::UserFacing,\n+            param_env.constness(),\n+        )\n     };\n     debug!(?normalize_param_env);\n \n@@ -1362,13 +1372,7 @@ pub fn check_type_bounds<'tcx>(\n         impl_ty_substs.rebase_onto(tcx, impl_ty.container.id(), impl_trait_ref.substs);\n \n     tcx.infer_ctxt().enter(move |infcx| {\n-        let constness = impl_ty\n-            .container\n-            .impl_def_id()\n-            .map(|did| tcx.impl_constness(did))\n-            .unwrap_or(hir::Constness::NotConst);\n-\n-        let inh = Inherited::with_constness(infcx, impl_ty.def_id.expect_local(), constness);\n+        let inh = Inherited::new(infcx, impl_ty.def_id.expect_local());\n         let infcx = &inh.infcx;\n         let mut selcx = traits::SelectionContext::new(&infcx);\n \n@@ -1412,8 +1416,7 @@ pub fn check_type_bounds<'tcx>(\n \n         // Check that all obligations are satisfied by the implementation's\n         // version.\n-        let errors =\n-            inh.fulfillment_cx.borrow_mut().select_all_with_constness_or_error(&infcx, constness);\n+        let errors = inh.fulfillment_cx.borrow_mut().select_all_or_error(&infcx);\n         if !errors.is_empty() {\n             infcx.report_fulfillment_errors(&errors, None, false);\n             return Err(ErrorReported);"}, {"sha": "280a39e7b3ed98e46d79ad32c4beab30146596a4", "filename": "compiler/rustc_typeck/src/check/fn_ctxt/_impl.rs", "status": "modified", "additions": 2, "deletions": 8, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2F_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2F_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2F_impl.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -616,10 +616,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n \n     #[instrument(skip(self), level = \"debug\")]\n     pub(in super::super) fn select_all_obligations_or_error(&self) {\n-        let errors = self\n-            .fulfillment_cx\n-            .borrow_mut()\n-            .select_all_with_constness_or_error(&self, self.inh.constness);\n+        let errors = self.fulfillment_cx.borrow_mut().select_all_or_error(&self);\n \n         if !errors.is_empty() {\n             self.report_fulfillment_errors(&errors, self.inh.body_id, false);\n@@ -632,10 +629,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         fallback_has_occurred: bool,\n         mutate_fulfillment_errors: impl Fn(&mut Vec<traits::FulfillmentError<'tcx>>),\n     ) {\n-        let mut result = self\n-            .fulfillment_cx\n-            .borrow_mut()\n-            .select_with_constness_where_possible(self, self.inh.constness);\n+        let mut result = self.fulfillment_cx.borrow_mut().select_where_possible(self);\n         if !result.is_empty() {\n             mutate_fulfillment_errors(&mut result);\n             self.report_fulfillment_errors(&result, self.inh.body_id, fallback_has_occurred);"}, {"sha": "bf52e7750433138689e5748b841307cda9ae8432", "filename": "compiler/rustc_typeck/src/check/inherited.rs", "status": "modified", "additions": 0, "deletions": 14, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Finherited.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Finherited.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Finherited.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -53,9 +53,6 @@ pub struct Inherited<'a, 'tcx> {\n     pub(super) deferred_generator_interiors:\n         RefCell<Vec<(hir::BodyId, Ty<'tcx>, hir::GeneratorKind)>>,\n \n-    /// Reports whether this is in a const context.\n-    pub(super) constness: hir::Constness,\n-\n     pub(super) body_id: Option<hir::BodyId>,\n \n     /// Whenever we introduce an adjustment from `!` into a type variable,\n@@ -102,16 +99,6 @@ impl<'tcx> InheritedBuilder<'tcx> {\n \n impl Inherited<'a, 'tcx> {\n     pub(super) fn new(infcx: InferCtxt<'a, 'tcx>, def_id: LocalDefId) -> Self {\n-        let tcx = infcx.tcx;\n-        let item_id = tcx.hir().local_def_id_to_hir_id(def_id);\n-        Self::with_constness(infcx, def_id, tcx.hir().get(item_id).constness_for_typeck())\n-    }\n-\n-    pub(super) fn with_constness(\n-        infcx: InferCtxt<'a, 'tcx>,\n-        def_id: LocalDefId,\n-        constness: hir::Constness,\n-    ) -> Self {\n         let tcx = infcx.tcx;\n         let item_id = tcx.hir().local_def_id_to_hir_id(def_id);\n         let body_id = tcx.hir().maybe_body_owned_by(item_id);\n@@ -128,7 +115,6 @@ impl Inherited<'a, 'tcx> {\n             deferred_cast_checks: RefCell::new(Vec::new()),\n             deferred_generator_interiors: RefCell::new(Vec::new()),\n             diverging_type_vars: RefCell::new(Default::default()),\n-            constness,\n             body_id,\n         }\n     }"}, {"sha": "03518dc8d127e788e73267e7aae751a58d1bd8a5", "filename": "compiler/rustc_typeck/src/check/method/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fmod.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -22,7 +22,7 @@ use rustc_infer::infer::{self, InferOk};\n use rustc_middle::ty::subst::Subst;\n use rustc_middle::ty::subst::{InternalSubsts, SubstsRef};\n use rustc_middle::ty::GenericParamDefKind;\n-use rustc_middle::ty::{self, ToPredicate, Ty, TypeFoldable, WithConstness};\n+use rustc_middle::ty::{self, ToPredicate, Ty, TypeFoldable};\n use rustc_span::symbol::Ident;\n use rustc_span::Span;\n use rustc_trait_selection::traits;"}, {"sha": "dc7243960946b6903000da1d62fbe600bc0bea26", "filename": "compiler/rustc_typeck/src/check/method/probe.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fprobe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fprobe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fprobe.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -21,7 +21,7 @@ use rustc_infer::infer::{self, InferOk, TyCtxtInferExt};\n use rustc_middle::middle::stability;\n use rustc_middle::ty::subst::{InternalSubsts, Subst, SubstsRef};\n use rustc_middle::ty::GenericParamDefKind;\n-use rustc_middle::ty::{self, ParamEnvAnd, ToPredicate, Ty, TyCtxt, TypeFoldable, WithConstness};\n+use rustc_middle::ty::{self, ParamEnvAnd, ToPredicate, Ty, TyCtxt, TypeFoldable};\n use rustc_session::lint;\n use rustc_span::def_id::LocalDefId;\n use rustc_span::lev_distance::{find_best_match_for_name, lev_distance};"}, {"sha": "45b8e13d328c5442bba67af09550d8136786d621", "filename": "compiler/rustc_typeck/src/check/method/suggest.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fsuggest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fsuggest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fsuggest.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -12,7 +12,7 @@ use rustc_hir::{ExprKind, Node, QPath};\n use rustc_infer::infer::type_variable::{TypeVariableOrigin, TypeVariableOriginKind};\n use rustc_middle::ty::fast_reject::simplify_type;\n use rustc_middle::ty::print::with_crate_prefix;\n-use rustc_middle::ty::{self, ToPredicate, Ty, TyCtxt, TypeFoldable, WithConstness};\n+use rustc_middle::ty::{self, ToPredicate, Ty, TyCtxt, TypeFoldable};\n use rustc_span::lev_distance;\n use rustc_span::symbol::{kw, sym, Ident};\n use rustc_span::{source_map, FileName, MultiSpan, Span, Symbol};"}, {"sha": "0219f9c9727151139e8c0073cb311754f1472a7b", "filename": "compiler/rustc_typeck/src/check/wfcheck.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -21,7 +21,6 @@ use rustc_middle::ty::subst::{GenericArgKind, InternalSubsts, Subst};\n use rustc_middle::ty::trait_def::TraitSpecializationKind;\n use rustc_middle::ty::{\n     self, AdtKind, GenericParamDefKind, ToPredicate, Ty, TyCtxt, TypeFoldable, TypeVisitor,\n-    WithConstness,\n };\n use rustc_session::parse::feature_err;\n use rustc_span::symbol::{sym, Ident, Symbol};"}, {"sha": "ea86bafffb394bfe188692e4ec61f345bb111f89", "filename": "compiler/rustc_typeck/src/collect.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -41,7 +41,7 @@ use rustc_middle::ty::subst::InternalSubsts;\n use rustc_middle::ty::util::Discr;\n use rustc_middle::ty::util::IntTypeExt;\n use rustc_middle::ty::{self, AdtKind, Const, DefIdTree, Ty, TyCtxt};\n-use rustc_middle::ty::{ReprOptions, ToPredicate, TypeFoldable, WithConstness};\n+use rustc_middle::ty::{ReprOptions, ToPredicate, TypeFoldable};\n use rustc_session::lint;\n use rustc_session::parse::feature_err;\n use rustc_span::symbol::{kw, sym, Ident, Symbol};"}, {"sha": "dca02cb25bd19c4f75da3f6eb4aa821b9004aee2", "filename": "src/librustdoc/clean/blanket_impl.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/src%2Flibrustdoc%2Fclean%2Fblanket_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/src%2Flibrustdoc%2Fclean%2Fblanket_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fblanket_impl.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -3,7 +3,7 @@ use rustc_hir as hir;\n use rustc_infer::infer::{InferOk, TyCtxtInferExt};\n use rustc_infer::traits;\n use rustc_middle::ty::subst::Subst;\n-use rustc_middle::ty::{ToPredicate, WithConstness};\n+use rustc_middle::ty::ToPredicate;\n use rustc_span::DUMMY_SP;\n \n use super::*;\n@@ -66,7 +66,8 @@ impl<'a, 'tcx> BlanketImplFinder<'a, 'tcx> {\n                             .into_iter()\n                             .chain(Some(\n                                 ty::Binder::dummy(trait_ref)\n-                                    .without_const()\n+                                    .to_poly_trait_predicate()\n+                                    .map_bound(ty::PredicateKind::Trait)\n                                     .to_predicate(infcx.tcx),\n                             ));\n                         for predicate in predicates {"}, {"sha": "383e13fd4b09d02a4aeb169c241312c9e42ce5dc", "filename": "src/test/ui/infinite/infinite-struct.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/src%2Ftest%2Fui%2Finfinite%2Finfinite-struct.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/src%2Ftest%2Fui%2Finfinite%2Finfinite-struct.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finfinite%2Finfinite-struct.stderr?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -19,7 +19,7 @@ LL | struct Take(Take);\n    | ^^^^^^^^^^^^^^^^^^\n    |\n    = note: ...which immediately requires computing drop-check constraints for `Take` again\n-   = note: cycle used when computing dropck types for `Canonical { max_universe: U0, variables: [], value: ParamEnvAnd { param_env: ParamEnv { caller_bounds: [], reveal: UserFacing }, value: Take } }`\n+   = note: cycle used when computing dropck types for `Canonical { max_universe: U0, variables: [], value: ParamEnvAnd { param_env: ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, value: Take } }`\n \n error: aborting due to 2 previous errors\n "}, {"sha": "1802c7599a3b59ae557dc09133839461062d1f7c", "filename": "src/test/ui/infinite/infinite-tag-type-recursion.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/src%2Ftest%2Fui%2Finfinite%2Finfinite-tag-type-recursion.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/src%2Ftest%2Fui%2Finfinite%2Finfinite-tag-type-recursion.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finfinite%2Finfinite-tag-type-recursion.stderr?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -18,7 +18,7 @@ LL | enum MList { Cons(isize, MList), Nil }\n    | ^^^^^^^^^^\n    |\n    = note: ...which immediately requires computing drop-check constraints for `MList` again\n-   = note: cycle used when computing dropck types for `Canonical { max_universe: U0, variables: [], value: ParamEnvAnd { param_env: ParamEnv { caller_bounds: [], reveal: UserFacing }, value: MList } }`\n+   = note: cycle used when computing dropck types for `Canonical { max_universe: U0, variables: [], value: ParamEnvAnd { param_env: ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, value: MList } }`\n \n error: aborting due to 2 previous errors\n "}, {"sha": "7b012083c5a3d2843807f61eec7fb7b00e64354e", "filename": "src/test/ui/rfc-2632-const-trait-impl/assoc-type.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fassoc-type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fassoc-type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fassoc-type.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -1,6 +1,5 @@\n // FIXME(fee1-dead): this should have a better error message\n #![feature(const_trait_impl)]\n-\n struct NonConstAdd(i32);\n \n impl std::ops::Add for NonConstAdd {"}, {"sha": "4a4b4de4758baacfb9292a240b6cae50398154ad", "filename": "src/test/ui/rfc-2632-const-trait-impl/assoc-type.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fassoc-type.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fassoc-type.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fassoc-type.stderr?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -1,12 +1,12 @@\n error[E0277]: cannot add `NonConstAdd` to `NonConstAdd`\n-  --> $DIR/assoc-type.rs:19:16\n+  --> $DIR/assoc-type.rs:18:16\n    |\n LL |     type Bar = NonConstAdd;\n    |                ^^^^^^^^^^^ no implementation for `NonConstAdd + NonConstAdd`\n    |\n    = help: the trait `Add` is not implemented for `NonConstAdd`\n note: required by a bound in `Foo::Bar`\n-  --> $DIR/assoc-type.rs:15:15\n+  --> $DIR/assoc-type.rs:14:15\n    |\n LL |     type Bar: ~const std::ops::Add;\n    |               ^^^^^^^^^^^^^^^^^^^^ required by this bound in `Foo::Bar`"}, {"sha": "43911a313d5a606aa022b7371e2cf22b63433eed", "filename": "src/tools/clippy/clippy_lints/src/future_not_send.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/84b1d859c8caa6049bfe728b219f679286151bb2/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffuture_not_send.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b1d859c8caa6049bfe728b219f679286151bb2/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffuture_not_send.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffuture_not_send.rs?ref=84b1d859c8caa6049bfe728b219f679286151bb2", "patch": "@@ -68,8 +68,8 @@ impl<'tcx> LateLintPass<'tcx> for FutureNotSend {\n             let mut is_future = false;\n             for &(p, _span) in preds {\n                 let p = p.subst(cx.tcx, subst);\n-                if let Some(trait_ref) = p.to_opt_poly_trait_ref() {\n-                    if Some(trait_ref.value.def_id()) == cx.tcx.lang_items().future_trait() {\n+                if let Some(trait_pred) = p.to_opt_poly_trait_pred() {\n+                    if Some(trait_pred.skip_binder().trait_ref.def_id) == cx.tcx.lang_items().future_trait() {\n                         is_future = true;\n                         break;\n                     }"}]}