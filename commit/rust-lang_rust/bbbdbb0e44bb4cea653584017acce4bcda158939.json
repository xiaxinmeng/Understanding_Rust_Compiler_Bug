{"sha": "bbbdbb0e44bb4cea653584017acce4bcda158939", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJiYmRiYjBlNDRiYjRjZWE2NTM1ODQwMTdhY2NlNGJjZGExNTg5Mzk=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-11-23T15:19:57Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-11-23T15:19:57Z"}, "message": "Move def collector from `rustc` to `rustc_resolve`", "tree": {"sha": "787ce80988a2f3416a9471ede25bd8310a96c4ac", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/787ce80988a2f3416a9471ede25bd8310a96c4ac"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bbbdbb0e44bb4cea653584017acce4bcda158939", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bbbdbb0e44bb4cea653584017acce4bcda158939", "html_url": "https://github.com/rust-lang/rust/commit/bbbdbb0e44bb4cea653584017acce4bcda158939", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bbbdbb0e44bb4cea653584017acce4bcda158939/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9420ff4c0ebea44b167d530bb59f9d5721d8ff0b", "url": "https://api.github.com/repos/rust-lang/rust/commits/9420ff4c0ebea44b167d530bb59f9d5721d8ff0b", "html_url": "https://github.com/rust-lang/rust/commit/9420ff4c0ebea44b167d530bb59f9d5721d8ff0b"}], "stats": {"total": 46, "additions": 29, "deletions": 17}, "files": [{"sha": "91b4971cd92be1016c988fe903d6a04be1ecdfdc", "filename": "src/librustc/hir/map/definitions.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/bbbdbb0e44bb4cea653584017acce4bcda158939/src%2Flibrustc%2Fhir%2Fmap%2Fdefinitions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbbdbb0e44bb4cea653584017acce4bcda158939/src%2Flibrustc%2Fhir%2Fmap%2Fdefinitions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmap%2Fdefinitions.rs?ref=bbbdbb0e44bb4cea653584017acce4bcda158939", "patch": "@@ -105,7 +105,7 @@ pub struct Definitions {\n     /// we know what parent node that fragment should be attached to thanks to this table.\n     invocation_parents: FxHashMap<ExpnId, DefIndex>,\n     /// Indices of unnamed struct or variant fields with unresolved attributes.\n-    pub(super) placeholder_field_indices: NodeMap<usize>,\n+    placeholder_field_indices: NodeMap<usize>,\n }\n \n /// A unique identifier that we can use to lookup a definition\n@@ -535,6 +535,15 @@ impl Definitions {\n         let old_parent = self.invocation_parents.insert(invoc_id, parent);\n         assert!(old_parent.is_none(), \"parent `DefIndex` is reset for an invocation\");\n     }\n+\n+    pub fn placeholder_field_index(&self, node_id: ast::NodeId) -> usize {\n+        self.placeholder_field_indices[&node_id]\n+    }\n+\n+    pub fn set_placeholder_field_index(&mut self, node_id: ast::NodeId, index: usize) {\n+        let old_index = self.placeholder_field_indices.insert(node_id, index);\n+        assert!(old_index.is_none(), \"placeholder field index is reset for a node ID\");\n+    }\n }\n \n impl DefPathData {"}, {"sha": "fc754c5e675e60edd5e44209947a302be28b8559", "filename": "src/librustc/hir/map/mod.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/bbbdbb0e44bb4cea653584017acce4bcda158939/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbbdbb0e44bb4cea653584017acce4bcda158939/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs?ref=bbbdbb0e44bb4cea653584017acce4bcda158939", "patch": "@@ -1,5 +1,4 @@\n use self::collector::NodeCollector;\n-pub use self::def_collector::DefCollector;\n pub use self::definitions::{\n     Definitions, DefKey, DefPath, DefPathData, DisambiguatedDefPathData, DefPathHash\n };\n@@ -25,7 +24,6 @@ use syntax_pos::{Span, DUMMY_SP};\n \n pub mod blocks;\n mod collector;\n-mod def_collector;\n pub mod definitions;\n mod hir_id_validator;\n "}, {"sha": "a178c603a462bcfe2bcc1ecbad4f0ceb67a839f5", "filename": "src/librustc_resolve/build_reduced_graph.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/bbbdbb0e44bb4cea653584017acce4bcda158939/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbbdbb0e44bb4cea653584017acce4bcda158939/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs?ref=bbbdbb0e44bb4cea653584017acce4bcda158939", "patch": "@@ -5,6 +5,7 @@\n //! unexpanded macros in the fragment are visited and registered.\n //! Imports are also considered items and placed into modules here, but not resolved yet.\n \n+use crate::def_collector::collect_definitions;\n use crate::macros::{LegacyBinding, LegacyScope};\n use crate::resolve_imports::ImportDirective;\n use crate::resolve_imports::ImportDirectiveSubclass::{self, GlobImport, SingleImport};\n@@ -16,7 +17,6 @@ use crate::{ResolutionError, Determinacy, PathResult, CrateLint};\n use rustc::bug;\n use rustc::hir::def::{self, *};\n use rustc::hir::def_id::{CRATE_DEF_INDEX, LOCAL_CRATE, DefId};\n-use rustc::hir::map::DefCollector;\n use rustc::ty;\n use rustc::middle::cstore::CrateStore;\n use rustc_metadata::cstore::LoadedMacro;\n@@ -167,8 +167,7 @@ impl<'a> Resolver<'a> {\n         fragment: &AstFragment,\n         parent_scope: ParentScope<'a>,\n     ) -> LegacyScope<'a> {\n-        let mut def_collector = DefCollector::new(&mut self.definitions, parent_scope.expansion);\n-        fragment.visit_with(&mut def_collector);\n+        collect_definitions(&mut self.definitions, fragment, parent_scope.expansion);\n         let mut visitor = BuildReducedGraphVisitor { r: self, parent_scope };\n         fragment.visit_with(&mut visitor);\n         visitor.parent_scope.legacy"}, {"sha": "414ea6e9aa1b506f24c59044701dc30a69d6f45d", "filename": "src/librustc_resolve/def_collector.rs", "status": "renamed", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/bbbdbb0e44bb4cea653584017acce4bcda158939/src%2Flibrustc_resolve%2Fdef_collector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbbdbb0e44bb4cea653584017acce4bcda158939/src%2Flibrustc_resolve%2Fdef_collector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fdef_collector.rs?ref=bbbdbb0e44bb4cea653584017acce4bcda158939", "patch": "@@ -1,26 +1,31 @@\n-use crate::hir::map::definitions::*;\n-use crate::hir::def_id::DefIndex;\n-\n+use log::debug;\n+use rustc::hir::map::definitions::*;\n+use rustc::hir::def_id::DefIndex;\n use syntax::ast::*;\n use syntax::visit;\n use syntax::symbol::{kw, sym};\n use syntax::token::{self, Token};\n+use syntax_expand::expand::AstFragment;\n use syntax_pos::hygiene::ExpnId;\n use syntax_pos::Span;\n \n+crate fn collect_definitions(\n+    definitions: &mut Definitions,\n+    fragment: &AstFragment,\n+    expansion: ExpnId,\n+) {\n+    let parent_def = definitions.invocation_parent(expansion);\n+    fragment.visit_with(&mut DefCollector { definitions, parent_def, expansion });\n+}\n+\n /// Creates `DefId`s for nodes in the AST.\n-pub struct DefCollector<'a> {\n+struct DefCollector<'a> {\n     definitions: &'a mut Definitions,\n     parent_def: DefIndex,\n     expansion: ExpnId,\n }\n \n impl<'a> DefCollector<'a> {\n-    pub fn new(definitions: &'a mut Definitions, expansion: ExpnId) -> Self {\n-        let parent_def = definitions.invocation_parent(expansion);\n-        DefCollector { definitions, parent_def, expansion }\n-    }\n-\n     fn create_def(&mut self,\n                   node_id: NodeId,\n                   data: DefPathData,\n@@ -82,7 +87,7 @@ impl<'a> DefCollector<'a> {\n                 .or_else(|| index.map(sym::integer))\n                 .unwrap_or_else(|| {\n                     let node_id = NodeId::placeholder_from_expn_id(self.expansion);\n-                    sym::integer(self.definitions.placeholder_field_indices[&node_id])\n+                    sym::integer(self.definitions.placeholder_field_index(node_id))\n                 });\n             let def = self.create_def(field.id, DefPathData::ValueNs(name), field.span);\n             self.with_parent(def, |this| visit::walk_struct_field(this, field));\n@@ -186,7 +191,7 @@ impl<'a> visit::Visitor<'a> for DefCollector<'a> {\n         for (index, field) in data.fields().iter().enumerate() {\n             self.collect_field(field, Some(index));\n             if field.is_placeholder && field.ident.is_none() {\n-                self.definitions.placeholder_field_indices.insert(field.id, index);\n+                self.definitions.set_placeholder_field_index(field.id, index);\n             }\n         }\n     }", "previous_filename": "src/librustc/hir/map/def_collector.rs"}, {"sha": "347b72885657adaf4fdeb7c224da3e64fce25cd6", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/bbbdbb0e44bb4cea653584017acce4bcda158939/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbbdbb0e44bb4cea653584017acce4bcda158939/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=bbbdbb0e44bb4cea653584017acce4bcda158939", "patch": "@@ -68,6 +68,7 @@ use rustc_error_codes::*;\n \n type Res = def::Res<NodeId>;\n \n+mod def_collector;\n mod diagnostics;\n mod late;\n mod macros;"}]}