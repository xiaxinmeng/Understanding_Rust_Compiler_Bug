{"sha": "882fd69b224c0e0207755febf2d31e81e58861ca", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg4MmZkNjliMjI0YzBlMDIwNzc1NWZlYmYyZDMxZTgxZTU4ODYxY2E=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2021-02-21T06:26:42Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-02-21T06:26:42Z"}, "message": "Rollup merge of #81966 - deg4uss3r:degausser/aarch64_apple_ios_sim, r=shepmaster\n\nAdd new `rustc` target for Arm64 machines that can target the iphonesimulator\n\nThis PR lands a new target (`aarch64-apple-ios-sim`) that targets arm64 iphone simulator, previously unreachable from Apple Silicon machines.\n\nresolves #81632\n\nr? `@shepmaster`", "tree": {"sha": "205be5681ad71b28d542dc29d7d43fca8f8b8ac0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/205be5681ad71b28d542dc29d7d43fca8f8b8ac0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/882fd69b224c0e0207755febf2d31e81e58861ca", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgMf0jCRBK7hj4Ov3rIwAAdHIIABOsAcmYqeH7DU8oIvG9ekod\nOjn13WNzPhytTERucqzrQBLA2yjzYXFEPSQRVw8+qLOGrgyQyWm+r/8W++ZspWWe\nqWiM/ub27H0CobVN4XjzRy3bNcS09qFIO7ud+QGrZ+3rerpTpBMVYoh0Wlb3iI6C\n5Bz6aCv+ivL1BlK8hJoGyV0UtcfNrmX+RXBwrW1BUHCn4mMk4ebzwcksJGguiEKW\nEIjKydmXQ8X2+6q/VbuzND3iY040S5HDLmeA1kPl6SOFI28QLC2+ndIjvf0NckFD\n9JR7ep2ClRE1fMMes6tD5WVG2+1cvk+PhdxkPvqXnW9uKISCVkMQN/ktlQX0D8c=\n=8NHo\n-----END PGP SIGNATURE-----\n", "payload": "tree 205be5681ad71b28d542dc29d7d43fca8f8b8ac0\nparent 4c1f195e0b5de82d40da8a1bd6bbbe049d586c6b\nparent 8d6ad11ab2490e95e6cf6daa18c2684e7382bb22\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1613888802 +0900\ncommitter GitHub <noreply@github.com> 1613888802 +0900\n\nRollup merge of #81966 - deg4uss3r:degausser/aarch64_apple_ios_sim, r=shepmaster\n\nAdd new `rustc` target for Arm64 machines that can target the iphonesimulator\n\nThis PR lands a new target (`aarch64-apple-ios-sim`) that targets arm64 iphone simulator, previously unreachable from Apple Silicon machines.\n\nresolves #81632\n\nr? `@shepmaster`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/882fd69b224c0e0207755febf2d31e81e58861ca", "html_url": "https://github.com/rust-lang/rust/commit/882fd69b224c0e0207755febf2d31e81e58861ca", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/882fd69b224c0e0207755febf2d31e81e58861ca/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4c1f195e0b5de82d40da8a1bd6bbbe049d586c6b", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c1f195e0b5de82d40da8a1bd6bbbe049d586c6b", "html_url": "https://github.com/rust-lang/rust/commit/4c1f195e0b5de82d40da8a1bd6bbbe049d586c6b"}, {"sha": "8d6ad11ab2490e95e6cf6daa18c2684e7382bb22", "url": "https://api.github.com/repos/rust-lang/rust/commits/8d6ad11ab2490e95e6cf6daa18c2684e7382bb22", "html_url": "https://github.com/rust-lang/rust/commit/8d6ad11ab2490e95e6cf6daa18c2684e7382bb22"}], "stats": {"total": 69, "additions": 63, "deletions": 6}, "files": [{"sha": "b93a579df15269b5081b8f4dc004893f829aaafb", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/882fd69b224c0e0207755febf2d31e81e58861ca/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/882fd69b224c0e0207755febf2d31e81e58861ca/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=882fd69b224c0e0207755febf2d31e81e58861ca", "patch": "@@ -2193,6 +2193,7 @@ fn add_apple_sdk(cmd: &mut dyn Linker, sess: &Session, flavor: LinkerFlavor) {\n         (\"x86_64\", \"tvos\") => \"appletvsimulator\",\n         (\"arm\", \"ios\") => \"iphoneos\",\n         (\"aarch64\", \"ios\") if llvm_target.contains(\"macabi\") => \"macosx\",\n+        (\"aarch64\", \"ios\") if llvm_target.contains(\"sim\") => \"iphonesimulator\",\n         (\"aarch64\", \"ios\") => \"iphoneos\",\n         (\"x86\", \"ios\") => \"iphonesimulator\",\n         (\"x86_64\", \"ios\") if llvm_target.contains(\"macabi\") => \"macosx\","}, {"sha": "e594ceec1b78c532ba880e2c8740ec0e2bc01a41", "filename": "compiler/rustc_target/src/spec/aarch64_apple_ios_sim.rs", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/882fd69b224c0e0207755febf2d31e81e58861ca/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_sim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/882fd69b224c0e0207755febf2d31e81e58861ca/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_sim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_sim.rs?ref=882fd69b224c0e0207755febf2d31e81e58861ca", "patch": "@@ -0,0 +1,39 @@\n+use super::apple_sdk_base::{opts, Arch};\n+use crate::spec::{Target, TargetOptions};\n+\n+pub fn target() -> Target {\n+    let base = opts(\"ios\", Arch::Arm64_sim);\n+\n+    // Clang automatically chooses a more specific target based on\n+    // IPHONEOS_DEPLOYMENT_TARGET.\n+    // This is required for the simulator target to pick the right\n+    // MACH-O commands, so we do too.\n+    let arch = \"arm64\";\n+    let llvm_target = super::apple_base::ios_sim_llvm_target(arch);\n+\n+    Target {\n+        llvm_target: llvm_target,\n+        pointer_width: 64,\n+        data_layout: \"e-m:o-i64:64-i128:128-n32:64-S128\".to_string(),\n+        arch: \"aarch64\".to_string(),\n+        options: TargetOptions {\n+            features: \"+neon,+fp-armv8,+apple-a7\".to_string(),\n+            eliminate_frame_pointer: false,\n+            max_atomic_width: Some(128),\n+            unsupported_abis: super::arm_base::unsupported_abis(),\n+            forces_embed_bitcode: true,\n+            // Taken from a clang build on Xcode 11.4.1.\n+            // These arguments are not actually invoked - they just have\n+            // to look right to pass App Store validation.\n+            bitcode_llvm_cmdline: \"-triple\\0\\\n+                arm64-apple-ios14.0-simulator\\0\\\n+                -emit-obj\\0\\\n+                -disable-llvm-passes\\0\\\n+                -target-abi\\0\\\n+                darwinpcs\\0\\\n+                -Os\\0\"\n+                .to_string(),\n+            ..base\n+        },\n+    }\n+}"}, {"sha": "23f1357af163f22590e07fb7fed02736ab4bb552", "filename": "compiler/rustc_target/src/spec/apple_base.rs", "status": "modified", "additions": 16, "deletions": 5, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/882fd69b224c0e0207755febf2d31e81e58861ca/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/882fd69b224c0e0207755febf2d31e81e58861ca/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_base.rs?ref=882fd69b224c0e0207755febf2d31e81e58861ca", "patch": "@@ -54,14 +54,16 @@ pub fn opts(os: &str) -> TargetOptions {\n     }\n }\n \n-fn macos_deployment_target() -> (u32, u32) {\n-    let deployment_target = env::var(\"MACOSX_DEPLOYMENT_TARGET\").ok();\n-    let version = deployment_target\n+fn deployment_target(var_name: &str) -> Option<(u32, u32)> {\n+    let deployment_target = env::var(var_name).ok();\n+    deployment_target\n         .as_ref()\n         .and_then(|s| s.split_once('.'))\n-        .and_then(|(a, b)| a.parse::<u32>().and_then(|a| b.parse::<u32>().map(|b| (a, b))).ok());\n+        .and_then(|(a, b)| a.parse::<u32>().and_then(|a| b.parse::<u32>().map(|b| (a, b))).ok())\n+}\n \n-    version.unwrap_or((10, 7))\n+fn macos_deployment_target() -> (u32, u32) {\n+    deployment_target(\"MACOSX_DEPLOYMENT_TARGET\").unwrap_or((10, 7))\n }\n \n pub fn macos_llvm_target(arch: &str) -> String {\n@@ -84,3 +86,12 @@ pub fn macos_link_env_remove() -> Vec<String> {\n     env_remove.push(\"IPHONEOS_DEPLOYMENT_TARGET\".to_string());\n     env_remove\n }\n+\n+fn ios_deployment_target() -> (u32, u32) {\n+    deployment_target(\"IPHONEOS_DEPLOYMENT_TARGET\").unwrap_or((7, 0))\n+}\n+\n+pub fn ios_sim_llvm_target(arch: &str) -> String {\n+    let (major, minor) = ios_deployment_target();\n+    format!(\"{}-apple-ios{}.{}.0-simulator\", arch, major, minor)\n+}"}, {"sha": "538c4ca86974f9e8c71835eaed9e3c74e98fbc60", "filename": "compiler/rustc_target/src/spec/apple_sdk_base.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/882fd69b224c0e0207755febf2d31e81e58861ca/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_sdk_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/882fd69b224c0e0207755febf2d31e81e58861ca/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_sdk_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_sdk_base.rs?ref=882fd69b224c0e0207755febf2d31e81e58861ca", "patch": "@@ -11,6 +11,7 @@ pub enum Arch {\n     X86_64,\n     X86_64_macabi,\n     Arm64_macabi,\n+    Arm64_sim,\n }\n \n fn target_cpu(arch: Arch) -> String {\n@@ -22,13 +23,16 @@ fn target_cpu(arch: Arch) -> String {\n         X86_64 => \"core2\",\n         X86_64_macabi => \"core2\",\n         Arm64_macabi => \"apple-a12\",\n+        Arm64_sim => \"apple-a12\",\n     }\n     .to_string()\n }\n \n fn link_env_remove(arch: Arch) -> Vec<String> {\n     match arch {\n-        Armv7 | Armv7s | Arm64 | I386 | X86_64 => vec![\"MACOSX_DEPLOYMENT_TARGET\".to_string()],\n+        Armv7 | Armv7s | Arm64 | I386 | X86_64 | Arm64_sim => {\n+            vec![\"MACOSX_DEPLOYMENT_TARGET\".to_string()]\n+        }\n         X86_64_macabi | Arm64_macabi => vec![\"IPHONEOS_DEPLOYMENT_TARGET\".to_string()],\n     }\n }"}, {"sha": "ae803dbdb3117265b7b33e078040c10df1378394", "filename": "compiler/rustc_target/src/spec/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/882fd69b224c0e0207755febf2d31e81e58861ca/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/882fd69b224c0e0207755febf2d31e81e58861ca/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs?ref=882fd69b224c0e0207755febf2d31e81e58861ca", "patch": "@@ -727,6 +727,7 @@ supported_targets! {\n     (\"armv7s-apple-ios\", armv7s_apple_ios),\n     (\"x86_64-apple-ios-macabi\", x86_64_apple_ios_macabi),\n     (\"aarch64-apple-ios-macabi\", aarch64_apple_ios_macabi),\n+    (\"aarch64-apple-ios-sim\", aarch64_apple_ios_sim),\n     (\"aarch64-apple-tvos\", aarch64_apple_tvos),\n     (\"x86_64-apple-tvos\", x86_64_apple_tvos),\n "}, {"sha": "d21cf334442c84090f2eec83fb9df1a5414b6967", "filename": "src/doc/rustc/src/platform-support.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/882fd69b224c0e0207755febf2d31e81e58861ca/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support.md", "raw_url": "https://github.com/rust-lang/rust/raw/882fd69b224c0e0207755febf2d31e81e58861ca/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support.md?ref=882fd69b224c0e0207755febf2d31e81e58861ca", "patch": "@@ -153,6 +153,7 @@ not available.\n target | std | host | notes\n -------|-----|------|-------\n `aarch64-apple-ios-macabi` | ? |  | Apple Catalyst on ARM64\n+`aarch64-apple-ios-sim` | ? |  | Apple iOS Simulator on ARM64\n `aarch64-apple-tvos` | * |  | ARM64 tvOS\n `aarch64-unknown-freebsd` | \u2713 | \u2713 | ARM64 FreeBSD\n `aarch64-unknown-hermit` | ? |  |"}]}