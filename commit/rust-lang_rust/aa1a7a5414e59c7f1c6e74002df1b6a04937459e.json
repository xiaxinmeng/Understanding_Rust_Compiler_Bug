{"sha": "aa1a7a5414e59c7f1c6e74002df1b6a04937459e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFhMWE3YTU0MTRlNTljN2YxYzZlNzQwMDJkZjFiNmEwNDkzNzQ1OWU=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-08-18T14:41:21Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-08-18T14:50:07Z"}, "message": "Introduce Label", "tree": {"sha": "6d112b6a8614138ebffa8bef0b27d90f8ef2cef9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6d112b6a8614138ebffa8bef0b27d90f8ef2cef9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aa1a7a5414e59c7f1c6e74002df1b6a04937459e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aa1a7a5414e59c7f1c6e74002df1b6a04937459e", "html_url": "https://github.com/rust-lang/rust/commit/aa1a7a5414e59c7f1c6e74002df1b6a04937459e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eb81731600d1bc50efc00e32b9fc2244a2af52ad", "url": "https://api.github.com/repos/rust-lang/rust/commits/eb81731600d1bc50efc00e32b9fc2244a2af52ad", "html_url": "https://github.com/rust-lang/rust/commit/eb81731600d1bc50efc00e32b9fc2244a2af52ad"}], "stats": {"total": 98, "additions": 68, "deletions": 30}, "files": [{"sha": "11c171fc2d6f5b3bcafd6aaa814517c411fe6d0d", "filename": "crates/assists/src/assist_context.rs", "status": "modified", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Fassists%2Fsrc%2Fassist_context.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Fassists%2Fsrc%2Fassist_context.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Fassist_context.rs?ref=aa1a7a5414e59c7f1c6e74002df1b6a04937459e", "patch": "@@ -6,6 +6,7 @@ use algo::find_covering_element;\n use base_db::{FileId, FileRange};\n use hir::Semantics;\n use ide_db::{\n+    label::Label,\n     source_change::{SourceChange, SourceFileEdit},\n     RootDatabase,\n };\n@@ -157,8 +158,9 @@ impl Assists {\n         if !self.is_allowed(&id) {\n             return None;\n         }\n-        let label = Assist::new(id, label.into(), None, target);\n-        self.add_impl(label, f)\n+        let label = Label::new(label.into());\n+        let assist = Assist { id, label, group: None, target };\n+        self.add_impl(assist, f)\n     }\n \n     pub(crate) fn add_group(\n@@ -172,12 +174,12 @@ impl Assists {\n         if !self.is_allowed(&id) {\n             return None;\n         }\n-\n-        let label = Assist::new(id, label.into(), Some(group.clone()), target);\n-        self.add_impl(label, f)\n+        let label = Label::new(label.into());\n+        let assist = Assist { id, label, group: Some(group.clone()), target };\n+        self.add_impl(assist, f)\n     }\n \n-    fn add_impl(&mut self, label: Assist, f: impl FnOnce(&mut AssistBuilder)) -> Option<()> {\n+    fn add_impl(&mut self, assist: Assist, f: impl FnOnce(&mut AssistBuilder)) -> Option<()> {\n         let source_change = if self.resolve {\n             let mut builder = AssistBuilder::new(self.file);\n             f(&mut builder);\n@@ -186,7 +188,7 @@ impl Assists {\n             None\n         };\n \n-        self.buf.push((label, source_change));\n+        self.buf.push((assist, source_change));\n         Some(())\n     }\n "}, {"sha": "14834480ac39b3f77c52a5390befeee57ed86a61", "filename": "crates/assists/src/lib.rs", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Fassists%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Fassists%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Flib.rs?ref=aa1a7a5414e59c7f1c6e74002df1b6a04937459e", "patch": "@@ -19,7 +19,7 @@ pub mod ast_transform;\n \n use base_db::FileRange;\n use hir::Semantics;\n-use ide_db::{source_change::SourceChange, RootDatabase};\n+use ide_db::{label::Label, source_change::SourceChange, RootDatabase};\n use syntax::TextRange;\n \n pub(crate) use crate::assist_context::{AssistContext, Assists};\n@@ -68,7 +68,7 @@ pub struct GroupLabel(pub String);\n pub struct Assist {\n     pub id: AssistId,\n     /// Short description of the assist, as shown in the UI.\n-    label: String,\n+    pub label: Label,\n     pub group: Option<GroupLabel>,\n     /// Target ranges are used to sort assists: the smaller the target range,\n     /// the more specific assist is, and so it should be sorted first.\n@@ -82,11 +82,6 @@ pub struct ResolvedAssist {\n }\n \n impl Assist {\n-    fn new(id: AssistId, label: String, group: Option<GroupLabel>, target: TextRange) -> Assist {\n-        assert!(label.starts_with(char::is_uppercase));\n-        Assist { id, label, group, target }\n-    }\n-\n     /// Return all the assists applicable at the given position.\n     ///\n     /// Assists are returned in the \"unresolved\" state, that is only labels are\n@@ -118,10 +113,6 @@ impl Assist {\n         });\n         acc.finish_resolved()\n     }\n-\n-    pub fn label(&self) -> &str {\n-        self.label.as_str()\n-    }\n }\n \n mod handlers {"}, {"sha": "3c36c0e15dca7b2581b440169ce116c1316fcf60", "filename": "crates/ide/src/diagnostics.rs", "status": "modified", "additions": 4, "deletions": 9, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Fide%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Fide%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fdiagnostics.rs?ref=aa1a7a5414e59c7f1c6e74002df1b6a04937459e", "patch": "@@ -19,7 +19,7 @@ use syntax::{\n };\n use text_edit::TextEdit;\n \n-use crate::{FileId, SourceChange, SourceFileEdit};\n+use crate::{FileId, Label, SourceChange, SourceFileEdit};\n \n use self::fixes::DiagnosticWithFix;\n \n@@ -34,20 +34,15 @@ pub struct Diagnostic {\n \n #[derive(Debug)]\n pub struct Fix {\n-    pub label: String,\n+    pub label: Label,\n     pub source_change: SourceChange,\n     /// Allows to trigger the fix only when the caret is in the range given\n     pub fix_trigger_range: TextRange,\n }\n \n impl Fix {\n-    fn new(\n-        label: impl Into<String>,\n-        source_change: SourceChange,\n-        fix_trigger_range: TextRange,\n-    ) -> Self {\n-        let label = label.into();\n-        assert!(label.starts_with(char::is_uppercase) && !label.ends_with('.'));\n+    fn new(label: &str, source_change: SourceChange, fix_trigger_range: TextRange) -> Self {\n+        let label = Label::new(label);\n         Self { label, source_change, fix_trigger_range }\n     }\n }"}, {"sha": "e3af6d5bc945aa9525e8e8a64498226084675213", "filename": "crates/ide/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Fide%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Fide%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Flib.rs?ref=aa1a7a5414e59c7f1c6e74002df1b6a04937459e", "patch": "@@ -88,6 +88,7 @@ pub use base_db::{\n pub use hir::{Documentation, Semantics};\n pub use ide_db::{\n     change::AnalysisChange,\n+    label::Label,\n     line_index::{LineCol, LineIndex},\n     search::SearchScope,\n     source_change::{FileSystemEdit, SourceChange, SourceFileEdit},"}, {"sha": "c0e89e72f5827c07e8d22e0112780b7e01296288", "filename": "crates/ide_db/src/label.rs", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Fide_db%2Fsrc%2Flabel.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Fide_db%2Fsrc%2Flabel.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Flabel.rs?ref=aa1a7a5414e59c7f1c6e74002df1b6a04937459e", "patch": "@@ -0,0 +1,49 @@\n+//! See `Label`\n+use std::fmt;\n+\n+/// A type to specify UI label, like an entry in the list of assists. Enforces\n+/// proper casing:\n+///\n+///    Frobnicate bar\n+///\n+/// Note the upper-case first letter and the absence of `.` at the end.\n+#[derive(Clone)]\n+pub struct Label(String);\n+\n+impl PartialEq<str> for Label {\n+    fn eq(&self, other: &str) -> bool {\n+        self.0 == other\n+    }\n+}\n+\n+impl PartialEq<&'_ str> for Label {\n+    fn eq(&self, other: &&str) -> bool {\n+        self == *other\n+    }\n+}\n+\n+impl From<Label> for String {\n+    fn from(label: Label) -> String {\n+        label.0\n+    }\n+}\n+\n+impl Label {\n+    pub fn new(label: impl Into<String>) -> Label {\n+        let label = label.into();\n+        assert!(label.starts_with(char::is_uppercase) && !label.ends_with('.'));\n+        Label(label)\n+    }\n+}\n+\n+impl fmt::Display for Label {\n+    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+        fmt::Display::fmt(&self.0, f)\n+    }\n+}\n+\n+impl fmt::Debug for Label {\n+    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+        fmt::Debug::fmt(&self.0, f)\n+    }\n+}"}, {"sha": "70ada02f3121ef0b03cf489ea2c35e7eaf659320", "filename": "crates/ide_db/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Fide_db%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Fide_db%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Flib.rs?ref=aa1a7a5414e59c7f1c6e74002df1b6a04937459e", "patch": "@@ -2,6 +2,7 @@\n //!\n //! It is mainly a `HirDatabase` for semantic analysis, plus a `SymbolsDatabase`, for fuzzy search.\n \n+pub mod label;\n pub mod line_index;\n pub mod symbol_index;\n pub mod change;"}, {"sha": "f8159d0f4984cec2c49acea40f9c6dd970476e2c", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=aa1a7a5414e59c7f1c6e74002df1b6a04937459e", "patch": "@@ -782,10 +782,9 @@ fn handle_fixes(\n         .filter_map(|d| d.fix)\n         .filter(|fix| fix.fix_trigger_range.intersect(range).is_some())\n     {\n-        let title = fix.label;\n         let edit = to_proto::snippet_workspace_edit(&snap, fix.source_change)?;\n         let action = lsp_ext::CodeAction {\n-            title,\n+            title: fix.label.to_string(),\n             id: None,\n             group: None,\n             kind: Some(CodeActionKind::QUICKFIX),"}, {"sha": "643dcb4fcb56706801ea626e1bcc763829a7868b", "filename": "crates/rust-analyzer/src/to_proto.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa1a7a5414e59c7f1c6e74002df1b6a04937459e/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs?ref=aa1a7a5414e59c7f1c6e74002df1b6a04937459e", "patch": "@@ -704,7 +704,7 @@ pub(crate) fn unresolved_code_action(\n     index: usize,\n ) -> Result<lsp_ext::CodeAction> {\n     let res = lsp_ext::CodeAction {\n-        title: assist.label().to_string(),\n+        title: assist.label.to_string(),\n         id: Some(format!(\"{}:{}\", assist.id.0, index.to_string())),\n         group: assist.group.filter(|_| snap.config.client_caps.code_action_group).map(|gr| gr.0),\n         kind: Some(code_action_kind(assist.id.1)),"}]}