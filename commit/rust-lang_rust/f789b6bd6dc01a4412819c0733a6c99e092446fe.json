{"sha": "f789b6bd6dc01a4412819c0733a6c99e092446fe", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY3ODliNmJkNmRjMDFhNDQxMjgxOWMwNzMzYTZjOTllMDkyNDQ2ZmU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-09-14T22:17:45Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-09-14T22:17:45Z"}, "message": "Auto merge of #54069 - petrochenkov:subns, r=aturon\n\nresolve: Introduce two sub-namespaces in macro namespace\n\nTwo sub-namespaces are introduced in the macro namespace - one for bang macros and one for attribute-like macros (attributes, derives).\n\n\"Sub-namespace\" means this is not a newly introduced full namespace, the single macro namespace is still in place.\nI.e. you still can't define/import two macros with the same name in a single module, `use` imports still import only one name in macro namespace (from any sub-namespace) and not possibly two.\n\nHowever, when we are searching for a name used in a `!` macro call context (`my_macro!()`) we skip attribute names in scope, and when we are searching for a name used in attribute context (`#[my_macro]`/`#[derive(my_macro)]`) we are skipping bang macro names in scope.\nIn other words, bang macros cannot shadow attribute macros and vice versa.\n\nFor a non-macro analogy, we could e.g. skip non-traits when searching for `MyTrait` in `impl MyTrait for Type { ... }`.\nHowever we do not do it in non-macro namespaces because we don't have practical issues with e.g. non-traits shadowing traits with the same name, but with macros we do, especially after macro modularization.\n\nFor `#[test]` and `#[bench]` we have a hack in the compiler right now preventing their shadowing by `macro_rules! test` and similar things. This hack was introduced after making `#[test]`/`#[bench]` built-in macros instead of built-in attributes (https://github.com/rust-lang/rust/pull/53410), something that needed to be done from the start since they are \"active\" attributes transforming their inputs.\nNow they are passed through normal name resolution and can be shadowed, but that's a breaking change, so we have  a special hack basically applying this PR for `#[test]` and `#[bench]` only.\n\nSoon all potentially built-in attributes will be passed through normal name resolution (https://github.com/rust-lang/rust/pull/53913) and that uncovers even more cases where the strict \"macro namespace is a single namespace\" rule needs to be broken.\nFor example, with strict rules, built-in macro `cfg!(...)` would shadow built-in attribute `#[cfg]` (they are different things), standard library macro `thread_local!(...)` would shadow built-in attribute `#[thread_local]` - both of these cases are covered by special hacks in https://github.com/rust-lang/rust/pull/53913 as well.\nCrater run uncovered more cases of attributes being shadowed by user-defined macros (`warn`, `doc`, `main`, even `deprecated`), we cannot add exceptions in the compiler for all of them.\n\nRegressions with user-defined attributes like https://github.com/rust-lang/rust/issues/53583 and https://github.com/rust-lang/rust/issues/53898 also appeared after enabling macro modularization.\n\nPeople are also usually confused (https://github.com/rust-lang/rust/issues/53205#issuecomment-411552763, https://github.com/rust-lang/rust/issues/53583#issuecomment-415447800) when they see conflicts between attributes and non-attribute macros for the first time.\n\nSo my proposed solution is to solve this issue by introducing two sub-namespaces and thus skipping resolutions of the wrong kind and preventing more error-causing cases of shadowing.\n\nFixes https://github.com/rust-lang/rust/issues/53583", "tree": {"sha": "9a9b6c2fe96d385c68b7631e9626352da118b097", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9a9b6c2fe96d385c68b7631e9626352da118b097"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f789b6bd6dc01a4412819c0733a6c99e092446fe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f789b6bd6dc01a4412819c0733a6c99e092446fe", "html_url": "https://github.com/rust-lang/rust/commit/f789b6bd6dc01a4412819c0733a6c99e092446fe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f789b6bd6dc01a4412819c0733a6c99e092446fe/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2ab3eba30741652ba538bc2fc2bba9d81a5c84c6", "url": "https://api.github.com/repos/rust-lang/rust/commits/2ab3eba30741652ba538bc2fc2bba9d81a5c84c6", "html_url": "https://github.com/rust-lang/rust/commit/2ab3eba30741652ba538bc2fc2bba9d81a5c84c6"}, {"sha": "beb3b5d22c709c19600ca6514d94f9cf1be44dca", "url": "https://api.github.com/repos/rust-lang/rust/commits/beb3b5d22c709c19600ca6514d94f9cf1be44dca", "html_url": "https://github.com/rust-lang/rust/commit/beb3b5d22c709c19600ca6514d94f9cf1be44dca"}], "stats": {"total": 99, "additions": 64, "deletions": 35}, "files": [{"sha": "d955a21ef233256c71cb4f1ae26f2a740c71e654", "filename": "src/librustc_resolve/macros.rs", "status": "modified", "additions": 18, "deletions": 11, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Flibrustc_resolve%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Flibrustc_resolve%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fmacros.rs?ref=f789b6bd6dc01a4412819c0733a6c99e092446fe", "patch": "@@ -118,11 +118,21 @@ pub struct ProcMacError {\n     warn_msg: &'static str,\n }\n \n-// For compatibility bang macros are skipped when resolving potentially built-in attributes.\n-fn macro_kind_mismatch(name: Name, requirement: Option<MacroKind>, candidate: Option<MacroKind>)\n-                       -> bool {\n-    requirement == Some(MacroKind::Attr) && candidate == Some(MacroKind::Bang) &&\n-    (name == \"test\" || name == \"bench\" || is_builtin_attr_name(name))\n+// Macro namespace is separated into two sub-namespaces, one for bang macros and\n+// one for attribute-like macros (attributes, derives).\n+// We ignore resolutions from one sub-namespace when searching names in scope for another.\n+fn sub_namespace_mismatch(requirement: Option<MacroKind>, candidate: Option<MacroKind>) -> bool {\n+    #[derive(PartialEq)]\n+    enum SubNS { Bang, AttrLike }\n+    let sub_ns = |kind| match kind {\n+        MacroKind::Bang => Some(SubNS::Bang),\n+        MacroKind::Attr | MacroKind::Derive => Some(SubNS::AttrLike),\n+        MacroKind::ProcMacroStub => None,\n+    };\n+    let requirement = requirement.and_then(|kind| sub_ns(kind));\n+    let candidate = candidate.and_then(|kind| sub_ns(kind));\n+    // \"No specific sub-namespace\" means \"matches anything\" for both requirements and candidates.\n+    candidate.is_some() && requirement.is_some() && candidate != requirement\n }\n \n impl<'a, 'crateloader: 'a> base::Resolver for Resolver<'a, 'crateloader> {\n@@ -641,10 +651,7 @@ impl<'a, 'cl> Resolver<'a, 'cl> {\n                     }\n                 }\n                 WhereToResolve::BuiltinAttrs => {\n-                    // FIXME: Only built-in attributes are not considered as candidates for\n-                    // non-attributes to fight off regressions on stable channel (#53205).\n-                    // We need to come up with some more principled approach instead.\n-                    if kind == Some(MacroKind::Attr) && is_builtin_attr_name(ident.name) {\n+                    if is_builtin_attr_name(ident.name) {\n                         let binding = (Def::NonMacroAttr(NonMacroAttrKind::Builtin),\n                                        ty::Visibility::Public, ident.span, Mark::root())\n                                        .to_name_binding(self.arenas);\n@@ -765,7 +772,7 @@ impl<'a, 'cl> Resolver<'a, 'cl> {\n \n             match result {\n                 Ok(result) => {\n-                    if macro_kind_mismatch(ident.name, kind, result.0.macro_kind()) {\n+                    if sub_namespace_mismatch(kind, result.0.macro_kind()) {\n                         continue_search!();\n                     }\n \n@@ -829,7 +836,7 @@ impl<'a, 'cl> Resolver<'a, 'cl> {\n         parent_scope: &ParentScope<'a>,\n         record_used: bool,\n     ) -> Option<&'a NameBinding<'a>> {\n-        if macro_kind_mismatch(ident.name, kind, Some(MacroKind::Bang)) {\n+        if sub_namespace_mismatch(kind, Some(MacroKind::Bang)) {\n             return None;\n         }\n "}, {"sha": "9912a89dafb3f0e799725e740baf8b623cb1ab5d", "filename": "src/test/ui-fulldeps/proc-macro/auxiliary/derive-helper-shadowed-2.rs", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fauxiliary%2Fderive-helper-shadowed-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fauxiliary%2Fderive-helper-shadowed-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fauxiliary%2Fderive-helper-shadowed-2.rs?ref=f789b6bd6dc01a4412819c0733a6c99e092446fe", "patch": "@@ -0,0 +1,2 @@\n+#[macro_export]\n+macro_rules! my_attr { () => () }"}, {"sha": "4e701710f4212426b42618c87d2a6d2b86494e6b", "filename": "src/test/ui-fulldeps/proc-macro/auxiliary/derive-helper-shadowed.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fauxiliary%2Fderive-helper-shadowed.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fauxiliary%2Fderive-helper-shadowed.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fauxiliary%2Fderive-helper-shadowed.rs?ref=f789b6bd6dc01a4412819c0733a6c99e092446fe", "patch": "@@ -0,0 +1,11 @@\n+// no-prefer-dynamic\n+\n+#![crate_type = \"proc-macro\"]\n+\n+extern crate proc_macro;\n+use proc_macro::*;\n+\n+#[proc_macro_derive(MyTrait, attributes(my_attr))]\n+pub fn foo(_: TokenStream) -> TokenStream {\n+    TokenStream::new()\n+}"}, {"sha": "792b54b3b945ae4a5f8e043934334b055896f912", "filename": "src/test/ui-fulldeps/proc-macro/derive-helper-shadowed.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fderive-helper-shadowed.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fderive-helper-shadowed.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fderive-helper-shadowed.rs?ref=f789b6bd6dc01a4412819c0733a6c99e092446fe", "patch": "@@ -0,0 +1,16 @@\n+// compile-pass\n+// aux-build:derive-helper-shadowed.rs\n+// aux-build:derive-helper-shadowed-2.rs\n+\n+#[macro_use]\n+extern crate derive_helper_shadowed;\n+#[macro_use(my_attr)]\n+extern crate derive_helper_shadowed_2;\n+\n+macro_rules! my_attr { () => () }\n+\n+#[derive(MyTrait)]\n+#[my_attr] // OK\n+struct S;\n+\n+fn main() {}"}, {"sha": "a4b8b48384d7aa59213dd67d81ca73053fb6ed70", "filename": "src/test/ui/issues/issue-11692-2.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui%2Fissues%2Fissue-11692-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui%2Fissues%2Fissue-11692-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-11692-2.rs?ref=f789b6bd6dc01a4412819c0733a6c99e092446fe", "patch": "@@ -9,5 +9,5 @@\n // except according to those terms.\n \n fn main() {\n-    concat!(test!()); //~ ERROR `test` can only be used in attributes\n+    concat!(test!()); //~ ERROR cannot find macro `test!` in this scope\n }"}, {"sha": "85f600dbff24e85712d7d16a428242cbe33e4459", "filename": "src/test/ui/issues/issue-11692-2.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui%2Fissues%2Fissue-11692-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui%2Fissues%2Fissue-11692-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-11692-2.stderr?ref=f789b6bd6dc01a4412819c0733a6c99e092446fe", "patch": "@@ -1,7 +1,7 @@\n-error: `test` can only be used in attributes\n+error: cannot find macro `test!` in this scope\n   --> $DIR/issue-11692-2.rs:12:13\n    |\n-LL |     concat!(test!()); //~ ERROR `test` can only be used in attributes\n+LL |     concat!(test!()); //~ ERROR cannot find macro `test!` in this scope\n    |             ^^^^\n \n error: aborting due to previous error"}, {"sha": "597053d625134d831fa6f6c73a2a97ba1d670a51", "filename": "src/test/ui/macros/macro-path-prelude-fail-3.rs", "status": "modified", "additions": 0, "deletions": 13, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui%2Fmacros%2Fmacro-path-prelude-fail-3.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui%2Fmacros%2Fmacro-path-prelude-fail-3.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fmacro-path-prelude-fail-3.rs?ref=f789b6bd6dc01a4412819c0733a6c99e092446fe", "patch": "@@ -1,16 +1,3 @@\n-// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n-// file at the top-level directory of this distribution and at\n-// http://rust-lang.org/COPYRIGHT.\n-//\n-// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n-// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n-// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n-// option. This file may not be copied, modified, or distributed\n-// except according to those terms.\n-\n-#[derive(inline)] //~ ERROR cannot find derive macro `inline` in this scope\n-struct S;\n-\n fn main() {\n     inline!(); //~ ERROR cannot find macro `inline!` in this scope\n }"}, {"sha": "1772325118174e88fd2c4051f33d1976b0302659", "filename": "src/test/ui/macros/macro-path-prelude-fail-3.stderr", "status": "modified", "additions": 2, "deletions": 8, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui%2Fmacros%2Fmacro-path-prelude-fail-3.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui%2Fmacros%2Fmacro-path-prelude-fail-3.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fmacro-path-prelude-fail-3.stderr?ref=f789b6bd6dc01a4412819c0733a6c99e092446fe", "patch": "@@ -1,14 +1,8 @@\n-error: cannot find derive macro `inline` in this scope\n-  --> $DIR/macro-path-prelude-fail-3.rs:11:10\n-   |\n-LL | #[derive(inline)] //~ ERROR cannot find derive macro `inline` in this scope\n-   |          ^^^^^^\n-\n error: cannot find macro `inline!` in this scope\n-  --> $DIR/macro-path-prelude-fail-3.rs:15:5\n+  --> $DIR/macro-path-prelude-fail-3.rs:2:5\n    |\n LL |     inline!(); //~ ERROR cannot find macro `inline!` in this scope\n    |     ^^^^^^ help: you could try the macro: `line`\n \n-error: aborting due to 2 previous errors\n+error: aborting due to previous error\n "}, {"sha": "283427b9acefed06708c98e5ef9265e7bb522556", "filename": "src/test/ui/macros/macro-path-prelude-fail-4.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui%2Fmacros%2Fmacro-path-prelude-fail-4.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui%2Fmacros%2Fmacro-path-prelude-fail-4.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fmacro-path-prelude-fail-4.rs?ref=f789b6bd6dc01a4412819c0733a6c99e092446fe", "patch": "@@ -0,0 +1,4 @@\n+#[derive(inline)] //~ ERROR expected a macro, found built-in attribute\n+struct S;\n+\n+fn main() {}"}, {"sha": "e354f345a4c2f437208482c7baa1d4d86ccbfc07", "filename": "src/test/ui/macros/macro-path-prelude-fail-4.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui%2Fmacros%2Fmacro-path-prelude-fail-4.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f789b6bd6dc01a4412819c0733a6c99e092446fe/src%2Ftest%2Fui%2Fmacros%2Fmacro-path-prelude-fail-4.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fmacro-path-prelude-fail-4.stderr?ref=f789b6bd6dc01a4412819c0733a6c99e092446fe", "patch": "@@ -0,0 +1,8 @@\n+error: expected a macro, found built-in attribute\n+  --> $DIR/macro-path-prelude-fail-4.rs:1:10\n+   |\n+LL | #[derive(inline)] //~ ERROR expected a macro, found built-in attribute\n+   |          ^^^^^^\n+\n+error: aborting due to previous error\n+"}]}