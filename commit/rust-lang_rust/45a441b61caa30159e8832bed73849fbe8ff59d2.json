{"sha": "45a441b61caa30159e8832bed73849fbe8ff59d2", "node_id": "C_kwDOAAsO6NoAKDQ1YTQ0MWI2MWNhYTMwMTU5ZTg4MzJiZWQ3Mzg0OWZiZThmZjU5ZDI", "commit": {"author": {"name": "cynecx", "email": "me@cynecx.net", "date": "2022-02-25T21:52:17Z"}, "committer": {"name": "cynecx", "email": "me@cynecx.net", "date": "2022-02-25T21:53:34Z"}, "message": "`check_used` should only look at actual `used` attributes", "tree": {"sha": "99fa680f2025d5712b76745e474476f375bff49c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/99fa680f2025d5712b76745e474476f375bff49c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/45a441b61caa30159e8832bed73849fbe8ff59d2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/45a441b61caa30159e8832bed73849fbe8ff59d2", "html_url": "https://github.com/rust-lang/rust/commit/45a441b61caa30159e8832bed73849fbe8ff59d2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/45a441b61caa30159e8832bed73849fbe8ff59d2/comments", "author": {"login": "cynecx", "id": 5961244, "node_id": "MDQ6VXNlcjU5NjEyNDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/5961244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cynecx", "html_url": "https://github.com/cynecx", "followers_url": "https://api.github.com/users/cynecx/followers", "following_url": "https://api.github.com/users/cynecx/following{/other_user}", "gists_url": "https://api.github.com/users/cynecx/gists{/gist_id}", "starred_url": "https://api.github.com/users/cynecx/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cynecx/subscriptions", "organizations_url": "https://api.github.com/users/cynecx/orgs", "repos_url": "https://api.github.com/users/cynecx/repos", "events_url": "https://api.github.com/users/cynecx/events{/privacy}", "received_events_url": "https://api.github.com/users/cynecx/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cynecx", "id": 5961244, "node_id": "MDQ6VXNlcjU5NjEyNDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/5961244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cynecx", "html_url": "https://github.com/cynecx", "followers_url": "https://api.github.com/users/cynecx/followers", "following_url": "https://api.github.com/users/cynecx/following{/other_user}", "gists_url": "https://api.github.com/users/cynecx/gists{/gist_id}", "starred_url": "https://api.github.com/users/cynecx/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cynecx/subscriptions", "organizations_url": "https://api.github.com/users/cynecx/orgs", "repos_url": "https://api.github.com/users/cynecx/repos", "events_url": "https://api.github.com/users/cynecx/events{/privacy}", "received_events_url": "https://api.github.com/users/cynecx/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d981633ed6669c6f7b1cb46d1d1a7282e281ca8e", "url": "https://api.github.com/repos/rust-lang/rust/commits/d981633ed6669c6f7b1cb46d1d1a7282e281ca8e", "html_url": "https://github.com/rust-lang/rust/commit/d981633ed6669c6f7b1cb46d1d1a7282e281ca8e"}], "stats": {"total": 13, "additions": 11, "deletions": 2}, "files": [{"sha": "6e4907fe518ae1626594a112ec015dfeb11b0e6a", "filename": "compiler/rustc_passes/src/check_attr.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/45a441b61caa30159e8832bed73849fbe8ff59d2/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/45a441b61caa30159e8832bed73849fbe8ff59d2/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs?ref=45a441b61caa30159e8832bed73849fbe8ff59d2", "patch": "@@ -1740,8 +1740,8 @@ impl CheckAttrVisitor<'_> {\n     fn check_used(&self, attrs: &[Attribute], target: Target) {\n         let mut used_linker_span = None;\n         let mut used_compiler_span = None;\n-        for attr in attrs {\n-            if attr.has_name(sym::used) && target != Target::Static {\n+        for attr in attrs.iter().filter(|attr| attr.has_name(sym::used)) {\n+            if target != Target::Static {\n                 self.tcx\n                     .sess\n                     .span_err(attr.span, \"attribute must be applied to a `static` variable\");"}, {"sha": "d0bbe76ef3e570a222485efae4caa8cacd1424d8", "filename": "src/test/ui/attributes/used_with_arg_no_mangle.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/45a441b61caa30159e8832bed73849fbe8ff59d2/src%2Ftest%2Fui%2Fattributes%2Fused_with_arg_no_mangle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/45a441b61caa30159e8832bed73849fbe8ff59d2/src%2Ftest%2Fui%2Fattributes%2Fused_with_arg_no_mangle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fattributes%2Fused_with_arg_no_mangle.rs?ref=45a441b61caa30159e8832bed73849fbe8ff59d2", "patch": "@@ -0,0 +1,9 @@\n+// check-pass\n+\n+#![feature(used_with_arg)]\n+\n+#[used(linker)]\n+#[no_mangle] // accidentally detected as `used(compiler)`\n+pub static GLOB: usize = 0;\n+\n+fn main() {}"}]}