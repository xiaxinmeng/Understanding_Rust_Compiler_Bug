{"sha": "31d9aee68499cba8d1a5332b841eca5c67991001", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMxZDlhZWU2ODQ5OWNiYThkMWE1MzMyYjg0MWVjYTVjNjc5OTEwMDE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-06-22T00:11:00Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-06-22T00:11:00Z"}, "message": "Auto merge of #26394 - arielb1:implement-rfc401-part2, r=nrc\n\nThis makes them compliant with the new version of RFC 401 (i.e.\r\n    RFC 1052).\r\n\r\nFixes #26391. I *hope* the tests I have are enough.\r\n\r\nThis is a [breaking-change]\r\n\r\nr? @nrc", "tree": {"sha": "9b31c38f23bf678609022224ca5e2f88f4cb9373", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9b31c38f23bf678609022224ca5e2f88f4cb9373"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/31d9aee68499cba8d1a5332b841eca5c67991001", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/31d9aee68499cba8d1a5332b841eca5c67991001", "html_url": "https://github.com/rust-lang/rust/commit/31d9aee68499cba8d1a5332b841eca5c67991001", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/31d9aee68499cba8d1a5332b841eca5c67991001/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4a788a2003d6ad66b768f520a13f251c6800ab7d", "url": "https://api.github.com/repos/rust-lang/rust/commits/4a788a2003d6ad66b768f520a13f251c6800ab7d", "html_url": "https://github.com/rust-lang/rust/commit/4a788a2003d6ad66b768f520a13f251c6800ab7d"}, {"sha": "51336064b1c640db9bb4e84a6f9b29b2d0a301f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/51336064b1c640db9bb4e84a6f9b29b2d0a301f0", "html_url": "https://github.com/rust-lang/rust/commit/51336064b1c640db9bb4e84a6f9b29b2d0a301f0"}], "stats": {"total": 34, "additions": 25, "deletions": 9}, "files": [{"sha": "c46a033c13f95ca87429763f06fe1ebbbb734c95", "filename": "src/librustc_typeck/check/cast.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/31d9aee68499cba8d1a5332b841eca5c67991001/src%2Flibrustc_typeck%2Fcheck%2Fcast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31d9aee68499cba8d1a5332b841eca5c67991001/src%2Flibrustc_typeck%2Fcheck%2Fcast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fcast.rs?ref=31d9aee68499cba8d1a5332b841eca5c67991001", "patch": "@@ -27,7 +27,12 @@\n //!\n //! where `&.T` and `*T` are references of either mutability,\n //! and where unsize_kind(`T`) is the kind of the unsize info\n-//! in `T` - a vtable or a length (or `()` if `T: Sized`).\n+//! in `T` - the vtable for a trait definition (e.g. `fmt::Display` or\n+//! `Iterator`, not `Iterator<Item=u8>`) or a length (or `()` if `T: Sized`).\n+//!\n+//! Note that lengths are not adjusted when casting raw slices -\n+//! `T: *const [u16] as *const [u8]` creates a slice that only includes\n+//! half of the original memory.\n //!\n //! Casting is not transitive, that is, even if `e as U1 as U2` is a valid\n //! expression, `e as U2` is not necessarily so (in fact it will only be valid if\n@@ -59,7 +64,7 @@ pub struct CastCheck<'tcx> {\n /// fat pointers if their unsize-infos have the same kind.\n #[derive(Copy, Clone, PartialEq, Eq)]\n enum UnsizeKind<'tcx> {\n-    Vtable,\n+    Vtable(ast::DefId),\n     Length,\n     /// The unsize info of this projection\n     OfProjection(&'tcx ty::ProjectionTy<'tcx>),\n@@ -74,7 +79,7 @@ fn unsize_kind<'a,'tcx>(fcx: &FnCtxt<'a, 'tcx>,\n                         -> Option<UnsizeKind<'tcx>> {\n     match t.sty {\n         ty::TySlice(_) | ty::TyStr => Some(UnsizeKind::Length),\n-        ty::TyTrait(_) => Some(UnsizeKind::Vtable),\n+        ty::TyTrait(ref tty) => Some(UnsizeKind::Vtable(tty.principal_def_id())),\n         ty::TyStruct(did, substs) => {\n             match ty::struct_fields(fcx.tcx(), did, substs).pop() {\n                 None => None,"}, {"sha": "29ce8c15143f5ce207407c8487ad3abd7b88cdbe", "filename": "src/test/compile-fail/cast-rfc0401.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/31d9aee68499cba8d1a5332b841eca5c67991001/src%2Ftest%2Fcompile-fail%2Fcast-rfc0401.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31d9aee68499cba8d1a5332b841eca5c67991001/src%2Ftest%2Fcompile-fail%2Fcast-rfc0401.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fcast-rfc0401.rs?ref=31d9aee68499cba8d1a5332b841eca5c67991001", "patch": "@@ -21,6 +21,9 @@ fn illegal_cast_2<U:?Sized>(u: *const U) -> *const str\n trait Foo { fn foo(&self) {} }\n impl<T> Foo for T {}\n \n+trait Bar { fn foo(&self) {} }\n+impl<T> Bar for T {}\n+\n enum E {\n     A, B\n }\n@@ -72,4 +75,7 @@ fn main()\n     // check no error cascade\n     let _ = main.f as *const u32; //~ ERROR attempted access of field\n \n+    let cf: *const Foo = &0;\n+    let _ = cf as *const [u8]; //~ ERROR vtable kinds\n+    let _ = cf as *const Bar; //~ ERROR vtable kinds\n }"}, {"sha": "3a9f24ad4cc7c7bb1bef2788755583bb35d3b303", "filename": "src/test/run-pass/cast-rfc0401-vtable-kinds.rs", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/31d9aee68499cba8d1a5332b841eca5c67991001/src%2Ftest%2Frun-pass%2Fcast-rfc0401-vtable-kinds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31d9aee68499cba8d1a5332b841eca5c67991001/src%2Ftest%2Frun-pass%2Fcast-rfc0401-vtable-kinds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fcast-rfc0401-vtable-kinds.rs?ref=31d9aee68499cba8d1a5332b841eca5c67991001", "patch": "@@ -23,12 +23,11 @@ impl<T> Foo<T> for () {}\n impl Foo<u32> for u32 { fn foo(&self, _: u32) -> u32 { self+43 } }\n impl Bar for () {}\n \n-unsafe fn fool<'a>(t: *const (Foo<u32>+'a)) -> u32 {\n-    let bar : *const Bar = t as *const Bar;\n+unsafe fn round_trip_and_call<'a>(t: *const (Foo<u32>+'a)) -> u32 {\n     let foo_e : *const Foo<u16> = t as *const _;\n     let r_1 = foo_e as *mut Foo<u32>;\n \n-    (&*r_1).foo(0)*(&*(bar as *const Foo<u32>)).foo(0)\n+    (&*r_1).foo(0)\n }\n \n #[repr(C)]\n@@ -43,8 +42,8 @@ fn foo_to_bar<T:?Sized>(u: *const FooS<T>) -> *const BarS<T> {\n fn main() {\n     let x = 4u32;\n     let y : &Foo<u32> = &x;\n-    let fl = unsafe { fool(y as *const Foo<u32>) };\n-    assert_eq!(fl, (43+4)*(43+4));\n+    let fl = unsafe { round_trip_and_call(y as *const Foo<u32>) };\n+    assert_eq!(fl, (43+4));\n \n     let s = FooS([0,1,2]);\n     let u: &FooS<[u32]> = &s;"}, {"sha": "5b6f6ccc627a41f4c245799df9f2fe7763e3fe39", "filename": "src/test/run-pass/cast-rfc0401.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/31d9aee68499cba8d1a5332b841eca5c67991001/src%2Ftest%2Frun-pass%2Fcast-rfc0401.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31d9aee68499cba8d1a5332b841eca5c67991001/src%2Ftest%2Frun-pass%2Fcast-rfc0401.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fcast-rfc0401.rs?ref=31d9aee68499cba8d1a5332b841eca5c67991001", "patch": "@@ -88,7 +88,7 @@ fn main()\n     assert_eq!(u as *const u8, p as *const u8);\n     assert_eq!(u as *const u16, p as *const u16);\n \n-    // ptr-ptr-cast (both vk=Length)\n+    // ptr-ptr-cast (Length vtables)\n     let mut l : [u8; 2] = [0,1];\n     let w: *mut [u16; 2] = &mut l as *mut [u8; 2] as *mut _;\n     let w: *mut [u16] = unsafe {&mut *w};\n@@ -99,6 +99,12 @@ fn main()\n     let l_via_str = unsafe{&*(s as *const [u8])};\n     assert_eq!(&l, l_via_str);\n \n+    // ptr-ptr-cast (Length vtables, check length is preserved)\n+    let l: [[u8; 3]; 2] = [[3, 2, 6], [4, 5, 1]];\n+    let p: *const [[u8; 3]] = &l;\n+    let p: &[[u8; 2]] = unsafe {&*(p as *const [[u8; 2]])};\n+    assert_eq!(p, [[3, 2], [6, 4]]);\n+\n     // enum-cast\n     assert_eq!(Simple::A as u8, 0);\n     assert_eq!(Simple::B as u8, 1);"}]}