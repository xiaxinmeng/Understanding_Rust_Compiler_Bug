{"sha": "a0d6eedfade9250f6c05fccfd8771f1a0fa64aa7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEwZDZlZWRmYWRlOTI1MGY2YzA1ZmNjZmQ4NzcxZjFhMGZhNjRhYTc=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-03-29T00:32:19Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-29T00:32:19Z"}, "message": "Rollup merge of #70235 - dillona:70182-check-before-using-git, r=Mark-Simulacrum\n\nValidate git setup before accessing functionality\n\nCloses #70182", "tree": {"sha": "ec4db3da945900235426741c82e5d1dc2df75de1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ec4db3da945900235426741c82e5d1dc2df75de1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a0d6eedfade9250f6c05fccfd8771f1a0fa64aa7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJef+yTCRBK7hj4Ov3rIwAAdHIIAFCNucKxY1SH+pS6tZjP8gan\nQ1qu+ADwL6d9Cc0vswKF3ndfM+6EscDih/XgajuxgDXhd5BqYZQb6yr2cCSJFrwK\nnSVli5jBPWlEM9RScblwi5Cdt0YiA0+DbDRccSU2uiQjT+XhoZbdlXNeu3nhxx0W\n/TMwwtJPlM+bYXuLN6j/FYo5CMPVnWFAB9wgM6IXssR+D5LMRcQQV1sD509uVEH4\nim2uclv544qSqXaWl3XC99AkuxbLAK4ROD2QbAwq2Olwr9LU6yL92Hgl0dnbgE8z\ni1vmpXA6Knr0YHPO8YrnUWnChPG62Ibd7RUvPYcqDctgTJmELUldCwpUWOPFH/8=\n=8799\n-----END PGP SIGNATURE-----\n", "payload": "tree ec4db3da945900235426741c82e5d1dc2df75de1\nparent d584f5a386c4d06afbe1d7375bfe43c08b19549d\nparent 37c63edfc4462381ee0669b17d593a307a985c52\nauthor Dylan DPC <dylan.dpc@gmail.com> 1585441939 +0100\ncommitter GitHub <noreply@github.com> 1585441939 +0100\n\nRollup merge of #70235 - dillona:70182-check-before-using-git, r=Mark-Simulacrum\n\nValidate git setup before accessing functionality\n\nCloses #70182\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a0d6eedfade9250f6c05fccfd8771f1a0fa64aa7", "html_url": "https://github.com/rust-lang/rust/commit/a0d6eedfade9250f6c05fccfd8771f1a0fa64aa7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a0d6eedfade9250f6c05fccfd8771f1a0fa64aa7/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d584f5a386c4d06afbe1d7375bfe43c08b19549d", "url": "https://api.github.com/repos/rust-lang/rust/commits/d584f5a386c4d06afbe1d7375bfe43c08b19549d", "html_url": "https://github.com/rust-lang/rust/commit/d584f5a386c4d06afbe1d7375bfe43c08b19549d"}, {"sha": "37c63edfc4462381ee0669b17d593a307a985c52", "url": "https://api.github.com/repos/rust-lang/rust/commits/37c63edfc4462381ee0669b17d593a307a985c52", "html_url": "https://github.com/rust-lang/rust/commit/37c63edfc4462381ee0669b17d593a307a985c52"}], "stats": {"total": 54, "additions": 43, "deletions": 11}, "files": [{"sha": "6653c505bf538118cec97bb0b1233b5ef52cc1ca", "filename": "src/bootstrap/format.rs", "status": "modified", "additions": 43, "deletions": 11, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/a0d6eedfade9250f6c05fccfd8771f1a0fa64aa7/src%2Fbootstrap%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0d6eedfade9250f6c05fccfd8771f1a0fa64aa7/src%2Fbootstrap%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fformat.rs?ref=a0d6eedfade9250f6c05fccfd8771f1a0fa64aa7", "patch": "@@ -4,7 +4,7 @@ use crate::Build;\n use build_helper::{output, t};\n use ignore::WalkBuilder;\n use std::path::Path;\n-use std::process::Command;\n+use std::process::{Command, Stdio};\n \n fn rustfmt(src: &Path, rustfmt: &Path, path: &Path, check: bool) {\n     let mut cmd = Command::new(&rustfmt);\n@@ -56,16 +56,48 @@ pub fn format(build: &Build, check: bool) {\n     for ignore in rustfmt_config.ignore {\n         ignore_fmt.add(&format!(\"!{}\", ignore)).expect(&ignore);\n     }\n-    let untracked_paths_output = output(\n-        Command::new(\"git\").arg(\"status\").arg(\"--porcelain\").arg(\"--untracked-files=normal\"),\n-    );\n-    let untracked_paths = untracked_paths_output\n-        .lines()\n-        .filter(|entry| entry.starts_with(\"??\"))\n-        .map(|entry| entry.split(\" \").nth(1).expect(\"every git status entry should list a path\"));\n-    for untracked_path in untracked_paths {\n-        eprintln!(\"skip untracked path {} during rustfmt invocations\", untracked_path);\n-        ignore_fmt.add(&format!(\"!{}\", untracked_path)).expect(&untracked_path);\n+    let git_available = match Command::new(\"git\")\n+        .arg(\"--version\")\n+        .stdout(Stdio::null())\n+        .stderr(Stdio::null())\n+        .status()\n+    {\n+        Ok(status) => status.success(),\n+        Err(_) => false,\n+    };\n+    if git_available {\n+        let in_working_tree = match Command::new(\"git\")\n+            .arg(\"rev-parse\")\n+            .arg(\"--is-inside-work-tree\")\n+            .stdout(Stdio::null())\n+            .stderr(Stdio::null())\n+            .status()\n+        {\n+            Ok(status) => status.success(),\n+            Err(_) => false,\n+        };\n+        if in_working_tree {\n+            let untracked_paths_output = output(\n+                Command::new(\"git\")\n+                    .arg(\"status\")\n+                    .arg(\"--porcelain\")\n+                    .arg(\"--untracked-files=normal\"),\n+            );\n+            let untracked_paths = untracked_paths_output\n+                .lines()\n+                .filter(|entry| entry.starts_with(\"??\"))\n+                .map(|entry| {\n+                    entry.split(\" \").nth(1).expect(\"every git status entry should list a path\")\n+                });\n+            for untracked_path in untracked_paths {\n+                eprintln!(\"skip untracked path {} during rustfmt invocations\", untracked_path);\n+                ignore_fmt.add(&format!(\"!{}\", untracked_path)).expect(&untracked_path);\n+            }\n+        } else {\n+            eprintln!(\"Not in git tree. Skipping git-aware format checks\");\n+        }\n+    } else {\n+        eprintln!(\"Could not find usable git. Skipping git-aware format checks\");\n     }\n     let ignore_fmt = ignore_fmt.build().unwrap();\n "}]}