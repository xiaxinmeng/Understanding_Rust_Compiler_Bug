{"sha": "b3a732a3eab60862068b1006973de5924bcda9e2", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIzYTczMmEzZWFiNjA4NjIwNjhiMTAwNjk3M2RlNTkyNGJjZGE5ZTI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-07-23T19:56:15Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-07-23T19:56:15Z"}, "message": "auto merge of #15928 : brson/rust/dist, r=alexcrichton,alexcrichton\n\nThe first commit reverts a similar fix that only solves the `make install` case. This adds the `--enable-dist-host-only` flag to configure to preserve the old behavior, which the nightly bots rely on. The bots will need to be updated soon after this lands (or they will ~double in size).\r\n\r\nCloses https://github.com/rust-lang/rust/issues/15711", "tree": {"sha": "cca3be76f42bab877da9a21827a81af53a0e6032", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cca3be76f42bab877da9a21827a81af53a0e6032"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b3a732a3eab60862068b1006973de5924bcda9e2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b3a732a3eab60862068b1006973de5924bcda9e2", "html_url": "https://github.com/rust-lang/rust/commit/b3a732a3eab60862068b1006973de5924bcda9e2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b3a732a3eab60862068b1006973de5924bcda9e2/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c080d26d328d6e8bbf4b159b5c5f3cd55c86f621", "url": "https://api.github.com/repos/rust-lang/rust/commits/c080d26d328d6e8bbf4b159b5c5f3cd55c86f621", "html_url": "https://github.com/rust-lang/rust/commit/c080d26d328d6e8bbf4b159b5c5f3cd55c86f621"}, {"sha": "e34e86d151341076556635b9bc233338d3d9898e", "url": "https://api.github.com/repos/rust-lang/rust/commits/e34e86d151341076556635b9bc233338d3d9898e", "html_url": "https://github.com/rust-lang/rust/commit/e34e86d151341076556635b9bc233338d3d9898e"}], "stats": {"total": 55, "additions": 29, "deletions": 26}, "files": [{"sha": "53fb8e25c5ff0282abbae0826200b5ba19cd16ce", "filename": "configure", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b3a732a3eab60862068b1006973de5924bcda9e2/configure", "raw_url": "https://github.com/rust-lang/rust/raw/b3a732a3eab60862068b1006973de5924bcda9e2/configure", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/configure?ref=b3a732a3eab60862068b1006973de5924bcda9e2", "patch": "@@ -422,6 +422,8 @@ opt rpath 0 \"build rpaths into rustc itself\"\n opt nightly 0 \"build nightly packages\"\n opt verify-install 1 \"verify installed binaries work\"\n opt jemalloc 1 \"build liballoc with jemalloc\"\n+# This is used by the automation to produce single-target nightlies\n+opt dist-host-only 0 \"only install bins for the host architecture\"\n valopt prefix \"/usr/local\" \"set installation prefix\"\n valopt local-rust-root \"/usr/local\" \"set prefix for local rust binary\"\n valopt llvm-root \"\" \"set LLVM root\""}, {"sha": "99fad94bf76ab95911b8581cf07f41e1be1b0662", "filename": "mk/dist.mk", "status": "modified", "additions": 25, "deletions": 24, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/b3a732a3eab60862068b1006973de5924bcda9e2/mk%2Fdist.mk", "raw_url": "https://github.com/rust-lang/rust/raw/b3a732a3eab60862068b1006973de5924bcda9e2/mk%2Fdist.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fdist.mk?ref=b3a732a3eab60862068b1006973de5924bcda9e2", "patch": "@@ -156,7 +156,7 @@ define DEF_OSX_PKG\n $$(eval $$(call DEF_PREPARE,osx-$(1)))\n \n dist-prepare-osx-$(1): PREPARE_HOST=$(1)\n-dist-prepare-osx-$(1): PREPARE_TARGETS=$(1)\n+dist-prepare-osx-$(1): PREPARE_TARGETS=$(2)\n dist-prepare-osx-$(1): PREPARE_DEST_DIR=tmp/dist/pkgroot-$(1)\n dist-prepare-osx-$(1): PREPARE_DIR_CMD=$(DEFAULT_PREPARE_DIR_CMD)\n dist-prepare-osx-$(1): PREPARE_BIN_CMD=$(DEFAULT_PREPARE_BIN_CMD)\n@@ -187,7 +187,11 @@ tmp/dist/pkgres-$(1)/%: $(S)src/etc/pkg/%\n \n endef\n \n-$(foreach host,$(CFG_HOST),$(eval $(call DEF_OSX_PKG,$(host))))\n+ifneq ($(CFG_ENABLE_DIST_HOST_ONLY),)\n+$(foreach host,$(CFG_HOST),$(eval $(call DEF_OSX_PKG,$(host),$(host))))\n+else\n+$(foreach host,$(CFG_HOST),$(eval $(call DEF_OSX_PKG,$(host),$(TARGET))))\n+endif\n \n dist-osx: $(foreach host,$(CFG_HOST),dist/$(PKG_NAME)-$(host).pkg)\n \n@@ -205,17 +209,19 @@ distcheck-osx: dist-osx\n # Unix binary installer tarballs\n ######################################################################\n \n-define DEF_PREPARE_DIST_DIR\n-\n-dist-install-dir-$(1)$(3): PREPARE_HOST=$(1)\n-dist-install-dir-$(1)$(3): PREPARE_TARGETS=$(2)\n-dist-install-dir-$(1)$(3): PREPARE_DEST_DIR=tmp/dist/$$(PKG_NAME)-$(1)\n-dist-install-dir-$(1)$(3): PREPARE_DIR_CMD=$(DEFAULT_PREPARE_DIR_CMD)\n-dist-install-dir-$(1)$(3): PREPARE_BIN_CMD=$(DEFAULT_PREPARE_BIN_CMD)\n-dist-install-dir-$(1)$(3): PREPARE_LIB_CMD=$(DEFAULT_PREPARE_LIB_CMD)\n-dist-install-dir-$(1)$(3): PREPARE_MAN_CMD=$(DEFAULT_PREPARE_MAN_CMD)\n-dist-install-dir-$(1)$(3): PREPARE_CLEAN=true\n-dist-install-dir-$(1)$(3): prepare-base-dir-$(1) docs compiler-docs\n+define DEF_INSTALLER\n+\n+$$(eval $$(call DEF_PREPARE,dir-$(1)))\n+\n+dist-install-dir-$(1): PREPARE_HOST=$(1)\n+dist-install-dir-$(1): PREPARE_TARGETS=$(2)\n+dist-install-dir-$(1): PREPARE_DEST_DIR=tmp/dist/$$(PKG_NAME)-$(1)\n+dist-install-dir-$(1): PREPARE_DIR_CMD=$(DEFAULT_PREPARE_DIR_CMD)\n+dist-install-dir-$(1): PREPARE_BIN_CMD=$(DEFAULT_PREPARE_BIN_CMD)\n+dist-install-dir-$(1): PREPARE_LIB_CMD=$(DEFAULT_PREPARE_LIB_CMD)\n+dist-install-dir-$(1): PREPARE_MAN_CMD=$(DEFAULT_PREPARE_MAN_CMD)\n+dist-install-dir-$(1): PREPARE_CLEAN=true\n+dist-install-dir-$(1): prepare-base-dir-$(1) docs compiler-docs\n \t$$(Q)(cd $$(PREPARE_DEST_DIR)/ && find . -type f | sed 's/^\\.\\///') \\\n       > tmp/dist/manifest-$(1).in\n \t$$(Q)mv tmp/dist/manifest-$(1).in $$(PREPARE_DEST_DIR)/$$(CFG_LIBDIR_RELATIVE)/rustlib/manifest.in\n@@ -227,24 +233,19 @@ dist-install-dir-$(1)$(3): prepare-base-dir-$(1) docs compiler-docs\n \t$$(Q)cp -r doc $$(PREPARE_DEST_DIR)\n \t$$(Q)$$(PREPARE_BIN_CMD) $$(S)src/etc/install.sh $$(PREPARE_DEST_DIR)\n \n-endef\n-\n-define DEF_INSTALLER\n-\n-$$(eval $$(call DEF_PREPARE,dir-$(1)))\n-\n-$$(eval $$(call DEF_PREPARE_DIST_DIR,$(1),$(1),))\n-\n-$$(eval $$(call DEF_PREPARE_DIST_DIR,$(1),$(CFG_TARGET),-with-target-libs))\n-\n dist/$$(PKG_NAME)-$(1).tar.gz: dist-install-dir-$(1)\n \t@$(call E, build: $$@)\n \t$$(Q)tar -czf dist/$$(PKG_NAME)-$(1).tar.gz -C tmp/dist $$(PKG_NAME)-$(1)\n \n endef\n \n+ifneq ($(CFG_ENABLE_DIST_HOST_ONLY),)\n+$(foreach host,$(CFG_HOST),\\\n+  $(eval $(call DEF_INSTALLER,$(host),$(host))))\n+else\n $(foreach host,$(CFG_HOST),\\\n-  $(eval $(call DEF_INSTALLER,$(host))))\n+  $(eval $(call DEF_INSTALLER,$(host),$(CFG_TARGET))))\n+endif\n \n dist-install-dirs: $(foreach host,$(CFG_HOST),dist-install-dir-$(host))\n "}, {"sha": "b7dac6a2e921c0683da0d14d1e19d2cf5f3960fd", "filename": "mk/install.mk", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b3a732a3eab60862068b1006973de5924bcda9e2/mk%2Finstall.mk", "raw_url": "https://github.com/rust-lang/rust/raw/b3a732a3eab60862068b1006973de5924bcda9e2/mk%2Finstall.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Finstall.mk?ref=b3a732a3eab60862068b1006973de5924bcda9e2", "patch": "@@ -14,12 +14,12 @@ else\n MAYBE_DISABLE_VERIFY=\n endif\n \n-install: dist-install-dir-$(CFG_BUILD)-with-target-libs | tmp/empty_dir\n+install: dist-install-dir-$(CFG_BUILD) | tmp/empty_dir\n \t$(Q)cd tmp/empty_dir && sh ../../tmp/dist/$(PKG_NAME)-$(CFG_BUILD)/install.sh --prefix=\"$(DESTDIR)$(CFG_PREFIX)\" --libdir=\"$(DESTDIR)$(CFG_LIBDIR)\" --mandir=\"$(DESTDIR)$(CFG_MANDIR)\" \"$(MAYBE_DISABLE_VERIFY)\"\n # Remove tmp files while we can because they may have been created under sudo\n \t$(Q)rm -R tmp/dist\n \n-uninstall: dist-install-dir-$(CFG_BUILD)-with-target-libs | tmp/empty_dir\n+uninstall: dist-install-dir-$(CFG_BUILD) | tmp/empty_dir\n \t$(Q)cd tmp/empty_dir && sh ../../tmp/dist/$(PKG_NAME)-$(CFG_BUILD)/install.sh --uninstall --prefix=\"$(DESTDIR)$(CFG_PREFIX)\" --libdir=\"$(DESTDIR)$(CFG_LIBDIR)\" --mandir=\"$(DESTDIR)$(CFG_MANDIR)\"\n # Remove tmp files while we can because they may have been created under sudo\n \t$(Q)rm -R tmp/dist"}]}