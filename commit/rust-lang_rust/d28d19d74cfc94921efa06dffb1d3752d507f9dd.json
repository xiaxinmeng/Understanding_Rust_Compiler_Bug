{"sha": "d28d19d74cfc94921efa06dffb1d3752d507f9dd", "node_id": "C_kwDOAAsO6NoAKGQyOGQxOWQ3NGNmYzk0OTIxZWZhMDZkZmZiMWQzNzUyZDUwN2Y5ZGQ", "commit": {"author": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2022-02-16T19:59:04Z"}, "committer": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2022-02-18T20:02:28Z"}, "message": "Fix `transmute_undefined_repr` when converting between a fat pointer and a type containing a fat pointer", "tree": {"sha": "4cbd60e74ca3f54014ed4b849bbc85cd73d7f502", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4cbd60e74ca3f54014ed4b849bbc85cd73d7f502"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d28d19d74cfc94921efa06dffb1d3752d507f9dd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d28d19d74cfc94921efa06dffb1d3752d507f9dd", "html_url": "https://github.com/rust-lang/rust/commit/d28d19d74cfc94921efa06dffb1d3752d507f9dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d28d19d74cfc94921efa06dffb1d3752d507f9dd/comments", "author": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7c07022c987a9f90218f70defe48b2ddb0824a84", "url": "https://api.github.com/repos/rust-lang/rust/commits/7c07022c987a9f90218f70defe48b2ddb0824a84", "html_url": "https://github.com/rust-lang/rust/commit/7c07022c987a9f90218f70defe48b2ddb0824a84"}], "stats": {"total": 23, "additions": 21, "deletions": 2}, "files": [{"sha": "b6cc1676b0086ad3ae34f12837f9047e2d613ba7", "filename": "clippy_lints/src/transmute/transmute_undefined_repr.rs", "status": "modified", "additions": 18, "deletions": 2, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/d28d19d74cfc94921efa06dffb1d3752d507f9dd/clippy_lints%2Fsrc%2Ftransmute%2Ftransmute_undefined_repr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d28d19d74cfc94921efa06dffb1d3752d507f9dd/clippy_lints%2Fsrc%2Ftransmute%2Ftransmute_undefined_repr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftransmute%2Ftransmute_undefined_repr.rs?ref=d28d19d74cfc94921efa06dffb1d3752d507f9dd", "patch": "@@ -19,8 +19,16 @@ pub(super) fn check<'tcx>(\n \n     while from_ty != to_ty {\n         match reduce_refs(cx, e.span, from_ty, to_ty) {\n-            ReducedTys::FromFatPtr { unsized_ty, to_ty } => match reduce_ty(cx, to_ty) {\n+            ReducedTys::FromFatPtr {\n+                unsized_ty,\n+                to_ty: to_sub_ty,\n+            } => match reduce_ty(cx, to_sub_ty) {\n                 ReducedTy::IntArray | ReducedTy::TypeErasure => break,\n+                ReducedTy::Ref(to_sub_ty) => {\n+                    from_ty = unsized_ty;\n+                    to_ty = to_sub_ty;\n+                    continue;\n+                },\n                 _ => {\n                     span_lint_and_then(\n                         cx,\n@@ -36,8 +44,16 @@ pub(super) fn check<'tcx>(\n                     return true;\n                 },\n             },\n-            ReducedTys::ToFatPtr { unsized_ty, from_ty } => match reduce_ty(cx, from_ty) {\n+            ReducedTys::ToFatPtr {\n+                unsized_ty,\n+                from_ty: from_sub_ty,\n+            } => match reduce_ty(cx, from_sub_ty) {\n                 ReducedTy::IntArray | ReducedTy::TypeErasure => break,\n+                ReducedTy::Ref(from_sub_ty) => {\n+                    from_ty = from_sub_ty;\n+                    to_ty = unsized_ty;\n+                    continue;\n+                },\n                 _ => {\n                     span_lint_and_then(\n                         cx,"}, {"sha": "b163d6056343d5b34e2e57f520c083a629db24ed", "filename": "tests/ui/transmute_undefined_repr.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d28d19d74cfc94921efa06dffb1d3752d507f9dd/tests%2Fui%2Ftransmute_undefined_repr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d28d19d74cfc94921efa06dffb1d3752d507f9dd/tests%2Fui%2Ftransmute_undefined_repr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftransmute_undefined_repr.rs?ref=d28d19d74cfc94921efa06dffb1d3752d507f9dd", "patch": "@@ -84,5 +84,8 @@ fn main() {\n \n         let _: [usize; 2] = transmute(value::<&[u8]>()); // Ok, transmute to int array\n         let _: &[u8] = transmute(value::<[usize; 2]>()); // Ok, transmute from int array\n+\n+        let _: *const [u8] = transmute(value::<Box<[u8]>>()); // Ok\n+        let _: Box<[u8]> = transmute(value::<*mut [u8]>()); // Ok\n     }\n }"}]}