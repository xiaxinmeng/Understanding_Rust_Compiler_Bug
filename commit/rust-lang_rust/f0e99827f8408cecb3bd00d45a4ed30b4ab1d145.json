{"sha": "f0e99827f8408cecb3bd00d45a4ed30b4ab1d145", "node_id": "C_kwDOAAsO6NoAKGYwZTk5ODI3Zjg0MDhjZWNiM2JkMDBkNDVhNGVkMzBiNGFiMWQxNDU", "commit": {"author": {"name": "Audun Halland", "email": "audun.halland@pm.me", "date": "2021-09-28T22:46:29Z"}, "committer": {"name": "Audun Halland", "email": "audun.halland@pm.me", "date": "2021-09-28T22:46:29Z"}, "message": "Deriving: Include bound generic params for extracted type parameters in where clause", "tree": {"sha": "b3faa332526c7d8ace993a1def3dcbc3a8e16844", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b3faa332526c7d8ace993a1def3dcbc3a8e16844"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f0e99827f8408cecb3bd00d45a4ed30b4ab1d145", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f0e99827f8408cecb3bd00d45a4ed30b4ab1d145", "html_url": "https://github.com/rust-lang/rust/commit/f0e99827f8408cecb3bd00d45a4ed30b4ab1d145", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f0e99827f8408cecb3bd00d45a4ed30b4ab1d145/comments", "author": {"login": "audunhalland", "id": 5767935, "node_id": "MDQ6VXNlcjU3Njc5MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/5767935?v=4", "gravatar_id": "", "url": "https://api.github.com/users/audunhalland", "html_url": "https://github.com/audunhalland", "followers_url": "https://api.github.com/users/audunhalland/followers", "following_url": "https://api.github.com/users/audunhalland/following{/other_user}", "gists_url": "https://api.github.com/users/audunhalland/gists{/gist_id}", "starred_url": "https://api.github.com/users/audunhalland/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/audunhalland/subscriptions", "organizations_url": "https://api.github.com/users/audunhalland/orgs", "repos_url": "https://api.github.com/users/audunhalland/repos", "events_url": "https://api.github.com/users/audunhalland/events{/privacy}", "received_events_url": "https://api.github.com/users/audunhalland/received_events", "type": "User", "site_admin": false}, "committer": {"login": "audunhalland", "id": 5767935, "node_id": "MDQ6VXNlcjU3Njc5MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/5767935?v=4", "gravatar_id": "", "url": "https://api.github.com/users/audunhalland", "html_url": "https://github.com/audunhalland", "followers_url": "https://api.github.com/users/audunhalland/followers", "following_url": "https://api.github.com/users/audunhalland/following{/other_user}", "gists_url": "https://api.github.com/users/audunhalland/gists{/gist_id}", "starred_url": "https://api.github.com/users/audunhalland/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/audunhalland/subscriptions", "organizations_url": "https://api.github.com/users/audunhalland/orgs", "repos_url": "https://api.github.com/users/audunhalland/repos", "events_url": "https://api.github.com/users/audunhalland/events{/privacy}", "received_events_url": "https://api.github.com/users/audunhalland/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8f8092cc32ec171becef8ceacec7dbb06c5d7d7e", "url": "https://api.github.com/repos/rust-lang/rust/commits/8f8092cc32ec171becef8ceacec7dbb06c5d7d7e", "html_url": "https://github.com/rust-lang/rust/commit/8f8092cc32ec171becef8ceacec7dbb06c5d7d7e"}], "stats": {"total": 64, "additions": 54, "deletions": 10}, "files": [{"sha": "cd013107a0151b6c95cabc580d712669032e04ce", "filename": "compiler/rustc_builtin_macros/src/deriving/generic/mod.rs", "status": "modified", "additions": 40, "deletions": 10, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/f0e99827f8408cecb3bd00d45a4ed30b4ab1d145/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fgeneric%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f0e99827f8408cecb3bd00d45a4ed30b4ab1d145/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fgeneric%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fgeneric%2Fmod.rs?ref=f0e99827f8408cecb3bd00d45a4ed30b4ab1d145", "patch": "@@ -332,44 +332,74 @@ pub fn combine_substructure(\n     RefCell::new(f)\n }\n \n+struct TypeParameter {\n+    bound_generic_params: Vec<ast::GenericParam>,\n+    ty: P<ast::Ty>,\n+}\n+\n /// This method helps to extract all the type parameters referenced from a\n /// type. For a type parameter `<T>`, it looks for either a `TyPath` that\n /// is not global and starts with `T`, or a `TyQPath`.\n+/// Also include bound generic params from the input type.\n fn find_type_parameters(\n     ty: &ast::Ty,\n     ty_param_names: &[Symbol],\n     cx: &ExtCtxt<'_>,\n-) -> Vec<P<ast::Ty>> {\n+) -> Vec<TypeParameter> {\n     use rustc_ast::visit;\n \n     struct Visitor<'a, 'b> {\n         cx: &'a ExtCtxt<'b>,\n         ty_param_names: &'a [Symbol],\n-        types: Vec<P<ast::Ty>>,\n+        bound_generic_params_stack: Vec<ast::GenericParam>,\n+        type_params: Vec<TypeParameter>,\n     }\n \n     impl<'a, 'b> visit::Visitor<'a> for Visitor<'a, 'b> {\n         fn visit_ty(&mut self, ty: &'a ast::Ty) {\n             if let ast::TyKind::Path(_, ref path) = ty.kind {\n                 if let Some(segment) = path.segments.first() {\n                     if self.ty_param_names.contains(&segment.ident.name) {\n-                        self.types.push(P(ty.clone()));\n+                        self.type_params.push(TypeParameter {\n+                            bound_generic_params: self.bound_generic_params_stack.clone(),\n+                            ty: P(ty.clone()),\n+                        });\n                     }\n                 }\n             }\n \n             visit::walk_ty(self, ty)\n         }\n \n+        // Place bound generic params on a stack, to extract them when a type is encountered.\n+        fn visit_poly_trait_ref(\n+            &mut self,\n+            trait_ref: &'a ast::PolyTraitRef,\n+            modifier: &'a ast::TraitBoundModifier,\n+        ) {\n+            let stack_len = trait_ref.bound_generic_params.len();\n+            self.bound_generic_params_stack\n+                .extend(trait_ref.bound_generic_params.clone().into_iter());\n+\n+            visit::walk_poly_trait_ref(self, trait_ref, modifier);\n+\n+            self.bound_generic_params_stack.truncate(stack_len);\n+        }\n+\n         fn visit_mac_call(&mut self, mac: &ast::MacCall) {\n             self.cx.span_err(mac.span(), \"`derive` cannot be used on items with type macros\");\n         }\n     }\n \n-    let mut visitor = Visitor { cx, ty_param_names, types: Vec::new() };\n+    let mut visitor = Visitor {\n+        cx,\n+        ty_param_names,\n+        bound_generic_params_stack: Vec::new(),\n+        type_params: Vec::new(),\n+    };\n     visit::Visitor::visit_ty(&mut visitor, ty);\n \n-    visitor.types\n+    visitor.type_params\n }\n \n impl<'a> TraitDef<'a> {\n@@ -617,11 +647,11 @@ impl<'a> TraitDef<'a> {\n                     ty_params.map(|ty_param| ty_param.ident.name).collect();\n \n                 for field_ty in field_tys {\n-                    let tys = find_type_parameters(&field_ty, &ty_param_names, cx);\n+                    let field_ty_params = find_type_parameters(&field_ty, &ty_param_names, cx);\n \n-                    for ty in tys {\n+                    for field_ty_param in field_ty_params {\n                         // if we have already handled this type, skip it\n-                        if let ast::TyKind::Path(_, ref p) = ty.kind {\n+                        if let ast::TyKind::Path(_, ref p) = field_ty_param.ty.kind {\n                             if p.segments.len() == 1\n                                 && ty_param_names.contains(&p.segments[0].ident.name)\n                             {\n@@ -639,8 +669,8 @@ impl<'a> TraitDef<'a> {\n \n                         let predicate = ast::WhereBoundPredicate {\n                             span: self.span,\n-                            bound_generic_params: Vec::new(),\n-                            bounded_ty: ty,\n+                            bound_generic_params: field_ty_param.bound_generic_params,\n+                            bounded_ty: field_ty_param.ty,\n                             bounds,\n                         };\n "}, {"sha": "32954914fb7edbeb55cbc01f62ce2ee62e2a37d5", "filename": "src/test/ui/deriving/issue-89188-gat-hrtb.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f0e99827f8408cecb3bd00d45a4ed30b4ab1d145/src%2Ftest%2Fui%2Fderiving%2Fissue-89188-gat-hrtb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f0e99827f8408cecb3bd00d45a4ed30b4ab1d145/src%2Ftest%2Fui%2Fderiving%2Fissue-89188-gat-hrtb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fderiving%2Fissue-89188-gat-hrtb.rs?ref=f0e99827f8408cecb3bd00d45a4ed30b4ab1d145", "patch": "@@ -0,0 +1,14 @@\n+// check-pass\n+\n+#![feature(generic_associated_types)]\n+\n+trait CallWithShim: Sized {\n+    type Shim<'s>\n+    where\n+        Self: 's;\n+}\n+\n+#[derive(Clone)]\n+struct ShimMethod<T: CallWithShim + 'static>(pub &'static dyn for<'s> Fn(&'s mut T::Shim<'s>));\n+\n+pub fn main() {}"}]}