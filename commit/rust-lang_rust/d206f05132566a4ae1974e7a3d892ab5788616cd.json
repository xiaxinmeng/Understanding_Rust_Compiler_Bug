{"sha": "d206f05132566a4ae1974e7a3d892ab5788616cd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQyMDZmMDUxMzI1NjZhNGFlMTk3NGU3YTNkODkyYWI1Nzg4NjE2Y2Q=", "commit": {"author": {"name": "Daniel Micay", "email": "danielmicay@gmail.com", "date": "2014-09-15T20:31:32Z"}, "committer": {"name": "Daniel Micay", "email": "danielmicay@gmail.com", "date": "2014-09-15T22:16:33Z"}, "message": "remove the closure_exchange_malloc lang item", "tree": {"sha": "887ea4a37d4e8bb93420cbf129358b265e2d361d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/887ea4a37d4e8bb93420cbf129358b265e2d361d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d206f05132566a4ae1974e7a3d892ab5788616cd", "comment_count": 6, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d206f05132566a4ae1974e7a3d892ab5788616cd", "html_url": "https://github.com/rust-lang/rust/commit/d206f05132566a4ae1974e7a3d892ab5788616cd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d206f05132566a4ae1974e7a3d892ab5788616cd/comments", "author": {"login": "thestinger", "id": 1505226, "node_id": "MDQ6VXNlcjE1MDUyMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thestinger", "html_url": "https://github.com/thestinger", "followers_url": "https://api.github.com/users/thestinger/followers", "following_url": "https://api.github.com/users/thestinger/following{/other_user}", "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}", "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions", "organizations_url": "https://api.github.com/users/thestinger/orgs", "repos_url": "https://api.github.com/users/thestinger/repos", "events_url": "https://api.github.com/users/thestinger/events{/privacy}", "received_events_url": "https://api.github.com/users/thestinger/received_events", "type": "User", "site_admin": false}, "committer": {"login": "thestinger", "id": 1505226, "node_id": "MDQ6VXNlcjE1MDUyMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thestinger", "html_url": "https://github.com/thestinger", "followers_url": "https://api.github.com/users/thestinger/followers", "following_url": "https://api.github.com/users/thestinger/following{/other_user}", "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}", "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions", "organizations_url": "https://api.github.com/users/thestinger/orgs", "repos_url": "https://api.github.com/users/thestinger/repos", "events_url": "https://api.github.com/users/thestinger/events{/privacy}", "received_events_url": "https://api.github.com/users/thestinger/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "84b37374bf31b463c36f70123e870f52db19c740", "url": "https://api.github.com/repos/rust-lang/rust/commits/84b37374bf31b463c36f70123e870f52db19c740", "html_url": "https://github.com/rust-lang/rust/commit/84b37374bf31b463c36f70123e870f52db19c740"}], "stats": {"total": 53, "additions": 14, "deletions": 39}, "files": [{"sha": "f1780b07271ec93d563c7eeca601229fffcf2b70", "filename": "src/liballoc/heap.rs", "status": "modified", "additions": 1, "deletions": 17, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d206f05132566a4ae1974e7a3d892ab5788616cd/src%2Fliballoc%2Fheap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d206f05132566a4ae1974e7a3d892ab5788616cd/src%2Fliballoc%2Fheap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Fheap.rs?ref=d206f05132566a4ae1974e7a3d892ab5788616cd", "patch": "@@ -10,7 +10,7 @@\n \n // FIXME: #13996: mark the `allocate` and `reallocate` return value as `noalias`\n \n-#[cfg(not(test))] use core::raw;\n+#[cfg(stage0, not(test))] use core::raw;\n #[cfg(stage0, not(test))] use util;\n \n /// Returns a pointer to `size` bytes of memory.\n@@ -111,7 +111,6 @@ unsafe fn exchange_free(ptr: *mut u8, size: uint, align: uint) {\n     deallocate(ptr, size, align);\n }\n \n-// FIXME: #7496\n #[cfg(stage0, not(test))]\n #[lang=\"closure_exchange_malloc\"]\n #[inline]\n@@ -127,21 +126,6 @@ unsafe fn closure_exchange_malloc(drop_glue: fn(*mut u8), size: uint,\n     alloc as *mut u8\n }\n \n-// FIXME: #7496\n-#[cfg(not(stage0), not(test))]\n-#[lang=\"closure_exchange_malloc\"]\n-#[inline]\n-#[allow(deprecated)]\n-unsafe fn closure_exchange_malloc(drop_glue: fn(*mut u8), size: uint,\n-                                  align: uint) -> *mut u8 {\n-    let p = allocate(size, align);\n-\n-    let alloc = p as *mut raw::Box<()>;\n-    (*alloc).drop_glue = drop_glue;\n-\n-    alloc as *mut u8\n-}\n-\n // The minimum alignment guaranteed by the architecture. This value is used to\n // add fast paths for low alignment values. In practice, the alignment is a\n // constant at the call site and the branch will be optimized out."}, {"sha": "507ba3e9d5bf6132f1014718b3d47b8750c309d3", "filename": "src/librustc/middle/lang_items.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d206f05132566a4ae1974e7a3d892ab5788616cd/src%2Flibrustc%2Fmiddle%2Flang_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d206f05132566a4ae1974e7a3d892ab5788616cd/src%2Flibrustc%2Fmiddle%2Flang_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Flang_items.rs?ref=d206f05132566a4ae1974e7a3d892ab5788616cd", "patch": "@@ -265,7 +265,6 @@ lets_do_this! {\n     BeginUnwindLangItem,             \"begin_unwind\",            begin_unwind;\n \n     ExchangeMallocFnLangItem,        \"exchange_malloc\",         exchange_malloc_fn;\n-    ClosureExchangeMallocFnLangItem, \"closure_exchange_malloc\", closure_exchange_malloc_fn;\n     ExchangeFreeFnLangItem,          \"exchange_free\",           exchange_free_fn;\n     MallocFnLangItem,                \"malloc\",                  malloc_fn;\n     FreeFnLangItem,                  \"free\",                    free_fn;"}, {"sha": "5187ecb8b3bc8ca47d0d8f8f137e295a9a2701ff", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 10, "deletions": 17, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/d206f05132566a4ae1974e7a3d892ab5788616cd/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d206f05132566a4ae1974e7a3d892ab5788616cd/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=d206f05132566a4ae1974e7a3d892ab5788616cd", "patch": "@@ -383,14 +383,10 @@ pub fn malloc_raw_dyn<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n     Result::new(r.bcx, PointerCast(r.bcx, r.val, llty_ptr))\n }\n \n-pub fn malloc_raw_dyn_proc<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n-                                       t: ty::t, alloc_fn: LangItem)\n-                                       -> Result<'blk, 'tcx> {\n+pub fn malloc_raw_dyn_proc<'blk, 'tcx>(bcx: Block<'blk, 'tcx>, t: ty::t) -> Result<'blk, 'tcx> {\n     let _icx = push_ctxt(\"malloc_raw_dyn_proc\");\n     let ccx = bcx.ccx();\n \n-    let langcall = require_alloc_fn(bcx, t, alloc_fn);\n-\n     // Grab the TypeRef type of ptr_ty.\n     let ptr_ty = ty::mk_uniq(bcx.tcx(), t);\n     let ptr_llty = type_of(ccx, ptr_ty);\n@@ -399,18 +395,15 @@ pub fn malloc_raw_dyn_proc<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n     let size = llsize_of(bcx.ccx(), llty);\n     let llalign = C_uint(ccx, llalign_of_min(bcx.ccx(), llty) as uint);\n \n-    // Allocate space:\n-    let drop_glue = glue::get_drop_glue(ccx, ty::mk_uniq(bcx.tcx(), t));\n-    let r = callee::trans_lang_call(\n-        bcx,\n-        langcall,\n-        [\n-            PointerCast(bcx, drop_glue, Type::glue_fn(ccx, Type::i8p(ccx)).ptr_to()),\n-            size,\n-            llalign\n-        ],\n-        None);\n-    Result::new(r.bcx, PointerCast(r.bcx, r.val, ptr_llty))\n+    // Allocate space and store the destructor pointer:\n+    let Result {bcx: bcx, val: llbox} = malloc_raw_dyn(bcx, ptr_llty, t, size, llalign);\n+    let dtor_ptr = GEPi(bcx, llbox, [0u, abi::box_field_drop_glue]);\n+    let drop_glue_field_ty = type_of(ccx, ty::mk_nil_ptr(bcx.tcx()));\n+    let drop_glue = PointerCast(bcx, glue::get_drop_glue(ccx, ty::mk_uniq(bcx.tcx(), t)),\n+                                drop_glue_field_ty);\n+    Store(bcx, drop_glue, dtor_ptr);\n+\n+    Result::new(bcx, llbox)\n }\n \n "}, {"sha": "2fac6e80ba085b83b8649b72ec7b4d77a4ec9501", "filename": "src/librustc/middle/trans/closure.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d206f05132566a4ae1974e7a3d892ab5788616cd/src%2Flibrustc%2Fmiddle%2Ftrans%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d206f05132566a4ae1974e7a3d892ab5788616cd/src%2Flibrustc%2Fmiddle%2Ftrans%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fclosure.rs?ref=d206f05132566a4ae1974e7a3d892ab5788616cd", "patch": "@@ -15,7 +15,6 @@ use driver::config::FullDebugInfo;\n use llvm::ValueRef;\n use middle::def;\n use middle::freevars;\n-use middle::lang_items::ClosureExchangeMallocFnLangItem;\n use middle::trans::adt;\n use middle::trans::base::*;\n use middle::trans::build::*;\n@@ -146,7 +145,7 @@ fn allocate_cbox<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n     let cbox_ty = tuplify_box_ty(tcx, cdata_ty);\n     match store {\n         ty::UniqTraitStore => {\n-            malloc_raw_dyn_proc(bcx, cbox_ty, ClosureExchangeMallocFnLangItem)\n+            malloc_raw_dyn_proc(bcx, cbox_ty)\n         }\n         ty::RegionTraitStore(..) => {\n             let llbox = alloc_ty(bcx, cbox_ty, \"__closure\");"}, {"sha": "fa2b192615d878990dfdf1c40ca54ec1085668df", "filename": "src/librustc/middle/trans/glue.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d206f05132566a4ae1974e7a3d892ab5788616cd/src%2Flibrustc%2Fmiddle%2Ftrans%2Fglue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d206f05132566a4ae1974e7a3d892ab5788616cd/src%2Flibrustc%2Fmiddle%2Ftrans%2Fglue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fglue.rs?ref=d206f05132566a4ae1974e7a3d892ab5788616cd", "patch": "@@ -519,7 +519,7 @@ fn make_drop_glue<'blk, 'tcx>(bcx: Block<'blk, 'tcx>, v0: ValueRef, t: ty::t)\n             let env_ptr_ty = Type::at_box(bcx.ccx(), Type::i8(bcx.ccx())).ptr_to();\n             let env = PointerCast(bcx, env, env_ptr_ty);\n             with_cond(bcx, IsNotNull(bcx, env), |bcx| {\n-                let dtor_ptr = GEPi(bcx, env, [0u, abi::box_field_tydesc]);\n+                let dtor_ptr = GEPi(bcx, env, [0u, abi::box_field_drop_glue]);\n                 let dtor = Load(bcx, dtor_ptr);\n                 Call(bcx, dtor, [PointerCast(bcx, box_cell_v, Type::i8p(bcx.ccx()))], None);\n                 bcx"}, {"sha": "72acba542460cc94280db8c246f5ddcf3ac75c69", "filename": "src/librustc_back/abi.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d206f05132566a4ae1974e7a3d892ab5788616cd/src%2Flibrustc_back%2Fabi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d206f05132566a4ae1974e7a3d892ab5788616cd/src%2Flibrustc_back%2Fabi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_back%2Fabi.rs?ref=d206f05132566a4ae1974e7a3d892ab5788616cd", "patch": "@@ -9,7 +9,7 @@\n // except according to those terms.\n \n pub static box_field_refcnt: uint = 0u;\n-pub static box_field_tydesc: uint = 1u;\n+pub static box_field_drop_glue: uint = 1u;\n pub static box_field_body: uint = 4u;\n \n pub static tydesc_field_visit_glue: uint = 3u;"}]}