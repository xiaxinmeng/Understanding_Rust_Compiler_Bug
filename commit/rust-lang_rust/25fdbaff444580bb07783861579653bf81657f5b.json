{"sha": "25fdbaff444580bb07783861579653bf81657f5b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI1ZmRiYWZmNDQ0NTgwYmIwNzc4Mzg2MTU3OTY1M2JmODE2NTdmNWI=", "commit": {"author": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2020-10-04T17:39:12Z"}, "committer": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2020-10-04T17:41:08Z"}, "message": "Discuss cleanup blocks and `span_bug` on `Abort`", "tree": {"sha": "05c8dbc273808c6ff092fc681fc808f405e616a4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/05c8dbc273808c6ff092fc681fc808f405e616a4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/25fdbaff444580bb07783861579653bf81657f5b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/25fdbaff444580bb07783861579653bf81657f5b", "html_url": "https://github.com/rust-lang/rust/commit/25fdbaff444580bb07783861579653bf81657f5b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/25fdbaff444580bb07783861579653bf81657f5b/comments", "author": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "14c3705c6cfc5f88ba64e00129c99cc1f8a41490", "url": "https://api.github.com/repos/rust-lang/rust/commits/14c3705c6cfc5f88ba64e00129c99cc1f8a41490", "html_url": "https://github.com/rust-lang/rust/commit/14c3705c6cfc5f88ba64e00129c99cc1f8a41490"}], "stats": {"total": 17, "additions": 11, "deletions": 6}, "files": [{"sha": "cb9feba260f602aef18ce3f0b5120237e9c93792", "filename": "compiler/rustc_mir/src/transform/check_consts/validation.rs", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/25fdbaff444580bb07783861579653bf81657f5b/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fvalidation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25fdbaff444580bb07783861579653bf81657f5b/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fvalidation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fvalidation.rs?ref=25fdbaff444580bb07783861579653bf81657f5b", "patch": "@@ -434,11 +434,13 @@ impl Visitor<'tcx> for Validator<'mir, 'tcx> {\n     fn visit_basic_block_data(&mut self, bb: BasicBlock, block: &BasicBlockData<'tcx>) {\n         trace!(\"visit_basic_block_data: bb={:?} is_cleanup={:?}\", bb, block.is_cleanup);\n \n-        // Just as the old checker did, we skip const-checking basic blocks on the unwind path.\n-        // These blocks often drop locals that would otherwise be returned from the function.\n+        // We don't const-check basic blocks on the cleanup path since we never unwind during\n+        // const-eval: a panic causes an immediate compile error. In other words, cleanup blocks\n+        // are unreachable during const-eval.\n         //\n-        // FIXME: This shouldn't be unsound since a panic at compile time will cause a compiler\n-        // error anyway, but maybe we should do more here?\n+        // We can't be more conservative (e.g., by const-checking cleanup blocks anyways) because\n+        // locals that would never be dropped during normal execution are sometimes dropped during\n+        // unwinding, which means backwards-incompatible live-drop errors.\n         if block.is_cleanup {\n             return;\n         }\n@@ -879,8 +881,11 @@ impl Visitor<'tcx> for Validator<'mir, 'tcx> {\n                 self.check_op(ops::Generator(hir::GeneratorKind::Gen))\n             }\n \n-            TerminatorKind::Abort\n-            | TerminatorKind::Assert { .. }\n+            TerminatorKind::Abort => {\n+                span_bug!(self.span, \"`Abort` terminator outside of cleanup block\")\n+            }\n+\n+            TerminatorKind::Assert { .. }\n             | TerminatorKind::FalseEdge { .. }\n             | TerminatorKind::FalseUnwind { .. }\n             | TerminatorKind::Goto { .. }"}]}