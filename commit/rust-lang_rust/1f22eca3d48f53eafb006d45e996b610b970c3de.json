{"sha": "1f22eca3d48f53eafb006d45e996b610b970c3de", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFmMjJlY2EzZDQ4ZjUzZWFmYjAwNmQ0NWU5OTZiNjEwYjk3MGMzZGU=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-12-22T13:12:22Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-12-22T13:12:22Z"}, "message": "Merge #6989\n\n6989: Build aarch64-apple-darwin binaries on CI r=matklad a=lnicola\n\nThis splits the `dist` matrix job into four and tries to make `xtask dist` more principled about target and artifact naming.\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>", "tree": {"sha": "3bd9d10a0add723846b77f6587a81f6a46ef3b75", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3bd9d10a0add723846b77f6587a81f6a46ef3b75"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1f22eca3d48f53eafb006d45e996b610b970c3de", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJf4fC2CRBK7hj4Ov3rIwAAdHIIACjxRsXByzcRTM1beebON961\nHPbWub4uUY5iuaMdTRsIw9+XaL/mClHQ+HAYVeovkZK2xweCI/kJ7usxOpB8UKED\nAVVCs0DYHM9C0kj84x0imUAfnVhf7A6aRNn9waWOBlABTQjO2TbZZaIs4jUspx2s\nxR5olLaGhuslbWfucVnayKGTd07vK3M0pDgM7cslrilrAsdUjtZYlFPgptXVpw9S\nQtesnCVnYEQiLf+tGaP6GsjWO9piCwr8HeYazl6c6H2vdSHawIWN5r1DllQV6WRi\nftNIgFnpuXDovgZKPcrojjR5+TGuU59kV1pJrZs4qtxYgbn7wSPIowS3kjrfdRY=\n=wN5V\n-----END PGP SIGNATURE-----\n", "payload": "tree 3bd9d10a0add723846b77f6587a81f6a46ef3b75\nparent b98ee075ee8baa6dc4284f04df4c7012baccda28\nparent e8818151153720898867c50699e0e781d88b2a34\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1608642742 +0000\ncommitter GitHub <noreply@github.com> 1608642742 +0000\n\nMerge #6989\n\n6989: Build aarch64-apple-darwin binaries on CI r=matklad a=lnicola\n\nThis splits the `dist` matrix job into four and tries to make `xtask dist` more principled about target and artifact naming.\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1f22eca3d48f53eafb006d45e996b610b970c3de", "html_url": "https://github.com/rust-lang/rust/commit/1f22eca3d48f53eafb006d45e996b610b970c3de", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1f22eca3d48f53eafb006d45e996b610b970c3de/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b98ee075ee8baa6dc4284f04df4c7012baccda28", "url": "https://api.github.com/repos/rust-lang/rust/commits/b98ee075ee8baa6dc4284f04df4c7012baccda28", "html_url": "https://github.com/rust-lang/rust/commit/b98ee075ee8baa6dc4284f04df4c7012baccda28"}, {"sha": "e8818151153720898867c50699e0e781d88b2a34", "url": "https://api.github.com/repos/rust-lang/rust/commits/e8818151153720898867c50699e0e781d88b2a34", "html_url": "https://github.com/rust-lang/rust/commit/e8818151153720898867c50699e0e781d88b2a34"}], "stats": {"total": 186, "additions": 154, "deletions": 32}, "files": [{"sha": "09752b817f0b3a5a402126cf03779d8679228ff7", "filename": ".github/workflows/release.yaml", "status": "modified", "additions": 96, "deletions": 18, "changes": 114, "blob_url": "https://github.com/rust-lang/rust/blob/1f22eca3d48f53eafb006d45e996b610b970c3de/.github%2Fworkflows%2Frelease.yaml", "raw_url": "https://github.com/rust-lang/rust/raw/1f22eca3d48f53eafb006d45e996b610b970c3de/.github%2Fworkflows%2Frelease.yaml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Frelease.yaml?ref=1f22eca3d48f53eafb006d45e996b610b970c3de", "patch": "@@ -15,12 +15,9 @@ env:\n   RUSTUP_MAX_RETRIES: 10\n \n jobs:\n-  dist:\n-    name: dist\n-    runs-on: ${{ matrix.os }}\n-    strategy:\n-      matrix:\n-        os: [ubuntu-16.04, windows-latest, macos-latest]\n+  dist-windows:\n+    name: dist (Windows)\n+    runs-on: windows-latest\n \n     steps:\n     - name: Checkout repository\n@@ -30,8 +27,7 @@ jobs:\n     # which takes a long time. The fastest way to do this is to rename the\n     # existing folder, as deleting it takes about as much time as not doing\n     # anything and just updating rust-docs.\n-    - name: Rename existing rust toolchain (Windows)\n-      if: matrix.os == 'windows-latest'\n+    - name: Rename existing rust toolchain\n       run: Rename-Item C:\\Users\\runneradmin\\.rustup\\toolchains\\stable-x86_64-pc-windows-msvc C:\\Users\\runneradmin\\.rustup\\toolchains\\stable-x86_64-pc-windows-msvc.old\n \n     - name: Install Rust toolchain\n@@ -41,38 +37,116 @@ jobs:\n         profile: minimal\n         override: true\n \n+    - name: Dist\n+      run: cargo xtask dist\n+      env:\n+        RA_TARGET: x86_64-pc-windows-msvc\n+\n+    - name: Upload artifacts\n+      uses: actions/upload-artifact@v1\n+      with:\n+        name: dist-windows-latest\n+        path: ./dist\n+\n+  dist-ubuntu:\n+    name: dist (Ubuntu 16.04)\n+    runs-on: ubuntu-16.04\n+\n+    steps:\n+    - name: Checkout repository\n+      uses: actions/checkout@v2\n+\n+    - name: Install Rust toolchain\n+      uses: actions-rs/toolchain@v1\n+      with:\n+        toolchain: stable\n+        profile: minimal\n+        override: true\n+\n     - name: Install Nodejs\n-      if: matrix.os == 'ubuntu-16.04'\n       uses: actions/setup-node@v1\n       with:\n         node-version: 12.x\n \n     - name: Dist\n-      if: matrix.os == 'ubuntu-16.04' && github.ref == 'refs/heads/release'\n+      if: github.ref == 'refs/heads/release'\n       run: cargo xtask dist --client 0.2.$GITHUB_RUN_NUMBER\n+      env:\n+        RA_TARGET: x86_64-unknown-linux-gnu\n \n     - name: Dist\n-      if: matrix.os == 'ubuntu-16.04' && github.ref != 'refs/heads/release'\n+      if: github.ref != 'refs/heads/release'\n       run: cargo xtask dist --nightly --client 0.3.$GITHUB_RUN_NUMBER-nightly\n+      env:\n+        RA_TARGET: x86_64-unknown-linux-gnu\n+\n+    - name: Nightly analysis-stats check\n+      if: github.ref != 'refs/heads/release'\n+      run: ./dist/rust-analyzer-x86_64-unknown-linux-gnu analysis-stats .\n+\n+    - name: Upload artifacts\n+      uses: actions/upload-artifact@v1\n+      with:\n+        name: dist-ubuntu-16.04\n+        path: ./dist\n+\n+  dist-macos-latest:\n+    name: dist (MacOS latest)\n+    runs-on: macos-latest\n+\n+    steps:\n+    - name: Checkout repository\n+      uses: actions/checkout@v2\n+\n+    - name: Install Rust toolchain\n+      uses: actions-rs/toolchain@v1\n+      with:\n+        toolchain: stable\n+        profile: minimal\n+        override: true\n \n     - name: Dist\n-      if: matrix.os != 'ubuntu-16.04'\n       run: cargo xtask dist\n+      env:\n+        RA_TARGET: x86_64-apple-darwin\n \n-    - name: Nightly analysis-stats check\n-      if: matrix.os == 'ubuntu-16.04' && github.ref != 'refs/heads/release'\n-      run: ./dist/rust-analyzer-linux analysis-stats .\n+    - name: Upload artifacts\n+      uses: actions/upload-artifact@v1\n+      with:\n+        name: dist-macos-latest\n+        path: ./dist\n+\n+  dist-macos-11:\n+    name: dist (MacOS 11.0)\n+    runs-on: macos-11.0\n+\n+    steps:\n+    - name: Checkout repository\n+      uses: actions/checkout@v2\n+\n+    - name: Install Rust toolchain (beta)\n+      uses: actions-rs/toolchain@v1\n+      with:\n+        toolchain: beta\n+        target: aarch64-apple-darwin\n+        profile: minimal\n+        override: true\n+\n+    - name: Dist\n+      run: cargo xtask dist\n+      env:\n+        RA_TARGET: aarch64-apple-darwin\n \n     - name: Upload artifacts\n       uses: actions/upload-artifact@v1\n       with:\n-        name: dist-${{ matrix.os }}\n+        name: dist-macos-11.0\n         path: ./dist\n \n   publish:\n     name: publish\n     runs-on: ubuntu-16.04\n-    needs: ['dist']\n+    needs: ['dist-windows', 'dist-ubuntu', 'dist-macos-latest', 'dist-macos-11']\n     steps:\n     - name: Install Nodejs\n       uses: actions/setup-node@v1\n@@ -91,6 +165,10 @@ jobs:\n     - run: echo \"HEAD_SHA=$(git rev-parse HEAD)\" >> $GITHUB_ENV\n     - run: 'echo \"HEAD_SHA: $HEAD_SHA\"'\n \n+    - uses: actions/download-artifact@v1\n+      with:\n+        name: dist-macos-11.0\n+        path: dist\n     - uses: actions/download-artifact@v1\n       with:\n         name: dist-macos-latest\n@@ -103,7 +181,7 @@ jobs:\n       with:\n         name: dist-windows-latest\n         path: dist\n-    - run: ls -all ./dist\n+    - run: ls -al ./dist\n \n     - name: Publish Release\n       uses: ./.github/actions/github-release"}, {"sha": "d07ad94204cfe0858dae2537077e67afccb41bf5", "filename": "xtask/src/dist.rs", "status": "modified", "additions": 58, "deletions": 14, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/1f22eca3d48f53eafb006d45e996b610b970c3de/xtask%2Fsrc%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f22eca3d48f53eafb006d45e996b610b970c3de/xtask%2Fsrc%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fdist.rs?ref=1f22eca3d48f53eafb006d45e996b610b970c3de", "patch": "@@ -58,30 +58,74 @@ fn dist_client(version: &str, release_tag: &str) -> Result<()> {\n }\n \n fn dist_server() -> Result<()> {\n-    if cfg!(target_os = \"linux\") {\n+    let target = get_target();\n+    if target.contains(\"-linux-gnu\") {\n         env::set_var(\"CC\", \"clang\");\n     }\n-    cmd!(\"cargo build --manifest-path ./crates/rust-analyzer/Cargo.toml --bin rust-analyzer --release\").run()?;\n-\n-    let (src, dst) = if cfg!(target_os = \"linux\") {\n-        (\"./target/release/rust-analyzer\", \"./dist/rust-analyzer-linux\")\n-    } else if cfg!(target_os = \"windows\") {\n-        (\"./target/release/rust-analyzer.exe\", \"./dist/rust-analyzer-windows.exe\")\n-    } else if cfg!(target_os = \"macos\") {\n-        (\"./target/release/rust-analyzer\", \"./dist/rust-analyzer-mac\")\n-    } else {\n-        panic!(\"Unsupported OS\")\n-    };\n \n-    let src = Path::new(src);\n-    let dst = Path::new(dst);\n+    let toolchain = toolchain(&target);\n+    cmd!(\"cargo +{toolchain} build --manifest-path ./crates/rust-analyzer/Cargo.toml --bin rust-analyzer --target {target} --release\").run()?;\n \n+    let suffix = exe_suffix(&target);\n+    let src =\n+        Path::new(\"target\").join(&target).join(\"release\").join(format!(\"rust-analyzer{}\", suffix));\n+    let dst = Path::new(\"dist\").join(format!(\"rust-analyzer-{}{}\", target, suffix));\n     cp(&src, &dst)?;\n     gzip(&src, &dst.with_extension(\"gz\"))?;\n \n+    // FIXME: the old names are temporarily kept for client compatibility, but they should be removed\n+    // Remove this block after a couple of releases\n+    match target.as_ref() {\n+        \"x86_64-unknown-linux-gnu\" => {\n+            cp(&src, \"dist/rust-analyzer-linux\")?;\n+            gzip(&src, Path::new(\"dist/rust-analyzer-linux.gz\"))?;\n+        }\n+        \"x86_64-pc-windows-msvc\" => {\n+            cp(&src, \"dist/rust-analyzer-windows.exe\")?;\n+            gzip(&src, Path::new(\"dist/rust-analyzer-windows.gz\"))?;\n+        }\n+        \"x86_64-apple-darwin\" => {\n+            cp(&src, \"dist/rust-analyzer-mac\")?;\n+            gzip(&src, Path::new(\"dist/rust-analyzer-mac.gz\"))?;\n+        }\n+        _ => {}\n+    }\n+\n     Ok(())\n }\n \n+fn get_target() -> String {\n+    match env::var(\"RA_TARGET\") {\n+        Ok(target) => target,\n+        _ => {\n+            if cfg!(target_os = \"linux\") {\n+                \"x86_64-unknown-linux-gnu\".to_string()\n+            } else if cfg!(target_os = \"windows\") {\n+                \"x86_64-pc-windows-msvc\".to_string()\n+            } else if cfg!(target_os = \"macos\") {\n+                \"x86_64-apple-darwin\".to_string()\n+            } else {\n+                panic!(\"Unsupported OS, maybe try setting RA_TARGET\")\n+            }\n+        }\n+    }\n+}\n+\n+fn exe_suffix(target: &str) -> String {\n+    if target.contains(\"-windows-\") {\n+        \".exe\".into()\n+    } else {\n+        \"\".into()\n+    }\n+}\n+\n+fn toolchain(target: &str) -> String {\n+    match target {\n+        \"aarch64-apple-darwin\" => \"beta\".to_string(),\n+        _ => \"stable\".to_string(),\n+    }\n+}\n+\n fn gzip(src_path: &Path, dest_path: &Path) -> Result<()> {\n     let mut encoder = GzEncoder::new(File::create(dest_path)?, Compression::best());\n     let mut input = io::BufReader::new(File::open(src_path)?);"}]}