{"sha": "a2434eb950bee72f8c7e5186fad657852cbf14bf", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEyNDM0ZWI5NTBiZWU3MmY4YzdlNTE4NmZhZDY1Nzg1MmNiZjE0YmY=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-05-23T20:45:26Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-05-24T05:21:21Z"}, "message": "mk: Fix bootstrapping cross-hosts on beta\n\nThe beta builds are currently failing, unfortunately, due to what is presumably\nsome odd behavior with our makefiles. The wrong bootstrap key is being used to\ngenerate the stage1 cross-compiled libraries, which fails the build.\nInterestingly enough if the targets are directly specified as part of the build\nthen it works just fine! Just a bare `make` fails...\n\nInstead of trying to understand what's happening in the makefiles instead just\ntweak how we configure the bootstrap key in a way that's more likely to work.", "tree": {"sha": "cc9adef38fc69396979ebf4bc955f935c62982cb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cc9adef38fc69396979ebf4bc955f935c62982cb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a2434eb950bee72f8c7e5186fad657852cbf14bf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a2434eb950bee72f8c7e5186fad657852cbf14bf", "html_url": "https://github.com/rust-lang/rust/commit/a2434eb950bee72f8c7e5186fad657852cbf14bf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a2434eb950bee72f8c7e5186fad657852cbf14bf/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "57ef015132ec09345b88d2ec20a9d9809b5d3dfc", "url": "https://api.github.com/repos/rust-lang/rust/commits/57ef015132ec09345b88d2ec20a9d9809b5d3dfc", "html_url": "https://github.com/rust-lang/rust/commit/57ef015132ec09345b88d2ec20a9d9809b5d3dfc"}], "stats": {"total": 29, "additions": 20, "deletions": 9}, "files": [{"sha": "2a08b7b0465343e39ed0dd753bdbc7a1cde02b07", "filename": "mk/target.mk", "status": "modified", "additions": 20, "deletions": 9, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/a2434eb950bee72f8c7e5186fad657852cbf14bf/mk%2Ftarget.mk", "raw_url": "https://github.com/rust-lang/rust/raw/a2434eb950bee72f8c7e5186fad657852cbf14bf/mk%2Ftarget.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Ftarget.mk?ref=a2434eb950bee72f8c7e5186fad657852cbf14bf", "patch": "@@ -42,6 +42,23 @@ $(foreach host,$(CFG_HOST), \\\n    $(foreach crate,$(CRATES), \\\n     $(eval $(call RUST_CRATE_FULLDEPS,$(stage),$(target),$(host),$(crate)))))))\n \n+# $(1) stage\n+# $(2) target\n+# $(3) host\n+define DEFINE_BOOTSTRAP_KEY\n+BOOTSTRAP_KEY$(1)_T_$(2)_H_$(3) := $$(CFG_BOOTSTRAP_KEY)\n+ifeq ($(1),0)\n+ifeq ($(3),$$(CFG_BUILD))\n+BOOTSTRAP_KEY$(1)_T_$(2)_H_$(3) := $$(CFG_BOOTSTRAP_KEY_STAGE0)\n+endif\n+endif\n+endef\n+\n+$(foreach host,$(CFG_TARGET), \\\n+ $(foreach target,$(CFG_TARGET), \\\n+  $(foreach stage,$(STAGES), \\\n+   $(eval $(call DEFINE_BOOTSTRAP_KEY,$(stage),$(target),$(host))))))\n+\n # RUST_TARGET_STAGE_N template: This defines how target artifacts are built\n # for all stage/target architecture combinations. This is one giant rule which\n # works as follows:\n@@ -65,12 +82,9 @@ $(foreach host,$(CFG_HOST), \\\n # $(4) is the crate name\n define RUST_TARGET_STAGE_N\n \n-ifeq ($(1),0)\n-$$(TLIB$(1)_T_$(2)_H_$(3))/stamp.$(4): \\\n-\texport RUSTC_BOOTSTRAP_KEY := $$(CFG_BOOTSTRAP_KEY_STAGE0)\n-endif\n-\n $$(TLIB$(1)_T_$(2)_H_$(3))/stamp.$(4): CFG_COMPILER_HOST_TRIPLE = $(2)\n+$$(TLIB$(1)_T_$(2)_H_$(3))/stamp.$(4): \\\n+\texport RUSTC_BOOTSTRAP_KEY := $$(BOOTSTRAP_KEY$(1)_T_$(2)_H_$(3))\n $$(TLIB$(1)_T_$(2)_H_$(3))/stamp.$(4): \\\n \t\t$$(CRATEFILE_$(4)) \\\n \t\t$$(CRATE_FULLDEPS_$(1)_T_$(2)_H_$(3)_$(4)) \\\n@@ -118,11 +132,8 @@ endef\n # $(4) - name of the tool being built\n define TARGET_TOOL\n \n-ifeq ($(1),0)\n $$(TBIN$(1)_T_$(2)_H_$(3))/$(4)$$(X_$(2)): \\\n-\texport RUSTC_BOOTSTRAP_KEY := $$(CFG_BOOTSTRAP_KEY_STAGE0)\n-endif\n-\n+\texport RUSTC_BOOTSTRAP_KEY := $$(BOOTSTRAP_KEY$(1)_T_$(2)_H_$(3))\n $$(TBIN$(1)_T_$(2)_H_$(3))/$(4)$$(X_$(2)): \\\n \t\t$$(TOOL_SOURCE_$(4)) \\\n \t\t$$(TOOL_INPUTS_$(4)) \\"}]}