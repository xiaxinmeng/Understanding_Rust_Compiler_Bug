{"sha": "c122ac3e6991544d2d28fbee3ffcf20a1dd4b514", "node_id": "C_kwDOAAsO6NoAKGMxMjJhYzNlNjk5MTU0NGQyZDI4ZmJlZTNmZmNmMjBhMWRkNGI1MTQ", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2023-05-08T10:41:50Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-05-08T10:41:50Z"}, "message": "Rollup merge of #111331 - taiki-e:s390x-asm-cc, r=Amanieu\n\nMark s390x condition code register as clobbered in inline assembly\n\nVarious s390x instructions (arithmetic operations, logical operations, comparisons, etc. see also \"Condition Codes\" section in [z/Architecture Reference Summary](https://www.ibm.com/support/pages/zarchitecture-reference-summary)) modify condition code register `cc`, but AFAIK there is currently no way to mark it as clobbered in `asm!`.\n\n`cc` register definition in LLVM:\nhttps://github.com/llvm/llvm-project/blob/main/llvm/lib/Target/SystemZ/SystemZRegisterInfo.td#L320\n\nThis PR also updates asm_experimental_arch docs in the unstable-book to mention s390x registers.\n\ncc `@uweigand`\n\nr? `@Amanieu`", "tree": {"sha": "7ee62039f69279432555044d6facf1931877a3c2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7ee62039f69279432555044d6facf1931877a3c2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c122ac3e6991544d2d28fbee3ffcf20a1dd4b514", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkWNHuCRBK7hj4Ov3rIwAAK4MIAEqOfvZ0ZKq2n2Af5ju0ujt0\nEewSDnrOsT85+c7qzhtOsi3HLzhPmZBd/Fryq0E3puQmxbJIW1qUI1X2tlZsAtCI\nSGIr1Sw4LPtShMwB6JFVHl0e6UrET+H0FSPa7jqi653QGzCKruYdiQzBCukHRHQP\n9e9oHg9mgJoCgYv5udinQwnfAZKEl4/9jd1EUdqqdt2y24y7xg6XD/gnp66kLWdu\nVFYyBKDwSxIKZeYEtLIdYOFO3fWsaOcCEOJcFoELOeA/M+/sHo5WI7uwHi/uKZU6\nTqUS6uYboOdF4nGiYoTjDRmSQwQJzuq7QFFVKFP1gbuOW3ASBcD1hxdqAlQQBYU=\n=W9xf\n-----END PGP SIGNATURE-----\n", "payload": "tree 7ee62039f69279432555044d6facf1931877a3c2\nparent 28b9696a9e0a948b0cafbb72a8ed880d571a8cca\nparent e61bb8810b26de043d3b4ba2560e78af71121a0e\nauthor Yuki Okushi <jtitor@2k36.org> 1683542510 +0900\ncommitter GitHub <noreply@github.com> 1683542510 +0900\n\nRollup merge of #111331 - taiki-e:s390x-asm-cc, r=Amanieu\n\nMark s390x condition code register as clobbered in inline assembly\n\nVarious s390x instructions (arithmetic operations, logical operations, comparisons, etc. see also \"Condition Codes\" section in [z/Architecture Reference Summary](https://www.ibm.com/support/pages/zarchitecture-reference-summary)) modify condition code register `cc`, but AFAIK there is currently no way to mark it as clobbered in `asm!`.\n\n`cc` register definition in LLVM:\nhttps://github.com/llvm/llvm-project/blob/main/llvm/lib/Target/SystemZ/SystemZRegisterInfo.td#L320\n\nThis PR also updates asm_experimental_arch docs in the unstable-book to mention s390x registers.\n\ncc `@uweigand`\n\nr? `@Amanieu`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c122ac3e6991544d2d28fbee3ffcf20a1dd4b514", "html_url": "https://github.com/rust-lang/rust/commit/c122ac3e6991544d2d28fbee3ffcf20a1dd4b514", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c122ac3e6991544d2d28fbee3ffcf20a1dd4b514/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "28b9696a9e0a948b0cafbb72a8ed880d571a8cca", "url": "https://api.github.com/repos/rust-lang/rust/commits/28b9696a9e0a948b0cafbb72a8ed880d571a8cca", "html_url": "https://github.com/rust-lang/rust/commit/28b9696a9e0a948b0cafbb72a8ed880d571a8cca"}, {"sha": "e61bb8810b26de043d3b4ba2560e78af71121a0e", "url": "https://api.github.com/repos/rust-lang/rust/commits/e61bb8810b26de043d3b4ba2560e78af71121a0e", "html_url": "https://github.com/rust-lang/rust/commit/e61bb8810b26de043d3b4ba2560e78af71121a0e"}], "stats": {"total": 17, "additions": 14, "deletions": 3}, "files": [{"sha": "70bcbf92f383a0f2f5ec9b9ddbb5fe3321e9209a", "filename": "compiler/rustc_codegen_llvm/src/asm.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c122ac3e6991544d2d28fbee3ffcf20a1dd4b514/compiler%2Frustc_codegen_llvm%2Fsrc%2Fasm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c122ac3e6991544d2d28fbee3ffcf20a1dd4b514/compiler%2Frustc_codegen_llvm%2Fsrc%2Fasm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fasm.rs?ref=c122ac3e6991544d2d28fbee3ffcf20a1dd4b514", "patch": "@@ -238,7 +238,9 @@ impl<'ll, 'tcx> AsmBuilderMethods<'tcx> for Builder<'_, 'll, 'tcx> {\n                 InlineAsmArch::Hexagon => {}\n                 InlineAsmArch::LoongArch64 => {}\n                 InlineAsmArch::Mips | InlineAsmArch::Mips64 => {}\n-                InlineAsmArch::S390x => {}\n+                InlineAsmArch::S390x => {\n+                    constraints.push(\"~{cc}\".to_string());\n+                }\n                 InlineAsmArch::SpirV => {}\n                 InlineAsmArch::Wasm32 | InlineAsmArch::Wasm64 => {}\n                 InlineAsmArch::Bpf => {}"}, {"sha": "532cb9eea1107ad56faaca76eec2daeadcf7b41e", "filename": "src/doc/unstable-book/src/language-features/asm-experimental-arch.md", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/c122ac3e6991544d2d28fbee3ffcf20a1dd4b514/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Fasm-experimental-arch.md", "raw_url": "https://github.com/rust-lang/rust/raw/c122ac3e6991544d2d28fbee3ffcf20a1dd4b514/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Fasm-experimental-arch.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Fasm-experimental-arch.md?ref=c122ac3e6991544d2d28fbee3ffcf20a1dd4b514", "patch": "@@ -18,6 +18,7 @@ This feature tracks `asm!` and `global_asm!` support for the following architect\n - MSP430\n - M68k\n - LoongArch\n+- s390x\n \n ## Register classes\n \n@@ -48,6 +49,8 @@ This feature tracks `asm!` and `global_asm!` support for the following architect\n | M68k         | `reg_addr`     | `a[0-3]`                           | `a`                  |\n | LoongArch    | `reg`          | `$r1`, `$r[4-20]`, `$r[23,30]`     | `r`                  |\n | LoongArch    | `freg`         | `$f[0-31]`                         | `f`                  |\n+| s390x        | `reg`          | `r[0-10]`, `r[12-14]`              | `r`                  |\n+| s390x        | `freg`         | `f[0-15]`                          | `f`                  |\n \n > **Notes**:\n > - NVPTX doesn't have a fixed register set, so named registers are not supported.\n@@ -81,6 +84,8 @@ This feature tracks `asm!` and `global_asm!` support for the following architect\n | M68k         | `reg_data`                      | None           | `i8`, `i16`, `i32`                      |\n | LoongArch64  | `reg`                           | None           | `i8`, `i16`, `i32`, `i64`, `f32`, `f64` |\n | LoongArch64  | `freg`                          | None           | `f32`, `f64`                            |\n+| s390x        | `reg`                           | None           | `i8`, `i16`, `i32`, `i64`               |\n+| s390x        | `freg`                          | None           | `f32`, `f64`                            |\n \n ## Register aliases\n \n@@ -115,8 +120,8 @@ This feature tracks `asm!` and `global_asm!` support for the following architect\n \n | Architecture | Unsupported register                    | Reason                                                                                                                                                                              |\n | ------------ | --------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n-| All          | `sp`                                    | The stack pointer must be restored to its original value at the end of an asm code block.                                                                                           |\n-| All          | `fr` (Hexagon), `$fp` (MIPS), `Y` (AVR), `r4` (MSP430), `a6` (M68k), `$fp` (LoongArch) | The frame pointer cannot be used as an input or output.                                                                                                                             |\n+| All          | `sp`, `r15` (s390x)                     | The stack pointer must be restored to its original value at the end of an asm code block.                                                                                           |\n+| All          | `fr` (Hexagon), `$fp` (MIPS), `Y` (AVR), `r4` (MSP430), `a6` (M68k), `$fp` (LoongArch), `r11` (s390x) | The frame pointer cannot be used as an input or output.                                                                                                                             |\n | All          | `r19` (Hexagon)                         | This is used internally by LLVM as a \"base pointer\" for functions with complex stack frames.                                                                                        |\n | MIPS         | `$0` or `$zero`                         | This is a constant zero register which can't be modified.                                                                                                                           |\n | MIPS         | `$1` or `$at`                           | Reserved for assembler.                                                                                                                                                             |\n@@ -147,6 +152,8 @@ This feature tracks `asm!` and `global_asm!` support for the following architect\n | PowerPC      | `freg`         | None     | `0`            | None          |\n | LoongArch    | `reg`          | None     | `$r2`          | None          |\n | LoongArch    | `freg`         | None     | `$f0`          | None          |\n+| s390x        | `reg`          | None     | `%r0`          | None          |\n+| s390x        | `freg`         | None     | `%f0`          | None          |\n \n # Flags covered by `preserves_flags`\n \n@@ -157,3 +164,5 @@ These flags registers must be restored upon exiting the asm block if the `preser\n   - The status register `r2`.\n - M68k\n   - The condition code register `ccr`.\n+- s390x\n+  - The condition code register `cc`."}]}