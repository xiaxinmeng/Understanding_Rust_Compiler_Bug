{"sha": "fe67d269a5f0df45d138051a3f105e05490ccf9e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZlNjdkMjY5YTVmMGRmNDVkMTM4MDUxYTNmMTA1ZTA1NDkwY2NmOWU=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-06-27T21:39:01Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-07-14T21:24:50Z"}, "message": "std: Make unlink() more consistent\n\nCurrently when a read-only file has unlink() invoked on it on windows, the call\nwill fail. On unix, however, the call will succeed. In order to have a more\nconsistent behavior across platforms, this error is recognized on windows and\nthe file is changed to read-write before removal is attempted.", "tree": {"sha": "8d660397d7e5117cc3e5296f0e9904bd2f3cc18d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8d660397d7e5117cc3e5296f0e9904bd2f3cc18d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fe67d269a5f0df45d138051a3f105e05490ccf9e", "comment_count": 9, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fe67d269a5f0df45d138051a3f105e05490ccf9e", "html_url": "https://github.com/rust-lang/rust/commit/fe67d269a5f0df45d138051a3f105e05490ccf9e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fe67d269a5f0df45d138051a3f105e05490ccf9e/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "996263a01589c5d2bd2a5ad559abac267296ad71", "url": "https://api.github.com/repos/rust-lang/rust/commits/996263a01589c5d2bd2a5ad559abac267296ad71", "html_url": "https://github.com/rust-lang/rust/commit/996263a01589c5d2bd2a5ad559abac267296ad71"}], "stats": {"total": 53, "additions": 47, "deletions": 6}, "files": [{"sha": "2c2e134d882cb9af73fb9c9605ddb85572f8a0fc", "filename": "src/librustuv/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fe67d269a5f0df45d138051a3f105e05490ccf9e/src%2Flibrustuv%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe67d269a5f0df45d138051a3f105e05490ccf9e/src%2Flibrustuv%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustuv%2Flib.rs?ref=fe67d269a5f0df45d138051a3f105e05490ccf9e", "patch": "@@ -420,6 +420,7 @@ pub fn uv_error_to_io_error(uverr: UvError) -> IoError {\n             uvll::EADDRNOTAVAIL => libc::WSAEADDRNOTAVAIL,\n             uvll::ECANCELED => libc::ERROR_OPERATION_ABORTED,\n             uvll::EADDRINUSE => libc::WSAEADDRINUSE,\n+            uvll::EPERM => libc::ERROR_ACCESS_DENIED,\n             err => {\n                 uvdebug!(\"uverr.code {}\", err as int);\n                 // FIXME: Need to map remaining uv error types"}, {"sha": "a59bc21d792a9ba175ed28e5999ccc4c0640ed6f", "filename": "src/librustuv/uvll.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fe67d269a5f0df45d138051a3f105e05490ccf9e/src%2Flibrustuv%2Fuvll.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe67d269a5f0df45d138051a3f105e05490ccf9e/src%2Flibrustuv%2Fuvll.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustuv%2Fuvll.rs?ref=fe67d269a5f0df45d138051a3f105e05490ccf9e", "patch": "@@ -39,7 +39,7 @@ use libc::uintptr_t;\n \n pub use self::errors::{EACCES, ECONNREFUSED, ECONNRESET, EPIPE, ECONNABORTED,\n                        ECANCELED, EBADF, ENOTCONN, ENOENT, EADDRNOTAVAIL,\n-                       EADDRINUSE};\n+                       EADDRINUSE, EPERM};\n \n pub static OK: c_int = 0;\n pub static EOF: c_int = -4095;\n@@ -63,6 +63,7 @@ pub mod errors {\n     pub static EBADF: c_int = -4083;\n     pub static EADDRNOTAVAIL: c_int = -4090;\n     pub static EADDRINUSE: c_int = -4091;\n+    pub static EPERM: c_int = -4048;\n }\n #[cfg(not(windows))]\n pub mod errors {\n@@ -80,6 +81,7 @@ pub mod errors {\n     pub static EBADF : c_int = -libc::EBADF;\n     pub static EADDRNOTAVAIL : c_int = -libc::EADDRNOTAVAIL;\n     pub static EADDRINUSE : c_int = -libc::EADDRINUSE;\n+    pub static EPERM: c_int = -libc::EPERM;\n }\n \n pub static PROCESS_SETUID: c_int = 1 << 0;"}, {"sha": "caff7d5e4c5930a6be9896e226466c5326a23e3e", "filename": "src/libstd/io/fs.rs", "status": "modified", "additions": 43, "deletions": 5, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/fe67d269a5f0df45d138051a3f105e05490ccf9e/src%2Flibstd%2Fio%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe67d269a5f0df45d138051a3f105e05490ccf9e/src%2Flibstd%2Fio%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fio%2Ffs.rs?ref=fe67d269a5f0df45d138051a3f105e05490ccf9e", "patch": "@@ -275,11 +275,41 @@ impl File {\n /// user lacks permissions to remove the file, or if some other filesystem-level\n /// error occurs.\n pub fn unlink(path: &Path) -> IoResult<()> {\n-    let err = LocalIo::maybe_raise(|io| {\n-        io.fs_unlink(&path.to_c_str())\n-    }).map_err(IoError::from_rtio_error);\n-    err.update_err(\"couldn't unlink path\",\n-                   |e| format!(\"{}; path={}\", e, path.display()))\n+    return match do_unlink(path) {\n+        Ok(()) => Ok(()),\n+        Err(e) => {\n+            // On unix, a readonly file can be successfully removed. On windows,\n+            // however, it cannot. To keep the two platforms in line with\n+            // respect to their behavior, catch this case on windows, attempt to\n+            // change it to read-write, and then remove the file.\n+            if cfg!(windows) && e.kind == io::PermissionDenied {\n+                let stat = match stat(path) {\n+                    Ok(stat) => stat,\n+                    Err(..) => return Err(e),\n+                };\n+                if stat.perm.intersects(io::UserWrite) { return Err(e) }\n+\n+                match chmod(path, stat.perm | io::UserWrite) {\n+                    Ok(()) => do_unlink(path),\n+                    Err(..) => {\n+                        // Try to put it back as we found it\n+                        let _ = chmod(path, stat.perm);\n+                        Err(e)\n+                    }\n+                }\n+            } else {\n+                Err(e)\n+            }\n+        }\n+    };\n+\n+    fn do_unlink(path: &Path) -> IoResult<()> {\n+        let err = LocalIo::maybe_raise(|io| {\n+            io.fs_unlink(&path.to_c_str())\n+        }).map_err(IoError::from_rtio_error);\n+        err.update_err(\"couldn't unlink path\",\n+                       |e| format!(\"{}; path={}\", e, path.display()))\n+    }\n }\n \n /// Given a path, query the file system to get information about a file,\n@@ -1591,4 +1621,12 @@ mod test {\n         let actual = check!(File::open(&tmpdir.join(\"test\")).read_to_end());\n         assert!(actual.as_slice() == bytes);\n     })\n+\n+    iotest!(fn unlink_readonly() {\n+        let tmpdir = tmpdir();\n+        let path = tmpdir.join(\"file\");\n+        check!(File::create(&path));\n+        check!(chmod(&path, io::UserRead));\n+        check!(unlink(&path));\n+    })\n }"}]}