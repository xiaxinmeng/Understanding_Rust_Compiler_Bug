{"sha": "ecc061596746dd5902cd29f64b61003b35cf8904", "node_id": "C_kwDOAAsO6NoAKGVjYzA2MTU5Njc0NmRkNTkwMmNkMjlmNjRiNjEwMDNiMzVjZjg5MDQ", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-05-06T21:32:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-05-06T21:32:03Z"}, "message": "Rollup merge of #111274 - cuviper:print-target-cpus, r=Mark-Simulacrum\n\nExpand the LLVM coverage of `--print target-cpus`\n\nWe've been relying on a custom patch to add `MCSubtargetInfo::getCPUTable`\nfor `rustc --print target-cpus`, and just printing that it's not supported\non external LLVM builds. LLVM `main` now has `getAllProcessorDescriptions`\nthat can replace ours, so now we try to use that. In addition, the fallback\npath can at least print the native and default cpu options.\n\nThere were also some mismatches in the function signatures here between\n`LLVM_RUSTLLVM` and otherwise; this is now mitigated by sharing these\nfunctions and only using cpp to adjust the function bodies.", "tree": {"sha": "03a33257d4a1b86d6faf59fa20bc4c4eb817fd99", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/03a33257d4a1b86d6faf59fa20bc4c4eb817fd99"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ecc061596746dd5902cd29f64b61003b35cf8904", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkVsdTCRBK7hj4Ov3rIwAAaLQIAJ0ZUVm8JZKypp9hdw1aP/Vp\nrfg5gPpms3Mks5OdvWm1zhXh51t+LLZRLNYy4DM1xv08lr+dolVDp/t5AQKkCQcP\nOwo85HRx6Yxn2nlY7uAyW+KjnyQAHJna4MsCZUJPQzPYNzQimac5fmhPABd4Wiqs\nRtO9KGDPC8iTqU+F2gkn+1hl9bHwReY/0WZK6RVtO95i0x8o5Mca/Bs9Wo5/CrOG\nOQzE2m0PTUTQyHfXgf4yTXHd0oXEyfQpsdVxy8iCrr2XIInlcJ8DJGIq0XVvQmBs\nTbqEzMlIoyZP+OEFuzWfsiehMTOpznTuIvALGPkorpjDmwsbW2BkkLPAl9PvUDM=\n=ZjGR\n-----END PGP SIGNATURE-----\n", "payload": "tree 03a33257d4a1b86d6faf59fa20bc4c4eb817fd99\nparent a3af5325185a07bb1f4004c51d20302204dd5f0e\nparent 67ae38a336599a7e0d2898a5ea3416b947458f5d\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1683408723 +0200\ncommitter GitHub <noreply@github.com> 1683408723 +0200\n\nRollup merge of #111274 - cuviper:print-target-cpus, r=Mark-Simulacrum\n\nExpand the LLVM coverage of `--print target-cpus`\n\nWe've been relying on a custom patch to add `MCSubtargetInfo::getCPUTable`\nfor `rustc --print target-cpus`, and just printing that it's not supported\non external LLVM builds. LLVM `main` now has `getAllProcessorDescriptions`\nthat can replace ours, so now we try to use that. In addition, the fallback\npath can at least print the native and default cpu options.\n\nThere were also some mismatches in the function signatures here between\n`LLVM_RUSTLLVM` and otherwise; this is now mitigated by sharing these\nfunctions and only using cpp to adjust the function bodies.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ecc061596746dd5902cd29f64b61003b35cf8904", "html_url": "https://github.com/rust-lang/rust/commit/ecc061596746dd5902cd29f64b61003b35cf8904", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ecc061596746dd5902cd29f64b61003b35cf8904/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a3af5325185a07bb1f4004c51d20302204dd5f0e", "url": "https://api.github.com/repos/rust-lang/rust/commits/a3af5325185a07bb1f4004c51d20302204dd5f0e", "html_url": "https://github.com/rust-lang/rust/commit/a3af5325185a07bb1f4004c51d20302204dd5f0e"}, {"sha": "67ae38a336599a7e0d2898a5ea3416b947458f5d", "url": "https://api.github.com/repos/rust-lang/rust/commits/67ae38a336599a7e0d2898a5ea3416b947458f5d", "html_url": "https://github.com/rust-lang/rust/commit/67ae38a336599a7e0d2898a5ea3416b947458f5d"}], "stats": {"total": 30, "additions": 16, "deletions": 14}, "files": [{"sha": "5ec3b95225d178195da9c7ae99871da8f4e3a090", "filename": "compiler/rustc_llvm/llvm-wrapper/PassWrapper.cpp", "status": "modified", "additions": 16, "deletions": 14, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/ecc061596746dd5902cd29f64b61003b35cf8904/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/ecc061596746dd5902cd29f64b61003b35cf8904/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp?ref=ecc061596746dd5902cd29f64b61003b35cf8904", "patch": "@@ -297,7 +297,6 @@ static Reloc::Model fromRust(LLVMRustRelocModel RustReloc) {\n   report_fatal_error(\"Bad RelocModel.\");\n }\n \n-#ifdef LLVM_RUSTLLVM\n /// getLongestEntryLength - Return the length of the longest entry in the table.\n template<typename KV>\n static size_t getLongestEntryLength(ArrayRef<KV> Table) {\n@@ -312,13 +311,23 @@ extern \"C\" void LLVMRustPrintTargetCPUs(LLVMTargetMachineRef TM, const char* Tar\n   const MCSubtargetInfo *MCInfo = Target->getMCSubtargetInfo();\n   const Triple::ArchType HostArch = Triple(sys::getDefaultTargetTriple()).getArch();\n   const Triple::ArchType TargetArch = Target->getTargetTriple().getArch();\n+\n+#if LLVM_VERSION_GE(17, 0)\n+  const ArrayRef<SubtargetSubTypeKV> CPUTable = MCInfo->getAllProcessorDescriptions();\n+#elif defined(LLVM_RUSTLLVM)\n   const ArrayRef<SubtargetSubTypeKV> CPUTable = MCInfo->getCPUTable();\n+#else\n+  printf(\"Full target CPU help is not supported by this LLVM version.\\n\\n\");\n+  SubtargetSubTypeKV TargetCPUKV = { TargetCPU, {{}}, {{}} };\n+  const ArrayRef<SubtargetSubTypeKV> CPUTable = TargetCPUKV;\n+#endif\n   unsigned MaxCPULen = getLongestEntryLength(CPUTable);\n \n   printf(\"Available CPUs for this target:\\n\");\n   // Don't print the \"native\" entry when the user specifies --target with a\n   // different arch since that could be wrong or misleading.\n   if (HostArch == TargetArch) {\n+    MaxCPULen = std::max(MaxCPULen, (unsigned) std::strlen(\"native\"));\n     const StringRef HostCPU = sys::getHostCPUName();\n     printf(\"    %-*s - Select the CPU of the current host (currently %.*s).\\n\",\n       MaxCPULen, \"native\", (int)HostCPU.size(), HostCPU.data());\n@@ -338,34 +347,27 @@ extern \"C\" void LLVMRustPrintTargetCPUs(LLVMTargetMachineRef TM, const char* Tar\n }\n \n extern \"C\" size_t LLVMRustGetTargetFeaturesCount(LLVMTargetMachineRef TM) {\n+#ifdef LLVM_RUSTLLVM\n   const TargetMachine *Target = unwrap(TM);\n   const MCSubtargetInfo *MCInfo = Target->getMCSubtargetInfo();\n   const ArrayRef<SubtargetFeatureKV> FeatTable = MCInfo->getFeatureTable();\n   return FeatTable.size();\n+#else\n+  return 0;\n+#endif\n }\n \n extern \"C\" void LLVMRustGetTargetFeature(LLVMTargetMachineRef TM, size_t Index,\n                                          const char** Feature, const char** Desc) {\n+#ifdef LLVM_RUSTLLVM\n   const TargetMachine *Target = unwrap(TM);\n   const MCSubtargetInfo *MCInfo = Target->getMCSubtargetInfo();\n   const ArrayRef<SubtargetFeatureKV> FeatTable = MCInfo->getFeatureTable();\n   const SubtargetFeatureKV Feat = FeatTable[Index];\n   *Feature = Feat.Key;\n   *Desc = Feat.Desc;\n-}\n-\n-#else\n-\n-extern \"C\" void LLVMRustPrintTargetCPUs(LLVMTargetMachineRef) {\n-  printf(\"Target CPU help is not supported by this LLVM version.\\n\\n\");\n-}\n-\n-extern \"C\" size_t LLVMRustGetTargetFeaturesCount(LLVMTargetMachineRef) {\n-  return 0;\n-}\n-\n-extern \"C\" void LLVMRustGetTargetFeature(LLVMTargetMachineRef, const char**, const char**) {}\n #endif\n+}\n \n extern \"C\" const char* LLVMRustGetHostCPUName(size_t *len) {\n   StringRef Name = sys::getHostCPUName();"}]}