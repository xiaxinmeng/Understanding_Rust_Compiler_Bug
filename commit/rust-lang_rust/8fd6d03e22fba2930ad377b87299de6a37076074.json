{"sha": "8fd6d03e22fba2930ad377b87299de6a37076074", "node_id": "C_kwDOAAsO6NoAKDhmZDZkMDNlMjJmYmEyOTMwYWQzNzdiODcyOTlkZTZhMzcwNzYwNzQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-20T07:10:18Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-20T07:10:18Z"}, "message": "Auto merge of #101806 - BelovDV:issue-fix-fn-find_library, r=petrochenkov\n\nfix verbatim with upstream dependencies\n\nhttps://github.com/rust-lang/rust/issues/99425#issuecomment-1207224161\n\nr? `@petrochenkov`", "tree": {"sha": "c5fa9caa1ae1f3572549c588e78ba3fc400d90c5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c5fa9caa1ae1f3572549c588e78ba3fc400d90c5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8fd6d03e22fba2930ad377b87299de6a37076074", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8fd6d03e22fba2930ad377b87299de6a37076074", "html_url": "https://github.com/rust-lang/rust/commit/8fd6d03e22fba2930ad377b87299de6a37076074", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8fd6d03e22fba2930ad377b87299de6a37076074/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "acb8934fd57b3c2740c4abac0a5728c2c9b1423b", "url": "https://api.github.com/repos/rust-lang/rust/commits/acb8934fd57b3c2740c4abac0a5728c2c9b1423b", "html_url": "https://github.com/rust-lang/rust/commit/acb8934fd57b3c2740c4abac0a5728c2c9b1423b"}, {"sha": "a38a082afb5522a0943e60b556588eb78a4dda80", "url": "https://api.github.com/repos/rust-lang/rust/commits/a38a082afb5522a0943e60b556588eb78a4dda80", "html_url": "https://github.com/rust-lang/rust/commit/a38a082afb5522a0943e60b556588eb78a4dda80"}], "stats": {"total": 94, "additions": 75, "deletions": 19}, "files": [{"sha": "e0bd7a33f7373c6d93a217937906a00c04f4049b", "filename": "compiler/rustc_codegen_ssa/src/back/linker.rs", "status": "modified", "additions": 12, "deletions": 6, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/8fd6d03e22fba2930ad377b87299de6a37076074/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fd6d03e22fba2930ad377b87299de6a37076074/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs?ref=8fd6d03e22fba2930ad377b87299de6a37076074", "patch": "@@ -439,7 +439,10 @@ impl<'a> Linker for GccLinker<'a> {\n             }\n         }\n         self.hint_dynamic();\n-        self.cmd.arg(format!(\"-l{}{}\", if verbatim { \":\" } else { \"\" }, lib));\n+        self.cmd.arg(format!(\n+            \"-l{}{lib}\",\n+            if verbatim && self.sess.target.linker_is_gnu { \":\" } else { \"\" },\n+        ));\n         if !as_needed {\n             if self.sess.target.is_like_osx {\n                 // See above FIXME comment\n@@ -450,7 +453,10 @@ impl<'a> Linker for GccLinker<'a> {\n     }\n     fn link_staticlib(&mut self, lib: &str, verbatim: bool) {\n         self.hint_static();\n-        self.cmd.arg(format!(\"-l{}{}\", if verbatim { \":\" } else { \"\" }, lib));\n+        self.cmd.arg(format!(\n+            \"-l{}{lib}\",\n+            if verbatim && self.sess.target.linker_is_gnu { \":\" } else { \"\" },\n+        ));\n     }\n     fn link_rlib(&mut self, lib: &Path) {\n         self.hint_static();\n@@ -504,10 +510,10 @@ impl<'a> Linker for GccLinker<'a> {\n         self.hint_static();\n         let target = &self.sess.target;\n         if !target.is_like_osx {\n-            self.linker_arg(\"--whole-archive\").cmd.arg(format!(\n-                \"-l{}{}\",\n-                if verbatim { \":\" } else { \"\" },\n-                lib\n+            self.linker_arg(\"--whole-archive\");\n+            self.cmd.arg(format!(\n+                \"-l{}{lib}\",\n+                if verbatim && self.sess.target.linker_is_gnu { \":\" } else { \"\" },\n             ));\n             self.linker_arg(\"--no-whole-archive\");\n         } else {"}, {"sha": "2a986c41d72f008ec108af180097ce5ad9cce943", "filename": "compiler/rustc_metadata/src/native_libs.rs", "status": "modified", "additions": 10, "deletions": 13, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/8fd6d03e22fba2930ad377b87299de6a37076074/compiler%2Frustc_metadata%2Fsrc%2Fnative_libs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fd6d03e22fba2930ad377b87299de6a37076074/compiler%2Frustc_metadata%2Fsrc%2Fnative_libs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Fnative_libs.rs?ref=8fd6d03e22fba2930ad377b87299de6a37076074", "patch": "@@ -33,28 +33,25 @@ pub fn find_native_static_library(\n     search_paths: &[PathBuf],\n     sess: &Session,\n ) -> PathBuf {\n-    let verbatim = verbatim.unwrap_or(false);\n-    // On Windows, static libraries sometimes show up as libfoo.a and other\n-    // times show up as foo.lib\n-    let oslibname = if verbatim {\n-        name.to_string()\n+    let formats = if verbatim.unwrap_or(false) {\n+        vec![(\"\".into(), \"\".into())]\n     } else {\n-        format!(\"{}{}{}\", sess.target.staticlib_prefix, name, sess.target.staticlib_suffix)\n+        let os = (sess.target.staticlib_prefix.clone(), sess.target.staticlib_suffix.clone());\n+        // On Windows, static libraries sometimes show up as libfoo.a and other\n+        // times show up as foo.lib\n+        let unix = (\"lib\".into(), \".a\".into());\n+        if os == unix { vec![os] } else { vec![os, unix] }\n     };\n-    let unixlibname = format!(\"lib{}.a\", name);\n \n     for path in search_paths {\n-        let test = path.join(&oslibname);\n-        if test.exists() {\n-            return test;\n-        }\n-        if oslibname != unixlibname {\n-            let test = path.join(&unixlibname);\n+        for (prefix, suffix) in &formats {\n+            let test = path.join(format!(\"{}{}{}\", prefix, name, suffix));\n             if test.exists() {\n                 return test;\n             }\n         }\n     }\n+\n     sess.emit_fatal(MissingNativeLibrary { libname: name });\n }\n "}, {"sha": "e56e1e94ec5b1d2cc7e2f6437db8328676d2e052", "filename": "src/test/run-make/native-link-modifier-verbatim-linker/Makefile", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/8fd6d03e22fba2930ad377b87299de6a37076074/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-linker%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/8fd6d03e22fba2930ad377b87299de6a37076074/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-linker%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-linker%2FMakefile?ref=8fd6d03e22fba2930ad377b87299de6a37076074", "patch": "@@ -0,0 +1,15 @@\n+# ignore-cross-compile\n+# ignore-macos\n+\n+include ../../run-make-fulldeps/tools.mk\n+\n+all:\n+\t# Verbatim allows specify precise name.\n+\t$(RUSTC) local_native_dep.rs --crate-type=staticlib -o $(TMPDIR)/local_some_strange_name.ext\n+\t$(RUSTC) main.rs -Zunstable-options -l static:+verbatim=local_some_strange_name.ext\n+\n+\t# With verbatim any other name cannot be used (local).\n+\t$(RUSTC) local_native_dep.rs --crate-type=staticlib -o $(TMPDIR)/liblocal_native_dep.a\n+\t$(RUSTC) local_native_dep.rs --crate-type=staticlib -o $(TMPDIR)/local_native_dep.a\n+\t$(RUSTC) local_native_dep.rs --crate-type=staticlib -o $(TMPDIR)/local_native_dep.lib\n+\t$(RUSTC) main.rs -Zunstable-options -l static:+verbatim=local_native_dep 2>&1 | $(CGREP) \"local_native_dep\""}, {"sha": "59b6c92d2936378b53d979f43ca5aaaa1f77c40b", "filename": "src/test/run-make/native-link-modifier-verbatim-linker/local_native_dep.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8fd6d03e22fba2930ad377b87299de6a37076074/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-linker%2Flocal_native_dep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fd6d03e22fba2930ad377b87299de6a37076074/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-linker%2Flocal_native_dep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-linker%2Flocal_native_dep.rs?ref=8fd6d03e22fba2930ad377b87299de6a37076074", "patch": "@@ -0,0 +1,4 @@\n+#[no_mangle]\n+pub fn local_native_f() -> i32 {\n+    return 0;\n+}"}, {"sha": "71b73a489c76744ad6428c29a710aeb98e863950", "filename": "src/test/run-make/native-link-modifier-verbatim-linker/main.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/8fd6d03e22fba2930ad377b87299de6a37076074/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-linker%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fd6d03e22fba2930ad377b87299de6a37076074/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-linker%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-linker%2Fmain.rs?ref=8fd6d03e22fba2930ad377b87299de6a37076074", "patch": "@@ -0,0 +1,9 @@\n+extern \"C\" {\n+    fn local_native_f() -> i32;\n+}\n+\n+pub fn main() {\n+    unsafe {\n+        assert!(local_native_f() == 0);\n+    };\n+}"}, {"sha": "1093b1cd3694d1de267da2c7850d9c7e71fb9711", "filename": "src/test/run-make/native-link-modifier-verbatim-rustc/Makefile", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/8fd6d03e22fba2930ad377b87299de6a37076074/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-rustc%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/8fd6d03e22fba2930ad377b87299de6a37076074/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-rustc%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-rustc%2FMakefile?ref=8fd6d03e22fba2930ad377b87299de6a37076074", "patch": "@@ -0,0 +1,12 @@\n+include ../../run-make-fulldeps/tools.mk\n+\n+all:\n+\t# Verbatim allows specify precise name.\n+\t$(RUSTC) upstream_native_dep.rs --crate-type=staticlib -o $(TMPDIR)/upstream_some_strange_name.ext\n+\t$(RUSTC) rust_dep.rs -Zunstable-options -l static:+verbatim=upstream_some_strange_name.ext --crate-type rlib\n+\n+\t# With verbatim any other name cannot be used (upstream).\n+\t$(RUSTC) upstream_native_dep.rs --crate-type=staticlib -o $(TMPDIR)/libupstream_native_dep.a\n+\t$(RUSTC) upstream_native_dep.rs --crate-type=staticlib -o $(TMPDIR)/upstream_native_dep.a\n+\t$(RUSTC) upstream_native_dep.rs --crate-type=staticlib -o $(TMPDIR)/upstream_native_dep.lib\n+\t$(RUSTC) rust_dep.rs -Zunstable-options -l static:+verbatim=upstream_native_dep --crate-type rlib 2>&1 | $(CGREP) \"upstream_native_dep\""}, {"sha": "e9517218e0dbe93833e8d66b66dd1d47b7d25a45", "filename": "src/test/run-make/native-link-modifier-verbatim-rustc/rust_dep.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/8fd6d03e22fba2930ad377b87299de6a37076074/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-rustc%2Frust_dep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fd6d03e22fba2930ad377b87299de6a37076074/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-rustc%2Frust_dep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-rustc%2Frust_dep.rs?ref=8fd6d03e22fba2930ad377b87299de6a37076074", "patch": "@@ -0,0 +1,9 @@\n+extern \"C\" {\n+    fn upstream_native_f() -> i32;\n+}\n+\n+pub fn rust_dep() {\n+    unsafe {\n+        assert!(upstream_native_f() == 0);\n+    }\n+}"}, {"sha": "8396862333dc034420cea64f2f93d073f3b86768", "filename": "src/test/run-make/native-link-modifier-verbatim-rustc/upstream_native_dep.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8fd6d03e22fba2930ad377b87299de6a37076074/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-rustc%2Fupstream_native_dep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fd6d03e22fba2930ad377b87299de6a37076074/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-rustc%2Fupstream_native_dep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-verbatim-rustc%2Fupstream_native_dep.rs?ref=8fd6d03e22fba2930ad377b87299de6a37076074", "patch": "@@ -0,0 +1,4 @@\n+#[no_mangle]\n+pub fn upstream_native_f() -> i32 {\n+    return 0;\n+}"}]}