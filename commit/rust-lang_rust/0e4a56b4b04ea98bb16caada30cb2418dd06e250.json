{"sha": "0e4a56b4b04ea98bb16caada30cb2418dd06e250", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBlNGE1NmI0YjA0ZWE5OGJiMTZjYWFkYTMwY2IyNDE4ZGQwNmUyNTA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-06-13T15:44:58Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-06-13T15:44:58Z"}, "message": "Auto merge of #61772 - alexcrichton:pr-and-master-builds, r=pietroalbini\n\nci: Enable toolstate tracking on Azure\n\nCurrently just run it through its paces but don't actually push to\nofficial locations. Instead let's just push to a separate fork (mine) as\nwell as open issues in a separate fork (mine). Make sure that people\naren't pinged for these issues as well!\n\nThis should hopefully ensure that everything is working on Azure and\ngive us a chance to work through any issues that come up.\n\nFixes https://github.com/rust-lang/rust/issues/61790\nFixes https://github.com/rust-lang/rust/issues/61371", "tree": {"sha": "e61f83ef4ef8738a82ce896da8d2423edcc8a0e5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e61f83ef4ef8738a82ce896da8d2423edcc8a0e5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0e4a56b4b04ea98bb16caada30cb2418dd06e250", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0e4a56b4b04ea98bb16caada30cb2418dd06e250", "html_url": "https://github.com/rust-lang/rust/commit/0e4a56b4b04ea98bb16caada30cb2418dd06e250", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0e4a56b4b04ea98bb16caada30cb2418dd06e250/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "57a3300c2538fd1044ce45d9ef3b82182acb57ae", "url": "https://api.github.com/repos/rust-lang/rust/commits/57a3300c2538fd1044ce45d9ef3b82182acb57ae", "html_url": "https://github.com/rust-lang/rust/commit/57a3300c2538fd1044ce45d9ef3b82182acb57ae"}, {"sha": "521edee2e586bc405953f0e84f50c49b85bf8510", "url": "https://api.github.com/repos/rust-lang/rust/commits/521edee2e586bc405953f0e84f50c49b85bf8510", "html_url": "https://github.com/rust-lang/rust/commit/521edee2e586bc405953f0e84f50c49b85bf8510"}], "stats": {"total": 58, "additions": 39, "deletions": 19}, "files": [{"sha": "4f000e79bd015232b524e5c29cb2210ee6736491", "filename": ".azure-pipelines/auto.yml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0e4a56b4b04ea98bb16caada30cb2418dd06e250/.azure-pipelines%2Fauto.yml", "raw_url": "https://github.com/rust-lang/rust/raw/0e4a56b4b04ea98bb16caada30cb2418dd06e250/.azure-pipelines%2Fauto.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fauto.yml?ref=0e4a56b4b04ea98bb16caada30cb2418dd06e250", "patch": "@@ -140,7 +140,6 @@ jobs:\n         IMAGE: x86_64-gnu-aux\n       x86_64-gnu-tools:\n         IMAGE: x86_64-gnu-tools\n-      # FIXME if: branch = auto OR (type = pull_request AND commit_message =~ /(?i:^update.*\\b(rls|rustfmt|clippy|miri|cargo)\\b)/)\n       x86_64-gnu-debug:\n         IMAGE: x86_64-gnu-debug\n       x86_64-gnu-nopt:"}, {"sha": "e2baa923d99f7c8f493ee73868b468147f8c77aa", "filename": ".azure-pipelines/master.yml", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/0e4a56b4b04ea98bb16caada30cb2418dd06e250/.azure-pipelines%2Fmaster.yml", "raw_url": "https://github.com/rust-lang/rust/raw/0e4a56b4b04ea98bb16caada30cb2418dd06e250/.azure-pipelines%2Fmaster.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fmaster.yml?ref=0e4a56b4b04ea98bb16caada30cb2418dd06e250", "patch": "@@ -6,6 +6,9 @@ pr: none\n trigger:\n   - master\n \n+variables:\n+- group: prod-credentials\n+\n pool:\n   vmImage: ubuntu-16.04\n \n@@ -16,9 +19,7 @@ steps:\n - script: |\n     export MESSAGE_FILE=$(mktemp -t msg.XXXXXX)\n     . src/ci/docker/x86_64-gnu-tools/repo.sh\n-    # FIXME(pietro): committing is disabled until we switch to Azure Pipelines\n-    # as the source of truth, or until we setup a separate test repo.\n-    #commit_toolstate_change \"$MESSAGE_FILE\" \"$BUILD_SOURCESDIRECTORY/src/tools/publish_toolstate.py\" \"$(git rev-parse HEAD)\" \"$(git log --format=%s -n1 HEAD)\" \"$MESSAGE_FILE\" \"$TOOLSTATE_REPO_ACCESS_TOKEN\"\n+    commit_toolstate_change \"$MESSAGE_FILE\" \"$BUILD_SOURCESDIRECTORY/src/tools/publish_toolstate.py\" \"$(git rev-parse HEAD)\" \"$(git log --format=%s -n1 HEAD)\" \"$MESSAGE_FILE\" \"$TOOLSTATE_REPO_ACCESS_TOKEN\"\n   displayName: Publish toolstate\n   env:\n-    TOOLSTATE_REPO_ACCESS_TOKEN: $(TOOLSTATE_REPO_ACCESS_TOKEN_SECRET)\n+    TOOLSTATE_REPO_ACCESS_TOKEN: $(TOOLSTATE_REPO_ACCESS_TOKEN)"}, {"sha": "88b5067b4a330e8f0c9c95574aa5e5f2ea3352a0", "filename": ".azure-pipelines/pr.yml", "status": "modified", "additions": 16, "deletions": 5, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/0e4a56b4b04ea98bb16caada30cb2418dd06e250/.azure-pipelines%2Fpr.yml", "raw_url": "https://github.com/rust-lang/rust/raw/0e4a56b4b04ea98bb16caada30cb2418dd06e250/.azure-pipelines%2Fpr.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fpr.yml?ref=0e4a56b4b04ea98bb16caada30cb2418dd06e250", "patch": "@@ -4,19 +4,30 @@\n \n trigger: none\n pr:\n-- master # FIXME: really just want any branch, but want an explicit \"pr\" property set so it's clear\n+- master\n \n jobs:\n - job: Linux\n+  timeoutInMinutes: 600\n   pool:\n     vmImage: ubuntu-16.04\n   steps:\n     - template: steps/run.yml\n   strategy:\n     matrix:\n       x86_64-gnu-llvm-6.0:\n-        RUST_BACKTRACE: 1\n+        IMAGE: x86_64-gnu-llvm-6.0\n+      mingw-check:\n+        IMAGE: mingw-check\n \n-#      x86_64-gnu-tools: {}\n-#      # if: branch = auto OR (type = pull_request AND commit_message =~ /(?i:^update.*\\b(rls|rustfmt|clippy|miri|cargo)\\b)/)\n-#      mingw-check: {}\n+# TODO: enable this job if the commit message matches this regex, need tools\n+# figure out how to get the current commit message on azure and stick it in a\n+# condition somewhere\n+#     if: commit_message =~ /(?i:^update.*\\b(rls|rustfmt|clippy|miri|cargo)\\b)/\n+# - job: Linux-x86_64-gnu-tools\n+#   pool:\n+#     vmImage: ubuntu-16.04\n+#   steps:\n+#     - template: steps/run.yml\n+#   variables:\n+#     IMAGE: x86_64-gnu-tools"}, {"sha": "3f98aa495296a3b02ca477d23f6200bbf3012565", "filename": ".azure-pipelines/steps/run.yml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0e4a56b4b04ea98bb16caada30cb2418dd06e250/.azure-pipelines%2Fsteps%2Frun.yml", "raw_url": "https://github.com/rust-lang/rust/raw/0e4a56b4b04ea98bb16caada30cb2418dd06e250/.azure-pipelines%2Fsteps%2Frun.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Frun.yml?ref=0e4a56b4b04ea98bb16caada30cb2418dd06e250", "patch": "@@ -124,6 +124,7 @@ steps:\n     CI: true\n     SRC: .\n     AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)\n+    TOOLSTATE_REPO_ACCESS_TOKEN: $(TOOLSTATE_REPO_ACCESS_TOKEN)\n   displayName: Run build\n \n # If we're a deploy builder, use the `aws` command to publish everything to our"}, {"sha": "e6cd794887c0a9d4347fc072e089d8d38aa90578", "filename": "src/ci/docker/run.sh", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src%2Fci%2Fdocker%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src%2Fci%2Fdocker%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Frun.sh?ref=0e4a56b4b04ea98bb16caada30cb2418dd06e250", "patch": "@@ -149,6 +149,7 @@ exec docker \\\n   --env TF_BUILD \\\n   --env BUILD_SOURCEBRANCHNAME \\\n   --env TOOLSTATE_REPO_ACCESS_TOKEN \\\n+  --env TOOLSTATE_REPO \\\n   --env CI_JOB_NAME=\"${CI_JOB_NAME-$IMAGE}\" \\\n   --volume \"$HOME/.cargo:/cargo\" \\\n   --volume \"$HOME/rustsrc:$HOME/rustsrc\" \\"}, {"sha": "741d4dcbd9a45e12e1f4caff9f93daf3e7f4e805", "filename": "src/ci/docker/x86_64-gnu-tools/repo.sh", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Frepo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Frepo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Frepo.sh?ref=0e4a56b4b04ea98bb16caada30cb2418dd06e250", "patch": "@@ -55,7 +55,7 @@ commit_toolstate_change() {\n     git config --global credential.helper store\n     printf 'https://%s:x-oauth-basic@github.com\\n' \"$TOOLSTATE_REPO_ACCESS_TOKEN\" \\\n         > \"$HOME/.git-credentials\"\n-    git clone --depth=1 https://github.com/rust-lang-nursery/rust-toolstate.git\n+    git clone --depth=1 $TOOLSTATE_REPO\n \n     cd rust-toolstate\n     FAILURE=1"}, {"sha": "a777279bd16c91b01a67d527609c5439764241ca", "filename": "src/tools/publish_toolstate.py", "status": "modified", "additions": 15, "deletions": 8, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src%2Ftools%2Fpublish_toolstate.py", "raw_url": "https://github.com/rust-lang/rust/raw/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src%2Ftools%2Fpublish_toolstate.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fpublish_toolstate.py?ref=0e4a56b4b04ea98bb16caada30cb2418dd06e250", "patch": "@@ -3,6 +3,7 @@\n \n import sys\n import re\n+import os\n import json\n import datetime\n import collections\n@@ -53,6 +54,14 @@ def read_current_status(current_commit, path):\n                 return json.loads(status)\n     return {}\n \n+def gh_url():\n+    return os.environ['TOOLSTATE_ISSUES_API_URL']\n+\n+def maybe_delink(message):\n+    if os.environ.get('TOOLSTATE_SKIP_MENTIONS') is not None:\n+        return message.replace(\"@\", \"\")\n+    return message\n+\n def issue(\n     tool,\n     maintainers,\n@@ -61,13 +70,12 @@ def issue(\n     pr_reviewer,\n ):\n     # Open an issue about the toolstate failure.\n-    gh_url = 'https://api.github.com/repos/rust-lang/rust/issues'\n     assignees = [x.strip() for x in maintainers.split('@') if x != '']\n     assignees.append(relevant_pr_user)\n     response = urllib2.urlopen(urllib2.Request(\n-        gh_url,\n+        gh_url(),\n         json.dumps({\n-            'body': textwrap.dedent('''\\\n+            'body': maybe_delink(textwrap.dedent('''\\\n             Hello, this is your friendly neighborhood mergebot.\n             After merging PR {}, I observed that the tool {} no longer builds.\n             A follow-up PR to the repository {} is needed to fix the fallout.\n@@ -77,7 +85,7 @@ def issue(\n \n             cc @{}, the PR reviewer, and @rust-lang/compiler -- nominating for prioritization.\n \n-            ''').format(relevant_pr_number, tool, REPOS.get(tool), relevant_pr_user, pr_reviewer),\n+            ''').format(relevant_pr_number, tool, REPOS.get(tool), relevant_pr_user, pr_reviewer)),\n             'title': '`{}` no longer builds after {}'.format(tool, relevant_pr_number),\n             'assignees': assignees,\n             'labels': ['T-compiler', 'I-nominated'],\n@@ -216,11 +224,10 @@ def update_latest(\n         f.write(message)\n \n     # Write the toolstate comment on the PR as well.\n-    gh_url = 'https://api.github.com/repos/rust-lang/rust/issues/{}/comments' \\\n-        .format(number)\n+    issue_url = gh_url() + '/{}/comments'.format(number)\n     response = urllib2.urlopen(urllib2.Request(\n-        gh_url,\n-        json.dumps({'body': message}),\n+        issue_url,\n+        json.dumps({'body': maybe_delink(message)}),\n         {\n             'Authorization': 'token ' + github_token,\n             'Content-Type': 'application/json',"}]}