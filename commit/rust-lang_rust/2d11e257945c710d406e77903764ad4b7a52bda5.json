{"sha": "2d11e257945c710d406e77903764ad4b7a52bda5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJkMTFlMjU3OTQ1YzcxMGQ0MDZlNzc5MDM3NjRhZDRiN2E1MmJkYTU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-05T03:56:26Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-05T03:56:26Z"}, "message": "Auto merge of #84794 - ChrisDenton:dedup-native-libs, r=petrochenkov\n\nDeduplicate native libs before they are passed to the linker\n\nStop spamming the linker with the same native library over and over again, if they directly follow from each other. This would help prevent [this situation](https://github.com/MSxDOS/ntapi/issues/2).\n\nIssue #38460 has been open since 2016 so I think it's worth making an incomplete fix that at least addresses the most common symptom and without otherwise changing how Rust handles native libs. This PR is intended to be easy to revert (if necessary) when a more permanent fix is implemented.", "tree": {"sha": "e2cab8b96e4b75c1d22140b244b32eaf80f9e2d9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e2cab8b96e4b75c1d22140b244b32eaf80f9e2d9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2d11e257945c710d406e77903764ad4b7a52bda5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2d11e257945c710d406e77903764ad4b7a52bda5", "html_url": "https://github.com/rust-lang/rust/commit/2d11e257945c710d406e77903764ad4b7a52bda5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2d11e257945c710d406e77903764ad4b7a52bda5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "45ccf910703fe7afee30cf223ed046ed2d2afb91", "url": "https://api.github.com/repos/rust-lang/rust/commits/45ccf910703fe7afee30cf223ed046ed2d2afb91", "html_url": "https://github.com/rust-lang/rust/commit/45ccf910703fe7afee30cf223ed046ed2d2afb91"}, {"sha": "e40faeffa2d9e980778fb46973f8d0eb090526a9", "url": "https://api.github.com/repos/rust-lang/rust/commits/e40faeffa2d9e980778fb46973f8d0eb090526a9", "html_url": "https://github.com/rust-lang/rust/commit/e40faeffa2d9e980778fb46973f8d0eb090526a9"}], "stats": {"total": 8, "additions": 8, "deletions": 0}, "files": [{"sha": "dcdd0910aa6af216348afa4ef2872d65d5116294", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2d11e257945c710d406e77903764ad4b7a52bda5/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d11e257945c710d406e77903764ad4b7a52bda5/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=2d11e257945c710d406e77903764ad4b7a52bda5", "patch": "@@ -1803,7 +1803,11 @@ fn add_local_native_libraries(\n         codegen_results.crate_info.used_libraries.iter().filter(|l| relevant_lib(sess, l));\n \n     let search_path = archive_search_paths(sess);\n+    let mut last = (NativeLibKind::Unspecified, None);\n     for lib in relevant_libs {\n+        // Skip if this library is the same as the last.\n+        last = if (lib.kind, lib.name) == last { continue } else { (lib.kind, lib.name) };\n+\n         let name = match lib.name {\n             Some(l) => l,\n             None => continue,\n@@ -2127,8 +2131,12 @@ fn add_upstream_native_libraries(\n         .expect(\"failed to find crate type in dependency format list\");\n \n     let crates = &codegen_results.crate_info.used_crates_static;\n+    let mut last = (NativeLibKind::Unspecified, None);\n     for &(cnum, _) in crates {\n         for lib in codegen_results.crate_info.native_libraries[&cnum].iter() {\n+            // Skip if this library is the same as the last.\n+            last = if (lib.kind, lib.name) == last { continue } else { (lib.kind, lib.name) };\n+\n             let name = match lib.name {\n                 Some(l) => l,\n                 None => continue,"}]}