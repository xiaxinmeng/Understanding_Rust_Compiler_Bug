{"sha": "2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJjOGFlNWNhOGRkNDIzNDQzZTQ0ZTNmMDg2M2YzYzUwYjMxMjZjZDI=", "commit": {"author": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-08-25T23:36:18Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-08-25T23:36:18Z"}, "message": "Add element to closure to hold captured tydesc (not body tydesc).", "tree": {"sha": "dbeee2bb393721d22fd85827dbb30702bbfb6c22", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dbeee2bb393721d22fd85827dbb30702bbfb6c22"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2", "html_url": "https://github.com/rust-lang/rust/commit/2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2/comments", "author": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "91d640f90f23a79f10cde0a4e70bd86ab8cf5378", "url": "https://api.github.com/repos/rust-lang/rust/commits/91d640f90f23a79f10cde0a4e70bd86ab8cf5378", "html_url": "https://github.com/rust-lang/rust/commit/91d640f90f23a79f10cde0a4e70bd86ab8cf5378"}], "stats": {"total": 22, "additions": 12, "deletions": 10}, "files": [{"sha": "dbbc713540560a97e0755ac6b74b9405e3e46c94", "filename": "src/boot/be/abi.ml", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2/src%2Fboot%2Fbe%2Fabi.ml", "raw_url": "https://github.com/rust-lang/rust/raw/2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2/src%2Fboot%2Fbe%2Fabi.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Fbe%2Fabi.ml?ref=2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2", "patch": "@@ -62,9 +62,10 @@ let obj_body_elt_fields = 1;;\n let fn_field_code = binding_field_dispatch;;\n let fn_field_box = binding_field_bound_data;;\n \n-let closure_body_elt_tydesc = 0;;\n-let closure_body_elt_target = 1;;\n-let closure_body_elt_bound_args = 2;;\n+let closure_body_elt_bound_args_tydesc = 0;;\n+let closure_body_elt_target_tydesc = 1;;\n+let closure_body_elt_target = 2;;\n+let closure_body_elt_bound_args = 3;;\n \n let tag_elt_discriminant = 0;;\n let tag_elt_variant = 1;;"}, {"sha": "3f98488cd967e686f5ecea6ba542a7fa134ea6d7", "filename": "src/boot/me/semant.ml", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2/src%2Fboot%2Fme%2Fsemant.ml", "raw_url": "https://github.com/rust-lang/rust/raw/2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2/src%2Fboot%2Fme%2Fsemant.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Fme%2Fsemant.ml?ref=2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2", "patch": "@@ -1905,8 +1905,6 @@ let obj_rty (word_bits:Il.bits) : Il.referent_ty =\n     r [| obj_vtbl_ptr; obj_box_ptr |]\n ;;\n \n-\n-\n let rec closure_box_rty\n     (word_bits:Il.bits)\n     (bs:Ast.slot array)\n@@ -1920,8 +1918,9 @@ let rec closure_box_rty\n   let tydesc = sp (tydesc_rty word_bits) in\n   let targ = fn_rty true word_bits in\n   let bound_args = r (Array.map (slot_referent_type word_bits) bs) in\n-\n-    r [| rc; r [| tydesc; targ; bound_args |] |]\n+    (* First tydesc is the one describing bound_args; second tydesc is the one\n+     * to pass to targ when invoking it.  *)\n+    r [| rc; r [| tydesc; tydesc; targ; bound_args |] |]\n \n and fn_rty (opaque_box_body:bool) (word_bits:Il.bits) : Il.referent_ty =\n   let s t = Il.ScalarTy t in"}, {"sha": "2c1ecee141a28d762d74608626ed3e408c352e57", "filename": "src/boot/me/trans.ml", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2/src%2Fboot%2Fme%2Ftrans.ml", "raw_url": "https://github.com/rust-lang/rust/raw/2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2/src%2Fboot%2Fme%2Ftrans.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Fme%2Ftrans.ml?ref=2c8ae5ca8dd423443e44e3f0863f3c50b3126cd2", "patch": "@@ -3619,16 +3619,18 @@ let trans_visitor\n     let rc_cell = get_element_ptr closure_cell Abi.box_rc_field_refcnt in\n     let body_cell = get_element_ptr closure_cell Abi.box_rc_field_body in\n     let targ_cell = get_element_ptr body_cell Abi.closure_body_elt_target in\n-    let tydesc_cell = get_element_ptr body_cell Abi.closure_body_elt_tydesc in\n+    let bound_args_tydesc_cell =\n+      get_element_ptr body_cell Abi.closure_body_elt_bound_args_tydesc\n+    in\n     let args_cell =\n       get_element_ptr body_cell Abi.closure_body_elt_bound_args\n     in\n \n     iflog (fun _ -> annotate \"init closure refcount\");\n     mov rc_cell one;\n \n-    iflog (fun _ -> annotate \"set closure tydesc ptr\");\n-    mov tydesc_cell\n+    iflog (fun _ -> annotate \"set closure bound-args tydesc ptr\");\n+    mov bound_args_tydesc_cell\n       (Il.Cell (get_tydesc None\n                   (Ast.TY_tup (Array.map slot_ty bound_arg_slots))));\n "}]}