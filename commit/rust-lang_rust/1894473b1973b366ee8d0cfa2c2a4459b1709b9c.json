{"sha": "1894473b1973b366ee8d0cfa2c2a4459b1709b9c", "node_id": "C_kwDOAAsO6NoAKDE4OTQ0NzNiMTk3M2IzNjZlZThkMGNmYTJjMmE0NDU5YjE3MDliOWM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-22T15:46:30Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-22T15:46:30Z"}, "message": "Auto merge of #12058 - jonas-schievink:one-thread-with-extra-stack-please, r=jonas-schievink\n\nfix: Spawn a new thread with a larger stack for the LSP and proc-macro server\n\nThis runs the server and proc-macro process in dedicated threads with 8 MB of stack space to paper over OS differences and fix occasional stack overflows.\n\nThis hopefully resolves https://github.com/rust-lang/rust-analyzer/issues/11669", "tree": {"sha": "82147c6805aee561eeb8ad2d9c0f6b90e14ab194", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/82147c6805aee561eeb8ad2d9c0f6b90e14ab194"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1894473b1973b366ee8d0cfa2c2a4459b1709b9c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1894473b1973b366ee8d0cfa2c2a4459b1709b9c", "html_url": "https://github.com/rust-lang/rust/commit/1894473b1973b366ee8d0cfa2c2a4459b1709b9c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1894473b1973b366ee8d0cfa2c2a4459b1709b9c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ebe6e30f0459ef3eedfb4fef9f02bd95db111d2d", "url": "https://api.github.com/repos/rust-lang/rust/commits/ebe6e30f0459ef3eedfb4fef9f02bd95db111d2d", "html_url": "https://github.com/rust-lang/rust/commit/ebe6e30f0459ef3eedfb4fef9f02bd95db111d2d"}, {"sha": "b5a56c7d53c3b00df4b580e9d48c59fa7df48cf5", "url": "https://api.github.com/repos/rust-lang/rust/commits/b5a56c7d53c3b00df4b580e9d48c59fa7df48cf5", "html_url": "https://github.com/rust-lang/rust/commit/b5a56c7d53c3b00df4b580e9d48c59fa7df48cf5"}], "stats": {"total": 25, "additions": 23, "deletions": 2}, "files": [{"sha": "df61ba8eec8466c8365b02c9157862836a1cfe40", "filename": "crates/rust-analyzer/src/bin/main.rs", "status": "modified", "additions": 23, "deletions": 2, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/1894473b1973b366ee8d0cfa2c2a4459b1709b9c/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1894473b1973b366ee8d0cfa2c2a4459b1709b9c/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs?ref=1894473b1973b366ee8d0cfa2c2a4459b1709b9c", "patch": "@@ -77,9 +77,13 @@ fn try_main() -> Result<()> {\n                 println!(\"{}\", flags::RustAnalyzer::HELP);\n                 return Ok(());\n             }\n-            run_server()?\n+            with_extra_thread(\"rust-analyzer server thread\", run_server)?;\n+        }\n+        flags::RustAnalyzerCmd::ProcMacro(flags::ProcMacro) => {\n+            with_extra_thread(\"rust-analyzer proc-macro expander\", || {\n+                proc_macro_srv::cli::run().map_err(Into::into)\n+            })?;\n         }\n-        flags::RustAnalyzerCmd::ProcMacro(flags::ProcMacro) => proc_macro_srv::cli::run()?,\n         flags::RustAnalyzerCmd::Parse(cmd) => cmd.run()?,\n         flags::RustAnalyzerCmd::Symbols(cmd) => cmd.run()?,\n         flags::RustAnalyzerCmd::Highlight(cmd) => cmd.run()?,\n@@ -128,6 +132,23 @@ fn setup_logging(log_file: Option<&Path>) -> Result<()> {\n     Ok(())\n }\n \n+const STACK_SIZE: usize = 1024 * 1024 * 8;\n+\n+/// Parts of rust-analyzer can use a lot of stack space, and some operating systems only give us\n+/// 1 MB by default (eg. Windows), so this spawns a new thread with hopefully sufficient stack\n+/// space.\n+fn with_extra_thread(\n+    thread_name: impl Into<String>,\n+    f: impl FnOnce() -> Result<()> + Send + 'static,\n+) -> Result<()> {\n+    let handle =\n+        std::thread::Builder::new().name(thread_name.into()).stack_size(STACK_SIZE).spawn(f)?;\n+    match handle.join() {\n+        Ok(res) => res,\n+        Err(panic) => std::panic::resume_unwind(panic),\n+    }\n+}\n+\n fn run_server() -> Result<()> {\n     tracing::info!(\"server version {} will start\", env!(\"REV\"));\n "}]}