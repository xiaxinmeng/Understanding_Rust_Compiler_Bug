{"sha": "c673d3fed07aafa77bba3a0db04aa9acb56353e1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM2NzNkM2ZlZDA3YWFmYTc3YmJhM2EwZGIwNGFhOWFjYjU2MzUzZTE=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2021-07-24T16:51:59Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-24T16:51:59Z"}, "message": "Rollup merge of #87389 - Aaron1011:expand-known-attrs, r=wesleywiser\n\nRename `known_attrs` to `expanded_inert_attrs` and move to rustc_expand\n\nThere's no need for this to be (untracked) global state.", "tree": {"sha": "0ebae5820965f3b6c76982e0b489fadc32665166", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0ebae5820965f3b6c76982e0b489fadc32665166"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c673d3fed07aafa77bba3a0db04aa9acb56353e1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg/EUvCRBK7hj4Ov3rIwAAc1cIAI8I9l9Er/ZzkL2ckWCpZJ+S\npTGkeH2jQ7/vmPGkeRwHzjYIxeN8iD4znf16mIU7miskTeVShsMNQjVWtvNYph8X\nKqEGIl41q9rlDJO/cOPZV6PRuqJcKeTnzVZiuKYcsiVQsXGBw2Kv1QeUH8MU9qzJ\nqdb2wMGOcfT5RMzdlIy13FpvWll0eL6x08F42dVlpKrT1OyXi/mYCiezWJwULX1K\nJ/L/C2DhrsrgSGRtQdZACOpPn/ELY8BBMpUTsuXR2getlodJSN2HSKN24XiRl9zh\nq4IZesxEknp+4p/B58DI99RWpSl2+nMDUxqZSoEE5sXNYD9UC+CqgWkjCeQI1Ps=\n=1m6D\n-----END PGP SIGNATURE-----\n", "payload": "tree 0ebae5820965f3b6c76982e0b489fadc32665166\nparent 9d45a019f23a5982a478d9ea693e1d891a88d1ed\nparent a2ae1912954bf6e21c706258348735218ceb1ab4\nauthor Manish Goregaokar <manishsmail@gmail.com> 1627145519 -0700\ncommitter GitHub <noreply@github.com> 1627145519 -0700\n\nRollup merge of #87389 - Aaron1011:expand-known-attrs, r=wesleywiser\n\nRename `known_attrs` to `expanded_inert_attrs` and move to rustc_expand\n\nThere's no need for this to be (untracked) global state.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c673d3fed07aafa77bba3a0db04aa9acb56353e1", "html_url": "https://github.com/rust-lang/rust/commit/c673d3fed07aafa77bba3a0db04aa9acb56353e1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c673d3fed07aafa77bba3a0db04aa9acb56353e1/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9d45a019f23a5982a478d9ea693e1d891a88d1ed", "url": "https://api.github.com/repos/rust-lang/rust/commits/9d45a019f23a5982a478d9ea693e1d891a88d1ed", "html_url": "https://github.com/rust-lang/rust/commit/9d45a019f23a5982a478d9ea693e1d891a88d1ed"}, {"sha": "a2ae1912954bf6e21c706258348735218ceb1ab4", "url": "https://api.github.com/repos/rust-lang/rust/commits/a2ae1912954bf6e21c706258348735218ceb1ab4", "html_url": "https://github.com/rust-lang/rust/commit/a2ae1912954bf6e21c706258348735218ceb1ab4"}], "stats": {"total": 20, "additions": 8, "deletions": 12}, "files": [{"sha": "3d5bc770c4fb0e6965f613f4772d502850438f79", "filename": "compiler/rustc_expand/src/base.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c673d3fed07aafa77bba3a0db04aa9acb56353e1/compiler%2Frustc_expand%2Fsrc%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c673d3fed07aafa77bba3a0db04aa9acb56353e1/compiler%2Frustc_expand%2Fsrc%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fbase.rs?ref=c673d3fed07aafa77bba3a0db04aa9acb56353e1", "patch": "@@ -1,6 +1,7 @@\n use crate::expand::{self, AstFragment, Invocation};\n use crate::module::DirOwnership;\n \n+use rustc_ast::attr::MarkedAttrs;\n use rustc_ast::ptr::P;\n use rustc_ast::token::{self, Nonterminal};\n use rustc_ast::tokenstream::{CanSynthesizeMissingTokens, TokenStream};\n@@ -951,6 +952,10 @@ pub struct ExtCtxt<'a> {\n     ///\n     /// `Ident` is the module name.\n     pub(super) extern_mod_loaded: OnExternModLoaded<'a>,\n+    /// When we 'expand' an inert attribute, we leave it\n+    /// in the AST, but insert it here so that we know\n+    /// not to expand it again.\n+    pub(super) expanded_inert_attrs: MarkedAttrs,\n }\n \n impl<'a> ExtCtxt<'a> {\n@@ -977,6 +982,7 @@ impl<'a> ExtCtxt<'a> {\n             },\n             force_mode: false,\n             expansions: FxHashMap::default(),\n+            expanded_inert_attrs: MarkedAttrs::new(),\n         }\n     }\n "}, {"sha": "c72b1b33dbc85996583df71bb4efcb95bf06ab92", "filename": "compiler/rustc_expand/src/expand.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c673d3fed07aafa77bba3a0db04aa9acb56353e1/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c673d3fed07aafa77bba3a0db04aa9acb56353e1/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs?ref=c673d3fed07aafa77bba3a0db04aa9acb56353e1", "patch": "@@ -754,7 +754,7 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n                     }\n                 }\n                 SyntaxExtensionKind::NonMacroAttr { mark_used } => {\n-                    self.cx.sess.mark_attr_known(&attr);\n+                    self.cx.expanded_inert_attrs.mark(&attr);\n                     if *mark_used {\n                         self.cx.sess.mark_attr_used(&attr);\n                     }\n@@ -1040,7 +1040,7 @@ impl<'a, 'b> InvocationCollector<'a, 'b> {\n         item.visit_attrs(|attrs| {\n             attr = attrs\n                 .iter()\n-                .position(|a| !self.cx.sess.is_attr_known(a) && !is_builtin_attr(a))\n+                .position(|a| !self.cx.expanded_inert_attrs.is_marked(a) && !is_builtin_attr(a))\n                 .map(|attr_pos| {\n                     let attr = attrs.remove(attr_pos);\n                     let following_derives = attrs[attr_pos..]"}, {"sha": "369af437c43841ce3090ce8a9af1e429bf9ed15c", "filename": "compiler/rustc_session/src/session.rs", "status": "modified", "additions": 0, "deletions": 10, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/c673d3fed07aafa77bba3a0db04aa9acb56353e1/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c673d3fed07aafa77bba3a0db04aa9acb56353e1/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fsession.rs?ref=c673d3fed07aafa77bba3a0db04aa9acb56353e1", "patch": "@@ -219,7 +219,6 @@ pub struct Session {\n     /// Set of enabled features for the current target.\n     pub target_features: FxHashSet<Symbol>,\n \n-    known_attrs: Lock<MarkedAttrs>,\n     used_attrs: Lock<MarkedAttrs>,\n \n     /// `Span`s for `if` conditions that we have suggested turning into `if let`.\n@@ -1076,14 +1075,6 @@ impl Session {\n             == config::InstrumentCoverage::ExceptUnusedFunctions\n     }\n \n-    pub fn mark_attr_known(&self, attr: &Attribute) {\n-        self.known_attrs.lock().mark(attr)\n-    }\n-\n-    pub fn is_attr_known(&self, attr: &Attribute) -> bool {\n-        self.known_attrs.lock().is_marked(attr)\n-    }\n-\n     pub fn mark_attr_used(&self, attr: &Attribute) {\n         self.used_attrs.lock().mark(attr)\n     }\n@@ -1389,7 +1380,6 @@ pub fn build_session(\n         miri_unleashed_features: Lock::new(Default::default()),\n         asm_arch,\n         target_features: FxHashSet::default(),\n-        known_attrs: Lock::new(MarkedAttrs::new()),\n         used_attrs: Lock::new(MarkedAttrs::new()),\n         if_let_suggestions: Default::default(),\n     };"}]}