{"sha": "ed33453a37d602f34cc40c205f9b9b8a8aff88b5", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVkMzM0NTNhMzdkNjAyZjM0Y2M0MGMyMDVmOWI5YjhhOGFmZjg4YjU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-12-25T10:20:48Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-12-25T10:20:48Z"}, "message": "Auto merge of #67524 - LukasKalbertodt:improve-into-iter-lint, r=matthewjasper\n\nGeneralize `array_into_iter` lint to also lint for boxed arrays\n\n`Box` is special in that a method call on a box can move the value out\nof the box. Thus, the same backwards-compatibility problem can arise\nfor boxed arrays as for simple arrays.\n\n---\n\nCC #66145\nr? @matthewjasper  (as you reviewed the first PR)", "tree": {"sha": "c37ae05bd5ed0869fd2b2973b1dfb55d701ae5f6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c37ae05bd5ed0869fd2b2973b1dfb55d701ae5f6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ed33453a37d602f34cc40c205f9b9b8a8aff88b5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ed33453a37d602f34cc40c205f9b9b8a8aff88b5", "html_url": "https://github.com/rust-lang/rust/commit/ed33453a37d602f34cc40c205f9b9b8a8aff88b5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ed33453a37d602f34cc40c205f9b9b8a8aff88b5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7bc1665730002a5368b4384613758c7ddc77db09", "url": "https://api.github.com/repos/rust-lang/rust/commits/7bc1665730002a5368b4384613758c7ddc77db09", "html_url": "https://github.com/rust-lang/rust/commit/7bc1665730002a5368b4384613758c7ddc77db09"}, {"sha": "f934b836ce3768915388880696256dffad2f00ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/f934b836ce3768915388880696256dffad2f00ca", "html_url": "https://github.com/rust-lang/rust/commit/f934b836ce3768915388880696256dffad2f00ca"}], "stats": {"total": 146, "additions": 140, "deletions": 6}, "files": [{"sha": "b6075d165dd05a4cfebdfd458f188a08b4693ce7", "filename": "src/librustc_lint/array_into_iter.rs", "status": "modified", "additions": 18, "deletions": 6, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/ed33453a37d602f34cc40c205f9b9b8a8aff88b5/src%2Flibrustc_lint%2Farray_into_iter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed33453a37d602f34cc40c205f9b9b8a8aff88b5/src%2Flibrustc_lint%2Farray_into_iter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Farray_into_iter.rs?ref=ed33453a37d602f34cc40c205f9b9b8a8aff88b5", "patch": "@@ -44,14 +44,26 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for ArrayIntoIter {\n             // argument.\n             let receiver_arg = &args[0];\n \n-            // Test if the original `self` type is an array type.\n-            match cx.tables.expr_ty(receiver_arg).kind {\n-                ty::Array(..) => {}\n-                _ => return,\n+            // Peel all `Box<_>` layers. We have to special case `Box` here as\n+            // `Box` is the only thing that values can be moved out of via\n+            // method call. `Box::new([1]).into_iter()` should trigger this\n+            // lint.\n+            let mut recv_ty = cx.tables.expr_ty(receiver_arg);\n+            let mut num_box_derefs = 0;\n+            while recv_ty.is_box() {\n+                num_box_derefs += 1;\n+                recv_ty = recv_ty.boxed_ty();\n+            }\n+\n+            // Make sure we found an array after peeling the boxes.\n+            if !matches!(recv_ty.kind, ty::Array(..)) {\n+                return;\n             }\n \n-            // Make sure that the first adjustment is an autoref coercion.\n-            match cx.tables.expr_adjustments(receiver_arg).get(0) {\n+            // Make sure that there is an autoref coercion at the expected\n+            // position. The first `num_box_derefs` adjustments are the derefs\n+            // of the box.\n+            match cx.tables.expr_adjustments(receiver_arg).get(num_box_derefs) {\n                 Some(Adjustment { kind: Adjust::Borrow(_), .. }) => {}\n                 _ => return,\n             }"}, {"sha": "c1aa3d70f77cc0381772ce6a6851ad9a02a58b52", "filename": "src/test/ui/iterators/into-iter-on-arrays-lint.fixed", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/ed33453a37d602f34cc40c205f9b9b8a8aff88b5/src%2Ftest%2Fui%2Fiterators%2Finto-iter-on-arrays-lint.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/ed33453a37d602f34cc40c205f9b9b8a8aff88b5/src%2Ftest%2Fui%2Fiterators%2Finto-iter-on-arrays-lint.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fiterators%2Finto-iter-on-arrays-lint.fixed?ref=ed33453a37d602f34cc40c205f9b9b8a8aff88b5", "patch": "@@ -19,6 +19,31 @@ fn main() {\n     //~^ WARNING this method call currently resolves to `<&[T] as IntoIterator>::into_iter`\n     //~| WARNING this was previously accepted by the compiler but is being phased out\n \n+    Box::new(small).iter();\n+    //~^ WARNING this method call currently resolves to `<&[T; N] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+    Box::new([1, 2]).iter();\n+    //~^ WARNING this method call currently resolves to `<&[T; N] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+    Box::new(big).iter();\n+    //~^ WARNING this method call currently resolves to `<&[T] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+    Box::new([0u8; 33]).iter();\n+    //~^ WARNING this method call currently resolves to `<&[T] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+\n+    Box::new(Box::new(small)).iter();\n+    //~^ WARNING this method call currently resolves to `<&[T; N] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+    Box::new(Box::new([1, 2])).iter();\n+    //~^ WARNING this method call currently resolves to `<&[T; N] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+    Box::new(Box::new(big)).iter();\n+    //~^ WARNING this method call currently resolves to `<&[T] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+    Box::new(Box::new([0u8; 33])).iter();\n+    //~^ WARNING this method call currently resolves to `<&[T] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n \n     // Expressions that should not\n     (&[1, 2]).into_iter();"}, {"sha": "afdf6cb7f442020b2d2037c4f34d9e7970954c93", "filename": "src/test/ui/iterators/into-iter-on-arrays-lint.rs", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/ed33453a37d602f34cc40c205f9b9b8a8aff88b5/src%2Ftest%2Fui%2Fiterators%2Finto-iter-on-arrays-lint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed33453a37d602f34cc40c205f9b9b8a8aff88b5/src%2Ftest%2Fui%2Fiterators%2Finto-iter-on-arrays-lint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fiterators%2Finto-iter-on-arrays-lint.rs?ref=ed33453a37d602f34cc40c205f9b9b8a8aff88b5", "patch": "@@ -19,6 +19,31 @@ fn main() {\n     //~^ WARNING this method call currently resolves to `<&[T] as IntoIterator>::into_iter`\n     //~| WARNING this was previously accepted by the compiler but is being phased out\n \n+    Box::new(small).into_iter();\n+    //~^ WARNING this method call currently resolves to `<&[T; N] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+    Box::new([1, 2]).into_iter();\n+    //~^ WARNING this method call currently resolves to `<&[T; N] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+    Box::new(big).into_iter();\n+    //~^ WARNING this method call currently resolves to `<&[T] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+    Box::new([0u8; 33]).into_iter();\n+    //~^ WARNING this method call currently resolves to `<&[T] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+\n+    Box::new(Box::new(small)).into_iter();\n+    //~^ WARNING this method call currently resolves to `<&[T; N] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+    Box::new(Box::new([1, 2])).into_iter();\n+    //~^ WARNING this method call currently resolves to `<&[T; N] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+    Box::new(Box::new(big)).into_iter();\n+    //~^ WARNING this method call currently resolves to `<&[T] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n+    Box::new(Box::new([0u8; 33])).into_iter();\n+    //~^ WARNING this method call currently resolves to `<&[T] as IntoIterator>::into_iter`\n+    //~| WARNING this was previously accepted by the compiler but is being phased out\n \n     // Expressions that should not\n     (&[1, 2]).into_iter();"}, {"sha": "e9cc427f6d8b76fbdf0d9deae5ab831d3f985a72", "filename": "src/test/ui/iterators/into-iter-on-arrays-lint.stderr", "status": "modified", "additions": 72, "deletions": 0, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/ed33453a37d602f34cc40c205f9b9b8a8aff88b5/src%2Ftest%2Fui%2Fiterators%2Finto-iter-on-arrays-lint.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ed33453a37d602f34cc40c205f9b9b8a8aff88b5/src%2Ftest%2Fui%2Fiterators%2Finto-iter-on-arrays-lint.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fiterators%2Finto-iter-on-arrays-lint.stderr?ref=ed33453a37d602f34cc40c205f9b9b8a8aff88b5", "patch": "@@ -35,3 +35,75 @@ LL |     [0u8; 33].into_iter();\n    = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n    = note: for more information, see issue #66145 <https://github.com/rust-lang/rust/issues/66145>\n \n+warning: this method call currently resolves to `<&[T; N] as IntoIterator>::into_iter` (due to autoref coercions), but that might change in the future when `IntoIterator` impls for arrays are added.\n+  --> $DIR/into-iter-on-arrays-lint.rs:22:21\n+   |\n+LL |     Box::new(small).into_iter();\n+   |                     ^^^^^^^^^ help: use `.iter()` instead of `.into_iter()` to avoid ambiguity: `iter`\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #66145 <https://github.com/rust-lang/rust/issues/66145>\n+\n+warning: this method call currently resolves to `<&[T; N] as IntoIterator>::into_iter` (due to autoref coercions), but that might change in the future when `IntoIterator` impls for arrays are added.\n+  --> $DIR/into-iter-on-arrays-lint.rs:25:22\n+   |\n+LL |     Box::new([1, 2]).into_iter();\n+   |                      ^^^^^^^^^ help: use `.iter()` instead of `.into_iter()` to avoid ambiguity: `iter`\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #66145 <https://github.com/rust-lang/rust/issues/66145>\n+\n+warning: this method call currently resolves to `<&[T] as IntoIterator>::into_iter` (due to autoref coercions), but that might change in the future when `IntoIterator` impls for arrays are added.\n+  --> $DIR/into-iter-on-arrays-lint.rs:28:19\n+   |\n+LL |     Box::new(big).into_iter();\n+   |                   ^^^^^^^^^ help: use `.iter()` instead of `.into_iter()` to avoid ambiguity: `iter`\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #66145 <https://github.com/rust-lang/rust/issues/66145>\n+\n+warning: this method call currently resolves to `<&[T] as IntoIterator>::into_iter` (due to autoref coercions), but that might change in the future when `IntoIterator` impls for arrays are added.\n+  --> $DIR/into-iter-on-arrays-lint.rs:31:25\n+   |\n+LL |     Box::new([0u8; 33]).into_iter();\n+   |                         ^^^^^^^^^ help: use `.iter()` instead of `.into_iter()` to avoid ambiguity: `iter`\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #66145 <https://github.com/rust-lang/rust/issues/66145>\n+\n+warning: this method call currently resolves to `<&[T; N] as IntoIterator>::into_iter` (due to autoref coercions), but that might change in the future when `IntoIterator` impls for arrays are added.\n+  --> $DIR/into-iter-on-arrays-lint.rs:35:31\n+   |\n+LL |     Box::new(Box::new(small)).into_iter();\n+   |                               ^^^^^^^^^ help: use `.iter()` instead of `.into_iter()` to avoid ambiguity: `iter`\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #66145 <https://github.com/rust-lang/rust/issues/66145>\n+\n+warning: this method call currently resolves to `<&[T; N] as IntoIterator>::into_iter` (due to autoref coercions), but that might change in the future when `IntoIterator` impls for arrays are added.\n+  --> $DIR/into-iter-on-arrays-lint.rs:38:32\n+   |\n+LL |     Box::new(Box::new([1, 2])).into_iter();\n+   |                                ^^^^^^^^^ help: use `.iter()` instead of `.into_iter()` to avoid ambiguity: `iter`\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #66145 <https://github.com/rust-lang/rust/issues/66145>\n+\n+warning: this method call currently resolves to `<&[T] as IntoIterator>::into_iter` (due to autoref coercions), but that might change in the future when `IntoIterator` impls for arrays are added.\n+  --> $DIR/into-iter-on-arrays-lint.rs:41:29\n+   |\n+LL |     Box::new(Box::new(big)).into_iter();\n+   |                             ^^^^^^^^^ help: use `.iter()` instead of `.into_iter()` to avoid ambiguity: `iter`\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #66145 <https://github.com/rust-lang/rust/issues/66145>\n+\n+warning: this method call currently resolves to `<&[T] as IntoIterator>::into_iter` (due to autoref coercions), but that might change in the future when `IntoIterator` impls for arrays are added.\n+  --> $DIR/into-iter-on-arrays-lint.rs:44:35\n+   |\n+LL |     Box::new(Box::new([0u8; 33])).into_iter();\n+   |                                   ^^^^^^^^^ help: use `.iter()` instead of `.into_iter()` to avoid ambiguity: `iter`\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #66145 <https://github.com/rust-lang/rust/issues/66145>\n+"}]}