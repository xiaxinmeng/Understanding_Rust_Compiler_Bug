{"sha": "6f38a15c7b5a57abf024e7e38cb0239e39037e9f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZmMzhhMTVjN2I1YTU3YWJmMDI0ZTdlMzhjYjAyMzllMzkwMzdlOWY=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-12-23T14:16:26Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-12-23T14:16:26Z"}, "message": "Rollup merge of #67527 - GuillaumeGomez:results-show-too-much, r=kinnison\n\nResults show too much\n\nFixes #67461.\n\nTo reproduce the current issue: search anything, then once the results appears, press escape. They should disappear then re-appear right away. This is because blurring an element triggers the \"change\" event.\n\nr? @kinnison", "tree": {"sha": "35b3fe51722d2d4728312f6a52b443064396e875", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/35b3fe51722d2d4728312f6a52b443064396e875"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6f38a15c7b5a57abf024e7e38cb0239e39037e9f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeAMw7CRBK7hj4Ov3rIwAAdHIIAK0nybSwXNfyJgE7fO50X9d5\nQIx6NlGO+3FiSpUUIFvRoVq8O9mHC6Rdft7c8xBcpHcWHpH0I0Cy+1ceYwQQjdkv\nOqxdNEmOfX+QktdErhz16uqp3t2PSoTV+PVr8bKP/juqWTd79y5IPC+XhZ5vvgqA\naBA5oDoTp9yzkeJMcIno6AihmgitGkTHcwtZ/fUuZG7AdcMGxy0LIeeakU6yT2cK\nlm1E1S6AWwMVG73oSgI7BDhVxkpAZSxoG1s4Gy1aG6Z27csiUk1g27N9zPlPYXch\n/a3taHS/Vl308h0t6KvXrZCrtJ3/nEIBo5dllRRL2GOgDJKmQ1J7e80uIm3WMzw=\n=loYz\n-----END PGP SIGNATURE-----\n", "payload": "tree 35b3fe51722d2d4728312f6a52b443064396e875\nparent 67c0f4e2c947cf87f330224d6b764d2777cc8b59\nparent 71ff18fb8965712cc0a35a9d968cdc41c6561386\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1577110586 +0100\ncommitter GitHub <noreply@github.com> 1577110586 +0100\n\nRollup merge of #67527 - GuillaumeGomez:results-show-too-much, r=kinnison\n\nResults show too much\n\nFixes #67461.\n\nTo reproduce the current issue: search anything, then once the results appears, press escape. They should disappear then re-appear right away. This is because blurring an element triggers the \"change\" event.\n\nr? @kinnison\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6f38a15c7b5a57abf024e7e38cb0239e39037e9f", "html_url": "https://github.com/rust-lang/rust/commit/6f38a15c7b5a57abf024e7e38cb0239e39037e9f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6f38a15c7b5a57abf024e7e38cb0239e39037e9f/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "67c0f4e2c947cf87f330224d6b764d2777cc8b59", "url": "https://api.github.com/repos/rust-lang/rust/commits/67c0f4e2c947cf87f330224d6b764d2777cc8b59", "html_url": "https://github.com/rust-lang/rust/commit/67c0f4e2c947cf87f330224d6b764d2777cc8b59"}, {"sha": "71ff18fb8965712cc0a35a9d968cdc41c6561386", "url": "https://api.github.com/repos/rust-lang/rust/commits/71ff18fb8965712cc0a35a9d968cdc41c6561386", "html_url": "https://github.com/rust-lang/rust/commit/71ff18fb8965712cc0a35a9d968cdc41c6561386"}], "stats": {"total": 91, "additions": 45, "deletions": 46}, "files": [{"sha": "8ccb74d6f15d3b7c025e8d0c8c8b3cf57f380d17", "filename": "src/librustdoc/html/static/main.js", "status": "modified", "additions": 45, "deletions": 46, "changes": 91, "blob_url": "https://github.com/rust-lang/rust/blob/6f38a15c7b5a57abf024e7e38cb0239e39037e9f/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/6f38a15c7b5a57abf024e7e38cb0239e39037e9f/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js?ref=6f38a15c7b5a57abf024e7e38cb0239e39037e9f", "patch": "@@ -138,6 +138,22 @@ function getSearchElement() {\n         }\n     }\n \n+    function showSearchResults(search) {\n+        if (search === null || typeof search === 'undefined') {\n+            search = getSearchElement();\n+        }\n+        addClass(main, \"hidden\");\n+        removeClass(search, \"hidden\");\n+    }\n+\n+    function hideSearchResults(search) {\n+        if (search === null || typeof search === 'undefined') {\n+            search = getSearchElement();\n+        }\n+        addClass(search, \"hidden\");\n+        removeClass(main, \"hidden\");\n+    }\n+\n     // used for special search precedence\n     var TY_PRIMITIVE = itemTypes.indexOf(\"primitive\");\n     var TY_KEYWORD = itemTypes.indexOf(\"keyword\");\n@@ -169,8 +185,7 @@ function getSearchElement() {\n         if (ev !== null && search && !hasClass(search, \"hidden\") && ev.newURL) {\n             // This block occurs when clicking on an element in the navbar while\n             // in a search.\n-            addClass(search, \"hidden\");\n-            removeClass(main, \"hidden\");\n+            hideSearchResults(search);\n             var hash = ev.newURL.slice(ev.newURL.indexOf(\"#\") + 1);\n             if (browserSupportsHistoryApi()) {\n                 history.replaceState(hash, \"\", \"?search=#\" + hash);\n@@ -331,8 +346,7 @@ function getSearchElement() {\n             displayHelp(false, ev, help);\n         } else if (hasClass(search, \"hidden\") === false) {\n             ev.preventDefault();\n-            addClass(search, \"hidden\");\n-            removeClass(main, \"hidden\");\n+            hideSearchResults(search);\n             document.title = titleBeforeSearch;\n         }\n         defocusSearchBar();\n@@ -390,8 +404,8 @@ function getSearchElement() {\n         return null;\n     }\n \n-    document.onkeypress = handleShortcut;\n-    document.onkeydown = handleShortcut;\n+    document.addEventListener(\"keypress\", handleShortcut);\n+    document.addEventListener(\"keydown\", handleShortcut);\n \n     var handleSourceHighlight = (function() {\n         var prev_line_id = 0;\n@@ -430,7 +444,7 @@ function getSearchElement() {\n         }\n     })();\n \n-    document.onclick = function(ev) {\n+    document.addEventListener(\"click\", function(ev) {\n         if (hasClass(ev.target, \"collapse-toggle\")) {\n             collapseDocs(ev.target, \"toggle\");\n         } else if (hasClass(ev.target.parentNode, \"collapse-toggle\")) {\n@@ -452,7 +466,7 @@ function getSearchElement() {\n                 expandSection(a.hash.replace(/^#/, \"\"));\n             }\n         }\n-    };\n+    });\n \n     var x = document.getElementsByClassName(\"version-selector\");\n     if (x.length > 0) {\n@@ -1264,8 +1278,7 @@ function getSearchElement() {\n                 }\n                 dst = dst[0];\n                 if (window.location.pathname === dst.pathname) {\n-                    addClass(getSearchElement(), \"hidden\");\n-                    removeClass(main, \"hidden\");\n+                    hideSearchResults();\n                     document.location.href = dst.href;\n                 }\n             };\n@@ -1340,8 +1353,6 @@ function getSearchElement() {\n                     e.preventDefault();\n                 } else if (e.which === 16) { // shift\n                     // Does nothing, it's just to avoid losing \"focus\" on the highlighted element.\n-                } else if (e.which === 27) { // escape\n-                    handleEscape(e);\n                 } else if (actives[currentTab].length > 0) {\n                     removeClass(actives[currentTab][0], \"highlighted\");\n                 }\n@@ -1491,10 +1502,9 @@ function getSearchElement() {\n                 \"</div><div id=\\\"results\\\">\" +\n                 ret_others[0] + ret_in_args[0] + ret_returned[0] + \"</div>\";\n \n-            addClass(main, \"hidden\");\n             var search = getSearchElement();\n-            removeClass(search, \"hidden\");\n             search.innerHTML = output;\n+            showSearchResults(search);\n             var tds = search.getElementsByTagName(\"td\");\n             var td_width = 0;\n             if (tds.length > 0) {\n@@ -1699,13 +1709,7 @@ function getSearchElement() {\n                     if (browserSupportsHistoryApi()) {\n                         history.replaceState(\"\", window.currentCrate + \" - Rust\", \"?search=\");\n                     }\n-                    if (hasClass(main, \"content\")) {\n-                        removeClass(main, \"hidden\");\n-                    }\n-                    var search_c = getSearchElement();\n-                    if (hasClass(search_c, \"content\")) {\n-                        addClass(search_c, \"hidden\");\n-                    }\n+                    hideSearchResults();\n                 } else {\n                     searchTimeout = setTimeout(search, 500);\n                 }\n@@ -1718,6 +1722,10 @@ function getSearchElement() {\n                 search();\n             };\n             search_input.onchange = function(e) {\n+                if (e.target !== document.activeElement) {\n+                    // To prevent doing anything when it's from a blur event.\n+                    return;\n+                }\n                 // Do NOT e.preventDefault() here. It will prevent pasting.\n                 clearTimeout(searchTimeout);\n                 // zero-timeout necessary here because at the time of event handler execution the\n@@ -1741,19 +1749,8 @@ function getSearchElement() {\n                 // Store the previous <title> so we can revert back to it later.\n                 var previousTitle = document.title;\n \n-                window.onpopstate = function(e) {\n+                window.addEventListener(\"popstate\", function(e) {\n                     var params = getQueryStringParams();\n-                    // When browsing back from search results the main page\n-                    // visibility must be reset.\n-                    if (!params.search) {\n-                        if (hasClass(main, \"content\")) {\n-                            removeClass(main, \"hidden\");\n-                        }\n-                        var search_c = getSearchElement();\n-                        if (hasClass(search_c, \"content\")) {\n-                            addClass(search_c, \"hidden\");\n-                        }\n-                    }\n                     // Revert to the previous title manually since the History\n                     // API ignores the title parameter.\n                     document.title = previousTitle;\n@@ -1765,18 +1762,21 @@ function getSearchElement() {\n                     // perform the search. This will empty the bar if there's\n                     // nothing there, which lets you really go back to a\n                     // previous state with nothing in the bar.\n-                    if (params.search) {\n+                    if (params.search && params.search.length > 0) {\n                         search_input.value = params.search;\n+                        // Some browsers fire \"onpopstate\" for every page load\n+                        // (Chrome), while others fire the event only when actually\n+                        // popping a state (Firefox), which is why search() is\n+                        // called both here and at the end of the startSearch()\n+                        // function.\n+                        search(e);\n                     } else {\n                         search_input.value = \"\";\n+                        // When browsing back from search results the main page\n+                        // visibility must be reset.\n+                        hideSearchResults();\n                     }\n-                    // Some browsers fire \"onpopstate\" for every page load\n-                    // (Chrome), while others fire the event only when actually\n-                    // popping a state (Firefox), which is why search() is\n-                    // called both here and at the end of the startSearch()\n-                    // function.\n-                    search();\n-                };\n+                });\n             }\n             search();\n         }\n@@ -2522,9 +2522,9 @@ function getSearchElement() {\n     }\n \n     function putBackSearch(search_input) {\n-        if (search_input.value !== \"\") {\n-            addClass(main, \"hidden\");\n-            removeClass(getSearchElement(), \"hidden\");\n+        var search = getSearchElement();\n+        if (search_input.value !== \"\" && hasClass(search, \"hidden\")) {\n+            showSearchResults(search);\n             if (browserSupportsHistoryApi()) {\n                 history.replaceState(search_input.value,\n                                      \"\",\n@@ -2541,10 +2541,9 @@ function getSearchElement() {\n \n     var params = getQueryStringParams();\n     if (params && params.search) {\n-        addClass(main, \"hidden\");\n         var search = getSearchElement();\n-        removeClass(search, \"hidden\");\n         search.innerHTML = \"<h3 style=\\\"text-align: center;\\\">Loading search results...</h3>\";\n+        showSearchResults(search);\n     }\n \n     var sidebar_menu = document.getElementsByClassName(\"sidebar-menu\")[0];"}]}