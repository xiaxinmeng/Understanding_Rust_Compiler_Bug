{"sha": "55ff45a5c25c49e665a9459b8d6ea03ae2c44476", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU1ZmY0NWE1YzI1YzQ5ZTY2NWE5NDU5YjhkNmVhMDNhZTJjNDQ0NzY=", "commit": {"author": {"name": "David Tolnay", "email": "dtolnay@gmail.com", "date": "2021-07-09T03:24:29Z"}, "committer": {"name": "David Tolnay", "email": "dtolnay@gmail.com", "date": "2021-07-18T21:08:34Z"}, "message": "Support negative numbers in Literal::from_str", "tree": {"sha": "454ce7299b38c0e9552a98c023a5a0ab5a271ebf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/454ce7299b38c0e9552a98c023a5a0ab5a271ebf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/55ff45a5c25c49e665a9459b8d6ea03ae2c44476", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEERijF2Cz/ZdaBZKeK+boUO5X/bYIFAmD0mFIACgkQ+boUO5X/\nbYJwMA/+Id/qRbfDerHwXpNLoPTxY5NnLVNw1BUQ/zGh03/942xOgOcic3jKOD2y\n0t44VG5hx4lC+yUH/JKLA3fBQ5Wqzm4HyUB4hkf5X2mTnPwBSEt0PTApJ2RuAvkK\nxCsoqkI2WFGUNexDFyTISoUZA35ODgsN4totwxhHMXmB40llZVNEBB0f9LZVRUTV\nrZYTGWuG9KJU4lYQh+6hkc4PL+AT5u4yd73MzWz3whxmXE7rSwqKNcGSrvK1lWI4\ngqFY8y3u5Dp9KoFh8QMRkJuDxgKxudpyupzWZJIpfS7J0bvuvBZSB1CEKcqv5zr3\nE1x+FYyAivL2rYm/pbz6QF/AKkNg/Q7czXLN6OFA9IIwlKZiVvVdxZ+YJZa2xhmB\nYNmCefeGwX47i8au7zBG80cihtQdk7+EjMsuowSKWj6O9PtzTFuNgWmjegKHk5KG\nnLnPjrkyo97Nd5HtYmm0Wm+T9SDqFHBHAbg3BAdhT04JdaeGYu6gVlXfIQZLXq+3\n3G2UVi2Wft/oeii0d22dh8jQCTR31bJFBNX7D1LCA0avEnfTQsUWEjdBUQt5+yUQ\ncdlr5cMi3k8K8t5hwM+0CmF3eNtpxJ4qOAC9p0DQtTYL/Cnmx4lFCKxGvkotSGZN\njhwDInpboDh+1IyjEaQuvFBQyplavkFk1CAg82MOFnkzzC0ELOE=\n=ts2l\n-----END PGP SIGNATURE-----", "payload": "tree 454ce7299b38c0e9552a98c023a5a0ab5a271ebf\nparent 331da5820cfeb937dcdd76192d97a5fc4dd115c8\nauthor David Tolnay <dtolnay@gmail.com> 1625801069 -0700\ncommitter David Tolnay <dtolnay@gmail.com> 1626642514 -0700\n\nSupport negative numbers in Literal::from_str\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/55ff45a5c25c49e665a9459b8d6ea03ae2c44476", "html_url": "https://github.com/rust-lang/rust/commit/55ff45a5c25c49e665a9459b8d6ea03ae2c44476", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/55ff45a5c25c49e665a9459b8d6ea03ae2c44476/comments", "author": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "331da5820cfeb937dcdd76192d97a5fc4dd115c8", "url": "https://api.github.com/repos/rust-lang/rust/commits/331da5820cfeb937dcdd76192d97a5fc4dd115c8", "html_url": "https://github.com/rust-lang/rust/commit/331da5820cfeb937dcdd76192d97a5fc4dd115c8"}], "stats": {"total": 78, "additions": 56, "deletions": 22}, "files": [{"sha": "8404e16fd1eb416c082d0af6fa8324c0b5c01d07", "filename": "compiler/rustc_expand/src/proc_macro_server.rs", "status": "modified", "additions": 41, "deletions": 22, "changes": 63, "blob_url": "https://github.com/rust-lang/rust/blob/55ff45a5c25c49e665a9459b8d6ea03ae2c44476/compiler%2Frustc_expand%2Fsrc%2Fproc_macro_server.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55ff45a5c25c49e665a9459b8d6ea03ae2c44476/compiler%2Frustc_expand%2Fsrc%2Fproc_macro_server.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fproc_macro_server.rs?ref=55ff45a5c25c49e665a9459b8d6ea03ae2c44476", "patch": "@@ -1,7 +1,7 @@\n use crate::base::{ExtCtxt, ResolverExpand};\n \n use rustc_ast as ast;\n-use rustc_ast::token::{self, Nonterminal, NtIdent, TokenKind};\n+use rustc_ast::token::{self, Nonterminal, NtIdent};\n use rustc_ast::tokenstream::{self, CanSynthesizeMissingTokens};\n use rustc_ast::tokenstream::{DelimSpan, Spacing::*, TokenStream, TreeAndSpacing};\n use rustc_ast_pretty::pprust;\n@@ -537,30 +537,49 @@ impl server::Ident for Rustc<'_> {\n \n impl server::Literal for Rustc<'_> {\n     fn from_str(&mut self, s: &str) -> Result<Self::Literal, ()> {\n-        let override_span = None;\n-        let stream = parse_stream_from_source_str(\n-            FileName::proc_macro_source_code(s),\n-            s.to_owned(),\n-            self.sess,\n-            override_span,\n-        );\n-        if stream.len() != 1 {\n-            return Err(());\n-        }\n-        let tree = stream.into_trees().next().unwrap();\n-        let token = match tree {\n-            tokenstream::TokenTree::Token(token) => token,\n-            tokenstream::TokenTree::Delimited { .. } => return Err(()),\n+        let name = FileName::proc_macro_source_code(s);\n+        let mut parser = rustc_parse::new_parser_from_source_str(self.sess, name, s.to_owned());\n+\n+        let first_span = parser.token.span.data();\n+        let minus_present = parser.eat(&token::BinOp(token::Minus));\n+\n+        let lit_span = parser.token.span.data();\n+        let mut lit = match parser.token.kind {\n+            token::Literal(lit) => lit,\n+            _ => return Err(()),\n         };\n-        let span_data = token.span.data();\n-        if (span_data.hi.0 - span_data.lo.0) as usize != s.len() {\n-            // There is a comment or whitespace adjacent to the literal.\n+\n+        // Check no comment or whitespace surrounding the (possibly negative)\n+        // literal, or more tokens after it.\n+        if (lit_span.hi.0 - first_span.lo.0) as usize != s.len() {\n             return Err(());\n         }\n-        let lit = match token.kind {\n-            TokenKind::Literal(lit) => lit,\n-            _ => return Err(()),\n-        };\n+\n+        if minus_present {\n+            // If minus is present, check no comment or whitespace in between it\n+            // and the literal token.\n+            if first_span.hi.0 != lit_span.lo.0 {\n+                return Err(());\n+            }\n+\n+            // Check literal is a kind we allow to be negated in a proc macro token.\n+            match lit.kind {\n+                token::LitKind::Bool\n+                | token::LitKind::Byte\n+                | token::LitKind::Char\n+                | token::LitKind::Str\n+                | token::LitKind::StrRaw(_)\n+                | token::LitKind::ByteStr\n+                | token::LitKind::ByteStrRaw(_)\n+                | token::LitKind::Err => return Err(()),\n+                token::LitKind::Integer | token::LitKind::Float => {}\n+            }\n+\n+            // Synthesize a new symbol that includes the minus sign.\n+            let symbol = Symbol::intern(&s[..1 + lit.symbol.len()]);\n+            lit = token::Lit::new(lit.kind, symbol, lit.suffix);\n+        }\n+\n         Ok(Literal { lit, span: self.call_site })\n     }\n     fn debug_kind(&mut self, literal: &Self::Literal) -> String {"}, {"sha": "6c2f69c4b671fa1b7cb4580cfb73179954e68638", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/55ff45a5c25c49e665a9459b8d6ea03ae2c44476/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55ff45a5c25c49e665a9459b8d6ea03ae2c44476/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=55ff45a5c25c49e665a9459b8d6ea03ae2c44476", "patch": "@@ -1588,6 +1588,10 @@ impl Symbol {\n         self.0.as_u32()\n     }\n \n+    pub fn len(self) -> usize {\n+        with_interner(|interner| interner.get(self).len())\n+    }\n+\n     pub fn is_empty(self) -> bool {\n         self == kw::Empty\n     }"}, {"sha": "a304c5e81a4bbba07c8bcdf6562d7d423bdcc4fa", "filename": "src/test/ui/proc-macro/auxiliary/api/parse.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/55ff45a5c25c49e665a9459b8d6ea03ae2c44476/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Fapi%2Fparse.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55ff45a5c25c49e665a9459b8d6ea03ae2c44476/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Fapi%2Fparse.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Fapi%2Fparse.rs?ref=55ff45a5c25c49e665a9459b8d6ea03ae2c44476", "patch": "@@ -1,9 +1,15 @@\n use proc_macro::Literal;\n \n pub fn test() {\n+    test_display_literal();\n     test_parse_literal();\n }\n \n+fn test_display_literal() {\n+    assert_eq!(Literal::isize_unsuffixed(-10).to_string(), \"- 10\");\n+    assert_eq!(Literal::isize_suffixed(-10).to_string(), \"- 10isize\");\n+}\n+\n fn test_parse_literal() {\n     assert_eq!(\"1\".parse::<Literal>().unwrap().to_string(), \"1\");\n     assert_eq!(\"1.0\".parse::<Literal>().unwrap().to_string(), \"1.0\");\n@@ -12,12 +18,17 @@ fn test_parse_literal() {\n     assert_eq!(\"b\\\"\\\"\".parse::<Literal>().unwrap().to_string(), \"b\\\"\\\"\");\n     assert_eq!(\"r##\\\"\\\"##\".parse::<Literal>().unwrap().to_string(), \"r##\\\"\\\"##\");\n     assert_eq!(\"10ulong\".parse::<Literal>().unwrap().to_string(), \"10ulong\");\n+    assert_eq!(\"-10ulong\".parse::<Literal>().unwrap().to_string(), \"- 10ulong\");\n \n+    assert!(\"true\".parse::<Literal>().is_err());\n+    assert!(\".8\".parse::<Literal>().is_err());\n     assert!(\"0 1\".parse::<Literal>().is_err());\n     assert!(\"'a\".parse::<Literal>().is_err());\n     assert!(\" 0\".parse::<Literal>().is_err());\n     assert!(\"0 \".parse::<Literal>().is_err());\n     assert!(\"/* comment */0\".parse::<Literal>().is_err());\n     assert!(\"0/* comment */\".parse::<Literal>().is_err());\n     assert!(\"0// comment\".parse::<Literal>().is_err());\n+    assert!(\"- 10\".parse::<Literal>().is_err());\n+    assert!(\"-'x'\".parse::<Literal>().is_err());\n }"}]}