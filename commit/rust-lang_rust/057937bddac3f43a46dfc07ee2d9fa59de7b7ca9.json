{"sha": "057937bddac3f43a46dfc07ee2d9fa59de7b7ca9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA1NzkzN2JkZGFjM2Y0M2E0NmRmYzA3ZWUyZDlmYTU5ZGU3YjdjYTk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-12-13T10:52:29Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-12-13T10:52:29Z"}, "message": "Auto merge of #79668 - coolreader18:recover-const-impl, r=petrochenkov\n\nRecover on `const impl<> X for Y`\n\n`@leonardo-m` mentioned that `const impl Foo for Bar` could be recovered from in #79287.\n\nI'm not sure about the error strings as they are, I think it should probably be something like the error that `expected_one_of_not_found` makes + the suggestion to flip the keywords, but I'm not sure how exactly to do that. Also, I decided not to try to handle `const unsafe impl` or `unsafe const impl` cause I figured that `unsafe impl const` would be pretty rare anyway (if it's even valid?), and it wouldn't be worth making the code more messy.", "tree": {"sha": "70c2b453a1dc7a1ab5fcd1b5e81f105eb253a2bc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/70c2b453a1dc7a1ab5fcd1b5e81f105eb253a2bc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9", "html_url": "https://github.com/rust-lang/rust/commit/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d149b6579fb118ea75b16cb7a6afa62695d88992", "url": "https://api.github.com/repos/rust-lang/rust/commits/d149b6579fb118ea75b16cb7a6afa62695d88992", "html_url": "https://github.com/rust-lang/rust/commit/d149b6579fb118ea75b16cb7a6afa62695d88992"}, {"sha": "1e27b65d8e877fd33ff8de20c359282577b8956c", "url": "https://api.github.com/repos/rust-lang/rust/commits/1e27b65d8e877fd33ff8de20c359282577b8956c", "html_url": "https://github.com/rust-lang/rust/commit/1e27b65d8e877fd33ff8de20c359282577b8956c"}], "stats": {"total": 102, "additions": 99, "deletions": 3}, "files": [{"sha": "4c92c198679f99ad8cf09883cba6bd488d5fac20", "filename": "compiler/rustc_parse/src/parser/item.rs", "status": "modified", "additions": 38, "deletions": 3, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs?ref=057937bddac3f43a46dfc07ee2d9fa59de7b7ca9", "patch": "@@ -247,9 +247,14 @@ impl<'a> Parser<'a> {\n             (ident, ItemKind::Static(ty, m, expr))\n         } else if let Const::Yes(const_span) = self.parse_constness() {\n             // CONST ITEM\n-            self.recover_const_mut(const_span);\n-            let (ident, ty, expr) = self.parse_item_global(None)?;\n-            (ident, ItemKind::Const(def(), ty, expr))\n+            if self.token.is_keyword(kw::Impl) {\n+                // recover from `const impl`, suggest `impl const`\n+                self.recover_const_impl(const_span, attrs, def())?\n+            } else {\n+                self.recover_const_mut(const_span);\n+                let (ident, ty, expr) = self.parse_item_global(None)?;\n+                (ident, ItemKind::Const(def(), ty, expr))\n+            }\n         } else if self.check_keyword(kw::Trait) || self.check_auto_or_unsafe_trait_item() {\n             // TRAIT ITEM\n             self.parse_item_trait(attrs, lo)?\n@@ -988,6 +993,36 @@ impl<'a> Parser<'a> {\n         }\n     }\n \n+    /// Recover on `const impl` with `const` already eaten.\n+    fn recover_const_impl(\n+        &mut self,\n+        const_span: Span,\n+        attrs: &mut Vec<Attribute>,\n+        defaultness: Defaultness,\n+    ) -> PResult<'a, ItemInfo> {\n+        let impl_span = self.token.span;\n+        let mut err = self.expected_ident_found();\n+        let mut impl_info = self.parse_item_impl(attrs, defaultness)?;\n+        match impl_info.1 {\n+            // only try to recover if this is implementing a trait for a type\n+            ItemKind::Impl { of_trait: Some(ref trai), ref mut constness, .. } => {\n+                *constness = Const::Yes(const_span);\n+\n+                let before_trait = trai.path.span.shrink_to_lo();\n+                let const_up_to_impl = const_span.with_hi(impl_span.lo());\n+                err.multipart_suggestion(\n+                    \"you might have meant to write a const trait impl\",\n+                    vec![(const_up_to_impl, \"\".to_owned()), (before_trait, \"const \".to_owned())],\n+                    Applicability::MaybeIncorrect,\n+                )\n+                .emit();\n+            }\n+            ItemKind::Impl { .. } => return Err(err),\n+            _ => unreachable!(),\n+        }\n+        Ok(impl_info)\n+    }\n+\n     /// Parse `[\"const\" | (\"static\" \"mut\"?)] $ident \":\" $ty (= $expr)?` with\n     /// `[\"const\" | (\"static\" \"mut\"?)]` already parsed and stored in `m`.\n     ///"}, {"sha": "936c90e88aaeecdd4d75270ee0865e98c0cce5b7", "filename": "src/test/ui/rfc-2632-const-trait-impl/const-impl-norecover.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-impl-norecover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-impl-norecover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-impl-norecover.rs?ref=057937bddac3f43a46dfc07ee2d9fa59de7b7ca9", "patch": "@@ -0,0 +1,13 @@\n+#![feature(const_trait_impl)]\n+#![allow(incomplete_features)]\n+\n+struct Foo;\n+\n+const impl Foo { //~ ERROR: expected identifier, found keyword\n+    fn bar() {}\n+}\n+\n+fn main() {\n+     // shouldn't error here because we shouldn't have been able to recover above\n+     Foo::bar();\n+}"}, {"sha": "612511a479956d388544f40d7ba023fb7c77d1c4", "filename": "src/test/ui/rfc-2632-const-trait-impl/const-impl-norecover.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-impl-norecover.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-impl-norecover.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-impl-norecover.stderr?ref=057937bddac3f43a46dfc07ee2d9fa59de7b7ca9", "patch": "@@ -0,0 +1,8 @@\n+error: expected identifier, found keyword `impl`\n+  --> $DIR/const-impl-norecover.rs:6:7\n+   |\n+LL | const impl Foo {\n+   |       ^^^^ expected identifier, found keyword\n+\n+error: aborting due to previous error\n+"}, {"sha": "fd3dd2cef9d1c9c8ba95d8d6e51ec9fceff8f1e1", "filename": "src/test/ui/rfc-2632-const-trait-impl/const-impl-recovery.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-impl-recovery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-impl-recovery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-impl-recovery.rs?ref=057937bddac3f43a46dfc07ee2d9fa59de7b7ca9", "patch": "@@ -0,0 +1,16 @@\n+#![feature(const_trait_impl)]\n+#![allow(incomplete_features)]\n+\n+trait Foo {}\n+\n+const impl Foo for i32 {} //~ ERROR: expected identifier, found keyword\n+\n+trait Bar {}\n+\n+const impl<T: Foo> Bar for T {} //~ ERROR: expected identifier, found keyword\n+\n+const fn still_implements<T: Bar>() {}\n+\n+const _: () = still_implements::<i32>();\n+\n+fn main() {}"}, {"sha": "84fb619dc9648815d6c83b6c3bb4054c3838e787", "filename": "src/test/ui/rfc-2632-const-trait-impl/const-impl-recovery.stderr", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-impl-recovery.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/057937bddac3f43a46dfc07ee2d9fa59de7b7ca9/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-impl-recovery.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-impl-recovery.stderr?ref=057937bddac3f43a46dfc07ee2d9fa59de7b7ca9", "patch": "@@ -0,0 +1,24 @@\n+error: expected identifier, found keyword `impl`\n+  --> $DIR/const-impl-recovery.rs:6:7\n+   |\n+LL | const impl Foo for i32 {}\n+   |       ^^^^ expected identifier, found keyword\n+   |\n+help: you might have meant to write a const trait impl\n+   |\n+LL | impl const Foo for i32 {}\n+   |--    ^^^^^\n+\n+error: expected identifier, found keyword `impl`\n+  --> $DIR/const-impl-recovery.rs:10:7\n+   |\n+LL | const impl<T: Foo> Bar for T {}\n+   |       ^^^^ expected identifier, found keyword\n+   |\n+help: you might have meant to write a const trait impl\n+   |\n+LL | impl<T: Foo> const Bar for T {}\n+   |--            ^^^^^\n+\n+error: aborting due to 2 previous errors\n+"}]}