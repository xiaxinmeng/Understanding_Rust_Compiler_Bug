{"sha": "3f977baf34ed32c64c4ff185b4ef6ae2c2948afc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNmOTc3YmFmMzRlZDMyYzY0YzRmZjE4NWI0ZWY2YWUyYzI5NDhhZmM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-08-09T04:03:49Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-08-09T04:03:49Z"}, "message": "Auto merge of #43728 - zackmdavis:fnused, r=eddyb\n\n#[must_use] for functions\n\nThis implements [RFC 1940](https://github.com/rust-lang/rfcs/pull/1940).\n\nThe RFC and discussion thereof seem to suggest that tagging `PartialEq::eq` and friends as `#[must_use]` would automatically lint for unused comparisons, but it doesn't work out that way (at least the way I've implemented it): unused `.eq` method calls get linted, but not `==` expressions. (The lint operates on the HIR, which sees binary operations as their own thing, even if they ultimately just call `.eq` _&c._.)\n\nWhat do _you_ think??\n\nResolves #43302.", "tree": {"sha": "e9ce3edd355afc9fdfba987d21d27fdc9d91540d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e9ce3edd355afc9fdfba987d21d27fdc9d91540d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3f977baf34ed32c64c4ff185b4ef6ae2c2948afc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3f977baf34ed32c64c4ff185b4ef6ae2c2948afc", "html_url": "https://github.com/rust-lang/rust/commit/3f977baf34ed32c64c4ff185b4ef6ae2c2948afc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3f977baf34ed32c64c4ff185b4ef6ae2c2948afc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0f9317d37e5469a8ce3b77ed49dd3eb315c8c859", "url": "https://api.github.com/repos/rust-lang/rust/commits/0f9317d37e5469a8ce3b77ed49dd3eb315c8c859", "html_url": "https://github.com/rust-lang/rust/commit/0f9317d37e5469a8ce3b77ed49dd3eb315c8c859"}, {"sha": "f5ac228b366b96892fb2c950fa1269d437df8360", "url": "https://api.github.com/repos/rust-lang/rust/commits/f5ac228b366b96892fb2c950fa1269d437df8360", "html_url": "https://github.com/rust-lang/rust/commit/f5ac228b366b96892fb2c950fa1269d437df8360"}], "stats": {"total": 88, "additions": 79, "deletions": 9}, "files": [{"sha": "ec6525485f7a1d2a5107d4490f90ae8370936d51", "filename": "src/libcore/cmp.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/3f977baf34ed32c64c4ff185b4ef6ae2c2948afc/src%2Flibcore%2Fcmp.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f977baf34ed32c64c4ff185b4ef6ae2c2948afc/src%2Flibcore%2Fcmp.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fcmp.rs?ref=3f977baf34ed32c64c4ff185b4ef6ae2c2948afc", "patch": "@@ -110,11 +110,13 @@ use self::Ordering::*;\n pub trait PartialEq<Rhs: ?Sized = Self> {\n     /// This method tests for `self` and `other` values to be equal, and is used\n     /// by `==`.\n+    #[must_use]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     fn eq(&self, other: &Rhs) -> bool;\n \n     /// This method tests for `!=`.\n     #[inline]\n+    #[must_use]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     fn ne(&self, other: &Rhs) -> bool { !self.eq(other) }\n }\n@@ -625,6 +627,7 @@ pub trait PartialOrd<Rhs: ?Sized = Self>: PartialEq<Rhs> {\n     /// let result = std::f64::NAN.partial_cmp(&1.0);\n     /// assert_eq!(result, None);\n     /// ```\n+    #[must_use]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     fn partial_cmp(&self, other: &Rhs) -> Option<Ordering>;\n \n@@ -640,6 +643,7 @@ pub trait PartialOrd<Rhs: ?Sized = Self>: PartialEq<Rhs> {\n     /// assert_eq!(result, false);\n     /// ```\n     #[inline]\n+    #[must_use]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     fn lt(&self, other: &Rhs) -> bool {\n         match self.partial_cmp(other) {\n@@ -661,6 +665,7 @@ pub trait PartialOrd<Rhs: ?Sized = Self>: PartialEq<Rhs> {\n     /// assert_eq!(result, true);\n     /// ```\n     #[inline]\n+    #[must_use]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     fn le(&self, other: &Rhs) -> bool {\n         match self.partial_cmp(other) {\n@@ -681,6 +686,7 @@ pub trait PartialOrd<Rhs: ?Sized = Self>: PartialEq<Rhs> {\n     /// assert_eq!(result, false);\n     /// ```\n     #[inline]\n+    #[must_use]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     fn gt(&self, other: &Rhs) -> bool {\n         match self.partial_cmp(other) {\n@@ -702,6 +708,7 @@ pub trait PartialOrd<Rhs: ?Sized = Self>: PartialEq<Rhs> {\n     /// assert_eq!(result, true);\n     /// ```\n     #[inline]\n+    #[must_use]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     fn ge(&self, other: &Rhs) -> bool {\n         match self.partial_cmp(other) {"}, {"sha": "ba17df4cdca4b930759bd8dd547ce93f1686209d", "filename": "src/librustc_lint/unused.rs", "status": "modified", "additions": 25, "deletions": 9, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/3f977baf34ed32c64c4ff185b4ef6ae2c2948afc/src%2Flibrustc_lint%2Funused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f977baf34ed32c64c4ff185b4ef6ae2c2948afc/src%2Flibrustc_lint%2Funused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Funused.rs?ref=3f977baf34ed32c64c4ff185b4ef6ae2c2948afc", "patch": "@@ -145,22 +145,38 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for UnusedResults {\n         }\n \n         let t = cx.tables.expr_ty(&expr);\n-        let warned = match t.sty {\n-            ty::TyTuple(ref tys, _) if tys.is_empty() => return,\n-            ty::TyNever => return,\n-            ty::TyBool => return,\n-            ty::TyAdt(def, _) => check_must_use(cx, def.did, s.span),\n+        let ty_warned = match t.sty {\n+            ty::TyAdt(def, _) => check_must_use(cx, def.did, s.span, \"\"),\n             _ => false,\n         };\n-        if !warned {\n+\n+        let mut fn_warned = false;\n+        let maybe_def = match expr.node {\n+            hir::ExprCall(ref callee, _) => {\n+                match callee.node {\n+                    hir::ExprPath(ref qpath) => Some(cx.tables.qpath_def(qpath, callee.id)),\n+                    _ => None\n+                }\n+            },\n+            hir::ExprMethodCall(..) => {\n+                cx.tables.type_dependent_defs.get(&expr.id).cloned()\n+            },\n+            _ => { None }\n+        };\n+        if let Some(def) = maybe_def {\n+            let def_id = def.def_id();\n+            fn_warned = check_must_use(cx, def_id, s.span, \"return value of \");\n+        }\n+\n+        if !(ty_warned || fn_warned) {\n             cx.span_lint(UNUSED_RESULTS, s.span, \"unused result\");\n         }\n \n-        fn check_must_use(cx: &LateContext, def_id: DefId, sp: Span) -> bool {\n+        fn check_must_use(cx: &LateContext, def_id: DefId, sp: Span, describe_path: &str) -> bool {\n             for attr in cx.tcx.get_attrs(def_id).iter() {\n                 if attr.check_name(\"must_use\") {\n-                    let mut msg = format!(\"unused `{}` which must be used\",\n-                                          cx.tcx.item_path_str(def_id));\n+                    let mut msg = format!(\"unused {}`{}` which must be used\",\n+                                          describe_path, cx.tcx.item_path_str(def_id));\n                     // check for #[must_use=\"...\"]\n                     if let Some(s) = attr.value_str() {\n                         msg.push_str(\": \");"}, {"sha": "ea2197f3fd1a0cb24925cedddac29895e79e2c48", "filename": "src/test/ui/lint/fn_must_use.rs", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/3f977baf34ed32c64c4ff185b4ef6ae2c2948afc/src%2Ftest%2Fui%2Flint%2Ffn_must_use.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f977baf34ed32c64c4ff185b4ef6ae2c2948afc/src%2Ftest%2Fui%2Flint%2Ffn_must_use.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Ffn_must_use.rs?ref=3f977baf34ed32c64c4ff185b4ef6ae2c2948afc", "patch": "@@ -0,0 +1,33 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+\n+struct MyStruct {\n+    n: usize\n+}\n+\n+impl MyStruct {\n+    #[must_use]\n+    fn need_to_use_this_method_value(&self) -> usize {\n+        self.n\n+    }\n+}\n+\n+#[must_use=\"it's important\"]\n+fn need_to_use_this_value() -> bool {\n+    false\n+}\n+\n+fn main() {\n+    need_to_use_this_value();\n+\n+    let m = MyStruct { n: 2 };\n+    m.need_to_use_this_method_value();\n+}"}, {"sha": "7057c8e9aaad1663872df8f935100172d42e365a", "filename": "src/test/ui/lint/fn_must_use.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/3f977baf34ed32c64c4ff185b4ef6ae2c2948afc/src%2Ftest%2Fui%2Flint%2Ffn_must_use.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3f977baf34ed32c64c4ff185b4ef6ae2c2948afc/src%2Ftest%2Fui%2Flint%2Ffn_must_use.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Ffn_must_use.stderr?ref=3f977baf34ed32c64c4ff185b4ef6ae2c2948afc", "patch": "@@ -0,0 +1,14 @@\n+warning: unused return value of `need_to_use_this_value` which must be used: it's important\n+  --> $DIR/fn_must_use.rs:29:5\n+   |\n+29 |     need_to_use_this_value();\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: #[warn(unused_must_use)] on by default\n+\n+warning: unused return value of `MyStruct::need_to_use_this_method_value` which must be used\n+  --> $DIR/fn_must_use.rs:32:5\n+   |\n+32 |     m.need_to_use_this_method_value();\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+"}]}