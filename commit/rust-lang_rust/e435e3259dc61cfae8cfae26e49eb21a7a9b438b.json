{"sha": "e435e3259dc61cfae8cfae26e49eb21a7a9b438b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU0MzVlMzI1OWRjNjFjZmFlOGNmYWUyNmU0OWViMjFhN2E5YjQzOGI=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-06-21T00:42:15Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-21T00:42:15Z"}, "message": "Rollup merge of #86156 - ehuss:linkchecker-fixes, r=Mark-Simulacrum\n\nFix a bug in the linkchecker\n\nThere was a small typo in the linkchecker (in #85652) that caused it to report a `#` fragment link error pointing to the wrong file (it was displaying the path to the source file, not the target of the link).\n\nThis also includes a few other changes:\n- Fixes the tests due to some changes in the redirect handling in #84703.\n- Adds the tests to rustbuild to run whenever the linkchecker itself is run.\n- Updates the tests to validate more of the output (so that a mistake like this would have been caught).\n\nCloses #86144", "tree": {"sha": "66539a8c3b6a5785ac70ad806ac8599de89b5fc8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/66539a8c3b6a5785ac70ad806ac8599de89b5fc8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e435e3259dc61cfae8cfae26e49eb21a7a9b438b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgz+BoCRBK7hj4Ov3rIwAAgUoIAAdCXm6WW9DzH8M3+LVmt7vk\nWeICvehsqN3yAcX+u30cOgEx21XFZoDnFmn7cykY/HyThqAaKpIXBU3uKWpxMIjW\n2GGqBzqv/iPh7y0qUiZ2YE/Ugoq5nIiU+QX2AdeKbotM2IUU7MnVIOqB2p/bBQyH\n+RH6FuzCmKC+Mm3Tz7MLBm+q6E8OyTJn7Fyyjr9/mFiyk6MBYSZTHsl6P7/HojCJ\nlhSs5/2CZwPjSwUHxw2RE9zjS913+def9oRhA8rE9hWV1k4UVNO4/3bKZ0/EQMPL\nfiDklQjEGm1OTzoaupxHppE6bnGpKSX7/EKQfTyAOm5B2OIIfF5UW0izDfEGbac=\n=qNqm\n-----END PGP SIGNATURE-----\n", "payload": "tree 66539a8c3b6a5785ac70ad806ac8599de89b5fc8\nparent e7a4f1e3fcb9af6841a07f073432b838193550d4\nparent 1e9f0b367e0b7dc9902502cfa09bcc52d2215261\nauthor Yuki Okushi <jtitor@2k36.org> 1624236135 +0900\ncommitter GitHub <noreply@github.com> 1624236135 +0900\n\nRollup merge of #86156 - ehuss:linkchecker-fixes, r=Mark-Simulacrum\n\nFix a bug in the linkchecker\n\nThere was a small typo in the linkchecker (in #85652) that caused it to report a `#` fragment link error pointing to the wrong file (it was displaying the path to the source file, not the target of the link).\n\nThis also includes a few other changes:\n- Fixes the tests due to some changes in the redirect handling in #84703.\n- Adds the tests to rustbuild to run whenever the linkchecker itself is run.\n- Updates the tests to validate more of the output (so that a mistake like this would have been caught).\n\nCloses #86144\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e435e3259dc61cfae8cfae26e49eb21a7a9b438b", "html_url": "https://github.com/rust-lang/rust/commit/e435e3259dc61cfae8cfae26e49eb21a7a9b438b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e7a4f1e3fcb9af6841a07f073432b838193550d4", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7a4f1e3fcb9af6841a07f073432b838193550d4", "html_url": "https://github.com/rust-lang/rust/commit/e7a4f1e3fcb9af6841a07f073432b838193550d4"}, {"sha": "1e9f0b367e0b7dc9902502cfa09bcc52d2215261", "url": "https://api.github.com/repos/rust-lang/rust/commits/1e9f0b367e0b7dc9902502cfa09bcc52d2215261", "html_url": "https://github.com/rust-lang/rust/commit/1e9f0b367e0b7dc9902502cfa09bcc52d2215261"}], "stats": {"total": 78, "additions": 70, "deletions": 8}, "files": [{"sha": "e7fb8c0d4d5d20357d85afdb462ad3dbc69c7d39", "filename": "src/bootstrap/builder/tests.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Fbootstrap%2Fbuilder%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Fbootstrap%2Fbuilder%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder%2Ftests.rs?ref=e435e3259dc61cfae8cfae26e49eb21a7a9b438b", "patch": "@@ -613,9 +613,14 @@ mod dist {\n         // Note that the stages here are +1 than what they actually are because\n         // Rustdoc::run swaps out the compiler with stage minus 1 if --stage is\n         // not 0.\n+        //\n+        // The stage 0 copy is the one downloaded for bootstrapping. It is\n+        // (currently) needed to run \"cargo test\" on the linkchecker, and\n+        // should be relatively \"free\".\n         assert_eq!(\n             first(builder.cache.all::<tool::Rustdoc>()),\n             &[\n+                tool::Rustdoc { compiler: Compiler { host: a, stage: 0 } },\n                 tool::Rustdoc { compiler: Compiler { host: a, stage: 1 } },\n                 tool::Rustdoc { compiler: Compiler { host: a, stage: 2 } },\n             ]"}, {"sha": "93ba8b07f5b3a108a28ca2dc6e17a97454f27523", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=e435e3259dc61cfae8cfae26e49eb21a7a9b438b", "patch": "@@ -124,8 +124,25 @@ You can skip linkcheck with --exclude src/tools/linkchecker\"\n \n         builder.info(&format!(\"Linkcheck ({})\", host));\n \n+        // Test the linkchecker itself.\n+        let bootstrap_host = builder.config.build;\n+        let compiler = builder.compiler(0, bootstrap_host);\n+        let cargo = tool::prepare_tool_cargo(\n+            builder,\n+            compiler,\n+            Mode::ToolBootstrap,\n+            bootstrap_host,\n+            \"test\",\n+            \"src/tools/linkchecker\",\n+            SourceType::InTree,\n+            &[],\n+        );\n+        try_run(builder, &mut cargo.into());\n+\n+        // Build all the default documentation.\n         builder.default_doc(&[]);\n \n+        // Run the linkchecker.\n         let _time = util::timeit(&builder);\n         try_run(\n             builder,"}, {"sha": "15edd628cdffcfa4532f48f6b30175143ceeba0f", "filename": "src/tools/linkchecker/main.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Ftools%2Flinkchecker%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Ftools%2Flinkchecker%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Flinkchecker%2Fmain.rs?ref=e435e3259dc61cfae8cfae26e49eb21a7a9b438b", "patch": "@@ -347,7 +347,7 @@ impl Checker {\n                 } else {\n                     report.errors += 1;\n                     print!(\"{}:{}: broken link fragment \", pretty_path, i + 1);\n-                    println!(\"`#{}` pointing to `{}`\", fragment, pretty_path);\n+                    println!(\"`#{}` pointing to `{}`\", fragment, target_pretty_path);\n                 };\n             }\n         });"}, {"sha": "9c580d8e07ee8c6ce7f3eef11cd76d8c31873448", "filename": "src/tools/linkchecker/tests/broken_redir/redir-bad.html", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Ftools%2Flinkchecker%2Ftests%2Fbroken_redir%2Fredir-bad.html", "raw_url": "https://github.com/rust-lang/rust/raw/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Ftools%2Flinkchecker%2Ftests%2Fbroken_redir%2Fredir-bad.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Flinkchecker%2Ftests%2Fbroken_redir%2Fredir-bad.html?ref=e435e3259dc61cfae8cfae26e49eb21a7a9b438b", "patch": "@@ -2,6 +2,7 @@\n <html lang=\"en\">\n <head>\n     <meta http-equiv=\"refresh\" content=\"0;URL=sometarget\">\n+    <title>Redirection</title>\n </head>\n <body>\n     <p>Redirecting to <a href=\"sometarget\">sometarget</a>...</p>"}, {"sha": "1a0b1b00e0de095dde50d75f8a2cbe7f8a2a9bf8", "filename": "src/tools/linkchecker/tests/checks.rs", "status": "modified", "additions": 43, "deletions": 7, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Ftools%2Flinkchecker%2Ftests%2Fchecks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Ftools%2Flinkchecker%2Ftests%2Fchecks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Flinkchecker%2Ftests%2Fchecks.rs?ref=e435e3259dc61cfae8cfae26e49eb21a7a9b438b", "patch": "@@ -15,7 +15,7 @@ fn run(dirname: &str) -> (ExitStatus, String, String) {\n fn broken_test(dirname: &str, expected: &str) {\n     let (status, stdout, stderr) = run(dirname);\n     assert!(!status.success());\n-    if !stdout.contains(expected) {\n+    if !contains(expected, &stdout) {\n         panic!(\n             \"stdout did not contain expected text: {}\\n\\\n             --- stdout:\\n\\\n@@ -27,6 +27,25 @@ fn broken_test(dirname: &str, expected: &str) {\n     }\n }\n \n+fn contains(expected: &str, actual: &str) -> bool {\n+    // Normalize for Windows paths.\n+    let actual = actual.replace('\\\\', \"/\");\n+    actual.lines().any(|mut line| {\n+        for (i, part) in expected.split(\"[..]\").enumerate() {\n+            match line.find(part) {\n+                Some(j) => {\n+                    if i == 0 && j != 0 {\n+                        return false;\n+                    }\n+                    line = &line[j + part.len()..];\n+                }\n+                None => return false,\n+            }\n+        }\n+        line.is_empty() || expected.ends_with(\"[..]\")\n+    })\n+}\n+\n fn valid_test(dirname: &str) {\n     let (status, stdout, stderr) = run(dirname);\n     if !status.success() {\n@@ -48,30 +67,47 @@ fn valid() {\n \n #[test]\n fn basic_broken() {\n-    broken_test(\"basic_broken\", \"bar.html\");\n+    broken_test(\"basic_broken\", \"foo.html:3: broken link - `bar.html`\");\n }\n \n #[test]\n fn broken_fragment_local() {\n-    broken_test(\"broken_fragment_local\", \"#somefrag\");\n+    broken_test(\n+        \"broken_fragment_local\",\n+        \"foo.html:3: broken link fragment `#somefrag` pointing to `foo.html`\",\n+    );\n }\n \n #[test]\n fn broken_fragment_remote() {\n-    broken_test(\"broken_fragment_remote/inner\", \"#somefrag\");\n+    broken_test(\n+        \"broken_fragment_remote/inner\",\n+        \"foo.html:3: broken link fragment `#somefrag` pointing to \\\n+         `[..]/broken_fragment_remote/bar.html`\",\n+    );\n }\n \n #[test]\n fn broken_redir() {\n-    broken_test(\"broken_redir\", \"sometarget\");\n+    broken_test(\n+        \"broken_redir\",\n+        \"foo.html:3: broken redirect from `redir-bad.html` to `sometarget`\",\n+    );\n }\n \n #[test]\n fn directory_link() {\n-    broken_test(\"directory_link\", \"somedir\");\n+    broken_test(\n+        \"directory_link\",\n+        \"foo.html:3: directory link to `somedir` (directory links should use index.html instead)\",\n+    );\n }\n \n #[test]\n fn redirect_loop() {\n-    broken_test(\"redirect_loop\", \"redir-bad.html\");\n+    broken_test(\n+        \"redirect_loop\",\n+        \"foo.html:3: redirect from `redir-bad.html` to `[..]redirect_loop/redir-bad.html` \\\n+         which is also a redirect (not supported)\",\n+    );\n }"}, {"sha": "bc567caa78b7e500efaba0d7c2290fc73931a39d", "filename": "src/tools/linkchecker/tests/redirect_loop/redir-bad.html", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Ftools%2Flinkchecker%2Ftests%2Fredirect_loop%2Fredir-bad.html", "raw_url": "https://github.com/rust-lang/rust/raw/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Ftools%2Flinkchecker%2Ftests%2Fredirect_loop%2Fredir-bad.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Flinkchecker%2Ftests%2Fredirect_loop%2Fredir-bad.html?ref=e435e3259dc61cfae8cfae26e49eb21a7a9b438b", "patch": "@@ -2,6 +2,7 @@\n <html lang=\"en\">\n <head>\n     <meta http-equiv=\"refresh\" content=\"0;URL=redir-bad.html\">\n+    <title>Redirection</title>\n </head>\n <body>\n     <p>Redirecting to <a href=\"redir-bad.html\">redir-bad.html</a>...</p>"}, {"sha": "f32683efe67ec8bf382534aa88f201d38b19d61f", "filename": "src/tools/linkchecker/tests/valid/inner/redir-bad.html", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Ftools%2Flinkchecker%2Ftests%2Fvalid%2Finner%2Fredir-bad.html", "raw_url": "https://github.com/rust-lang/rust/raw/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Ftools%2Flinkchecker%2Ftests%2Fvalid%2Finner%2Fredir-bad.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Flinkchecker%2Ftests%2Fvalid%2Finner%2Fredir-bad.html?ref=e435e3259dc61cfae8cfae26e49eb21a7a9b438b", "patch": "@@ -2,6 +2,7 @@\n <html lang=\"en\">\n <head>\n     <meta http-equiv=\"refresh\" content=\"0;URL=xxx\">\n+    <title>Redirection</title>\n </head>\n <body>\n     <p>Redirecting to <a href=\"xxx\">xxx</a>...</p>"}, {"sha": "3a52a8973853738b9b882e5aaeba45c341f58572", "filename": "src/tools/linkchecker/tests/valid/inner/redir.html", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Ftools%2Flinkchecker%2Ftests%2Fvalid%2Finner%2Fredir.html", "raw_url": "https://github.com/rust-lang/rust/raw/e435e3259dc61cfae8cfae26e49eb21a7a9b438b/src%2Ftools%2Flinkchecker%2Ftests%2Fvalid%2Finner%2Fredir.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Flinkchecker%2Ftests%2Fvalid%2Finner%2Fredir.html?ref=e435e3259dc61cfae8cfae26e49eb21a7a9b438b", "patch": "@@ -2,6 +2,7 @@\n <html lang=\"en\">\n <head>\n     <meta http-equiv=\"refresh\" content=\"0;URL=redir-target.html\">\n+    <title>Redirection</title>\n </head>\n <body>\n     <p>Redirecting to <a href=\"redir-target.html\">redir-target.html</a>...</p>"}]}