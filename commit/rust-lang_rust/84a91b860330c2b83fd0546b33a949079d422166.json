{"sha": "84a91b860330c2b83fd0546b33a949079d422166", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg0YTkxYjg2MDMzMGMyYjgzZmQwNTQ2YjMzYTk0OTA3OWQ0MjIxNjY=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-03-20T18:21:17Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-03-21T01:51:52Z"}, "message": "syntax: Tidy up parsing the new attribute syntax", "tree": {"sha": "1ef0a81e5d7d6c076ac9669a16fab8faa3c80b34", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1ef0a81e5d7d6c076ac9669a16fab8faa3c80b34"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/84a91b860330c2b83fd0546b33a949079d422166", "comment_count": 13, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/84a91b860330c2b83fd0546b33a949079d422166", "html_url": "https://github.com/rust-lang/rust/commit/84a91b860330c2b83fd0546b33a949079d422166", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/84a91b860330c2b83fd0546b33a949079d422166/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4e00cf613428d24d305a89e4f8e79b70ea8e8322", "url": "https://api.github.com/repos/rust-lang/rust/commits/4e00cf613428d24d305a89e4f8e79b70ea8e8322", "html_url": "https://github.com/rust-lang/rust/commit/4e00cf613428d24d305a89e4f8e79b70ea8e8322"}], "stats": {"total": 110, "additions": 56, "deletions": 54}, "files": [{"sha": "855bc1e5852d07fb3f9fae67b7b53c77b0eab480", "filename": "src/compiletest/compiletest.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Fcompiletest%2Fcompiletest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Fcompiletest%2Fcompiletest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcompiletest%2Fcompiletest.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -12,6 +12,7 @@\n #[feature(phase)];\n \n #[allow(non_camel_case_types)];\n+#[allow(deprecated_owned_vector)]; // NOTE: remove after stage0\n #[deny(warnings)];\n \n extern crate test;"}, {"sha": "dbebb8fb2bc680edd1ec61b4ac64a7b69a8967c0", "filename": "src/libarena/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibarena%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibarena%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibarena%2Flib.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -24,6 +24,7 @@\n       html_root_url = \"http://static.rust-lang.org/doc/master\")];\n #[allow(missing_doc)];\n #[feature(managed_boxes)];\n+#[allow(deprecated_owned_vector)]; // NOTE: remove after stage0\n \n extern crate collections;\n "}, {"sha": "b9846c9c3a2a8385bb443656235e4cd82faed6fa", "filename": "src/libgreen/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibgreen%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibgreen%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibgreen%2Flib.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -174,6 +174,7 @@\n // NB this does *not* include globs, please keep it that way.\n #[feature(macro_rules, phase)];\n #[allow(visible_private_types)];\n+#[allow(deprecated_owned_vector)]; // NOTE: remove after stage0\n \n #[cfg(test)] #[phase(syntax, link)] extern crate log;\n extern crate rand;"}, {"sha": "ee4f15e7954bd31b81717b29bd05c4bd84ffcedb", "filename": "src/librustuv/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibrustuv%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibrustuv%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustuv%2Flib.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -42,6 +42,7 @@ via `close` and `delete` methods.\n #[feature(macro_rules)];\n #[deny(unused_result, unused_must_use)];\n #[allow(visible_private_types)];\n+#[allow(deprecated_owned_vector)]; // NOTE: remove after stage0\n \n #[cfg(test)] extern crate green;\n "}, {"sha": "8f7fb5749a1ebfd3e7944ecb35d6733d81adda6c", "filename": "src/libsyntax/parse/attr.rs", "status": "modified", "additions": 18, "deletions": 28, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibsyntax%2Fparse%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibsyntax%2Fparse%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fattr.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -58,41 +58,40 @@ impl<'a> ParserAttr for Parser<'a> {\n         return attrs;\n     }\n \n-    // matches attribute = # [ meta_item ]\n+    // matches attribute = # ! [ meta_item ]\n     //\n-    // if permit_inner is true, then a trailing `;` indicates an inner\n+    // if permit_inner is true, then a leading `!` indicates an inner\n     // attribute\n     fn parse_attribute(&mut self, permit_inner: bool) -> ast::Attribute {\n         debug!(\"parse_attributes: permit_inner={:?} self.token={:?}\",\n                permit_inner, self.token);\n-        let mut warned = false;\n-        let (span, value) = match self.token {\n+        let (span, value, mut style) = match self.token {\n             INTERPOLATED(token::NtAttr(attr)) => {\n                 assert!(attr.node.style == ast::AttrOuter);\n                 self.bump();\n-                (attr.span, attr.node.value)\n+                (attr.span, attr.node.value, ast::AttrOuter)\n             }\n             token::POUND => {\n                 let lo = self.span.lo;\n                 self.bump();\n \n-                if self.eat(&token::NOT) {\n+                let style = if self.eat(&token::NOT) {\n                     if !permit_inner {\n-                        self.fatal(\"an inner attribute was not permitted in this context.\");\n+                        self.span_err(self.span,\n+                                      \"an inner attribute is not permitted in \\\n+                                       this context\");\n                     }\n+                    ast::AttrInner\n                 } else {\n-                    warned = true;\n-                    // NOTE: uncomment this after a stage0 snap\n-                    //self.warn(\"The syntax for inner attributes have changed.\n-                    //    Use `#![lang(foo)]` instead.\");\n-                }\n+                    ast::AttrOuter\n+                };\n \n                 self.expect(&token::LBRACKET);\n                 let meta_item = self.parse_meta_item();\n                 self.expect(&token::RBRACKET);\n \n                 let hi = self.span.hi;\n-                (mk_sp(lo, hi), meta_item)\n+                (mk_sp(lo, hi), meta_item, style)\n             }\n             _ => {\n                 let token_str = self.this_token_to_str();\n@@ -101,21 +100,12 @@ impl<'a> ParserAttr for Parser<'a> {\n             }\n         };\n \n-        let style = if permit_inner {\n-\n-            if self.eat(&token::SEMI) {\n-                // Only warn the user once if the syntax is the old one.\n-                if !warned {\n-                    // NOTE: uncomment this after a stage0 snap\n-                    //self.warn(\"This uses the old attribute syntax. Semicolons\n-                    //  are not longer required.\");\n-                }\n-            }\n-\n-            ast::AttrInner\n-        } else {\n-            ast::AttrOuter\n-        };\n+        if permit_inner && self.eat(&token::SEMI) {\n+            // NOTE: uncomment this after a stage0 snap\n+            //self.warn(\"This uses the old attribute syntax. Semicolons\n+            //  are not longer required.\");\n+            style = ast::AttrInner;\n+        }\n \n         return Spanned {\n             span: span,"}, {"sha": "43ae9b97350df4e6e2d2c444b4487dd826745bb4", "filename": "src/libsyntax/parse/comments.rs", "status": "modified", "additions": 5, "deletions": 7, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibsyntax%2Fparse%2Fcomments.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibsyntax%2Fparse%2Fcomments.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fcomments.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -12,7 +12,7 @@ use ast;\n use codemap::{BytePos, CharPos, CodeMap, Pos};\n use diagnostic;\n use parse::lexer::{is_whitespace, with_str_from, Reader};\n-use parse::lexer::{StringReader, bump, peek, is_eof, nextch_is, TokenAndSpan};\n+use parse::lexer::{StringReader, bump, is_eof, nextch_is, TokenAndSpan};\n use parse::lexer::{is_line_non_doc_comment, is_block_non_doc_comment};\n use parse::lexer;\n use parse::token;\n@@ -319,7 +319,9 @@ fn read_block_comment(rdr: &StringReader,\n fn peeking_at_comment(rdr: &StringReader) -> bool {\n     return (rdr.curr_is('/') && nextch_is(rdr, '/')) ||\n          (rdr.curr_is('/') && nextch_is(rdr, '*')) ||\n-         (rdr.curr_is('#') && nextch_is(rdr, '!'));\n+         // consider shebangs comments, but not inner attributes\n+         (rdr.curr_is('#') && nextch_is(rdr, '!') &&\n+          !lexer::nextnextch_is(rdr, '['));\n }\n \n fn consume_comment(rdr: &StringReader,\n@@ -331,11 +333,7 @@ fn consume_comment(rdr: &StringReader,\n     } else if rdr.curr_is('/') && nextch_is(rdr, '*') {\n         read_block_comment(rdr, code_to_the_left, comments);\n     } else if rdr.curr_is('#') && nextch_is(rdr, '!') {\n-        // Make sure the following token is **not** the beginning\n-        // of an inner attribute, which starts with the same syntax.\n-        if peek(rdr, 2).unwrap() != '[' {\n-            read_shebang_comment(rdr, code_to_the_left, comments);\n-        }\n+        read_shebang_comment(rdr, code_to_the_left, comments);\n     } else { fail!(); }\n     debug!(\"<<< consume comment\");\n }"}, {"sha": "ca2fbd245873f8ca146a557e01634a4e918ba0f8", "filename": "src/libsyntax/parse/lexer.rs", "status": "modified", "additions": 18, "deletions": 12, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibsyntax%2Fparse%2Flexer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibsyntax%2Fparse%2Flexer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Flexer.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -18,9 +18,10 @@ use parse::token::{str_to_ident};\n \n use std::cell::{Cell, RefCell};\n use std::char;\n-use std::rc::Rc;\n use std::mem::replace;\n use std::num::from_str_radix;\n+use std::rc::Rc;\n+use std::str;\n \n pub use ext::tt::transcribe::{TtReader, new_tt_reader};\n \n@@ -272,16 +273,6 @@ pub fn bump(rdr: &StringReader) {\n     }\n }\n \n-// EFFECT: Peek 'n' characters ahead.\n-pub fn peek(rdr: &StringReader, n: uint) -> Option<char> {\n-    let offset = byte_offset(rdr, rdr.pos.get()).to_uint() + (n - 1);\n-    if offset < (rdr.filemap.src).len() {\n-        Some(rdr.filemap.src.char_at(offset))\n-    } else {\n-        None\n-    }\n-}\n-\n pub fn is_eof(rdr: &StringReader) -> bool {\n     rdr.curr.get().is_none()\n }\n@@ -298,6 +289,21 @@ pub fn nextch_is(rdr: &StringReader, c: char) -> bool {\n     nextch(rdr) == Some(c)\n }\n \n+pub fn nextnextch(rdr: &StringReader) -> Option<char> {\n+    let offset = byte_offset(rdr, rdr.pos.get()).to_uint();\n+    let s = rdr.filemap.deref().src.as_slice();\n+    if offset >= s.len() { return None }\n+    let str::CharRange { next, .. } = s.char_range_at(offset);\n+    if next < s.len() {\n+        Some(s.char_at(next))\n+    } else {\n+        None\n+    }\n+}\n+pub fn nextnextch_is(rdr: &StringReader, c: char) -> bool {\n+    nextnextch(rdr) == Some(c)\n+}\n+\n fn hex_digit_val(c: Option<char>) -> int {\n     let d = c.unwrap_or('\\x00');\n \n@@ -384,7 +390,7 @@ fn consume_any_line_comment(rdr: &StringReader)\n         if nextch_is(rdr, '!') {\n \n             // Parse an inner attribute.\n-            if peek(rdr, 2).unwrap() == '[' {\n+            if nextnextch_is(rdr, '[') {\n                 return None;\n             }\n "}, {"sha": "ec7d48cf12bda0368f5e448c3478c4fe34c3bbb1", "filename": "src/libtest/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibtest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Flibtest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Flib.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -33,6 +33,7 @@\n       html_root_url = \"http://static.rust-lang.org/doc/master\")];\n \n #[feature(asm, macro_rules)];\n+#[allow(deprecated_owned_vector)]; // NOTE: remove after stage0\n \n extern crate collections;\n extern crate getopts;"}, {"sha": "b1f7a791f0958100416f3ecfa4e3a30429d90ff1", "filename": "src/test/compile-fail/attr.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Ftest%2Fcompile-fail%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Ftest%2Fcompile-fail%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fattr.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -10,5 +10,5 @@\n \n fn main() {}\n \n-#![lang(foo)] //~ ERROR An inner attribute was not permitted in this context.\n-fn foo() {}\n\\ No newline at end of file\n+#![lang(foo)] //~ ERROR an inner attribute is not permitted in this context\n+fn foo() {}"}, {"sha": "3a6594f64f36abc28213581bfa4ba4ca1b30bc69", "filename": "src/test/compile-fail/column-offset-1-based.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Ftest%2Fcompile-fail%2Fcolumn-offset-1-based.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Ftest%2Fcompile-fail%2Fcolumn-offset-1-based.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fcolumn-offset-1-based.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -8,4 +8,4 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-# //~ ERROR 11:1: 11:2 error: expected item\n+# //~ ERROR 11:1: 11:2 error: expected `[` but found `<eof>`"}, {"sha": "e2810b854f7959dfed8e9e811a4d8bd2932946fd", "filename": "src/test/compile-fail/issue-1655.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Ftest%2Fcompile-fail%2Fissue-1655.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Ftest%2Fcompile-fail%2Fissue-1655.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-1655.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -8,7 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-// error-pattern:expected item\n+// error-pattern:expected `[` but found `~`\n mod blade_runner {\n     #~[doc(\n         brief = \"Blade Runner is probably the best movie ever\","}, {"sha": "af615912f2823e79d56b50ea826d1a4298107753", "filename": "src/test/run-pass/attr-mix-new.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Ftest%2Frun-pass%2Fattr-mix-new.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Ftest%2Frun-pass%2Fattr-mix-new.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fattr-mix-new.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -13,4 +13,4 @@ mod foo {\n   #![feature(globs)]\n }\n \n-fn main() {}\n\\ No newline at end of file\n+pub fn main() {}"}, {"sha": "f4919f768b9cddd21f56be3b9c024a9542c3196e", "filename": "src/test/run-pass/attr-shebang.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Ftest%2Frun-pass%2Fattr-shebang.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Ftest%2Frun-pass%2Fattr-shebang.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fattr-shebang.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -1,4 +1,5 @@\n #![allow(unknown_features)]\n #![feature(bogus)]\n-fn main() { }\n-// ignore-license\n\\ No newline at end of file\n+pub fn main() { }\n+// ignore-license\n+// ignore-fast"}, {"sha": "6a19a44e07420db516dcf3874a9e4df9c28dd8e5", "filename": "src/test/run-pass/attr.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84a91b860330c2b83fd0546b33a949079d422166/src%2Ftest%2Frun-pass%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a91b860330c2b83fd0546b33a949079d422166/src%2Ftest%2Frun-pass%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fattr.rs?ref=84a91b860330c2b83fd0546b33a949079d422166", "patch": "@@ -8,6 +8,8 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+// ignore-fast\n+\n #[main]\n fn foo() {\n }"}]}