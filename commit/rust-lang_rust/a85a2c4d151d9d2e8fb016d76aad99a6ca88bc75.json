{"sha": "a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE4NWEyYzRkMTUxZDlkMmU4ZmIwMTZkNzZhYWQ5OWE2Y2E4OGJjNzU=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-05-11T14:15:31Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-05-11T14:15:31Z"}, "message": "Allow viewing the crate graph in a webview", "tree": {"sha": "636c0727298fd9d60a7b2a639c49dca8ba73d813", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/636c0727298fd9d60a7b2a639c49dca8ba73d813"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "html_url": "https://github.com/rust-lang/rust/commit/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9fa9d166d8141bb9ca4fcf0544c49b903fb85e09", "url": "https://api.github.com/repos/rust-lang/rust/commits/9fa9d166d8141bb9ca4fcf0544c49b903fb85e09", "html_url": "https://github.com/rust-lang/rust/commit/9fa9d166d8141bb9ca4fcf0544c49b903fb85e09"}], "stats": {"total": 125, "additions": 125, "deletions": 0}, "files": [{"sha": "f9c34547ed5432cdb0afc699339d6f0a16d4b31e", "filename": "Cargo.lock", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "patch": "@@ -319,6 +319,12 @@ version = \"1.0.2\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"fc4b29f4b9bb94bf267d57269fd0706d343a160937108e9619fe380645428abb\"\n \n+[[package]]\n+name = \"dot\"\n+version = \"0.1.4\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"a74b6c4d4a1cff5f454164363c16b72fa12463ca6b31f4b5f2035a65fa3d5906\"\n+\n [[package]]\n name = \"drop_bomb\"\n version = \"0.1.5\"\n@@ -588,6 +594,7 @@ version = \"0.0.0\"\n dependencies = [\n  \"cfg\",\n  \"cov-mark\",\n+ \"dot\",\n  \"either\",\n  \"expect-test\",\n  \"hir\","}, {"sha": "88f3d09d3407fd8a875ad7d497cf770bb3f592c9", "filename": "crates/ide/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/crates%2Fide%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/crates%2Fide%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2FCargo.toml?ref=a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "patch": "@@ -20,6 +20,7 @@ oorandom = \"11.1.2\"\n pulldown-cmark-to-cmark = \"6.0.0\"\n pulldown-cmark = { version = \"0.8.0\", default-features = false }\n url = \"2.1.1\"\n+dot = \"0.1.4\"\n \n stdx = { path = \"../stdx\", version = \"0.0.0\" }\n syntax = { path = \"../syntax\", version = \"0.0.0\" }"}, {"sha": "34360501af8eea46de28fc148bd1d94117be26d9", "filename": "crates/ide/src/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/crates%2Fide%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/crates%2Fide%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Flib.rs?ref=a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "patch": "@@ -49,6 +49,7 @@ mod syntax_tree;\n mod typing;\n mod markdown_remove;\n mod doc_links;\n+mod view_crate_graph;\n \n use std::sync::Arc;\n \n@@ -287,6 +288,10 @@ impl Analysis {\n         self.with_db(|db| view_hir::view_hir(&db, position))\n     }\n \n+    pub fn view_crate_graph(&self) -> Cancelable<Result<String, String>> {\n+        self.with_db(|db| view_crate_graph::view_crate_graph(&db))\n+    }\n+\n     pub fn expand_macro(&self, position: FilePosition) -> Cancelable<Option<ExpandedMacro>> {\n         self.with_db(|db| expand_macro::expand_macro(db, position))\n     }"}, {"sha": "4da4ce2b379f87178f744761010bfbfb4a5023de", "filename": "crates/ide/src/view_crate_graph.rs", "status": "added", "additions": 81, "deletions": 0, "changes": 81, "blob_url": "https://github.com/rust-lang/rust/blob/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/crates%2Fide%2Fsrc%2Fview_crate_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/crates%2Fide%2Fsrc%2Fview_crate_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fview_crate_graph.rs?ref=a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "patch": "@@ -0,0 +1,81 @@\n+use std::{\n+    error::Error,\n+    io::{Read, Write},\n+    process::{Command, Stdio},\n+    sync::Arc,\n+};\n+\n+use dot::Id;\n+use ide_db::{\n+    base_db::{CrateGraph, CrateId, Dependency, SourceDatabase},\n+    RootDatabase,\n+};\n+\n+// Feature: View Crate Graph\n+//\n+// Renders the currently loaded crate graph as an SVG graphic. Requires the `dot` tool to be\n+// installed.\n+//\n+// |===\n+// | Editor  | Action Name\n+//\n+// | VS Code | **Rust Analyzer: View Crate Graph**\n+// |===\n+pub(crate) fn view_crate_graph(db: &RootDatabase) -> Result<String, String> {\n+    let mut dot = Vec::new();\n+    let graph = DotCrateGraph(db.crate_graph());\n+    dot::render(&graph, &mut dot).unwrap();\n+\n+    render_svg(&dot).map_err(|e| e.to_string())\n+}\n+\n+fn render_svg(dot: &[u8]) -> Result<String, Box<dyn Error>> {\n+    // We shell out to `dot` to render to SVG, as there does not seem to be a pure-Rust renderer.\n+    let child = Command::new(\"dot\")\n+        .arg(\"-Tsvg\")\n+        .stdin(Stdio::piped())\n+        .stdout(Stdio::piped())\n+        .spawn()\n+        .map_err(|err| format!(\"failed to spawn `dot -Tsvg`: {}\", err))?;\n+    child.stdin.unwrap().write_all(&dot)?;\n+\n+    let mut svg = String::new();\n+    child.stdout.unwrap().read_to_string(&mut svg)?;\n+    Ok(svg)\n+}\n+\n+struct DotCrateGraph(Arc<CrateGraph>);\n+\n+type Edge<'a> = (CrateId, &'a Dependency);\n+\n+impl<'a> dot::GraphWalk<'a, CrateId, Edge<'a>> for DotCrateGraph {\n+    fn nodes(&'a self) -> dot::Nodes<'a, CrateId> {\n+        self.0.iter().collect()\n+    }\n+\n+    fn edges(&'a self) -> dot::Edges<'a, Edge<'a>> {\n+        self.0\n+            .iter()\n+            .flat_map(|krate| self.0[krate].dependencies.iter().map(move |dep| (krate, dep)))\n+            .collect()\n+    }\n+\n+    fn source(&'a self, edge: &Edge<'a>) -> CrateId {\n+        edge.0\n+    }\n+\n+    fn target(&'a self, edge: &Edge<'a>) -> CrateId {\n+        edge.1.crate_id\n+    }\n+}\n+\n+impl<'a> dot::Labeller<'a, CrateId, Edge<'a>> for DotCrateGraph {\n+    fn graph_id(&'a self) -> Id<'a> {\n+        Id::new(\"rust_analyzer_crate_graph\").unwrap()\n+    }\n+\n+    fn node_id(&'a self, n: &CrateId) -> Id<'a> {\n+        let name = self.0[*n].display_name.as_ref().map_or(\"_missing_name_\", |name| &*name);\n+        Id::new(name).unwrap()\n+    }\n+}"}, {"sha": "dafbab6d094f10a6d83c48864c297e7ec9679454", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "patch": "@@ -117,6 +117,12 @@ pub(crate) fn handle_view_hir(\n     Ok(res)\n }\n \n+pub(crate) fn handle_view_crate_graph(snap: GlobalStateSnapshot, (): ()) -> Result<String> {\n+    let _p = profile::span(\"handle_view_crate_graph\");\n+    let res = snap.analysis.view_crate_graph()??;\n+    Ok(res)\n+}\n+\n pub(crate) fn handle_expand_macro(\n     snap: GlobalStateSnapshot,\n     params: lsp_ext::ExpandMacroParams,"}, {"sha": "3bd09805800b7f92b8e03684db148cbe2eb04889", "filename": "crates/rust-analyzer/src/lsp_ext.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs?ref=a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "patch": "@@ -61,6 +61,14 @@ impl Request for ViewHir {\n     const METHOD: &'static str = \"rust-analyzer/viewHir\";\n }\n \n+pub enum ViewCrateGraph {}\n+\n+impl Request for ViewCrateGraph {\n+    type Params = ();\n+    type Result = String;\n+    const METHOD: &'static str = \"rust-analyzer/viewCrateGraph\";\n+}\n+\n pub enum ExpandMacro {}\n \n impl Request for ExpandMacro {"}, {"sha": "c7bd7eee1a90d55e160f73ac5ba1d23481cb80b9", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "patch": "@@ -513,6 +513,7 @@ impl GlobalState {\n             .on::<lsp_ext::AnalyzerStatus>(handlers::handle_analyzer_status)\n             .on::<lsp_ext::SyntaxTree>(handlers::handle_syntax_tree)\n             .on::<lsp_ext::ViewHir>(handlers::handle_view_hir)\n+            .on::<lsp_ext::ViewCrateGraph>(handlers::handle_view_crate_graph)\n             .on::<lsp_ext::ExpandMacro>(handlers::handle_expand_macro)\n             .on::<lsp_ext::ParentModule>(handlers::handle_parent_module)\n             .on::<lsp_ext::Runnables>(handlers::handle_runnables)"}, {"sha": "0f38a1673ac013e0ecff26be8610a6a2fef10581", "filename": "editors/code/package.json", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "patch": "@@ -109,6 +109,11 @@\n                 \"title\": \"View Hir\",\n                 \"category\": \"Rust Analyzer\"\n             },\n+            {\n+                \"command\": \"rust-analyzer.viewCrateGraph\",\n+                \"title\": \"View Crate Graph\",\n+                \"category\": \"Rust Analyzer\"\n+            },\n             {\n                 \"command\": \"rust-analyzer.expandMacro\",\n                 \"title\": \"Expand macro recursively\","}, {"sha": "8ab259af22119a5182f986c4d58bcacdb78d68e4", "filename": "editors/code/src/commands.ts", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/editors%2Fcode%2Fsrc%2Fcommands.ts", "raw_url": "https://github.com/rust-lang/rust/raw/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/editors%2Fcode%2Fsrc%2Fcommands.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands.ts?ref=a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "patch": "@@ -429,6 +429,14 @@ export function viewHir(ctx: Ctx): Cmd {\n     };\n }\n \n+export function viewCrateGraph(ctx: Ctx): Cmd {\n+    return async () => {\n+        const panel = vscode.window.createWebviewPanel(\"rust-analyzer.crate-graph\", \"rust-analyzer crate graph\", vscode.ViewColumn.Two);\n+        const svg = await ctx.client.sendRequest(ra.viewCrateGraph);\n+        panel.webview.html = svg;\n+    };\n+}\n+\n // Opens the virtual file that will show the syntax tree\n //\n // The contents of the file come from the `TextDocumentContentProvider`"}, {"sha": "aa745a65ce60e855668216d4fc30f38f646605aa", "filename": "editors/code/src/lsp_ext.ts", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "raw_url": "https://github.com/rust-lang/rust/raw/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Flsp_ext.ts?ref=a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "patch": "@@ -27,6 +27,8 @@ export const syntaxTree = new lc.RequestType<SyntaxTreeParams, string, void>(\"ru\n \n export const viewHir = new lc.RequestType<lc.TextDocumentPositionParams, string, void>(\"rust-analyzer/viewHir\");\n \n+export const viewCrateGraph = new lc.RequestType0<string, void>(\"rust-analyzer/viewCrateGraph\");\n+\n export interface ExpandMacroParams {\n     textDocument: lc.TextDocumentIdentifier;\n     position: lc.Position;"}, {"sha": "516322d035d4672796a328a6c60dc6f5af9fe361", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=a85a2c4d151d9d2e8fb016d76aad99a6ca88bc75", "patch": "@@ -106,6 +106,7 @@ async function tryActivate(context: vscode.ExtensionContext) {\n     ctx.registerCommand('parentModule', commands.parentModule);\n     ctx.registerCommand('syntaxTree', commands.syntaxTree);\n     ctx.registerCommand('viewHir', commands.viewHir);\n+    ctx.registerCommand('viewCrateGraph', commands.viewCrateGraph);\n     ctx.registerCommand('expandMacro', commands.expandMacro);\n     ctx.registerCommand('run', commands.run);\n     ctx.registerCommand('copyRunCommandLine', commands.copyRunCommandLine);"}]}