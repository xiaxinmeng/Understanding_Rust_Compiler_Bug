{"sha": "31884427eb6677703b370426617926e8ae0123d0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMxODg0NDI3ZWI2Njc3NzAzYjM3MDQyNjYxNzkyNmU4YWUwMTIzZDA=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-08-16T20:19:04Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-08-16T20:23:35Z"}, "message": "Set more llvm function attributes for __rust_try\n\nThis shim is generated elsewhere in the compiler so this commit adds support to\nensure it goes through similar paths as the rest of the compiler to set llvm\nfunction attributes like target features.\n\ncc #53372", "tree": {"sha": "632d3b95f92360d660de44651bd76da1a50504d8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/632d3b95f92360d660de44651bd76da1a50504d8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/31884427eb6677703b370426617926e8ae0123d0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/31884427eb6677703b370426617926e8ae0123d0", "html_url": "https://github.com/rust-lang/rust/commit/31884427eb6677703b370426617926e8ae0123d0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/31884427eb6677703b370426617926e8ae0123d0/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d767ee11616390d128853a06f5addb619e79213f", "url": "https://api.github.com/repos/rust-lang/rust/commits/d767ee11616390d128853a06f5addb619e79213f", "html_url": "https://github.com/rust-lang/rust/commit/d767ee11616390d128853a06f5addb619e79213f"}], "stats": {"total": 79, "additions": 44, "deletions": 35}, "files": [{"sha": "2b64642b766ab9d8a5d85580e0844081d8b089c8", "filename": "src/librustc_codegen_llvm/attributes.rs", "status": "modified", "additions": 40, "deletions": 12, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/31884427eb6677703b370426617926e8ae0123d0/src%2Flibrustc_codegen_llvm%2Fattributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31884427eb6677703b370426617926e8ae0123d0/src%2Flibrustc_codegen_llvm%2Fattributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fattributes.rs?ref=31884427eb6677703b370426617926e8ae0123d0", "patch": "@@ -11,7 +11,7 @@\n \n use std::ffi::CString;\n \n-use rustc::hir::CodegenFnAttrFlags;\n+use rustc::hir::{CodegenFnAttrFlags, CodegenFnAttrs};\n use rustc::hir::def_id::{DefId, LOCAL_CRATE};\n use rustc::session::Session;\n use rustc::session::config::Sanitizer;\n@@ -134,11 +134,37 @@ pub fn apply_target_cpu_attr(cx: &CodegenCx<'ll, '_>, llfn: &'ll Value) {\n \n /// Composite function which sets LLVM attributes for function depending on its AST (#[attribute])\n /// attributes.\n-pub fn from_fn_attrs(cx: &CodegenCx<'ll, '_>, llfn: &'ll Value, id: DefId) {\n-    let codegen_fn_attrs = cx.tcx.codegen_fn_attrs(id);\n+pub fn from_fn_attrs(\n+    cx: &CodegenCx<'ll, '_>,\n+    llfn: &'ll Value,\n+    id: Option<DefId>,\n+) {\n+    let codegen_fn_attrs = id.map(|id| cx.tcx.codegen_fn_attrs(id))\n+        .unwrap_or(CodegenFnAttrs::new());\n \n     inline(llfn, codegen_fn_attrs.inline);\n \n+    // The `uwtable` attribute according to LLVM is:\n+    //\n+    //     This attribute indicates that the ABI being targeted requires that an\n+    //     unwind table entry be produced for this function even if we can show\n+    //     that no exceptions passes by it. This is normally the case for the\n+    //     ELF x86-64 abi, but it can be disabled for some compilation units.\n+    //\n+    // Typically when we're compiling with `-C panic=abort` (which implies this\n+    // `no_landing_pads` check) we don't need `uwtable` because we can't\n+    // generate any exceptions! On Windows, however, exceptions include other\n+    // events such as illegal instructions, segfaults, etc. This means that on\n+    // Windows we end up still needing the `uwtable` attribute even if the `-C\n+    // panic=abort` flag is passed.\n+    //\n+    // You can also find more info on why Windows is whitelisted here in:\n+    //      https://bugzilla.mozilla.org/show_bug.cgi?id=1302078\n+    if !cx.sess().no_landing_pads() ||\n+       cx.sess().target.target.options.requires_uwtable {\n+        attributes::emit_uwtable(llfn, true);\n+    }\n+\n     set_frame_pointer_elimination(cx, llfn);\n     set_probestack(cx, llfn);\n \n@@ -162,7 +188,7 @@ pub fn from_fn_attrs(cx: &CodegenCx<'ll, '_>, llfn: &'ll Value, id: DefId) {\n     // *in Rust code* may unwind. Foreign items like `extern \"C\" {\n     // fn foo(); }` are assumed not to unwind **unless** they have\n     // a `#[unwind]` attribute.\n-    } else if !cx.tcx.is_foreign_item(id) {\n+    } else if id.map(|id| !cx.tcx.is_foreign_item(id)).unwrap_or(false) {\n         Some(true)\n     } else {\n         None\n@@ -208,14 +234,16 @@ pub fn from_fn_attrs(cx: &CodegenCx<'ll, '_>, llfn: &'ll Value, id: DefId) {\n     // Note that currently the `wasm-import-module` doesn't do anything, but\n     // eventually LLVM 7 should read this and ferry the appropriate import\n     // module to the output file.\n-    if cx.tcx.sess.target.target.arch == \"wasm32\" {\n-        if let Some(module) = wasm_import_module(cx.tcx, id) {\n-            llvm::AddFunctionAttrStringValue(\n-                llfn,\n-                llvm::AttributePlace::Function,\n-                const_cstr!(\"wasm-import-module\"),\n-                &module,\n-            );\n+    if let Some(id) = id {\n+        if cx.tcx.sess.target.target.arch == \"wasm32\" {\n+            if let Some(module) = wasm_import_module(cx.tcx, id) {\n+                llvm::AddFunctionAttrStringValue(\n+                    llfn,\n+                    llvm::AttributePlace::Function,\n+                    const_cstr!(\"wasm-import-module\"),\n+                    &module,\n+                );\n+            }\n         }\n     }\n }"}, {"sha": "63573cc6fb06903299b6b547b13ec034131c9f9c", "filename": "src/librustc_codegen_llvm/base.rs", "status": "modified", "additions": 0, "deletions": 21, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/31884427eb6677703b370426617926e8ae0123d0/src%2Flibrustc_codegen_llvm%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31884427eb6677703b370426617926e8ae0123d0/src%2Flibrustc_codegen_llvm%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fbase.rs?ref=31884427eb6677703b370426617926e8ae0123d0", "patch": "@@ -503,27 +503,6 @@ pub fn codegen_instance<'a, 'tcx>(cx: &CodegenCx<'a, 'tcx>, instance: Instance<'\n \n     cx.stats.borrow_mut().n_closures += 1;\n \n-    // The `uwtable` attribute according to LLVM is:\n-    //\n-    //     This attribute indicates that the ABI being targeted requires that an\n-    //     unwind table entry be produced for this function even if we can show\n-    //     that no exceptions passes by it. This is normally the case for the\n-    //     ELF x86-64 abi, but it can be disabled for some compilation units.\n-    //\n-    // Typically when we're compiling with `-C panic=abort` (which implies this\n-    // `no_landing_pads` check) we don't need `uwtable` because we can't\n-    // generate any exceptions! On Windows, however, exceptions include other\n-    // events such as illegal instructions, segfaults, etc. This means that on\n-    // Windows we end up still needing the `uwtable` attribute even if the `-C\n-    // panic=abort` flag is passed.\n-    //\n-    // You can also find more info on why Windows is whitelisted here in:\n-    //      https://bugzilla.mozilla.org/show_bug.cgi?id=1302078\n-    if !cx.sess().no_landing_pads() ||\n-       cx.sess().target.target.options.requires_uwtable {\n-        attributes::emit_uwtable(lldecl, true);\n-    }\n-\n     let mir = cx.tcx.instance_mir(instance.def);\n     mir::codegen_mir(cx, lldecl, &mir, instance, sig);\n }"}, {"sha": "2e90f95fa8e2d88b7032f05b05ebe4b85eaa8f50", "filename": "src/librustc_codegen_llvm/callee.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/31884427eb6677703b370426617926e8ae0123d0/src%2Flibrustc_codegen_llvm%2Fcallee.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31884427eb6677703b370426617926e8ae0123d0/src%2Flibrustc_codegen_llvm%2Fcallee.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fcallee.rs?ref=31884427eb6677703b370426617926e8ae0123d0", "patch": "@@ -98,7 +98,7 @@ pub fn get_fn(\n         if instance.def.is_inline(tcx) {\n             attributes::inline(llfn, attributes::InlineAttr::Hint);\n         }\n-        attributes::from_fn_attrs(cx, llfn, instance.def.def_id());\n+        attributes::from_fn_attrs(cx, llfn, Some(instance.def.def_id()));\n \n         let instance_def_id = instance.def_id();\n "}, {"sha": "099d8562aa536ce025c4eef696e11fe99ff85a86", "filename": "src/librustc_codegen_llvm/intrinsic.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/31884427eb6677703b370426617926e8ae0123d0/src%2Flibrustc_codegen_llvm%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31884427eb6677703b370426617926e8ae0123d0/src%2Flibrustc_codegen_llvm%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fintrinsic.rs?ref=31884427eb6677703b370426617926e8ae0123d0", "patch": "@@ -10,6 +10,7 @@\n \n #![allow(non_upper_case_globals)]\n \n+use attributes;\n use intrinsics::{self, Intrinsic};\n use llvm::{self, TypeKind};\n use abi::{Abi, FnType, LlvmType, PassMode};\n@@ -944,6 +945,7 @@ fn gen_fn<'ll, 'tcx>(\n         Abi::Rust\n     )));\n     let llfn = declare::define_internal_fn(cx, name, rust_fn_ty);\n+    attributes::from_fn_attrs(cx, llfn, None);\n     let bx = Builder::new_block(cx, llfn, \"entry-block\");\n     codegen(bx);\n     llfn"}, {"sha": "7f25911abec35a11813c73bf9401104f1435bad3", "filename": "src/librustc_codegen_llvm/mono_item.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/31884427eb6677703b370426617926e8ae0123d0/src%2Flibrustc_codegen_llvm%2Fmono_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31884427eb6677703b370426617926e8ae0123d0/src%2Flibrustc_codegen_llvm%2Fmono_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fmono_item.rs?ref=31884427eb6677703b370426617926e8ae0123d0", "patch": "@@ -182,7 +182,7 @@ fn predefine_fn<'a, 'tcx>(cx: &CodegenCx<'a, 'tcx>,\n     if instance.def.is_inline(cx.tcx) {\n         attributes::inline(lldecl, attributes::InlineAttr::Hint);\n     }\n-    attributes::from_fn_attrs(cx, lldecl, instance.def.def_id());\n+    attributes::from_fn_attrs(cx, lldecl, Some(instance.def.def_id()));\n \n     cx.instances.borrow_mut().insert(instance, lldecl);\n }"}]}