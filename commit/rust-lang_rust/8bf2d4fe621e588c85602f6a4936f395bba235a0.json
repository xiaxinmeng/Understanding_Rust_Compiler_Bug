{"sha": "8bf2d4fe621e588c85602f6a4936f395bba235a0", "node_id": "C_kwDOAAsO6NoAKDhiZjJkNGZlNjIxZTU4OGM4NTYwMmY2YTQ5MzZmMzk1YmJhMjM1YTA", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-09-30T18:38:39Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-30T18:38:39Z"}, "message": "Merge #10404\n\n10404: minor: Simplify r=Veykril a=Veykril\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/10405\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "876bfff8bb9d48285ddccc55a7320b7993a1ecc1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/876bfff8bb9d48285ddccc55a7320b7993a1ecc1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8bf2d4fe621e588c85602f6a4936f395bba235a0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhVgQvCRBK7hj4Ov3rIwAA7sAIAJluZTfeeD1vVCHny5hqHptB\nIryFuyXcn0pO6N19lLTuuNBPLrBRX+IcGKHFZS9rTgEqKUJZwuNHoBZBJATqiRcP\nWNoNCUgFWdZnwVTD9DdfKbfHP21DaMjhGhTw2ymhxceDMas6GT9Ej3KoY8lqwPrN\n24B6HYomF6lUph5Qh8m1S20djNw0Mkhg0ruEnKdakTUnH3zBEvpfvWyfdS+bLa1m\n7wt8OKs3roR1+DUO6abjbqIR2Im59uj8onmolLAGatTQWBgRhjDOX4vRXIdHeL89\nyhaZVtQeO+Z+jEPdF52ElEpOuqaE+dvo38iaQCpiCndvk1UGuvpVU5yvP8aXaLw=\n=7Mrf\n-----END PGP SIGNATURE-----\n", "payload": "tree 876bfff8bb9d48285ddccc55a7320b7993a1ecc1\nparent 4f3ce62b0daeaca48cb8c7f3d26712a402c5c9b7\nparent 0c7ea0c9a1b60780ff20ab8e099085a7d4a41769\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1633027119 +0000\ncommitter GitHub <noreply@github.com> 1633027119 +0000\n\nMerge #10404\n\n10404: minor: Simplify r=Veykril a=Veykril\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/10405\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8bf2d4fe621e588c85602f6a4936f395bba235a0", "html_url": "https://github.com/rust-lang/rust/commit/8bf2d4fe621e588c85602f6a4936f395bba235a0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8bf2d4fe621e588c85602f6a4936f395bba235a0/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4f3ce62b0daeaca48cb8c7f3d26712a402c5c9b7", "url": "https://api.github.com/repos/rust-lang/rust/commits/4f3ce62b0daeaca48cb8c7f3d26712a402c5c9b7", "html_url": "https://github.com/rust-lang/rust/commit/4f3ce62b0daeaca48cb8c7f3d26712a402c5c9b7"}, {"sha": "0c7ea0c9a1b60780ff20ab8e099085a7d4a41769", "url": "https://api.github.com/repos/rust-lang/rust/commits/0c7ea0c9a1b60780ff20ab8e099085a7d4a41769", "html_url": "https://github.com/rust-lang/rust/commit/0c7ea0c9a1b60780ff20ab8e099085a7d4a41769"}], "stats": {"total": 53, "additions": 24, "deletions": 29}, "files": [{"sha": "b4331fc09f41b3da1e8f948cdd1a7d37be4984e0", "filename": "crates/ide/src/syntax_highlighting.rs", "status": "modified", "additions": 23, "deletions": 29, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/8bf2d4fe621e588c85602f6a4936f395bba235a0/crates%2Fide%2Fsrc%2Fsyntax_highlighting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bf2d4fe621e588c85602f6a4936f395bba235a0/crates%2Fide%2Fsrc%2Fsyntax_highlighting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting.rs?ref=8bf2d4fe621e588c85602f6a4936f395bba235a0", "patch": "@@ -197,7 +197,7 @@ fn traverse(\n     let mut bindings_shadow_count: FxHashMap<Name, u32> = FxHashMap::default();\n \n     let mut current_macro_call: Option<ast::MacroCall> = None;\n-    let mut current_attr_macro_call = None;\n+    let mut current_attr_call = None;\n     let mut current_macro: Option<ast::Macro> = None;\n     let mut macro_highlighter = MacroHighlighter::default();\n     let mut inside_attribute = false;\n@@ -236,7 +236,7 @@ fn traverse(\n                         },\n                         ast::Item(item) => {\n                             if sema.is_attr_macro_call(&item) {\n-                                current_attr_macro_call = Some(item);\n+                                current_attr_call = Some(item);\n                             }\n                         },\n                         ast::Attr(__) => inside_attribute = true,\n@@ -257,8 +257,8 @@ fn traverse(\n                             macro_highlighter = MacroHighlighter::default();\n                         },\n                         ast::Item(item) => {\n-                            if current_attr_macro_call == Some(item) {\n-                                current_attr_macro_call = None;\n+                            if current_attr_call == Some(item) {\n+                                current_attr_call = None;\n                             }\n                         },\n                         ast::Attr(__) => inside_attribute = false,\n@@ -287,34 +287,28 @@ fn traverse(\n             }\n         }\n \n-        let element_to_highlight = if current_macro_call.is_some() && element.kind() != COMMENT {\n+        let descend_token = (current_macro_call.is_some() || current_attr_call.is_some())\n+            && element.kind() != COMMENT;\n+        let element_to_highlight = if descend_token {\n             // Inside a macro -- expand it first\n             let token = match element.clone().into_token() {\n-                Some(it) if it.parent().map_or(false, |it| it.kind() == TOKEN_TREE) => it,\n-                _ => continue,\n-            };\n-            let token = sema.descend_into_macros(token.clone());\n-            match token.parent() {\n-                Some(parent) => {\n-                    // We only care Name and Name_ref\n-                    match (token.kind(), parent.kind()) {\n-                        (IDENT, NAME | NAME_REF) => parent.into(),\n-                        _ => token.into(),\n+                Some(it) if current_macro_call.is_some() => {\n+                    let not_in_tt = it.parent().map_or(true, |it| it.kind() != TOKEN_TREE);\n+                    if not_in_tt {\n+                        continue;\n                     }\n+                    it\n                 }\n-                None => token.into(),\n-            }\n-        } else if current_attr_macro_call.is_some() {\n-            let token = match element.clone().into_token() {\n                 Some(it) => it,\n                 _ => continue,\n             };\n-            let token = sema.descend_into_macros(token.clone());\n+            let token = sema.descend_into_macros(token);\n             match token.parent() {\n                 Some(parent) => {\n                     // We only care Name and Name_ref\n                     match (token.kind(), parent.kind()) {\n-                        (IDENT, NAME | NAME_REF) => parent.into(),\n+                        (T![ident], NAME | NAME_REF) => parent.into(),\n+                        (T![self] | T![super] | T![crate], NAME_REF) => parent.into(),\n                         _ => token.into(),\n                     }\n                 }\n@@ -324,11 +318,12 @@ fn traverse(\n             element.clone()\n         };\n \n-        if let Some(token) = element.as_token().cloned().and_then(ast::String::cast) {\n+        if let Some(token) = element.into_token().and_then(ast::String::cast) {\n             if token.is_raw() {\n-                let expanded = element_to_highlight.as_token().unwrap().clone();\n-                if inject::ra_fixture(hl, sema, token, expanded).is_some() {\n-                    continue;\n+                if let Some(expanded) = element_to_highlight.as_token() {\n+                    if inject::ra_fixture(hl, sema, token, expanded.clone()).is_some() {\n+                        continue;\n+                    }\n                 }\n             }\n         }\n@@ -351,7 +346,7 @@ fn traverse(\n             hl.add(HlRange { range, highlight, binding_hash });\n         }\n \n-        if let Some(string) = element_to_highlight.as_token().cloned().and_then(ast::String::cast) {\n+        if let Some(string) = element_to_highlight.into_token().and_then(ast::String::cast) {\n             highlight_format_string(hl, &string, range);\n             // Highlight escape sequences\n             if let Some(char_ranges) = string.char_ranges() {\n@@ -376,9 +371,8 @@ fn macro_call_range(macro_call: &ast::MacroCall) -> Option<TextRange> {\n     let range_start = name_ref.syntax().text_range().start();\n     let mut range_end = name_ref.syntax().text_range().end();\n     for sibling in path.syntax().siblings_with_tokens(Direction::Next) {\n-        match sibling.kind() {\n-            T![!] | IDENT => range_end = sibling.text_range().end(),\n-            _ => (),\n+        if let T![!] | T![ident] = sibling.kind() {\n+            range_end = sibling.text_range().end();\n         }\n     }\n "}, {"sha": "d5f579f11d8a61c75f6b1746435f27a6982c3d8c", "filename": "crates/rust-analyzer/src/semantic_tokens.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8bf2d4fe621e588c85602f6a4936f395bba235a0/crates%2Frust-analyzer%2Fsrc%2Fsemantic_tokens.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bf2d4fe621e588c85602f6a4936f395bba235a0/crates%2Frust-analyzer%2Fsrc%2Fsemantic_tokens.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fsemantic_tokens.rs?ref=8bf2d4fe621e588c85602f6a4936f395bba235a0", "patch": "@@ -81,6 +81,7 @@ macro_rules! define_semantic_token_modifiers {\n             SemanticTokenModifier::ABSTRACT,\n             SemanticTokenModifier::DEPRECATED,\n             SemanticTokenModifier::READONLY,\n+            SemanticTokenModifier::DEFAULT_LIBRARY,\n             $($ident),*\n         ];\n     };"}]}