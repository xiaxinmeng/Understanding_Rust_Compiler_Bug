{"sha": "392723ec6e643f694a66e47941e5c8ae670e219f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM5MjcyM2VjNmU2NDNmNjk0YTY2ZTQ3OTQxZTVjOGFlNjcwZTIxOWY=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2021-05-06T16:47:37Z"}, "committer": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2021-05-06T16:47:37Z"}, "message": "ci: error out if someone sends a PR to the wrong branch", "tree": {"sha": "ab59af1a27c5db07b737e442205c8702188edcd1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ab59af1a27c5db07b737e442205c8702188edcd1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/392723ec6e643f694a66e47941e5c8ae670e219f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE1JbYPtLJAsc22U9xPgar6Auq8ZwFAmCUHbQACgkQPgar6Auq\n8ZzcgA//YSH+iKgT51RVkmSp1fODOz8yPwezaSGqZQFoi0IsSJzeH8X0EFi7aYen\n1xJ4d5Hyhx30UuLaLtCtCNOhFk9vd+dw3dfuu5LH3tnbhl060wnkA2dbVyUvyP96\nOMzQSY/6mzNiECNpD3nPpU6dnJzSQRgqnsUqD2oifrat+yGQLpc6etWCeY8T0zdC\nWKaxwbmTcyY64PEarHdAKwGdPyBQZXM9tsx10OTIu4lu8XMjyPPr1FFxcKGfQVD/\nqDySOGL7HfZdCoaHD4o9T21yHEp3qoZDy4o8iIuQ3pzRIa+zA6g86DtKShzIZtRr\ndnAN3HiuaQEJFRRyPCokxaWUliNyrNrPtMJlNlUl6IRmUGjpGTkMJBiYQWXwZ8eS\nhk1eDyj0LDjPiAb8GhlsBWr9yThkr+MMAOxipXhakykyZdQQOAM84nsvV6b0xq7R\nd/RQevTMXIGNGvIG/E/bN6uFQnMi8AQmYNV8F8xpw/NUB2jEc54XmCOWgMWBb4d4\neVBCEiKqH56ys/foUFNTB9RbwdZBaVHTnSN3fT7A4d48TuvnCbYbzQ9ZwzEciDq2\nmUYoTSsObKvyUTap1dLQydk7Rk7c2BUZOtLdwh2mkqTzvS41EW0BmeZ9X+gpTTBx\n/kWrlZregkAqUcPck80GD+3auVuwzTACFdKggdxD8qRrYcPAktk=\n=vSdN\n-----END PGP SIGNATURE-----", "payload": "tree ab59af1a27c5db07b737e442205c8702188edcd1\nparent 81a97cea83a34dfaf214a66d213dd0d02a495cbd\nauthor Pietro Albini <pietro@pietroalbini.org> 1620319657 +0200\ncommitter Pietro Albini <pietro@pietroalbini.org> 1620319657 +0200\n\nci: error out if someone sends a PR to the wrong branch\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/392723ec6e643f694a66e47941e5c8ae670e219f", "html_url": "https://github.com/rust-lang/rust/commit/392723ec6e643f694a66e47941e5c8ae670e219f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/392723ec6e643f694a66e47941e5c8ae670e219f/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "81a97cea83a34dfaf214a66d213dd0d02a495cbd", "url": "https://api.github.com/repos/rust-lang/rust/commits/81a97cea83a34dfaf214a66d213dd0d02a495cbd", "html_url": "https://github.com/rust-lang/rust/commit/81a97cea83a34dfaf214a66d213dd0d02a495cbd"}], "stats": {"total": 53, "additions": 53, "deletions": 0}, "files": [{"sha": "aa9d97ba477b76b85fddb9391195d4b1a6ce1fca", "filename": ".github/workflows/ci.yml", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/392723ec6e643f694a66e47941e5c8ae670e219f/.github%2Fworkflows%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/392723ec6e643f694a66e47941e5c8ae670e219f/.github%2Fworkflows%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yml?ref=392723ec6e643f694a66e47941e5c8ae670e219f", "patch": "@@ -72,6 +72,9 @@ jobs:\n       - name: decide whether to skip this job\n         run: src/ci/scripts/should-skip-this.sh\n         if: success() && !env.SKIP_JOB\n+      - name: ensure the channel matches the target branch\n+        run: src/ci/scripts/verify-channel.sh\n+        if: success() && !env.SKIP_JOB\n       - name: configure GitHub Actions to kill the build when outdated\n         uses: rust-lang/simpleinfra/github-actions/cancel-outdated-builds@master\n         with:\n@@ -434,6 +437,9 @@ jobs:\n       - name: decide whether to skip this job\n         run: src/ci/scripts/should-skip-this.sh\n         if: success() && !env.SKIP_JOB\n+      - name: ensure the channel matches the target branch\n+        run: src/ci/scripts/verify-channel.sh\n+        if: success() && !env.SKIP_JOB\n       - name: configure GitHub Actions to kill the build when outdated\n         uses: rust-lang/simpleinfra/github-actions/cancel-outdated-builds@master\n         with:\n@@ -541,6 +547,9 @@ jobs:\n       - name: decide whether to skip this job\n         run: src/ci/scripts/should-skip-this.sh\n         if: success() && !env.SKIP_JOB\n+      - name: ensure the channel matches the target branch\n+        run: src/ci/scripts/verify-channel.sh\n+        if: success() && !env.SKIP_JOB\n       - name: configure GitHub Actions to kill the build when outdated\n         uses: rust-lang/simpleinfra/github-actions/cancel-outdated-builds@master\n         with:"}, {"sha": "343091cb779fc2705a153c71c9c59c50a935f5fd", "filename": "src/ci/github-actions/ci.yml", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/392723ec6e643f694a66e47941e5c8ae670e219f/src%2Fci%2Fgithub-actions%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/392723ec6e643f694a66e47941e5c8ae670e219f/src%2Fci%2Fgithub-actions%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fgithub-actions%2Fci.yml?ref=392723ec6e643f694a66e47941e5c8ae670e219f", "patch": "@@ -126,6 +126,10 @@ x--expand-yaml-anchors--remove:\n         run: src/ci/scripts/should-skip-this.sh\n         <<: *step\n \n+      - name: ensure the channel matches the target branch\n+        run: src/ci/scripts/verify-channel.sh\n+        <<: *step\n+\n       - name: configure GitHub Actions to kill the build when outdated\n         uses: rust-lang/simpleinfra/github-actions/cancel-outdated-builds@master\n         with:"}, {"sha": "7945512738eb8aba4f1bbc107bc2aa62ca4a1f78", "filename": "src/ci/scripts/verify-channel.sh", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/392723ec6e643f694a66e47941e5c8ae670e219f/src%2Fci%2Fscripts%2Fverify-channel.sh", "raw_url": "https://github.com/rust-lang/rust/raw/392723ec6e643f694a66e47941e5c8ae670e219f/src%2Fci%2Fscripts%2Fverify-channel.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fscripts%2Fverify-channel.sh?ref=392723ec6e643f694a66e47941e5c8ae670e219f", "patch": "@@ -0,0 +1,28 @@\n+#!/bin/bash\n+# We want to make sure all PRs are targeting the right branch when they're\n+# opened, otherwise we risk (for example) to land a beta-specific change to the\n+# master branch. This script ensures the branch of the PR matches the channel.\n+\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+source \"$(cd \"$(dirname \"$0\")\" && pwd)/../shared.sh\"\n+\n+declare -A CHANNEL_BRANCH\n+CHANNEL_BRANCH[\"nightly\"]=\"master\"\n+CHANNEL_BRANCH[\"beta\"]=\"beta\"\n+CHANNEL_BRANCH[\"stable\"]=\"stable\"\n+\n+if isCiBranch auto || isCiBranch try; then\n+    echo \"channel verification is only executed on PR builds\"\n+    exit\n+fi\n+\n+channel=$(cat \"$(ciCheckoutPath)/src/ci/channel\")\n+branch=\"$(ciBaseBranch)\"\n+if [[ \"${branch}\" != \"${CHANNEL_BRANCH[$channel]}\" ]]; then\n+    echo \"error: PRs changing the \\`${channel}\\` channel should be sent to the \\\n+\\`${CHANNEL_BRANCH[$channel]}\\` branch!\"\n+\n+    exit 1\n+fi"}, {"sha": "332a949a4dc51bda7202d33aa63337d8902c4212", "filename": "src/ci/shared.sh", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/392723ec6e643f694a66e47941e5c8ae670e219f/src%2Fci%2Fshared.sh", "raw_url": "https://github.com/rust-lang/rust/raw/392723ec6e643f694a66e47941e5c8ae670e219f/src%2Fci%2Fshared.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fshared.sh?ref=392723ec6e643f694a66e47941e5c8ae670e219f", "patch": "@@ -73,6 +73,18 @@ function isCiBranch {\n     fi\n }\n \n+function ciBaseBranch {\n+    if isAzurePipelines; then\n+        echo \"unsupported on Azure Pipelines\"\n+        exit 1\n+    elif isGitHubActions; then\n+        echo \"${GITHUB_BASE_REF#refs/heads/}\"\n+    else\n+        echo \"ciBaseBranch only works inside CI!\"\n+        exit 1\n+    fi\n+}\n+\n function ciCommit {\n     if isAzurePipelines; then\n         echo \"${BUILD_SOURCEVERSION}\""}]}