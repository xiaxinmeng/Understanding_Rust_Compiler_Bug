{"sha": "2d14b39204e648a219a17335e712c3fb14666a07", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJkMTRiMzkyMDRlNjQ4YTIxOWExNzMzNWU3MTJjM2ZiMTQ2NjZhMDc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-02-20T14:33:13Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-02-20T14:33:13Z"}, "message": "Auto merge of #31747 - jseyfried:stop_resolve_after_fail, r=nrc\n\nNow that #31461 is merged, a failing resolution can never become indeterminate or succeed, so we no longer have to keep trying to resolve failing import directives.\nr? @nrc", "tree": {"sha": "01d7d5c20de1e6c28f0f034dae683d2de708b205", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/01d7d5c20de1e6c28f0f034dae683d2de708b205"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2d14b39204e648a219a17335e712c3fb14666a07", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2d14b39204e648a219a17335e712c3fb14666a07", "html_url": "https://github.com/rust-lang/rust/commit/2d14b39204e648a219a17335e712c3fb14666a07", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2d14b39204e648a219a17335e712c3fb14666a07/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6c751e045642376eafe7ec8a2cae6d92995a46b6", "url": "https://api.github.com/repos/rust-lang/rust/commits/6c751e045642376eafe7ec8a2cae6d92995a46b6", "html_url": "https://github.com/rust-lang/rust/commit/6c751e045642376eafe7ec8a2cae6d92995a46b6"}, {"sha": "5ad84f130169136cc32b63d9172143ef4422a09f", "url": "https://api.github.com/repos/rust-lang/rust/commits/5ad84f130169136cc32b63d9172143ef4422a09f", "html_url": "https://github.com/rust-lang/rust/commit/5ad84f130169136cc32b63d9172143ef4422a09f"}], "stats": {"total": 109, "additions": 37, "deletions": 72}, "files": [{"sha": "a25968174fd4eeda26be50ce06dbb20caf5f3ee6", "filename": "src/librustc_resolve/build_reduced_graph.rs", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/2d14b39204e648a219a17335e712c3fb14666a07/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d14b39204e648a219a17335e712c3fb14666a07/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs?ref=2d14b39204e648a219a17335e712c3fb14666a07", "patch": "@@ -19,7 +19,7 @@ use resolve_imports::ImportDirectiveSubclass::{self, SingleImport, GlobImport};\n use Module;\n use Namespace::{self, TypeNS, ValueNS};\n use {NameBinding, NameBindingKind};\n-use {names_to_string, module_to_string};\n+use module_to_string;\n use ParentLink::{ModuleParentLink, BlockParentLink};\n use Resolver;\n use resolve_imports::Shadowable;\n@@ -682,7 +682,7 @@ impl<'a, 'b:'a, 'tcx:'b> GraphBuilder<'a, 'b, 'tcx> {\n                               id: NodeId,\n                               is_public: bool,\n                               shadowable: Shadowable) {\n-        module_.imports\n+        module_.unresolved_imports\n                .borrow_mut()\n                .push(ImportDirective::new(module_path, subclass, span, id, is_public, shadowable));\n         self.unresolved_imports += 1;\n@@ -696,9 +696,6 @@ impl<'a, 'b:'a, 'tcx:'b> GraphBuilder<'a, 'b, 'tcx> {\n \n         match subclass {\n             SingleImport(target, _) => {\n-                debug!(\"(building import directive) building import directive: {}::{}\",\n-                       names_to_string(&module_.imports.borrow().last().unwrap().module_path),\n-                       target);\n                 module_.increment_outstanding_references_for(target, ValueNS);\n                 module_.increment_outstanding_references_for(target, TypeNS);\n             }"}, {"sha": "11c51522b6763e4ab9bc720353cf3e98f72e9cca", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 5, "deletions": 23, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/2d14b39204e648a219a17335e712c3fb14666a07/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d14b39204e648a219a17335e712c3fb14666a07/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=2d14b39204e648a219a17335e712c3fb14666a07", "patch": "@@ -18,7 +18,6 @@\n #![cfg_attr(not(stage0), deny(warnings))]\n \n #![feature(associated_consts)]\n-#![feature(borrow_state)]\n #![feature(rustc_diagnostic_macros)]\n #![feature(rustc_private)]\n #![feature(staged_api)]\n@@ -810,7 +809,7 @@ pub struct ModuleS<'a> {\n     is_extern_crate: bool,\n \n     resolutions: RefCell<HashMap<(Name, Namespace), NameResolution<'a>>>,\n-    imports: RefCell<Vec<ImportDirective>>,\n+    unresolved_imports: RefCell<Vec<ImportDirective>>,\n \n     // The module children of this node, including normal modules and anonymous modules.\n     // Anonymous children are pseudo-modules that are implicitly created around items\n@@ -839,9 +838,6 @@ pub struct ModuleS<'a> {\n     // The number of unresolved pub glob imports in this module\n     pub_glob_count: Cell<usize>,\n \n-    // The index of the import we're resolving.\n-    resolved_import_count: Cell<usize>,\n-\n     // Whether this module is populated. If not populated, any attempt to\n     // access the children must be preceded with a\n     // `populate_module_if_necessary` call.\n@@ -859,13 +855,12 @@ impl<'a> ModuleS<'a> {\n             is_public: is_public,\n             is_extern_crate: false,\n             resolutions: RefCell::new(HashMap::new()),\n-            imports: RefCell::new(Vec::new()),\n+            unresolved_imports: RefCell::new(Vec::new()),\n             module_children: RefCell::new(NodeMap()),\n             shadowed_traits: RefCell::new(Vec::new()),\n             glob_count: Cell::new(0),\n             pub_count: Cell::new(0),\n             pub_glob_count: Cell::new(0),\n-            resolved_import_count: Cell::new(0),\n             populated: Cell::new(!external),\n         }\n     }\n@@ -936,15 +931,6 @@ impl<'a> ModuleS<'a> {\n         }\n     }\n \n-    fn all_imports_resolved(&self) -> bool {\n-        if self.imports.borrow_state() == ::std::cell::BorrowState::Writing {\n-            // it is currently being resolved ! so nope\n-            false\n-        } else {\n-            self.imports.borrow().len() == self.resolved_import_count.get()\n-        }\n-    }\n-\n     pub fn inc_glob_count(&self) {\n         self.glob_count.set(self.glob_count.get() + 1);\n     }\n@@ -1635,13 +1621,9 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n     }\n \n     fn report_unresolved_imports(&mut self, module_: Module<'a>) {\n-        let index = module_.resolved_import_count.get();\n-        let imports = module_.imports.borrow();\n-        let import_count = imports.len();\n-        if index != import_count {\n-            resolve_error(self,\n-                          (*imports)[index].span,\n-                          ResolutionError::UnresolvedImport(None));\n+        for import in module_.unresolved_imports.borrow().iter() {\n+            resolve_error(self, import.span, ResolutionError::UnresolvedImport(None));\n+            break;\n         }\n \n         // Descend into children and anonymous children."}, {"sha": "9c6e51c647c783c1b3f6832d6b07da2e8e8b21da", "filename": "src/librustc_resolve/resolve_imports.rs", "status": "modified", "additions": 28, "deletions": 42, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/2d14b39204e648a219a17335e712c3fb14666a07/src%2Flibrustc_resolve%2Fresolve_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d14b39204e648a219a17335e712c3fb14666a07/src%2Flibrustc_resolve%2Fresolve_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fresolve_imports.rs?ref=2d14b39204e648a219a17335e712c3fb14666a07", "patch": "@@ -173,13 +173,14 @@ impl<'a, 'b:'a, 'tcx:'b> ImportResolver<'a, 'b, 'tcx> {\n     fn resolve_imports(&mut self) {\n         let mut i = 0;\n         let mut prev_unresolved_imports = 0;\n+        let mut errors = Vec::new();\n+\n         loop {\n             debug!(\"(resolving imports) iteration {}, {} imports left\",\n                    i,\n                    self.resolver.unresolved_imports);\n \n-            let module_root = self.resolver.graph_root;\n-            let errors = self.resolve_imports_for_module_subtree(module_root);\n+            self.resolve_imports_for_module_subtree(self.resolver.graph_root, &mut errors);\n \n             if self.resolver.unresolved_imports == 0 {\n                 debug!(\"(resolving imports) success\");\n@@ -197,7 +198,7 @@ impl<'a, 'b:'a, 'tcx:'b> ImportResolver<'a, 'b, 'tcx> {\n                     // to avoid generating multiple errors on the same import.\n                     // Imports that are still indeterminate at this point are actually blocked\n                     // by errored imports, so there is no point reporting them.\n-                    self.resolver.report_unresolved_imports(module_root);\n+                    self.resolver.report_unresolved_imports(self.resolver.graph_root);\n                 }\n                 break;\n             }\n@@ -236,67 +237,45 @@ impl<'a, 'b:'a, 'tcx:'b> ImportResolver<'a, 'b, 'tcx> {\n     /// Attempts to resolve imports for the given module and all of its\n     /// submodules.\n     fn resolve_imports_for_module_subtree(&mut self,\n-                                          module_: Module<'b>)\n-                                          -> Vec<ImportResolvingError<'b>> {\n-        let mut errors = Vec::new();\n+                                          module_: Module<'b>,\n+                                          errors: &mut Vec<ImportResolvingError<'b>>) {\n         debug!(\"(resolving imports for module subtree) resolving {}\",\n                module_to_string(&module_));\n         let orig_module = replace(&mut self.resolver.current_module, module_);\n-        errors.extend(self.resolve_imports_for_module(module_));\n+        self.resolve_imports_for_module(module_, errors);\n         self.resolver.current_module = orig_module;\n \n         for (_, child_module) in module_.module_children.borrow().iter() {\n-            errors.extend(self.resolve_imports_for_module_subtree(child_module));\n+            self.resolve_imports_for_module_subtree(child_module, errors);\n         }\n-\n-        errors\n     }\n \n     /// Attempts to resolve imports for the given module only.\n-    fn resolve_imports_for_module(&mut self, module: Module<'b>) -> Vec<ImportResolvingError<'b>> {\n-        let mut errors = Vec::new();\n-\n-        if module.all_imports_resolved() {\n-            debug!(\"(resolving imports for module) all imports resolved for {}\",\n-                   module_to_string(&module));\n-            return errors;\n-        }\n-\n-        let mut imports = module.imports.borrow_mut();\n-        let import_count = imports.len();\n-        let mut indeterminate_imports = Vec::new();\n-        while module.resolved_import_count.get() + indeterminate_imports.len() < import_count {\n-            let import_index = module.resolved_import_count.get();\n-            match self.resolve_import_for_module(module, &imports[import_index]) {\n-                ResolveResult::Failed(err) => {\n-                    let import_directive = &imports[import_index];\n+    fn resolve_imports_for_module(&mut self,\n+                                  module: Module<'b>,\n+                                  errors: &mut Vec<ImportResolvingError<'b>>) {\n+        let mut imports = Vec::new();\n+        let mut unresolved_imports = module.unresolved_imports.borrow_mut();\n+        ::std::mem::swap(&mut imports, &mut unresolved_imports);\n+\n+        for import_directive in imports {\n+            match self.resolve_import_for_module(module, &import_directive) {\n+                Failed(err) => {\n                     let (span, help) = match err {\n                         Some((span, msg)) => (span, format!(\". {}\", msg)),\n                         None => (import_directive.span, String::new()),\n                     };\n                     errors.push(ImportResolvingError {\n                         source_module: module,\n-                        import_directive: import_directive.clone(),\n+                        import_directive: import_directive,\n                         span: span,\n                         help: help,\n                     });\n                 }\n-                ResolveResult::Indeterminate => {}\n-                ResolveResult::Success(()) => {\n-                    // count success\n-                    module.resolved_import_count\n-                          .set(module.resolved_import_count.get() + 1);\n-                    continue;\n-                }\n+                Indeterminate => unresolved_imports.push(import_directive),\n+                Success(()) => {}\n             }\n-            // This resolution was not successful, keep it for later\n-            indeterminate_imports.push(imports.swap_remove(import_index));\n-\n         }\n-\n-        imports.extend(indeterminate_imports);\n-\n-        errors\n     }\n \n     /// Attempts to resolve the given import. The return value indicates\n@@ -564,6 +543,13 @@ impl<'a, 'b:'a, 'tcx:'b> ImportResolver<'a, 'b, 'tcx> {\n                        ns: Namespace,\n                        binding: &'b NameBinding<'b>,\n                        old_binding: &'b NameBinding<'b>) {\n+        // Error on the second of two conflicting imports\n+        if old_binding.is_import() && binding.is_import() &&\n+           old_binding.span.unwrap().lo > binding.span.unwrap().lo {\n+            self.report_conflict(name, ns, old_binding, binding);\n+            return;\n+        }\n+\n         if old_binding.is_extern_crate() {\n             let msg = format!(\"import `{0}` conflicts with imported crate \\\n                                in this module (maybe you meant `use {0}::*`?)\","}, {"sha": "fa3b75c70f0b68a75250c93b5c50638e20257bf6", "filename": "src/test/compile-fail/import-shadow-6.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2d14b39204e648a219a17335e712c3fb14666a07/src%2Ftest%2Fcompile-fail%2Fimport-shadow-6.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d14b39204e648a219a17335e712c3fb14666a07/src%2Ftest%2Fcompile-fail%2Fimport-shadow-6.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fimport-shadow-6.rs?ref=2d14b39204e648a219a17335e712c3fb14666a07", "patch": "@@ -12,8 +12,8 @@\n \n #![no_implicit_prelude]\n \n-use qux::*; //~ERROR a type named `Baz` has already been imported in this module\n-use foo::*;\n+use qux::*;\n+use foo::*; //~ERROR a type named `Baz` has already been imported in this module\n \n mod foo {\n     pub type Baz = isize;"}]}