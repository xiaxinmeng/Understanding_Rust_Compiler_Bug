{"sha": "64bef2910be17ca75ced3f0a99b4584f69114c74", "node_id": "C_kwDOAAsO6NoAKDY0YmVmMjkxMGJlMTdjYTc1Y2VkM2YwYTk5YjQ1ODRmNjkxMTRjNzQ", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-04-12T15:01:22Z"}, "committer": {"name": "Jubilee", "email": "46493976+workingjubilee@users.noreply.github.com", "date": "2022-07-19T23:37:34Z"}, "message": "portable-simd: use simd_arith_offset to avoid ptr-int transmutation", "tree": {"sha": "67abceaffce87da2f2d33c9a00bb6f70d1468321", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/67abceaffce87da2f2d33c9a00bb6f70d1468321"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/64bef2910be17ca75ced3f0a99b4584f69114c74", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/64bef2910be17ca75ced3f0a99b4584f69114c74", "html_url": "https://github.com/rust-lang/rust/commit/64bef2910be17ca75ced3f0a99b4584f69114c74", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/64bef2910be17ca75ced3f0a99b4584f69114c74/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "workingjubilee", "id": 46493976, "node_id": "MDQ6VXNlcjQ2NDkzOTc2", "avatar_url": "https://avatars.githubusercontent.com/u/46493976?v=4", "gravatar_id": "", "url": "https://api.github.com/users/workingjubilee", "html_url": "https://github.com/workingjubilee", "followers_url": "https://api.github.com/users/workingjubilee/followers", "following_url": "https://api.github.com/users/workingjubilee/following{/other_user}", "gists_url": "https://api.github.com/users/workingjubilee/gists{/gist_id}", "starred_url": "https://api.github.com/users/workingjubilee/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/workingjubilee/subscriptions", "organizations_url": "https://api.github.com/users/workingjubilee/orgs", "repos_url": "https://api.github.com/users/workingjubilee/repos", "events_url": "https://api.github.com/users/workingjubilee/events{/privacy}", "received_events_url": "https://api.github.com/users/workingjubilee/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ed8092e96bb5ad10f7242589f2c263746adafa35", "url": "https://api.github.com/repos/rust-lang/rust/commits/ed8092e96bb5ad10f7242589f2c263746adafa35", "html_url": "https://github.com/rust-lang/rust/commit/ed8092e96bb5ad10f7242589f2c263746adafa35"}], "stats": {"total": 15, "additions": 15, "deletions": 0}, "files": [{"sha": "a1de8474fb20167d885e20161cab6467455fbe4d", "filename": "crates/core_simd/src/intrinsics.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/64bef2910be17ca75ced3f0a99b4584f69114c74/crates%2Fcore_simd%2Fsrc%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/64bef2910be17ca75ced3f0a99b4584f69114c74/crates%2Fcore_simd%2Fsrc%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fcore_simd%2Fsrc%2Fintrinsics.rs?ref=64bef2910be17ca75ced3f0a99b4584f69114c74", "patch": "@@ -61,6 +61,10 @@ extern \"platform-intrinsic\" {\n     /// xor\n     pub(crate) fn simd_xor<T>(x: T, y: T) -> T;\n \n+    /// getelementptr (without inbounds)\n+    #[cfg(not(bootstrap))]\n+    pub(crate) fn simd_arith_offset<T, U>(ptrs: T, offsets: U) -> T;\n+\n     /// fptoui/fptosi/uitofp/sitofp\n     /// casting floats to integers is truncating, so it is safe to convert values like e.g. 1.5\n     /// but the truncated value must fit in the target type or the result is poison."}, {"sha": "68a9c67f795af984749230c2934564cee15bfe16", "filename": "crates/core_simd/src/vector/ptr.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/64bef2910be17ca75ced3f0a99b4584f69114c74/crates%2Fcore_simd%2Fsrc%2Fvector%2Fptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/64bef2910be17ca75ced3f0a99b4584f69114c74/crates%2Fcore_simd%2Fsrc%2Fvector%2Fptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fcore_simd%2Fsrc%2Fvector%2Fptr.rs?ref=64bef2910be17ca75ced3f0a99b4584f69114c74", "patch": "@@ -1,5 +1,8 @@\n //! Private implementation details of public gather/scatter APIs.\n+#[cfg(not(bootstrap))]\n+use crate::simd::intrinsics;\n use crate::simd::{LaneCount, Simd, SupportedLaneCount};\n+#[cfg(bootstrap)]\n use core::mem;\n \n /// A vector of *const T.\n@@ -21,12 +24,16 @@ where\n     #[inline]\n     #[must_use]\n     pub fn wrapping_add(self, addend: Simd<usize, LANES>) -> Self {\n+        #[cfg(bootstrap)]\n         // Safety: converting pointers to usize and vice-versa is safe\n         // (even if using that pointer is not)\n         unsafe {\n             let x: Simd<usize, LANES> = mem::transmute_copy(&self);\n             mem::transmute_copy(&{ x + (addend * Simd::splat(mem::size_of::<T>())) })\n         }\n+        #[cfg(not(bootstrap))]\n+        // Safety: this intrinsic doesn't have a precondition\n+        unsafe { intrinsics::simd_arith_offset(self, addend) }\n     }\n }\n \n@@ -49,11 +56,15 @@ where\n     #[inline]\n     #[must_use]\n     pub fn wrapping_add(self, addend: Simd<usize, LANES>) -> Self {\n+        #[cfg(bootstrap)]\n         // Safety: converting pointers to usize and vice-versa is safe\n         // (even if using that pointer is not)\n         unsafe {\n             let x: Simd<usize, LANES> = mem::transmute_copy(&self);\n             mem::transmute_copy(&{ x + (addend * Simd::splat(mem::size_of::<T>())) })\n         }\n+        #[cfg(not(bootstrap))]\n+        // Safety: this intrinsic doesn't have a precondition\n+        unsafe { intrinsics::simd_arith_offset(self, addend) }\n     }\n }"}]}