{"sha": "7e3217845dc5dea331b26efb2bf51b60afae2082", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdlMzIxNzg0NWRjNWRlYTMzMWIyNmVmYjJiZjUxYjYwYWZhZTIwODI=", "commit": {"author": {"name": "J. Ryan Stinnett", "email": "jryans@gmail.com", "date": "2021-01-28T22:03:20Z"}, "committer": {"name": "J. Ryan Stinnett", "email": "jryans@gmail.com", "date": "2021-01-30T14:23:50Z"}, "message": "Balance sidebar `Deref` cycle check with main content\n\nThe `Deref` cycle checks added as part of #80653 were \"unbalanced\" in the sense\nthat the main content code path checks for cycles _before_ descending, while the\nsidebar checks _after_. Checking _before_ is correct, so this changes the\nsidebar path to match the main content path.", "tree": {"sha": "c40c88774ac954d5b09f55aee3b820c53d45c3e5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c40c88774ac954d5b09f55aee3b820c53d45c3e5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7e3217845dc5dea331b26efb2bf51b60afae2082", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7e3217845dc5dea331b26efb2bf51b60afae2082", "html_url": "https://github.com/rust-lang/rust/commit/7e3217845dc5dea331b26efb2bf51b60afae2082", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7e3217845dc5dea331b26efb2bf51b60afae2082/comments", "author": {"login": "jryans", "id": 279572, "node_id": "MDQ6VXNlcjI3OTU3Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/279572?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jryans", "html_url": "https://github.com/jryans", "followers_url": "https://api.github.com/users/jryans/followers", "following_url": "https://api.github.com/users/jryans/following{/other_user}", "gists_url": "https://api.github.com/users/jryans/gists{/gist_id}", "starred_url": "https://api.github.com/users/jryans/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jryans/subscriptions", "organizations_url": "https://api.github.com/users/jryans/orgs", "repos_url": "https://api.github.com/users/jryans/repos", "events_url": "https://api.github.com/users/jryans/events{/privacy}", "received_events_url": "https://api.github.com/users/jryans/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jryans", "id": 279572, "node_id": "MDQ6VXNlcjI3OTU3Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/279572?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jryans", "html_url": "https://github.com/jryans", "followers_url": "https://api.github.com/users/jryans/followers", "following_url": "https://api.github.com/users/jryans/following{/other_user}", "gists_url": "https://api.github.com/users/jryans/gists{/gist_id}", "starred_url": "https://api.github.com/users/jryans/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jryans/subscriptions", "organizations_url": "https://api.github.com/users/jryans/orgs", "repos_url": "https://api.github.com/users/jryans/repos", "events_url": "https://api.github.com/users/jryans/events{/privacy}", "received_events_url": "https://api.github.com/users/jryans/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7ce1b3b24491cbe10669cbe2b5733c2fe7cfe5b7", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ce1b3b24491cbe10669cbe2b5733c2fe7cfe5b7", "html_url": "https://github.com/rust-lang/rust/commit/7ce1b3b24491cbe10669cbe2b5733c2fe7cfe5b7"}], "stats": {"total": 33, "additions": 26, "deletions": 7}, "files": [{"sha": "6909ab870db61a82556b15aebaf0ef2954a34580", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/7e3217845dc5dea331b26efb2bf51b60afae2082/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e3217845dc5dea331b26efb2bf51b60afae2082/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=7e3217845dc5dea331b26efb2bf51b60afae2082", "patch": "@@ -3510,6 +3510,7 @@ fn render_assoc_items(\n                     \"deref-methods-{:#}\",\n                     type_.print(cx.cache())\n                 )));\n+                debug!(\"Adding {} to deref id map\", type_.print(cx.cache()));\n                 cx.deref_id_map\n                     .borrow_mut()\n                     .insert(type_.def_id_full(cx.cache()).unwrap(), id.clone());\n@@ -3626,6 +3627,7 @@ fn render_deref_methods(\n             _ => None,\n         })\n         .expect(\"Expected associated type binding\");\n+    debug!(\"Render deref methods for {:#?}, target {:#?}\", impl_.inner_impl().for_, target);\n     let what =\n         AssocItemRender::DerefFor { trait_: deref_type, type_: real_target, deref_mut_: deref_mut };\n     if let Some(did) = target.def_id_full(cx.cache()) {\n@@ -4416,6 +4418,15 @@ fn sidebar_deref_methods(cx: &Context<'_>, out: &mut Buffer, impl_: &Impl, v: &V\n         })\n     {\n         debug!(\"found target, real_target: {:?} {:?}\", target, real_target);\n+        if let Some(did) = target.def_id_full(cx.cache()) {\n+            if let Some(type_did) = impl_.inner_impl().for_.def_id_full(cx.cache()) {\n+                // `impl Deref<Target = S> for S`\n+                if did == type_did {\n+                    // Avoid infinite cycles\n+                    return;\n+                }\n+            }\n+        }\n         let deref_mut = v\n             .iter()\n             .filter(|i| i.inner_impl().trait_.is_some())\n@@ -4464,13 +4475,6 @@ fn sidebar_deref_methods(cx: &Context<'_>, out: &mut Buffer, impl_: &Impl, v: &V\n                     .filter(|i| i.inner_impl().trait_.is_some())\n                     .find(|i| i.inner_impl().trait_.def_id_full(cx.cache()) == c.deref_trait_did)\n                 {\n-                    if let Some(type_did) = impl_.inner_impl().for_.def_id_full(cx.cache()) {\n-                        // `impl Deref<Target = S> for S`\n-                        if target_did == type_did {\n-                            // Avoid infinite cycles\n-                            return;\n-                        }\n-                    }\n                     sidebar_deref_methods(cx, out, target_deref_impl, target_impls);\n                 }\n             }"}, {"sha": "bc64beb1b939d9207588c6a9f1edca81d1ac8b7e", "filename": "src/test/rustdoc-ui/deref-generic.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/7e3217845dc5dea331b26efb2bf51b60afae2082/src%2Ftest%2Frustdoc-ui%2Fderef-generic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e3217845dc5dea331b26efb2bf51b60afae2082/src%2Ftest%2Frustdoc-ui%2Fderef-generic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fderef-generic.rs?ref=7e3217845dc5dea331b26efb2bf51b60afae2082", "patch": "@@ -0,0 +1,15 @@\n+// check-pass\n+// #81395: Fix ICE when recursing into Deref target only differing in type args\n+\n+pub struct Generic<T>(T);\n+\n+impl<'a> std::ops::Deref for Generic<&'a mut ()> {\n+    type Target = Generic<&'a ()>;\n+    fn deref(&self) -> &Self::Target {\n+        unimplemented!()\n+    }\n+}\n+\n+impl<'a> Generic<&'a ()> {\n+    pub fn some_method(&self) {}\n+}"}]}