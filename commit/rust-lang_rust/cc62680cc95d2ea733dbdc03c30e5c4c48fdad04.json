{"sha": "cc62680cc95d2ea733dbdc03c30e5c4c48fdad04", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNjNjI2ODBjYzk1ZDJlYTczM2RiZGMwM2MzMGU1YzRjNDhmZGFkMDQ=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2013-05-02T21:08:04Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2013-05-02T21:08:04Z"}, "message": "free the borrow list propertly instead of crashing", "tree": {"sha": "5d67f0c706152d6e1dee8457010e6022f63eea4f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5d67f0c706152d6e1dee8457010e6022f63eea4f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cc62680cc95d2ea733dbdc03c30e5c4c48fdad04", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cc62680cc95d2ea733dbdc03c30e5c4c48fdad04", "html_url": "https://github.com/rust-lang/rust/commit/cc62680cc95d2ea733dbdc03c30e5c4c48fdad04", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cc62680cc95d2ea733dbdc03c30e5c4c48fdad04/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4999d44d5b244671492fbdc05121416e05f729eb", "url": "https://api.github.com/repos/rust-lang/rust/commits/4999d44d5b244671492fbdc05121416e05f729eb", "html_url": "https://github.com/rust-lang/rust/commit/4999d44d5b244671492fbdc05121416e05f729eb"}], "stats": {"total": 16, "additions": 15, "deletions": 1}, "files": [{"sha": "5e2f4af184dc45b8c509684c775c28686db59f81", "filename": "src/libcore/cleanup.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/cc62680cc95d2ea733dbdc03c30e5c4c48fdad04/src%2Flibcore%2Fcleanup.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc62680cc95d2ea733dbdc03c30e5c4c48fdad04/src%2Flibcore%2Fcleanup.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fcleanup.rs?ref=cc62680cc95d2ea733dbdc03c30e5c4c48fdad04", "patch": "@@ -15,6 +15,7 @@ use ptr::mut_null;\n use repr::BoxRepr;\n use sys::TypeDesc;\n use cast::transmute;\n+use unstable::lang::clear_task_borrow_list;\n \n #[cfg(notest)] use ptr::to_unsafe_ptr;\n \n@@ -179,6 +180,10 @@ pub unsafe fn annihilate() {\n         n_bytes_freed: 0\n     };\n \n+    // Quick hack: we need to free this list upon task exit, and this\n+    // is a convenient place to do it.\n+    clear_task_borrow_list();\n+\n     // Pass 1: Make all boxes immortal.\n     //\n     // In this pass, nothing gets freed, so it does not matter whether"}, {"sha": "a3e44b5feea4af698dab89ab6acf3281b918b9f6", "filename": "src/libcore/unstable/lang.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/cc62680cc95d2ea733dbdc03c30e5c4c48fdad04/src%2Flibcore%2Funstable%2Flang.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc62680cc95d2ea733dbdc03c30e5c4c48fdad04/src%2Flibcore%2Funstable%2Flang.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Funstable%2Flang.rs?ref=cc62680cc95d2ea733dbdc03c30e5c4c48fdad04", "patch": "@@ -91,7 +91,16 @@ fn swap_task_borrow_list(f: &fn(~[BorrowRecord]) -> ~[BorrowRecord]) {\n     }\n }\n \n-pub fn fail_borrowed(box: *mut BoxRepr, file: *c_char, line: size_t) {\n+pub unsafe fn clear_task_borrow_list() {\n+    // pub because it is used by the box annihilator.\n+    let cur_task = rust_get_task();\n+    let ptr = rustrt::rust_take_task_borrow_list(cur_task);\n+    if !ptr.is_null() {\n+        let _: ~[BorrowRecord] = transmute(ptr);\n+    }\n+}\n+\n+fn fail_borrowed(box: *mut BoxRepr, file: *c_char, line: size_t) {\n     debug_ptr(\"fail_borrowed: \", box);\n \n     if !::rt::env::get().debug_borrows {"}]}