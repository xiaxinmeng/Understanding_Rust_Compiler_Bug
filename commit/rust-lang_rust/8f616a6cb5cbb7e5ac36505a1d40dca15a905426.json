{"sha": "8f616a6cb5cbb7e5ac36505a1d40dca15a905426", "node_id": "C_kwDOAAsO6NoAKDhmNjE2YTZjYjVjYmI3ZTVhYzM2NTA1YTFkNDBkY2ExNWE5MDU0MjY", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2022-04-24T03:59:08Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2022-04-24T03:59:08Z"}, "message": "Fix Reload Workspace command", "tree": {"sha": "a4c4fbb688eba70e98dedef2253aa6c7069bd9cf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a4c4fbb688eba70e98dedef2253aa6c7069bd9cf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8f616a6cb5cbb7e5ac36505a1d40dca15a905426", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8f616a6cb5cbb7e5ac36505a1d40dca15a905426", "html_url": "https://github.com/rust-lang/rust/commit/8f616a6cb5cbb7e5ac36505a1d40dca15a905426", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8f616a6cb5cbb7e5ac36505a1d40dca15a905426/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c61bb6be8c3f45c15a24a26413a665c6c8f63f5c", "url": "https://api.github.com/repos/rust-lang/rust/commits/c61bb6be8c3f45c15a24a26413a665c6c8f63f5c", "html_url": "https://github.com/rust-lang/rust/commit/c61bb6be8c3f45c15a24a26413a665c6c8f63f5c"}], "stats": {"total": 20, "additions": 14, "deletions": 6}, "files": [{"sha": "d005cdb985283cf18c13ca0f23a319ef03f7794e", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/8f616a6cb5cbb7e5ac36505a1d40dca15a905426/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8f616a6cb5cbb7e5ac36505a1d40dca15a905426/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=8f616a6cb5cbb7e5ac36505a1d40dca15a905426", "patch": "@@ -43,6 +43,13 @@ use crate::{\n     to_proto, LspError, Result,\n };\n \n+pub(crate) fn handle_workspace_reload(state: &mut GlobalState, _: ()) -> Result<()> {\n+    state.proc_macro_client = None;\n+    state.fetch_workspaces_queue.request_op(\"reload workspace request\".to_string());\n+    state.fetch_build_data_queue.request_op(\"reload workspace request\".to_string());\n+    Ok(())\n+}\n+\n pub(crate) fn handle_analyzer_status(\n     snap: GlobalStateSnapshot,\n     params: lsp_ext::AnalyzerStatusParams,"}, {"sha": "96f4e2a50b955490a5c7ec88d05bdccba3b44bd1", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/8f616a6cb5cbb7e5ac36505a1d40dca15a905426/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8f616a6cb5cbb7e5ac36505a1d40dca15a905426/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=8f616a6cb5cbb7e5ac36505a1d40dca15a905426", "patch": "@@ -499,9 +499,13 @@ impl GlobalState {\n                 self.fetch_workspaces(cause);\n             }\n         }\n-        if let Some(cause) = self.fetch_build_data_queue.should_start_op() {\n-            self.fetch_build_data(cause);\n+\n+        if !self.fetch_workspaces_queue.op_in_progress() {\n+            if let Some(cause) = self.fetch_build_data_queue.should_start_op() {\n+                self.fetch_build_data(cause);\n+            }\n         }\n+\n         if let Some(cause) = self.prime_caches_queue.should_start_op() {\n             tracing::debug!(%cause, \"will prime caches\");\n             let num_worker_threads = self.config.prime_caches_num_threads();\n@@ -571,14 +575,11 @@ impl GlobalState {\n         }\n \n         RequestDispatcher { req: Some(req), global_state: self }\n-            .on_sync_mut::<lsp_ext::ReloadWorkspace>(|s, ()| {\n-                s.fetch_workspaces_queue.request_op(\"reload workspace request\".to_string());\n-                Ok(())\n-            })?\n             .on_sync_mut::<lsp_types::request::Shutdown>(|s, ()| {\n                 s.shutdown_requested = true;\n                 Ok(())\n             })?\n+            .on_sync_mut::<lsp_ext::ReloadWorkspace>(handlers::handle_workspace_reload)?\n             .on_sync_mut::<lsp_ext::MemoryUsage>(handlers::handle_memory_usage)?\n             .on_sync_mut::<lsp_ext::ShuffleCrateGraph>(handlers::handle_shuffle_crate_graph)?\n             .on_sync::<lsp_ext::JoinLines>(handlers::handle_join_lines)?"}]}