{"sha": "d50a4753b8cffdb17e2d83282d95b61e266521fb", "node_id": "C_kwDOAAsO6NoAKGQ1MGE0NzUzYjhjZmZkYjE3ZTJkODMyODJkOTViNjFlMjY2NTIxZmI", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2021-11-02T13:36:54Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2021-11-02T15:55:50Z"}, "message": "Split doc_cfg and doc_auto_cfg features", "tree": {"sha": "9ec93323785711506e028d852a559709c8453ac1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9ec93323785711506e028d852a559709c8453ac1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d50a4753b8cffdb17e2d83282d95b61e266521fb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d50a4753b8cffdb17e2d83282d95b61e266521fb", "html_url": "https://github.com/rust-lang/rust/commit/d50a4753b8cffdb17e2d83282d95b61e266521fb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d50a4753b8cffdb17e2d83282d95b61e266521fb/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dca3f1b786efd27be3b325ed1e01e247aa589c3b", "url": "https://api.github.com/repos/rust-lang/rust/commits/dca3f1b786efd27be3b325ed1e01e247aa589c3b", "html_url": "https://github.com/rust-lang/rust/commit/dca3f1b786efd27be3b325ed1e01e247aa589c3b"}], "stats": {"total": 33, "additions": 28, "deletions": 5}, "files": [{"sha": "42af8e1faad02238aba4f98483c39a414cc8ef40", "filename": "compiler/rustc_feature/src/active.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d50a4753b8cffdb17e2d83282d95b61e266521fb/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d50a4753b8cffdb17e2d83282d95b61e266521fb/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Factive.rs?ref=d50a4753b8cffdb17e2d83282d95b61e266521fb", "patch": "@@ -688,6 +688,9 @@ declare_features! (\n     /// not changed from prior instances of the same struct (RFC #2528)\n     (incomplete, type_changing_struct_update, \"1.58.0\", Some(86555), None),\n \n+    /// Tells rustdoc to automatically generate `#[doc(cfg(...))]`.\n+    (active, doc_auto_cfg, \"1.58.0\", Some(43781), None),\n+\n     // -------------------------------------------------------------------------\n     // feature-group-end: actual feature gates\n     // -------------------------------------------------------------------------"}, {"sha": "5f71e955e2ad7aad58673357dfad0028f1150137", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d50a4753b8cffdb17e2d83282d95b61e266521fb/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d50a4753b8cffdb17e2d83282d95b61e266521fb/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=d50a4753b8cffdb17e2d83282d95b61e266521fb", "patch": "@@ -549,6 +549,7 @@ symbols! {\n         div_assign,\n         doc,\n         doc_alias,\n+        doc_auto_cfg,\n         doc_cfg,\n         doc_cfg_hide,\n         doc_keyword,"}, {"sha": "56ae43855de924718c08a49e5c85de296bfb4210", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d50a4753b8cffdb17e2d83282d95b61e266521fb/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d50a4753b8cffdb17e2d83282d95b61e266521fb/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=d50a4753b8cffdb17e2d83282d95b61e266521fb", "patch": "@@ -789,6 +789,7 @@ impl AttributesExt for [ast::Attribute] {\n     fn cfg(&self, tcx: TyCtxt<'_>, hidden_cfg: &FxHashSet<Cfg>) -> Option<Arc<Cfg>> {\n         let sess = tcx.sess;\n         let doc_cfg_active = tcx.features().doc_cfg;\n+        let doc_auto_cfg_active = tcx.features().doc_auto_cfg;\n \n         fn single<T: IntoIterator>(it: T) -> Option<T::Item> {\n             let mut iter = it.into_iter();\n@@ -799,24 +800,26 @@ impl AttributesExt for [ast::Attribute] {\n             Some(item)\n         }\n \n-        let mut cfg = if doc_cfg_active {\n+        let mut cfg = if doc_cfg_active || doc_auto_cfg_active {\n             let mut doc_cfg = self\n                 .iter()\n                 .filter(|attr| attr.has_name(sym::doc))\n                 .flat_map(|attr| attr.meta_item_list().unwrap_or_else(Vec::new))\n                 .filter(|attr| attr.has_name(sym::cfg))\n                 .peekable();\n-            if doc_cfg.peek().is_some() {\n+            if doc_cfg.peek().is_some() && doc_cfg_active {\n                 doc_cfg\n                     .filter_map(|attr| Cfg::parse(attr.meta_item()?).ok())\n                     .fold(Cfg::True, |cfg, new_cfg| cfg & new_cfg)\n-            } else {\n+            } else if doc_auto_cfg_active {\n                 self.iter()\n                     .filter(|attr| attr.has_name(sym::cfg))\n                     .filter_map(|attr| single(attr.meta_item_list()?))\n                     .filter_map(|attr| Cfg::parse(attr.meta_item()?).ok())\n                     .filter(|cfg| !hidden_cfg.contains(cfg))\n                     .fold(Cfg::True, |cfg, new_cfg| cfg & new_cfg)\n+            } else {\n+                Cfg::True\n             }\n         } else {\n             Cfg::True"}, {"sha": "fcdd83545696b46fa4d6e0546c8a87e19ea94bcf", "filename": "src/test/rustdoc/doc-auto-cfg.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d50a4753b8cffdb17e2d83282d95b61e266521fb/src%2Ftest%2Frustdoc%2Fdoc-auto-cfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d50a4753b8cffdb17e2d83282d95b61e266521fb/src%2Ftest%2Frustdoc%2Fdoc-auto-cfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fdoc-auto-cfg.rs?ref=d50a4753b8cffdb17e2d83282d95b61e266521fb", "patch": "@@ -0,0 +1,8 @@\n+#![feature(doc_auto_cfg)]\n+\n+#![crate_name = \"foo\"]\n+\n+// @has foo/fn.foo.html\n+// @has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'non-test'\n+#[cfg(not(test))]\n+pub fn foo() {}"}, {"sha": "424fa6d6a911fac841884f3d302fcb7a0805ed6c", "filename": "src/test/rustdoc/doc-cfg-hide.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d50a4753b8cffdb17e2d83282d95b61e266521fb/src%2Ftest%2Frustdoc%2Fdoc-cfg-hide.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d50a4753b8cffdb17e2d83282d95b61e266521fb/src%2Ftest%2Frustdoc%2Fdoc-cfg-hide.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fdoc-cfg-hide.rs?ref=d50a4753b8cffdb17e2d83282d95b61e266521fb", "patch": "@@ -1,5 +1,5 @@\n #![crate_name = \"oud\"]\n-#![feature(doc_cfg, doc_cfg_hide)]\n+#![feature(doc_auto_cfg, doc_cfg, doc_cfg_hide)]\n \n #![doc(cfg_hide(feature = \"solecism\"))]\n "}, {"sha": "5d17a4ede6adcb16da2a182c0abe50e36b64132f", "filename": "src/test/rustdoc/doc-cfg-implicit.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d50a4753b8cffdb17e2d83282d95b61e266521fb/src%2Ftest%2Frustdoc%2Fdoc-cfg-implicit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d50a4753b8cffdb17e2d83282d95b61e266521fb/src%2Ftest%2Frustdoc%2Fdoc-cfg-implicit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fdoc-cfg-implicit.rs?ref=d50a4753b8cffdb17e2d83282d95b61e266521fb", "patch": "@@ -1,5 +1,5 @@\n #![crate_name = \"funambulism\"]\n-#![feature(doc_cfg)]\n+#![feature(doc_auto_cfg, doc_cfg)]\n \n // @has 'funambulism/struct.Disorbed.html'\n // @count   - '//*[@class=\"stab portability\"]' 1"}, {"sha": "da76381e4800064b7b3327bf62693605b44e4e65", "filename": "src/test/rustdoc/feature-gate-doc_auto_cfg.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d50a4753b8cffdb17e2d83282d95b61e266521fb/src%2Ftest%2Frustdoc%2Ffeature-gate-doc_auto_cfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d50a4753b8cffdb17e2d83282d95b61e266521fb/src%2Ftest%2Frustdoc%2Ffeature-gate-doc_auto_cfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Ffeature-gate-doc_auto_cfg.rs?ref=d50a4753b8cffdb17e2d83282d95b61e266521fb", "patch": "@@ -0,0 +1,8 @@\n+#![feature(doc_cfg)]\n+\n+#![crate_name = \"foo\"]\n+\n+// @has foo/fn.foo.html\n+// @count - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 0\n+#[cfg(not(test))]\n+pub fn foo() {}"}]}