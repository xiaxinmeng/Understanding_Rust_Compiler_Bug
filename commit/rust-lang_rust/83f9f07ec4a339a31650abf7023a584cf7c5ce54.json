{"sha": "83f9f07ec4a339a31650abf7023a584cf7c5ce54", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgzZjlmMDdlYzRhMzM5YTMxNjUwYWJmNzAyM2E1ODRjZjdjNWNlNTQ=", "commit": {"author": {"name": "Erick Tryzelaar", "email": "erick.tryzelaar@gmail.com", "date": "2014-07-04T18:08:38Z"}, "committer": {"name": "Erick Tryzelaar", "email": "erick.tryzelaar@gmail.com", "date": "2014-07-04T18:08:38Z"}, "message": "serialize: Remove allocations from escaping strs and indenting spaces", "tree": {"sha": "7a503764954bb9c997aabbcde192597c4329e60c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7a503764954bb9c997aabbcde192597c4329e60c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/83f9f07ec4a339a31650abf7023a584cf7c5ce54", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/83f9f07ec4a339a31650abf7023a584cf7c5ce54", "html_url": "https://github.com/rust-lang/rust/commit/83f9f07ec4a339a31650abf7023a584cf7c5ce54", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/83f9f07ec4a339a31650abf7023a584cf7c5ce54/comments", "author": {"login": "erickt", "id": 84711, "node_id": "MDQ6VXNlcjg0NzEx", "avatar_url": "https://avatars.githubusercontent.com/u/84711?v=4", "gravatar_id": "", "url": "https://api.github.com/users/erickt", "html_url": "https://github.com/erickt", "followers_url": "https://api.github.com/users/erickt/followers", "following_url": "https://api.github.com/users/erickt/following{/other_user}", "gists_url": "https://api.github.com/users/erickt/gists{/gist_id}", "starred_url": "https://api.github.com/users/erickt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/erickt/subscriptions", "organizations_url": "https://api.github.com/users/erickt/orgs", "repos_url": "https://api.github.com/users/erickt/repos", "events_url": "https://api.github.com/users/erickt/events{/privacy}", "received_events_url": "https://api.github.com/users/erickt/received_events", "type": "User", "site_admin": false}, "committer": {"login": "erickt", "id": 84711, "node_id": "MDQ6VXNlcjg0NzEx", "avatar_url": "https://avatars.githubusercontent.com/u/84711?v=4", "gravatar_id": "", "url": "https://api.github.com/users/erickt", "html_url": "https://github.com/erickt", "followers_url": "https://api.github.com/users/erickt/followers", "following_url": "https://api.github.com/users/erickt/following{/other_user}", "gists_url": "https://api.github.com/users/erickt/gists{/gist_id}", "starred_url": "https://api.github.com/users/erickt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/erickt/subscriptions", "organizations_url": "https://api.github.com/users/erickt/orgs", "repos_url": "https://api.github.com/users/erickt/repos", "events_url": "https://api.github.com/users/erickt/events{/privacy}", "received_events_url": "https://api.github.com/users/erickt/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "04ac2b087e10c8d23e41d5f910ea2069e77c9e73", "url": "https://api.github.com/repos/rust-lang/rust/commits/04ac2b087e10c8d23e41d5f910ea2069e77c9e73", "html_url": "https://github.com/rust-lang/rust/commit/04ac2b087e10c8d23e41d5f910ea2069e77c9e73"}], "stats": {"total": 101, "additions": 63, "deletions": 38}, "files": [{"sha": "49f929d4658a0c446ea5631e401422780111d2db", "filename": "src/libserialize/json.rs", "status": "modified", "additions": 63, "deletions": 38, "changes": 101, "blob_url": "https://github.com/rust-lang/rust/blob/83f9f07ec4a339a31650abf7023a584cf7c5ce54/src%2Flibserialize%2Fjson.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83f9f07ec4a339a31650abf7023a584cf7c5ce54/src%2Flibserialize%2Fjson.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibserialize%2Fjson.rs?ref=83f9f07ec4a339a31650abf7023a584cf7c5ce54", "patch": "@@ -256,22 +256,38 @@ fn io_error_to_error(io: io::IoError) -> ParserError {\n pub type EncodeResult = io::IoResult<()>;\n pub type DecodeResult<T> = Result<T, DecoderError>;\n \n-fn escape_str(s: &str) -> String {\n-    let mut escaped = String::from_str(\"\\\"\");\n-    for c in s.chars() {\n-        match c {\n-            '\"' => escaped.push_str(\"\\\\\\\"\"),\n-            '\\\\' => escaped.push_str(\"\\\\\\\\\"),\n-            '\\x08' => escaped.push_str(\"\\\\b\"),\n-            '\\x0c' => escaped.push_str(\"\\\\f\"),\n-            '\\n' => escaped.push_str(\"\\\\n\"),\n-            '\\r' => escaped.push_str(\"\\\\r\"),\n-            '\\t' => escaped.push_str(\"\\\\t\"),\n-            _ => escaped.push_char(c),\n-        }\n-    };\n-    escaped.push_char('\"');\n-    escaped\n+fn escape_bytes(writer: &mut io::Writer, s: &[u8]) -> Result<(), io::IoError> {\n+    try!(writer.write_str(\"\\\"\"));\n+    for byte in s.iter() {\n+        match *byte {\n+            b'\"' => try!(writer.write_str(\"\\\\\\\"\")),\n+            b'\\\\' => try!(writer.write_str(\"\\\\\\\\\")),\n+            b'\\x08' => try!(writer.write_str(\"\\\\b\")),\n+            b'\\x0c' => try!(writer.write_str(\"\\\\f\")),\n+            b'\\n' => try!(writer.write_str(\"\\\\n\")),\n+            b'\\r' => try!(writer.write_str(\"\\\\r\")),\n+            b'\\t' => try!(writer.write_str(\"\\\\t\")),\n+            _ => try!(writer.write_u8(*byte)),\n+        }\n+    }\n+    writer.write_str(\"\\\"\")\n+}\n+\n+fn escape_str(writer: &mut io::Writer, v: &str) -> Result<(), io::IoError> {\n+    escape_bytes(writer, v.as_bytes())\n+}\n+\n+fn escape_char(writer: &mut io::Writer, v: char) -> Result<(), io::IoError> {\n+    let mut buf = [0, .. 4];\n+    v.encode_utf8(buf);\n+    escape_bytes(writer, buf)\n+}\n+\n+fn spaces(writer: &mut io::Writer, n: uint) -> Result<(), io::IoError> {\n+    for _ in range(0, n) {\n+        try!(writer.write_str(\" \"));\n+    }\n+    Ok(())\n }\n \n fn fmt_number_or_null(v: f64) -> String {\n@@ -281,10 +297,6 @@ fn fmt_number_or_null(v: f64) -> String {\n     }\n }\n \n-fn spaces(n: uint) -> String {\n-    String::from_char(n, ' ')\n-}\n-\n /// A structure for implementing serialization to JSON.\n pub struct Encoder<'a> {\n     writer: &'a mut io::Writer,\n@@ -348,10 +360,10 @@ impl<'a> ::Encoder<io::IoError> for Encoder<'a> {\n     fn emit_f32(&mut self, v: f32) -> EncodeResult { self.emit_f64(v as f64) }\n \n     fn emit_char(&mut self, v: char) -> EncodeResult {\n-        self.emit_str(str::from_char(v).as_slice())\n+        escape_char(self.writer, v)\n     }\n     fn emit_str(&mut self, v: &str) -> EncodeResult {\n-        write!(self.writer, \"{}\", escape_str(v))\n+        escape_str(self.writer, v)\n     }\n \n     fn emit_enum(&mut self, _name: &str, f: |&mut Encoder<'a>| -> EncodeResult) -> EncodeResult {\n@@ -367,10 +379,10 @@ impl<'a> ::Encoder<io::IoError> for Encoder<'a> {\n         // Bunny => \"Bunny\"\n         // Kangaroo(34,\"William\") => {\"variant\": \"Kangaroo\", \"fields\": [34,\"William\"]}\n         if cnt == 0 {\n-            write!(self.writer, \"{}\", escape_str(name))\n+            escape_str(self.writer, name)\n         } else {\n             try!(write!(self.writer, \"{{\\\"variant\\\":\"));\n-            try!(write!(self.writer, \"{}\", escape_str(name)));\n+            try!(escape_str(self.writer, name));\n             try!(write!(self.writer, \",\\\"fields\\\":[\"));\n             try!(f(self));\n             write!(self.writer, \"]}}\")\n@@ -415,7 +427,8 @@ impl<'a> ::Encoder<io::IoError> for Encoder<'a> {\n                          idx: uint,\n                          f: |&mut Encoder<'a>| -> EncodeResult) -> EncodeResult {\n         if idx != 0 { try!(write!(self.writer, \",\")); }\n-        try!(write!(self.writer, \"{}:\", escape_str(name)));\n+        try!(escape_str(self.writer, name));\n+        try!(write!(self.writer, \":\"));\n         f(self)\n     }\n \n@@ -541,10 +554,10 @@ impl<'a> ::Encoder<io::IoError> for PrettyEncoder<'a> {\n     }\n \n     fn emit_char(&mut self, v: char) -> EncodeResult {\n-        self.emit_str(str::from_char(v).as_slice())\n+        escape_char(self.writer, v)\n     }\n     fn emit_str(&mut self, v: &str) -> EncodeResult {\n-        write!(self.writer, \"{}\", escape_str(v))\n+        escape_str(self.writer, v)\n     }\n \n     fn emit_enum(&mut self,\n@@ -559,14 +572,18 @@ impl<'a> ::Encoder<io::IoError> for PrettyEncoder<'a> {\n                          cnt: uint,\n                          f: |&mut PrettyEncoder<'a>| -> EncodeResult) -> EncodeResult {\n         if cnt == 0 {\n-            write!(self.writer, \"{}\", escape_str(name))\n+            escape_str(self.writer, name)\n         } else {\n             self.indent += 2;\n-            try!(write!(self.writer, \"[\\n{}{},\\n\", spaces(self.indent),\n-                          escape_str(name)));\n+            try!(write!(self.writer, \"[\\n\"));\n+            try!(spaces(self.writer, self.indent));\n+            try!(escape_str(self.writer, name));\n+            try!(write!(self.writer, \",\\n\"));\n             try!(f(self));\n             self.indent -= 2;\n-            write!(self.writer, \"\\n{}]\", spaces(self.indent))\n+            try!(write!(self.writer, \"\\n\"));\n+            try!(spaces(self.writer, self.indent));\n+            write!(self.writer, \"]\")\n         }\n     }\n \n@@ -576,7 +593,7 @@ impl<'a> ::Encoder<io::IoError> for PrettyEncoder<'a> {\n         if idx != 0 {\n             try!(write!(self.writer, \",\\n\"));\n         }\n-        try!(write!(self.writer, \"{}\", spaces(self.indent)));\n+        try!(spaces(self.writer, self.indent));\n         f(self)\n     }\n \n@@ -607,7 +624,9 @@ impl<'a> ::Encoder<io::IoError> for PrettyEncoder<'a> {\n             self.indent += 2;\n             try!(f(self));\n             self.indent -= 2;\n-            write!(self.writer, \"\\n{}}}\", spaces(self.indent))\n+            try!(write!(self.writer, \"\\n\"));\n+            try!(spaces(self.writer, self.indent));\n+            write!(self.writer, \"}}\")\n         }\n     }\n \n@@ -620,7 +639,9 @@ impl<'a> ::Encoder<io::IoError> for PrettyEncoder<'a> {\n         } else {\n             try!(write!(self.writer, \",\\n\"));\n         }\n-        try!(write!(self.writer, \"{}{}: \", spaces(self.indent), escape_str(name)));\n+        try!(spaces(self.writer, self.indent));\n+        try!(escape_str(self.writer, name));\n+        try!(write!(self.writer, \": \"));\n         f(self)\n     }\n \n@@ -665,7 +686,9 @@ impl<'a> ::Encoder<io::IoError> for PrettyEncoder<'a> {\n             self.indent += 2;\n             try!(f(self));\n             self.indent -= 2;\n-            write!(self.writer, \"\\n{}]\", spaces(self.indent))\n+            try!(write!(self.writer, \"\\n\"));\n+            try!(spaces(self.writer, self.indent));\n+            write!(self.writer, \"]\")\n         }\n     }\n \n@@ -677,7 +700,7 @@ impl<'a> ::Encoder<io::IoError> for PrettyEncoder<'a> {\n         } else {\n             try!(write!(self.writer, \",\\n\"));\n         }\n-        try!(write!(self.writer, \"{}\", spaces(self.indent)));\n+        try!(spaces(self.writer, self.indent));\n         f(self)\n     }\n \n@@ -691,7 +714,9 @@ impl<'a> ::Encoder<io::IoError> for PrettyEncoder<'a> {\n             self.indent += 2;\n             try!(f(self));\n             self.indent -= 2;\n-            write!(self.writer, \"\\n{}}}\", spaces(self.indent))\n+            try!(write!(self.writer, \"\\n\"));\n+            try!(spaces(self.writer, self.indent));\n+            write!(self.writer, \"}}\")\n         }\n     }\n \n@@ -703,7 +728,7 @@ impl<'a> ::Encoder<io::IoError> for PrettyEncoder<'a> {\n         } else {\n             try!(write!(self.writer, \",\\n\"));\n         }\n-        try!(write!(self.writer, \"{}\", spaces(self.indent)));\n+        try!(spaces(self.writer, self.indent));\n         // ref #12967, make sure to wrap a key in double quotes,\n         // in the event that its of a type that omits them (eg numbers)\n         let mut buf = MemWriter::new();"}]}