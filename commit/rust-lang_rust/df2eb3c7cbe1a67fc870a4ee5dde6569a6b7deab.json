{"sha": "df2eb3c7cbe1a67fc870a4ee5dde6569a6b7deab", "node_id": "C_kwDOAAsO6NoAKGRmMmViM2M3Y2JlMWE2N2ZjODcwYTRlZTVkZGU2NTY5YTZiN2RlYWI", "commit": {"author": {"name": "DropDemBits", "email": "r3usrlnd@gmail.com", "date": "2022-02-14T23:46:16Z"}, "committer": {"name": "DropDemBits", "email": "r3usrlnd@gmail.com", "date": "2022-02-15T00:37:01Z"}, "message": "fix: Don't drop tree when the other has `self`", "tree": {"sha": "e73bd6dfbf41608056b19b64be2812ae28be4286", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e73bd6dfbf41608056b19b64be2812ae28be4286"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/df2eb3c7cbe1a67fc870a4ee5dde6569a6b7deab", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCgAdFiEEosE1rSpoNOieSVDGiUkQv4PnA0cFAmIK9a0ACgkQiUkQv4Pn\nA0dt6gv/UexiPdthi8rDXF958qtbyj5GeNe05we4dpo3S2nuzuLgdiXlkeCnL6HA\ncMreRVLXXRHXahhpxGk74lceYgFfiv90nYevvG/6DoDtFcNzhjlaTBsXwRvqu8wh\nHoqa7SLx/WgIYAhZ2oOLhV15UpW3bOKwdezUIRl50gY+aaBO8PUK49nJNrdJZnrE\ncz/bCFd4Nkd4Vx0NAj9mqQzIM/8Dq2KnFYkPSZUgyZz9PPK1eX8b/0PsURFd1rwH\nj1KD7jthA/ilnd5l/EZYBcBXQ0oY8rM91mG4Y90uQAkSulQCZ3nVTu94EwQli0KA\nlojhFhR0oqrw3ZfKkhovCNCp/adGWXQ/skxsyzmutfIr0WFVjAAQaJwOjPKZdbWc\nYo16oyiVXKEQXLlbTSwPD2hi5sxUzBjjx9PhXnZu7xPV3T//cViAK0UhsVJJxwJe\nFE8pWQzlkdowDdY5AjZtN39VYl+3e/UUekvbIYSLiADYVoB7wOc6LrEQJ4f+rMVK\naW0PNUR0\n=j37e\n-----END PGP SIGNATURE-----", "payload": "tree e73bd6dfbf41608056b19b64be2812ae28be4286\nparent 014d3ef1a4b69c4329aba9e0c27cd7a8649e33c2\nauthor DropDemBits <r3usrlnd@gmail.com> 1644882376 -0500\ncommitter DropDemBits <r3usrlnd@gmail.com> 1644885421 -0500\n\nfix: Don't drop tree when the other has `self`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/df2eb3c7cbe1a67fc870a4ee5dde6569a6b7deab", "html_url": "https://github.com/rust-lang/rust/commit/df2eb3c7cbe1a67fc870a4ee5dde6569a6b7deab", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/df2eb3c7cbe1a67fc870a4ee5dde6569a6b7deab/comments", "author": {"login": "DropDemBits", "id": 13354275, "node_id": "MDQ6VXNlcjEzMzU0Mjc1", "avatar_url": "https://avatars.githubusercontent.com/u/13354275?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DropDemBits", "html_url": "https://github.com/DropDemBits", "followers_url": "https://api.github.com/users/DropDemBits/followers", "following_url": "https://api.github.com/users/DropDemBits/following{/other_user}", "gists_url": "https://api.github.com/users/DropDemBits/gists{/gist_id}", "starred_url": "https://api.github.com/users/DropDemBits/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DropDemBits/subscriptions", "organizations_url": "https://api.github.com/users/DropDemBits/orgs", "repos_url": "https://api.github.com/users/DropDemBits/repos", "events_url": "https://api.github.com/users/DropDemBits/events{/privacy}", "received_events_url": "https://api.github.com/users/DropDemBits/received_events", "type": "User", "site_admin": false}, "committer": {"login": "DropDemBits", "id": 13354275, "node_id": "MDQ6VXNlcjEzMzU0Mjc1", "avatar_url": "https://avatars.githubusercontent.com/u/13354275?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DropDemBits", "html_url": "https://github.com/DropDemBits", "followers_url": "https://api.github.com/users/DropDemBits/followers", "following_url": "https://api.github.com/users/DropDemBits/following{/other_user}", "gists_url": "https://api.github.com/users/DropDemBits/gists{/gist_id}", "starred_url": "https://api.github.com/users/DropDemBits/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DropDemBits/subscriptions", "organizations_url": "https://api.github.com/users/DropDemBits/orgs", "repos_url": "https://api.github.com/users/DropDemBits/repos", "events_url": "https://api.github.com/users/DropDemBits/events{/privacy}", "received_events_url": "https://api.github.com/users/DropDemBits/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "014d3ef1a4b69c4329aba9e0c27cd7a8649e33c2", "url": "https://api.github.com/repos/rust-lang/rust/commits/014d3ef1a4b69c4329aba9e0c27cd7a8649e33c2", "html_url": "https://github.com/rust-lang/rust/commit/014d3ef1a4b69c4329aba9e0c27cd7a8649e33c2"}], "stats": {"total": 74, "additions": 71, "deletions": 3}, "files": [{"sha": "cf30897ab42c9514da1332790c8644f789349aae", "filename": "crates/ide_assists/src/handlers/merge_imports.rs", "status": "modified", "additions": 69, "deletions": 0, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/df2eb3c7cbe1a67fc870a4ee5dde6569a6b7deab/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmerge_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df2eb3c7cbe1a67fc870a4ee5dde6569a6b7deab/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmerge_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmerge_imports.rs?ref=df2eb3c7cbe1a67fc870a4ee5dde6569a6b7deab", "patch": "@@ -252,6 +252,75 @@ use std::{fmt::{Display, Debug}};\n         );\n     }\n \n+    #[test]\n+    fn test_merge_with_nested_self_item() {\n+        check_assist(\n+            merge_imports,\n+            r\"\n+use std$0::{fmt::{Write, Display}};\n+use std::{fmt::{self, Debug}};\n+\",\n+            r\"\n+use std::{fmt::{Write, Display, self, Debug}};\n+\",\n+        );\n+    }\n+\n+    #[test]\n+    fn test_merge_with_nested_self_item2() {\n+        check_assist(\n+            merge_imports,\n+            r\"\n+use std$0::{fmt::{self, Debug}};\n+use std::{fmt::{Write, Display}};\n+\",\n+            r\"\n+use std::{fmt::{self, Debug, Write, Display}};\n+\",\n+        );\n+    }\n+\n+    #[test]\n+    fn test_merge_self_with_nested_self_item() {\n+        check_assist(\n+            merge_imports,\n+            r\"\n+use std::{fmt$0::{self, Debug}, fmt::{Write, Display}};\n+\",\n+            r\"\n+use std::{fmt::{self, Debug, Write, Display}};\n+\",\n+        );\n+    }\n+\n+    #[test]\n+    fn test_merge_nested_self_and_empty() {\n+        check_assist(\n+            merge_imports,\n+            r\"\n+use foo::$0{bar::{self}};\n+use foo::{bar};\n+\",\n+            r\"\n+use foo::{bar::{self}};\n+\",\n+        )\n+    }\n+\n+    #[test]\n+    fn test_merge_nested_empty_and_self() {\n+        check_assist(\n+            merge_imports,\n+            r\"\n+use foo::$0{bar};\n+use foo::{bar::{self}};\n+\",\n+            r\"\n+use foo::{bar::{self}};\n+\",\n+        )\n+    }\n+\n     #[test]\n     fn test_merge_single_wildcard_diff_prefixes() {\n         check_assist("}, {"sha": "614784b467456b7ff887b03615de98270d859084", "filename": "crates/ide_db/src/helpers/merge_imports.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/df2eb3c7cbe1a67fc870a4ee5dde6569a6b7deab/crates%2Fide_db%2Fsrc%2Fhelpers%2Fmerge_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df2eb3c7cbe1a67fc870a4ee5dde6569a6b7deab/crates%2Fide_db%2Fsrc%2Fhelpers%2Fmerge_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fhelpers%2Fmerge_imports.rs?ref=df2eb3c7cbe1a67fc870a4ee5dde6569a6b7deab", "patch": "@@ -115,11 +115,10 @@ fn recursive_merge(lhs: &ast::UseTree, rhs: &ast::UseTree, merge: MergeBehavior)\n                     let tree_contains_self = |tree: &ast::UseTree| {\n                         tree.use_tree_list()\n                             .map(|tree_list| tree_list.use_trees().any(|it| tree_is_self(&it)))\n-                            .unwrap_or(false)\n                     };\n                     match (tree_contains_self(lhs_t), tree_contains_self(&rhs_t)) {\n-                        (true, false) => continue,\n-                        (false, true) => {\n+                        (Some(true), None) => continue,\n+                        (None, Some(true)) => {\n                             ted::replace(lhs_t.syntax(), rhs_t.syntax());\n                             *lhs_t = rhs_t;\n                             continue;"}]}