{"sha": "d5d5a569264d6ca18ff4d4648d62a81ce85114f7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ1ZDVhNTY5MjY0ZDZjYTE4ZmY0ZDQ2NDhkNjJhODFjZTg1MTE0Zjc=", "commit": {"author": {"name": "David Cook", "email": "divergentdave@gmail.com", "date": "2020-04-05T18:25:49Z"}, "committer": {"name": "David Cook", "email": "divergentdave@gmail.com", "date": "2020-04-05T18:25:49Z"}, "message": "Add tests", "tree": {"sha": "7310ab7f5262339951949d3bf6aaf63a3e9ad76f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7310ab7f5262339951949d3bf6aaf63a3e9ad76f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d5d5a569264d6ca18ff4d4648d62a81ce85114f7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d5d5a569264d6ca18ff4d4648d62a81ce85114f7", "html_url": "https://github.com/rust-lang/rust/commit/d5d5a569264d6ca18ff4d4648d62a81ce85114f7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d5d5a569264d6ca18ff4d4648d62a81ce85114f7/comments", "author": {"login": "divergentdave", "id": 181772, "node_id": "MDQ6VXNlcjE4MTc3Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/181772?v=4", "gravatar_id": "", "url": "https://api.github.com/users/divergentdave", "html_url": "https://github.com/divergentdave", "followers_url": "https://api.github.com/users/divergentdave/followers", "following_url": "https://api.github.com/users/divergentdave/following{/other_user}", "gists_url": "https://api.github.com/users/divergentdave/gists{/gist_id}", "starred_url": "https://api.github.com/users/divergentdave/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/divergentdave/subscriptions", "organizations_url": "https://api.github.com/users/divergentdave/orgs", "repos_url": "https://api.github.com/users/divergentdave/repos", "events_url": "https://api.github.com/users/divergentdave/events{/privacy}", "received_events_url": "https://api.github.com/users/divergentdave/received_events", "type": "User", "site_admin": false}, "committer": {"login": "divergentdave", "id": 181772, "node_id": "MDQ6VXNlcjE4MTc3Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/181772?v=4", "gravatar_id": "", "url": "https://api.github.com/users/divergentdave", "html_url": "https://github.com/divergentdave", "followers_url": "https://api.github.com/users/divergentdave/followers", "following_url": "https://api.github.com/users/divergentdave/following{/other_user}", "gists_url": "https://api.github.com/users/divergentdave/gists{/gist_id}", "starred_url": "https://api.github.com/users/divergentdave/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/divergentdave/subscriptions", "organizations_url": "https://api.github.com/users/divergentdave/orgs", "repos_url": "https://api.github.com/users/divergentdave/repos", "events_url": "https://api.github.com/users/divergentdave/events{/privacy}", "received_events_url": "https://api.github.com/users/divergentdave/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e7944419d4b7403c51028204ec5c4c53e776e94a", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7944419d4b7403c51028204ec5c4c53e776e94a", "html_url": "https://github.com/rust-lang/rust/commit/e7944419d4b7403c51028204ec5c4c53e776e94a"}], "stats": {"total": 73, "additions": 73, "deletions": 0}, "files": [{"sha": "7034bf64ec9019fdb65d07570e5ad084ecc0a20e", "filename": "tests/compile-fail/libc_pthread_mutex_normal_deadlock.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d5d5a569264d6ca18ff4d4648d62a81ce85114f7/tests%2Fcompile-fail%2Flibc_pthread_mutex_normal_deadlock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5d5a569264d6ca18ff4d4648d62a81ce85114f7/tests%2Fcompile-fail%2Flibc_pthread_mutex_normal_deadlock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Flibc_pthread_mutex_normal_deadlock.rs?ref=d5d5a569264d6ca18ff4d4648d62a81ce85114f7", "patch": "@@ -0,0 +1,16 @@\n+// ignore-windows: No libc on Windows\n+\n+#![feature(rustc_private)]\n+\n+extern crate libc;\n+\n+fn main() {\n+    unsafe {\n+        let mut mutexattr: libc::pthread_mutexattr_t = std::mem::zeroed();\n+        assert_eq!(libc::pthread_mutexattr_settype(&mut mutexattr as *mut _, libc::PTHREAD_MUTEX_NORMAL), 0);\n+        let mut mutex: libc::pthread_mutex_t = std::mem::zeroed();\n+        assert_eq!(libc::pthread_mutex_init(&mut mutex as *mut _, &mutexattr as *const _), 0);\n+        assert_eq!(libc::pthread_mutex_lock(&mut mutex as *mut _), 0);\n+        libc::pthread_mutex_lock(&mut mutex as *mut _); //~ ERROR deadlock\n+    }\n+}"}, {"sha": "dd4707d60e4ca1c6700f81af58a426539328f708", "filename": "tests/compile-fail/libc_pthread_rwlock_read_write_deadlock.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d5d5a569264d6ca18ff4d4648d62a81ce85114f7/tests%2Fcompile-fail%2Flibc_pthread_rwlock_read_write_deadlock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5d5a569264d6ca18ff4d4648d62a81ce85114f7/tests%2Fcompile-fail%2Flibc_pthread_rwlock_read_write_deadlock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Flibc_pthread_rwlock_read_write_deadlock.rs?ref=d5d5a569264d6ca18ff4d4648d62a81ce85114f7", "patch": "@@ -0,0 +1,13 @@\n+// ignore-windows: No libc on Windows\n+\n+#![feature(rustc_private)]\n+\n+extern crate libc;\n+\n+fn main() {\n+    let rw = std::cell::UnsafeCell::new(libc::PTHREAD_RWLOCK_INITIALIZER);\n+    unsafe {\n+        assert_eq!(libc::pthread_rwlock_rdlock(rw.get()), 0);\n+        libc::pthread_rwlock_wrlock(rw.get()); //~ ERROR: deadlock\n+    }\n+}"}, {"sha": "1b460e7174d28f40f8c56fc89fc15d7762ff4596", "filename": "tests/compile-fail/libc_pthread_rwlock_write_read_deadlock.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d5d5a569264d6ca18ff4d4648d62a81ce85114f7/tests%2Fcompile-fail%2Flibc_pthread_rwlock_write_read_deadlock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5d5a569264d6ca18ff4d4648d62a81ce85114f7/tests%2Fcompile-fail%2Flibc_pthread_rwlock_write_read_deadlock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Flibc_pthread_rwlock_write_read_deadlock.rs?ref=d5d5a569264d6ca18ff4d4648d62a81ce85114f7", "patch": "@@ -0,0 +1,13 @@\n+// ignore-windows: No libc on Windows\n+\n+#![feature(rustc_private)]\n+\n+extern crate libc;\n+\n+fn main() {\n+    let rw = std::cell::UnsafeCell::new(libc::PTHREAD_RWLOCK_INITIALIZER);\n+    unsafe {\n+        assert_eq!(libc::pthread_rwlock_wrlock(rw.get()), 0);\n+        libc::pthread_rwlock_rdlock(rw.get()); //~ ERROR: deadlock\n+    }\n+}"}, {"sha": "cc327ec46bc2989ed0302bb1d91afec0230d6662", "filename": "tests/compile-fail/libc_pthread_rwlock_write_write_deadlock.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d5d5a569264d6ca18ff4d4648d62a81ce85114f7/tests%2Fcompile-fail%2Flibc_pthread_rwlock_write_write_deadlock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5d5a569264d6ca18ff4d4648d62a81ce85114f7/tests%2Fcompile-fail%2Flibc_pthread_rwlock_write_write_deadlock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Flibc_pthread_rwlock_write_write_deadlock.rs?ref=d5d5a569264d6ca18ff4d4648d62a81ce85114f7", "patch": "@@ -0,0 +1,13 @@\n+// ignore-windows: No libc on Windows\n+\n+#![feature(rustc_private)]\n+\n+extern crate libc;\n+\n+fn main() {\n+    let rw = std::cell::UnsafeCell::new(libc::PTHREAD_RWLOCK_INITIALIZER);\n+    unsafe {\n+        assert_eq!(libc::pthread_rwlock_wrlock(rw.get()), 0);\n+        libc::pthread_rwlock_wrlock(rw.get()); //~ ERROR: deadlock\n+    }\n+}"}, {"sha": "c930a034b130bd02d93e1e87e653f5ba9cefe558", "filename": "tests/run-pass/libc.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d5d5a569264d6ca18ff4d4648d62a81ce85114f7/tests%2Frun-pass%2Flibc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5d5a569264d6ca18ff4d4648d62a81ce85114f7/tests%2Frun-pass%2Flibc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Flibc.rs?ref=d5d5a569264d6ca18ff4d4648d62a81ce85114f7", "patch": "@@ -78,6 +78,23 @@ fn test_mutex_libc_init_normal() {\n     }\n }\n \n+fn test_mutex_libc_init_errorcheck() {\n+    unsafe {\n+        let mut mutexattr: libc::pthread_mutexattr_t = std::mem::zeroed();\n+        assert_eq!(libc::pthread_mutexattr_settype(&mut mutexattr as *mut _, libc::PTHREAD_MUTEX_ERRORCHECK), 0);\n+        let mut mutex: libc::pthread_mutex_t = std::mem::zeroed();\n+        assert_eq!(libc::pthread_mutex_init(&mut mutex as *mut _, &mutexattr as *const _), 0);\n+        assert_eq!(libc::pthread_mutex_lock(&mut mutex as *mut _), 0);\n+        assert_eq!(libc::pthread_mutex_trylock(&mut mutex as *mut _), libc::EBUSY);\n+        assert_eq!(libc::pthread_mutex_lock(&mut mutex as *mut _), libc::EDEADLK);\n+        assert_eq!(libc::pthread_mutex_unlock(&mut mutex as *mut _), 0);\n+        assert_eq!(libc::pthread_mutex_trylock(&mut mutex as *mut _), 0);\n+        assert_eq!(libc::pthread_mutex_unlock(&mut mutex as *mut _), 0);\n+        assert_eq!(libc::pthread_mutex_unlock(&mut mutex as *mut _), libc::EPERM);\n+        assert_eq!(libc::pthread_mutex_destroy(&mut mutex as *mut _), 0);\n+    }\n+}\n+\n // Only linux provides PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP,\n // libc for macOS just has the default PTHREAD_MUTEX_INITIALIZER.\n #[cfg(target_os = \"linux\")]\n@@ -126,6 +143,7 @@ fn main() {\n \n     test_mutex_libc_init_recursive();\n     test_mutex_libc_init_normal();\n+    test_mutex_libc_init_errorcheck();\n     test_rwlock_libc_static_initializer();\n \n     #[cfg(target_os = \"linux\")]"}]}