{"sha": "a0111af531178e48375f14f838d7a2298524067c", "node_id": "C_kwDOAAsO6NoAKGEwMTExYWY1MzExNzhlNDgzNzVmMTRmODM4ZDdhMjI5ODUyNDA2N2M", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-08T14:23:13Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-08T14:23:13Z"}, "message": "Auto merge of #110824 - cjgillot:const-prop-index, r=JakobDegen,oli-obk\n\nConstProp into PlaceElem::Index.\n\nNoticed this while looking at keccak output MIR.\n\nThis pass aims to replace `ProjectionElem::Index` with `ProjectionElem::ConstantIndex` during ConstProp.\n\nr? `@ghost`", "tree": {"sha": "96a4bc428f299af2cc8a5e408e76b5689ca7409e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/96a4bc428f299af2cc8a5e408e76b5689ca7409e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a0111af531178e48375f14f838d7a2298524067c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a0111af531178e48375f14f838d7a2298524067c", "html_url": "https://github.com/rust-lang/rust/commit/a0111af531178e48375f14f838d7a2298524067c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a0111af531178e48375f14f838d7a2298524067c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ce042889f7f0d687368a9704eff64cf9542bac6d", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce042889f7f0d687368a9704eff64cf9542bac6d", "html_url": "https://github.com/rust-lang/rust/commit/ce042889f7f0d687368a9704eff64cf9542bac6d"}, {"sha": "a8988519d508cf89b96d18aaa9ace4e0bcd67621", "url": "https://api.github.com/repos/rust-lang/rust/commits/a8988519d508cf89b96d18aaa9ace4e0bcd67621", "html_url": "https://github.com/rust-lang/rust/commit/a8988519d508cf89b96d18aaa9ace4e0bcd67621"}], "stats": {"total": 30, "additions": 26, "deletions": 4}, "files": [{"sha": "a5d18fff89bd79c63a47ef71d75b4d83678ed9bb", "filename": "compiler/rustc_mir_transform/src/const_prop.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/a0111af531178e48375f14f838d7a2298524067c/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0111af531178e48375f14f838d7a2298524067c/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs?ref=a0111af531178e48375f14f838d7a2298524067c", "patch": "@@ -806,6 +806,24 @@ impl<'tcx> MutVisitor<'tcx> for ConstPropagator<'_, 'tcx> {\n         }\n     }\n \n+    fn process_projection_elem(\n+        &mut self,\n+        elem: PlaceElem<'tcx>,\n+        _: Location,\n+    ) -> Option<PlaceElem<'tcx>> {\n+        if let PlaceElem::Index(local) = elem\n+            && let Some(value) = self.get_const(local.into())\n+            && self.should_const_prop(&value)\n+            && let interpret::Operand::Immediate(interpret::Immediate::Scalar(scalar)) = *value\n+            && let Ok(offset) = scalar.to_target_usize(&self.tcx)\n+            && let Some(min_length) = offset.checked_add(1)\n+        {\n+            Some(PlaceElem::ConstantIndex { offset, min_length, from_end: false })\n+        } else {\n+            None\n+        }\n+    }\n+\n     fn visit_assign(\n         &mut self,\n         place: &mut Place<'tcx>,"}, {"sha": "d72675c2d1157b228810e8ab487e6112554236f8", "filename": "tests/mir-opt/const_prop/bad_op_unsafe_oob_for_slices.main.ConstProp.32bit.diff", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a0111af531178e48375f14f838d7a2298524067c/tests%2Fmir-opt%2Fconst_prop%2Fbad_op_unsafe_oob_for_slices.main.ConstProp.32bit.diff", "raw_url": "https://github.com/rust-lang/rust/raw/a0111af531178e48375f14f838d7a2298524067c/tests%2Fmir-opt%2Fconst_prop%2Fbad_op_unsafe_oob_for_slices.main.ConstProp.32bit.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Fbad_op_unsafe_oob_for_slices.main.ConstProp.32bit.diff?ref=a0111af531178e48375f14f838d7a2298524067c", "patch": "@@ -45,7 +45,8 @@\n       }\n   \n       bb1: {\n-          _5 = (*_1)[_6];                  // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:18: +3:25\n+-         _5 = (*_1)[_6];                  // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:18: +3:25\n++         _5 = (*_1)[3 of 4];              // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:18: +3:25\n           StorageDead(_6);                 // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:25: +3:26\n           _0 = const ();                   // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+2:5: +4:6\n           StorageDead(_5);                 // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+4:5: +4:6"}, {"sha": "d72675c2d1157b228810e8ab487e6112554236f8", "filename": "tests/mir-opt/const_prop/bad_op_unsafe_oob_for_slices.main.ConstProp.64bit.diff", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a0111af531178e48375f14f838d7a2298524067c/tests%2Fmir-opt%2Fconst_prop%2Fbad_op_unsafe_oob_for_slices.main.ConstProp.64bit.diff", "raw_url": "https://github.com/rust-lang/rust/raw/a0111af531178e48375f14f838d7a2298524067c/tests%2Fmir-opt%2Fconst_prop%2Fbad_op_unsafe_oob_for_slices.main.ConstProp.64bit.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Fbad_op_unsafe_oob_for_slices.main.ConstProp.64bit.diff?ref=a0111af531178e48375f14f838d7a2298524067c", "patch": "@@ -45,7 +45,8 @@\n       }\n   \n       bb1: {\n-          _5 = (*_1)[_6];                  // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:18: +3:25\n+-         _5 = (*_1)[_6];                  // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:18: +3:25\n++         _5 = (*_1)[3 of 4];              // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:18: +3:25\n           StorageDead(_6);                 // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:25: +3:26\n           _0 = const ();                   // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+2:5: +4:6\n           StorageDead(_5);                 // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+4:5: +4:6"}, {"sha": "33bbad2f422ba0ebddd14dbe28e6c97f7575c303", "filename": "tests/mir-opt/const_prop/large_array_index.main.ConstProp.32bit.diff", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a0111af531178e48375f14f838d7a2298524067c/tests%2Fmir-opt%2Fconst_prop%2Flarge_array_index.main.ConstProp.32bit.diff", "raw_url": "https://github.com/rust-lang/rust/raw/a0111af531178e48375f14f838d7a2298524067c/tests%2Fmir-opt%2Fconst_prop%2Flarge_array_index.main.ConstProp.32bit.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Flarge_array_index.main.ConstProp.32bit.diff?ref=a0111af531178e48375f14f838d7a2298524067c", "patch": "@@ -27,7 +27,8 @@\n       }\n   \n       bb1: {\n-          _1 = _2[_3];                     // scope 0 at $DIR/large_array_index.rs:+2:17: +2:32\n+-         _1 = _2[_3];                     // scope 0 at $DIR/large_array_index.rs:+2:17: +2:32\n++         _1 = _2[2 of 3];                 // scope 0 at $DIR/large_array_index.rs:+2:17: +2:32\n           StorageDead(_3);                 // scope 0 at $DIR/large_array_index.rs:+2:32: +2:33\n           StorageDead(_2);                 // scope 0 at $DIR/large_array_index.rs:+2:32: +2:33\n           _0 = const ();                   // scope 0 at $DIR/large_array_index.rs:+0:11: +3:2"}, {"sha": "33bbad2f422ba0ebddd14dbe28e6c97f7575c303", "filename": "tests/mir-opt/const_prop/large_array_index.main.ConstProp.64bit.diff", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a0111af531178e48375f14f838d7a2298524067c/tests%2Fmir-opt%2Fconst_prop%2Flarge_array_index.main.ConstProp.64bit.diff", "raw_url": "https://github.com/rust-lang/rust/raw/a0111af531178e48375f14f838d7a2298524067c/tests%2Fmir-opt%2Fconst_prop%2Flarge_array_index.main.ConstProp.64bit.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Flarge_array_index.main.ConstProp.64bit.diff?ref=a0111af531178e48375f14f838d7a2298524067c", "patch": "@@ -27,7 +27,8 @@\n       }\n   \n       bb1: {\n-          _1 = _2[_3];                     // scope 0 at $DIR/large_array_index.rs:+2:17: +2:32\n+-         _1 = _2[_3];                     // scope 0 at $DIR/large_array_index.rs:+2:17: +2:32\n++         _1 = _2[2 of 3];                 // scope 0 at $DIR/large_array_index.rs:+2:17: +2:32\n           StorageDead(_3);                 // scope 0 at $DIR/large_array_index.rs:+2:32: +2:33\n           StorageDead(_2);                 // scope 0 at $DIR/large_array_index.rs:+2:32: +2:33\n           _0 = const ();                   // scope 0 at $DIR/large_array_index.rs:+0:11: +3:2"}]}