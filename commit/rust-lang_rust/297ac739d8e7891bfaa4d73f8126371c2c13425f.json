{"sha": "297ac739d8e7891bfaa4d73f8126371c2c13425f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI5N2FjNzM5ZDhlNzg5MWJmYWE0ZDczZjgxMjYzNzFjMmMxMzQyNWY=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-09-14T17:46:29Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-09-16T03:42:06Z"}, "message": "When declaring extern fns from external crates, use the correct abi\n\nBeforehand it was assumed that the standard cdecl abi was used for all extern\nfns of extern crates, but this reads the abi of the extern fn type and declares\nthe function in the local crate with the appropriate type.", "tree": {"sha": "89642ea04fd96c89a8b98e8c1c2d8b74c3da1677", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/89642ea04fd96c89a8b98e8c1c2d8b74c3da1677"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/297ac739d8e7891bfaa4d73f8126371c2c13425f", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/297ac739d8e7891bfaa4d73f8126371c2c13425f", "html_url": "https://github.com/rust-lang/rust/commit/297ac739d8e7891bfaa4d73f8126371c2c13425f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/297ac739d8e7891bfaa4d73f8126371c2c13425f/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ccadbd3b7c936dacab69856cc3963aad477c7f06", "url": "https://api.github.com/repos/rust-lang/rust/commits/ccadbd3b7c936dacab69856cc3963aad477c7f06", "html_url": "https://github.com/rust-lang/rust/commit/ccadbd3b7c936dacab69856cc3963aad477c7f06"}], "stats": {"total": 38, "additions": 25, "deletions": 13}, "files": [{"sha": "f1fffa88071592d3336d786f6d2164ba9dc91d29", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 23, "deletions": 10, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/297ac739d8e7891bfaa4d73f8126371c2c13425f/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/297ac739d8e7891bfaa4d73f8126371c2c13425f/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=297ac739d8e7891bfaa4d73f8126371c2c13425f", "patch": "@@ -86,7 +86,7 @@ use syntax::parse::token;\n use syntax::parse::token::{special_idents};\n use syntax::print::pprust::stmt_to_str;\n use syntax::{ast, ast_util, codemap, ast_map};\n-use syntax::abi::{X86, X86_64, Arm, Mips};\n+use syntax::abi::{X86, X86_64, Arm, Mips, Rust, RustIntrinsic};\n use syntax::visit;\n use syntax::visit::Visitor;\n \n@@ -813,15 +813,28 @@ pub fn trans_external_path(ccx: &mut CrateContext, did: ast::DefId, t: ty::t)\n     -> ValueRef {\n     let name = csearch::get_symbol(ccx.sess.cstore, did);\n     match ty::get(t).sty {\n-      ty::ty_bare_fn(_) | ty::ty_closure(_) => {\n-        let llty = type_of_fn_from_ty(ccx, t);\n-        return get_extern_fn(&mut ccx.externs, ccx.llmod, name,\n-                             lib::llvm::CCallConv, llty);\n-      }\n-      _ => {\n-        let llty = type_of(ccx, t);\n-        return get_extern_const(&mut ccx.externs, ccx.llmod, name, llty);\n-      }\n+        ty::ty_bare_fn(ref fn_ty) => {\n+            // Currently llvm_calling_convention triggers unimpl/bug on\n+            // Rust/RustIntrinsic, so those two are handled specially here.\n+            let cconv = match fn_ty.abis.for_arch(ccx.sess.targ_cfg.arch) {\n+                Some(Rust) | Some(RustIntrinsic) => lib::llvm::CCallConv,\n+                Some(*) | None => {\n+                    let c = foreign::llvm_calling_convention(ccx, fn_ty.abis);\n+                    c.unwrap_or(lib::llvm::CCallConv)\n+                }\n+            };\n+            let llty = type_of_fn_from_ty(ccx, t);\n+            return get_extern_fn(&mut ccx.externs, ccx.llmod, name, cconv, llty);\n+        }\n+        ty::ty_closure(_) => {\n+            let llty = type_of_fn_from_ty(ccx, t);\n+            return get_extern_fn(&mut ccx.externs, ccx.llmod, name,\n+            lib::llvm::CCallConv, llty);\n+        }\n+        _ => {\n+            let llty = type_of(ccx, t);\n+            return get_extern_const(&mut ccx.externs, ccx.llmod, name, llty);\n+        }\n     };\n }\n "}, {"sha": "d5ce3516c59a454d2db879752f5556445cdf1277", "filename": "src/librustc/middle/trans/foreign.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/297ac739d8e7891bfaa4d73f8126371c2c13425f/src%2Flibrustc%2Fmiddle%2Ftrans%2Fforeign.rs", "raw_url": "https://github.com/rust-lang/rust/raw/297ac739d8e7891bfaa4d73f8126371c2c13425f/src%2Flibrustc%2Fmiddle%2Ftrans%2Fforeign.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fforeign.rs?ref=297ac739d8e7891bfaa4d73f8126371c2c13425f", "patch": "@@ -74,9 +74,8 @@ struct LlvmSignature {\n ///////////////////////////////////////////////////////////////////////////\n // Calls to external functions\n \n-fn llvm_calling_convention(ccx: @mut CrateContext,\n-                           abis: AbiSet)\n-                           -> Option<CallConv> {\n+pub fn llvm_calling_convention(ccx: &mut CrateContext,\n+                               abis: AbiSet) -> Option<CallConv> {\n     let arch = ccx.sess.targ_cfg.arch;\n     abis.for_arch(arch).map(|abi| {\n         match *abi {"}]}