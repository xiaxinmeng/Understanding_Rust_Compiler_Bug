{"sha": "18b6327a2967c552baf6fe8b0189fe66d368f5f9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE4YjYzMjdhMjk2N2M1NTJiYWY2ZmU4YjAxODlmZTY2ZDM2OGY1Zjk=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-07-26T17:58:14Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-07-26T17:58:14Z"}, "message": "Remove the legacy macro scoping hack", "tree": {"sha": "f6ae8918f0ec62b276d9c91b76ca213b49633f99", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f6ae8918f0ec62b276d9c91b76ca213b49633f99"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/18b6327a2967c552baf6fe8b0189fe66d368f5f9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/18b6327a2967c552baf6fe8b0189fe66d368f5f9", "html_url": "https://github.com/rust-lang/rust/commit/18b6327a2967c552baf6fe8b0189fe66d368f5f9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/18b6327a2967c552baf6fe8b0189fe66d368f5f9/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f0db648cb6785930fa4027fc941c0f1692b5ad59", "url": "https://api.github.com/repos/rust-lang/rust/commits/f0db648cb6785930fa4027fc941c0f1692b5ad59", "html_url": "https://github.com/rust-lang/rust/commit/f0db648cb6785930fa4027fc941c0f1692b5ad59"}], "stats": {"total": 36, "additions": 29, "deletions": 7}, "files": [{"sha": "cca51b8167cdc91a969d6942a4497787cb636148", "filename": "crates/hir_def/src/nameres/collector.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/18b6327a2967c552baf6fe8b0189fe66d368f5f9/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/18b6327a2967c552baf6fe8b0189fe66d368f5f9/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=18b6327a2967c552baf6fe8b0189fe66d368f5f9", "patch": "@@ -1890,7 +1890,7 @@ impl ModCollector<'_, '_> {\n     }\n \n     fn collect_macro_call(&mut self, mac: &MacroCall) {\n-        let mut ast_id = AstIdWithPath::new(self.file_id(), mac.ast_id, (*mac.path).clone());\n+        let ast_id = AstIdWithPath::new(self.file_id(), mac.ast_id, (*mac.path).clone());\n \n         // Case 1: try to resolve in legacy scope and expand macro_rules\n         let mut error = None;\n@@ -1941,11 +1941,6 @@ impl ModCollector<'_, '_> {\n         }\n \n         // Case 2: resolve in module scope, expand during name resolution.\n-        // We rewrite simple path `macro_name` to `self::macro_name` to force resolve in module scope only.\n-        if ast_id.path.is_ident() {\n-            ast_id.path.kind = PathKind::Super(0);\n-        }\n-\n         self.def_collector.unresolved_macros.push(MacroDirective {\n             module_id: self.module_id,\n             depth: self.macro_depth + 1,"}, {"sha": "45448ba81b347c6be50dae37859cddb3526e1f9e", "filename": "crates/hir_def/src/nameres/tests/macros.rs", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/18b6327a2967c552baf6fe8b0189fe66d368f5f9/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/18b6327a2967c552baf6fe8b0189fe66d368f5f9/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests%2Fmacros.rs?ref=18b6327a2967c552baf6fe8b0189fe66d368f5f9", "patch": "@@ -349,8 +349,10 @@ macro_rules! m {\n \"#,\n         expect![[r#\"\n             crate\n+            S: t v\n         \"#]],\n     );\n+    // FIXME: should not expand. legacy macro scoping is not implemented.\n }\n \n #[test]\n@@ -427,6 +429,7 @@ macro_rules! baz {\n \"#,\n         expect![[r#\"\n             crate\n+            NotFoundBefore: t v\n             Ok: t v\n             OkAfter: t v\n             OkShadowStop: t v\n@@ -462,6 +465,7 @@ macro_rules! baz {\n             crate::m3::m5\n         \"#]],\n     );\n+    // FIXME: should not see `NotFoundBefore`\n }\n \n #[test]\n@@ -994,3 +998,26 @@ structs!(Foo);\n         \"#]],\n     );\n }\n+\n+#[test]\n+fn macro_in_prelude() {\n+    check(\n+        r#\"\n+//- /lib.rs crate:lib deps:std\n+global_asm!();\n+\n+//- /std.rs crate:std\n+pub mod prelude {\n+    pub mod rust_2018 {\n+        pub macro global_asm() {\n+            pub struct S;\n+        }\n+    }\n+}\n+        \"#,\n+        expect![[r#\"\n+            crate\n+            S: t v\n+        \"#]],\n+    )\n+}"}, {"sha": "ea0f35501bcfebbf7f6e282e05e308868573a56a", "filename": "crates/ide_diagnostics/src/handlers/unresolved_macro_call.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/18b6327a2967c552baf6fe8b0189fe66d368f5f9/crates%2Fide_diagnostics%2Fsrc%2Fhandlers%2Funresolved_macro_call.rs", "raw_url": "https://github.com/rust-lang/rust/raw/18b6327a2967c552baf6fe8b0189fe66d368f5f9/crates%2Fide_diagnostics%2Fsrc%2Fhandlers%2Funresolved_macro_call.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_diagnostics%2Fsrc%2Fhandlers%2Funresolved_macro_call.rs?ref=18b6327a2967c552baf6fe8b0189fe66d368f5f9", "patch": "@@ -63,7 +63,7 @@ foo::bar!(92);\n macro_rules! m { () => {} }\n \n m!(); m2!();\n-    //^^ error: unresolved macro `self::m2!`\n+    //^^ error: unresolved macro `m2!`\n \"#,\n         );\n     }"}]}