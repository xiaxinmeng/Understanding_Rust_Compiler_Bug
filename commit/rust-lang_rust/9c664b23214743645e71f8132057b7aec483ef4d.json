{"sha": "9c664b23214743645e71f8132057b7aec483ef4d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjljNjY0YjIzMjE0NzQzNjQ1ZTcxZjgxMzIwNTdiN2FlYzQ4M2VmNGQ=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-06-21T15:00:42Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-21T15:00:42Z"}, "message": "Rollup merge of #86472 - Mark-Simulacrum:fix-ci-beta, r=pietroalbini\n\nFix CI to fetch master on beta channel\n\nThis forward-ports a fix from the beta channel (landing in #86413, hopefully) to master so that we don't need to apply it on each round of backports.\n\nThis bug also demonstrates that our channel-checking is a bit insufficient -- stable is checked, but beta has some of its own peculiarities currently and isn't checked. But this does not attempt to adjust for that; we likely can't afford to run both beta and stable channels by CI and the current state here seems OK for now.\n\nr? `@pietroalbini`", "tree": {"sha": "59b2dc0a408d01fdb0eea592d5d3030b081f75bc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/59b2dc0a408d01fdb0eea592d5d3030b081f75bc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9c664b23214743645e71f8132057b7aec483ef4d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg0KmbCRBK7hj4Ov3rIwAAQDwIABlCGpuRibCgM6aVoyE+f8Fg\nRmlrJ6Q2CA3A8w2rowZzSf5VRpCCSjFrNOCloL5gNzz3yi9xgUYqQ8Tt4boI07Pb\n2C0kyNUlsjWDKmnV3DcLCM/I5iM/RrgC5dxRyPkNqLkWB2cyZv1wceN07CqLHwIT\njhMhPYyh+7QfMkBJO0DcYxl0gKJCS555/MLON9DxqdbDS/I4R3GpcL0J3+txAXkR\nEp9YIc3IAQ9PYR+8yqdCJ+6ju0dVVAXV25POQOwm/KI9XzCG907aMaWx9HU6s4Am\n3QJLo89HtJwnB7ZEhqxWmBqZIwACrspj7qlfeV426OuVUlgcD/Mb/R3k3BSUPpk=\n=z8b6\n-----END PGP SIGNATURE-----\n", "payload": "tree 59b2dc0a408d01fdb0eea592d5d3030b081f75bc\nparent a81f55fb161a22e287220281d33542406a3a57f8\nparent 61b453cd1ab28b0dabab3293ee12df7474516eb6\nauthor Yuki Okushi <jtitor@2k36.org> 1624287642 +0900\ncommitter GitHub <noreply@github.com> 1624287642 +0900\n\nRollup merge of #86472 - Mark-Simulacrum:fix-ci-beta, r=pietroalbini\n\nFix CI to fetch master on beta channel\n\nThis forward-ports a fix from the beta channel (landing in #86413, hopefully) to master so that we don't need to apply it on each round of backports.\n\nThis bug also demonstrates that our channel-checking is a bit insufficient -- stable is checked, but beta has some of its own peculiarities currently and isn't checked. But this does not attempt to adjust for that; we likely can't afford to run both beta and stable channels by CI and the current state here seems OK for now.\n\nr? `@pietroalbini`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9c664b23214743645e71f8132057b7aec483ef4d", "html_url": "https://github.com/rust-lang/rust/commit/9c664b23214743645e71f8132057b7aec483ef4d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9c664b23214743645e71f8132057b7aec483ef4d/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a81f55fb161a22e287220281d33542406a3a57f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/a81f55fb161a22e287220281d33542406a3a57f8", "html_url": "https://github.com/rust-lang/rust/commit/a81f55fb161a22e287220281d33542406a3a57f8"}, {"sha": "61b453cd1ab28b0dabab3293ee12df7474516eb6", "url": "https://api.github.com/repos/rust-lang/rust/commits/61b453cd1ab28b0dabab3293ee12df7474516eb6", "html_url": "https://github.com/rust-lang/rust/commit/61b453cd1ab28b0dabab3293ee12df7474516eb6"}], "stats": {"total": 16, "additions": 10, "deletions": 6}, "files": [{"sha": "3c61dcc9d9c7b46a70a56b180355d6af93721707", "filename": "src/ci/init_repo.sh", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9c664b23214743645e71f8132057b7aec483ef4d/src%2Fci%2Finit_repo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/9c664b23214743645e71f8132057b7aec483ef4d/src%2Fci%2Finit_repo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Finit_repo.sh?ref=9c664b23214743645e71f8132057b7aec483ef4d", "patch": "@@ -31,7 +31,7 @@ mkdir \"$CACHE_DIR\"\n \n # On the beta channel we'll be automatically calculating the prerelease version\n # via the git history, so unshallow our shallow clone from CI.\n-if grep -q RUST_RELEASE_CHANNEL=beta src/ci/run.sh; then\n+if [ \"$(releaseChannel)\" = \"beta\" ]; then\n   git fetch origin --unshallow beta master\n fi\n "}, {"sha": "b5019d83af45b426e424dd312d068145761398aa", "filename": "src/ci/run.sh", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9c664b23214743645e71f8132057b7aec483ef4d/src%2Fci%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/9c664b23214743645e71f8132057b7aec483ef4d/src%2Fci%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Frun.sh?ref=9c664b23214743645e71f8132057b7aec483ef4d", "patch": "@@ -65,11 +65,7 @@ fi\n # Always set the release channel for bootstrap; this is normally not important (i.e., only dist\n # builds would seem to matter) but in practice bootstrap wants to know whether we're targeting\n # master, beta, or stable with a build to determine whether to run some checks (notably toolstate).\n-if [[ -z \"${RUST_CI_OVERRIDE_RELEASE_CHANNEL+x}\" ]]; then\n-    export RUST_RELEASE_CHANNEL=\"$(cat \"${ci_dir}/channel\")\"\n-else\n-    export RUST_RELEASE_CHANNEL=\"${RUST_CI_OVERRIDE_RELEASE_CHANNEL}\"\n-fi\n+export RUST_RELEASE_CHANNEL=$(releaseChannel)\n RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --release-channel=$RUST_RELEASE_CHANNEL\"\n \n if [ \"$DEPLOY$DEPLOY_ALT\" = \"1\" ]; then"}, {"sha": "b095afb542d83da4dfa114d371fcce8288a819d1", "filename": "src/ci/shared.sh", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/9c664b23214743645e71f8132057b7aec483ef4d/src%2Fci%2Fshared.sh", "raw_url": "https://github.com/rust-lang/rust/raw/9c664b23214743645e71f8132057b7aec483ef4d/src%2Fci%2Fshared.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fshared.sh?ref=9c664b23214743645e71f8132057b7aec483ef4d", "patch": "@@ -141,3 +141,11 @@ function ciCommandSetEnv {\n         exit 1\n     fi\n }\n+\n+function releaseChannel {\n+    if [[ -z \"${RUST_CI_OVERRIDE_RELEASE_CHANNEL+x}\" ]]; then\n+        cat \"${ci_dir}/channel\"\n+    else\n+        echo $RUST_CI_OVERRIDE_RELEASE_CHANNEL\n+    fi\n+}"}]}