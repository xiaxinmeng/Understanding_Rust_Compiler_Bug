{"sha": "19f969a465e15abc2f5f271b234405c6a85c471f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE5Zjk2OWE0NjVlMTVhYmMyZjVmMjcxYjIzNDQwNWM2YTg1YzQ3MWY=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-03-09T16:18:11Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-03-09T16:18:11Z"}, "message": "Rollup merge of #58518 - oli-obk:unreachable_result_errors, r=RalfJung\n\nUse early unwraps instead of bubbling up errors just to unwrap in the end\n\nr? @RalfJung", "tree": {"sha": "29c173eb462eaac7fb4d8f759be82fc2a8b4a1b5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/29c173eb462eaac7fb4d8f759be82fc2a8b4a1b5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/19f969a465e15abc2f5f271b234405c6a85c471f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcg+dDCRBK7hj4Ov3rIwAAdHIIAHZK9/WXjfsuWw877uCZNcmc\nSAqUPB4/HdYCTRarRUn5j3tw8ST0e9oLverKDuJZSVzF3WMxoVsA1fSME6cZBM6p\n5I7kyDbitKuLwkzxrPEQ89E23l0flHNb2ywj9Cc3MGC0ef6s4BREwoRcrEjB4UZe\n2UBTvkdcGEOneaRqEaLuL2xutN1ly5rjGvF2QCBpH078LVWXupQ9lrqvL+blK0GK\nbqEremeCnYX1fks+ec2swIxzmvDD/1OIOAi9eCn5wASw6ReV6DJeoDUZLvC3A+mU\nYloWrG2FSn/W3KJefwTELSzggLYARM2xkKN7UoUnj1pv9icKsPbW1+hUHUYjxH8=\n=oLCF\n-----END PGP SIGNATURE-----\n", "payload": "tree 29c173eb462eaac7fb4d8f759be82fc2a8b4a1b5\nparent e1b8898cfb0392f534cc25808a7f6caad36ebbb7\nparent 5c0615b89c399ce6a431ba660f9457c24bc69964\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1552148291 +0100\ncommitter GitHub <noreply@github.com> 1552148291 +0100\n\nRollup merge of #58518 - oli-obk:unreachable_result_errors, r=RalfJung\n\nUse early unwraps instead of bubbling up errors just to unwrap in the end\n\nr? @RalfJung\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/19f969a465e15abc2f5f271b234405c6a85c471f", "html_url": "https://github.com/rust-lang/rust/commit/19f969a465e15abc2f5f271b234405c6a85c471f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/19f969a465e15abc2f5f271b234405c6a85c471f/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e1b8898cfb0392f534cc25808a7f6caad36ebbb7", "url": "https://api.github.com/repos/rust-lang/rust/commits/e1b8898cfb0392f534cc25808a7f6caad36ebbb7", "html_url": "https://github.com/rust-lang/rust/commit/e1b8898cfb0392f534cc25808a7f6caad36ebbb7"}, {"sha": "5c0615b89c399ce6a431ba660f9457c24bc69964", "url": "https://api.github.com/repos/rust-lang/rust/commits/5c0615b89c399ce6a431ba660f9457c24bc69964", "html_url": "https://github.com/rust-lang/rust/commit/5c0615b89c399ce6a431ba660f9457c24bc69964"}], "stats": {"total": 74, "additions": 30, "deletions": 44}, "files": [{"sha": "349c9132842b893947cd5434e4edc2f364d68d47", "filename": "src/librustc_codegen_ssa/mir/constant.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/19f969a465e15abc2f5f271b234405c6a85c471f/src%2Flibrustc_codegen_ssa%2Fmir%2Fconstant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/19f969a465e15abc2f5f271b234405c6a85c471f/src%2Flibrustc_codegen_ssa%2Fmir%2Fconstant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fconstant.rs?ref=19f969a465e15abc2f5f271b234405c6a85c471f", "patch": "@@ -49,36 +49,36 @@ impl<'a, 'tcx: 'a, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n         constant: Result<ty::Const<'tcx>, ErrorHandled>,\n     ) -> (Bx::Value, Ty<'tcx>) {\n         constant\n-            .and_then(|c| {\n+            .map(|c| {\n                 let field_ty = c.ty.builtin_index().unwrap();\n                 let fields = match c.ty.sty {\n                     ty::Array(_, n) => n.unwrap_usize(bx.tcx()),\n                     ref other => bug!(\"invalid simd shuffle type: {}\", other),\n                 };\n-                let values: Result<Vec<_>, ErrorHandled> = (0..fields).map(|field| {\n+                let values: Vec<_> = (0..fields).map(|field| {\n                     let field = const_field(\n                         bx.tcx(),\n                         ty::ParamEnv::reveal_all(),\n                         None,\n                         mir::Field::new(field as usize),\n                         c,\n-                    )?;\n+                    );\n                     if let Some(prim) = field.val.try_to_scalar() {\n                         let layout = bx.layout_of(field_ty);\n                         let scalar = match layout.abi {\n                             layout::Abi::Scalar(ref x) => x,\n                             _ => bug!(\"from_const: invalid ByVal layout: {:#?}\", layout)\n                         };\n-                        Ok(bx.scalar_to_backend(\n+                        bx.scalar_to_backend(\n                             prim, scalar,\n                             bx.immediate_backend_type(layout),\n-                        ))\n+                        )\n                     } else {\n                         bug!(\"simd shuffle field {:?}\", field)\n                     }\n                 }).collect();\n-                let llval = bx.const_struct(&values?, false);\n-                Ok((llval, c.ty))\n+                let llval = bx.const_struct(&values, false);\n+                (llval, c.ty)\n             })\n             .unwrap_or_else(|_| {\n                 bx.tcx().sess.span_err("}, {"sha": "365cb508b09253958b0b4a1543735b7c9a285235", "filename": "src/librustc_mir/const_eval.rs", "status": "modified", "additions": 20, "deletions": 23, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/19f969a465e15abc2f5f271b234405c6a85c471f/src%2Flibrustc_mir%2Fconst_eval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/19f969a465e15abc2f5f271b234405c6a85c471f/src%2Flibrustc_mir%2Fconst_eval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fconst_eval.rs?ref=19f969a465e15abc2f5f271b234405c6a85c471f", "patch": "@@ -466,45 +466,42 @@ impl<'a, 'mir, 'tcx> interpret::Machine<'a, 'mir, 'tcx>\n }\n \n /// Projects to a field of a (variant of a) const.\n+// this function uses `unwrap` copiously, because an already validated constant must have valid\n+// fields and can thus never fail outside of compiler bugs\n pub fn const_field<'a, 'tcx>(\n     tcx: TyCtxt<'a, 'tcx, 'tcx>,\n     param_env: ty::ParamEnv<'tcx>,\n     variant: Option<VariantIdx>,\n     field: mir::Field,\n     value: ty::Const<'tcx>,\n-) -> ::rustc::mir::interpret::ConstEvalResult<'tcx> {\n+) -> ty::Const<'tcx> {\n     trace!(\"const_field: {:?}, {:?}\", field, value);\n     let ecx = mk_eval_cx(tcx, DUMMY_SP, param_env);\n-    let result = (|| {\n-        // get the operand again\n-        let op = ecx.const_to_op(value, None)?;\n-        // downcast\n-        let down = match variant {\n-            None => op,\n-            Some(variant) => ecx.operand_downcast(op, variant)?\n-        };\n-        // then project\n-        let field = ecx.operand_field(down, field.index() as u64)?;\n-        // and finally move back to the const world, always normalizing because\n-        // this is not called for statics.\n-        op_to_const(&ecx, field)\n-    })();\n-    result.map_err(|error| {\n-        let err = error_to_const_error(&ecx, error);\n-        err.report_as_error(ecx.tcx, \"could not access field of constant\");\n-        ErrorHandled::Reported\n-    })\n+    // get the operand again\n+    let op = ecx.const_to_op(value, None).unwrap();\n+    // downcast\n+    let down = match variant {\n+        None => op,\n+        Some(variant) => ecx.operand_downcast(op, variant).unwrap(),\n+    };\n+    // then project\n+    let field = ecx.operand_field(down, field.index() as u64).unwrap();\n+    // and finally move back to the const world, always normalizing because\n+    // this is not called for statics.\n+    op_to_const(&ecx, field).unwrap()\n }\n \n+// this function uses `unwrap` copiously, because an already validated constant must have valid\n+// fields and can thus never fail outside of compiler bugs\n pub fn const_variant_index<'a, 'tcx>(\n     tcx: TyCtxt<'a, 'tcx, 'tcx>,\n     param_env: ty::ParamEnv<'tcx>,\n     val: ty::Const<'tcx>,\n-) -> EvalResult<'tcx, VariantIdx> {\n+) -> VariantIdx {\n     trace!(\"const_variant_index: {:?}\", val);\n     let ecx = mk_eval_cx(tcx, DUMMY_SP, param_env);\n-    let op = ecx.const_to_op(val, None)?;\n-    Ok(ecx.read_discriminant(op)?.1)\n+    let op = ecx.const_to_op(val, None).unwrap();\n+    ecx.read_discriminant(op).unwrap().1\n }\n \n pub fn error_to_const_error<'a, 'mir, 'tcx>("}, {"sha": "586a3fdb907ee7a1c4841ed4324a20a9128ce4bf", "filename": "src/librustc_mir/hair/pattern/_match.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/19f969a465e15abc2f5f271b234405c6a85c471f/src%2Flibrustc_mir%2Fhair%2Fpattern%2F_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/19f969a465e15abc2f5f271b234405c6a85c471f/src%2Flibrustc_mir%2Fhair%2Fpattern%2F_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fpattern%2F_match.rs?ref=19f969a465e15abc2f5f271b234405c6a85c471f", "patch": "@@ -440,13 +440,7 @@ impl<'tcx> Constructor<'tcx> {\n                 assert!(!adt.is_enum());\n                 VariantIdx::new(0)\n             }\n-            &ConstantValue(c) => {\n-                crate::const_eval::const_variant_index(\n-                    cx.tcx,\n-                    cx.param_env,\n-                    c,\n-                ).unwrap()\n-            },\n+            &ConstantValue(c) => crate::const_eval::const_variant_index(cx.tcx, cx.param_env, c),\n             _ => bug!(\"bad constructor {:?} for adt {:?}\", self, adt)\n         }\n     }"}, {"sha": "b17da609ab4ceafbf4664ea3bce2b83a73c6a5ef", "filename": "src/librustc_mir/hair/pattern/mod.rs", "status": "modified", "additions": 2, "deletions": 7, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/19f969a465e15abc2f5f271b234405c6a85c471f/src%2Flibrustc_mir%2Fhair%2Fpattern%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/19f969a465e15abc2f5f271b234405c6a85c471f/src%2Flibrustc_mir%2Fhair%2Fpattern%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fpattern%2Fmod.rs?ref=19f969a465e15abc2f5f271b234405c6a85c471f", "patch": "@@ -937,10 +937,7 @@ impl<'a, 'tcx> PatternContext<'a, 'tcx> {\n         debug!(\"const_to_pat: cv={:#?} id={:?}\", cv, id);\n         let adt_subpattern = |i, variant_opt| {\n             let field = Field::new(i);\n-            let val = const_field(\n-                self.tcx, self.param_env,\n-                variant_opt, field, cv,\n-            ).expect(\"field access failed\");\n+            let val = const_field(self.tcx, self.param_env, variant_opt, field, cv);\n             self.const_to_pat(instance, val, id, span)\n         };\n         let adt_subpatterns = |n, variant_opt| {\n@@ -979,9 +976,7 @@ impl<'a, 'tcx> PatternContext<'a, 'tcx> {\n                 PatternKind::Wild\n             }\n             ty::Adt(adt_def, substs) if adt_def.is_enum() => {\n-                let variant_index = const_variant_index(\n-                    self.tcx, self.param_env, cv\n-                ).expect(\"const_variant_index failed\");\n+                let variant_index = const_variant_index(self.tcx, self.param_env, cv);\n                 let subpatterns = adt_subpatterns(\n                     adt_def.variants[variant_index].fields.len(),\n                     Some(variant_index),"}]}