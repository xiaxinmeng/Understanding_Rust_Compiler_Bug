{"sha": "dc302587e2cf5105a3a864319d7e7bcb434bba20", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRjMzAyNTg3ZTJjZjUxMDVhM2E4NjQzMTlkN2U3YmNiNDM0YmJhMjA=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-03-24T01:48:29Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-06-05T02:01:40Z"}, "message": "Pass --cfg=bootstrap for proc_macros or build scripts built by stage0\n\nCargo ignores RUSTFLAGS when building proc macro crates. However,\nsometimes rustc_macro needs to have conditional compilation when there\nare breaking changes to the `libproc_macro` API (see for example\ntell the difference between stage 0 and stage 1.\n\nAnother alternative is to unconditionally build rustc_macros with the\nmaster libstd instead of the beta one (i.e. use `--sysroot\nstage0-sysroot`), but that led to strange and maddening errors:\n\n```\nerror[E0460]: found possibly newer version of crate `std` which `proc_macro2` depends on\n  --> /home/joshua/.local/lib/cargo/registry/src/github.com-1ecc6299db9ec823/tracing-attributes-0.1.13/src/lib.rs:90:5\n   |\n90 | use proc_macro2::TokenStream;\n   |     ^^^^^^^^^^^\n   |\n   = note: perhaps that crate needs to be recompiled?\n   = note: the following crate versions were found:\n           crate `std`: /home/joshua/rustc2/build/x86_64-unknown-linux-gnu/stage0-sysroot/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd-b3602c301b71cc3d.rmeta\n           crate `proc_macro2`: /home/joshua/rustc2/build/x86_64-unknown-linux-gnu/stage0-rustc/release/deps/libproc_macro2-a83c1f01610c129e.rlib\n```", "tree": {"sha": "ad0127bda8840f9ed30a47c304329e575382dd1e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ad0127bda8840f9ed30a47c304329e575382dd1e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dc302587e2cf5105a3a864319d7e7bcb434bba20", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dc302587e2cf5105a3a864319d7e7bcb434bba20", "html_url": "https://github.com/rust-lang/rust/commit/dc302587e2cf5105a3a864319d7e7bcb434bba20", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dc302587e2cf5105a3a864319d7e7bcb434bba20/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c4c2ab57a43737867982fafc8cfacd9b069fee96", "url": "https://api.github.com/repos/rust-lang/rust/commits/c4c2ab57a43737867982fafc8cfacd9b069fee96", "html_url": "https://github.com/rust-lang/rust/commit/c4c2ab57a43737867982fafc8cfacd9b069fee96"}], "stats": {"total": 7, "additions": 7, "deletions": 0}, "files": [{"sha": "ac8bbfe102dfea63efb4f7491c99946f06cc4046", "filename": "src/bootstrap/bin/rustc.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/dc302587e2cf5105a3a864319d7e7bcb434bba20/src%2Fbootstrap%2Fbin%2Frustc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc302587e2cf5105a3a864319d7e7bcb434bba20/src%2Fbootstrap%2Fbin%2Frustc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Frustc.rs?ref=dc302587e2cf5105a3a864319d7e7bcb434bba20", "patch": "@@ -124,6 +124,13 @@ fn main() {\n                 cmd.arg(\"-C\").arg(\"target-feature=-crt-static\");\n             }\n         }\n+\n+        if stage == \"0\" {\n+            // Cargo doesn't pass RUSTFLAGS to proc_macros:\n+            // https://github.com/rust-lang/cargo/issues/4423\n+            // Set `--cfg=bootstrap` explicitly instead.\n+            cmd.arg(\"--cfg=bootstrap\");\n+        }\n     }\n \n     if let Ok(map) = env::var(\"RUSTC_DEBUGINFO_MAP\") {"}]}