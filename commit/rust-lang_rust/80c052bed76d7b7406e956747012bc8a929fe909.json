{"sha": "80c052bed76d7b7406e956747012bc8a929fe909", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgwYzA1MmJlZDc2ZDdiNzQwNmU5NTY3NDcwMTJiYzhhOTI5ZmU5MDk=", "commit": {"author": {"name": "Dan Robertson", "email": "dan@dlrobertson.com", "date": "2019-02-05T15:52:54Z"}, "committer": {"name": "Dan Robertson", "email": "dan@dlrobertson.com", "date": "2019-02-05T21:20:07Z"}, "message": "Do not ICE in codegen given a extern_type static\n\nThe layout of a extern_type static is unsized, but may pass the\nWell-Formed check in typeck. As a result, we cannot assume that\na static is sized when generating the `Place` for an r-value.", "tree": {"sha": "77a17b1ae61363f1c0191da16bee3d4324b2956c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/77a17b1ae61363f1c0191da16bee3d4324b2956c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/80c052bed76d7b7406e956747012bc8a929fe909", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEF5dO2RaKc5C+SCJ9RcSmUsR+QqUFAlxZ/gwACgkQRcSmUsR+\nQqV21xAAk+bmsgWful4LJCu5jpZo4/N3Gw6DkhbmYpS9OGqAU6dw8G88zMkPFTAe\nOa6mgYi3JMPzdRXij1ZIVryFV/BEWNTiWdvk3OH+/Yzl5RexoQBu9YAzML08+RhX\n/s/ra3a1bunBP/vycpuBYxfRuNYVt6Nwf2xXtaMm5mlBE/1fhQ1hu6c9O1mX2t3c\n4QplEOpmNqQyP1tuas3X63v5N4qAblgtSxe7n16uKtRYL3TjRGUc1DCmtxG97FcY\nUQ5wrfpLkwRNUw6wVJQxLhvM8XkpFaAKbb1aBsj7Yj/C6NP1+1ynzkykhzFD60vG\nxdgDbi67fHWYk85AK/0IXcYJsI8OLMoeXIV/0PiZc7SxZF9fb2o12zbDRlUxfrhQ\n743AIXCbN4pubtBRHtH7sLcgf87VrTeuzxiELOvkdbLane6VyVkymZ5LIE9HVz4Q\nfAkPfiD8N4orJvPSzimivUMzHgNcef5pSk1CV6hDBDSc/g3wczLzrHyq8LyPGXvf\n2H1LWqmxW82g+Tm/9xlTBgpq4piLZxgzMiFnZhyenIM4h9NuiGaIBDAzYTm26RU8\n62RbG6MPXUtDf7Fw/B6Rh6aaOFyrowVURZewGxTRDaW8WGur2MEV7haqRVdNxF2C\nx+n8sZf92xLnpcilEZAVIUzsdB2fgVI9I0fYL/AzOQ4vsujU6jk=\n=mEUt\n-----END PGP SIGNATURE-----", "payload": "tree 77a17b1ae61363f1c0191da16bee3d4324b2956c\nparent b2c6b8c29f13f8d1f242da89e587960b95337819\nauthor Dan Robertson <dan@dlrobertson.com> 1549381974 +0000\ncommitter Dan Robertson <dan@dlrobertson.com> 1549401607 +0000\n\nDo not ICE in codegen given a extern_type static\n\nThe layout of a extern_type static is unsized, but may pass the\nWell-Formed check in typeck. As a result, we cannot assume that\na static is sized when generating the `Place` for an r-value.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/80c052bed76d7b7406e956747012bc8a929fe909", "html_url": "https://github.com/rust-lang/rust/commit/80c052bed76d7b7406e956747012bc8a929fe909", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/80c052bed76d7b7406e956747012bc8a929fe909/comments", "author": {"login": "dlrobertson", "id": 7504153, "node_id": "MDQ6VXNlcjc1MDQxNTM=", "avatar_url": "https://avatars.githubusercontent.com/u/7504153?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dlrobertson", "html_url": "https://github.com/dlrobertson", "followers_url": "https://api.github.com/users/dlrobertson/followers", "following_url": "https://api.github.com/users/dlrobertson/following{/other_user}", "gists_url": "https://api.github.com/users/dlrobertson/gists{/gist_id}", "starred_url": "https://api.github.com/users/dlrobertson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dlrobertson/subscriptions", "organizations_url": "https://api.github.com/users/dlrobertson/orgs", "repos_url": "https://api.github.com/users/dlrobertson/repos", "events_url": "https://api.github.com/users/dlrobertson/events{/privacy}", "received_events_url": "https://api.github.com/users/dlrobertson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dlrobertson", "id": 7504153, "node_id": "MDQ6VXNlcjc1MDQxNTM=", "avatar_url": "https://avatars.githubusercontent.com/u/7504153?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dlrobertson", "html_url": "https://github.com/dlrobertson", "followers_url": "https://api.github.com/users/dlrobertson/followers", "following_url": "https://api.github.com/users/dlrobertson/following{/other_user}", "gists_url": "https://api.github.com/users/dlrobertson/gists{/gist_id}", "starred_url": "https://api.github.com/users/dlrobertson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dlrobertson/subscriptions", "organizations_url": "https://api.github.com/users/dlrobertson/orgs", "repos_url": "https://api.github.com/users/dlrobertson/repos", "events_url": "https://api.github.com/users/dlrobertson/events{/privacy}", "received_events_url": "https://api.github.com/users/dlrobertson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b2c6b8c29f13f8d1f242da89e587960b95337819", "url": "https://api.github.com/repos/rust-lang/rust/commits/b2c6b8c29f13f8d1f242da89e587960b95337819", "html_url": "https://github.com/rust-lang/rust/commit/b2c6b8c29f13f8d1f242da89e587960b95337819"}], "stats": {"total": 49, "additions": 48, "deletions": 1}, "files": [{"sha": "596f97a038892678a01520619a43b108b2b9c0f0", "filename": "src/librustc_codegen_ssa/mir/place.rs", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/80c052bed76d7b7406e956747012bc8a929fe909/src%2Flibrustc_codegen_ssa%2Fmir%2Fplace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80c052bed76d7b7406e956747012bc8a929fe909/src%2Flibrustc_codegen_ssa%2Fmir%2Fplace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fplace.rs?ref=80c052bed76d7b7406e956747012bc8a929fe909", "patch": "@@ -41,6 +41,21 @@ impl<'a, 'tcx: 'a, V: CodegenObject> PlaceRef<'tcx, V> {\n         }\n     }\n \n+    fn new_thin_place<Bx: BuilderMethods<'a, 'tcx, Value = V>>(\n+        bx: &mut Bx,\n+        llval: V,\n+        layout: TyLayout<'tcx>,\n+        align: Align,\n+    ) -> PlaceRef<'tcx, V> {\n+        assert!(!bx.cx().type_has_metadata(layout.ty));\n+        PlaceRef {\n+            llval,\n+            llextra: None,\n+            layout,\n+            align\n+        }\n+    }\n+\n     pub fn alloca<Bx: BuilderMethods<'a, 'tcx, Value = V>>(\n         bx: &mut Bx,\n         layout: TyLayout<'tcx>,\n@@ -421,8 +436,10 @@ impl<'a, 'tcx: 'a, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                 }\n             }\n             mir::Place::Static(box mir::Static { def_id, ty }) => {\n+                // NB: The layout of a static may be unsized as is the case when working\n+                // with a static that is an extern_type.\n                 let layout = cx.layout_of(self.monomorphize(&ty));\n-                PlaceRef::new_sized(bx.get_static(def_id), layout, layout.align.abi)\n+                PlaceRef::new_thin_place(bx, bx.get_static(def_id), layout, layout.align.abi)\n             },\n             mir::Place::Projection(box mir::Projection {\n                 ref base,"}, {"sha": "5879fc0ce7781a2f109cea88da1c65d463e69be2", "filename": "src/test/run-make-fulldeps/static-extern-type/Makefile", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/80c052bed76d7b7406e956747012bc8a929fe909/src%2Ftest%2Frun-make-fulldeps%2Fstatic-extern-type%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/80c052bed76d7b7406e956747012bc8a929fe909/src%2Ftest%2Frun-make-fulldeps%2Fstatic-extern-type%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fstatic-extern-type%2FMakefile?ref=80c052bed76d7b7406e956747012bc8a929fe909", "patch": "@@ -0,0 +1,5 @@\n+-include ../tools.mk\n+\n+all: $(call NATIVE_STATICLIB,define-foo)\n+\t$(RUSTC) -ldefine-foo use-foo.rs\n+\t$(call RUN,use-foo) || exit 1"}, {"sha": "39be5acfa11182f4c46ed1f09f3c4bf27100499b", "filename": "src/test/run-make-fulldeps/static-extern-type/define-foo.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/80c052bed76d7b7406e956747012bc8a929fe909/src%2Ftest%2Frun-make-fulldeps%2Fstatic-extern-type%2Fdefine-foo.c", "raw_url": "https://github.com/rust-lang/rust/raw/80c052bed76d7b7406e956747012bc8a929fe909/src%2Ftest%2Frun-make-fulldeps%2Fstatic-extern-type%2Fdefine-foo.c", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fstatic-extern-type%2Fdefine-foo.c?ref=80c052bed76d7b7406e956747012bc8a929fe909", "patch": "@@ -0,0 +1,11 @@\n+#include <stdint.h>\n+\n+struct Foo {\n+    uint8_t x;\n+};\n+\n+struct Foo FOO = { 42 };\n+\n+uint8_t bar(const struct Foo* foo) {\n+    return foo->x;\n+}"}, {"sha": "932b5b5944bc72d732f530e50fa268986e7400ad", "filename": "src/test/run-make-fulldeps/static-extern-type/use-foo.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/80c052bed76d7b7406e956747012bc8a929fe909/src%2Ftest%2Frun-make-fulldeps%2Fstatic-extern-type%2Fuse-foo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80c052bed76d7b7406e956747012bc8a929fe909/src%2Ftest%2Frun-make-fulldeps%2Fstatic-extern-type%2Fuse-foo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fstatic-extern-type%2Fuse-foo.rs?ref=80c052bed76d7b7406e956747012bc8a929fe909", "patch": "@@ -0,0 +1,14 @@\n+#![feature(extern_types)]\n+\n+extern \"C\" {\n+    type Foo;\n+    static FOO: Foo;\n+    fn bar(foo: *const Foo) -> u8;\n+}\n+\n+fn main() {\n+    unsafe {\n+        let foo = &FOO;\n+        assert_eq!(bar(foo), 42);\n+    }\n+}"}]}