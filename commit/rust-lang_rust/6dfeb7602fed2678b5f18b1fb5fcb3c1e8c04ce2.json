{"sha": "6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZkZmViNzYwMmZlZDI2NzhiNWYxOGIxZmI1ZmNiM2MxZThjMDRjZTI=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2018-10-25T12:31:01Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-10-25T12:31:01Z"}, "message": "Rollup merge of #55138 - zackmdavis:the_paren_trap, r=pnkfelix\n\nin which unused-parens suggestions heed what the user actually wrote\n\nAaron Hill pointed out that unnecessary parens around a macro call (paradigmatically, `format!`) yielded a suggestion of hideous macro-expanded code. `span_to_snippet` is fallable as far as the type system is concerned, so the pretty-printing can live on in the oft-neglected `else` branch.\n\nResolves #55109.", "tree": {"sha": "24925872284ae012ea87fe72c3816ed080021823", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/24925872284ae012ea87fe72c3816ed080021823"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJb0beGCRBK7hj4Ov3rIwAAdHIIADhSw3t+duYrjvqtOxanQyBh\nwQt3PDPonA08NfVU4dOt3IOjtd3txsptT2P5oukWrU5PqvD2kTXMX+LqfiCJzhbn\nyT9L6YkkPzw4/P+MoFYaGofPPXlsdIgVJQ729pwXcznqg9wrTbfUmGur4Yo4JN2C\nmsMdhSRC7wreRZ2B9Cd1t1SmxwAIj09LHcLghR/jksy+cUhj0Hay2k2v3XoThSR4\naUuytBxmEcDwG8YRXhUXo8dWp2WT1XfczOsMJ6WfHNcwkspqfwR+yfBmKGaXfkgB\nJzIB8Jh9VibUg2AID0n4gris3fgqLEUH4GMxCyBX9ZkBI9Y6zmRzGQSrYe3cdOM=\n=Jf5i\n-----END PGP SIGNATURE-----\n", "payload": "tree 24925872284ae012ea87fe72c3816ed080021823\nparent f81e47f85e539a01af95dba2e16c861058803e4d\nparent 475be10dbd5bef7c37d58f2d5f1905123cb6e19e\nauthor Pietro Albini <pietro@pietroalbini.org> 1540470661 +0200\ncommitter GitHub <noreply@github.com> 1540470661 +0200\n\nRollup merge of #55138 - zackmdavis:the_paren_trap, r=pnkfelix\n\nin which unused-parens suggestions heed what the user actually wrote\n\nAaron Hill pointed out that unnecessary parens around a macro call (paradigmatically, `format!`) yielded a suggestion of hideous macro-expanded code. `span_to_snippet` is fallable as far as the type system is concerned, so the pretty-printing can live on in the oft-neglected `else` branch.\n\nResolves #55109.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2", "html_url": "https://github.com/rust-lang/rust/commit/6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f81e47f85e539a01af95dba2e16c861058803e4d", "url": "https://api.github.com/repos/rust-lang/rust/commits/f81e47f85e539a01af95dba2e16c861058803e4d", "html_url": "https://github.com/rust-lang/rust/commit/f81e47f85e539a01af95dba2e16c861058803e4d"}, {"sha": "475be10dbd5bef7c37d58f2d5f1905123cb6e19e", "url": "https://api.github.com/repos/rust-lang/rust/commits/475be10dbd5bef7c37d58f2d5f1905123cb6e19e", "html_url": "https://github.com/rust-lang/rust/commit/475be10dbd5bef7c37d58f2d5f1905123cb6e19e"}], "stats": {"total": 32, "additions": 21, "deletions": 11}, "files": [{"sha": "96d04253cc48549f3fd981e0a774ee922a21ab44", "filename": "src/librustc_lint/unused.rs", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2/src%2Flibrustc_lint%2Funused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2/src%2Flibrustc_lint%2Funused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Funused.rs?ref=6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2", "patch": "@@ -284,8 +284,13 @@ impl UnusedParens {\n                 parser::contains_exterior_struct_lit(&inner)\n             };\n             if !necessary {\n-                let pattern = pprust::expr_to_string(value);\n-                Self::remove_outer_parens(cx, value.span, &pattern, msg);\n+                let expr_text = if let Ok(snippet) = cx.sess().source_map()\n+                    .span_to_snippet(value.span) {\n+                        snippet\n+                    } else {\n+                        pprust::expr_to_string(value)\n+                    };\n+                Self::remove_outer_parens(cx, value.span, &expr_text, msg);\n             }\n         }\n     }\n@@ -295,8 +300,13 @@ impl UnusedParens {\n                                 value: &ast::Pat,\n                                 msg: &str) {\n         if let ast::PatKind::Paren(_) = value.node {\n-            let pattern = pprust::pat_to_string(value);\n-            Self::remove_outer_parens(cx, value.span, &pattern, msg);\n+            let pattern_text = if let Ok(snippet) = cx.sess().source_map()\n+                .span_to_snippet(value.span) {\n+                    snippet\n+                } else {\n+                    pprust::pat_to_string(value)\n+                };\n+            Self::remove_outer_parens(cx, value.span, &pattern_text, msg);\n         }\n     }\n "}, {"sha": "77d546a00ecd47fd8b2df908227a8191f475f68d", "filename": "src/test/ui/lint/suggestions.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2/src%2Ftest%2Fui%2Flint%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2/src%2Ftest%2Fui%2Flint%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fsuggestions.rs?ref=6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2", "patch": "@@ -56,7 +56,7 @@ fn main() {\n     while true {\n     //~^ WARN denote infinite loops\n     //~| HELP use `loop`\n-        let mut a = (1);\n+        let mut registry_no = (format!(\"NX-{}\", 74205));\n         //~^ WARN does not need to be mutable\n         //~| HELP remove this `mut`\n         //~| WARN unnecessary parentheses\n@@ -72,6 +72,6 @@ fn main() {\n             //~^ WARN this pattern is redundant\n             //~| HELP remove this\n         }\n-        println!(\"{} {}\", a, b);\n+        println!(\"{} {}\", registry_no, b);\n     }\n }"}, {"sha": "73704614815bed69407bed2750f4603dc042b3d1", "filename": "src/test/ui/lint/suggestions.stderr", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2/src%2Ftest%2Fui%2Flint%2Fsuggestions.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2/src%2Ftest%2Fui%2Flint%2Fsuggestions.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fsuggestions.stderr?ref=6dfeb7602fed2678b5f18b1fb5fcb3c1e8c04ce2", "patch": "@@ -1,8 +1,8 @@\n warning: unnecessary parentheses around assigned value\n-  --> $DIR/suggestions.rs:59:21\n+  --> $DIR/suggestions.rs:59:31\n    |\n-LL |         let mut a = (1);\n-   |                     ^^^ help: remove these parentheses\n+LL |         let mut registry_no = (format!(\"NX-{}\", 74205));\n+   |                               ^^^^^^^^^^^^^^^^^^^^^^^^^ help: remove these parentheses\n    |\n note: lint level defined here\n   --> $DIR/suggestions.rs:13:21\n@@ -21,8 +21,8 @@ LL | #[no_debug] // should suggest removal of deprecated attribute\n warning: variable does not need to be mutable\n   --> $DIR/suggestions.rs:59:13\n    |\n-LL |         let mut a = (1);\n-   |             ----^\n+LL |         let mut registry_no = (format!(\"NX-{}\", 74205));\n+   |             ----^^^^^^^^^^^\n    |             |\n    |             help: remove this `mut`\n    |"}]}