{"sha": "00b54130874b6a6541626b9b023948440fe11141", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAwYjU0MTMwODc0YjZhNjU0MTYyNmI5YjAyMzk0ODQ0MGZlMTExNDE=", "commit": {"author": {"name": "Marco A L Barbosa", "email": "malbarbo@gmail.com", "date": "2018-01-03T15:24:56Z"}, "committer": {"name": "Marco A L Barbosa", "email": "malbarbo@gmail.com", "date": "2018-01-03T15:49:13Z"}, "message": "ci: use musl shared script in dist-i586-gnu-i686-musl", "tree": {"sha": "3eb73504ecf688b5ce2ac22272b0c78b906aa6d4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3eb73504ecf688b5ce2ac22272b0c78b906aa6d4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/00b54130874b6a6541626b9b023948440fe11141", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/00b54130874b6a6541626b9b023948440fe11141", "html_url": "https://github.com/rust-lang/rust/commit/00b54130874b6a6541626b9b023948440fe11141", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/00b54130874b6a6541626b9b023948440fe11141/comments", "author": {"login": "malbarbo", "id": 1678126, "node_id": "MDQ6VXNlcjE2NzgxMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1678126?v=4", "gravatar_id": "", "url": "https://api.github.com/users/malbarbo", "html_url": "https://github.com/malbarbo", "followers_url": "https://api.github.com/users/malbarbo/followers", "following_url": "https://api.github.com/users/malbarbo/following{/other_user}", "gists_url": "https://api.github.com/users/malbarbo/gists{/gist_id}", "starred_url": "https://api.github.com/users/malbarbo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/malbarbo/subscriptions", "organizations_url": "https://api.github.com/users/malbarbo/orgs", "repos_url": "https://api.github.com/users/malbarbo/repos", "events_url": "https://api.github.com/users/malbarbo/events{/privacy}", "received_events_url": "https://api.github.com/users/malbarbo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "malbarbo", "id": 1678126, "node_id": "MDQ6VXNlcjE2NzgxMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1678126?v=4", "gravatar_id": "", "url": "https://api.github.com/users/malbarbo", "html_url": "https://github.com/malbarbo", "followers_url": "https://api.github.com/users/malbarbo/followers", "following_url": "https://api.github.com/users/malbarbo/following{/other_user}", "gists_url": "https://api.github.com/users/malbarbo/gists{/gist_id}", "starred_url": "https://api.github.com/users/malbarbo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/malbarbo/subscriptions", "organizations_url": "https://api.github.com/users/malbarbo/orgs", "repos_url": "https://api.github.com/users/malbarbo/repos", "events_url": "https://api.github.com/users/malbarbo/events{/privacy}", "received_events_url": "https://api.github.com/users/malbarbo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "10a759130e763206bb961deb4c9da6e0466c71a1", "url": "https://api.github.com/repos/rust-lang/rust/commits/10a759130e763206bb961deb4c9da6e0466c71a1", "html_url": "https://github.com/rust-lang/rust/commit/10a759130e763206bb961deb4c9da6e0466c71a1"}], "stats": {"total": 114, "additions": 41, "deletions": 73}, "files": [{"sha": "c59476fab009cf7ca4707622d54ab207fccc8297", "filename": "src/ci/docker/dist-i586-gnu-i686-musl/Dockerfile", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/00b54130874b6a6541626b9b023948440fe11141/src%2Fci%2Fdocker%2Fdist-i586-gnu-i686-musl%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/00b54130874b6a6541626b9b023948440fe11141/src%2Fci%2Fdocker%2Fdist-i586-gnu-i686-musl%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-i586-gnu-i686-musl%2FDockerfile?ref=00b54130874b6a6541626b9b023948440fe11141", "patch": "@@ -17,8 +17,11 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   pkg-config\n \n WORKDIR /build/\n-COPY dist-i586-gnu-i686-musl/musl-libunwind-patch.patch dist-i586-gnu-i686-musl/build-musl.sh /build/\n-RUN sh /build/build-musl.sh && rm -rf /build\n+COPY scripts/musl.sh /build/\n+RUN CC=gcc CFLAGS=\"-m32 -fPIC -Wa,-mrelax-relocations=no\" \\\n+    CXX=g++ CXXFLAGS=\"-m32 -Wa,-mrelax-relocations=no\" \\\n+    bash musl.sh i686 --target=i686 && \\\n+    rm -rf /build\n \n COPY scripts/sccache.sh /scripts/\n RUN sh /scripts/sccache.sh"}, {"sha": "883859d1fa64e89cd09c9c5917255589fd8926c0", "filename": "src/ci/docker/dist-i586-gnu-i686-musl/build-musl.sh", "status": "removed", "additions": 0, "deletions": 55, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/10a759130e763206bb961deb4c9da6e0466c71a1/src%2Fci%2Fdocker%2Fdist-i586-gnu-i686-musl%2Fbuild-musl.sh", "raw_url": "https://github.com/rust-lang/rust/raw/10a759130e763206bb961deb4c9da6e0466c71a1/src%2Fci%2Fdocker%2Fdist-i586-gnu-i686-musl%2Fbuild-musl.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-i586-gnu-i686-musl%2Fbuild-musl.sh?ref=10a759130e763206bb961deb4c9da6e0466c71a1", "patch": "@@ -1,55 +0,0 @@\n-#!/bin/sh\n-# Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n-# file at the top-level directory of this distribution and at\n-# http://rust-lang.org/COPYRIGHT.\n-#\n-# Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n-# http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n-# <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n-# option. This file may not be copied, modified, or distributed\n-# except according to those terms.\n-\n-set -ex\n-\n-# We need to mitigate rust-lang/rust#34978 when compiling musl itself as well\n-export CFLAGS=\"-fPIC -Wa,-mrelax-relocations=no\"\n-export CXXFLAGS=\"-Wa,-mrelax-relocations=no\"\n-\n-MUSL=musl-1.1.17\n-curl https://www.musl-libc.org/releases/$MUSL.tar.gz | tar xzf -\n-cd $MUSL\n-CC=gcc \\\n-  CFLAGS=\"$CFLAGS -m32\" \\\n-  ./configure --prefix=/musl-i686 --disable-shared \\\n-    --target=i686\n-make AR=ar RANLIB=ranlib -j10\n-make install\n-cd ..\n-\n-# To build MUSL we're going to need a libunwind lying around, so acquire that\n-# here and build it.\n-curl -L https://github.com/llvm-mirror/llvm/archive/release_37.tar.gz | tar xzf -\n-curl -L https://github.com/llvm-mirror/libunwind/archive/release_37.tar.gz | tar xzf -\n-\n-# Whoa what's this mysterious patch we're applying to libunwind! Why are we\n-# swapping the values of ESP/EBP in libunwind?!\n-#\n-# Discovered in #35599 it turns out that the vanilla build of libunwind is not\n-# suitable for unwinding 32-bit musl. After some investigation it ended up\n-# looking like the register values for ESP/EBP were indeed incorrect (swapped)\n-# in the source. Similar commits in libunwind (r280099 and r282589) have noticed\n-# this for other platforms, and we just need to realize it for musl linux as\n-# well.\n-#\n-# More technical info can be found at #35599\n-cd libunwind-release_37\n-patch -Np1 < /build/musl-libunwind-patch.patch\n-cd ..\n-\n-mkdir libunwind-build\n-cd libunwind-build\n-CFLAGS=\"$CFLAGS -m32\" CXXFLAGS=\"$CXXFLAGS -m32\" cmake ../libunwind-release_37 \\\n-          -DLLVM_PATH=/build/llvm-release_37 \\\n-          -DLIBUNWIND_ENABLE_SHARED=0\n-make -j10\n-cp lib/libunwind.a /musl-i686/lib"}, {"sha": "99cd685b72d1718aaf6933da48fec15b21c91591", "filename": "src/ci/docker/dist-i586-gnu-i686-musl/musl-libunwind-patch.patch", "status": "removed", "additions": 0, "deletions": 15, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/10a759130e763206bb961deb4c9da6e0466c71a1/src%2Fci%2Fdocker%2Fdist-i586-gnu-i686-musl%2Fmusl-libunwind-patch.patch", "raw_url": "https://github.com/rust-lang/rust/raw/10a759130e763206bb961deb4c9da6e0466c71a1/src%2Fci%2Fdocker%2Fdist-i586-gnu-i686-musl%2Fmusl-libunwind-patch.patch", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-i586-gnu-i686-musl%2Fmusl-libunwind-patch.patch?ref=10a759130e763206bb961deb4c9da6e0466c71a1", "patch": "@@ -1,15 +0,0 @@\n-diff --git a/include/libunwind.h b/include/libunwind.h\n-index c5b9633..1360eb2 100644\n---- a/include/libunwind.h\n-+++ b/include/libunwind.h\n-@@ -151,8 +151,8 @@ enum {\n-   UNW_X86_ECX = 1,\n-   UNW_X86_EDX = 2,\n-   UNW_X86_EBX = 3,\n--  UNW_X86_EBP = 4,\n--  UNW_X86_ESP = 5,\n-+  UNW_X86_ESP = 4,\n-+  UNW_X86_EBP = 5,\n-   UNW_X86_ESI = 6,\n-   UNW_X86_EDI = 7\n- };"}, {"sha": "b704e37d5929128be514f929b39bd0db551c5334", "filename": "src/ci/docker/scripts/musl.sh", "status": "modified", "additions": 36, "deletions": 1, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/00b54130874b6a6541626b9b023948440fe11141/src%2Fci%2Fdocker%2Fscripts%2Fmusl.sh", "raw_url": "https://github.com/rust-lang/rust/raw/00b54130874b6a6541626b9b023948440fe11141/src%2Fci%2Fdocker%2Fscripts%2Fmusl.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fmusl.sh?ref=00b54130874b6a6541626b9b023948440fe11141", "patch": "@@ -39,7 +39,11 @@ fi\n \n cd $MUSL\n ./configure --disable-shared --prefix=/musl-$TAG $@\n-hide_output make -j$(nproc)\n+if [ \"$TAG\" = \"i686\" ]; then\n+  hide_output make -j$(nproc) AR=ar RANLIB=ranlib\n+else\n+  hide_output make -j$(nproc)\n+fi\n hide_output make install\n hide_output make clean\n \n@@ -50,6 +54,37 @@ LLVM=39\n if [ ! -d libunwind-release_$LLVM ]; then\n   curl -L https://github.com/llvm-mirror/llvm/archive/release_$LLVM.tar.gz | tar xzf -\n   curl -L https://github.com/llvm-mirror/libunwind/archive/release_$LLVM.tar.gz | tar xzf -\n+  # Whoa what's this mysterious patch we're applying to libunwind! Why are we\n+  # swapping the values of ESP/EBP in libunwind?!\n+  #\n+  # Discovered in #35599 it turns out that the vanilla build of libunwind is not\n+  # suitable for unwinding i686 musl. After some investigation it ended up\n+  # looking like the register values for ESP/EBP were indeed incorrect (swapped)\n+  # in the source. Similar commits in libunwind (r280099 and r282589) have noticed\n+  # this for other platforms, and we just need to realize it for musl linux as\n+  # well.\n+  #\n+  # More technical info can be found at #35599\n+  cd libunwind-release_$LLVM\n+  patch -Np1 << EOF\n+diff --git a/include/libunwind.h b/include/libunwind.h\n+index c5b9633..1360eb2 100644\n+--- a/include/libunwind.h\n++++ b/include/libunwind.h\n+@@ -151,8 +151,8 @@ enum {\n+   UNW_X86_ECX = 1,\n+   UNW_X86_EDX = 2,\n+   UNW_X86_EBX = 3,\n+-  UNW_X86_EBP = 4,\n+-  UNW_X86_ESP = 5,\n++  UNW_X86_ESP = 4,\n++  UNW_X86_EBP = 5,\n+   UNW_X86_ESI = 6,\n+   UNW_X86_EDI = 7\n+ };\n+fi\n+EOF\n+  cd ..\n fi\n \n mkdir libunwind-build"}]}