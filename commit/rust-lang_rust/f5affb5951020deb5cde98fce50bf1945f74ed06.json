{"sha": "f5affb5951020deb5cde98fce50bf1945f74ed06", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY1YWZmYjU5NTEwMjBkZWI1Y2RlOThmY2U1MGJmMTk0NWY3NGVkMDY=", "commit": {"author": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2017-09-21T17:31:26Z"}, "committer": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2017-09-21T17:31:26Z"}, "message": "Make the fallback of generator resumption be unreachable instead of using return", "tree": {"sha": "dc2a1ebf7a47dd3c5cd17264fdf65c4e587ad5c2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dc2a1ebf7a47dd3c5cd17264fdf65c4e587ad5c2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f5affb5951020deb5cde98fce50bf1945f74ed06", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f5affb5951020deb5cde98fce50bf1945f74ed06", "html_url": "https://github.com/rust-lang/rust/commit/f5affb5951020deb5cde98fce50bf1945f74ed06", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f5affb5951020deb5cde98fce50bf1945f74ed06/comments", "author": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1b55d19479eabcb5d6cbda651187c7004aa28f7f", "url": "https://api.github.com/repos/rust-lang/rust/commits/1b55d19479eabcb5d6cbda651187c7004aa28f7f", "html_url": "https://github.com/rust-lang/rust/commit/1b55d19479eabcb5d6cbda651187c7004aa28f7f"}], "stats": {"total": 21, "additions": 11, "deletions": 10}, "files": [{"sha": "507a42970c10afb8346bd8593122b40e22399d08", "filename": "src/librustc_mir/transform/generator.rs", "status": "modified", "additions": 11, "deletions": 10, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/f5affb5951020deb5cde98fce50bf1945f74ed06/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f5affb5951020deb5cde98fce50bf1945f74ed06/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs?ref=f5affb5951020deb5cde98fce50bf1945f74ed06", "patch": "@@ -443,14 +443,15 @@ fn compute_layout<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n fn insert_switch<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n                            mir: &mut Mir<'tcx>,\n                            cases: Vec<(u32, BasicBlock)>,\n-                           transform: &TransformVisitor<'a, 'tcx>) {\n-    let return_block = insert_return_block(mir);\n+                           transform: &TransformVisitor<'a, 'tcx>,\n+                           default: TerminatorKind<'tcx>) {\n+    let default_block = insert_term_block(mir, default);\n \n     let switch = TerminatorKind::SwitchInt {\n         discr: Operand::Consume(transform.make_field(transform.state_field, tcx.types.u32)),\n         switch_ty: tcx.types.u32,\n         values: Cow::from(cases.iter().map(|&(i, _)| ConstInt::U32(i)).collect::<Vec<_>>()),\n-        targets: cases.iter().map(|&(_, d)| d).chain(once(return_block)).collect(),\n+        targets: cases.iter().map(|&(_, d)| d).chain(once(default_block)).collect(),\n     };\n \n     let source_info = source_info(mir);\n@@ -542,7 +543,7 @@ fn create_generator_drop_shim<'a, 'tcx>(\n     // The returned state (1) and the poisoned state (2) falls through to\n     // the default case which is just to return\n \n-    insert_switch(tcx, &mut mir, cases, &transform);\n+    insert_switch(tcx, &mut mir, cases, &transform, TerminatorKind::Return);\n \n     for block in mir.basic_blocks_mut() {\n         let kind = &mut block.terminator_mut().kind;\n@@ -588,18 +589,18 @@ fn create_generator_drop_shim<'a, 'tcx>(\n     mir\n }\n \n-fn insert_return_block<'tcx>(mir: &mut Mir<'tcx>) -> BasicBlock {\n-    let return_block = BasicBlock::new(mir.basic_blocks().len());\n+fn insert_term_block<'tcx>(mir: &mut Mir<'tcx>, kind: TerminatorKind<'tcx>) -> BasicBlock {\n+    let term_block = BasicBlock::new(mir.basic_blocks().len());\n     let source_info = source_info(mir);\n     mir.basic_blocks_mut().push(BasicBlockData {\n         statements: Vec::new(),\n         terminator: Some(Terminator {\n             source_info,\n-            kind: TerminatorKind::Return,\n+            kind,\n         }),\n         is_cleanup: false,\n     });\n-    return_block\n+    term_block\n }\n \n fn insert_panic_block<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n@@ -659,7 +660,7 @@ fn create_generator_resume_function<'a, 'tcx>(\n     // Panic when resumed on the poisoned (2) state\n     cases.insert(2, (2, insert_panic_block(tcx, mir, AssertMessage::GeneratorResumedAfterPanic)));\n \n-    insert_switch(tcx, mir, cases, &transform);\n+    insert_switch(tcx, mir, cases, &transform, TerminatorKind::Unreachable);\n \n     make_generator_state_argument_indirect(tcx, def_id, mir);\n \n@@ -680,7 +681,7 @@ fn source_info<'a, 'tcx>(mir: &Mir<'tcx>) -> SourceInfo {\n }\n \n fn insert_clean_drop<'a, 'tcx>(mir: &mut Mir<'tcx>) -> BasicBlock {\n-    let return_block = insert_return_block(mir);\n+    let return_block = insert_term_block(mir, TerminatorKind::Return);\n \n     // Create a block to destroy an unresumed generators. This can only destroy upvars.\n     let drop_clean = BasicBlock::new(mir.basic_blocks().len());"}]}