{"sha": "1ddbae372fce6d0fde6cdda4082ec45dc2f113d3", "node_id": "C_kwDOAAsO6NoAKDFkZGJhZTM3MmZjZTZkMGZkZTZjZGRhNDA4MmVjNDVkYzJmMTEzZDM", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-03-11T14:29:11Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-03-18T09:49:50Z"}, "message": "Compare installed browser-ui-test version to the one used in CI", "tree": {"sha": "4f15be5efa763ec81de8cdab95d9de10ba5e01ad", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4f15be5efa763ec81de8cdab95d9de10ba5e01ad"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1ddbae372fce6d0fde6cdda4082ec45dc2f113d3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1ddbae372fce6d0fde6cdda4082ec45dc2f113d3", "html_url": "https://github.com/rust-lang/rust/commit/1ddbae372fce6d0fde6cdda4082ec45dc2f113d3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1ddbae372fce6d0fde6cdda4082ec45dc2f113d3/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "691d1c1e12602c57237e9ccddac406ebd0c54082", "url": "https://api.github.com/repos/rust-lang/rust/commits/691d1c1e12602c57237e9ccddac406ebd0c54082", "html_url": "https://github.com/rust-lang/rust/commit/691d1c1e12602c57237e9ccddac406ebd0c54082"}], "stats": {"total": 69, "additions": 50, "deletions": 19}, "files": [{"sha": "c8b76809abad72aea0344b63258f9225fadbce93", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 41, "deletions": 17, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/1ddbae372fce6d0fde6cdda4082ec45dc2f113d3/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ddbae372fce6d0fde6cdda4082ec45dc2f113d3/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=1ddbae372fce6d0fde6cdda4082ec45dc2f113d3", "patch": "@@ -836,22 +836,39 @@ impl Step for RustdocJSNotStd {\n     }\n }\n \n-fn check_if_browser_ui_test_is_installed_global(npm: &Path, global: bool) -> bool {\n+fn get_browser_ui_test_version_inner(npm: &Path, global: bool) -> Option<String> {\n     let mut command = Command::new(&npm);\n-    command.arg(\"list\").arg(\"--depth=0\");\n+    command.arg(\"list\").arg(\"--parseable\").arg(\"--long\").arg(\"--depth=0\");\n     if global {\n         command.arg(\"--global\");\n     }\n     let lines = command\n         .output()\n         .map(|output| String::from_utf8_lossy(&output.stdout).into_owned())\n         .unwrap_or(String::new());\n-    lines.contains(&\" browser-ui-test@\")\n+    lines.lines().find_map(|l| l.split(\":browser-ui-test@\").skip(1).next()).map(|v| v.to_owned())\n }\n \n-fn check_if_browser_ui_test_is_installed(npm: &Path) -> bool {\n-    check_if_browser_ui_test_is_installed_global(npm, false)\n-        || check_if_browser_ui_test_is_installed_global(npm, true)\n+fn get_browser_ui_test_version(npm: &Path) -> Option<String> {\n+    get_browser_ui_test_version_inner(npm, false)\n+        .or_else(|| get_browser_ui_test_version_inner(npm, true))\n+}\n+\n+fn compare_browser_ui_test_version(installed_version: &str, src: &Path) {\n+    match fs::read_to_string(\n+        src.join(\"src/ci/docker/host-x86_64/x86_64-gnu-tools/browser-ui-test.version\"),\n+    ) {\n+        Ok(v) => {\n+            if v.trim() != installed_version {\n+                eprintln!(\n+                    \"\u26a0\ufe0f Installed version of browser-ui-test (`{}`) is different than the \\\n+                     one used in the CI (`{}`)\",\n+                    installed_version, v\n+                );\n+            }\n+        }\n+        Err(e) => eprintln!(\"Couldn't find the CI browser-ui-test version: {:?}\", e),\n+    }\n }\n \n #[derive(Debug, Copy, Clone, Hash, PartialEq, Eq)]\n@@ -874,7 +891,7 @@ impl Step for RustdocGUI {\n                     .config\n                     .npm\n                     .as_ref()\n-                    .map(|p| check_if_browser_ui_test_is_installed(p))\n+                    .map(|p| get_browser_ui_test_version(p).is_some())\n                     .unwrap_or(false)\n         }))\n     }\n@@ -892,16 +909,23 @@ impl Step for RustdocGUI {\n \n         // The goal here is to check if the necessary packages are installed, and if not, we\n         // panic.\n-        if !check_if_browser_ui_test_is_installed(&npm) {\n-            eprintln!(\n-                \"error: rustdoc-gui test suite cannot be run because npm `browser-ui-test` \\\n-                 dependency is missing\",\n-            );\n-            eprintln!(\n-                \"If you want to install the `{0}` dependency, run `npm install {0}`\",\n-                \"browser-ui-test\",\n-            );\n-            panic!(\"Cannot run rustdoc-gui tests\");\n+        match get_browser_ui_test_version(&npm) {\n+            Some(version) => {\n+                // We also check the version currently used in CI and emit a warning if it's not the\n+                // same one.\n+                compare_browser_ui_test_version(&version, &builder.build.src);\n+            }\n+            None => {\n+                eprintln!(\n+                    \"error: rustdoc-gui test suite cannot be run because npm `browser-ui-test` \\\n+                     dependency is missing\",\n+                );\n+                eprintln!(\n+                    \"If you want to install the `{0}` dependency, run `npm install {0}`\",\n+                    \"browser-ui-test\",\n+                );\n+                panic!(\"Cannot run rustdoc-gui tests\");\n+            }\n         }\n \n         let out_dir = builder.test_out(self.target).join(\"rustdoc-gui\");"}, {"sha": "2358091a6dfbf86cd2847625b48b9c6fdf18738a", "filename": "src/ci/docker/host-x86_64/x86_64-gnu-tools/Dockerfile", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/1ddbae372fce6d0fde6cdda4082ec45dc2f113d3/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/1ddbae372fce6d0fde6cdda4082ec45dc2f113d3/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2FDockerfile?ref=1ddbae372fce6d0fde6cdda4082ec45dc2f113d3", "patch": "@@ -65,14 +65,20 @@ RUN /scripts/cmake.sh\n COPY host-x86_64/x86_64-gnu-tools/checktools.sh /tmp/\n \n RUN curl -sL https://nodejs.org/dist/v14.4.0/node-v14.4.0-linux-x64.tar.xz | tar -xJ\n-ENV PATH=\"/node-v14.4.0-linux-x64/bin:${PATH}\"\n+ENV NODE_FOLDER=/node-v14.4.0-linux-x64/bin\n+ENV PATH=\"$NODE_FOLDER:${PATH}\"\n+\n+COPY host-x86_64/x86_64-gnu-tools/browser-ui-test.version /tmp/\n \n # For now, we need to use `--unsafe-perm=true` to go around an issue when npm tries\n # to create a new folder. For reference:\n # https://github.com/puppeteer/puppeteer/issues/375\n #\n # We also specify the version in case we need to update it to go around cache limitations.\n-RUN npm install -g browser-ui-test@0.8.3 --unsafe-perm=true\n+#\n+# The `browser-ui-test.version` file is also used by bootstrap to emit warnings in case\n+# the local version of the package is different than the one used by the CI.\n+RUN npm install -g browser-ui-test@$(head -n 1 /tmp/browser-ui-test.version) --unsafe-perm=true\n \n ENV RUST_CONFIGURE_ARGS \\\n   --build=x86_64-unknown-linux-gnu \\"}, {"sha": "fab77af2a1a7301ebd696324675e5d81f043b901", "filename": "src/ci/docker/host-x86_64/x86_64-gnu-tools/browser-ui-test.version", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1ddbae372fce6d0fde6cdda4082ec45dc2f113d3/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2Fbrowser-ui-test.version", "raw_url": "https://github.com/rust-lang/rust/raw/1ddbae372fce6d0fde6cdda4082ec45dc2f113d3/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2Fbrowser-ui-test.version", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2Fbrowser-ui-test.version?ref=1ddbae372fce6d0fde6cdda4082ec45dc2f113d3", "patch": "@@ -0,0 +1 @@\n+0.8.3\n\\ No newline at end of file"}]}