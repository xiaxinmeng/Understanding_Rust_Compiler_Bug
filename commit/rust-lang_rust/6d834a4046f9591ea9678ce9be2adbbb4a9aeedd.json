{"sha": "6d834a4046f9591ea9678ce9be2adbbb4a9aeedd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZkODM0YTQwNDZmOTU5MWVhOTY3OGNlOWJlMmFkYmJiNGE5YWVlZGQ=", "commit": {"author": {"name": "Tyler Mandry", "email": "tmandry@gmail.com", "date": "2020-09-01T02:18:14Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-09-01T02:18:14Z"}, "message": "Rollup merge of #76002 - richkadel:llvm-coverage-map-gen-6b.3, r=tmandry\n\nFix `-Z instrument-coverage` on MSVC\n\nFound that `-C link-dead-code` (which was enabled automatically\nunder `-Z instrument-coverage`) was causing the linking error that\nresulted in segmentation faults in coverage instrumented binaries. Link\ndead code is now disabled under MSVC, allowing `-Z instrument-coverage`\nto be enabled under MSVC for the first time.\n\nMore details are included in Issue #76038 .\n\nNote this PR makes it possible to support `Z instrument-coverage` but\ndoes not enable instrument coverage for MSVC in existing tests. It will be\nenabled in another PR to follow this one (both PRs coming from original\nPR #75828).\n\nr? @tmandry\nFYI: @wesleywiser", "tree": {"sha": "d987ffc6fd70ab04b630bb6eb0c7e8eae43d8519", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d987ffc6fd70ab04b630bb6eb0c7e8eae43d8519"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfTa9nCRBK7hj4Ov3rIwAAdHIIAEpeO6jBF6ezEqLC8IH4M4NT\n1wjbYkIt8v9F2QIyGgr0cx156ucN/7/wgaeh8kl+I4+RApqlEq7qvb3Ahj43FpAP\nGHdaU9mf5QM2uWZtAyZArVAN17m/p5CIQ+g9sCVCq0S8rNZeVe5ZI4czUjd77zXV\nQmGW06vqRI6JOhgJlmYs1ARRhVEo+slzKxzayzy9cpy3K5eKeZQQQK+BCsJB5wSE\nIjUr/8jgM7J7qejg3Vws44R8fDS8tVfJSL51hibQiGjEHSJRwhBXiafF5Sw7Vj26\nHefBXGF8yX8TnZwHYhBhb2aAvfM1Cgxzcu5TBGiuNFh4CySFWiJpronFEuJ//vA=\n=N7dm\n-----END PGP SIGNATURE-----\n", "payload": "tree d987ffc6fd70ab04b630bb6eb0c7e8eae43d8519\nparent b67582449339a8c90a18aec2e93f6fc3560acb2f\nparent ddb054aee898dd74261fa8f50fe0c6541e5ceaf3\nauthor Tyler Mandry <tmandry@gmail.com> 1598926694 -0700\ncommitter GitHub <noreply@github.com> 1598926694 -0700\n\nRollup merge of #76002 - richkadel:llvm-coverage-map-gen-6b.3, r=tmandry\n\nFix `-Z instrument-coverage` on MSVC\n\nFound that `-C link-dead-code` (which was enabled automatically\nunder `-Z instrument-coverage`) was causing the linking error that\nresulted in segmentation faults in coverage instrumented binaries. Link\ndead code is now disabled under MSVC, allowing `-Z instrument-coverage`\nto be enabled under MSVC for the first time.\n\nMore details are included in Issue #76038 .\n\nNote this PR makes it possible to support `Z instrument-coverage` but\ndoes not enable instrument coverage for MSVC in existing tests. It will be\nenabled in another PR to follow this one (both PRs coming from original\nPR #75828).\n\nr? @tmandry\nFYI: @wesleywiser\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd", "html_url": "https://github.com/rust-lang/rust/commit/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd/comments", "author": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b67582449339a8c90a18aec2e93f6fc3560acb2f", "url": "https://api.github.com/repos/rust-lang/rust/commits/b67582449339a8c90a18aec2e93f6fc3560acb2f", "html_url": "https://github.com/rust-lang/rust/commit/b67582449339a8c90a18aec2e93f6fc3560acb2f"}, {"sha": "ddb054aee898dd74261fa8f50fe0c6541e5ceaf3", "url": "https://api.github.com/repos/rust-lang/rust/commits/ddb054aee898dd74261fa8f50fe0c6541e5ceaf3", "html_url": "https://github.com/rust-lang/rust/commit/ddb054aee898dd74261fa8f50fe0c6541e5ceaf3"}], "stats": {"total": 79, "additions": 45, "deletions": 34}, "files": [{"sha": "270c8250e19812f11702c427a6b1401e1bca44a4", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=6d834a4046f9591ea9678ce9be2adbbb4a9aeedd", "patch": "@@ -1668,7 +1668,7 @@ fn linker_with_args<'a, B: ArchiveBuilder<'a>>(\n     // FIXME: Order dependent, applies to the following objects. Where should it be placed?\n     // Try to strip as much out of the generated object by removing unused\n     // sections if possible. See more comments in linker.rs\n-    if sess.opts.cg.link_dead_code != Some(true) {\n+    if !sess.link_dead_code() {\n         let keep_metadata = crate_type == CrateType::Dylib;\n         cmd.gc_sections(keep_metadata);\n     }"}, {"sha": "79e2c5aac23859939bbe467a890ecd3dc0b752b1", "filename": "compiler/rustc_middle/src/mir/mono.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs?ref=6d834a4046f9591ea9678ce9be2adbbb4a9aeedd", "patch": "@@ -85,7 +85,7 @@ impl<'tcx> MonoItem<'tcx> {\n             .debugging_opts\n             .inline_in_all_cgus\n             .unwrap_or_else(|| tcx.sess.opts.optimize != OptLevel::No)\n-            && tcx.sess.opts.cg.link_dead_code != Some(true);\n+            && !tcx.sess.link_dead_code();\n \n         match *self {\n             MonoItem::Fn(ref instance) => {"}, {"sha": "b45fe0ee010f98ba9d4f7451a1126cfb2334e825", "filename": "compiler/rustc_mir/src/monomorphize/partitioning/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd/compiler%2Frustc_mir%2Fsrc%2Fmonomorphize%2Fpartitioning%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd/compiler%2Frustc_mir%2Fsrc%2Fmonomorphize%2Fpartitioning%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fmonomorphize%2Fpartitioning%2Fmod.rs?ref=6d834a4046f9591ea9678ce9be2adbbb4a9aeedd", "patch": "@@ -190,7 +190,7 @@ pub fn partition<'tcx>(\n \n     // Next we try to make as many symbols \"internal\" as possible, so LLVM has\n     // more freedom to optimize.\n-    if tcx.sess.opts.cg.link_dead_code != Some(true) {\n+    if !tcx.sess.link_dead_code() {\n         let _prof_timer = tcx.prof.generic_activity(\"cgu_partitioning_internalize_symbols\");\n         partitioner.internalize_symbols(tcx, &mut post_inlining, inlining_map);\n     }\n@@ -327,7 +327,7 @@ fn collect_and_partition_mono_items<'tcx>(\n             }\n         }\n         None => {\n-            if tcx.sess.opts.cg.link_dead_code == Some(true) {\n+            if tcx.sess.link_dead_code() {\n                 MonoItemCollectionMode::Eager\n             } else {\n                 MonoItemCollectionMode::Lazy"}, {"sha": "0a2a535598a2ff8c66da875f209c14cc9f5fba79", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 4, "deletions": 13, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=6d834a4046f9591ea9678ce9be2adbbb4a9aeedd", "patch": "@@ -1718,20 +1718,11 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n             );\n         }\n \n-        // `-Z instrument-coverage` implies:\n-        //   * `-Z symbol-mangling-version=v0` - to ensure consistent and reversible name mangling.\n-        //     Note, LLVM coverage tools can analyze coverage over multiple runs, including some\n-        //     changes to source code; so mangled names must be consistent across compilations.\n-        //   * `-C link-dead-code` - so unexecuted code is still counted as zero, rather than be\n-        //     optimized out. Note that instrumenting dead code can be explicitly disabled with:\n-        //         `-Z instrument-coverage -C link-dead-code=no`.\n+        // `-Z instrument-coverage` implies `-Z symbol-mangling-version=v0` - to ensure consistent\n+        // and reversible name mangling. Note, LLVM coverage tools can analyze coverage over\n+        // multiple runs, including some changes to source code; so mangled names must be consistent\n+        // across compilations.\n         debugging_opts.symbol_mangling_version = SymbolManglingVersion::V0;\n-        if cg.link_dead_code == None {\n-            // FIXME(richkadel): Investigate if the `instrument-coverage` implementation can\n-            // inject [\"zero counters\"](https://llvm.org/docs/CoverageMappingFormat.html#counter)\n-            // in the coverage map when \"dead code\" is removed, rather than forcing `link-dead-code`.\n-            cg.link_dead_code = Some(true);\n-        }\n     }\n \n     if !cg.embed_bitcode {"}, {"sha": "ee30c16108a0c50d51f3ce0e450ff0a2f6342ed2", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=6d834a4046f9591ea9678ce9be2adbbb4a9aeedd", "patch": "@@ -885,9 +885,9 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         \"instrument the generated code to support LLVM source-based code coverage \\\n         reports (note, the compiler build config must include `profiler = true`, \\\n         and is mutually exclusive with `-C profile-generate`/`-C profile-use`); \\\n-        implies `-C link-dead-code` (unless explicitly disabled)` and \\\n-        `-Z symbol-mangling-version=v0`; and disables/overrides some optimization \\\n-        options (default: no)\"),\n+        implies `-C link-dead-code` (unless targeting MSVC, or explicitly disabled) \\\n+        and `-Z symbol-mangling-version=v0`; disables/overrides some Rust \\\n+        optimizations (default: no)\"),\n     instrument_mcount: bool = (false, parse_bool, [TRACKED],\n         \"insert function instrument code for mcount-based tracing (default: no)\"),\n     keep_hygiene_data: bool = (false, parse_bool, [UNTRACKED],"}, {"sha": "db2059251c0c8f8b02409c26e79d6121b651f567", "filename": "compiler/rustc_session/src/session.rs", "status": "modified", "additions": 34, "deletions": 14, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d834a4046f9591ea9678ce9be2adbbb4a9aeedd/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fsession.rs?ref=6d834a4046f9591ea9678ce9be2adbbb4a9aeedd", "patch": "@@ -1024,6 +1024,40 @@ impl Session {\n         || self.opts.debugging_opts.sanitizer.intersects(SanitizerSet::ADDRESS | SanitizerSet::MEMORY)\n     }\n \n+    pub fn link_dead_code(&self) -> bool {\n+        match self.opts.cg.link_dead_code {\n+            Some(explicitly_set) => explicitly_set,\n+            None => {\n+                self.opts.debugging_opts.instrument_coverage\n+                    && !self.target.target.options.is_like_msvc\n+                // Issue #76038: (rustc `-Clink-dead-code` causes MSVC linker to produce invalid\n+                // binaries when LLVM InstrProf counters are enabled). As described by this issue,\n+                // the \"link dead code\" option produces incorrect binaries when compiled and linked\n+                // under MSVC. The resulting Rust programs typically crash with a segmentation\n+                // fault, or produce an empty \"*.profraw\" file (profiling counter results normally\n+                // generated during program exit).\n+                //\n+                // If not targeting MSVC, `-Z instrument-coverage` implies `-C link-dead-code`, so\n+                // unexecuted code is still counted as zero, rather than be optimized out. Note that\n+                // instrumenting dead code can be explicitly disabled with:\n+                //\n+                //     `-Z instrument-coverage -C link-dead-code=no`.\n+                //\n+                // FIXME(richkadel): Investigate if `instrument-coverage` implementation can inject\n+                // [zero counters](https://llvm.org/docs/CoverageMappingFormat.html#counter) in the\n+                // coverage map when \"dead code\" is removed, rather than forcing `link-dead-code`.\n+                // This may not be possible, however, if (as it seems to appear) the \"dead code\"\n+                // that would otherwise not be linked is only identified as \"dead\" by the native\n+                // linker. If that's the case, I believe it is too late for the Rust compiler to\n+                // leverage any information it might be able to get from the linker regarding what\n+                // code is dead, to be able to add those counters.\n+                //\n+                // On the other hand, if any Rust compiler passes are optimizing out dead code blocks\n+                // we should inject \"zero\" counters for those code regions.\n+            }\n+        }\n+    }\n+\n     pub fn mark_attr_known(&self, attr: &Attribute) {\n         self.known_attrs.lock().mark(attr)\n     }\n@@ -1432,20 +1466,6 @@ fn validate_commandline_args_with_session_available(sess: &Session) {\n         );\n     }\n \n-    // FIXME(richkadel): See `src/test/run-make-fulldeps/instrument-coverage/Makefile`. After\n-    // compiling with `-Zinstrument-coverage`, the resulting binary generates a segfault during\n-    // the program's exit process (likely while attempting to generate the coverage stats in\n-    // the \"*.profraw\" file). An investigation to resolve the problem on Windows is ongoing,\n-    // but until this is resolved, the option is disabled on Windows, and the test is skipped\n-    // when targeting `MSVC`.\n-    if sess.opts.debugging_opts.instrument_coverage && sess.target.target.options.is_like_msvc {\n-        sess.warn(\n-            \"Rust source-based code coverage instrumentation (with `-Z instrument-coverage`) \\\n-            is not yet supported on Windows when targeting MSVC. The resulting binaries will \\\n-            still be instrumented for experimentation purposes, but may not execute correctly.\",\n-        );\n-    }\n-\n     const ASAN_SUPPORTED_TARGETS: &[&str] = &[\n         \"aarch64-fuchsia\",\n         \"aarch64-unknown-linux-gnu\","}]}