{"sha": "fe8ace8da3e2dba750fe09587628b2c36d303267", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZlOGFjZThkYTNlMmRiYTc1MGZlMDk1ODc2MjhiMmMzNmQzMDMyNjc=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2018-10-04T20:40:17Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2018-10-08T10:23:50Z"}, "message": "Move errors specify \"dereference of raw pointer\".\n\nPreviously, move errors involving the dereference of a raw pointer would\nsay \"borrowed content\". This commit changes it to say \"dereference of\nraw pointer\".", "tree": {"sha": "e6489bbecdc99f2a53b25204ce68b2c745f4125a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e6489bbecdc99f2a53b25204ce68b2c745f4125a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fe8ace8da3e2dba750fe09587628b2c36d303267", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEWwgxPGhT5b/6kagXAXYLT59T8VQFAlu7MDYACgkQAXYLT59T\n8VTQ1RAAobwKncSAekEyH7fzp1XywzkFk1pdX7s9x/ez1iwa5PjNq3pmBmU4AXFb\nZtmXOH0AQUzQUtTfAy8oXuKR5DXJF/NySziWboXWe7eWBUWkADfVanrJ3jPn54sT\nwfNmEQAWYoOh52Kg65LFr9JesvZCzQxn7hS/oOsNiWXp2YJwin8ebAE44/uHLDc2\nGH3ij9ZEqJNWWlsnRYdSl2y+snVqSO6LeRNcxWE7SygsEBo5CEcoB03wlKurojZv\ngFeByTL2sKQtLbpf7nx0d2JOsGTHeG8xHLCu246ITThJVER+qClhFOzZTdU/yqYI\n9h//pqqDdKpV4iE7QRYW69Zc7s3GRUrLeA85Pq21G03lF2RUzXIDYrYUgU3X4eq3\nnsyMZ/H1C5KCrc4ahFV89ZC4xVX4i9OskmEIvEokkU0dTM7LC9gawNyZZ2SN9pCL\nVENyb9GeLMtBS/tUJTFJ8CS3Tz5Zdz1UR+wU85PWLZSY9B3hKcqtepwGLihiYj7t\nAEOG05YKd2mryjMVr4qhuROd8u0rQ65sTBfSJETNskVt7l6kZZXQZWxVVJmGc7PG\nLyhhiy8sfF9x/VgpD+LWIujN5fy4S/8j32S6+tsYvaU5UuMVStFIot0ly4WKA08U\n3hTaVnFAFhEBnqk3tfm6C5l41e7tDIHNaOWXgjfmfasDBZqL/Us=\n=XY2E\n-----END PGP SIGNATURE-----", "payload": "tree e6489bbecdc99f2a53b25204ce68b2c745f4125a\nparent 61f5ca7d6419ecd22dc4c0eaf2902d7fe7db4323\nauthor David Wood <david@davidtw.co> 1538685617 +0200\ncommitter David Wood <david@davidtw.co> 1538994230 +0200\n\nMove errors specify \"dereference of raw pointer\".\n\nPreviously, move errors involving the dereference of a raw pointer would\nsay \"borrowed content\". This commit changes it to say \"dereference of\nraw pointer\".\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fe8ace8da3e2dba750fe09587628b2c36d303267", "html_url": "https://github.com/rust-lang/rust/commit/fe8ace8da3e2dba750fe09587628b2c36d303267", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fe8ace8da3e2dba750fe09587628b2c36d303267/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "61f5ca7d6419ecd22dc4c0eaf2902d7fe7db4323", "url": "https://api.github.com/repos/rust-lang/rust/commits/61f5ca7d6419ecd22dc4c0eaf2902d7fe7db4323", "html_url": "https://github.com/rust-lang/rust/commit/61f5ca7d6419ecd22dc4c0eaf2902d7fe7db4323"}], "stats": {"total": 27, "additions": 21, "deletions": 6}, "files": [{"sha": "ea62694f8be753c7c52e6b1c71fd8127b0af5282", "filename": "src/librustc_mir/borrow_check/move_errors.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/fe8ace8da3e2dba750fe09587628b2c36d303267/src%2Flibrustc_mir%2Fborrow_check%2Fmove_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe8ace8da3e2dba750fe09587628b2c36d303267/src%2Flibrustc_mir%2Fborrow_check%2Fmove_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fmove_errors.rs?ref=fe8ace8da3e2dba750fe09587628b2c36d303267", "patch": "@@ -68,6 +68,7 @@ enum GroupedMoveError<'tcx> {\n enum BorrowedContentSource {\n     Arc,\n     Rc,\n+    DerefRawPointer,\n     Other,\n }\n \n@@ -76,6 +77,7 @@ impl Display for BorrowedContentSource {\n         match *self {\n             BorrowedContentSource::Arc => write!(f, \"an `Arc`\"),\n             BorrowedContentSource::Rc => write!(f, \"an `Rc`\"),\n+            BorrowedContentSource::DerefRawPointer => write!(f, \"dereference of raw pointer\"),\n             BorrowedContentSource::Other => write!(f, \"borrowed content\"),\n         }\n     }\n@@ -279,6 +281,7 @@ impl<'a, 'gcx, 'tcx> MirBorrowckCtxt<'a, 'gcx, 'tcx> {\n                             self.prefixes(&original_path, PrefixSet::All)\n                             .any(|p| p.is_upvar_field_projection(self.mir, &self.infcx.tcx)\n                                  .is_some());\n+                        debug!(\"report: ty={:?}\", ty);\n                         match ty.sty {\n                             ty::Array(..) | ty::Slice(..) =>\n                                 self.infcx.tcx.cannot_move_out_of_interior_noncopy(\n@@ -582,6 +585,18 @@ impl<'a, 'gcx, 'tcx> MirBorrowckCtxt<'a, 'gcx, 'tcx> {\n             }\n         }\n \n+        // If we didn't find an `Arc` or an `Rc`, then check specifically for\n+        // a dereference of a place that has the type of a raw pointer.\n+        // We can't use `place.ty(..).to_ty(..)` here as that strips away the raw pointer.\n+        if let Place::Projection(box Projection {\n+            base,\n+            elem: ProjectionElem::Deref,\n+        }) = place {\n+            if base.ty(self.mir, self.infcx.tcx).to_ty(self.infcx.tcx).is_unsafe_ptr() {\n+                return BorrowedContentSource::DerefRawPointer;\n+            }\n+        }\n+\n         BorrowedContentSource::Other\n     }\n }"}, {"sha": "c3a2180b9f082e062f9afab0ede465a7511ac8f3", "filename": "src/test/ui/borrowck/borrowck-move-from-unsafe-ptr.nll.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fe8ace8da3e2dba750fe09587628b2c36d303267/src%2Ftest%2Fui%2Fborrowck%2Fborrowck-move-from-unsafe-ptr.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fe8ace8da3e2dba750fe09587628b2c36d303267/src%2Ftest%2Fui%2Fborrowck%2Fborrowck-move-from-unsafe-ptr.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fborrowck-move-from-unsafe-ptr.nll.stderr?ref=fe8ace8da3e2dba750fe09587628b2c36d303267", "patch": "@@ -1,10 +1,10 @@\n-error[E0507]: cannot move out of borrowed content\n+error[E0507]: cannot move out of dereference of raw pointer\n   --> $DIR/borrowck-move-from-unsafe-ptr.rs:13:13\n    |\n LL |     let y = *x; //~ ERROR cannot move out of dereference of raw pointer\n    |             ^^\n    |             |\n-   |             cannot move out of borrowed content\n+   |             cannot move out of dereference of raw pointer\n    |             help: consider removing the `*`: `x`\n \n error: aborting due to previous error"}, {"sha": "362778b26c861911d2624046c87cd15c65d575ea", "filename": "src/test/ui/issues/issue-20801.nll.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/fe8ace8da3e2dba750fe09587628b2c36d303267/src%2Ftest%2Fui%2Fissues%2Fissue-20801.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fe8ace8da3e2dba750fe09587628b2c36d303267/src%2Ftest%2Fui%2Fissues%2Fissue-20801.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-20801.nll.stderr?ref=fe8ace8da3e2dba750fe09587628b2c36d303267", "patch": "@@ -16,22 +16,22 @@ LL |     let b = unsafe { *imm_ref() };\n    |                      cannot move out of borrowed content\n    |                      help: consider removing the `*`: `imm_ref()`\n \n-error[E0507]: cannot move out of borrowed content\n+error[E0507]: cannot move out of dereference of raw pointer\n   --> $DIR/issue-20801.rs:42:22\n    |\n LL |     let c = unsafe { *mut_ptr() };\n    |                      ^^^^^^^^^^\n    |                      |\n-   |                      cannot move out of borrowed content\n+   |                      cannot move out of dereference of raw pointer\n    |                      help: consider removing the `*`: `mut_ptr()`\n \n-error[E0507]: cannot move out of borrowed content\n+error[E0507]: cannot move out of dereference of raw pointer\n   --> $DIR/issue-20801.rs:45:22\n    |\n LL |     let d = unsafe { *const_ptr() };\n    |                      ^^^^^^^^^^^^\n    |                      |\n-   |                      cannot move out of borrowed content\n+   |                      cannot move out of dereference of raw pointer\n    |                      help: consider removing the `*`: `const_ptr()`\n \n error: aborting due to 4 previous errors"}]}