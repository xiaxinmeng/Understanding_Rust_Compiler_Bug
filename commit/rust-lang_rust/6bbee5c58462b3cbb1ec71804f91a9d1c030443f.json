{"sha": "6bbee5c58462b3cbb1ec71804f91a9d1c030443f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZiYmVlNWM1ODQ2MmIzY2JiMWVjNzE4MDRmOTFhOWQxYzAzMDQ0M2Y=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-16T16:57:15Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-16T16:57:15Z"}, "message": "Auto merge of #7217 - xFrednet:7172-metadata-collection-cargo-alias, r=flip1995\n\nAdd `cargo collect-metadata` as an cargo alias for the metadata collection lint\n\nThis PR adds a new alias to run the metadata collection monster on `clippy_lints`. I'm currently using it to create the `metadata_collection.json` file and I plan to use it in the `deply.sh` script. Having it as a new alias enables us to simply use:\n\n```sh\ncargo collect-metadata\n```\n\nIt sometimes requires running `cargo clean` before collecting the metadata due to caching. I'm still debating if I should include a cargo clean as part of the `run_metadata_collection_lint` test or not. Input on this would be greatly appreciated :upside_down_face:\n\nThat's it, just a small change that can be reviewed and merged in parallel to #7214.\n\n---\n\nSee: #7172 for the full metadata collection to-do list or to suggest a new feature in connection to it.\n\n---\n\nchangelog: none\n\nr? `@flip1995` btw. feel free to pass these PRs one to other team members as well if you want.", "tree": {"sha": "a0065e5843f9d8669ed66162ea7fb5b741053b14", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a0065e5843f9d8669ed66162ea7fb5b741053b14"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6bbee5c58462b3cbb1ec71804f91a9d1c030443f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6bbee5c58462b3cbb1ec71804f91a9d1c030443f", "html_url": "https://github.com/rust-lang/rust/commit/6bbee5c58462b3cbb1ec71804f91a9d1c030443f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6bbee5c58462b3cbb1ec71804f91a9d1c030443f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "58359b2d2d34b38b62b8ea1b96b40686f689201d", "url": "https://api.github.com/repos/rust-lang/rust/commits/58359b2d2d34b38b62b8ea1b96b40686f689201d", "html_url": "https://github.com/rust-lang/rust/commit/58359b2d2d34b38b62b8ea1b96b40686f689201d"}, {"sha": "0d4604dc05acd45d2401f4973d6085a4eba50016", "url": "https://api.github.com/repos/rust-lang/rust/commits/0d4604dc05acd45d2401f4973d6085a4eba50016", "html_url": "https://github.com/rust-lang/rust/commit/0d4604dc05acd45d2401f4973d6085a4eba50016"}], "stats": {"total": 69, "additions": 41, "deletions": 28}, "files": [{"sha": "e95ea224cb681361993f8643bd2be639d420a288", "filename": ".cargo/config", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6bbee5c58462b3cbb1ec71804f91a9d1c030443f/.cargo%2Fconfig", "raw_url": "https://github.com/rust-lang/rust/raw/6bbee5c58462b3cbb1ec71804f91a9d1c030443f/.cargo%2Fconfig", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.cargo%2Fconfig?ref=6bbee5c58462b3cbb1ec71804f91a9d1c030443f", "patch": "@@ -2,6 +2,7 @@\n uitest = \"test --test compile-test\"\n dev = \"run --target-dir clippy_dev/target --package clippy_dev --bin clippy_dev --manifest-path clippy_dev/Cargo.toml --\"\n lintcheck = \"run --target-dir lintcheck/target --package lintcheck --bin lintcheck --manifest-path lintcheck/Cargo.toml  -- \"\n+collect-metadata = \"test --test dogfood --features metadata-collector-lint -- run_metadata_collection_lint --ignored\"\n \n [build]\n rustflags = [\"-Zunstable-options\"]"}, {"sha": "5d9f128753f105fada9a0dfc3405cd9ea7e7b8ba", "filename": "tests/dogfood.rs", "status": "modified", "additions": 40, "deletions": 28, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/6bbee5c58462b3cbb1ec71804f91a9d1c030443f/tests%2Fdogfood.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6bbee5c58462b3cbb1ec71804f91a9d1c030443f/tests%2Fdogfood.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fdogfood.rs?ref=6bbee5c58462b3cbb1ec71804f91a9d1c030443f", "patch": "@@ -22,14 +22,12 @@ fn dogfood_clippy() {\n         return;\n     }\n     let root_dir = PathBuf::from(env!(\"CARGO_MANIFEST_DIR\"));\n-    let enable_metadata_collection = std::env::var(\"ENABLE_METADATA_COLLECTION\").unwrap_or_else(|_| \"0\".to_string());\n \n     let mut command = Command::new(&*CLIPPY_PATH);\n     command\n         .current_dir(root_dir)\n         .env(\"CLIPPY_DOGFOOD\", \"1\")\n         .env(\"CARGO_INCREMENTAL\", \"0\")\n-        .env(\"ENABLE_METADATA_COLLECTION\", &enable_metadata_collection)\n         .arg(\"clippy\")\n         .arg(\"--all-targets\")\n         .arg(\"--all-features\")\n@@ -157,10 +155,9 @@ fn dogfood_subprojects() {\n     if cargo::is_rustc_test_suite() {\n         return;\n     }\n-    let root_dir = PathBuf::from(env!(\"CARGO_MANIFEST_DIR\"));\n \n     // NOTE: `path_dep` crate is omitted on purpose here\n-    for d in &[\n+    for project in &[\n         \"clippy_workspace_tests\",\n         \"clippy_workspace_tests/src\",\n         \"clippy_workspace_tests/subcrate\",\n@@ -170,34 +167,49 @@ fn dogfood_subprojects() {\n         \"clippy_utils\",\n         \"rustc_tools_util\",\n     ] {\n-        let mut command = Command::new(&*CLIPPY_PATH);\n-        command\n-            .current_dir(root_dir.join(d))\n-            .env(\"CLIPPY_DOGFOOD\", \"1\")\n-            .env(\"CARGO_INCREMENTAL\", \"0\")\n-            .arg(\"clippy\")\n-            .arg(\"--all-targets\")\n-            .arg(\"--all-features\")\n-            .arg(\"--\")\n-            .args(&[\"-D\", \"clippy::all\"])\n-            .args(&[\"-D\", \"clippy::pedantic\"])\n-            .arg(\"-Cdebuginfo=0\"); // disable debuginfo to generate less data in the target dir\n+        run_clippy_for_project(project);\n+    }\n+\n+    // NOTE: Since tests run in parallel we can't run cargo commands on the same workspace at the\n+    // same time, so we test this immediately after the dogfood for workspaces.\n+    test_no_deps_ignores_path_deps_in_workspaces();\n+}\n \n-        // internal lints only exist if we build with the internal-lints feature\n-        if cfg!(feature = \"internal-lints\") {\n-            command.args(&[\"-D\", \"clippy::internal\"]);\n-        }\n+#[test]\n+#[ignore]\n+#[cfg(feature = \"metadata-collector-lint\")]\n+fn run_metadata_collection_lint() {\n+    std::env::set_var(\"ENABLE_METADATA_COLLECTION\", \"1\");\n+    run_clippy_for_project(\"clippy_lints\");\n+}\n \n-        let output = command.output().unwrap();\n+fn run_clippy_for_project(project: &str) {\n+    let root_dir = PathBuf::from(env!(\"CARGO_MANIFEST_DIR\"));\n \n-        println!(\"status: {}\", output.status);\n-        println!(\"stdout: {}\", String::from_utf8_lossy(&output.stdout));\n-        println!(\"stderr: {}\", String::from_utf8_lossy(&output.stderr));\n+    let mut command = Command::new(&*CLIPPY_PATH);\n \n-        assert!(output.status.success());\n+    command\n+        .current_dir(root_dir.join(project))\n+        .env(\"CLIPPY_DOGFOOD\", \"1\")\n+        .env(\"CARGO_INCREMENTAL\", \"0\")\n+        .arg(\"clippy\")\n+        .arg(\"--all-targets\")\n+        .arg(\"--all-features\")\n+        .arg(\"--\")\n+        .args(&[\"-D\", \"clippy::all\"])\n+        .args(&[\"-D\", \"clippy::pedantic\"])\n+        .arg(\"-Cdebuginfo=0\"); // disable debuginfo to generate less data in the target dir\n+\n+    // internal lints only exist if we build with the internal-lints feature\n+    if cfg!(feature = \"internal-lints\") {\n+        command.args(&[\"-D\", \"clippy::internal\"]);\n     }\n \n-    // NOTE: Since tests run in parallel we can't run cargo commands on the same workspace at the\n-    // same time, so we test this immediately after the dogfood for workspaces.\n-    test_no_deps_ignores_path_deps_in_workspaces();\n+    let output = command.output().unwrap();\n+\n+    println!(\"status: {}\", output.status);\n+    println!(\"stdout: {}\", String::from_utf8_lossy(&output.stdout));\n+    println!(\"stderr: {}\", String::from_utf8_lossy(&output.stderr));\n+\n+    assert!(output.status.success());\n }"}]}