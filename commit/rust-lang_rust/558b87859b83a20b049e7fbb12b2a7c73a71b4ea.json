{"sha": "558b87859b83a20b049e7fbb12b2a7c73a71b4ea", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU1OGI4Nzg1OWI4M2EyMGIwNDllN2ZiYjEyYjJhN2M3M2E3MWI0ZWE=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-01-24T21:10:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-24T21:10:08Z"}, "message": "Rollup merge of #81320 - CraftSpider:jsondoc-errors, r=jyn514\n\nMake bad shlex parsing a pretty error\n\nCloses #81319\n\nOld Output:\n<details><summary>Backtrace</summary>\n<p>\n\n```\nthread 'main' panicked at 'called `Option::unwrap()` on a `None` value', src\\too\nls\\jsondocck\\src\\main.rs:152:81\nstack backtrace:\n   0:     0x7ff79a011405 - std::backtrace_rs::backtrace::dbghelp::trace\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\..\\..\\backtrace\\src\\backtrace\\dbghelp.rs:98\n   1:     0x7ff79a011405 - std::backtrace_rs::backtrace::trace_unsynchronized\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\..\\..\\backtrace\\src\\backtrace\\mod.rs:66\n   2:     0x7ff79a011405 - std::sys_common::backtrace::_print_fmt\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\sys_common\\backtrace.rs:67\n   3:     0x7ff79a011405 - std::sys_common::backtrace::_print::{{impl}}::fmt\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\sys_common\\backtrace.rs:46\n   4:     0x7ff79a026c7b - core::fmt::write\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\core\\src\\fmt\\mod.rs:1078\n   5:     0x7ff79a00e74d - std::io::Write::write_fmt<std::sys::windows::stdio::S\ntderr>\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\io\\mod.rs:1519\n   6:     0x7ff79a01413d - std::sys_common::backtrace::_print\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\sys_common\\backtrace.rs:49\n   7:     0x7ff79a01413d - std::sys_common::backtrace::print\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\sys_common\\backtrace.rs:36\n   8:     0x7ff79a01413d - std::panicking::default_hook::{{closure}}\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:208\n   9:     0x7ff79a013c4a - std::panicking::default_hook\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:225\n  10:     0x7ff79a014a7e - std::panicking::rust_panic_with_hook\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:591\n  11:     0x7ff79a014573 - std::panicking::begin_panic_handler::{{closure}}\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:495\n  12:     0x7ff79a011ddf - std::sys_common::backtrace::__rust_end_short_backtrac\ne<closure-0,!>\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\sys_common\\backtrace.rs:141\n  13:     0x7ff79a0144f9 - std::panicking::begin_panic_handler\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:493\n  14:     0x7ff79a025230 - core::panicking::panic_fmt\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\core\\src\\panicking.rs:92\n  15:     0x7ff79a02517c - core::panicking::panic\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\core\\src\\panicking.rs:50\n  16:     0x7ff799f5245f - indexmap::map::core::raw::<impl indexmap::map::core::\nIndexMapCore<K,V>>::get_index_of::had34e726f99bd999\n  17:     0x7ff799f48fea - std::sys_common::backtrace::__rust_begin_short_backtr\nace::h1ac92efa44350e74\n  18:     0x7ff799f41015 - std::rt::lang_start::{{closure}}::hdfe733a6a1ad9a18\n  19:     0x7ff79a014c34 - core::ops::function::impls::{{impl}}::call_once\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\library\\core\\src\\ops\\function.rs:280\n  20:     0x7ff79a014c34 - std::panicking::try::do_call\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:379\n  21:     0x7ff79a014c34 - std::panicking::try\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:343\n  22:     0x7ff79a014c34 - std::panic::catch_unwind\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panic.rs:396\n  23:     0x7ff79a014c34 - std::rt::lang_start_internal\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\rt.rs:51\n  24:     0x7ff799f536a7 - main\n  25:     0x7ff79a02d788 - invoke_main\n                               at d:\\A01\\_work\\6\\s\\src\\vctools\\crt\\vcstartup\\src\n\\startup\\exe_common.inl:78\n  26:     0x7ff79a02d788 - __scrt_common_main_seh\n                               at d:\\A01\\_work\\6\\s\\src\\vctools\\crt\\vcstartup\\src\n\\startup\\exe_common.inl:288\n  27:     0x7ffe6bf47034 - BaseThreadInitThunk\n  28:     0x7ffe6c89d241 - RtlUserThreadStart\n```\n\n</p>\n</details>\n\nNew Output:\n```\nInvalid command: Invalid arguments to shlex::split: ` - \"$foo` on line 26\n```\n\nI've hit this a couple times, makes debugging a little nicer.", "tree": {"sha": "deb92713d7e16665c1bddcf4fe49314596f5bd36", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/deb92713d7e16665c1bddcf4fe49314596f5bd36"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/558b87859b83a20b049e7fbb12b2a7c73a71b4ea", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgDeIwCRBK7hj4Ov3rIwAAdHIIABagEqzjJdMFDYFG0Xim3drZ\nj93s+xqlEAUtTRPgXKgH0Nf5zd2dYseUC2RnlXOVVVYIymFcX2a6cGJPuXkwdHrH\n1bQkjJn83WpaXTutn1/utkPvlSvVXuxK1S7ORQq/1Apy3BdKvvMmhMfwVyR83zwD\neIDayFeQXG02RJUFGRRv+FiU7deElA0BJWtM4evDczeuSQRUH+/850FMf8l6YDko\nbPTXoJmrh0dBMZVnTRqUPfGprfygCh18srrTNMSW9jp/Mq22YxdMFHyWtP6s41MX\nkCOQdVzHJoXyExQg7a3U4O91ZE2kCcduFihTn02Ly86LplCHJrzf8745BiwRt+g=\n=oA3c\n-----END PGP SIGNATURE-----\n", "payload": "tree deb92713d7e16665c1bddcf4fe49314596f5bd36\nparent 04ddf42218dca9f73edb38919d1dd9caae9b691e\nparent c37c4213543a727870ca862d25446b3c66d8e399\nauthor Jonas Schievink <jonasschievink@gmail.com> 1611522608 +0100\ncommitter GitHub <noreply@github.com> 1611522608 +0100\n\nRollup merge of #81320 - CraftSpider:jsondoc-errors, r=jyn514\n\nMake bad shlex parsing a pretty error\n\nCloses #81319\n\nOld Output:\n<details><summary>Backtrace</summary>\n<p>\n\n```\nthread 'main' panicked at 'called `Option::unwrap()` on a `None` value', src\\too\nls\\jsondocck\\src\\main.rs:152:81\nstack backtrace:\n   0:     0x7ff79a011405 - std::backtrace_rs::backtrace::dbghelp::trace\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\..\\..\\backtrace\\src\\backtrace\\dbghelp.rs:98\n   1:     0x7ff79a011405 - std::backtrace_rs::backtrace::trace_unsynchronized\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\..\\..\\backtrace\\src\\backtrace\\mod.rs:66\n   2:     0x7ff79a011405 - std::sys_common::backtrace::_print_fmt\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\sys_common\\backtrace.rs:67\n   3:     0x7ff79a011405 - std::sys_common::backtrace::_print::{{impl}}::fmt\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\sys_common\\backtrace.rs:46\n   4:     0x7ff79a026c7b - core::fmt::write\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\core\\src\\fmt\\mod.rs:1078\n   5:     0x7ff79a00e74d - std::io::Write::write_fmt<std::sys::windows::stdio::S\ntderr>\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\io\\mod.rs:1519\n   6:     0x7ff79a01413d - std::sys_common::backtrace::_print\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\sys_common\\backtrace.rs:49\n   7:     0x7ff79a01413d - std::sys_common::backtrace::print\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\sys_common\\backtrace.rs:36\n   8:     0x7ff79a01413d - std::panicking::default_hook::{{closure}}\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:208\n   9:     0x7ff79a013c4a - std::panicking::default_hook\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:225\n  10:     0x7ff79a014a7e - std::panicking::rust_panic_with_hook\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:591\n  11:     0x7ff79a014573 - std::panicking::begin_panic_handler::{{closure}}\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:495\n  12:     0x7ff79a011ddf - std::sys_common::backtrace::__rust_end_short_backtrac\ne<closure-0,!>\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\sys_common\\backtrace.rs:141\n  13:     0x7ff79a0144f9 - std::panicking::begin_panic_handler\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:493\n  14:     0x7ff79a025230 - core::panicking::panic_fmt\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\core\\src\\panicking.rs:92\n  15:     0x7ff79a02517c - core::panicking::panic\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\core\\src\\panicking.rs:50\n  16:     0x7ff799f5245f - indexmap::map::core::raw::<impl indexmap::map::core::\nIndexMapCore<K,V>>::get_index_of::had34e726f99bd999\n  17:     0x7ff799f48fea - std::sys_common::backtrace::__rust_begin_short_backtr\nace::h1ac92efa44350e74\n  18:     0x7ff799f41015 - std::rt::lang_start::{{closure}}::hdfe733a6a1ad9a18\n  19:     0x7ff79a014c34 - core::ops::function::impls::{{impl}}::call_once\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\library\\core\\src\\ops\\function.rs:280\n  20:     0x7ff79a014c34 - std::panicking::try::do_call\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:379\n  21:     0x7ff79a014c34 - std::panicking::try\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panicking.rs:343\n  22:     0x7ff79a014c34 - std::panic::catch_unwind\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\panic.rs:396\n  23:     0x7ff79a014c34 - std::rt::lang_start_internal\n                               at /rustc/05b6023675d77979637b04a350c85903fbf5925\n7\\/library\\std\\src\\rt.rs:51\n  24:     0x7ff799f536a7 - main\n  25:     0x7ff79a02d788 - invoke_main\n                               at d:\\A01\\_work\\6\\s\\src\\vctools\\crt\\vcstartup\\src\n\\startup\\exe_common.inl:78\n  26:     0x7ff79a02d788 - __scrt_common_main_seh\n                               at d:\\A01\\_work\\6\\s\\src\\vctools\\crt\\vcstartup\\src\n\\startup\\exe_common.inl:288\n  27:     0x7ffe6bf47034 - BaseThreadInitThunk\n  28:     0x7ffe6c89d241 - RtlUserThreadStart\n```\n\n</p>\n</details>\n\nNew Output:\n```\nInvalid command: Invalid arguments to shlex::split: ` - \"$foo` on line 26\n```\n\nI've hit this a couple times, makes debugging a little nicer.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/558b87859b83a20b049e7fbb12b2a7c73a71b4ea", "html_url": "https://github.com/rust-lang/rust/commit/558b87859b83a20b049e7fbb12b2a7c73a71b4ea", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/558b87859b83a20b049e7fbb12b2a7c73a71b4ea/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "04ddf42218dca9f73edb38919d1dd9caae9b691e", "url": "https://api.github.com/repos/rust-lang/rust/commits/04ddf42218dca9f73edb38919d1dd9caae9b691e", "html_url": "https://github.com/rust-lang/rust/commit/04ddf42218dca9f73edb38919d1dd9caae9b691e"}, {"sha": "c37c4213543a727870ca862d25446b3c66d8e399", "url": "https://api.github.com/repos/rust-lang/rust/commits/c37c4213543a727870ca862d25446b3c66d8e399", "html_url": "https://github.com/rust-lang/rust/commit/c37c4213543a727870ca862d25446b3c66d8e399"}], "stats": {"total": 17, "additions": 16, "deletions": 1}, "files": [{"sha": "6ec292aba649589be6d3426b8367ac80d4b5a48e", "filename": "src/tools/jsondocck/src/main.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/558b87859b83a20b049e7fbb12b2a7c73a71b4ea/src%2Ftools%2Fjsondocck%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/558b87859b83a20b049e7fbb12b2a7c73a71b4ea/src%2Ftools%2Fjsondocck%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fjsondocck%2Fsrc%2Fmain.rs?ref=558b87859b83a20b049e7fbb12b2a7c73a71b4ea", "patch": "@@ -149,7 +149,22 @@ fn get_commands(template: &str) -> Result<Vec<Command>, ()> {\n             }\n         }\n \n-        let args = cap.name(\"args\").map_or(vec![], |m| shlex::split(m.as_str()).unwrap());\n+        let args = cap.name(\"args\").map_or(Some(vec![]), |m| shlex::split(m.as_str()));\n+\n+        let args = match args {\n+            Some(args) => args,\n+            None => {\n+                print_err(\n+                    &format!(\n+                        \"Invalid arguments to shlex::split: `{}`\",\n+                        cap.name(\"args\").unwrap().as_str()\n+                    ),\n+                    lineno,\n+                );\n+                errors = true;\n+                continue;\n+            }\n+        };\n \n         if !cmd.validate(&args, commands.len(), lineno) {\n             errors = true;"}]}