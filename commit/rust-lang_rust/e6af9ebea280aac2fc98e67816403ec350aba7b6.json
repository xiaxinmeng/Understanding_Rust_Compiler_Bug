{"sha": "e6af9ebea280aac2fc98e67816403ec350aba7b6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU2YWY5ZWJlYTI4MGFhYzJmYzk4ZTY3ODE2NDAzZWMzNTBhYmE3YjY=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2018-01-23T23:34:16Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2018-01-24T05:36:40Z"}, "message": "Point at unknown lang item attribute", "tree": {"sha": "ea4cc89844f841f282877a55dd2f01a40576a2c8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ea4cc89844f841f282877a55dd2f01a40576a2c8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e6af9ebea280aac2fc98e67816403ec350aba7b6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e6af9ebea280aac2fc98e67816403ec350aba7b6", "html_url": "https://github.com/rust-lang/rust/commit/e6af9ebea280aac2fc98e67816403ec350aba7b6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e6af9ebea280aac2fc98e67816403ec350aba7b6/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3a39b2aa5a68dd07aacab2106db3927f666a485a", "url": "https://api.github.com/repos/rust-lang/rust/commits/3a39b2aa5a68dd07aacab2106db3927f666a485a", "html_url": "https://github.com/rust-lang/rust/commit/3a39b2aa5a68dd07aacab2106db3927f666a485a"}], "stats": {"total": 51, "additions": 41, "deletions": 10}, "files": [{"sha": "447ce46ee5c5c46415e41411780202aff027ee5b", "filename": "src/librustc/middle/lang_items.rs", "status": "modified", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/e6af9ebea280aac2fc98e67816403ec350aba7b6/src%2Flibrustc%2Fmiddle%2Flang_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6af9ebea280aac2fc98e67816403ec350aba7b6/src%2Flibrustc%2Fmiddle%2Flang_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Flang_items.rs?ref=e6af9ebea280aac2fc98e67816403ec350aba7b6", "patch": "@@ -28,6 +28,7 @@ use util::nodemap::FxHashMap;\n \n use syntax::ast;\n use syntax::symbol::Symbol;\n+use syntax_pos::Span;\n use hir::itemlikevisit::ItemLikeVisitor;\n use hir;\n \n@@ -104,17 +105,18 @@ struct LanguageItemCollector<'a, 'tcx: 'a> {\n \n impl<'a, 'v, 'tcx> ItemLikeVisitor<'v> for LanguageItemCollector<'a, 'tcx> {\n     fn visit_item(&mut self, item: &hir::Item) {\n-        if let Some(value) = extract(&item.attrs) {\n+        if let Some((value, span)) = extract(&item.attrs) {\n             let item_index = self.item_refs.get(&*value.as_str()).cloned();\n \n             if let Some(item_index) = item_index {\n                 let def_id = self.tcx.hir.local_def_id(item.id);\n                 self.collect_item(item_index, def_id);\n             } else {\n-                let span = self.tcx.hir.span(item.id);\n-                span_err!(self.tcx.sess, span, E0522,\n-                          \"definition of an unknown language item: `{}`.\",\n-                          value);\n+                let mut err = struct_span_err!(self.tcx.sess, span, E0522,\n+                                               \"definition of an unknown language item: `{}`\",\n+                                               value);\n+                err.span_label(span, format!(\"definition of unknown language item `{}`\", value));\n+                err.emit();\n             }\n         }\n     }\n@@ -177,11 +179,11 @@ impl<'a, 'tcx> LanguageItemCollector<'a, 'tcx> {\n     }\n }\n \n-pub fn extract(attrs: &[ast::Attribute]) -> Option<Symbol> {\n+pub fn extract(attrs: &[ast::Attribute]) -> Option<(Symbol, Span)> {\n     for attribute in attrs {\n         if attribute.check_name(\"lang\") {\n             if let Some(value) = attribute.value_str() {\n-                return Some(value)\n+                return Some((value, attribute.span));\n             }\n         }\n     }"}, {"sha": "95e75b4f0646efc42442ce7a60c425aad22fa152", "filename": "src/librustc/middle/weak_lang_items.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e6af9ebea280aac2fc98e67816403ec350aba7b6/src%2Flibrustc%2Fmiddle%2Fweak_lang_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6af9ebea280aac2fc98e67816403ec350aba7b6/src%2Flibrustc%2Fmiddle%2Fweak_lang_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fweak_lang_items.rs?ref=e6af9ebea280aac2fc98e67816403ec350aba7b6", "patch": "@@ -55,7 +55,7 @@ pub fn check_crate<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n }\n \n pub fn link_name(attrs: &[ast::Attribute]) -> Option<Symbol> {\n-    lang_items::extract(attrs).and_then(|name| {\n+    lang_items::extract(attrs).and_then(|(name, _)| {\n         $(if name == stringify!($name) {\n             Some(Symbol::intern(stringify!($sym)))\n         } else)* {\n@@ -129,7 +129,7 @@ impl<'a, 'tcx, 'v> Visitor<'v> for Context<'a, 'tcx> {\n     }\n \n     fn visit_foreign_item(&mut self, i: &hir::ForeignItem) {\n-        if let Some(lang_item) = lang_items::extract(&i.attrs) {\n+        if let Some((lang_item, _)) = lang_items::extract(&i.attrs) {\n             self.register(&lang_item.as_str(), i.span);\n         }\n         intravisit::walk_foreign_item(self, i)"}, {"sha": "3d4377853464b84b2cdeafddbca7efe22f155541", "filename": "src/test/compile-fail/E0522.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e6af9ebea280aac2fc98e67816403ec350aba7b6/src%2Ftest%2Fcompile-fail%2FE0522.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6af9ebea280aac2fc98e67816403ec350aba7b6/src%2Ftest%2Fcompile-fail%2FE0522.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2FE0522.rs?ref=e6af9ebea280aac2fc98e67816403ec350aba7b6", "patch": "@@ -11,6 +11,7 @@\n #![feature(lang_items)]\n \n #[lang = \"cookie\"]\n-fn cookie() -> ! { //~ E0522\n+fn cookie() -> ! {\n+//~^^ ERROR definition of an unknown language item: `cookie` [E0522]\n     loop {}\n }"}, {"sha": "3c2105997127d663c0aef2425346f44d1038e004", "filename": "src/test/ui/unknown-language-item.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/e6af9ebea280aac2fc98e67816403ec350aba7b6/src%2Ftest%2Fui%2Funknown-language-item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6af9ebea280aac2fc98e67816403ec350aba7b6/src%2Ftest%2Fui%2Funknown-language-item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funknown-language-item.rs?ref=e6af9ebea280aac2fc98e67816403ec350aba7b6", "patch": "@@ -0,0 +1,20 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![allow(unused)]\n+#![feature(lang_items)]\n+\n+#[lang = \"foo\"]\n+fn bar() -> ! {\n+//~^^ ERROR definition of an unknown language item: `foo`\n+    loop {}\n+}\n+\n+fn main() {}"}, {"sha": "c4b4a789c3dcc398f2bc8538292a3108738dab4d", "filename": "src/test/ui/unknown-language-item.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e6af9ebea280aac2fc98e67816403ec350aba7b6/src%2Ftest%2Fui%2Funknown-language-item.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e6af9ebea280aac2fc98e67816403ec350aba7b6/src%2Ftest%2Fui%2Funknown-language-item.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funknown-language-item.stderr?ref=e6af9ebea280aac2fc98e67816403ec350aba7b6", "patch": "@@ -0,0 +1,8 @@\n+error[E0522]: definition of an unknown language item: `foo`\n+  --> $DIR/unknown-language-item.rs:14:1\n+   |\n+14 | #[lang = \"foo\"]\n+   | ^^^^^^^^^^^^^^^ definition of unknown language item `foo`\n+\n+error: aborting due to previous error\n+"}]}