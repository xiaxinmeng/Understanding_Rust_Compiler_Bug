{"sha": "1c8b7412d4416c32854aaa588245b735712b5931", "node_id": "C_kwDOAAsO6NoAKDFjOGI3NDEyZDQ0MTZjMzI4NTRhYWE1ODgyNDViNzM1NzEyYjU5MzE", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-03-28T14:08:11Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-03-28T14:08:11Z"}, "message": "Rollup merge of #95390 - nnethercote:allow-doc-comments-in-macros, r=petrochenkov\n\nIgnore doc comments in a declarative macro matcher.\n\nFixes #95267. Reverts to the old behaviour before #95159 introduced a\nregression.\n\nr? `@petrochenkov`", "tree": {"sha": "22a1b240021c43ef2b88a903a571a55aac9c5073", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/22a1b240021c43ef2b88a903a571a55aac9c5073"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1c8b7412d4416c32854aaa588245b735712b5931", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiQcFLCRBK7hj4Ov3rIwAApoIIAKLO0gEsaLFVBzZM0nDKR6cS\n6ZIVBdMA2HUNVW6SuQ6Dpq0dlmAn2zjpjg/xuTV47uEsyoQaKrHA+IO21uwb2Emp\nBRNu5cQ0yqkC6Q6J73X25BAKuXsj+eIIxGf18gDOtyMwg6iyfuFc1Wl3Ig93FCaq\ncAdRsaLQ3+d18SMQ1I0+Cnr270lDqDIBpXdlP2GrAdu8lgZFXGyPicIfX8idw3Dn\nCJ6bfLRIY7FJn+QWRODTych+o0x42xEx3hVhpSdSzj23fOlsWZXCqHWlAMPHuqXL\nNqT9AsAePtZTKr/L4AxZ5b/CIkZ/i8vc4treHB+PjhcRO51iJ7kxKP9j+jgZ4oY=\n=PMwP\n-----END PGP SIGNATURE-----\n", "payload": "tree 22a1b240021c43ef2b88a903a571a55aac9c5073\nparent 2f5e9443228915a4425e0cc498db4c75a1a5a624\nparent 996759434610a151c71476ab85305bfcf2d6d5e7\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1648476491 +0200\ncommitter GitHub <noreply@github.com> 1648476491 +0200\n\nRollup merge of #95390 - nnethercote:allow-doc-comments-in-macros, r=petrochenkov\n\nIgnore doc comments in a declarative macro matcher.\n\nFixes #95267. Reverts to the old behaviour before #95159 introduced a\nregression.\n\nr? `@petrochenkov`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1c8b7412d4416c32854aaa588245b735712b5931", "html_url": "https://github.com/rust-lang/rust/commit/1c8b7412d4416c32854aaa588245b735712b5931", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1c8b7412d4416c32854aaa588245b735712b5931/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2f5e9443228915a4425e0cc498db4c75a1a5a624", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f5e9443228915a4425e0cc498db4c75a1a5a624", "html_url": "https://github.com/rust-lang/rust/commit/2f5e9443228915a4425e0cc498db4c75a1a5a624"}, {"sha": "996759434610a151c71476ab85305bfcf2d6d5e7", "url": "https://api.github.com/repos/rust-lang/rust/commits/996759434610a151c71476ab85305bfcf2d6d5e7", "html_url": "https://github.com/rust-lang/rust/commit/996759434610a151c71476ab85305bfcf2d6d5e7"}], "stats": {"total": 28, "additions": 21, "deletions": 7}, "files": [{"sha": "5a6a2b2c57b9656a161add1a9988a22294b877fc", "filename": "compiler/rustc_expand/src/mbe/macro_parser.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/1c8b7412d4416c32854aaa588245b735712b5931/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_parser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c8b7412d4416c32854aaa588245b735712b5931/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_parser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_parser.rs?ref=1c8b7412d4416c32854aaa588245b735712b5931", "patch": "@@ -516,13 +516,14 @@ impl<'tt> TtParser<'tt> {\n                     }\n \n                     TokenTree::Token(t) => {\n-                        // Doc comments cannot appear in a matcher.\n-                        debug_assert!(!matches!(t, Token { kind: DocComment(..), .. }));\n-\n-                        // If the token matches, we can just advance the parser. Otherwise, this\n-                        // match hash failed, there is nothing to do, and hopefully another item in\n-                        // `cur_items` will match.\n-                        if token_name_eq(&t, token) {\n+                        // If it's a doc comment, we just ignore it and move on to the next tt in\n+                        // the matcher. If the token matches, we can just advance the parser.\n+                        // Otherwise, this match has failed, there is nothing to do, and hopefully\n+                        // another item in `cur_items` will match.\n+                        if matches!(t, Token { kind: DocComment(..), .. }) {\n+                            item.idx += 1;\n+                            self.cur_items.push(item);\n+                        } else if token_name_eq(&t, token) {\n                             item.idx += 1;\n                             self.next_items.push(item);\n                         }"}, {"sha": "4d59c7ea5e9d7585aecc43dffaf494bf460fd4a5", "filename": "src/test/ui/macros/issue-95267.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/1c8b7412d4416c32854aaa588245b735712b5931/src%2Ftest%2Fui%2Fmacros%2Fissue-95267.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c8b7412d4416c32854aaa588245b735712b5931/src%2Ftest%2Fui%2Fmacros%2Fissue-95267.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fissue-95267.rs?ref=1c8b7412d4416c32854aaa588245b735712b5931", "patch": "@@ -0,0 +1,13 @@\n+// check-pass\n+\n+// This is a valid macro. Commit 4 in #95159 broke things such that it failed\n+// with a \"missing tokens in macro arguments\" error, as reported in #95267.\n+macro_rules! f {\n+    (\n+        /// ab\n+    ) => {};\n+}\n+\n+fn main() {\n+    f!();\n+}"}]}