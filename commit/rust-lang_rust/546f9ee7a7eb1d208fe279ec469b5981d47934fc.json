{"sha": "546f9ee7a7eb1d208fe279ec469b5981d47934fc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU0NmY5ZWU3YTdlYjFkMjA4ZmUyNzllYzQ2OWI1OTgxZDQ3OTM0ZmM=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-04-21T20:13:17Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-04-21T20:13:17Z"}, "message": "Merge #4078\n\n4078: Do not add default and closure types in 'add explicit type' assist r=matklad a=SomeoneToIgnore\n\n\n\nCo-authored-by: Kirill Bulatov <mail4score@gmail.com>", "tree": {"sha": "58d4bcad28bcd6df819ee00a3d7c12d16fe31078", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/58d4bcad28bcd6df819ee00a3d7c12d16fe31078"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/546f9ee7a7eb1d208fe279ec469b5981d47934fc", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJen1PdCRBK7hj4Ov3rIwAAdHIIAIvjK4SB2EnFTI0p0nCG2hlN\nCYHtj83aPQYpQXWix3sACwj3Kd2wilaqMtDEVefHlmp6LSynl8F2aeP+TpAegHPk\n1C2qFfS91iqCmt3Fqu1c1/IAv0Qx/xd35rO/wvzTpSLLfuxDqN18z2sYnEbBLVS+\nrGMw9fFf4Oo8VLFZGL8CcDXt7/63GUwTFxd+n6n25YHI5ZsHIC/pTrm2GK77nVC4\nEey3STc/eGvxvdS5d5RDzRbxmz29+G7Qecwb9mZvA98lG8SGcExll5FjndkqQNnV\n+o0STkIKtFJ8baPSqNXAfosnJ64lwtx6P1pigGyfVgcuoLuqI8uJD5ZDxLqJrDo=\n=s7XY\n-----END PGP SIGNATURE-----\n", "payload": "tree 58d4bcad28bcd6df819ee00a3d7c12d16fe31078\nparent 7ab28cacbb50d78e4e6f12293351683625cab607\nparent ce06a6b4225d7ea5777da11166ad618389df3573\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1587499997 +0000\ncommitter GitHub <noreply@github.com> 1587499997 +0000\n\nMerge #4078\n\n4078: Do not add default and closure types in 'add explicit type' assist r=matklad a=SomeoneToIgnore\n\n\n\nCo-authored-by: Kirill Bulatov <mail4score@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/546f9ee7a7eb1d208fe279ec469b5981d47934fc", "html_url": "https://github.com/rust-lang/rust/commit/546f9ee7a7eb1d208fe279ec469b5981d47934fc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/546f9ee7a7eb1d208fe279ec469b5981d47934fc/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7ab28cacbb50d78e4e6f12293351683625cab607", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ab28cacbb50d78e4e6f12293351683625cab607", "html_url": "https://github.com/rust-lang/rust/commit/7ab28cacbb50d78e4e6f12293351683625cab607"}, {"sha": "ce06a6b4225d7ea5777da11166ad618389df3573", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce06a6b4225d7ea5777da11166ad618389df3573", "html_url": "https://github.com/rust-lang/rust/commit/ce06a6b4225d7ea5777da11166ad618389df3573"}], "stats": {"total": 52, "additions": 47, "deletions": 5}, "files": [{"sha": "6c56d93d878d4cbff8fa21f3a567150efce20224", "filename": "crates/ra_assists/src/handlers/add_explicit_type.rs", "status": "modified", "additions": 43, "deletions": 5, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/546f9ee7a7eb1d208fe279ec469b5981d47934fc/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_explicit_type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/546f9ee7a7eb1d208fe279ec469b5981d47934fc/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_explicit_type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_explicit_type.rs?ref=546f9ee7a7eb1d208fe279ec469b5981d47934fc", "patch": "@@ -52,21 +52,22 @@ pub(crate) fn add_explicit_type(ctx: AssistCtx) -> Option<Assist> {\n     }\n     // Infer type\n     let ty = ctx.sema.type_of_expr(&expr)?;\n-    // Assist not applicable if the type is unknown\n-    if ty.contains_unknown() {\n+\n+    if ty.contains_unknown() || ty.is_closure() {\n         return None;\n     }\n \n     let db = ctx.db;\n+    let new_type_string = ty.display_truncated(db, None).to_string();\n     ctx.add_assist(\n         AssistId(\"add_explicit_type\"),\n-        format!(\"Insert explicit type '{}'\", ty.display(db)),\n+        format!(\"Insert explicit type '{}'\", new_type_string),\n         |edit| {\n             edit.target(pat_range);\n             if let Some(ascribed_ty) = ascribed_ty {\n-                edit.replace(ascribed_ty.syntax().text_range(), format!(\"{}\", ty.display(db)));\n+                edit.replace(ascribed_ty.syntax().text_range(), new_type_string);\n             } else {\n-                edit.insert(name_range.end(), format!(\": {}\", ty.display(db)));\n+                edit.insert(name_range.end(), format!(\": {}\", new_type_string));\n             }\n         },\n     )\n@@ -174,4 +175,41 @@ mod tests {\n             \"fn f() <|>{let a = match 1 {2 => 3, 3 => 5};}\",\n         )\n     }\n+\n+    #[test]\n+    fn closure_parameters_are_not_added() {\n+        check_assist_not_applicable(\n+            add_explicit_type,\n+            r#\"\n+fn main() {\n+    let multiply_by_two<|> = |i| i * 3;\n+    let six = multiply_by_two(2);\n+}\"#,\n+        )\n+    }\n+\n+    #[test]\n+    fn default_generics_should_not_be_added() {\n+        check_assist(\n+            add_explicit_type,\n+            r#\"\n+struct Test<K, T = u8> {\n+    k: K,\n+    t: T,\n+}\n+\n+fn main() {\n+    let test<|> = Test { t: 23, k: 33 };\n+}\"#,\n+            r#\"\n+struct Test<K, T = u8> {\n+    k: K,\n+    t: T,\n+}\n+\n+fn main() {\n+    let test<|>: Test<i32> = Test { t: 23, k: 33 };\n+}\"#,\n+        );\n+    }\n }"}, {"sha": "43f932e20cc8e189ed0c22eacb3ed79aaf898eb9", "filename": "crates/ra_hir/src/code_model.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/546f9ee7a7eb1d208fe279ec469b5981d47934fc/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "raw_url": "https://github.com/rust-lang/rust/raw/546f9ee7a7eb1d208fe279ec469b5981d47934fc/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fcode_model.rs?ref=546f9ee7a7eb1d208fe279ec469b5981d47934fc", "patch": "@@ -1132,6 +1132,10 @@ impl Type {\n         Some(self.ty.value.as_callable()?.0)\n     }\n \n+    pub fn is_closure(&self) -> bool {\n+        matches!(&self.ty.value, Ty::Apply(ApplicationTy { ctor: TypeCtor::Closure { .. }, .. }))\n+    }\n+\n     pub fn contains_unknown(&self) -> bool {\n         return go(&self.ty.value);\n "}]}