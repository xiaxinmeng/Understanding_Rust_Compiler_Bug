{"sha": "b970bc2a79719b5c1573fb87c96773ce131dbb8d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI5NzBiYzJhNzk3MTliNWMxNTczZmI4N2M5Njc3M2NlMTMxZGJiOGQ=", "commit": {"author": {"name": "Aidan Hobson Sayers", "email": "aidanhs@cantab.net", "date": "2017-04-04T21:51:16Z"}, "committer": {"name": "Aidan Hobson Sayers", "email": "aidanhs@cantab.net", "date": "2017-04-04T22:41:38Z"}, "message": "Enable appveyor cache, add more paranoia", "tree": {"sha": "804e1a1fb9493a6bc68dd2989d7836127499a71a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/804e1a1fb9493a6bc68dd2989d7836127499a71a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b970bc2a79719b5c1573fb87c96773ce131dbb8d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b970bc2a79719b5c1573fb87c96773ce131dbb8d", "html_url": "https://github.com/rust-lang/rust/commit/b970bc2a79719b5c1573fb87c96773ce131dbb8d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b970bc2a79719b5c1573fb87c96773ce131dbb8d/comments", "author": {"login": "aidanhs", "id": 1050652, "node_id": "MDQ6VXNlcjEwNTA2NTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1050652?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aidanhs", "html_url": "https://github.com/aidanhs", "followers_url": "https://api.github.com/users/aidanhs/followers", "following_url": "https://api.github.com/users/aidanhs/following{/other_user}", "gists_url": "https://api.github.com/users/aidanhs/gists{/gist_id}", "starred_url": "https://api.github.com/users/aidanhs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aidanhs/subscriptions", "organizations_url": "https://api.github.com/users/aidanhs/orgs", "repos_url": "https://api.github.com/users/aidanhs/repos", "events_url": "https://api.github.com/users/aidanhs/events{/privacy}", "received_events_url": "https://api.github.com/users/aidanhs/received_events", "type": "User", "site_admin": false}, "committer": {"login": "aidanhs", "id": 1050652, "node_id": "MDQ6VXNlcjEwNTA2NTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1050652?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aidanhs", "html_url": "https://github.com/aidanhs", "followers_url": "https://api.github.com/users/aidanhs/followers", "following_url": "https://api.github.com/users/aidanhs/following{/other_user}", "gists_url": "https://api.github.com/users/aidanhs/gists{/gist_id}", "starred_url": "https://api.github.com/users/aidanhs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aidanhs/subscriptions", "organizations_url": "https://api.github.com/users/aidanhs/orgs", "repos_url": "https://api.github.com/users/aidanhs/repos", "events_url": "https://api.github.com/users/aidanhs/events{/privacy}", "received_events_url": "https://api.github.com/users/aidanhs/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2564711e803f62e04bebf10408cc1c11297c0caf", "url": "https://api.github.com/repos/rust-lang/rust/commits/2564711e803f62e04bebf10408cc1c11297c0caf", "html_url": "https://github.com/rust-lang/rust/commit/2564711e803f62e04bebf10408cc1c11297c0caf"}], "stats": {"total": 22, "additions": 18, "deletions": 4}, "files": [{"sha": "b0adda4bdb904e234223fc9fbae9e2b0f6e76425", "filename": "appveyor.yml", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/b970bc2a79719b5c1573fb87c96773ce131dbb8d/appveyor.yml", "raw_url": "https://github.com/rust-lang/rust/raw/b970bc2a79719b5c1573fb87c96773ce131dbb8d/appveyor.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/appveyor.yml?ref=b970bc2a79719b5c1573fb87c96773ce131dbb8d", "patch": "@@ -141,15 +141,18 @@ install:\n   - set SCCACHE_ERROR_LOG=%CD%/sccache.log\n \n test_script:\n-  - appveyor-retry sh -c 'git submodule deinit -f . && git submodule update --init'\n+  - if not exist C:\\cache\\rustsrc\\NUL mkdir C:\\cache\\rustsrc\n+  - sh src/ci/init_repo.sh . /c/cache/rustsrc\n   - set SRC=.\n   - set NO_CCACHE=1\n   - sh src/ci/run.sh\n \n on_failure:\n-  - cat %CD%/sccache.log\n+  - cat %CD%\\sccache.log\n+  - cat C:\\Users\\appveyor\\AppData\\Local\\Temp\\1\\build-cache-logs\\*.log\n \n cache:\n+  - C:\\cache\\rustsrc\n   - \"build/i686-pc-windows-msvc/llvm -> src/rustllvm/llvm-rebuild-trigger\"\n   - \"build/x86_64-pc-windows-msvc/llvm -> src/rustllvm/llvm-rebuild-trigger\"\n   - \"i686-pc-windows-msvc/llvm -> src/rustllvm/llvm-rebuild-trigger\""}, {"sha": "c235681cddd0c5dac224280a0d67c25c6599c23b", "filename": "src/ci/init_repo.sh", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b970bc2a79719b5c1573fb87c96773ce131dbb8d/src%2Fci%2Finit_repo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/b970bc2a79719b5c1573fb87c96773ce131dbb8d/src%2Fci%2Finit_repo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Finit_repo.sh?ref=b970bc2a79719b5c1573fb87c96773ce131dbb8d", "patch": "@@ -38,9 +38,20 @@ fi\n \n # Wipe the cache if it's not valid, or mark it as invalid while we update it\n if [ ! -f \"$cache_valid_file\" ]; then\n-    rm -rf \"$CACHE_DIR\" && mkdir \"$CACHE_DIR\"\n+    rm -rf \"$CACHE_DIR\"\n+    mkdir \"$CACHE_DIR\"\n else\n-    rm \"$cache_valid_file\"\n+    stat_lines=$(cd \"$cache_src_dir\" && git status --porcelain | wc -l)\n+    stat_ec=$(cd \"$cache_src_dir\" && git status >/dev/null 2>&1 && echo $?)\n+    if [ ! -d \"$cache_src_dir/.git\" -o $stat_lines != 0 -o $stat_ec != 0 ]; then\n+        # Something is badly wrong - the cache valid file is here, but something\n+        # about the git repo is fishy. Nuke it all, just in case\n+        echo \"WARNING: $cache_valid_file exists but bad repo: l:$stat_lines, ec:$stat_ec\"\n+        rm -rf \"$CACHE_DIR\"\n+        mkdir \"$CACHE_DIR\"\n+    else\n+        rm \"$cache_valid_file\"\n+    fi\n fi\n \n # Update the cache (a pristine copy of the rust source master)"}]}