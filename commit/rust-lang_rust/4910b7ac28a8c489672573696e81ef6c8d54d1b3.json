{"sha": "4910b7ac28a8c489672573696e81ef6c8d54d1b3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ5MTBiN2FjMjhhOGM0ODk2NzI1NzM2OTZlODFlZjZjOGQ1NGQxYjM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-11-03T06:26:00Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-11-03T06:26:00Z"}, "message": "auto merge of #10242 : thestinger/rust/inline_dtor, r=alexcrichton\n\nCloses #7793", "tree": {"sha": "ae0939b4244a07f4a04cf7f056c18af1509259e1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ae0939b4244a07f4a04cf7f056c18af1509259e1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4910b7ac28a8c489672573696e81ef6c8d54d1b3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4910b7ac28a8c489672573696e81ef6c8d54d1b3", "html_url": "https://github.com/rust-lang/rust/commit/4910b7ac28a8c489672573696e81ef6c8d54d1b3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4910b7ac28a8c489672573696e81ef6c8d54d1b3/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b5c1b48048cc911c3caa07ada776239123a97b50", "url": "https://api.github.com/repos/rust-lang/rust/commits/b5c1b48048cc911c3caa07ada776239123a97b50", "html_url": "https://github.com/rust-lang/rust/commit/b5c1b48048cc911c3caa07ada776239123a97b50"}, {"sha": "e58270219fcb40e342d3f51ef140574960b21a67", "url": "https://api.github.com/repos/rust-lang/rust/commits/e58270219fcb40e342d3f51ef140574960b21a67", "html_url": "https://github.com/rust-lang/rust/commit/e58270219fcb40e342d3f51ef140574960b21a67"}], "stats": {"total": 53, "additions": 48, "deletions": 5}, "files": [{"sha": "64a4c453b2deb9e3befe5ff102ae5c0ebdb2b1ce", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/4910b7ac28a8c489672573696e81ef6c8d54d1b3/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4910b7ac28a8c489672573696e81ef6c8d54d1b3/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=4910b7ac28a8c489672573696e81ef6c8d54d1b3", "patch": "@@ -523,16 +523,23 @@ pub fn get_res_dtor(ccx: @mut CrateContext,\n                     substs: &[ty::t])\n                  -> ValueRef {\n     let _icx = push_ctxt(\"trans_res_dtor\");\n+    let did = if did.crate != ast::LOCAL_CRATE {\n+        inline::maybe_instantiate_inline(ccx, did)\n+    } else {\n+        did\n+    };\n     if !substs.is_empty() {\n-        let did = if did.crate != ast::LOCAL_CRATE {\n-            inline::maybe_instantiate_inline(ccx, did)\n-        } else {\n-            did\n-        };\n         assert_eq!(did.crate, ast::LOCAL_CRATE);\n         let tsubsts = ty::substs {regions: ty::ErasedRegions,\n                                   self_ty: None,\n                                   tps: /*bad*/ substs.to_owned() };\n+\n+        // FIXME: #4252: Generic destructors with type bounds are broken.\n+        //\n+        // Since the vtables aren't passed to `monomorphic_fn` here, generic destructors with type\n+        // bounds are broken. Sadly, the `typeck` pass isn't outputting the necessary metadata\n+        // because it does so based on method calls present in the AST. Destructor calls are not yet\n+        // known about at that stage of compilation, since `trans` handles cleanups.\n         let (val, _) = monomorphize::monomorphic_fn(ccx,\n                                                     did,\n                                                     &tsubsts,"}, {"sha": "1e93cd6359167facd87ff01bb000e91e48fb1f03", "filename": "src/test/auxiliary/inline_dtor.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/4910b7ac28a8c489672573696e81ef6c8d54d1b3/src%2Ftest%2Fauxiliary%2Finline_dtor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4910b7ac28a8c489672573696e81ef6c8d54d1b3/src%2Ftest%2Fauxiliary%2Finline_dtor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Finline_dtor.rs?ref=4910b7ac28a8c489672573696e81ef6c8d54d1b3", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[link(name=\"inline_dtor\", vers=\"0.1\")];\n+\n+pub struct Foo;\n+\n+impl Drop for Foo {\n+    #[inline]\n+    fn drop(&mut self) {}\n+}"}, {"sha": "73b7013742b2bf1e01f3ade399e634f8296b61ce", "filename": "src/test/run-pass/use_inline_dtor.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/4910b7ac28a8c489672573696e81ef6c8d54d1b3/src%2Ftest%2Frun-pass%2Fuse_inline_dtor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4910b7ac28a8c489672573696e81ef6c8d54d1b3/src%2Ftest%2Frun-pass%2Fuse_inline_dtor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fuse_inline_dtor.rs?ref=4910b7ac28a8c489672573696e81ef6c8d54d1b3", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:inline_dtor.rs\n+// xfail-fast\n+\n+extern mod inline_dtor;\n+\n+fn main() {\n+    let _x = inline_dtor::Foo;\n+}"}]}