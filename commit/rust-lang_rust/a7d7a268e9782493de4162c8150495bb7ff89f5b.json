{"sha": "a7d7a268e9782493de4162c8150495bb7ff89f5b", "node_id": "C_kwDOAAsO6NoAKGE3ZDdhMjY4ZTk3ODI0OTNkZTQxNjJjODE1MDQ5NWJiN2ZmODlmNWI", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2022-03-26T23:30:58Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2022-03-26T23:43:29Z"}, "message": "resolve: Simplify some diagnostic code to avoid an ICE", "tree": {"sha": "c10864bf36289a6897a99db6562923ba39ef8eff", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c10864bf36289a6897a99db6562923ba39ef8eff"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a7d7a268e9782493de4162c8150495bb7ff89f5b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a7d7a268e9782493de4162c8150495bb7ff89f5b", "html_url": "https://github.com/rust-lang/rust/commit/a7d7a268e9782493de4162c8150495bb7ff89f5b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a7d7a268e9782493de4162c8150495bb7ff89f5b/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1d9c262eea411ec5230f8a4c9ba50b3647064da4", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d9c262eea411ec5230f8a4c9ba50b3647064da4", "html_url": "https://github.com/rust-lang/rust/commit/1d9c262eea411ec5230f8a4c9ba50b3647064da4"}], "stats": {"total": 47, "additions": 28, "deletions": 19}, "files": [{"sha": "c8ca51348cc7199ffeb60e76d6fd016ae80b32d7", "filename": "compiler/rustc_resolve/src/late/diagnostics.rs", "status": "modified", "additions": 4, "deletions": 17, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/a7d7a268e9782493de4162c8150495bb7ff89f5b/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a7d7a268e9782493de4162c8150495bb7ff89f5b/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs?ref=a7d7a268e9782493de4162c8150495bb7ff89f5b", "patch": "@@ -696,14 +696,7 @@ impl<'a: 'ast, 'ast> LateResolutionVisitor<'a, '_, 'ast> {\n         ) = &bounded_ty.kind\n         {\n             // use this to verify that ident is a type param.\n-            let Ok(Some(partial_res)) = self.resolve_qpath_anywhere(\n-                None,\n-                &Segment::from_path(path),\n-                Namespace::TypeNS,\n-                span,\n-                true,\n-                Finalize::No,\n-            ) else {\n+            let Some(partial_res) = self.r.partial_res_map.get(&bounded_ty.id) else {\n                 return false;\n             };\n             if !(matches!(\n@@ -718,16 +711,10 @@ impl<'a: 'ast, 'ast> LateResolutionVisitor<'a, '_, 'ast> {\n             return false;\n         };\n \n-        if let ast::TyKind::Path(None, type_param_path) = &ty.peel_refs().kind {\n+        let peeled_ty = ty.peel_refs();\n+        if let ast::TyKind::Path(None, type_param_path) = &peeled_ty.kind {\n             // Confirm that the `SelfTy` is a type parameter.\n-            let Ok(Some(partial_res)) = self.resolve_qpath_anywhere(\n-                None,\n-                &Segment::from_path(type_param_path),\n-                Namespace::TypeNS,\n-                span,\n-                true,\n-                Finalize::No,\n-            ) else {\n+            let Some(partial_res) = self.r.partial_res_map.get(&peeled_ty.id) else {\n                 return false;\n             };\n             if !(matches!("}, {"sha": "471a6b836b51e56932d2ae5a56ac3dc8c007c578", "filename": "src/test/ui/traits/associated_type_bound/assoc_type_bound_with_struct.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a7d7a268e9782493de4162c8150495bb7ff89f5b/src%2Ftest%2Fui%2Ftraits%2Fassociated_type_bound%2Fassoc_type_bound_with_struct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a7d7a268e9782493de4162c8150495bb7ff89f5b/src%2Ftest%2Fui%2Ftraits%2Fassociated_type_bound%2Fassoc_type_bound_with_struct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Fassociated_type_bound%2Fassoc_type_bound_with_struct.rs?ref=a7d7a268e9782493de4162c8150495bb7ff89f5b", "patch": "@@ -16,4 +16,8 @@ fn foo<T: Bar>(_: T) where <T as Bar>::Baz: String { //~ ERROR expected trait, f\n fn qux<'a, T: Bar>(_: &'a T) where <&'a T as Bar>::Baz: String { //~ ERROR expected trait, found\n }\n \n+fn issue_95327() where <u8 as Unresolved>::Assoc: String {}\n+//~^ ERROR expected trait, found struct\n+//~| ERROR use of undeclared type `Unresolved`\n+\n fn main() {}"}, {"sha": "9ca446a0a891d82ecb0436977b226f971a18b68d", "filename": "src/test/ui/traits/associated_type_bound/assoc_type_bound_with_struct.stderr", "status": "modified", "additions": 20, "deletions": 2, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/a7d7a268e9782493de4162c8150495bb7ff89f5b/src%2Ftest%2Fui%2Ftraits%2Fassociated_type_bound%2Fassoc_type_bound_with_struct.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a7d7a268e9782493de4162c8150495bb7ff89f5b/src%2Ftest%2Fui%2Ftraits%2Fassociated_type_bound%2Fassoc_type_bound_with_struct.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Fassociated_type_bound%2Fassoc_type_bound_with_struct.stderr?ref=a7d7a268e9782493de4162c8150495bb7ff89f5b", "patch": "@@ -1,3 +1,9 @@\n+error[E0433]: failed to resolve: use of undeclared type `Unresolved`\n+  --> $DIR/assoc_type_bound_with_struct.rs:19:31\n+   |\n+LL | fn issue_95327() where <u8 as Unresolved>::Assoc: String {}\n+   |                               ^^^^^^^^^^ use of undeclared type `Unresolved`\n+\n error[E0404]: expected trait, found struct `String`\n   --> $DIR/assoc_type_bound_with_struct.rs:5:46\n    |\n@@ -78,6 +84,18 @@ help: a trait with a similar name exists\n LL | fn qux<'a, T: Bar>(_: &'a T) where <&'a T as Bar>::Baz: ToString {\n    |                                                         ~~~~~~~~\n \n-error: aborting due to 4 previous errors\n+error[E0404]: expected trait, found struct `String`\n+  --> $DIR/assoc_type_bound_with_struct.rs:19:51\n+   |\n+LL | fn issue_95327() where <u8 as Unresolved>::Assoc: String {}\n+   |                                                   ^^^^^^ help: a trait with a similar name exists: `ToString`\n+   |\n+  ::: $SRC_DIR/alloc/src/string.rs:LL:COL\n+   |\n+LL | pub trait ToString {\n+   | ------------------ similarly named trait `ToString` defined here\n+\n+error: aborting due to 6 previous errors\n \n-For more information about this error, try `rustc --explain E0404`.\n+Some errors have detailed explanations: E0404, E0433.\n+For more information about an error, try `rustc --explain E0404`."}]}