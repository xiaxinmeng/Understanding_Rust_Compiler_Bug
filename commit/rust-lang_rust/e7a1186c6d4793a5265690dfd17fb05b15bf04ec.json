{"sha": "e7a1186c6d4793a5265690dfd17fb05b15bf04ec", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU3YTExODZjNmQ0NzkzYTUyNjU2OTBkZmQxN2ZiMDViMTViZjA0ZWM=", "commit": {"author": {"name": "Fabian Wolff", "email": "fabian.wolff@alumni.ethz.ch", "date": "2021-06-18T19:39:53Z"}, "committer": {"name": "Fabian Wolff", "email": "fabian.wolff@alumni.ethz.ch", "date": "2021-06-18T19:39:53Z"}, "message": "Fix ICE with `#[repr(simd)]` on enum", "tree": {"sha": "96c328b4131cad792cee6b88f16684a6a22912b5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/96c328b4131cad792cee6b88f16684a6a22912b5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e7a1186c6d4793a5265690dfd17fb05b15bf04ec", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e7a1186c6d4793a5265690dfd17fb05b15bf04ec", "html_url": "https://github.com/rust-lang/rust/commit/e7a1186c6d4793a5265690dfd17fb05b15bf04ec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e7a1186c6d4793a5265690dfd17fb05b15bf04ec/comments", "author": {"login": "FabianWolff", "id": 16052130, "node_id": "MDQ6VXNlcjE2MDUyMTMw", "avatar_url": "https://avatars.githubusercontent.com/u/16052130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/FabianWolff", "html_url": "https://github.com/FabianWolff", "followers_url": "https://api.github.com/users/FabianWolff/followers", "following_url": "https://api.github.com/users/FabianWolff/following{/other_user}", "gists_url": "https://api.github.com/users/FabianWolff/gists{/gist_id}", "starred_url": "https://api.github.com/users/FabianWolff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/FabianWolff/subscriptions", "organizations_url": "https://api.github.com/users/FabianWolff/orgs", "repos_url": "https://api.github.com/users/FabianWolff/repos", "events_url": "https://api.github.com/users/FabianWolff/events{/privacy}", "received_events_url": "https://api.github.com/users/FabianWolff/received_events", "type": "User", "site_admin": false}, "committer": {"login": "FabianWolff", "id": 16052130, "node_id": "MDQ6VXNlcjE2MDUyMTMw", "avatar_url": "https://avatars.githubusercontent.com/u/16052130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/FabianWolff", "html_url": "https://github.com/FabianWolff", "followers_url": "https://api.github.com/users/FabianWolff/followers", "following_url": "https://api.github.com/users/FabianWolff/following{/other_user}", "gists_url": "https://api.github.com/users/FabianWolff/gists{/gist_id}", "starred_url": "https://api.github.com/users/FabianWolff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/FabianWolff/subscriptions", "organizations_url": "https://api.github.com/users/FabianWolff/orgs", "repos_url": "https://api.github.com/users/FabianWolff/repos", "events_url": "https://api.github.com/users/FabianWolff/events{/privacy}", "received_events_url": "https://api.github.com/users/FabianWolff/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "312b894cc12240a3fcc645474c3daa14f7d568ea", "url": "https://api.github.com/repos/rust-lang/rust/commits/312b894cc12240a3fcc645474c3daa14f7d568ea", "html_url": "https://github.com/rust-lang/rust/commit/312b894cc12240a3fcc645474c3daa14f7d568ea"}], "stats": {"total": 49, "additions": 49, "deletions": 0}, "files": [{"sha": "6b1ec1b0646aec1354d6ade066bd2539fae58b32", "filename": "compiler/rustc_middle/src/ty/layout.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e7a1186c6d4793a5265690dfd17fb05b15bf04ec/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e7a1186c6d4793a5265690dfd17fb05b15bf04ec/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs?ref=e7a1186c6d4793a5265690dfd17fb05b15bf04ec", "patch": "@@ -672,6 +672,15 @@ impl<'tcx> LayoutCx<'tcx, TyCtxt<'tcx>> {\n \n             // SIMD vector types.\n             ty::Adt(def, substs) if def.repr.simd() => {\n+                if !def.is_struct() {\n+                    // Should have yielded E0517 by now.\n+                    tcx.sess.delay_span_bug(\n+                        DUMMY_SP,\n+                        \"#[repr(simd)] was applied to an ADT that is not a struct\",\n+                    );\n+                    return Err(LayoutError::Unknown(ty));\n+                }\n+\n                 // Supported SIMD vectors are homogeneous ADTs with at least one field:\n                 //\n                 // * #[repr(simd)] struct S(T, T, T, T);"}, {"sha": "280b771d0153925fe3f0cc394af6c72a7eec8468", "filename": "src/test/ui/repr/issue-83505-repr-simd.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e7a1186c6d4793a5265690dfd17fb05b15bf04ec/src%2Ftest%2Fui%2Frepr%2Fissue-83505-repr-simd.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e7a1186c6d4793a5265690dfd17fb05b15bf04ec/src%2Ftest%2Fui%2Frepr%2Fissue-83505-repr-simd.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frepr%2Fissue-83505-repr-simd.rs?ref=e7a1186c6d4793a5265690dfd17fb05b15bf04ec", "patch": "@@ -0,0 +1,10 @@\n+// Regression test for the ICE described in #83505.\n+\n+#![crate_type=\"lib\"]\n+\n+#[repr(simd)]\n+//~^ ERROR: attribute should be applied to a struct [E0517]\n+//~| ERROR: unsupported representation for zero-variant enum [E0084]\n+enum Es {}\n+static CLs: Es;\n+//~^ ERROR: free static item without body"}, {"sha": "f1390a652016b2e1b4a8048c1ee612f6949215cb", "filename": "src/test/ui/repr/issue-83505-repr-simd.stderr", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/e7a1186c6d4793a5265690dfd17fb05b15bf04ec/src%2Ftest%2Fui%2Frepr%2Fissue-83505-repr-simd.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e7a1186c6d4793a5265690dfd17fb05b15bf04ec/src%2Ftest%2Fui%2Frepr%2Fissue-83505-repr-simd.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frepr%2Fissue-83505-repr-simd.stderr?ref=e7a1186c6d4793a5265690dfd17fb05b15bf04ec", "patch": "@@ -0,0 +1,30 @@\n+error: free static item without body\n+  --> $DIR/issue-83505-repr-simd.rs:9:1\n+   |\n+LL | static CLs: Es;\n+   | ^^^^^^^^^^^^^^-\n+   |               |\n+   |               help: provide a definition for the static: `= <expr>;`\n+\n+error[E0517]: attribute should be applied to a struct\n+  --> $DIR/issue-83505-repr-simd.rs:5:8\n+   |\n+LL | #[repr(simd)]\n+   |        ^^^^\n+...\n+LL | enum Es {}\n+   | ---------- not a struct\n+\n+error[E0084]: unsupported representation for zero-variant enum\n+  --> $DIR/issue-83505-repr-simd.rs:5:1\n+   |\n+LL | #[repr(simd)]\n+   | ^^^^^^^^^^^^^\n+...\n+LL | enum Es {}\n+   | ---------- zero-variant enum\n+\n+error: aborting due to 3 previous errors\n+\n+Some errors have detailed explanations: E0084, E0517.\n+For more information about an error, try `rustc --explain E0084`."}]}