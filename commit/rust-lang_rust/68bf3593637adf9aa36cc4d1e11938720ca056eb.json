{"sha": "68bf3593637adf9aa36cc4d1e11938720ca056eb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY4YmYzNTkzNjM3YWRmOWFhMzZjYzRkMWUxMTkzODcyMGNhMDU2ZWI=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-09-01T12:51:37Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-09-01T12:51:37Z"}, "message": "fix: make `goto_implementation` multi-token mapping aware", "tree": {"sha": "ddd92487059a011de3d8c650bed2290f5238d5ec", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ddd92487059a011de3d8c650bed2290f5238d5ec"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/68bf3593637adf9aa36cc4d1e11938720ca056eb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/68bf3593637adf9aa36cc4d1e11938720ca056eb", "html_url": "https://github.com/rust-lang/rust/commit/68bf3593637adf9aa36cc4d1e11938720ca056eb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/68bf3593637adf9aa36cc4d1e11938720ca056eb/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "25368d24308d6a94ffe8b99f0122bcf5a2175322", "url": "https://api.github.com/repos/rust-lang/rust/commits/25368d24308d6a94ffe8b99f0122bcf5a2175322", "html_url": "https://github.com/rust-lang/rust/commit/25368d24308d6a94ffe8b99f0122bcf5a2175322"}], "stats": {"total": 115, "additions": 67, "deletions": 48}, "files": [{"sha": "e5b882612750977c9467d0a426c436f1909736fc", "filename": "crates/ide/src/goto_implementation.rs", "status": "modified", "additions": 66, "deletions": 45, "changes": 111, "blob_url": "https://github.com/rust-lang/rust/blob/68bf3593637adf9aa36cc4d1e11938720ca056eb/crates%2Fide%2Fsrc%2Fgoto_implementation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68bf3593637adf9aa36cc4d1e11938720ca056eb/crates%2Fide%2Fsrc%2Fgoto_implementation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fgoto_implementation.rs?ref=68bf3593637adf9aa36cc4d1e11938720ca056eb", "patch": "@@ -1,9 +1,11 @@\n use hir::{AsAssocItem, Impl, Semantics};\n use ide_db::{\n     defs::{Definition, NameClass, NameRefClass},\n+    helpers::pick_best_token,\n     RootDatabase,\n };\n-use syntax::{ast, AstNode};\n+use itertools::Itertools;\n+use syntax::{ast, AstNode, SyntaxKind::*, T};\n \n use crate::{display::TryToNav, FilePosition, NavigationTarget, RangeInfo};\n \n@@ -26,52 +28,71 @@ pub(crate) fn goto_implementation(\n     let source_file = sema.parse(position.file_id);\n     let syntax = source_file.syntax().clone();\n \n-    let node = sema.find_node_at_offset_with_descend(&syntax, position.offset)?;\n-    let def = match &node {\n-        ast::NameLike::Name(name) => NameClass::classify(&sema, name).map(|class| match class {\n-            NameClass::Definition(it) | NameClass::ConstReference(it) => it,\n-            NameClass::PatFieldShorthand { local_def, field_ref: _ } => {\n-                Definition::Local(local_def)\n-            }\n-        }),\n-        ast::NameLike::NameRef(name_ref) => {\n-            NameRefClass::classify(&sema, name_ref).map(|class| match class {\n-                NameRefClass::Definition(def) => def,\n-                NameRefClass::FieldShorthand { local_ref, field_ref: _ } => {\n-                    Definition::Local(local_ref)\n+    let original_token =\n+        pick_best_token(syntax.token_at_offset(position.offset), |kind| match kind {\n+            IDENT | T![self] => 1,\n+            _ => 0,\n+        })?;\n+    let range = original_token.text_range();\n+    let navs =\n+        sema.descend_into_macros_many(original_token)\n+            .into_iter()\n+            .filter_map(|token| token.parent().and_then(ast::NameLike::cast))\n+            .filter_map(|node| {\n+                let def = match &node {\n+                    ast::NameLike::Name(name) => {\n+                        NameClass::classify(&sema, name).map(|class| match class {\n+                            NameClass::Definition(it) | NameClass::ConstReference(it) => it,\n+                            NameClass::PatFieldShorthand { local_def, field_ref: _ } => {\n+                                Definition::Local(local_def)\n+                            }\n+                        })\n+                    }\n+                    ast::NameLike::NameRef(name_ref) => NameRefClass::classify(&sema, name_ref)\n+                        .map(|class| match class {\n+                            NameRefClass::Definition(def) => def,\n+                            NameRefClass::FieldShorthand { local_ref, field_ref: _ } => {\n+                                Definition::Local(local_ref)\n+                            }\n+                        }),\n+                    ast::NameLike::Lifetime(_) => None,\n+                }?;\n+\n+                match def {\n+                    Definition::ModuleDef(def) => Some(def),\n+                    _ => None,\n                 }\n             })\n-        }\n-        ast::NameLike::Lifetime(_) => None,\n-    }?;\n-\n-    let def = match def {\n-        Definition::ModuleDef(def) => def,\n-        _ => return None,\n-    };\n-    let navs = match def {\n-        hir::ModuleDef::Trait(trait_) => impls_for_trait(&sema, trait_),\n-        hir::ModuleDef::Adt(adt) => impls_for_ty(&sema, adt.ty(sema.db)),\n-        hir::ModuleDef::TypeAlias(alias) => impls_for_ty(&sema, alias.ty(sema.db)),\n-        hir::ModuleDef::BuiltinType(builtin) => {\n-            let module = sema.to_module_def(position.file_id)?;\n-            impls_for_ty(&sema, builtin.ty(sema.db, module))\n-        }\n-        hir::ModuleDef::Function(f) => {\n-            let assoc = f.as_assoc_item(sema.db)?;\n-            let name = assoc.name(sema.db)?;\n-            let trait_ = assoc.containing_trait_or_trait_impl(sema.db)?;\n-            impls_for_trait_item(&sema, trait_, name)\n-        }\n-        hir::ModuleDef::Const(c) => {\n-            let assoc = c.as_assoc_item(sema.db)?;\n-            let name = assoc.name(sema.db)?;\n-            let trait_ = assoc.containing_trait_or_trait_impl(sema.db)?;\n-            impls_for_trait_item(&sema, trait_, name)\n-        }\n-        _ => return None,\n-    };\n-    Some(RangeInfo { range: node.syntax().text_range(), info: navs })\n+            .unique()\n+            .filter_map(|def| {\n+                let navs = match def {\n+                    hir::ModuleDef::Trait(trait_) => impls_for_trait(&sema, trait_),\n+                    hir::ModuleDef::Adt(adt) => impls_for_ty(&sema, adt.ty(sema.db)),\n+                    hir::ModuleDef::TypeAlias(alias) => impls_for_ty(&sema, alias.ty(sema.db)),\n+                    hir::ModuleDef::BuiltinType(builtin) => {\n+                        let module = sema.to_module_def(position.file_id)?;\n+                        impls_for_ty(&sema, builtin.ty(sema.db, module))\n+                    }\n+                    hir::ModuleDef::Function(f) => {\n+                        let assoc = f.as_assoc_item(sema.db)?;\n+                        let name = assoc.name(sema.db)?;\n+                        let trait_ = assoc.containing_trait_or_trait_impl(sema.db)?;\n+                        impls_for_trait_item(&sema, trait_, name)\n+                    }\n+                    hir::ModuleDef::Const(c) => {\n+                        let assoc = c.as_assoc_item(sema.db)?;\n+                        let name = assoc.name(sema.db)?;\n+                        let trait_ = assoc.containing_trait_or_trait_impl(sema.db)?;\n+                        impls_for_trait_item(&sema, trait_, name)\n+                    }\n+                    _ => return None,\n+                };\n+                Some(navs)\n+            })\n+            .flatten()\n+            .collect();\n+\n+    Some(RangeInfo { range, info: navs })\n }\n \n fn impls_for_ty(sema: &Semantics<RootDatabase>, ty: hir::Type) -> Vec<NavigationTarget> {"}, {"sha": "c288c5c3e0816c54689358e8596688ff5f98e312", "filename": "crates/ide_db/src/search.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/68bf3593637adf9aa36cc4d1e11938720ca056eb/crates%2Fide_db%2Fsrc%2Fsearch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68bf3593637adf9aa36cc4d1e11938720ca056eb/crates%2Fide_db%2Fsrc%2Fsearch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fsearch.rs?ref=68bf3593637adf9aa36cc4d1e11938720ca056eb", "patch": "@@ -442,9 +442,7 @@ impl<'a> FindUsages<'a> {\n                         continue;\n                     }\n \n-                    if let Some(ast::NameLike::NameRef(name_ref)) =\n-                        sema.find_node_at_offset_with_descend(&tree, offset)\n-                    {\n+                    for name_ref in sema.find_nodes_at_offset_with_descend(&tree, offset) {\n                         if self.found_self_module_name_ref(&name_ref, sink) {\n                             return;\n                         }"}]}