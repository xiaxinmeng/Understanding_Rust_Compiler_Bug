{"sha": "7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc5NzFhNDdlZmY0YjE3OGZmZTdjMzhjNjdiMTkyNmRhY2VhNGMwZGQ=", "commit": {"author": {"name": "Cameron Hart", "email": "cameron.hart@gmail.com", "date": "2017-03-25T08:00:49Z"}, "committer": {"name": "Cameron Hart", "email": "cameron.hart@gmail.com", "date": "2017-04-20T21:37:10Z"}, "message": "Added feature gate, updated error messages and tests.", "tree": {"sha": "e13abfbdef80aa9a36dd5f58dc0d12f2985cedfb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e13abfbdef80aa9a36dd5f58dc0d12f2985cedfb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "html_url": "https://github.com/rust-lang/rust/commit/7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/comments", "author": {"login": "bitshifter", "id": 135700, "node_id": "MDQ6VXNlcjEzNTcwMA==", "avatar_url": "https://avatars.githubusercontent.com/u/135700?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bitshifter", "html_url": "https://github.com/bitshifter", "followers_url": "https://api.github.com/users/bitshifter/followers", "following_url": "https://api.github.com/users/bitshifter/following{/other_user}", "gists_url": "https://api.github.com/users/bitshifter/gists{/gist_id}", "starred_url": "https://api.github.com/users/bitshifter/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bitshifter/subscriptions", "organizations_url": "https://api.github.com/users/bitshifter/orgs", "repos_url": "https://api.github.com/users/bitshifter/repos", "events_url": "https://api.github.com/users/bitshifter/events{/privacy}", "received_events_url": "https://api.github.com/users/bitshifter/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bitshifter", "id": 135700, "node_id": "MDQ6VXNlcjEzNTcwMA==", "avatar_url": "https://avatars.githubusercontent.com/u/135700?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bitshifter", "html_url": "https://github.com/bitshifter", "followers_url": "https://api.github.com/users/bitshifter/followers", "following_url": "https://api.github.com/users/bitshifter/following{/other_user}", "gists_url": "https://api.github.com/users/bitshifter/gists{/gist_id}", "starred_url": "https://api.github.com/users/bitshifter/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bitshifter/subscriptions", "organizations_url": "https://api.github.com/users/bitshifter/orgs", "repos_url": "https://api.github.com/users/bitshifter/repos", "events_url": "https://api.github.com/users/bitshifter/events{/privacy}", "received_events_url": "https://api.github.com/users/bitshifter/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4358e35fda66ab7a00215c7f9d50e7c6dc9b801b", "url": "https://api.github.com/repos/rust-lang/rust/commits/4358e35fda66ab7a00215c7f9d50e7c6dc9b801b", "html_url": "https://github.com/rust-lang/rust/commit/4358e35fda66ab7a00215c7f9d50e7c6dc9b801b"}], "stats": {"total": 61, "additions": 53, "deletions": 8}, "files": [{"sha": "ee4e568a5ca9af263cd3fc50537d3cd18b652a1b", "filename": "src/doc/unstable-book/src/SUMMARY.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md", "raw_url": "https://github.com/rust-lang/rust/raw/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md?ref=7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "patch": "@@ -72,6 +72,7 @@\n     - [proc_macro](language-features/proc-macro.md)\n     - [quote](language-features/quote.md)\n     - [relaxed_adts](language-features/relaxed-adts.md)\n+    - [repr_align](language-features/repr-align.md)\n     - [repr_simd](language-features/repr-simd.md)\n     - [rustc_attrs](language-features/rustc-attrs.md)\n     - [rustc_diagnostic_macros](language-features/rustc-diagnostic-macros.md)"}, {"sha": "deea04f4c51cc7525328b0844034bebe1e603430", "filename": "src/doc/unstable-book/src/language-features/repr-align.md", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Frepr-align.md", "raw_url": "https://github.com/rust-lang/rust/raw/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Frepr-align.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Frepr-align.md?ref=7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "patch": "@@ -0,0 +1,11 @@\n+# `repr_align`\n+\n+The tracking issue for this feature is: [#33626]\n+\n+[#33626]: https://github.com/rust-lang/rust/issues/33626\n+\n+------------------------\n+\n+\n+\n+"}, {"sha": "82492d976276e05d6ed6d758872c48acc17405ee", "filename": "src/libsyntax/attr.rs", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Flibsyntax%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Flibsyntax%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fattr.rs?ref=7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "patch": "@@ -972,19 +972,24 @@ pub fn find_repr_attrs(diagnostic: &Handler, attr: &Attribute) -> Vec<ReprAttr>\n                 } else if let Some((name, value)) = item.name_value_literal() {\n                     if name == \"align\" {\n                         recognised = true;\n-                        let mut valid_align = false;\n+                        let mut align_error = None;\n                         if let ast::LitKind::Int(align, ast::LitIntType::Unsuffixed) = value.node {\n                             if align.is_power_of_two() {\n                                 // rustc::ty::layout::Align restricts align to <= 32768\n                                 if align <= 32768 {\n                                     acc.push(ReprAlign(align as u16));\n-                                    valid_align = true;\n+                                } else {\n+                                    align_error = Some(\"larger than 32768\");\n                                 }\n+                            } else {\n+                                align_error = Some(\"not a power of two\");\n                             }\n+                        } else {\n+                            align_error = Some(\"not an unsuffixed integer\");\n                         }\n-                        if !valid_align {\n+                        if let Some(align_error) = align_error {\n                             span_err!(diagnostic, item.span, E0589,\n-                                      \"align representation must be a u16 power of two\");\n+                                      \"invalid `repr(align)` attribute: {}\", align_error);\n                         }\n                     }\n                 }"}, {"sha": "01d1277ea6265014c018401a8854033db84931fa", "filename": "src/libsyntax/diagnostic_list.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Flibsyntax%2Fdiagnostic_list.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Flibsyntax%2Fdiagnostic_list.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fdiagnostic_list.rs?ref=7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "patch": "@@ -292,5 +292,5 @@ register_diagnostics! {\n     E0556, // malformed feature, expected just one word\n     E0557, // feature has been removed\n     E0584, // file for module `..` found at both .. and ..\n-    E0589, // align representation must be a u16 power of two\n+    E0589, // invalid `repr(align)` attribute\n }"}, {"sha": "9b55a860b3595a0e4edd1bfb5e837d22f71ee7fd", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "patch": "@@ -338,6 +338,9 @@ declare_features! (\n     // Allows the `catch {...}` expression\n     (active, catch_expr, \"1.17.0\", Some(31436)),\n \n+    // Allows `repr(align(u16))` struct attribute (RFC 1358)\n+    (active, repr_align, \"1.17.0\", Some(33626)),\n+\n     // See rust-lang/rfcs#1414. Allows code like `let x: &'static u32 = &42` to work.\n     (active, rvalue_static_promotion, \"1.15.1\", Some(38865)),\n \n@@ -1189,6 +1192,11 @@ impl<'a> Visitor<'a> for PostExpansionVisitor<'a> {\n                                                     and possibly buggy\");\n \n                             }\n+                            if item.check_name(\"align\") {\n+                                gate_feature_post!(&self, repr_align, i.span,\n+                                                   \"the struct `#[repr(align(u16))]` attribute \\\n+                                                    is experimental\");\n+                            }\n                         }\n                     }\n                 }"}, {"sha": "01fa3ffbaa6ae7a82a9f9644ccba0209b4ee4f77", "filename": "src/test/compile-fail/conflicting-repr-hints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Ftest%2Fcompile-fail%2Fconflicting-repr-hints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Ftest%2Fcompile-fail%2Fconflicting-repr-hints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fconflicting-repr-hints.rs?ref=7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "patch": "@@ -10,6 +10,7 @@\n \n #![allow(dead_code)]\n #![feature(attr_literals)]\n+#![feature(repr_align)]\n \n #[repr(C)]\n enum A { A }"}, {"sha": "8e986e197f2694d9113949cac7046f6117c5d880", "filename": "src/test/compile-fail/feature-gate-repr_align.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Ftest%2Fcompile-fail%2Ffeature-gate-repr_align.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Ftest%2Fcompile-fail%2Ffeature-gate-repr_align.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Ffeature-gate-repr_align.rs?ref=7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "patch": "@@ -0,0 +1,15 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+#![feature(attr_literals)]\n+\n+#[repr(align(64))]\n+struct Foo(u64, u64); //~ error: the struct `#[repr(align(u16))]` attribute is experimental\n+\n+fn main() {}"}, {"sha": "eb0b27fe9c07ed5307a658e87da2fda19cc630bb", "filename": "src/test/compile-fail/repr-align.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Ftest%2Fcompile-fail%2Frepr-align.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Ftest%2Fcompile-fail%2Frepr-align.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Frepr-align.rs?ref=7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "patch": "@@ -9,14 +9,15 @@\n // except according to those terms.\n #![allow(dead_code)]\n #![feature(attr_literals)]\n+#![feature(repr_align)]\n \n-#[repr(align(16.0))] //~ ERROR: align representation must be a u16 power of two\n+#[repr(align(16.0))] //~ ERROR: invalid `repr(align)` attribute: not an unsuffixed integer\n struct A(i32);\n \n-#[repr(align(15))] //~ ERROR: align representation must be a u16 power of two\n+#[repr(align(15))] //~ ERROR: invalid `repr(align)` attribute: not a power of two\n struct B(i32);\n \n-#[repr(align(65536))] //~ ERROR: align representation must be a u16 power of tw\n+#[repr(align(65536))] //~ ERROR: invalid `repr(align)` attribute: larger than 32768\n struct C(i32);\n \n fn main() {}"}, {"sha": "c584dcf3e5993eacd8eeeb083f53d5a88d2386c4", "filename": "src/test/compile-fail/repr-packed-contains-align.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Ftest%2Fcompile-fail%2Frepr-packed-contains-align.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Ftest%2Fcompile-fail%2Frepr-packed-contains-align.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Frepr-packed-contains-align.rs?ref=7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "patch": "@@ -8,6 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n #![feature(attr_literals)]\n+#![feature(repr_align)]\n #![allow(dead_code)]\n \n #[repr(align(16))]"}, {"sha": "0b9a3594502b00bc0dcbaa04f9672a6a0e6ecffb", "filename": "src/test/run-pass/align-struct.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Ftest%2Frun-pass%2Falign-struct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Ftest%2Frun-pass%2Falign-struct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Falign-struct.rs?ref=7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "patch": "@@ -8,6 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n #![feature(attr_literals)]\n+#![feature(repr_align)]\n \n use std::mem;\n "}, {"sha": "e9b43145de469706b199292371e4fa0be7542ede", "filename": "src/test/ui/print_type_sizes/repr-align.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Ftest%2Fui%2Fprint_type_sizes%2Frepr-align.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7971a47eff4b178ffe7c38c67b1926dacea4c0dd/src%2Ftest%2Fui%2Fprint_type_sizes%2Frepr-align.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Frepr-align.rs?ref=7971a47eff4b178ffe7c38c67b1926dacea4c0dd", "patch": "@@ -18,6 +18,7 @@\n // aligned (while on most it is 8-byte aligned) and so the resulting\n // padding and overall computed sizes can be quite different.\n #![feature(attr_literals)]\n+#![feature(repr_align)]\n #![allow(dead_code)]\n \n #[repr(align(16))]"}]}