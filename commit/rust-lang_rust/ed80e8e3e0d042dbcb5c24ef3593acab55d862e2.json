{"sha": "ed80e8e3e0d042dbcb5c24ef3593acab55d862e2", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVkODBlOGUzZTBkMDQyZGJjYjVjMjRlZjM1OTNhY2FiNTVkODYyZTI=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-05-29T18:21:22Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-05-29T18:21:22Z"}, "message": "Rollup merge of #72591 - sexxi-goose:rename_upvar_list-to-closure_captures, r=matthewjasper\n\nlibrustc_middle: Rename upvar_list to closure_captures\n\nAs part of supporting RFC 2229, we will be capturing all the places that\nare mentioned in a closure. Currently the `upvar_list` field gives access to a `FxIndexMap<HirId, Upvar>` map. Eventually this will change, with the `upvar_list` having a more general structure that expresses captured paths, not just the mentioned `upvars`. We will make those changes in subsequent PRs.\n\nThis commit modifies the name of the `upvar_list` map to `closure_captures` in `TypeckTables`.\n\nr? @matthewjasper", "tree": {"sha": "2475c33ad1ea62c5d77862ba466ac05d27e8e9d6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2475c33ad1ea62c5d77862ba466ac05d27e8e9d6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe0VKiCRBK7hj4Ov3rIwAAdHIIAFz2/FfER3Lyxb3172U6LLLX\nZq3+bwBN/yNRE50UN/uA/sipd5eOonNXXQ89pQpToFdJABW8DGOubvr2ZfIvzP2n\nQtL0X44+ooJ0DONaTrjljnn8gASrAeo9Sm4n1V0AGKkSf301ni80hT18rjzQywox\nHNwJPPavPZCsR5ScWLEJRJEXaSui9RhyWZnJU3M/AtYGxouUIcrlyMXIQVMCCQn7\nRfnJy6k0YCPc9J4GtAmC1uL9eM9wYkYiztY5uJhPlI630MeNZ+bPxCSPUuVZG990\n7ajNlKWDfXXiVVVbPFGZCchbu3EDZefXhV16oNl8gk0ji6lbu8Y6kTxiQL4QfT0=\n=KZ+a\n-----END PGP SIGNATURE-----\n", "payload": "tree 2475c33ad1ea62c5d77862ba466ac05d27e8e9d6\nparent 89cb4d75a104d772e8f40e43eabb0122e71eacb1\nparent c3dc8c455cee65db8928913da029725046c14a1b\nauthor Dylan DPC <dylan.dpc@gmail.com> 1590776482 +0200\ncommitter GitHub <noreply@github.com> 1590776482 +0200\n\nRollup merge of #72591 - sexxi-goose:rename_upvar_list-to-closure_captures, r=matthewjasper\n\nlibrustc_middle: Rename upvar_list to closure_captures\n\nAs part of supporting RFC 2229, we will be capturing all the places that\nare mentioned in a closure. Currently the `upvar_list` field gives access to a `FxIndexMap<HirId, Upvar>` map. Eventually this will change, with the `upvar_list` having a more general structure that expresses captured paths, not just the mentioned `upvars`. We will make those changes in subsequent PRs.\n\nThis commit modifies the name of the `upvar_list` map to `closure_captures` in `TypeckTables`.\n\nr? @matthewjasper\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2", "html_url": "https://github.com/rust-lang/rust/commit/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "89cb4d75a104d772e8f40e43eabb0122e71eacb1", "url": "https://api.github.com/repos/rust-lang/rust/commits/89cb4d75a104d772e8f40e43eabb0122e71eacb1", "html_url": "https://github.com/rust-lang/rust/commit/89cb4d75a104d772e8f40e43eabb0122e71eacb1"}, {"sha": "c3dc8c455cee65db8928913da029725046c14a1b", "url": "https://api.github.com/repos/rust-lang/rust/commits/c3dc8c455cee65db8928913da029725046c14a1b", "html_url": "https://github.com/rust-lang/rust/commit/c3dc8c455cee65db8928913da029725046c14a1b"}], "stats": {"total": 30, "additions": 15, "deletions": 15}, "files": [{"sha": "0298f3d8442a6c37fd3fad2f387ced1b21b8b831", "filename": "src/librustc_middle/ty/context.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_middle%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_middle%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fcontext.rs?ref=ed80e8e3e0d042dbcb5c24ef3593acab55d862e2", "patch": "@@ -419,7 +419,7 @@ pub struct TypeckTables<'tcx> {\n     /// The upvarID contains the HIR node ID and it also contains the full path\n     /// leading to the member of the struct or tuple that is used instead of the\n     /// entire variable.\n-    pub upvar_list: ty::UpvarListMap,\n+    pub closure_captures: ty::UpvarListMap,\n \n     /// Stores the type, expression, span and optional scope span of all types\n     /// that are live across the yield of this generator (if a generator).\n@@ -447,7 +447,7 @@ impl<'tcx> TypeckTables<'tcx> {\n             used_trait_imports: Lrc::new(Default::default()),\n             tainted_by_errors: None,\n             concrete_opaque_types: Default::default(),\n-            upvar_list: Default::default(),\n+            closure_captures: Default::default(),\n             generator_interior_types: Default::default(),\n         }\n     }\n@@ -688,7 +688,7 @@ impl<'a, 'tcx> HashStable<StableHashingContext<'a>> for TypeckTables<'tcx> {\n             ref used_trait_imports,\n             tainted_by_errors,\n             ref concrete_opaque_types,\n-            ref upvar_list,\n+            ref closure_captures,\n             ref generator_interior_types,\n         } = *self;\n \n@@ -721,7 +721,7 @@ impl<'a, 'tcx> HashStable<StableHashingContext<'a>> for TypeckTables<'tcx> {\n             used_trait_imports.hash_stable(hcx, hasher);\n             tainted_by_errors.hash_stable(hcx, hasher);\n             concrete_opaque_types.hash_stable(hcx, hasher);\n-            upvar_list.hash_stable(hcx, hasher);\n+            closure_captures.hash_stable(hcx, hasher);\n             generator_interior_types.hash_stable(hcx, hasher);\n         })\n     }"}, {"sha": "65e62dbd9dd492420e1a8c0dc8a691422faa8518", "filename": "src/librustc_mir/borrow_check/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs?ref=ed80e8e3e0d042dbcb5c24ef3593acab55d862e2", "patch": "@@ -142,7 +142,7 @@ fn do_mir_borrowck<'a, 'tcx>(\n         infcx.set_tainted_by_errors();\n     }\n     let upvars: Vec<_> = tables\n-        .upvar_list\n+        .closure_captures\n         .get(&def_id.to_def_id())\n         .into_iter()\n         .flat_map(|v| v.values())"}, {"sha": "e962dfb2b3e86735db858db51e93e8f2056028ba", "filename": "src/librustc_mir/interpret/validity.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_mir%2Finterpret%2Fvalidity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_mir%2Finterpret%2Fvalidity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fvalidity.rs?ref=ed80e8e3e0d042dbcb5c24ef3593acab55d862e2", "patch": "@@ -227,7 +227,7 @@ impl<'rt, 'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> ValidityVisitor<'rt, 'mir, '\n                 let mut name = None;\n                 if let Some(def_id) = def_id.as_local() {\n                     let tables = self.ecx.tcx.typeck_tables_of(def_id);\n-                    if let Some(upvars) = tables.upvar_list.get(&def_id.to_def_id()) {\n+                    if let Some(upvars) = tables.closure_captures.get(&def_id.to_def_id()) {\n                         // Sometimes the index is beyond the number of upvars (seen\n                         // for a generator).\n                         if let Some((&var_hir_id, _)) = upvars.get_index(field) {"}, {"sha": "3d821aa55a1f87fc0d51d3a0e3c5fa377904acf3", "filename": "src/librustc_mir_build/build/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_mir_build%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_mir_build%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir_build%2Fbuild%2Fmod.rs?ref=ed80e8e3e0d042dbcb5c24ef3593acab55d862e2", "patch": "@@ -790,11 +790,11 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         let hir_tables = self.hir.tables();\n \n         // In analyze_closure() in upvar.rs we gathered a list of upvars used by a\n-        // closure and we stored in a map called upvar_list in TypeckTables indexed\n+        // indexed closure and we stored in a map called closure_captures in TypeckTables\n         // with the closure's DefId. Here, we run through that vec of UpvarIds for\n         // the given closure and use the necessary information to create upvar\n         // debuginfo and to fill `self.upvar_mutbls`.\n-        if let Some(upvars) = hir_tables.upvar_list.get(&fn_def_id) {\n+        if let Some(upvars) = hir_tables.closure_captures.get(&fn_def_id) {\n             let closure_env_arg = Local::new(1);\n             let mut closure_env_projs = vec![];\n             let mut closure_ty = self.local_decls[closure_env_arg].ty;"}, {"sha": "fd3c48b38badbf3786fd58db4dfa95241899d94e", "filename": "src/librustc_mir_build/hair/cx/expr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_mir_build%2Fhair%2Fcx%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_mir_build%2Fhair%2Fcx%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir_build%2Fhair%2Fcx%2Fexpr.rs?ref=ed80e8e3e0d042dbcb5c24ef3593acab55d862e2", "patch": "@@ -884,7 +884,7 @@ fn convert_var<'tcx>(\n ) -> ExprKind<'tcx> {\n     let upvar_index = cx\n         .tables()\n-        .upvar_list\n+        .closure_captures\n         .get(&cx.body_owner)\n         .and_then(|upvars| upvars.get_full(&var_hir_id).map(|(i, _, _)| i));\n "}, {"sha": "19a23e5a594788b52a8c5e02a98fa74ce1233623", "filename": "src/librustc_typeck/check/upvar.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_typeck%2Fcheck%2Fupvar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_typeck%2Fcheck%2Fupvar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fupvar.rs?ref=ed80e8e3e0d042dbcb5c24ef3593acab55d862e2", "patch": "@@ -112,7 +112,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         };\n \n         if let Some(upvars) = self.tcx.upvars_mentioned(closure_def_id) {\n-            let mut upvar_list: FxIndexMap<hir::HirId, ty::UpvarId> =\n+            let mut closure_captures: FxIndexMap<hir::HirId, ty::UpvarId> =\n                 FxIndexMap::with_capacity_and_hasher(upvars.len(), Default::default());\n             for (&var_hir_id, _) in upvars.iter() {\n                 let upvar_id = ty::UpvarId {\n@@ -122,7 +122,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 debug!(\"seed upvar_id {:?}\", upvar_id);\n                 // Adding the upvar Id to the list of Upvars, which will be added\n                 // to the map for the closure at the end of the for loop.\n-                upvar_list.insert(var_hir_id, upvar_id);\n+                closure_captures.insert(var_hir_id, upvar_id);\n \n                 let capture_kind = match capture_clause {\n                     hir::CaptureBy::Value => ty::UpvarCapture::ByValue,\n@@ -140,8 +140,8 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             // Add the vector of upvars to the map keyed with the closure id.\n             // This gives us an easier access to them without having to call\n             // tcx.upvars again..\n-            if !upvar_list.is_empty() {\n-                self.tables.borrow_mut().upvar_list.insert(closure_def_id, upvar_list);\n+            if !closure_captures.is_empty() {\n+                self.tables.borrow_mut().closure_captures.insert(closure_def_id, closure_captures);\n             }\n         }\n "}, {"sha": "3473dc7a58d0469e5c50751b5dde57999cf0c7dc", "filename": "src/librustc_typeck/check/writeback.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_typeck%2Fcheck%2Fwriteback.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed80e8e3e0d042dbcb5c24ef3593acab55d862e2/src%2Flibrustc_typeck%2Fcheck%2Fwriteback.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fwriteback.rs?ref=ed80e8e3e0d042dbcb5c24ef3593acab55d862e2", "patch": "@@ -74,8 +74,8 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         debug!(\"used_trait_imports({:?}) = {:?}\", item_def_id, used_trait_imports);\n         wbcx.tables.used_trait_imports = used_trait_imports;\n \n-        wbcx.tables.upvar_list =\n-            mem::replace(&mut self.tables.borrow_mut().upvar_list, Default::default());\n+        wbcx.tables.closure_captures =\n+            mem::replace(&mut self.tables.borrow_mut().closure_captures, Default::default());\n \n         if self.is_tainted_by_errors() {\n             // FIXME(eddyb) keep track of `ErrorReported` from where the error was emitted."}]}