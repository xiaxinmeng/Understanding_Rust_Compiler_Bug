{"sha": "972079c0e32ba6085eb5ba02a137a6df86b79b5a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk3MjA3OWMwZTMyYmE2MDg1ZWI1YmEwMmExMzdhNmRmODZiNzliNWE=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-10-08T11:39:44Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-10-08T11:39:44Z"}, "message": "macro DSL for cfg in tests", "tree": {"sha": "574449a7582de5b06c257a72d645b7d489562f22", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/574449a7582de5b06c257a72d645b7d489562f22"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/972079c0e32ba6085eb5ba02a137a6df86b79b5a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/972079c0e32ba6085eb5ba02a137a6df86b79b5a", "html_url": "https://github.com/rust-lang/rust/commit/972079c0e32ba6085eb5ba02a137a6df86b79b5a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/972079c0e32ba6085eb5ba02a137a6df86b79b5a/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "355419d4044704d13a902641d86ad5501af8714d", "url": "https://api.github.com/repos/rust-lang/rust/commits/355419d4044704d13a902641d86ad5501af8714d", "html_url": "https://github.com/rust-lang/rust/commit/355419d4044704d13a902641d86ad5501af8714d"}], "stats": {"total": 39, "additions": 23, "deletions": 16}, "files": [{"sha": "827424983560f6cd876eb55a1183ac92409e894f", "filename": "crates/ra_hir/src/mock.rs", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/972079c0e32ba6085eb5ba02a137a6df86b79b5a/crates%2Fra_hir%2Fsrc%2Fmock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/972079c0e32ba6085eb5ba02a137a6df86b79b5a/crates%2Fra_hir%2Fsrc%2Fmock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fmock.rs?ref=972079c0e32ba6085eb5ba02a137a6df86b79b5a", "patch": "@@ -278,15 +278,30 @@ macro_rules! crate_graph {\n             $crate_path:literal,\n             $($edition:literal,)?\n             [$($dep:literal),*]\n-            $(,$cfg:expr)?\n+            $(, cfg = {\n+                $($key:literal $(= $value:literal)?),*\n+                $(,)?\n+            })?\n         ),\n     )*) => {{\n         let mut res = $crate::mock::CrateGraphFixture::default();\n         $(\n             #[allow(unused_mut, unused_assignments)]\n             let mut edition = ra_db::Edition::Edition2018;\n             $(edition = ra_db::Edition::from_string($edition);)?\n-            let cfg_options = { ::ra_cfg::CfgOptions::default() $(; $cfg)? };\n+            let cfg_options = {\n+                #[allow(unused_mut)]\n+                let mut cfg = ::ra_cfg::CfgOptions::default();\n+                $(\n+                    $(\n+                        if 0 == 0 $(+ { drop($value); 1})? {\n+                            cfg.insert_atom($key.into());\n+                        }\n+                        $(cfg.insert_key_value($key.into(), $value.into());)?\n+                    )*\n+                )?\n+                cfg\n+            };\n             res.0.push((\n                 $crate_name.to_string(),\n                 ($crate_path.to_string(), edition, cfg_options, vec![$($dep.to_string()),*])"}, {"sha": "8c6b40aaf2a0dfbbec6afa3382d664958d058442", "filename": "crates/ra_hir/src/nameres/tests.rs", "status": "modified", "additions": 5, "deletions": 8, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/972079c0e32ba6085eb5ba02a137a6df86b79b5a/crates%2Fra_hir%2Fsrc%2Fnameres%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/972079c0e32ba6085eb5ba02a137a6df86b79b5a/crates%2Fra_hir%2Fsrc%2Fnameres%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fnameres%2Ftests.rs?ref=972079c0e32ba6085eb5ba02a137a6df86b79b5a", "patch": "@@ -7,7 +7,6 @@ mod mod_resolution;\n use std::sync::Arc;\n \n use insta::assert_snapshot;\n-use ra_cfg::CfgOptions;\n use ra_db::SourceDatabase;\n use test_utils::covers;\n \n@@ -561,13 +560,11 @@ fn cfg_test() {\n         \"#,\n         crate_graph! {\n             \"main\": (\"/main.rs\", [\"std\"]),\n-            \"std\": (\"/lib.rs\", [], {\n-                let mut opts = CfgOptions::default();\n-                opts.insert_atom(\"test\".into());\n-                opts.insert_key_value(\"feature\".into(), \"foo\".into());\n-                opts.insert_key_value(\"feature\".into(), \"bar\".into());\n-                opts.insert_key_value(\"opt\".into(), \"42\".into());\n-                opts\n+            \"std\": (\"/lib.rs\", [], cfg = {\n+                \"test\",\n+                \"feature\" = \"foo\",\n+                \"feature\" = \"bar\",\n+                \"opt\" = \"42\",\n             }),\n         },\n     );"}, {"sha": "263b61a59cd08cddb00d5bfb93469ce138afb024", "filename": "crates/ra_hir/src/ty/tests.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/972079c0e32ba6085eb5ba02a137a6df86b79b5a/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/972079c0e32ba6085eb5ba02a137a6df86b79b5a/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs?ref=972079c0e32ba6085eb5ba02a137a6df86b79b5a", "patch": "@@ -3,7 +3,6 @@ use std::sync::Arc;\n \n use insta::assert_snapshot;\n \n-use ra_cfg::CfgOptions;\n use ra_db::{salsa::Database, FilePosition, SourceDatabase};\n use ra_syntax::{\n     algo,\n@@ -62,11 +61,7 @@ impl S {\n \"#,\n     );\n     db.set_crate_graph_from_fixture(crate_graph! {\n-        \"main\": (\"/main.rs\", [\"foo\"], {\n-            let mut opts = CfgOptions::default();\n-            opts.insert_atom(\"test\".into());\n-            opts\n-        }),\n+        \"main\": (\"/main.rs\", [\"foo\"], cfg = { \"test\" }),\n         \"foo\": (\"/foo.rs\", []),\n     });\n     assert_eq!(\"(i32, {unknown}, i32, {unknown})\", type_at_pos(&db, pos));"}]}