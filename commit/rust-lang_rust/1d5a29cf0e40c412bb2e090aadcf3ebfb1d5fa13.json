{"sha": "1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFkNWEyOWNmMGU0MGM0MTJiYjJlMDkwYWFkY2YzZWJmYjFkNWZhMTM=", "commit": {"author": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2016-04-17T22:30:55Z"}, "committer": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2016-04-19T22:14:16Z"}, "message": "debugging, misc fixes", "tree": {"sha": "2829e35dea8626a1eb6c98a6b74ed129905f157a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2829e35dea8626a1eb6c98a6b74ed129905f157a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "html_url": "https://github.com/rust-lang/rust/commit/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "744be0b5aac8c06c60dabac3a7802a8117c946b2", "url": "https://api.github.com/repos/rust-lang/rust/commits/744be0b5aac8c06c60dabac3a7802a8117c946b2", "html_url": "https://github.com/rust-lang/rust/commit/744be0b5aac8c06c60dabac3a7802a8117c946b2"}], "stats": {"total": 422, "additions": 260, "deletions": 162}, "files": [{"sha": "0a01cc91f0e30a05443633004f589f76fde33b63", "filename": "src/librustc/hir/lowering.rs", "status": "modified", "additions": 148, "deletions": 70, "changes": 218, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc%2Fhir%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc%2Fhir%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Flowering.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -62,6 +62,9 @@\n // in the HIR, especially for multiple identifiers.\n \n use hir;\n+use hir::map::Definitions;\n+use hir::map::definitions::DefPathData;\n+use hir::def_id::DefIndex;\n \n use std::collections::BTreeMap;\n use std::collections::HashMap;\n@@ -92,10 +95,20 @@ pub struct LoweringContext<'a> {\n     // A copy of cached_id, but is also set to an id while a node is lowered for\n     // the first time.\n     gensym_key: Cell<u32>,\n+    // We must keep the set of definitions up to date as we add nodes that\n+    // weren't in the AST.\n+    definitions: Option<&'a RefCell<Definitions>>,\n+    // As we walk the AST we must keep track of the current 'parent' def id (in\n+    // the form of a DefIndex) so that if we create a new node which introduces\n+    // a definition, then we can properly create the def id.\n+    parent_def: Cell<Option<DefIndex>>,\n }\n \n impl<'a, 'hir> LoweringContext<'a> {\n-    pub fn new(id_assigner: &'a NodeIdAssigner, c: Option<&Crate>) -> LoweringContext<'a> {\n+    pub fn new(id_assigner: &'a NodeIdAssigner,\n+               c: Option<&Crate>,\n+               defs: &'a RefCell<Definitions>)\n+               -> LoweringContext<'a> {\n         let crate_root = c.and_then(|c| {\n             if std_inject::no_core(c) {\n                 None\n@@ -113,6 +126,23 @@ impl<'a, 'hir> LoweringContext<'a> {\n             cached_id: Cell::new(0),\n             gensym_cache: RefCell::new(HashMap::new()),\n             gensym_key: Cell::new(0),\n+            definitions: Some(defs),\n+            parent_def: Cell::new(None),\n+        }\n+    }\n+\n+    // Only use this when you want a LoweringContext for testing and won't look\n+    // up def ids for anything created during lowering.\n+    pub fn testing_context(id_assigner: &'a NodeIdAssigner) -> LoweringContext<'a> {\n+        LoweringContext {\n+            crate_root: None,\n+            id_cache: RefCell::new(HashMap::new()),\n+            id_assigner: id_assigner,\n+            cached_id: Cell::new(0),\n+            gensym_cache: RefCell::new(HashMap::new()),\n+            gensym_key: Cell::new(0),\n+            definitions: None,\n+            parent_def: Cell::new(None),\n         }\n     }\n \n@@ -146,6 +176,25 @@ impl<'a, 'hir> LoweringContext<'a> {\n     fn diagnostic(&self) -> &Handler {\n         self.id_assigner.diagnostic()\n     }\n+\n+    fn with_parent_def<T, F: FnOnce() -> T>(&self, parent_id: NodeId, f: F) -> T {\n+        if self.definitions.is_none() {\n+            // This should only be used for testing.\n+            return f();\n+        }\n+\n+        let old_def = self.parent_def.get();\n+        self.parent_def.set(Some(self.get_def(parent_id)));\n+        let result = f();\n+        self.parent_def.set(old_def);\n+\n+        result\n+    }\n+\n+    fn get_def(&self, id: NodeId) -> DefIndex {\n+        let defs = self.definitions.unwrap().borrow();\n+        defs.opt_def_index(id).unwrap()\n+    }\n }\n \n // Utility fn for setting and unsetting the cached id.\n@@ -733,47 +782,51 @@ pub fn lower_item_kind(lctx: &LoweringContext, i: &ItemKind) -> hir::Item_ {\n }\n \n pub fn lower_trait_item(lctx: &LoweringContext, i: &TraitItem) -> hir::TraitItem {\n-    hir::TraitItem {\n-        id: i.id,\n-        name: i.ident.name,\n-        attrs: lower_attrs(lctx, &i.attrs),\n-        node: match i.node {\n-            TraitItemKind::Const(ref ty, ref default) => {\n-                hir::ConstTraitItem(lower_ty(lctx, ty),\n-                                    default.as_ref().map(|x| lower_expr(lctx, x)))\n-            }\n-            TraitItemKind::Method(ref sig, ref body) => {\n-                hir::MethodTraitItem(lower_method_sig(lctx, sig),\n-                                     body.as_ref().map(|x| lower_block(lctx, x)))\n-            }\n-            TraitItemKind::Type(ref bounds, ref default) => {\n-                hir::TypeTraitItem(lower_bounds(lctx, bounds),\n-                                   default.as_ref().map(|x| lower_ty(lctx, x)))\n-            }\n-        },\n-        span: i.span,\n-    }\n+    lctx.with_parent_def(i.id, || {\n+        hir::TraitItem {\n+            id: i.id,\n+            name: i.ident.name,\n+            attrs: lower_attrs(lctx, &i.attrs),\n+            node: match i.node {\n+                TraitItemKind::Const(ref ty, ref default) => {\n+                    hir::ConstTraitItem(lower_ty(lctx, ty),\n+                                        default.as_ref().map(|x| lower_expr(lctx, x)))\n+                }\n+                TraitItemKind::Method(ref sig, ref body) => {\n+                    hir::MethodTraitItem(lower_method_sig(lctx, sig),\n+                                         body.as_ref().map(|x| lower_block(lctx, x)))\n+                }\n+                TraitItemKind::Type(ref bounds, ref default) => {\n+                    hir::TypeTraitItem(lower_bounds(lctx, bounds),\n+                                       default.as_ref().map(|x| lower_ty(lctx, x)))\n+                }\n+            },\n+            span: i.span,\n+        }\n+    })\n }\n \n pub fn lower_impl_item(lctx: &LoweringContext, i: &ImplItem) -> hir::ImplItem {\n-    hir::ImplItem {\n-        id: i.id,\n-        name: i.ident.name,\n-        attrs: lower_attrs(lctx, &i.attrs),\n-        vis: lower_visibility(lctx, &i.vis),\n-        defaultness: lower_defaultness(lctx, i.defaultness),\n-        node: match i.node {\n-            ImplItemKind::Const(ref ty, ref expr) => {\n-                hir::ImplItemKind::Const(lower_ty(lctx, ty), lower_expr(lctx, expr))\n-            }\n-            ImplItemKind::Method(ref sig, ref body) => {\n-                hir::ImplItemKind::Method(lower_method_sig(lctx, sig), lower_block(lctx, body))\n-            }\n-            ImplItemKind::Type(ref ty) => hir::ImplItemKind::Type(lower_ty(lctx, ty)),\n-            ImplItemKind::Macro(..) => panic!(\"Shouldn't exist any more\"),\n-        },\n-        span: i.span,\n-    }\n+    lctx.with_parent_def(i.id, || {\n+        hir::ImplItem {\n+            id: i.id,\n+            name: i.ident.name,\n+            attrs: lower_attrs(lctx, &i.attrs),\n+            vis: lower_visibility(lctx, &i.vis),\n+            defaultness: lower_defaultness(lctx, i.defaultness),\n+            node: match i.node {\n+                ImplItemKind::Const(ref ty, ref expr) => {\n+                    hir::ImplItemKind::Const(lower_ty(lctx, ty), lower_expr(lctx, expr))\n+                }\n+                ImplItemKind::Method(ref sig, ref body) => {\n+                    hir::ImplItemKind::Method(lower_method_sig(lctx, sig), lower_block(lctx, body))\n+                }\n+                ImplItemKind::Type(ref ty) => hir::ImplItemKind::Type(lower_ty(lctx, ty)),\n+                ImplItemKind::Macro(..) => panic!(\"Shouldn't exist any more\"),\n+            },\n+            span: i.span,\n+        }\n+    })\n }\n \n pub fn lower_mod(lctx: &LoweringContext, m: &Mod) -> hir::Mod {\n@@ -831,7 +884,9 @@ pub fn lower_item_id(_lctx: &LoweringContext, i: &Item) -> hir::ItemId {\n }\n \n pub fn lower_item(lctx: &LoweringContext, i: &Item) -> hir::Item {\n-    let node = lower_item_kind(lctx, &i.node);\n+    let node = lctx.with_parent_def(i.id, || {\n+        lower_item_kind(lctx, &i.node)\n+    });\n \n     hir::Item {\n         id: i.id,\n@@ -844,21 +899,23 @@ pub fn lower_item(lctx: &LoweringContext, i: &Item) -> hir::Item {\n }\n \n pub fn lower_foreign_item(lctx: &LoweringContext, i: &ForeignItem) -> hir::ForeignItem {\n-    hir::ForeignItem {\n-        id: i.id,\n-        name: i.ident.name,\n-        attrs: lower_attrs(lctx, &i.attrs),\n-        node: match i.node {\n-            ForeignItemKind::Fn(ref fdec, ref generics) => {\n-                hir::ForeignItemFn(lower_fn_decl(lctx, fdec), lower_generics(lctx, generics))\n-            }\n-            ForeignItemKind::Static(ref t, m) => {\n-                hir::ForeignItemStatic(lower_ty(lctx, t), m)\n-            }\n-        },\n-        vis: lower_visibility(lctx, &i.vis),\n-        span: i.span,\n-    }\n+    lctx.with_parent_def(i.id, || {\n+        hir::ForeignItem {\n+            id: i.id,\n+            name: i.ident.name,\n+            attrs: lower_attrs(lctx, &i.attrs),\n+            node: match i.node {\n+                ForeignItemKind::Fn(ref fdec, ref generics) => {\n+                    hir::ForeignItemFn(lower_fn_decl(lctx, fdec), lower_generics(lctx, generics))\n+                }\n+                ForeignItemKind::Static(ref t, m) => {\n+                    hir::ForeignItemStatic(lower_ty(lctx, t), m)\n+                }\n+            },\n+            vis: lower_visibility(lctx, &i.vis),\n+            span: i.span,\n+        }\n+    })\n }\n \n pub fn lower_method_sig(lctx: &LoweringContext, sig: &MethodSig) -> hir::MethodSig {\n@@ -926,9 +983,11 @@ pub fn lower_pat(lctx: &LoweringContext, p: &Pat) -> P<hir::Pat> {\n         node: match p.node {\n             PatKind::Wild => hir::PatKind::Wild,\n             PatKind::Ident(ref binding_mode, pth1, ref sub) => {\n-                hir::PatKind::Ident(lower_binding_mode(lctx, binding_mode),\n-                              respan(pth1.span, lower_ident(lctx, pth1.node)),\n-                              sub.as_ref().map(|x| lower_pat(lctx, x)))\n+                lctx.with_parent_def(p.id, || {\n+                    hir::PatKind::Ident(lower_binding_mode(lctx, binding_mode),\n+                                  respan(pth1.span, lower_ident(lctx, pth1.node)),\n+                                  sub.as_ref().map(|x| lower_pat(lctx, x)))\n+                })\n             }\n             PatKind::Lit(ref e) => hir::PatKind::Lit(lower_expr(lctx, e)),\n             PatKind::TupleStruct(ref pth, ref pats) => {\n@@ -1202,9 +1261,11 @@ pub fn lower_expr(lctx: &LoweringContext, e: &Expr) -> P<hir::Expr> {\n                                hir::MatchSource::Normal)\n             }\n             ExprKind::Closure(capture_clause, ref decl, ref body) => {\n-                hir::ExprClosure(lower_capture_clause(lctx, capture_clause),\n-                                 lower_fn_decl(lctx, decl),\n-                                 lower_block(lctx, body))\n+                lctx.with_parent_def(e.id, || {\n+                    hir::ExprClosure(lower_capture_clause(lctx, capture_clause),\n+                                     lower_fn_decl(lctx, decl),\n+                                     lower_block(lctx, body))\n+                })\n             }\n             ExprKind::Block(ref blk) => hir::ExprBlock(lower_block(lctx, blk)),\n             ExprKind::Assign(ref el, ref er) => {\n@@ -1602,7 +1663,12 @@ pub fn lower_expr(lctx: &LoweringContext, e: &Expr) -> P<hir::Expr> {\n                     // `{ let _result = ...; _result }`\n                     // underscore prevents an unused_variables lint if the head diverges\n                     let result_ident = lctx.str_to_ident(\"_result\");\n-                    let let_stmt = stmt_let(lctx, e.span, false, result_ident, match_expr, None);\n+                    let let_stmt = stmt_let(lctx,\n+                                            e.span,\n+                                            false,\n+                                            result_ident,\n+                                            match_expr,\n+                                            None);\n                     let result = expr_ident(lctx, e.span, result_ident, None);\n                     let block = block_all(lctx, e.span, hir_vec![let_stmt], Some(result));\n                     // add the attributes to the outer returned expr node\n@@ -1655,7 +1721,8 @@ pub fn lower_expr(lctx: &LoweringContext, e: &Expr) -> P<hir::Expr> {\n                             let err_ctor = expr_path(lctx, path, None);\n                             expr_call(lctx, e.span, err_ctor, hir_vec![from_expr], None)\n                         };\n-                        let err_pat = pat_err(lctx, e.span, pat_ident(lctx, e.span, err_ident));\n+                        let err_pat = pat_err(lctx, e.span,\n+                                              pat_ident(lctx, e.span, err_ident));\n                         let ret_expr = expr(lctx, e.span,\n                                             hir::Expr_::ExprRet(Some(err_expr)), None);\n \n@@ -1938,12 +2005,22 @@ fn pat_ident_binding_mode(lctx: &LoweringContext,\n                           bm: hir::BindingMode)\n                           -> P<hir::Pat> {\n     let pat_ident = hir::PatKind::Ident(bm,\n-                                  Spanned {\n-                                      span: span,\n-                                      node: ident,\n-                                  },\n-                                  None);\n-    pat(lctx, span, pat_ident)\n+                                        Spanned {\n+                                            span: span,\n+                                            node: ident,\n+                                        },\n+                                        None);\n+\n+    let pat = pat(lctx, span, pat_ident);\n+\n+    if let Some(defs) = lctx.definitions {\n+        let mut defs = defs.borrow_mut();\n+        defs.create_def_with_parent(lctx.parent_def.get(),\n+                                    pat.id,\n+                                    DefPathData::Binding(ident.name));\n+    }\n+\n+    pat\n }\n \n fn pat_wild(lctx: &LoweringContext, span: Span) -> P<hir::Pat> {\n@@ -2130,7 +2207,8 @@ mod test {\n         let ast_in = quote_expr!(&cx, in HEAP { foo() });\n         let ast_in = assigner.fold_expr(ast_in);\n \n-        let lctx = LoweringContext::new(&assigner, None);\n+        let lctx = LoweringContext::testing_context(&assigner);\n+\n         let hir1 = lower_expr(&lctx, &ast_if_let);\n         let hir2 = lower_expr(&lctx, &ast_if_let);\n         assert!(hir1 == hir2);"}, {"sha": "9f55f46541cfde4c007f99fb587ad0173e1cc42e", "filename": "src/librustc/hir/map/collector.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc%2Fhir%2Fmap%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc%2Fhir%2Fmap%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmap%2Fcollector.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -162,7 +162,12 @@ impl<'ast> Visitor<'ast> for NodeCollector<'ast> {\n     }\n \n     fn visit_pat(&mut self, pat: &'ast Pat) {\n-        self.insert(pat.id, NodeLocal(pat));\n+        let node = if let PatKind::Ident(..) = pat.node {\n+            NodeLocal(pat)\n+        } else {\n+            NodePat(pat)\n+        };\n+        self.insert(pat.id, node);\n \n         self.with_parent(pat.id, |this| {\n             intravisit::walk_pat(this, pat);"}, {"sha": "b2456f4ab8714bfdac7c987a0750f74c7f79677c", "filename": "src/librustc/hir/map/def_collector.rs", "status": "modified", "additions": 20, "deletions": 26, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc%2Fhir%2Fmap%2Fdef_collector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc%2Fhir%2Fmap%2Fdef_collector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmap%2Fdef_collector.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -18,6 +18,7 @@ use middle::cstore::InlinedItem;\n \n use syntax::ast::*;\n use syntax::visit;\n+use syntax::parse::token;\n \n /// Creates def ids for nodes in the HIR.\n pub struct DefCollector<'ast> {\n@@ -35,8 +36,9 @@ impl<'ast> DefCollector<'ast> {\n             definitions: Definitions::new(),\n             parent_def: None,\n         };\n-        let result = collector.create_def_with_parent(None, CRATE_NODE_ID, DefPathData::CrateRoot);\n-        assert_eq!(result, CRATE_DEF_INDEX);\n+        let root = collector.create_def_with_parent(None, CRATE_NODE_ID, DefPathData::CrateRoot);\n+        assert_eq!(root, CRATE_DEF_INDEX);\n+        collector.parent_def = Some(root);\n \n         collector.create_def_with_parent(Some(CRATE_DEF_INDEX), DUMMY_NODE_ID, DefPathData::Misc);\n \n@@ -125,12 +127,12 @@ impl<'ast> visit::Visitor<'ast> for DefCollector<'ast> {\n                             this.create_def(v.node.data.id(),\n                                             DefPathData::EnumVariant(v.node.name.name));\n \n-                        for field in v.node.data.fields() {\n-                            if let Some(ident) = field.ident {\n-                                this.create_def_with_parent(Some(variant_def_index),\n-                                                            field.id,\n-                                                            DefPathData::Field(ident.name));\n-                            }\n+                        for (index, field) in v.node.data.fields().iter().enumerate() {\n+                            let name = field.ident.map(|ident| ident.name)\n+                                .unwrap_or(token::intern(&index.to_string()));\n+                            this.create_def_with_parent(Some(variant_def_index),\n+                                                        field.id,\n+                                                        DefPathData::Field(name));\n                         }\n                     }\n                 }\n@@ -141,10 +143,10 @@ impl<'ast> visit::Visitor<'ast> for DefCollector<'ast> {\n                                         DefPathData::StructCtor);\n                     }\n \n-                    for field in struct_def.fields() {\n-                        if let Some(ident) = field.ident {\n-                            this.create_def(field.id, DefPathData::Field(ident.name));\n-                        }\n+                    for (index, field) in struct_def.fields().iter().enumerate() {\n+                        let name = field.ident.map(|ident| ident.name)\n+                            .unwrap_or(token::intern(&index.to_string()));\n+                        this.create_def(field.id, DefPathData::Field(name));\n                     }\n                 }\n                 _ => {}\n@@ -205,14 +207,10 @@ impl<'ast> visit::Visitor<'ast> for DefCollector<'ast> {\n     }\n \n     fn visit_pat(&mut self, pat: &'ast Pat) {\n-        let maybe_binding = match pat.node {\n-            PatKind::Ident(_, id, _) => Some(id.node),\n-            _ => None\n-        };\n-\n         let parent_def = self.parent_def;\n-        if let Some(id) = maybe_binding {\n-            let def = self.create_def(pat.id, DefPathData::Binding(id.name));\n+\n+        if let PatKind::Ident(_, id, _) = pat.node {\n+            let def = self.create_def(pat.id, DefPathData::Binding(id.node.name));\n             self.parent_def = Some(def);\n         }\n \n@@ -353,14 +351,10 @@ impl<'ast> intravisit::Visitor<'ast> for DefCollector<'ast> {\n     }\n \n     fn visit_pat(&mut self, pat: &'ast hir::Pat) {\n-        let maybe_binding = match pat.node {\n-            hir::PatKind::Ident(_, id, _) => Some(id.node),\n-            _ => None\n-        };\n-\n         let parent_def = self.parent_def;\n-        if let Some(id) = maybe_binding {\n-            let def = self.create_def(pat.id, DefPathData::Binding(id.name));\n+\n+        if let hir::PatKind::Ident(_, id, _) = pat.node {\n+            let def = self.create_def(pat.id, DefPathData::Binding(id.node.name));\n             self.parent_def = Some(def);\n         }\n "}, {"sha": "92f8c9249c842937e45b55585d16faf9489aed80", "filename": "src/librustc/hir/map/mod.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -196,7 +196,7 @@ pub struct Map<'ast> {\n     /// plain old integers.\n     map: RefCell<Vec<MapEntry<'ast>>>,\n \n-    definitions: RefCell<Definitions>,\n+    definitions: &'ast RefCell<Definitions>,\n }\n \n impl<'ast> Map<'ast> {\n@@ -789,7 +789,9 @@ pub fn collect_definitions<'ast>(krate: &'ast ast::Crate) -> Definitions {\n     def_collector.definitions\n }\n \n-pub fn map_crate<'ast>(forest: &'ast mut Forest, definitions: Definitions) -> Map<'ast> {\n+pub fn map_crate<'ast>(forest: &'ast mut Forest,\n+                       definitions: &'ast RefCell<Definitions>)\n+                       -> Map<'ast> {\n     let mut collector = NodeCollector::root(&forest.krate);\n     intravisit::walk_crate(&mut collector, &forest.krate);\n     let map = collector.map;\n@@ -814,7 +816,7 @@ pub fn map_crate<'ast>(forest: &'ast mut Forest, definitions: Definitions) -> Ma\n         forest: forest,\n         dep_graph: forest.dep_graph.clone(),\n         map: RefCell::new(map),\n-        definitions: RefCell::new(definitions),\n+        definitions: definitions,\n     }\n }\n "}, {"sha": "26422e3194a2219ba525f7f980ebb60fb13e5e56", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -43,6 +43,7 @@ use super::Compilation;\n \n use serialize::json;\n \n+use std::cell::RefCell;\n use std::collections::HashMap;\n use std::env;\n use std::ffi::{OsString, OsStr};\n@@ -123,17 +124,17 @@ pub fn compile_input(sess: &Session,\n         let dep_graph = DepGraph::new(sess.opts.build_dep_graph);\n \n         // Collect defintions for def ids.\n-        let defs = time(sess.time_passes(),\n-                        \"collecting defs\",\n-                        || hir_map::collect_definitions(&expanded_crate));\n+        let defs = &RefCell::new(time(sess.time_passes(),\n+                                 \"collecting defs\",\n+                                 || hir_map::collect_definitions(&expanded_crate)));\n \n         time(sess.time_passes(),\n              \"external crate/lib resolution\",\n              || LocalCrateReader::new(sess, &cstore, &defs, &expanded_crate, &id)\n                     .read_crates(&dep_graph));\n \n         // Lower ast -> hir.\n-        let lcx = LoweringContext::new(sess, Some(&expanded_crate));\n+        let lcx = LoweringContext::new(sess, Some(&expanded_crate), defs);\n         let hir_forest = &mut time(sess.time_passes(),\n                                    \"lowering ast -> hir\",\n                                    || hir_map::Forest::new(lower_crate(&lcx, &expanded_crate),"}, {"sha": "0e100f48ac38d64488defa10f3e3d7775c0e49ff", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 3, "deletions": 8, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -199,14 +199,9 @@ pub fn run_compiler<'a>(args: &[String],\n     // It is somewhat unfortunate that this is hardwired in - this is forced by\n     // the fact that pretty_print_input requires the session by value.\n     let pretty = callbacks.parse_pretty(&sess, &matches);\n-    match pretty {\n-        Some((ppm, opt_uii)) => {\n-            pretty::pretty_print_input(sess, &cstore, cfg, &input, ppm, opt_uii, ofile);\n-            return (Ok(()), None);\n-        }\n-        None => {\n-            // continue\n-        }\n+    if let Some((ppm, opt_uii)) = pretty {\n+        pretty::pretty_print_input(sess, &cstore, cfg, &input, ppm, opt_uii, ofile);\n+        return (Ok(()), None);\n     }\n \n     let plugins = sess.opts.debugging_opts.extra_plugins.clone();"}, {"sha": "b1143fd3e845463339783d224442c3b191d1c6b0", "filename": "src/librustc_driver/pretty.rs", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_driver%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_driver%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fpretty.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -29,6 +29,7 @@ use rustc_borrowck as borrowck;\n use rustc_borrowck::graphviz as borrowck_dot;\n use rustc_resolve as resolve;\n use rustc_metadata::cstore::CStore;\n+use rustc_metadata::creader::LocalCrateReader;\n \n use rustc_mir::pretty::write_mir_pretty;\n use rustc_mir::graphviz::write_mir_graphviz;\n@@ -43,6 +44,7 @@ use syntax::util::small_vector::SmallVector;\n \n use graphviz as dot;\n \n+use std::cell::RefCell;\n use std::fs::File;\n use std::io::{self, Write};\n use std::iter;\n@@ -719,7 +721,7 @@ pub fn pretty_print_input(sess: Session,\n     let is_expanded = needs_expansion(&ppm);\n     let compute_ast_map = needs_ast_map(&ppm, &opt_uii);\n     let krate = if compute_ast_map {\n-        match driver::phase_2_configure_and_expand(&sess, &cstore, krate, &id[..], None) {\n+        match driver::phase_2_configure_and_expand(&sess, &cstore, krate, &id, None) {\n             Err(_) => return,\n             Ok(k) => driver::assign_node_ids(&sess, k),\n         }\n@@ -730,15 +732,18 @@ pub fn pretty_print_input(sess: Session,\n     // There is some twisted, god-forsaken tangle of lifetimes here which makes\n     // the ordering of stuff super-finicky.\n     let mut hir_forest;\n-    let lcx = LoweringContext::new(&sess, Some(&krate));\n-    let arenas = ty::CtxtArenas::new();\n+    let mut _defs = None;\n     let dep_graph = DepGraph::new(false);\n+    let arenas = ty::CtxtArenas::new();\n     let _ignore = dep_graph.in_ignore();\n     let ast_map = if compute_ast_map {\n-        let defs = hir_map::collect_definitions(&krate);\n+        _defs = Some(RefCell::new(hir_map::collect_definitions(&krate)));\n+        let defs = _defs.as_ref().unwrap();\n+        LocalCrateReader::new(&sess, &cstore, defs, &krate, &id).read_crates(&dep_graph);\n+        let lcx = LoweringContext::new(&sess, Some(&krate), defs);\n+\n         hir_forest = hir_map::Forest::new(lower_crate(&lcx, &krate), dep_graph.clone());\n-        let map = hir_map::map_crate(&mut hir_forest, defs);\n-        Some(map)\n+        Some(hir_map::map_crate(&mut hir_forest, defs))\n     } else {\n         None\n     };\n@@ -751,7 +756,7 @@ pub fn pretty_print_input(sess: Session,\n                   .unwrap()\n                   .as_bytes()\n                   .to_vec();\n-    let mut rdr = &src[..];\n+    let mut rdr = &*src;\n \n     let mut out = Vec::new();\n "}, {"sha": "ce92dd158c969e4b33a80b05125f25fe471f2518", "filename": "src/librustc_driver/test.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_driver%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_driver%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Ftest.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -27,8 +27,10 @@ use rustc::ty::{self, Ty, TyCtxt, TypeFoldable};\n use rustc::ty::relate::TypeRelation;\n use rustc::infer::{self, InferOk, InferResult, TypeOrigin};\n use rustc_metadata::cstore::CStore;\n+use rustc_metadata::creader::LocalCrateReader;\n use rustc::hir::map as hir_map;\n use rustc::session::{self, config};\n+use std::cell::RefCell;\n use std::rc::Rc;\n use syntax::ast;\n use syntax::abi::Abi;\n@@ -119,13 +121,15 @@ fn test_env<F>(source_string: &str,\n     let krate = driver::phase_2_configure_and_expand(&sess, &cstore, krate, \"test\", None)\n                     .expect(\"phase 2 aborted\");\n \n-    let krate = driver::assign_node_ids(&sess, krate);\n-    let lcx = LoweringContext::new(&sess, Some(&krate));\n     let dep_graph = DepGraph::new(false);\n+    let krate = driver::assign_node_ids(&sess, krate);\n+    let defs = &RefCell::new(hir_map::collect_definitions(&krate));\n+    LocalCrateReader::new(&sess, &cstore, defs, &krate, \"test_crate\").read_crates(&dep_graph);\n+    let lcx = LoweringContext::new(&sess, Some(&krate), defs);\n     let _ignore = dep_graph.in_ignore();\n-    let mut hir_forest = hir_map::Forest::new(lower_crate(&lcx, &krate), dep_graph.clone());\n+    let mut hir_forest = &mut hir_map::Forest::new(lower_crate(&lcx, &krate), dep_graph.clone());\n     let arenas = ty::CtxtArenas::new();\n-    let ast_map = driver::make_map(&sess, &mut hir_forest);\n+    let ast_map = hir_map::map_crate(hir_forest, defs);\n \n     // run just enough stuff to build a tcx:\n     let lang_items = lang_items::collect_language_items(&sess, &ast_map);"}, {"sha": "2d6a043e34aeb88fb280fb58bfdf03039d2f04d0", "filename": "src/librustc_metadata/astencode.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_metadata%2Fastencode.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_metadata%2Fastencode.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fastencode.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -1339,7 +1339,7 @@ fn roundtrip(in_item: hir::Item) {\n fn test_basic() {\n     let cx = mk_ctxt();\n     let fnia = FakeNodeIdAssigner;\n-    let lcx = LoweringContext::new(&fnia, None);\n+    let lcx = LoweringContext::testing_context(&fnia);\n     roundtrip(lower_item(&lcx, &quote_item!(&cx,\n         fn foo() {}\n     ).unwrap()));\n@@ -1349,7 +1349,7 @@ fn test_basic() {\n fn test_smalltalk() {\n     let cx = mk_ctxt();\n     let fnia = FakeNodeIdAssigner;\n-    let lcx = LoweringContext::new(&fnia, None);\n+    let lcx = LoweringContext::testing_context(&fnia);\n     roundtrip(lower_item(&lcx, &quote_item!(&cx,\n         fn foo() -> isize { 3 + 4 } // first smalltalk program ever executed.\n     ).unwrap()));\n@@ -1359,7 +1359,7 @@ fn test_smalltalk() {\n fn test_more() {\n     let cx = mk_ctxt();\n     let fnia = FakeNodeIdAssigner;\n-    let lcx = LoweringContext::new(&fnia, None);\n+    let lcx = LoweringContext::testing_context(&fnia);\n     roundtrip(lower_item(&lcx, &quote_item!(&cx,\n         fn foo(x: usize, y: usize) -> usize {\n             let z = x + y;\n@@ -1378,7 +1378,7 @@ fn test_simplification() {\n         }\n     ).unwrap();\n     let fnia = FakeNodeIdAssigner;\n-    let lcx = LoweringContext::new(&fnia, None);\n+    let lcx = LoweringContext::testing_context(&fnia);\n     let hir_item = lower_item(&lcx, &item);\n     let item_in = InlinedItemRef::Item(&hir_item);\n     let item_out = simplify_ast(item_in);"}, {"sha": "635ef4ab3583619b4a74475625e4b0451362d380", "filename": "src/librustc_metadata/creader.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_metadata%2Fcreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_metadata%2Fcreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcreader.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -45,7 +45,7 @@ pub struct LocalCrateReader<'a> {\n     cstore: &'a CStore,\n     creader: CrateReader<'a>,\n     krate: &'a ast::Crate,\n-    defintions: &'a hir_map::Definitions,\n+    defintions: &'a RefCell<hir_map::Definitions>,\n }\n \n pub struct CrateReader<'a> {\n@@ -59,6 +59,7 @@ pub struct CrateReader<'a> {\n impl<'a, 'ast> visit::Visitor<'ast> for LocalCrateReader<'a> {\n     fn visit_item(&mut self, a: &'ast ast::Item) {\n         self.process_item(a);\n+        visit::walk_item(self, a);\n     }\n }\n \n@@ -81,6 +82,7 @@ fn should_link(i: &ast::Item) -> bool {\n     !attr::contains_name(&i.attrs, \"no_link\")\n }\n \n+#[derive(Debug)]\n struct CrateInfo {\n     ident: String,\n     name: String,\n@@ -750,7 +752,7 @@ impl<'a> CrateReader<'a> {\n impl<'a> LocalCrateReader<'a> {\n     pub fn new(sess: &'a Session,\n                cstore: &'a CStore,\n-               defs: &'a hir_map::Definitions,\n+               defs: &'a RefCell<hir_map::Definitions>,\n                krate: &'a ast::Crate,\n                local_crate_name: &str)\n                -> LocalCrateReader<'a> {\n@@ -807,9 +809,10 @@ impl<'a> LocalCrateReader<'a> {\n                                                                       i.span,\n                                                                       PathKind::Crate,\n                                                                       true);\n-                        let def_id = self.defintions.opt_local_def_id(i.id).unwrap();\n \n-                        let len = self.defintions.def_path(def_id.index).data.len();\n+                        let defs = self.defintions.borrow();\n+                        let def_id = defs.opt_local_def_id(i.id).unwrap();\n+                        let len = defs.def_path(def_id.index).data.len();\n \n                         self.creader.update_extern_crate(cnum,\n                                                          ExternCrate {"}, {"sha": "45ec9a97a11844308d27cc0a05eeaefcec7dd8d4", "filename": "src/librustc_save_analysis/csv_dumper.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_save_analysis%2Fcsv_dumper.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_save_analysis%2Fcsv_dumper.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fcsv_dumper.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -17,10 +17,10 @@ use super::data::*;\n use super::dump::Dump;\n use super::span_utils::SpanUtils;\n \n-pub struct CsvDumper<'a, 'b, W: 'b> {\n+pub struct CsvDumper<'tcx, 'b, W: 'b> {\n     output: &'b mut W,\n     dump_spans: bool,\n-    span: SpanUtils<'a>\n+    span: SpanUtils<'tcx>\n }\n \n impl<'a, 'b, W: Write> CsvDumper<'a, 'b, W> {"}, {"sha": "bf6ad7039636e97697c919b34de5f10f6bcd27f5", "filename": "src/librustc_save_analysis/dump_visitor.rs", "status": "modified", "additions": 10, "deletions": 13, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_save_analysis%2Fdump_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_save_analysis%2Fdump_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fdump_visitor.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -42,7 +42,7 @@ use syntax::visit::{self, Visitor};\n use syntax::print::pprust::{path_to_string, ty_to_string};\n use syntax::ptr::P;\n \n-use rustc::hir::lowering::{lower_expr, LoweringContext};\n+use rustc::hir::lowering::lower_expr;\n \n use super::{escape, generated_code, SaveContext, PathCollector};\n use super::data::*;\n@@ -60,12 +60,12 @@ macro_rules! down_cast_data {\n     };\n }\n \n-pub struct DumpVisitor<'l, 'tcx: 'l, D: 'l> {\n+pub struct DumpVisitor<'l, 'tcx: 'l, 'll, D: 'll> {\n     save_ctxt: SaveContext<'l, 'tcx>,\n     sess: &'l Session,\n     tcx: &'l TyCtxt<'tcx>,\n     analysis: &'l ty::CrateAnalysis<'l>,\n-    dumper: &'l mut D,\n+    dumper: &'ll mut D,\n \n     span: SpanUtils<'l>,\n \n@@ -77,22 +77,19 @@ pub struct DumpVisitor<'l, 'tcx: 'l, D: 'l> {\n     // one macro use per unique callsite span.\n     mac_defs: HashSet<Span>,\n     mac_uses: HashSet<Span>,\n-\n }\n \n-impl <'l, 'tcx, D> DumpVisitor<'l, 'tcx, D>\n-where D: Dump\n-{\n+impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n     pub fn new(tcx: &'l TyCtxt<'tcx>,\n-               lcx: &'l LoweringContext<'l>,\n+               save_ctxt: SaveContext<'l, 'tcx>,\n                analysis: &'l ty::CrateAnalysis<'l>,\n-               dumper: &'l mut D)\n-               -> DumpVisitor<'l, 'tcx, D> {\n+               dumper: &'ll mut D)\n+               -> DumpVisitor<'l, 'tcx, 'll, D> {\n         let span_utils = SpanUtils::new(&tcx.sess);\n         DumpVisitor {\n             sess: &tcx.sess,\n             tcx: tcx,\n-            save_ctxt: SaveContext::from_span_utils(tcx, lcx, span_utils.clone()),\n+            save_ctxt: save_ctxt,\n             analysis: analysis,\n             dumper: dumper,\n             span: span_utils.clone(),\n@@ -103,7 +100,7 @@ where D: Dump\n     }\n \n     fn nest<F>(&mut self, scope_id: NodeId, f: F)\n-        where F: FnOnce(&mut DumpVisitor<'l, 'tcx, D>)\n+        where F: FnOnce(&mut DumpVisitor<'l, 'tcx, 'll, D>)\n     {\n         let parent_scope = self.cur_scope;\n         self.cur_scope = scope_id;\n@@ -982,7 +979,7 @@ where D: Dump\n     }\n }\n \n-impl<'l, 'tcx, 'v, D: Dump + 'l> Visitor<'v> for DumpVisitor<'l, 'tcx, D> {\n+impl<'v, 'l, 'tcx: 'l, 'll, D: Dump +'ll> Visitor<'v> for DumpVisitor<'l, 'tcx, 'll, D> {\n     fn visit_item(&mut self, item: &ast::Item) {\n         use syntax::ast::ItemKind::*;\n         self.process_macro_use(item.span, item.id);"}, {"sha": "9148b53322bfe61b125620c0d80f1e3011bdf097", "filename": "src/librustc_save_analysis/lib.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_save_analysis%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_save_analysis%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Flib.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -73,7 +73,7 @@ pub mod recorder {\n pub struct SaveContext<'l, 'tcx: 'l> {\n     tcx: &'l TyCtxt<'tcx>,\n     lcx: &'l lowering::LoweringContext<'l>,\n-    span_utils: SpanUtils<'l>,\n+    span_utils: SpanUtils<'tcx>,\n }\n \n macro_rules! option_try(\n@@ -90,7 +90,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n \n     pub fn from_span_utils(tcx: &'l TyCtxt<'tcx>,\n                            lcx: &'l lowering::LoweringContext<'l>,\n-                           span_utils: SpanUtils<'l>)\n+                           span_utils: SpanUtils<'tcx>)\n                            -> SaveContext<'l, 'tcx> {\n         SaveContext {\n             tcx: tcx,\n@@ -680,7 +680,7 @@ impl<'v> Visitor<'v> for PathCollector {\n pub fn process_crate<'l, 'tcx>(tcx: &'l TyCtxt<'tcx>,\n                                lcx: &'l lowering::LoweringContext<'l>,\n                                krate: &ast::Crate,\n-                               analysis: &ty::CrateAnalysis,\n+                               analysis: &'l ty::CrateAnalysis<'l>,\n                                cratename: &str,\n                                odir: Option<&Path>) {\n     let _ignore = tcx.dep_graph.in_ignore();\n@@ -726,9 +726,10 @@ pub fn process_crate<'l, 'tcx>(tcx: &'l TyCtxt<'tcx>,\n     });\n     root_path.pop();\n \n-    let utils = SpanUtils::new(&tcx.sess);\n+    let utils: SpanUtils<'tcx> = SpanUtils::new(&tcx.sess);\n+    let save_ctxt = SaveContext::new(tcx, lcx);\n     let mut dumper = CsvDumper::new(&mut output_file, utils);\n-    let mut visitor = DumpVisitor::new(tcx, lcx, analysis, &mut dumper);\n+    let mut visitor = DumpVisitor::new(tcx, save_ctxt, analysis, &mut dumper);\n     // FIXME: we don't write anything!\n \n     visitor.dump_crate_info(cratename, krate);"}, {"sha": "c64eeb92737e05ebcdbe2c62db8eeeb3f45d9bde", "filename": "src/librustc_save_analysis/span_utils.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_save_analysis%2Fspan_utils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustc_save_analysis%2Fspan_utils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fspan_utils.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -26,6 +26,8 @@ use syntax::parse::token::{keywords, Token};\n #[derive(Clone)]\n pub struct SpanUtils<'a> {\n     pub sess: &'a Session,\n+    // FIXME given that we clone SpanUtils all over the place, this err_count is\n+    // probably useless and any logic relying on it is bogus.\n     pub err_count: Cell<isize>,\n }\n "}, {"sha": "6d1e91a687e586074115bd8bb07654073643c28d", "filename": "src/librustdoc/core.rs", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustdoc%2Fcore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustdoc%2Fcore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fcore.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -22,6 +22,7 @@ use rustc_trans::back::link;\n use rustc_resolve as resolve;\n use rustc::hir::lowering::{lower_crate, LoweringContext};\n use rustc_metadata::cstore::CStore;\n+use rustc_metadata::creader::LocalCrateReader;\n \n use syntax::{ast, codemap, errors};\n use syntax::errors::emitter::ColorConfig;\n@@ -151,14 +152,18 @@ pub fn run_core(search_paths: SearchPaths,\n                     .expect(\"phase_2_configure_and_expand aborted in rustdoc!\");\n \n     let krate = driver::assign_node_ids(&sess, krate);\n+    let dep_graph = DepGraph::new(false);\n+\n+    let defs = &RefCell::new(hir_map::collect_definitions(&krate));\n+    LocalCrateReader::new(&sess, &cstore, &defs, &krate, &name).read_crates(&dep_graph);\n+    let lcx = LoweringContext::new(&sess, Some(&krate), defs);\n+\n     // Lower ast -> hir.\n-    let lcx = LoweringContext::new(&sess, Some(&krate));\n-    let mut hir_forest = hir_map::Forest::new(lower_crate(&lcx, &krate), DepGraph::new(false));\n+    let mut hir_forest = hir_map::Forest::new(lower_crate(&lcx, &krate), dep_graph);\n     let arenas = ty::CtxtArenas::new();\n-    let hir_map = driver::make_map(&sess, &mut hir_forest);\n+    let hir_map = hir_map::map_crate(&mut hir_forest, defs);\n \n     abort_on_err(driver::phase_3_run_analysis_passes(&sess,\n-                                                     &cstore,\n                                                      hir_map,\n                                                      &arenas,\n                                                      &name,"}, {"sha": "487aac1806ea7291e7e1e7122af1f4f604a4a1ed", "filename": "src/librustdoc/test.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustdoc%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Flibrustdoc%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ftest.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -94,15 +94,17 @@ pub fn run(input: &str,\n                                                      \"rustdoc-test\", None)\n         .expect(\"phase_2_configure_and_expand aborted in rustdoc!\");\n     let krate = driver::assign_node_ids(&sess, krate);\n-    let lcx = LoweringContext::new(&sess, Some(&krate));\n+    let dep_graph = DepGraph::new(false);\n+    let defs = &RefCell::new(hir_map::collect_definitions(&krate));\n+\n+    let lcx = LoweringContext::new(&sess, Some(&krate), defs);\n     let krate = lower_crate(&lcx, &krate);\n \n     let opts = scrape_test_config(&krate);\n \n-    let dep_graph = DepGraph::new(false);\n     let _ignore = dep_graph.in_ignore();\n     let mut forest = hir_map::Forest::new(krate, dep_graph.clone());\n-    let map = hir_map::map_crate(&mut forest);\n+    let map = hir_map::map_crate(&mut forest, defs);\n \n     let ctx = core::DocContext {\n         map: &map,"}, {"sha": "86b9c4c81c66b18922cc9d65a729dee292986ac8", "filename": "src/test/run-make/execution-engine/test.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Ftest%2Frun-make%2Fexecution-engine%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13/src%2Ftest%2Frun-make%2Fexecution-engine%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fexecution-engine%2Ftest.rs?ref=1d5a29cf0e40c412bb2e090aadcf3ebfb1d5fa13", "patch": "@@ -20,6 +20,7 @@ extern crate rustc_metadata;\n extern crate rustc_resolve;\n #[macro_use] extern crate syntax;\n \n+use std::cell::RefCell;\n use std::ffi::{CStr, CString};\n use std::mem::transmute;\n use std::path::PathBuf;\n@@ -35,6 +36,7 @@ use rustc::session::build_session;\n use rustc_driver::{driver, abort_on_err};\n use rustc::hir::lowering::{lower_crate, LoweringContext};\n use rustc_resolve::MakeGlobMap;\n+use rustc_metadata::creader::LocalCrateReader;\n use rustc_metadata::cstore::CStore;\n use libc::c_void;\n \n@@ -237,15 +239,17 @@ fn compile_program(input: &str, sysroot: PathBuf)\n         let krate = driver::phase_2_configure_and_expand(&sess, &cstore, krate, &id, None)\n             .expect(\"phase_2 returned `None`\");\n \n+        let dep_graph = DepGraph::new(sess.opts.build_dep_graph);\n         let krate = driver::assign_node_ids(&sess, krate);\n-        let lcx = LoweringContext::new(&sess, Some(&krate));\n-        let dep_graph = DepGraph::new(sess.opts.build_dep_graph());\n+        let defs = RefCell::new(ast_map::collect_definitions(&krate));\n+        LocalCrateReader::new(&sess, &cstore, &defs, &krate, &id).read_crates(&dep_graph);\n+        let lcx = LoweringContext::new(&sess, Some(&krate), &defs);\n         let mut hir_forest = ast_map::Forest::new(lower_crate(&lcx, &krate), dep_graph);\n         let arenas = ty::CtxtArenas::new();\n-        let ast_map = driver::make_map(&sess, &mut hir_forest);\n+        let ast_map = ast_map::map_crate(&mut hir_forest, &defs);\n \n         abort_on_err(driver::phase_3_run_analysis_passes(\n-            &sess, &cstore, ast_map, &arenas, &id,\n+            &sess, ast_map, &arenas, &id,\n             MakeGlobMap::No, |tcx, mir_map, analysis, _| {\n \n             let trans = driver::phase_4_translate_to_llvm(tcx, mir_map.unwrap(), analysis);"}]}