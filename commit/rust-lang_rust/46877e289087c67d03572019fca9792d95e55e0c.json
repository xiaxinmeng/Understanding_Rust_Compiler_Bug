{"sha": "46877e289087c67d03572019fca9792d95e55e0c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ2ODc3ZTI4OTA4N2M2N2QwMzU3MjAxOWZjYTk3OTJkOTVlNTVlMGM=", "commit": {"author": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-08-29T00:18:25Z"}, "committer": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-09-02T21:23:21Z"}, "message": "Fix const eval bug breaking run-pass tests in Miri\n\nPR #63580 broke miri's ability to run the run-pass test suite with MIR\noptimizations enabled. The issue was that we weren't properly handling\nthe substs and DefId associated with a Promoted value. This didn't break\nanything in rustc because in rustc this code runs before the Inliner\npass which is where the DefId and substs can diverge from their initial\nvalues. It broke Miri though because it ran this code again after\nrunning the optimization pass.", "tree": {"sha": "3c982a8f58fe415b3c862bf89745ce25cce5ebdf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3c982a8f58fe415b3c862bf89745ce25cce5ebdf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/46877e289087c67d03572019fca9792d95e55e0c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/46877e289087c67d03572019fca9792d95e55e0c", "html_url": "https://github.com/rust-lang/rust/commit/46877e289087c67d03572019fca9792d95e55e0c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/46877e289087c67d03572019fca9792d95e55e0c/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fdaf594bab31eec75fb6d582cd33e5a5b43de7f4", "url": "https://api.github.com/repos/rust-lang/rust/commits/fdaf594bab31eec75fb6d582cd33e5a5b43de7f4", "html_url": "https://github.com/rust-lang/rust/commit/fdaf594bab31eec75fb6d582cd33e5a5b43de7f4"}], "stats": {"total": 5, "additions": 3, "deletions": 2}, "files": [{"sha": "f358bb00f4d12a744d5969a00d25572ef18b3c00", "filename": "src/librustc_mir/interpret/place.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/46877e289087c67d03572019fca9792d95e55e0c/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/46877e289087c67d03572019fca9792d95e55e0c/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fplace.rs?ref=46877e289087c67d03572019fca9792d95e55e0c", "patch": "@@ -585,8 +585,9 @@ where\n         use rustc::mir::StaticKind;\n \n         Ok(match place_static.kind {\n-            StaticKind::Promoted(promoted, _) => {\n-                let instance = self.frame().instance;\n+            StaticKind::Promoted(promoted, promoted_substs) => {\n+                let substs = self.subst_from_frame_and_normalize_erasing_regions(promoted_substs);\n+                let instance = ty::Instance::new(place_static.def_id, substs);\n                 self.const_eval_raw(GlobalId {\n                     instance,\n                     promoted: Some(promoted),"}]}