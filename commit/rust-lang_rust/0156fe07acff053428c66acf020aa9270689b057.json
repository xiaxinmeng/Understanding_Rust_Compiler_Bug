{"sha": "0156fe07acff053428c66acf020aa9270689b057", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAxNTZmZTA3YWNmZjA1MzQyOGM2NmFjZjAyMGFhOTI3MDY4OWIwNTc=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2018-04-05T05:36:15Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-04-05T05:36:15Z"}, "message": "Merge pull request #2589 from topecongiro/issue-2588\n\nDo not indent or unindent inside string literal", "tree": {"sha": "d22a71f084e9df25469625e80700b7ac5a8e1f4c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d22a71f084e9df25469625e80700b7ac5a8e1f4c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0156fe07acff053428c66acf020aa9270689b057", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJaxbXPCRBK7hj4Ov3rIwAAdHIIAIV0MJA/ZoijC863wIYtbETd\nwYRnzbeQxZQvxRRLxuGqCLI4SYQgSuImaI+p4XyzP5IDWvVNCrHxo4Y6zwvYqoNU\nXijr6HTp2zZ1p0Kp7Pv7Fmp9Ij25Nlfxb2kJSseWiQSpUCDXX5kNdZjK9ybf9mls\nfPsMFXX5GUy/QutJ5aBhXHbbf1BkjoigucfSZ2Rsx4hT204MT5a2adqq5DGqRMxc\nYtFtj/y6pOaLntSx64JOYbcKmJH4GsGTenGIB7cvyqwSNrzScewj7VtpgVBflnnr\nj93l0DNd9fvF8uySea2P1OH3ftbaV8UR+GcGu2lY7xd/XMkwzHXgcaD4PWU8+mE=\n=gkGG\n-----END PGP SIGNATURE-----\n", "payload": "tree d22a71f084e9df25469625e80700b7ac5a8e1f4c\nparent 4237f40c50e80cc88389c01bd7b89fb8db30b4af\nparent ec1907b2a473a2f34dd854304ead822e9becef51\nauthor Nick Cameron <nrc@ncameron.org> 1522906575 +1200\ncommitter GitHub <noreply@github.com> 1522906575 +1200\n\nMerge pull request #2589 from topecongiro/issue-2588\n\nDo not indent or unindent inside string literal "}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0156fe07acff053428c66acf020aa9270689b057", "html_url": "https://github.com/rust-lang/rust/commit/0156fe07acff053428c66acf020aa9270689b057", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0156fe07acff053428c66acf020aa9270689b057/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4237f40c50e80cc88389c01bd7b89fb8db30b4af", "url": "https://api.github.com/repos/rust-lang/rust/commits/4237f40c50e80cc88389c01bd7b89fb8db30b4af", "html_url": "https://github.com/rust-lang/rust/commit/4237f40c50e80cc88389c01bd7b89fb8db30b4af"}, {"sha": "ec1907b2a473a2f34dd854304ead822e9becef51", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec1907b2a473a2f34dd854304ead822e9becef51", "html_url": "https://github.com/rust-lang/rust/commit/ec1907b2a473a2f34dd854304ead822e9becef51"}], "stats": {"total": 171, "additions": 135, "deletions": 36}, "files": [{"sha": "9d5543258f6cee01e47c60421dee4510e3bec345", "filename": "src/comment.rs", "status": "modified", "additions": 46, "deletions": 2, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/0156fe07acff053428c66acf020aa9270689b057/src%2Fcomment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0156fe07acff053428c66acf020aa9270689b057/src%2Fcomment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomment.rs?ref=0156fe07acff053428c66acf020aa9270689b057", "patch": "@@ -901,6 +901,45 @@ where\n     }\n }\n \n+/// An iterator over the lines of a string, paired with the char kind at the\n+/// end of the line.\n+pub struct LineClasses<'a> {\n+    base: iter::Peekable<CharClasses<std::str::Chars<'a>>>,\n+    kind: FullCodeCharKind,\n+}\n+\n+impl<'a> LineClasses<'a> {\n+    pub fn new(s: &'a str) -> Self {\n+        LineClasses {\n+            base: CharClasses::new(s.chars()).peekable(),\n+            kind: FullCodeCharKind::Normal,\n+        }\n+    }\n+}\n+\n+impl<'a> Iterator for LineClasses<'a> {\n+    type Item = (FullCodeCharKind, String);\n+\n+    fn next(&mut self) -> Option<Self::Item> {\n+        if self.base.peek().is_none() {\n+            return None;\n+        }\n+\n+        let mut line = String::new();\n+\n+        while let Some((kind, c)) = self.base.next() {\n+            self.kind = kind;\n+            if c == '\\n' {\n+                break;\n+            } else {\n+                line.push(c);\n+            }\n+        }\n+\n+        Some((self.kind, line))\n+    }\n+}\n+\n /// Iterator over functional and commented parts of a string. Any part of a string is either\n /// functional code, either *one* block comment, either *one* line comment. Whitespace between\n /// comments is functional code. Line comments contain their ending newlines.\n@@ -1141,8 +1180,7 @@ fn remove_comment_header(comment: &str) -> &str {\n \n #[cfg(test)]\n mod test {\n-    use super::{contains_comment, rewrite_comment, CharClasses, CodeCharKind, CommentCodeSlices,\n-                FindUncommented, FullCodeCharKind};\n+    use super::*;\n     use shape::{Indent, Shape};\n \n     #[test]\n@@ -1298,4 +1336,10 @@ mod test {\n         check(\"\\\"/* abc */\\\"\", \"abc\", Some(4));\n         check(\"\\\"/* abc\", \"abc\", Some(4));\n     }\n+\n+    #[test]\n+    fn test_remove_trailing_white_spaces() {\n+        let s = format!(\"    r#\\\"\\n        test\\n    \\\"#\");\n+        assert_eq!(remove_trailing_white_spaces(&s), s);\n+    }\n }"}, {"sha": "6aa9f7f31075e8f512c8380b293342132419ba71", "filename": "src/lib.rs", "status": "modified", "additions": 20, "deletions": 7, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/0156fe07acff053428c66acf020aa9270689b057/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0156fe07acff053428c66acf020aa9270689b057/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=0156fe07acff053428c66acf020aa9270689b057", "patch": "@@ -47,7 +47,7 @@ use syntax::errors::{DiagnosticBuilder, Handler};\n use syntax::parse::{self, ParseSess};\n \n use checkstyle::{output_footer, output_header};\n-use comment::{CharClasses, FullCodeCharKind};\n+use comment::{CharClasses, FullCodeCharKind, LineClasses};\n use issues::{BadIssueSeeker, Issue};\n use shape::Indent;\n use utils::use_colored_tty;\n@@ -605,10 +605,19 @@ const FN_MAIN_PREFIX: &str = \"fn main() {\\n\";\n \n fn enclose_in_main_block(s: &str, config: &Config) -> String {\n     let indent = Indent::from_width(config, config.tab_spaces());\n-    FN_MAIN_PREFIX.to_owned() + &indent.to_string(config)\n-        + &s.lines()\n-            .collect::<Vec<_>>()\n-            .join(&indent.to_string_with_newline(config)) + \"\\n}\"\n+    let mut result = String::with_capacity(s.len() * 2);\n+    result.push_str(FN_MAIN_PREFIX);\n+    let mut need_indent = true;\n+    for (kind, line) in LineClasses::new(s) {\n+        if need_indent {\n+            result.push_str(&indent.to_string(config));\n+        }\n+        result.push_str(&line);\n+        result.push('\\n');\n+        need_indent = !(kind.is_string() && !line.ends_with('\\\\'));\n+    }\n+    result.push('}');\n+    result\n }\n \n /// Format the given code block. Mainly targeted for code block in comment.\n@@ -626,13 +635,16 @@ pub fn format_code_block(code_snippet: &str, config: &Config) -> Option<String>\n     let formatted = format_snippet(&snippet, config)?;\n     // 2 = \"}\\n\"\n     let block_len = formatted.len().checked_sub(2).unwrap_or(0);\n-    for line in formatted[FN_MAIN_PREFIX.len()..block_len].lines() {\n+    let mut is_indented = true;\n+    for (kind, ref line) in LineClasses::new(&formatted[FN_MAIN_PREFIX.len()..block_len]) {\n         if !is_first {\n             result.push('\\n');\n         } else {\n             is_first = false;\n         }\n-        let trimmed_line = if line.len() > config.max_width() {\n+        let trimmed_line = if !is_indented {\n+            line\n+        } else if line.len() > config.max_width() {\n             // If there are lines that are larger than max width, we cannot tell\n             // whether we have succeeded but have some comments or strings that\n             // are too long, or we have failed to format code block. We will be\n@@ -655,6 +667,7 @@ pub fn format_code_block(code_snippet: &str, config: &Config) -> Option<String>\n             line\n         };\n         result.push_str(trimmed_line);\n+        is_indented = !(kind.is_string() && !line.ends_with('\\\\'));\n     }\n     Some(result)\n }"}, {"sha": "3769c97845b9aa4c974057db9ab4b925ab43bcd8", "filename": "src/macros.rs", "status": "modified", "additions": 41, "deletions": 27, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/0156fe07acff053428c66acf020aa9270689b057/src%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0156fe07acff053428c66acf020aa9270689b057/src%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmacros.rs?ref=0156fe07acff053428c66acf020aa9270689b057", "patch": "@@ -34,7 +34,7 @@ use syntax::{ast, ptr};\n \n use codemap::SpanUtils;\n use comment::{contains_comment, remove_trailing_white_spaces, CharClasses, FindUncommented,\n-              FullCodeCharKind};\n+              FullCodeCharKind, LineClasses};\n use expr::rewrite_array;\n use lists::{itemize_list, write_list, ListFormatting};\n use overflow;\n@@ -1054,18 +1054,27 @@ fn indent_macro_snippet(\n     macro_str: &str,\n     indent: Indent,\n ) -> Option<String> {\n-    let mut lines = macro_str.lines();\n-    let first_line = lines.next().map(|s| s.trim_right())?;\n+    let mut lines = LineClasses::new(macro_str);\n+    let first_line = lines.next().map(|(_, s)| s.trim_right().to_owned())?;\n     let mut trimmed_lines = Vec::with_capacity(16);\n \n+    let mut veto_trim = false;\n     let min_prefix_space_width = lines\n-        .filter_map(|line| {\n-            let prefix_space_width = if is_empty_line(line) {\n+        .filter_map(|(kind, line)| {\n+            let mut trimmed = true;\n+            let prefix_space_width = if is_empty_line(&line) {\n                 None\n             } else {\n-                Some(get_prefix_space_width(context, line))\n+                Some(get_prefix_space_width(context, &line))\n             };\n-            trimmed_lines.push((line.trim(), prefix_space_width));\n+            let line = if veto_trim || (kind.is_string() && !line.ends_with('\\\\')) {\n+                veto_trim = kind.is_string() && !line.ends_with('\\\\');\n+                trimmed = false;\n+                line\n+            } else {\n+                line.trim().to_owned()\n+            };\n+            trimmed_lines.push((trimmed, line, prefix_space_width));\n             prefix_space_width\n         })\n         .min()?;\n@@ -1074,17 +1083,20 @@ fn indent_macro_snippet(\n         String::from(first_line) + \"\\n\"\n             + &trimmed_lines\n                 .iter()\n-                .map(|&(line, prefix_space_width)| match prefix_space_width {\n-                    Some(original_indent_width) => {\n-                        let new_indent_width = indent.width()\n-                            + original_indent_width\n-                                .checked_sub(min_prefix_space_width)\n-                                .unwrap_or(0);\n-                        let new_indent = Indent::from_width(context.config, new_indent_width);\n-                        format!(\"{}{}\", new_indent.to_string(context.config), line.trim())\n-                    }\n-                    None => String::new(),\n-                })\n+                .map(\n+                    |&(trimmed, ref line, prefix_space_width)| match prefix_space_width {\n+                        _ if !trimmed => line.to_owned(),\n+                        Some(original_indent_width) => {\n+                            let new_indent_width = indent.width()\n+                                + original_indent_width\n+                                    .checked_sub(min_prefix_space_width)\n+                                    .unwrap_or(0);\n+                            let new_indent = Indent::from_width(context.config, new_indent_width);\n+                            format!(\"{}{}\", new_indent.to_string(context.config), line.trim())\n+                        }\n+                        None => String::new(),\n+                    },\n+                )\n                 .collect::<Vec<_>>()\n                 .join(\"\\n\"),\n     )\n@@ -1231,15 +1243,17 @@ impl MacroBranch {\n \n         // Indent the body since it is in a block.\n         let indent_str = body_indent.to_string(&config);\n-        let mut new_body = new_body\n-            .trim_right()\n-            .lines()\n-            .fold(String::new(), |mut s, l| {\n-                if !l.is_empty() {\n-                    s += &indent_str;\n-                }\n-                s + l + \"\\n\"\n-            });\n+        let mut new_body = LineClasses::new(new_body.trim_right())\n+            .fold(\n+                (String::new(), true),\n+                |(mut s, need_indent), (kind, ref l)| {\n+                    if !l.is_empty() && need_indent {\n+                        s += &indent_str;\n+                    }\n+                    (s + l + \"\\n\", !(kind.is_string() && !l.ends_with('\\\\')))\n+                },\n+            )\n+            .0;\n \n         // Undo our replacement of macro variables.\n         // FIXME: this could be *much* more efficient."}, {"sha": "6e730fffbf6136a18fbee536e2018012e331a4d9", "filename": "tests/source/macros.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/0156fe07acff053428c66acf020aa9270689b057/tests%2Fsource%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0156fe07acff053428c66acf020aa9270689b057/tests%2Fsource%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fmacros.rs?ref=0156fe07acff053428c66acf020aa9270689b057", "patch": "@@ -348,6 +348,20 @@ macro lex_err($kind: ident $(, $body: expr)*) {\n methods![ get, post, delete, ];\n methods!( get, post, delete, );\n \n+// #2588\n+macro_rules! m {\n+    () => {\n+        r#\"\n+            test\n+        \"#\n+    };\n+}\n+fn foo() {\n+    f!{r#\"\n+            test\n+       \"#};\n+}\n+\n // #2591\n fn foo() {\n     match 0u32 {"}, {"sha": "d430f5711dd8e7d034cfc9aa68b5c380d1250caf", "filename": "tests/target/macros.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/0156fe07acff053428c66acf020aa9270689b057/tests%2Ftarget%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0156fe07acff053428c66acf020aa9270689b057/tests%2Ftarget%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fmacros.rs?ref=0156fe07acff053428c66acf020aa9270689b057", "patch": "@@ -923,6 +923,20 @@ macro lex_err($kind: ident $(, $body: expr)*) {\n methods![get, post, delete,];\n methods!(get, post, delete,);\n \n+// #2588\n+macro_rules! m {\n+    () => {\n+        r#\"\n+            test\n+        \"#\n+    };\n+}\n+fn foo() {\n+    f!{r#\"\n+            test\n+       \"#};\n+}\n+\n // #2591\n fn foo() {\n     match 0u32 {"}]}