{"sha": "5574182b4d2d08c848a88a1ac5633fc194e0465e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU1NzQxODJiNGQyZDA4Yzg0OGE4OGExYWM1NjMzZmMxOTRlMDQ2NWU=", "commit": {"author": {"name": "Hirochika Matsumoto", "email": "matsujika@gmail.com", "date": "2020-08-28T09:40:22Z"}, "committer": {"name": "Hirochika Matsumoto", "email": "matsujika@gmail.com", "date": "2020-08-28T09:45:28Z"}, "message": "Add a new lint to prevent `create_dir` from being used", "tree": {"sha": "bac34671804d6b3b36383d6f6d5a8350eb48b246", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bac34671804d6b3b36383d6f6d5a8350eb48b246"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5574182b4d2d08c848a88a1ac5633fc194e0465e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5574182b4d2d08c848a88a1ac5633fc194e0465e", "html_url": "https://github.com/rust-lang/rust/commit/5574182b4d2d08c848a88a1ac5633fc194e0465e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5574182b4d2d08c848a88a1ac5633fc194e0465e/comments", "author": {"login": "hkmatsumoto", "id": 57856193, "node_id": "MDQ6VXNlcjU3ODU2MTkz", "avatar_url": "https://avatars.githubusercontent.com/u/57856193?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hkmatsumoto", "html_url": "https://github.com/hkmatsumoto", "followers_url": "https://api.github.com/users/hkmatsumoto/followers", "following_url": "https://api.github.com/users/hkmatsumoto/following{/other_user}", "gists_url": "https://api.github.com/users/hkmatsumoto/gists{/gist_id}", "starred_url": "https://api.github.com/users/hkmatsumoto/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hkmatsumoto/subscriptions", "organizations_url": "https://api.github.com/users/hkmatsumoto/orgs", "repos_url": "https://api.github.com/users/hkmatsumoto/repos", "events_url": "https://api.github.com/users/hkmatsumoto/events{/privacy}", "received_events_url": "https://api.github.com/users/hkmatsumoto/received_events", "type": "User", "site_admin": false}, "committer": {"login": "hkmatsumoto", "id": 57856193, "node_id": "MDQ6VXNlcjU3ODU2MTkz", "avatar_url": "https://avatars.githubusercontent.com/u/57856193?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hkmatsumoto", "html_url": "https://github.com/hkmatsumoto", "followers_url": "https://api.github.com/users/hkmatsumoto/followers", "following_url": "https://api.github.com/users/hkmatsumoto/following{/other_user}", "gists_url": "https://api.github.com/users/hkmatsumoto/gists{/gist_id}", "starred_url": "https://api.github.com/users/hkmatsumoto/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hkmatsumoto/subscriptions", "organizations_url": "https://api.github.com/users/hkmatsumoto/orgs", "repos_url": "https://api.github.com/users/hkmatsumoto/repos", "events_url": "https://api.github.com/users/hkmatsumoto/events{/privacy}", "received_events_url": "https://api.github.com/users/hkmatsumoto/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "07c5e9edb5db8723b15573eb6ebe183fddbc5d33", "url": "https://api.github.com/repos/rust-lang/rust/commits/07c5e9edb5db8723b15573eb6ebe183fddbc5d33", "html_url": "https://github.com/rust-lang/rust/commit/07c5e9edb5db8723b15573eb6ebe183fddbc5d33"}], "stats": {"total": 104, "additions": 104, "deletions": 0}, "files": [{"sha": "b37273af44d2226c5bb01bbbc33fadf9d8c7b60e", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5574182b4d2d08c848a88a1ac5633fc194e0465e/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/5574182b4d2d08c848a88a1ac5633fc194e0465e/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=5574182b4d2d08c848a88a1ac5633fc194e0465e", "patch": "@@ -1444,6 +1444,7 @@ Released 2018-09-13\n [`collapsible_if`]: https://rust-lang.github.io/rust-clippy/master/index.html#collapsible_if\n [`comparison_chain`]: https://rust-lang.github.io/rust-clippy/master/index.html#comparison_chain\n [`copy_iterator`]: https://rust-lang.github.io/rust-clippy/master/index.html#copy_iterator\n+[`create_dir`]: https://rust-lang.github.io/rust-clippy/master/index.html#create_dir\n [`crosspointer_transmute`]: https://rust-lang.github.io/rust-clippy/master/index.html#crosspointer_transmute\n [`dbg_macro`]: https://rust-lang.github.io/rust-clippy/master/index.html#dbg_macro\n [`debug_assert_with_mut_call`]: https://rust-lang.github.io/rust-clippy/master/index.html#debug_assert_with_mut_call"}, {"sha": "229536bd673071abd6e6b93b4f62ea08042ac946", "filename": "clippy_lints/src/create_dir.rs", "status": "added", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/5574182b4d2d08c848a88a1ac5633fc194e0465e/clippy_lints%2Fsrc%2Fcreate_dir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5574182b4d2d08c848a88a1ac5633fc194e0465e/clippy_lints%2Fsrc%2Fcreate_dir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcreate_dir.rs?ref=5574182b4d2d08c848a88a1ac5633fc194e0465e", "patch": "@@ -0,0 +1,50 @@\n+use crate::utils::{match_qpath, snippet, span_lint_and_sugg};\n+use if_chain::if_chain;\n+use rustc_errors::Applicability;\n+use rustc_hir::*;\n+use rustc_lint::{LateContext, LateLintPass};\n+use rustc_session::{declare_lint_pass, declare_tool_lint};\n+\n+declare_clippy_lint! {\n+    /// **What it does:** Checks usage of `std::fs::create_dir` and suggest using `std::fs::create_dir_all` instead.\n+    ///\n+    /// **Why is this bad?** Sometimes `std::fs::crate_dir` is mistakenly chosen over `std::fs::create_dir_all`.\n+    ///\n+    /// **Known problems:** None.\n+    ///\n+    /// **Example:**\n+    ///\n+    /// ```rust\n+    /// std::fs::create_dir(\"foo\")\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// std::fs::create_dir_all(\"foo\")\n+    /// ```\n+    pub CREATE_DIR,\n+    restriction,\n+    \"calling `std::fs::create_dir` instead of `std::fs::create_dir_all`\"\n+}\n+\n+declare_lint_pass!(CreateDir => [CREATE_DIR]);\n+\n+impl LateLintPass<'_> for CreateDir {\n+    fn check_expr(&mut self, cx: &LateContext<'_>, expr: &Expr<'_>) {\n+        if_chain! {\n+            if let ExprKind::Call(ref func, ref args) = expr.kind;\n+            if let ExprKind::Path(ref path) = func.kind;\n+            if match_qpath(path, &[\"std\", \"fs\", \"create_dir\"]);\n+            then {\n+                span_lint_and_sugg(\n+                    cx,\n+                    CREATE_DIR,\n+                    expr.span,\n+                    \"calling `std::fs::create_dir` where there may be a better way\",\n+                    \"consider calling `std::fs::create_dir_all` instead\",\n+                    format!(\"std::fs::create_dir_all({})\", snippet(cx, args[0].span, \"..\")),\n+                    Applicability::MachineApplicable,\n+                )\n+            }\n+        }\n+    }\n+}"}, {"sha": "7943be34c6238a79d6bad25124f0975508887779", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5574182b4d2d08c848a88a1ac5633fc194e0465e/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5574182b4d2d08c848a88a1ac5633fc194e0465e/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=5574182b4d2d08c848a88a1ac5633fc194e0465e", "patch": "@@ -169,6 +169,7 @@ mod collapsible_if;\n mod comparison_chain;\n mod copies;\n mod copy_iterator;\n+mod create_dir;\n mod dbg_macro;\n mod default_trait_access;\n mod dereference;\n@@ -511,6 +512,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         &copies::MATCH_SAME_ARMS,\n         &copies::SAME_FUNCTIONS_IN_IF_CONDITION,\n         &copy_iterator::COPY_ITERATOR,\n+        &create_dir::CREATE_DIR,\n         &dbg_macro::DBG_MACRO,\n         &default_trait_access::DEFAULT_TRAIT_ACCESS,\n         &dereference::EXPLICIT_DEREF_METHODS,\n@@ -1042,6 +1044,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_early_pass(|| box items_after_statements::ItemsAfterStatements);\n     store.register_early_pass(|| box precedence::Precedence);\n     store.register_early_pass(|| box needless_continue::NeedlessContinue);\n+    store.register_late_pass(|| box create_dir::CreateDir);\n     store.register_early_pass(|| box needless_arbitrary_self_type::NeedlessArbitrarySelfType);\n     store.register_early_pass(|| box redundant_static_lifetimes::RedundantStaticLifetimes);\n     store.register_late_pass(|| box cargo_common_metadata::CargoCommonMetadata);\n@@ -1104,6 +1107,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&arithmetic::FLOAT_ARITHMETIC),\n         LintId::of(&arithmetic::INTEGER_ARITHMETIC),\n         LintId::of(&as_conversions::AS_CONVERSIONS),\n+        LintId::of(&create_dir::CREATE_DIR),\n         LintId::of(&dbg_macro::DBG_MACRO),\n         LintId::of(&else_if_without_else::ELSE_IF_WITHOUT_ELSE),\n         LintId::of(&exit::EXIT),"}, {"sha": "e51345109226c6514403075ea65c9b4d05c0c351", "filename": "src/lintlist/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5574182b4d2d08c848a88a1ac5633fc194e0465e/src%2Flintlist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5574182b4d2d08c848a88a1ac5633fc194e0465e/src%2Flintlist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flintlist%2Fmod.rs?ref=5574182b4d2d08c848a88a1ac5633fc194e0465e", "patch": "@@ -290,6 +290,13 @@ pub static ref ALL_LINTS: Vec<Lint> = vec![\n         deprecation: None,\n         module: \"copy_iterator\",\n     },\n+    Lint {\n+        name: \"create_dir\",\n+        group: \"restriction\",\n+        desc: \"calling `std::fs::create_dir` instead of `std::fs::create_dir_all`\",\n+        deprecation: None,\n+        module: \"create_dir\",\n+    },\n     Lint {\n         name: \"crosspointer_transmute\",\n         group: \"complexity\","}, {"sha": "50f31f0c9c540f46f6a78c15998677cc5480ec01", "filename": "tests/ui/create_dir.fixed", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/5574182b4d2d08c848a88a1ac5633fc194e0465e/tests%2Fui%2Fcreate_dir.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/5574182b4d2d08c848a88a1ac5633fc194e0465e/tests%2Fui%2Fcreate_dir.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcreate_dir.fixed?ref=5574182b4d2d08c848a88a1ac5633fc194e0465e", "patch": "@@ -0,0 +1,13 @@\n+// run-rustfix\n+#![allow(unused_must_use)]\n+#![warn(clippy::create_dir)]\n+\n+fn not_create_dir() {}\n+\n+fn main() {\n+    std::fs::create_dir_all(\"foo\");\n+    std::fs::create_dir_all(\"bar\").unwrap();\n+\n+    not_create_dir();\n+    std::fs::create_dir_all(\"foobar\");\n+}"}, {"sha": "00ef37f413f776ad72395a32da391cf5bb6db010", "filename": "tests/ui/create_dir.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/5574182b4d2d08c848a88a1ac5633fc194e0465e/tests%2Fui%2Fcreate_dir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5574182b4d2d08c848a88a1ac5633fc194e0465e/tests%2Fui%2Fcreate_dir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcreate_dir.rs?ref=5574182b4d2d08c848a88a1ac5633fc194e0465e", "patch": "@@ -0,0 +1,13 @@\n+// run-rustfix\n+#![allow(unused_must_use)]\n+#![warn(clippy::create_dir)]\n+\n+fn not_create_dir() {}\n+\n+fn main() {\n+    std::fs::create_dir(\"foo\");\n+    std::fs::create_dir(\"bar\").unwrap();\n+\n+    not_create_dir();\n+    std::fs::create_dir_all(\"foobar\");\n+}"}, {"sha": "3ae4680d9296e244d134cc14aa7a728ba99189f4", "filename": "tests/ui/create_dir.stderr", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/5574182b4d2d08c848a88a1ac5633fc194e0465e/tests%2Fui%2Fcreate_dir.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5574182b4d2d08c848a88a1ac5633fc194e0465e/tests%2Fui%2Fcreate_dir.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcreate_dir.stderr?ref=5574182b4d2d08c848a88a1ac5633fc194e0465e", "patch": "@@ -0,0 +1,16 @@\n+error: calling `std::fs::create_dir` where there may be a better way\n+  --> $DIR/create_dir.rs:8:5\n+   |\n+LL |     std::fs::create_dir(\"foo\");\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider calling `std::fs::create_dir_all` instead: `std::fs::create_dir_all(\"foo\")`\n+   |\n+   = note: `-D clippy::create-dir` implied by `-D warnings`\n+\n+error: calling `std::fs::create_dir` where there may be a better way\n+  --> $DIR/create_dir.rs:9:5\n+   |\n+LL |     std::fs::create_dir(\"bar\").unwrap();\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider calling `std::fs::create_dir_all` instead: `std::fs::create_dir_all(\"bar\")`\n+\n+error: aborting due to 2 previous errors\n+"}]}