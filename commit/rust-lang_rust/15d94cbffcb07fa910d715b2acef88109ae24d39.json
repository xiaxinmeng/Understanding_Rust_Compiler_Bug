{"sha": "15d94cbffcb07fa910d715b2acef88109ae24d39", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE1ZDk0Y2JmZmNiMDdmYTkxMGQ3MTViMmFjZWY4ODEwOWFlMjRkMzk=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-01-03T13:25:37Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-01-03T13:25:37Z"}, "message": "Merge #2731\n\n2731: Split `crate_def_map` into two methods r=matklad a=michalt\n\nThis change:\r\n\r\n  - introduces `compute_crate_def_map` query and renames\r\n    `CrateDefMap::crate_def_map_query` for consistency,\r\n\r\n  - annotates `crate_def_map` as `salsa::transparent` and adds a\r\n    top-level `crate_def_map` wrapper function around that starts the\r\n    profiler and immediately calls into `compute_crate_def_map` query.\r\n\r\nThis allows us to better understand where we spent the time, in\r\nparticular, how much is spent in the recomputaiton and how much in\r\nsalsa.\r\n\r\nExample output (where we don't actually re-compute anything, but the\r\nquery still takes a non-trivial amount of time):\r\n\r\n```\r\n  211ms - handle_inlay_hints\r\n      150ms - get_inlay_hints\r\n          150ms - SourceAnalyzer::new\r\n               65ms - def_with_body_from_child_node\r\n                   65ms - analyze_container\r\n                       65ms - analyze_container\r\n                           65ms - Module::from_definition\r\n                               65ms - Module::from_file\r\n                                   65ms - crate_def_map\r\n                                        1ms - parse_macro_query (6 calls)\r\n                                        0ms - raw_items_query (1 calls)\r\n                                       64ms - ???\r\n```\r\n\r\nSigned-off-by: Michal Terepeta <michal.terepeta@gmail.com>\n\nCo-authored-by: Michal Terepeta <michal.terepeta@gmail.com>", "tree": {"sha": "0b4d2b1afcb919b50dd16efc4448c18eb39a9f16", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0b4d2b1afcb919b50dd16efc4448c18eb39a9f16"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/15d94cbffcb07fa910d715b2acef88109ae24d39", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeD0DRCRBK7hj4Ov3rIwAAdHIIAHOjwSfrr7SEYqAcZG+OcSxJ\np40grj3S7S/4eJKJU9kpWMyRBewd5438KIDukMdAqAp2Qfi6fq25cL7kQ9p9Qn/7\nbvPjSBt9bpY45QigoZGN/kINTSXd38yaI4WTxNjMXdvacO5fM1DPABT8O+xFsz4X\nagsYjPXCIiFLUri43arx0o4ioxbM83wnSCO9ZwPtmX7gOuVr2a7rImjgoY+QaSpq\n/4KwmMPB88745G8yZg+9s0A9MDDpAV5iitLz9FJ/xDwSMpsWTf7fjOVUVEM5gWF5\nVrn4yHPoK/s9hx/idbzzdrQVTmB5hqAbrmfQxatXNIDLcxkPqQoaHfl2wJm5L2U=\n=tnZS\n-----END PGP SIGNATURE-----\n", "payload": "tree 0b4d2b1afcb919b50dd16efc4448c18eb39a9f16\nparent e423cfe383a4a1f9f0b5459810587d50bf2a2b2d\nparent 2e2e4435605b8fdabb36f018c2d6cba1fd0069b8\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1578057937 +0000\ncommitter GitHub <noreply@github.com> 1578057937 +0000\n\nMerge #2731\n\n2731: Split `crate_def_map` into two methods r=matklad a=michalt\n\nThis change:\r\n\r\n  - introduces `compute_crate_def_map` query and renames\r\n    `CrateDefMap::crate_def_map_query` for consistency,\r\n\r\n  - annotates `crate_def_map` as `salsa::transparent` and adds a\r\n    top-level `crate_def_map` wrapper function around that starts the\r\n    profiler and immediately calls into `compute_crate_def_map` query.\r\n\r\nThis allows us to better understand where we spent the time, in\r\nparticular, how much is spent in the recomputaiton and how much in\r\nsalsa.\r\n\r\nExample output (where we don't actually re-compute anything, but the\r\nquery still takes a non-trivial amount of time):\r\n\r\n```\r\n  211ms - handle_inlay_hints\r\n      150ms - get_inlay_hints\r\n          150ms - SourceAnalyzer::new\r\n               65ms - def_with_body_from_child_node\r\n                   65ms - analyze_container\r\n                       65ms - analyze_container\r\n                           65ms - Module::from_definition\r\n                               65ms - Module::from_file\r\n                                   65ms - crate_def_map\r\n                                        1ms - parse_macro_query (6 calls)\r\n                                        0ms - raw_items_query (1 calls)\r\n                                       64ms - ???\r\n```\r\n\r\nSigned-off-by: Michal Terepeta <michal.terepeta@gmail.com>\n\nCo-authored-by: Michal Terepeta <michal.terepeta@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/15d94cbffcb07fa910d715b2acef88109ae24d39", "html_url": "https://github.com/rust-lang/rust/commit/15d94cbffcb07fa910d715b2acef88109ae24d39", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/15d94cbffcb07fa910d715b2acef88109ae24d39/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e423cfe383a4a1f9f0b5459810587d50bf2a2b2d", "url": "https://api.github.com/repos/rust-lang/rust/commits/e423cfe383a4a1f9f0b5459810587d50bf2a2b2d", "html_url": "https://github.com/rust-lang/rust/commit/e423cfe383a4a1f9f0b5459810587d50bf2a2b2d"}, {"sha": "2e2e4435605b8fdabb36f018c2d6cba1fd0069b8", "url": "https://api.github.com/repos/rust-lang/rust/commits/2e2e4435605b8fdabb36f018c2d6cba1fd0069b8", "html_url": "https://github.com/rust-lang/rust/commit/2e2e4435605b8fdabb36f018c2d6cba1fd0069b8"}], "stats": {"total": 27, "additions": 18, "deletions": 9}, "files": [{"sha": "0af4a28683631ff5236d87c3d10b11f7132e43ca", "filename": "crates/ra_hir/src/db.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/15d94cbffcb07fa910d715b2acef88109ae24d39/crates%2Fra_hir%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/15d94cbffcb07fa910d715b2acef88109ae24d39/crates%2Fra_hir%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fdb.rs?ref=15d94cbffcb07fa910d715b2acef88109ae24d39", "patch": "@@ -1,11 +1,11 @@\n //! FIXME: write short doc here\n \n pub use hir_def::db::{\n-    BodyQuery, BodyWithSourceMapQuery, ConstDataQuery, CrateDefMapQuery, CrateLangItemsQuery,\n-    DefDatabase, DefDatabaseStorage, DocumentationQuery, EnumDataQuery, ExprScopesQuery,\n-    FunctionDataQuery, GenericParamsQuery, ImplDataQuery, InternDatabase, InternDatabaseStorage,\n-    LangItemQuery, ModuleLangItemsQuery, RawItemsQuery, StaticDataQuery, StructDataQuery,\n-    TraitDataQuery, TypeAliasDataQuery,\n+    BodyQuery, BodyWithSourceMapQuery, ComputeCrateDefMapQuery, ConstDataQuery,\n+    CrateLangItemsQuery, DefDatabase, DefDatabaseStorage, DocumentationQuery, EnumDataQuery,\n+    ExprScopesQuery, FunctionDataQuery, GenericParamsQuery, ImplDataQuery, InternDatabase,\n+    InternDatabaseStorage, LangItemQuery, ModuleLangItemsQuery, RawItemsQuery, StaticDataQuery,\n+    StructDataQuery, TraitDataQuery, TypeAliasDataQuery,\n };\n pub use hir_expand::db::{\n     AstDatabase, AstDatabaseStorage, AstIdMapQuery, MacroArgQuery, MacroDefQuery, MacroExpandQuery,"}, {"sha": "da273eb11559e4999a8075ee27efbf3d794bb216", "filename": "crates/ra_hir_def/src/db.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/15d94cbffcb07fa910d715b2acef88109ae24d39/crates%2Fra_hir_def%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/15d94cbffcb07fa910d715b2acef88109ae24d39/crates%2Fra_hir_def%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fdb.rs?ref=15d94cbffcb07fa910d715b2acef88109ae24d39", "patch": "@@ -3,6 +3,7 @@ use std::sync::Arc;\n \n use hir_expand::{db::AstDatabase, HirFileId};\n use ra_db::{salsa, CrateId, SourceDatabase};\n+use ra_prof::profile;\n use ra_syntax::SmolStr;\n \n use crate::{\n@@ -46,9 +47,12 @@ pub trait DefDatabase: InternDatabase + AstDatabase {\n     #[salsa::invoke(RawItems::raw_items_query)]\n     fn raw_items(&self, file_id: HirFileId) -> Arc<RawItems>;\n \n-    #[salsa::invoke(CrateDefMap::crate_def_map_query)]\n+    #[salsa::transparent]\n     fn crate_def_map(&self, krate: CrateId) -> Arc<CrateDefMap>;\n \n+    #[salsa::invoke(CrateDefMap::compute_crate_def_map_query)]\n+    fn compute_crate_def_map(&self, krate: CrateId) -> Arc<CrateDefMap>;\n+\n     #[salsa::invoke(StructData::struct_data_query)]\n     fn struct_data(&self, id: StructId) -> Arc<StructData>;\n     #[salsa::invoke(StructData::union_data_query)]\n@@ -104,3 +108,8 @@ pub trait DefDatabase: InternDatabase + AstDatabase {\n     #[salsa::invoke(Documentation::documentation_query)]\n     fn documentation(&self, def: AttrDefId) -> Option<Documentation>;\n }\n+\n+fn crate_def_map(db: &impl DefDatabase, krate: CrateId) -> Arc<CrateDefMap> {\n+    let _p = profile(\"crate_def_map\");\n+    db.compute_crate_def_map(krate)\n+}"}, {"sha": "4d210eab12ea2916b0bbeca5525b73b5eb5bc714", "filename": "crates/ra_hir_def/src/nameres.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/15d94cbffcb07fa910d715b2acef88109ae24d39/crates%2Fra_hir_def%2Fsrc%2Fnameres.rs", "raw_url": "https://github.com/rust-lang/rust/raw/15d94cbffcb07fa910d715b2acef88109ae24d39/crates%2Fra_hir_def%2Fsrc%2Fnameres.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fnameres.rs?ref=15d94cbffcb07fa910d715b2acef88109ae24d39", "patch": "@@ -172,13 +172,13 @@ pub struct ModuleData {\n }\n \n impl CrateDefMap {\n-    pub(crate) fn crate_def_map_query(\n+    pub(crate) fn compute_crate_def_map_query(\n         // Note that this doesn't have `+ AstDatabase`!\n         // This gurantess that `CrateDefMap` is stable across reparses.\n         db: &impl DefDatabase,\n         krate: CrateId,\n     ) -> Arc<CrateDefMap> {\n-        let _p = profile(\"crate_def_map_query\");\n+        let _p = profile(\"compute_crate_def_map\");\n         let def_map = {\n             let crate_graph = db.crate_graph();\n             let edition = crate_graph.edition(krate);"}, {"sha": "4585bf522d09b04de4575de126b1b7ba21bfd157", "filename": "crates/ra_ide/src/change.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/15d94cbffcb07fa910d715b2acef88109ae24d39/crates%2Fra_ide%2Fsrc%2Fchange.rs", "raw_url": "https://github.com/rust-lang/rust/raw/15d94cbffcb07fa910d715b2acef88109ae24d39/crates%2Fra_ide%2Fsrc%2Fchange.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fchange.rs?ref=15d94cbffcb07fa910d715b2acef88109ae24d39", "patch": "@@ -309,7 +309,7 @@ impl RootDatabase {\n             hir::db::EnumDataQuery\n             hir::db::TraitDataQuery\n             hir::db::RawItemsQuery\n-            hir::db::CrateDefMapQuery\n+            hir::db::ComputeCrateDefMapQuery\n             hir::db::GenericParamsQuery\n             hir::db::FunctionDataQuery\n             hir::db::TypeAliasDataQuery"}]}