{"sha": "1fdbfa9930d87ed90c77eb2adc4a6f5cce92122d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFmZGJmYTk5MzBkODdlZDkwYzc3ZWIyYWRjNGE2ZjVjY2U5MjEyMmQ=", "commit": {"author": {"name": "Petr Hosek", "email": "phosek@google.com", "date": "2017-09-21T22:36:05Z"}, "committer": {"name": "James Tucker", "email": "jftucker@gmail.com", "date": "2017-09-24T20:55:55Z"}, "message": "Use Zircon's Clang rather than building our own\n\nThis toolchain is already used to build Zircon itself and is the\nofficial Clang toolchain used by all Fuchsia developers.", "tree": {"sha": "529c22fa2d07cf1924097588371b3f315f4dad2b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/529c22fa2d07cf1924097588371b3f315f4dad2b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1fdbfa9930d87ed90c77eb2adc4a6f5cce92122d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1fdbfa9930d87ed90c77eb2adc4a6f5cce92122d", "html_url": "https://github.com/rust-lang/rust/commit/1fdbfa9930d87ed90c77eb2adc4a6f5cce92122d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1fdbfa9930d87ed90c77eb2adc4a6f5cce92122d/comments", "author": {"login": "petrhosek", "id": 283696, "node_id": "MDQ6VXNlcjI4MzY5Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/283696?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrhosek", "html_url": "https://github.com/petrhosek", "followers_url": "https://api.github.com/users/petrhosek/followers", "following_url": "https://api.github.com/users/petrhosek/following{/other_user}", "gists_url": "https://api.github.com/users/petrhosek/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrhosek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrhosek/subscriptions", "organizations_url": "https://api.github.com/users/petrhosek/orgs", "repos_url": "https://api.github.com/users/petrhosek/repos", "events_url": "https://api.github.com/users/petrhosek/events{/privacy}", "received_events_url": "https://api.github.com/users/petrhosek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "raggi", "id": 348, "node_id": "MDQ6VXNlcjM0OA==", "avatar_url": "https://avatars.githubusercontent.com/u/348?v=4", "gravatar_id": "", "url": "https://api.github.com/users/raggi", "html_url": "https://github.com/raggi", "followers_url": "https://api.github.com/users/raggi/followers", "following_url": "https://api.github.com/users/raggi/following{/other_user}", "gists_url": "https://api.github.com/users/raggi/gists{/gist_id}", "starred_url": "https://api.github.com/users/raggi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/raggi/subscriptions", "organizations_url": "https://api.github.com/users/raggi/orgs", "repos_url": "https://api.github.com/users/raggi/repos", "events_url": "https://api.github.com/users/raggi/events{/privacy}", "received_events_url": "https://api.github.com/users/raggi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0ef87cc109bcec982fd86edad5b1ee4cf929eed3", "url": "https://api.github.com/repos/rust-lang/rust/commits/0ef87cc109bcec982fd86edad5b1ee4cf929eed3", "html_url": "https://github.com/rust-lang/rust/commit/0ef87cc109bcec982fd86edad5b1ee4cf929eed3"}], "stats": {"total": 76, "additions": 19, "deletions": 57}, "files": [{"sha": "6f35a53c8ade8eba1a5786bce4c1371c7da4df19", "filename": "src/ci/docker/dist-fuchsia/Dockerfile", "status": "modified", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/1fdbfa9930d87ed90c77eb2adc4a6f5cce92122d/src%2Fci%2Fdocker%2Fdist-fuchsia%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/1fdbfa9930d87ed90c77eb2adc4a6f5cce92122d/src%2Fci%2Fdocker%2Fdist-fuchsia%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-fuchsia%2FDockerfile?ref=1fdbfa9930d87ed90c77eb2adc4a6f5cce92122d", "patch": "@@ -3,24 +3,15 @@ FROM ubuntu:16.04\n RUN apt-get update && apt-get install -y --no-install-recommends \\\n   g++ \\\n   make \\\n-  ninja-build \\\n   file \\\n   curl \\\n   ca-certificates \\\n   python2.7-dev \\\n   git \\\n   sudo \\\n   bzip2 \\\n-  xz-utils \\\n-  swig \\\n-  libedit-dev \\\n-  libncurses5-dev \\\n-  patch \\\n   unzip\n \n-RUN curl -L https://cmake.org/files/v3.9/cmake-3.9.2-Linux-x86_64.tar.gz | \\\n-      tar xzf - -C /usr/local --strip-components=1\n-\n WORKDIR /tmp\n COPY dist-fuchsia/shared.sh dist-fuchsia/build-toolchain.sh /tmp/\n RUN /tmp/build-toolchain.sh"}, {"sha": "105f712ce51ac21d141c9c635bb713128f04c083", "filename": "src/ci/docker/dist-fuchsia/build-toolchain.sh", "status": "modified", "additions": 19, "deletions": 48, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/1fdbfa9930d87ed90c77eb2adc4a6f5cce92122d/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fbuild-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/1fdbfa9930d87ed90c77eb2adc4a6f5cce92122d/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fbuild-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fbuild-toolchain.sh?ref=1fdbfa9930d87ed90c77eb2adc4a6f5cce92122d", "patch": "@@ -14,72 +14,43 @@\n set -ex\n source shared.sh\n \n-# Download sources\n-SRCS=(\n-  \"https://fuchsia.googlesource.com/zircon zircon e9a26dbc70d631029f8ee9763103910b7e3a2fe1\"\n-  \"https://llvm.googlesource.com/llvm llvm 65bdf0ae4a87e6992c24f06e2612909952468710\"\n-  \"https://llvm.googlesource.com/clang llvm/tools/clang 914987de45cf83636537909ce09156aa7a37d6ec\"\n-  \"https://llvm.googlesource.com/clang-tools-extra llvm/tools/clang/tools/extra 83de24124250a7cdc7a0fdc61b7e3c3d64b80225\"\n-  \"https://llvm.googlesource.com/lld llvm/tools/lld f8ed4483c589b390daafac92e28f4680ad052643\"\n-  \"https://llvm.googlesource.com/lldb llvm/tools/lldb 55cf8753321782668cb7e2d879457ee1ad57a2b9\"\n-  \"https://llvm.googlesource.com/compiler-rt llvm/runtimes/compiler-rt a8682fdf74d3cb93769b7394f2cdffc5cefb8bd8\"\n-  \"https://llvm.googlesource.com/libcxx llvm/runtimes/libcxx 5f919fe349450b3da0e29611ae37f6a940179290\"\n-  \"https://llvm.googlesource.com/libcxxabi llvm/runtimes/libcxxabi caa78daf9285dada17e3e6b8aebcf7d128427f83\"\n-  \"https://llvm.googlesource.com/libunwind llvm/runtimes/libunwind 469bacd2ea64679c15bb4d86adf000f2f2c27328\"\n-)\n+ZIRCON=e9a26dbc70d631029f8ee9763103910b7e3a2fe1\n \n-fetch() {\n-  mkdir -p $2\n-  pushd $2 > /dev/null\n-  git init\n-  git remote add origin $1\n-  git fetch --depth=1 origin $3\n-  git reset --hard FETCH_HEAD\n-  popd > /dev/null\n-}\n+mkdir -p zircon\n+pushd zircon > /dev/null\n \n-for i in \"${SRCS[@]}\"; do\n-  fetch $i\n-done\n+# Download sources\n+git init\n+git remote add origin https://fuchsia.googlesource.com/zircon\n+git fetch --depth=1 origin $ZIRCON\n+git reset --hard FETCH_HEAD\n \n-# Build sysroot\n-./zircon/scripts/download-toolchain\n+# Download toolchain\n+./scripts/download-toolchain\n+cp -a prebuilt/downloads/clang+llvm-x86_64-linux/. /usr/local\n \n-build_sysroot() {\n+build() {\n   local arch=\"$1\"\n \n   case \"${arch}\" in\n     x86_64) tgt=\"zircon-pc-x86-64\" ;;\n     aarch64) tgt=\"zircon-qemu-arm64\" ;;\n   esac\n \n-  hide_output make -C zircon -j$(getconf _NPROCESSORS_ONLN) $tgt\n+  hide_output make -j$(getconf _NPROCESSORS_ONLN) $tgt\n   dst=/usr/local/${arch}-unknown-fuchsia\n   mkdir -p $dst\n-  cp -r zircon/build-${tgt}/sysroot/include $dst/\n-  cp -r zircon/build-${tgt}/sysroot/lib $dst/\n+  cp -a build-${tgt}/sysroot/include $dst/\n+  cp -a build-${tgt}/sysroot/lib $dst/\n }\n \n+# Build sysroot\n for arch in x86_64 aarch64; do\n-  build_sysroot ${arch}\n+  build ${arch}\n done\n \n-# Build toolchain\n-cd llvm\n-mkdir build\n-cd build\n-hide_output cmake -GNinja \\\n-  -DFUCHSIA_x86_64_SYSROOT=/usr/local/x86_64-unknown-fuchsia \\\n-  -DFUCHSIA_aarch64_SYSROOT=/usr/local/aarch64-unknown-fuchsia \\\n-  -DLLVM_ENABLE_LTO=OFF \\\n-  -DCLANG_BOOTSTRAP_PASSTHROUGH=LLVM_ENABLE_LTO \\\n-  -C ../tools/clang/cmake/caches/Fuchsia.cmake \\\n-  ..\n-hide_output ninja stage2-distribution\n-hide_output ninja stage2-install-distribution\n-cd ../..\n-\n-rm -rf zircon llvm\n+popd > /dev/null\n+rm -rf zircon\n \n for arch in x86_64 aarch64; do\n   for tool in clang clang++; do"}]}