{"sha": "e75afebeb243538ac85e4cb965bd40582f4c7b59", "node_id": "C_kwDOAAsO6NoAKGU3NWFmZWJlYjI0MzUzOGFjODVlNGNiOTY1YmQ0MDU4MmY0YzdiNTk", "commit": {"author": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-11-11T10:56:47Z"}, "committer": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-11-11T11:31:44Z"}, "message": "Resolve invisible defs in `fix_visibility` assist", "tree": {"sha": "d0b3d16eef87d670909ae19d2d92276b68109606", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d0b3d16eef87d670909ae19d2d92276b68109606"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e75afebeb243538ac85e4cb965bd40582f4c7b59", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEkSbsQIURluxz4rzf4laYqTBYYXEFAmNuMqAACgkQ4laYqTBY\nYXHrAhAAqICMs5wGOlHU96Wbdozp2dHKeP2OOp3qCW0kYVky3Nk5ZgvCfpiyl0Qb\n9zKxvJRnit8M7gOXZZRqnw0qGx2wh9kWdtlzRqVBbqOVXDO549AWXQ+UJ/xqWLE2\nYMvAKMQsoNH4PEkCv6r8fhYqx/J8d4/3HwEeAjbhE6TJOjh9iH1rpl4zTw9ONDNN\n+Uz4BcQyNT+557oL0RFrksgmhbRsXiO9DJtN+fpwMPWZsw+QQL4vB3GitDVq4YZI\nsf9S8cRHAF285wd71pYhGyoKtuEy68gQ+kfyErbOvixQ7btcQgYlecCe0yPBsErZ\nOhyKC7f20CoIRy4bartWhwELJIQ4rm6RwiWcOHE0Vv1VBLem/ifSXoz+VW0mKs20\nTOgUzKAKyOq2EqJkjuruyvAnUR5mP1IYu682oHEYfQThfnLisdJklEnxYDkSf4Gz\nT79E8GqibuUvQRB+zrbIH4gzFIylcfTuy/ff8T/HS7z1RGGwZR2QNoOvUrASFflU\nqYBv+j34BIEB5CZYm8Aoz5A9SUKvw27+aOkOEkZ8ecL1BqcN33xBChdH79+8QOYc\n6H8Oql1cKqzJ2N/6gxhpturda2dq7WAJf9PNINeuPw4dPya7Dko8yc6DEWJWwaJr\nU3LgGP4GgOYM51lRzwLIII3g40AjSoGACePHVO6qB/Mue2ZCoQ0=\n=mFCV\n-----END PGP SIGNATURE-----", "payload": "tree d0b3d16eef87d670909ae19d2d92276b68109606\nparent dea49d082644cb3dbc7755849b6e3c325a6f32d9\nauthor Ryo Yoshida <low.ryoshida@gmail.com> 1668164207 +0900\ncommitter Ryo Yoshida <low.ryoshida@gmail.com> 1668166304 +0900\n\nResolve invisible defs in `fix_visibility` assist\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e75afebeb243538ac85e4cb965bd40582f4c7b59", "html_url": "https://github.com/rust-lang/rust/commit/e75afebeb243538ac85e4cb965bd40582f4c7b59", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e75afebeb243538ac85e4cb965bd40582f4c7b59/comments", "author": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dea49d082644cb3dbc7755849b6e3c325a6f32d9", "url": "https://api.github.com/repos/rust-lang/rust/commits/dea49d082644cb3dbc7755849b6e3c325a6f32d9", "html_url": "https://github.com/rust-lang/rust/commit/dea49d082644cb3dbc7755849b6e3c325a6f32d9"}], "stats": {"total": 24, "additions": 14, "deletions": 10}, "files": [{"sha": "d9e00435ecf5d73e14c0fefbc4e3f62cd7af1eb1", "filename": "crates/ide-assists/src/handlers/fix_visibility.rs", "status": "modified", "additions": 12, "deletions": 8, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/e75afebeb243538ac85e4cb965bd40582f4c7b59/crates%2Fide-assists%2Fsrc%2Fhandlers%2Ffix_visibility.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e75afebeb243538ac85e4cb965bd40582f4c7b59/crates%2Fide-assists%2Fsrc%2Fhandlers%2Ffix_visibility.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Ffix_visibility.rs?ref=e75afebeb243538ac85e4cb965bd40582f4c7b59", "patch": "@@ -1,4 +1,4 @@\n-use hir::{db::HirDatabase, HasSource, HasVisibility, PathResolution};\n+use hir::{db::HirDatabase, HasSource, HasVisibility, ModuleDef, PathResolution, ScopeDef};\n use ide_db::base_db::FileId;\n use syntax::{\n     ast::{self, HasVisibility as _},\n@@ -18,7 +18,7 @@ use crate::{utils::vis_offset, AssistContext, AssistId, AssistKind, Assists};\n //     fn frobnicate() {}\n // }\n // fn main() {\n-//     m::frobnicate$0() {}\n+//     m::frobnicate$0();\n // }\n // ```\n // ->\n@@ -27,7 +27,7 @@ use crate::{utils::vis_offset, AssistContext, AssistId, AssistKind, Assists};\n //     $0pub(crate) fn frobnicate() {}\n // }\n // fn main() {\n-//     m::frobnicate() {}\n+//     m::frobnicate();\n // }\n // ```\n pub(crate) fn fix_visibility(acc: &mut Assists, ctx: &AssistContext<'_>) -> Option<()> {\n@@ -37,11 +37,15 @@ pub(crate) fn fix_visibility(acc: &mut Assists, ctx: &AssistContext<'_>) -> Opti\n \n fn add_vis_to_referenced_module_def(acc: &mut Assists, ctx: &AssistContext<'_>) -> Option<()> {\n     let path: ast::Path = ctx.find_node_at_offset()?;\n-    let path_res = ctx.sema.resolve_path(&path)?;\n-    let def = match path_res {\n-        PathResolution::Def(def) => def,\n-        _ => return None,\n-    };\n+    let qualifier = path.qualifier()?;\n+    let name_ref = path.segment()?.name_ref()?;\n+    let qualifier_res = ctx.sema.resolve_path(&qualifier)?;\n+    let PathResolution::Def(ModuleDef::Module(module)) = qualifier_res else { return None; };\n+    let (_, def) = module\n+        .scope(ctx.db(), None)\n+        .into_iter()\n+        .find(|(name, _)| name.to_smol_str() == name_ref.text().as_str())?;\n+    let ScopeDef::ModuleDef(def) = def else { return None; };\n \n     let current_module = ctx.sema.scope(path.syntax())?.module();\n     let target_module = def.module(ctx.db())?;"}, {"sha": "c09317572acf2b8fb935fd8e8f7ff6d72f4fe0ee", "filename": "crates/ide-assists/src/tests/generated.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e75afebeb243538ac85e4cb965bd40582f4c7b59/crates%2Fide-assists%2Fsrc%2Ftests%2Fgenerated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e75afebeb243538ac85e4cb965bd40582f4c7b59/crates%2Fide-assists%2Fsrc%2Ftests%2Fgenerated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Ftests%2Fgenerated.rs?ref=e75afebeb243538ac85e4cb965bd40582f4c7b59", "patch": "@@ -741,15 +741,15 @@ mod m {\n     fn frobnicate() {}\n }\n fn main() {\n-    m::frobnicate$0() {}\n+    m::frobnicate$0();\n }\n \"#####,\n         r#####\"\n mod m {\n     $0pub(crate) fn frobnicate() {}\n }\n fn main() {\n-    m::frobnicate() {}\n+    m::frobnicate();\n }\n \"#####,\n     )"}]}