{"sha": "e6529c36af56eedf01dc5db29f9f6408f07e97c3", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU2NTI5YzM2YWY1NmVlZGYwMWRjNWRiMjlmOWY2NDA4ZjA3ZTk3YzM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-05-08T08:33:38Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-05-08T08:33:38Z"}, "message": "auto merge of #6307 : brson/rust/rng2, r=brson\n\nCloses #6280", "tree": {"sha": "3355031fb470acc4daffb6807a05e1fb58b5398a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3355031fb470acc4daffb6807a05e1fb58b5398a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e6529c36af56eedf01dc5db29f9f6408f07e97c3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e6529c36af56eedf01dc5db29f9f6408f07e97c3", "html_url": "https://github.com/rust-lang/rust/commit/e6529c36af56eedf01dc5db29f9f6408f07e97c3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e6529c36af56eedf01dc5db29f9f6408f07e97c3/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "625e518ffefaacb95c9bdc0544bc5771cc7a0928", "url": "https://api.github.com/repos/rust-lang/rust/commits/625e518ffefaacb95c9bdc0544bc5771cc7a0928", "html_url": "https://github.com/rust-lang/rust/commit/625e518ffefaacb95c9bdc0544bc5771cc7a0928"}, {"sha": "3b6a32d7c90805dab8c08f6969249ac01bce875a", "url": "https://api.github.com/repos/rust-lang/rust/commits/3b6a32d7c90805dab8c08f6969249ac01bce875a", "html_url": "https://github.com/rust-lang/rust/commit/3b6a32d7c90805dab8c08f6969249ac01bce875a"}], "stats": {"total": 128, "additions": 68, "deletions": 60}, "files": [{"sha": "b83e1d2464890806cf342010cd9200f7bcf36ff5", "filename": "src/libcore/rt/local_services.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Flibcore%2Frt%2Flocal_services.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Flibcore%2Frt%2Flocal_services.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Frt%2Flocal_services.rs?ref=e6529c36af56eedf01dc5db29f9f6408f07e97c3", "patch": "@@ -220,4 +220,13 @@ mod test {\n             assert!(result.is_err());\n         }\n     }\n+\n+    #[test]\n+    fn rng() {\n+        do run_in_newsched_task() {\n+            use rand::{rng, Rng};\n+            let r = rng();\n+            let _ = r.next();\n+        }\n+    }\n }\n\\ No newline at end of file"}, {"sha": "885b40c0a50623ae1533d4cd1b6ec553a7844d23", "filename": "src/rt/rust_builtin.cpp", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Frt%2Frust_builtin.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Frt%2Frust_builtin.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_builtin.cpp?ref=e6529c36af56eedf01dc5db29f9f6408f07e97c3", "patch": "@@ -88,8 +88,7 @@ rand_seed_size() {\n \n extern \"C\" CDECL void\n rand_gen_seed(uint8_t* dest, size_t size) {\n-    rust_task *task = rust_get_current_task();\n-    rng_gen_seed(task->kernel, dest, size);\n+    rng_gen_seed(dest, size);\n }\n \n extern \"C\" CDECL void *\n@@ -101,14 +100,14 @@ rand_new_seeded(uint8_t* seed, size_t seed_size) {\n         task->fail();\n         return NULL;\n     }\n-    rng_init(task->kernel, rng, seed, seed_size);\n+    char *env_seed = task->kernel->env->rust_seed;\n+    rng_init(rng, env_seed, seed, seed_size);\n     return rng;\n }\n \n extern \"C\" CDECL uint32_t\n rand_next(rust_rng *rng) {\n-    rust_task *task = rust_get_current_task();\n-    return rng_gen_u32(task->kernel, rng);\n+    return rng_gen_u32(rng);\n }\n \n extern \"C\" CDECL void"}, {"sha": "bf48554696ebd3760bfb350f134a8d40730f5ab1", "filename": "src/rt/rust_kernel.cpp", "status": "modified", "additions": 0, "deletions": 19, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Frt%2Frust_kernel.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Frt%2Frust_kernel.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_kernel.cpp?ref=e6529c36af56eedf01dc5db29f9f6408f07e97c3", "patch": "@@ -257,25 +257,6 @@ rust_kernel::generate_task_id() {\n     return id;\n }\n \n-#ifdef __WIN32__\n-void\n-rust_kernel::win32_require(LPCTSTR fn, BOOL ok) {\n-    if (!ok) {\n-        LPTSTR buf;\n-        DWORD err = GetLastError();\n-        FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER |\n-                      FORMAT_MESSAGE_FROM_SYSTEM |\n-                      FORMAT_MESSAGE_IGNORE_INSERTS,\n-                      NULL, err,\n-                      MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),\n-                      (LPTSTR) &buf, 0, NULL );\n-        KLOG_ERR_(dom, \"%s failed with error %ld: %s\", fn, err, buf);\n-        LocalFree((HLOCAL)buf);\n-        assert(ok);\n-    }\n-}\n-#endif\n-\n void\n rust_kernel::set_exit_status(int code) {\n     scoped_lock with(rval_lock);"}, {"sha": "4976dec149a0273148b8c3eaeaebbeec84b8052e", "filename": "src/rt/rust_kernel.h", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Frt%2Frust_kernel.h", "raw_url": "https://github.com/rust-lang/rust/raw/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Frt%2Frust_kernel.h", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_kernel.h?ref=e6529c36af56eedf01dc5db29f9f6408f07e97c3", "patch": "@@ -147,10 +147,6 @@ class rust_kernel {\n     void wait_for_schedulers();\n     int run();\n \n-#ifdef __WIN32__\n-    void win32_require(LPCTSTR fn, BOOL ok);\n-#endif\n-\n     rust_task_id generate_task_id();\n \n     void set_exit_status(int code);"}, {"sha": "27015891feebd74ab7932347125ac31fed9fdec6", "filename": "src/rt/rust_rng.cpp", "status": "modified", "additions": 50, "deletions": 26, "changes": 76, "blob_url": "https://github.com/rust-lang/rust/blob/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Frt%2Frust_rng.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Frt%2Frust_rng.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_rng.cpp?ref=e6529c36af56eedf01dc5db29f9f6408f07e97c3", "patch": "@@ -12,6 +12,26 @@\n #include \"rust_rng.h\"\n #include \"rust_util.h\"\n \n+\n+#ifdef __WIN32__\n+void\n+win32_require(LPCTSTR fn, BOOL ok) {\n+    if (!ok) {\n+        LPTSTR buf;\n+        DWORD err = GetLastError();\n+        FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER |\n+                      FORMAT_MESSAGE_FROM_SYSTEM |\n+                      FORMAT_MESSAGE_IGNORE_INSERTS,\n+                      NULL, err,\n+                      MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),\n+                      (LPTSTR) &buf, 0, NULL );\n+        fprintf(stderr, \"%s failed with error %ld: %s\", fn, err, buf);\n+        LocalFree((HLOCAL)buf);\n+        abort();\n+    }\n+}\n+#endif\n+\n size_t\n rng_seed_size() {\n     randctx rctx;\n@@ -21,44 +41,50 @@ rng_seed_size() {\n // Initialization helpers for ISAAC RNG\n \n void\n-rng_gen_seed(rust_kernel* kernel, uint8_t* dest, size_t size) {\n+rng_gen_seed(uint8_t* dest, size_t size) {\n #ifdef __WIN32__\n     HCRYPTPROV hProv;\n-    kernel->win32_require\n+    win32_require\n         (_T(\"CryptAcquireContext\"),\n          CryptAcquireContext(&hProv, NULL, NULL, PROV_RSA_FULL,\n                              CRYPT_VERIFYCONTEXT|CRYPT_SILENT));\n-    kernel->win32_require\n+    win32_require\n         (_T(\"CryptGenRandom\"), CryptGenRandom(hProv, size, (BYTE*) dest));\n-    kernel->win32_require\n+    win32_require\n         (_T(\"CryptReleaseContext\"), CryptReleaseContext(hProv, 0));\n #else\n     int fd = open(\"/dev/urandom\", O_RDONLY);\n-    if (fd == -1)\n-        kernel->fatal(\"error opening /dev/urandom: %s\", strerror(errno));\n+    if (fd == -1) {\n+        fprintf(stderr, \"error opening /dev/urandom: %s\", strerror(errno));\n+        abort();\n+    }\n     size_t amount = 0;\n     do {\n         ssize_t ret = read(fd, dest+amount, size-amount);\n-        if (ret < 0)\n-            kernel->fatal(\"error reading /dev/urandom: %s\", strerror(errno));\n-        else if (ret == 0)\n-            kernel->fatal(\"somehow hit eof reading from /dev/urandom\");\n+        if (ret < 0) {\n+            fprintf(stderr, \"error reading /dev/urandom: %s\", strerror(errno));\n+            abort();\n+        }\n+        else if (ret == 0) {\n+            fprintf(stderr, \"somehow hit eof reading from /dev/urandom\");\n+            abort();\n+        }\n         amount += (size_t)ret;\n     } while (amount < size);\n     int ret = close(fd);\n-    // FIXME #3697: Why does this fail sometimes?\n-    if (ret != 0)\n-        kernel->log(log_warn, \"error closing /dev/urandom: %s\",\n-            strerror(errno));\n+    if (ret != 0) {\n+        fprintf(stderr, \"error closing /dev/urandom: %s\", strerror(errno));\n+        // FIXME #3697: Why does this fail sometimes?\n+        // abort();\n+    }\n #endif\n }\n \n static void\n-isaac_init(rust_kernel *kernel, randctx *rctx,\n+isaac_init(randctx *rctx, char *env_seed,\n            uint8_t* user_seed, size_t seed_len) {\n     memset(rctx, 0, sizeof(randctx));\n \n-    char *env_seed = kernel->env->rust_seed;\n     if (user_seed != NULL) {\n         // ignore bytes after the required length\n         if (seed_len > sizeof(rctx->randrsl)) {\n@@ -72,40 +98,38 @@ isaac_init(rust_kernel *kernel, randctx *rctx,\n             seed = (seed + 0x7ed55d16) + (seed << 12);\n         }\n     } else {\n-        rng_gen_seed(kernel,\n-                     (uint8_t*)&rctx->randrsl,\n+        rng_gen_seed((uint8_t*)&rctx->randrsl,\n                      sizeof(rctx->randrsl));\n     }\n \n     randinit(rctx, 1);\n }\n \n void\n-rng_init(rust_kernel* kernel, rust_rng* rng,\n+rng_init(rust_rng* rng, char* env_seed,\n          uint8_t *user_seed, size_t seed_len) {\n-    isaac_init(kernel, &rng->rctx, user_seed, seed_len);\n-    rng->reseedable = !user_seed && !kernel->env->rust_seed;\n+    isaac_init(&rng->rctx, env_seed, user_seed, seed_len);\n+    rng->reseedable = !user_seed && !env_seed;\n }\n \n static void\n-rng_maybe_reseed(rust_kernel* kernel, rust_rng* rng) {\n+rng_maybe_reseed(rust_rng* rng) {\n     // If this RNG has generated more than 32KB of random data and was not\n     // seeded by the user or RUST_SEED, then we should reseed now.\n     const size_t RESEED_THRESHOLD = 32 * 1024;\n     size_t bytes_generated = rng->rctx.randc * sizeof(ub4);\n     if (bytes_generated < RESEED_THRESHOLD || !rng->reseedable) {\n         return;\n     }\n-    rng_gen_seed(kernel,\n-                 (uint8_t*)rng->rctx.randrsl,\n+    rng_gen_seed((uint8_t*)rng->rctx.randrsl,\n                  sizeof(rng->rctx.randrsl));\n     randinit(&rng->rctx, 1);\n }\n \n uint32_t\n-rng_gen_u32(rust_kernel* kernel, rust_rng* rng) {\n+rng_gen_u32(rust_rng* rng) {\n     uint32_t x = isaac_rand(&rng->rctx);\n-    rng_maybe_reseed(kernel, rng);\n+    rng_maybe_reseed(rng);\n     return x;\n }\n "}, {"sha": "a13b5acd0eff220d0ba06e3ebfd94149586ae6d7", "filename": "src/rt/rust_rng.h", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Frt%2Frust_rng.h", "raw_url": "https://github.com/rust-lang/rust/raw/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Frt%2Frust_rng.h", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_rng.h?ref=e6529c36af56eedf01dc5db29f9f6408f07e97c3", "patch": "@@ -23,11 +23,10 @@ struct rust_rng {\n };\n \n size_t rng_seed_size();\n-void rng_gen_seed(rust_kernel* kernel,\n-                  uint8_t* dest, size_t size);\n-void rng_init(rust_kernel *kernel, rust_rng *rng,\n+void rng_gen_seed(uint8_t* dest, size_t size);\n+void rng_init(rust_rng *rng, char *env_seed,\n               uint8_t *user_seed, size_t seed_len);\n-uint32_t rng_gen_u32(rust_kernel *kernel, rust_rng *rng);\n+uint32_t rng_gen_u32(rust_rng *rng);\n \n //\n // Local Variables:"}, {"sha": "1f718df32aac9bebf5cbc3d71f4742d4441402f6", "filename": "src/rt/rust_sched_loop.cpp", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Frt%2Frust_sched_loop.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/e6529c36af56eedf01dc5db29f9f6408f07e97c3/src%2Frt%2Frust_sched_loop.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_sched_loop.cpp?ref=e6529c36af56eedf01dc5db29f9f6408f07e97c3", "patch": "@@ -43,7 +43,7 @@ rust_sched_loop::rust_sched_loop(rust_scheduler *sched, int id, bool killed) :\n     name(\"main\")\n {\n     LOGPTR(this, \"new dom\", (uintptr_t)this);\n-    rng_init(kernel, &rng, NULL, 0);\n+    rng_init(&rng, kernel->env->rust_seed, NULL, 0);\n \n     if (!tls_initialized)\n         init_tls();\n@@ -154,7 +154,7 @@ rust_sched_loop::schedule_task() {\n     lock.must_have_lock();\n     size_t tasks = running_tasks.length();\n     if (tasks > 0) {\n-        size_t i = (tasks > 1) ? (rng_gen_u32(kernel, &rng) % tasks) : 0;\n+        size_t i = (tasks > 1) ? (rng_gen_u32(&rng) % tasks) : 0;\n         return running_tasks[i];\n     }\n     return NULL;"}]}