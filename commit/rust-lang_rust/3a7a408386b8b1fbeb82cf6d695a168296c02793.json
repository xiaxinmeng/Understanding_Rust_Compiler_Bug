{"sha": "3a7a408386b8b1fbeb82cf6d695a168296c02793", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNhN2E0MDgzODZiOGIxZmJlYjgyY2Y2ZDY5NWExNjgyOTZjMDI3OTM=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2012-03-24T00:51:54Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2012-03-29T23:43:18Z"}, "message": "rt: Free all outstanding boxes at task death", "tree": {"sha": "d4716b29380eb27c3b361bd8ed12a3a22d1aa5d5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d4716b29380eb27c3b361bd8ed12a3a22d1aa5d5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3a7a408386b8b1fbeb82cf6d695a168296c02793", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3a7a408386b8b1fbeb82cf6d695a168296c02793", "html_url": "https://github.com/rust-lang/rust/commit/3a7a408386b8b1fbeb82cf6d695a168296c02793", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3a7a408386b8b1fbeb82cf6d695a168296c02793/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "106c9faa59c1a605d7e0d67da5b45d24863ec009", "url": "https://api.github.com/repos/rust-lang/rust/commits/106c9faa59c1a605d7e0d67da5b45d24863ec009", "html_url": "https://github.com/rust-lang/rust/commit/106c9faa59c1a605d7e0d67da5b45d24863ec009"}], "stats": {"total": 21, "additions": 21, "deletions": 0}, "files": [{"sha": "2eaa784e191d3dab1a8818533c36fdf6e9bababd", "filename": "mk/rt.mk", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3a7a408386b8b1fbeb82cf6d695a168296c02793/mk%2Frt.mk", "raw_url": "https://github.com/rust-lang/rust/raw/3a7a408386b8b1fbeb82cf6d695a168296c02793/mk%2Frt.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Frt.mk?ref=3a7a408386b8b1fbeb82cf6d695a168296c02793", "patch": "@@ -67,6 +67,7 @@ RUNTIME_CS_$(1) := \\\n               rt/rust_abi.cpp \\\n               rt/rust_cc.cpp \\\n               rt/rust_debug.cpp \\\n+              rt/rust_box_annihilator.cpp \\\n               rt/memory_region.cpp \\\n               rt/boxed_region.cpp \\\n               rt/arch/$$(HOST_$(1))/context.cpp"}, {"sha": "29c69aa1766220e9089ad5e7e1e01de054f1c063", "filename": "src/rt/rust_box_annihilator.cpp", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/3a7a408386b8b1fbeb82cf6d695a168296c02793/src%2Frt%2Frust_box_annihilator.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/3a7a408386b8b1fbeb82cf6d695a168296c02793/src%2Frt%2Frust_box_annihilator.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_box_annihilator.cpp?ref=3a7a408386b8b1fbeb82cf6d695a168296c02793", "patch": "@@ -0,0 +1,15 @@\n+#include \"rust_internal.h\"\n+#include \"rust_shape.h\"\n+\n+void\n+annihilate_boxes(rust_task *task) {\n+    LOG(task, gc, \"annihilating boxes for task %p\", task);\n+\n+    boxed_region *boxed = &task->boxed;\n+    rust_opaque_box *box = boxed->first_live_alloc();\n+    while (box != NULL) {\n+        rust_opaque_box *tmp = box;\n+        box = box->next;\n+        boxed->free(tmp);\n+    }\n+}"}, {"sha": "de3069ddf58e43c461d7ca158274c6d69125865a", "filename": "src/rt/rust_task.cpp", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3a7a408386b8b1fbeb82cf6d695a168296c02793/src%2Frt%2Frust_task.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/3a7a408386b8b1fbeb82cf6d695a168296c02793/src%2Frt%2Frust_task.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_task.cpp?ref=3a7a408386b8b1fbeb82cf6d695a168296c02793", "patch": "@@ -87,12 +87,17 @@ struct cleanup_args {\n     bool threw_exception;\n };\n \n+void\n+annihilate_boxes(rust_task *task);\n+\n void\n cleanup_task(cleanup_args *args) {\n     spawn_args *a = args->spargs;\n     bool threw_exception = args->threw_exception;\n     rust_task *task = a->task;\n \n+    cc::do_cc(task);\n+    annihilate_boxes(task);\n     cc::do_final_cc(task);\n \n     task->die();"}]}