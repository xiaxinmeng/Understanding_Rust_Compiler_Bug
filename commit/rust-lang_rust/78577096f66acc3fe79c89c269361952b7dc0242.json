{"sha": "78577096f66acc3fe79c89c269361952b7dc0242", "node_id": "C_kwDOAAsO6NoAKDc4NTc3MDk2ZjY2YWNjM2ZlNzljODljMjY5MzYxOTUyYjdkYzAyNDI", "commit": {"author": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2022-06-15T17:48:52Z"}, "committer": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2022-06-15T17:48:52Z"}, "message": "Add `#[inline]` to small fns of futex `RwLock`\n\nThe important methods like `read` and `write` were already inlined,\nwhich can propagate all the way to inlining in user code, but these\nsmall state functions were left behind as normal calls. They should\nalmost always be inlined as well, as they're just a few instructions.", "tree": {"sha": "c6d5cd5a5eec239d1b6c209f0d3df48e56f84dda", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c6d5cd5a5eec239d1b6c209f0d3df48e56f84dda"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/78577096f66acc3fe79c89c269361952b7dc0242", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/78577096f66acc3fe79c89c269361952b7dc0242", "html_url": "https://github.com/rust-lang/rust/commit/78577096f66acc3fe79c89c269361952b7dc0242", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/78577096f66acc3fe79c89c269361952b7dc0242/comments", "author": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a4cec9742b7e05c33c84cd75002cd56762f7e33b", "url": "https://api.github.com/repos/rust-lang/rust/commits/a4cec9742b7e05c33c84cd75002cd56762f7e33b", "html_url": "https://github.com/rust-lang/rust/commit/a4cec9742b7e05c33c84cd75002cd56762f7e33b"}], "stats": {"total": 9, "additions": 9, "deletions": 0}, "files": [{"sha": "b3bbbf743f84c8ac63302b7a7d63cfae43b3bf4c", "filename": "library/std/src/sys/unix/locks/futex_rwlock.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/78577096f66acc3fe79c89c269361952b7dc0242/library%2Fstd%2Fsrc%2Fsys%2Funix%2Flocks%2Ffutex_rwlock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/78577096f66acc3fe79c89c269361952b7dc0242/library%2Fstd%2Fsrc%2Fsys%2Funix%2Flocks%2Ffutex_rwlock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Flocks%2Ffutex_rwlock.rs?ref=78577096f66acc3fe79c89c269361952b7dc0242", "patch": "@@ -27,22 +27,27 @@ const MAX_READERS: u32 = MASK - 1;\n const READERS_WAITING: u32 = 1 << 30;\n const WRITERS_WAITING: u32 = 1 << 31;\n \n+#[inline]\n fn is_unlocked(state: u32) -> bool {\n     state & MASK == 0\n }\n \n+#[inline]\n fn is_write_locked(state: u32) -> bool {\n     state & MASK == WRITE_LOCKED\n }\n \n+#[inline]\n fn has_readers_waiting(state: u32) -> bool {\n     state & READERS_WAITING != 0\n }\n \n+#[inline]\n fn has_writers_waiting(state: u32) -> bool {\n     state & WRITERS_WAITING != 0\n }\n \n+#[inline]\n fn is_read_lockable(state: u32) -> bool {\n     // This also returns false if the counter could overflow if we tried to read lock it.\n     //\n@@ -53,6 +58,7 @@ fn is_read_lockable(state: u32) -> bool {\n     state & MASK < MAX_READERS && !has_readers_waiting(state) && !has_writers_waiting(state)\n }\n \n+#[inline]\n fn has_reached_max_readers(state: u32) -> bool {\n     state & MASK == MAX_READERS\n }\n@@ -287,6 +293,7 @@ impl RwLock {\n     }\n \n     /// Spin for a while, but stop directly at the given condition.\n+    #[inline]\n     fn spin_until(&self, f: impl Fn(u32) -> bool) -> u32 {\n         let mut spin = 100; // Chosen by fair dice roll.\n         loop {\n@@ -299,11 +306,13 @@ impl RwLock {\n         }\n     }\n \n+    #[inline]\n     fn spin_write(&self) -> u32 {\n         // Stop spinning when it's unlocked or when there's waiting writers, to keep things somewhat fair.\n         self.spin_until(|state| is_unlocked(state) || has_writers_waiting(state))\n     }\n \n+    #[inline]\n     fn spin_read(&self) -> u32 {\n         // Stop spinning when it's unlocked or read locked, or when there's waiting threads.\n         self.spin_until(|state| {"}]}