{"sha": "519799f099a60f293f539578f02ff00c7414f97f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUxOTc5OWYwOTlhNjBmMjkzZjUzOTU3OGYwMmZmMDBjNzQxNGY5N2Y=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-09-11T02:35:01Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-09-11T02:35:01Z"}, "message": "Auto merge of #75800 - Aaron1011:feature/full-nt-tokens, r=petrochenkov\n\nAttach tokens to all AST types used in `Nonterminal`\n\nWe perform token capturing when we have outer attributes (for nonterminals that support attributes - e.g. `Stmt`), or when we parse a `Nonterminal` for a `macro_rules!` argument. The full list of `Nonterminals` affected by this PR is:\n\n* `NtBlock`\n* `NtStmt`\n* `NtTy`\n* `NtMeta`\n* `NtPath`\n* `NtVis`\n* `NtLiteral`\n\nOf these nonterminals, only `NtStmt` and `NtLiteral` (which is actually just an `Expr`), support outer attributes - the rest only ever have token capturing perform when they match a `macro_rules!` argument.\n\nThis makes progress towards solving https://github.com/rust-lang/rust/issues/43081 - we now collect tokens for everything that might need them. However, we still need to handle `#[cfg]`, inner attributes, and misc pretty-printing issues (e.g. #75734)\n\nI've separated the changes into (mostly) independent commits, which could be split into individual PRs for each `Nonterminal` variant. The purpose of having them all in one PR is to do a single Crater run for all of them.\n\nMost of the changes in this PR are trivial (adding `tokens: None` everywhere we construct the various AST structs). The significant changes are:\n\n* `ast::Visibility` is changed from `type Visibility = Spanned<VisibilityKind>` to a `struct Visibility { kind, span, tokens }`.\n* `maybe_collect_tokens` is made generic, and used for both `ast::Expr` and `ast::Stmt`.\n* Some of the statement-parsing functions are refactored so that we can capture the trailing semicolon.\n* `Nonterminal` and `Expr` both grew by 8 bytes, as some of the structs which are stored inline (rather than behind a `P`) now have an `Option<TokenStream>` field. Hopefully the performance impact of doing this is negligible.", "tree": {"sha": "a3f85c58ec8be5e9f4bd09513914887ec41d6590", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a3f85c58ec8be5e9f4bd09513914887ec41d6590"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/519799f099a60f293f539578f02ff00c7414f97f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/519799f099a60f293f539578f02ff00c7414f97f", "html_url": "https://github.com/rust-lang/rust/commit/519799f099a60f293f539578f02ff00c7414f97f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/519799f099a60f293f539578f02ff00c7414f97f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a12828a80a62fbf2ee3e1ffc3b8169a8dc3c2b80", "url": "https://api.github.com/repos/rust-lang/rust/commits/a12828a80a62fbf2ee3e1ffc3b8169a8dc3c2b80", "html_url": "https://github.com/rust-lang/rust/commit/a12828a80a62fbf2ee3e1ffc3b8169a8dc3c2b80"}, {"sha": "8808dc6abf8eeada2934b09f4f4245e57c1d6584", "url": "https://api.github.com/repos/rust-lang/rust/commits/8808dc6abf8eeada2934b09f4f4245e57c1d6584", "html_url": "https://github.com/rust-lang/rust/commit/8808dc6abf8eeada2934b09f4f4245e57c1d6584"}], "stats": {"total": 12, "additions": 6, "deletions": 6}, "files": [{"sha": "67a463538568e9adf619ce3add880796f21c81c4", "filename": "clippy_lints/src/enum_variants.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/519799f099a60f293f539578f02ff00c7414f97f/clippy_lints%2Fsrc%2Fenum_variants.rs", "raw_url": "https://github.com/rust-lang/rust/raw/519799f099a60f293f539578f02ff00c7414f97f/clippy_lints%2Fsrc%2Fenum_variants.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fenum_variants.rs?ref=519799f099a60f293f539578f02ff00c7414f97f", "patch": "@@ -285,7 +285,7 @@ impl EarlyLintPass for EnumVariantNames {\n                             );\n                         }\n                     }\n-                    if item.vis.node.is_pub() {\n+                    if item.vis.kind.is_pub() {\n                         let matching = partial_match(mod_camel, &item_camel);\n                         let rmatching = partial_rmatch(mod_camel, &item_camel);\n                         let nchars = mod_camel.chars().count();\n@@ -316,7 +316,7 @@ impl EarlyLintPass for EnumVariantNames {\n             }\n         }\n         if let ItemKind::Enum(ref def, _) = item.kind {\n-            let lint = match item.vis.node {\n+            let lint = match item.vis.kind {\n                 VisibilityKind::Public => PUB_ENUM_VARIANT_NAMES,\n                 _ => ENUM_VARIANT_NAMES,\n             };"}, {"sha": "9c623821fdddc3cee97deec82fc03398d43d299e", "filename": "clippy_lints/src/manual_non_exhaustive.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/519799f099a60f293f539578f02ff00c7414f97f/clippy_lints%2Fsrc%2Fmanual_non_exhaustive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/519799f099a60f293f539578f02ff00c7414f97f/clippy_lints%2Fsrc%2Fmanual_non_exhaustive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmanual_non_exhaustive.rs?ref=519799f099a60f293f539578f02ff00c7414f97f", "patch": "@@ -122,7 +122,7 @@ fn check_manual_non_exhaustive_enum(cx: &EarlyContext<'_>, item: &Item, variants\n \n fn check_manual_non_exhaustive_struct(cx: &EarlyContext<'_>, item: &Item, data: &VariantData) {\n     fn is_private(field: &StructField) -> bool {\n-        matches!(field.vis.node, VisibilityKind::Inherited)\n+        matches!(field.vis.kind, VisibilityKind::Inherited)\n     }\n \n     fn is_non_exhaustive_marker(field: &StructField) -> bool {\n@@ -141,7 +141,7 @@ fn check_manual_non_exhaustive_struct(cx: &EarlyContext<'_>, item: &Item, data:\n \n     let fields = data.fields();\n     let private_fields = fields.iter().filter(|f| is_private(f)).count();\n-    let public_fields = fields.iter().filter(|f| f.vis.node.is_pub()).count();\n+    let public_fields = fields.iter().filter(|f| f.vis.kind.is_pub()).count();\n \n     if_chain! {\n         if private_fields == 1 && public_fields >= 1 && public_fields == fields.len() - 1;"}, {"sha": "35b38eca14d1be6293e729d4ce3c370d0fef0a8a", "filename": "clippy_lints/src/single_component_path_imports.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/519799f099a60f293f539578f02ff00c7414f97f/clippy_lints%2Fsrc%2Fsingle_component_path_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/519799f099a60f293f539578f02ff00c7414f97f/clippy_lints%2Fsrc%2Fsingle_component_path_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fsingle_component_path_imports.rs?ref=519799f099a60f293f539578f02ff00c7414f97f", "patch": "@@ -41,7 +41,7 @@ impl EarlyLintPass for SingleComponentPathImports {\n         if_chain! {\n             if !in_macro(item.span);\n             if cx.sess.opts.edition == Edition::Edition2018;\n-            if !item.vis.node.is_pub();\n+            if !item.vis.kind.is_pub();\n             if let ItemKind::Use(use_tree) = &item.kind;\n             if let segments = &use_tree.prefix.segments;\n             if segments.len() == 1;"}, {"sha": "0e9feef3746e75c9053e114e5c7fabb0bb0ad42b", "filename": "clippy_lints/src/utils/ast_utils.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/519799f099a60f293f539578f02ff00c7414f97f/clippy_lints%2Fsrc%2Futils%2Fast_utils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/519799f099a60f293f539578f02ff00c7414f97f/clippy_lints%2Fsrc%2Futils%2Fast_utils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fast_utils.rs?ref=519799f099a60f293f539578f02ff00c7414f97f", "patch": "@@ -394,7 +394,7 @@ pub fn eq_defaultness(l: Defaultness, r: Defaultness) -> bool {\n \n pub fn eq_vis(l: &Visibility, r: &Visibility) -> bool {\n     use VisibilityKind::*;\n-    match (&l.node, &r.node) {\n+    match (&l.kind, &r.kind) {\n         (Public, Public) | (Inherited, Inherited) | (Crate(_), Crate(_)) => true,\n         (Restricted { path: l, .. }, Restricted { path: r, .. }) => eq_path(l, r),\n         _ => false,"}]}