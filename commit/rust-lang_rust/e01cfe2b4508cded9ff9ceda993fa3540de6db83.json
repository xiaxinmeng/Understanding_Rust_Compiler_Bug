{"sha": "e01cfe2b4508cded9ff9ceda993fa3540de6db83", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUwMWNmZTJiNDUwOGNkZWQ5ZmY5Y2VkYTk5M2ZhMzU0MGRlNmRiODM=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-08-18T12:27:17Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-08-18T12:29:31Z"}, "message": "Simplify building a symbol hierarchy", "tree": {"sha": "abefcbd4cd1228c49dede098f3f180fe6980f2db", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/abefcbd4cd1228c49dede098f3f180fe6980f2db"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e01cfe2b4508cded9ff9ceda993fa3540de6db83", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e01cfe2b4508cded9ff9ceda993fa3540de6db83", "html_url": "https://github.com/rust-lang/rust/commit/e01cfe2b4508cded9ff9ceda993fa3540de6db83", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e01cfe2b4508cded9ff9ceda993fa3540de6db83/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2252a65f238cac0ebf0c4c56d9b475fa0460d758", "url": "https://api.github.com/repos/rust-lang/rust/commits/2252a65f238cac0ebf0c4c56d9b475fa0460d758", "html_url": "https://github.com/rust-lang/rust/commit/2252a65f238cac0ebf0c4c56d9b475fa0460d758"}], "stats": {"total": 32, "additions": 16, "deletions": 16}, "files": [{"sha": "41c214a4c5dc4ebad78b4b32909e8621a8223552", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 16, "deletions": 16, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/e01cfe2b4508cded9ff9ceda993fa3540de6db83/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e01cfe2b4508cded9ff9ceda993fa3540de6db83/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=e01cfe2b4508cded9ff9ceda993fa3540de6db83", "patch": "@@ -271,24 +271,24 @@ pub(crate) fn handle_document_symbol(\n         };\n         parents.push((doc_symbol, symbol.parent));\n     }\n-    let mut document_symbols = Vec::new();\n-    // Constructs `document_symbols` from `parents`, in order from the end.\n-    while let Some((node, parent)) = parents.pop() {\n-        match parent {\n-            None => document_symbols.push(node),\n-            Some(i) => {\n-                parents[i].0.children.get_or_insert_with(Vec::new).push(node);\n-            }\n-        }\n-    }\n \n-    fn reverse(symbols: &mut Vec<DocumentSymbol>) {\n-        for sym in symbols.iter_mut() {\n-            sym.children.as_mut().map(|c| reverse(c));\n+    // Builds hierarchy from a flat list, in reverse order (so that indices\n+    // makes sense)\n+    let document_symbols = {\n+        let mut acc = Vec::new();\n+        while let Some((mut node, parent_idx)) = parents.pop() {\n+            if let Some(children) = &mut node.children {\n+                children.reverse();\n+            }\n+            let parent = match parent_idx {\n+                None => &mut acc,\n+                Some(i) => parents[i].0.children.get_or_insert_with(Vec::new),\n+            };\n+            parent.push(node);\n         }\n-        symbols.reverse();\n-    }\n-    reverse(&mut document_symbols);\n+        acc.reverse();\n+        acc\n+    };\n \n     let res = if snap.config.client_caps.hierarchical_symbols {\n         document_symbols.into()"}]}