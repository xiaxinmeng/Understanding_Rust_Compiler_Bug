{"sha": "60669cbdfd5d0aa4ed7528e3cddac71047e378ac", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYwNjY5Y2JkZmQ1ZDBhYTRlZDc1MjhlM2NkZGFjNzEwNDdlMzc4YWM=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2018-06-10T09:23:56Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2018-06-10T09:23:56Z"}, "message": "Rustup to rustc 1.28.0-nightly (2a0062974 2018-06-09)", "tree": {"sha": "3d5b7913c100bb22f2fd32941514e3dec3c2a721", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3d5b7913c100bb22f2fd32941514e3dec3c2a721"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/60669cbdfd5d0aa4ed7528e3cddac71047e378ac", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/60669cbdfd5d0aa4ed7528e3cddac71047e378ac", "html_url": "https://github.com/rust-lang/rust/commit/60669cbdfd5d0aa4ed7528e3cddac71047e378ac", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/60669cbdfd5d0aa4ed7528e3cddac71047e378ac/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0755fd64290912f2d77c8e6d210217d407213a8d", "url": "https://api.github.com/repos/rust-lang/rust/commits/0755fd64290912f2d77c8e6d210217d407213a8d", "html_url": "https://github.com/rust-lang/rust/commit/0755fd64290912f2d77c8e6d210217d407213a8d"}], "stats": {"total": 85, "additions": 46, "deletions": 39}, "files": [{"sha": "0fbb46246aea8a8c99d665e1836bbae4ca3d8e09", "filename": "benches/helpers/miri_helper.rs", "status": "modified", "additions": 17, "deletions": 29, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/60669cbdfd5d0aa4ed7528e3cddac71047e378ac/benches%2Fhelpers%2Fmiri_helper.rs", "raw_url": "https://github.com/rust-lang/rust/raw/60669cbdfd5d0aa4ed7528e3cddac71047e378ac/benches%2Fhelpers%2Fmiri_helper.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/benches%2Fhelpers%2Fmiri_helper.rs?ref=60669cbdfd5d0aa4ed7528e3cddac71047e378ac", "patch": "@@ -5,8 +5,7 @@ extern crate rustc_driver;\n extern crate test;\n \n use self::miri::eval_main;\n-use self::rustc::session::Session;\n-use self::rustc_driver::{driver, CompilerCalls, Compilation};\n+use self::rustc_driver::{driver, Compilation};\n use std::cell::RefCell;\n use std::rc::Rc;\n use test::Bencher;\n@@ -36,37 +35,26 @@ pub fn run(filename: &str, bencher: &mut Bencher) {\n         \"--sysroot\".to_string(),\n         find_sysroot(),\n     ];\n-    let compiler_calls = &mut MiriCompilerCalls(Rc::new(RefCell::new(bencher)));\n-    rustc_driver::run_compiler(args, compiler_calls, None, None);\n-}\n-\n-impl<'a> CompilerCalls<'a> for MiriCompilerCalls<'a> {\n-    fn build_controller(\n-        &mut self,\n-        _: &Session,\n-        _: &getopts::Matches,\n-    ) -> driver::CompileController<'a> {\n-        let mut control: driver::CompileController<'a> = driver::CompileController::basic();\n-\n-        let bencher = self.0.clone();\n+    let bencher = RefCell::new(bencher);\n \n-        control.after_analysis.stop = Compilation::Stop;\n-        control.after_analysis.callback = Box::new(move |state| {\n-            state.session.abort_if_errors();\n+    let mut control = driver::CompileController::basic();\n \n-            let tcx = state.tcx.unwrap();\n-            let (entry_node_id, _, _) = state.session.entry_fn.borrow().expect(\n-                \"no main or start function found\",\n-            );\n-            let entry_def_id = tcx.hir.local_def_id(entry_node_id);\n+    control.after_analysis.stop = Compilation::Stop;\n+    control.after_analysis.callback = Box::new(move |state| {\n+        state.session.abort_if_errors();\n \n-            bencher.borrow_mut().iter(|| {\n-                eval_main(tcx, entry_def_id, None);\n-            });\n+        let tcx = state.tcx.unwrap();\n+        let (entry_node_id, _, _) = state.session.entry_fn.borrow().expect(\n+            \"no main or start function found\",\n+        );\n+        let entry_def_id = tcx.hir.local_def_id(entry_node_id);\n \n-            state.session.abort_if_errors();\n+        bencher.borrow_mut().iter(|| {\n+            eval_main(tcx, entry_def_id, None);\n         });\n \n-        control\n-    }\n+        state.session.abort_if_errors();\n+    });\n+\n+    rustc_driver::run_compiler(args, Box::new(control), None, None);\n }"}, {"sha": "35e83d49125e010132b66f2624c0525aadf0a6be", "filename": "src/bin/miri.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/60669cbdfd5d0aa4ed7528e3cddac71047e378ac/src%2Fbin%2Fmiri.rs", "raw_url": "https://github.com/rust-lang/rust/raw/60669cbdfd5d0aa4ed7528e3cddac71047e378ac/src%2Fbin%2Fmiri.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fmiri.rs?ref=60669cbdfd5d0aa4ed7528e3cddac71047e378ac", "patch": "@@ -23,7 +23,7 @@ use syntax::ast;\n use std::path::PathBuf;\n \n struct MiriCompilerCalls {\n-    default: RustcDefaultCalls,\n+    default: Box<RustcDefaultCalls>,\n     /// Whether to begin interpretation at the start_fn lang item or not\n     /// \n     /// If false, the interpretation begins at the `main` function\n@@ -78,13 +78,14 @@ impl<'a> CompilerCalls<'a> for MiriCompilerCalls {\n         self.default.late_callback(codegen_backend, matches, sess, cstore, input, odir, ofile)\n     }\n     fn build_controller(\n-        &mut self,\n+        self: Box<Self>,\n         sess: &Session,\n         matches: &getopts::Matches,\n     ) -> CompileController<'a> {\n-        let mut control = self.default.build_controller(sess, matches);\n+        let this = *self;\n+        let mut control = this.default.build_controller(sess, matches);\n         control.after_hir_lowering.callback = Box::new(after_hir_lowering);\n-        let start_fn = self.start_fn;\n+        let start_fn = this.start_fn;\n         control.after_analysis.callback = Box::new(move |state| after_analysis(state, start_fn));\n         if sess.target.target != sess.host {\n             // only fully compile targets on the host. linking will fail for cross-compilation.\n@@ -234,8 +235,8 @@ fn main() {\n     // Make sure we always have all the MIR (e.g. for auxilary builds in unit tests).\n     args.push(\"-Zalways-encode-mir\".to_owned());\n \n-    rustc_driver::run_compiler(&args, &mut MiriCompilerCalls {\n-        default: RustcDefaultCalls,\n+    rustc_driver::run_compiler(&args, Box::new(MiriCompilerCalls {\n+        default: Box::new(RustcDefaultCalls),\n         start_fn,\n-    }, None, None);\n+    }), None, None);\n }"}, {"sha": "d2ee39dd995a4d1a02a5ad3be131acd4b5584ed0", "filename": "src/lib.rs", "status": "modified", "additions": 21, "deletions": 3, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/60669cbdfd5d0aa4ed7528e3cddac71047e378ac/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/60669cbdfd5d0aa4ed7528e3cddac71047e378ac/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=60669cbdfd5d0aa4ed7528e3cddac71047e378ac", "patch": "@@ -24,6 +24,7 @@ use rustc::ty::layout::{TyLayout, LayoutOf, Size};\n use rustc::ty::subst::Subst;\n use rustc::hir::def_id::DefId;\n use rustc::mir;\n+use rustc::middle::const_val;\n \n use syntax::ast::Mutability;\n use syntax::codemap::Span;\n@@ -253,9 +254,26 @@ pub fn eval_main<'a, 'tcx: 'a>(\n                 //tcx.sess.err(\"the evaluated program leaked memory\");\n             }\n         }\n-        Err(mut e) => {\n-            ecx.tcx.sess.err(&e.to_string());\n-            ecx.report(&mut e, true, None);\n+        Err(e) => {\n+            if let Some(frame) = ecx.stack().last() {\n+                let block = &frame.mir.basic_blocks()[frame.block];\n+                let span = if frame.stmt < block.statements.len() {\n+                    block.statements[frame.stmt].source_info.span\n+                } else {\n+                    block.terminator().source_info.span\n+                };\n+\n+                let mut err = const_val::struct_error(ecx.tcx.tcx.at(span), \"constant evaluation error\");\n+                let (frames, span) = ecx.generate_stacktrace(None);\n+                err.span_label(span, e.to_string());\n+                for const_val::FrameInfo { span, location, .. } in frames {\n+                    err.span_note(span, &format!(\"inside call to `{}`\", location));\n+                }\n+                err.emit();\n+            } else {\n+                ecx.tcx.sess.err(&e.to_string());\n+            }\n+\n             for (i, frame) in ecx.stack().iter().enumerate() {\n                 trace!(\"-------------------\");\n                 trace!(\"Frame {}\", i);"}]}