{"sha": "37e80c529772aec176d93a33ee5a2fec3ab8e45d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM3ZTgwYzUyOTc3MmFlYzE3NmQ5M2EzM2VlNWEyZmVjM2FiOGU0NWQ=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-06-01T19:11:38Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-06-01T19:13:24Z"}, "message": "show macro expanded trees in the stats as well", "tree": {"sha": "6bb668dd8184fac575be43ed50d3c49f6021110f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6bb668dd8184fac575be43ed50d3c49f6021110f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/37e80c529772aec176d93a33ee5a2fec3ab8e45d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/37e80c529772aec176d93a33ee5a2fec3ab8e45d", "html_url": "https://github.com/rust-lang/rust/commit/37e80c529772aec176d93a33ee5a2fec3ab8e45d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/37e80c529772aec176d93a33ee5a2fec3ab8e45d/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ccec71165bf1f8f79bd2d2a5c05bed55ff3a07a2", "url": "https://api.github.com/repos/rust-lang/rust/commits/ccec71165bf1f8f79bd2d2a5c05bed55ff3a07a2", "html_url": "https://github.com/rust-lang/rust/commit/ccec71165bf1f8f79bd2d2a5c05bed55ff3a07a2"}], "stats": {"total": 15, "additions": 8, "deletions": 7}, "files": [{"sha": "822279812c0b84deb103c5462ee2cee4419d33eb", "filename": "crates/ra_ide_api/src/status.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/37e80c529772aec176d93a33ee5a2fec3ab8e45d/crates%2Fra_ide_api%2Fsrc%2Fstatus.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37e80c529772aec176d93a33ee5a2fec3ab8e45d/crates%2Fra_ide_api%2Fsrc%2Fstatus.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fstatus.rs?ref=37e80c529772aec176d93a33ee5a2fec3ab8e45d", "patch": "@@ -4,19 +4,20 @@ use std::{\n     sync::Arc,\n };\n \n-use ra_syntax::{AstNode, Parse};\n+use ra_syntax::{TreeArc, SyntaxNode};\n use ra_db::{\n-    ParseQuery, FileTextQuery, SourceRootId,\n+    FileTextQuery, SourceRootId,\n     salsa::{Database, debug::{DebugQueryTable, TableEntry}},\n };\n+use hir::HirFileId;\n \n use crate::{\n     FileId, db::RootDatabase,\n     symbol_index::{SymbolIndex, LibrarySymbolsQuery},\n };\n \n pub(crate) fn syntax_tree_stats(db: &RootDatabase) -> SyntaxTreeStats {\n-    db.query(ParseQuery).entries::<SyntaxTreeStats>()\n+    db.query(hir::db::ParseOrExpandQuery).entries::<SyntaxTreeStats>()\n }\n \n pub(crate) fn status(db: &RootDatabase) -> String {\n@@ -72,17 +73,17 @@ impl fmt::Display for SyntaxTreeStats {\n     }\n }\n \n-impl FromIterator<TableEntry<FileId, Parse>> for SyntaxTreeStats {\n+impl FromIterator<TableEntry<HirFileId, Option<TreeArc<SyntaxNode>>>> for SyntaxTreeStats {\n     fn from_iter<T>(iter: T) -> SyntaxTreeStats\n     where\n-        T: IntoIterator<Item = TableEntry<FileId, Parse>>,\n+        T: IntoIterator<Item = TableEntry<HirFileId, Option<TreeArc<SyntaxNode>>>>,\n     {\n         let mut res = SyntaxTreeStats::default();\n         for entry in iter {\n             res.total += 1;\n-            if let Some(value) = entry.value {\n+            if let Some(tree) = entry.value.and_then(|it| it) {\n                 res.retained += 1;\n-                res.retained_size += value.tree.syntax().memory_size_of_subtree();\n+                res.retained_size += tree.memory_size_of_subtree();\n             }\n         }\n         res"}]}