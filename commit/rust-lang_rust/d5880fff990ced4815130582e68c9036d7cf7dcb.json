{"sha": "d5880fff990ced4815130582e68c9036d7cf7dcb", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ1ODgwZmZmOTkwY2VkNDgxNTEzMDU4MmU2OGM5MDM2ZDdjZjdkY2I=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-03-13T19:24:42Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-03-13T19:24:42Z"}, "message": "Auto merge of #32227 - jseyfried:fix_import_resolution_bug, r=alexcrichton\n\nFix import resolution bug\n\nThis fixes #32222, which was introduced in #31726.", "tree": {"sha": "69d9be53e412592c284570dbf6684bc069072301", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/69d9be53e412592c284570dbf6684bc069072301"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d5880fff990ced4815130582e68c9036d7cf7dcb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d5880fff990ced4815130582e68c9036d7cf7dcb", "html_url": "https://github.com/rust-lang/rust/commit/d5880fff990ced4815130582e68c9036d7cf7dcb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d5880fff990ced4815130582e68c9036d7cf7dcb/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ce943eb369c9bdd0aef4917675e515f39f3b4a1e", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce943eb369c9bdd0aef4917675e515f39f3b4a1e", "html_url": "https://github.com/rust-lang/rust/commit/ce943eb369c9bdd0aef4917675e515f39f3b4a1e"}, {"sha": "d1020143b67a55d3c5733f735f82bd683b0e35be", "url": "https://api.github.com/repos/rust-lang/rust/commits/d1020143b67a55d3c5733f735f82bd683b0e35be", "html_url": "https://github.com/rust-lang/rust/commit/d1020143b67a55d3c5733f735f82bd683b0e35be"}], "stats": {"total": 83, "additions": 61, "deletions": 22}, "files": [{"sha": "c2b665b3b4ca1097b97fb8e5c581dd734a5d6382", "filename": "src/librustc_resolve/resolve_imports.rs", "status": "modified", "additions": 27, "deletions": 22, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/d5880fff990ced4815130582e68c9036d7cf7dcb/src%2Flibrustc_resolve%2Fresolve_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5880fff990ced4815130582e68c9036d7cf7dcb/src%2Flibrustc_resolve%2Fresolve_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fresolve_imports.rs?ref=d5880fff990ced4815130582e68c9036d7cf7dcb", "patch": "@@ -176,6 +176,25 @@ impl<'a> NameResolution<'a> {\n         }\n     }\n \n+    fn increment_outstanding_references(&mut self, is_public: bool) {\n+        self.outstanding_references += 1;\n+        if is_public {\n+            self.pub_outstanding_references += 1;\n+        }\n+    }\n+\n+    fn decrement_outstanding_references(&mut self, is_public: bool) {\n+        let decrement_references = |count: &mut _| {\n+            assert!(*count > 0);\n+            *count -= 1;\n+        };\n+\n+        decrement_references(&mut self.outstanding_references);\n+        if is_public {\n+            decrement_references(&mut self.pub_outstanding_references);\n+        }\n+    }\n+\n     fn report_conflicts<F: FnMut(&NameBinding, &NameBinding)>(&self, mut report: F) {\n         let binding = match self.binding {\n             Some(binding) => binding,\n@@ -253,26 +272,8 @@ impl<'a> ::ModuleS<'a> {\n     }\n \n     pub fn increment_outstanding_references_for(&self, name: Name, ns: Namespace, is_public: bool) {\n-        let mut resolutions = self.resolutions.borrow_mut();\n-        let resolution = resolutions.entry((name, ns)).or_insert_with(Default::default);\n-        resolution.outstanding_references += 1;\n-        if is_public {\n-            resolution.pub_outstanding_references += 1;\n-        }\n-    }\n-\n-    fn decrement_outstanding_references_for(&self, name: Name, ns: Namespace, is_public: bool) {\n-        let decrement_references = |count: &mut _| {\n-            assert!(*count > 0);\n-            *count -= 1;\n-        };\n-\n-        self.update_resolution(name, ns, |resolution| {\n-            decrement_references(&mut resolution.outstanding_references);\n-            if is_public {\n-                decrement_references(&mut resolution.pub_outstanding_references);\n-            }\n-        })\n+        self.resolutions.borrow_mut().entry((name, ns)).or_insert_with(Default::default)\n+            .increment_outstanding_references(is_public);\n     }\n \n     // Use `update` to mutate the resolution for the name.\n@@ -477,7 +478,8 @@ impl<'a, 'b:'a, 'tcx:'b> ImportResolver<'a, 'b, 'tcx> {\n                 // Temporarily count the directive as determined so that the resolution fails\n                 // (as opposed to being indeterminate) when it can only be defined by the directive.\n                 if !determined {\n-                    module_.decrement_outstanding_references_for(target, ns, directive.is_public)\n+                    module_.resolutions.borrow_mut().get_mut(&(target, ns)).unwrap()\n+                           .decrement_outstanding_references(directive.is_public);\n                 }\n                 let result =\n                     self.resolver.resolve_name_in_module(target_module, source, ns, false, true);\n@@ -514,7 +516,10 @@ impl<'a, 'b:'a, 'tcx:'b> ImportResolver<'a, 'b, 'tcx> {\n                     self.report_conflict(target, ns, &directive.import(binding, None), old_binding);\n                 }\n             }\n-            module_.decrement_outstanding_references_for(target, ns, directive.is_public);\n+\n+            module_.update_resolution(target, ns, |resolution| {\n+                resolution.decrement_outstanding_references(directive.is_public);\n+            })\n         }\n \n         match (&value_result, &type_result) {"}, {"sha": "b3b34f4b0efda37b4096eabfef8ceaeaf6bef729", "filename": "src/test/compile-fail/issue-32222.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/d5880fff990ced4815130582e68c9036d7cf7dcb/src%2Ftest%2Fcompile-fail%2Fissue-32222.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5880fff990ced4815130582e68c9036d7cf7dcb/src%2Ftest%2Fcompile-fail%2Fissue-32222.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-32222.rs?ref=d5880fff990ced4815130582e68c9036d7cf7dcb", "patch": "@@ -0,0 +1,34 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(rustc_attrs)]\n+#![allow(warnings)]\n+\n+mod foo {\n+    pub fn bar() {}\n+}\n+\n+pub use foo::*;\n+use b::bar;\n+\n+mod foobar {\n+    use super::*;\n+}\n+\n+mod a {\n+    pub mod bar {}\n+}\n+\n+mod b {\n+    pub use a::bar;\n+}\n+\n+#[rustc_error]\n+fn main() {} //~ ERROR compilation successful"}]}