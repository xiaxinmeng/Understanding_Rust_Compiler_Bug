{"sha": "d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ0ZWUxYzkzZmYyNWE3ZmE2ZjVlMzVkYzc3NGE2NDhhN2U2ZDU3OGU=", "commit": {"author": {"name": "Tom Tromey", "email": "tom@tromey.com", "date": "2018-11-21T18:35:49Z"}, "committer": {"name": "Tom Tromey", "email": "tom@tromey.com", "date": "2018-11-21T21:07:22Z"}, "message": "Fix BTreeSet and BTreeMap gdb pretty-printers\n\nThe BTreeSet and BTreeMap gdb pretty-printers did not take the node\nstructure into account, and consequently only worked for shallow sets.\nThis fixes the problem by iterating over child nodes when needed.\n\nThis patch avoids the current approach of implementing some of the\nvalue manipulations in debugger-indepdendent code.  This was done for\nconvenience: a type lookup was needed for the first time, and there\ncurrently are no lldb formatters for these types.\n\nCloses #55771", "tree": {"sha": "4eefee4a88ef0518f5160fc70d545840a50d18a2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4eefee4a88ef0518f5160fc70d545840a50d18a2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e", "html_url": "https://github.com/rust-lang/rust/commit/d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e/comments", "author": {"login": "tromey", "id": 1557670, "node_id": "MDQ6VXNlcjE1NTc2NzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tromey", "html_url": "https://github.com/tromey", "followers_url": "https://api.github.com/users/tromey/followers", "following_url": "https://api.github.com/users/tromey/following{/other_user}", "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}", "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tromey/subscriptions", "organizations_url": "https://api.github.com/users/tromey/orgs", "repos_url": "https://api.github.com/users/tromey/repos", "events_url": "https://api.github.com/users/tromey/events{/privacy}", "received_events_url": "https://api.github.com/users/tromey/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tromey", "id": 1557670, "node_id": "MDQ6VXNlcjE1NTc2NzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tromey", "html_url": "https://github.com/tromey", "followers_url": "https://api.github.com/users/tromey/followers", "following_url": "https://api.github.com/users/tromey/following{/other_user}", "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}", "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tromey/subscriptions", "organizations_url": "https://api.github.com/users/tromey/orgs", "repos_url": "https://api.github.com/users/tromey/repos", "events_url": "https://api.github.com/users/tromey/events{/privacy}", "received_events_url": "https://api.github.com/users/tromey/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "15e661328198540e35670138f485bbc06a866464", "url": "https://api.github.com/repos/rust-lang/rust/commits/15e661328198540e35670138f485bbc06a866464", "html_url": "https://github.com/rust-lang/rust/commit/15e661328198540e35670138f485bbc06a866464"}], "stats": {"total": 113, "additions": 50, "deletions": 63}, "files": [{"sha": "b99e401929e62f643ea33b281af2dc5253ccb4d3", "filename": "src/etc/debugger_pretty_printers_common.py", "status": "modified", "additions": 0, "deletions": 26, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e/src%2Fetc%2Fdebugger_pretty_printers_common.py", "raw_url": "https://github.com/rust-lang/rust/raw/d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e/src%2Fetc%2Fdebugger_pretty_printers_common.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fdebugger_pretty_printers_common.py?ref=d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e", "patch": "@@ -375,32 +375,6 @@ def extract_tail_head_ptr_and_cap_from_std_vecdeque(vec_val):\n     assert data_ptr.type.get_dwarf_type_kind() == DWARF_TYPE_CODE_PTR\n     return (tail, head, data_ptr, capacity)\n \n-\n-def extract_length_and_ptr_from_std_btreeset(vec_val):\n-    assert vec_val.type.get_type_kind() == TYPE_KIND_STD_BTREESET\n-    map = vec_val.get_child_at_index(0)\n-    root = map.get_child_at_index(0)\n-    length = map.get_child_at_index(1).as_integer()\n-    node = root.get_child_at_index(0)\n-    ptr = node.get_child_at_index(0)\n-    unique_ptr_val = ptr.get_child_at_index(0)\n-    data_ptr = unique_ptr_val.get_child_at_index(0)\n-    assert data_ptr.type.get_dwarf_type_kind() == DWARF_TYPE_CODE_PTR\n-    return (length, data_ptr)\n-\n-\n-def extract_length_and_ptr_from_std_btreemap(vec_val):\n-    assert vec_val.type.get_type_kind() == TYPE_KIND_STD_BTREEMAP\n-    root = vec_val.get_child_at_index(0)\n-    length = vec_val.get_child_at_index(1).as_integer()\n-    node = root.get_child_at_index(0)\n-    ptr = node.get_child_at_index(0)\n-    unique_ptr_val = ptr.get_child_at_index(0)\n-    data_ptr = unique_ptr_val.get_child_at_index(0)\n-    assert data_ptr.type.get_dwarf_type_kind() == DWARF_TYPE_CODE_PTR\n-    return (length, data_ptr)\n-\n-\n def extract_length_and_ptr_from_slice(slice_val):\n     assert (slice_val.type.get_type_kind() == TYPE_KIND_SLICE or\n             slice_val.type.get_type_kind() == TYPE_KIND_STR_SLICE)"}, {"sha": "11e46e8c54cc9552db54c2e760fb39e42ab34d59", "filename": "src/etc/gdb_rust_pretty_printing.py", "status": "modified", "additions": 41, "deletions": 29, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e/src%2Fetc%2Fgdb_rust_pretty_printing.py", "raw_url": "https://github.com/rust-lang/rust/raw/d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e/src%2Fetc%2Fgdb_rust_pretty_printing.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fgdb_rust_pretty_printing.py?ref=d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e", "patch": "@@ -304,6 +304,32 @@ def children(self):\n             yield (str(index), (gdb_ptr + index).dereference())\n \n \n+# Yield each key (and optionally value) from a BoxedNode.\n+def children_of_node(boxed_node, height, want_values):\n+    ptr = boxed_node['ptr']['pointer']\n+    # This is written oddly because we don't want to rely on the field name being `__0`.\n+    node_ptr = ptr[ptr.type.fields()[0]]\n+    if height > 0:\n+        type_name = str(node_ptr.type.target()).replace('LeafNode', 'InternalNode')\n+        node_type = gdb.lookup_type(type_name)\n+        node_ptr = node_ptr.cast(node_type.pointer())\n+        leaf = node_ptr['data']\n+    else:\n+        leaf = node_ptr.dereference()\n+    keys = leaf['keys']['value']['value']\n+    if want_values:\n+        values = leaf['vals']['value']['value']\n+    length = int(leaf['len'])\n+    for i in xrange(0, length + 1):\n+        if height > 0:\n+            for child in children_of_node(node_ptr['edges'][i], height - 1, want_values):\n+                yield child\n+        if i < length:\n+            if want_values:\n+                yield (keys[i], values[i])\n+            else:\n+                yield keys[i]\n+\n class RustStdBTreeSetPrinter(object):\n     def __init__(self, val):\n         self.__val = val\n@@ -313,21 +339,16 @@ def display_hint():\n         return \"array\"\n \n     def to_string(self):\n-        (length, data_ptr) = \\\n-            rustpp.extract_length_and_ptr_from_std_btreeset(self.__val)\n         return (self.__val.type.get_unqualified_type_name() +\n-                (\"(len: %i)\" % length))\n+                (\"(len: %i)\" % self.__val.get_wrapped_value()['map']['length']))\n \n     def children(self):\n-        (length, data_ptr) = \\\n-            rustpp.extract_length_and_ptr_from_std_btreeset(self.__val)\n-        leaf_node = GdbValue(data_ptr.get_wrapped_value().dereference())\n-        maybe_uninit_keys = leaf_node.get_child_at_index(3)\n-        manually_drop_keys = maybe_uninit_keys.get_child_at_index(1)\n-        keys = manually_drop_keys.get_child_at_index(0)\n-        gdb_ptr = keys.get_wrapped_value()\n-        for index in xrange(length):\n-            yield (str(index), gdb_ptr[index])\n+        root = self.__val.get_wrapped_value()['map']['root']\n+        node_ptr = root['node']\n+        i = 0\n+        for child in children_of_node(node_ptr, root['height'], False):\n+            yield (str(i), child)\n+            i = i + 1\n \n \n class RustStdBTreeMapPrinter(object):\n@@ -339,26 +360,17 @@ def display_hint():\n         return \"map\"\n \n     def to_string(self):\n-        (length, data_ptr) = \\\n-            rustpp.extract_length_and_ptr_from_std_btreemap(self.__val)\n         return (self.__val.type.get_unqualified_type_name() +\n-                (\"(len: %i)\" % length))\n+                (\"(len: %i)\" % self.__val.get_wrapped_value()['length']))\n \n     def children(self):\n-        (length, data_ptr) = \\\n-            rustpp.extract_length_and_ptr_from_std_btreemap(self.__val)\n-        leaf_node = GdbValue(data_ptr.get_wrapped_value().dereference())\n-        maybe_uninit_keys = leaf_node.get_child_at_index(3)\n-        manually_drop_keys = maybe_uninit_keys.get_child_at_index(1)\n-        keys = manually_drop_keys.get_child_at_index(0)\n-        keys_ptr = keys.get_wrapped_value()\n-        maybe_uninit_vals = leaf_node.get_child_at_index(4)\n-        manually_drop_vals = maybe_uninit_vals.get_child_at_index(1)\n-        vals = manually_drop_vals.get_child_at_index(0)\n-        vals_ptr = vals.get_wrapped_value()\n-        for index in xrange(length):\n-            yield (str(index), keys_ptr[index])\n-            yield (str(index), vals_ptr[index])\n+        root = self.__val.get_wrapped_value()['root']\n+        node_ptr = root['node']\n+        i = 0\n+        for child in children_of_node(node_ptr, root['height'], True):\n+            yield (str(i), child[0])\n+            yield (str(i), child[1])\n+            i = i + 1\n \n \n class RustStdStringPrinter(object):"}, {"sha": "55e20d67276cd9233fdee249c99e181495391287", "filename": "src/test/debuginfo/pretty-std-collections.rs", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e/src%2Ftest%2Fdebuginfo%2Fpretty-std-collections.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e/src%2Ftest%2Fdebuginfo%2Fpretty-std-collections.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fdebuginfo%2Fpretty-std-collections.rs?ref=d4ee1c93ff25a7fa6f5e35dc774a648a7e6d578e", "patch": "@@ -8,6 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+// ignore-tidy-linelength\n // ignore-windows failing on win32 bot\n // ignore-freebsd: gdb package too new\n // ignore-android: FIXME(#10381)\n@@ -20,10 +21,10 @@\n // gdb-command: run\n \n // gdb-command: print btree_set\n-// gdb-check:$1 = BTreeSet<i32>(len: 3) = {3, 5, 7}\n+// gdb-check:$1 = BTreeSet<i32>(len: 15) = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14}\n \n // gdb-command: print btree_map\n-// gdb-check:$2 = BTreeMap<i32, i32>(len: 3) = {[3] = 3, [5] = 7, [7] = 4}\n+// gdb-check:$2 = BTreeMap<i32, i32>(len: 15) = {[0] = 0, [1] = 1, [2] = 2, [3] = 3, [4] = 4, [5] = 5, [6] = 6, [7] = 7, [8] = 8, [9] = 9, [10] = 10, [11] = 11, [12] = 12, [13] = 13, [14] = 14}\n \n // gdb-command: print vec_deque\n // gdb-check:$3 = VecDeque<i32>(len: 3, cap: 8) = {5, 3, 7}\n@@ -38,15 +39,15 @@ fn main() {\n \n     // BTreeSet\n     let mut btree_set = BTreeSet::new();\n-    btree_set.insert(5);\n-    btree_set.insert(3);\n-    btree_set.insert(7);\n+    for i in 0..15 {\n+        btree_set.insert(i);\n+    }\n \n     // BTreeMap\n     let mut btree_map = BTreeMap::new();\n-    btree_map.insert(5, 7);\n-    btree_map.insert(3, 3);\n-    btree_map.insert(7, 4);\n+    for i in 0..15 {\n+        btree_map.insert(i, i);\n+    }\n \n     // VecDeque\n     let mut vec_deque = VecDeque::new();"}]}