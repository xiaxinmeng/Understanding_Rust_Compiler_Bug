{"sha": "8c135eecac6277a1e2b899db898d2a93c78c4a03", "node_id": "C_kwDOAAsO6NoAKDhjMTM1ZWVjYWM2Mjc3YTFlMmI4OTlkYjg5OGQyYTkzYzc4YzRhMDM", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2023-02-24T06:32:40Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-24T06:32:40Z"}, "message": "Rollup merge of #106541 - fee1-dead-contrib:no-const-check-no, r=thomcc\n\nimplement const iterator using `rustc_do_not_const_check`\n\nPrevious experiment: #102225.\n\nExplanation: rather than making all default methods work under `const` all at once, this uses `rustc_do_not_const_check` as a workaround to \"trick\" the compiler to not run any checks on those other default methods. Any const implementations are only required to implement the `next` method. Any actual calls to the trait methods other than `next` will either error in compile time (at CTFE runs), or run the methods correctly if they do not have any non-const operations. This is extremely easy to maintain, remove, or improve.", "tree": {"sha": "5faa82c3af8411192833110bf49cb13cef2bf7c6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5faa82c3af8411192833110bf49cb13cef2bf7c6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8c135eecac6277a1e2b899db898d2a93c78c4a03", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj+FoICRBK7hj4Ov3rIwAANpwIAA+V2muDfjnuOngQh1Sh3wcg\nDBWp5sn1yDQHUVnLko19bmfptiArM9HZbPiUx4mbq8hAsKIQcxd2nGzYTZKkFhfq\nIV2koZW9yrdpwxH+j1xKB624DAOjm6fxSE/A4z1chKU+NkGXhqkZsE1GcmElAggW\nF1TXiVVrddpEZeSfdbzQZtBZL8mYGS/BNSEDv87z/yjJEt0pzNbZ8evJJf1JUZpv\nzfuq44d5z5gQOHLFU+RDrbFlhqgRlTh4YQNm2GcDvI80EMAREtm6cbI7jxGy4unV\nNfCcf+H/UWf6FIs1WPtG5rYIm8gm93fUtXEmO5kXxXvz5oK7U5dJNCV1j9EmN+8=\n=WLby\n-----END PGP SIGNATURE-----\n", "payload": "tree 5faa82c3af8411192833110bf49cb13cef2bf7c6\nparent 07c993eba8b76eae497e98433ae075b00f01be10\nparent 3aeb43cb788c455cb7817bb8dcd7a752cf052240\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1677220360 +0530\ncommitter GitHub <noreply@github.com> 1677220360 +0530\n\nRollup merge of #106541 - fee1-dead-contrib:no-const-check-no, r=thomcc\n\nimplement const iterator using `rustc_do_not_const_check`\n\nPrevious experiment: #102225.\n\nExplanation: rather than making all default methods work under `const` all at once, this uses `rustc_do_not_const_check` as a workaround to \"trick\" the compiler to not run any checks on those other default methods. Any const implementations are only required to implement the `next` method. Any actual calls to the trait methods other than `next` will either error in compile time (at CTFE runs), or run the methods correctly if they do not have any non-const operations. This is extremely easy to maintain, remove, or improve.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8c135eecac6277a1e2b899db898d2a93c78c4a03", "html_url": "https://github.com/rust-lang/rust/commit/8c135eecac6277a1e2b899db898d2a93c78c4a03", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8c135eecac6277a1e2b899db898d2a93c78c4a03/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "07c993eba8b76eae497e98433ae075b00f01be10", "url": "https://api.github.com/repos/rust-lang/rust/commits/07c993eba8b76eae497e98433ae075b00f01be10", "html_url": "https://github.com/rust-lang/rust/commit/07c993eba8b76eae497e98433ae075b00f01be10"}, {"sha": "3aeb43cb788c455cb7817bb8dcd7a752cf052240", "url": "https://api.github.com/repos/rust-lang/rust/commits/3aeb43cb788c455cb7817bb8dcd7a752cf052240", "html_url": "https://github.com/rust-lang/rust/commit/3aeb43cb788c455cb7817bb8dcd7a752cf052240"}], "stats": {"total": 175, "additions": 166, "deletions": 9}, "files": [{"sha": "91fd8fad73c7b1647be76c025324a931b01d0e84", "filename": "compiler/rustc_hir_typeck/src/lib.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/8c135eecac6277a1e2b899db898d2a93c78c4a03/compiler%2Frustc_hir_typeck%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c135eecac6277a1e2b899db898d2a93c78c4a03/compiler%2Frustc_hir_typeck%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Flib.rs?ref=8c135eecac6277a1e2b899db898d2a93c78c4a03", "patch": "@@ -71,7 +71,7 @@ use rustc_middle::ty::{self, Ty, TyCtxt};\n use rustc_session::config;\n use rustc_session::Session;\n use rustc_span::def_id::{DefId, LocalDefId};\n-use rustc_span::Span;\n+use rustc_span::{sym, Span};\n \n fluent_messages! { \"../locales/en-US.ftl\" }\n \n@@ -207,6 +207,11 @@ fn typeck_with_fallback<'tcx>(\n \n     let typeck_results = Inherited::build(tcx, def_id).enter(|inh| {\n         let param_env = tcx.param_env(def_id);\n+        let param_env = if tcx.has_attr(def_id.to_def_id(), sym::rustc_do_not_const_check) {\n+            param_env.without_const()\n+        } else {\n+            param_env\n+        };\n         let mut fcx = FnCtxt::new(&inh, param_env, def_id);\n \n         if let Some(hir::FnSig { header, decl, .. }) = fn_sig {"}, {"sha": "b3a630d9559952f79d55e7ea2a95d5224ec19255", "filename": "library/core/src/iter/traits/iterator.rs", "status": "modified", "additions": 76, "deletions": 0, "changes": 76, "blob_url": "https://github.com/rust-lang/rust/blob/8c135eecac6277a1e2b899db898d2a93c78c4a03/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fiterator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c135eecac6277a1e2b899db898d2a93c78c4a03/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fiterator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fiterator.rs?ref=8c135eecac6277a1e2b899db898d2a93c78c4a03", "patch": "@@ -69,6 +69,7 @@ fn _assert_is_object_safe(_: &dyn Iterator<Item = ()>) {}\n #[doc(notable_trait)]\n #[rustc_diagnostic_item = \"Iterator\"]\n #[must_use = \"iterators are lazy and do nothing unless consumed\"]\n+#[cfg_attr(not(bootstrap), const_trait)]\n pub trait Iterator {\n     /// The type of the elements being iterated over.\n     #[rustc_diagnostic_item = \"IteratorItem\"]\n@@ -141,6 +142,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[unstable(feature = \"iter_next_chunk\", reason = \"recently added\", issue = \"98326\")]\n+    #[rustc_do_not_const_check]\n     fn next_chunk<const N: usize>(\n         &mut self,\n     ) -> Result<[Self::Item; N], array::IntoIter<Self::Item, N>>\n@@ -218,6 +220,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn size_hint(&self) -> (usize, Option<usize>) {\n         (0, None)\n     }\n@@ -255,6 +258,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn count(self) -> usize\n     where\n         Self: Sized,\n@@ -285,6 +289,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn last(self) -> Option<Self::Item>\n     where\n         Self: Sized,\n@@ -331,6 +336,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[unstable(feature = \"iter_advance_by\", reason = \"recently added\", issue = \"77404\")]\n+    #[rustc_do_not_const_check]\n     fn advance_by(&mut self, n: usize) -> Result<(), usize> {\n         for i in 0..n {\n             self.next().ok_or(i)?;\n@@ -379,6 +385,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn nth(&mut self, n: usize) -> Option<Self::Item> {\n         self.advance_by(n).ok()?;\n         self.next()\n@@ -431,6 +438,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"iterator_step_by\", since = \"1.28.0\")]\n+    #[rustc_do_not_const_check]\n     fn step_by(self, step: usize) -> StepBy<Self>\n     where\n         Self: Sized,\n@@ -502,6 +510,7 @@ pub trait Iterator {\n     /// [`OsStr`]: ../../std/ffi/struct.OsStr.html\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn chain<U>(self, other: U) -> Chain<Self, U::IntoIter>\n     where\n         Self: Sized,\n@@ -620,6 +629,7 @@ pub trait Iterator {\n     /// [`zip`]: crate::iter::zip\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn zip<U>(self, other: U) -> Zip<Self, U::IntoIter>\n     where\n         Self: Sized,\n@@ -662,6 +672,7 @@ pub trait Iterator {\n     /// [`intersperse_with`]: Iterator::intersperse_with\n     #[inline]\n     #[unstable(feature = \"iter_intersperse\", reason = \"recently added\", issue = \"79524\")]\n+    #[rustc_do_not_const_check]\n     fn intersperse(self, separator: Self::Item) -> Intersperse<Self>\n     where\n         Self: Sized,\n@@ -720,6 +731,7 @@ pub trait Iterator {\n     /// [`intersperse`]: Iterator::intersperse\n     #[inline]\n     #[unstable(feature = \"iter_intersperse\", reason = \"recently added\", issue = \"79524\")]\n+    #[rustc_do_not_const_check]\n     fn intersperse_with<G>(self, separator: G) -> IntersperseWith<Self, G>\n     where\n         Self: Sized,\n@@ -779,6 +791,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn map<B, F>(self, f: F) -> Map<Self, F>\n     where\n         Self: Sized,\n@@ -824,6 +837,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"iterator_for_each\", since = \"1.21.0\")]\n+    #[rustc_do_not_const_check]\n     fn for_each<F>(self, f: F)\n     where\n         Self: Sized,\n@@ -899,6 +913,7 @@ pub trait Iterator {\n     /// Note that `iter.filter(f).next()` is equivalent to `iter.find(f)`.\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn filter<P>(self, predicate: P) -> Filter<Self, P>\n     where\n         Self: Sized,\n@@ -944,6 +959,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn filter_map<B, F>(self, f: F) -> FilterMap<Self, F>\n     where\n         Self: Sized,\n@@ -990,6 +1006,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn enumerate(self) -> Enumerate<Self>\n     where\n         Self: Sized,\n@@ -1061,6 +1078,7 @@ pub trait Iterator {\n     /// [`next`]: Iterator::next\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn peekable(self) -> Peekable<Self>\n     where\n         Self: Sized,\n@@ -1126,6 +1144,7 @@ pub trait Iterator {\n     #[inline]\n     #[doc(alias = \"drop_while\")]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn skip_while<P>(self, predicate: P) -> SkipWhile<Self, P>\n     where\n         Self: Sized,\n@@ -1207,6 +1226,7 @@ pub trait Iterator {\n     /// the iteration should stop, but wasn't placed back into the iterator.\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn take_while<P>(self, predicate: P) -> TakeWhile<Self, P>\n     where\n         Self: Sized,\n@@ -1295,6 +1315,7 @@ pub trait Iterator {\n     /// [`fuse`]: Iterator::fuse\n     #[inline]\n     #[stable(feature = \"iter_map_while\", since = \"1.57.0\")]\n+    #[rustc_do_not_const_check]\n     fn map_while<B, P>(self, predicate: P) -> MapWhile<Self, P>\n     where\n         Self: Sized,\n@@ -1326,6 +1347,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn skip(self, n: usize) -> Skip<Self>\n     where\n         Self: Sized,\n@@ -1379,6 +1401,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn take(self, n: usize) -> Take<Self>\n     where\n         Self: Sized,\n@@ -1428,6 +1451,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn scan<St, B, F>(self, initial_state: St, f: F) -> Scan<Self, St, F>\n     where\n         Self: Sized,\n@@ -1468,6 +1492,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn flat_map<U, F>(self, f: F) -> FlatMap<Self, U, F>\n     where\n         Self: Sized,\n@@ -1552,6 +1577,7 @@ pub trait Iterator {\n     /// [`flat_map()`]: Iterator::flat_map\n     #[inline]\n     #[stable(feature = \"iterator_flatten\", since = \"1.29.0\")]\n+    #[rustc_do_not_const_check]\n     fn flatten(self) -> Flatten<Self>\n     where\n         Self: Sized,\n@@ -1620,6 +1646,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn fuse(self) -> Fuse<Self>\n     where\n         Self: Sized,\n@@ -1704,6 +1731,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn inspect<F>(self, f: F) -> Inspect<Self, F>\n     where\n         Self: Sized,\n@@ -1734,6 +1762,7 @@ pub trait Iterator {\n     /// assert_eq!(of_rust, vec![\"of\", \"Rust\"]);\n     /// ```\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn by_ref(&mut self) -> &mut Self\n     where\n         Self: Sized,\n@@ -1853,6 +1882,7 @@ pub trait Iterator {\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     #[must_use = \"if you really need to exhaust the iterator, consider `.for_each(drop)` instead\"]\n     #[cfg_attr(not(test), rustc_diagnostic_item = \"iterator_collect_fn\")]\n+    #[rustc_do_not_const_check]\n     fn collect<B: FromIterator<Self::Item>>(self) -> B\n     where\n         Self: Sized,\n@@ -1931,6 +1961,7 @@ pub trait Iterator {\n     /// [`collect`]: Iterator::collect\n     #[inline]\n     #[unstable(feature = \"iterator_try_collect\", issue = \"94047\")]\n+    #[rustc_do_not_const_check]\n     fn try_collect<B>(&mut self) -> ChangeOutputType<Self::Item, B>\n     where\n         Self: Sized,\n@@ -2004,6 +2035,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[unstable(feature = \"iter_collect_into\", reason = \"new API\", issue = \"94780\")]\n+    #[rustc_do_not_const_check]\n     fn collect_into<E: Extend<Self::Item>>(self, collection: &mut E) -> &mut E\n     where\n         Self: Sized,\n@@ -2038,6 +2070,7 @@ pub trait Iterator {\n     /// assert_eq!(odd, vec![1, 3]);\n     /// ```\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn partition<B, F>(self, f: F) -> (B, B)\n     where\n         Self: Sized,\n@@ -2100,6 +2133,7 @@ pub trait Iterator {\n     /// assert!(a[i..].iter().all(|&n| n % 2 == 1)); // odds\n     /// ```\n     #[unstable(feature = \"iter_partition_in_place\", reason = \"new API\", issue = \"62543\")]\n+    #[rustc_do_not_const_check]\n     fn partition_in_place<'a, T: 'a, P>(mut self, ref mut predicate: P) -> usize\n     where\n         Self: Sized + DoubleEndedIterator<Item = &'a mut T>,\n@@ -2157,6 +2191,7 @@ pub trait Iterator {\n     /// assert!(!\"IntoIterator\".chars().is_partitioned(char::is_uppercase));\n     /// ```\n     #[unstable(feature = \"iter_is_partitioned\", reason = \"new API\", issue = \"62544\")]\n+    #[rustc_do_not_const_check]\n     fn is_partitioned<P>(mut self, mut predicate: P) -> bool\n     where\n         Self: Sized,\n@@ -2251,6 +2286,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"iterator_try_fold\", since = \"1.27.0\")]\n+    #[rustc_do_not_const_check]\n     fn try_fold<B, F, R>(&mut self, init: B, mut f: F) -> R\n     where\n         Self: Sized,\n@@ -2309,6 +2345,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"iterator_try_fold\", since = \"1.27.0\")]\n+    #[rustc_do_not_const_check]\n     fn try_for_each<F, R>(&mut self, f: F) -> R\n     where\n         Self: Sized,\n@@ -2428,6 +2465,7 @@ pub trait Iterator {\n     #[doc(alias = \"inject\", alias = \"foldl\")]\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn fold<B, F>(mut self, init: B, mut f: F) -> B\n     where\n         Self: Sized,\n@@ -2465,6 +2503,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"iterator_fold_self\", since = \"1.51.0\")]\n+    #[rustc_do_not_const_check]\n     fn reduce<F>(mut self, f: F) -> Option<Self::Item>\n     where\n         Self: Sized,\n@@ -2536,6 +2575,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[unstable(feature = \"iterator_try_reduce\", reason = \"new API\", issue = \"87053\")]\n+    #[rustc_do_not_const_check]\n     fn try_reduce<F, R>(&mut self, f: F) -> ChangeOutputType<R, Option<R::Output>>\n     where\n         Self: Sized,\n@@ -2593,6 +2633,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn all<F>(&mut self, f: F) -> bool\n     where\n         Self: Sized,\n@@ -2646,6 +2687,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn any<F>(&mut self, f: F) -> bool\n     where\n         Self: Sized,\n@@ -2709,6 +2751,7 @@ pub trait Iterator {\n     /// Note that `iter.find(f)` is equivalent to `iter.filter(f).next()`.\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn find<P>(&mut self, predicate: P) -> Option<Self::Item>\n     where\n         Self: Sized,\n@@ -2740,6 +2783,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"iterator_find_map\", since = \"1.30.0\")]\n+    #[rustc_do_not_const_check]\n     fn find_map<B, F>(&mut self, f: F) -> Option<B>\n     where\n         Self: Sized,\n@@ -2796,6 +2840,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[unstable(feature = \"try_find\", reason = \"new API\", issue = \"63178\")]\n+    #[rustc_do_not_const_check]\n     fn try_find<F, R>(&mut self, f: F) -> ChangeOutputType<R, Option<Self::Item>>\n     where\n         Self: Sized,\n@@ -2878,6 +2923,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn position<P>(&mut self, predicate: P) -> Option<usize>\n     where\n         Self: Sized,\n@@ -2935,6 +2981,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn rposition<P>(&mut self, predicate: P) -> Option<usize>\n     where\n         P: FnMut(Self::Item) -> bool,\n@@ -2986,6 +3033,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn max(self) -> Option<Self::Item>\n     where\n         Self: Sized,\n@@ -3024,6 +3072,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn min(self) -> Option<Self::Item>\n     where\n         Self: Sized,\n@@ -3046,6 +3095,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"iter_cmp_by_key\", since = \"1.6.0\")]\n+    #[rustc_do_not_const_check]\n     fn max_by_key<B: Ord, F>(self, f: F) -> Option<Self::Item>\n     where\n         Self: Sized,\n@@ -3079,6 +3129,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"iter_max_by\", since = \"1.15.0\")]\n+    #[rustc_do_not_const_check]\n     fn max_by<F>(self, compare: F) -> Option<Self::Item>\n     where\n         Self: Sized,\n@@ -3106,6 +3157,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"iter_cmp_by_key\", since = \"1.6.0\")]\n+    #[rustc_do_not_const_check]\n     fn min_by_key<B: Ord, F>(self, f: F) -> Option<Self::Item>\n     where\n         Self: Sized,\n@@ -3139,6 +3191,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"iter_min_by\", since = \"1.15.0\")]\n+    #[rustc_do_not_const_check]\n     fn min_by<F>(self, compare: F) -> Option<Self::Item>\n     where\n         Self: Sized,\n@@ -3176,6 +3229,7 @@ pub trait Iterator {\n     #[inline]\n     #[doc(alias = \"reverse\")]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn rev(self) -> Rev<Self>\n     where\n         Self: Sized + DoubleEndedIterator,\n@@ -3214,6 +3268,7 @@ pub trait Iterator {\n     /// assert_eq!(z, [3, 6]);\n     /// ```\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn unzip<A, B, FromA, FromB>(self) -> (FromA, FromB)\n     where\n         FromA: Default + Extend<A>,\n@@ -3246,6 +3301,7 @@ pub trait Iterator {\n     /// assert_eq!(v_map, vec![1, 2, 3]);\n     /// ```\n     #[stable(feature = \"iter_copied\", since = \"1.36.0\")]\n+    #[rustc_do_not_const_check]\n     fn copied<'a, T: 'a>(self) -> Copied<Self>\n     where\n         Self: Sized + Iterator<Item = &'a T>,\n@@ -3293,6 +3349,7 @@ pub trait Iterator {\n     /// assert_eq!(&[vec![23]], &faster[..]);\n     /// ```\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_do_not_const_check]\n     fn cloned<'a, T: 'a>(self) -> Cloned<Self>\n     where\n         Self: Sized + Iterator<Item = &'a T>,\n@@ -3327,6 +3384,7 @@ pub trait Iterator {\n     /// ```\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     #[inline]\n+    #[rustc_do_not_const_check]\n     fn cycle(self) -> Cycle<Self>\n     where\n         Self: Sized + Clone,\n@@ -3370,6 +3428,7 @@ pub trait Iterator {\n     /// ```\n     #[track_caller]\n     #[unstable(feature = \"iter_array_chunks\", reason = \"recently added\", issue = \"100450\")]\n+    #[rustc_do_not_const_check]\n     fn array_chunks<const N: usize>(self) -> ArrayChunks<Self, N>\n     where\n         Self: Sized,\n@@ -3400,6 +3459,7 @@ pub trait Iterator {\n     /// assert_eq!(sum, 6);\n     /// ```\n     #[stable(feature = \"iter_arith\", since = \"1.11.0\")]\n+    #[rustc_do_not_const_check]\n     fn sum<S>(self) -> S\n     where\n         Self: Sized,\n@@ -3429,6 +3489,7 @@ pub trait Iterator {\n     /// assert_eq!(factorial(5), 120);\n     /// ```\n     #[stable(feature = \"iter_arith\", since = \"1.11.0\")]\n+    #[rustc_do_not_const_check]\n     fn product<P>(self) -> P\n     where\n         Self: Sized,\n@@ -3450,6 +3511,7 @@ pub trait Iterator {\n     /// assert_eq!([1, 2].iter().cmp([1].iter()), Ordering::Greater);\n     /// ```\n     #[stable(feature = \"iter_order\", since = \"1.5.0\")]\n+    #[rustc_do_not_const_check]\n     fn cmp<I>(self, other: I) -> Ordering\n     where\n         I: IntoIterator<Item = Self::Item>,\n@@ -3479,6 +3541,7 @@ pub trait Iterator {\n     /// assert_eq!(xs.iter().cmp_by(&ys, |&x, &y| (2 * x).cmp(&y)), Ordering::Greater);\n     /// ```\n     #[unstable(feature = \"iter_order_by\", issue = \"64295\")]\n+    #[rustc_do_not_const_check]\n     fn cmp_by<I, F>(self, other: I, cmp: F) -> Ordering\n     where\n         Self: Sized,\n@@ -3535,6 +3598,7 @@ pub trait Iterator {\n     /// ```\n     ///\n     #[stable(feature = \"iter_order\", since = \"1.5.0\")]\n+    #[rustc_do_not_const_check]\n     fn partial_cmp<I>(self, other: I) -> Option<Ordering>\n     where\n         I: IntoIterator,\n@@ -3573,6 +3637,7 @@ pub trait Iterator {\n     /// );\n     /// ```\n     #[unstable(feature = \"iter_order_by\", issue = \"64295\")]\n+    #[rustc_do_not_const_check]\n     fn partial_cmp_by<I, F>(self, other: I, partial_cmp: F) -> Option<Ordering>\n     where\n         Self: Sized,\n@@ -3606,6 +3671,7 @@ pub trait Iterator {\n     /// assert_eq!([1].iter().eq([1, 2].iter()), false);\n     /// ```\n     #[stable(feature = \"iter_order\", since = \"1.5.0\")]\n+    #[rustc_do_not_const_check]\n     fn eq<I>(self, other: I) -> bool\n     where\n         I: IntoIterator,\n@@ -3631,6 +3697,7 @@ pub trait Iterator {\n     /// assert!(xs.iter().eq_by(&ys, |&x, &y| x * x == y));\n     /// ```\n     #[unstable(feature = \"iter_order_by\", issue = \"64295\")]\n+    #[rustc_do_not_const_check]\n     fn eq_by<I, F>(self, other: I, eq: F) -> bool\n     where\n         Self: Sized,\n@@ -3663,6 +3730,7 @@ pub trait Iterator {\n     /// assert_eq!([1].iter().ne([1, 2].iter()), true);\n     /// ```\n     #[stable(feature = \"iter_order\", since = \"1.5.0\")]\n+    #[rustc_do_not_const_check]\n     fn ne<I>(self, other: I) -> bool\n     where\n         I: IntoIterator,\n@@ -3684,6 +3752,7 @@ pub trait Iterator {\n     /// assert_eq!([1, 2].iter().lt([1, 2].iter()), false);\n     /// ```\n     #[stable(feature = \"iter_order\", since = \"1.5.0\")]\n+    #[rustc_do_not_const_check]\n     fn lt<I>(self, other: I) -> bool\n     where\n         I: IntoIterator,\n@@ -3705,6 +3774,7 @@ pub trait Iterator {\n     /// assert_eq!([1, 2].iter().le([1, 2].iter()), true);\n     /// ```\n     #[stable(feature = \"iter_order\", since = \"1.5.0\")]\n+    #[rustc_do_not_const_check]\n     fn le<I>(self, other: I) -> bool\n     where\n         I: IntoIterator,\n@@ -3726,6 +3796,7 @@ pub trait Iterator {\n     /// assert_eq!([1, 2].iter().gt([1, 2].iter()), false);\n     /// ```\n     #[stable(feature = \"iter_order\", since = \"1.5.0\")]\n+    #[rustc_do_not_const_check]\n     fn gt<I>(self, other: I) -> bool\n     where\n         I: IntoIterator,\n@@ -3747,6 +3818,7 @@ pub trait Iterator {\n     /// assert_eq!([1, 2].iter().ge([1, 2].iter()), true);\n     /// ```\n     #[stable(feature = \"iter_order\", since = \"1.5.0\")]\n+    #[rustc_do_not_const_check]\n     fn ge<I>(self, other: I) -> bool\n     where\n         I: IntoIterator,\n@@ -3778,6 +3850,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[unstable(feature = \"is_sorted\", reason = \"new API\", issue = \"53485\")]\n+    #[rustc_do_not_const_check]\n     fn is_sorted(self) -> bool\n     where\n         Self: Sized,\n@@ -3806,6 +3879,7 @@ pub trait Iterator {\n     ///\n     /// [`is_sorted`]: Iterator::is_sorted\n     #[unstable(feature = \"is_sorted\", reason = \"new API\", issue = \"53485\")]\n+    #[rustc_do_not_const_check]\n     fn is_sorted_by<F>(mut self, compare: F) -> bool\n     where\n         Self: Sized,\n@@ -3852,6 +3926,7 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[unstable(feature = \"is_sorted\", reason = \"new API\", issue = \"53485\")]\n+    #[rustc_do_not_const_check]\n     fn is_sorted_by_key<F, K>(self, f: F) -> bool\n     where\n         Self: Sized,\n@@ -3867,6 +3942,7 @@ pub trait Iterator {\n     #[inline]\n     #[doc(hidden)]\n     #[unstable(feature = \"trusted_random_access\", issue = \"none\")]\n+    #[rustc_do_not_const_check]\n     unsafe fn __iterator_get_unchecked(&mut self, _idx: usize) -> Self::Item\n     where\n         Self: TrustedRandomAccessNoCoerce,"}, {"sha": "d3727a824b5a062e19463d9c278fef8740043a94", "filename": "library/core/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8c135eecac6277a1e2b899db898d2a93c78c4a03/library%2Fcore%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c135eecac6277a1e2b899db898d2a93c78c4a03/library%2Fcore%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Flib.rs?ref=8c135eecac6277a1e2b899db898d2a93c78c4a03", "patch": "@@ -194,6 +194,7 @@\n #![feature(cfg_target_has_atomic_equal_alignment)]\n #![feature(const_closures)]\n #![feature(const_fn_floating_point_arithmetic)]\n+#![feature(const_for)]\n #![feature(const_mut_refs)]\n #![feature(const_precise_live_drops)]\n #![feature(const_refs_to_cell)]"}, {"sha": "be7e70dfabba76b69765e435f699d2ebbaabc459", "filename": "tests/ui/consts/gate-do-not-const-check.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/8c135eecac6277a1e2b899db898d2a93c78c4a03/tests%2Fui%2Fconsts%2Fgate-do-not-const-check.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c135eecac6277a1e2b899db898d2a93c78c4a03/tests%2Fui%2Fconsts%2Fgate-do-not-const-check.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconsts%2Fgate-do-not-const-check.rs?ref=8c135eecac6277a1e2b899db898d2a93c78c4a03", "patch": "@@ -0,0 +1,5 @@\n+#[rustc_do_not_const_check]\n+//~^ ERROR this is an internal attribute that will never be stable\n+const fn foo() {}\n+\n+fn main() {}"}, {"sha": "3bb1360166a19fba12bb2ba25b66418ebc699a6d", "filename": "tests/ui/consts/gate-do-not-const-check.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/8c135eecac6277a1e2b899db898d2a93c78c4a03/tests%2Fui%2Fconsts%2Fgate-do-not-const-check.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8c135eecac6277a1e2b899db898d2a93c78c4a03/tests%2Fui%2Fconsts%2Fgate-do-not-const-check.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconsts%2Fgate-do-not-const-check.stderr?ref=8c135eecac6277a1e2b899db898d2a93c78c4a03", "patch": "@@ -0,0 +1,11 @@\n+error[E0658]: this is an internal attribute that will never be stable\n+  --> $DIR/gate-do-not-const-check.rs:1:1\n+   |\n+LL | #[rustc_do_not_const_check]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: add `#![feature(rustc_attrs)]` to the crate attributes to enable\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0658`."}, {"sha": "730e268c09124802794e5f5d656edab3d1823f3c", "filename": "tests/ui/rfc-2632-const-trait-impl/do-not-const-check-override.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/8c135eecac6277a1e2b899db898d2a93c78c4a03/tests%2Fui%2Frfc-2632-const-trait-impl%2Fdo-not-const-check-override.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c135eecac6277a1e2b899db898d2a93c78c4a03/tests%2Fui%2Frfc-2632-const-trait-impl%2Fdo-not-const-check-override.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frfc-2632-const-trait-impl%2Fdo-not-const-check-override.rs?ref=8c135eecac6277a1e2b899db898d2a93c78c4a03", "patch": "@@ -0,0 +1,19 @@\n+// check-pass\n+#![feature(const_trait_impl, rustc_attrs)]\n+\n+#[const_trait]\n+trait Foo {\n+    #[rustc_do_not_const_check]\n+    fn into_iter(&self) { println!(\"FEAR ME!\") }\n+}\n+\n+\n+impl const Foo for () {\n+    fn into_iter(&self) {\n+        // ^_^\n+    }\n+}\n+\n+const _: () = Foo::into_iter(&());\n+\n+fn main() {}"}, {"sha": "3c39c53de5f0a4a537d97cdd26fe5343bcc9b869", "filename": "tests/ui/rfc-2632-const-trait-impl/do-not-const-check.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/8c135eecac6277a1e2b899db898d2a93c78c4a03/tests%2Fui%2Frfc-2632-const-trait-impl%2Fdo-not-const-check.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c135eecac6277a1e2b899db898d2a93c78c4a03/tests%2Fui%2Frfc-2632-const-trait-impl%2Fdo-not-const-check.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frfc-2632-const-trait-impl%2Fdo-not-const-check.rs?ref=8c135eecac6277a1e2b899db898d2a93c78c4a03", "patch": "@@ -0,0 +1,18 @@\n+// check-pass\n+#![feature(const_trait_impl, rustc_attrs)]\n+\n+#[const_trait]\n+trait IntoIter {\n+    fn into_iter(self);\n+}\n+\n+#[const_trait]\n+trait Hmm: Sized {\n+    #[rustc_do_not_const_check]\n+    fn chain<U>(self, other: U) where U: IntoIter,\n+    {\n+        other.into_iter()\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "a450dbb82d1bdf4fabf4b5229100a810104badd8", "filename": "tests/ui/typeck/typeck_type_placeholder_item.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8c135eecac6277a1e2b899db898d2a93c78c4a03/tests%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c135eecac6277a1e2b899db898d2a93c78c4a03/tests%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.rs?ref=8c135eecac6277a1e2b899db898d2a93c78c4a03", "patch": "@@ -227,4 +227,6 @@ fn evens_squared(n: usize) -> _ {\n }\n \n const _: _ = (1..10).filter(|x| x % 2 == 0).map(|x| x * x);\n-//~^ ERROR the placeholder `_` is not allowed within types on item signatures for constants\n+//~^ ERROR the trait bound\n+//~| ERROR the trait bound\n+//~| ERROR the placeholder"}, {"sha": "bc6c9fd077993a172ee6525d570693a0eb4e0826", "filename": "tests/ui/typeck/typeck_type_placeholder_item.stderr", "status": "modified", "additions": 27, "deletions": 7, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/8c135eecac6277a1e2b899db898d2a93c78c4a03/tests%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8c135eecac6277a1e2b899db898d2a93c78c4a03/tests%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.stderr?ref=8c135eecac6277a1e2b899db898d2a93c78c4a03", "patch": "@@ -437,17 +437,37 @@ LL | fn evens_squared(n: usize) -> _ {\n    |                               not allowed in type signatures\n    |                               help: replace with an appropriate return type: `impl Iterator<Item = usize>`\n \n-error[E0121]: the placeholder `_` is not allowed within types on item signatures for constants\n-  --> $DIR/typeck_type_placeholder_item.rs:229:10\n+error[E0277]: the trait bound `std::ops::Range<{integer}>: Iterator` is not satisfied\n+  --> $DIR/typeck_type_placeholder_item.rs:229:22\n    |\n LL | const _: _ = (1..10).filter(|x| x % 2 == 0).map(|x| x * x);\n-   |          ^ not allowed in type signatures\n+   |                      ^^^^^^ `std::ops::Range<{integer}>` is not an iterator\n+   |\n+   = help: the trait `~const Iterator` is not implemented for `std::ops::Range<{integer}>`\n+note: the trait `Iterator` is implemented for `std::ops::Range<{integer}>`, but that implementation is not `const`\n+  --> $DIR/typeck_type_placeholder_item.rs:229:14\n+   |\n+LL | const _: _ = (1..10).filter(|x| x % 2 == 0).map(|x| x * x);\n+   |              ^^^^^^^\n+\n+error[E0277]: the trait bound `Filter<std::ops::Range<{integer}>, [closure@$DIR/typeck_type_placeholder_item.rs:229:29: 229:32]>: Iterator` is not satisfied\n+  --> $DIR/typeck_type_placeholder_item.rs:229:45\n    |\n-note: however, the inferred type `Map<Filter<Range<i32>, [closure@typeck_type_placeholder_item.rs:229:29]>, [closure@typeck_type_placeholder_item.rs:229:49]>` cannot be named\n+LL | const _: _ = (1..10).filter(|x| x % 2 == 0).map(|x| x * x);\n+   |                                             ^^^ `Filter<std::ops::Range<{integer}>, [closure@$DIR/typeck_type_placeholder_item.rs:229:29: 229:32]>` is not an iterator\n+   |\n+   = help: the trait `~const Iterator` is not implemented for `Filter<std::ops::Range<{integer}>, [closure@$DIR/typeck_type_placeholder_item.rs:229:29: 229:32]>`\n+note: the trait `Iterator` is implemented for `Filter<std::ops::Range<{integer}>, [closure@$DIR/typeck_type_placeholder_item.rs:229:29: 229:32]>`, but that implementation is not `const`\n   --> $DIR/typeck_type_placeholder_item.rs:229:14\n    |\n LL | const _: _ = (1..10).filter(|x| x % 2 == 0).map(|x| x * x);\n-   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for constants\n+  --> $DIR/typeck_type_placeholder_item.rs:229:10\n+   |\n+LL | const _: _ = (1..10).filter(|x| x % 2 == 0).map(|x| x * x);\n+   |          ^ not allowed in type signatures\n \n error[E0121]: the placeholder `_` is not allowed within types on item signatures for functions\n   --> $DIR/typeck_type_placeholder_item.rs:140:31\n@@ -657,7 +677,7 @@ LL |     const D: _ = 42;\n    |              not allowed in type signatures\n    |              help: replace with the correct type: `i32`\n \n-error: aborting due to 71 previous errors\n+error: aborting due to 73 previous errors\n \n-Some errors have detailed explanations: E0121, E0282, E0403.\n+Some errors have detailed explanations: E0121, E0277, E0282, E0403.\n For more information about an error, try `rustc --explain E0121`."}]}