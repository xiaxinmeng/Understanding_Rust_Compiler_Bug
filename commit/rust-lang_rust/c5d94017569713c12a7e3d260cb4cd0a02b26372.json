{"sha": "c5d94017569713c12a7e3d260cb4cd0a02b26372", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM1ZDk0MDE3NTY5NzEzYzEyYTdlM2QyNjBjYjRjZDBhMDJiMjYzNzI=", "commit": {"author": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2019-05-06T01:47:03Z"}, "committer": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2019-05-20T08:56:53Z"}, "message": "Avoid symbol interning in `file_metadata`.\n\nThis commit changes `created_files` so it uses strings directly as keys,\nrather than symbols derived from the strings. This avoids the cost of\nhaving to do the hash table lookups to produce the symbols from the\nstrings.\n\nThe commit also uses `entry` to avoid doing a repeated hash table lookup\n(`get` + `insert`).\n\nNote that PR #60467 improved this code somewhat; this is a further\nimprovement.", "tree": {"sha": "7df7cdc63a9f1db64163458e4ebc8abc941c1bea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7df7cdc63a9f1db64163458e4ebc8abc941c1bea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c5d94017569713c12a7e3d260cb4cd0a02b26372", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c5d94017569713c12a7e3d260cb4cd0a02b26372", "html_url": "https://github.com/rust-lang/rust/commit/c5d94017569713c12a7e3d260cb4cd0a02b26372", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c5d94017569713c12a7e3d260cb4cd0a02b26372/comments", "author": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "128b4c8035fc788b78157d4e1975cda0f25ce599", "url": "https://api.github.com/repos/rust-lang/rust/commits/128b4c8035fc788b78157d4e1975cda0f25ce599", "html_url": "https://github.com/rust-lang/rust/commit/128b4c8035fc788b78157d4e1975cda0f25ce599"}], "stats": {"total": 68, "additions": 34, "deletions": 34}, "files": [{"sha": "e7f54f6609d299fd0294c776d8b4c6bd5614cafe", "filename": "src/librustc_codegen_llvm/debuginfo/metadata.rs", "status": "modified", "additions": 32, "deletions": 32, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/c5d94017569713c12a7e3d260cb4cd0a02b26372/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c5d94017569713c12a7e3d260cb4cd0a02b26372/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs?ref=c5d94017569713c12a7e3d260cb4cd0a02b26372", "patch": "@@ -38,14 +38,15 @@ use rustc_data_structures::small_c_str::SmallCStr;\n use rustc_target::abi::HasDataLayout;\n \n use libc::{c_uint, c_longlong};\n+use std::collections::hash_map::Entry;\n use std::ffi::CString;\n use std::fmt::{self, Write};\n use std::hash::{Hash, Hasher};\n use std::iter;\n use std::ptr;\n use std::path::{Path, PathBuf};\n use syntax::ast;\n-use syntax::symbol::{Interner, InternedString, Symbol};\n+use syntax::symbol::{Interner, InternedString};\n use syntax_pos::{self, Span, FileName};\n \n impl PartialEq for llvm::Metadata {\n@@ -787,49 +788,48 @@ pub fn file_metadata(cx: &CodegenCx<'ll, '_>,\n            file_name,\n            defining_crate);\n \n-    let file_name = &file_name.to_string();\n-    let file_name_symbol = Symbol::intern(file_name);\n-    if defining_crate == LOCAL_CRATE {\n-        let directory = &cx.sess().working_dir.0.to_string_lossy();\n-        file_metadata_raw(cx, file_name, Some(file_name_symbol),\n-                          directory, Some(Symbol::intern(directory)))\n+    let file_name = Some(file_name.to_string());\n+    let directory = if defining_crate == LOCAL_CRATE {\n+        Some(cx.sess().working_dir.0.to_string_lossy().to_string())\n     } else {\n         // If the path comes from an upstream crate we assume it has been made\n         // independent of the compiler's working directory one way or another.\n-        file_metadata_raw(cx, file_name, Some(file_name_symbol), \"\", None)\n-    }\n+        None\n+    };\n+    file_metadata_raw(cx, file_name, directory)\n }\n \n pub fn unknown_file_metadata(cx: &CodegenCx<'ll, '_>) -> &'ll DIFile {\n-    file_metadata_raw(cx, \"<unknown>\", None, \"\", None)\n+    file_metadata_raw(cx, None, None)\n }\n \n fn file_metadata_raw(cx: &CodegenCx<'ll, '_>,\n-                     file_name: &str,\n-                     file_name_symbol: Option<Symbol>,\n-                     directory: &str,\n-                     directory_symbol: Option<Symbol>)\n+                     file_name: Option<String>,\n+                     directory: Option<String>)\n                      -> &'ll DIFile {\n-    let key = (file_name_symbol, directory_symbol);\n+    let key = (file_name, directory);\n+\n+    match debug_context(cx).created_files.borrow_mut().entry(key) {\n+        Entry::Occupied(o) => return o.get(),\n+        Entry::Vacant(v) => {\n+            let (file_name, directory) = v.key();\n+            debug!(\"file_metadata: file_name: {:?}, directory: {:?}\", file_name, directory);\n+\n+            let file_name = SmallCStr::new(\n+                if let Some(file_name) = file_name { &file_name } else { \"<unknown>\" });\n+            let directory = SmallCStr::new(\n+                if let Some(directory) = directory { &directory } else { \"\" });\n+\n+            let file_metadata = unsafe {\n+                llvm::LLVMRustDIBuilderCreateFile(DIB(cx),\n+                                                  file_name.as_ptr(),\n+                                                  directory.as_ptr())\n+            };\n \n-    if let Some(file_metadata) = debug_context(cx).created_files.borrow().get(&key) {\n-        return *file_metadata;\n+            v.insert(file_metadata);\n+            file_metadata\n+        }\n     }\n-\n-    debug!(\"file_metadata: file_name: {}, directory: {}\", file_name, directory);\n-\n-    let file_name = SmallCStr::new(file_name);\n-    let directory = SmallCStr::new(directory);\n-\n-    let file_metadata = unsafe {\n-        llvm::LLVMRustDIBuilderCreateFile(DIB(cx),\n-                                          file_name.as_ptr(),\n-                                          directory.as_ptr())\n-    };\n-\n-    let mut created_files = debug_context(cx).created_files.borrow_mut();\n-    created_files.insert(key, file_metadata);\n-    file_metadata\n }\n \n fn basic_type_metadata(cx: &CodegenCx<'ll, 'tcx>, t: Ty<'tcx>) -> &'ll DIType {"}, {"sha": "527290392fff45a27f73ef22404f7d37f6d22f5a", "filename": "src/librustc_codegen_llvm/debuginfo/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c5d94017569713c12a7e3d260cb4cd0a02b26372/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c5d94017569713c12a7e3d260cb4cd0a02b26372/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmod.rs?ref=c5d94017569713c12a7e3d260cb4cd0a02b26372", "patch": "@@ -37,7 +37,7 @@ use std::ffi::CString;\n \n use syntax_pos::{self, Span, Pos};\n use syntax::ast;\n-use syntax::symbol::{Symbol, InternedString};\n+use syntax::symbol::InternedString;\n use rustc::ty::layout::{self, LayoutOf, HasTyCtxt};\n use rustc_codegen_ssa::traits::*;\n \n@@ -63,7 +63,7 @@ pub struct CrateDebugContext<'a, 'tcx> {\n     llcontext: &'a llvm::Context,\n     llmod: &'a llvm::Module,\n     builder: &'a mut DIBuilder<'a>,\n-    created_files: RefCell<FxHashMap<(Option<Symbol>, Option<Symbol>), &'a DIFile>>,\n+    created_files: RefCell<FxHashMap<(Option<String>, Option<String>), &'a DIFile>>,\n     created_enum_disr_types: RefCell<FxHashMap<(DefId, layout::Primitive), &'a DIType>>,\n \n     type_map: RefCell<TypeMap<'a, 'tcx>>,"}]}