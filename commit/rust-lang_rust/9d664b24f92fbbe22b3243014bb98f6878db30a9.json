{"sha": "9d664b24f92fbbe22b3243014bb98f6878db30a9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlkNjY0YjI0ZjkyZmJiZTIyYjMyNDMwMTRiYjk4ZjY4NzhkYjMwYTk=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-08-25T00:51:53Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-08-25T00:55:07Z"}, "message": "Make the pre-commit script pre-push instead\n\nThis should make it substantially less annoying, and hopefully more\npeople will find it useful. In particular, it will no longer run tidy\neach time you run `git commit --amend` or rebase a branch.\n\nThis also warns if you have the old script in pre-commit; see the HACK\ncomment for details.", "tree": {"sha": "d387af77cd63b46ff0752fe897c82b52ab2005b7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d387af77cd63b46ff0752fe897c82b52ab2005b7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9d664b24f92fbbe22b3243014bb98f6878db30a9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9d664b24f92fbbe22b3243014bb98f6878db30a9", "html_url": "https://github.com/rust-lang/rust/commit/9d664b24f92fbbe22b3243014bb98f6878db30a9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9d664b24f92fbbe22b3243014bb98f6878db30a9/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b03ccace573bb91e27625c190a0f7807045a1012", "url": "https://api.github.com/repos/rust-lang/rust/commits/b03ccace573bb91e27625c190a0f7807045a1012", "html_url": "https://github.com/rust-lang/rust/commit/b03ccace573bb91e27625c190a0f7807045a1012"}], "stats": {"total": 28, "additions": 21, "deletions": 7}, "files": [{"sha": "9c41ab69c8be3784e4e07f12acc9c06d60b03844", "filename": "src/bootstrap/bin/main.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/9d664b24f92fbbe22b3243014bb98f6878db30a9/src%2Fbootstrap%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9d664b24f92fbbe22b3243014bb98f6878db30a9/src%2Fbootstrap%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Fmain.rs?ref=9d664b24f92fbbe22b3243014bb98f6878db30a9", "patch": "@@ -30,6 +30,7 @@ fn main() {\n         println!(\"{}\", suggestion);\n     }\n \n+    let pre_commit = config.src.join(\".git\").join(\"hooks\").join(\"pre-commit\");\n     Build::new(config).build();\n \n     if suggest_setup {\n@@ -42,6 +43,19 @@ fn main() {\n         println!(\"{}\", suggestion);\n     }\n \n+    // Give a warning if the pre-commit script is in pre-commit and not pre-push.\n+    // HACK: Since the commit script uses hard links, we can't actually tell if it was installed by x.py setup or not.\n+    // We could see if it's identical to src/etc/pre-push.sh, but pre-push may have been modified in the meantime.\n+    // Instead, look for this comment, which is almost certainly not in any custom hook.\n+    if std::fs::read_to_string(pre_commit).map_or(false, |contents| {\n+        contents.contains(\"https://github.com/rust-lang/rust/issues/77620#issuecomment-705144570\")\n+    }) {\n+        println!(\n+            \"warning: You have the pre-push script installed to .git/hooks/pre-commit. \\\n+                  Consider moving it to .git/hooks/pre-push instead, which runs less often.\"\n+        );\n+    }\n+\n     if suggest_setup || changelog_suggestion.is_some() {\n         println!(\"note: this message was printed twice to make it more likely to be seen\");\n     }"}, {"sha": "6fafd7cf1d575860977ad7745888ab62fcc46316", "filename": "src/bootstrap/setup.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/9d664b24f92fbbe22b3243014bb98f6878db30a9/src%2Fbootstrap%2Fsetup.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9d664b24f92fbbe22b3243014bb98f6878db30a9/src%2Fbootstrap%2Fsetup.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fsetup.rs?ref=9d664b24f92fbbe22b3243014bb98f6878db30a9", "patch": "@@ -191,9 +191,9 @@ fn install_git_hook_maybe(src_path: &Path) -> io::Result<()> {\n     let mut input = String::new();\n     println!(\n         \"Rust's CI will automatically fail if it doesn't pass `tidy`, the internal tool for ensuring code quality.\n-If you'd like, x.py can install a git hook for you that will automatically run `tidy --bless` on each commit\n-to ensure your code is up to par. If you decide later that this behavior is undesirable,\n-simply delete the `pre-commit` file from .git/hooks.\"\n+If you'd like, x.py can install a git hook for you that will automatically run `tidy --bless` before\n+pushing your code to ensure your code is up to par. If you decide later that this behavior is\n+undesirable, simply delete the `pre-push` file from .git/hooks.\"\n     );\n \n     let should_install = loop {\n@@ -213,21 +213,21 @@ simply delete the `pre-commit` file from .git/hooks.\"\n     };\n \n     if should_install {\n-        let src = src_path.join(\"src\").join(\"etc\").join(\"pre-commit.sh\");\n+        let src = src_path.join(\"src\").join(\"etc\").join(\"pre-push.sh\");\n         let git = t!(Command::new(\"git\").args(&[\"rev-parse\", \"--git-common-dir\"]).output().map(\n             |output| {\n                 assert!(output.status.success(), \"failed to run `git`\");\n                 PathBuf::from(t!(String::from_utf8(output.stdout)).trim())\n             }\n         ));\n-        let dst = git.join(\"hooks\").join(\"pre-commit\");\n+        let dst = git.join(\"hooks\").join(\"pre-push\");\n         match fs::hard_link(src, &dst) {\n             Err(e) => println!(\n                 \"error: could not create hook {}: do you already have the git hook installed?\\n{}\",\n                 dst.display(),\n                 e\n             ),\n-            Ok(_) => println!(\"Linked `src/etc/pre-commit.sh` to `.git/hooks/pre-commit`\"),\n+            Ok(_) => println!(\"Linked `src/etc/pre-commit.sh` to `.git/hooks/pre-push`\"),\n         };\n     } else {\n         println!(\"Ok, skipping installation!\");"}, {"sha": "a78725f2ab0d1c1383e708240e819ae451c843c0", "filename": "src/etc/pre-push.sh", "status": "renamed", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9d664b24f92fbbe22b3243014bb98f6878db30a9/src%2Fetc%2Fpre-push.sh", "raw_url": "https://github.com/rust-lang/rust/raw/9d664b24f92fbbe22b3243014bb98f6878db30a9/src%2Fetc%2Fpre-push.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fpre-push.sh?ref=9d664b24f92fbbe22b3243014bb98f6878db30a9", "patch": "@@ -16,7 +16,7 @@ if [[ \"$OSTYPE\" == \"msys\" || \"$OSTYPE\" == \"win32\" ]]; then\n   COMMAND=\"python $COMMAND\"\n fi\n \n-echo \"Running pre-commit script '$COMMAND'\"\n+echo \"Running pre-push script '$COMMAND'\"\n \n cd \"$ROOT_DIR\"\n ", "previous_filename": "src/etc/pre-commit.sh"}]}