{"sha": "5bd4110170e053244636a97f9faa953a8147865f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjViZDQxMTAxNzBlMDUzMjQ0NjM2YTk3ZjlmYWE5NTNhODE0Nzg2NWY=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2012-08-11T01:15:08Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2012-08-13T22:34:36Z"}, "message": "rustc: Mostly implement region-bounded stack closures", "tree": {"sha": "b3794a07c69e0ab14bce66503f89d205a154026c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b3794a07c69e0ab14bce66503f89d205a154026c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5bd4110170e053244636a97f9faa953a8147865f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5bd4110170e053244636a97f9faa953a8147865f", "html_url": "https://github.com/rust-lang/rust/commit/5bd4110170e053244636a97f9faa953a8147865f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5bd4110170e053244636a97f9faa953a8147865f/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "395d1ac18598be88d71214691acfb3e820dc05a8", "url": "https://api.github.com/repos/rust-lang/rust/commits/395d1ac18598be88d71214691acfb3e820dc05a8", "html_url": "https://github.com/rust-lang/rust/commit/395d1ac18598be88d71214691acfb3e820dc05a8"}], "stats": {"total": 513, "additions": 364, "deletions": 149}, "files": [{"sha": "c080088674a804a88b28df3893e0d95087172330", "filename": "src/libcore/os.rs", "status": "modified", "additions": 5, "deletions": 7, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Flibcore%2Fos.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Flibcore%2Fos.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fos.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -163,14 +163,12 @@ mod global_env {\n \n     fn get_global_env_chan() -> comm::chan<msg> {\n         let global_ptr = rustrt::rust_global_env_chan_ptr();\n-        let task_build_fn = || {\n-            // FIXME (#2621): This would be a good place to use a very small\n-            // foreign stack\n-            task::task().sched_mode(task::single_threaded).unlinked()\n-        };\n         unsafe {\n-            priv::chan_from_global_ptr(\n-                global_ptr, task_build_fn, global_env_task)\n+            priv::chan_from_global_ptr(global_ptr, || {\n+                // FIXME (#2621): This would be a good place to use a very\n+                // small foreign stack\n+                task::task().sched_mode(task::single_threaded).unlinked()\n+            }, global_env_task)\n         }\n     }\n "}, {"sha": "a90f2fca55faa41c32294ead3b11e38b9a142d8a", "filename": "src/libcore/vec.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Flibcore%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Flibcore%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fvec.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -109,7 +109,7 @@ extern mod rusti {\n }\n \n /// A function used to initialize the elements of a vector\n-type init_op<T> = fn(uint) -> T;\n+type init_op/&<T> = fn(uint) -> T;\n \n /// Returns true if a vector contains no elements\n pure fn is_empty<T>(v: &[const T]) -> bool {"}, {"sha": "60996c1f773ae10b06d4b3203f77787bfe7d01d6", "filename": "src/libstd/par.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Flibstd%2Fpar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Flibstd%2Fpar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fpar.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -81,7 +81,7 @@ fn map_slices<A: copy send, B: copy send>(\n fn map<A: copy send, B: copy send>(xs: ~[A], f: fn~(A) -> B) -> ~[B] {\n     vec::concat(map_slices(xs, || {\n         fn~(_base: uint, slice : &[A], copy f) -> ~[B] {\n-            vec::map(slice, f)\n+            vec::map(slice, |x| f(x))\n         }\n     }))\n }\n@@ -139,7 +139,7 @@ fn alli<A: copy send>(xs: ~[A], f: fn~(uint, A) -> bool) -> bool {\n fn any<A: copy send>(xs: ~[A], f: fn~(A) -> bool) -> bool {\n     do vec::any(map_slices(xs, || {\n         fn~(_base : uint, slice: &[A], copy f) -> bool {\n-            vec::any(slice, f)\n+            vec::any(slice, |x| f(x))\n         }\n     })) |x| { x }\n }"}, {"sha": "4f6d04a5dd79cbbc09db7b59130108c073edf169", "filename": "src/libstd/test.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Flibstd%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Flibstd%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Ftest.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -347,9 +347,7 @@ fn filter_tests(opts: test_opts,\n             } else { return option::none; }\n         }\n \n-        let filter = |x| filter_fn(x, filter_str);\n-\n-        vec::filter_map(filtered, filter)\n+        vec::filter_map(filtered, |x| filter_fn(x, filter_str))\n     };\n \n     // Maybe pull out the ignored test and unignore them"}, {"sha": "14db589db8e60245aa66d814fcf53915ac1732e4", "filename": "src/libstd/uv_global_loop.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Flibstd%2Fuv_global_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Flibstd%2Fuv_global_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fuv_global_loop.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -39,15 +39,16 @@ fn get_monitor_task_gl() -> iotask unsafe {\n     debug!{\"ENTERING global_loop::get() loop chan: %?\",\n            monitor_loop_chan_ptr};\n \n-    let builder_fn = || {\n-        task::task().sched_mode(task::single_threaded).unlinked()\n-    };\n-\n     debug!{\"before priv::chan_from_global_ptr\"};\n     type monchan = chan<iotask>;\n \n-    let monitor_ch = do chan_from_global_ptr::<monchan>(monitor_loop_chan_ptr,\n-                                                        builder_fn) |msg_po| {\n+    let monitor_ch =\n+        do chan_from_global_ptr::<monchan>(monitor_loop_chan_ptr,\n+                                           || {\n+                                                task::task().sched_mode\n+                                                (task::single_threaded)\n+                                                .unlinked()\n+                                           }) |msg_po| {\n         debug!{\"global monitor task starting\"};\n \n         // As a weak task the runtime will notify us when to exit"}, {"sha": "80c64430ec3786cccec059204ce76220e7a97b25", "filename": "src/rustc/metadata/tydecode.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmetadata%2Ftydecode.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmetadata%2Ftydecode.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmetadata%2Ftydecode.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -85,13 +85,11 @@ fn parse_ty_rust_fn(st: @pstate, conv: conv_did) -> ty::t {\n     return ty::mk_fn(st.tcx, parse_ty_fn(st, conv));\n }\n \n-fn parse_proto(c: char) -> ast::proto {\n-    match c {\n-      '~' => ast::proto_uniq,\n-      '@' => ast::proto_box,\n-      '&' => ast::proto_block,\n-      'n' => ast::proto_bare,\n-      _ => fail ~\"illegal fn type kind \" + str::from_char(c)\n+fn parse_proto(st: @pstate) -> ty::fn_proto {\n+    match next(st) {\n+        'n' => ty::proto_bare,\n+        'v' => ty::proto_vstore(parse_vstore(st)),\n+        c => fail ~\"illegal proto type kind \" + str::from_char(c)\n     }\n }\n \n@@ -360,7 +358,7 @@ fn parse_purity(c: char) -> purity {\n }\n \n fn parse_ty_fn(st: @pstate, conv: conv_did) -> ty::fn_ty {\n-    let proto = parse_proto(next(st));\n+    let proto = parse_proto(st);\n     let purity = parse_purity(next(st));\n     let bounds = parse_bounds(st, conv);\n     assert (next(st) == '[');"}, {"sha": "30b2a21167ab4e20e7702cf357fffb7ea7417166", "filename": "src/rustc/metadata/tyencode.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmetadata%2Ftyencode.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmetadata%2Ftyencode.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmetadata%2Ftyencode.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -306,12 +306,15 @@ fn enc_sty(w: io::writer, cx: @ctxt, st: ty::sty) {\n       }\n     }\n }\n-fn enc_proto(w: io::writer, proto: proto) {\n+\n+fn enc_proto(w: io::writer, cx: @ctxt, proto: ty::fn_proto) {\n+    w.write_str(&\"f\");\n     match proto {\n-      proto_uniq => w.write_str(&\"f~\"),\n-      proto_box => w.write_str(&\"f@\"),\n-      proto_block => w.write_str(~\"f&\"),\n-      proto_bare => w.write_str(&\"fn\")\n+        ty::proto_bare => w.write_str(&\"n\"),\n+        ty::proto_vstore(vstore) => {\n+            w.write_str(&\"v\");\n+            enc_vstore(w, cx, vstore);\n+        }\n     }\n }\n \n@@ -335,7 +338,7 @@ fn enc_purity(w: io::writer, p: purity) {\n }\n \n fn enc_ty_fn(w: io::writer, cx: @ctxt, ft: ty::fn_ty) {\n-    enc_proto(w, ft.proto);\n+    enc_proto(w, cx, ft.proto);\n     enc_purity(w, ft.purity);\n     enc_bounds(w, cx, ft.bounds);\n     w.write_char('[');"}, {"sha": "bb33b8c92a890710b26bdb97f31c3ade1347f759", "filename": "src/rustc/middle/block_use.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fblock_use.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fblock_use.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Fblock_use.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -14,7 +14,7 @@ fn check_crate(tcx: ty::ctxt, crate: @crate) {\n fn visit_expr(ex: @expr, cx: ctx, v: visit::vt<ctx>) {\n     if !cx.allow_block {\n         match ty::get(ty::expr_ty(cx.tcx, ex)).struct {\n-          ty::ty_fn({proto: p, _}) if is_blockish(p) => {\n+          ty::ty_fn({proto: p, _}) if ty::is_blockish(p) => {\n             cx.tcx.sess.span_err(ex.span,\n                ~\"expressions with stack closure type \\\n                 can only appear in callee or (by-ref) argument position\");"}, {"sha": "4c3ee9eb4dd19ea052dd8033d84ae943449fa95d", "filename": "src/rustc/middle/borrowck/check_loans.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fborrowck%2Fcheck_loans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fborrowck%2Fcheck_loans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Fborrowck%2Fcheck_loans.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -218,10 +218,7 @@ impl check_loan_ctxt {\n     fn is_stack_closure(id: ast::node_id) -> bool {\n         let fn_ty = ty::node_id_to_type(self.tcx(), id);\n         let proto = ty::ty_fn_proto(fn_ty);\n-        match proto {\n-          ast::proto_block => true,\n-          ast::proto_bare | ast::proto_uniq | ast::proto_box => false\n-        }\n+        return ty::is_blockish(proto);\n     }\n \n     fn is_allowed_pure_arg(expr: @ast::expr) -> bool {"}, {"sha": "b45064db88d3eb77b570e2832597aef2f933b93b", "filename": "src/rustc/middle/capture.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fcapture.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fcapture.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Fcapture.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -59,7 +59,7 @@ fn check_capture_clause(tcx: ty::ctxt,\n \n fn compute_capture_vars(tcx: ty::ctxt,\n                         fn_expr_id: ast::node_id,\n-                        fn_proto: ast::proto,\n+                        fn_proto: ty::fn_proto,\n                         cap_clause: ast::capture_clause) -> ~[capture_var] {\n     let freevars = freevars::get_freevars(tcx, fn_expr_id);\n     let cap_map = map::int_hash();\n@@ -101,10 +101,12 @@ fn compute_capture_vars(tcx: ty::ctxt,\n     // now go through anything that is referenced but was not explicitly\n     // named and add that\n \n-    let implicit_mode = match fn_proto {\n-      ast::proto_block => cap_ref,\n-      ast::proto_bare | ast::proto_box | ast::proto_uniq => cap_copy\n-    };\n+    let implicit_mode;\n+    if ty::is_blockish(fn_proto) {\n+        implicit_mode = cap_ref;\n+    } else {\n+        implicit_mode = cap_copy;\n+    }\n \n     do vec::iter(*freevars) |fvar| {\n         let fvar_def_id = ast_util::def_id_of_def(fvar.def).node;"}, {"sha": "a105ce685290a63a8335617d451c7dedc1422e57", "filename": "src/rustc/middle/check_loop.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fcheck_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fcheck_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Fcheck_loop.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -25,7 +25,8 @@ fn check_crate(tcx: ty::ctxt, crate: @crate) {\n                 v.visit_block(b, {in_loop: false, can_ret: false}, v);\n               }\n               expr_loop_body(@{node: expr_fn_block(_, b, _), _}) => {\n-                let blk = is_blockish(ty::ty_fn_proto(ty::expr_ty(tcx, e)));\n+                let blk = ty::is_blockish(ty::ty_fn_proto(ty::expr_ty(tcx,\n+                                                                      e)));\n                 v.visit_block(b, {in_loop: true, can_ret: blk}, v);\n               }\n               expr_break => {"}, {"sha": "9968318292c6ff202ec7461b752348029aeb70a3", "filename": "src/rustc/middle/kind.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fkind.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fkind.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Fkind.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -144,10 +144,12 @@ fn with_appropriate_checker(cx: ctx, id: node_id, b: fn(check_fn)) {\n \n     let fty = ty::node_id_to_type(cx.tcx, id);\n     match ty::ty_fn_proto(fty) {\n-      proto_uniq => b(check_for_uniq),\n-      proto_box => b(check_for_box),\n-      proto_bare => b(check_for_bare),\n-      proto_block => b(check_for_block)\n+      ty::proto_vstore(ty::vstore_uniq) => b(check_for_uniq),\n+      ty::proto_vstore(ty::vstore_box) => b(check_for_box),\n+      ty::proto_bare => b(check_for_bare),\n+      ty::proto_vstore(ty::vstore_slice(_)) => b(check_for_block),\n+      ty::proto_vstore(ty::vstore_fixed(_)) =>\n+        fail ~\"fixed vstore not allowed here\"\n     }\n }\n "}, {"sha": "cf9ee1bc190e6a828985c83027603f0baef0021b", "filename": "src/rustc/middle/mem_categorization.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fmem_categorization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fmem_categorization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Fmem_categorization.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -383,18 +383,22 @@ impl &mem_categorization_ctxt {\n             let ty = ty::node_id_to_type(self.tcx, fn_node_id);\n             let proto = ty::ty_fn_proto(ty);\n             match proto {\n-              ast::proto_block => {\n+              ty::proto_vstore(ty::vstore_slice(_)) => {\n                 let upcmt = self.cat_def(id, span, expr_ty, *inner);\n                 @{id:id, span:span,\n                   cat:cat_stack_upvar(upcmt), lp:upcmt.lp,\n                   mutbl:upcmt.mutbl, ty:upcmt.ty}\n               }\n-              ast::proto_bare | ast::proto_uniq | ast::proto_box => {\n+              ty::proto_bare |\n+              ty::proto_vstore(ty::vstore_uniq) |\n+              ty::proto_vstore(ty::vstore_box) => {\n                 // FIXME #2152 allow mutation of moved upvars\n                 @{id:id, span:span,\n                   cat:cat_special(sk_heap_upvar), lp:none,\n                   mutbl:m_imm, ty:expr_ty}\n               }\n+              ty::proto_vstore(ty::vstore_fixed(_)) =>\n+                fail ~\"fixed vstore not allowed here\"\n             }\n           }\n "}, {"sha": "c4ab394aca0eb816b27f2e30f4a80fc0c2e1985b", "filename": "src/rustc/middle/region.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fregion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fregion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Fregion.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -496,6 +496,13 @@ fn determine_rp_in_ty(ty: @ast::ty,\n         }\n       }\n \n+      ast::ty_fn(ast::proto_bare, _, _) |\n+      ast::ty_fn(ast::proto_block, _, _) if cx.anon_implies_rp => {\n+        debug!(\"referenced bare fn type with regions %s\",\n+               pprust::ty_to_str(ty));\n+        cx.add_rp(cx.item_id);\n+      }\n+\n       _ => {}\n     }\n "}, {"sha": "d39f02389e2d1d21ddf1bc626c5ccceeaca5180d", "filename": "src/rustc/middle/trans/base.rs", "status": "modified", "additions": 23, "deletions": 3, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -2043,7 +2043,7 @@ fn normalize_for_monomorphization(tcx: ty::ctxt, ty: ty::t) -> option<ty::t> {\n       }\n       ty::ty_trait(_, _) => {\n         some(ty::mk_fn(tcx, {purity: ast::impure_fn,\n-                             proto: ast::proto_box,\n+                             proto: ty::proto_vstore(ty::vstore_box),\n                              bounds: @~[],\n                              inputs: ~[],\n                              output: ty::mk_nil(tcx),\n@@ -3774,8 +3774,28 @@ fn trans_expr(bcx: block, e: @ast::expr, dest: dest) -> block {\n           }\n           ast::expr_addr_of(_, x) => { return trans_addr_of(bcx, x, dest); }\n           ast::expr_fn(proto, decl, body, cap_clause) => {\n-            return closure::trans_expr_fn(bcx, proto, decl, body, e.id,\n-                                       cap_clause, none, dest);\n+            // Don't use this function for anything real. Use the one in\n+            // astconv instead.\n+            fn ast_proto_to_proto_simple(ast_proto: ast::proto)\n+                                      -> ty::fn_proto {\n+                match ast_proto {\n+                    ast::proto_bare =>\n+                        ty::proto_bare,\n+                    ast::proto_uniq =>\n+                        ty::proto_vstore(ty::vstore_uniq),\n+                    ast::proto_box =>\n+                        ty::proto_vstore(ty::vstore_box),\n+                    ast::proto_block =>\n+                        ty::proto_vstore(ty::vstore_slice(ty::re_static))\n+                }\n+            }\n+\n+            // XXX: This syntax should be reworked a bit (in the parser I\n+            // guess?); @fn() { ... } won't work.\n+            return closure::trans_expr_fn(bcx,\n+                                          ast_proto_to_proto_simple(proto),\n+                                          decl, body, e.id, cap_clause, none,\n+                                          dest);\n           }\n           ast::expr_fn_block(decl, body, cap_clause) => {\n             match check ty::get(expr_ty(bcx, e)).struct {"}, {"sha": "997991a5aa28ff796436b7f75a503d763ef918d1", "filename": "src/rustc/middle/trans/closure.rs", "status": "modified", "additions": 21, "deletions": 12, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftrans%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftrans%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftrans%2Fclosure.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -347,7 +347,7 @@ fn load_environment(fcx: fn_ctxt,\n }\n \n fn trans_expr_fn(bcx: block,\n-                 proto: ast::proto,\n+                 proto: ty::fn_proto,\n                  decl: ast::fn_decl,\n                  body: ast::blk,\n                  id: ast::node_id,\n@@ -364,8 +364,8 @@ fn trans_expr_fn(bcx: block,\n     let llfn = decl_internal_cdecl_fn(ccx.llmod, s, llfnty);\n \n     let trans_closure_env = fn@(ck: ty::closure_kind) -> result {\n-        let cap_vars = capture::compute_capture_vars(\n-            ccx.tcx, id, proto, cap_clause);\n+        let cap_vars = capture::compute_capture_vars(ccx.tcx, id, proto,\n+                                                     cap_clause);\n         let ret_handle = match is_loop_body { some(x) => x, none => none };\n         let {llbox, cdata_ty, bcx} = build_closure(bcx, cap_vars, ck, id,\n                                                    ret_handle);\n@@ -382,14 +382,19 @@ fn trans_expr_fn(bcx: block,\n     };\n \n     let {bcx: bcx, val: closure} = match proto {\n-      ast::proto_block => trans_closure_env(ty::ck_block),\n-      ast::proto_box => trans_closure_env(ty::ck_box),\n-      ast::proto_uniq => trans_closure_env(ty::ck_uniq),\n-      ast::proto_bare => {\n+      ty::proto_vstore(ty::vstore_slice(_)) =>\n+        trans_closure_env(ty::ck_block),\n+      ty::proto_vstore(ty::vstore_box) =>\n+        trans_closure_env(ty::ck_box),\n+      ty::proto_vstore(ty::vstore_uniq) =>\n+        trans_closure_env(ty::ck_uniq),\n+      ty::proto_bare => {\n         trans_closure(ccx, sub_path, decl, body, llfn, no_self, none,\n                       id, |_fcx| { }, |_bcx| { });\n         {bcx: bcx, val: C_null(T_opaque_box_ptr(ccx))}\n       }\n+      ty::proto_vstore(ty::vstore_fixed(_)) =>\n+        fail ~\"vstore_fixed unexpected\"\n     };\n     fill_fn_pair(bcx, get_dest_addr(dest), llfn, closure);\n \n@@ -416,11 +421,15 @@ fn make_fn_glue(\n     };\n \n     return match ty::get(t).struct {\n-      ty::ty_fn({proto: ast::proto_bare, _}) |\n-      ty::ty_fn({proto: ast::proto_block, _}) => bcx,\n-      ty::ty_fn({proto: ast::proto_uniq, _}) => fn_env(ty::ck_uniq),\n-      ty::ty_fn({proto: ast::proto_box, _}) => fn_env(ty::ck_box),\n-      _ => fail ~\"make_fn_glue invoked on non-function type\"\n+      ty::ty_fn({proto: ty::proto_bare, _}) |\n+      ty::ty_fn({proto: ty::proto_vstore(ty::vstore_slice(_)), _}) =>\n+        bcx,\n+      ty::ty_fn({proto: ty::proto_vstore(ty::vstore_uniq), _}) =>\n+        fn_env(ty::ck_uniq),\n+      ty::ty_fn({proto: ty::proto_vstore(ty::vstore_box), _}) =>\n+        fn_env(ty::ck_box),\n+      _ =>\n+        fail ~\"make_fn_glue invoked on non-function type\"\n     };\n }\n "}, {"sha": "50a900394a753931761e4beabbf0719cb5ae7b41", "filename": "src/rustc/middle/trans/foreign.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftrans%2Fforeign.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftrans%2Fforeign.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftrans%2Fforeign.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -960,7 +960,8 @@ fn trans_intrinsic(ccx: @crate_ctxt, decl: ValueRef, item: @ast::foreign_item,\n         let frameaddress_val = Call(bcx, frameaddress, ~[C_i32(0i32)]);\n         let fty = ty::mk_fn(bcx.tcx(), {\n             purity: ast::impure_fn,\n-            proto: ast::proto_block,\n+            proto:\n+                ty::proto_vstore(ty::vstore_slice(ty::re_bound(ty::br_anon))),\n             bounds: @~[],\n             inputs: ~[{\n                 mode: ast::expl(ast::by_val),"}, {"sha": "ccb3bf3429b3e3252e812178f5c2246c23e35b00", "filename": "src/rustc/middle/trans/reflect.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftrans%2Freflect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftrans%2Freflect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftrans%2Freflect.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -185,10 +185,12 @@ impl reflector {\n               ast::extern_fn => 3u\n             };\n             let protoval = match fty.proto {\n-              ast::proto_bare => 0u,\n-              ast::proto_uniq => 2u,\n-              ast::proto_box => 3u,\n-              ast::proto_block => 4u\n+              ty::proto_bare => 0u,\n+              ty::proto_vstore(ty::vstore_uniq) => 2u,\n+              ty::proto_vstore(ty::vstore_box) => 3u,\n+              ty::proto_vstore(ty::vstore_slice(_)) => 4u,\n+              ty::proto_vstore(ty::vstore_fixed(_)) =>\n+                fail ~\"fixed unexpected\"\n             };\n             let retval = match fty.ret_style {\n               ast::noreturn => 0u,"}, {"sha": "68bddb8d151ed084a154ecaa9fda317ec499776e", "filename": "src/rustc/middle/trans/shape.rs", "status": "modified", "additions": 14, "deletions": 8, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftrans%2Fshape.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftrans%2Fshape.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftrans%2Fshape.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -351,14 +351,20 @@ fn shape_of(ccx: @crate_ctxt, t: ty::t) -> ~[u8] {\n       ty::ty_param(*) => {\n         ccx.tcx.sess.bug(~\"non-monomorphized type parameter\");\n       }\n-      ty::ty_fn({proto: ast::proto_box, _}) => ~[shape_box_fn],\n-      ty::ty_fn({proto: ast::proto_uniq, _}) => ~[shape_uniq_fn],\n-      ty::ty_fn({proto: ast::proto_block, _}) => ~[shape_stack_fn],\n-      ty::ty_fn({proto: ast::proto_bare, _}) => ~[shape_bare_fn],\n-      ty::ty_opaque_closure_ptr(_) => ~[shape_opaque_closure_ptr],\n-      ty::ty_var(_) | ty::ty_var_integral(_) | ty::ty_self => {\n-        ccx.sess.bug(~\"shape_of: unexpected type struct found\");\n-      }\n+      ty::ty_fn({proto: ty::proto_vstore(ty::vstore_box), _}) =>\n+        ~[shape_box_fn],\n+      ty::ty_fn({proto: ty::proto_vstore(ty::vstore_uniq), _}) =>\n+        ~[shape_uniq_fn],\n+      ty::ty_fn({proto: ty::proto_vstore(ty::vstore_slice(_)), _}) =>\n+        ~[shape_stack_fn],\n+      ty::ty_fn({proto: ty::proto_vstore(ty::vstore_fixed(_)), _}) =>\n+        fail ~\"fixed vstore is impossible\",\n+      ty::ty_fn({proto: ty::proto_bare, _}) =>\n+        ~[shape_bare_fn],\n+      ty::ty_opaque_closure_ptr(_) =>\n+        ~[shape_opaque_closure_ptr],\n+      ty::ty_var(_) | ty::ty_var_integral(_) | ty::ty_self =>\n+        ccx.sess.bug(~\"shape_of: unexpected type struct found\")\n     }\n }\n "}, {"sha": "d630653ef2723a30297d0e225a5f842ca1f70640", "filename": "src/rustc/middle/trans/type_use.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftrans%2Ftype_use.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftrans%2Ftype_use.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftrans%2Ftype_use.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -202,13 +202,16 @@ fn mark_for_expr(cx: ctx, e: @expr) {\n       }\n       expr_fn(*) | expr_fn_block(*) => {\n         match ty::ty_fn_proto(ty::expr_ty(cx.ccx.tcx, e)) {\n-          proto_bare | proto_uniq => {}\n-          proto_box | proto_block => {\n+          ty::proto_bare | ty::proto_vstore(ty::vstore_uniq) => {}\n+          ty::proto_vstore(ty::vstore_box) |\n+          ty::proto_vstore(ty::vstore_slice(_)) => {\n             for vec::each(*freevars::get_freevars(cx.ccx.tcx, e.id)) |fv| {\n                 let node_id = ast_util::def_id_of_def(fv.def).node;\n                 node_type_needs(cx, use_repr, node_id);\n             }\n           }\n+          ty::proto_vstore(ty::vstore_fixed(_)) =>\n+            fail ~\"vstore_fixed not allowed here\"\n         }\n       }\n       expr_assign(val, _) | expr_swap(val, _) | expr_assign_op(_, val, _) |"}, {"sha": "8fcd47d3f31d36088c8cc0db2613030fd28582a9", "filename": "src/rustc/middle/ty.rs", "status": "modified", "additions": 83, "deletions": 15, "changes": 98, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Fty.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -172,9 +172,13 @@ export terr_regions_does_not_outlive, terr_mutability, terr_purity_mismatch;\n export terr_regions_not_same, terr_regions_no_overlap;\n export terr_proto_mismatch;\n export terr_ret_style_mismatch;\n+export terr_fn;\n export purity_to_str;\n export param_tys_in_type;\n export eval_repeat_count;\n+export fn_proto, proto_bare, proto_vstore;\n+export ast_proto_to_proto;\n+export is_blockish;\n \n // Data types\n \n@@ -317,6 +321,11 @@ enum closure_kind {\n     ck_uniq,\n }\n \n+enum fn_proto {\n+    proto_bare,             // supertype of all other protocols\n+    proto_vstore(vstore)\n+}\n+\n /// Innards of a function type:\n ///\n /// - `purity` is the function's effect (pure, impure, unsafe).\n@@ -326,7 +335,7 @@ enum closure_kind {\n /// - `output` is the return type.\n /// - `ret_style` indicates whether the function returns a value or fails.\n type fn_ty = {purity: ast::purity,\n-              proto: ast::proto,\n+              proto: fn_proto,\n               bounds: @~[param_bound],\n               inputs: ~[arg],\n               output: t,\n@@ -443,7 +452,7 @@ enum sty {\n }\n \n enum terr_vstore_kind {\n-    terr_vec, terr_str\n+    terr_vec, terr_str, terr_fn\n }\n \n // Data structures used in type unification\n@@ -452,7 +461,7 @@ enum type_err {\n     terr_ret_style_mismatch(ast::ret_style, ast::ret_style),\n     terr_purity_mismatch(purity, purity),\n     terr_mutability,\n-    terr_proto_mismatch(ast::proto, ast::proto),\n+    terr_proto_mismatch(ty::fn_proto, ty::fn_proto),\n     terr_box_mutability,\n     terr_ptr_mutability,\n     terr_ref_mutability,\n@@ -675,6 +684,10 @@ fn mk_t_with_id(cx: ctxt, +st: sty, o_def_id: option<ast::def_id>) -> t {\n       ty_rec(flds) => for flds.each |f| { flags |= get(f.mt.ty).flags; },\n       ty_tup(ts) => for ts.each |tt| { flags |= get(tt).flags; },\n       ty_fn(ref f) => {\n+        match f.proto {\n+            ty::proto_vstore(vstore_slice(r)) => flags |= rflags(r),\n+            ty::proto_bare | ty::proto_vstore(_) => {}\n+        }\n         for f.inputs.each |a| { flags |= get(a.ty).flags; }\n         flags |= get(f.output).flags;\n       }\n@@ -995,8 +1008,27 @@ fn fold_regions_and_ty(\n       ty_trait(def_id, ref substs) => {\n         ty::mk_trait(cx, def_id, fold_substs(substs, fldr, fldt))\n       }\n-      ref sty @ ty_fn(_) => {\n-        fold_sty_to_ty(cx, sty, |t| fldfnt(t))\n+      ref sty @ ty_fn(f) => {\n+        let new_proto;\n+        match f.proto {\n+            proto_bare =>\n+                new_proto = proto_bare,\n+            proto_vstore(vstore_slice(r)) =>\n+                new_proto = proto_vstore(vstore_slice(fldr(r))),\n+            proto_vstore(old_vstore) =>\n+                new_proto = proto_vstore(old_vstore)\n+        }\n+\n+        let new_args = vec::map(f.inputs, |a| {\n+            let new_ty = fldfnt(a.ty);\n+            {mode: a.mode, ty: new_ty}\n+        });\n+        let new_output = fldfnt(f.output);\n+        ty::mk_fn(cx, {\n+            inputs: new_args,\n+            output: new_output,\n+            proto: new_proto with f\n+        })\n       }\n       ref sty => {\n         fold_sty_to_ty(cx, sty, |t| fldt(t))\n@@ -1311,7 +1343,7 @@ fn type_needs_drop(cx: ctxt, ty: t) -> bool {\n       }\n       ty_fn(ref fty) => {\n         match fty.proto {\n-          proto_bare | proto_block => false,\n+          proto_bare | proto_vstore(vstore_slice(_)) => false,\n           _ => true\n         }\n       }\n@@ -1551,13 +1583,18 @@ pure fn kind_is_owned(k: kind) -> bool {\n     *k & KIND_MASK_OWNED == KIND_MASK_OWNED\n }\n \n-fn proto_kind(p: proto) -> kind {\n+fn proto_kind(p: fn_proto) -> kind {\n     match p {\n-      ast::proto_block => kind_noncopyable() | kind_(KIND_MASK_DEFAULT_MODE),\n-      ast::proto_box => kind_safe_for_default_mode() | kind_owned(),\n-      ast::proto_uniq => kind_send_copy() | kind_owned(),\n-      ast::proto_bare => kind_safe_for_default_mode_send() | kind_const() |\n-                           kind_owned()\n+      proto_vstore(vstore_slice(_)) =>\n+        kind_noncopyable() | kind_(KIND_MASK_DEFAULT_MODE),\n+      proto_vstore(vstore_box) =>\n+        kind_safe_for_default_mode() | kind_owned(),\n+      proto_vstore(vstore_uniq) =>\n+        kind_send_copy() | kind_owned(),\n+      proto_vstore(vstore_fixed(_)) =>\n+        fail ~\"fixed vstore protos are not allowed\",\n+      proto_bare =>\n+        kind_safe_for_default_mode_send() | kind_const() | kind_owned()\n     }\n }\n \n@@ -2296,7 +2333,7 @@ fn ty_fn_args(fty: t) -> ~[arg] {\n     }\n }\n \n-fn ty_fn_proto(fty: t) -> ast::proto {\n+fn ty_fn_proto(fty: t) -> fn_proto {\n     match get(fty).struct {\n       ty_fn(ref f) => f.proto,\n       _ => fail ~\"ty_fn_proto() called on non-fn type\"\n@@ -2579,7 +2616,11 @@ fn ty_sort_str(cx: ctxt, t: t) -> ~str {\n \n fn type_err_to_str(cx: ctxt, err: &type_err) -> ~str {\n     fn terr_vstore_kind_to_str(k: terr_vstore_kind) -> ~str {\n-        match k { terr_vec => ~\"[]\", terr_str => ~\"str\" }\n+        match k {\n+            terr_vec => ~\"[]\",\n+            terr_str => ~\"str\",\n+            terr_fn => ~\"fn\"\n+        }\n     }\n \n     match *err {\n@@ -2600,7 +2641,8 @@ fn type_err_to_str(cx: ctxt, err: &type_err) -> ~str {\n       }\n       terr_proto_mismatch(e, a) => {\n         return fmt!{\"closure protocol mismatch (%s vs %s)\",\n-                 proto_to_str(e), proto_to_str(a)};\n+                    util::ppaux::proto_ty_to_str(cx, e),\n+                    util::ppaux::proto_ty_to_str(cx, a)};\n       }\n       terr_mutability => return ~\"values differ in mutability\",\n       terr_box_mutability => return ~\"boxed values differ in mutability\",\n@@ -3214,6 +3256,21 @@ fn normalize_ty(cx: ctxt, t: t) -> t {\n             // This type has a region. Get rid of it\n             mk_rptr(cx, re_static, normalize_mt(cx, mt)),\n \n+        ty_fn({purity: purity,\n+               proto: proto_vstore(vstore),\n+               bounds: bounds,\n+               inputs: inputs,\n+               output: output,\n+               ret_style: ret_style}) =>\n+            mk_fn(cx, {\n+                purity: purity,\n+                proto: proto_vstore(normalize_vstore(vstore)),\n+                bounds: bounds,\n+                inputs: inputs,\n+                output: output,\n+                ret_style: ret_style\n+            }),\n+\n         ty_enum(did, r) =>\n             match r.self_r {\n                 some(_) =>\n@@ -3267,6 +3324,17 @@ fn eval_repeat_count(tcx: ctxt, count_expr: @ast::expr, span: span) -> uint {\n     }\n }\n \n+pure fn is_blockish(proto: fn_proto) -> bool {\n+    match proto {\n+        proto_vstore(vstore_slice(_)) =>\n+            true,\n+        proto_vstore(vstore_box) | proto_vstore(vstore_uniq) | proto_bare =>\n+            false,\n+        proto_vstore(vstore_fixed(_)) =>\n+            fail ~\"fixed vstore not allowed here\"\n+    }\n+}\n+\n // Local Variables:\n // mode: rust\n // fill-column: 78;"}, {"sha": "88469c33516e64415ef4161c3958270b7d463513", "filename": "src/rustc/middle/typeck.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftypeck.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -251,7 +251,7 @@ fn check_main_fn_ty(ccx: @crate_ctxt,\n     let tcx = ccx.tcx;\n     let main_t = ty::node_id_to_type(tcx, main_id);\n     match ty::get(main_t).struct {\n-      ty::ty_fn({purity: ast::impure_fn, proto: ast::proto_bare, bounds,\n+      ty::ty_fn({purity: ast::impure_fn, proto: ty::proto_bare, bounds,\n                  inputs, output, ret_style: ast::return_val}) => {\n         match tcx.items.find(main_id) {\n          some(ast_map::node_item(it,_)) => {"}, {"sha": "9a1eba46f2eac5f943d9a060f5228b45470af344", "filename": "src/rustc/middle/typeck/astconv.rs", "status": "modified", "additions": 25, "deletions": 4, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck%2Fastconv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck%2Fastconv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftypeck%2Fastconv.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -200,7 +200,7 @@ fn ast_ty_to_ty<AC: ast_conv, RS: region_scope copy owned>(\n             // Run through the normal function type conversion process.\n             let bounds = collect::compute_bounds(self.ccx(), ast_bounds);\n             let fn_decl = ty_of_fn_decl(self, rscope, new_proto, bounds,\n-                                        ast_fn_decl, none);\n+                                        ast_fn_decl, none, span);\n             return ty::mk_fn(tcx, fn_decl);\n           }\n           _ => ()\n@@ -286,7 +286,8 @@ fn ast_ty_to_ty<AC: ast_conv, RS: region_scope copy owned>(\n       }\n       ast::ty_fn(proto, ast_bounds, decl) => {\n         let bounds = collect::compute_bounds(self.ccx(), ast_bounds);\n-        let fn_decl = ty_of_fn_decl(self, rscope, proto, bounds, decl, none);\n+        let fn_decl = ty_of_fn_decl(self, rscope, proto, bounds, decl, none,\n+                                    ast_ty.span);\n         ty::mk_fn(tcx, fn_decl)\n       }\n       ast::ty_path(path, id) => {\n@@ -418,15 +419,33 @@ fn ty_of_arg<AC: ast_conv, RS: region_scope copy owned>(\n     {mode: mode, ty: ty}\n }\n \n+fn ast_proto_to_proto<AC: ast_conv, RS: region_scope copy owned>(\n+    self: AC, rscope: RS, span: span, ast_proto: ast::proto) -> ty::fn_proto {\n+    match ast_proto {\n+        ast::proto_bare =>\n+            ty::proto_bare,\n+        ast::proto_uniq =>\n+            ty::proto_vstore(ty::vstore_uniq),\n+        ast::proto_box =>\n+            ty::proto_vstore(ty::vstore_box),\n+        ast::proto_block => {\n+            let result = rscope.anon_region();\n+            let region = get_region_reporting_err(self.tcx(), span, result);\n+            ty::proto_vstore(ty::vstore_slice(region))\n+        }\n+    }\n+}\n+\n type expected_tys = option<{inputs: ~[ty::arg],\n                             output: ty::t}>;\n \n fn ty_of_fn_decl<AC: ast_conv, RS: region_scope copy owned>(\n     self: AC, rscope: RS,\n-    proto: ast::proto,\n+    ast_proto: ast::proto,\n     bounds: @~[ty::param_bound],\n     decl: ast::fn_decl,\n-    expected_tys: expected_tys) -> ty::fn_ty {\n+    expected_tys: expected_tys,\n+    span: span) -> ty::fn_ty {\n \n     debug!{\"ty_of_fn_decl\"};\n     do indent {\n@@ -450,6 +469,8 @@ fn ty_of_fn_decl<AC: ast_conv, RS: region_scope copy owned>(\n           _ => ast_ty_to_ty(self, rb, decl.output)\n         };\n \n+        let proto = ast_proto_to_proto(self, rscope, span, ast_proto);\n+\n         {purity: decl.purity, proto: proto, bounds: bounds, inputs: input_tys,\n          output: output_ty, ret_style: decl.cf}\n     }"}, {"sha": "ff588a586aa54a99dcc3df804c2c5ff6ee9a8978", "filename": "src/rustc/middle/typeck/check.rs", "status": "modified", "additions": 40, "deletions": 10, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftypeck%2Fcheck.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -1116,9 +1116,14 @@ fn check_expr_with_unifier(fcx: @fn_ctxt,\n         }\n     }\n \n+    enum fn_or_ast_proto {\n+        foap_fn_proto(ty::fn_proto),\n+        foap_ast_proto(ast::proto)\n+    }\n+\n     fn check_expr_fn(fcx: @fn_ctxt,\n                      expr: @ast::expr,\n-                     proto: ast::proto,\n+                     fn_or_ast_proto: fn_or_ast_proto,\n                      decl: ast::fn_decl,\n                      body: ast::blk,\n                      is_loop_body: bool,\n@@ -1143,9 +1148,29 @@ fn check_expr_with_unifier(fcx: @fn_ctxt,\n             }\n         };\n \n+        let ast_proto;\n+        match fn_or_ast_proto {\n+            foap_fn_proto(fn_proto) => {\n+                // Generate a fake AST prototype. We'll fill in the type with\n+                // the real one later.\n+                // XXX: This is a hack.\n+                ast_proto = ast::proto_box;\n+            }\n+            foap_ast_proto(existing_ast_proto) => {\n+                ast_proto = existing_ast_proto;\n+            }\n+        }\n+\n         // construct the function type\n-        let fn_ty = astconv::ty_of_fn_decl(fcx, fcx, proto, @~[],\n-                                           decl, expected_tys);\n+        let mut fn_ty = astconv::ty_of_fn_decl(fcx, fcx, ast_proto, @~[],\n+                                               decl, expected_tys, expr.span);\n+\n+        // Patch up the function declaration, if necessary.\n+        match fn_or_ast_proto {\n+            foap_fn_proto(fn_proto) => fn_ty.proto = fn_proto,\n+            foap_ast_proto(_) => {}\n+        }\n+\n         let fty = ty::mk_fn(tcx, fn_ty);\n \n         debug!{\"check_expr_fn_with_unifier %s fty=%s\",\n@@ -1485,15 +1510,17 @@ fn check_expr_with_unifier(fcx: @fn_ctxt,\n         bot = alt::check_alt(fcx, expr, discrim, arms);\n       }\n       ast::expr_fn(proto, decl, body, cap_clause) => {\n-        check_expr_fn(fcx, expr, proto, decl, body, false, expected);\n+        check_expr_fn(fcx, expr, foap_ast_proto(proto), decl, body, false,\n+                      expected);\n         capture::check_capture_clause(tcx, expr.id, cap_clause);\n       }\n       ast::expr_fn_block(decl, body, cap_clause) => {\n          // Take the prototype from the expected type, but default to block:\n           let proto = unpack_expected(fcx, expected, |sty|\n               match sty { ty::ty_fn({proto, _}) => some(proto), _ => none }\n-          ).get_default(ast::proto_box);\n-        check_expr_fn(fcx, expr, proto, decl, body, false, expected);\n+          ).get_default(ty::proto_vstore(ty::vstore_box));\n+        check_expr_fn(fcx, expr, foap_fn_proto(proto), decl, body, false,\n+                      expected);\n         capture::check_capture_clause(tcx, expr.id, cap_clause);\n       }\n       ast::expr_loop_body(b) => {\n@@ -1525,7 +1552,8 @@ fn check_expr_with_unifier(fcx: @fn_ctxt,\n         };\n         match check b.node {\n           ast::expr_fn_block(decl, body, cap_clause) => {\n-            check_expr_fn(fcx, b, proto, decl, body, true, some(inner_ty));\n+            check_expr_fn(fcx, b, foap_fn_proto(proto), decl, body, true,\n+                          some(inner_ty));\n             demand::suptype(fcx, b.span, inner_ty, fcx.expr_ty(b));\n             capture::check_capture_clause(tcx, b.id, cap_clause);\n           }\n@@ -1553,7 +1581,8 @@ fn check_expr_with_unifier(fcx: @fn_ctxt,\n         };\n         match check b.node {\n           ast::expr_fn_block(decl, body, cap_clause) => {\n-            check_expr_fn(fcx, b, proto, decl, body, true, some(inner_ty));\n+            check_expr_fn(fcx, b, foap_fn_proto(proto), decl, body, true,\n+                          some(inner_ty));\n             demand::suptype(fcx, b.span, inner_ty, fcx.expr_ty(b));\n             capture::check_capture_clause(tcx, b.id, cap_clause);\n           }\n@@ -2438,7 +2467,8 @@ fn check_intrinsic_type(ccx: @crate_ctxt, it: @ast::foreign_item) {\n       ~\"frame_address\" => {\n         let fty = ty::mk_fn(ccx.tcx, {\n             purity: ast::impure_fn,\n-            proto: ast::proto_block,\n+            proto:\n+                ty::proto_vstore(ty::vstore_slice(ty::re_bound(ty::br_anon))),\n             bounds: @~[],\n             inputs: ~[{\n                 mode: ast::expl(ast::by_val),\n@@ -2458,7 +2488,7 @@ fn check_intrinsic_type(ccx: @crate_ctxt, it: @ast::foreign_item) {\n       }\n     };\n     let fty = ty::mk_fn(tcx, {purity: ast::impure_fn,\n-                              proto: ast::proto_bare,\n+                              proto: ty::proto_bare,\n                               bounds: @~[],\n                               inputs: inputs, output: output,\n                               ret_style: ast::return_val});"}, {"sha": "b069745d5434c8ad1b8edd6885eb5ab8997e1a1c", "filename": "src/rustc/middle/typeck/check/method.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmethod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmethod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmethod.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -334,7 +334,8 @@ class lookup {\n     fn ty_from_did(did: ast::def_id) -> ty::t {\n         match check ty::get(ty::lookup_item_type(self.tcx(), did).ty).struct {\n           ty::ty_fn(fty) => {\n-            ty::mk_fn(self.tcx(), {proto: ast::proto_box with fty})\n+            ty::mk_fn(self.tcx(),\n+                      {proto: ty::proto_vstore(ty::vstore_box) with fty})\n           }\n         }\n         /*\n@@ -416,7 +417,8 @@ class lookup {\n \n         // a bit hokey, but the method unbound has a bare protocol, whereas\n         // a.b has a protocol like fn@() (perhaps eventually fn&()):\n-        let fty = ty::mk_fn(tcx, {proto: ast::proto_box with m.fty});\n+        let fty = ty::mk_fn(tcx, {proto: ty::proto_vstore(ty::vstore_box)\n+                                  with m.fty});\n \n         self.candidates.push(\n             {self_ty: self.self_ty,"}, {"sha": "84a5ec67be8c6bfebe6c325e2b1a612ceb839ae2", "filename": "src/rustc/middle/typeck/check/vtable.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck%2Fcheck%2Fvtable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck%2Fcheck%2Fvtable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftypeck%2Fcheck%2Fvtable.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -230,6 +230,7 @@ fn resolve_expr(ex: @ast::expr, &&fcx: @fn_ctxt, v: visit::vt<@fn_ctxt>) {\n     let cx = fcx.ccx;\n     match ex.node {\n       ast::expr_path(*) => {\n+        debug!(\"(vtable - resolving expr) resolving path expr\");\n         match fcx.opt_node_ty_substs(ex.id) {\n           some(ref substs) => {\n             let did = ast_util::def_id_of_def(cx.tcx.def_map.get(ex.id));\n@@ -249,6 +250,8 @@ fn resolve_expr(ex: @ast::expr, &&fcx: @fn_ctxt, v: visit::vt<@fn_ctxt>) {\n       ast::expr_field(*) | ast::expr_binary(*) |\n       ast::expr_unary(*) | ast::expr_assign_op(*) |\n       ast::expr_index(*) => {\n+        debug!(\"(vtable - resolving expr) resolving field/binary/unary/\\\n+                assign/index expr\");\n         match cx.method_map.find(ex.id) {\n           some({origin: method_static(did), _}) => {\n             let bounds = ty::lookup_item_type(cx.tcx, did).bounds;\n@@ -269,6 +272,7 @@ fn resolve_expr(ex: @ast::expr, &&fcx: @fn_ctxt, v: visit::vt<@fn_ctxt>) {\n         }\n       }\n       ast::expr_cast(src, _) => {\n+        debug!(\"(vtable - resolving expr) resolving cast expr\");\n         let target_ty = fcx.expr_ty(ex);\n         match ty::get(target_ty).struct {\n           ty::ty_trait(*) => {"}, {"sha": "5ff1c5ff6924af706be33697a05886f83ec0b530", "filename": "src/rustc/middle/typeck/collect.rs", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftypeck%2Fcollect.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -126,7 +126,8 @@ fn get_enum_variant_types(ccx: @crate_ctxt,\n                 });\n                 result_ty = some(ty::mk_fn(tcx,\n                                            {purity: ast::pure_fn,\n-                                            proto: ast::proto_box,\n+                                            proto: ty::proto_vstore\n+                                                (ty::vstore_box),\n                                             bounds: @~[],\n                                             inputs: args,\n                                             output: enum_ty,\n@@ -474,7 +475,7 @@ fn convert_struct(ccx: @crate_ctxt, rp: bool, struct_def: @ast::struct_def,\n              tps: ty::ty_params_to_tys(tcx, tps)});\n         let t_ctor = ty::mk_fn(\n             tcx, {purity: ast::impure_fn,\n-                  proto: ast::proto_block,\n+                  proto: ty::proto_vstore(ty::vstore_slice(ty::re_static)),\n                   bounds: @~[],\n                   inputs: t_args,\n                   output: t_res,\n@@ -490,8 +491,8 @@ fn convert_struct(ccx: @crate_ctxt, rp: bool, struct_def: @ast::struct_def,\n         // Write the dtor type\n         let t_dtor = ty::mk_fn(\n             tcx,\n-            ty_of_fn_decl(ccx, type_rscope(rp), ast::proto_block, @~[],\n-                          ast_util::dtor_dec(), none));\n+            ty_of_fn_decl(ccx, type_rscope(rp), ast::proto_bare, @~[],\n+                          ast_util::dtor_dec(), none, dtor.span));\n         write_ty_to_tcx(tcx, dtor.node.id, t_dtor);\n         tcx.tcache.insert(local_def(dtor.node.id),\n                           {bounds: tpt.bounds,\n@@ -536,7 +537,7 @@ fn ty_of_method(ccx: @crate_ctxt,\n     {ident: m.ident,\n      tps: ty_param_bounds(ccx, m.tps),\n      fty: ty_of_fn_decl(ccx, type_rscope(rp), ast::proto_bare, @~[],\n-                        m.decl, none),\n+                        m.decl, none, m.span),\n      self_ty: m.self_ty.node,\n      purity: m.decl.purity,\n      vis: m.vis}\n@@ -548,7 +549,7 @@ fn ty_of_ty_method(self: @crate_ctxt,\n     {ident: m.ident,\n      tps: ty_param_bounds(self, m.tps),\n      fty: ty_of_fn_decl(self, type_rscope(rp), ast::proto_bare, @~[], m.decl,\n-                        none),\n+                        none, m.span),\n      // assume public, because this is only invoked on trait methods\n      self_ty: m.self_ty.node,\n      purity: m.decl.purity, vis: ast::public}\n@@ -602,7 +603,7 @@ fn ty_of_item(ccx: @crate_ctxt, it: @ast::item)\n       ast::item_fn(decl, tps, _) => {\n         let bounds = ty_param_bounds(ccx, tps);\n         let tofd = ty_of_fn_decl(ccx, empty_rscope, ast::proto_bare, @~[],\n-                                 decl, none);\n+                                 decl, none, it.span);\n         let tpt = {bounds: bounds,\n                    rp: false, // functions do not have a self\n                    ty: ty::mk_fn(ccx.tcx, tofd)};\n@@ -726,7 +727,7 @@ fn ty_of_foreign_fn_decl(ccx: @crate_ctxt,\n     let output_ty = ast_ty_to_ty(ccx, rb, decl.output);\n \n     let t_fn = ty::mk_fn(ccx.tcx, {purity: decl.purity,\n-                                   proto: ast::proto_bare,\n+                                   proto: ty::proto_bare,\n                                    bounds: @~[],\n                                    inputs: input_tys,\n                                    output: output_ty,"}, {"sha": "cc0ed23ac72ec225d5299d1ead823fef4124aa5f", "filename": "src/rustc/middle/typeck/infer.rs", "status": "modified", "additions": 51, "deletions": 24, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck%2Finfer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Fmiddle%2Ftypeck%2Finfer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftypeck%2Finfer.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -251,7 +251,7 @@ import std::smallintmap::smallintmap;\n import std::map::hashmap;\n import middle::ty;\n import middle::ty::{tv_vid, tvi_vid, region_vid, vid,\n-                    ty_int, ty_uint, get};\n+                    ty_int, ty_uint, get, terr_fn};\n import syntax::{ast, ast_util};\n import syntax::ast::{ret_style, purity};\n import util::ppaux::{ty_to_str, mt_to_str};\n@@ -1654,7 +1654,7 @@ trait combine {\n     fn flds(a: ty::field, b: ty::field) -> cres<ty::field>;\n     fn modes(a: ast::mode, b: ast::mode) -> cres<ast::mode>;\n     fn args(a: ty::arg, b: ty::arg) -> cres<ty::arg>;\n-    fn protos(p1: ast::proto, p2: ast::proto) -> cres<ast::proto>;\n+    fn protos(p1: ty::fn_proto, p2: ty::fn_proto) -> cres<ty::fn_proto>;\n     fn ret_styles(r1: ret_style, r2: ret_style) -> cres<ret_style>;\n     fn purities(f1: purity, f2: purity) -> cres<purity>;\n     fn contraregions(a: ty::region, b: ty::region) -> cres<ty::region>;\n@@ -2053,10 +2053,25 @@ impl sub: combine {\n         }\n     }\n \n-    fn protos(a: ast::proto, b: ast::proto) -> cres<ast::proto> {\n-        (&self.lub()).protos(a, b).compare(b, || {\n-            ty::terr_proto_mismatch(b, a)\n-        })\n+    fn protos(a: ty::fn_proto, b: ty::fn_proto) -> cres<ty::fn_proto> {\n+        match (a, b) {\n+            (ty::proto_bare, _) => ok(ty::proto_bare),\n+\n+            (ty::proto_vstore(ty::vstore_box),\n+             ty::proto_vstore(ty::vstore_slice(_))) =>\n+                ok(ty::proto_vstore(ty::vstore_box)),\n+\n+            (ty::proto_vstore(ty::vstore_uniq),\n+             ty::proto_vstore(ty::vstore_slice(_))) =>\n+                ok(ty::proto_vstore(ty::vstore_uniq)),\n+\n+            (_, ty::proto_bare) => err(ty::terr_proto_mismatch(b, a)),\n+            (ty::proto_vstore(vs_a), ty::proto_vstore(vs_b)) => {\n+                do self.vstores(ty::terr_fn, vs_a, vs_b).chain |vs_c| {\n+                    ok(ty::proto_vstore(vs_c))\n+                }\n+            }\n+        }\n     }\n \n     fn purities(f1: purity, f2: purity) -> cres<purity> {\n@@ -2214,15 +2229,21 @@ impl lub: combine {\n         glb(self.infcx()).tys(a, b)\n     }\n \n-    fn protos(p1: ast::proto, p2: ast::proto) -> cres<ast::proto> {\n-        if p1 == ast::proto_bare {\n-            ok(p2)\n-        } else if p2 == ast::proto_bare {\n-            ok(p1)\n-        } else if p1 == p2 {\n-            ok(p1)\n-        } else {\n-            ok(ast::proto_block)\n+    // XXX: Wrong.\n+    fn protos(p1: ty::fn_proto, p2: ty::fn_proto) -> cres<ty::fn_proto> {\n+        match (p1, p2) {\n+            (ty::proto_bare, _) => ok(p2),\n+            (_, ty::proto_bare) => ok(p1),\n+            (ty::proto_vstore(v1), ty::proto_vstore(v2)) => {\n+                self.infcx().try(|| {\n+                    do self.vstores(terr_fn, v1, v2).chain |vs| {\n+                        ok(ty::proto_vstore(vs))\n+                    }\n+                }).chain_err(|_err| {\n+                    // XXX: Totally unsound, but fixed up later.\n+                    ok(ty::proto_vstore(ty::vstore_slice(ty::re_static)))\n+                })\n+            }\n         }\n     }\n \n@@ -2411,15 +2432,21 @@ impl glb: combine {\n         lub(self.infcx()).tys(a, b)\n     }\n \n-    fn protos(p1: ast::proto, p2: ast::proto) -> cres<ast::proto> {\n-        if p1 == ast::proto_block {\n-            ok(p2)\n-        } else if p2 == ast::proto_block {\n-            ok(p1)\n-        } else if p1 == p2 {\n-            ok(p1)\n-        } else {\n-            ok(ast::proto_bare)\n+    fn protos(p1: ty::fn_proto, p2: ty::fn_proto) -> cres<ty::fn_proto> {\n+        match (p1, p2) {\n+            (ty::proto_vstore(ty::vstore_slice(_)), _) => ok(p2),\n+            (_, ty::proto_vstore(ty::vstore_slice(_))) => ok(p1),\n+            (ty::proto_vstore(v1), ty::proto_vstore(v2)) => {\n+                self.infcx().try(|| {\n+                    do self.vstores(terr_fn, v1, v2).chain |vs| {\n+                        ok(ty::proto_vstore(vs))\n+                    }\n+                }).chain_err(|_err| {\n+                    // XXX: Totally unsound, but fixed up later.\n+                    ok(ty::proto_bare)\n+                })\n+            }\n+            _ => ok(ty::proto_bare)\n         }\n     }\n "}, {"sha": "98bae1fa6c00fe7d3abeb01093cfaf8d3f909bb1", "filename": "src/rustc/util/ppaux.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Futil%2Fppaux.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Frustc%2Futil%2Fppaux.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Futil%2Fppaux.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -188,6 +188,13 @@ fn vstore_ty_to_str(cx: ctxt, ty: ~str, vs: ty::vstore) -> ~str {\n     }\n }\n \n+fn proto_ty_to_str(cx: ctxt, proto: ty::fn_proto) -> ~str {\n+    match proto {\n+      ty::proto_bare => ~\"\",\n+      ty::proto_vstore(vstore) => vstore_to_str(cx, vstore)\n+    }\n+}\n+\n fn tys_to_str(cx: ctxt, ts: ~[t]) -> ~str {\n     let mut rs = ~\"\";\n     for ts.each |t| { rs += ty_to_str(cx, t); }\n@@ -211,7 +218,7 @@ fn ty_to_str(cx: ctxt, typ: t) -> ~str {\n         };\n         modestr + ty_to_str(cx, ty)\n     }\n-    fn fn_to_str(cx: ctxt, purity: ast::purity, proto: ast::proto,\n+    fn fn_to_str(cx: ctxt, purity: ast::purity, proto: ty::fn_proto,\n                  ident: option<ast::ident>,\n                  inputs: ~[arg], output: t, cf: ast::ret_style) -> ~str {\n         let mut s;\n@@ -220,7 +227,10 @@ fn ty_to_str(cx: ctxt, typ: t) -> ~str {\n           ast::impure_fn => ~\"\",\n           _ => purity_to_str(purity) + ~\" \"\n         };\n-        s += proto_to_str(proto);\n+\n+        s += ~\"fn\";\n+\n+        s += proto_ty_to_str(cx, proto);\n         match ident {\n           some(i) => { s += ~\" \"; s += *i; }\n           _ => { }"}, {"sha": "b6529d3b0308a5c5334d443011110cd4a64cf5c3", "filename": "src/test/run-pass/issue-2185.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5bd4110170e053244636a97f9faa953a8147865f/src%2Ftest%2Frun-pass%2Fissue-2185.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd4110170e053244636a97f9faa953a8147865f/src%2Ftest%2Frun-pass%2Fissue-2185.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-2185.rs?ref=5bd4110170e053244636a97f9faa953a8147865f", "patch": "@@ -37,12 +37,12 @@ fn range(lo: uint, hi: uint, it: fn(uint)) {\n }\n \n fn main() {\n-    let range = |a| range(0u, 1000u, a);\n-    let filt = |a| filter(\n+    let range: fn@(fn&(uint)) = |a| range(0u, 1000u, a);\n+    let filt: fn@(fn&(&&uint)) = |a| filter(\n         range,\n         |&&n: uint| n % 3u != 0u && n % 5u != 0u,\n         a);\n     let sum = foldl(filt, 0u, |accum, &&n: uint| accum + n );\n \n     io::println(fmt!{\"%u\", sum});\n-}\n\\ No newline at end of file\n+}"}]}