{"sha": "5722d2b7b88cf04365037b0769316916e486de48", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU3MjJkMmI3Yjg4Y2YwNDM2NTAzN2IwNzY5MzE2OTE2ZTQ4NmRlNDg=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-01-07T19:53:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-07T19:53:05Z"}, "message": "Merge #7097\n\n7097: Add fix to wrap return expression in Some r=matklad a=theotherphil\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/7095\n\nCo-authored-by: Phil Ellison <phil.j.ellison@gmail.com>", "tree": {"sha": "89a4c3f6e8a2b41bb637f818defeb87a47fadd09", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/89a4c3f6e8a2b41bb637f818defeb87a47fadd09"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5722d2b7b88cf04365037b0769316916e486de48", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJf92ahCRBK7hj4Ov3rIwAAdHIIAHSBPd6y8zR4ToTXpJgRJAT8\n45o72MLQ2bs/5CqFBpqUZS12nVQQwAqKOBVYgXwAwk4UzNovodFy6mtCAvo1wUJl\nn/sQVhpL68p+8Ye3/hmZRd49Ky8QpzbCLENRDT9hWrT0vk/o7MqbVMTyMc8NayZx\nxRY7vmLplMUw5AnU217LyBE/GYZwME90Gc6KkdQuKTWzrvGKYW7TJx+w6Q0HkPZZ\ncs5/ZpR3OmAzodjXpTVCVDR/gB/aGlz1u6BLk8P+ZllT7D4ATvdtNDXM1co64MIG\nyLS4hK7Q7iutll+gSgiLtui8xC89Pdb70E+FuadNmgg4c2ULnKZM4ACbA2tvxG0=\n=uKvH\n-----END PGP SIGNATURE-----\n", "payload": "tree 89a4c3f6e8a2b41bb637f818defeb87a47fadd09\nparent 981a0d708ec352969f9ca075a3e0e50c6da48197\nparent 7066bff9c323f3a02894f70728d22a4398d2e8bd\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1610049185 +0000\ncommitter GitHub <noreply@github.com> 1610049185 +0000\n\nMerge #7097\n\n7097: Add fix to wrap return expression in Some r=matklad a=theotherphil\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/7095\n\nCo-authored-by: Phil Ellison <phil.j.ellison@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5722d2b7b88cf04365037b0769316916e486de48", "html_url": "https://github.com/rust-lang/rust/commit/5722d2b7b88cf04365037b0769316916e486de48", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5722d2b7b88cf04365037b0769316916e486de48/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "981a0d708ec352969f9ca075a3e0e50c6da48197", "url": "https://api.github.com/repos/rust-lang/rust/commits/981a0d708ec352969f9ca075a3e0e50c6da48197", "html_url": "https://github.com/rust-lang/rust/commit/981a0d708ec352969f9ca075a3e0e50c6da48197"}, {"sha": "7066bff9c323f3a02894f70728d22a4398d2e8bd", "url": "https://api.github.com/repos/rust-lang/rust/commits/7066bff9c323f3a02894f70728d22a4398d2e8bd", "html_url": "https://github.com/rust-lang/rust/commit/7066bff9c323f3a02894f70728d22a4398d2e8bd"}], "stats": {"total": 110, "additions": 90, "deletions": 20}, "files": [{"sha": "447faa04f18968f44bb216647ccd7292920b9a88", "filename": "crates/hir/src/diagnostics.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fhir%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fhir%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fdiagnostics.rs?ref=5722d2b7b88cf04365037b0769316916e486de48", "patch": "@@ -4,6 +4,6 @@ pub use hir_expand::diagnostics::{\n     Diagnostic, DiagnosticCode, DiagnosticSink, DiagnosticSinkBuilder,\n };\n pub use hir_ty::diagnostics::{\n-    IncorrectCase, MismatchedArgCount, MissingFields, MissingMatchArms, MissingOkInTailExpr,\n+    IncorrectCase, MismatchedArgCount, MissingFields, MissingMatchArms, MissingOkOrSomeInTailExpr,\n     NoSuchField, RemoveThisSemicolon,\n };"}, {"sha": "3dd7c3cbba2628a9938642d0ca4d88ea7b3279d7", "filename": "crates/hir_def/src/path.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fhir_def%2Fsrc%2Fpath.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fhir_def%2Fsrc%2Fpath.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fpath.rs?ref=5722d2b7b88cf04365037b0769316916e486de48", "patch": "@@ -305,6 +305,7 @@ pub use hir_expand::name as __name;\n macro_rules! __known_path {\n     (core::iter::IntoIterator) => {};\n     (core::result::Result) => {};\n+    (core::option::Option) => {};\n     (core::ops::Range) => {};\n     (core::ops::RangeFrom) => {};\n     (core::ops::RangeFull) => {};"}, {"sha": "95d853b6da6fe333fb694582986a864b878c7c61", "filename": "crates/hir_expand/src/name.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fhir_expand%2Fsrc%2Fname.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fhir_expand%2Fsrc%2Fname.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fname.rs?ref=5722d2b7b88cf04365037b0769316916e486de48", "patch": "@@ -164,6 +164,7 @@ pub mod known {\n         future,\n         result,\n         boxed,\n+        option,\n         // Components of known path (type name)\n         Iterator,\n         IntoIterator,\n@@ -172,6 +173,7 @@ pub mod known {\n         Ok,\n         Future,\n         Result,\n+        Option,\n         Output,\n         Target,\n         Box,"}, {"sha": "c67a289f28328872c168eb088b9161a07fb677eb", "filename": "crates/hir_ty/src/diagnostics.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fhir_ty%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fhir_ty%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fdiagnostics.rs?ref=5722d2b7b88cf04365037b0769316916e486de48", "patch": "@@ -186,9 +186,10 @@ impl Diagnostic for MissingMatchArms {\n     }\n }\n \n-// Diagnostic: missing-ok-in-tail-expr\n+// Diagnostic: missing-ok-or-some-in-tail-expr\n //\n-// This diagnostic is triggered if block that should return `Result` returns a value not wrapped in `Ok`.\n+// This diagnostic is triggered if a block that should return `Result` returns a value not wrapped in `Ok`,\n+// or if a block that should return `Option` returns a value not wrapped in `Some`.\n //\n // Example:\n //\n@@ -198,17 +199,19 @@ impl Diagnostic for MissingMatchArms {\n // }\n // ```\n #[derive(Debug)]\n-pub struct MissingOkInTailExpr {\n+pub struct MissingOkOrSomeInTailExpr {\n     pub file: HirFileId,\n     pub expr: AstPtr<ast::Expr>,\n+    // `Some` or `Ok` depending on whether the return type is Result or Option\n+    pub required: String,\n }\n \n-impl Diagnostic for MissingOkInTailExpr {\n+impl Diagnostic for MissingOkOrSomeInTailExpr {\n     fn code(&self) -> DiagnosticCode {\n-        DiagnosticCode(\"missing-ok-in-tail-expr\")\n+        DiagnosticCode(\"missing-ok-or-some-in-tail-expr\")\n     }\n     fn message(&self) -> String {\n-        \"wrap return expression in Ok\".to_string()\n+        format!(\"wrap return expression in {}\", self.required)\n     }\n     fn display_source(&self) -> InFile<SyntaxNodePtr> {\n         InFile { file_id: self.file, value: self.expr.clone().into() }"}, {"sha": "a1c484fdff4de3cfb0e486384a0fb1cee4dbdf6f", "filename": "crates/hir_ty/src/diagnostics/expr.rs", "status": "modified", "additions": 20, "deletions": 7, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fhir_ty%2Fsrc%2Fdiagnostics%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fhir_ty%2Fsrc%2Fdiagnostics%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fdiagnostics%2Fexpr.rs?ref=5722d2b7b88cf04365037b0769316916e486de48", "patch": "@@ -11,8 +11,8 @@ use crate::{\n     db::HirDatabase,\n     diagnostics::{\n         match_check::{is_useful, MatchCheckCtx, Matrix, PatStack, Usefulness},\n-        MismatchedArgCount, MissingFields, MissingMatchArms, MissingOkInTailExpr, MissingPatFields,\n-        RemoveThisSemicolon,\n+        MismatchedArgCount, MissingFields, MissingMatchArms, MissingOkOrSomeInTailExpr,\n+        MissingPatFields, RemoveThisSemicolon,\n     },\n     utils::variant_data,\n     ApplicationTy, InferenceResult, Ty, TypeCtor,\n@@ -306,27 +306,40 @@ impl<'a, 'b> ExprValidator<'a, 'b> {\n         };\n \n         let core_result_path = path![core::result::Result];\n+        let core_option_path = path![core::option::Option];\n \n         let resolver = self.owner.resolver(db.upcast());\n         let core_result_enum = match resolver.resolve_known_enum(db.upcast(), &core_result_path) {\n             Some(it) => it,\n             _ => return,\n         };\n+        let core_option_enum = match resolver.resolve_known_enum(db.upcast(), &core_option_path) {\n+            Some(it) => it,\n+            _ => return,\n+        };\n \n         let core_result_ctor = TypeCtor::Adt(AdtId::EnumId(core_result_enum));\n-        let params = match &mismatch.expected {\n+        let core_option_ctor = TypeCtor::Adt(AdtId::EnumId(core_option_enum));\n+\n+        let (params, required) = match &mismatch.expected {\n             Ty::Apply(ApplicationTy { ctor, parameters }) if ctor == &core_result_ctor => {\n-                parameters\n+                (parameters, \"Ok\".to_string())\n+            }\n+            Ty::Apply(ApplicationTy { ctor, parameters }) if ctor == &core_option_ctor => {\n+                (parameters, \"Some\".to_string())\n             }\n             _ => return,\n         };\n \n-        if params.len() == 2 && params[0] == mismatch.actual {\n+        if params.len() > 0 && params[0] == mismatch.actual {\n             let (_, source_map) = db.body_with_source_map(self.owner.into());\n \n             if let Ok(source_ptr) = source_map.expr_syntax(id) {\n-                self.sink\n-                    .push(MissingOkInTailExpr { file: source_ptr.file_id, expr: source_ptr.value });\n+                self.sink.push(MissingOkOrSomeInTailExpr {\n+                    file: source_ptr.file_id,\n+                    expr: source_ptr.value,\n+                    required,\n+                });\n             }\n         }\n     }"}, {"sha": "055c0a79cf3c385436445a25330ce6376b3e3bfd", "filename": "crates/ide/src/diagnostics.rs", "status": "modified", "additions": 51, "deletions": 2, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fide%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fide%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fdiagnostics.rs?ref=5722d2b7b88cf04365037b0769316916e486de48", "patch": "@@ -125,7 +125,7 @@ pub(crate) fn diagnostics(\n         .on::<hir::diagnostics::MissingFields, _>(|d| {\n             res.borrow_mut().push(diagnostic_with_fix(d, &sema));\n         })\n-        .on::<hir::diagnostics::MissingOkInTailExpr, _>(|d| {\n+        .on::<hir::diagnostics::MissingOkOrSomeInTailExpr, _>(|d| {\n             res.borrow_mut().push(diagnostic_with_fix(d, &sema));\n         })\n         .on::<hir::diagnostics::NoSuchField, _>(|d| {\n@@ -304,6 +304,40 @@ mod tests {\n         expect.assert_debug_eq(&diagnostics)\n     }\n \n+    #[test]\n+    fn test_wrap_return_type_option() {\n+        check_fix(\n+            r#\"\n+//- /main.rs crate:main deps:core\n+use core::option::Option::{self, Some, None};\n+\n+fn div(x: i32, y: i32) -> Option<i32> {\n+    if y == 0 {\n+        return None;\n+    }\n+    x / y$0\n+}\n+//- /core/lib.rs crate:core\n+pub mod result {\n+    pub enum Result<T, E> { Ok(T), Err(E) }\n+}\n+pub mod option {\n+    pub enum Option<T> { Some(T), None }\n+}\n+\"#,\n+            r#\"\n+use core::option::Option::{self, Some, None};\n+\n+fn div(x: i32, y: i32) -> Option<i32> {\n+    if y == 0 {\n+        return None;\n+    }\n+    Some(x / y)\n+}\n+\"#,\n+        );\n+    }\n+\n     #[test]\n     fn test_wrap_return_type() {\n         check_fix(\n@@ -321,6 +355,9 @@ fn div(x: i32, y: i32) -> Result<i32, ()> {\n pub mod result {\n     pub enum Result<T, E> { Ok(T), Err(E) }\n }\n+pub mod option {\n+    pub enum Option<T> { Some(T), None }\n+}\n \"#,\n             r#\"\n use core::result::Result::{self, Ok, Err};\n@@ -352,6 +389,9 @@ fn div<T>(x: T) -> Result<T, i32> {\n pub mod result {\n     pub enum Result<T, E> { Ok(T), Err(E) }\n }\n+pub mod option {\n+    pub enum Option<T> { Some(T), None }\n+}\n \"#,\n             r#\"\n use core::result::Result::{self, Ok, Err};\n@@ -385,6 +425,9 @@ fn div(x: i32, y: i32) -> MyResult<i32> {\n pub mod result {\n     pub enum Result<T, E> { Ok(T), Err(E) }\n }\n+pub mod option {\n+    pub enum Option<T> { Some(T), None }\n+}\n \"#,\n             r#\"\n use core::result::Result::{self, Ok, Err};\n@@ -414,12 +457,15 @@ fn foo() -> Result<(), i32> { 0 }\n pub mod result {\n     pub enum Result<T, E> { Ok(T), Err(E) }\n }\n+pub mod option {\n+    pub enum Option<T> { Some(T), None }\n+}\n \"#,\n         );\n     }\n \n     #[test]\n-    fn test_wrap_return_type_not_applicable_when_return_type_is_not_result() {\n+    fn test_wrap_return_type_not_applicable_when_return_type_is_not_result_or_option() {\n         check_no_diagnostics(\n             r#\"\n //- /main.rs crate:main deps:core\n@@ -433,6 +479,9 @@ fn foo() -> SomeOtherEnum { 0 }\n pub mod result {\n     pub enum Result<T, E> { Ok(T), Err(E) }\n }\n+pub mod option {\n+    pub enum Option<T> { Some(T), None }\n+}\n \"#,\n         );\n     }"}, {"sha": "d7ad88ed523b2141a94008b67e6682e4b213416d", "filename": "crates/ide/src/diagnostics/fixes.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fide%2Fsrc%2Fdiagnostics%2Ffixes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5722d2b7b88cf04365037b0769316916e486de48/crates%2Fide%2Fsrc%2Fdiagnostics%2Ffixes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fdiagnostics%2Ffixes.rs?ref=5722d2b7b88cf04365037b0769316916e486de48", "patch": "@@ -3,7 +3,7 @@\n use hir::{\n     db::AstDatabase,\n     diagnostics::{\n-        Diagnostic, IncorrectCase, MissingFields, MissingOkInTailExpr, NoSuchField,\n+        Diagnostic, IncorrectCase, MissingFields, MissingOkOrSomeInTailExpr, NoSuchField,\n         RemoveThisSemicolon, UnresolvedModule,\n     },\n     HasSource, HirDisplay, InFile, Semantics, VariantDef,\n@@ -94,15 +94,17 @@ impl DiagnosticWithFix for MissingFields {\n     }\n }\n \n-impl DiagnosticWithFix for MissingOkInTailExpr {\n+impl DiagnosticWithFix for MissingOkOrSomeInTailExpr {\n     fn fix(&self, sema: &Semantics<RootDatabase>) -> Option<Fix> {\n         let root = sema.db.parse_or_expand(self.file)?;\n         let tail_expr = self.expr.to_node(&root);\n         let tail_expr_range = tail_expr.syntax().text_range();\n-        let edit = TextEdit::replace(tail_expr_range, format!(\"Ok({})\", tail_expr.syntax()));\n+        let replacement = format!(\"{}({})\", self.required, tail_expr.syntax());\n+        let edit = TextEdit::replace(tail_expr_range, replacement);\n         let source_change =\n             SourceFileEdit { file_id: self.file.original_file(sema.db), edit }.into();\n-        Some(Fix::new(\"Wrap with ok\", source_change, tail_expr_range))\n+        let name = if self.required == \"Ok\" { \"Wrap with Ok\" } else { \"Wrap with Some\" };\n+        Some(Fix::new(name, source_change, tail_expr_range))\n     }\n }\n "}]}