{"sha": "c640f31c9f4b2159ebd2817904fcbc7077cec57a", "node_id": "C_kwDOAAsO6NoAKGM2NDBmMzFjOWY0YjIxNTllYmQyODE3OTA0ZmNiYzcwNzdjZWM1N2E", "commit": {"author": {"name": "The 8472", "email": "git@infinite-source.de", "date": "2021-11-30T23:31:46Z"}, "committer": {"name": "The 8472", "email": "git@infinite-source.de", "date": "2021-12-06T17:43:01Z"}, "message": "avoid string validation in rustc_serialize, check a marker byte instead\n\nsince the serialization format isn't self-describing we need a way to detect\nwhen encoder and decoder don't match up. but that doesn't have to\nbe utf8 validation for strings, which does cost a few % of performance.\nInstead we can use a marker byte at the end to be reasonably\nsure that we're dealing with a string and it wasn't overwritten in some\nway.", "tree": {"sha": "a373660033e46bafcf70d6890b173ba7891a2efa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a373660033e46bafcf70d6890b173ba7891a2efa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c640f31c9f4b2159ebd2817904fcbc7077cec57a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c640f31c9f4b2159ebd2817904fcbc7077cec57a", "html_url": "https://github.com/rust-lang/rust/commit/c640f31c9f4b2159ebd2817904fcbc7077cec57a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c640f31c9f4b2159ebd2817904fcbc7077cec57a/comments", "author": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "committer": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "207c80f105282245d93024c95ac408c622f70114", "url": "https://api.github.com/repos/rust-lang/rust/commits/207c80f105282245d93024c95ac408c622f70114", "html_url": "https://github.com/rust-lang/rust/commit/207c80f105282245d93024c95ac408c622f70114"}], "stats": {"total": 21, "additions": 17, "deletions": 4}, "files": [{"sha": "cc1216418ae79306d54a5b46bb6b69a261afcdef", "filename": "compiler/rustc_serialize/src/opaque.rs", "status": "modified", "additions": 17, "deletions": 4, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/c640f31c9f4b2159ebd2817904fcbc7077cec57a/compiler%2Frustc_serialize%2Fsrc%2Fopaque.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c640f31c9f4b2159ebd2817904fcbc7077cec57a/compiler%2Frustc_serialize%2Fsrc%2Fopaque.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_serialize%2Fsrc%2Fopaque.rs?ref=c640f31c9f4b2159ebd2817904fcbc7077cec57a", "patch": "@@ -55,6 +55,13 @@ macro_rules! write_leb128 {\n     }};\n }\n \n+/// A byte that [cannot occur in UTF8 sequences][utf8]. Used to mark the end of a string.\n+/// This way we can skip validation and still be relatively sure that deserialization\n+/// did not desynchronize.\n+///\n+/// [utf8]: https://en.wikipedia.org/w/index.php?title=UTF-8&oldid=1058865525#Codepage_layout\n+const STR_SENTINEL: u8 = 0xC1;\n+\n impl serialize::Encoder for Encoder {\n     type Error = !;\n \n@@ -150,7 +157,8 @@ impl serialize::Encoder for Encoder {\n     #[inline]\n     fn emit_str(&mut self, v: &str) -> EncodeResult {\n         self.emit_usize(v.len())?;\n-        self.emit_raw_bytes(v.as_bytes())\n+        self.emit_raw_bytes(v.as_bytes())?;\n+        self.emit_u8(STR_SENTINEL)\n     }\n \n     #[inline]\n@@ -502,7 +510,8 @@ impl serialize::Encoder for FileEncoder {\n     #[inline]\n     fn emit_str(&mut self, v: &str) -> FileEncodeResult {\n         self.emit_usize(v.len())?;\n-        self.emit_raw_bytes(v.as_bytes())\n+        self.emit_raw_bytes(v.as_bytes())?;\n+        self.emit_u8(STR_SENTINEL)\n     }\n \n     #[inline]\n@@ -656,8 +665,12 @@ impl<'a> serialize::Decoder for Decoder<'a> {\n     #[inline]\n     fn read_str(&mut self) -> Result<Cow<'_, str>, Self::Error> {\n         let len = self.read_usize()?;\n-        let s = std::str::from_utf8(&self.data[self.position..self.position + len]).unwrap();\n-        self.position += len;\n+        let sentinel = self.data[self.position + len];\n+        assert!(sentinel == STR_SENTINEL);\n+        let s = unsafe {\n+            std::str::from_utf8_unchecked(&self.data[self.position..self.position + len])\n+        };\n+        self.position += len + 1;\n         Ok(Cow::Borrowed(s))\n     }\n "}]}