{"sha": "139a3c5b0aa4eb8b0ac21f561480f552072fdf64", "node_id": "C_kwDOAAsO6NoAKDEzOWEzYzViMGFhNGViOGIwYWMyMWY1NjE0ODBmNTUyMDcyZmRmNjQ", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2023-01-25T11:31:44Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-01-25T11:31:44Z"}, "message": "Rollup merge of #107227 - lcnr:solver-new-external-api, r=compiler-errors\n\n`new_outside_solver` ->  `evaluate_root_goal`\n\nr? ```@rust-lang/initiative-trait-system-refactor```", "tree": {"sha": "20b44cfa471c01440fb38491ad30f854d2e47aed", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/20b44cfa471c01440fb38491ad30f854d2e47aed"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/139a3c5b0aa4eb8b0ac21f561480f552072fdf64", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj0RMgCRBK7hj4Ov3rIwAAfawIAIbjpdrZKUFoZNa+UtCMik2l\nb3lWRveh0F0vjVhqXEXp3DpqkK9Z6KcTX9L04s7uaiy4fTTRcaV9fqWLlZXzSjvO\nKTkj/6yi4OP88Wzy3AQaAt06p5E1YxJjvctda07r1+fsNPBZBVjd3FviwpvkiUwV\nvwh8WnkPxGp4hqVw4t1Rzvg1HCzZrxQtknjNKsSp5A91E3X0s+VaAwXUnxce1geB\nE61xHcPrp5zP9Ll86/J+vdT4uRJc2m4KgLBkm1uQmzB+Oky0yVzbz5ISEZER9cll\n5FuhmvEhX7+DwO4reJbpHy+B3eVfzcKEYtmxrH5XVOnuU0JX+PwN9EfLizfWhBo=\n=8F9/\n-----END PGP SIGNATURE-----\n", "payload": "tree 20b44cfa471c01440fb38491ad30f854d2e47aed\nparent 24066910ca31d5ccab6586f7d68a789103dd8ae0\nparent 033047a72cd3129831d4c0ae59024d77f17106ec\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1674646304 +0530\ncommitter GitHub <noreply@github.com> 1674646304 +0530\n\nRollup merge of #107227 - lcnr:solver-new-external-api, r=compiler-errors\n\n`new_outside_solver` ->  `evaluate_root_goal`\n\nr? ```@rust-lang/initiative-trait-system-refactor```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/139a3c5b0aa4eb8b0ac21f561480f552072fdf64", "html_url": "https://github.com/rust-lang/rust/commit/139a3c5b0aa4eb8b0ac21f561480f552072fdf64", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/139a3c5b0aa4eb8b0ac21f561480f552072fdf64/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "24066910ca31d5ccab6586f7d68a789103dd8ae0", "url": "https://api.github.com/repos/rust-lang/rust/commits/24066910ca31d5ccab6586f7d68a789103dd8ae0", "html_url": "https://github.com/rust-lang/rust/commit/24066910ca31d5ccab6586f7d68a789103dd8ae0"}, {"sha": "033047a72cd3129831d4c0ae59024d77f17106ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/033047a72cd3129831d4c0ae59024d77f17106ec", "html_url": "https://github.com/rust-lang/rust/commit/033047a72cd3129831d4c0ae59024d77f17106ec"}], "stats": {"total": 49, "additions": 32, "deletions": 17}, "files": [{"sha": "d59fa71406c31197c75a4bedbe1545463f302b8a", "filename": "compiler/rustc_trait_selection/src/solve/fulfill.rs", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/139a3c5b0aa4eb8b0ac21f561480f552072fdf64/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ffulfill.rs", "raw_url": "https://github.com/rust-lang/rust/raw/139a3c5b0aa4eb8b0ac21f561480f552072fdf64/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ffulfill.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ffulfill.rs?ref=139a3c5b0aa4eb8b0ac21f561480f552072fdf64", "patch": "@@ -1,5 +1,6 @@\n use std::mem;\n \n+use super::{Certainty, InferCtxtEvalExt};\n use rustc_infer::{\n     infer::InferCtxt,\n     traits::{\n@@ -8,8 +9,6 @@ use rustc_infer::{\n     },\n };\n \n-use super::{search_graph, Certainty, EvalCtxt};\n-\n /// A trait engine using the new trait solver.\n ///\n /// This is mostly identical to how `evaluate_all` works inside of the\n@@ -66,9 +65,7 @@ impl<'tcx> TraitEngine<'tcx> for FulfillmentCtxt<'tcx> {\n             let mut has_changed = false;\n             for obligation in mem::take(&mut self.obligations) {\n                 let goal = obligation.clone().into();\n-                let search_graph = &mut search_graph::SearchGraph::new(infcx.tcx);\n-                let mut ecx = EvalCtxt::new_outside_solver(infcx, search_graph);\n-                let (changed, certainty) = match ecx.evaluate_goal(goal) {\n+                let (changed, certainty) = match infcx.evaluate_root_goal(goal) {\n                     Ok(result) => result,\n                     Err(NoSolution) => {\n                         errors.push(FulfillmentError {"}, {"sha": "70f094014453edfcca6960ef8a09c64a5ab4798f", "filename": "compiler/rustc_trait_selection/src/solve/mod.rs", "status": "modified", "additions": 30, "deletions": 12, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/139a3c5b0aa4eb8b0ac21f561480f552072fdf64/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/139a3c5b0aa4eb8b0ac21f561480f552072fdf64/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Fmod.rs?ref=139a3c5b0aa4eb8b0ac21f561480f552072fdf64", "patch": "@@ -152,6 +152,36 @@ impl<'tcx> TyCtxtExt<'tcx> for TyCtxt<'tcx> {\n     }\n }\n \n+pub trait InferCtxtEvalExt<'tcx> {\n+    /// Evaluates a goal from **outside** of the trait solver.\n+    ///\n+    /// Using this while inside of the solver is wrong as it uses a new\n+    /// search graph which would break cycle detection.\n+    fn evaluate_root_goal(\n+        &self,\n+        goal: Goal<'tcx, ty::Predicate<'tcx>>,\n+    ) -> Result<(bool, Certainty), NoSolution>;\n+}\n+\n+impl<'tcx> InferCtxtEvalExt<'tcx> for InferCtxt<'tcx> {\n+    fn evaluate_root_goal(\n+        &self,\n+        goal: Goal<'tcx, ty::Predicate<'tcx>>,\n+    ) -> Result<(bool, Certainty), NoSolution> {\n+        let mut search_graph = search_graph::SearchGraph::new(self.tcx);\n+\n+        let result = EvalCtxt {\n+            search_graph: &mut search_graph,\n+            infcx: self,\n+            var_values: CanonicalVarValues::dummy(),\n+        }\n+        .evaluate_goal(goal);\n+\n+        assert!(search_graph.is_empty());\n+        result\n+    }\n+}\n+\n struct EvalCtxt<'a, 'tcx> {\n     infcx: &'a InferCtxt<'tcx>,\n     var_values: CanonicalVarValues<'tcx>,\n@@ -164,18 +194,6 @@ impl<'a, 'tcx> EvalCtxt<'a, 'tcx> {\n         self.infcx.tcx\n     }\n \n-    /// Creates a new evaluation context outside of the trait solver.\n-    ///\n-    /// With this solver making a canonical response doesn't make much sense.\n-    /// The `search_graph` for this solver has to be completely empty.\n-    fn new_outside_solver(\n-        infcx: &'a InferCtxt<'tcx>,\n-        search_graph: &'a mut search_graph::SearchGraph<'tcx>,\n-    ) -> EvalCtxt<'a, 'tcx> {\n-        assert!(search_graph.is_empty());\n-        EvalCtxt { infcx, var_values: CanonicalVarValues::dummy(), search_graph }\n-    }\n-\n     #[instrument(level = \"debug\", skip(tcx, search_graph), ret)]\n     fn evaluate_canonical_goal(\n         tcx: TyCtxt<'tcx>,"}]}