{"sha": "c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM5ZDQ2ZWIyMjQ0ZDQ5MjE1ZTBhMWNjZjhiZDRiN2U3MDBiMjUyZTc=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2020-11-23T14:26:10Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2021-09-08T16:23:37Z"}, "message": "Rework DepthFirstSearch API\n\nThis expands the API to be more flexible, allowing for more visitation patterns\non graphs. This will be useful to avoid extra datasets (and allocations) in\ncases where the expanded DFS API is sufficient.\n\nThis also fixes a bug with the previous DFS constructor, which left the start\nnode not marked as visited (even though it was immediately returned).", "tree": {"sha": "b74c11abe1c30a0f528ff5c2ef3a711771937495", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b74c11abe1c30a0f528ff5c2ef3a711771937495"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7", "html_url": "https://github.com/rust-lang/rust/commit/c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "11bbb5231349a0a144d86d5c0c21061a06d1969d", "url": "https://api.github.com/repos/rust-lang/rust/commits/11bbb5231349a0a144d86d5c0c21061a06d1969d", "html_url": "https://github.com/rust-lang/rust/commit/11bbb5231349a0a144d86d5c0c21061a06d1969d"}], "stats": {"total": 72, "additions": 69, "deletions": 3}, "files": [{"sha": "a9db3497b23908a50548e9a24ab74f189feed37d", "filename": "compiler/rustc_data_structures/src/graph/iterate/mod.rs", "status": "modified", "additions": 52, "deletions": 2, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fiterate%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fiterate%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fiterate%2Fmod.rs?ref=c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7", "patch": "@@ -83,8 +83,58 @@ impl<G> DepthFirstSearch<'graph, G>\n where\n     G: ?Sized + DirectedGraph + WithNumNodes + WithSuccessors,\n {\n-    pub fn new(graph: &'graph G, start_node: G::Node) -> Self {\n-        Self { graph, stack: vec![start_node], visited: BitSet::new_empty(graph.num_nodes()) }\n+    pub fn new(graph: &'graph G) -> Self {\n+        Self { graph, stack: vec![], visited: BitSet::new_empty(graph.num_nodes()) }\n+    }\n+\n+    /// Version of `push_start_node` that is convenient for chained\n+    /// use.\n+    pub fn with_start_node(mut self, start_node: G::Node) -> Self {\n+        self.push_start_node(start_node);\n+        self\n+    }\n+\n+    /// Pushes another start node onto the stack. If the node\n+    /// has not already been visited, then you will be able to\n+    /// walk its successors (and so forth) after the current\n+    /// contents of the stack are drained. If multiple start nodes\n+    /// are added into the walk, then their mutual successors\n+    /// will all be walked. You can use this method once the\n+    /// iterator has been completely drained to add additional\n+    /// start nodes.\n+    pub fn push_start_node(&mut self, start_node: G::Node) {\n+        if self.visited.insert(start_node) {\n+            self.stack.push(start_node);\n+        }\n+    }\n+\n+    /// Searches all nodes reachable from the current start nodes.\n+    /// This is equivalent to just invoke `next` repeatedly until\n+    /// you get a `None` result.\n+    pub fn complete_search(&mut self) {\n+        while let Some(_) = self.next() {}\n+    }\n+\n+    /// Returns true if node has been visited thus far.\n+    /// A node is considered \"visited\" once it is pushed\n+    /// onto the internal stack; it may not yet have been yielded\n+    /// from the iterator. This method is best used after\n+    /// the iterator is completely drained.\n+    pub fn visited(&self, node: G::Node) -> bool {\n+        self.visited.contains(node)\n+    }\n+}\n+\n+impl<G> std::fmt::Debug for DepthFirstSearch<'_, G>\n+where\n+    G: ?Sized + DirectedGraph + WithNumNodes + WithSuccessors,\n+{\n+    fn fmt(&self, fmt: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n+        let mut f = fmt.debug_set();\n+        for n in self.visited.iter() {\n+            f.entry(&n);\n+        }\n+        f.finish()\n     }\n }\n "}, {"sha": "c498c289337f1a1eebe77955943ab88812ae2b9c", "filename": "compiler/rustc_data_structures/src/graph/iterate/tests.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fiterate%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fiterate%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fiterate%2Ftests.rs?ref=c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7", "patch": "@@ -20,3 +20,19 @@ fn is_cyclic() {\n     assert!(!is_cyclic(&diamond_acyclic));\n     assert!(is_cyclic(&diamond_cyclic));\n }\n+\n+#[test]\n+fn dfs() {\n+    let graph = TestGraph::new(0, &[(0, 1), (0, 2), (1, 3), (2, 3), (3, 0)]);\n+\n+    let result: Vec<usize> = DepthFirstSearch::new(&graph).with_start_node(0).collect();\n+    assert_eq!(result, vec![0, 2, 3, 1]);\n+}\n+\n+#[test]\n+fn dfs_debug() {\n+    let graph = TestGraph::new(0, &[(0, 1), (0, 2), (1, 3), (2, 3), (3, 0)]);\n+    let mut dfs = DepthFirstSearch::new(&graph).with_start_node(0);\n+    dfs.complete_search();\n+    assert_eq!(format!(\"{{0, 1, 2, 3}}\"), format!(\"{:?}\", dfs));\n+}"}, {"sha": "3560df6e5e204548dc2966179e26052d90298bfb", "filename": "compiler/rustc_data_structures/src/graph/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fmod.rs?ref=c9d46eb2244d49215e0a1ccf8bd4b7e700b252e7", "patch": "@@ -32,7 +32,7 @@ where\n     where\n         Self: WithNumNodes,\n     {\n-        iterate::DepthFirstSearch::new(self, from)\n+        iterate::DepthFirstSearch::new(self).with_start_node(from)\n     }\n }\n "}]}