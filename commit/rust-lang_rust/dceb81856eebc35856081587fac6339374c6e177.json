{"sha": "dceb81856eebc35856081587fac6339374c6e177", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRjZWI4MTg1NmVlYmMzNTg1NjA4MTU4N2ZhYzYzMzkzNzRjNmUxNzc=", "commit": {"author": {"name": "Veetaha", "email": "veetaha2@gmail.com", "date": "2020-06-20T12:38:08Z"}, "committer": {"name": "Veetaha", "email": "veetaha2@gmail.com", "date": "2020-06-20T12:45:30Z"}, "message": "Download artifacts into tmp dir", "tree": {"sha": "76e5bf29adb5078623a60446647313ff0a3d8e43", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/76e5bf29adb5078623a60446647313ff0a3d8e43"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dceb81856eebc35856081587fac6339374c6e177", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dceb81856eebc35856081587fac6339374c6e177", "html_url": "https://github.com/rust-lang/rust/commit/dceb81856eebc35856081587fac6339374c6e177", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dceb81856eebc35856081587fac6339374c6e177/comments", "author": {"login": "Veetaha", "id": 36276403, "node_id": "MDQ6VXNlcjM2Mjc2NDAz", "avatar_url": "https://avatars.githubusercontent.com/u/36276403?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veetaha", "html_url": "https://github.com/Veetaha", "followers_url": "https://api.github.com/users/Veetaha/followers", "following_url": "https://api.github.com/users/Veetaha/following{/other_user}", "gists_url": "https://api.github.com/users/Veetaha/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veetaha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veetaha/subscriptions", "organizations_url": "https://api.github.com/users/Veetaha/orgs", "repos_url": "https://api.github.com/users/Veetaha/repos", "events_url": "https://api.github.com/users/Veetaha/events{/privacy}", "received_events_url": "https://api.github.com/users/Veetaha/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veetaha", "id": 36276403, "node_id": "MDQ6VXNlcjM2Mjc2NDAz", "avatar_url": "https://avatars.githubusercontent.com/u/36276403?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veetaha", "html_url": "https://github.com/Veetaha", "followers_url": "https://api.github.com/users/Veetaha/followers", "following_url": "https://api.github.com/users/Veetaha/following{/other_user}", "gists_url": "https://api.github.com/users/Veetaha/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veetaha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veetaha/subscriptions", "organizations_url": "https://api.github.com/users/Veetaha/orgs", "repos_url": "https://api.github.com/users/Veetaha/repos", "events_url": "https://api.github.com/users/Veetaha/events{/privacy}", "received_events_url": "https://api.github.com/users/Veetaha/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0f7961d5570f17d6c2098ab11d2a3bcbbfb84ff6", "url": "https://api.github.com/repos/rust-lang/rust/commits/0f7961d5570f17d6c2098ab11d2a3bcbbfb84ff6", "html_url": "https://github.com/rust-lang/rust/commit/0f7961d5570f17d6c2098ab11d2a3bcbbfb84ff6"}], "stats": {"total": 71, "additions": 60, "deletions": 11}, "files": [{"sha": "670f2ebfd628f2f883a12943eccdfb68981b1236", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/dceb81856eebc35856081587fac6339374c6e177/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/dceb81856eebc35856081587fac6339374c6e177/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=dceb81856eebc35856081587fac6339374c6e177", "patch": "@@ -42,7 +42,16 @@ export async function activate(context: vscode.ExtensionContext) {\n \n     const config = new Config(context);\n     const state = new PersistentState(context.globalState);\n-    const serverPath = await bootstrap(config, state);\n+    const serverPath = await bootstrap(config, state).catch(err => {\n+        let message = \"Failed to bootstrap rust-analyzer.\";\n+        if (err.code === \"EBUSY\" || err.code === \"ETXTBSY\") {\n+            message += \" Other vscode windows might be using rust-analyzer, \" +\n+                \"you should close them and reload this window to retry.\";\n+        }\n+        message += \" Open \\\"Help > Toggle Developer Tools > Console\\\" to see the logs\";\n+        log.error(\"Bootstrap error\", err);\n+        throw new Error(message);\n+    });\n \n     const workspaceFolder = vscode.workspace.workspaceFolders?.[0];\n     if (workspaceFolder === undefined) {\n@@ -285,6 +294,11 @@ async function getServer(config: Config, state: PersistentState): Promise<string\n     const artifact = release.assets.find(artifact => artifact.name === binaryName);\n     assert(!!artifact, `Bad release: ${JSON.stringify(release)}`);\n \n+    // Unlinking the exe file before moving new one on its place should prevent ETXTBSY error.\n+    await fs.unlink(dest).catch(err => {\n+        if (err.code !== \"ENOENT\") throw err;\n+    });\n+\n     await download(artifact.browser_download_url, dest, \"Downloading rust-analyzer server\", { mode: 0o755 });\n \n     // Patching executable if that's NixOS."}, {"sha": "0e7dd29c264c55d4a448125aa52ac7cd5e6fdd9b", "filename": "editors/code/src/net.ts", "status": "modified", "additions": 45, "deletions": 10, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/dceb81856eebc35856081587fac6339374c6e177/editors%2Fcode%2Fsrc%2Fnet.ts", "raw_url": "https://github.com/rust-lang/rust/raw/dceb81856eebc35856081587fac6339374c6e177/editors%2Fcode%2Fsrc%2Fnet.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fnet.ts?ref=dceb81856eebc35856081587fac6339374c6e177", "patch": "@@ -1,7 +1,9 @@\n import fetch from \"node-fetch\";\n import * as vscode from \"vscode\";\n-import * as fs from \"fs\";\n import * as stream from \"stream\";\n+import * as fs from \"fs\";\n+import * as os from \"os\";\n+import * as path from \"path\";\n import * as util from \"util\";\n import { log, assert } from \"./util\";\n \n@@ -87,7 +89,7 @@ export async function download(\n }\n \n /**\n- * Downloads file from `url` and stores it at `destFilePath` with `destFilePermissions`.\n+ * Downloads file from `url` and stores it at `destFilePath` with `mode` (unix permissions).\n  * `onProgress` callback is called on recieveing each chunk of bytes\n  * to track the progress of downloading, it gets the already read and total\n  * amount of bytes to read as its parameters.\n@@ -118,13 +120,46 @@ async function downloadFile(\n         onProgress(readBytes, totalBytes);\n     });\n \n-    const destFileStream = fs.createWriteStream(destFilePath, { mode });\n-\n-    await pipeline(res.body, destFileStream);\n-    return new Promise<void>(resolve => {\n-        destFileStream.on(\"close\", resolve);\n-        destFileStream.destroy();\n-        // This workaround is awaiting to be removed when vscode moves to newer nodejs version:\n-        // https://github.com/rust-analyzer/rust-analyzer/issues/3167\n+    // Put the artifact into a temporary folder to prevent partially downloaded files when user kills vscode\n+    await withTempFile(async tempFilePath => {\n+        const destFileStream = fs.createWriteStream(tempFilePath, { mode });\n+        await pipeline(res.body, destFileStream);\n+        await new Promise<void>(resolve => {\n+            destFileStream.on(\"close\", resolve);\n+            destFileStream.destroy();\n+            // This workaround is awaiting to be removed when vscode moves to newer nodejs version:\n+            // https://github.com/rust-analyzer/rust-analyzer/issues/3167\n+        });\n+        await moveFile(tempFilePath, destFilePath);\n     });\n }\n+\n+async function withTempFile(scope: (tempFilePath: string) => Promise<void>) {\n+    // Based on the great article: https://advancedweb.hu/secure-tempfiles-in-nodejs-without-dependencies/\n+\n+    // `.realpath()` should handle the cases where os.tmpdir() contains symlinks\n+    const osTempDir = await fs.promises.realpath(os.tmpdir());\n+\n+    const tempDir = await fs.promises.mkdtemp(path.join(osTempDir, \"rust-analyzer\"));\n+\n+    try {\n+        return await scope(path.join(tempDir, \"file\"));\n+    } finally {\n+        // We are good citizens :D\n+        void fs.promises.rmdir(tempDir, { recursive: true }).catch(log.error);\n+    }\n+};\n+\n+async function moveFile(src: fs.PathLike, dest: fs.PathLike) {\n+    try {\n+        await fs.promises.rename(src, dest);\n+    } catch (err) {\n+        if (err.code === 'EXDEV') {\n+            // We are probably moving the file across partitions/devices\n+            await fs.promises.copyFile(src, dest);\n+            await fs.promises.unlink(src);\n+        } else {\n+            log.error(`Failed to rename the file ${src} -> ${dest}`, err);\n+        }\n+    }\n+}"}]}