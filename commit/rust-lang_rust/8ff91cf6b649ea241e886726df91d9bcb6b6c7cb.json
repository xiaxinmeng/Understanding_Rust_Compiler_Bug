{"sha": "8ff91cf6b649ea241e886726df91d9bcb6b6c7cb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhmZjkxY2Y2YjY0OWVhMjQxZTg4NjcyNmRmOTFkOWJjYjZiNmM3Y2I=", "commit": {"author": {"name": "Leander Tentrup", "email": "leander.tentrup@gmail.com", "date": "2020-06-16T21:03:59Z"}, "committer": {"name": "Leander Tentrup", "email": "leander.tentrup@gmail.com", "date": "2020-06-16T21:03:59Z"}, "message": "Inspect markdown code fences to determine whether to apply syntax highlighting", "tree": {"sha": "dccf7e441820c421d9690b5ff273078f7426523c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dccf7e441820c421d9690b5ff273078f7426523c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8ff91cf6b649ea241e886726df91d9bcb6b6c7cb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8ff91cf6b649ea241e886726df91d9bcb6b6c7cb", "html_url": "https://github.com/rust-lang/rust/commit/8ff91cf6b649ea241e886726df91d9bcb6b6c7cb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8ff91cf6b649ea241e886726df91d9bcb6b6c7cb/comments", "author": {"login": "ltentrup", "id": 201808, "node_id": "MDQ6VXNlcjIwMTgwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/201808?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ltentrup", "html_url": "https://github.com/ltentrup", "followers_url": "https://api.github.com/users/ltentrup/followers", "following_url": "https://api.github.com/users/ltentrup/following{/other_user}", "gists_url": "https://api.github.com/users/ltentrup/gists{/gist_id}", "starred_url": "https://api.github.com/users/ltentrup/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ltentrup/subscriptions", "organizations_url": "https://api.github.com/users/ltentrup/orgs", "repos_url": "https://api.github.com/users/ltentrup/repos", "events_url": "https://api.github.com/users/ltentrup/events{/privacy}", "received_events_url": "https://api.github.com/users/ltentrup/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ltentrup", "id": 201808, "node_id": "MDQ6VXNlcjIwMTgwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/201808?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ltentrup", "html_url": "https://github.com/ltentrup", "followers_url": "https://api.github.com/users/ltentrup/followers", "following_url": "https://api.github.com/users/ltentrup/following{/other_user}", "gists_url": "https://api.github.com/users/ltentrup/gists{/gist_id}", "starred_url": "https://api.github.com/users/ltentrup/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ltentrup/subscriptions", "organizations_url": "https://api.github.com/users/ltentrup/orgs", "repos_url": "https://api.github.com/users/ltentrup/repos", "events_url": "https://api.github.com/users/ltentrup/events{/privacy}", "received_events_url": "https://api.github.com/users/ltentrup/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5d7974e5fb921236fea74731d8edde518f08e73a", "url": "https://api.github.com/repos/rust-lang/rust/commits/5d7974e5fb921236fea74731d8edde518f08e73a", "html_url": "https://github.com/rust-lang/rust/commit/5d7974e5fb921236fea74731d8edde518f08e73a"}], "stats": {"total": 26, "additions": 22, "deletions": 4}, "files": [{"sha": "13a5d1b12a2021c1c57a98fb5d78ad028747e6c5", "filename": "crates/ra_ide/src/snapshots/highlight_doctest.html", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/8ff91cf6b649ea241e886726df91d9bcb6b6c7cb/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlight_doctest.html", "raw_url": "https://github.com/rust-lang/rust/raw/8ff91cf6b649ea241e886726df91d9bcb6b6c7cb/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlight_doctest.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlight_doctest.html?ref=8ff91cf6b649ea241e886726df91d9bcb6b6c7cb", "patch": "@@ -73,9 +73,13 @@\n     <span class=\"comment\">///</span>\n     <span class=\"comment\">/// ```</span>\n     <span class=\"comment\">///</span>\n-    <span class=\"comment\">/// ```</span>\n+    <span class=\"comment\">/// ```rust,no_run</span>\n     <span class=\"comment\">/// </span><span class=\"keyword\">let</span> <span class=\"variable declaration\">foobar</span> = <span class=\"struct\">Foo</span>::<span class=\"function\">new</span>().<span class=\"function\">bar</span>();\n     <span class=\"comment\">/// ```</span>\n+    <span class=\"comment\">///</span>\n+    <span class=\"comment\">/// ```sh</span>\n+    <span class=\"comment\">/// echo 1</span>\n+    <span class=\"comment\">/// ```</span>\n     <span class=\"keyword\">pub</span> <span class=\"keyword\">fn</span> <span class=\"function declaration\">foo</span>(&<span class=\"self_keyword\">self</span>) -&gt; <span class=\"builtin_type\">bool</span> {\n         <span class=\"bool_literal\">true</span>\n     }"}, {"sha": "929a5cc5c0a08ee0f63a8afe326ec7cd1ca54a52", "filename": "crates/ra_ide/src/syntax_highlighting/injection.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/8ff91cf6b649ea241e886726df91d9bcb6b6c7cb/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Finjection.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ff91cf6b649ea241e886726df91d9bcb6b6c7cb/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Finjection.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Finjection.rs?ref=8ff91cf6b649ea241e886726df91d9bcb6b6c7cb", "patch": "@@ -53,6 +53,10 @@ pub(super) fn highlight_injection(\n /// Mapping from extracted documentation code to original code\n type RangesMap = BTreeMap<TextSize, TextSize>;\n \n+const RUSTDOC_FENCE: &'static str = \"```\";\n+const RUSTDOC_FENCE_TOKENS: &[&'static str] =\n+    &[\"\", \"rust\", \"should_panic\", \"ignore\", \"no_run\", \"compile_fail\", \"edition2015\", \"edition2018\"];\n+\n /// Extracts Rust code from documentation comments as well as a mapping from\n /// the extracted source code back to the original source ranges.\n /// Lastly, a vector of new comment highlight ranges (spanning only the\n@@ -67,6 +71,7 @@ pub(super) fn extract_doc_comments(\n     // Mapping from extracted documentation code to original code\n     let mut range_mapping: RangesMap = BTreeMap::new();\n     let mut line_start = TextSize::try_from(prefix.len()).unwrap();\n+    let mut is_codeblock = false;\n     let mut is_doctest = false;\n     // Replace the original, line-spanning comment ranges by new, only comment-prefix\n     // spanning comment ranges.\n@@ -76,8 +81,13 @@ pub(super) fn extract_doc_comments(\n         .filter_map(|el| el.into_token().and_then(ast::Comment::cast))\n         .filter(|comment| comment.kind().doc.is_some())\n         .filter(|comment| {\n-            if comment.text().contains(\"```\") {\n-                is_doctest = !is_doctest;\n+            if let Some(idx) = comment.text().find(RUSTDOC_FENCE) {\n+                is_codeblock = !is_codeblock;\n+                // Check whether code is rust by inspecting fence guards\n+                let guards = &comment.text()[idx + RUSTDOC_FENCE.len()..];\n+                let is_rust =\n+                    guards.split(',').all(|sub| RUSTDOC_FENCE_TOKENS.contains(&sub.trim()));\n+                is_doctest = is_codeblock && is_rust;\n                 false\n             } else {\n                 is_doctest"}, {"sha": "ebf5b50ac0459a4d60babe254d57ccd5c482c207", "filename": "crates/ra_ide/src/syntax_highlighting/tests.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/8ff91cf6b649ea241e886726df91d9bcb6b6c7cb/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ff91cf6b649ea241e886726df91d9bcb6b6c7cb/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs?ref=8ff91cf6b649ea241e886726df91d9bcb6b6c7cb", "patch": "@@ -329,9 +329,13 @@ impl Foo {\n     ///\n     /// ```\n     ///\n-    /// ```\n+    /// ```rust,no_run\n     /// let foobar = Foo::new().bar();\n     /// ```\n+    ///\n+    /// ```sh\n+    /// echo 1\n+    /// ```\n     pub fn foo(&self) -> bool {\n         true\n     }"}]}