{"sha": "12f6bdcfd9fe1393887b3be0d0329fcf11492e75", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEyZjZiZGNmZDlmZTEzOTM4ODdiM2JlMGQwMzI5ZmNmMTE0OTJlNzU=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2021-03-09T17:18:35Z"}, "committer": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2021-03-09T17:27:23Z"}, "message": "Check ancestor maps when computing traits in scope", "tree": {"sha": "88a83002c062b99d7a5dbbc61814c5b051b0c8b6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/88a83002c062b99d7a5dbbc61814c5b051b0c8b6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/12f6bdcfd9fe1393887b3be0d0329fcf11492e75", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/12f6bdcfd9fe1393887b3be0d0329fcf11492e75", "html_url": "https://github.com/rust-lang/rust/commit/12f6bdcfd9fe1393887b3be0d0329fcf11492e75", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/12f6bdcfd9fe1393887b3be0d0329fcf11492e75/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6be4f30cae93479c19dfe313ab13b8ffd3f7a27f", "url": "https://api.github.com/repos/rust-lang/rust/commits/6be4f30cae93479c19dfe313ab13b8ffd3f7a27f", "html_url": "https://github.com/rust-lang/rust/commit/6be4f30cae93479c19dfe313ab13b8ffd3f7a27f"}], "stats": {"total": 43, "additions": 43, "deletions": 0}, "files": [{"sha": "28b184f7cf6b10103ecc45071168d5eb999256b5", "filename": "crates/hir_def/src/resolver.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/12f6bdcfd9fe1393887b3be0d0329fcf11492e75/crates%2Fhir_def%2Fsrc%2Fresolver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12f6bdcfd9fe1393887b3be0d0329fcf11492e75/crates%2Fhir_def%2Fsrc%2Fresolver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fresolver.rs?ref=12f6bdcfd9fe1393887b3be0d0329fcf11492e75", "patch": "@@ -342,6 +342,16 @@ impl Resolver {\n                     traits.extend(prelude_def_map[prelude.local_id].scope.traits());\n                 }\n                 traits.extend(m.def_map[m.module_id].scope.traits());\n+\n+                // Add all traits that are in scope because of the containing DefMaps\n+                m.def_map.with_ancestor_maps(db, m.module_id, &mut |def_map, module| {\n+                    if let Some(prelude) = def_map.prelude() {\n+                        let prelude_def_map = prelude.def_map(db);\n+                        traits.extend(prelude_def_map[prelude.local_id].scope.traits());\n+                    }\n+                    traits.extend(def_map[module].scope.traits());\n+                    None::<()>\n+                });\n             }\n         }\n         traits"}, {"sha": "e185b1c0a16c7b8e27bd79fec889963dc9d7cc2f", "filename": "crates/hir_ty/src/tests/traits.rs", "status": "modified", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/12f6bdcfd9fe1393887b3be0d0329fcf11492e75/crates%2Fhir_ty%2Fsrc%2Ftests%2Ftraits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12f6bdcfd9fe1393887b3be0d0329fcf11492e75/crates%2Fhir_ty%2Fsrc%2Ftests%2Ftraits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Ftraits.rs?ref=12f6bdcfd9fe1393887b3be0d0329fcf11492e75", "patch": "@@ -3173,6 +3173,39 @@ fn f() {\n     );\n }\n \n+#[test]\n+fn trait_in_scope_with_inner_item() {\n+    check_infer(\n+        r#\"\n+mod m {\n+    pub trait Tr {\n+        fn method(&self) -> u8 { 0 }\n+    }\n+\n+    impl Tr for () {}\n+}\n+\n+use m::Tr;\n+\n+fn f() {\n+    fn inner() {\n+        ().method();\n+      //^^^^^^^^^^^ u8\n+    }\n+}\n+        \"#,\n+        expect![[r#\"\n+            46..50 'self': &Self\n+            58..63 '{ 0 }': u8\n+            60..61 '0': u8\n+            115..185 '{     ...   } }': ()\n+            132..183 '{     ...     }': ()\n+            142..144 '()': ()\n+            142..153 '().method()': u8\n+        \"#]],\n+    );\n+}\n+\n #[test]\n fn inner_use_in_block() {\n     check_types("}]}