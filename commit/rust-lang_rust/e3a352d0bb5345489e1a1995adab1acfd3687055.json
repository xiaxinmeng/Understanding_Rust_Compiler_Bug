{"sha": "e3a352d0bb5345489e1a1995adab1acfd3687055", "node_id": "C_kwDOAAsO6NoAKGUzYTM1MmQwYmI1MzQ1NDg5ZTFhMTk5NWFkYWIxYWNmZDM2ODcwNTU", "commit": {"author": {"name": "blyxyas", "email": "blyxyas@gmail.com", "date": "2023-04-16T15:24:59Z"}, "committer": {"name": "Philipp Krones", "email": "hello@philkrones.com", "date": "2023-04-16T21:16:27Z"}, "message": "Add new chapter: \"Macro Expansions\"\n\nCo-authored-by: Nahua <kangnahua@gmail.com>", "tree": {"sha": "75e5660752cf13d2b7918f2b27494c772357a2b5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/75e5660752cf13d2b7918f2b27494c772357a2b5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e3a352d0bb5345489e1a1995adab1acfd3687055", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEij1UXJ/PQTcb99vTHKDfKvWdaKUFAmQ8ZasACgkQHKDfKvWd\naKV+nQ//Q6XcwGVfbBRWT0TXhIbyftuC7EfCqMcTzjl2tc/ZPM3sEE202U3qYroT\nNDO2k1Wz29ObEsXVUIRRTcfpffmJm/2GFJLhwmcmqcmtahKsDjFu98H2t1wXIRcN\nXdDtq5hxiQj5lagyKd73u7cdc591dSRA1h7ajsOCI16y9DO709OBHD4S02O9h6Lu\n3p4Exb5Fp24MbbKiVFzkbdBOvoZ8UnqeTIMutvrlw9yhRAhkdCIyE0eVgkzWTsEz\nSsKPNHZfRnti8LPZ3gdoJmr6iUjdG4v1Zv0WBwqhTs4lY/RPogANI/drBNEVR0Cn\nwuOdDpO8IgpaG8I2HcKXOTGWejtixlXM4GEPx56kQEzsUkFWzCLlcsDT2nxnPyaE\njxSwwf3O/rjGbEFETq7NSPWnY2VnUKDYCTMPNDnF/66Ev7VD13pfhepnwWKDtz8Y\ndfnHDWCVVZyvBORwp940Bn/KPBi86FQqH2RZOTM8o2f+IZgaEYILqdQnS8tovKc2\nPGjzJwUOIMU29gRCP7XMTFbFhvEIzi5CfRHShHw5a26nB2Gy7kAij4fh3CrWuy0p\n0uGYtF+ZKCSe6UV53cX9N1bfcTaKHxGFjRriZlR/jARHv3knUSI3mWVMnJQ0ipj7\nP8gF1kqGBzEJ1yI4NZSB4uXIOZORCgNrS0Sfw43U2YgW6VtJvf4=\n=b1nD\n-----END PGP SIGNATURE-----", "payload": "tree 75e5660752cf13d2b7918f2b27494c772357a2b5\nparent 004981647f6f7bd2e70808651e897b1e6b719bb4\nauthor blyxyas <blyxyas@gmail.com> 1681658699 +0200\ncommitter Philipp Krones <hello@philkrones.com> 1681679787 +0200\n\nAdd new chapter: \"Macro Expansions\"\n\nCo-authored-by: Nahua <kangnahua@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e3a352d0bb5345489e1a1995adab1acfd3687055", "html_url": "https://github.com/rust-lang/rust/commit/e3a352d0bb5345489e1a1995adab1acfd3687055", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e3a352d0bb5345489e1a1995adab1acfd3687055/comments", "author": {"login": "blyxyas", "id": 73757586, "node_id": "MDQ6VXNlcjczNzU3NTg2", "avatar_url": "https://avatars.githubusercontent.com/u/73757586?v=4", "gravatar_id": "", "url": "https://api.github.com/users/blyxyas", "html_url": "https://github.com/blyxyas", "followers_url": "https://api.github.com/users/blyxyas/followers", "following_url": "https://api.github.com/users/blyxyas/following{/other_user}", "gists_url": "https://api.github.com/users/blyxyas/gists{/gist_id}", "starred_url": "https://api.github.com/users/blyxyas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/blyxyas/subscriptions", "organizations_url": "https://api.github.com/users/blyxyas/orgs", "repos_url": "https://api.github.com/users/blyxyas/repos", "events_url": "https://api.github.com/users/blyxyas/events{/privacy}", "received_events_url": "https://api.github.com/users/blyxyas/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "004981647f6f7bd2e70808651e897b1e6b719bb4", "url": "https://api.github.com/repos/rust-lang/rust/commits/004981647f6f7bd2e70808651e897b1e6b719bb4", "html_url": "https://github.com/rust-lang/rust/commit/004981647f6f7bd2e70808651e897b1e6b719bb4"}], "stats": {"total": 159, "additions": 159, "deletions": 0}, "files": [{"sha": "b61343c877345ac69449da6c6535bb99f4216de9", "filename": "book/src/SUMMARY.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e3a352d0bb5345489e1a1995adab1acfd3687055/book%2Fsrc%2FSUMMARY.md", "raw_url": "https://github.com/rust-lang/rust/raw/e3a352d0bb5345489e1a1995adab1acfd3687055/book%2Fsrc%2FSUMMARY.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/book%2Fsrc%2FSUMMARY.md?ref=e3a352d0bb5345489e1a1995adab1acfd3687055", "patch": "@@ -14,6 +14,7 @@\n     - [Basics](development/basics.md)\n     - [Adding Lints](development/adding_lints.md)\n     - [Type Checking](development/type_checking.md)\n+    - [Macro Expansions](development/macro_expansions.md)\n     - [Common Tools](development/common_tools_writing_lints.md)\n     - [Infrastructure](development/infrastructure/README.md)\n         - [Syncing changes between Clippy and rust-lang/rust](development/infrastructure/sync.md)"}, {"sha": "c5eb000272d39e348900c5448bb2c55b6ee62e42", "filename": "book/src/development/macro_expansions.md", "status": "added", "additions": 158, "deletions": 0, "changes": 158, "blob_url": "https://github.com/rust-lang/rust/blob/e3a352d0bb5345489e1a1995adab1acfd3687055/book%2Fsrc%2Fdevelopment%2Fmacro_expansions.md", "raw_url": "https://github.com/rust-lang/rust/raw/e3a352d0bb5345489e1a1995adab1acfd3687055/book%2Fsrc%2Fdevelopment%2Fmacro_expansions.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/book%2Fsrc%2Fdevelopment%2Fmacro_expansions.md?ref=e3a352d0bb5345489e1a1995adab1acfd3687055", "patch": "@@ -0,0 +1,158 @@\n+# Dealing with macros and expansions\n+\n+Sometimes we might encounter Rust macro expansions while working with Clippy.\n+While macro expansions are not as dramatic and profound as the expansion\n+of our universe, they can certainly bring chaos to the orderly world\n+of code and logic.\n+\n+The general rule of thumb is that we should ignore code with macro\n+expansions when working with Clippy because the code can be dynamic\n+in ways that are difficult or impossible for us to foresee.\n+\n+## False Positives\n+\n+What exactly do we mean by _dynamic in ways that are difficult to foresee_?\n+\n+Macros are [expanded][expansion] in the `EarlyLintPass` level,\n+so the Abstract Syntax Tree (AST) is generated in place of macros.\n+This means the code which we work with in Clippy is already expanded.\n+\n+If we wrote a new lint, there is a possibility that the lint is\n+triggered in macro-generated code. Since this expanded macro code\n+is not written by the macro's user but really by the macro's author,\n+the user cannot and should not be responsible for fixing the issue\n+that triggers the lint.\n+\n+Besides, a [Span] in a macro can be changed by the macro author.\n+Therefore, any lint check related to lines or columns should be\n+avoided since they might be changed at any time and become unreliable\n+or incorrect information.\n+\n+Because of these unforeseeable or unstable behaviors, macro expansion\n+should often not be regarded as a part of the stable API.\n+This is also why most lints check if they are inside a macro or not\n+before emitting suggestions to the end user to avoid false positives.\n+\n+## How to Work with Macros\n+\n+Several functions are available for working with macros.\n+\n+### The `Span.from_expansion` method\n+\n+We could utilize a `span`'s [`from_expansion`] method, which\n+detects if the `span` is from a macro expansion / desugaring.\n+This is a very common first step in a lint:\n+\n+```rust\n+if expr.span.from_expansion() {\n+    // We most likely want to ignore it.\n+    return;\n+}\n+```\n+\n+### `Span.ctxt` method\n+\n+The `span`'s context, given by the method [`ctxt`] and returning [SpanContext],\n+represents if the span is from a macro expansion and, if it is, which\n+macro call expanded this span.\n+\n+Sometimes, it is useful to check if the context of two spans are equal.\n+For instance, suppose we have the following line of code that would\n+expand into `1 + 0`:\n+\n+```rust\n+// The following code expands to `1 + 0` for both `EarlyLintPass` and `LateLintPass`\n+1 + mac!()\n+```\n+\n+Assuming that we'd collect the `1` expression as a variable `left` and the\n+`0`/`mac!()` expression as a variable `right`, we can simply compare their\n+contexts. If the context is different, then we most likely are dealing with a\n+macro expansion and should just ignore it:\n+\n+```rust\n+if left.span.ctxt() != right.span.ctxt() {\n+    // The code author most likely cannot modify this expression\n+    return;\n+}\n+```\n+\n+> **Note**: Code that is not from expansion is in the \"root\" context.\n+> So any spans whose `from_expansion` returns `false` can be assumed\n+> to have the same context. Because of this, using `span.from_expansion()`\n+> is often sufficient.\n+\n+Going a bit deeper, in a simple expression such as `a == b`,\n+`a` and `b` have the same context.\n+However, in a `macro_rules!` with `a == $b`, `$b` is expanded to\n+an expression that contains a different context from `a`.\n+\n+Take a look at the following macro `m`:\n+\n+```rust\n+macro_rules! m {\n+    ($a:expr, $b:expr) => {\n+        if $a.is_some() {\n+            $b;\n+        }\n+    }\n+}\n+\n+let x: Option<u32> = Some(42);\n+m!(x, x.unwrap());\n+```\n+\n+If the `m!(x, x.unwrapp());` line is expanded, we would get two expanded\n+expressions:\n+\n+- `x.is_some()` (from the `$a.is_some()` line in the `m` macro)\n+- `x.unwrap()` (corresponding to `$b` in the `m` macro)\n+\n+Suppose `x.is_some()` expression's span is associated with the `x_is_some_span` variable\n+and `x.unwrap()` expression's span is associated with `x_unwrap_span` variable,\n+we could assume that these two spans do not share the same context:\n+\n+```rust\n+// x.is_some() is from inside the macro\n+// x.unwrap() is from outside the macro\n+assert_ne!(x_is_some_span.ctxt(), x_unwrap_span.ctxt());\n+```\n+\n+### The `in_external_macro` function\n+\n+`rustc_middle::lint` provides a function ([`in_external_macro`]) that can\n+detect if the given span is from a macro defined in a foreign crate.\n+\n+Therefore, if we really want a new lint to work with macro-generated code,\n+this is the next line of defense to avoid macros not defined inside\n+the current crate since it is unfair to the user if Clippy lints code\n+which the user cannot change.\n+\n+For example, assume we have the following code that is being examined\n+by Clippy:\n+\n+```rust\n+#[macro_use]\n+extern crate a_foreign_crate_with_macros;\n+\n+// `foo` macro is defined in `a_foreign_crate_with_macros`\n+foo!(\"bar\");\n+```\n+\n+Also assume that we get the corresponding variable `foo_span` for the\n+`foo` macro call, we could decide not to lint if `in_external_macro`\n+results in `true` (note that `cx` can be `EarlyContext` or `LateContext`):\n+\n+```rust\n+if in_external_macro(cx.sess(), foo_span) {\n+    // We should ignore macro from a foreign crate.\n+    return;\n+}\n+```\n+\n+[`ctxt`]: https://doc.rust-lang.org/stable/nightly-rustc/rustc_span/struct.Span.html#method.ctxt\n+[expansion]: https://rustc-dev-guide.rust-lang.org/macro-expansion.html#expansion-and-ast-integration\n+[`from_expansion`]: https://doc.rust-lang.org/stable/nightly-rustc/rustc_span/struct.Span.html#method.from_expansion\n+[`in_external_macro`]: https://doc.rust-lang.org/stable/nightly-rustc/rustc_middle/lint/fn.in_external_macro.html\n+[Span]: https://doc.rust-lang.org/stable/nightly-rustc/rustc_span/struct.Span.html\n+[SpanContext]: https://doc.rust-lang.org/stable/nightly-rustc/rustc_span/hygiene/struct.SyntaxContext.html"}]}