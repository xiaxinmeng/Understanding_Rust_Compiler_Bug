{"sha": "641be558fcdbddbabc1b6af841c05b61dbdd9d5f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY0MWJlNTU4ZmNkYmRkYmFiYzFiNmFmODQxYzA1YjYxZGJkZDlkNWY=", "commit": {"author": {"name": "lengyijun", "email": "sjtu5140809011@gmail.com", "date": "2021-08-22T07:22:28Z"}, "committer": {"name": "lengyijun", "email": "sjtu5140809011@gmail.com", "date": "2021-08-24T05:03:48Z"}, "message": "redundant_allocation: fix 7487", "tree": {"sha": "8d4a60249d1e89f17b8a9a405f03df15d1fc45a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8d4a60249d1e89f17b8a9a405f03df15d1fc45a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/641be558fcdbddbabc1b6af841c05b61dbdd9d5f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/641be558fcdbddbabc1b6af841c05b61dbdd9d5f", "html_url": "https://github.com/rust-lang/rust/commit/641be558fcdbddbabc1b6af841c05b61dbdd9d5f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/641be558fcdbddbabc1b6af841c05b61dbdd9d5f/comments", "author": {"login": "lengyijun", "id": 14830596, "node_id": "MDQ6VXNlcjE0ODMwNTk2", "avatar_url": "https://avatars.githubusercontent.com/u/14830596?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lengyijun", "html_url": "https://github.com/lengyijun", "followers_url": "https://api.github.com/users/lengyijun/followers", "following_url": "https://api.github.com/users/lengyijun/following{/other_user}", "gists_url": "https://api.github.com/users/lengyijun/gists{/gist_id}", "starred_url": "https://api.github.com/users/lengyijun/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lengyijun/subscriptions", "organizations_url": "https://api.github.com/users/lengyijun/orgs", "repos_url": "https://api.github.com/users/lengyijun/repos", "events_url": "https://api.github.com/users/lengyijun/events{/privacy}", "received_events_url": "https://api.github.com/users/lengyijun/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lengyijun", "id": 14830596, "node_id": "MDQ6VXNlcjE0ODMwNTk2", "avatar_url": "https://avatars.githubusercontent.com/u/14830596?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lengyijun", "html_url": "https://github.com/lengyijun", "followers_url": "https://api.github.com/users/lengyijun/followers", "following_url": "https://api.github.com/users/lengyijun/following{/other_user}", "gists_url": "https://api.github.com/users/lengyijun/gists{/gist_id}", "starred_url": "https://api.github.com/users/lengyijun/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lengyijun/subscriptions", "organizations_url": "https://api.github.com/users/lengyijun/orgs", "repos_url": "https://api.github.com/users/lengyijun/repos", "events_url": "https://api.github.com/users/lengyijun/events{/privacy}", "received_events_url": "https://api.github.com/users/lengyijun/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1fc1aee7be6e7e71f12eacd60b9b1040e7640fe4", "url": "https://api.github.com/repos/rust-lang/rust/commits/1fc1aee7be6e7e71f12eacd60b9b1040e7640fe4", "html_url": "https://github.com/rust-lang/rust/commit/1fc1aee7be6e7e71f12eacd60b9b1040e7640fe4"}], "stats": {"total": 39, "additions": 37, "deletions": 2}, "files": [{"sha": "ac7bdd6a1ebebf318c6e8eab2a46bbcb999b2328", "filename": "clippy_lints/src/types/redundant_allocation.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/641be558fcdbddbabc1b6af841c05b61dbdd9d5f/clippy_lints%2Fsrc%2Ftypes%2Fredundant_allocation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/641be558fcdbddbabc1b6af841c05b61dbdd9d5f/clippy_lints%2Fsrc%2Ftypes%2Fredundant_allocation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftypes%2Fredundant_allocation.rs?ref=641be558fcdbddbabc1b6af841c05b61dbdd9d5f", "patch": "@@ -54,7 +54,13 @@ pub(super) fn check(cx: &LateContext<'_>, hir_ty: &hir::Ty<'_>, qpath: &QPath<'_\n         _ => return false,\n     };\n     let inner_span = match get_qpath_generic_tys(inner_qpath).next() {\n-        Some(ty) => ty.span,\n+        Some(ty) => {\n+            // Box<Box<dyn T>> is smaller than Box<dyn T> because of wide pointers\n+            if matches!(ty.kind, TyKind::TraitObject(..)) {\n+                return false;\n+            }\n+            ty.span\n+        },\n         None => return false,\n     };\n     if inner_sym == outer_sym {"}, {"sha": "52fbc91e325555a9c808f57a47e76cc48e893363", "filename": "tests/ui/redundant_allocation.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/641be558fcdbddbabc1b6af841c05b61dbdd9d5f/tests%2Fui%2Fredundant_allocation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/641be558fcdbddbabc1b6af841c05b61dbdd9d5f/tests%2Fui%2Fredundant_allocation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fredundant_allocation.rs?ref=641be558fcdbddbabc1b6af841c05b61dbdd9d5f", "patch": "@@ -77,4 +77,24 @@ mod outer_arc {\n     }\n }\n \n+// https://github.com/rust-lang/rust-clippy/issues/7487\n+mod box_dyn {\n+    use std::boxed::Box;\n+    use std::rc::Rc;\n+    use std::sync::Arc;\n+\n+    pub trait T {}\n+\n+    struct S {\n+        a: Box<Box<dyn T>>,\n+        b: Rc<Box<dyn T>>,\n+        c: Arc<Box<dyn T>>,\n+    }\n+\n+    pub fn test_box(_: Box<Box<dyn T>>) {}\n+    pub fn test_rc(_: Rc<Box<dyn T>>) {}\n+    pub fn test_arc(_: Arc<Box<dyn T>>) {}\n+    pub fn test_rc_box(_: Rc<Box<Box<dyn T>>>) {}\n+}\n+\n fn main() {}"}, {"sha": "c3b10e5f5e679df879418117c4840aa6268b07dd", "filename": "tests/ui/redundant_allocation.stderr", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/641be558fcdbddbabc1b6af841c05b61dbdd9d5f/tests%2Fui%2Fredundant_allocation.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/641be558fcdbddbabc1b6af841c05b61dbdd9d5f/tests%2Fui%2Fredundant_allocation.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fredundant_allocation.stderr?ref=641be558fcdbddbabc1b6af841c05b61dbdd9d5f", "patch": "@@ -134,5 +134,14 @@ LL |     pub fn arc_test9<T>(foo: Arc<Rc<T>>) -> Arc<Rc<SubT<T>>> {\n    = note: `Rc<SubT<T>>` is already on the heap, `Arc<Rc<SubT<T>>>` makes an extra allocation\n    = help: consider using just `Arc<SubT<T>>` or `Rc<SubT<T>>`\n \n-error: aborting due to 15 previous errors\n+error: usage of `Rc<Box<Box<dyn T>>>`\n+  --> $DIR/redundant_allocation.rs:97:27\n+   |\n+LL |     pub fn test_rc_box(_: Rc<Box<Box<dyn T>>>) {}\n+   |                           ^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: `Box<Box<dyn T>>` is already on the heap, `Rc<Box<Box<dyn T>>>` makes an extra allocation\n+   = help: consider using just `Rc<Box<dyn T>>` or `Box<Box<dyn T>>`\n+\n+error: aborting due to 16 previous errors\n "}]}