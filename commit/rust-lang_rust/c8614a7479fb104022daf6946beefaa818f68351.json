{"sha": "c8614a7479fb104022daf6946beefaa818f68351", "node_id": "C_kwDOAAsO6NoAKGM4NjE0YTc0NzlmYjEwNDAyMmRhZjY5NDZiZWVmYWE4MThmNjgzNTE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-02-11T16:18:45Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-11T16:18:45Z"}, "message": "Rollup merge of #107912 - clubby789:doc-bad-enum-field, r=camelid,GuillaumeGomez\n\nrustdoc: Don't resolve link to field on different variant\n\nFix #107903\n\nThis also gives a more specific diagnostic when the enum has any fields", "tree": {"sha": "d75b4d4be3bc0928b948812aef339fb7635ebafe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d75b4d4be3bc0928b948812aef339fb7635ebafe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c8614a7479fb104022daf6946beefaa818f68351", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj57/lCRBK7hj4Ov3rIwAAch0IACGzYXWE89UtdnLihNmgsZYV\nOhTZoATRK8uQMtQwq1g7ZDaY6H6a+mOnoOnLF0rFhEXYAEIqmci6LTHr26CRqBbB\nz1Iie0Br2DHYh2VWm/nR+yeyCnz/+t4hiItv6wrmvaJQC7/csThG6mDNYm5NUl36\nrTueMB/ZtSMC5Zseo/VFv5XRYE0PBWviVHtQQSqQXqhPFwLlUg8MLbI4L/xeRly4\n3qIaHBD02aDD6UOyPZRGZN7Yfw9/hCb5l1uo8EFZ5H5fRvl4GouYkRZQj6GRlXZO\nEY8ks9LU2oy8bgpYLI0X9bHJ6bMB4OMLd6CGIbvplqA8XK42yFi+rIKDJE+ElDo=\n=Iewn\n-----END PGP SIGNATURE-----\n", "payload": "tree d75b4d4be3bc0928b948812aef339fb7635ebafe\nparent f95f68e6199e3ff1f74bfa4d64bed02dac7040ab\nparent ef8de38c8498885a46119f214e17f0237dab6251\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1676132325 +0100\ncommitter GitHub <noreply@github.com> 1676132325 +0100\n\nRollup merge of #107912 - clubby789:doc-bad-enum-field, r=camelid,GuillaumeGomez\n\nrustdoc: Don't resolve link to field on different variant\n\nFix #107903\n\nThis also gives a more specific diagnostic when the enum has any fields\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c8614a7479fb104022daf6946beefaa818f68351", "html_url": "https://github.com/rust-lang/rust/commit/c8614a7479fb104022daf6946beefaa818f68351", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c8614a7479fb104022daf6946beefaa818f68351/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f95f68e6199e3ff1f74bfa4d64bed02dac7040ab", "url": "https://api.github.com/repos/rust-lang/rust/commits/f95f68e6199e3ff1f74bfa4d64bed02dac7040ab", "html_url": "https://github.com/rust-lang/rust/commit/f95f68e6199e3ff1f74bfa4d64bed02dac7040ab"}, {"sha": "ef8de38c8498885a46119f214e17f0237dab6251", "url": "https://api.github.com/repos/rust-lang/rust/commits/ef8de38c8498885a46119f214e17f0237dab6251", "html_url": "https://github.com/rust-lang/rust/commit/ef8de38c8498885a46119f214e17f0237dab6251"}], "stats": {"total": 59, "additions": 54, "deletions": 5}, "files": [{"sha": "62e190b4bd8ed7b8ccd7d1e6cbc2a985c635ecce", "filename": "src/librustdoc/passes/collect_intra_doc_links.rs", "status": "modified", "additions": 25, "deletions": 4, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/c8614a7479fb104022daf6946beefaa818f68351/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c8614a7479fb104022daf6946beefaa818f68351/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs?ref=c8614a7479fb104022daf6946beefaa818f68351", "patch": "@@ -297,7 +297,8 @@ impl<'a, 'tcx> LinkCollector<'a, 'tcx> {\n         match ty_res {\n             Res::Def(DefKind::Enum, did) => match tcx.type_of(did).kind() {\n                 ty::Adt(def, _) if def.is_enum() => {\n-                    if let Some(field) = def.all_fields().find(|f| f.name == variant_field_name) {\n+                    if let Some(variant) = def.variants().iter().find(|v| v.name == variant_name)\n+                        && let Some(field) = variant.fields.iter().find(|f| f.name == variant_field_name) {\n                         Ok((ty_res, field.did))\n                     } else {\n                         Err(UnresolvedPath {\n@@ -1716,15 +1717,35 @@ fn resolution_failure(\n \n                     // Otherwise, it must be an associated item or variant\n                     let res = partial_res.expect(\"None case was handled by `last_found_module`\");\n-                    let kind = match res {\n-                        Res::Def(kind, _) => Some(kind),\n+                    let kind_did = match res {\n+                        Res::Def(kind, did) => Some((kind, did)),\n                         Res::Primitive(_) => None,\n                     };\n-                    let path_description = if let Some(kind) = kind {\n+                    let is_struct_variant = |did| {\n+                        if let ty::Adt(def, _) = tcx.type_of(did).kind()\n+                        && def.is_enum()\n+                        && let Some(variant) = def.variants().iter().find(|v| v.name == res.name(tcx)) {\n+                            // ctor is `None` if variant is a struct\n+                            variant.ctor.is_none()\n+                        } else {\n+                            false\n+                        }\n+                    };\n+                    let path_description = if let Some((kind, did)) = kind_did {\n                         match kind {\n                             Mod | ForeignMod => \"inner item\",\n                             Struct => \"field or associated item\",\n                             Enum | Union => \"variant or associated item\",\n+                            Variant if is_struct_variant(did) => {\n+                                let variant = res.name(tcx);\n+                                let note = format!(\"variant `{variant}` has no such field\");\n+                                if let Some(span) = sp {\n+                                    diag.span_label(span, &note);\n+                                } else {\n+                                    diag.note(&note);\n+                                }\n+                                return;\n+                            }\n                             Variant\n                             | Field\n                             | Closure"}, {"sha": "95dd2b98e037ed1b49001ca610fa6a8a6e19d6ec", "filename": "tests/rustdoc-ui/intra-doc/errors.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/c8614a7479fb104022daf6946beefaa818f68351/tests%2Frustdoc-ui%2Fintra-doc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c8614a7479fb104022daf6946beefaa818f68351/tests%2Frustdoc-ui%2Fintra-doc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-ui%2Fintra-doc%2Ferrors.rs?ref=c8614a7479fb104022daf6946beefaa818f68351", "patch": "@@ -103,3 +103,19 @@ pub trait T {\n macro_rules! m {\n     () => {};\n }\n+\n+///[`TestEnum::Variant1::field_name`]\n+//~^ ERROR unresolved link\n+//~| NOTE variant `Variant1` has no such field\n+pub enum TestEnum {\n+    Variant1 {},\n+    Variant2 { field_name: u64 },\n+}\n+\n+///[`TestEnumNoFields::Variant1::field_name`]\n+//~^ ERROR unresolved link\n+//~| NOTE `Variant1` is a variant, not a module or type, and cannot have associated items\n+pub enum TestEnumNoFields {\n+    Variant1 (),\n+    Variant2 {},\n+}"}, {"sha": "1b2416d7da76570b745501df69df93a2b0e1e80a", "filename": "tests/rustdoc-ui/intra-doc/errors.stderr", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/c8614a7479fb104022daf6946beefaa818f68351/tests%2Frustdoc-ui%2Fintra-doc%2Ferrors.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c8614a7479fb104022daf6946beefaa818f68351/tests%2Frustdoc-ui%2Fintra-doc%2Ferrors.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-ui%2Fintra-doc%2Ferrors.stderr?ref=c8614a7479fb104022daf6946beefaa818f68351", "patch": "@@ -142,6 +142,18 @@ error: unresolved link to `T::h`\n LL | /// [T::h!]\n    |      ^^^^^ the trait `T` has no macro named `h`\n \n+error: unresolved link to `TestEnum::Variant1::field_name`\n+  --> $DIR/errors.rs:107:6\n+   |\n+LL | ///[`TestEnum::Variant1::field_name`]\n+   |      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ variant `Variant1` has no such field\n+\n+error: unresolved link to `TestEnumNoFields::Variant1::field_name`\n+  --> $DIR/errors.rs:115:6\n+   |\n+LL | ///[`TestEnumNoFields::Variant1::field_name`]\n+   |      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `Variant1` is a variant, not a module or type, and cannot have associated items\n+\n error: unresolved link to `m`\n   --> $DIR/errors.rs:98:6\n    |\n@@ -153,5 +165,5 @@ help: to link to the macro, add an exclamation mark\n LL | /// [m!()]\n    |       +\n \n-error: aborting due to 20 previous errors\n+error: aborting due to 22 previous errors\n "}]}