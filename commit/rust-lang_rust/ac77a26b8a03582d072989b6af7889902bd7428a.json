{"sha": "ac77a26b8a03582d072989b6af7889902bd7428a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFjNzdhMjZiOGEwMzU4MmQwNzI5ODliNmFmNzg4OTkwMmJkNzQyOGE=", "commit": {"author": {"name": "flip1995", "email": "9744647+flip1995@users.noreply.github.com", "date": "2018-07-19T11:44:26Z"}, "committer": {"name": "flip1995", "email": "9744647+flip1995@users.noreply.github.com", "date": "2018-07-19T11:59:25Z"}, "message": "Skip useless_attribute lint on allow(unused_imports) on extern crate items with macro_use", "tree": {"sha": "8cf044d052f9eb72ea7a292cc33e8f73dec7d89f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8cf044d052f9eb72ea7a292cc33e8f73dec7d89f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ac77a26b8a03582d072989b6af7889902bd7428a", "comment_count": 0, "verification": {"verified": false, "reason": "unknown_key", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE8rLaPclMjvVJWRZHnxhOEWSDEYEFAltQfR0ACgkQnxhOEWSD\nEYHJRA/+MqG1N5ke0wXigA101cPFqQWjJJ/NrcdYIAgvbvRGO0ihkqXqDAaOxTNa\nq694N2asBblCn6wArUlD/80EUiDM/5YCfLnNlrh2lt47rbc6c2pNLWQ30kqRVhXc\nILZfZj0WJ3UlLAnstdjGQEUgnFvti2BKtverFtwNcmdyVbOk7lnMzivkADWglVWf\nlAex025CgOP0iyWGamNsJk0GnK0zXajyefBxSjn9XeiwIPUCLNYZIM3bqgrQ0AUX\nnV3lPJLPxtN5xd1GcUUYVlu9UqU6A4l/5yleFR9ljol2VB6bBKcY3MiAtB/9chOT\nHtvd0fUyqqespL4qALibJ73NnDXkVDdZJ+u/DTLcjWYY1+uVRiLs7aKkkAwd5Fko\naswd3UCm36HfA04r/5OhYY/lbirIhxzxsIaqBokoJnVXZGSU+tEKZ4rnOMvQgfaM\nMl4VG0HQm+mKso/dcfojKSB7L4wk4PzyOrE4uG9xAfXriateMckTchvjYik1LZDE\nvkakrq5zgsGKtALZkRLL/iJdVVuOLOPnRwgygdZK6+apIymZmmSZ7morBZ+Ib4R+\nGuOZ55d03U6e/E7ofhUH/95kIFlihiyZ/4QtwAmn2v5nNv5yw2iCqpUyDT3ONLhn\n47PJ8JwqX/k9WMsVzuz1b309rKCrYAbVxIFX1l5W0ztL9SqHmVs=\n=uFNO\n-----END PGP SIGNATURE-----", "payload": "tree 8cf044d052f9eb72ea7a292cc33e8f73dec7d89f\nparent de13d5a5bd6373624fbc675c6bc6d60854b06a73\nauthor flip1995 <9744647+flip1995@users.noreply.github.com> 1532000666 +0200\ncommitter flip1995 <9744647+flip1995@users.noreply.github.com> 1532001565 +0200\n\nSkip useless_attribute lint on allow(unused_imports) on extern crate items with macro_use\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ac77a26b8a03582d072989b6af7889902bd7428a", "html_url": "https://github.com/rust-lang/rust/commit/ac77a26b8a03582d072989b6af7889902bd7428a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ac77a26b8a03582d072989b6af7889902bd7428a/comments", "author": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "de13d5a5bd6373624fbc675c6bc6d60854b06a73", "url": "https://api.github.com/repos/rust-lang/rust/commits/de13d5a5bd6373624fbc675c6bc6d60854b06a73", "html_url": "https://github.com/rust-lang/rust/commit/de13d5a5bd6373624fbc675c6bc6d60854b06a73"}], "stats": {"total": 46, "additions": 33, "deletions": 13}, "files": [{"sha": "367968cfe656f68c98fee55c11ed03b3fc95f8ea", "filename": "clippy_lints/src/attrs.rs", "status": "modified", "additions": 31, "deletions": 13, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/ac77a26b8a03582d072989b6af7889902bd7428a/clippy_lints%2Fsrc%2Fattrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac77a26b8a03582d072989b6af7889902bd7428a/clippy_lints%2Fsrc%2Fattrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fattrs.rs?ref=ac77a26b8a03582d072989b6af7889902bd7428a", "patch": "@@ -39,22 +39,31 @@ declare_clippy_lint! {\n }\n \n /// **What it does:** Checks for `extern crate` and `use` items annotated with\n-/// lint attributes\n+/// lint attributes.\n+///\n+/// This lint whitelists `#[allow(unused_imports)]` and `#[allow(deprecated)]` on\n+/// `use` items and `#[allow(unused_imports)]` on `extern crate` items with a\n+/// `#[macro_use]` attribute.\n ///\n /// **Why is this bad?** Lint attributes have no effect on crate imports. Most\n-/// likely a `!` was\n-/// forgotten\n+/// likely a `!` was forgotten.\n ///\n-/// **Known problems:** Technically one might allow `unused_import` on a `use`\n-/// item,\n-/// but it's easier to remove the unused item.\n+/// **Known problems:** None.\n ///\n /// **Example:**\n /// ```rust\n+/// // Bad\n /// #[deny(dead_code)]\n /// extern crate foo;\n-/// #[allow(unused_import)]\n+/// #[forbid(dead_code)]\n /// use foo::bar;\n+///\n+/// // Ok\n+/// #[allow(unused_imports)]\n+/// use foo::baz;\n+/// #[allow(unused_imports)]\n+/// #[macro_use]\n+/// extern crate baz;\n /// ```\n declare_clippy_lint! {\n     pub USELESS_ATTRIBUTE,\n@@ -154,17 +163,26 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for AttrPass {\n             check_attrs(cx, item.span, item.name, &item.attrs)\n         }\n         match item.node {\n-            ItemKind::ExternCrate(_) | ItemKind::Use(_, _) => {\n+            ItemKind::ExternCrate(..) | ItemKind::Use(..) => {\n+                let skip_unused_imports = item.attrs.iter().any(|attr| attr.name() == \"macro_use\");\n+\n                 for attr in &item.attrs {\n                     if let Some(ref lint_list) = attr.meta_item_list() {\n                         match &*attr.name().as_str() {\n                             \"allow\" | \"warn\" | \"deny\" | \"forbid\" => {\n-                                // whitelist `unused_imports` and `deprecated`\n+                                // whitelist `unused_imports` and `deprecated` for `use` items\n+                                // and `unused_imports` for `extern crate` items with `macro_use`\n                                 for lint in lint_list {\n-                                    if is_word(lint, \"unused_imports\") || is_word(lint, \"deprecated\") {\n-                                        if let ItemKind::Use(_, _) = item.node {\n-                                            return;\n-                                        }\n+                                    match item.node {\n+                                        ItemKind::Use(..) => if is_word(lint, \"unused_imports\")\n+                                                                || is_word(lint, \"deprecated\") {\n+                                                return\n+                                        },\n+                                        ItemKind::ExternCrate(..) => if is_word(lint, \"unused_imports\")\n+                                                                        && skip_unused_imports {\n+                                                return\n+                                        },\n+                                        _ => {},\n                                     }\n                                 }\n                                 let line_span = last_line_of_span(cx, attr.span);"}, {"sha": "68c7d2007a6b65bf258cf716a1e693ef365937d2", "filename": "tests/ui/useless_attribute.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ac77a26b8a03582d072989b6af7889902bd7428a/tests%2Fui%2Fuseless_attribute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac77a26b8a03582d072989b6af7889902bd7428a/tests%2Fui%2Fuseless_attribute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fuseless_attribute.rs?ref=ac77a26b8a03582d072989b6af7889902bd7428a", "patch": "@@ -6,6 +6,8 @@\n #[cfg_attr(feature = \"cargo-clippy\", allow(dead_code, unused_extern_crates))]\n #[cfg_attr(feature = \"cargo-clippy\",\n            allow(dead_code, unused_extern_crates))]\n+#[allow(unused_imports)]\n+#[macro_use]\n extern crate clippy_lints;\n \n // don't lint on unused_import for `use` items"}]}