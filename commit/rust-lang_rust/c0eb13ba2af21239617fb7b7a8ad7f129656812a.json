{"sha": "c0eb13ba2af21239617fb7b7a8ad7f129656812a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMwZWIxM2JhMmFmMjEyMzk2MTdmYjdiN2E4YWQ3ZjEyOTY1NjgxMmE=", "commit": {"author": {"name": "hyd-dev", "email": "yd-huang@outlook.com", "date": "2021-02-14T10:12:33Z"}, "committer": {"name": "hyd-dev", "email": "yd-huang@outlook.com", "date": "2021-02-15T12:43:27Z"}, "message": "Patch `--extern` arguments in `phase_cargo_rustc` as well", "tree": {"sha": "ec4e0e8b349f918d071f145a437a66b6bc3990a9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ec4e0e8b349f918d071f145a437a66b6bc3990a9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c0eb13ba2af21239617fb7b7a8ad7f129656812a", "comment_count": 0, "verification": {"verified": false, "reason": "no_user", "signature": "-----BEGIN PGP SIGNATURE-----\n\niIsEABYIADMWIQRJ2jPMDdiQ+U4U42Z0+n/VuNoUuAUCYCpsbxUceWQtaHVhbmdA\nb3V0bG9vay5jb20ACgkQdPp/1bjaFLi31wD+PxGsfckfBzgtg20NyOlFTRaHei5g\n6tOQtflAzUWcsxYBAOZ78xYKOhYxGxz3Hml9f7AwV/0SxSNAY7CjOtWUr48N\n=VlpY\n-----END PGP SIGNATURE-----", "payload": "tree ec4e0e8b349f918d071f145a437a66b6bc3990a9\nparent 56250ccbf20babae5b110ddae60598defdd1e328\nauthor hyd-dev <yd-huang@outlook.com> 1613297553 +0800\ncommitter hyd-dev <yd-huang@outlook.com> 1613393007 +0800\n\nPatch `--extern` arguments in `phase_cargo_rustc` as well\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c0eb13ba2af21239617fb7b7a8ad7f129656812a", "html_url": "https://github.com/rust-lang/rust/commit/c0eb13ba2af21239617fb7b7a8ad7f129656812a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c0eb13ba2af21239617fb7b7a8ad7f129656812a/comments", "author": null, "committer": null, "parents": [{"sha": "56250ccbf20babae5b110ddae60598defdd1e328", "url": "https://api.github.com/repos/rust-lang/rust/commits/56250ccbf20babae5b110ddae60598defdd1e328", "html_url": "https://github.com/rust-lang/rust/commit/56250ccbf20babae5b110ddae60598defdd1e328"}], "stats": {"total": 34, "additions": 32, "deletions": 2}, "files": [{"sha": "77ccaea4bf69c078fe24378d83e4b32dee89d7f3", "filename": "cargo-miri/bin.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c0eb13ba2af21239617fb7b7a8ad7f129656812a/cargo-miri%2Fbin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0eb13ba2af21239617fb7b7a8ad7f129656812a/cargo-miri%2Fbin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/cargo-miri%2Fbin.rs?ref=c0eb13ba2af21239617fb7b7a8ad7f129656812a", "patch": "@@ -565,7 +565,7 @@ fn phase_cargo_miri(mut args: env::Args) {\n     exec(cmd)\n }\n \n-fn phase_cargo_rustc(args: env::Args) {\n+fn phase_cargo_rustc(mut args: env::Args) {\n     /// Determines if we are being invoked (as rustc) to build a crate for\n     /// the \"target\" architecture, in contrast to the \"host\" architecture.\n     /// Host crates are for build scripts and proc macros and still need to\n@@ -655,7 +655,7 @@ fn phase_cargo_rustc(args: env::Args) {\n     if !print && target_crate {\n         // Forward arguments, but remove \"link\" from \"--emit\" to make this a check-only build.\n         let emit_flag = \"--emit\";\n-        for arg in args {\n+        while let Some(arg) = args.next() {\n             if arg.starts_with(emit_flag) {\n                 // Patch this argument. First, extract its value.\n                 let val = &arg[emit_flag.len()..];\n@@ -671,6 +671,10 @@ fn phase_cargo_rustc(args: env::Args) {\n                     }\n                 }\n                 cmd.arg(format!(\"{}={}\", emit_flag, val.join(\",\")));\n+            } else if arg == \"--extern\" {\n+                // Patch `--extern` filenames, since Cargo sometimes passes stub `.rlib` files:\n+                // https://github.com/rust-lang/miri/issues/1705\n+                forward_patched_extern_arg(&mut args, &mut cmd);\n             } else {\n                 cmd.arg(arg);\n             }"}, {"sha": "eff36026defef20c8307768c240997b9d477ac99", "filename": "test-cargo-miri/Cargo.lock", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c0eb13ba2af21239617fb7b7a8ad7f129656812a/test-cargo-miri%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/c0eb13ba2af21239617fb7b7a8ad7f129656812a/test-cargo-miri%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2FCargo.lock?ref=c0eb13ba2af21239617fb7b7a8ad7f129656812a", "patch": "@@ -13,6 +13,7 @@ dependencies = [\n  \"byteorder\",\n  \"issue_1567\",\n  \"issue_1691\",\n+ \"issue_1705\",\n  \"rand\",\n  \"serde_derive\",\n ]\n@@ -54,6 +55,13 @@ dependencies = [\n name = \"issue_1691\"\n version = \"0.1.0\"\n \n+[[package]]\n+name = \"issue_1705\"\n+version = \"0.1.0\"\n+dependencies = [\n+ \"byteorder\",\n+]\n+\n [[package]]\n name = \"libc\"\n version = \"0.2.81\""}, {"sha": "4bc5d121ac79c7aa828205f5f25624468199eb3b", "filename": "test-cargo-miri/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c0eb13ba2af21239617fb7b7a8ad7f129656812a/test-cargo-miri%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c0eb13ba2af21239617fb7b7a8ad7f129656812a/test-cargo-miri%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2FCargo.toml?ref=c0eb13ba2af21239617fb7b7a8ad7f129656812a", "patch": "@@ -11,6 +11,7 @@ edition = \"2018\"\n byteorder = \"1.0\"\n issue_1567 = { path = \"issue-1567\" }\n issue_1691 = { path = \"issue-1691\" }\n+issue_1705 = { path = \"issue-1705\" }\n \n [dev-dependencies]\n rand = { version = \"0.7\", features = [\"small_rng\"] }"}, {"sha": "ae63647a88819b3a7d7d51b32fbd691ee30462b3", "filename": "test-cargo-miri/issue-1705/Cargo.toml", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/c0eb13ba2af21239617fb7b7a8ad7f129656812a/test-cargo-miri%2Fissue-1705%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c0eb13ba2af21239617fb7b7a8ad7f129656812a/test-cargo-miri%2Fissue-1705%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Fissue-1705%2FCargo.toml?ref=c0eb13ba2af21239617fb7b7a8ad7f129656812a", "patch": "@@ -0,0 +1,11 @@\n+[package]\n+name = \"issue_1705\"\n+version = \"0.1.0\"\n+authors = [\"Miri Team\"]\n+edition = \"2018\"\n+\n+[lib]\n+crate-type = [\"lib\", \"staticlib\", \"cdylib\"]\n+\n+[dependencies]\n+byteorder = \"1.0\""}, {"sha": "ef24d3f1a06da6be0ce03f2637e4ee6c922f2f91", "filename": "test-cargo-miri/issue-1705/src/lib.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c0eb13ba2af21239617fb7b7a8ad7f129656812a/test-cargo-miri%2Fissue-1705%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0eb13ba2af21239617fb7b7a8ad7f129656812a/test-cargo-miri%2Fissue-1705%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Fissue-1705%2Fsrc%2Flib.rs?ref=c0eb13ba2af21239617fb7b7a8ad7f129656812a", "patch": "@@ -0,0 +1,5 @@\n+use byteorder::{LittleEndian, ByteOrder};\n+\n+pub fn use_the_dependency() {\n+    let _n = <LittleEndian as ByteOrder>::read_u32(&[1,2,3,4]);\n+}"}, {"sha": "1da169bd51cff4a9dcf2cb4dbb8d474d16c1ce4d", "filename": "test-cargo-miri/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c0eb13ba2af21239617fb7b7a8ad7f129656812a/test-cargo-miri%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0eb13ba2af21239617fb7b7a8ad7f129656812a/test-cargo-miri%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Fsrc%2Flib.rs?ref=c0eb13ba2af21239617fb7b7a8ad7f129656812a", "patch": "@@ -3,5 +3,6 @@\n /// assert!(cargo_miri_test::make_true());\n /// ```\n pub fn make_true() -> bool {\n+    issue_1705::use_the_dependency();\n     issue_1691::use_me()\n }"}]}