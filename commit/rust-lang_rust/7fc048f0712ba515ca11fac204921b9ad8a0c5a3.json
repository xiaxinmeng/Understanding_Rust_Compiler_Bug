{"sha": "7fc048f0712ba515ca11fac204921b9ad8a0c5a3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdmYzA0OGYwNzEyYmE1MTVjYTExZmFjMjA0OTIxYjlhZDhhMGM1YTM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-08-29T16:59:39Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-08-29T16:59:39Z"}, "message": "Auto merge of #75754 - joshtriplett:wip-perf-snappy, r=Mark-Simulacrum\n\nSwitch to Snappy compression for metadata", "tree": {"sha": "8dfb0b55b216870ad85217a00ec460c680e66448", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8dfb0b55b216870ad85217a00ec460c680e66448"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7fc048f0712ba515ca11fac204921b9ad8a0c5a3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7fc048f0712ba515ca11fac204921b9ad8a0c5a3", "html_url": "https://github.com/rust-lang/rust/commit/7fc048f0712ba515ca11fac204921b9ad8a0c5a3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7fc048f0712ba515ca11fac204921b9ad8a0c5a3/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fe8ab8a530fc2369e2748421a319444383363340", "url": "https://api.github.com/repos/rust-lang/rust/commits/fe8ab8a530fc2369e2748421a319444383363340", "html_url": "https://github.com/rust-lang/rust/commit/fe8ab8a530fc2369e2748421a319444383363340"}, {"sha": "574f6bed62a205c743737c6b13e925a04a3de6bb", "url": "https://api.github.com/repos/rust-lang/rust/commits/574f6bed62a205c743737c6b13e925a04a3de6bb", "html_url": "https://github.com/rust-lang/rust/commit/574f6bed62a205c743737c6b13e925a04a3de6bb"}], "stats": {"total": 27, "additions": 16, "deletions": 11}, "files": [{"sha": "4bf46643e47d0fd69cad466e3fc3d820d8733bd0", "filename": "Cargo.lock", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/7fc048f0712ba515ca11fac204921b9ad8a0c5a3/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/7fc048f0712ba515ca11fac204921b9ad8a0c5a3/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=7fc048f0712ba515ca11fac204921b9ad8a0c5a3", "patch": "@@ -3365,7 +3365,6 @@ name = \"rustc_codegen_llvm\"\n version = \"0.0.0\"\n dependencies = [\n  \"bitflags\",\n- \"flate2\",\n  \"libc\",\n  \"measureme\",\n  \"rustc-demangle\",\n@@ -3386,6 +3385,7 @@ dependencies = [\n  \"rustc_span\",\n  \"rustc_target\",\n  \"smallvec 1.4.2\",\n+ \"snap\",\n  \"tracing\",\n ]\n \n@@ -3711,7 +3711,6 @@ dependencies = [\n name = \"rustc_metadata\"\n version = \"0.0.0\"\n dependencies = [\n- \"flate2\",\n  \"libc\",\n  \"memmap\",\n  \"rustc_ast\",\n@@ -3729,6 +3728,7 @@ dependencies = [\n  \"rustc_span\",\n  \"rustc_target\",\n  \"smallvec 1.4.2\",\n+ \"snap\",\n  \"stable_deref_trait\",\n  \"tracing\",\n  \"winapi 0.3.9\",\n@@ -4399,6 +4399,12 @@ version = \"1.4.2\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"fbee7696b84bbf3d89a1c2eccff0850e3047ed46bfcd2e92c29a2d074d57e252\"\n \n+[[package]]\n+name = \"snap\"\n+version = \"1.0.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"da73c8f77aebc0e40c300b93f0a5f1bece7a248a36eee287d4e095f35c7b7d6e\"\n+\n [[package]]\n name = \"socket2\"\n version = \"0.3.12\""}, {"sha": "d8ccaf16e28bc9aef60107c1267919fc33b91fee", "filename": "src/librustc_codegen_llvm/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7fc048f0712ba515ca11fac204921b9ad8a0c5a3/src%2Flibrustc_codegen_llvm%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/7fc048f0712ba515ca11fac204921b9ad8a0c5a3/src%2Flibrustc_codegen_llvm%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2FCargo.toml?ref=7fc048f0712ba515ca11fac204921b9ad8a0c5a3", "patch": "@@ -12,9 +12,9 @@ doctest = false\n \n [dependencies]\n bitflags = \"1.0\"\n-flate2 = \"1.0\"\n libc = \"0.2\"\n measureme = \"0.7.1\"\n+snap = \"1\"\n tracing = \"0.1\"\n rustc_middle = { path = \"../librustc_middle\" }\n rustc-demangle = \"0.1\""}, {"sha": "6a1b373ef071145332252ee5f64fd71737bd6719", "filename": "src/librustc_codegen_llvm/base.rs", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/7fc048f0712ba515ca11fac204921b9ad8a0c5a3/src%2Flibrustc_codegen_llvm%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7fc048f0712ba515ca11fac204921b9ad8a0c5a3/src%2Flibrustc_codegen_llvm%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fbase.rs?ref=7fc048f0712ba515ca11fac204921b9ad8a0c5a3", "patch": "@@ -45,15 +45,12 @@ pub fn write_compressed_metadata<'tcx>(\n     metadata: &EncodedMetadata,\n     llvm_module: &mut ModuleLlvm,\n ) {\n-    use flate2::write::DeflateEncoder;\n-    use flate2::Compression;\n+    use snap::write::FrameEncoder;\n     use std::io::Write;\n \n     let (metadata_llcx, metadata_llmod) = (&*llvm_module.llcx, llvm_module.llmod());\n     let mut compressed = tcx.metadata_encoding_version();\n-    DeflateEncoder::new(&mut compressed, Compression::fast())\n-        .write_all(&metadata.raw_data)\n-        .unwrap();\n+    FrameEncoder::new(&mut compressed).write_all(&metadata.raw_data).unwrap();\n \n     let llmeta = common::bytes_in_context(metadata_llcx, &compressed);\n     let llconst = common::struct_in_context(metadata_llcx, &[llmeta], false);"}, {"sha": "76e11bd689c5c4d46f9cf25af383fb23f200558d", "filename": "src/librustc_metadata/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7fc048f0712ba515ca11fac204921b9ad8a0c5a3/src%2Flibrustc_metadata%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/7fc048f0712ba515ca11fac204921b9ad8a0c5a3/src%2Flibrustc_metadata%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2FCargo.toml?ref=7fc048f0712ba515ca11fac204921b9ad8a0c5a3", "patch": "@@ -10,8 +10,8 @@ path = \"lib.rs\"\n doctest = false\n \n [dependencies]\n-flate2 = \"1.0\"\n libc = \"0.2\"\n+snap = \"1\"\n tracing = \"0.1\"\n memmap = \"0.7\"\n smallvec = { version = \"1.0\", features = [\"union\", \"may_dangle\"] }"}, {"sha": "0869ec2836753881b1ad7b8180fc2c12a1fc09c5", "filename": "src/librustc_metadata/locator.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/7fc048f0712ba515ca11fac204921b9ad8a0c5a3/src%2Flibrustc_metadata%2Flocator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7fc048f0712ba515ca11fac204921b9ad8a0c5a3/src%2Flibrustc_metadata%2Flocator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Flocator.rs?ref=7fc048f0712ba515ca11fac204921b9ad8a0c5a3", "patch": "@@ -229,7 +229,7 @@ use rustc_span::symbol::{sym, Symbol};\n use rustc_span::Span;\n use rustc_target::spec::{Target, TargetTriple};\n \n-use flate2::read::DeflateDecoder;\n+use snap::read::FrameDecoder;\n use std::io::{Read, Result as IoResult, Write};\n use std::ops::Deref;\n use std::path::{Path, PathBuf};\n@@ -766,7 +766,7 @@ fn get_metadata_section(\n             let compressed_bytes = &buf[header_len..];\n             debug!(\"inflating {} bytes of compressed metadata\", compressed_bytes.len());\n             let mut inflated = Vec::new();\n-            match DeflateDecoder::new(compressed_bytes).read_to_end(&mut inflated) {\n+            match FrameDecoder::new(compressed_bytes).read_to_end(&mut inflated) {\n                 Ok(_) => rustc_erase_owner!(OwningRef::new(inflated).map_owner_box()),\n                 Err(_) => {\n                     return Err(format!(\"failed to decompress metadata: {}\", filename.display()));"}, {"sha": "356705305d78b1af4a45b579bb50e7c59a33c561", "filename": "src/tools/tidy/src/deps.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7fc048f0712ba515ca11fac204921b9ad8a0c5a3/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7fc048f0712ba515ca11fac204921b9ad8a0c5a3/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs?ref=7fc048f0712ba515ca11fac204921b9ad8a0c5a3", "patch": "@@ -42,6 +42,7 @@ const EXCEPTIONS: &[(&str, &str)] = &[\n     (\"crossbeam-queue\", \"MIT/Apache-2.0 AND BSD-2-Clause\"), // rls via rayon\n     (\"arrayref\", \"BSD-2-Clause\"),       // cargo-miri/directories/.../rust-argon2 (redox)\n     (\"instant\", \"BSD-3-Clause\"),        // rustc_driver/tracing-subscriber/parking_lot\n+    (\"snap\", \"BSD-3-Clause\"),           // rustc\n     // FIXME: this dependency violates the documentation comment above:\n     (\"fortanix-sgx-abi\", \"MPL-2.0\"), // libstd but only for `sgx` target\n ];\n@@ -161,6 +162,7 @@ const PERMITTED_DEPENDENCIES: &[&str] = &[\n     \"serde_derive\",\n     \"sha-1\",\n     \"smallvec\",\n+    \"snap\",\n     \"stable_deref_trait\",\n     \"stacker\",\n     \"syn\","}]}