{"sha": "7b518af5d92e1f5aa4ff9946cc1fa17bd4fa9cdd", "node_id": "C_kwDOAAsO6NoAKDdiNTE4YWY1ZDkyZTFmNWFhNGZmOTk0NmNjMWZhMTdiZDRmYTljZGQ", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-11-04T23:02:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-04T23:02:05Z"}, "message": "Rollup merge of #103946 - camsteffen:cleanup-bind-pattern, r=cjgillot\n\nCleanup bind_pattern args\n\nFixes #101896", "tree": {"sha": "2f5343febf95a8722c3cd533c8b04f0cd9ce289c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2f5343febf95a8722c3cd533c8b04f0cd9ce289c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7b518af5d92e1f5aa4ff9946cc1fa17bd4fa9cdd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjZZntCRBK7hj4Ov3rIwAA024IAFblbfkhVbucpWzZqdc5RHb4\n9gUutG/IHObjnVdHo6ulkmtoruhfwnI0egPnbbu1UecmiK/hZWFpCYGV4+YVQMLG\nzeQGdOF6g3mR/5lp3EYu2ZRanUz+sFkf9YDVwEz7u69aWOC3V+gspbgRSyK7f9PG\nWsIwo/uT3fAjPGY04n/9GkFBoReI7BX3jdy0eWCJGow7m3UBcxNLDaRKmLRsE2X0\nbgV9q/eQqw3t1dEwvg4wB7Z6iRFKzsKIdc1w9eLpPwCtsHf+yKDIELE7XXY5G9cx\nnjwezYJtCXW31IdBY4z9bFjq0Dhh+cxeGTTjIHLdwWXtWPgooEq2j1+c7dxzcFc=\n=u3Re\n-----END PGP SIGNATURE-----\n", "payload": "tree 2f5343febf95a8722c3cd533c8b04f0cd9ce289c\nparent 68c8d6d1c12856f22646accfdae6d90c2406f06e\nparent e7bae89a3c739556c90758a5d73fc9565e9efdc8\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1667602925 +0100\ncommitter GitHub <noreply@github.com> 1667602925 +0100\n\nRollup merge of #103946 - camsteffen:cleanup-bind-pattern, r=cjgillot\n\nCleanup bind_pattern args\n\nFixes #101896\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7b518af5d92e1f5aa4ff9946cc1fa17bd4fa9cdd", "html_url": "https://github.com/rust-lang/rust/commit/7b518af5d92e1f5aa4ff9946cc1fa17bd4fa9cdd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7b518af5d92e1f5aa4ff9946cc1fa17bd4fa9cdd/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "68c8d6d1c12856f22646accfdae6d90c2406f06e", "url": "https://api.github.com/repos/rust-lang/rust/commits/68c8d6d1c12856f22646accfdae6d90c2406f06e", "html_url": "https://github.com/rust-lang/rust/commit/68c8d6d1c12856f22646accfdae6d90c2406f06e"}, {"sha": "e7bae89a3c739556c90758a5d73fc9565e9efdc8", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7bae89a3c739556c90758a5d73fc9565e9efdc8", "html_url": "https://github.com/rust-lang/rust/commit/e7bae89a3c739556c90758a5d73fc9565e9efdc8"}], "stats": {"total": 51, "additions": 14, "deletions": 37}, "files": [{"sha": "dfd8649cb97e7f716e5ab3218b9157cb192a732d", "filename": "compiler/rustc_mir_build/src/build/matches/mod.rs", "status": "modified", "additions": 14, "deletions": 37, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/7b518af5d92e1f5aa4ff9946cc1fa17bd4fa9cdd/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmatches%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b518af5d92e1f5aa4ff9946cc1fa17bd4fa9cdd/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmatches%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmatches%2Fmod.rs?ref=7b518af5d92e1f5aa4ff9946cc1fa17bd4fa9cdd", "patch": "@@ -364,12 +364,9 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                     let arm_block = this.bind_pattern(\n                         outer_source_info,\n                         candidate,\n-                        arm.guard.as_ref(),\n                         &fake_borrow_temps,\n                         scrutinee_span,\n-                        Some(arm.span),\n-                        Some(arm.scope),\n-                        Some(match_scope),\n+                        Some((arm, match_scope)),\n                         false,\n                     );\n \n@@ -410,12 +407,9 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         &mut self,\n         outer_source_info: SourceInfo,\n         candidate: Candidate<'_, 'tcx>,\n-        guard: Option<&Guard<'tcx>>,\n         fake_borrow_temps: &[(Place<'tcx>, Local)],\n         scrutinee_span: Span,\n-        arm_span: Option<Span>,\n-        arm_scope: Option<region::Scope>,\n-        match_scope: Option<region::Scope>,\n+        arm_match_scope: Option<(&Arm<'tcx>, region::Scope)>,\n         storages_alive: bool,\n     ) -> BasicBlock {\n         if candidate.subcandidates.is_empty() {\n@@ -424,11 +418,9 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             self.bind_and_guard_matched_candidate(\n                 candidate,\n                 &[],\n-                guard,\n                 fake_borrow_temps,\n                 scrutinee_span,\n-                arm_span,\n-                match_scope,\n+                arm_match_scope,\n                 true,\n                 storages_alive,\n             )\n@@ -449,28 +441,27 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             // we lower the guard.\n             let target_block = self.cfg.start_new_block();\n             let mut schedule_drops = true;\n+            let arm = arm_match_scope.unzip().0;\n             // We keep a stack of all of the bindings and type ascriptions\n             // from the parent candidates that we visit, that also need to\n             // be bound for each candidate.\n             traverse_candidate(\n                 candidate,\n                 &mut Vec::new(),\n                 &mut |leaf_candidate, parent_bindings| {\n-                    if let Some(arm_scope) = arm_scope {\n-                        self.clear_top_scope(arm_scope);\n+                    if let Some(arm) = arm {\n+                        self.clear_top_scope(arm.scope);\n                     }\n                     let binding_end = self.bind_and_guard_matched_candidate(\n                         leaf_candidate,\n                         parent_bindings,\n-                        guard,\n                         &fake_borrow_temps,\n                         scrutinee_span,\n-                        arm_span,\n-                        match_scope,\n+                        arm_match_scope,\n                         schedule_drops,\n                         storages_alive,\n                     );\n-                    if arm_scope.is_none() {\n+                    if arm.is_none() {\n                         schedule_drops = false;\n                     }\n                     self.cfg.goto(binding_end, outer_source_info, target_block);\n@@ -636,12 +627,9 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         self.bind_pattern(\n             self.source_info(irrefutable_pat.span),\n             candidate,\n-            None,\n             &fake_borrow_temps,\n             irrefutable_pat.span,\n             None,\n-            None,\n-            None,\n             false,\n         )\n         .unit()\n@@ -1820,12 +1808,9 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         let post_guard_block = self.bind_pattern(\n             self.source_info(pat.span),\n             guard_candidate,\n-            None,\n             &fake_borrow_temps,\n             expr.span,\n             None,\n-            None,\n-            None,\n             false,\n         );\n \n@@ -1844,11 +1829,9 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         &mut self,\n         candidate: Candidate<'pat, 'tcx>,\n         parent_bindings: &[(Vec<Binding<'tcx>>, Vec<Ascription<'tcx>>)],\n-        guard: Option<&Guard<'tcx>>,\n         fake_borrows: &[(Place<'tcx>, Local)],\n         scrutinee_span: Span,\n-        arm_span: Option<Span>,\n-        match_scope: Option<region::Scope>,\n+        arm_match_scope: Option<(&Arm<'tcx>, region::Scope)>,\n         schedule_drops: bool,\n         storages_alive: bool,\n     ) -> BasicBlock {\n@@ -1960,7 +1943,9 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         //      the reference that we create for the arm.\n         //    * So we eagerly create the reference for the arm and then take a\n         //      reference to that.\n-        if let Some(guard) = guard {\n+        if let Some((arm, match_scope)) = arm_match_scope\n+            && let Some(guard) = &arm.guard\n+        {\n             let tcx = self.tcx;\n             let bindings = parent_bindings\n                 .iter()\n@@ -1981,8 +1966,6 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                 self.cfg.push_assign(block, scrutinee_source_info, Place::from(temp), borrow);\n             }\n \n-            let arm_span = arm_span.unwrap();\n-            let match_scope = match_scope.unwrap();\n             let mut guard_span = rustc_span::DUMMY_SP;\n \n             let (post_guard_block, otherwise_post_guard_block) =\n@@ -1995,13 +1978,13 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                             e,\n                             None,\n                             match_scope,\n-                            this.source_info(arm_span),\n+                            this.source_info(arm.span),\n                         )\n                     }\n                     Guard::IfLet(ref pat, scrutinee) => {\n                         let s = &this.thir[scrutinee];\n                         guard_span = s.span;\n-                        this.lower_let_expr(block, s, pat, match_scope, None, arm_span)\n+                        this.lower_let_expr(block, s, pat, match_scope, None, arm.span)\n                     }\n                 });\n \n@@ -2317,24 +2300,18 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             let matching = this.bind_pattern(\n                 this.source_info(pattern.span),\n                 candidate,\n-                None,\n                 &fake_borrow_temps,\n                 initializer_span,\n                 None,\n-                None,\n-                None,\n                 true,\n             );\n             // This block is for the failure case\n             let failure = this.bind_pattern(\n                 this.source_info(else_block_span),\n                 wildcard,\n-                None,\n                 &fake_borrow_temps,\n                 initializer_span,\n                 None,\n-                None,\n-                None,\n                 true,\n             );\n             this.break_for_else(failure, *let_else_scope, this.source_info(initializer_span));"}]}