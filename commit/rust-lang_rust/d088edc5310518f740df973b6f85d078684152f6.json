{"sha": "d088edc5310518f740df973b6f85d078684152f6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQwODhlZGM1MzEwNTE4Zjc0MGRmOTczYjZmODVkMDc4Njg0MTUyZjY=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2018-10-16T17:37:01Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2018-10-18T16:21:15Z"}, "message": "Improve check to consider how value is used.", "tree": {"sha": "1c4617a4299b50a733a99d3d5c045470aad8f99d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1c4617a4299b50a733a99d3d5c045470aad8f99d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d088edc5310518f740df973b6f85d078684152f6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEWwgxPGhT5b/6kagXAXYLT59T8VQFAlvIsvsACgkQAXYLT59T\n8VS6Ow/9HdXhfQspGc2rIuE+gH4AgYf5uIY8gQYuRWdxzVGNto/zTcg0+zitocXB\n98pyLbaDq++N0fR5iZt823uLqERDYG2umf45JGa0sBMhZxnuj/dCgMdJqNd/30Kw\n/7zcPoi6lNIlj5V+gK2evZLXfNLliIgwTEfuychSeMTQjKLqccq1f0OmimjMG+Qg\n7zq1vrl0nKvbdCFy0kpwwwZ59qgmZq2hjDBDfGDNtzah+KGr/Z6sbcHtEjTOeziu\n5OX6q3GAiGLc5/uqcitF3MkZhvCXDtU5PSAP9c0z1VZ3HVe6/QsdW9onNswLJjGd\nhq9EHsNJDBfo4znwXjMl6CyExwYemf4ORvWeL4m0dwwdAL9N0Q31lu7PdUo98aXT\nHm+Oz8Wj7dkZMD/Qse9nsETg3S7GD151g4OfiqM3pctNpDFVKlu61HTGqbqUwr0w\nXfS2bc1aX5XmTsyJZTdVmGJm33q6UotlB5zDoRsojanYIQRNOspFmuGls5wJkT6l\ntv6mV3s6MdFYQspT6e4JpplzKaTczQ/XREebWlizZd9iE2eyM9UyYkHAJt2pwznO\n56hRUlGmuUeL9yi/WOtEiDshWiMgN64Xu/EoYagivuvdM+88A3pIHzYxy30vYnxX\nx7/yAV82ZPK0SmSXt1pqHLpCGLiZ66qC49W+9Z9I7K4yyhiSTNo=\n=v1RG\n-----END PGP SIGNATURE-----", "payload": "tree 1c4617a4299b50a733a99d3d5c045470aad8f99d\nparent 375645abb89d1b98490c744dc980fb96aa076e73\nauthor David Wood <david@davidtw.co> 1539711421 +0200\ncommitter David Wood <david@davidtw.co> 1539879675 +0200\n\nImprove check to consider how value is used.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d088edc5310518f740df973b6f85d078684152f6", "html_url": "https://github.com/rust-lang/rust/commit/d088edc5310518f740df973b6f85d078684152f6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d088edc5310518f740df973b6f85d078684152f6/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "375645abb89d1b98490c744dc980fb96aa076e73", "url": "https://api.github.com/repos/rust-lang/rust/commits/375645abb89d1b98490c744dc980fb96aa076e73", "html_url": "https://github.com/rust-lang/rust/commit/375645abb89d1b98490c744dc980fb96aa076e73"}], "stats": {"total": 55, "additions": 15, "deletions": 40}, "files": [{"sha": "baf9e032270a684e9af3cc3d9471d58b3e897a4f", "filename": "src/librustc_mir/borrow_check/error_reporting.rs", "status": "modified", "additions": 15, "deletions": 22, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/d088edc5310518f740df973b6f85d078684152f6/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d088edc5310518f740df973b6f85d078684152f6/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs?ref=d088edc5310518f740df973b6f85d078684152f6", "patch": "@@ -1133,32 +1133,25 @@ impl<'cx, 'gcx, 'tcx> MirBorrowckCtxt<'cx, 'gcx, 'tcx> {\n                      closure,\n                 );\n \n-                if let ty::TyKind::Closure(did, substs) = self.mir.local_decls[closure].ty.sty {\n-                    let upvar_tys = substs.upvar_tys(did, self.infcx.tcx);\n+                if let ty::TyKind::Closure(did, _substs) = self.mir.local_decls[closure].ty.sty {\n                     let node_id = match self.infcx.tcx.hir.as_local_node_id(did) {\n                         Some(node_id) => node_id,\n                         _ => return,\n                     };\n-\n-                    self.infcx.tcx.with_freevars(node_id, |freevars| {\n-                        for (freevar, upvar_ty) in freevars.iter().zip(upvar_tys) {\n-                            debug!(\n-                                \"add_closure_invoked_twice_with_moved_variable_suggestion: \\\n-                                 freevar={:?} upvar_ty={:?}\",\n-                                freevar, upvar_ty,\n-                            );\n-                            if !upvar_ty.is_region_ptr() {\n-                                diag.span_note(\n-                                    freevar.span,\n-                                    &format!(\n-                                        \"closure cannot be invoked more than once because it \\\n-                                         moves the variable `{}` out of its environment\",\n-                                         self.infcx.tcx.hir.name(freevar.var_id()),\n-                                    ),\n-                                );\n-                            }\n-                        }\n-                    });\n+                    let hir_id = self.infcx.tcx.hir.node_to_hir_id(node_id);\n+\n+                    if let Some((\n+                        span, name\n+                    )) = self.infcx.tcx.typeck_tables_of(did).closure_kind_origins().get(hir_id) {\n+                        diag.span_note(\n+                            *span,\n+                            &format!(\n+                                \"closure cannot be invoked more than once because it \\\n+                                 moves the variable `{}` out of its environment\",\n+                                 name,\n+                            ),\n+                        );\n+                    }\n                 }\n             }\n         }"}, {"sha": "51dd2e72832b6a48d05d988941c1b1d1238a0101", "filename": "src/test/ui/issues/issue-12127.nll.stderr", "status": "removed", "additions": 0, "deletions": 18, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/375645abb89d1b98490c744dc980fb96aa076e73/src%2Ftest%2Fui%2Fissues%2Fissue-12127.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/375645abb89d1b98490c744dc980fb96aa076e73/src%2Ftest%2Fui%2Fissues%2Fissue-12127.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-12127.nll.stderr?ref=375645abb89d1b98490c744dc980fb96aa076e73", "patch": "@@ -1,18 +0,0 @@\n-error[E0382]: use of moved value: `f`\n-  --> $DIR/issue-12127.rs:21:9\n-   |\n-LL |         f();\n-   |         - value moved here\n-LL |         f();\n-   |         ^ value used here after move\n-   |\n-note: closure cannot be invoked more than once because it moves the variable `x` out of its environment\n-  --> $DIR/issue-12127.rs:18:39\n-   |\n-LL |     let f = to_fn_once(move|| do_it(&*x));\n-   |                                       ^\n-   = note: move occurs because `f` has type `[closure@$DIR/issue-12127.rs:18:24: 18:41 x:std::boxed::Box<isize>]`, which does not implement the `Copy` trait\n-\n-error: aborting due to previous error\n-\n-For more information about this error, try `rustc --explain E0382`."}]}