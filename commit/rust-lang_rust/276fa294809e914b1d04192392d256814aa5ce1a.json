{"sha": "276fa294809e914b1d04192392d256814aa5ce1a", "node_id": "C_kwDOAAsO6NoAKDI3NmZhMjk0ODA5ZTkxNGIxZDA0MTkyMzkyZDI1NjgxNGFhNWNlMWE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-14T17:23:11Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-14T17:23:11Z"}, "message": "Auto merge of #110263 - jyn514:ui-fulldeps-llvm, r=albertlarsan68\n\nAdd `libLLVM.so` to the target libdir when download-rustc is enabled\n\nPreviously, we would only add it to the host libdir, which meant it couldn't be loaded by `ui-fulldeps` tests that used rustc_private.\n\nFixes https://github.com/rust-lang/rust/issues/110225, fixes https://github.com/rust-lang/rust/issues/110226.", "tree": {"sha": "81a8890b4c3aaa2de7464f67d00314de18524486", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/81a8890b4c3aaa2de7464f67d00314de18524486"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/276fa294809e914b1d04192392d256814aa5ce1a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/276fa294809e914b1d04192392d256814aa5ce1a", "html_url": "https://github.com/rust-lang/rust/commit/276fa294809e914b1d04192392d256814aa5ce1a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/276fa294809e914b1d04192392d256814aa5ce1a/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "660c966ff941ddf995d3251df32508b383cd4cee", "url": "https://api.github.com/repos/rust-lang/rust/commits/660c966ff941ddf995d3251df32508b383cd4cee", "html_url": "https://github.com/rust-lang/rust/commit/660c966ff941ddf995d3251df32508b383cd4cee"}, {"sha": "7d64c7cd024ac22e71df104577037d2e2fb42c49", "url": "https://api.github.com/repos/rust-lang/rust/commits/7d64c7cd024ac22e71df104577037d2e2fb42c49", "html_url": "https://github.com/rust-lang/rust/commit/7d64c7cd024ac22e71df104577037d2e2fb42c49"}], "stats": {"total": 28, "additions": 24, "deletions": 4}, "files": [{"sha": "4a4e7adcbf388dcc486c2fce54da081fecc99802", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/276fa294809e914b1d04192392d256814aa5ce1a/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/276fa294809e914b1d04192392d256814aa5ce1a/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=276fa294809e914b1d04192392d256814aa5ce1a", "patch": "@@ -1281,9 +1281,7 @@ impl Step for Sysroot {\n             }\n \n             // Copy the compiler into the correct sysroot.\n-            let ci_rustc_dir =\n-                builder.config.out.join(&*builder.config.build.triple).join(\"ci-rustc\");\n-            builder.cp_r(&ci_rustc_dir, &sysroot);\n+            builder.cp_r(&builder.ci_rustc_dir(builder.build.build), &sysroot);\n             return INTERNER.intern_path(sysroot);\n         }\n \n@@ -1385,7 +1383,10 @@ impl Step for Assemble {\n \n         // If we're downloading a compiler from CI, we can use the same compiler for all stages other than 0.\n         if builder.download_rustc() {\n-            builder.ensure(Sysroot { compiler: target_compiler });\n+            let sysroot = builder.ensure(Sysroot { compiler: target_compiler });\n+            // Ensure that `libLLVM.so` ends up in the newly created target directory,\n+            // so that tools using `rustc_private` can use it.\n+            dist::maybe_install_llvm_target(builder, target_compiler.host, &sysroot);\n             return target_compiler;\n         }\n "}, {"sha": "9498b772f58e0016b9ddb127cdf155f9ec83740d", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/276fa294809e914b1d04192392d256814aa5ce1a/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/276fa294809e914b1d04192392d256814aa5ce1a/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=276fa294809e914b1d04192392d256814aa5ce1a", "patch": "@@ -1962,6 +1962,20 @@ fn maybe_install_llvm(builder: &Builder<'_>, target: TargetSelection, dst_libdir\n         }\n     }\n \n+    // FIXME: for reasons I don't understand, the LLVM so in the `rustc` component is different than the one in `rust-dev`.\n+    // Only the one in `rustc` works with the downloaded compiler.\n+    if builder.download_rustc() && target == builder.build.build {\n+        let src_libdir = builder.ci_rustc_dir(target).join(\"lib\");\n+        for entry in t!(std::fs::read_dir(&src_libdir)) {\n+            let entry = t!(entry);\n+            if entry.file_name().to_str().unwrap().starts_with(\"libLLVM-\") {\n+                install_llvm_file(builder, &entry.path(), dst_libdir);\n+                return !builder.config.dry_run();\n+            }\n+        }\n+        panic!(\"libLLVM.so not found in src_libdir {}!\", src_libdir.display());\n+    }\n+\n     // On macOS, rustc (and LLVM tools) link to an unversioned libLLVM.dylib\n     // instead of libLLVM-11-rust-....dylib, as on linux. It's not entirely\n     // clear why this is the case, though. llvm-config will emit the versioned"}, {"sha": "419bcbc63cfffb2dab1663bc4b48c5b1be019f9d", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/276fa294809e914b1d04192392d256814aa5ce1a/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/276fa294809e914b1d04192392d256814aa5ce1a/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=276fa294809e914b1d04192392d256814aa5ce1a", "patch": "@@ -814,6 +814,11 @@ impl Build {\n         self.stage_out(compiler, mode).join(&*target.triple).join(self.cargo_dir())\n     }\n \n+    /// Directory where the extracted `rustc-dev` component is stored.\n+    fn ci_rustc_dir(&self, target: TargetSelection) -> PathBuf {\n+        self.out.join(&*target.triple).join(\"ci-rustc\")\n+    }\n+\n     /// Root output directory for LLVM compiled for `target`\n     ///\n     /// Note that if LLVM is configured externally then the directory returned"}]}