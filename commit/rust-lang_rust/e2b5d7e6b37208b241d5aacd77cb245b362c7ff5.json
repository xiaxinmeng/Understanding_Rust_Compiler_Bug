{"sha": "e2b5d7e6b37208b241d5aacd77cb245b362c7ff5", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUyYjVkN2U2YjM3MjA4YjI0MWQ1YWFjZDc3Y2IyNDViMzYyYzdmZjU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-07-28T12:55:12Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-07-28T12:55:12Z"}, "message": "Auto merge of #43324 - Nashenas88:visit_locations, r=arielb1\n\nProvide positional information when visiting ty, substs and closure_substs in MIR\n\nThis will enable the region renumbering portion of #43234 (non-lexical lifetimes). @nikomatsakis's current plan [here](https://gist.github.com/nikomatsakis/dfc27b28cd024eb25054b52bb11082f2) shows that we need spans of the original code to create new region variables, e.g. `self.infcx.next_region_var(infer::MiscVariable(span))`. The current visitor impls did not pass positional information (`Location` in some, `Span` and `SourceInfo` for others) for all types. I did not expand this to all visits, just the ones necessary for the above-mentioned plan.", "tree": {"sha": "c25d6a0bf2ccf232ae08278a899c249f051a2ded", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c25d6a0bf2ccf232ae08278a899c249f051a2ded"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e2b5d7e6b37208b241d5aacd77cb245b362c7ff5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e2b5d7e6b37208b241d5aacd77cb245b362c7ff5", "html_url": "https://github.com/rust-lang/rust/commit/e2b5d7e6b37208b241d5aacd77cb245b362c7ff5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e2b5d7e6b37208b241d5aacd77cb245b362c7ff5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6f815ca771b59fe652a5f88f198810b5dc37a4c9", "url": "https://api.github.com/repos/rust-lang/rust/commits/6f815ca771b59fe652a5f88f198810b5dc37a4c9", "html_url": "https://github.com/rust-lang/rust/commit/6f815ca771b59fe652a5f88f198810b5dc37a4c9"}, {"sha": "4b9acad7c66c9e9cb8f585ff7446872eec5c33de", "url": "https://api.github.com/repos/rust-lang/rust/commits/4b9acad7c66c9e9cb8f585ff7446872eec5c33de", "html_url": "https://github.com/rust-lang/rust/commit/4b9acad7c66c9e9cb8f585ff7446872eec5c33de"}], "stats": {"total": 60, "additions": 37, "deletions": 23}, "files": [{"sha": "fd3a9f8cd2d9aa21d9f303a358d3869932602baf", "filename": "src/librustc/mir/visit.rs", "status": "modified", "additions": 27, "deletions": 15, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/e2b5d7e6b37208b241d5aacd77cb245b362c7ff5/src%2Flibrustc%2Fmir%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2b5d7e6b37208b241d5aacd77cb245b362c7ff5/src%2Flibrustc%2Fmir%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fvisit.rs?ref=e2b5d7e6b37208b241d5aacd77cb245b362c7ff5", "patch": "@@ -210,17 +210,20 @@ macro_rules! make_mir_visitor {\n             }\n \n             fn visit_ty(&mut self,\n-                        ty: & $($mutability)* Ty<'tcx>) {\n+                        ty: & $($mutability)* Ty<'tcx>,\n+                        _: Lookup) {\n                 self.super_ty(ty);\n             }\n \n             fn visit_substs(&mut self,\n-                            substs: & $($mutability)* &'tcx Substs<'tcx>) {\n+                            substs: & $($mutability)* &'tcx Substs<'tcx>,\n+                            _: Location) {\n                 self.super_substs(substs);\n             }\n \n             fn visit_closure_substs(&mut self,\n-                                    substs: & $($mutability)* ClosureSubsts<'tcx>) {\n+                                    substs: & $($mutability)* ClosureSubsts<'tcx>,\n+                                    _: Location) {\n                 self.super_closure_substs(substs);\n             }\n \n@@ -266,7 +269,11 @@ macro_rules! make_mir_visitor {\n                     self.visit_visibility_scope_data(scope);\n                 }\n \n-                self.visit_ty(&$($mutability)* mir.return_ty);\n+                let lookup = Lookup::Src(SourceInfo {\n+                    span: mir.span,\n+                    scope: ARGUMENT_VISIBILITY_SCOPE,\n+                });\n+                self.visit_ty(&$($mutability)* mir.return_ty, lookup);\n \n                 for local_decl in &$($mutability)* mir.local_decls {\n                     self.visit_local_decl(local_decl);\n@@ -385,7 +392,7 @@ macro_rules! make_mir_visitor {\n                                                 ref values,\n                                                 ref targets } => {\n                         self.visit_operand(discr, source_location);\n-                        self.visit_ty(switch_ty);\n+                        self.visit_ty(switch_ty, Lookup::Loc(source_location));\n                         for value in &values[..] {\n                             self.visit_const_int(value, source_location);\n                         }\n@@ -489,7 +496,7 @@ macro_rules! make_mir_visitor {\n                                  ref $($mutability)* operand,\n                                  ref $($mutability)* ty) => {\n                         self.visit_operand(operand, location);\n-                        self.visit_ty(ty);\n+                        self.visit_ty(ty, Lookup::Loc(location));\n                     }\n \n                     Rvalue::BinaryOp(_bin_op,\n@@ -511,28 +518,28 @@ macro_rules! make_mir_visitor {\n                     }\n \n                     Rvalue::NullaryOp(_op, ref $($mutability)* ty) => {\n-                        self.visit_ty(ty);\n+                        self.visit_ty(ty, Lookup::Loc(location));\n                     }\n \n                     Rvalue::Aggregate(ref $($mutability)* kind,\n                                       ref $($mutability)* operands) => {\n                         let kind = &$($mutability)* **kind;\n                         match *kind {\n                             AggregateKind::Array(ref $($mutability)* ty) => {\n-                                self.visit_ty(ty);\n+                                self.visit_ty(ty, Lookup::Loc(location));\n                             }\n                             AggregateKind::Tuple => {\n                             }\n                             AggregateKind::Adt(_adt_def,\n                                                _variant_index,\n                                                ref $($mutability)* substs,\n                                                _active_field_index) => {\n-                                self.visit_substs(substs);\n+                                self.visit_substs(substs, location);\n                             }\n                             AggregateKind::Closure(ref $($mutability)* def_id,\n                                                    ref $($mutability)* closure_substs) => {\n                                 self.visit_def_id(def_id, location);\n-                                self.visit_closure_substs(closure_substs);\n+                                self.visit_closure_substs(closure_substs, location);\n                             }\n                         }\n \n@@ -581,7 +588,7 @@ macro_rules! make_mir_visitor {\n                     ref $($mutability)* ty,\n                 } = *static_;\n                 self.visit_def_id(def_id, location);\n-                self.visit_ty(ty);\n+                self.visit_ty(ty, Lookup::Loc(location));\n             }\n \n             fn super_projection(&mut self,\n@@ -611,7 +618,7 @@ macro_rules! make_mir_visitor {\n                     ProjectionElem::Subslice { from: _, to: _ } => {\n                     }\n                     ProjectionElem::Field(_field, ref $($mutability)* ty) => {\n-                        self.visit_ty(ty);\n+                        self.visit_ty(ty, Lookup::Loc(location));\n                     }\n                     ProjectionElem::Index(ref $($mutability)* operand) => {\n                         self.visit_operand(operand, location);\n@@ -635,7 +642,7 @@ macro_rules! make_mir_visitor {\n                     is_user_variable: _,\n                 } = *local_decl;\n \n-                self.visit_ty(ty);\n+                self.visit_ty(ty, Lookup::Src(*source_info));\n                 self.visit_source_info(source_info);\n             }\n \n@@ -658,7 +665,7 @@ macro_rules! make_mir_visitor {\n                 } = *constant;\n \n                 self.visit_span(span);\n-                self.visit_ty(ty);\n+                self.visit_ty(ty, Lookup::Loc(location));\n                 self.visit_literal(literal, location);\n             }\n \n@@ -669,7 +676,7 @@ macro_rules! make_mir_visitor {\n                     Literal::Item { ref $($mutability)* def_id,\n                                     ref $($mutability)* substs } => {\n                         self.visit_def_id(def_id, location);\n-                        self.visit_substs(substs);\n+                        self.visit_substs(substs, location);\n                     }\n                     Literal::Value { ref $($mutability)* value } => {\n                         self.visit_const_val(value, location);\n@@ -734,6 +741,11 @@ macro_rules! make_mir_visitor {\n make_mir_visitor!(Visitor,);\n make_mir_visitor!(MutVisitor,mut);\n \n+pub enum Lookup {\n+    Loc(Location),\n+    Src(SourceInfo),\n+}\n+\n #[derive(Copy, Clone, Debug, PartialEq, Eq)]\n pub enum LvalueContext<'tcx> {\n     // Appears as LHS of an assignment"}, {"sha": "3353fb9a5b49c8b501ae925658ab12a25852bbc1", "filename": "src/librustc_mir/build/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e2b5d7e6b37208b241d5aacd77cb245b362c7ff5/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2b5d7e6b37208b241d5aacd77cb245b362c7ff5/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmod.rs?ref=e2b5d7e6b37208b241d5aacd77cb245b362c7ff5", "patch": "@@ -17,7 +17,7 @@ use rustc::hir::def_id::DefId;\n use rustc::middle::region::CodeExtent;\n use rustc::mir::*;\n use rustc::mir::transform::MirSource;\n-use rustc::mir::visit::MutVisitor;\n+use rustc::mir::visit::{MutVisitor, Lookup};\n use rustc::ty::{self, Ty, TyCtxt};\n use rustc::ty::subst::Substs;\n use rustc::util::nodemap::NodeMap;\n@@ -143,7 +143,7 @@ struct GlobalizeMir<'a, 'gcx: 'a> {\n }\n \n impl<'a, 'gcx: 'tcx, 'tcx> MutVisitor<'tcx> for GlobalizeMir<'a, 'gcx> {\n-    fn visit_ty(&mut self, ty: &mut Ty<'tcx>) {\n+    fn visit_ty(&mut self, ty: &mut Ty<'tcx>, _: Lookup) {\n         if let Some(lifted) = self.tcx.lift(ty) {\n             *ty = lifted;\n         } else {\n@@ -153,7 +153,7 @@ impl<'a, 'gcx: 'tcx, 'tcx> MutVisitor<'tcx> for GlobalizeMir<'a, 'gcx> {\n         }\n     }\n \n-    fn visit_substs(&mut self, substs: &mut &'tcx Substs<'tcx>) {\n+    fn visit_substs(&mut self, substs: &mut &'tcx Substs<'tcx>, _: Location) {\n         if let Some(lifted) = self.tcx.lift(substs) {\n             *substs = lifted;\n         } else {"}, {"sha": "da9032685e03bef7de05f8d51f50d29053aee055", "filename": "src/librustc_mir/transform/erase_regions.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e2b5d7e6b37208b241d5aacd77cb245b362c7ff5/src%2Flibrustc_mir%2Ftransform%2Ferase_regions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2b5d7e6b37208b241d5aacd77cb245b362c7ff5/src%2Flibrustc_mir%2Ftransform%2Ferase_regions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Ferase_regions.rs?ref=e2b5d7e6b37208b241d5aacd77cb245b362c7ff5", "patch": "@@ -15,7 +15,7 @@\n use rustc::ty::subst::Substs;\n use rustc::ty::{Ty, TyCtxt, ClosureSubsts};\n use rustc::mir::*;\n-use rustc::mir::visit::MutVisitor;\n+use rustc::mir::visit::{MutVisitor, Lookup};\n use rustc::mir::transform::{MirPass, MirSource};\n \n struct EraseRegionsVisitor<'a, 'tcx: 'a> {\n@@ -31,12 +31,12 @@ impl<'a, 'tcx> EraseRegionsVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> MutVisitor<'tcx> for EraseRegionsVisitor<'a, 'tcx> {\n-    fn visit_ty(&mut self, ty: &mut Ty<'tcx>) {\n+    fn visit_ty(&mut self, ty: &mut Ty<'tcx>, _: Lookup) {\n         let old_ty = *ty;\n         *ty = self.tcx.erase_regions(&old_ty);\n     }\n \n-    fn visit_substs(&mut self, substs: &mut &'tcx Substs<'tcx>) {\n+    fn visit_substs(&mut self, substs: &mut &'tcx Substs<'tcx>, _: Location) {\n         *substs = self.tcx.erase_regions(&{*substs});\n     }\n \n@@ -62,7 +62,8 @@ impl<'a, 'tcx> MutVisitor<'tcx> for EraseRegionsVisitor<'a, 'tcx> {\n     }\n \n     fn visit_closure_substs(&mut self,\n-                            substs: &mut ClosureSubsts<'tcx>) {\n+                            substs: &mut ClosureSubsts<'tcx>,\n+                            _: Location) {\n         *substs = self.tcx.erase_regions(substs);\n     }\n "}, {"sha": "9895802700ef7c1895d44f28834b62453e4333d0", "filename": "src/librustc_passes/mir_stats.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b5d7e6b37208b241d5aacd77cb245b362c7ff5/src%2Flibrustc_passes%2Fmir_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2b5d7e6b37208b241d5aacd77cb245b362c7ff5/src%2Flibrustc_passes%2Fmir_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Fmir_stats.rs?ref=e2b5d7e6b37208b241d5aacd77cb245b362c7ff5", "patch": "@@ -279,7 +279,8 @@ impl<'a, 'tcx> mir_visit::Visitor<'tcx> for StatCollector<'a, 'tcx> {\n     }\n \n     fn visit_closure_substs(&mut self,\n-                            substs: &ClosureSubsts<'tcx>) {\n+                            substs: &ClosureSubsts<'tcx>,\n+                            _: Location) {\n         self.record(\"ClosureSubsts\", substs);\n         self.super_closure_substs(substs);\n     }"}]}