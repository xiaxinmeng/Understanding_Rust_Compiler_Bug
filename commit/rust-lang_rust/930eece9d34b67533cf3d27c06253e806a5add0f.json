{"sha": "930eece9d34b67533cf3d27c06253e806a5add0f", "node_id": "C_kwDOAAsO6NoAKDkzMGVlY2U5ZDM0YjY3NTMzY2YzZDI3YzA2MjUzZTgwNmE1YWRkMGY", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-05-04T17:24:13Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-05-04T17:24:13Z"}, "message": "Don't compute trait super bounds unless they're positive", "tree": {"sha": "43ac520695b17eeb60ee8047676670d8ba4bc999", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/43ac520695b17eeb60ee8047676670d8ba4bc999"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/930eece9d34b67533cf3d27c06253e806a5add0f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/930eece9d34b67533cf3d27c06253e806a5add0f", "html_url": "https://github.com/rust-lang/rust/commit/930eece9d34b67533cf3d27c06253e806a5add0f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/930eece9d34b67533cf3d27c06253e806a5add0f/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eac35583d2ffb5ed9e564dee0822c9a244058ee0", "url": "https://api.github.com/repos/rust-lang/rust/commits/eac35583d2ffb5ed9e564dee0822c9a244058ee0", "html_url": "https://github.com/rust-lang/rust/commit/eac35583d2ffb5ed9e564dee0822c9a244058ee0"}], "stats": {"total": 30, "additions": 25, "deletions": 5}, "files": [{"sha": "c1e12b554e94c7b5827154366fb70b487a4b3237", "filename": "compiler/rustc_hir_analysis/src/collect/predicates_of.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/930eece9d34b67533cf3d27c06253e806a5add0f/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect%2Fpredicates_of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/930eece9d34b67533cf3d27c06253e806a5add0f/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect%2Fpredicates_of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect%2Fpredicates_of.rs?ref=930eece9d34b67533cf3d27c06253e806a5add0f", "patch": "@@ -657,14 +657,15 @@ pub(super) fn implied_predicates_with_filter(\n         &*tcx.arena.alloc_from_iter(superbounds.predicates().chain(where_bounds_that_match));\n     debug!(?implied_bounds);\n \n-    // Now require that immediate supertraits are converted,\n-    // which will, in turn, reach indirect supertraits.\n+    // Now require that immediate supertraits are converted, which will, in\n+    // turn, reach indirect supertraits, so we detect cycles now instead of\n+    // overflowing during elaboration.\n     if matches!(filter, PredicateFilter::SelfOnly) {\n-        // Now require that immediate supertraits are converted,\n-        // which will, in turn, reach indirect supertraits.\n         for &(pred, span) in implied_bounds {\n             debug!(\"superbound: {:?}\", pred);\n-            if let ty::PredicateKind::Clause(ty::Clause::Trait(bound)) = pred.kind().skip_binder() {\n+            if let ty::PredicateKind::Clause(ty::Clause::Trait(bound)) = pred.kind().skip_binder()\n+                && bound.polarity == ty::ImplPolarity::Positive\n+            {\n                 tcx.at(span).super_predicates_of(bound.def_id());\n             }\n         }"}, {"sha": "df0884b8b9f1601eb4fcfafe1a0c231c315f64d7", "filename": "tests/ui/traits/negative-bounds/supertrait.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/930eece9d34b67533cf3d27c06253e806a5add0f/tests%2Fui%2Ftraits%2Fnegative-bounds%2Fsupertrait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/930eece9d34b67533cf3d27c06253e806a5add0f/tests%2Fui%2Ftraits%2Fnegative-bounds%2Fsupertrait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftraits%2Fnegative-bounds%2Fsupertrait.rs?ref=930eece9d34b67533cf3d27c06253e806a5add0f", "patch": "@@ -0,0 +1,9 @@\n+// check-pass\n+\n+#![feature(negative_bounds)]\n+//~^ WARN the feature `negative_bounds` is incomplete\n+\n+trait A: !B {}\n+trait B: !A {}\n+\n+fn main() {}"}, {"sha": "f44753b624e3fd082df0a09fc434755c0607c938", "filename": "tests/ui/traits/negative-bounds/supertrait.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/930eece9d34b67533cf3d27c06253e806a5add0f/tests%2Fui%2Ftraits%2Fnegative-bounds%2Fsupertrait.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/930eece9d34b67533cf3d27c06253e806a5add0f/tests%2Fui%2Ftraits%2Fnegative-bounds%2Fsupertrait.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftraits%2Fnegative-bounds%2Fsupertrait.stderr?ref=930eece9d34b67533cf3d27c06253e806a5add0f", "patch": "@@ -0,0 +1,10 @@\n+warning: the feature `negative_bounds` is incomplete and may not be safe to use and/or cause compiler crashes\n+  --> $DIR/supertrait.rs:3:12\n+   |\n+LL | #![feature(negative_bounds)]\n+   |            ^^^^^^^^^^^^^^^\n+   |\n+   = note: `#[warn(incomplete_features)]` on by default\n+\n+warning: 1 warning emitted\n+"}]}