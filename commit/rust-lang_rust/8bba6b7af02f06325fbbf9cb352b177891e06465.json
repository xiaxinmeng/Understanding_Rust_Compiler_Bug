{"sha": "8bba6b7af02f06325fbbf9cb352b177891e06465", "node_id": "C_kwDOAAsO6NoAKDhiYmE2YjdhZjAyZjA2MzI1ZmJiZjljYjM1MmIxNzc4OTFlMDY0NjU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-02-25T21:12:14Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-02-25T21:12:14Z"}, "message": "Auto merge of #8253 - Alexendoo:print-in-fmt, r=camsteffen\n\nAdd `print_in_format_impl` lint\n\nchangelog: new lint: [`print_in_format_impl`]\n\nLints the use of `print`-like macros in manual `Display`/`Debug` impls. I feel like I make this mistake every time I write one \ud83d\ude04\n\nr? `@camsteffen`", "tree": {"sha": "66a70aa78cd70a1ab634d6731fa21c466f52352b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/66a70aa78cd70a1ab634d6731fa21c466f52352b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8bba6b7af02f06325fbbf9cb352b177891e06465", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8bba6b7af02f06325fbbf9cb352b177891e06465", "html_url": "https://github.com/rust-lang/rust/commit/8bba6b7af02f06325fbbf9cb352b177891e06465", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8bba6b7af02f06325fbbf9cb352b177891e06465/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4417f78e91eca7b2de09a820ea29efc0b2629901", "url": "https://api.github.com/repos/rust-lang/rust/commits/4417f78e91eca7b2de09a820ea29efc0b2629901", "html_url": "https://github.com/rust-lang/rust/commit/4417f78e91eca7b2de09a820ea29efc0b2629901"}, {"sha": "52f3d61a2a97a84c6aa96b7b4cb80aaff1c5f898", "url": "https://api.github.com/repos/rust-lang/rust/commits/52f3d61a2a97a84c6aa96b7b4cb80aaff1c5f898", "html_url": "https://github.com/rust-lang/rust/commit/52f3d61a2a97a84c6aa96b7b4cb80aaff1c5f898"}], "stats": {"total": 285, "additions": 228, "deletions": 57}, "files": [{"sha": "35983b7fb506f7799cd2f6e6549061bf5b64e868", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8bba6b7af02f06325fbbf9cb352b177891e06465/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/8bba6b7af02f06325fbbf9cb352b177891e06465/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=8bba6b7af02f06325fbbf9cb352b177891e06465", "patch": "@@ -3370,6 +3370,7 @@ Released 2018-09-13\n [`pattern_type_mismatch`]: https://rust-lang.github.io/rust-clippy/master/index.html#pattern_type_mismatch\n [`possible_missing_comma`]: https://rust-lang.github.io/rust-clippy/master/index.html#possible_missing_comma\n [`precedence`]: https://rust-lang.github.io/rust-clippy/master/index.html#precedence\n+[`print_in_format_impl`]: https://rust-lang.github.io/rust-clippy/master/index.html#print_in_format_impl\n [`print_literal`]: https://rust-lang.github.io/rust-clippy/master/index.html#print_literal\n [`print_stderr`]: https://rust-lang.github.io/rust-clippy/master/index.html#print_stderr\n [`print_stdout`]: https://rust-lang.github.io/rust-clippy/master/index.html#print_stdout"}, {"sha": "ef8be9e878f6cb6f60a9342455e6d00b904987ad", "filename": "clippy_lints/src/format_impl.rs", "status": "renamed", "additions": 115, "deletions": 52, "changes": 167, "blob_url": "https://github.com/rust-lang/rust/blob/8bba6b7af02f06325fbbf9cb352b177891e06465/clippy_lints%2Fsrc%2Fformat_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bba6b7af02f06325fbbf9cb352b177891e06465/clippy_lints%2Fsrc%2Fformat_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fformat_impl.rs?ref=8bba6b7af02f06325fbbf9cb352b177891e06465", "patch": "@@ -1,27 +1,13 @@\n-use clippy_utils::diagnostics::span_lint;\n+use clippy_utils::diagnostics::{span_lint, span_lint_and_sugg};\n use clippy_utils::macros::{is_format_macro, root_macro_call_first_node, FormatArgsArg, FormatArgsExpn};\n-use clippy_utils::{is_diag_trait_item, path_to_local, peel_ref_operators};\n+use clippy_utils::{get_parent_as_impl, is_diag_trait_item, path_to_local, peel_ref_operators};\n use if_chain::if_chain;\n-use rustc_hir::{Expr, ExprKind, Impl, Item, ItemKind, QPath};\n+use rustc_errors::Applicability;\n+use rustc_hir::{Expr, ExprKind, Impl, ImplItem, ImplItemKind, QPath};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n use rustc_span::{sym, symbol::kw, Symbol};\n \n-#[derive(Clone, Copy)]\n-enum FormatTrait {\n-    Debug,\n-    Display,\n-}\n-\n-impl FormatTrait {\n-    fn name(self) -> Symbol {\n-        match self {\n-            FormatTrait::Debug => sym::Debug,\n-            FormatTrait::Display => sym::Display,\n-        }\n-    }\n-}\n-\n declare_clippy_lint! {\n     /// ### What it does\n     /// Checks for format trait implementations (e.g. `Display`) with a recursive call to itself\n@@ -61,47 +47,92 @@ declare_clippy_lint! {\n     \"Format trait method called while implementing the same Format trait\"\n }\n \n+declare_clippy_lint! {\n+    /// ### What it does\n+    /// Checks for use of `println`, `print`, `eprintln` or `eprint` in an\n+    /// implementation of a formatting trait.\n+    ///\n+    /// ### Why is this bad?\n+    /// Using a print macro is likely unintentional since formatting traits\n+    /// should write to the `Formatter`, not stdout/stderr.\n+    ///\n+    /// ### Example\n+    /// ```rust\n+    /// use std::fmt::{Display, Error, Formatter};\n+    ///\n+    /// struct S;\n+    /// impl Display for S {\n+    ///     fn fmt(&self, f: &mut Formatter) -> Result<(), Error> {\n+    ///         println!(\"S\");\n+    ///\n+    ///         Ok(())\n+    ///     }\n+    /// }\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// use std::fmt::{Display, Error, Formatter};\n+    ///\n+    /// struct S;\n+    /// impl Display for S {\n+    ///     fn fmt(&self, f: &mut Formatter) -> Result<(), Error> {\n+    ///         writeln!(f, \"S\");\n+    ///\n+    ///         Ok(())\n+    ///     }\n+    /// }\n+    /// ```\n+    #[clippy::version = \"1.61.0\"]\n+    pub PRINT_IN_FORMAT_IMPL,\n+    suspicious,\n+    \"use of a print macro in a formatting trait impl\"\n+}\n+\n+#[derive(Clone, Copy)]\n+struct FormatTrait {\n+    /// e.g. `sym::Display`\n+    name: Symbol,\n+    /// `f` in `fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {}`\n+    formatter_name: Option<Symbol>,\n+}\n+\n #[derive(Default)]\n-pub struct RecursiveFormatImpl {\n+pub struct FormatImpl {\n     // Whether we are inside Display or Debug trait impl - None for neither\n     format_trait_impl: Option<FormatTrait>,\n }\n \n-impl RecursiveFormatImpl {\n+impl FormatImpl {\n     pub fn new() -> Self {\n         Self {\n             format_trait_impl: None,\n         }\n     }\n }\n \n-impl_lint_pass!(RecursiveFormatImpl => [RECURSIVE_FORMAT_IMPL]);\n+impl_lint_pass!(FormatImpl => [RECURSIVE_FORMAT_IMPL, PRINT_IN_FORMAT_IMPL]);\n \n-impl<'tcx> LateLintPass<'tcx> for RecursiveFormatImpl {\n-    fn check_item(&mut self, cx: &LateContext<'_>, item: &Item<'_>) {\n-        if let Some(format_trait_impl) = is_format_trait_impl(cx, item) {\n-            self.format_trait_impl = Some(format_trait_impl);\n-        }\n+impl<'tcx> LateLintPass<'tcx> for FormatImpl {\n+    fn check_impl_item(&mut self, cx: &LateContext<'_>, impl_item: &ImplItem<'_>) {\n+        self.format_trait_impl = is_format_trait_impl(cx, impl_item);\n     }\n \n-    fn check_item_post(&mut self, cx: &LateContext<'_>, item: &Item<'_>) {\n+    fn check_impl_item_post(&mut self, cx: &LateContext<'_>, impl_item: &ImplItem<'_>) {\n         // Assume no nested Impl of Debug and Display within eachother\n-        if is_format_trait_impl(cx, item).is_some() {\n+        if is_format_trait_impl(cx, impl_item).is_some() {\n             self.format_trait_impl = None;\n         }\n     }\n \n     fn check_expr(&mut self, cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>) {\n-        match self.format_trait_impl {\n-            Some(FormatTrait::Display) => {\n-                check_to_string_in_display(cx, expr);\n-                check_self_in_format_args(cx, expr, FormatTrait::Display);\n-            },\n-            Some(FormatTrait::Debug) => {\n-                check_self_in_format_args(cx, expr, FormatTrait::Debug);\n-            },\n-            None => {},\n+        let Some(format_trait_impl) = self.format_trait_impl else { return };\n+\n+        if format_trait_impl.name == sym::Display {\n+            check_to_string_in_display(cx, expr);\n         }\n+\n+        check_self_in_format_args(cx, expr, format_trait_impl);\n+        check_print_in_format_impl(cx, expr, format_trait_impl);\n     }\n }\n \n@@ -140,7 +171,7 @@ fn check_self_in_format_args<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>,\n         if let Some(args) = format_args.args();\n         then {\n             for arg in args {\n-                if arg.format_trait != impl_trait.name() {\n+                if arg.format_trait != impl_trait.name {\n                     continue;\n                 }\n                 check_format_arg_self(cx, expr, &arg, impl_trait);\n@@ -156,33 +187,65 @@ fn check_format_arg_self(cx: &LateContext<'_>, expr: &Expr<'_>, arg: &FormatArgs\n     let reference = peel_ref_operators(cx, arg.value);\n     let map = cx.tcx.hir();\n     // Is the reference self?\n-    let symbol_ident = impl_trait.name().to_ident_string();\n     if path_to_local(reference).map(|x| map.name(x)) == Some(kw::SelfLower) {\n+        let FormatTrait { name, .. } = impl_trait;\n         span_lint(\n             cx,\n             RECURSIVE_FORMAT_IMPL,\n             expr.span,\n-            &format!(\n-                \"using `self` as `{}` in `impl {}` will cause infinite recursion\",\n-                &symbol_ident, &symbol_ident\n-            ),\n+            &format!(\"using `self` as `{name}` in `impl {name}` will cause infinite recursion\"),\n         );\n     }\n }\n \n-fn is_format_trait_impl(cx: &LateContext<'_>, item: &Item<'_>) -> Option<FormatTrait> {\n+fn check_print_in_format_impl(cx: &LateContext<'_>, expr: &Expr<'_>, impl_trait: FormatTrait) {\n     if_chain! {\n-        // Are we at an Impl?\n-        if let ItemKind::Impl(Impl { of_trait: Some(trait_ref), .. }) = &item.kind;\n+        if let Some(macro_call) = root_macro_call_first_node(cx, expr);\n+        if let Some(name) = cx.tcx.get_diagnostic_name(macro_call.def_id);\n+        then {\n+            let replacement = match name {\n+                sym::print_macro | sym::eprint_macro => \"write\",\n+                sym::println_macro | sym::eprintln_macro => \"writeln\",\n+                _ => return,\n+            };\n+\n+            let name = name.as_str().strip_suffix(\"_macro\").unwrap();\n+\n+            span_lint_and_sugg(\n+                cx,\n+                PRINT_IN_FORMAT_IMPL,\n+                macro_call.span,\n+                &format!(\"use of `{}!` in `{}` impl\", name, impl_trait.name),\n+                \"replace with\",\n+                if let Some(formatter_name) = impl_trait.formatter_name {\n+                    format!(\"{}!({}, ..)\", replacement, formatter_name)\n+                } else {\n+                    format!(\"{}!(..)\", replacement)\n+                },\n+                Applicability::HasPlaceholders,\n+            );\n+        }\n+    }\n+}\n+\n+fn is_format_trait_impl(cx: &LateContext<'_>, impl_item: &ImplItem<'_>) -> Option<FormatTrait> {\n+    if_chain! {\n+        if impl_item.ident.name == sym::fmt;\n+        if let ImplItemKind::Fn(_, body_id) = impl_item.kind;\n+        if let Some(Impl { of_trait: Some(trait_ref),..}) = get_parent_as_impl(cx.tcx, impl_item.hir_id());\n         if let Some(did) = trait_ref.trait_def_id();\n         if let Some(name) = cx.tcx.get_diagnostic_name(did);\n+        if matches!(name, sym::Debug | sym::Display);\n         then {\n-            // Is Impl for Debug or Display?\n-            match name {\n-                sym::Debug => Some(FormatTrait::Debug),\n-                sym::Display => Some(FormatTrait::Display),\n-                _ => None,\n-            }\n+            let body = cx.tcx.hir().body(body_id);\n+            let formatter_name = body.params.get(1)\n+                .and_then(|param| param.pat.simple_ident())\n+                .map(|ident| ident.name);\n+\n+            Some(FormatTrait {\n+                name,\n+                formatter_name,\n+            })\n         } else {\n             None\n         }", "previous_filename": "clippy_lints/src/recursive_format_impl.rs"}, {"sha": "f6d467941e3ef80dd629caba969e28cfdf208b16", "filename": "clippy_lints/src/lib.register_all.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/8bba6b7af02f06325fbbf9cb352b177891e06465/clippy_lints%2Fsrc%2Flib.register_all.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bba6b7af02f06325fbbf9cb352b177891e06465/clippy_lints%2Fsrc%2Flib.register_all.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_all.rs?ref=8bba6b7af02f06325fbbf9cb352b177891e06465", "patch": "@@ -68,6 +68,8 @@ store.register_group(true, \"clippy::all\", Some(\"clippy_all\"), vec![\n     LintId::of(format::USELESS_FORMAT),\n     LintId::of(format_args::FORMAT_IN_FORMAT_ARGS),\n     LintId::of(format_args::TO_STRING_IN_FORMAT_ARGS),\n+    LintId::of(format_impl::PRINT_IN_FORMAT_IMPL),\n+    LintId::of(format_impl::RECURSIVE_FORMAT_IMPL),\n     LintId::of(formatting::POSSIBLE_MISSING_COMMA),\n     LintId::of(formatting::SUSPICIOUS_ASSIGNMENT_FORMATTING),\n     LintId::of(formatting::SUSPICIOUS_ELSE_FORMATTING),\n@@ -244,7 +246,6 @@ store.register_group(true, \"clippy::all\", Some(\"clippy_all\"), vec![\n     LintId::of(ranges::MANUAL_RANGE_CONTAINS),\n     LintId::of(ranges::RANGE_ZIP_WITH_LEN),\n     LintId::of(ranges::REVERSED_EMPTY_RANGES),\n-    LintId::of(recursive_format_impl::RECURSIVE_FORMAT_IMPL),\n     LintId::of(redundant_clone::REDUNDANT_CLONE),\n     LintId::of(redundant_closure_call::REDUNDANT_CLOSURE_CALL),\n     LintId::of(redundant_field_names::REDUNDANT_FIELD_NAMES),"}, {"sha": "35b1e644a8a71d63bd9afa2375a0d089cec14bb0", "filename": "clippy_lints/src/lib.register_correctness.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8bba6b7af02f06325fbbf9cb352b177891e06465/clippy_lints%2Fsrc%2Flib.register_correctness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bba6b7af02f06325fbbf9cb352b177891e06465/clippy_lints%2Fsrc%2Flib.register_correctness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_correctness.rs?ref=8bba6b7af02f06325fbbf9cb352b177891e06465", "patch": "@@ -24,6 +24,7 @@ store.register_group(true, \"clippy::correctness\", Some(\"clippy_correctness\"), ve\n     LintId::of(enum_clike::ENUM_CLIKE_UNPORTABLE_VARIANT),\n     LintId::of(eq_op::EQ_OP),\n     LintId::of(erasing_op::ERASING_OP),\n+    LintId::of(format_impl::RECURSIVE_FORMAT_IMPL),\n     LintId::of(formatting::POSSIBLE_MISSING_COMMA),\n     LintId::of(functions::NOT_UNSAFE_PTR_ARG_DEREF),\n     LintId::of(if_let_mutex::IF_LET_MUTEX),\n@@ -52,7 +53,6 @@ store.register_group(true, \"clippy::correctness\", Some(\"clippy_correctness\"), ve\n     LintId::of(ptr::INVALID_NULL_PTR_USAGE),\n     LintId::of(ptr::MUT_FROM_REF),\n     LintId::of(ranges::REVERSED_EMPTY_RANGES),\n-    LintId::of(recursive_format_impl::RECURSIVE_FORMAT_IMPL),\n     LintId::of(regex::INVALID_REGEX),\n     LintId::of(self_assignment::SELF_ASSIGNMENT),\n     LintId::of(serde_api::SERDE_API_MISUSE),"}, {"sha": "686482671b482ae698579d25f42f7edb9893731a", "filename": "clippy_lints/src/lib.register_lints.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/8bba6b7af02f06325fbbf9cb352b177891e06465/clippy_lints%2Fsrc%2Flib.register_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bba6b7af02f06325fbbf9cb352b177891e06465/clippy_lints%2Fsrc%2Flib.register_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_lints.rs?ref=8bba6b7af02f06325fbbf9cb352b177891e06465", "patch": "@@ -152,6 +152,8 @@ store.register_lints(&[\n     format::USELESS_FORMAT,\n     format_args::FORMAT_IN_FORMAT_ARGS,\n     format_args::TO_STRING_IN_FORMAT_ARGS,\n+    format_impl::PRINT_IN_FORMAT_IMPL,\n+    format_impl::RECURSIVE_FORMAT_IMPL,\n     formatting::POSSIBLE_MISSING_COMMA,\n     formatting::SUSPICIOUS_ASSIGNMENT_FORMATTING,\n     formatting::SUSPICIOUS_ELSE_FORMATTING,\n@@ -417,7 +419,6 @@ store.register_lints(&[\n     ranges::RANGE_PLUS_ONE,\n     ranges::RANGE_ZIP_WITH_LEN,\n     ranges::REVERSED_EMPTY_RANGES,\n-    recursive_format_impl::RECURSIVE_FORMAT_IMPL,\n     redundant_clone::REDUNDANT_CLONE,\n     redundant_closure_call::REDUNDANT_CLOSURE_CALL,\n     redundant_else::REDUNDANT_ELSE,"}, {"sha": "465baa8258174e59f14d91b941dbe4bae33d3936", "filename": "clippy_lints/src/lib.register_suspicious.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8bba6b7af02f06325fbbf9cb352b177891e06465/clippy_lints%2Fsrc%2Flib.register_suspicious.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bba6b7af02f06325fbbf9cb352b177891e06465/clippy_lints%2Fsrc%2Flib.register_suspicious.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_suspicious.rs?ref=8bba6b7af02f06325fbbf9cb352b177891e06465", "patch": "@@ -10,6 +10,7 @@ store.register_group(true, \"clippy::suspicious\", Some(\"clippy_suspicious\"), vec!\n     LintId::of(casts::CAST_ENUM_TRUNCATION),\n     LintId::of(eval_order_dependence::EVAL_ORDER_DEPENDENCE),\n     LintId::of(float_equality_without_abs::FLOAT_EQUALITY_WITHOUT_ABS),\n+    LintId::of(format_impl::PRINT_IN_FORMAT_IMPL),\n     LintId::of(formatting::SUSPICIOUS_ASSIGNMENT_FORMATTING),\n     LintId::of(formatting::SUSPICIOUS_ELSE_FORMATTING),\n     LintId::of(formatting::SUSPICIOUS_UNARY_OP_FORMATTING),"}, {"sha": "230e2b2ccdfb597e8fe293ce666587f746ad22fb", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8bba6b7af02f06325fbbf9cb352b177891e06465/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bba6b7af02f06325fbbf9cb352b177891e06465/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=8bba6b7af02f06325fbbf9cb352b177891e06465", "patch": "@@ -226,6 +226,7 @@ mod float_literal;\n mod floating_point_arithmetic;\n mod format;\n mod format_args;\n+mod format_impl;\n mod formatting;\n mod from_over_into;\n mod from_str_radix_10;\n@@ -333,7 +334,6 @@ mod ptr_eq;\n mod ptr_offset_with_cast;\n mod question_mark;\n mod ranges;\n-mod recursive_format_impl;\n mod redundant_clone;\n mod redundant_closure_call;\n mod redundant_else;\n@@ -705,7 +705,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(|| Box::new(modulo_arithmetic::ModuloArithmetic));\n     store.register_early_pass(|| Box::new(reference::DerefAddrOf));\n     store.register_early_pass(|| Box::new(double_parens::DoubleParens));\n-    store.register_late_pass(|| Box::new(recursive_format_impl::RecursiveFormatImpl::new()));\n+    store.register_late_pass(|| Box::new(format_impl::FormatImpl::new()));\n     store.register_early_pass(|| Box::new(unsafe_removed_from_name::UnsafeNameRemoval));\n     store.register_early_pass(|| Box::new(else_if_without_else::ElseIfWithoutElse));\n     store.register_early_pass(|| Box::new(int_plus_one::IntPlusOne));"}, {"sha": "64e8868660980fb1c62a20456e7f438d2d9e6225", "filename": "tests/ui/print_in_format_impl.rs", "status": "added", "additions": 58, "deletions": 0, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/8bba6b7af02f06325fbbf9cb352b177891e06465/tests%2Fui%2Fprint_in_format_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bba6b7af02f06325fbbf9cb352b177891e06465/tests%2Fui%2Fprint_in_format_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fprint_in_format_impl.rs?ref=8bba6b7af02f06325fbbf9cb352b177891e06465", "patch": "@@ -0,0 +1,58 @@\n+#![allow(unused, clippy::print_literal, clippy::write_literal)]\n+#![warn(clippy::print_in_format_impl)]\n+use std::fmt::{Debug, Display, Error, Formatter};\n+\n+macro_rules! indirect {\n+    () => {{ println!() }};\n+}\n+\n+macro_rules! nested {\n+    ($($tt:tt)*) => {\n+        $($tt)*\n+    };\n+}\n+\n+struct Foo;\n+impl Debug for Foo {\n+    fn fmt(&self, f: &mut Formatter) -> Result<(), Error> {\n+        static WORKS_WITH_NESTED_ITEMS: bool = true;\n+\n+        print!(\"{}\", 1);\n+        println!(\"{}\", 2);\n+        eprint!(\"{}\", 3);\n+        eprintln!(\"{}\", 4);\n+        nested! {\n+            println!(\"nested\");\n+        };\n+\n+        write!(f, \"{}\", 5);\n+        writeln!(f, \"{}\", 6);\n+        indirect!();\n+\n+        Ok(())\n+    }\n+}\n+\n+impl Display for Foo {\n+    fn fmt(&self, f: &mut Formatter) -> Result<(), Error> {\n+        print!(\"Display\");\n+        write!(f, \"Display\");\n+\n+        Ok(())\n+    }\n+}\n+\n+struct UnnamedFormatter;\n+impl Debug for UnnamedFormatter {\n+    fn fmt(&self, _: &mut Formatter) -> Result<(), Error> {\n+        println!(\"UnnamedFormatter\");\n+        Ok(())\n+    }\n+}\n+\n+fn main() {\n+    print!(\"outside fmt\");\n+    println!(\"outside fmt\");\n+    eprint!(\"outside fmt\");\n+    eprintln!(\"outside fmt\");\n+}"}, {"sha": "63b7179bca7dcf715783ca67a8a1d7fb85d0cab0", "filename": "tests/ui/print_in_format_impl.stderr", "status": "added", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/8bba6b7af02f06325fbbf9cb352b177891e06465/tests%2Fui%2Fprint_in_format_impl.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8bba6b7af02f06325fbbf9cb352b177891e06465/tests%2Fui%2Fprint_in_format_impl.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fprint_in_format_impl.stderr?ref=8bba6b7af02f06325fbbf9cb352b177891e06465", "patch": "@@ -0,0 +1,46 @@\n+error: use of `print!` in `Debug` impl\n+  --> $DIR/print_in_format_impl.rs:20:9\n+   |\n+LL |         print!(\"{}\", 1);\n+   |         ^^^^^^^^^^^^^^^ help: replace with: `write!(f, ..)`\n+   |\n+   = note: `-D clippy::print-in-format-impl` implied by `-D warnings`\n+\n+error: use of `println!` in `Debug` impl\n+  --> $DIR/print_in_format_impl.rs:21:9\n+   |\n+LL |         println!(\"{}\", 2);\n+   |         ^^^^^^^^^^^^^^^^^ help: replace with: `writeln!(f, ..)`\n+\n+error: use of `eprint!` in `Debug` impl\n+  --> $DIR/print_in_format_impl.rs:22:9\n+   |\n+LL |         eprint!(\"{}\", 3);\n+   |         ^^^^^^^^^^^^^^^^ help: replace with: `write!(f, ..)`\n+\n+error: use of `eprintln!` in `Debug` impl\n+  --> $DIR/print_in_format_impl.rs:23:9\n+   |\n+LL |         eprintln!(\"{}\", 4);\n+   |         ^^^^^^^^^^^^^^^^^^ help: replace with: `writeln!(f, ..)`\n+\n+error: use of `println!` in `Debug` impl\n+  --> $DIR/print_in_format_impl.rs:25:13\n+   |\n+LL |             println!(\"nested\");\n+   |             ^^^^^^^^^^^^^^^^^^ help: replace with: `writeln!(f, ..)`\n+\n+error: use of `print!` in `Display` impl\n+  --> $DIR/print_in_format_impl.rs:38:9\n+   |\n+LL |         print!(\"Display\");\n+   |         ^^^^^^^^^^^^^^^^^ help: replace with: `write!(f, ..)`\n+\n+error: use of `println!` in `Debug` impl\n+  --> $DIR/print_in_format_impl.rs:48:9\n+   |\n+LL |         println!(\"UnnamedFormatter\");\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: replace with: `writeln!(..)`\n+\n+error: aborting due to 7 previous errors\n+"}]}