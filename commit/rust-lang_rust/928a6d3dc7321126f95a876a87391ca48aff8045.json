{"sha": "928a6d3dc7321126f95a876a87391ca48aff8045", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkyOGE2ZDNkYzczMjExMjZmOTVhODc2YTg3MzkxY2E0OGFmZjgwNDU=", "commit": {"author": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2018-10-11T06:07:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-10-11T06:07:51Z"}, "message": "Merge pull request #3288 from devonhollowood/pedantic-dogfood-casts\n\nPedantic dogfood: casts", "tree": {"sha": "5993167a6576eb51f6e03f75a03bd9f3a404eb07", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5993167a6576eb51f6e03f75a03bd9f3a404eb07"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/928a6d3dc7321126f95a876a87391ca48aff8045", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbvui3CRBK7hj4Ov3rIwAAdHIIAD+1JveLCAL19H6PYDSPn2ZG\nlMFyLPEyDLuoAJYvbO0WJoBOHdZ81jfj4dNuXOnFxl2M7tvwfZ0r1zYEib7KHvct\n/Y/5XazmVTbzJ4sOwmd70joB0NqVV7BGAdO76UjvXzxMPAZL00c9bUB5SimF1I8U\n59RVLX8gPc+veZ2z6u3b1fCDIzWuKgTag9kmp7weWpH+X9Y0CnLS/pJFkizoGkoP\nbsKbyocoTTKifNAPM4Ar8UO9KS8SpWhH711QlrKyOZ5PS71/hTLUAMN51c3KEJ9E\nKNHVxkQzFCYNoxYbSBH54sgtL6J4W1UUN/ho/wZfHwlJTFSuTwtp5ge9FVYIcEw=\n=CtPQ\n-----END PGP SIGNATURE-----\n", "payload": "tree 5993167a6576eb51f6e03f75a03bd9f3a404eb07\nparent 31eb3b73d34cf62a76abe99d868dfd6285228278\nparent 289c642d1a58c6173a1c3adbc26dbb89a7fde4ca\nauthor Philipp Hansch <dev@phansch.net> 1539238071 +0200\ncommitter GitHub <noreply@github.com> 1539238071 +0200\n\nMerge pull request #3288 from devonhollowood/pedantic-dogfood-casts\n\nPedantic dogfood: casts"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/928a6d3dc7321126f95a876a87391ca48aff8045", "html_url": "https://github.com/rust-lang/rust/commit/928a6d3dc7321126f95a876a87391ca48aff8045", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/928a6d3dc7321126f95a876a87391ca48aff8045/comments", "author": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "31eb3b73d34cf62a76abe99d868dfd6285228278", "url": "https://api.github.com/repos/rust-lang/rust/commits/31eb3b73d34cf62a76abe99d868dfd6285228278", "html_url": "https://github.com/rust-lang/rust/commit/31eb3b73d34cf62a76abe99d868dfd6285228278"}, {"sha": "289c642d1a58c6173a1c3adbc26dbb89a7fde4ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/289c642d1a58c6173a1c3adbc26dbb89a7fde4ca", "html_url": "https://github.com/rust-lang/rust/commit/289c642d1a58c6173a1c3adbc26dbb89a7fde4ca"}], "stats": {"total": 46, "additions": 34, "deletions": 12}, "files": [{"sha": "5d509ef76f3f2c071ef37fda6d6188ef5017089b", "filename": "clippy_lints/src/consts.rs", "status": "modified", "additions": 21, "deletions": 7, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/928a6d3dc7321126f95a876a87391ca48aff8045/clippy_lints%2Fsrc%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/928a6d3dc7321126f95a876a87391ca48aff8045/clippy_lints%2Fsrc%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fconsts.rs?ref=928a6d3dc7321126f95a876a87391ca48aff8045", "patch": "@@ -18,6 +18,7 @@ use crate::rustc::ty::{self, Ty, TyCtxt, Instance};\n use crate::rustc::ty::subst::{Subst, Substs};\n use std::cmp::Ordering::{self, Equal};\n use std::cmp::PartialOrd;\n+use std::convert::TryInto;\n use std::hash::{Hash, Hasher};\n use std::mem;\n use std::rc::Rc;\n@@ -229,6 +230,7 @@ impl<'c, 'cc> ConstEvalLateContext<'c, 'cc> {\n         }\n     }\n \n+    #[allow(clippy::cast_possible_wrap)]\n     fn constant_not(&self, o: &Constant, ty: ty::Ty<'_>) -> Option<Constant> {\n         use self::Constant::*;\n         match *o {\n@@ -341,8 +343,12 @@ impl<'c, 'cc> ConstEvalLateContext<'c, 'cc> {\n                             BinOpKind::Mul => l.checked_mul(r).map(zext),\n                             BinOpKind::Div if r != 0 => l.checked_div(r).map(zext),\n                             BinOpKind::Rem if r != 0 => l.checked_rem(r).map(zext),\n-                            BinOpKind::Shr => l.checked_shr(r as u128 as u32).map(zext),\n-                            BinOpKind::Shl => l.checked_shl(r as u128 as u32).map(zext),\n+                            BinOpKind::Shr => l.checked_shr(\n+                                    r.try_into().expect(\"invalid shift\")\n+                                ).map(zext),\n+                            BinOpKind::Shl => l.checked_shl(\n+                                    r.try_into().expect(\"invalid shift\")\n+                                ).map(zext),\n                             BinOpKind::BitXor => Some(zext(l ^ r)),\n                             BinOpKind::BitOr => Some(zext(l | r)),\n                             BinOpKind::BitAnd => Some(zext(l & r)),\n@@ -362,8 +368,12 @@ impl<'c, 'cc> ConstEvalLateContext<'c, 'cc> {\n                             BinOpKind::Mul => l.checked_mul(r).map(Constant::Int),\n                             BinOpKind::Div => l.checked_div(r).map(Constant::Int),\n                             BinOpKind::Rem => l.checked_rem(r).map(Constant::Int),\n-                            BinOpKind::Shr => l.checked_shr(r as u32).map(Constant::Int),\n-                            BinOpKind::Shl => l.checked_shl(r as u32).map(Constant::Int),\n+                            BinOpKind::Shr => l.checked_shr(\n+                                    r.try_into().expect(\"shift too large\")\n+                                ).map(Constant::Int),\n+                            BinOpKind::Shl => l.checked_shl(\n+                                    r.try_into().expect(\"shift too large\")\n+                                ).map(Constant::Int),\n                             BinOpKind::BitXor => Some(Constant::Int(l ^ r)),\n                             BinOpKind::BitOr => Some(Constant::Int(l | r)),\n                             BinOpKind::BitAnd => Some(Constant::Int(l & r)),\n@@ -426,8 +436,12 @@ pub fn miri_to_const<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>, result: &ty::Const<'\n         ConstValue::Scalar(Scalar::Bits{ bits: b, ..}) => match result.ty.sty {\n             ty::Bool => Some(Constant::Bool(b == 1)),\n             ty::Uint(_) | ty::Int(_) => Some(Constant::Int(b)),\n-            ty::Float(FloatTy::F32) => Some(Constant::F32(f32::from_bits(b as u32))),\n-            ty::Float(FloatTy::F64) => Some(Constant::F64(f64::from_bits(b as u64))),\n+            ty::Float(FloatTy::F32) => Some(Constant::F32(f32::from_bits(\n+                b.try_into().expect(\"invalid f32 bit representation\")\n+            ))),\n+            ty::Float(FloatTy::F64) => Some(Constant::F64(f64::from_bits(\n+                b.try_into().expect(\"invalid f64 bit representation\")\n+            ))),\n             // FIXME: implement other conversion\n             _ => None,\n         },\n@@ -439,7 +453,7 @@ pub fn miri_to_const<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>, result: &ty::Const<'\n                         .alloc_map\n                         .lock()\n                         .unwrap_memory(ptr.alloc_id);\n-                    let offset = ptr.offset.bytes() as usize;\n+                    let offset = ptr.offset.bytes().try_into().expect(\"too-large pointer offset\");\n                     let n = n as usize;\n                     String::from_utf8(alloc.bytes[offset..(offset + n)].to_owned()).ok().map(Constant::Str)\n                 },"}, {"sha": "313175aee8494f7107c3aa92990acd2fe5b885ab", "filename": "clippy_lints/src/enum_clike.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/928a6d3dc7321126f95a876a87391ca48aff8045/clippy_lints%2Fsrc%2Fenum_clike.rs", "raw_url": "https://github.com/rust-lang/rust/raw/928a6d3dc7321126f95a876a87391ca48aff8045/clippy_lints%2Fsrc%2Fenum_clike.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fenum_clike.rs?ref=928a6d3dc7321126f95a876a87391ca48aff8045", "patch": "@@ -53,7 +53,7 @@ impl LintPass for UnportableVariant {\n }\n \n impl<'a, 'tcx> LateLintPass<'a, 'tcx> for UnportableVariant {\n-    #[allow(clippy::cast_possible_truncation, clippy::cast_sign_loss)]\n+    #[allow(clippy::cast_possible_truncation, clippy::cast_possible_wrap, clippy::cast_sign_loss)]\n     fn check_item(&mut self, cx: &LateContext<'a, 'tcx>, item: &'tcx Item) {\n         if cx.tcx.data_layout.pointer_size.bits() != 64 {\n             return;"}, {"sha": "af69a6284f337941d737425d51df89370c12cff1", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/928a6d3dc7321126f95a876a87391ca48aff8045/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/928a6d3dc7321126f95a876a87391ca48aff8045/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=928a6d3dc7321126f95a876a87391ca48aff8045", "patch": "@@ -21,6 +21,7 @@\n #![feature(tool_lints)]\n #![warn(rust_2018_idioms, trivial_casts, trivial_numeric_casts)]\n #![feature(crate_visibility_modifier)]\n+#![feature(try_from)]\n \n // FIXME: switch to something more ergonomic here, once available.\n // (currently there is no way to opt into sysroot crates w/o `extern crate`)"}, {"sha": "e68468d4dfe27db65916716dc0090faabc8aa665", "filename": "clippy_lints/src/regex.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/928a6d3dc7321126f95a876a87391ca48aff8045/clippy_lints%2Fsrc%2Fregex.rs", "raw_url": "https://github.com/rust-lang/rust/raw/928a6d3dc7321126f95a876a87391ca48aff8045/clippy_lints%2Fsrc%2Fregex.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fregex.rs?ref=928a6d3dc7321126f95a876a87391ca48aff8045", "patch": "@@ -18,6 +18,7 @@ use crate::syntax::ast::{LitKind, NodeId, StrStyle};\n use crate::syntax::source_map::{BytePos, Span};\n use crate::utils::{is_expn_of, match_def_path, match_type, opt_def_id, paths, span_help_and_lint, span_lint};\n use crate::consts::{constant, Constant};\n+use std::convert::TryFrom;\n \n /// **What it does:** Checks [regex](https://crates.io/crates/regex) creation\n /// (with `Regex::new`,`RegexBuilder::new` or `RegexSet::new`) for correct\n@@ -141,10 +142,11 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Pass {\n     }\n }\n \n+#[allow(clippy::cast_possible_truncation)] // truncation very unlikely here\n fn str_span(base: Span, c: regex_syntax::ast::Span, offset: u16) -> Span {\n     let offset = u32::from(offset);\n-    let end = base.lo() + BytePos(c.end.offset as u32 + offset);\n-    let start = base.lo() + BytePos(c.start.offset as u32 + offset);\n+    let end = base.lo() + BytePos(u32::try_from(c.end.offset).expect(\"offset too large\") + offset);\n+    let start = base.lo() + BytePos(u32::try_from(c.start.offset).expect(\"offset too large\") + offset);\n     assert!(start <= end);\n     Span::new(start, end, base.ctxt())\n }"}, {"sha": "2a9b1cb0a102325c52cb58fc969185d43cf88b3c", "filename": "clippy_lints/src/utils/mod.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/928a6d3dc7321126f95a876a87391ca48aff8045/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/928a6d3dc7321126f95a876a87391ca48aff8045/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fmod.rs?ref=928a6d3dc7321126f95a876a87391ca48aff8045", "patch": "@@ -971,12 +971,14 @@ pub fn int_bits(tcx: TyCtxt<'_, '_, '_>, ity: ast::IntTy) -> u64 {\n     layout::Integer::from_attr(tcx, attr::IntType::SignedInt(ity)).size().bits()\n }\n \n+#[allow(clippy::cast_possible_wrap)]\n /// Turn a constant int byte representation into an i128\n pub fn sext(tcx: TyCtxt<'_, '_, '_>, u: u128, ity: ast::IntTy) -> i128 {\n     let amt = 128 - int_bits(tcx, ity);\n     ((u as i128) << amt) >> amt\n }\n \n+#[allow(clippy::cast_sign_loss)]\n /// clip unused bytes\n pub fn unsext(tcx: TyCtxt<'_, '_, '_>, u: i128, ity: ast::IntTy) -> u128 {\n     let amt = 128 - int_bits(tcx, ity);"}, {"sha": "eb67838f1d188e58ba6f89d6e66942f0856e5a47", "filename": "clippy_lints/src/utils/sugg.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/928a6d3dc7321126f95a876a87391ca48aff8045/clippy_lints%2Fsrc%2Futils%2Fsugg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/928a6d3dc7321126f95a876a87391ca48aff8045/clippy_lints%2Fsrc%2Futils%2Fsugg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fsugg.rs?ref=928a6d3dc7321126f95a876a87391ca48aff8045", "patch": "@@ -16,6 +16,7 @@ use crate::rustc::hir;\n use crate::rustc::lint::{EarlyContext, LateContext, LintContext};\n use crate::rustc_errors;\n use std::borrow::Cow;\n+use std::convert::TryInto;\n use std::fmt::Display;\n use std;\n use crate::syntax::source_map::{CharPos, Span};\n@@ -551,7 +552,7 @@ impl<'a, 'b, 'c, T: LintContext<'c>> DiagnosticBuilderExt<'c, T> for rustc_error\n             let non_whitespace_offset = src[fmpos.pos.to_usize()..].find(|c| c != ' ' && c != '\\t' && c != '\\n');\n \n             if let Some(non_whitespace_offset) = non_whitespace_offset {\n-                remove_span = remove_span.with_hi(remove_span.hi() + BytePos(non_whitespace_offset as u32))\n+                remove_span = remove_span.with_hi(remove_span.hi() + BytePos(non_whitespace_offset.try_into().expect(\"offset too large\")))\n             }\n         }\n "}, {"sha": "0619b3ae0d9c3b1a018168c9f063bffde8efcf50", "filename": "src/driver.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/928a6d3dc7321126f95a876a87391ca48aff8045/src%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/928a6d3dc7321126f95a876a87391ca48aff8045/src%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdriver.rs?ref=928a6d3dc7321126f95a876a87391ca48aff8045", "patch": "@@ -12,6 +12,7 @@\n #![feature(box_syntax)]\n #![feature(rustc_private)]\n #![feature(tool_lints)]\n+#![feature(try_from)]\n #![allow(unknown_lints, clippy::missing_docs_in_private_items)]\n \n // FIXME: switch to something more ergonomic here, once available.\n@@ -22,6 +23,7 @@ extern crate rustc_driver;\n extern crate rustc_plugin;\n use self::rustc_driver::{driver::CompileController, Compilation};\n \n+use std::convert::TryInto;\n use std::path::Path;\n use std::process::{exit, Command};\n \n@@ -153,5 +155,5 @@ pub fn main() {\n \n         let args = args;\n         rustc_driver::run_compiler(&args, Box::new(controller), None, None)\n-    }) as i32)\n+    }).try_into().expect(\"exit code too large\"))\n }"}]}