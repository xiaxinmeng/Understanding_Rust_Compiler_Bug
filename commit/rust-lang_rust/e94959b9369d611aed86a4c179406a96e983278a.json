{"sha": "e94959b9369d611aed86a4c179406a96e983278a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU5NDk1OWI5MzY5ZDYxMWFlZDg2YTRjMTc5NDA2YTk2ZTk4MzI3OGE=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2018-10-17T14:14:29Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2018-10-19T12:31:35Z"}, "message": "propagate user-type annotation for constants in expressions", "tree": {"sha": "53991c2ddcb42811bc5efa4e61e32bdf5e7a7c99", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/53991c2ddcb42811bc5efa4e61e32bdf5e7a7c99"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e94959b9369d611aed86a4c179406a96e983278a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e94959b9369d611aed86a4c179406a96e983278a", "html_url": "https://github.com/rust-lang/rust/commit/e94959b9369d611aed86a4c179406a96e983278a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e94959b9369d611aed86a4c179406a96e983278a/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ebdfda64f893f30675320e15349b2948b2194ea9", "url": "https://api.github.com/repos/rust-lang/rust/commits/ebdfda64f893f30675320e15349b2948b2194ea9", "html_url": "https://github.com/rust-lang/rust/commit/ebdfda64f893f30675320e15349b2948b2194ea9"}], "stats": {"total": 104, "additions": 91, "deletions": 13}, "files": [{"sha": "bb1e940d4a9ed0cc803044f1c4a0dde4774dc132", "filename": "src/librustc_mir/hair/cx/expr.rs", "status": "modified", "additions": 14, "deletions": 13, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/e94959b9369d611aed86a4c179406a96e983278a/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e94959b9369d611aed86a4c179406a96e983278a/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs?ref=e94959b9369d611aed86a4c179406a96e983278a", "patch": "@@ -771,13 +771,11 @@ fn user_substs_applied_to_def(\n         Def::Fn(_) |\n         Def::Method(_) |\n         Def::StructCtor(_, CtorKind::Fn) |\n-        Def::VariantCtor(_, CtorKind::Fn) =>\n+        Def::VariantCtor(_, CtorKind::Fn) |\n+        Def::Const(_) |\n+        Def::AssociatedConst(_) =>\n             Some(UserTypeAnnotation::TypeOf(def.def_id(), cx.tables().user_substs(hir_id)?)),\n \n-        Def::Const(_def_id) |\n-        Def::AssociatedConst(_def_id) =>\n-            bug!(\"unimplemented\"),\n-\n         // A unit struct/variant which is used as a value (e.g.,\n         // `None`). This has the type of the enum/struct that defines\n         // this variant -- but with the substitutions given by the\n@@ -889,14 +887,17 @@ fn convert_path_expr<'a, 'gcx, 'tcx>(cx: &mut Cx<'a, 'gcx, 'tcx>,\n         },\n \n         Def::Const(def_id) |\n-        Def::AssociatedConst(def_id) => ExprKind::Literal {\n-            literal: ty::Const::unevaluated(\n-                cx.tcx,\n-                def_id,\n-                substs,\n-                cx.tables().node_id_to_type(expr.hir_id),\n-            ),\n-            user_ty: None, // FIXME(#47184) -- user given type annot on constants\n+        Def::AssociatedConst(def_id) => {\n+            let user_ty = user_substs_applied_to_def(cx, expr.hir_id, &def);\n+            ExprKind::Literal {\n+                literal: ty::Const::unevaluated(\n+                    cx.tcx,\n+                    def_id,\n+                    substs,\n+                    cx.tables().node_id_to_type(expr.hir_id),\n+                ),\n+                user_ty,\n+            }\n         },\n \n         Def::StructCtor(def_id, CtorKind::Const) |"}, {"sha": "058ebaee9e512cae26f8fb172ae9468d09783d30", "filename": "src/test/ui/nll/user-annotations/constant-in-expr-inherent-1.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/e94959b9369d611aed86a4c179406a96e983278a/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-inherent-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e94959b9369d611aed86a4c179406a96e983278a/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-inherent-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-inherent-1.rs?ref=e94959b9369d611aed86a4c179406a96e983278a", "patch": "@@ -0,0 +1,15 @@\n+#![feature(nll)]\n+\n+struct Foo<'a> { x: &'a u32 }\n+\n+impl<'a> Foo<'a> {\n+    const C: &'a u32 = &22;\n+}\n+\n+fn foo<'a>(_: &'a u32) -> &'static u32 {\n+    <Foo<'a>>::C //~ ERROR\n+}\n+\n+fn main() {\n+}\n+"}, {"sha": "94fbe01772412081a4fd5f03fc4661cf5fec00aa", "filename": "src/test/ui/nll/user-annotations/constant-in-expr-inherent-1.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e94959b9369d611aed86a4c179406a96e983278a/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-inherent-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e94959b9369d611aed86a4c179406a96e983278a/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-inherent-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-inherent-1.stderr?ref=e94959b9369d611aed86a4c179406a96e983278a", "patch": "@@ -0,0 +1,10 @@\n+error: unsatisfied lifetime constraints\n+  --> $DIR/constant-in-expr-inherent-1.rs:10:5\n+   |\n+LL | fn foo<'a>(_: &'a u32) -> &'static u32 {\n+   |        -- lifetime `'a` defined here\n+LL |     <Foo<'a>>::C //~ ERROR\n+   |     ^^^^^^^^^^^^ returning this value requires that `'a` must outlive `'static`\n+\n+error: aborting due to previous error\n+"}, {"sha": "daa0d7bc24140b1cbf6d5906b07e950fe8616d14", "filename": "src/test/ui/nll/user-annotations/constant-in-expr-trait-item-1.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/e94959b9369d611aed86a4c179406a96e983278a/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-trait-item-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e94959b9369d611aed86a4c179406a96e983278a/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-trait-item-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-trait-item-1.rs?ref=e94959b9369d611aed86a4c179406a96e983278a", "patch": "@@ -0,0 +1,16 @@\n+#![feature(nll)]\n+\n+trait Foo<'a> {\n+    const C: &'a u32;\n+}\n+\n+impl<'a, T> Foo<'a> for T {\n+    const C: &'a u32 = &22;\n+}\n+\n+fn foo<'a>(_: &'a u32) -> &'static u32 {\n+    <() as Foo<'a>>::C //~ ERROR\n+}\n+\n+fn main() {\n+}"}, {"sha": "fee9abc1ed83af17f9e09ccdbfca1315b88cea43", "filename": "src/test/ui/nll/user-annotations/constant-in-expr-trait-item-1.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e94959b9369d611aed86a4c179406a96e983278a/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-trait-item-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e94959b9369d611aed86a4c179406a96e983278a/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-trait-item-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-trait-item-1.stderr?ref=e94959b9369d611aed86a4c179406a96e983278a", "patch": "@@ -0,0 +1,10 @@\n+error: unsatisfied lifetime constraints\n+  --> $DIR/constant-in-expr-trait-item-1.rs:12:5\n+   |\n+LL | fn foo<'a>(_: &'a u32) -> &'static u32 {\n+   |        -- lifetime `'a` defined here\n+LL |     <() as Foo<'a>>::C //~ ERROR\n+   |     ^^^^^^^^^^^^^^^^^^ returning this value requires that `'a` must outlive `'static`\n+\n+error: aborting due to previous error\n+"}, {"sha": "cd66e7a49cb83d1bc9350b593e1e4ee6047d88e6", "filename": "src/test/ui/nll/user-annotations/constant-in-expr-trait-item-2.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/e94959b9369d611aed86a4c179406a96e983278a/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-trait-item-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e94959b9369d611aed86a4c179406a96e983278a/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-trait-item-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-trait-item-2.rs?ref=e94959b9369d611aed86a4c179406a96e983278a", "patch": "@@ -0,0 +1,16 @@\n+#![feature(nll)]\n+\n+trait Foo<'a> {\n+    const C: &'a u32;\n+}\n+\n+impl<'a, T> Foo<'a> for T {\n+    const C: &'a u32 = &22;\n+}\n+\n+fn foo<'a, T: Foo<'a>>() -> &'static u32 {\n+    <T as Foo<'a>>::C //~ ERROR\n+}\n+\n+fn main() {\n+}"}, {"sha": "047aad98319232d12dc9a8e6fe3bf31c5fd39791", "filename": "src/test/ui/nll/user-annotations/constant-in-expr-trait-item-2.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e94959b9369d611aed86a4c179406a96e983278a/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-trait-item-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e94959b9369d611aed86a4c179406a96e983278a/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-trait-item-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fuser-annotations%2Fconstant-in-expr-trait-item-2.stderr?ref=e94959b9369d611aed86a4c179406a96e983278a", "patch": "@@ -0,0 +1,10 @@\n+error: unsatisfied lifetime constraints\n+  --> $DIR/constant-in-expr-trait-item-2.rs:12:5\n+   |\n+LL | fn foo<'a, T: Foo<'a>>() -> &'static u32 {\n+   |        -- lifetime `'a` defined here\n+LL |     <T as Foo<'a>>::C //~ ERROR\n+   |     ^^^^^^^^^^^^^^^^^ returning this value requires that `'a` must outlive `'static`\n+\n+error: aborting due to previous error\n+"}]}