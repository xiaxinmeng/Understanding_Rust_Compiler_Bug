{"sha": "41856b0a0f0a612c1e64088baed5389d82f93157", "node_id": "C_kwDOAAsO6NoAKDQxODU2YjBhMGYwYTYxMmMxZTY0MDg4YmFlZDUzODlkODJmOTMxNTc", "commit": {"author": {"name": "Ezra Shaw", "email": "ezrasure@outlook.com", "date": "2023-01-14T10:00:17Z"}, "committer": {"name": "Ezra Shaw", "email": "ezrasure@outlook.com", "date": "2023-01-14T23:48:53Z"}, "message": "allow negative numeric literals in `concat!`", "tree": {"sha": "cdf586caa69cbbdcb474a17ac37265205848e024", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cdf586caa69cbbdcb474a17ac37265205848e024"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/41856b0a0f0a612c1e64088baed5389d82f93157", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJJBAABCAAzFiEEYSWD6p+RIeSP1N2eF81cKtrg00QFAmPDP2UVHGV6cmFzdXJl\nQG91dGxvb2suY29tAAoJEBfNXCra4NNEpAoP/R/bVq0yieXpzWlVPifmp6PDTIgH\nQPg/8JoMZciv9PFmdA2JL9L9SHmTJcAwq+4YmRB6/lr998JZkEGSkeZnGXECkW90\n1aIJBlaAXv1Rr30MmFa9l6DgNXJvpSVYPRDMq3TmEPKe2HWYkIM1X5BrWnDcvUHf\nQOwuVNt/eIw2dN4r/OheCQv1D3DjSyotcbknO06/PIbVdoz+c6TMD3CkR3Ey7Y0i\nDU9QU4LYLVAmdj04dwlEUOwic/XqG0kkqvrUVV+d6ji8pHaKKOZcO0rvp4R64VOA\nj79LeLJ+uTImkEKl1KzO/LOrlKZDc8ENrqAqI9zkxjmzEQn25a4GE2iQOFuvszI+\n7cuSjS+aWdqOWtFah/wcAR9K3n5aR/Tm7uTSCIfWB3bU1OyyWr3MhoF/v1qHNUkP\nmuqEL5Pr7UDH6Q5pD7BeP/y+Zl6v3jchKm93CumnLyQtU4bqwO1akEvf8TCHLYCW\nf4JDPhFAewu8y0MlV1PoYEtLfGQec3Om7yLMX5AUy6svsTU2WIufVoz010ai0s30\nerPZTJF4WCbJ4az98uepb5VOHEO3CLIa9zda+bCuno4IHVUjSgpg9+qYuLgEnUw6\nYz2qHm39FHXa1NeJ8bAyQLXNVWqqNGwRteXzCqVu6egrlwCBga0enHOtlnIcaBhZ\njUr5XXWcyfd8Ldne\n=fnv1\n-----END PGP SIGNATURE-----", "payload": "tree cdf586caa69cbbdcb474a17ac37265205848e024\nparent e9e09083674a58d361cd805877be55b5856d2806\nauthor Ezra Shaw <ezrasure@outlook.com> 1673690417 +1300\ncommitter Ezra Shaw <ezrasure@outlook.com> 1673740133 +1300\n\nallow negative numeric literals in `concat!`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/41856b0a0f0a612c1e64088baed5389d82f93157", "html_url": "https://github.com/rust-lang/rust/commit/41856b0a0f0a612c1e64088baed5389d82f93157", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/41856b0a0f0a612c1e64088baed5389d82f93157/comments", "author": {"login": "Ezrashaw", "id": 38062690, "node_id": "MDQ6VXNlcjM4MDYyNjkw", "avatar_url": "https://avatars.githubusercontent.com/u/38062690?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Ezrashaw", "html_url": "https://github.com/Ezrashaw", "followers_url": "https://api.github.com/users/Ezrashaw/followers", "following_url": "https://api.github.com/users/Ezrashaw/following{/other_user}", "gists_url": "https://api.github.com/users/Ezrashaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/Ezrashaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Ezrashaw/subscriptions", "organizations_url": "https://api.github.com/users/Ezrashaw/orgs", "repos_url": "https://api.github.com/users/Ezrashaw/repos", "events_url": "https://api.github.com/users/Ezrashaw/events{/privacy}", "received_events_url": "https://api.github.com/users/Ezrashaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Ezrashaw", "id": 38062690, "node_id": "MDQ6VXNlcjM4MDYyNjkw", "avatar_url": "https://avatars.githubusercontent.com/u/38062690?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Ezrashaw", "html_url": "https://github.com/Ezrashaw", "followers_url": "https://api.github.com/users/Ezrashaw/followers", "following_url": "https://api.github.com/users/Ezrashaw/following{/other_user}", "gists_url": "https://api.github.com/users/Ezrashaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/Ezrashaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Ezrashaw/subscriptions", "organizations_url": "https://api.github.com/users/Ezrashaw/orgs", "repos_url": "https://api.github.com/users/Ezrashaw/repos", "events_url": "https://api.github.com/users/Ezrashaw/events{/privacy}", "received_events_url": "https://api.github.com/users/Ezrashaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e9e09083674a58d361cd805877be55b5856d2806", "url": "https://api.github.com/repos/rust-lang/rust/commits/e9e09083674a58d361cd805877be55b5856d2806", "html_url": "https://github.com/rust-lang/rust/commit/e9e09083674a58d361cd805877be55b5856d2806"}], "stats": {"total": 49, "additions": 45, "deletions": 4}, "files": [{"sha": "36682bbe0708f88babcb29aee81c064ce452f7c3", "filename": "compiler/rustc_builtin_macros/src/concat.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/41856b0a0f0a612c1e64088baed5389d82f93157/compiler%2Frustc_builtin_macros%2Fsrc%2Fconcat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/41856b0a0f0a612c1e64088baed5389d82f93157/compiler%2Frustc_builtin_macros%2Fsrc%2Fconcat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fconcat.rs?ref=41856b0a0f0a612c1e64088baed5389d82f93157", "patch": "@@ -42,6 +42,18 @@ pub fn expand_concat(\n                     has_errors = true;\n                 }\n             },\n+            // We also want to allow negative numeric literals.\n+            ast::ExprKind::Unary(ast::UnOp::Neg, ref expr) if let ast::ExprKind::Lit(token_lit) = expr.kind => {\n+                match ast::LitKind::from_token_lit(token_lit) {\n+                    Ok(ast::LitKind::Int(i, _)) => accumulator.push_str(&format!(\"-{i}\")),\n+                    Ok(ast::LitKind::Float(f, _)) => accumulator.push_str(&format!(\"-{f}\")),\n+                    Err(err) => {\n+                        report_lit_error(&cx.sess.parse_sess, err, token_lit, e.span);\n+                        has_errors = true;\n+                    }\n+                    _ => missing_literal.push(e.span),\n+                }\n+            }\n             ast::ExprKind::IncludedBytes(..) => {\n                 cx.span_err(e.span, \"cannot concatenate a byte string literal\")\n             }\n@@ -53,9 +65,10 @@ pub fn expand_concat(\n             }\n         }\n     }\n+\n     if !missing_literal.is_empty() {\n         let mut err = cx.struct_span_err(missing_literal, \"expected a literal\");\n-        err.note(\"only literals (like `\\\"foo\\\"`, `42` and `3.14`) can be passed to `concat!()`\");\n+        err.note(\"only literals (like `\\\"foo\\\"`, `-42` and `3.14`) can be passed to `concat!()`\");\n         err.emit();\n         return DummyResult::any(sp);\n     } else if has_errors {"}, {"sha": "d67f3c33d36e3cf1fe6a82ffb73c1906e01de192", "filename": "tests/ui/macros/bad-concat.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/41856b0a0f0a612c1e64088baed5389d82f93157/tests%2Fui%2Fmacros%2Fbad-concat.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/41856b0a0f0a612c1e64088baed5389d82f93157/tests%2Fui%2Fmacros%2Fbad-concat.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmacros%2Fbad-concat.stderr?ref=41856b0a0f0a612c1e64088baed5389d82f93157", "patch": "@@ -4,7 +4,7 @@ error: expected a literal\n LL |     let _ = concat!(x, y, z, \"bar\");\n    |                     ^  ^  ^\n    |\n-   = note: only literals (like `\"foo\"`, `42` and `3.14`) can be passed to `concat!()`\n+   = note: only literals (like `\"foo\"`, `-42` and `3.14`) can be passed to `concat!()`\n \n error: aborting due to previous error\n "}, {"sha": "d65d9354454c3e829e0813e99cfaf0ff188d42fe", "filename": "tests/ui/macros/concat.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/41856b0a0f0a612c1e64088baed5389d82f93157/tests%2Fui%2Fmacros%2Fconcat.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/41856b0a0f0a612c1e64088baed5389d82f93157/tests%2Fui%2Fmacros%2Fconcat.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmacros%2Fconcat.stderr?ref=41856b0a0f0a612c1e64088baed5389d82f93157", "patch": "@@ -16,15 +16,15 @@ error: expected a literal\n LL |     concat!(foo);\n    |             ^^^\n    |\n-   = note: only literals (like `\"foo\"`, `42` and `3.14`) can be passed to `concat!()`\n+   = note: only literals (like `\"foo\"`, `-42` and `3.14`) can be passed to `concat!()`\n \n error: expected a literal\n   --> $DIR/concat.rs:5:13\n    |\n LL |     concat!(foo());\n    |             ^^^^^\n    |\n-   = note: only literals (like `\"foo\"`, `42` and `3.14`) can be passed to `concat!()`\n+   = note: only literals (like `\"foo\"`, `-42` and `3.14`) can be passed to `concat!()`\n \n error: aborting due to 4 previous errors\n "}, {"sha": "7bbd3d68a900eb2ff4d0783a2aa647270b72c0ee", "filename": "tests/ui/macros/issue-106837.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/41856b0a0f0a612c1e64088baed5389d82f93157/tests%2Fui%2Fmacros%2Fissue-106837.rs", "raw_url": "https://github.com/rust-lang/rust/raw/41856b0a0f0a612c1e64088baed5389d82f93157/tests%2Fui%2Fmacros%2Fissue-106837.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmacros%2Fissue-106837.rs?ref=41856b0a0f0a612c1e64088baed5389d82f93157", "patch": "@@ -0,0 +1,10 @@\n+fn main() {\n+    concat!(-42);\n+    concat!(-3.14);\n+\n+    concat!(-\"hello\");\n+    //~^ ERROR expected a literal\n+\n+    concat!(--1);\n+    //~^ ERROR expected a literal\n+}"}, {"sha": "998d6c5eb6f2b2df9f2ba993a45161b6bda3c451", "filename": "tests/ui/macros/issue-106837.stderr", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/41856b0a0f0a612c1e64088baed5389d82f93157/tests%2Fui%2Fmacros%2Fissue-106837.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/41856b0a0f0a612c1e64088baed5389d82f93157/tests%2Fui%2Fmacros%2Fissue-106837.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmacros%2Fissue-106837.stderr?ref=41856b0a0f0a612c1e64088baed5389d82f93157", "patch": "@@ -0,0 +1,18 @@\n+error: expected a literal\n+  --> $DIR/issue-106837.rs:5:13\n+   |\n+LL |     concat!(-\"hello\");\n+   |             ^^^^^^^^\n+   |\n+   = note: only literals (like `\"foo\"`, `-42` and `3.14`) can be passed to `concat!()`\n+\n+error: expected a literal\n+  --> $DIR/issue-106837.rs:8:13\n+   |\n+LL |     concat!(--1);\n+   |             ^^^\n+   |\n+   = note: only literals (like `\"foo\"`, `-42` and `3.14`) can be passed to `concat!()`\n+\n+error: aborting due to 2 previous errors\n+"}]}