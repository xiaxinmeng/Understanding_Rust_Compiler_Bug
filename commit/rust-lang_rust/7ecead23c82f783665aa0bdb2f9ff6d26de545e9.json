{"sha": "7ecead23c82f783665aa0bdb2f9ff6d26de545e9", "node_id": "C_kwDOAAsO6NoAKDdlY2VhZDIzYzgyZjc4MzY2NWFhMGJkYjJmOWZmNmQyNmRlNTQ1ZTk", "commit": {"author": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-07-18T10:49:14Z"}, "committer": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-08-30T11:52:42Z"}, "message": "fix: sort and deduplicate auto traits in trait object types", "tree": {"sha": "c2a375ab10a54ce54dcd0483520fbd2ac822e1f3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c2a375ab10a54ce54dcd0483520fbd2ac822e1f3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7ecead23c82f783665aa0bdb2f9ff6d26de545e9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEkSbsQIURluxz4rzf4laYqTBYYXEFAmMN+goACgkQ4laYqTBY\nYXFIrxAAqqcJqCWuI+0/XYWoOHz6PNF+JLomngpRs7vDIP7UrEE0PjGmkU9tPr26\n6jJ2fEkqpMb4axolggk54vCRUFHpu0j+mq7+FGjw025Of8T4KpduIzVE4Jvi11t+\nbThmll5ZvEfCMN5q+TMrS6nSPb+i526clQAOHsb+cjFN4EaQo6Xj3rTE4/djKXHW\nxNkJe2vos+y8y9BZINU6qIfg6X0imkc3nC+UBkV4UKzLPQW1UKn5GWAJG34GWswE\nzvq+PMVM8hH9iThXUxFyIn2u7yjykl5mCzFY751d2LSYJ+7ZGf7MNUuvE7bqZPvG\nVAz/dgt2rUOy0vzdgktJgHEENOilbzU8J2S1BWHmQzs+9AiT8YKK+3HCeflj1Zuh\nGirqR9Mhui8bcN8llWjExtz6J+i9vLFfAj7c87ZWCg4beg0uzlN4dvOYkdlnNit8\nRxSTR9c+ckwKDmGHYSYNLOF7ah+zeEph9vUSuPdhOWDMM27s5/ns1WuMr7KH/S3a\nYcxnaDxsjL0eTvbNFizeX/v5L1+dzM6c/CdvSOXWeprPx4rtwM3yhykR08NNqL8v\nwP2lfQcGiGpgNjNp0q07bp0aO6vL35hVuhs4oiE0YX5UN+9onT9FvarOP/dJrJbS\nNeO8XS2OlVHxvOpQYxrzKTTGy0G99rYVhkW8UroVzyfAH9nAb10=\n=kvQA\n-----END PGP SIGNATURE-----", "payload": "tree c2a375ab10a54ce54dcd0483520fbd2ac822e1f3\nparent 5543dd88c98eca686d63fc032ae927a0565565b8\nauthor Ryo Yoshida <low.ryoshida@gmail.com> 1658141354 +0900\ncommitter Ryo Yoshida <low.ryoshida@gmail.com> 1661860362 +0900\n\nfix: sort and deduplicate auto traits in trait object types\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7ecead23c82f783665aa0bdb2f9ff6d26de545e9", "html_url": "https://github.com/rust-lang/rust/commit/7ecead23c82f783665aa0bdb2f9ff6d26de545e9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7ecead23c82f783665aa0bdb2f9ff6d26de545e9/comments", "author": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5543dd88c98eca686d63fc032ae927a0565565b8", "url": "https://api.github.com/repos/rust-lang/rust/commits/5543dd88c98eca686d63fc032ae927a0565565b8", "html_url": "https://github.com/rust-lang/rust/commit/5543dd88c98eca686d63fc032ae927a0565565b8"}], "stats": {"total": 141, "additions": 132, "deletions": 9}, "files": [{"sha": "64a07070f02adf032d3a1750b46cb250e09320d3", "filename": "crates/hir-ty/src/lower.rs", "status": "modified", "additions": 39, "deletions": 8, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/7ecead23c82f783665aa0bdb2f9ff6d26de545e9/crates%2Fhir-ty%2Fsrc%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ecead23c82f783665aa0bdb2f9ff6d26de545e9/crates%2Fhir-ty%2Fsrc%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Flower.rs?ref=7ecead23c82f783665aa0bdb2f9ff6d26de545e9", "patch": "@@ -1,8 +1,8 @@\n //! Methods for lowering the HIR to types. There are two main cases here:\n //!\n //!  - Lowering a type reference like `&usize` or `Option<foo::bar::Baz>` to a\n-//!    type: The entry point for this is `Ty::from_hir`.\n-//!  - Building the type for an item: This happens through the `type_for_def` query.\n+//!    type: The entry point for this is `TyLoweringContext::lower_ty`.\n+//!  - Building the type for an item: This happens through the `ty` query.\n //!\n //! This usually involves resolving names, collecting generic arguments etc.\n use std::{\n@@ -47,7 +47,7 @@ use crate::{\n     consteval::{intern_const_scalar, path_to_const, unknown_const, unknown_const_as_generic},\n     db::HirDatabase,\n     make_binders,\n-    mapping::ToChalk,\n+    mapping::{from_chalk_trait_id, ToChalk},\n     static_lifetime, to_assoc_type_id, to_chalk_trait_id, to_placeholder_idx,\n     utils::Generics,\n     utils::{all_super_trait_refs, associated_type_by_name_including_super_traits, generics},\n@@ -969,13 +969,44 @@ impl<'a> TyLoweringContext<'a> {\n     fn lower_dyn_trait(&self, bounds: &[Interned<TypeBound>]) -> Ty {\n         let self_ty = TyKind::BoundVar(BoundVar::new(DebruijnIndex::INNERMOST, 0)).intern(Interner);\n         let bounds = self.with_shifted_in(DebruijnIndex::ONE, |ctx| {\n-            QuantifiedWhereClauses::from_iter(\n+            let bounds =\n+                bounds.iter().flat_map(|b| ctx.lower_type_bound(b, self_ty.clone(), false));\n+\n+            let mut auto_traits = SmallVec::<[_; 8]>::new();\n+            let mut regular_traits = SmallVec::<[_; 2]>::new();\n+            let mut other_bounds = SmallVec::<[_; 8]>::new();\n+            for bound in bounds {\n+                if let Some(id) = bound.trait_id() {\n+                    if ctx.db.trait_data(from_chalk_trait_id(id)).is_auto {\n+                        auto_traits.push(bound);\n+                    } else {\n+                        regular_traits.push(bound);\n+                    }\n+                } else {\n+                    other_bounds.push(bound);\n+                }\n+            }\n+\n+            if regular_traits.len() > 1 {\n+                return None;\n+            }\n+\n+            auto_traits.sort_unstable_by_key(|b| b.trait_id().unwrap());\n+            auto_traits.dedup();\n+\n+            Some(QuantifiedWhereClauses::from_iter(\n                 Interner,\n-                bounds.iter().flat_map(|b| ctx.lower_type_bound(b, self_ty.clone(), false)),\n-            )\n+                regular_traits.into_iter().chain(other_bounds).chain(auto_traits),\n+            ))\n         });\n-        let bounds = crate::make_single_type_binders(bounds);\n-        TyKind::Dyn(DynTy { bounds, lifetime: static_lifetime() }).intern(Interner)\n+\n+        if let Some(bounds) = bounds {\n+            let bounds = crate::make_single_type_binders(bounds);\n+            TyKind::Dyn(DynTy { bounds, lifetime: static_lifetime() }).intern(Interner)\n+        } else {\n+            // FIXME: report error (additional non-auto traits)\n+            TyKind::Error.intern(Interner)\n+        }\n     }\n \n     fn lower_impl_trait("}, {"sha": "e67c27aa2db97fb4cff6fd19475fa448aa422cc9", "filename": "crates/hir-ty/src/tests/traits.rs", "status": "modified", "additions": 92, "deletions": 0, "changes": 92, "blob_url": "https://github.com/rust-lang/rust/blob/7ecead23c82f783665aa0bdb2f9ff6d26de545e9/crates%2Fhir-ty%2Fsrc%2Ftests%2Ftraits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ecead23c82f783665aa0bdb2f9ff6d26de545e9/crates%2Fhir-ty%2Fsrc%2Ftests%2Ftraits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Ftests%2Ftraits.rs?ref=7ecead23c82f783665aa0bdb2f9ff6d26de545e9", "patch": "@@ -3833,3 +3833,95 @@ fn test() {\n \"#,\n     )\n }\n+\n+#[test]\n+fn dyn_multiple_auto_traits_in_different_order() {\n+    check_no_mismatches(\n+        r#\"\n+auto trait Send {}\n+auto trait Sync {}\n+\n+fn f(t: &(dyn Sync + Send)) {}\n+fn g(t: &(dyn Send + Sync)) {\n+    f(t);\n+}\n+        \"#,\n+    );\n+\n+    check_no_mismatches(\n+        r#\"\n+auto trait Send {}\n+auto trait Sync {}\n+trait T {}\n+\n+fn f(t: &(dyn T + Send + Sync)) {}\n+fn g(t: &(dyn Sync + T + Send)) {\n+    f(t);\n+}\n+        \"#,\n+    );\n+\n+    check_infer_with_mismatches(\n+        r#\"\n+auto trait Send {}\n+auto trait Sync {}\n+trait T1 {}\n+trait T2 {}\n+\n+fn f(t: &(dyn T1 + T2 + Send + Sync)) {}\n+fn g(t: &(dyn Sync + T2 + T1 + Send)) {\n+    f(t);\n+}\n+        \"#,\n+        expect![[r#\"\n+            68..69 't': &{unknown}\n+            101..103 '{}': ()\n+            109..110 't': &{unknown}\n+            142..155 '{     f(t); }': ()\n+            148..149 'f': fn f(&{unknown})\n+            148..152 'f(t)': ()\n+            150..151 't': &{unknown}\n+        \"#]],\n+    );\n+\n+    check_no_mismatches(\n+        r#\"\n+auto trait Send {}\n+auto trait Sync {}\n+trait T {\n+    type Proj: Send + Sync;\n+}\n+\n+fn f(t: &(dyn T<Proj = ()>  + Send + Sync)) {}\n+fn g(t: &(dyn Sync + T<Proj = ()> + Send)) {\n+    f(t);\n+}\n+        \"#,\n+    );\n+}\n+\n+#[test]\n+fn dyn_duplicate_auto_trait() {\n+    check_no_mismatches(\n+        r#\"\n+auto trait Send {}\n+\n+fn f(t: &(dyn Send + Send)) {}\n+fn g(t: &(dyn Send)) {\n+    f(t);\n+}\n+        \"#,\n+    );\n+\n+    check_no_mismatches(\n+        r#\"\n+auto trait Send {}\n+trait T {}\n+\n+fn f(t: &(dyn T + Send + Send)) {}\n+fn g(t: &(dyn T + Send)) {\n+    f(t);\n+}\n+        \"#,\n+    );\n+}"}, {"sha": "e9034daefa8d46c1dea2afce1e07683f52f82f66", "filename": "crates/ide/src/inlay_hints.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7ecead23c82f783665aa0bdb2f9ff6d26de545e9/crates%2Fide%2Fsrc%2Finlay_hints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ecead23c82f783665aa0bdb2f9ff6d26de545e9/crates%2Fide%2Fsrc%2Finlay_hints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Finlay_hints.rs?ref=7ecead23c82f783665aa0bdb2f9ff6d26de545e9", "patch": "@@ -1910,7 +1910,7 @@ impl<T> Vec<T> {\n pub struct Box<T> {}\n \n trait Display {}\n-trait Sync {}\n+auto trait Sync {}\n \n fn main() {\n     // The block expression wrapping disables the constructor hint hiding logic"}]}