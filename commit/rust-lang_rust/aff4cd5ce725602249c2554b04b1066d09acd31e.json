{"sha": "aff4cd5ce725602249c2554b04b1066d09acd31e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFmZjRjZDVjZTcyNTYwMjI0OWMyNTU0YjA0YjEwNjZkMDlhY2QzMWU=", "commit": {"author": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-06-13T17:49:37Z"}, "committer": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-08-31T05:24:18Z"}, "message": "Report Layout of enum variants\n\nFollowup of #83501, Fixes #86253.", "tree": {"sha": "f8915f7a08176769ce67ad2f1f53ab2ffba79114", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f8915f7a08176769ce67ad2f1f53ab2ffba79114"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aff4cd5ce725602249c2554b04b1066d09acd31e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEQ7Fl7qPq2YcWF1dqAn35M4hird0FAmEtvQIACgkQAn35M4hi\nrd1t8hAAkTqxHBFKO4Ciau03ES5jme4khaPlTWbgJQgKJbZATRPHkCNZczZGISFW\no/PSN90JA8G1WhQskJwiorXUTRzzM4IfbeIcHhDdqsF200zGeXowCA47+vxSkEGu\n/YQlgeQPhj/h9bPziwL7HNeKyeWQsPzH4ACrRJBjCqpxvGnHEvAhsSG+HZIOO57v\no4OnzR/TI8LYq4+1HGVYhU1vAVD6H5CfkHSfQHCD/yr+o/IbavrNHflB8Wu68N1p\neAoSc7WoolaJF9BhsjT9g0NZRFWSU+STEYjsAgCht/KkZMP4YF7OBYi9uWKzjiSD\n2KtpucBSYpN1R2E860ekvnxiby9wLJ1qPfq80oxKteEFJi2qcDTqf9o/4fkXyUFm\nTpybCoHROvAvDotQdN52brck4U5xUFVh7qs2uroIdY07MLm4PpVWHU/xrU29H1SO\nxGz0BqEdPRAZHWYwXDzWsxfdBS5us7YP859BFNCzHB9zCIJHsGDldkoTgIetM+St\nXbNaptseszLAfeZmdjM8TzpseMfx+Cp+sIVAhXHufrZBAy5zWND2xeXH1IdEWfta\nc0OR+e3DMHxVqYcJZjbGODDBoMHQWH5VcmUhYrlrZHdmpXMQNBXclIOmEuVez+F/\nAAlPBmE48qK+ZKbVxYRKNgrNvymeOrd/aTTstlEs7xSQdlvLtqk=\n=734D\n-----END PGP SIGNATURE-----", "payload": "tree f8915f7a08176769ce67ad2f1f53ab2ffba79114\nparent ac50a53359328a5d7f2f558833e63d59d372e4f7\nauthor Deadbeef <ent3rm4n@gmail.com> 1623606577 +0800\ncommitter Deadbeef <ent3rm4n@gmail.com> 1630387458 +0000\n\nReport Layout of enum variants\n\nFollowup of #83501, Fixes #86253.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aff4cd5ce725602249c2554b04b1066d09acd31e", "html_url": "https://github.com/rust-lang/rust/commit/aff4cd5ce725602249c2554b04b1066d09acd31e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aff4cd5ce725602249c2554b04b1066d09acd31e/comments", "author": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ac50a53359328a5d7f2f558833e63d59d372e4f7", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac50a53359328a5d7f2f558833e63d59d372e4f7", "html_url": "https://github.com/rust-lang/rust/commit/ac50a53359328a5d7f2f558833e63d59d372e4f7"}], "stats": {"total": 42, "additions": 41, "deletions": 1}, "files": [{"sha": "f362a288bcbf98a6920b8f7781bb42661a6de4a1", "filename": "src/librustdoc/html/render/print_item.rs", "status": "modified", "additions": 35, "deletions": 1, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/aff4cd5ce725602249c2554b04b1066d09acd31e/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aff4cd5ce725602249c2554b04b1066d09acd31e/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs?ref=aff4cd5ce725602249c2554b04b1066d09acd31e", "patch": "@@ -7,11 +7,13 @@ use rustc_data_structures::fx::FxHashMap;\n use rustc_hir as hir;\n use rustc_hir::def::CtorKind;\n use rustc_hir::def_id::DefId;\n+use rustc_middle::bug;\n use rustc_middle::middle::stability;\n use rustc_middle::ty::layout::LayoutError;\n-use rustc_middle::ty::TyCtxt;\n+use rustc_middle::ty::{Adt, TyCtxt};\n use rustc_span::hygiene::MacroKind;\n use rustc_span::symbol::{kw, sym, Symbol};\n+use rustc_target::abi::Variants;\n \n use super::{\n     collect_paths_for_type, document, ensure_trailing_slash, item_ty_to_strs, notable_traits_decl,\n@@ -1636,6 +1638,38 @@ fn document_type_layout(w: &mut Buffer, cx: &Context<'_>, ty_def_id: DefId) {\n                     pl = if bytes == 1 { \"\" } else { \"s\" },\n                 );\n             }\n+            if let Variants::Multiple { variants, .. } = &ty_layout.layout.variants {\n+                if !variants.is_empty() {\n+                    w.write_str(\n+                        \"<p>\\\n+                            <strong>Size for each variant:</strong>\\\n+                            <ul>\",\n+                    );\n+\n+                    let adt = if let Adt(adt, _) = ty_layout.ty.kind() {\n+                        adt\n+                    } else {\n+                        bug!(\"not an adt\")\n+                    };\n+\n+                    for (index, layout) in variants.iter_enumerated() {\n+                        let ident = adt.variants[index].ident;\n+                        if layout.abi.is_unsized() {\n+                            writeln!(w, \"<li><code>{name}</code> (unsized)</li>\", name = ident);\n+                        } else {\n+                            let bytes = layout.size.bytes();\n+                            writeln!(\n+                                w,\n+                                \"<li><code>{name}</code>: {size} byte{pl}</li>\",\n+                                name = ident,\n+                                size = bytes,\n+                                pl = if bytes == 1 { \"\" } else { \"s\" },\n+                            );\n+                        }\n+                    }\n+                    w.write_str(\"</ul></p>\");\n+                }\n+            }\n         }\n         // This kind of layout error can occur with valid code, e.g. if you try to\n         // get the layout of a generic type such as `Vec<T>`."}, {"sha": "f398dd776d9c6a6f84ba70ec55e11990c0c67224", "filename": "src/test/rustdoc/type-layout.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/aff4cd5ce725602249c2554b04b1066d09acd31e/src%2Ftest%2Frustdoc%2Ftype-layout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aff4cd5ce725602249c2554b04b1066d09acd31e/src%2Ftest%2Frustdoc%2Ftype-layout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Ftype-layout.rs?ref=aff4cd5ce725602249c2554b04b1066d09acd31e", "patch": "@@ -52,3 +52,9 @@ pub struct Unsized([u8]);\n \n // @!has type_layout/trait.MyTrait.html 'Size: '\n pub trait MyTrait {}\n+\n+// @has type_layout/enum.Variants.html '1 byte'\n+pub enum Variants {\n+    A,\n+    B(u8),\n+}"}]}