{"sha": "c42c77bc7b64cf9015c5b8e7f11f192e499509b3", "node_id": "C_kwDOAAsO6NoAKGM0MmM3N2JjN2I2NGNmOTAxNWM1YjhlN2YxMWYxOTJlNDk5NTA5YjM", "commit": {"author": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2022-06-10T18:44:53Z"}, "committer": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2022-07-29T22:59:26Z"}, "message": "Update to still be correct without drop tracking", "tree": {"sha": "6a02f53df3acb322bf8e56692e0bfb04b44c63be", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6a02f53df3acb322bf8e56692e0bfb04b44c63be"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c42c77bc7b64cf9015c5b8e7f11f192e499509b3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c42c77bc7b64cf9015c5b8e7f11f192e499509b3", "html_url": "https://github.com/rust-lang/rust/commit/c42c77bc7b64cf9015c5b8e7f11f192e499509b3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c42c77bc7b64cf9015c5b8e7f11f192e499509b3/comments", "author": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "89d35060b900f0aa441ca16b1bde2cdebcb46263", "url": "https://api.github.com/repos/rust-lang/rust/commits/89d35060b900f0aa441ca16b1bde2cdebcb46263", "html_url": "https://github.com/rust-lang/rust/commit/89d35060b900f0aa441ca16b1bde2cdebcb46263"}], "stats": {"total": 47, "additions": 38, "deletions": 9}, "files": [{"sha": "bfe0200101c93f7609ea79688db96078da652767", "filename": "compiler/rustc_typeck/src/check/generator_interior.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c42c77bc7b64cf9015c5b8e7f11f192e499509b3/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c42c77bc7b64cf9015c5b8e7f11f192e499509b3/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior.rs?ref=c42c77bc7b64cf9015c5b8e7f11f192e499509b3", "patch": "@@ -457,7 +457,7 @@ impl<'a, 'tcx> Visitor<'tcx> for InteriorVisitor<'a, 'tcx> {\n }\n \n #[derive(Default)]\n-pub struct SuspendCheckData<'a, 'tcx> {\n+struct SuspendCheckData<'a, 'tcx> {\n     expr: Option<&'tcx Expr<'tcx>>,\n     source_span: Span,\n     yield_span: Span,\n@@ -472,7 +472,7 @@ pub struct SuspendCheckData<'a, 'tcx> {\n //\n // Note that this technique was chosen over things like a `Suspend` marker trait\n // as it is simpler and has precedent in the compiler\n-pub fn check_must_not_suspend_ty<'tcx>(\n+fn check_must_not_suspend_ty<'tcx>(\n     fcx: &FnCtxt<'_, 'tcx>,\n     ty: Ty<'tcx>,\n     hir_id: HirId,\n@@ -582,7 +582,9 @@ pub fn check_must_not_suspend_ty<'tcx>(\n                 },\n             )\n         }\n-        ty::Ref(_region, ty, _mutability) => {\n+        // If drop tracking is enabled, we want to look through references, since the referrent\n+        // may not be considered live across the await point.\n+        ty::Ref(_region, ty, _mutability) if fcx.sess().opts.debugging_opts.drop_tracking => {\n             let descr_pre = &format!(\"{}reference{} to \", data.descr_pre, plural_suffix);\n             check_must_not_suspend_ty(fcx, ty, hir_id, SuspendCheckData { descr_pre, ..data })\n         }"}, {"sha": "33c7ff2cb3375340604eae4bccc158299a58ab20", "filename": "src/test/ui/lint/must_not_suspend/ref-drop-tracking.stderr", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/c42c77bc7b64cf9015c5b8e7f11f192e499509b3/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref-drop-tracking.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c42c77bc7b64cf9015c5b8e7f11f192e499509b3/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref-drop-tracking.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref-drop-tracking.stderr?ref=c42c77bc7b64cf9015c5b8e7f11f192e499509b3", "patch": "@@ -0,0 +1,27 @@\n+error: reference to `Umm` held across a suspend point, but should not be\n+  --> $DIR/ref-drop-tracking.rs:19:13\n+   |\n+LL |         let guard = &mut self.u;\n+   |             ^^^^^\n+LL | \n+LL |         other().await;\n+   |                ------ the value is held across this suspend point\n+   |\n+note: the lint level is defined here\n+  --> $DIR/ref-drop-tracking.rs:4:9\n+   |\n+LL | #![deny(must_not_suspend)]\n+   |         ^^^^^^^^^^^^^^^^\n+note: You gotta use Umm's, ya know?\n+  --> $DIR/ref-drop-tracking.rs:19:13\n+   |\n+LL |         let guard = &mut self.u;\n+   |             ^^^^^\n+help: consider using a block (`{ ... }`) to shrink the value's scope, ending before the suspend point\n+  --> $DIR/ref-drop-tracking.rs:19:13\n+   |\n+LL |         let guard = &mut self.u;\n+   |             ^^^^^\n+\n+error: aborting due to previous error\n+"}, {"sha": "5f000014c7dba2565c8c11b9b6a16f4f3da4e18a", "filename": "src/test/ui/lint/must_not_suspend/ref.stderr", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/c42c77bc7b64cf9015c5b8e7f11f192e499509b3/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c42c77bc7b64cf9015c5b8e7f11f192e499509b3/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref.stderr?ref=c42c77bc7b64cf9015c5b8e7f11f192e499509b3", "patch": "@@ -1,5 +1,5 @@\n-error: reference to `Umm` held across a suspend point, but should not be\n-  --> $DIR/ref.rs:18:13\n+error: `Umm` held across a suspend point, but should not be\n+  --> $DIR/ref.rs:18:26\n    |\n LL |         let guard = &mut self.u;\n    |                          ^^^^^^\n@@ -13,15 +13,15 @@ note: the lint level is defined here\n LL | #![deny(must_not_suspend)]\n    |         ^^^^^^^^^^^^^^^^\n note: You gotta use Umm's, ya know?\n-  --> $DIR/ref.rs:18:13\n+  --> $DIR/ref.rs:18:26\n    |\n LL |         let guard = &mut self.u;\n-   |             ^^^^^\n+   |                          ^^^^^^\n help: consider using a block (`{ ... }`) to shrink the value's scope, ending before the suspend point\n-  --> $DIR/ref.rs:18:13\n+  --> $DIR/ref.rs:18:26\n    |\n LL |         let guard = &mut self.u;\n-   |             ^^^^^\n+   |                          ^^^^^^\n \n error: aborting due to previous error\n "}]}