{"sha": "508b328c398b84126011f6fe74d018fe855bc242", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUwOGIzMjhjMzk4Yjg0MTI2MDExZjZmZTc0ZDAxOGZlODU1YmMyNDI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-08-07T12:44:09Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-08-07T12:44:09Z"}, "message": "Auto merge of #87810 - devnexen:haiku_os_simpl, r=Mark-Simulacrum\n\ncurrent_exe haiku code path simplification all of these part of libc", "tree": {"sha": "6b1c1e475fbbda9e5bdf59d2de3339fb36b12caf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6b1c1e475fbbda9e5bdf59d2de3339fb36b12caf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/508b328c398b84126011f6fe74d018fe855bc242", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/508b328c398b84126011f6fe74d018fe855bc242", "html_url": "https://github.com/rust-lang/rust/commit/508b328c398b84126011f6fe74d018fe855bc242", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/508b328c398b84126011f6fe74d018fe855bc242/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6b20506d17f4e5e5bf5bcad7e94add4d754b0ae3", "url": "https://api.github.com/repos/rust-lang/rust/commits/6b20506d17f4e5e5bf5bcad7e94add4d754b0ae3", "html_url": "https://github.com/rust-lang/rust/commit/6b20506d17f4e5e5bf5bcad7e94add4d754b0ae3"}, {"sha": "5501eba6452d5877b3c45aabadb105d3daa71b4b", "url": "https://api.github.com/repos/rust-lang/rust/commits/5501eba6452d5877b3c45aabadb105d3daa71b4b", "html_url": "https://github.com/rust-lang/rust/commit/5501eba6452d5877b3c45aabadb105d3daa71b4b"}], "stats": {"total": 41, "additions": 8, "deletions": 33}, "files": [{"sha": "bbfe846e31556d732a9ad70ee33800b894d11e2d", "filename": "library/std/src/sys/unix/os.rs", "status": "modified", "additions": 8, "deletions": 33, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/508b328c398b84126011f6fe74d018fe855bc242/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fos.rs", "raw_url": "https://github.com/rust-lang/rust/raw/508b328c398b84126011f6fe74d018fe855bc242/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fos.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fos.rs?ref=508b328c398b84126011f6fe74d018fe855bc242", "patch": "@@ -388,46 +388,21 @@ pub fn current_exe() -> io::Result<PathBuf> {\n \n #[cfg(target_os = \"haiku\")]\n pub fn current_exe() -> io::Result<PathBuf> {\n-    // Use Haiku's image info functions\n-    #[repr(C)]\n-    struct image_info {\n-        id: i32,\n-        type_: i32,\n-        sequence: i32,\n-        init_order: i32,\n-        init_routine: *mut libc::c_void, // function pointer\n-        term_routine: *mut libc::c_void, // function pointer\n-        device: libc::dev_t,\n-        node: libc::ino_t,\n-        name: [libc::c_char; 1024], // MAXPATHLEN\n-        text: *mut libc::c_void,\n-        data: *mut libc::c_void,\n-        text_size: i32,\n-        data_size: i32,\n-        api_version: i32,\n-        abi: i32,\n-    }\n-\n     unsafe {\n-        extern \"C\" {\n-            fn _get_next_image_info(\n-                team_id: i32,\n-                cookie: *mut i32,\n-                info: *mut image_info,\n-                size: i32,\n-            ) -> i32;\n-        }\n-\n-        let mut info: image_info = mem::zeroed();\n+        let mut info: mem::MaybeUninit<libc::image_info> = mem::MaybeUninit::uninit();\n         let mut cookie: i32 = 0;\n         // the executable can be found at team id 0\n-        let result =\n-            _get_next_image_info(0, &mut cookie, &mut info, mem::size_of::<image_info>() as i32);\n+        let result = libc::_get_next_image_info(\n+            0,\n+            &mut cookie,\n+            info.as_mut_ptr(),\n+            mem::size_of::<libc::image_info>(),\n+        );\n         if result != 0 {\n             use crate::io::ErrorKind;\n             Err(io::Error::new_const(ErrorKind::Uncategorized, &\"Error getting executable path\"))\n         } else {\n-            let name = CStr::from_ptr(info.name.as_ptr()).to_bytes();\n+            let name = CStr::from_ptr((*info.as_ptr()).name.as_ptr()).to_bytes();\n             Ok(PathBuf::from(OsStr::from_bytes(name)))\n         }\n     }"}]}