{"sha": "fd09fad064504e18cd7fd15ccd7c957787482b81", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZkMDlmYWQwNjQ1MDRlMThjZDdmZDE1Y2NkN2M5NTc3ODc0ODJiODE=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-12-02T03:09:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-12-02T03:09:00Z"}, "message": "Rollup merge of #66789 - eddyb:mir-source-scope-local-data, r=oli-obk\n\nrustc: move mir::SourceScopeLocalData to a field of SourceScopeData.\n\nBy having one `ClearCrossCrate<SourceScopeLocalData>` for each scope, as opposed to a single `ClearCrossCrate` for all the `SourceScopeLocalData`s, we can represent the fact that some scopes have `SourceScopeLocalData` associated with them, and some don't.\n\nThis is useful when doing MIR inlining across crates, because the `ClearCrossCrate` will be `Clear` for the cross-crate MIR scopes and `Set` for the local ones.\n\nAlso see https://github.com/rust-lang/rust/pull/66203#issuecomment-555589574 for some context around this approach.\n\nFixes #51314.", "tree": {"sha": "8c4114ca2afdc2149bffbdb2b8e4c7474afbfa38", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8c4114ca2afdc2149bffbdb2b8e4c7474afbfa38"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fd09fad064504e18cd7fd15ccd7c957787482b81", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJd5IBMCRBK7hj4Ov3rIwAAdHIIAJ78PZRHfJZbA48Ai0KweL71\ngNI+BYn9GUFzfvPboI3YobI33lBz+F9YHt9aOeHWPl65SO/6Nv1tuPAsQDOuvjHE\nPBrCg75MvVajFqAHU9hgUKDnl6K9BXKZqYE52t2jkCx3YZBZjsnIHsYd3dN/aHRH\nbv6k07YL2qn132P41CT2XgQ/aSp7af9itoJ6E2HRRkZIm1YmC02uL3DgBr3ye9kk\nJ1ZMrgc9WMMorneCcux28A7dqNdgoYlk3Vv9ojkXA1BPBSH4DsKjMZvxsdjsW1Qh\nZxMn1m39h/Adx2BMYnAi+Ct6uUf84rfswRmwiJrkRW2OqsB5egIA+3IhVN6uJ9o=\n=gsmv\n-----END PGP SIGNATURE-----\n", "payload": "tree 8c4114ca2afdc2149bffbdb2b8e4c7474afbfa38\nparent a279ebbc9199d81d1c4ffc87c41c9544ea905115\nparent a9976d89ed721184a95a24f109a65916f2905793\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1575256140 +0100\ncommitter GitHub <noreply@github.com> 1575256140 +0100\n\nRollup merge of #66789 - eddyb:mir-source-scope-local-data, r=oli-obk\n\nrustc: move mir::SourceScopeLocalData to a field of SourceScopeData.\n\nBy having one `ClearCrossCrate<SourceScopeLocalData>` for each scope, as opposed to a single `ClearCrossCrate` for all the `SourceScopeLocalData`s, we can represent the fact that some scopes have `SourceScopeLocalData` associated with them, and some don't.\n\nThis is useful when doing MIR inlining across crates, because the `ClearCrossCrate` will be `Clear` for the cross-crate MIR scopes and `Set` for the local ones.\n\nAlso see https://github.com/rust-lang/rust/pull/66203#issuecomment-555589574 for some context around this approach.\n\nFixes #51314.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fd09fad064504e18cd7fd15ccd7c957787482b81", "html_url": "https://github.com/rust-lang/rust/commit/fd09fad064504e18cd7fd15ccd7c957787482b81", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fd09fad064504e18cd7fd15ccd7c957787482b81/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a279ebbc9199d81d1c4ffc87c41c9544ea905115", "url": "https://api.github.com/repos/rust-lang/rust/commits/a279ebbc9199d81d1c4ffc87c41c9544ea905115", "html_url": "https://github.com/rust-lang/rust/commit/a279ebbc9199d81d1c4ffc87c41c9544ea905115"}, {"sha": "a9976d89ed721184a95a24f109a65916f2905793", "url": "https://api.github.com/repos/rust-lang/rust/commits/a9976d89ed721184a95a24f109a65916f2905793", "html_url": "https://github.com/rust-lang/rust/commit/a9976d89ed721184a95a24f109a65916f2905793"}], "stats": {"total": 231, "additions": 102, "deletions": 129}, "files": [{"sha": "da0cadd5cf2420326aeafcab49f461ad633ab46d", "filename": "src/librustc/mir/mod.rs", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fmod.rs?ref=fd09fad064504e18cd7fd15ccd7c957787482b81", "patch": "@@ -104,10 +104,6 @@ pub struct Body<'tcx> {\n     /// and used for debuginfo. Indexed by a `SourceScope`.\n     pub source_scopes: IndexVec<SourceScope, SourceScopeData>,\n \n-    /// Crate-local information for each source scope, that can't (and\n-    /// needn't) be tracked across crates.\n-    pub source_scope_local_data: ClearCrossCrate<IndexVec<SourceScope, SourceScopeLocalData>>,\n-\n     /// The yield type of the function, if it is a generator.\n     pub yield_ty: Option<Ty<'tcx>>,\n \n@@ -167,7 +163,6 @@ impl<'tcx> Body<'tcx> {\n     pub fn new(\n         basic_blocks: IndexVec<BasicBlock, BasicBlockData<'tcx>>,\n         source_scopes: IndexVec<SourceScope, SourceScopeData>,\n-        source_scope_local_data: ClearCrossCrate<IndexVec<SourceScope, SourceScopeLocalData>>,\n         local_decls: LocalDecls<'tcx>,\n         user_type_annotations: CanonicalUserTypeAnnotations<'tcx>,\n         arg_count: usize,\n@@ -188,7 +183,6 @@ impl<'tcx> Body<'tcx> {\n             phase: MirPhase::Build,\n             basic_blocks,\n             source_scopes,\n-            source_scope_local_data,\n             yield_ty: None,\n             generator_drop: None,\n             generator_layout: None,\n@@ -435,6 +429,13 @@ pub enum ClearCrossCrate<T> {\n }\n \n impl<T> ClearCrossCrate<T> {\n+    pub fn as_ref(&'a self) -> ClearCrossCrate<&'a T> {\n+        match self {\n+            ClearCrossCrate::Clear => ClearCrossCrate::Clear,\n+            ClearCrossCrate::Set(v) => ClearCrossCrate::Set(v),\n+        }\n+    }\n+\n     pub fn assert_crate_local(self) -> T {\n         match self {\n             ClearCrossCrate::Clear => bug!(\"unwrapping cross-crate data\"),\n@@ -2027,6 +2028,10 @@ rustc_index::newtype_index! {\n pub struct SourceScopeData {\n     pub span: Span,\n     pub parent_scope: Option<SourceScope>,\n+\n+    /// Crate-local information for this source scope, that can't (and\n+    /// needn't) be tracked across crates.\n+    pub local_data: ClearCrossCrate<SourceScopeLocalData>,\n }\n \n #[derive(Clone, Debug, RustcEncodable, RustcDecodable, HashStable)]"}, {"sha": "145593f1c4d4adc839b6cb96aac54b6420a25e57", "filename": "src/librustc/mir/visit.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc%2Fmir%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc%2Fmir%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fvisit.rs?ref=fd09fad064504e18cd7fd15ccd7c957787482b81", "patch": "@@ -317,6 +317,7 @@ macro_rules! make_mir_visitor {\n                 let SourceScopeData {\n                     span,\n                     parent_scope,\n+                    local_data: _,\n                 } = scope_data;\n \n                 self.visit_span(span);"}, {"sha": "3a783f674e9ae6c75f758e87f6c86422a47388a0", "filename": "src/librustc_mir/borrow_check/mod.rs", "status": "modified", "additions": 34, "deletions": 33, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs?ref=fd09fad064504e18cd7fd15ccd7c957787482b81", "patch": "@@ -300,11 +300,10 @@ fn do_mir_borrowck<'a, 'tcx>(\n         let mut initial_diag =\n             mbcx.report_conflicting_borrow(location, (&place, span), bk, &borrow);\n \n-        let lint_root = if let ClearCrossCrate::Set(ref vsi) = mbcx.body.source_scope_local_data {\n-            let scope = mbcx.body.source_info(location).scope;\n-            vsi[scope].lint_root\n-        } else {\n-            id\n+        let scope = mbcx.body.source_info(location).scope;\n+        let lint_root = match &mbcx.body.source_scopes[scope].local_data {\n+            ClearCrossCrate::Set(data) => data.lint_root,\n+            _ => id,\n         };\n \n         // Span and message don't matter; we overwrite them below anyway\n@@ -338,38 +337,40 @@ fn do_mir_borrowck<'a, 'tcx>(\n     debug!(\"mbcx.used_mut: {:?}\", mbcx.used_mut);\n     let used_mut = mbcx.used_mut;\n     for local in mbcx.body.mut_vars_and_args_iter().filter(|local| !used_mut.contains(local)) {\n-        if let ClearCrossCrate::Set(ref vsi) = mbcx.body.source_scope_local_data {\n-            let local_decl = &mbcx.body.local_decls[local];\n-\n-            // Skip over locals that begin with an underscore or have no name\n-            match mbcx.local_names[local] {\n-                Some(name) => if name.as_str().starts_with(\"_\") {\n-                    continue;\n-                },\n-                None => continue,\n-            }\n+        let local_decl = &mbcx.body.local_decls[local];\n+        let lint_root = match &mbcx.body.source_scopes[local_decl.source_info.scope].local_data {\n+            ClearCrossCrate::Set(data) => data.lint_root,\n+            _ => continue,\n+        };\n \n-            let span = local_decl.source_info.span;\n-            if span.desugaring_kind().is_some() {\n-                // If the `mut` arises as part of a desugaring, we should ignore it.\n+        // Skip over locals that begin with an underscore or have no name\n+        match mbcx.local_names[local] {\n+            Some(name) => if name.as_str().starts_with(\"_\") {\n                 continue;\n-            }\n+            },\n+            None => continue,\n+        }\n \n-            let mut_span = tcx.sess.source_map().span_until_non_whitespace(span);\n-            tcx.struct_span_lint_hir(\n-                UNUSED_MUT,\n-                vsi[local_decl.source_info.scope].lint_root,\n-                span,\n-                \"variable does not need to be mutable\",\n-            )\n-            .span_suggestion_short(\n-                mut_span,\n-                \"remove this `mut`\",\n-                String::new(),\n-                Applicability::MachineApplicable,\n-            )\n-            .emit();\n+        let span = local_decl.source_info.span;\n+        if span.desugaring_kind().is_some() {\n+            // If the `mut` arises as part of a desugaring, we should ignore it.\n+            continue;\n         }\n+\n+        let mut_span = tcx.sess.source_map().span_until_non_whitespace(span);\n+        tcx.struct_span_lint_hir(\n+            UNUSED_MUT,\n+            lint_root,\n+            span,\n+            \"variable does not need to be mutable\",\n+        )\n+        .span_suggestion_short(\n+            mut_span,\n+            \"remove this `mut`\",\n+            String::new(),\n+            Applicability::MachineApplicable,\n+        )\n+        .emit();\n     }\n \n     // Buffer any move errors that we collected and de-duplicated."}, {"sha": "eb9b401f27208abc5352e5e7c1e749a01e5f2da2", "filename": "src/librustc_mir/build/mod.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmod.rs?ref=fd09fad064504e18cd7fd15ccd7c957787482b81", "patch": "@@ -309,7 +309,6 @@ struct Builder<'a, 'tcx> {\n     /// The vector of all scopes that we have created thus far;\n     /// we track this for debuginfo later.\n     source_scopes: IndexVec<SourceScope, SourceScopeData>,\n-    source_scope_local_data: IndexVec<SourceScope, SourceScopeLocalData>,\n     source_scope: SourceScope,\n \n     /// The guard-context: each time we build the guard expression for\n@@ -704,7 +703,6 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             block_context: BlockContext::new(),\n             source_scopes: IndexVec::new(),\n             source_scope: OUTERMOST_SOURCE_SCOPE,\n-            source_scope_local_data: IndexVec::new(),\n             guard_context: vec![],\n             push_unsafe_count: 0,\n             unpushed_unsafe: safety,\n@@ -741,7 +739,6 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         Body::new(\n             self.cfg.basic_blocks,\n             self.source_scopes,\n-            ClearCrossCrate::Set(self.source_scope_local_data),\n             self.local_decls,\n             self.canonical_user_type_annotations,\n             self.arg_count,\n@@ -942,7 +939,11 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             self.hir.root_lint_level\n         );\n         let parent_root = tcx.maybe_lint_level_root_bounded(\n-            self.source_scope_local_data[original_source_scope].lint_root,\n+            self.source_scopes[original_source_scope]\n+                .local_data\n+                .as_ref()\n+                .assert_crate_local()\n+                .lint_root,\n             self.hir.root_lint_level,\n         );\n         if current_root != parent_root {"}, {"sha": "00a30af806a895959311e09c3d994621d797ca6f", "filename": "src/librustc_mir/build/scope.rs", "status": "modified", "additions": 13, "deletions": 10, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Fbuild%2Fscope.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Fbuild%2Fscope.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fscope.rs?ref=fd09fad064504e18cd7fd15ccd7c957787482b81", "patch": "@@ -436,7 +436,11 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             // We estimate the true lint roots here to avoid creating a lot of source scopes.\n \n             let parent_root = tcx.maybe_lint_level_root_bounded(\n-                self.source_scope_local_data[source_scope].lint_root,\n+                self.source_scopes[source_scope]\n+                    .local_data\n+                    .as_ref()\n+                    .assert_crate_local()\n+                    .lint_root,\n                 self.hir.root_lint_level,\n             );\n             let current_root = tcx.maybe_lint_level_root_bounded(\n@@ -654,23 +658,22 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         let parent = self.source_scope;\n         debug!(\"new_source_scope({:?}, {:?}, {:?}) - parent({:?})={:?}\",\n                span, lint_level, safety,\n-               parent, self.source_scope_local_data.get(parent));\n-        let scope = self.source_scopes.push(SourceScopeData {\n-            span,\n-            parent_scope: Some(parent),\n-        });\n+               parent, self.source_scopes.get(parent));\n         let scope_local_data = SourceScopeLocalData {\n             lint_root: if let LintLevel::Explicit(lint_root) = lint_level {\n                 lint_root\n             } else {\n-                self.source_scope_local_data[parent].lint_root\n+                self.source_scopes[parent].local_data.as_ref().assert_crate_local().lint_root\n             },\n             safety: safety.unwrap_or_else(|| {\n-                self.source_scope_local_data[parent].safety\n+                self.source_scopes[parent].local_data.as_ref().assert_crate_local().safety\n             })\n         };\n-        self.source_scope_local_data.push(scope_local_data);\n-        scope\n+        self.source_scopes.push(SourceScopeData {\n+            span,\n+            parent_scope: Some(parent),\n+            local_data: ClearCrossCrate::Set(scope_local_data),\n+        })\n     }\n \n     /// Given a span and the current source scope, make a SourceInfo."}, {"sha": "6c16c4f2219289601b9b0988e0d6a2ea732ccd1f", "filename": "src/librustc_mir/interpret/eval_context.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Finterpret%2Feval_context.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Finterpret%2Feval_context.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Feval_context.rs?ref=fd09fad064504e18cd7fd15ccd7c957787482b81", "patch": "@@ -849,8 +849,8 @@ impl<'mir, 'tcx, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n                 } else {\n                     block.terminator().source_info\n                 };\n-                match body.source_scope_local_data {\n-                    mir::ClearCrossCrate::Set(ref ivs) => Some(ivs[source_info.scope].lint_root),\n+                match &body.source_scopes[source_info.scope].local_data {\n+                    mir::ClearCrossCrate::Set(data) => Some(data.lint_root),\n                     mir::ClearCrossCrate::Clear => None,\n                 }\n             });"}, {"sha": "708686fdcf9f1ab4df308cce7b4c5790ca4d2983", "filename": "src/librustc_mir/shim.rs", "status": "modified", "additions": 4, "deletions": 15, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Fshim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Fshim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fshim.rs?ref=fd09fad064504e18cd7fd15ccd7c957787482b81", "patch": "@@ -198,9 +198,6 @@ fn build_drop_shim<'tcx>(tcx: TyCtxt<'tcx>, def_id: DefId, ty: Option<Ty<'tcx>>)\n \n     let mut body = new_body(\n         blocks,\n-        IndexVec::from_elem_n(\n-            SourceScopeData { span, parent_scope: None }, 1\n-        ),\n         local_decls_for_sig(&sig, span),\n         sig.inputs().len(),\n         span);\n@@ -244,15 +241,16 @@ fn build_drop_shim<'tcx>(tcx: TyCtxt<'tcx>, def_id: DefId, ty: Option<Ty<'tcx>>)\n \n fn new_body<'tcx>(\n     basic_blocks: IndexVec<BasicBlock, BasicBlockData<'tcx>>,\n-    source_scopes: IndexVec<SourceScope, SourceScopeData>,\n     local_decls: IndexVec<Local, LocalDecl<'tcx>>,\n     arg_count: usize,\n     span: Span,\n ) -> Body<'tcx> {\n     Body::new(\n         basic_blocks,\n-        source_scopes,\n-        ClearCrossCrate::Clear,\n+        IndexVec::from_elem_n(\n+            SourceScopeData { span, parent_scope: None, local_data: ClearCrossCrate::Clear },\n+            1,\n+        ),\n         local_decls,\n         IndexVec::new(),\n         arg_count,\n@@ -380,9 +378,6 @@ impl CloneShimBuilder<'tcx> {\n     fn into_mir(self) -> Body<'tcx> {\n         new_body(\n             self.blocks,\n-            IndexVec::from_elem_n(\n-                SourceScopeData { span: self.span, parent_scope: None }, 1\n-            ),\n             self.local_decls,\n             self.sig.inputs().len(),\n             self.span,\n@@ -836,9 +831,6 @@ fn build_call_shim<'tcx>(\n \n     let mut body = new_body(\n         blocks,\n-        IndexVec::from_elem_n(\n-            SourceScopeData { span, parent_scope: None }, 1\n-        ),\n         local_decls,\n         sig.inputs().len(),\n         span,\n@@ -919,9 +911,6 @@ pub fn build_adt_ctor(tcx: TyCtxt<'_>, ctor_id: DefId) -> &Body<'_> {\n \n     let body = new_body(\n         IndexVec::from_elem_n(start_block, 1),\n-        IndexVec::from_elem_n(\n-            SourceScopeData { span, parent_scope: None }, 1\n-        ),\n         local_decls,\n         sig.inputs().len(),\n         span,"}, {"sha": "d12d21aee6abe24053c760343efe517d7c2eb77e", "filename": "src/librustc_mir/transform/check_unsafety.rs", "status": "modified", "additions": 11, "deletions": 22, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs?ref=fd09fad064504e18cd7fd15ccd7c957787482b81", "patch": "@@ -1,6 +1,4 @@\n use rustc_data_structures::fx::FxHashSet;\n-use rustc_index::vec::IndexVec;\n-use rustc_data_structures::sync::Lrc;\n \n use rustc::ty::query::Providers;\n use rustc::ty::{self, TyCtxt};\n@@ -24,7 +22,6 @@ pub struct UnsafetyChecker<'a, 'tcx> {\n     body: &'a Body<'tcx>,\n     const_context: bool,\n     min_const_fn: bool,\n-    source_scope_local_data: &'a IndexVec<SourceScope, SourceScopeLocalData>,\n     violations: Vec<UnsafetyViolation>,\n     source_info: SourceInfo,\n     tcx: TyCtxt<'tcx>,\n@@ -39,7 +36,6 @@ impl<'a, 'tcx> UnsafetyChecker<'a, 'tcx> {\n         const_context: bool,\n         min_const_fn: bool,\n         body: &'a Body<'tcx>,\n-        source_scope_local_data: &'a IndexVec<SourceScope, SourceScopeLocalData>,\n         tcx: TyCtxt<'tcx>,\n         param_env: ty::ParamEnv<'tcx>,\n     ) -> Self {\n@@ -51,7 +47,6 @@ impl<'a, 'tcx> UnsafetyChecker<'a, 'tcx> {\n             body,\n             const_context,\n             min_const_fn,\n-            source_scope_local_data,\n             violations: vec![],\n             source_info: SourceInfo {\n                 span: body.span,\n@@ -219,8 +214,11 @@ impl<'a, 'tcx> Visitor<'tcx> for UnsafetyChecker<'a, 'tcx> {\n             if context.is_borrow() {\n                 if util::is_disaligned(self.tcx, self.body, self.param_env, place) {\n                     let source_info = self.source_info;\n-                    let lint_root =\n-                        self.source_scope_local_data[source_info.scope].lint_root;\n+                    let lint_root = self.body.source_scopes[source_info.scope]\n+                        .local_data\n+                        .as_ref()\n+                        .assert_crate_local()\n+                        .lint_root;\n                     self.register_violations(&[UnsafetyViolation {\n                         source_info,\n                         description: Symbol::intern(\"borrow of packed field\"),\n@@ -346,7 +344,11 @@ impl<'a, 'tcx> UnsafetyChecker<'a, 'tcx> {\n     fn register_violations(&mut self,\n                            violations: &[UnsafetyViolation],\n                            unsafe_blocks: &[(hir::HirId, bool)]) {\n-        let safety = self.source_scope_local_data[self.source_info.scope].safety;\n+        let safety = self.body.source_scopes[self.source_info.scope]\n+            .local_data\n+            .as_ref()\n+            .assert_crate_local()\n+            .safety;\n         let within_unsafe = match safety {\n             // `unsafe` blocks are required in safe code\n             Safety::Safe => {\n@@ -516,17 +518,6 @@ fn unsafety_check_result(tcx: TyCtxt<'_>, def_id: DefId) -> UnsafetyCheckResult\n     // `mir_built` force this.\n     let body = &tcx.mir_built(def_id).borrow();\n \n-    let source_scope_local_data = match body.source_scope_local_data {\n-        ClearCrossCrate::Set(ref data) => data,\n-        ClearCrossCrate::Clear => {\n-            debug!(\"unsafety_violations: {:?} - remote, skipping\", def_id);\n-            return UnsafetyCheckResult {\n-                violations: Lrc::new([]),\n-                unsafe_blocks: Lrc::new([])\n-            }\n-        }\n-    };\n-\n     let param_env = tcx.param_env(def_id);\n \n     let id = tcx.hir().as_local_hir_id(def_id).unwrap();\n@@ -536,9 +527,7 @@ fn unsafety_check_result(tcx: TyCtxt<'_>, def_id: DefId) -> UnsafetyCheckResult\n         hir::BodyOwnerKind::Const |\n         hir::BodyOwnerKind::Static(_) => (true, false),\n     };\n-    let mut checker = UnsafetyChecker::new(\n-        const_context, min_const_fn,\n-        body, source_scope_local_data, tcx, param_env);\n+    let mut checker = UnsafetyChecker::new(const_context, min_const_fn, body, tcx, param_env);\n     checker.visit_body(body);\n \n     check_unused_unsafe(tcx, def_id, &checker.used_unsafe, &mut checker.inherited_blocks);"}, {"sha": "21c335317d6dbfec74fb0bbc181b008de3117fab", "filename": "src/librustc_mir/transform/const_prop.rs", "status": "modified", "additions": 16, "deletions": 36, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs?ref=fd09fad064504e18cd7fd15ccd7c957787482b81", "patch": "@@ -9,7 +9,7 @@ use rustc::hir::def_id::DefId;\n use rustc::mir::{\n     AggregateKind, Constant, Location, Place, PlaceBase, Body, Operand, Rvalue, Local, UnOp,\n     StatementKind, Statement, LocalKind, TerminatorKind, Terminator,  ClearCrossCrate, SourceInfo,\n-    BinOp, SourceScope, SourceScopeLocalData, LocalDecl, BasicBlock, RETURN_PLACE,\n+    BinOp, SourceScope, SourceScopeData, LocalDecl, BasicBlock, RETURN_PLACE,\n };\n use rustc::mir::visit::{\n     Visitor, PlaceContext, MutatingUseContext, MutVisitor, NonMutatingUseContext,\n@@ -74,17 +74,10 @@ impl<'tcx> MirPass<'tcx> for ConstProp {\n \n         trace!(\"ConstProp starting for {:?}\", source.def_id());\n \n-        // Steal some data we need from `body`.\n-        let source_scope_local_data = std::mem::replace(\n-            &mut body.source_scope_local_data,\n-            ClearCrossCrate::Clear\n-        );\n-\n         let dummy_body =\n             &Body::new(\n                 body.basic_blocks().clone(),\n-                Default::default(),\n-                ClearCrossCrate::Clear,\n+                body.source_scopes.clone(),\n                 body.local_decls.clone(),\n                 Default::default(),\n                 body.arg_count,\n@@ -101,19 +94,11 @@ impl<'tcx> MirPass<'tcx> for ConstProp {\n         let mut optimization_finder = ConstPropagator::new(\n             body,\n             dummy_body,\n-            source_scope_local_data,\n             tcx,\n             source\n         );\n         optimization_finder.visit_body(body);\n \n-        // put back the data we stole from `mir`\n-        let source_scope_local_data = optimization_finder.release_stolen_data();\n-        std::mem::replace(\n-            &mut body.source_scope_local_data,\n-            source_scope_local_data\n-        );\n-\n         trace!(\"ConstProp done for {:?}\", source.def_id());\n     }\n }\n@@ -267,7 +252,9 @@ struct ConstPropagator<'mir, 'tcx> {\n     source: MirSource<'tcx>,\n     can_const_prop: IndexVec<Local, bool>,\n     param_env: ParamEnv<'tcx>,\n-    source_scope_local_data: ClearCrossCrate<IndexVec<SourceScope, SourceScopeLocalData>>,\n+    // FIXME(eddyb) avoid cloning these two fields more than once,\n+    // by accessing them through `ecx` instead.\n+    source_scopes: IndexVec<SourceScope, SourceScopeData>,\n     local_decls: IndexVec<Local, LocalDecl<'tcx>>,\n     ret: Option<OpTy<'tcx, ()>>,\n }\n@@ -299,7 +286,6 @@ impl<'mir, 'tcx> ConstPropagator<'mir, 'tcx> {\n     fn new(\n         body: &Body<'tcx>,\n         dummy_body: &'mir Body<'tcx>,\n-        source_scope_local_data: ClearCrossCrate<IndexVec<SourceScope, SourceScopeLocalData>>,\n         tcx: TyCtxt<'tcx>,\n         source: MirSource<'tcx>,\n     ) -> ConstPropagator<'mir, 'tcx> {\n@@ -337,17 +323,15 @@ impl<'mir, 'tcx> ConstPropagator<'mir, 'tcx> {\n             source,\n             param_env,\n             can_const_prop,\n-            source_scope_local_data,\n+            // FIXME(eddyb) avoid cloning these two fields more than once,\n+            // by accessing them through `ecx` instead.\n+            source_scopes: body.source_scopes.clone(),\n             //FIXME(wesleywiser) we can't steal this because `Visitor::super_visit_body()` needs it\n             local_decls: body.local_decls.clone(),\n             ret: ret.map(Into::into),\n         }\n     }\n \n-    fn release_stolen_data(self) -> ClearCrossCrate<IndexVec<SourceScope, SourceScopeLocalData>> {\n-        self.source_scope_local_data\n-    }\n-\n     fn get_const(&self, local: Local) -> Option<Const<'tcx>> {\n         if local == RETURN_PLACE {\n             // Try to read the return place as an immediate so that if it is representable as a\n@@ -377,14 +361,11 @@ impl<'mir, 'tcx> ConstPropagator<'mir, 'tcx> {\n         F: FnOnce(&mut Self) -> InterpResult<'tcx, T>,\n     {\n         self.ecx.tcx.span = source_info.span;\n-        let lint_root = match self.source_scope_local_data {\n-            ClearCrossCrate::Set(ref ivs) => {\n-                //FIXME(#51314): remove this check\n-                if source_info.scope.index() >= ivs.len() {\n-                    return None;\n-                }\n-                ivs[source_info.scope].lint_root\n-            },\n+        // FIXME(eddyb) move this to the `Panic(_)` error case, so that\n+        // `f(self)` is always called, and that the only difference when the\n+        // scope's `local_data` is missing, is that the lint isn't emitted.\n+        let lint_root = match &self.source_scopes[source_info.scope].local_data {\n+            ClearCrossCrate::Set(data) => data.lint_root,\n             ClearCrossCrate::Clear => return None,\n         };\n         let r = match f(self) {\n@@ -525,19 +506,18 @@ impl<'mir, 'tcx> ConstPropagator<'mir, 'tcx> {\n                     let right_size = r.layout.size;\n                     let r_bits = r.to_scalar().and_then(|r| r.to_bits(right_size));\n                     if r_bits.ok().map_or(false, |b| b >= left_bits as u128) {\n-                        let source_scope_local_data = match self.source_scope_local_data {\n-                            ClearCrossCrate::Set(ref data) => data,\n+                        let lint_root = match &self.source_scopes[source_info.scope].local_data {\n+                            ClearCrossCrate::Set(data) => data.lint_root,\n                             ClearCrossCrate::Clear => return None,\n                         };\n                         let dir = if *op == BinOp::Shr {\n                             \"right\"\n                         } else {\n                             \"left\"\n                         };\n-                        let hir_id = source_scope_local_data[source_info.scope].lint_root;\n                         self.tcx.lint_hir(\n                             ::rustc::lint::builtin::EXCEEDING_BITSHIFTS,\n-                            hir_id,\n+                            lint_root,\n                             span,\n                             &format!(\"attempt to shift {} with overflow\", dir));\n                         return None;"}, {"sha": "ebfadd0cfd3ed61064bad8cf213644b782a663b0", "filename": "src/librustc_mir/transform/inline.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Finline.rs?ref=fd09fad064504e18cd7fd15ccd7c957787482b81", "patch": "@@ -391,9 +391,14 @@ impl Inliner<'tcx> {\n                 for mut scope in callee_body.source_scopes.iter().cloned() {\n                     if scope.parent_scope.is_none() {\n                         scope.parent_scope = Some(callsite.location.scope);\n+                        // FIXME(eddyb) is this really needed?\n+                        // (also note that it's always overwritten below)\n                         scope.span = callee_body.span;\n                     }\n \n+                    // FIXME(eddyb) this doesn't seem right at all.\n+                    // The inlined source scopes should probably be annotated as\n+                    // such, but also contain all of the original information.\n                     scope.span = callsite.location.span;\n \n                     let idx = caller_body.source_scopes.push(scope);"}, {"sha": "591f3ca44009d4aa4bf004f3c1ba5d4f73b7f0d7", "filename": "src/librustc_mir/transform/promote_consts.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd09fad064504e18cd7fd15ccd7c957787482b81/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs?ref=fd09fad064504e18cd7fd15ccd7c957787482b81", "patch": "@@ -1081,7 +1081,6 @@ pub fn promote_candidates<'tcx>(\n                 // FIXME: maybe try to filter this to avoid blowing up\n                 // memory usage?\n                 body.source_scopes.clone(),\n-                body.source_scope_local_data.clone(),\n                 initial_locals,\n                 IndexVec::new(),\n                 0,"}]}