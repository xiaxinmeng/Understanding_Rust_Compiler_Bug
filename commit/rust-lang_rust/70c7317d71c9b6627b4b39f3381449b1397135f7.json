{"sha": "70c7317d71c9b6627b4b39f3381449b1397135f7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcwYzczMTdkNzFjOWI2NjI3YjRiMzlmMzM4MTQ0OWIxMzk3MTM1Zjc=", "commit": {"author": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2021-08-30T09:54:12Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2021-09-07T12:14:08Z"}, "message": "Add test case for no-bundle/whole-archive native libs linking.", "tree": {"sha": "5994f6d24e452c725e12f9c0d36316f238775448", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5994f6d24e452c725e12f9c0d36316f238775448"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/70c7317d71c9b6627b4b39f3381449b1397135f7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/70c7317d71c9b6627b4b39f3381449b1397135f7", "html_url": "https://github.com/rust-lang/rust/commit/70c7317d71c9b6627b4b39f3381449b1397135f7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/70c7317d71c9b6627b4b39f3381449b1397135f7/comments", "author": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "846c372f86dfad597797ee73665f330fc557c63f", "url": "https://api.github.com/repos/rust-lang/rust/commits/846c372f86dfad597797ee73665f330fc557c63f", "html_url": "https://github.com/rust-lang/rust/commit/846c372f86dfad597797ee73665f330fc557c63f"}], "stats": {"total": 87, "additions": 87, "deletions": 0}, "files": [{"sha": "799b5f6f5fc6f9a06ae84d1b575e5f44939587ee", "filename": "src/test/run-make/native-link-modifier-whole-archive/Makefile", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2FMakefile?ref=70c7317d71c9b6627b4b39f3381449b1397135f7", "patch": "@@ -0,0 +1,39 @@\n+# ignore-cross-compile -- compiling C++ code does not work well when cross-compiling\n+\n+# This test case makes sure that native libraries are linked with --whole-archive semantics\n+# when the `-bundle,+whole-archive` modifiers are applied to them.\n+#\n+# The test works by checking that the resulting executables produce the expected output,\n+# part of which is emitted by otherwise unreferenced C code. If +whole-archive didn't work\n+# that code would never make it into the final executable and we'd thus be missing some\n+# of the output.\n+\n+-include ../../run-make-fulldeps/tools.mk\n+\n+all: $(TMPDIR)/$(call BIN,directly_linked) $(TMPDIR)/$(call BIN,indirectly_linked) $(TMPDIR)/$(call BIN,indirectly_linked_via_attr)\n+\t$(call RUN,directly_linked) | $(CGREP) 'static-initializer.directly_linked.'\n+\t$(call RUN,indirectly_linked) | $(CGREP) 'static-initializer.indirectly_linked.'\n+\t$(call RUN,indirectly_linked_via_attr) | $(CGREP) 'static-initializer.native_lib_in_src.'\n+\n+# Native lib linked directly into executable\n+$(TMPDIR)/$(call BIN,directly_linked): $(call NATIVE_STATICLIB,c_static_lib_with_constructor)\n+\t$(RUSTC) directly_linked.rs -Z unstable-options -l static:+whole-archive=c_static_lib_with_constructor\n+\n+# Native lib linked into RLIB via `-l static:-bundle,+whole-archive`, RLIB linked into executable\n+$(TMPDIR)/$(call BIN,indirectly_linked): $(TMPDIR)/librlib_with_cmdline_native_lib.rlib\n+\t$(RUSTC) indirectly_linked.rs\n+\n+# Native lib linked into RLIB via #[link] attribute, RLIB linked into executable\n+$(TMPDIR)/$(call BIN,indirectly_linked_via_attr): $(TMPDIR)/libnative_lib_in_src.rlib\n+\t$(RUSTC) indirectly_linked_via_attr.rs\n+\n+# Native lib linked into rlib with via commandline\n+$(TMPDIR)/librlib_with_cmdline_native_lib.rlib: $(call NATIVE_STATICLIB,c_static_lib_with_constructor)\n+\t$(RUSTC) rlib_with_cmdline_native_lib.rs -Z unstable-options --crate-type=rlib -l static:-bundle,+whole-archive=c_static_lib_with_constructor\n+\n+# Native lib linked into rlib via `#[link()]` attribute on extern block.\n+$(TMPDIR)/libnative_lib_in_src.rlib: $(call NATIVE_STATICLIB,c_static_lib_with_constructor)\n+\t$(RUSTC) native_lib_in_src.rs --crate-type=rlib\n+\n+$(TMPDIR)/libc_static_lib_with_constructor.o: c_static_lib_with_constructor.cpp\n+\t$(call COMPILE_OBJ_CXX,$@,$<)"}, {"sha": "c687eb0f092f956019a9356e52480f832b7170ca", "filename": "src/test/run-make/native-link-modifier-whole-archive/c_static_lib_with_constructor.cpp", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fc_static_lib_with_constructor.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fc_static_lib_with_constructor.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fc_static_lib_with_constructor.cpp?ref=70c7317d71c9b6627b4b39f3381449b1397135f7", "patch": "@@ -0,0 +1,11 @@\n+#include <cstdio>\n+\n+// Since this is a global variable, its constructor will be called before\n+// main() is executed. But only if the object file containing it actually\n+// gets linked into the executable.\n+struct Foo {\n+    Foo() {\n+        printf(\"static-initializer.\");\n+        fflush(stdout);\n+    }\n+} FOO;"}, {"sha": "17518e8b2f9634abfc8f4fd35844c9175a6a7d30", "filename": "src/test/run-make/native-link-modifier-whole-archive/directly_linked.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fdirectly_linked.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fdirectly_linked.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fdirectly_linked.rs?ref=70c7317d71c9b6627b4b39f3381449b1397135f7", "patch": "@@ -0,0 +1,6 @@\n+use std::io::Write;\n+\n+fn main() {\n+    print!(\"directly_linked.\");\n+    std::io::stdout().flush().unwrap();\n+}"}, {"sha": "c8b83fcfe037da50c73c1c9016bc7a3f522e0f35", "filename": "src/test/run-make/native-link-modifier-whole-archive/indirectly_linked.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Findirectly_linked.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Findirectly_linked.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Findirectly_linked.rs?ref=70c7317d71c9b6627b4b39f3381449b1397135f7", "patch": "@@ -0,0 +1,5 @@\n+extern crate rlib_with_cmdline_native_lib;\n+\n+fn main() {\n+    rlib_with_cmdline_native_lib::hello();\n+}"}, {"sha": "b9e347609b2c00fc4472df53084cc7a117672f8c", "filename": "src/test/run-make/native-link-modifier-whole-archive/indirectly_linked_via_attr.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Findirectly_linked_via_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Findirectly_linked_via_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Findirectly_linked_via_attr.rs?ref=70c7317d71c9b6627b4b39f3381449b1397135f7", "patch": "@@ -0,0 +1,5 @@\n+extern crate native_lib_in_src;\n+\n+fn main() {\n+    native_lib_in_src::hello();\n+}"}, {"sha": "373d89b7936e5348911c7f138d8c511a379c8271", "filename": "src/test/run-make/native-link-modifier-whole-archive/native_lib_in_src.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fnative_lib_in_src.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fnative_lib_in_src.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fnative_lib_in_src.rs?ref=70c7317d71c9b6627b4b39f3381449b1397135f7", "patch": "@@ -0,0 +1,15 @@\n+#![feature(native_link_modifiers_bundle)]\n+#![feature(native_link_modifiers_whole_archive)]\n+#![feature(native_link_modifiers)]\n+\n+use std::io::Write;\n+\n+#[link(name = \"c_static_lib_with_constructor\",\n+       kind = \"static\",\n+       modifiers = \"-bundle,+whole-archive\")]\n+extern {}\n+\n+pub fn hello() {\n+    print!(\"native_lib_in_src.\");\n+    std::io::stdout().flush().unwrap();\n+}"}, {"sha": "ef2b702dd82097df3b6d3234b8b9621ddd94a856", "filename": "src/test/run-make/native-link-modifier-whole-archive/rlib_with_cmdline_native_lib.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Frlib_with_cmdline_native_lib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c7317d71c9b6627b4b39f3381449b1397135f7/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Frlib_with_cmdline_native_lib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Frlib_with_cmdline_native_lib.rs?ref=70c7317d71c9b6627b4b39f3381449b1397135f7", "patch": "@@ -0,0 +1,6 @@\n+use std::io::Write;\n+\n+pub fn hello() {\n+    print!(\"indirectly_linked.\");\n+    std::io::stdout().flush().unwrap();\n+}"}]}