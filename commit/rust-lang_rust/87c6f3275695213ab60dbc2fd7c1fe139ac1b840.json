{"sha": "87c6f3275695213ab60dbc2fd7c1fe139ac1b840", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg3YzZmMzI3NTY5NTIxM2FiNjBkYmMyZmQ3YzFmZTEzOWFjMWI4NDA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-08-24T12:32:01Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-08-24T12:32:01Z"}, "message": "Auto merge of #7592 - lengyijun:redundant_allocation, r=camsteffen\n\nredundant_allocation: fix 7487\n\nFixes #7487\n\nchangelog: [`redundant_allocation`] - allow `Box<Box<dyn T>>` which replaces wide pointers with thin pointers", "tree": {"sha": "51664c2f133aa9ad380ad9b4faf52e87f247f562", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/51664c2f133aa9ad380ad9b4faf52e87f247f562"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/87c6f3275695213ab60dbc2fd7c1fe139ac1b840", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/87c6f3275695213ab60dbc2fd7c1fe139ac1b840", "html_url": "https://github.com/rust-lang/rust/commit/87c6f3275695213ab60dbc2fd7c1fe139ac1b840", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/87c6f3275695213ab60dbc2fd7c1fe139ac1b840/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "15b1c6f1a277325e099e42236f5d3ec874d67e7d", "url": "https://api.github.com/repos/rust-lang/rust/commits/15b1c6f1a277325e099e42236f5d3ec874d67e7d", "html_url": "https://github.com/rust-lang/rust/commit/15b1c6f1a277325e099e42236f5d3ec874d67e7d"}, {"sha": "641be558fcdbddbabc1b6af841c05b61dbdd9d5f", "url": "https://api.github.com/repos/rust-lang/rust/commits/641be558fcdbddbabc1b6af841c05b61dbdd9d5f", "html_url": "https://github.com/rust-lang/rust/commit/641be558fcdbddbabc1b6af841c05b61dbdd9d5f"}], "stats": {"total": 39, "additions": 37, "deletions": 2}, "files": [{"sha": "ac7bdd6a1ebebf318c6e8eab2a46bbcb999b2328", "filename": "clippy_lints/src/types/redundant_allocation.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/87c6f3275695213ab60dbc2fd7c1fe139ac1b840/clippy_lints%2Fsrc%2Ftypes%2Fredundant_allocation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/87c6f3275695213ab60dbc2fd7c1fe139ac1b840/clippy_lints%2Fsrc%2Ftypes%2Fredundant_allocation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftypes%2Fredundant_allocation.rs?ref=87c6f3275695213ab60dbc2fd7c1fe139ac1b840", "patch": "@@ -54,7 +54,13 @@ pub(super) fn check(cx: &LateContext<'_>, hir_ty: &hir::Ty<'_>, qpath: &QPath<'_\n         _ => return false,\n     };\n     let inner_span = match get_qpath_generic_tys(inner_qpath).next() {\n-        Some(ty) => ty.span,\n+        Some(ty) => {\n+            // Box<Box<dyn T>> is smaller than Box<dyn T> because of wide pointers\n+            if matches!(ty.kind, TyKind::TraitObject(..)) {\n+                return false;\n+            }\n+            ty.span\n+        },\n         None => return false,\n     };\n     if inner_sym == outer_sym {"}, {"sha": "52fbc91e325555a9c808f57a47e76cc48e893363", "filename": "tests/ui/redundant_allocation.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/87c6f3275695213ab60dbc2fd7c1fe139ac1b840/tests%2Fui%2Fredundant_allocation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/87c6f3275695213ab60dbc2fd7c1fe139ac1b840/tests%2Fui%2Fredundant_allocation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fredundant_allocation.rs?ref=87c6f3275695213ab60dbc2fd7c1fe139ac1b840", "patch": "@@ -77,4 +77,24 @@ mod outer_arc {\n     }\n }\n \n+// https://github.com/rust-lang/rust-clippy/issues/7487\n+mod box_dyn {\n+    use std::boxed::Box;\n+    use std::rc::Rc;\n+    use std::sync::Arc;\n+\n+    pub trait T {}\n+\n+    struct S {\n+        a: Box<Box<dyn T>>,\n+        b: Rc<Box<dyn T>>,\n+        c: Arc<Box<dyn T>>,\n+    }\n+\n+    pub fn test_box(_: Box<Box<dyn T>>) {}\n+    pub fn test_rc(_: Rc<Box<dyn T>>) {}\n+    pub fn test_arc(_: Arc<Box<dyn T>>) {}\n+    pub fn test_rc_box(_: Rc<Box<Box<dyn T>>>) {}\n+}\n+\n fn main() {}"}, {"sha": "c3b10e5f5e679df879418117c4840aa6268b07dd", "filename": "tests/ui/redundant_allocation.stderr", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/87c6f3275695213ab60dbc2fd7c1fe139ac1b840/tests%2Fui%2Fredundant_allocation.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/87c6f3275695213ab60dbc2fd7c1fe139ac1b840/tests%2Fui%2Fredundant_allocation.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fredundant_allocation.stderr?ref=87c6f3275695213ab60dbc2fd7c1fe139ac1b840", "patch": "@@ -134,5 +134,14 @@ LL |     pub fn arc_test9<T>(foo: Arc<Rc<T>>) -> Arc<Rc<SubT<T>>> {\n    = note: `Rc<SubT<T>>` is already on the heap, `Arc<Rc<SubT<T>>>` makes an extra allocation\n    = help: consider using just `Arc<SubT<T>>` or `Rc<SubT<T>>`\n \n-error: aborting due to 15 previous errors\n+error: usage of `Rc<Box<Box<dyn T>>>`\n+  --> $DIR/redundant_allocation.rs:97:27\n+   |\n+LL |     pub fn test_rc_box(_: Rc<Box<Box<dyn T>>>) {}\n+   |                           ^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: `Box<Box<dyn T>>` is already on the heap, `Rc<Box<Box<dyn T>>>` makes an extra allocation\n+   = help: consider using just `Rc<Box<dyn T>>` or `Box<Box<dyn T>>`\n+\n+error: aborting due to 16 previous errors\n "}]}