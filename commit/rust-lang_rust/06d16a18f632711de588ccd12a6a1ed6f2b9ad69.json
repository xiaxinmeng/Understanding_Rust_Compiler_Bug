{"sha": "06d16a18f632711de588ccd12a6a1ed6f2b9ad69", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA2ZDE2YTE4ZjYzMjcxMWRlNTg4Y2NkMTJhNmExZWQ2ZjJiOWFkNjk=", "commit": {"author": {"name": "Marcus Klaas de Vries", "email": "mail@marcusklaas.nl", "date": "2019-01-16T23:29:26Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-01-19T12:37:25Z"}, "message": "Implement match binding type inference and arm unification", "tree": {"sha": "88059c2a9b05147e5a393183883f78087a37047c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/88059c2a9b05147e5a393183883f78087a37047c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/06d16a18f632711de588ccd12a6a1ed6f2b9ad69", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/06d16a18f632711de588ccd12a6a1ed6f2b9ad69", "html_url": "https://github.com/rust-lang/rust/commit/06d16a18f632711de588ccd12a6a1ed6f2b9ad69", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/06d16a18f632711de588ccd12a6a1ed6f2b9ad69/comments", "author": {"login": "marcusklaas", "id": 1255413, "node_id": "MDQ6VXNlcjEyNTU0MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1255413?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcusklaas", "html_url": "https://github.com/marcusklaas", "followers_url": "https://api.github.com/users/marcusklaas/followers", "following_url": "https://api.github.com/users/marcusklaas/following{/other_user}", "gists_url": "https://api.github.com/users/marcusklaas/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcusklaas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcusklaas/subscriptions", "organizations_url": "https://api.github.com/users/marcusklaas/orgs", "repos_url": "https://api.github.com/users/marcusklaas/repos", "events_url": "https://api.github.com/users/marcusklaas/events{/privacy}", "received_events_url": "https://api.github.com/users/marcusklaas/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ac216880f5d1a3e5727b96d7b22433beec10382b", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac216880f5d1a3e5727b96d7b22433beec10382b", "html_url": "https://github.com/rust-lang/rust/commit/ac216880f5d1a3e5727b96d7b22433beec10382b"}], "stats": {"total": 33, "additions": 25, "deletions": 8}, "files": [{"sha": "74996dda52a11dca6407a4da4ad864409b122771", "filename": "crates/ra_hir/src/ty.rs", "status": "modified", "additions": 17, "deletions": 7, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/06d16a18f632711de588ccd12a6a1ed6f2b9ad69/crates%2Fra_hir%2Fsrc%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/06d16a18f632711de588ccd12a6a1ed6f2b9ad69/crates%2Fra_hir%2Fsrc%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty.rs?ref=06d16a18f632711de588ccd12a6a1ed6f2b9ad69", "patch": "@@ -36,7 +36,7 @@ use crate::{\n     db::HirDatabase,\n     type_ref::{TypeRef, Mutability},\n     name::KnownName,\n-    expr::{Body, Expr, Literal, ExprId, Pat, PatId, UnaryOp, BinaryOp, Statement, FieldPat},\n+    expr::{Body, Expr, MatchArm, Literal, ExprId, Pat, PatId, UnaryOp, BinaryOp, Statement, FieldPat},\n };\n \n /// The ID of a type variable.\n@@ -1097,14 +1097,24 @@ impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n                 ret_ty\n             }\n             Expr::Match { expr, arms } => {\n-                let _ty = self.infer_expr(*expr, &Expectation::none());\n-                for arm in arms {\n-                    // TODO type the bindings in pats\n+                let mut expected = Expectation::none();\n+                let input_ty = self.infer_expr(*expr, &Expectation::none());\n+                let pat_expectation = Expectation::has_type(input_ty);\n+\n+                for MatchArm {\n+                    pats,\n+                    expr: arm_expr,\n+                } in arms\n+                {\n+                    for &pat in pats {\n+                        let _pat_ty = self.infer_pat(pat, &pat_expectation);\n+                    }\n                     // TODO type the guard\n-                    let _ty = self.infer_expr(arm.expr, &Expectation::none());\n+                    let ty = self.infer_expr(*arm_expr, &expected);\n+                    expected = Expectation::has_type(ty);\n                 }\n-                // TODO unify all the match arm types\n-                Ty::Unknown\n+\n+                expected.ty\n             }\n             Expr::Path(p) => self.infer_path_expr(expr, p).unwrap_or(Ty::Unknown),\n             Expr::Continue => Ty::Never,"}, {"sha": "3b9b9a078b234f57d9e62c4bedb4ad4f7557d574", "filename": "crates/ra_hir/src/ty/tests/data/adt_pattern.txt", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/06d16a18f632711de588ccd12a6a1ed6f2b9ad69/crates%2Fra_hir%2Fsrc%2Fty%2Ftests%2Fdata%2Fadt_pattern.txt", "raw_url": "https://github.com/rust-lang/rust/raw/06d16a18f632711de588ccd12a6a1ed6f2b9ad69/crates%2Fra_hir%2Fsrc%2Fty%2Ftests%2Fdata%2Fadt_pattern.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Ftests%2Fdata%2Fadt_pattern.txt?ref=06d16a18f632711de588ccd12a6a1ed6f2b9ad69", "patch": "@@ -1,4 +1,4 @@\n-[68; 155) '{     ...= e; }': ()\n+[68; 221) '{     ...  }; }': ()\n [78; 79) 'e': E\n [82; 95) 'E::A { x: 3 }': E\n [92; 93) '3': usize\n@@ -9,3 +9,10 @@\n [129; 148) 'E::A {..._var }': E\n [139; 146) 'new_var': usize\n [151; 152) 'e': E\n+[159; 218) 'match ...     }': usize\n+[165; 166) 'e': E\n+[177; 187) 'E::A { x }': E\n+[184; 185) 'x': usize\n+[191; 192) 'x': usize\n+[202; 206) 'E::B': E\n+[210; 211) '1': usize"}]}