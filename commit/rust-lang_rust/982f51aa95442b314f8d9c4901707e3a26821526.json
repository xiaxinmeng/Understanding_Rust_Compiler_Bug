{"sha": "982f51aa95442b314f8d9c4901707e3a26821526", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk4MmY1MWFhOTU0NDJiMzE0ZjhkOWM0OTAxNzA3ZTNhMjY4MjE1MjY=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-06-17T01:01:13Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-06-17T01:01:57Z"}, "message": "stdlib: Fix reserve on zero-length interior vectors; uncomment test_unsafe_ptrs()", "tree": {"sha": "24aaa6a12c18fba85dd2dbc45bbd2b35094dbcf1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/24aaa6a12c18fba85dd2dbc45bbd2b35094dbcf1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/982f51aa95442b314f8d9c4901707e3a26821526", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/982f51aa95442b314f8d9c4901707e3a26821526", "html_url": "https://github.com/rust-lang/rust/commit/982f51aa95442b314f8d9c4901707e3a26821526", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/982f51aa95442b314f8d9c4901707e3a26821526/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "391348ec86ba40cfc05eb7a23d3dd1e58013f250", "url": "https://api.github.com/repos/rust-lang/rust/commits/391348ec86ba40cfc05eb7a23d3dd1e58013f250", "html_url": "https://github.com/rust-lang/rust/commit/391348ec86ba40cfc05eb7a23d3dd1e58013f250"}], "stats": {"total": 17, "additions": 14, "deletions": 3}, "files": [{"sha": "c713a923d460826d0f2ee8557453ac55587754dc", "filename": "src/rt/rust_builtin.cpp", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/982f51aa95442b314f8d9c4901707e3a26821526/src%2Frt%2Frust_builtin.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/982f51aa95442b314f8d9c4901707e3a26821526/src%2Frt%2Frust_builtin.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_builtin.cpp?ref=982f51aa95442b314f8d9c4901707e3a26821526", "patch": "@@ -587,7 +587,7 @@ ivec_reserve(rust_task *task, type_desc *ty, rust_ivec *v, size_t n_elems)\n         return;     // Already big enough.\n \n     rust_ivec_heap *heap_part;\n-    if (v->fill) {\n+    if (v->fill || !v->payload.ptr) {\n         // On stack; spill to heap.\n         heap_part = (rust_ivec_heap *)task->malloc(new_alloc +\n                                                    sizeof(size_t));\n@@ -625,6 +625,16 @@ ivec_to_ptr(rust_task *task, type_desc *ty, rust_ivec *v)\n     return v->fill ? v->payload.data : v->payload.ptr->data;\n }\n \n+static size_t\n+get_ivec_size(rust_ivec *v)\n+{\n+    if (v->fill)\n+        return v->fill;\n+    if (v->payload.ptr)\n+        return v->payload.ptr->fill;\n+    return 0;\n+}\n+\n /**\n  * Copies elements in an unsafe buffer to the given interior vector. The\n  * vector must have size zero.\n@@ -633,7 +643,8 @@ extern \"C\" void\n ivec_copy_from_buf(rust_task *task, type_desc *ty, rust_ivec *v, void *ptr,\n                    size_t count)\n {\n-    if (v->fill || (v->payload.ptr && v->payload.ptr->fill)) {\n+    size_t old_size = get_ivec_size(v);\n+    if (old_size) {\n         task->fail(1);\n         return;\n     }"}, {"sha": "f7e202a64d4219b38a54e0fd1e8033cc794bc73e", "filename": "src/test/run-pass/lib-ivec.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/982f51aa95442b314f8d9c4901707e3a26821526/src%2Ftest%2Frun-pass%2Flib-ivec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/982f51aa95442b314f8d9c4901707e3a26821526/src%2Ftest%2Frun-pass%2Flib-ivec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Flib-ivec.rs?ref=982f51aa95442b314f8d9c4901707e3a26821526", "patch": "@@ -45,7 +45,7 @@ fn test_init_fn() {\n \n fn main() {\n     test_reserve_and_on_heap();\n-    //test_unsafe_ptrs();\n+    test_unsafe_ptrs();\n     //test_init_fn();\n }\n "}]}