{"sha": "ad6dd60396d2a4e493e65ee5ba66562168d28cec", "node_id": "C_kwDOAAsO6NoAKGFkNmRkNjAzOTZkMmE0ZTQ5M2U2NWVlNWJhNjY1NjIxNjhkMjhjZWM", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2023-02-10T21:01:43Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2023-02-20T14:08:05Z"}, "message": "fix Stacked Borrows interaction with dyn*", "tree": {"sha": "d3704c41586c0003f04ec9fe01920b6bc258fcad", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d3704c41586c0003f04ec9fe01920b6bc258fcad"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ad6dd60396d2a4e493e65ee5ba66562168d28cec", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ad6dd60396d2a4e493e65ee5ba66562168d28cec", "html_url": "https://github.com/rust-lang/rust/commit/ad6dd60396d2a4e493e65ee5ba66562168d28cec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ad6dd60396d2a4e493e65ee5ba66562168d28cec/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "57056d7f8f79bf96ad99f562d00001451dc8fb4a", "url": "https://api.github.com/repos/rust-lang/rust/commits/57056d7f8f79bf96ad99f562d00001451dc8fb4a", "html_url": "https://github.com/rust-lang/rust/commit/57056d7f8f79bf96ad99f562d00001451dc8fb4a"}], "stats": {"total": 6, "additions": 4, "deletions": 2}, "files": [{"sha": "ed3dd741a8be0fe64f6bd107e6c58063b65c9583", "filename": "src/tools/miri/src/helpers.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ad6dd60396d2a4e493e65ee5ba66562168d28cec/src%2Ftools%2Fmiri%2Fsrc%2Fhelpers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad6dd60396d2a4e493e65ee5ba66562168d28cec/src%2Ftools%2Fmiri%2Fsrc%2Fhelpers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Fsrc%2Fhelpers.rs?ref=ad6dd60396d2a4e493e65ee5ba66562168d28cec", "patch": "@@ -478,6 +478,10 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriInterpCxExt<'mir, 'tcx> {\n                 } else if matches!(v.layout.fields, FieldsShape::Union(..)) {\n                     // A (non-frozen) union. We fall back to whatever the type says.\n                     (self.unsafe_cell_action)(v)\n+                } else if matches!(v.layout.ty.kind(), ty::Dynamic(_, _, ty::DynStar)) {\n+                    // This needs to read the vtable pointer to proceed type-driven, but we don't\n+                    // want to reentrantly read from memory here.\n+                    (self.unsafe_cell_action)(v)\n                 } else {\n                     // We want to not actually read from memory for this visit. So, before\n                     // walking this value, we have to make sure it is not a"}, {"sha": "16a8cec6cdae16c6ca7bac91c1cfb470d37f26a3", "filename": "src/tools/miri/tests/pass/dyn-star.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad6dd60396d2a4e493e65ee5ba66562168d28cec/src%2Ftools%2Fmiri%2Ftests%2Fpass%2Fdyn-star.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad6dd60396d2a4e493e65ee5ba66562168d28cec/src%2Ftools%2Fmiri%2Ftests%2Fpass%2Fdyn-star.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Ftests%2Fpass%2Fdyn-star.rs?ref=ad6dd60396d2a4e493e65ee5ba66562168d28cec", "patch": "@@ -1,5 +1,3 @@\n-// Dyn* handling leads to some funky reentrancy in Stacked Borrows, for some reason\n-//@compile-flags: -Zmiri-disable-stacked-borrows\n #![feature(dyn_star)]\n #![allow(incomplete_features)]\n "}]}