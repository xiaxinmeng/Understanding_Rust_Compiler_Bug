{"sha": "ffde0f722e410f7ec1e271ee2688bac9a24ca539", "node_id": "C_kwDOAAsO6NoAKGZmZGUwZjcyMmU0MTBmN2VjMWUyNzFlZTI2ODhiYWM5YTI0Y2E1Mzk", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-10-26T12:02:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-26T12:02:54Z"}, "message": "Rollup merge of #103428 - SarthakSingh31:issue-94187, r=compiler-errors\n\nRemoved verbose printing from the `PrettyPrinter` when printing constants\n\nPartially solves #94187 by completing the first step described in [this comment](https://github.com/rust-lang/rust/issues/94187#issuecomment-1282339909).", "tree": {"sha": "7e7477a351daf97a0eb4854856ea9c9448c49771", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7e7477a351daf97a0eb4854856ea9c9448c49771"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ffde0f722e410f7ec1e271ee2688bac9a24ca539", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjWSHuCRBK7hj4Ov3rIwAAh8wIAHboiJT5lqtPG+/x5cIVRarW\n11RDd6G6jXruea5q5vulKk+k52X7bOozQfP+6GC9rNQNa0qbmilrPQkgkjClch7V\nZIUvoUA1XeOO8w715ia9ZoP21Rh1yuFs8E278lmR/MH50ZX1d24jEp26aqgc1F8P\nzxHBN5jbfXCq1xcaf+REhTjQAGVohp1BqaJE9tLL72omi0914xO1hBATauNBgL5E\ne76EVR1e/i3NeNb7SMNd7jSEp1+idhRlViHgbJ9caKTs2kuQWI5EEUHk8Zedblq4\nO5MbF+Zshd+cTK9NjAjeapg+jReJyobrlLE1CmF7pOeF/2ipYExYiJthp4lKnV4=\n=U1pN\n-----END PGP SIGNATURE-----\n", "payload": "tree 7e7477a351daf97a0eb4854856ea9c9448c49771\nparent b03fa1a3fe02cd0087982cc22bda7598a9fc39eb\nparent 5e46d8675cd924e981aac9fd6ca146d627e9d4ab\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1666785774 +0530\ncommitter GitHub <noreply@github.com> 1666785774 +0530\n\nRollup merge of #103428 - SarthakSingh31:issue-94187, r=compiler-errors\n\nRemoved verbose printing from the `PrettyPrinter` when printing constants\n\nPartially solves #94187 by completing the first step described in [this comment](https://github.com/rust-lang/rust/issues/94187#issuecomment-1282339909).\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ffde0f722e410f7ec1e271ee2688bac9a24ca539", "html_url": "https://github.com/rust-lang/rust/commit/ffde0f722e410f7ec1e271ee2688bac9a24ca539", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ffde0f722e410f7ec1e271ee2688bac9a24ca539/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b03fa1a3fe02cd0087982cc22bda7598a9fc39eb", "url": "https://api.github.com/repos/rust-lang/rust/commits/b03fa1a3fe02cd0087982cc22bda7598a9fc39eb", "html_url": "https://github.com/rust-lang/rust/commit/b03fa1a3fe02cd0087982cc22bda7598a9fc39eb"}, {"sha": "5e46d8675cd924e981aac9fd6ca146d627e9d4ab", "url": "https://api.github.com/repos/rust-lang/rust/commits/5e46d8675cd924e981aac9fd6ca146d627e9d4ab", "html_url": "https://github.com/rust-lang/rust/commit/5e46d8675cd924e981aac9fd6ca146d627e9d4ab"}], "stats": {"total": 29, "additions": 24, "deletions": 5}, "files": [{"sha": "ffdb8de5b6c8c355b1fad36cb5b0e09f20932f67", "filename": "compiler/rustc_const_eval/src/interpret/intrinsics/type_name.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ffde0f722e410f7ec1e271ee2688bac9a24ca539/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics%2Ftype_name.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffde0f722e410f7ec1e271ee2688bac9a24ca539/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics%2Ftype_name.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics%2Ftype_name.rs?ref=ffde0f722e410f7ec1e271ee2688bac9a24ca539", "patch": "@@ -4,7 +4,7 @@ use rustc_hir::definitions::DisambiguatedDefPathData;\n use rustc_middle::mir::interpret::{Allocation, ConstAllocation};\n use rustc_middle::ty::{\n     self,\n-    print::{PrettyPrinter, Print, Printer},\n+    print::{with_no_verbose_constants, PrettyPrinter, Print, Printer},\n     subst::{GenericArg, GenericArgKind},\n     Ty, TyCtxt,\n };\n@@ -190,7 +190,9 @@ impl Write for AbsolutePathPrinter<'_> {\n \n /// Directly returns an `Allocation` containing an absolute path representation of the given type.\n pub(crate) fn alloc_type_name<'tcx>(tcx: TyCtxt<'tcx>, ty: Ty<'tcx>) -> ConstAllocation<'tcx> {\n-    let path = AbsolutePathPrinter { tcx, path: String::new() }.print_type(ty).unwrap().path;\n+    let path = with_no_verbose_constants!(\n+        AbsolutePathPrinter { tcx, path: String::new() }.print_type(ty).unwrap().path\n+    );\n     let alloc = Allocation::from_bytes_byte_aligned_immutable(path.into_bytes());\n     tcx.intern_const_alloc(alloc)\n }"}, {"sha": "c1c2e162f28399bd1c43563edc4d4c9dfad734e1", "filename": "compiler/rustc_middle/src/ty/print/pretty.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ffde0f722e410f7ec1e271ee2688bac9a24ca539/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffde0f722e410f7ec1e271ee2688bac9a24ca539/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs?ref=ffde0f722e410f7ec1e271ee2688bac9a24ca539", "patch": "@@ -63,6 +63,7 @@ thread_local! {\n     static NO_TRIMMED_PATH: Cell<bool> = const { Cell::new(false) };\n     static NO_QUERIES: Cell<bool> = const { Cell::new(false) };\n     static NO_VISIBLE_PATH: Cell<bool> = const { Cell::new(false) };\n+    static NO_VERBOSE_CONSTANTS: Cell<bool> = const { Cell::new(false) };\n }\n \n macro_rules! define_helper {\n@@ -117,6 +118,9 @@ define_helper!(\n     /// Prevent selection of visible paths. `Display` impl of DefId will prefer\n     /// visible (public) reexports of types as paths.\n     fn with_no_visible_paths(NoVisibleGuard, NO_VISIBLE_PATH);\n+    /// Prevent verbose printing of constants. Verbose printing of constants is\n+    /// never desirable in some contexts like `std::any::type_name`.\n+    fn with_no_verbose_constants(NoVerboseConstantsGuard, NO_VERBOSE_CONSTANTS);\n );\n \n /// The \"region highlights\" are used to control region printing during\n@@ -759,7 +763,7 @@ pub trait PrettyPrinter<'tcx>:\n             }\n             ty::Array(ty, sz) => {\n                 p!(\"[\", print(ty), \"; \");\n-                if self.tcx().sess.verbose() {\n+                if !NO_VERBOSE_CONSTANTS.with(|flag| flag.get()) && self.tcx().sess.verbose() {\n                     p!(write(\"{:?}\", sz));\n                 } else if let ty::ConstKind::Unevaluated(..) = sz.kind() {\n                     // Do not try to evaluate unevaluated constants. If we are const evaluating an\n@@ -1181,7 +1185,7 @@ pub trait PrettyPrinter<'tcx>:\n     ) -> Result<Self::Const, Self::Error> {\n         define_scoped_cx!(self);\n \n-        if self.tcx().sess.verbose() {\n+        if !NO_VERBOSE_CONSTANTS.with(|flag| flag.get()) && self.tcx().sess.verbose() {\n             p!(write(\"Const({:?}: {:?})\", ct.kind(), ct.ty()));\n             return Ok(self);\n         }\n@@ -1416,7 +1420,7 @@ pub trait PrettyPrinter<'tcx>:\n     ) -> Result<Self::Const, Self::Error> {\n         define_scoped_cx!(self);\n \n-        if self.tcx().sess.verbose() {\n+        if !NO_VERBOSE_CONSTANTS.with(|flag| flag.get()) && self.tcx().sess.verbose() {\n             p!(write(\"ValTree({:?}: \", valtree), print(ty), \")\");\n             return Ok(self);\n         }"}, {"sha": "902ef5ade2b0eb01844c9634f01aa06e3285582d", "filename": "src/test/ui/type/issue-94187-verbose-type-name.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/ffde0f722e410f7ec1e271ee2688bac9a24ca539/src%2Ftest%2Fui%2Ftype%2Fissue-94187-verbose-type-name.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffde0f722e410f7ec1e271ee2688bac9a24ca539/src%2Ftest%2Fui%2Ftype%2Fissue-94187-verbose-type-name.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftype%2Fissue-94187-verbose-type-name.rs?ref=ffde0f722e410f7ec1e271ee2688bac9a24ca539", "patch": "@@ -0,0 +1,13 @@\n+// Check to insure that the output of `std::any::type_name` does not change based on -Zverbose\n+// when printing constants\n+// run-pass\n+// edition: 2018\n+// revisions: normal verbose\n+// [verbose]compile-flags:-Zverbose\n+\n+struct Wrapper<const VALUE: usize>;\n+\n+fn main() {\n+    assert_eq!(std::any::type_name::<[u32; 0]>(), \"[u32; 0]\");\n+    assert_eq!(std::any::type_name::<Wrapper<0>>(), \"issue_94187_verbose_type_name::Wrapper<0>\");\n+}"}]}