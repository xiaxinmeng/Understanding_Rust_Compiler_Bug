{"sha": "7e17b98d17f2496dd00331ebd481d343f37654b2", "node_id": "C_kwDOAAsO6NoAKDdlMTdiOThkMTdmMjQ5NmRkMDAzMzFlYmQ0ODFkMzQzZjM3NjU0YjI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-09T10:29:28Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-09T10:29:28Z"}, "message": "Auto merge of #14111 - lnicola:squash-proc-macro-server-warning, r=Veykril\n\nfix: Hide proc macro server version detection errors\n\nThese are harmless, but users tend to blame other things on them.", "tree": {"sha": "b75687038e3800b7f7110c9a589f4ad069141c85", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b75687038e3800b7f7110c9a589f4ad069141c85"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7e17b98d17f2496dd00331ebd481d343f37654b2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7e17b98d17f2496dd00331ebd481d343f37654b2", "html_url": "https://github.com/rust-lang/rust/commit/7e17b98d17f2496dd00331ebd481d343f37654b2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7e17b98d17f2496dd00331ebd481d343f37654b2/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "313a48057aa0f628bd268a8d0305001197e27f7e", "url": "https://api.github.com/repos/rust-lang/rust/commits/313a48057aa0f628bd268a8d0305001197e27f7e", "html_url": "https://github.com/rust-lang/rust/commit/313a48057aa0f628bd268a8d0305001197e27f7e"}, {"sha": "8828f3494e307e715bea9c0d4d993ad4e550314b", "url": "https://api.github.com/repos/rust-lang/rust/commits/8828f3494e307e715bea9c0d4d993ad4e550314b", "html_url": "https://github.com/rust-lang/rust/commit/8828f3494e307e715bea9c0d4d993ad4e550314b"}], "stats": {"total": 15, "additions": 9, "deletions": 6}, "files": [{"sha": "1ccbd780fdda33067a2ffe140906de8955a5a156", "filename": "crates/proc-macro-api/src/process.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/7e17b98d17f2496dd00331ebd481d343f37654b2/crates%2Fproc-macro-api%2Fsrc%2Fprocess.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e17b98d17f2496dd00331ebd481d343f37654b2/crates%2Fproc-macro-api%2Fsrc%2Fprocess.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc-macro-api%2Fsrc%2Fprocess.rs?ref=7e17b98d17f2496dd00331ebd481d343f37654b2", "patch": "@@ -27,13 +27,13 @@ impl ProcMacroProcessSrv {\n         process_path: AbsPathBuf,\n         args: impl IntoIterator<Item = impl AsRef<OsStr>> + Clone,\n     ) -> io::Result<ProcMacroProcessSrv> {\n-        let create_srv = || {\n-            let mut process = Process::run(process_path.clone(), args.clone())?;\n+        let create_srv = |null_stderr| {\n+            let mut process = Process::run(process_path.clone(), args.clone(), null_stderr)?;\n             let (stdin, stdout) = process.stdio().expect(\"couldn't access child stdio\");\n \n             io::Result::Ok(ProcMacroProcessSrv { _process: process, stdin, stdout, version: 0 })\n         };\n-        let mut srv = create_srv()?;\n+        let mut srv = create_srv(true)?;\n         tracing::info!(\"sending version check\");\n         match srv.version_check() {\n             Ok(v) if v > CURRENT_API_VERSION => Err(io::Error::new(\n@@ -45,12 +45,13 @@ impl ProcMacroProcessSrv {\n             )),\n             Ok(v) => {\n                 tracing::info!(\"got version {v}\");\n+                srv = create_srv(false)?;\n                 srv.version = v;\n                 Ok(srv)\n             }\n             Err(e) => {\n                 tracing::info!(%e, \"proc-macro version check failed, restarting and assuming version 0\");\n-                create_srv()\n+                create_srv(false)\n             }\n         }\n     }\n@@ -98,9 +99,10 @@ impl Process {\n     fn run(\n         path: AbsPathBuf,\n         args: impl IntoIterator<Item = impl AsRef<OsStr>>,\n+        null_stderr: bool,\n     ) -> io::Result<Process> {\n         let args: Vec<OsString> = args.into_iter().map(|s| s.as_ref().into()).collect();\n-        let child = JodChild(mk_child(&path, args)?);\n+        let child = JodChild(mk_child(&path, args, null_stderr)?);\n         Ok(Process { child })\n     }\n \n@@ -116,13 +118,14 @@ impl Process {\n fn mk_child(\n     path: &AbsPath,\n     args: impl IntoIterator<Item = impl AsRef<OsStr>>,\n+    null_stderr: bool,\n ) -> io::Result<Child> {\n     Command::new(path.as_os_str())\n         .args(args)\n         .env(\"RUST_ANALYZER_INTERNALS_DO_NOT_USE\", \"this is unstable\")\n         .stdin(Stdio::piped())\n         .stdout(Stdio::piped())\n-        .stderr(Stdio::inherit())\n+        .stderr(if null_stderr { Stdio::null() } else { Stdio::inherit() })\n         .spawn()\n }\n "}]}