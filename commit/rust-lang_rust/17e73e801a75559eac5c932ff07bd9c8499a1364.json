{"sha": "17e73e801a75559eac5c932ff07bd9c8499a1364", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE3ZTczZTgwMWE3NTU1OWVhYzVjOTMyZmYwN2JkOWM4NDk5YTEzNjQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-08-28T17:49:37Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-08-28T17:49:37Z"}, "message": "Auto merge of #63875 - philipc:issue-57822, r=michaelwoerister\n\ndebuginfo: give unique names to closure and generator types\n\nClosure types have been moved to the namespace where they\nare defined, and both closure and generator type names now\ninclude the disambiguator.\n\nThis fixes an exception when lldb prints nested closures.\n\nFixes #57822\n\nI haven't included the `DW_AT_artificial` changes discussed in #57822 because they make the output worse IMO, but I can easily add these if still required. For example, for the new test case the output is now:\n```\n(lldb) p g\n(issue_57822::main::closure-1) $1 = closure-1(closure(1))\n```\nbut adding `DW_AT_artificial` changes this to:\n```\n(lldb) p g\n(issue_57822::main::closure-1) $0 = closure-1 {\n\n}\n```\n\nNote that nested generators didn't cause the exception. I haven't determined why, but I think it makes sense to add the disambiguator for them too. It feels like we still don't really understand why closures were causing an error though.\n\nr? @michaelwoerister", "tree": {"sha": "d961146b748423e806c5be7aa5b7168ee41af23b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d961146b748423e806c5be7aa5b7168ee41af23b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/17e73e801a75559eac5c932ff07bd9c8499a1364", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/17e73e801a75559eac5c932ff07bd9c8499a1364", "html_url": "https://github.com/rust-lang/rust/commit/17e73e801a75559eac5c932ff07bd9c8499a1364", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/17e73e801a75559eac5c932ff07bd9c8499a1364/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c4223726c354642705d87b9837933e3c3f38a2d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/c4223726c354642705d87b9837933e3c3f38a2d8", "html_url": "https://github.com/rust-lang/rust/commit/c4223726c354642705d87b9837933e3c3f38a2d8"}, {"sha": "61ff27aa1cc71042a7f3699713d38b1d1ed2b4c5", "url": "https://api.github.com/repos/rust-lang/rust/commits/61ff27aa1cc71042a7f3699713d38b1d1ed2b4c5", "html_url": "https://github.com/rust-lang/rust/commit/61ff27aa1cc71042a7f3699713d38b1d1ed2b4c5"}], "stats": {"total": 95, "additions": 80, "deletions": 15}, "files": [{"sha": "928532a1f4760f60cf2db0c5b01566ce3ddf87d6", "filename": "src/librustc_codegen_llvm/debuginfo/metadata.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/17e73e801a75559eac5c932ff07bd9c8499a1364/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17e73e801a75559eac5c932ff07bd9c8499a1364/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs?ref=17e73e801a75559eac5c932ff07bd9c8499a1364", "patch": "@@ -683,11 +683,13 @@ pub fn type_metadata(\n         }\n         ty::Closure(def_id, substs) => {\n             let upvar_tys : Vec<_> = substs.upvar_tys(def_id, cx.tcx).collect();\n+            let containing_scope = get_namespace_for_item(cx, def_id);\n             prepare_tuple_metadata(cx,\n                                    t,\n                                    &upvar_tys,\n                                    unique_type_id,\n-                                   usage_site_span).finalize(cx)\n+                                   usage_site_span,\n+                                   Some(containing_scope)).finalize(cx)\n         }\n         ty::Generator(def_id, substs,  _) => {\n             let upvar_tys : Vec<_> = substs.prefix_tys(def_id, cx.tcx).map(|t| {\n@@ -728,7 +730,8 @@ pub fn type_metadata(\n                                    t,\n                                    &tys,\n                                    unique_type_id,\n-                                   usage_site_span).finalize(cx)\n+                                   usage_site_span,\n+                                   NO_SCOPE_METADATA).finalize(cx)\n         }\n         _ => {\n             bug!(\"debuginfo: unexpected type in type_metadata: {:?}\", t)\n@@ -1205,14 +1208,15 @@ fn prepare_tuple_metadata(\n     component_types: &[Ty<'tcx>],\n     unique_type_id: UniqueTypeId,\n     span: Span,\n+    containing_scope: Option<&'ll DIScope>,\n ) -> RecursiveTypeDescription<'ll, 'tcx> {\n     let tuple_name = compute_debuginfo_type_name(cx.tcx, tuple_type, false);\n \n     let struct_stub = create_struct_stub(cx,\n                                          tuple_type,\n                                          &tuple_name[..],\n                                          unique_type_id,\n-                                         NO_SCOPE_METADATA);\n+                                         containing_scope);\n \n     create_and_register_recursive_type_forward_declaration(\n         cx,"}, {"sha": "9b5ad94ecd7cbbc145f9f31b8ab405752c7a98e4", "filename": "src/librustc_codegen_ssa/debuginfo/type_names.rs", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/17e73e801a75559eac5c932ff07bd9c8499a1364/src%2Flibrustc_codegen_ssa%2Fdebuginfo%2Ftype_names.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17e73e801a75559eac5c932ff07bd9c8499a1364/src%2Flibrustc_codegen_ssa%2Fdebuginfo%2Ftype_names.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fdebuginfo%2Ftype_names.rs?ref=17e73e801a75559eac5c932ff07bd9c8499a1364", "patch": "@@ -190,11 +190,17 @@ pub fn push_debuginfo_type_name<'tcx>(\n             // processing\n             visited.remove(t);\n         },\n-        ty::Closure(..) => {\n-            output.push_str(\"closure\");\n+        ty::Closure(def_id, ..) => {\n+            output.push_str(&format!(\n+                \"closure-{}\",\n+                tcx.def_key(def_id).disambiguated_data.disambiguator\n+            ));\n         }\n-        ty::Generator(..) => {\n-            output.push_str(\"generator\");\n+        ty::Generator(def_id, ..) => {\n+            output.push_str(&format!(\n+                \"generator-{}\",\n+                tcx.def_key(def_id).disambiguated_data.disambiguator\n+            ));\n         }\n         ty::Error |\n         ty::Infer(_) |"}, {"sha": "bfa7a05cad057bc661083975c768749305d14c74", "filename": "src/test/debuginfo/generator-objects.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/17e73e801a75559eac5c932ff07bd9c8499a1364/src%2Ftest%2Fdebuginfo%2Fgenerator-objects.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17e73e801a75559eac5c932ff07bd9c8499a1364/src%2Ftest%2Fdebuginfo%2Fgenerator-objects.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fdebuginfo%2Fgenerator-objects.rs?ref=17e73e801a75559eac5c932ff07bd9c8499a1364", "patch": "@@ -10,31 +10,31 @@\n \n // gdb-command:run\n // gdb-command:print b\n-// gdb-check:$1 = generator_objects::main::generator {__0: 0x[...], <<variant>>: {__state: 0, 0: generator_objects::main::generator::Unresumed, 1: generator_objects::main::generator::Returned, 2: generator_objects::main::generator::Panicked, 3: generator_objects::main::generator::Suspend0 {[...]}, 4: generator_objects::main::generator::Suspend1 {[...]}}}\n+// gdb-check:$1 = generator_objects::main::generator-0 {__0: 0x[...], <<variant>>: {__state: 0, 0: generator_objects::main::generator-0::Unresumed, 1: generator_objects::main::generator-0::Returned, 2: generator_objects::main::generator-0::Panicked, 3: generator_objects::main::generator-0::Suspend0 {[...]}, 4: generator_objects::main::generator-0::Suspend1 {[...]}}}\n // gdb-command:continue\n // gdb-command:print b\n-// gdb-check:$2 = generator_objects::main::generator {__0: 0x[...], <<variant>>: {__state: 3, 0: generator_objects::main::generator::Unresumed, 1: generator_objects::main::generator::Returned, 2: generator_objects::main::generator::Panicked, 3: generator_objects::main::generator::Suspend0 {c: 6, d: 7}, 4: generator_objects::main::generator::Suspend1 {[...]}}}\n+// gdb-check:$2 = generator_objects::main::generator-0 {__0: 0x[...], <<variant>>: {__state: 3, 0: generator_objects::main::generator-0::Unresumed, 1: generator_objects::main::generator-0::Returned, 2: generator_objects::main::generator-0::Panicked, 3: generator_objects::main::generator-0::Suspend0 {c: 6, d: 7}, 4: generator_objects::main::generator-0::Suspend1 {[...]}}}\n // gdb-command:continue\n // gdb-command:print b\n-// gdb-check:$3 = generator_objects::main::generator {__0: 0x[...], <<variant>>: {__state: 4, 0: generator_objects::main::generator::Unresumed, 1: generator_objects::main::generator::Returned, 2: generator_objects::main::generator::Panicked, 3: generator_objects::main::generator::Suspend0 {[...]}, 4: generator_objects::main::generator::Suspend1 {c: 7, d: 8}}}\n+// gdb-check:$3 = generator_objects::main::generator-0 {__0: 0x[...], <<variant>>: {__state: 4, 0: generator_objects::main::generator-0::Unresumed, 1: generator_objects::main::generator-0::Returned, 2: generator_objects::main::generator-0::Panicked, 3: generator_objects::main::generator-0::Suspend0 {[...]}, 4: generator_objects::main::generator-0::Suspend1 {c: 7, d: 8}}}\n // gdb-command:continue\n // gdb-command:print b\n-// gdb-check:$4 = generator_objects::main::generator {__0: 0x[...], <<variant>>: {__state: 1, 0: generator_objects::main::generator::Unresumed, 1: generator_objects::main::generator::Returned, 2: generator_objects::main::generator::Panicked, 3: generator_objects::main::generator::Suspend0 {[...]}, 4: generator_objects::main::generator::Suspend1 {[...]}}}\n+// gdb-check:$4 = generator_objects::main::generator-0 {__0: 0x[...], <<variant>>: {__state: 1, 0: generator_objects::main::generator-0::Unresumed, 1: generator_objects::main::generator-0::Returned, 2: generator_objects::main::generator-0::Panicked, 3: generator_objects::main::generator-0::Suspend0 {[...]}, 4: generator_objects::main::generator-0::Suspend1 {[...]}}}\n \n // === LLDB TESTS ==================================================================================\n \n // lldb-command:run\n // lldb-command:print b\n-// lldbg-check:(generator_objects::main::generator) $0 = generator(&0x[...])\n+// lldbg-check:(generator_objects::main::generator-0) $0 = generator-0(&0x[...])\n // lldb-command:continue\n // lldb-command:print b\n-// lldbg-check:(generator_objects::main::generator) $1 = generator(&0x[...])\n+// lldbg-check:(generator_objects::main::generator-0) $1 = generator-0(&0x[...])\n // lldb-command:continue\n // lldb-command:print b\n-// lldbg-check:(generator_objects::main::generator) $2 = generator(&0x[...])\n+// lldbg-check:(generator_objects::main::generator-0) $2 = generator-0(&0x[...])\n // lldb-command:continue\n // lldb-command:print b\n-// lldbg-check:(generator_objects::main::generator) $3 = generator(&0x[...])\n+// lldbg-check:(generator_objects::main::generator-0) $3 = generator-0(&0x[...])\n \n #![feature(omit_gdb_pretty_printer_section, generators, generator_trait)]\n #![omit_gdb_pretty_printer_section]"}, {"sha": "f18e41db0e6babaae474524c1d3cdcec06bb190c", "filename": "src/test/debuginfo/issue-57822.rs", "status": "added", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/17e73e801a75559eac5c932ff07bd9c8499a1364/src%2Ftest%2Fdebuginfo%2Fissue-57822.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17e73e801a75559eac5c932ff07bd9c8499a1364/src%2Ftest%2Fdebuginfo%2Fissue-57822.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fdebuginfo%2Fissue-57822.rs?ref=17e73e801a75559eac5c932ff07bd9c8499a1364", "patch": "@@ -0,0 +1,55 @@\n+// This test makes sure that the LLDB pretty printer does not throw an exception\n+// for nested closures and generators.\n+\n+// Require LLVM with DW_TAG_variant_part and a gdb that can read it.\n+// min-system-llvm-version: 8.0\n+// min-gdb-version: 8.2\n+// ignore-tidy-linelength\n+\n+// compile-flags:-g\n+\n+// === GDB TESTS ===================================================================================\n+\n+// gdb-command:run\n+\n+// gdb-command:print g\n+// gdb-check:$1 = issue_57822::main::closure-1 (issue_57822::main::closure-0 (1))\n+\n+// gdb-command:print b\n+// gdb-check:$2 = issue_57822::main::generator-3 {__0: issue_57822::main::generator-2 {__0: 2, <<variant>>: {[...]}}, <<variant>>: {[...]}}\n+\n+// === LLDB TESTS ==================================================================================\n+\n+// lldb-command:run\n+\n+// lldb-command:print g\n+// lldbg-check:(issue_57822::main::closure-1) $0 = closure-1(closure-0(1))\n+\n+// lldb-command:print b\n+// lldbg-check:(issue_57822::main::generator-3) $1 = generator-3(generator-2(2))\n+\n+#![feature(omit_gdb_pretty_printer_section, generators, generator_trait)]\n+#![omit_gdb_pretty_printer_section]\n+\n+use std::ops::Generator;\n+use std::pin::Pin;\n+\n+fn main() {\n+    let mut x = 1;\n+    let f = move || x;\n+    let g = move || f();\n+\n+    let mut y = 2;\n+    let mut a = move || {\n+        y += 1;\n+        yield;\n+    };\n+    let mut b = move || {\n+        Pin::new(&mut a).resume();\n+        yield;\n+    };\n+\n+    zzz(); // #break\n+}\n+\n+fn zzz() { () }"}]}