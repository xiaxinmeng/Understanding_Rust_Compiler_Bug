{"sha": "cbbb188ea9f0795d5ffe8b25734fbe644d40d964", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNiYmIxODhlYTlmMDc5NWQ1ZmZlOGIyNTczNGZiZTY0NGQ0MGQ5NjQ=", "commit": {"author": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2020-12-31T16:50:00Z"}, "committer": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2021-01-04T15:08:22Z"}, "message": "Bless only updated since clippy build", "tree": {"sha": "c6d6173a8ce30acf70e3a9dca339bf481534f752", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c6d6173a8ce30acf70e3a9dca339bf481534f752"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cbbb188ea9f0795d5ffe8b25734fbe644d40d964", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cbbb188ea9f0795d5ffe8b25734fbe644d40d964", "html_url": "https://github.com/rust-lang/rust/commit/cbbb188ea9f0795d5ffe8b25734fbe644d40d964", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cbbb188ea9f0795d5ffe8b25734fbe644d40d964/comments", "author": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ae9ae9713c01f9aca4388a71cd8f6b736c69a9bf", "url": "https://api.github.com/repos/rust-lang/rust/commits/ae9ae9713c01f9aca4388a71cd8f6b736c69a9bf", "html_url": "https://github.com/rust-lang/rust/commit/ae9ae9713c01f9aca4388a71cd8f6b736c69a9bf"}], "stats": {"total": 50, "additions": 40, "deletions": 10}, "files": [{"sha": "529f1161a0f78c93d201d7b5f675ec06c97e61bd", "filename": "clippy_dev/src/bless.rs", "status": "modified", "additions": 29, "deletions": 7, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/cbbb188ea9f0795d5ffe8b25734fbe644d40d964/clippy_dev%2Fsrc%2Fbless.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbbb188ea9f0795d5ffe8b25734fbe644d40d964/clippy_dev%2Fsrc%2Fbless.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Fbless.rs?ref=cbbb188ea9f0795d5ffe8b25734fbe644d40d964", "patch": "@@ -5,7 +5,7 @@ use std::env;\n use std::ffi::OsStr;\n use std::fs;\n use std::lazy::SyncLazy;\n-use std::path::PathBuf;\n+use std::path::{Path, PathBuf};\n use walkdir::WalkDir;\n \n use crate::clippy_project_root;\n@@ -16,7 +16,15 @@ pub static CARGO_TARGET_DIR: SyncLazy<PathBuf> = SyncLazy::new(|| match env::var\n     None => env::current_dir().unwrap().join(\"target\"),\n });\n \n-pub fn bless() {\n+static CLIPPY_BUILD_TIME: SyncLazy<Option<std::time::SystemTime>> = SyncLazy::new(|| {\n+    let profile = env::var(\"PROFILE\").unwrap_or_else(|_| \"debug\".to_string());\n+    let mut path = PathBuf::from(&**CARGO_TARGET_DIR);\n+    path.push(profile);\n+    path.push(\"cargo-clippy\");\n+    fs::metadata(path).ok()?.modified().ok()\n+});\n+\n+pub fn bless(ignore_timestamp: bool) {\n     let test_suite_dirs = [\n         clippy_project_root().join(\"tests\").join(\"ui\"),\n         clippy_project_root().join(\"tests\").join(\"ui-toml\"),\n@@ -29,15 +37,18 @@ pub fn bless() {\n             .filter(|f| f.path().extension() == Some(OsStr::new(\"rs\")))\n             .for_each(|f| {\n                 let test_name = f.path().strip_prefix(test_suite_dir).unwrap();\n-\n-                update_reference_file(f.path().with_extension(\"stdout\"), test_name.with_extension(\"stdout\"));\n-                update_reference_file(f.path().with_extension(\"stderr\"), test_name.with_extension(\"stderr\"));\n-                update_reference_file(f.path().with_extension(\"fixed\"), test_name.with_extension(\"fixed\"));\n+                for &ext in &[\"stdout\", \"stderr\", \"fixed\"] {\n+                    update_reference_file(\n+                        f.path().with_extension(ext),\n+                        test_name.with_extension(ext),\n+                        ignore_timestamp,\n+                    );\n+                }\n             });\n     }\n }\n \n-fn update_reference_file(reference_file_path: PathBuf, test_name: PathBuf) {\n+fn update_reference_file(reference_file_path: PathBuf, test_name: PathBuf, ignore_timestamp: bool) {\n     let test_output_path = build_dir().join(test_name);\n     let relative_reference_file_path = reference_file_path.strip_prefix(clippy_project_root()).unwrap();\n \n@@ -47,6 +58,11 @@ fn update_reference_file(reference_file_path: PathBuf, test_name: PathBuf) {\n         return;\n     }\n \n+    // If the test output was not updated since the last clippy build, it may be outdated\n+    if !ignore_timestamp && !updated_since_clippy_build(&test_output_path).unwrap_or(true) {\n+        return;\n+    }\n+\n     let test_output_file = fs::read(&test_output_path).expect(\"Unable to read test output file\");\n     let reference_file = fs::read(&reference_file_path).unwrap_or_default();\n \n@@ -66,6 +82,12 @@ fn update_reference_file(reference_file_path: PathBuf, test_name: PathBuf) {\n     }\n }\n \n+fn updated_since_clippy_build(path: &Path) -> Option<bool> {\n+    let clippy_build_time = (*CLIPPY_BUILD_TIME)?;\n+    let modified = fs::metadata(path).ok()?.modified().ok()?;\n+    Some(modified >= clippy_build_time)\n+}\n+\n fn build_dir() -> PathBuf {\n     let profile = env::var(\"PROFILE\").unwrap_or_else(|_| \"debug\".to_string());\n     let mut path = PathBuf::new();"}, {"sha": "2ea56c42fafd62316adc779fa60b5922b70ced30", "filename": "clippy_dev/src/main.rs", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/cbbb188ea9f0795d5ffe8b25734fbe644d40d964/clippy_dev%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbbb188ea9f0795d5ffe8b25734fbe644d40d964/clippy_dev%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Fmain.rs?ref=cbbb188ea9f0795d5ffe8b25734fbe644d40d964", "patch": "@@ -7,8 +7,8 @@ fn main() {\n     let matches = get_clap_config();\n \n     match matches.subcommand() {\n-        (\"bless\", Some(_)) => {\n-            bless::bless();\n+        (\"bless\", Some(matches)) => {\n+            bless::bless(matches.is_present(\"ignore-timestamp\"));\n         },\n         (\"fmt\", Some(matches)) => {\n             fmt::run(matches.is_present(\"check\"), matches.is_present(\"verbose\"));\n@@ -47,7 +47,15 @@ fn main() {\n \n fn get_clap_config<'a>() -> ArgMatches<'a> {\n     App::new(\"Clippy developer tooling\")\n-        .subcommand(SubCommand::with_name(\"bless\").about(\"bless the test output changes\"))\n+        .subcommand(\n+            SubCommand::with_name(\"bless\")\n+                .about(\"bless the test output changes\")\n+                .arg(\n+                    Arg::with_name(\"ignore-timestamp\")\n+                        .long(\"ignore-timestamp\")\n+                        .help(\"Include files updated before clippy was built\"),\n+                ),\n+        )\n         .subcommand(\n             SubCommand::with_name(\"fmt\")\n                 .about(\"Run rustfmt on all projects and tests\")"}]}