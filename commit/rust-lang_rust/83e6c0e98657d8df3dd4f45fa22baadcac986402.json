{"sha": "83e6c0e98657d8df3dd4f45fa22baadcac986402", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgzZTZjMGU5ODY1N2Q4ZGYzZGQ0ZjQ1ZmEyMmJhYWRjYWM5ODY0MDI=", "commit": {"author": {"name": "Andrew Paverd", "email": "andrew.paverd@microsoft.com", "date": "2020-06-16T16:44:03Z"}, "committer": {"name": "Andrew Paverd", "email": "andrew.paverd@microsoft.com", "date": "2020-06-16T16:44:03Z"}, "message": "Update CFGuard syntax", "tree": {"sha": "abc701f2a87883d84a3b6e97f87abc71f45972ac", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/abc701f2a87883d84a3b6e97f87abc71f45972ac"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/83e6c0e98657d8df3dd4f45fa22baadcac986402", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/83e6c0e98657d8df3dd4f45fa22baadcac986402", "html_url": "https://github.com/rust-lang/rust/commit/83e6c0e98657d8df3dd4f45fa22baadcac986402", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/83e6c0e98657d8df3dd4f45fa22baadcac986402/comments", "author": {"login": "ajpaverd", "id": 207321, "node_id": "MDQ6VXNlcjIwNzMyMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/207321?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ajpaverd", "html_url": "https://github.com/ajpaverd", "followers_url": "https://api.github.com/users/ajpaverd/followers", "following_url": "https://api.github.com/users/ajpaverd/following{/other_user}", "gists_url": "https://api.github.com/users/ajpaverd/gists{/gist_id}", "starred_url": "https://api.github.com/users/ajpaverd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ajpaverd/subscriptions", "organizations_url": "https://api.github.com/users/ajpaverd/orgs", "repos_url": "https://api.github.com/users/ajpaverd/repos", "events_url": "https://api.github.com/users/ajpaverd/events{/privacy}", "received_events_url": "https://api.github.com/users/ajpaverd/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ajpaverd", "id": 207321, "node_id": "MDQ6VXNlcjIwNzMyMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/207321?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ajpaverd", "html_url": "https://github.com/ajpaverd", "followers_url": "https://api.github.com/users/ajpaverd/followers", "following_url": "https://api.github.com/users/ajpaverd/following{/other_user}", "gists_url": "https://api.github.com/users/ajpaverd/gists{/gist_id}", "starred_url": "https://api.github.com/users/ajpaverd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ajpaverd/subscriptions", "organizations_url": "https://api.github.com/users/ajpaverd/orgs", "repos_url": "https://api.github.com/users/ajpaverd/repos", "events_url": "https://api.github.com/users/ajpaverd/events{/privacy}", "received_events_url": "https://api.github.com/users/ajpaverd/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c8a9c340de32cb70c8bad8af1a4474f805c5a969", "url": "https://api.github.com/repos/rust-lang/rust/commits/c8a9c340de32cb70c8bad8af1a4474f805c5a969", "html_url": "https://github.com/rust-lang/rust/commit/c8a9c340de32cb70c8bad8af1a4474f805c5a969"}], "stats": {"total": 53, "additions": 33, "deletions": 20}, "files": [{"sha": "087b0da74e5e1946aa0476a4abd5c204f09adc31", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=83e6c0e98657d8df3dd4f45fa22baadcac986402", "patch": "@@ -1176,7 +1176,7 @@ impl<'a> Builder<'a> {\n             );\n         }\n \n-        // If Control Flow Guard is enabled, pass the `control_flow_guard=checks` flag to rustc\n+        // If Control Flow Guard is enabled, pass the `control-flow-guard` flag to rustc\n         // when compiling the standard library, since this might be linked into the final outputs\n         // produced by rustc. Since this mitigation is only available on Windows, only enable it\n         // for the standard library in case the compiler is run on a non-Windows platform.\n@@ -1187,7 +1187,7 @@ impl<'a> Builder<'a> {\n             && self.config.control_flow_guard\n             && compiler.stage >= 1\n         {\n-            rustflags.arg(\"-Zcontrol_flow_guard=checks\");\n+            rustflags.arg(\"-Zcontrol-flow-guard\");\n         }\n \n         // For `cargo doc` invocations, make rustdoc print the Rust version into the docs"}, {"sha": "4115825e920838947ab4dee93124a1811980daaf", "filename": "src/doc/unstable-book/src/compiler-flags/control-flow-guard.md", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fcontrol-flow-guard.md", "raw_url": "https://github.com/rust-lang/rust/raw/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fcontrol-flow-guard.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fcontrol-flow-guard.md?ref=83e6c0e98657d8df3dd4f45fa22baadcac986402", "patch": "@@ -1,10 +1,10 @@\n-# `control_flow_guard`\n+# `control-flow-guard`\n \n The tracking issue for this feature is: [#68793](https://github.com/rust-lang/rust/issues/68793).\n \n ------------------------\n \n-The rustc flag `-Z control_flow_guard=checks` enables the Windows [Control Flow Guard](https://docs.microsoft.com/en-us/windows/win32/secbp/control-flow-guard) (CFG) platform security feature.\n+The rustc flag `-Z control-flow-guard` enables the Windows [Control Flow Guard](https://docs.microsoft.com/en-us/windows/win32/secbp/control-flow-guard) (CFG) platform security feature.\n \n CFG is an exploit mitigation designed to enforce control-flow integrity for software running on supported Windows platforms (Windows 8.1 onwards). Specifically, CFG uses runtime checks to validate the target address of every indirect call/jump before allowing the call to complete. \n \n@@ -29,7 +29,7 @@ The CFG checks and metadata can potentially increase binary size and runtime ove\n \n ## Testing Control Flow Guard\n \n-The rustc flag `-Z control_flow_guard=nochecks` instructs LLVM to emit the list of valid call targets without inserting runtime checks. This flag should only be used for testing purposes as it does not provide security enforcement.\n+The rustc flag `-Z control-flow-guard=nochecks` instructs LLVM to emit the list of valid call targets without inserting runtime checks. This flag should only be used for testing purposes as it does not provide security enforcement.\n \n \n ## Control Flow Guard in libraries\n@@ -44,14 +44,14 @@ For example:\n ```cmd\n rustup toolchain install --force nightly\n rustup component add rust-src\n-SET RUSTFLAGS=-Z control_flow_guard=checks\n+SET RUSTFLAGS=-Z control-flow-guard\n cargo +nightly build -Z build-std --target x86_64-pc-windows-msvc\n ```\n \n ```PowerShell\n rustup toolchain install --force nightly\n rustup component add rust-src\n-$Env:RUSTFLAGS = \"-Z control_flow_guard=checks\"\n+$Env:RUSTFLAGS = \"-Z control-flow-guard\"\n cargo +nightly build -Z build-std --target x86_64-pc-windows-msvc\n ```\n "}, {"sha": "bbe2e8da12e7c68da063f1ee823ebcd4276ad029", "filename": "src/librustc_interface/tests.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Flibrustc_interface%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Flibrustc_interface%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Ftests.rs?ref=83e6c0e98657d8df3dd4f45fa22baadcac986402", "patch": "@@ -463,7 +463,6 @@ fn test_debugging_options_tracking_hash() {\n     untracked!(ast_json_noexpand, true);\n     untracked!(borrowck, String::from(\"other\"));\n     untracked!(borrowck_stats, true);\n-    untracked!(control_flow_guard, CFGuard::Checks);\n     untracked!(deduplicate_diagnostics, true);\n     untracked!(dep_tasks, true);\n     untracked!(dont_buffer_diagnostics, true);\n@@ -537,6 +536,7 @@ fn test_debugging_options_tracking_hash() {\n     tracked!(binary_dep_depinfo, true);\n     tracked!(chalk, true);\n     tracked!(codegen_backend, Some(\"abc\".to_string()));\n+    tracked!(control_flow_guard, CFGuard::Checks);\n     tracked!(crate_attr, vec![\"abc\".to_string()]);\n     tracked!(debug_macros, true);\n     tracked!(dep_info_omit_d_target, true);"}, {"sha": "562f71e8e92876c673a74448a4f15969ba05cfa2", "filename": "src/librustc_session/config.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Flibrustc_session%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Flibrustc_session%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Fconfig.rs?ref=83e6c0e98657d8df3dd4f45fa22baadcac986402", "patch": "@@ -82,7 +82,7 @@ pub enum Strip {\n     Symbols,\n }\n \n-/// The different settings that the `-Z control_flow_guard` flag can have.\n+/// The different settings that the `-Z control-flow-guard` flag can have.\n #[derive(Clone, Copy, PartialEq, Hash, Debug)]\n pub enum CFGuard {\n     /// Do not emit Control Flow Guard metadata or checks."}, {"sha": "e822e79bf4fa275bc5deed5ec5a8ed05bcacc878", "filename": "src/librustc_session/options.rs", "status": "modified", "additions": 21, "deletions": 8, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Flibrustc_session%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Flibrustc_session%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Foptions.rs?ref=83e6c0e98657d8df3dd4f45fa22baadcac986402", "patch": "@@ -251,7 +251,8 @@ macro_rules! options {\n         pub const parse_sanitizer: &str = \"one of: `address`, `leak`, `memory` or `thread`\";\n         pub const parse_sanitizer_list: &str = \"comma separated list of sanitizers\";\n         pub const parse_sanitizer_memory_track_origins: &str = \"0, 1, or 2\";\n-        pub const parse_cfguard: &str = \"either `disabled`, `nochecks`, or `checks`\";\n+        pub const parse_cfguard: &str =\n+            \"either a boolean (`yes`, `no`, `on`, `off`, etc), `checks`, or `nochecks`\";\n         pub const parse_strip: &str = \"either `none`, `debuginfo`, or `symbols`\";\n         pub const parse_linker_flavor: &str = ::rustc_target::spec::LinkerFlavor::one_of();\n         pub const parse_optimization_fuel: &str = \"crate=integer\";\n@@ -505,12 +506,24 @@ macro_rules! options {\n         }\n \n         fn parse_cfguard(slot: &mut CFGuard, v: Option<&str>) -> bool {\n-            match v {\n-                Some(\"disabled\") => *slot = CFGuard::Disabled,\n-                Some(\"nochecks\") => *slot = CFGuard::NoChecks,\n-                Some(\"checks\") => *slot = CFGuard::Checks,\n-                _ => return false,\n+            if v.is_some() {\n+                let mut bool_arg = None;\n+                if parse_opt_bool(&mut bool_arg, v) {\n+                    *slot = if bool_arg.unwrap() {\n+                        CFGuard::Checks\n+                    } else {\n+                        CFGuard::Disabled\n+                    };\n+                    return true\n+                }\n             }\n+\n+            *slot = match v {\n+                None => CFGuard::Checks,\n+                Some(\"checks\") => CFGuard::Checks,\n+                Some(\"nochecks\") => CFGuard::NoChecks,\n+                Some(_) => return false,\n+            };\n             true\n         }\n \n@@ -806,8 +819,8 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         \"enable the experimental Chalk-based trait solving engine\"),\n     codegen_backend: Option<String> = (None, parse_opt_string, [TRACKED],\n         \"the backend to use\"),\n-    control_flow_guard: CFGuard = (CFGuard::Disabled, parse_cfguard, [UNTRACKED],\n-        \"use Windows Control Flow Guard (`disabled`, `nochecks` or `checks`)\"),\n+    control_flow_guard: CFGuard = (CFGuard::Disabled, parse_cfguard, [TRACKED],\n+        \"use Windows Control Flow Guard (default: no)\"),\n     crate_attr: Vec<String> = (Vec::new(), parse_string_push, [TRACKED],\n         \"inject the given attribute in the crate\"),\n     debug_macros: bool = (false, parse_bool, [TRACKED],"}, {"sha": "96f9158f9d39498b17a23d3445c326822e2bb8b4", "filename": "src/test/codegen/cfguard_checks.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Ftest%2Fcodegen%2Fcfguard_checks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Ftest%2Fcodegen%2Fcfguard_checks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard_checks.rs?ref=83e6c0e98657d8df3dd4f45fa22baadcac986402", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z control_flow_guard=checks\n+// compile-flags: -Z control-flow-guard=checks\n \n #![crate_type = \"lib\"]\n "}, {"sha": "1325ffc0f2595d3b76505cdb40daebf94ba77318", "filename": "src/test/codegen/cfguard_disabled.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Ftest%2Fcodegen%2Fcfguard_disabled.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Ftest%2Fcodegen%2Fcfguard_disabled.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard_disabled.rs?ref=83e6c0e98657d8df3dd4f45fa22baadcac986402", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z control_flow_guard=disabled\n+// compile-flags: -Z control-flow-guard=no\n \n #![crate_type = \"lib\"]\n "}, {"sha": "ae1de4c4d26d543b6f6c7a1a309a9f04bf14064d", "filename": "src/test/codegen/cfguard_nochecks.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Ftest%2Fcodegen%2Fcfguard_nochecks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83e6c0e98657d8df3dd4f45fa22baadcac986402/src%2Ftest%2Fcodegen%2Fcfguard_nochecks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard_nochecks.rs?ref=83e6c0e98657d8df3dd4f45fa22baadcac986402", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z control_flow_guard=nochecks\n+// compile-flags: -Z control-flow-guard=nochecks\n \n #![crate_type = \"lib\"]\n "}]}