{"sha": "13c83f90ac0031b71bea8aa14d967b47647498bb", "node_id": "C_kwDOAAsO6NoAKDEzYzgzZjkwYWMwMDMxYjcxYmVhOGFhMTRkOTY3YjQ3NjQ3NDk4YmI", "commit": {"author": {"name": "Dorian Scheidt", "email": "dorian.scheidt@gmail.com", "date": "2022-07-23T00:06:14Z"}, "committer": {"name": "Dorian Scheidt", "email": "dorian.scheidt@gmail.com", "date": "2022-07-23T17:25:02Z"}, "message": "fix: Don't add braces to 'if' completion in match guard position\n\nWhen the cursor is in a match arm, but before the fat arrow (=>) token, don't\nadd braces when autocompleting \"if\".\n\nfixes #12823", "tree": {"sha": "2a1655e1da52c475f5cd3ca72c41973348afcd48", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2a1655e1da52c475f5cd3ca72c41973348afcd48"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/13c83f90ac0031b71bea8aa14d967b47647498bb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/13c83f90ac0031b71bea8aa14d967b47647498bb", "html_url": "https://github.com/rust-lang/rust/commit/13c83f90ac0031b71bea8aa14d967b47647498bb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/13c83f90ac0031b71bea8aa14d967b47647498bb/comments", "author": {"login": "DorianListens", "id": 5692947, "node_id": "MDQ6VXNlcjU2OTI5NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/5692947?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DorianListens", "html_url": "https://github.com/DorianListens", "followers_url": "https://api.github.com/users/DorianListens/followers", "following_url": "https://api.github.com/users/DorianListens/following{/other_user}", "gists_url": "https://api.github.com/users/DorianListens/gists{/gist_id}", "starred_url": "https://api.github.com/users/DorianListens/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DorianListens/subscriptions", "organizations_url": "https://api.github.com/users/DorianListens/orgs", "repos_url": "https://api.github.com/users/DorianListens/repos", "events_url": "https://api.github.com/users/DorianListens/events{/privacy}", "received_events_url": "https://api.github.com/users/DorianListens/received_events", "type": "User", "site_admin": false}, "committer": {"login": "DorianListens", "id": 5692947, "node_id": "MDQ6VXNlcjU2OTI5NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/5692947?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DorianListens", "html_url": "https://github.com/DorianListens", "followers_url": "https://api.github.com/users/DorianListens/followers", "following_url": "https://api.github.com/users/DorianListens/following{/other_user}", "gists_url": "https://api.github.com/users/DorianListens/gists{/gist_id}", "starred_url": "https://api.github.com/users/DorianListens/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DorianListens/subscriptions", "organizations_url": "https://api.github.com/users/DorianListens/orgs", "repos_url": "https://api.github.com/users/DorianListens/repos", "events_url": "https://api.github.com/users/DorianListens/events{/privacy}", "received_events_url": "https://api.github.com/users/DorianListens/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0b131bc78eece8be69b5d3633f4db04cf2c1151b", "url": "https://api.github.com/repos/rust-lang/rust/commits/0b131bc78eece8be69b5d3633f4db04cf2c1151b", "html_url": "https://github.com/rust-lang/rust/commit/0b131bc78eece8be69b5d3633f4db04cf2c1151b"}], "stats": {"total": 89, "additions": 88, "deletions": 1}, "files": [{"sha": "bdf6e64f09696d27660409743a8d42842e8f7751", "filename": "crates/ide-completion/src/completions/expr.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/13c83f90ac0031b71bea8aa14d967b47647498bb/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13c83f90ac0031b71bea8aa14d967b47647498bb/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fexpr.rs?ref=13c83f90ac0031b71bea8aa14d967b47647498bb", "patch": "@@ -21,6 +21,7 @@ pub(crate) fn complete_expr_path(\n         ref is_func_update,\n         ref innermost_ret_ty,\n         ref impl_,\n+        in_match_guard,\n         ..\n     }: &ExprCtx,\n ) {\n@@ -195,7 +196,11 @@ pub(crate) fn complete_expr_path(\n                 add_keyword(\"while\", \"while $1 {\\n    $0\\n}\");\n                 add_keyword(\"while let\", \"while let $1 = $2 {\\n    $0\\n}\");\n                 add_keyword(\"loop\", \"loop {\\n    $0\\n}\");\n-                add_keyword(\"if\", \"if $1 {\\n    $0\\n}\");\n+                if in_match_guard {\n+                    add_keyword(\"if\", \"if $0\");\n+                } else {\n+                    add_keyword(\"if\", \"if $1 {\\n    $0\\n}\");\n+                }\n                 add_keyword(\"if let\", \"if let $1 = $2 {\\n    $0\\n}\");\n                 add_keyword(\"for\", \"for $1 in $2 {\\n    $0\\n}\");\n                 add_keyword(\"true\", \"true\");"}, {"sha": "3989a451bde42a150f8cdb9910df50fe9de245cc", "filename": "crates/ide-completion/src/completions/keyword.rs", "status": "modified", "additions": 71, "deletions": 0, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/13c83f90ac0031b71bea8aa14d967b47647498bb/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fkeyword.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13c83f90ac0031b71bea8aa14d967b47647498bb/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fkeyword.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fkeyword.rs?ref=13c83f90ac0031b71bea8aa14d967b47647498bb", "patch": "@@ -163,4 +163,75 @@ fn main() {\n \"#,\n         );\n     }\n+\n+    #[test]\n+    fn if_completion_in_match_guard() {\n+        check_edit(\n+            \"if\",\n+            r\"\n+fn main() {\n+    match () {\n+        () $0\n+    }\n+}\n+\",\n+            r\"\n+fn main() {\n+    match () {\n+        () if $0\n+    }\n+}\n+\",\n+        )\n+    }\n+\n+    #[test]\n+    fn if_completion_in_match_arm_expr() {\n+        check_edit(\n+            \"if\",\n+            r\"\n+fn main() {\n+    match () {\n+        () => $0\n+    }\n+}\n+\",\n+            r\"\n+fn main() {\n+    match () {\n+        () => if $1 {\n+    $0\n+}\n+    }\n+}\n+\",\n+        )\n+    }\n+\n+    #[test]\n+    fn if_completion_in_match_arm_expr_block() {\n+        check_edit(\n+            \"if\",\n+            r\"\n+fn main() {\n+    match () {\n+        () => {\n+            $0\n+        }\n+    }\n+}\n+\",\n+            r\"\n+fn main() {\n+    match () {\n+        () => {\n+            if $1 {\n+    $0\n+}\n+        }\n+    }\n+}\n+\",\n+        )\n+    }\n }"}, {"sha": "93b6ad5d145dff545f979c2aad0d9f06ad96179d", "filename": "crates/ide-completion/src/context.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/13c83f90ac0031b71bea8aa14d967b47647498bb/crates%2Fide-completion%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13c83f90ac0031b71bea8aa14d967b47647498bb/crates%2Fide-completion%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcontext.rs?ref=13c83f90ac0031b71bea8aa14d967b47647498bb", "patch": "@@ -138,6 +138,9 @@ pub(crate) struct ExprCtx {\n     pub(crate) self_param: Option<hir::SelfParam>,\n     pub(crate) innermost_ret_ty: Option<hir::Type>,\n     pub(crate) impl_: Option<ast::Impl>,\n+    /// Whether this expression occurs in match arm guard position: before the\n+    /// fat arrow token\n+    pub(crate) in_match_guard: bool,\n }\n \n /// Original file ast nodes"}, {"sha": "c71ffa0ed86fd754c4d7a0ab6cd29041998d444b", "filename": "crates/ide-completion/src/context/analysis.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/13c83f90ac0031b71bea8aa14d967b47647498bb/crates%2Fide-completion%2Fsrc%2Fcontext%2Fanalysis.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13c83f90ac0031b71bea8aa14d967b47647498bb/crates%2Fide-completion%2Fsrc%2Fcontext%2Fanalysis.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcontext%2Fanalysis.rs?ref=13c83f90ac0031b71bea8aa14d967b47647498bb", "patch": "@@ -763,6 +763,13 @@ impl<'a> CompletionContext<'a> {\n                 .map_or(false, |it| it.semicolon_token().is_none());\n             let impl_ = fetch_immediate_impl(sema, original_file, expr.syntax());\n \n+            let in_match_guard = match it.parent().and_then(ast::MatchArm::cast) {\n+                Some(arm) => arm\n+                    .fat_arrow_token()\n+                    .map_or(true, |arrow| it.text_range().start() < arrow.text_range().start()),\n+                None => false,\n+            };\n+\n             PathKind::Expr {\n                 expr_ctx: ExprCtx {\n                     in_block_expr,\n@@ -775,6 +782,7 @@ impl<'a> CompletionContext<'a> {\n                     self_param,\n                     incomplete_let,\n                     impl_,\n+                    in_match_guard,\n                 },\n             }\n         };"}]}