{"sha": "ef2f42d04a4c83dd5b50cd672b8a1b0791e00f98", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVmMmY0MmQwNGE0YzgzZGQ1YjUwY2Q2NzJiOGExYjA3OTFlMDBmOTg=", "commit": {"author": {"name": "Basile Desloges", "email": "basile.desloges@gmail.com", "date": "2017-10-05T09:03:32Z"}, "committer": {"name": "Basile Desloges", "email": "basile.desloges@gmail.com", "date": "2017-10-06T15:44:50Z"}, "message": "mir-borrowck: Autoderef values followed by a constant index, and fix reported lvalue for constant index\n\nPreviously the constant index was reported as `[x of y]` or `[-x of y]` where\n`x` was the offset and `y` the minimum length of the slice. The minus sign\nwasn't in the right case since for `&[_, x, .., _, _]`, the error reported was\n`[-1 of 4]`, and for `&[_, _, .., x, _]`, the error reported was `[2 of 4]`.\nThis commit fixes the sign so that the indexes 1 and -2 are reported, and\nremove the ` of y` part of the message to make it more succinct.", "tree": {"sha": "52daa15a1bfa1fd09d14a9b1aeb3e5e355ad564d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/52daa15a1bfa1fd09d14a9b1aeb3e5e355ad564d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ef2f42d04a4c83dd5b50cd672b8a1b0791e00f98", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ef2f42d04a4c83dd5b50cd672b8a1b0791e00f98", "html_url": "https://github.com/rust-lang/rust/commit/ef2f42d04a4c83dd5b50cd672b8a1b0791e00f98", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ef2f42d04a4c83dd5b50cd672b8a1b0791e00f98/comments", "author": {"login": "zilbuz", "id": 434964, "node_id": "MDQ6VXNlcjQzNDk2NA==", "avatar_url": "https://avatars.githubusercontent.com/u/434964?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zilbuz", "html_url": "https://github.com/zilbuz", "followers_url": "https://api.github.com/users/zilbuz/followers", "following_url": "https://api.github.com/users/zilbuz/following{/other_user}", "gists_url": "https://api.github.com/users/zilbuz/gists{/gist_id}", "starred_url": "https://api.github.com/users/zilbuz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zilbuz/subscriptions", "organizations_url": "https://api.github.com/users/zilbuz/orgs", "repos_url": "https://api.github.com/users/zilbuz/repos", "events_url": "https://api.github.com/users/zilbuz/events{/privacy}", "received_events_url": "https://api.github.com/users/zilbuz/received_events", "type": "User", "site_admin": false}, "committer": {"login": "zilbuz", "id": 434964, "node_id": "MDQ6VXNlcjQzNDk2NA==", "avatar_url": "https://avatars.githubusercontent.com/u/434964?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zilbuz", "html_url": "https://github.com/zilbuz", "followers_url": "https://api.github.com/users/zilbuz/followers", "following_url": "https://api.github.com/users/zilbuz/following{/other_user}", "gists_url": "https://api.github.com/users/zilbuz/gists{/gist_id}", "starred_url": "https://api.github.com/users/zilbuz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zilbuz/subscriptions", "organizations_url": "https://api.github.com/users/zilbuz/orgs", "repos_url": "https://api.github.com/users/zilbuz/repos", "events_url": "https://api.github.com/users/zilbuz/events{/privacy}", "received_events_url": "https://api.github.com/users/zilbuz/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "456e12ec38f669b26b08414527ee1dc35091da33", "url": "https://api.github.com/repos/rust-lang/rust/commits/456e12ec38f669b26b08414527ee1dc35091da33", "html_url": "https://github.com/rust-lang/rust/commit/456e12ec38f669b26b08414527ee1dc35091da33"}], "stats": {"total": 47, "additions": 43, "deletions": 4}, "files": [{"sha": "85ecb9d6e3670b49ccd7fd430d548590007b2119", "filename": "src/librustc_mir/borrow_check.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/ef2f42d04a4c83dd5b50cd672b8a1b0791e00f98/src%2Flibrustc_mir%2Fborrow_check.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef2f42d04a4c83dd5b50cd672b8a1b0791e00f98/src%2Flibrustc_mir%2Fborrow_check.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check.rs?ref=ef2f42d04a4c83dd5b50cd672b8a1b0791e00f98", "patch": "@@ -1090,10 +1090,14 @@ impl<'c, 'b, 'a: 'b+'c, 'gcx, 'tcx: 'a> MirBorrowckCtxt<'c, 'b, 'a, 'gcx, 'tcx>\n                         autoderef = true;\n                         (\"\",   format!(\"\"), Some(index))\n                     },\n-                    ProjectionElem::ConstantIndex { offset, min_length, from_end: true } =>\n-                        (\"\",   format!(\"[{} of {}]\", offset, min_length), None),\n-                    ProjectionElem::ConstantIndex { offset, min_length, from_end: false } =>\n-                        (\"\",   format!(\"[-{} of {}]\", offset, min_length), None),\n+                    ProjectionElem::ConstantIndex { offset, from_end: false, .. } => {\n+                        autoderef = true;\n+                        (\"\",   format!(\"[{}]\", offset), None)\n+                    },\n+                    ProjectionElem::ConstantIndex { offset, from_end: true, .. } => {\n+                        autoderef = true;\n+                        (\"\",   format!(\"[-{}]\", offset), None)\n+                    },\n                     ProjectionElem::Subslice { from, to: 0 } =>\n                         (\"\",   format!(\"[{}:]\", from), None),\n                     ProjectionElem::Subslice { from: 0, to } =>"}, {"sha": "9d1b2b64d850a823b0bfbb4591121d97e2ad98bb", "filename": "src/test/compile-fail/borrowck/borrowck-describe-lvalue.rs", "status": "modified", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/ef2f42d04a4c83dd5b50cd672b8a1b0791e00f98/src%2Ftest%2Fcompile-fail%2Fborrowck%2Fborrowck-describe-lvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef2f42d04a4c83dd5b50cd672b8a1b0791e00f98/src%2Ftest%2Fcompile-fail%2Fborrowck%2Fborrowck-describe-lvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fborrowck%2Fborrowck-describe-lvalue.rs?ref=ef2f42d04a4c83dd5b50cd672b8a1b0791e00f98", "patch": "@@ -11,6 +11,8 @@\n // revisions: ast mir\n //[mir]compile-flags: -Z emit-end-regions -Z borrowck-mir\n \n+#![feature(advanced_slice_patterns)]\n+\n pub struct Foo {\n   x: u32\n }\n@@ -163,4 +165,37 @@ fn main() {\n              //[mir]~^ ERROR cannot use `u.a` because it was mutably borrowed (Ast)\n              //[mir]~| ERROR cannot use `u.a` because it was mutably borrowed (Mir)\n     }\n+    // Constant index\n+    {\n+        let mut v = &[1, 2, 3, 4, 5, 6, 7, 8, 9, 10];\n+        let _v = &mut v;\n+        match v {\n+            &[x, _, .., _, _] => println!(\"{}\", x),\n+                //[ast]~^ ERROR cannot use `v[..]` because it was mutably borrowed\n+                //[mir]~^^ ERROR cannot use `v[..]` because it was mutably borrowed (Ast)\n+                //[mir]~| ERROR cannot use `v[0]` because it was mutably borrowed (Mir)\n+                            _ => panic!(\"other case\"),\n+        }\n+        match v {\n+            &[_, x, .., _, _] => println!(\"{}\", x),\n+                //[ast]~^ ERROR cannot use `v[..]` because it was mutably borrowed\n+                //[mir]~^^ ERROR cannot use `v[..]` because it was mutably borrowed (Ast)\n+                //[mir]~| ERROR cannot use `v[1]` because it was mutably borrowed (Mir)\n+                            _ => panic!(\"other case\"),\n+        }\n+        match v {\n+            &[_, _, .., x, _] => println!(\"{}\", x),\n+                //[ast]~^ ERROR cannot use `v[..]` because it was mutably borrowed\n+                //[mir]~^^ ERROR cannot use `v[..]` because it was mutably borrowed (Ast)\n+                //[mir]~| ERROR cannot use `v[-2]` because it was mutably borrowed (Mir)\n+                            _ => panic!(\"other case\"),\n+        }\n+        match v {\n+            &[_, _, .., _, x] => println!(\"{}\", x),\n+                //[ast]~^ ERROR cannot use `v[..]` because it was mutably borrowed\n+                //[mir]~^^ ERROR cannot use `v[..]` because it was mutably borrowed (Ast)\n+                //[mir]~| ERROR cannot use `v[-1]` because it was mutably borrowed (Mir)\n+                            _ => panic!(\"other case\"),\n+        }\n+    }\n }"}]}