{"sha": "0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBlYTdhYTMwY2M4NjRkMDBmYzMwYjliYTYxMGYyZGFlZmFiNGU4NTA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-06-09T22:52:07Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-06-09T22:52:07Z"}, "message": "auto merge of #14554 : kmcallister/rust/plugin_registrar, r=cmr\n\nThis implements the design in rust-lang/rfcs#86.  It shouldn't be merged until that RFC is accepted, but it would be great if somebody has time to review the code before then.", "tree": {"sha": "2f3216efe5cc25851595c14d803dc69738030a72", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2f3216efe5cc25851595c14d803dc69738030a72"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "html_url": "https://github.com/rust-lang/rust/commit/0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b6146e652ae7f6d373d55dd021dc50cb00e0caf8", "url": "https://api.github.com/repos/rust-lang/rust/commits/b6146e652ae7f6d373d55dd021dc50cb00e0caf8", "html_url": "https://github.com/rust-lang/rust/commit/b6146e652ae7f6d373d55dd021dc50cb00e0caf8"}, {"sha": "deecda6a94b31489045d420f16840a72c44af7e1", "url": "https://api.github.com/repos/rust-lang/rust/commits/deecda6a94b31489045d420f16840a72c44af7e1", "html_url": "https://github.com/rust-lang/rust/commit/deecda6a94b31489045d420f16840a72c44af7e1"}], "stats": {"total": 1072, "additions": 669, "deletions": 403}, "files": [{"sha": "cc6532945efad7fc2a7c65a43a9b7326f5e43eb7", "filename": "mk/crates.mk", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/mk%2Fcrates.mk", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/mk%2Fcrates.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fcrates.mk?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -83,16 +83,16 @@ DEPS_uuid := std serialize\n DEPS_sync := std alloc\n DEPS_getopts := std\n DEPS_collections := core alloc\n-DEPS_fourcc := syntax std\n-DEPS_hexfloat := syntax std\n+DEPS_fourcc := rustc syntax std\n+DEPS_hexfloat := rustc syntax std\n DEPS_num := std\n DEPS_test := std getopts serialize term time regex native:rust_test_helpers\n DEPS_time := std serialize sync\n DEPS_rand := core\n DEPS_url := std\n DEPS_log := std sync\n DEPS_regex := std\n-DEPS_regex_macros = syntax std regex\n+DEPS_regex_macros = rustc syntax std regex\n DEPS_fmt_macros = std\n \n TOOL_DEPS_compiletest := test green rustuv getopts"}, {"sha": "de0ca4971f5c2ba085bd1185dcfa5ed6f3f3d38f", "filename": "src/compiletest/compiletest.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Fcompiletest%2Fcompiletest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Fcompiletest%2Fcompiletest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcompiletest%2Fcompiletest.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -18,11 +18,17 @@\n \n extern crate test;\n extern crate getopts;\n-#[phase(link, syntax)]\n-extern crate log;\n extern crate green;\n extern crate rustuv;\n \n+#[cfg(stage0)]\n+#[phase(syntax, link)]\n+extern crate log;\n+\n+#[cfg(not(stage0))]\n+#[phase(plugin, link)]\n+extern crate log;\n+\n extern crate regex;\n \n use std::os;"}, {"sha": "35d356bb1b56cd8e4935a627d0a20b1f1134b072", "filename": "src/doc/rust.md", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Fdoc%2Frust.md", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Fdoc%2Frust.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frust.md?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -1819,9 +1819,8 @@ type int8_t = i8;\n \n ### Function-only attributes\n \n-- `macro_registrar` - when using loadable syntax extensions, mark this\n-  function as the registration point for the current crate's syntax\n-  extensions.\n+- `plugin_registrar` - mark this function as the registration point for\n+  compiler plugins, such as loadable syntax extensions.\n - `main` - indicates that this function should be passed to the entry point,\n   rather than the function in the crate root named `main`.\n - `start` - indicates that this function should be used as the entry point,\n@@ -4098,7 +4097,7 @@ that demonstrates all four of them:\n \n ~~~~\n #![feature(phase)]\n-#[phase(syntax, link)] extern crate log;\n+#[phase(plugin, link)] extern crate log;\n \n fn main() {\n     error!(\"This is an error log\")"}, {"sha": "7e2c9a75fad0d3eee0b23ecb3bb5de6dcc776302", "filename": "src/liballoc/lib.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Fliballoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Fliballoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -70,8 +70,14 @@\n #![no_std]\n #![feature(phase)]\n \n+#[cfg(stage0)]\n #[phase(syntax, link)]\n extern crate core;\n+\n+#[cfg(not(stage0))]\n+#[phase(plugin, link)]\n+extern crate core;\n+\n extern crate libc;\n \n \n@@ -80,8 +86,10 @@ extern crate libc;\n #[cfg(test)] extern crate debug;\n #[cfg(test)] extern crate sync;\n #[cfg(test)] extern crate native;\n-#[cfg(test)] #[phase(syntax, link)] extern crate std;\n-#[cfg(test)] #[phase(syntax, link)] extern crate log;\n+#[cfg(test, stage0)] #[phase(syntax, link)] extern crate std;\n+#[cfg(test, stage0)] #[phase(syntax, link)] extern crate log;\n+#[cfg(test, not(stage0))] #[phase(plugin, link)] extern crate std;\n+#[cfg(test, not(stage0))] #[phase(plugin, link)] extern crate log;\n \n // Heaps provided for low-level allocation strategies\n "}, {"sha": "a114755a0ed91a3ac011fd8b6cc8020e8ef3b89c", "filename": "src/libcollections/lib.rs", "status": "modified", "additions": 13, "deletions": 3, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibcollections%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibcollections%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -23,14 +23,24 @@\n #![feature(macro_rules, managed_boxes, default_type_params, phase, globs)]\n #![no_std]\n \n-#[phase(syntax, link)] extern crate core;\n extern crate alloc;\n \n+#[cfg(stage0)]\n+#[phase(syntax, link)]\n+extern crate core;\n+\n+#[cfg(not(stage0))]\n+#[phase(plugin, link)]\n+extern crate core;\n+\n #[cfg(test)] extern crate native;\n #[cfg(test)] extern crate test;\n #[cfg(test)] extern crate debug;\n-#[cfg(test)] #[phase(syntax, link)] extern crate std;\n-#[cfg(test)] #[phase(syntax, link)] extern crate log;\n+\n+#[cfg(test, stage0)] #[phase(syntax, link)] extern crate std;\n+#[cfg(test, stage0)] #[phase(syntax, link)] extern crate log;\n+#[cfg(test, not(stage0))] #[phase(plugin, link)] extern crate std;\n+#[cfg(test, not(stage0))] #[phase(plugin, link)] extern crate log;\n \n use core::prelude::*;\n "}, {"sha": "8d8fe8ffe8cfe404c10aa577d9cd0f4207bc3cc3", "filename": "src/libflate/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibflate%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibflate%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibflate%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -28,7 +28,8 @@ Simple [DEFLATE][def]-based compression. This is a wrapper around the\n #![feature(phase)]\n #![deny(deprecated_owned_vector)]\n \n-#[cfg(test)] #[phase(syntax, link)] extern crate log;\n+#[cfg(test, stage0)] #[phase(syntax, link)] extern crate log;\n+#[cfg(test, not(stage0))] #[phase(plugin, link)] extern crate log;\n \n extern crate libc;\n "}, {"sha": "694fe7d0f48b08fa3e3fb9097f443c67e2379b50", "filename": "src/libfourcc/lib.rs", "status": "modified", "additions": 8, "deletions": 12, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibfourcc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibfourcc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibfourcc%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -22,7 +22,7 @@ to be `big`, i.e. left-to-right order. It returns a u32.\n To load the extension and use it:\n \n ```rust,ignore\n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate fourcc;\n \n fn main() {\n@@ -48,29 +48,25 @@ fn main() {\n        html_root_url = \"http://doc.rust-lang.org/\")]\n \n #![deny(deprecated_owned_vector)]\n-#![feature(macro_registrar, managed_boxes)]\n+#![feature(plugin_registrar, managed_boxes)]\n \n extern crate syntax;\n+extern crate rustc;\n \n use syntax::ast;\n-use syntax::ast::Name;\n use syntax::attr::contains;\n use syntax::codemap::{Span, mk_sp};\n use syntax::ext::base;\n-use syntax::ext::base::{SyntaxExtension, BasicMacroExpander, NormalTT, ExtCtxt, MacExpr};\n+use syntax::ext::base::{ExtCtxt, MacExpr};\n use syntax::ext::build::AstBuilder;\n use syntax::parse;\n use syntax::parse::token;\n use syntax::parse::token::InternedString;\n+use rustc::plugin::Registry;\n \n-#[macro_registrar]\n-pub fn macro_registrar(register: |Name, SyntaxExtension|) {\n-    register(token::intern(\"fourcc\"),\n-        NormalTT(box BasicMacroExpander {\n-            expander: expand_syntax_ext,\n-            span: None,\n-        },\n-        None));\n+#[plugin_registrar]\n+pub fn plugin_registrar(reg: &mut Registry) {\n+    reg.register_macro(\"fourcc\", expand_syntax_ext);\n }\n \n pub fn expand_syntax_ext(cx: &mut ExtCtxt, sp: Span, tts: &[ast::TokenTree])"}, {"sha": "dec62265516fdb5da21e4285641a8b105300b9e8", "filename": "src/libgetopts/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibgetopts%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibgetopts%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibgetopts%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -91,7 +91,8 @@\n #![deny(deprecated_owned_vector)]\n \n #[cfg(test)] extern crate debug;\n-#[cfg(test)] #[phase(syntax, link)] extern crate log;\n+#[cfg(test, stage0)] #[phase(syntax, link)] extern crate log;\n+#[cfg(test, not(stage0))] #[phase(plugin, link)] extern crate log;\n \n use std::cmp::PartialEq;\n use std::result::{Err, Ok};"}, {"sha": "9748dfbae33f0dc8f744797f43e695cea15f4068", "filename": "src/libgreen/lib.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibgreen%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibgreen%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibgreen%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -148,7 +148,7 @@\n //!\n //! ```\n //! #![feature(phase)]\n-//! #[phase(syntax)] extern crate green;\n+//! #[phase(plugin)] extern crate green;\n //!\n //! green_start!(main)\n //!\n@@ -211,7 +211,7 @@\n #![allow(visible_private_types)]\n #![deny(deprecated_owned_vector)]\n \n-#[cfg(test)] #[phase(syntax, link)] extern crate log;\n+#[cfg(test)] #[phase(plugin, link)] extern crate log;\n #[cfg(test)] extern crate rustuv;\n extern crate libc;\n extern crate alloc;\n@@ -249,7 +249,7 @@ pub mod task;\n ///\n /// ```\n /// #![feature(phase)]\n-/// #[phase(syntax)] extern crate green;\n+/// #[phase(plugin)] extern crate green;\n ///\n /// green_start!(main)\n ///"}, {"sha": "54bc2802b09ac364cb92ab2b6f42d3dcc44abf62", "filename": "src/libhexfloat/lib.rs", "status": "modified", "additions": 8, "deletions": 12, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibhexfloat%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibhexfloat%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibhexfloat%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -21,7 +21,7 @@ literal.\n To load the extension and use it:\n \n ```rust,ignore\n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate hexfloat;\n \n fn main() {\n@@ -45,27 +45,23 @@ fn main() {\n        html_root_url = \"http://doc.rust-lang.org/\")]\n \n #![deny(deprecated_owned_vector)]\n-#![feature(macro_registrar, managed_boxes)]\n+#![feature(plugin_registrar, managed_boxes)]\n \n extern crate syntax;\n+extern crate rustc;\n \n use syntax::ast;\n-use syntax::ast::Name;\n use syntax::codemap::{Span, mk_sp};\n use syntax::ext::base;\n-use syntax::ext::base::{SyntaxExtension, BasicMacroExpander, NormalTT, ExtCtxt, MacExpr};\n+use syntax::ext::base::{ExtCtxt, MacExpr};\n use syntax::ext::build::AstBuilder;\n use syntax::parse;\n use syntax::parse::token;\n+use rustc::plugin::Registry;\n \n-#[macro_registrar]\n-pub fn macro_registrar(register: |Name, SyntaxExtension|) {\n-    register(token::intern(\"hexfloat\"),\n-        NormalTT(box BasicMacroExpander {\n-            expander: expand_syntax_ext,\n-            span: None,\n-        },\n-        None));\n+#[plugin_registrar]\n+pub fn plugin_registrar(reg: &mut Registry) {\n+    reg.register_macro(\"hexfloat\", expand_syntax_ext);\n }\n \n //Check if the literal is valid (as LLVM expects),"}, {"sha": "254f9aaf55e4399a9ff06816d6e512494caed3cd", "filename": "src/liblog/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Fliblog%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Fliblog%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliblog%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -16,7 +16,7 @@ Utilities for program-wide and customizable logging\n \n ```\n #![feature(phase)]\n-#[phase(syntax, link)] extern crate log;\n+#[phase(plugin, link)] extern crate log;\n \n fn main() {\n     debug!(\"this is a debug {}\", \"message\");"}, {"sha": "dba34c42a7e15997a7f9afa039a30be880b2f217", "filename": "src/liblog/macros.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Fliblog%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Fliblog%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliblog%2Fmacros.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -22,7 +22,7 @@\n ///\n /// ```\n /// #![feature(phase)]\n-/// #[phase(syntax, link)] extern crate log;\n+/// #[phase(plugin, link)] extern crate log;\n ///\n /// # fn main() {\n /// log!(log::DEBUG, \"this is a debug message\");\n@@ -51,7 +51,7 @@ macro_rules! log(\n ///\n /// ```\n /// #![feature(phase)]\n-/// #[phase(syntax, link)] extern crate log;\n+/// #[phase(plugin, link)] extern crate log;\n ///\n /// # fn main() {\n /// # let error = 3;\n@@ -69,7 +69,7 @@ macro_rules! error(\n ///\n /// ```\n /// #![feature(phase)]\n-/// #[phase(syntax, link)] extern crate log;\n+/// #[phase(plugin, link)] extern crate log;\n ///\n /// # fn main() {\n /// # let code = 3;\n@@ -87,7 +87,7 @@ macro_rules! warn(\n ///\n /// ```\n /// #![feature(phase)]\n-/// #[phase(syntax, link)] extern crate log;\n+/// #[phase(plugin, link)] extern crate log;\n ///\n /// # fn main() {\n /// # let ret = 3;\n@@ -107,7 +107,7 @@ macro_rules! info(\n ///\n /// ```\n /// #![feature(phase)]\n-/// #[phase(syntax, link)] extern crate log;\n+/// #[phase(plugin, link)] extern crate log;\n ///\n /// # fn main() {\n /// debug!(\"x = {x}, y = {y}\", x=10, y=20);\n@@ -124,7 +124,7 @@ macro_rules! debug(\n ///\n /// ```\n /// #![feature(phase)]\n-/// #[phase(syntax, link)] extern crate log;\n+/// #[phase(plugin, link)] extern crate log;\n ///\n /// # fn main() {\n /// # struct Point { x: int, y: int }"}, {"sha": "1f7216fc1a37d9e05b6270cf121703edc3e1af3f", "filename": "src/librand/lib.rs", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrand%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrand%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrand%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -28,13 +28,28 @@\n #![no_std]\n #![experimental]\n \n+#[cfg(stage0)]\n #[phase(syntax, link)]\n extern crate core;\n \n+#[cfg(not(stage0))]\n+#[phase(plugin, link)]\n+extern crate core;\n+\n+#[cfg(test, stage0)]\n+#[phase(syntax, link)] extern crate std;\n+\n+#[cfg(test, stage0)]\n+#[phase(syntax, link)] extern crate log;\n+\n+#[cfg(test, not(stage0))]\n+#[phase(plugin, link)] extern crate std;\n+\n+#[cfg(test, not(stage0))]\n+#[phase(plugin, link)] extern crate log;\n+\n #[cfg(test)] extern crate native;\n #[cfg(test)] extern crate debug;\n-#[cfg(test)] #[phase(syntax, link)] extern crate std;\n-#[cfg(test)] #[phase(syntax, link)] extern crate log;\n \n use core::prelude::*;\n "}, {"sha": "61e62a0d1053e960bd905310144fb9fbfe8bbe7c", "filename": "src/libregex/lib.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibregex%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibregex%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibregex%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -65,7 +65,7 @@\n //!\n //! ```rust\n //! #![feature(phase)]\n-//! #[phase(syntax)]\n+//! #[phase(plugin)]\n //! extern crate regex_macros;\n //! extern crate regex;\n //!\n@@ -95,7 +95,7 @@\n //!\n //! ```rust\n //! # #![feature(phase)]\n-//! # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+//! # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n //! # fn main() {\n //! let re = regex!(r\"(\\d{4})-(\\d{2})-(\\d{2})\");\n //! let text = \"2012-03-14, 2013-01-01 and 2014-07-05\";\n@@ -121,7 +121,7 @@\n //!\n //! ```rust\n //! # #![feature(phase)]\n-//! # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+//! # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n //! # fn main() {\n //! let re = regex!(r\"(?P<y>\\d{4})-(?P<m>\\d{2})-(?P<d>\\d{2})\");\n //! let before = \"2012-03-14, 2013-01-01 and 2014-07-05\";\n@@ -168,7 +168,7 @@\n //!\n //! ```rust\n //! # #![feature(phase)]\n-//! # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+//! # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n //! # fn main() {\n //! let re = regex!(r\"(?i)\u0394+\");\n //! assert_eq!(re.find(\"\u0394\u03b4\u0394\"), Some((0, 6)));\n@@ -181,7 +181,7 @@\n //!\n //! ```rust\n //! # #![feature(phase)]\n-//! # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+//! # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n //! # fn main() {\n //! let re = regex!(r\"[\\pN\\p{Greek}\\p{Cherokee}]+\");\n //! assert_eq!(re.find(\"abc\u0394\u13a0\u03b2\u2160\u13f4\u03b3\u03b4\u2161xyz\"), Some((3, 23)));\n@@ -278,7 +278,7 @@\n //!\n //! ```rust\n //! # #![feature(phase)]\n-//! # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+//! # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n //! # fn main() {\n //! let re = regex!(r\"(?i)a+(?-i)b+\");\n //! let cap = re.captures(\"AaAaAbbBBBb\").unwrap();"}, {"sha": "054cbb0fcd63dfa2c518f793bdeb3fd80f4599aa", "filename": "src/libregex/re.rs", "status": "modified", "additions": 13, "deletions": 13, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibregex%2Fre.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibregex%2Fre.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibregex%2Fre.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -87,7 +87,7 @@ pub fn is_match(regex: &str, text: &str) -> Result<bool, parse::Error> {\n /// ```rust\n /// #![feature(phase)]\n /// extern crate regex;\n-/// #[phase(syntax)] extern crate regex_macros;\n+/// #[phase(plugin)] extern crate regex_macros;\n ///\n /// fn main() {\n ///     let re = regex!(r\"\\d+\");\n@@ -172,7 +172,7 @@ impl Regex {\n     ///\n     /// ```rust\n     /// # #![feature(phase)]\n-    /// # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+    /// # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n     /// # fn main() {\n     /// let text = \"I categorically deny having triskaidekaphobia.\";\n     /// let matched = regex!(r\"\\b\\w{13}\\b\").is_match(text);\n@@ -197,7 +197,7 @@ impl Regex {\n     ///\n     /// ```rust\n     /// # #![feature(phase)]\n-    /// # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+    /// # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n     /// # fn main() {\n     /// let text = \"I categorically deny having triskaidekaphobia.\";\n     /// let pos = regex!(r\"\\b\\w{13}\\b\").find(text);\n@@ -224,7 +224,7 @@ impl Regex {\n     ///\n     /// ```rust\n     /// # #![feature(phase)]\n-    /// # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+    /// # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n     /// # fn main() {\n     /// let text = \"Retroactively relinquishing remunerations is reprehensible.\";\n     /// for pos in regex!(r\"\\b\\w{13}\\b\").find_iter(text) {\n@@ -263,7 +263,7 @@ impl Regex {\n     ///\n     /// ```rust\n     /// # #![feature(phase)]\n-    /// # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+    /// # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n     /// # fn main() {\n     /// let re = regex!(r\"'([^']+)'\\s+\\((\\d{4})\\)\");\n     /// let text = \"Not my favorite movie: 'Citizen Kane' (1941).\";\n@@ -281,7 +281,7 @@ impl Regex {\n     ///\n     /// ```rust\n     /// # #![feature(phase)]\n-    /// # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+    /// # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n     /// # fn main() {\n     /// let re = regex!(r\"'(?P<title>[^']+)'\\s+\\((?P<year>\\d{4})\\)\");\n     /// let text = \"Not my favorite movie: 'Citizen Kane' (1941).\";\n@@ -314,7 +314,7 @@ impl Regex {\n     ///\n     /// ```rust\n     /// # #![feature(phase)]\n-    /// # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+    /// # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n     /// # fn main() {\n     /// let re = regex!(r\"'(?P<title>[^']+)'\\s+\\((?P<year>\\d{4})\\)\");\n     /// let text = \"'Citizen Kane' (1941), 'The Wizard of Oz' (1939), 'M' (1931).\";\n@@ -350,7 +350,7 @@ impl Regex {\n     ///\n     /// ```rust\n     /// # #![feature(phase)]\n-    /// # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+    /// # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n     /// # fn main() {\n     /// let re = regex!(r\"[ \\t]+\");\n     /// let fields: Vec<&str> = re.split(\"a b \\t  c\\td    e\").collect();\n@@ -380,7 +380,7 @@ impl Regex {\n     ///\n     /// ```rust\n     /// # #![feature(phase)]\n-    /// # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+    /// # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n     /// # fn main() {\n     /// let re = regex!(r\"\\W+\");\n     /// let fields: Vec<&str> = re.splitn(\"Hey! How are you?\", 3).collect();\n@@ -410,7 +410,7 @@ impl Regex {\n     ///\n     /// ```rust\n     /// # #![feature(phase)]\n-    /// # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+    /// # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n     /// # fn main() {\n     /// let re = regex!(\"[^01]+\");\n     /// assert_eq!(re.replace(\"1078910\", \"\").as_slice(), \"1010\");\n@@ -424,7 +424,7 @@ impl Regex {\n     ///\n     /// ```rust\n     /// # #![feature(phase)]\n-    /// # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+    /// # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n     /// # use regex::Captures; fn main() {\n     /// let re = regex!(r\"([^,\\s]+),\\s+(\\S+)\");\n     /// let result = re.replace(\"Springsteen, Bruce\", |caps: &Captures| {\n@@ -441,7 +441,7 @@ impl Regex {\n     ///\n     /// ```rust\n     /// # #![feature(phase)]\n-    /// # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+    /// # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n     /// # fn main() {\n     /// let re = regex!(r\"(?P<last>[^,\\s]+),\\s+(?P<first>\\S+)\");\n     /// let result = re.replace(\"Springsteen, Bruce\", \"$first $last\");\n@@ -458,7 +458,7 @@ impl Regex {\n     ///\n     /// ```rust\n     /// # #![feature(phase)]\n-    /// # extern crate regex; #[phase(syntax)] extern crate regex_macros;\n+    /// # extern crate regex; #[phase(plugin)] extern crate regex_macros;\n     /// # fn main() {\n     /// use regex::NoExpand;\n     ///"}, {"sha": "96c600b0fda3a4a50f0a5dc04345b1b604d322c1", "filename": "src/libregex/test/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibregex%2Ftest%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibregex%2Ftest%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibregex%2Ftest%2Fmod.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -9,7 +9,7 @@\n // except according to those terms.\n \n #[cfg(not(stage1))]\n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate regex_macros;\n \n #[cfg(not(stage1))]"}, {"sha": "bbee09d0f38b37512ca502e9e2bdf95d0d0e47e4", "filename": "src/libregex_macros/lib.rs", "status": "modified", "additions": 8, "deletions": 9, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibregex_macros%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibregex_macros%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibregex_macros%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -19,24 +19,24 @@\n        html_favicon_url = \"http://www.rust-lang.org/favicon.ico\",\n        html_root_url = \"http://doc.rust-lang.org/\")]\n \n-#![feature(macro_registrar, managed_boxes, quote)]\n+#![feature(plugin_registrar, managed_boxes, quote)]\n \n extern crate regex;\n extern crate syntax;\n+extern crate rustc;\n \n use std::rc::Rc;\n \n use syntax::ast;\n use syntax::codemap;\n use syntax::ext::build::AstBuilder;\n-use syntax::ext::base::{\n-    SyntaxExtension, ExtCtxt, MacResult, MacExpr, DummyResult,\n-    NormalTT, BasicMacroExpander,\n-};\n+use syntax::ext::base::{ExtCtxt, MacResult, MacExpr, DummyResult};\n use syntax::parse;\n use syntax::parse::token;\n use syntax::print::pprust;\n \n+use rustc::plugin::Registry;\n+\n use regex::Regex;\n use regex::native::{\n     OneChar, CharClass, Any, Save, Jump, Split,\n@@ -46,11 +46,10 @@ use regex::native::{\n };\n \n /// For the `regex!` syntax extension. Do not use.\n-#[macro_registrar]\n+#[plugin_registrar]\n #[doc(hidden)]\n-pub fn macro_registrar(register: |ast::Name, SyntaxExtension|) {\n-    let expander = box BasicMacroExpander { expander: native, span: None };\n-    register(token::intern(\"regex\"), NormalTT(expander, None))\n+pub fn plugin_registrar(reg: &mut Registry) {\n+    reg.register_macro(\"regex\", native);\n }\n \n /// Generates specialized code for the Pike VM for a particular regular"}, {"sha": "45e9c7b562d0f1631b36f976bc0cd115bcfb12d1", "filename": "src/librustc/driver/driver.rs", "status": "modified", "additions": 40, "deletions": 26, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fdriver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fdriver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdriver%2Fdriver.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -18,12 +18,14 @@ use front;\n use lib::llvm::{ContextRef, ModuleRef};\n use metadata::common::LinkMeta;\n use metadata::creader;\n-use metadata::creader::Loader;\n use middle::cfg;\n use middle::cfg::graphviz::LabelledCFG;\n use middle::{trans, freevars, kind, ty, typeck, lint, reachable};\n use middle::dependency_format;\n use middle;\n+use plugin::load::Plugins;\n+use plugin::registry::Registry;\n+use plugin;\n use util::common::time;\n use util::ppaux;\n use util::nodemap::{NodeSet};\n@@ -39,7 +41,6 @@ use syntax::ast;\n use syntax::attr;\n use syntax::attr::{AttrMetaMethods};\n use syntax::crateid::CrateId;\n-use syntax::ext::base::CrateLoader;\n use syntax::parse;\n use syntax::parse::token;\n use syntax::print::{pp, pprust};\n@@ -75,11 +76,10 @@ pub fn compile_input(sess: Session,\n                                                  output,\n                                                  krate.attrs.as_slice(),\n                                                  &sess);\n-            let loader = &mut Loader::new(&sess);\n             let id = link::find_crate_id(krate.attrs.as_slice(),\n                                          outputs.out_filestem.as_slice());\n             let (expanded_crate, ast_map) =\n-                phase_2_configure_and_expand(&sess, loader, krate, &id);\n+                phase_2_configure_and_expand(&sess, krate, &id);\n             (outputs, expanded_crate, ast_map)\n         };\n         write_out_deps(&sess, input, &outputs, &expanded_crate);\n@@ -172,7 +172,6 @@ pub fn phase_1_parse_input(sess: &Session, cfg: ast::CrateConfig, input: &Input)\n /// harness if one is to be provided and injection of a dependency on the\n /// standard library and prelude.\n pub fn phase_2_configure_and_expand(sess: &Session,\n-                                    loader: &mut CrateLoader,\n                                     mut krate: ast::Crate,\n                                     crate_id: &CrateId)\n                                     -> (ast::Crate, syntax::ast_map::Map) {\n@@ -197,25 +196,42 @@ pub fn phase_2_configure_and_expand(sess: &Session,\n     krate = time(time_passes, \"configuration 1\", krate, |krate|\n                  front::config::strip_unconfigured_items(krate));\n \n-    krate = time(time_passes, \"expansion\", krate, |krate| {\n-        // Windows dlls do not have rpaths, so they don't know how to find their\n-        // dependencies. It's up to us to tell the system where to find all the\n-        // dependent dlls. Note that this uses cfg!(windows) as opposed to\n-        // targ_cfg because syntax extensions are always loaded for the host\n-        // compiler, not for the target.\n-        if cfg!(windows) {\n-            sess.host_filesearch().add_dylib_search_paths();\n+    let Plugins { macros, registrars }\n+        = time(time_passes, \"plugin loading\", (), |_|\n+               plugin::load::load_plugins(sess, &krate));\n+\n+    let mut registry = Registry::new(&krate);\n+\n+    time(time_passes, \"plugin registration\", (), |_| {\n+        for &registrar in registrars.iter() {\n+            registrar(&mut registry);\n         }\n-        let cfg = syntax::ext::expand::ExpansionConfig {\n-            loader: loader,\n-            deriving_hash_type_parameter: sess.features.default_type_params.get(),\n-            crate_id: crate_id.clone(),\n-        };\n-        syntax::ext::expand::expand_crate(&sess.parse_sess,\n-                                          cfg,\n-                                          krate)\n     });\n \n+    let Registry { syntax_exts, .. } = registry;\n+\n+    krate = time(time_passes, \"expansion\", (krate, macros, syntax_exts),\n+        |(krate, macros, syntax_exts)| {\n+            // Windows dlls do not have rpaths, so they don't know how to find their\n+            // dependencies. It's up to us to tell the system where to find all the\n+            // dependent dlls. Note that this uses cfg!(windows) as opposed to\n+            // targ_cfg because syntax extensions are always loaded for the host\n+            // compiler, not for the target.\n+            if cfg!(windows) {\n+                sess.host_filesearch().add_dylib_search_paths();\n+            }\n+            let cfg = syntax::ext::expand::ExpansionConfig {\n+                deriving_hash_type_parameter: sess.features.default_type_params.get(),\n+                crate_id: crate_id.clone(),\n+            };\n+            syntax::ext::expand::expand_crate(&sess.parse_sess,\n+                                              cfg,\n+                                              macros,\n+                                              syntax_exts,\n+                                              krate)\n+        }\n+    );\n+\n     // strip again, in case expansion added anything with a #[cfg].\n     krate = time(time_passes, \"configuration 2\", krate, |krate|\n                  front::config::strip_unconfigured_items(krate));\n@@ -281,9 +297,9 @@ pub fn phase_3_run_analysis_passes(sess: Session,\n     time(time_passes, \"looking for entry point\", (),\n          |_| middle::entry::find_entry_point(&sess, krate, &ast_map));\n \n-    sess.macro_registrar_fn.set(\n-        time(time_passes, \"looking for macro registrar\", (), |_|\n-            syntax::ext::registrar::find_macro_registrar(\n+    sess.plugin_registrar_fn.set(\n+        time(time_passes, \"looking for plugin registrar\", (), |_|\n+            plugin::build::find_plugin_registrar(\n                 sess.diagnostic(), krate)));\n \n     let freevars = time(time_passes, \"freevar finding\", (), |_|\n@@ -596,9 +612,7 @@ pub fn pretty_print_input(sess: Session,\n \n     let (krate, ast_map, is_expanded) = match ppm {\n         PpmExpanded | PpmExpandedIdentified | PpmTyped | PpmFlowGraph(_) => {\n-            let loader = &mut Loader::new(&sess);\n             let (krate, ast_map) = phase_2_configure_and_expand(&sess,\n-                                                                loader,\n                                                                 krate,\n                                                                 &id);\n             (krate, Some(ast_map), true)"}, {"sha": "773b9e6e0aac4022055e64b6cfea8afa95b38009", "filename": "src/librustc/driver/session.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fdriver%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fdriver%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdriver%2Fsession.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -36,7 +36,7 @@ pub struct Session {\n     // For a library crate, this is always none\n     pub entry_fn: RefCell<Option<(NodeId, codemap::Span)>>,\n     pub entry_type: Cell<Option<config::EntryFnType>>,\n-    pub macro_registrar_fn: Cell<Option<ast::NodeId>>,\n+    pub plugin_registrar_fn: Cell<Option<ast::NodeId>>,\n     pub default_sysroot: Option<Path>,\n     // The name of the root source file of the crate, in the local file system. The path is always\n     // expected to be absolute. `None` means that there is no source file.\n@@ -232,7 +232,7 @@ pub fn build_session_(sopts: config::Options,\n         // For a library crate, this is always none\n         entry_fn: RefCell::new(None),\n         entry_type: Cell::new(None),\n-        macro_registrar_fn: Cell::new(None),\n+        plugin_registrar_fn: Cell::new(None),\n         default_sysroot: default_sysroot,\n         local_crate_source_file: local_crate_source_file,\n         working_dir: os::getcwd(),"}, {"sha": "11dd6a86cd811df749a1f9fdbd6538d6f4e113ac", "filename": "src/librustc/front/feature_gate.rs", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Ffront%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Ffront%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ffront%2Ffeature_gate.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -46,7 +46,7 @@ static KNOWN_FEATURES: &'static [(&'static str, Status)] = &[\n     (\"thread_local\", Active),\n     (\"link_args\", Active),\n     (\"phase\", Active),\n-    (\"macro_registrar\", Active),\n+    (\"plugin_registrar\", Active),\n     (\"log_syntax\", Active),\n     (\"trace_macros\", Active),\n     (\"concat_idents\", Active),\n@@ -192,10 +192,9 @@ impl<'a> Visitor<()> for Context<'a> {\n             }\n \n             ast::ItemFn(..) => {\n-                if attr::contains_name(i.attrs.as_slice(), \"macro_registrar\") {\n-                    self.gate_feature(\"macro_registrar\", i.span,\n-                                      \"cross-crate macro exports are \\\n-                                       experimental and possibly buggy\");\n+                if attr::contains_name(i.attrs.as_slice(), \"plugin_registrar\") {\n+                    self.gate_feature(\"plugin_registrar\", i.span,\n+                                      \"compiler plugins are experimental and possibly buggy\");\n                 }\n             }\n "}, {"sha": "0514f7de505ef59b6baedfc161a0c171f0b3255a", "filename": "src/librustc/front/std_inject.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Ffront%2Fstd_inject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Ffront%2Fstd_inject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ffront%2Fstd_inject.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -81,7 +81,7 @@ impl<'a> fold::Folder for StandardLibraryInjector<'a> {\n                 attr::mk_attr_outer(attr::mk_attr_id(), attr::mk_list_item(\n                         InternedString::new(\"phase\"),\n                         vec!(\n-                            attr::mk_word_item(InternedString::new(\"syntax\")),\n+                            attr::mk_word_item(InternedString::new(\"plugin\")),\n                             attr::mk_word_item(InternedString::new(\"link\")\n                         ))))),\n             vis: ast::Inherited,"}, {"sha": "174bcc86d263a4f0f9c82fe18a0dcdc452e7a941", "filename": "src/librustc/front/test.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Ffront%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Ffront%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ffront%2Ftest.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -16,7 +16,6 @@\n use driver::session::Session;\n use front::config;\n use front::std_inject::with_version;\n-use metadata::creader::Loader;\n \n use std::cell::RefCell;\n use std::slice;\n@@ -150,12 +149,10 @@ impl<'a> fold::Folder for TestHarnessGenerator<'a> {\n \n fn generate_test_harness(sess: &Session, krate: ast::Crate)\n                          -> ast::Crate {\n-    let loader = &mut Loader::new(sess);\n     let mut cx: TestCtxt = TestCtxt {\n         sess: sess,\n         ext_cx: ExtCtxt::new(&sess.parse_sess, sess.opts.cfg.clone(),\n                              ExpansionConfig {\n-                                 loader: loader,\n                                  deriving_hash_type_parameter: false,\n                                  crate_id: from_str(\"test\").unwrap(),\n                              }),"}, {"sha": "4ac4e3a5a9ffbd547f2dffcf4a3c60aba6781916", "filename": "src/librustc/lib.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -42,9 +42,14 @@ extern crate sync;\n extern crate syntax;\n extern crate time;\n \n+#[cfg(stage0)]\n #[phase(syntax, link)]\n extern crate log;\n \n+#[cfg(not(stage0))]\n+#[phase(plugin, link)]\n+extern crate log;\n+\n pub mod middle {\n     pub mod def;\n     pub mod trans;\n@@ -109,6 +114,8 @@ pub mod metadata;\n \n pub mod driver;\n \n+pub mod plugin;\n+\n pub mod util {\n     pub mod common;\n     pub mod ppaux;"}, {"sha": "2ff656853c3bdbffb9617dbc56ef6bb320642452", "filename": "src/librustc/metadata/common.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fmetadata%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fmetadata%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Fcommon.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -198,7 +198,7 @@ pub static tag_native_libraries_lib: uint = 0x88;\n pub static tag_native_libraries_name: uint = 0x89;\n pub static tag_native_libraries_kind: uint = 0x8a;\n \n-pub static tag_macro_registrar_fn: uint = 0x8b;\n+pub static tag_plugin_registrar_fn: uint = 0x8b;\n pub static tag_exported_macros: uint = 0x8c;\n pub static tag_macro_def: uint = 0x8d;\n "}, {"sha": "4df21fbc974be7f20f78d5d57eab24c1ff7d19e6", "filename": "src/librustc/metadata/creader.rs", "status": "modified", "additions": 11, "deletions": 13, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fmetadata%2Fcreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fmetadata%2Fcreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Fcreader.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -21,6 +21,7 @@ use metadata::cstore::{CStore, CrateSource};\n use metadata::decoder;\n use metadata::loader;\n use metadata::loader::CratePaths;\n+use plugin::load::PluginMetadata;\n \n use std::rc::Rc;\n use std::collections::HashMap;\n@@ -30,7 +31,6 @@ use syntax::attr;\n use syntax::attr::AttrMetaMethods;\n use syntax::codemap::{Span};\n use syntax::diagnostic::SpanHandler;\n-use syntax::ext::base::{CrateLoader, MacroCrate};\n use syntax::parse::token::InternedString;\n use syntax::parse::token;\n use syntax::crateid::CrateId;\n@@ -379,23 +379,21 @@ fn resolve_crate_deps(e: &mut Env,\n     }).collect()\n }\n \n-pub struct Loader<'a> {\n+pub struct PluginMetadataReader<'a> {\n     env: Env<'a>,\n }\n \n-impl<'a> Loader<'a> {\n-    pub fn new(sess: &'a Session) -> Loader<'a> {\n-        Loader {\n+impl<'a> PluginMetadataReader<'a> {\n+    pub fn new(sess: &'a Session) -> PluginMetadataReader<'a> {\n+        PluginMetadataReader {\n             env: Env {\n                 sess: sess,\n                 next_crate_num: sess.cstore.next_crate_num(),\n             }\n         }\n     }\n-}\n \n-impl<'a> CrateLoader for Loader<'a> {\n-    fn load_crate(&mut self, krate: &ast::ViewItem) -> MacroCrate {\n+    pub fn read_plugin_metadata(&mut self, krate: &ast::ViewItem) -> PluginMetadata {\n         let info = extract_crate_info(&self.env, krate).unwrap();\n         let target_triple = self.env.sess.targ_cfg.target_strs.target_triple.as_slice();\n         let is_cross = target_triple != driver::host_triple();\n@@ -425,8 +423,8 @@ impl<'a> CrateLoader for Loader<'a> {\n                 load_ctxt.os = config::cfg_os_to_meta_os(self.env.sess.targ_cfg.os);\n                 load_ctxt.filesearch = self.env.sess.target_filesearch();\n                 let lib = load_ctxt.load_library_crate();\n-                if decoder::get_macro_registrar_fn(lib.metadata.as_slice()).is_some() {\n-                    let message = format!(\"crate `{}` contains a macro_registrar fn but \\\n+                if decoder::get_plugin_registrar_fn(lib.metadata.as_slice()).is_some() {\n+                    let message = format!(\"crate `{}` contains a plugin_registrar fn but \\\n                                   only a version for triple `{}` could be found (need {})\",\n                                   info.ident, target_triple, driver::host_triple());\n                     self.env.sess.span_err(krate.span, message.as_slice());\n@@ -441,10 +439,10 @@ impl<'a> CrateLoader for Loader<'a> {\n             None => { load_ctxt.report_load_errs(); unreachable!() },\n         };\n         let macros = decoder::get_exported_macros(library.metadata.as_slice());\n-        let registrar = decoder::get_macro_registrar_fn(library.metadata.as_slice()).map(|id| {\n+        let registrar = decoder::get_plugin_registrar_fn(library.metadata.as_slice()).map(|id| {\n             decoder::get_symbol(library.metadata.as_slice(), id).to_string()\n         });\n-        let mc = MacroCrate {\n+        let pc = PluginMetadata {\n             lib: library.dylib.clone(),\n             macros: macros.move_iter().map(|x| x.to_string()).collect(),\n             registrar_symbol: registrar,\n@@ -454,6 +452,6 @@ impl<'a> CrateLoader for Loader<'a> {\n             register_crate(&mut self.env, &None, info.ident.as_slice(),\n                            &info.crate_id, krate.span, library);\n         }\n-        mc\n+        pc\n     }\n }"}, {"sha": "846f879104f64f7ba559e62815d7b025d65b024e", "filename": "src/librustc/metadata/cstore.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fmetadata%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fmetadata%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Fcstore.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -139,9 +139,6 @@ impl CStore {\n             .map(|source| source.clone())\n     }\n \n-    pub fn dump_phase_syntax_crates(&self) {\n-    }\n-\n     pub fn reset(&self) {\n         self.metas.borrow_mut().clear();\n         self.extern_mod_crate_map.borrow_mut().clear();"}, {"sha": "8a2c3c08d419ae8b1c319366173901758b1332d7", "filename": "src/librustc/metadata/decoder.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fmetadata%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fmetadata%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Fdecoder.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -1255,8 +1255,8 @@ pub fn get_native_libraries(cdata: Cmd)\n     return result;\n }\n \n-pub fn get_macro_registrar_fn(data: &[u8]) -> Option<ast::NodeId> {\n-    reader::maybe_get_doc(ebml::Doc::new(data), tag_macro_registrar_fn)\n+pub fn get_plugin_registrar_fn(data: &[u8]) -> Option<ast::NodeId> {\n+    reader::maybe_get_doc(ebml::Doc::new(data), tag_plugin_registrar_fn)\n         .map(|doc| FromPrimitive::from_u32(reader::doc_as_u32(doc)).unwrap())\n }\n "}, {"sha": "1846c9c881bc570fd3611dc83bf8c33629d3fd93", "filename": "src/librustc/metadata/encoder.rs", "status": "modified", "additions": 20, "deletions": 20, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fmetadata%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fmetadata%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Fencoder.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -1582,9 +1582,9 @@ fn encode_native_libraries(ecx: &EncodeContext, ebml_w: &mut Encoder) {\n     ebml_w.end_tag();\n }\n \n-fn encode_macro_registrar_fn(ecx: &EncodeContext, ebml_w: &mut Encoder) {\n-    match ecx.tcx.sess.macro_registrar_fn.get() {\n-        Some(id) => { ebml_w.wr_tagged_u32(tag_macro_registrar_fn, id); }\n+fn encode_plugin_registrar_fn(ecx: &EncodeContext, ebml_w: &mut Encoder) {\n+    match ecx.tcx.sess.plugin_registrar_fn.get() {\n+        Some(id) => { ebml_w.wr_tagged_u32(tag_plugin_registrar_fn, id); }\n         None => {}\n     }\n }\n@@ -1791,7 +1791,7 @@ fn encode_metadata_inner(wr: &mut MemWriter, parms: EncodeParams, krate: &Crate)\n         dep_bytes: u64,\n         lang_item_bytes: u64,\n         native_lib_bytes: u64,\n-        macro_registrar_fn_bytes: u64,\n+        plugin_registrar_fn_bytes: u64,\n         macro_defs_bytes: u64,\n         impl_bytes: u64,\n         misc_bytes: u64,\n@@ -1805,7 +1805,7 @@ fn encode_metadata_inner(wr: &mut MemWriter, parms: EncodeParams, krate: &Crate)\n         dep_bytes: 0,\n         lang_item_bytes: 0,\n         native_lib_bytes: 0,\n-        macro_registrar_fn_bytes: 0,\n+        plugin_registrar_fn_bytes: 0,\n         macro_defs_bytes: 0,\n         impl_bytes: 0,\n         misc_bytes: 0,\n@@ -1870,10 +1870,10 @@ fn encode_metadata_inner(wr: &mut MemWriter, parms: EncodeParams, krate: &Crate)\n     encode_native_libraries(&ecx, &mut ebml_w);\n     stats.native_lib_bytes = ebml_w.writer.tell().unwrap() - i;\n \n-    // Encode the macro registrar function\n+    // Encode the plugin registrar function\n     i = ebml_w.writer.tell().unwrap();\n-    encode_macro_registrar_fn(&ecx, &mut ebml_w);\n-    stats.macro_registrar_fn_bytes = ebml_w.writer.tell().unwrap() - i;\n+    encode_plugin_registrar_fn(&ecx, &mut ebml_w);\n+    stats.plugin_registrar_fn_bytes = ebml_w.writer.tell().unwrap() - i;\n \n     // Encode macro definitions\n     i = ebml_w.writer.tell().unwrap();\n@@ -1912,18 +1912,18 @@ fn encode_metadata_inner(wr: &mut MemWriter, parms: EncodeParams, krate: &Crate)\n         }\n \n         println!(\"metadata stats:\");\n-        println!(\"      attribute bytes: {}\", stats.attr_bytes);\n-        println!(\"            dep bytes: {}\", stats.dep_bytes);\n-        println!(\"      lang item bytes: {}\", stats.lang_item_bytes);\n-        println!(\"         native bytes: {}\", stats.native_lib_bytes);\n-        println!(\"macro registrar bytes: {}\", stats.macro_registrar_fn_bytes);\n-        println!(\"      macro def bytes: {}\", stats.macro_defs_bytes);\n-        println!(\"           impl bytes: {}\", stats.impl_bytes);\n-        println!(\"           misc bytes: {}\", stats.misc_bytes);\n-        println!(\"           item bytes: {}\", stats.item_bytes);\n-        println!(\"          index bytes: {}\", stats.index_bytes);\n-        println!(\"           zero bytes: {}\", stats.zero_bytes);\n-        println!(\"          total bytes: {}\", stats.total_bytes);\n+        println!(\"       attribute bytes: {}\", stats.attr_bytes);\n+        println!(\"             dep bytes: {}\", stats.dep_bytes);\n+        println!(\"       lang item bytes: {}\", stats.lang_item_bytes);\n+        println!(\"          native bytes: {}\", stats.native_lib_bytes);\n+        println!(\"plugin registrar bytes: {}\", stats.plugin_registrar_fn_bytes);\n+        println!(\"       macro def bytes: {}\", stats.macro_defs_bytes);\n+        println!(\"            impl bytes: {}\", stats.impl_bytes);\n+        println!(\"            misc bytes: {}\", stats.misc_bytes);\n+        println!(\"            item bytes: {}\", stats.item_bytes);\n+        println!(\"           index bytes: {}\", stats.index_bytes);\n+        println!(\"            zero bytes: {}\", stats.zero_bytes);\n+        println!(\"           total bytes: {}\", stats.total_bytes);\n     }\n }\n "}, {"sha": "ad35c4efe1138adc6eb2a48b86c62ab83e3aeadf", "filename": "src/librustc/plugin/build.rs", "status": "renamed", "additions": 20, "deletions": 17, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fplugin%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fplugin%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fplugin%2Fbuild.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -8,23 +8,25 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-use ast;\n-use attr;\n-use codemap::Span;\n-use diagnostic;\n-use visit;\n-use visit::Visitor;\n+//! Used by `rustc` when compiling a plugin crate.\n \n-struct MacroRegistrarContext {\n+use syntax::ast;\n+use syntax::attr;\n+use syntax::codemap::Span;\n+use syntax::diagnostic;\n+use syntax::visit;\n+use syntax::visit::Visitor;\n+\n+struct RegistrarFinder {\n     registrars: Vec<(ast::NodeId, Span)> ,\n }\n \n-impl Visitor<()> for MacroRegistrarContext {\n+impl Visitor<()> for RegistrarFinder {\n     fn visit_item(&mut self, item: &ast::Item, _: ()) {\n         match item.node {\n             ast::ItemFn(..) => {\n                 if attr::contains_name(item.attrs.as_slice(),\n-                                       \"macro_registrar\") {\n+                                       \"plugin_registrar\") {\n                     self.registrars.push((item.id, item.span));\n                 }\n             }\n@@ -35,20 +37,21 @@ impl Visitor<()> for MacroRegistrarContext {\n     }\n }\n \n-pub fn find_macro_registrar(diagnostic: &diagnostic::SpanHandler,\n-                            krate: &ast::Crate) -> Option<ast::NodeId> {\n-    let mut ctx = MacroRegistrarContext { registrars: Vec::new() };\n-    visit::walk_crate(&mut ctx, krate, ());\n+/// Find the function marked with `#[plugin_registrar]`, if any.\n+pub fn find_plugin_registrar(diagnostic: &diagnostic::SpanHandler,\n+                             krate: &ast::Crate) -> Option<ast::NodeId> {\n+    let mut finder = RegistrarFinder { registrars: Vec::new() };\n+    visit::walk_crate(&mut finder, krate, ());\n \n-    match ctx.registrars.len() {\n+    match finder.registrars.len() {\n         0 => None,\n         1 => {\n-            let (node_id, _) = ctx.registrars.pop().unwrap();\n+            let (node_id, _) = finder.registrars.pop().unwrap();\n             Some(node_id)\n         },\n         _ => {\n-            diagnostic.handler().err(\"multiple macro registration functions found\");\n-            for &(_, span) in ctx.registrars.iter() {\n+            diagnostic.handler().err(\"multiple plugin registration functions found\");\n+            for &(_, span) in finder.registrars.iter() {\n                 diagnostic.span_note(span, \"one is here\");\n             }\n             diagnostic.handler().abort_if_errors();", "previous_filename": "src/libsyntax/ext/registrar.rs"}, {"sha": "ba50a15a82ba7d4ce795c3331689a198ce216309", "filename": "src/librustc/plugin/load.rs", "status": "added", "additions": 145, "deletions": 0, "changes": 145, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fplugin%2Fload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fplugin%2Fload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fplugin%2Fload.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -0,0 +1,145 @@\n+// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+//! Used by `rustc` when loading a plugin.\n+\n+use driver::session::Session;\n+use metadata::creader::PluginMetadataReader;\n+use plugin::registry::Registry;\n+\n+use std::mem;\n+use std::os;\n+use std::unstable::dynamic_lib::DynamicLibrary;\n+use syntax::ast;\n+use syntax::attr;\n+use syntax::visit;\n+use syntax::visit::Visitor;\n+use syntax::ext::expand::ExportedMacros;\n+use syntax::attr::AttrMetaMethods;\n+\n+/// Plugin-related crate metadata.\n+pub struct PluginMetadata {\n+    /// Source code of macros exported by the crate.\n+    pub macros: Vec<String>,\n+    /// Path to the shared library file.\n+    pub lib: Option<Path>,\n+    /// Symbol name of the plugin registrar function.\n+    pub registrar_symbol: Option<String>,\n+}\n+\n+/// Pointer to a registrar function.\n+pub type PluginRegistrarFun =\n+    fn(&mut Registry);\n+\n+/// Information about loaded plugins.\n+pub struct Plugins {\n+    /// Source code of exported macros.\n+    pub macros: Vec<ExportedMacros>,\n+    /// Registrars, as function pointers.\n+    pub registrars: Vec<PluginRegistrarFun>,\n+}\n+\n+struct PluginLoader<'a> {\n+    sess: &'a Session,\n+    reader: PluginMetadataReader<'a>,\n+    plugins: Plugins,\n+}\n+\n+impl<'a> PluginLoader<'a> {\n+    fn new(sess: &'a Session) -> PluginLoader<'a> {\n+        PluginLoader {\n+            sess: sess,\n+            reader: PluginMetadataReader::new(sess),\n+            plugins: Plugins {\n+                macros: vec!(),\n+                registrars: vec!(),\n+            },\n+        }\n+    }\n+}\n+\n+/// Read plugin metadata and dynamically load registrar functions.\n+pub fn load_plugins(sess: &Session, krate: &ast::Crate) -> Plugins {\n+    let mut loader = PluginLoader::new(sess);\n+    visit::walk_crate(&mut loader, krate, ());\n+    loader.plugins\n+}\n+\n+impl<'a> Visitor<()> for PluginLoader<'a> {\n+    fn visit_view_item(&mut self, vi: &ast::ViewItem, _: ()) {\n+        match vi.node {\n+            ast::ViewItemExternCrate(name, _, _) => {\n+                let mut plugin_phase = false;\n+\n+                for attr in vi.attrs.iter().filter(|a| a.check_name(\"phase\")) {\n+                    let phases = attr.meta_item_list().unwrap_or(&[]);\n+                    if attr::contains_name(phases, \"plugin\") {\n+                        plugin_phase = true;\n+                    }\n+                    if attr::contains_name(phases, \"syntax\") {\n+                        plugin_phase = true;\n+                        self.sess.span_warn(attr.span,\n+                            \"phase(syntax) is a deprecated synonym for phase(plugin)\");\n+                    }\n+                }\n+\n+                if !plugin_phase { return; }\n+\n+                let PluginMetadata { macros, lib, registrar_symbol } =\n+                    self.reader.read_plugin_metadata(vi);\n+\n+                self.plugins.macros.push(ExportedMacros {\n+                    crate_name: name,\n+                    macros: macros,\n+                });\n+\n+                match (lib, registrar_symbol) {\n+                    (Some(lib), Some(symbol))\n+                        => self.dylink_registrar(vi, lib, symbol),\n+                    _ => (),\n+                }\n+            }\n+            _ => (),\n+        }\n+    }\n+}\n+\n+impl<'a> PluginLoader<'a> {\n+    // Dynamically link a registrar function into the compiler process.\n+    fn dylink_registrar(&mut self, vi: &ast::ViewItem, path: Path, symbol: String) {\n+        // Make sure the path contains a / or the linker will search for it.\n+        let path = os::make_absolute(&path);\n+\n+        let lib = match DynamicLibrary::open(Some(&path)) {\n+            Ok(lib) => lib,\n+            // this is fatal: there are almost certainly macros we need\n+            // inside this crate, so continue would spew \"macro undefined\"\n+            // errors\n+            Err(err) => self.sess.span_fatal(vi.span, err.as_slice())\n+        };\n+\n+        unsafe {\n+            let registrar: PluginRegistrarFun =\n+                match lib.symbol(symbol.as_slice()) {\n+                    Ok(registrar) => registrar,\n+                    // again fatal if we can't register macros\n+                    Err(err) => self.sess.span_fatal(vi.span, err.as_slice())\n+                };\n+\n+            self.plugins.registrars.push(registrar);\n+\n+            // Intentionally leak the dynamic library. We can't ever unload it\n+            // since the library can make things that will live arbitrarily long\n+            // (e.g. an @-box cycle or a task).\n+            mem::forget(lib);\n+\n+        }\n+    }\n+}"}, {"sha": "fa70ffc7392f3c2b4405393e1cbed15fc9a5ec85", "filename": "src/librustc/plugin/mod.rs", "status": "added", "additions": 64, "deletions": 0, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fplugin%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fplugin%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fplugin%2Fmod.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -0,0 +1,64 @@\n+// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+/*!\n+ * Infrastructure for compiler plugins.\n+ *\n+ * Plugins are Rust libraries which extend the behavior of `rustc`\n+ * in various ways.\n+ *\n+ * Plugin authors will use the `Registry` type re-exported by\n+ * this module, along with its methods.  The rest of the module\n+ * is for use by `rustc` itself.\n+ *\n+ * To define a plugin, build a dylib crate with a\n+ * `#[plugin_registrar]` function:\n+ *\n+ * ```rust,ignore\n+ * #![crate_id = \"myplugin\"]\n+ * #![crate_type = \"dylib\"]\n+ * #![feature(plugin_registrar)]\n+ *\n+ * extern crate rustc;\n+ *\n+ * use rustc::plugin::Registry;\n+ *\n+ * #[plugin_registrar]\n+ * pub fn plugin_registrar(reg: &mut Registry) {\n+ *     reg.register_macro(\"mymacro\", expand_mymacro);\n+ * }\n+ *\n+ * fn expand_mymacro(...) {  // details elided\n+ * ```\n+ *\n+ * WARNING: We currently don't check that the registrar function\n+ * has the appropriate type!\n+ *\n+ * To use a plugin while compiling another crate:\n+ *\n+ * ```rust\n+ * #![feature(phase)]\n+ *\n+ * #[phase(plugin)]\n+ * extern crate myplugin;\n+ * ```\n+ *\n+ * If you also need the plugin crate available at runtime, use\n+ * `phase(plugin, link)`.\n+ *\n+ * See `src/test/auxiliary/macro_crate_test.rs` and `src/libfourcc`\n+ * for examples of syntax extension plugins.\n+ */\n+\n+pub use self::registry::Registry;\n+\n+pub mod registry;\n+pub mod load;\n+pub mod build;"}, {"sha": "f6e37822325a8227c027c4281b6653a56a1d3af6", "filename": "src/librustc/plugin/registry.rs", "status": "added", "additions": 70, "deletions": 0, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fplugin%2Fregistry.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustc%2Fplugin%2Fregistry.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fplugin%2Fregistry.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -0,0 +1,70 @@\n+// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+//! Used by plugin crates to tell `rustc` about the plugins they provide.\n+\n+use syntax::ext::base::{SyntaxExtension, NamedSyntaxExtension, NormalTT};\n+use syntax::ext::base::{IdentTT, ItemDecorator, ItemModifier, BasicMacroExpander};\n+use syntax::ext::base::{MacroExpanderFn};\n+use syntax::codemap::Span;\n+use syntax::parse::token;\n+use syntax::ast;\n+\n+/// Structure used to register plugins.\n+///\n+/// A plugin registrar function takes an `&mut Registry` and should call\n+/// methods to register its plugins.\n+///\n+/// This struct has public fields and other methods for use by `rustc`\n+/// itself. They are not documented here, and plugin authors should\n+/// not use them.\n+pub struct Registry {\n+    #[doc(hidden)]\n+    pub krate_span: Span,\n+\n+    #[doc(hidden)]\n+    pub syntax_exts: Vec<NamedSyntaxExtension>,\n+}\n+\n+impl Registry {\n+    #[doc(hidden)]\n+    pub fn new(krate: &ast::Crate) -> Registry {\n+        Registry {\n+            krate_span: krate.span,\n+            syntax_exts: vec!(),\n+        }\n+    }\n+\n+    /// Register a syntax extension of any kind.\n+    ///\n+    /// This is the most general hook into `libsyntax`'s expansion behavior.\n+    pub fn register_syntax_extension(&mut self, name: ast::Name, extension: SyntaxExtension) {\n+        self.syntax_exts.push((name, match extension {\n+            NormalTT(ext, _) => NormalTT(ext, Some(self.krate_span)),\n+            IdentTT(ext, _) => IdentTT(ext, Some(self.krate_span)),\n+            ItemDecorator(ext) => ItemDecorator(ext),\n+            ItemModifier(ext) => ItemModifier(ext),\n+        }));\n+    }\n+\n+    /// Register a macro of the usual kind.\n+    ///\n+    /// This is a convenience wrapper for `register_syntax_extension`.\n+    /// It builds for you a `NormalTT` with a `BasicMacroExpander`,\n+    /// and also takes care of interning the macro's name.\n+    pub fn register_macro(&mut self, name: &str, expander: MacroExpanderFn) {\n+        self.register_syntax_extension(\n+            token::intern(name),\n+            NormalTT(box BasicMacroExpander {\n+                expander: expander,\n+                span: None,\n+            }, None));\n+    }\n+}"}, {"sha": "f848c5224b7c8318552fb1f404e3d0000709ac6a", "filename": "src/librustdoc/core.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustdoc%2Fcore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustdoc%2Fcore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fcore.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -10,7 +10,6 @@\n \n use rustc;\n use rustc::{driver, middle};\n-use rustc::metadata::creader::Loader;\n use rustc::middle::privacy;\n use rustc::middle::lint;\n \n@@ -100,8 +99,8 @@ fn get_ast_and_resolve(cpath: &Path, libs: HashSet<Path>, cfgs: Vec<String>)\n     }\n \n     let krate = phase_1_parse_input(&sess, cfg, &input);\n-    let (krate, ast_map) = phase_2_configure_and_expand(&sess, &mut Loader::new(&sess),\n-                                                        krate, &from_str(\"rustdoc\").unwrap());\n+    let (krate, ast_map) = phase_2_configure_and_expand(&sess, krate,\n+                                                        &from_str(\"rustdoc\").unwrap());\n     let driver::driver::CrateAnalysis {\n         exported_items, public_items, ty_cx, ..\n     } = phase_3_run_analysis_passes(sess, &krate, ast_map);"}, {"sha": "05875f59fbe1852bb4da502a1cdba1f47aceeb71", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -19,15 +19,21 @@\n extern crate debug;\n extern crate getopts;\n extern crate libc;\n-#[phase(syntax, link)]\n-extern crate log;\n extern crate rustc;\n extern crate serialize;\n extern crate sync;\n extern crate syntax;\n extern crate testing = \"test\";\n extern crate time;\n \n+#[cfg(stage0)]\n+#[phase(syntax, link)]\n+extern crate log;\n+\n+#[cfg(not(stage0))]\n+#[phase(plugin, link)]\n+extern crate log;\n+\n use std::io;\n use std::io::{File, MemWriter};\n use std::str;"}, {"sha": "3436305829791456662c98b6cc355ced2f88b37d", "filename": "src/librustdoc/test.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustdoc%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustdoc%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ftest.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -23,7 +23,6 @@ use rustc::back::link;\n use rustc::driver::config;\n use rustc::driver::driver;\n use rustc::driver::session;\n-use rustc::metadata::creader::Loader;\n use syntax::ast;\n use syntax::codemap::{CodeMap, dummy_spanned};\n use syntax::diagnostic;\n@@ -68,7 +67,7 @@ pub fn run(input: &str,\n         @dummy_spanned(ast::MetaWord(cfg_))\n     }));\n     let krate = driver::phase_1_parse_input(&sess, cfg, &input);\n-    let (krate, _) = driver::phase_2_configure_and_expand(&sess, &mut Loader::new(&sess), krate,\n+    let (krate, _) = driver::phase_2_configure_and_expand(&sess, krate,\n                                                           &from_str(\"rustdoc-test\").unwrap());\n \n     let ctx = @core::DocContext {"}, {"sha": "bb57f5c038c0323c4f111c814f37d427f4dd2f3c", "filename": "src/librustrt/lib.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustrt%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibrustrt%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustrt%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -19,16 +19,24 @@\n #![no_std]\n #![experimental]\n \n+#[cfg(stage0)]\n #[phase(syntax, link)]\n extern crate core;\n+\n+#[cfg(not(stage0))]\n+#[phase(plugin, link)]\n+extern crate core;\n+\n extern crate alloc;\n extern crate libc;\n extern crate collections;\n \n #[cfg(test)] extern crate realrustrt = \"rustrt\";\n #[cfg(test)] extern crate test;\n #[cfg(test)] extern crate native;\n-#[cfg(test)] #[phase(syntax, link)] extern crate std;\n+\n+#[cfg(test, stage0)] #[phase(syntax, link)] extern crate std;\n+#[cfg(test, not(stage0))] #[phase(plugin, link)] extern crate std;\n \n pub use self::util::{Stdio, Stdout, Stderr};\n pub use self::unwind::{begin_unwind, begin_unwind_fmt};"}, {"sha": "33d20ed7bcd0fe35313719066df22d713da674e1", "filename": "src/libserialize/lib.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibserialize%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibserialize%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibserialize%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -27,9 +27,15 @@ Core encoding and decoding interfaces.\n // test harness access\n #[cfg(test)]\n extern crate test;\n+\n+#[cfg(stage0)]\n #[phase(syntax, link)]\n extern crate log;\n \n+#[cfg(not(stage0))]\n+#[phase(plugin, link)]\n+extern crate log;\n+\n pub use self::serialize::{Decoder, Encoder, Decodable, Encodable,\n                           DecoderHelpers, EncoderHelpers};\n "}, {"sha": "85813c02d5535be8c25e49515123caf37260e805", "filename": "src/libstd/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibstd%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibstd%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -119,7 +119,8 @@\n #[cfg(test)] extern crate native;\n #[cfg(test)] extern crate green;\n #[cfg(test)] extern crate debug;\n-#[cfg(test)] #[phase(syntax, link)] extern crate log;\n+#[cfg(test, stage0)] #[phase(syntax, link)] extern crate log;\n+#[cfg(test, not(stage0))] #[phase(plugin, link)] extern crate log;\n \n extern crate alloc;\n extern crate core;"}, {"sha": "44d17e6fb95ce13bb7d446aa8f3e8e7b556f7119", "filename": "src/libsync/lib.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibsync%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibsync%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsync%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -25,9 +25,12 @@\n \n #![deny(missing_doc)]\n \n-#[cfg(test)]\n+#[cfg(test, stage0)]\n #[phase(syntax, link)] extern crate log;\n \n+#[cfg(test, not(stage0))]\n+#[phase(plugin, link)] extern crate log;\n+\n extern crate alloc;\n \n pub use comm::{DuplexStream, duplex};"}, {"sha": "e81421cff043deb894c9bf60bba926c1473565ae", "filename": "src/libsyntax/ext/base.rs", "status": "modified", "additions": 4, "deletions": 15, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibsyntax%2Fext%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibsyntax%2Fext%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbase.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -95,9 +95,6 @@ impl IdentMacroExpander for BasicIdentMacroExpander {\n pub type IdentMacroExpanderFn =\n     fn(&mut ExtCtxt, Span, ast::Ident, Vec<ast::TokenTree>) -> Box<MacResult>;\n \n-pub type MacroCrateRegistrationFun =\n-    fn(|ast::Name, SyntaxExtension|);\n-\n /// The result of a macro expansion. The return values of the various\n /// methods are spliced into the AST at the callsite of the macro (or\n /// just into the compiler's internal macro table, for `make_def`).\n@@ -268,6 +265,8 @@ pub enum SyntaxExtension {\n     IdentTT(Box<IdentMacroExpander:'static>, Option<Span>),\n }\n \n+pub type NamedSyntaxExtension = (Name, SyntaxExtension);\n+\n pub struct BlockInfo {\n     // should macros escape from this scope?\n     pub macros_escape: bool,\n@@ -392,32 +391,22 @@ pub fn syntax_expander_table() -> SyntaxEnv {\n     syntax_expanders\n }\n \n-pub struct MacroCrate {\n-    pub lib: Option<Path>,\n-    pub macros: Vec<String>,\n-    pub registrar_symbol: Option<String>,\n-}\n-\n-pub trait CrateLoader {\n-    fn load_crate(&mut self, krate: &ast::ViewItem) -> MacroCrate;\n-}\n-\n // One of these is made during expansion and incrementally updated as we go;\n // when a macro expansion occurs, the resulting nodes have the backtrace()\n // -> expn_info of their expansion context stored into their span.\n pub struct ExtCtxt<'a> {\n     pub parse_sess: &'a parse::ParseSess,\n     pub cfg: ast::CrateConfig,\n     pub backtrace: Option<@ExpnInfo>,\n-    pub ecfg: expand::ExpansionConfig<'a>,\n+    pub ecfg: expand::ExpansionConfig,\n \n     pub mod_path: Vec<ast::Ident> ,\n     pub trace_mac: bool,\n }\n \n impl<'a> ExtCtxt<'a> {\n     pub fn new<'a>(parse_sess: &'a parse::ParseSess, cfg: ast::CrateConfig,\n-                   ecfg: expand::ExpansionConfig<'a>) -> ExtCtxt<'a> {\n+                   ecfg: expand::ExpansionConfig) -> ExtCtxt<'a> {\n         ExtCtxt {\n             parse_sess: parse_sess,\n             cfg: cfg,"}, {"sha": "bb335e7bed0cf9bf8b9dd91fbc470c59899bb113", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 30, "deletions": 122, "changes": 152, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -29,10 +29,6 @@ use visit;\n use visit::Visitor;\n use util::small_vector::SmallVector;\n \n-use std::mem;\n-use std::os;\n-use std::unstable::dynamic_lib::DynamicLibrary;\n-\n pub fn expand_expr(e: @ast::Expr, fld: &mut MacroExpander) -> @ast::Expr {\n     match e.node {\n         // expr_mac should really be expr_ext or something; it's the\n@@ -497,96 +493,6 @@ pub fn expand_item_mac(it: @ast::Item, fld: &mut MacroExpander)\n     return items;\n }\n \n-// load macros from syntax-phase crates\n-pub fn expand_view_item(vi: &ast::ViewItem,\n-                        fld: &mut MacroExpander)\n-                        -> ast::ViewItem {\n-    match vi.node {\n-        ast::ViewItemExternCrate(..) => {\n-            let should_load = vi.attrs.iter().any(|attr| {\n-                attr.check_name(\"phase\") &&\n-                    attr.meta_item_list().map_or(false, |phases| {\n-                        attr::contains_name(phases, \"syntax\")\n-                    })\n-            });\n-\n-            if should_load {\n-                load_extern_macros(vi, fld);\n-            }\n-        }\n-        ast::ViewItemUse(_) => {}\n-    }\n-\n-    noop_fold_view_item(vi, fld)\n-}\n-\n-fn load_extern_macros(krate: &ast::ViewItem, fld: &mut MacroExpander) {\n-    let MacroCrate { lib, macros, registrar_symbol } =\n-        fld.cx.ecfg.loader.load_crate(krate);\n-\n-    let crate_name = match krate.node {\n-        ast::ViewItemExternCrate(name, _, _) => name,\n-        _ => unreachable!()\n-    };\n-    let name = format!(\"<{} macros>\", token::get_ident(crate_name));\n-    let name = name.to_string();\n-\n-    for source in macros.iter() {\n-        let item = parse::parse_item_from_source_str(name.clone(),\n-                                                     (*source).clone(),\n-                                                     fld.cx.cfg(),\n-                                                     fld.cx.parse_sess())\n-                .expect(\"expected a serialized item\");\n-        expand_item_mac(item, fld);\n-    }\n-\n-    let path = match lib {\n-        Some(path) => path,\n-        None => return\n-    };\n-    // Make sure the path contains a / or the linker will search for it.\n-    let path = os::make_absolute(&path);\n-\n-    let registrar = match registrar_symbol {\n-        Some(registrar) => registrar,\n-        None => return\n-    };\n-\n-    debug!(\"load_extern_macros: mapped crate {} to path {} and registrar {:s}\",\n-           crate_name, path.display(), registrar);\n-\n-    let lib = match DynamicLibrary::open(Some(&path)) {\n-        Ok(lib) => lib,\n-        // this is fatal: there are almost certainly macros we need\n-        // inside this crate, so continue would spew \"macro undefined\"\n-        // errors\n-        Err(err) => fld.cx.span_fatal(krate.span, err.as_slice())\n-    };\n-\n-    unsafe {\n-        let registrar: MacroCrateRegistrationFun =\n-            match lib.symbol(registrar.as_slice()) {\n-                Ok(registrar) => registrar,\n-                // again fatal if we can't register macros\n-                Err(err) => fld.cx.span_fatal(krate.span, err.as_slice())\n-            };\n-        registrar(|name, extension| {\n-            let extension = match extension {\n-                NormalTT(ext, _) => NormalTT(ext, Some(krate.span)),\n-                IdentTT(ext, _) => IdentTT(ext, Some(krate.span)),\n-                ItemDecorator(ext) => ItemDecorator(ext),\n-                ItemModifier(ext) => ItemModifier(ext),\n-            };\n-            fld.extsbox.insert(name, extension);\n-        });\n-\n-        // Intentionally leak the dynamic library. We can't ever unload it\n-        // since the library can do things that will outlive the expansion\n-        // phase (e.g. make an @-box cycle or launch a task).\n-        mem::forget(lib);\n-    }\n-}\n-\n // expand a stmt\n pub fn expand_stmt(s: &Stmt, fld: &mut MacroExpander) -> SmallVector<@Stmt> {\n     // why the copying here and not in expand_expr?\n@@ -969,10 +875,6 @@ impl<'a, 'b> Folder for MacroExpander<'a, 'b> {\n         expand_item(item, self)\n     }\n \n-    fn fold_view_item(&mut self, vi: &ast::ViewItem) -> ast::ViewItem {\n-        expand_view_item(vi, self)\n-    }\n-\n     fn fold_stmt(&mut self, stmt: &ast::Stmt) -> SmallVector<@ast::Stmt> {\n         expand_stmt(stmt, self)\n     }\n@@ -986,21 +888,45 @@ impl<'a, 'b> Folder for MacroExpander<'a, 'b> {\n     }\n }\n \n-pub struct ExpansionConfig<'a> {\n-    pub loader: &'a mut CrateLoader,\n+pub struct ExpansionConfig {\n     pub deriving_hash_type_parameter: bool,\n     pub crate_id: CrateId,\n }\n \n+pub struct ExportedMacros {\n+    pub crate_name: Ident,\n+    pub macros: Vec<String>,\n+}\n+\n pub fn expand_crate(parse_sess: &parse::ParseSess,\n                     cfg: ExpansionConfig,\n+                    macros: Vec<ExportedMacros>,\n+                    user_exts: Vec<NamedSyntaxExtension>,\n                     c: Crate) -> Crate {\n     let mut cx = ExtCtxt::new(parse_sess, c.config.clone(), cfg);\n     let mut expander = MacroExpander {\n         extsbox: syntax_expander_table(),\n         cx: &mut cx,\n     };\n \n+    for ExportedMacros { crate_name, macros } in macros.move_iter() {\n+        let name = format!(\"<{} macros>\", token::get_ident(crate_name))\n+            .into_string();\n+\n+        for source in macros.move_iter() {\n+            let item = parse::parse_item_from_source_str(name.clone(),\n+                                                         source,\n+                                                         expander.cx.cfg(),\n+                                                         expander.cx.parse_sess())\n+                    .expect(\"expected a serialized item\");\n+            expand_item_mac(item, &mut expander);\n+        }\n+    }\n+\n+    for (name, extension) in user_exts.move_iter() {\n+        expander.extsbox.insert(name, extension);\n+    }\n+\n     let ret = expander.fold_crate(c);\n     parse_sess.span_diagnostic.handler().abort_if_errors();\n     return ret;\n@@ -1093,7 +1019,6 @@ mod test {\n     use attr;\n     use codemap;\n     use codemap::Spanned;\n-    use ext::base::{CrateLoader, MacroCrate};\n     use ext::mtwt;\n     use parse;\n     use parse::token;\n@@ -1137,14 +1062,6 @@ mod test {\n         }\n     }\n \n-    struct ErrLoader;\n-\n-    impl CrateLoader for ErrLoader {\n-        fn load_crate(&mut self, _: &ast::ViewItem) -> MacroCrate {\n-            fail!(\"lolwut\")\n-        }\n-    }\n-\n     // these following tests are quite fragile, in that they don't test what\n     // *kind* of failure occurs.\n \n@@ -1159,13 +1076,11 @@ mod test {\n             src,\n             Vec::new(), &sess);\n         // should fail:\n-        let mut loader = ErrLoader;\n         let cfg = ::syntax::ext::expand::ExpansionConfig {\n-            loader: &mut loader,\n             deriving_hash_type_parameter: false,\n             crate_id: from_str(\"test\").unwrap(),\n         };\n-        expand_crate(&sess,cfg,crate_ast);\n+        expand_crate(&sess,cfg,vec!(),vec!(),crate_ast);\n     }\n \n     // make sure that macros can leave scope for modules\n@@ -1178,14 +1093,11 @@ mod test {\n             \"<test>\".to_string(),\n             src,\n             Vec::new(), &sess);\n-        // should fail:\n-        let mut loader = ErrLoader;\n         let cfg = ::syntax::ext::expand::ExpansionConfig {\n-            loader: &mut loader,\n             deriving_hash_type_parameter: false,\n             crate_id: from_str(\"test\").unwrap(),\n         };\n-        expand_crate(&sess,cfg,crate_ast);\n+        expand_crate(&sess,cfg,vec!(),vec!(),crate_ast);\n     }\n \n     // macro_escape modules shouldn't cause macros to leave scope\n@@ -1198,13 +1110,11 @@ mod test {\n             src,\n             Vec::new(), &sess);\n         // should fail:\n-        let mut loader = ErrLoader;\n         let cfg = ::syntax::ext::expand::ExpansionConfig {\n-            loader: &mut loader,\n             deriving_hash_type_parameter: false,\n             crate_id: from_str(\"test\").unwrap(),\n         };\n-        expand_crate(&sess, cfg, crate_ast);\n+        expand_crate(&sess, cfg, vec!(), vec!(), crate_ast);\n     }\n \n     #[test] fn test_contains_flatten (){\n@@ -1237,13 +1147,11 @@ mod test {\n         let ps = parse::new_parse_sess();\n         let crate_ast = string_to_parser(&ps, crate_str).parse_crate_mod();\n         // the cfg argument actually does matter, here...\n-        let mut loader = ErrLoader;\n         let cfg = ::syntax::ext::expand::ExpansionConfig {\n-            loader: &mut loader,\n             deriving_hash_type_parameter: false,\n             crate_id: from_str(\"test\").unwrap(),\n         };\n-        expand_crate(&ps,cfg,crate_ast)\n+        expand_crate(&ps,cfg,vec!(),vec!(),crate_ast)\n     }\n \n     //fn expand_and_resolve(crate_str: @str) -> ast::crate {"}, {"sha": "754518f5fea3192f8cd7239757b63f8f38706a89", "filename": "src/libsyntax/lib.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibsyntax%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibsyntax%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -32,8 +32,15 @@ This API is completely unstable and subject to change.\n \n extern crate serialize;\n extern crate term;\n+\n+#[cfg(stage0)]\n #[phase(syntax, link)]\n extern crate log;\n+\n+#[cfg(not(stage0))]\n+#[phase(plugin, link)]\n+extern crate log;\n+\n extern crate fmt_macros;\n extern crate debug;\n \n@@ -74,7 +81,6 @@ pub mod ext {\n     pub mod asm;\n     pub mod base;\n     pub mod expand;\n-    pub mod registrar;\n \n     pub mod quote;\n "}, {"sha": "76118f642abe0480722ffed527cd58ac3aeb7640", "filename": "src/libterm/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibterm%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibterm%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibterm%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -52,7 +52,8 @@\n \n #![deny(missing_doc)]\n \n-#[phase(syntax, link)] extern crate log;\n+#[cfg(stage0)] #[phase(syntax, link)] extern crate log;\n+#[cfg(not(stage0))] #[phase(plugin, link)] extern crate log;\n \n pub use terminfo::TerminfoTerminal;\n #[cfg(windows)]"}, {"sha": "f2af59433358e44bc1cfeba8f9fa91b0d87aa169", "filename": "src/libtime/lib.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibtime%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Flibtime%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtime%2Flib.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -23,7 +23,9 @@\n #![deny(deprecated_owned_vector)]\n \n #[cfg(test)] extern crate debug;\n-#[cfg(test)] #[phase(syntax, link)] extern crate log;\n+\n+#[cfg(test, stage0)] #[phase(syntax, link)] extern crate log;\n+#[cfg(test, not(stage0))] #[phase(plugin, link)] extern crate log;\n \n extern crate serialize;\n extern crate libc;"}, {"sha": "dfd13851774ebd150c5c4dd1afb61310077e60b5", "filename": "src/test/auxiliary/issue-13560-3.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fauxiliary%2Fissue-13560-3.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fauxiliary%2Fissue-13560-3.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Fissue-13560-3.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,6 +13,6 @@\n #![crate_type = \"rlib\"]\n #![feature(phase)]\n \n-#[phase(syntax)] extern crate t1 = \"issue-13560-1\";\n-#[phase(syntax, link)] extern crate t2 = \"issue-13560-2\";\n+#[phase(plugin)] extern crate t1 = \"issue-13560-1\";\n+#[phase(plugin, link)] extern crate t2 = \"issue-13560-2\";\n "}, {"sha": "0c4af97b4100d9a183e134da2bfcab85a6b624a2", "filename": "src/test/auxiliary/logging_right_crate.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fauxiliary%2Flogging_right_crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fauxiliary%2Flogging_right_crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Flogging_right_crate.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -9,7 +9,7 @@\n // except according to those terms.\n \n #![feature(phase)]\n-#[phase(syntax, link)] extern crate log;\n+#[phase(plugin, link)] extern crate log;\n extern crate debug;\n \n pub fn foo<T>() {"}, {"sha": "805b8a894cb7e24a15a84a7ff341044417e65291", "filename": "src/test/auxiliary/macro_crate_test.rs", "status": "modified", "additions": 10, "deletions": 11, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fauxiliary%2Fmacro_crate_test.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fauxiliary%2Fmacro_crate_test.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Fmacro_crate_test.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -10,29 +10,28 @@\n \n // force-host\n \n-#![feature(globs, macro_registrar, macro_rules, quote, managed_boxes)]\n+#![feature(globs, plugin_registrar, macro_rules, quote, managed_boxes)]\n \n extern crate syntax;\n+extern crate rustc;\n \n-use syntax::ast::{Name, TokenTree, Item, MetaItem};\n+use syntax::ast::{TokenTree, Item, MetaItem};\n use syntax::codemap::Span;\n use syntax::ext::base::*;\n use syntax::parse::token;\n+use rustc::plugin::Registry;\n \n #[macro_export]\n macro_rules! exported_macro (() => (2))\n \n macro_rules! unexported_macro (() => (3))\n \n-#[macro_registrar]\n-pub fn macro_registrar(register: |Name, SyntaxExtension|) {\n-    register(token::intern(\"make_a_1\"),\n-        NormalTT(box BasicMacroExpander {\n-            expander: expand_make_a_1,\n-            span: None,\n-        },\n-        None));\n-    register(token::intern(\"into_foo\"), ItemModifier(expand_into_foo));\n+#[plugin_registrar]\n+pub fn plugin_registrar(reg: &mut Registry) {\n+    reg.register_macro(\"make_a_1\", expand_make_a_1);\n+    reg.register_syntax_extension(\n+        token::intern(\"into_foo\"),\n+        ItemModifier(expand_into_foo));\n }\n \n fn expand_make_a_1(cx: &mut ExtCtxt, sp: Span, tts: &[TokenTree])"}, {"sha": "213fdd6b74a292355cd4a39202c541e41c57ae6e", "filename": "src/test/auxiliary/plugin_crate_outlive_expansion_phase.rs", "status": "renamed", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fauxiliary%2Fplugin_crate_outlive_expansion_phase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fauxiliary%2Fplugin_crate_outlive_expansion_phase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Fplugin_crate_outlive_expansion_phase.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -10,13 +10,12 @@\n \n // force-host\n \n-#![feature(macro_registrar)]\n+#![feature(plugin_registrar)]\n \n-extern crate syntax;\n+extern crate rustc;\n \n use std::any::Any;\n-use syntax::ast::Name;\n-use syntax::ext::base::SyntaxExtension;\n+use rustc::plugin::Registry;\n \n struct Foo {\n     foo: int\n@@ -26,8 +25,8 @@ impl Drop for Foo {\n     fn drop(&mut self) {}\n }\n \n-#[macro_registrar]\n-pub fn registrar(_: |Name, SyntaxExtension|) {\n+#[plugin_registrar]\n+pub fn registrar(_: &mut Registry) {\n     local_data_key!(foo: Box<Any:Send>);\n     foo.replace(Some(box Foo { foo: 10 } as Box<Any:Send>));\n }", "previous_filename": "src/test/auxiliary/macro_crate_outlive_expansion_phase.rs"}, {"sha": "04318fcae2733d2dbf2cbbdd3e56397bd3d6adc2", "filename": "src/test/auxiliary/syntax-extension-with-dll-deps-2.rs", "status": "modified", "additions": 7, "deletions": 11, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fauxiliary%2Fsyntax-extension-with-dll-deps-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fauxiliary%2Fsyntax-extension-with-dll-deps-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Fsyntax-extension-with-dll-deps-2.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -12,24 +12,20 @@\n // no-prefer-dynamic\n \n #![crate_type = \"dylib\"]\n-#![feature(macro_registrar, quote, globs)]\n+#![feature(plugin_registrar, quote, globs)]\n \n extern crate other = \"syntax-extension-with-dll-deps-1\";\n extern crate syntax;\n+extern crate rustc;\n \n-use syntax::ast::{Name, TokenTree, Item, MetaItem};\n+use syntax::ast::{TokenTree, Item, MetaItem};\n use syntax::codemap::Span;\n use syntax::ext::base::*;\n-use syntax::parse::token;\n+use rustc::plugin::Registry;\n \n-#[macro_registrar]\n-pub fn macro_registrar(register: |Name, SyntaxExtension|) {\n-    register(token::intern(\"foo\"),\n-        NormalTT(box BasicMacroExpander {\n-            expander: expand_foo,\n-            span: None,\n-        },\n-        None));\n+#[plugin_registrar]\n+pub fn plugin_registrar(reg: &mut Registry) {\n+    reg.register_macro(\"foo\", expand_foo);\n }\n \n fn expand_foo(cx: &mut ExtCtxt, sp: Span, tts: &[TokenTree])"}, {"sha": "c998e362d7e34f96a3a93a3a16da8fd6d8e9e265", "filename": "src/test/auxiliary/weak-lang-items.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fauxiliary%2Fweak-lang-items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fauxiliary%2Fweak-lang-items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Fweak-lang-items.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -17,7 +17,7 @@\n #![feature(phase)]\n #![crate_type = \"rlib\"]\n \n-#[phase(syntax, link)]\n+#[phase(plugin, link)]\n extern crate core;\n \n struct A;"}, {"sha": "28786f1e163d965898cebb37e67aad8b386ada68", "filename": "src/test/bench/shootout-chameneos-redux.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fbench%2Fshootout-chameneos-redux.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fbench%2Fshootout-chameneos-redux.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fbench%2Fshootout-chameneos-redux.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -11,7 +11,7 @@\n // no-pretty-expanded\n \n #![feature(phase)]\n-#[phase(syntax)] extern crate green;\n+#[phase(plugin)] extern crate green;\n \n use std::string::String;\n use std::fmt;"}, {"sha": "afefaf2b5353c1832728ec1e88d4bf02dd3a41a3", "filename": "src/test/bench/shootout-meteor.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fbench%2Fshootout-meteor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fbench%2Fshootout-meteor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fbench%2Fshootout-meteor.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -39,7 +39,7 @@\n // OF THE POSSIBILITY OF SUCH DAMAGE.\n \n #![feature(phase)]\n-#[phase(syntax)] extern crate green;\n+#[phase(plugin)] extern crate green;\n extern crate sync;\n \n use sync::Arc;"}, {"sha": "ca0248bcf5deacbfceed66fb3f6ad8ca62d9a31a", "filename": "src/test/bench/shootout-regex-dna.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fbench%2Fshootout-regex-dna.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fbench%2Fshootout-regex-dna.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fbench%2Fshootout-regex-dna.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -46,7 +46,7 @@\n #![feature(macro_rules, phase)]\n \n extern crate regex;\n-#[phase(syntax)]extern crate regex_macros;\n+#[phase(plugin)]extern crate regex_macros;\n extern crate sync;\n \n use std::io;"}, {"sha": "15b7ff1e81e8a812ba6dace0960edb135a8da3d6", "filename": "src/test/bench/shootout-spectralnorm.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fbench%2Fshootout-spectralnorm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fbench%2Fshootout-spectralnorm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fbench%2Fshootout-spectralnorm.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -10,7 +10,7 @@\n \n #![feature(phase)]\n #![allow(non_snake_case_functions)]\n-#[phase(syntax)] extern crate green;\n+#[phase(plugin)] extern crate green;\n extern crate sync;\n \n use std::from_str::FromStr;"}, {"sha": "a001ff78ba0bfb8e1cc5c2fdcf0ff416049aefe8", "filename": "src/test/bench/shootout-threadring.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fbench%2Fshootout-threadring.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fbench%2Fshootout-threadring.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fbench%2Fshootout-threadring.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -9,7 +9,7 @@\n // except according to those terms.\n \n #![feature(phase)]\n-#[phase(syntax)] extern crate green;\n+#[phase(plugin)] extern crate green;\n green_start!(main)\n \n fn start(n_tasks: int, token: int) {"}, {"sha": "1f384b856334c0340b5e5b3156f45d05678635bd", "filename": "src/test/compile-fail-fulldeps/gated-phase.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fgated-phase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fgated-phase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fgated-phase.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -11,7 +11,7 @@\n // aux-build:macro_crate_test.rs\n // ignore-stage1\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n //~^ ERROR compile time crate loading is experimental and possibly buggy\n extern crate macro_crate_test;\n "}, {"sha": "39c2accaddf3327dd0259ac7b5344720b4ab4ad6", "filename": "src/test/compile-fail-fulldeps/macro-crate-unexported-macro.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fmacro-crate-unexported-macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fmacro-crate-unexported-macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fmacro-crate-unexported-macro.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -14,7 +14,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate macro_crate_test;\n \n fn main() {"}, {"sha": "7a7eac7b709250ab1d991ebb739e9efde6980575", "filename": "src/test/compile-fail-fulldeps/macro-crate-unknown-crate.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fmacro-crate-unknown-crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fmacro-crate-unknown-crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fmacro-crate-unknown-crate.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -10,7 +10,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate doesnt_exist; //~ ERROR can't find crate\n \n fn main() {}"}, {"sha": "274fbf797e1ef96c14a337d9c34b07f82a262513", "filename": "src/test/compile-fail-fulldeps/phase-syntax-doesnt-resolve.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fphase-syntax-doesnt-resolve.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fphase-syntax-doesnt-resolve.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fphase-syntax-doesnt-resolve.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -14,7 +14,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate macro_crate_test;\n \n fn main() {"}, {"sha": "3ad17618fc0b31e33830f5ced682c7e7e69ff4e0", "filename": "src/test/compile-fail-fulldeps/syntax-extension-fourcc-bad-len.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-bad-len.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-bad-len.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-bad-len.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,7 +13,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate fourcc;\n \n fn main() {"}, {"sha": "4d425d9a2056a62f8e7cbf3b019d4a3bd7592e73", "filename": "src/test/compile-fail-fulldeps/syntax-extension-fourcc-invalid-endian.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-invalid-endian.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-invalid-endian.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-invalid-endian.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,7 +13,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate fourcc;\n \n fn main() {"}, {"sha": "1a6d747c1e8368ee7c84ddec51a33e154c1ba00f", "filename": "src/test/compile-fail-fulldeps/syntax-extension-fourcc-non-ascii-str.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-non-ascii-str.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-non-ascii-str.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-non-ascii-str.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,7 +13,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate fourcc;\n \n fn main() {"}, {"sha": "885d8dd1ec326fcd76ca10634498807e6debb13f", "filename": "src/test/compile-fail-fulldeps/syntax-extension-fourcc-non-literal.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-non-literal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-non-literal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-non-literal.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,7 +13,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate fourcc;\n \n fn main() {"}, {"sha": "da1c0070715686c13e14238171bd70a9ed047019", "filename": "src/test/compile-fail-fulldeps/syntax-extension-fourcc-unsupported-literal.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-unsupported-literal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-unsupported-literal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-fourcc-unsupported-literal.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,7 +13,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate fourcc;\n \n fn main() {"}, {"sha": "191042f5f5639f6876b2c66e2e2cf664916a6417", "filename": "src/test/compile-fail-fulldeps/syntax-extension-hexfloat-bad-lits.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-hexfloat-bad-lits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-hexfloat-bad-lits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-hexfloat-bad-lits.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,7 +13,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate hexfloat;\n \n fn main() {"}, {"sha": "f0ace43ec9e8d34ad66d8b35c601feca8646d0b0", "filename": "src/test/compile-fail-fulldeps/syntax-extension-hexfloat-bad-types.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-hexfloat-bad-types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-hexfloat-bad-types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-hexfloat-bad-types.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,7 +13,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate hexfloat;\n \n fn main() {"}, {"sha": "bccba74e05c70e5dd20988758f68aaabc47bdc01", "filename": "src/test/compile-fail-fulldeps/syntax-extension-regex-invalid.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-regex-invalid.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-regex-invalid.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-regex-invalid.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -15,7 +15,7 @@\n #![feature(phase)]\n \n extern crate regex;\n-#[phase(syntax)] extern crate regex_macros;\n+#[phase(plugin)] extern crate regex_macros;\n \n // Tests to make sure that `regex!` will produce a compile error when given\n // an invalid regular expression."}, {"sha": "819c9e6b0fe2f9bf103e75c9e81621957175f13d", "filename": "src/test/compile-fail-fulldeps/syntax-extension-regex-unused-static.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-regex-unused-static.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-regex-unused-static.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-regex-unused-static.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -15,7 +15,7 @@\n #![feature(phase)]\n \n extern crate regex;\n-#[phase(syntax)] extern crate regex_macros;\n+#[phase(plugin)] extern crate regex_macros;\n \n #[deny(unused_variable)]\n #[deny(dead_code)]"}, {"sha": "d96b3f6f224cfb35c10c0d6ef99052bdcd875e2e", "filename": "src/test/compile-fail-fulldeps/syntax-extension-regex-unused.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-regex-unused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-regex-unused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fsyntax-extension-regex-unused.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -15,7 +15,7 @@\n #![feature(phase)]\n \n extern crate regex;\n-#[phase(syntax)] extern crate regex_macros;\n+#[phase(plugin)] extern crate regex_macros;\n \n #[deny(unused_variable)]\n #[deny(dead_code)]"}, {"sha": "f6e11ffd9e5239c92f732a01c6cbd0969afd6726", "filename": "src/test/compile-fail/gated-plugin_registrar.rs", "status": "renamed", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail%2Fgated-plugin_registrar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail%2Fgated-plugin_registrar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fgated-plugin_registrar.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -9,7 +9,7 @@\n // except according to those terms.\n \n // the registration function isn't typechecked yet\n-#[macro_registrar]\n-pub fn registrar() {} //~ ERROR cross-crate macro exports are experimental\n+#[plugin_registrar]\n+pub fn registrar() {} //~ ERROR compiler plugins are experimental\n \n fn main() {}", "previous_filename": "src/test/compile-fail/gated-macro_registrar.rs"}, {"sha": "f5ebf84b8e0df83823b4a588d4400795fd546bc4", "filename": "src/test/compile-fail/multiple-plugin-registrars.rs", "status": "renamed", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail%2Fmultiple-plugin-registrars.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Fcompile-fail%2Fmultiple-plugin-registrars.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fmultiple-plugin-registrars.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -8,15 +8,15 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-// error-pattern: multiple macro registration functions found\n+// error-pattern: multiple plugin registration functions found\n \n-#![feature(macro_registrar)]\n+#![feature(plugin_registrar)]\n \n // the registration function isn't typechecked yet\n-#[macro_registrar]\n+#[plugin_registrar]\n pub fn one() {}\n \n-#[macro_registrar]\n+#[plugin_registrar]\n pub fn two() {}\n \n fn main() {}", "previous_filename": "src/test/compile-fail/multiple-macro-registrars.rs"}, {"sha": "c960679a43f1e074e56667b13c7cc1f3ac893cfe", "filename": "src/test/run-fail/rt-set-exit-status-fail.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-fail%2Frt-set-exit-status-fail.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-fail%2Frt-set-exit-status-fail.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail%2Frt-set-exit-status-fail.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -11,7 +11,7 @@\n // error-pattern:whatever\n \n #![feature(phase)]\n-#[phase(syntax, link)] extern crate log;\n+#[phase(plugin, link)] extern crate log;\n use std::os;\n \n fn main() {"}, {"sha": "22985d57936a29a1237b5c898dffc022fa097a1c", "filename": "src/test/run-fail/rt-set-exit-status-fail2.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-fail%2Frt-set-exit-status-fail2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-fail%2Frt-set-exit-status-fail2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail%2Frt-set-exit-status-fail2.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -11,7 +11,7 @@\n // error-pattern:whatever\n \n #![feature(phase)]\n-#[phase(syntax, link)] extern crate log;\n+#[phase(plugin, link)] extern crate log;\n use std::os;\n use std::task;\n "}, {"sha": "d08cb198802ad38892d5fb9c91a3b67659ae3e4e", "filename": "src/test/run-fail/rt-set-exit-status.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-fail%2Frt-set-exit-status.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-fail%2Frt-set-exit-status.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail%2Frt-set-exit-status.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -11,7 +11,7 @@\n // error-pattern:whatever\n \n #![feature(phase)]\n-#[phase(syntax, link)] extern crate log;\n+#[phase(plugin, link)] extern crate log;\n use std::os;\n \n fn main() {"}, {"sha": "ec4fbca48f8de393128045daf59c5ba99adf9980", "filename": "src/test/run-make/lto-syntax-extension/main.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-make%2Flto-syntax-extension%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-make%2Flto-syntax-extension%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Flto-syntax-extension%2Fmain.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -11,7 +11,7 @@\n #![feature(phase)]\n \n extern crate lib;\n-#[phase(syntax)] extern crate fourcc;\n+#[phase(plugin)] extern crate fourcc;\n \n fn main() {\n     fourcc!(\"1234\");"}, {"sha": "dd585ea979408ec30e1abd46f9a4960296439bf1", "filename": "src/test/run-pass-fulldeps/macro-crate-outlive-expansion-phase.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass-fulldeps%2Fmacro-crate-outlive-expansion-phase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass-fulldeps%2Fmacro-crate-outlive-expansion-phase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fmacro-crate-outlive-expansion-phase.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -8,12 +8,12 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-// aux-build:macro_crate_outlive_expansion_phase.rs\n+// aux-build:plugin_crate_outlive_expansion_phase.rs\n // ignore-stage1\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n-extern crate macro_crate_outlive_expansion_phase;\n+#[phase(plugin)]\n+extern crate plugin_crate_outlive_expansion_phase;\n \n pub fn main() {}"}, {"sha": "1e796d9d724c66f1e150752fcdd74d1d56cc33e3", "filename": "src/test/run-pass-fulldeps/macro-crate.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass-fulldeps%2Fmacro-crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass-fulldeps%2Fmacro-crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fmacro-crate.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,7 +13,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate macro_crate_test;\n \n #[into_foo]"}, {"sha": "47ff7d31df5f3f2c5744b8a926b6a159033a2b26", "filename": "src/test/run-pass-fulldeps/phase-syntax-link-does-resolve.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass-fulldeps%2Fphase-syntax-link-does-resolve.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass-fulldeps%2Fphase-syntax-link-does-resolve.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fphase-syntax-link-does-resolve.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -17,7 +17,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax, link)]\n+#[phase(plugin, link)]\n extern crate macro_crate_test;\n \n fn main() {"}, {"sha": "b16975fe6eea7068f74f1ab4b702b1f7123663d5", "filename": "src/test/run-pass-fulldeps/syntax-extension-fourcc.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass-fulldeps%2Fsyntax-extension-fourcc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass-fulldeps%2Fsyntax-extension-fourcc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fsyntax-extension-fourcc.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,7 +13,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate fourcc;\n \n static static_val: u32 = fourcc!(\"foo \");"}, {"sha": "496b01113638b180e4963f92602e73d8e2bf474b", "filename": "src/test/run-pass-fulldeps/syntax-extension-hexfloat.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass-fulldeps%2Fsyntax-extension-hexfloat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass-fulldeps%2Fsyntax-extension-hexfloat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fsyntax-extension-hexfloat.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -12,7 +12,7 @@\n // ignore-pretty\n \n #![feature(phase)]\n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate hexfloat;\n \n pub fn main() {"}, {"sha": "275463f5d7fc4ee6cc3e3d564dc89293a0dc3507", "filename": "src/test/run-pass-fulldeps/syntax-extension-with-dll-deps.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass-fulldeps%2Fsyntax-extension-with-dll-deps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass-fulldeps%2Fsyntax-extension-with-dll-deps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fsyntax-extension-with-dll-deps.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -14,7 +14,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate extension = \"syntax-extension-with-dll-deps-2\";\n \n fn main() {"}, {"sha": "3402db7c355a942ac93127554baa1ccec5665c36", "filename": "src/test/run-pass/capturing-logging.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fcapturing-logging.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fcapturing-logging.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fcapturing-logging.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,7 +13,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax, link)]\n+#[phase(plugin, link)]\n extern crate log;\n extern crate native;\n "}, {"sha": "b7c4ccb3c2a360196165b5cd5be80184f92d4064", "filename": "src/test/run-pass/conditional-debug-macro-off.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fconditional-debug-macro-off.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fconditional-debug-macro-off.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fconditional-debug-macro-off.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -12,7 +12,7 @@\n // exec-env:RUST_LOG=conditional-debug-macro-off=4\n \n #![feature(phase)]\n-#[phase(syntax, link)]\n+#[phase(plugin, link)]\n extern crate log;\n extern crate debug;\n "}, {"sha": "df835dab4d4e083d49cfad6d8435c5db2b802c83", "filename": "src/test/run-pass/deprecated-phase-syntax.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fdeprecated-phase-syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fdeprecated-phase-syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fdeprecated-phase-syntax.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2013-2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(phase)]\n+\n+//~ WARNING phase(syntax) is a deprecated synonym for phase(plugin)\n+#[phase(syntax, link)]\n+extern crate log;\n+\n+fn main() {\n+    debug!(\"foo\");\n+}"}, {"sha": "96290386ccc11e4911d802513016464eb3362890", "filename": "src/test/run-pass/issue-14456.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fissue-14456.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fissue-14456.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-14456.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -10,7 +10,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax, link)]\n+#[phase(plugin, link)]\n extern crate green;\n extern crate native;\n "}, {"sha": "7975af434d2846339e1a8f9196ecdd17caf34697", "filename": "src/test/run-pass/logging-enabled-debug.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Flogging-enabled-debug.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Flogging-enabled-debug.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Flogging-enabled-debug.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -12,7 +12,7 @@\n // exec-env:RUST_LOG=logging-enabled-debug=debug\n \n #![feature(phase)]\n-#[phase(syntax, link)]\n+#[phase(plugin, link)]\n extern crate log;\n \n pub fn main() {"}, {"sha": "184ac713c899bfa178e0dd1f5ea2193f7d44344a", "filename": "src/test/run-pass/logging-enabled.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Flogging-enabled.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Flogging-enabled.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Flogging-enabled.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -11,7 +11,7 @@\n // exec-env:RUST_LOG=logging-enabled=info\n \n #![feature(phase)]\n-#[phase(syntax, link)]\n+#[phase(plugin, link)]\n extern crate log;\n \n pub fn main() {"}, {"sha": "989a8d4bde57aa58bd6473348d8477b24318735b", "filename": "src/test/run-pass/logging-separate-lines.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Flogging-separate-lines.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Flogging-separate-lines.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Flogging-separate-lines.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,7 +13,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax, link)]\n+#[phase(plugin, link)]\n extern crate log;\n \n use std::io::Command;"}, {"sha": "25da809babd4391f172cd57ebfec83d77a3a42d4", "filename": "src/test/run-pass/macro-crate-def-only.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fmacro-crate-def-only.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fmacro-crate-def-only.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fmacro-crate-def-only.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -12,7 +12,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate macro_crate_def_only;\n \n pub fn main() {"}, {"sha": "c7911a69ce46a8f16df81115284c367cdf2e316b", "filename": "src/test/run-pass/macro-export-inner-module.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fmacro-export-inner-module.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fmacro-export-inner-module.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fmacro-export-inner-module.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,7 +13,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n extern crate macro_export_inner_module;\n \n pub fn main() {"}, {"sha": "5015e43fa3f346b26cb1f0ecf4489425782cc606", "filename": "src/test/run-pass/phase-use-ignored.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fphase-use-ignored.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Fphase-use-ignored.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fphase-use-ignored.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -11,7 +11,7 @@\n \n #![feature(phase)]\n \n-#[phase(syntax)]\n+#[phase(plugin)]\n use std::mem;\n \n fn main() {}"}, {"sha": "9c4716e5f4d3805aa28877d4b5d41dfd34fc024e", "filename": "src/test/run-pass/tcp-stress.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Ftcp-stress.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ea7aa30cc864d00fc30b9ba610f2daefab4e850/src%2Ftest%2Frun-pass%2Ftcp-stress.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Ftcp-stress.rs?ref=0ea7aa30cc864d00fc30b9ba610f2daefab4e850", "patch": "@@ -13,7 +13,7 @@\n // exec-env:RUST_LOG=debug\n \n #![feature(phase)]\n-#[phase(syntax, link)]\n+#[phase(plugin, link)]\n extern crate log;\n extern crate libc;\n extern crate green;"}]}