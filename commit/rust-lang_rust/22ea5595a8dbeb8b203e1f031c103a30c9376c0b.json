{"sha": "22ea5595a8dbeb8b203e1f031c103a30c9376c0b", "node_id": "C_kwDOAAsO6NoAKDIyZWE1NTk1YThkYmViOGIyMDNlMWYwMzFjMTAzYTMwYzkzNzZjMGI", "commit": {"author": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-01-18T17:17:43Z"}, "committer": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-01-18T17:17:43Z"}, "message": "Don't load auxiliary crates outside the workspace", "tree": {"sha": "f1326f3c839f386098895bf25e07b738e27463d0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f1326f3c839f386098895bf25e07b738e27463d0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/22ea5595a8dbeb8b203e1f031c103a30c9376c0b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/22ea5595a8dbeb8b203e1f031c103a30c9376c0b", "html_url": "https://github.com/rust-lang/rust/commit/22ea5595a8dbeb8b203e1f031c103a30c9376c0b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/22ea5595a8dbeb8b203e1f031c103a30c9376c0b/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ac8806df0846ccc62ee396f38de41310ed1d9934", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac8806df0846ccc62ee396f38de41310ed1d9934", "html_url": "https://github.com/rust-lang/rust/commit/ac8806df0846ccc62ee396f38de41310ed1d9934"}], "stats": {"total": 9, "additions": 9, "deletions": 0}, "files": [{"sha": "96522bf070a4ccc1dddef77d689bb985d5d0b423", "filename": "crates/project_model/src/workspace.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/22ea5595a8dbeb8b203e1f031c103a30c9376c0b/crates%2Fproject_model%2Fsrc%2Fworkspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/22ea5595a8dbeb8b203e1f031c103a30c9376c0b/crates%2Fproject_model%2Fsrc%2Fworkspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject_model%2Fsrc%2Fworkspace.rs?ref=22ea5595a8dbeb8b203e1f031c103a30c9376c0b", "patch": "@@ -574,6 +574,15 @@ fn cargo_to_crate_graph(\n         has_private |= cargo[pkg].metadata.rustc_private;\n         let mut lib_tgt = None;\n         for &tgt in cargo[pkg].targets.iter() {\n+            if cargo[tgt].kind != TargetKind::Lib && !cargo[pkg].is_member {\n+                // For non-workspace-members, Cargo does not resolve dev-dependencies, so we don't\n+                // add any targets except the library target, since those will not work correctly if\n+                // they use dev-dependencies.\n+                // In fact, they can break quite badly if multiple client workspaces get merged:\n+                // https://github.com/rust-analyzer/rust-analyzer/issues/11300\n+                continue;\n+            }\n+\n             if let Some(file_id) = load(&cargo[tgt].root) {\n                 let crate_id = add_target_crate_root(\n                     &mut crate_graph,"}]}