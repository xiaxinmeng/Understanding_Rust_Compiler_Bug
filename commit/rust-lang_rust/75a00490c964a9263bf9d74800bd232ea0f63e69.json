{"sha": "75a00490c964a9263bf9d74800bd232ea0f63e69", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc1YTAwNDkwYzk2NGE5MjYzYmY5ZDc0ODAwYmQyMzJlYTBmNjNlNjk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-05-16T04:00:33Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-05-16T04:00:33Z"}, "message": "Auto merge of #50750 - est31:master, r=eddyb\n\n Remove ScopeTarget and LoopIdResult\n\n* Remove ScopeTarget in preparation of label-break-value (PR #50045)\n* Replace LoopIdResult by Result which is possible now thanks to commit 8ac65af81f5f9cf6c5e2c2306705b50eed77cfb5 \" Implement Encodable and Decodable for Result.\"\n\nr? @eddyb", "tree": {"sha": "7a095168c5902457023b9e930cf15b4a0efb39c6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7a095168c5902457023b9e930cf15b4a0efb39c6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/75a00490c964a9263bf9d74800bd232ea0f63e69", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/75a00490c964a9263bf9d74800bd232ea0f63e69", "html_url": "https://github.com/rust-lang/rust/commit/75a00490c964a9263bf9d74800bd232ea0f63e69", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/75a00490c964a9263bf9d74800bd232ea0f63e69/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3c31e17ddc8914365145683e6d56fa0229a01a8e", "url": "https://api.github.com/repos/rust-lang/rust/commits/3c31e17ddc8914365145683e6d56fa0229a01a8e", "html_url": "https://github.com/rust-lang/rust/commit/3c31e17ddc8914365145683e6d56fa0229a01a8e"}, {"sha": "4d328f786e6a927e6c11bf6e84b976a1971064cb", "url": "https://api.github.com/repos/rust-lang/rust/commits/4d328f786e6a927e6c11bf6e84b976a1971064cb", "html_url": "https://github.com/rust-lang/rust/commit/4d328f786e6a927e6c11bf6e84b976a1971064cb"}], "stats": {"total": 175, "additions": 48, "deletions": 127}, "files": [{"sha": "d8cf147e3ee4b0b8530e9729e01c8be1a196ed9b", "filename": "src/librustc/cfg/construct.rs", "status": "modified", "additions": 5, "deletions": 9, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc%2Fcfg%2Fconstruct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc%2Fcfg%2Fconstruct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fcfg%2Fconstruct.rs?ref=75a00490c964a9263bf9d74800bd232ea0f63e69", "patch": "@@ -582,19 +582,16 @@ impl<'a, 'tcx> CFGBuilder<'a, 'tcx> {\n                   scope_cf_kind: ScopeCfKind) -> (region::Scope, CFGIndex) {\n \n         match destination.target_id {\n-            hir::ScopeTarget::Block(block_expr_id) => {\n+            Ok(loop_id) => {\n                 for b in &self.breakable_block_scopes {\n-                    if b.block_expr_id == self.tcx.hir.node_to_hir_id(block_expr_id).local_id {\n-                        let scope_id = self.tcx.hir.node_to_hir_id(block_expr_id).local_id;\n+                    if b.block_expr_id == self.tcx.hir.node_to_hir_id(loop_id).local_id {\n+                        let scope_id = self.tcx.hir.node_to_hir_id(loop_id).local_id;\n                         return (region::Scope::Node(scope_id), match scope_cf_kind {\n                             ScopeCfKind::Break => b.break_index,\n                             ScopeCfKind::Continue => bug!(\"can't continue to block\"),\n                         });\n                     }\n                 }\n-                span_bug!(expr.span, \"no block expr for id {}\", block_expr_id);\n-            }\n-            hir::ScopeTarget::Loop(hir::LoopIdResult::Ok(loop_id)) => {\n                 for l in &self.loop_scopes {\n                     if l.loop_id == self.tcx.hir.node_to_hir_id(loop_id).local_id {\n                         let scope_id = self.tcx.hir.node_to_hir_id(loop_id).local_id;\n@@ -604,10 +601,9 @@ impl<'a, 'tcx> CFGBuilder<'a, 'tcx> {\n                         });\n                     }\n                 }\n-                span_bug!(expr.span, \"no loop scope for id {}\", loop_id);\n+                span_bug!(expr.span, \"no scope for id {}\", loop_id);\n             }\n-            hir::ScopeTarget::Loop(hir::LoopIdResult::Err(err)) =>\n-                span_bug!(expr.span, \"loop scope error: {}\",  err),\n+            Err(err) => span_bug!(expr.span, \"scope error: {}\",  err),\n         }\n     }\n }"}, {"sha": "1fb496cca629ed0210d3f9f851a2e9a3cebeb855", "filename": "src/librustc/hir/intravisit.rs", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc%2Fhir%2Fintravisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc%2Fhir%2Fintravisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fintravisit.rs?ref=75a00490c964a9263bf9d74800bd232ea0f63e69", "patch": "@@ -1039,10 +1039,8 @@ pub fn walk_expr<'v, V: Visitor<'v>>(visitor: &mut V, expression: &'v Expr) {\n             if let Some(ref label) = destination.label {\n                 visitor.visit_label(label);\n                 match destination.target_id {\n-                    ScopeTarget::Block(node_id) |\n-                    ScopeTarget::Loop(LoopIdResult::Ok(node_id)) =>\n-                        visitor.visit_def_mention(Def::Label(node_id)),\n-                    ScopeTarget::Loop(LoopIdResult::Err(_)) => {},\n+                    Ok(node_id) => visitor.visit_def_mention(Def::Label(node_id)),\n+                    Err(_) => {},\n                 };\n             }\n             walk_list!(visitor, visit_expr, opt_expr);\n@@ -1051,10 +1049,8 @@ pub fn walk_expr<'v, V: Visitor<'v>>(visitor: &mut V, expression: &'v Expr) {\n             if let Some(ref label) = destination.label {\n                 visitor.visit_label(label);\n                 match destination.target_id {\n-                    ScopeTarget::Block(_) => bug!(\"can't `continue` to a non-loop block\"),\n-                    ScopeTarget::Loop(LoopIdResult::Ok(node_id)) =>\n-                        visitor.visit_def_mention(Def::Label(node_id)),\n-                    ScopeTarget::Loop(LoopIdResult::Err(_)) => {},\n+                    Ok(node_id) => visitor.visit_def_mention(Def::Label(node_id)),\n+                    Err(_) => {},\n                 };\n             }\n         }"}, {"sha": "7a360f7ee43d483b736c27617195455c3b733c4a", "filename": "src/librustc/hir/lowering.rs", "status": "modified", "additions": 13, "deletions": 19, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc%2Fhir%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc%2Fhir%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Flowering.rs?ref=75a00490c964a9263bf9d74800bd232ea0f63e69", "patch": "@@ -928,29 +928,27 @@ impl<'a> LoweringContext<'a> {\n     fn lower_loop_destination(&mut self, destination: Option<(NodeId, Label)>) -> hir::Destination {\n         match destination {\n             Some((id, label)) => {\n-                let target = if let Def::Label(loop_id) = self.expect_full_def(id) {\n-                    hir::LoopIdResult::Ok(self.lower_node_id(loop_id).node_id)\n+                let target_id = if let Def::Label(loop_id) = self.expect_full_def(id) {\n+                    Ok(self.lower_node_id(loop_id).node_id)\n                 } else {\n-                    hir::LoopIdResult::Err(hir::LoopIdError::UnresolvedLabel)\n+                    Err(hir::LoopIdError::UnresolvedLabel)\n                 };\n                 hir::Destination {\n                     label: self.lower_label(Some(label)),\n-                    target_id: hir::ScopeTarget::Loop(target),\n+                    target_id,\n                 }\n             }\n             None => {\n-                let loop_id = self.loop_scopes\n+                let target_id = self.loop_scopes\n                     .last()\n-                    .map(|innermost_loop_id| *innermost_loop_id);\n+                    .map(|innermost_loop_id| *innermost_loop_id)\n+                    .map(|id| Ok(self.lower_node_id(id).node_id))\n+                    .unwrap_or(Err(hir::LoopIdError::OutsideLoopScope))\n+                    .into();\n \n                 hir::Destination {\n                     label: None,\n-                    target_id: hir::ScopeTarget::Loop(\n-                        loop_id\n-                            .map(|id| Ok(self.lower_node_id(id).node_id))\n-                            .unwrap_or(Err(hir::LoopIdError::OutsideLoopScope))\n-                            .into(),\n-                    ),\n+                    target_id,\n                 }\n             }\n         }\n@@ -3192,9 +3190,7 @@ impl<'a> LoweringContext<'a> {\n                 let destination = if self.is_in_loop_condition && opt_label.is_none() {\n                     hir::Destination {\n                         label: None,\n-                        target_id: hir::ScopeTarget::Loop(\n-                            Err(hir::LoopIdError::UnlabeledCfInWhileCondition).into(),\n-                        ),\n+                        target_id: Err(hir::LoopIdError::UnlabeledCfInWhileCondition).into(),\n                     }\n                 } else {\n                     self.lower_loop_destination(opt_label.map(|label| (e.id, label)))\n@@ -3208,9 +3204,7 @@ impl<'a> LoweringContext<'a> {\n                 hir::ExprAgain(if self.is_in_loop_condition && opt_label.is_none() {\n                     hir::Destination {\n                         label: None,\n-                        target_id: hir::ScopeTarget::Loop(\n-                            Err(hir::LoopIdError::UnlabeledCfInWhileCondition).into(),\n-                        ),\n+                        target_id: Err(hir::LoopIdError::UnlabeledCfInWhileCondition).into(),\n                     }\n                 } else {\n                     self.lower_loop_destination(opt_label.map(|label| (e.id, label)))\n@@ -3603,7 +3597,7 @@ impl<'a> LoweringContext<'a> {\n                             hir::ExprBreak(\n                                 hir::Destination {\n                                     label: None,\n-                                    target_id: hir::ScopeTarget::Block(catch_node),\n+                                    target_id: Ok(catch_node),\n                                 },\n                                 Some(from_err_expr),\n                             ),"}, {"sha": "3f49e0bfd19837b018ce65970fd9e14de1a59bb2", "filename": "src/librustc/hir/mod.rs", "status": "modified", "additions": 1, "deletions": 41, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc%2Fhir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc%2Fhir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmod.rs?ref=75a00490c964a9263bf9d74800bd232ea0f63e69", "patch": "@@ -1502,54 +1502,14 @@ impl fmt::Display for LoopIdError {\n     }\n }\n \n-// FIXME(cramertj) this should use `Result` once master compiles w/ a vesion of Rust where\n-// `Result` implements `Encodable`/`Decodable`\n-#[derive(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Debug, Copy)]\n-pub enum LoopIdResult {\n-    Ok(NodeId),\n-    Err(LoopIdError),\n-}\n-impl Into<Result<NodeId, LoopIdError>> for LoopIdResult {\n-    fn into(self) -> Result<NodeId, LoopIdError> {\n-        match self {\n-            LoopIdResult::Ok(ok) => Ok(ok),\n-            LoopIdResult::Err(err) => Err(err),\n-        }\n-    }\n-}\n-impl From<Result<NodeId, LoopIdError>> for LoopIdResult {\n-    fn from(res: Result<NodeId, LoopIdError>) -> Self {\n-        match res {\n-            Ok(ok) => LoopIdResult::Ok(ok),\n-            Err(err) => LoopIdResult::Err(err),\n-        }\n-    }\n-}\n-\n-#[derive(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Debug, Copy)]\n-pub enum ScopeTarget {\n-    Block(NodeId),\n-    Loop(LoopIdResult),\n-}\n-\n-impl ScopeTarget {\n-    pub fn opt_id(self) -> Option<NodeId> {\n-        match self {\n-            ScopeTarget::Block(node_id) |\n-            ScopeTarget::Loop(LoopIdResult::Ok(node_id)) => Some(node_id),\n-            ScopeTarget::Loop(LoopIdResult::Err(_)) => None,\n-        }\n-    }\n-}\n-\n #[derive(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Debug, Copy)]\n pub struct Destination {\n     // This is `Some(_)` iff there is an explicit user-specified `label\n     pub label: Option<Label>,\n \n     // These errors are caught and then reported during the diagnostics pass in\n     // librustc_passes/loops.rs\n-    pub target_id: ScopeTarget,\n+    pub target_id: Result<NodeId, LoopIdError>,\n }\n \n #[derive(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Debug, Copy)]"}, {"sha": "6edf1b35bdd734247f59d5c169afdf05d3dedc9e", "filename": "src/librustc/ich/impls_hir.rs", "status": "modified", "additions": 0, "deletions": 10, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc%2Fich%2Fimpls_hir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc%2Fich%2Fimpls_hir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_hir.rs?ref=75a00490c964a9263bf9d74800bd232ea0f63e69", "patch": "@@ -656,22 +656,12 @@ impl_stable_hash_for!(struct hir::Destination {\n \n impl_stable_hash_for_spanned!(ast::Ident);\n \n-impl_stable_hash_for!(enum hir::LoopIdResult {\n-    Ok(node_id),\n-    Err(loop_id_error)\n-});\n-\n impl_stable_hash_for!(enum hir::LoopIdError {\n     OutsideLoopScope,\n     UnlabeledCfInWhileCondition,\n     UnresolvedLabel\n });\n \n-impl_stable_hash_for!(enum hir::ScopeTarget {\n-    Block(node_id),\n-    Loop(loop_id_result)\n-});\n-\n impl<'a> HashStable<StableHashingContext<'a>> for ast::Ident {\n     fn hash_stable<W: StableHasherResult>(&self,\n                                           hcx: &mut StableHashingContext<'a>,"}, {"sha": "2b1663bed2f40d57844a89bdf7e18c341c234bec", "filename": "src/librustc/middle/liveness.rs", "status": "modified", "additions": 5, "deletions": 15, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc%2Fmiddle%2Fliveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc%2Fmiddle%2Fliveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fliveness.rs?ref=75a00490c964a9263bf9d74800bd232ea0f63e69", "patch": "@@ -571,9 +571,6 @@ struct Liveness<'a, 'tcx: 'a> {\n     // it probably doesn't now)\n     break_ln: NodeMap<LiveNode>,\n     cont_ln: NodeMap<LiveNode>,\n-\n-    // mappings from node ID to LiveNode for \"breakable\" blocks-- currently only `catch {...}`\n-    breakable_block_ln: NodeMap<LiveNode>,\n }\n \n impl<'a, 'tcx> Liveness<'a, 'tcx> {\n@@ -601,7 +598,6 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n             users: vec![invalid_users(); num_live_nodes * num_vars],\n             break_ln: NodeMap(),\n             cont_ln: NodeMap(),\n-            breakable_block_ln: NodeMap(),\n         }\n     }\n \n@@ -870,7 +866,7 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n     fn propagate_through_block(&mut self, blk: &hir::Block, succ: LiveNode)\n                                -> LiveNode {\n         if blk.targeted_by_break {\n-            self.breakable_block_ln.insert(blk.id, succ);\n+            self.break_ln.insert(blk.id, succ);\n         }\n         let succ = self.propagate_through_opt_expr(blk.expr.as_ref().map(|e| &**e), succ);\n         blk.stmts.iter().rev().fold(succ, |succ, stmt| {\n@@ -1055,12 +1051,8 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n           hir::ExprBreak(label, ref opt_expr) => {\n               // Find which label this break jumps to\n               let target = match label.target_id {\n-                    hir::ScopeTarget::Block(node_id) =>\n-                        self.breakable_block_ln.get(&node_id),\n-                    hir::ScopeTarget::Loop(hir::LoopIdResult::Ok(node_id)) =>\n-                        self.break_ln.get(&node_id),\n-                    hir::ScopeTarget::Loop(hir::LoopIdResult::Err(err)) =>\n-                        span_bug!(expr.span, \"loop scope error: {}\", err),\n+                    Ok(node_id) => self.break_ln.get(&node_id),\n+                    Err(err) => span_bug!(expr.span, \"loop scope error: {}\", err),\n               }.map(|x| *x);\n \n               // Now that we know the label we're going to,\n@@ -1075,10 +1067,8 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n           hir::ExprAgain(label) => {\n               // Find which label this expr continues to\n               let sc = match label.target_id {\n-                    hir::ScopeTarget::Block(_) => bug!(\"can't `continue` to a non-loop block\"),\n-                    hir::ScopeTarget::Loop(hir::LoopIdResult::Ok(node_id)) => node_id,\n-                    hir::ScopeTarget::Loop(hir::LoopIdResult::Err(err)) =>\n-                        span_bug!(expr.span, \"loop scope error: {}\", err),\n+                    Ok(node_id) => node_id,\n+                    Err(err) => span_bug!(expr.span, \"loop scope error: {}\", err),\n               };\n \n               // Now that we know the label we're going to,"}, {"sha": "3e432d84c699d2846be64074ff6d79edc46b578b", "filename": "src/librustc_mir/hair/cx/expr.rs", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs?ref=75a00490c964a9263bf9d74800bd232ea0f63e69", "patch": "@@ -536,23 +536,19 @@ fn make_mirror_unadjusted<'a, 'gcx, 'tcx>(cx: &mut Cx<'a, 'gcx, 'tcx>,\n         hir::ExprRet(ref v) => ExprKind::Return { value: v.to_ref() },\n         hir::ExprBreak(dest, ref value) => {\n             match dest.target_id {\n-                hir::ScopeTarget::Block(target_id) |\n-                hir::ScopeTarget::Loop(hir::LoopIdResult::Ok(target_id)) => ExprKind::Break {\n+                Ok(target_id) => ExprKind::Break {\n                     label: region::Scope::Node(cx.tcx.hir.node_to_hir_id(target_id).local_id),\n                     value: value.to_ref(),\n                 },\n-                hir::ScopeTarget::Loop(hir::LoopIdResult::Err(err)) =>\n-                    bug!(\"invalid loop id for break: {}\", err)\n+                Err(err) => bug!(\"invalid loop id for break: {}\", err)\n             }\n         }\n         hir::ExprAgain(dest) => {\n             match dest.target_id {\n-                hir::ScopeTarget::Block(_) => bug!(\"cannot continue to blocks\"),\n-                hir::ScopeTarget::Loop(hir::LoopIdResult::Ok(loop_id)) => ExprKind::Continue {\n+                Ok(loop_id) => ExprKind::Continue {\n                     label: region::Scope::Node(cx.tcx.hir.node_to_hir_id(loop_id).local_id),\n                 },\n-                hir::ScopeTarget::Loop(hir::LoopIdResult::Err(err)) =>\n-                    bug!(\"invalid loop id for continue: {}\", err)\n+                Err(err) => bug!(\"invalid loop id for continue: {}\", err)\n             }\n         }\n         hir::ExprMatch(ref discr, ref arms, _) => {"}, {"sha": "81299f4ba9f66cf004732458ec7ed8cc683e70aa", "filename": "src/librustc_passes/loops.rs", "status": "modified", "additions": 15, "deletions": 16, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc_passes%2Floops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc_passes%2Floops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Floops.rs?ref=75a00490c964a9263bf9d74800bd232ea0f63e69", "patch": "@@ -85,20 +85,21 @@ impl<'a, 'hir> Visitor<'hir> for CheckLoopVisitor<'a, 'hir> {\n                 self.with_context(Closure, |v| v.visit_nested_body(b));\n             }\n             hir::ExprBreak(label, ref opt_expr) => {\n-                let loop_id = match label.target_id {\n-                    hir::ScopeTarget::Block(_) => return,\n-                    hir::ScopeTarget::Loop(loop_res) => {\n-                        match loop_res.into() {\n-                            Ok(loop_id) => loop_id,\n-                            Err(hir::LoopIdError::OutsideLoopScope) => ast::DUMMY_NODE_ID,\n-                            Err(hir::LoopIdError::UnlabeledCfInWhileCondition) => {\n-                                self.emit_unlabled_cf_in_while_condition(e.span, \"break\");\n-                                ast::DUMMY_NODE_ID\n-                            },\n-                            Err(hir::LoopIdError::UnresolvedLabel) => ast::DUMMY_NODE_ID,\n-                        }\n-                    }\n+                let loop_id = match label.target_id.into() {\n+                    Ok(loop_id) => loop_id,\n+                    Err(hir::LoopIdError::OutsideLoopScope) => ast::DUMMY_NODE_ID,\n+                    Err(hir::LoopIdError::UnlabeledCfInWhileCondition) => {\n+                        self.emit_unlabled_cf_in_while_condition(e.span, \"break\");\n+                        ast::DUMMY_NODE_ID\n+                    },\n+                    Err(hir::LoopIdError::UnresolvedLabel) => ast::DUMMY_NODE_ID,\n                 };\n+                if loop_id != ast::DUMMY_NODE_ID {\n+                    match self.hir_map.find(loop_id).unwrap() {\n+                        hir::map::NodeBlock(_) => return,\n+                        _=> (),\n+                    }\n+                }\n \n                 if opt_expr.is_some() {\n                     let loop_kind = if loop_id == ast::DUMMY_NODE_ID {\n@@ -132,9 +133,7 @@ impl<'a, 'hir> Visitor<'hir> for CheckLoopVisitor<'a, 'hir> {\n                 self.require_loop(\"break\", e.span);\n             }\n             hir::ExprAgain(label) => {\n-                if let hir::ScopeTarget::Loop(\n-                    hir::LoopIdResult::Err(\n-                        hir::LoopIdError::UnlabeledCfInWhileCondition)) = label.target_id {\n+                if let Err(hir::LoopIdError::UnlabeledCfInWhileCondition) = label.target_id {\n                     self.emit_unlabled_cf_in_while_condition(e.span, \"continue\");\n                 }\n                 self.require_loop(\"continue\", e.span)"}, {"sha": "f98a8ba1e4d6c70fc52291109def800ac667206b", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75a00490c964a9263bf9d74800bd232ea0f63e69/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=75a00490c964a9263bf9d74800bd232ea0f63e69", "patch": "@@ -3726,7 +3726,7 @@ impl<'a, 'gcx, 'tcx> FnCtxt<'a, 'gcx, 'tcx> {\n               tcx.mk_nil()\n           }\n           hir::ExprBreak(destination, ref expr_opt) => {\n-              if let Some(target_id) = destination.target_id.opt_id() {\n+              if let Ok(target_id) = destination.target_id {\n                   let (e_ty, cause);\n                   if let Some(ref e) = *expr_opt {\n                       // If this is a break with a value, we need to type-check"}]}