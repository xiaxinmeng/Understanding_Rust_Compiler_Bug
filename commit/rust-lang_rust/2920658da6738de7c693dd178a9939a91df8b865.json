{"sha": "2920658da6738de7c693dd178a9939a91df8b865", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI5MjA2NThkYTY3MzhkZTdjNjkzZGQxNzhhOTkzOWE5MWRmOGI4NjU=", "commit": {"author": {"name": "Kornel", "email": "kornel@geekhood.net", "date": "2017-08-22T20:20:42Z"}, "committer": {"name": "Kornel", "email": "kornel@geekhood.net", "date": "2017-08-22T20:20:42Z"}, "message": "--print=native-static-libs", "tree": {"sha": "525f42b20f6d496b16f4a268c41f118ae05e3fdf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/525f42b20f6d496b16f4a268c41f118ae05e3fdf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2920658da6738de7c693dd178a9939a91df8b865", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2920658da6738de7c693dd178a9939a91df8b865", "html_url": "https://github.com/rust-lang/rust/commit/2920658da6738de7c693dd178a9939a91df8b865", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2920658da6738de7c693dd178a9939a91df8b865/comments", "author": {"login": "kornelski", "id": 72159, "node_id": "MDQ6VXNlcjcyMTU5", "avatar_url": "https://avatars.githubusercontent.com/u/72159?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kornelski", "html_url": "https://github.com/kornelski", "followers_url": "https://api.github.com/users/kornelski/followers", "following_url": "https://api.github.com/users/kornelski/following{/other_user}", "gists_url": "https://api.github.com/users/kornelski/gists{/gist_id}", "starred_url": "https://api.github.com/users/kornelski/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kornelski/subscriptions", "organizations_url": "https://api.github.com/users/kornelski/orgs", "repos_url": "https://api.github.com/users/kornelski/repos", "events_url": "https://api.github.com/users/kornelski/events{/privacy}", "received_events_url": "https://api.github.com/users/kornelski/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kornelski", "id": 72159, "node_id": "MDQ6VXNlcjcyMTU5", "avatar_url": "https://avatars.githubusercontent.com/u/72159?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kornelski", "html_url": "https://github.com/kornelski", "followers_url": "https://api.github.com/users/kornelski/followers", "following_url": "https://api.github.com/users/kornelski/following{/other_user}", "gists_url": "https://api.github.com/users/kornelski/gists{/gist_id}", "starred_url": "https://api.github.com/users/kornelski/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kornelski/subscriptions", "organizations_url": "https://api.github.com/users/kornelski/orgs", "repos_url": "https://api.github.com/users/kornelski/repos", "events_url": "https://api.github.com/users/kornelski/events{/privacy}", "received_events_url": "https://api.github.com/users/kornelski/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0314e10c3fa6918f48e797cd716f0ec934829803", "url": "https://api.github.com/repos/rust-lang/rust/commits/0314e10c3fa6918f48e797cd716f0ec934829803", "html_url": "https://github.com/rust-lang/rust/commit/0314e10c3fa6918f48e797cd716f0ec934829803"}], "stats": {"total": 49, "additions": 46, "deletions": 3}, "files": [{"sha": "801497cae2acbaf393b31c5b166726dec38df8cc", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2920658da6738de7c693dd178a9939a91df8b865/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2920658da6738de7c693dd178a9939a91df8b865/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=2920658da6738de7c693dd178a9939a91df8b865", "patch": "@@ -340,6 +340,7 @@ pub enum PrintRequest {\n     RelocationModels,\n     CodeModels,\n     TargetSpec,\n+    NativeStaticLibs,\n }\n \n pub enum Input {\n@@ -1292,7 +1293,7 @@ pub fn rustc_short_optgroups() -> Vec<RustcOptGroup> {\n                                print on stdout\",\n                      \"[crate-name|file-names|sysroot|cfg|target-list|\\\n                        target-cpus|target-features|relocation-models|\\\n-                       code-models|target-spec-json]\"),\n+                       code-models|target-spec-json|native-static-deps]\"),\n         opt::flagmulti_s(\"g\",  \"\",  \"Equivalent to -C debuginfo=2\"),\n         opt::flagmulti_s(\"O\", \"\", \"Equivalent to -C opt-level=2\"),\n         opt::opt_s(\"o\", \"\", \"Write output to <filename>\", \"FILENAME\"),\n@@ -1638,6 +1639,7 @@ pub fn build_session_options_and_crate_config(matches: &getopts::Matches)\n             \"target-features\" => PrintRequest::TargetFeatures,\n             \"relocation-models\" => PrintRequest::RelocationModels,\n             \"code-models\" => PrintRequest::CodeModels,\n+            \"native-static-libs\" => PrintRequest::NativeStaticLibs,\n             \"target-spec-json\" => {\n                 if nightly_options::is_unstable_enabled(matches) {\n                     PrintRequest::TargetSpec"}, {"sha": "a82c5e40d7040dc4089b34919b0c9ab5e18272b2", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/2920658da6738de7c693dd178a9939a91df8b865/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2920658da6738de7c693dd178a9939a91df8b865/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=2920658da6738de7c693dd178a9939a91df8b865", "patch": "@@ -742,7 +742,9 @@ impl RustcDefaultCalls {\n                         odir: &Option<PathBuf>,\n                         ofile: &Option<PathBuf>)\n                         -> Compilation {\n-        if sess.opts.prints.is_empty() {\n+        // PrintRequest::NativeStaticLibs is special - printed during linking\n+        // (empty iterator returns true)\n+        if sess.opts.prints.iter().all(|&p| p==PrintRequest::NativeStaticLibs) {\n             return Compilation::Continue;\n         }\n \n@@ -852,6 +854,9 @@ impl RustcDefaultCalls {\n                 PrintRequest::TargetCPUs | PrintRequest::TargetFeatures => {\n                     rustc_trans::print(*req, sess);\n                 }\n+                PrintRequest::NativeStaticLibs => {\n+                    println!(\"Native static libs can be printed only during linking\");\n+                }\n             }\n         }\n         return Compilation::Stop;"}, {"sha": "3c4defb07bb94eb8269bffa6eb65e72caa2b1733", "filename": "src/librustc_trans/back/link.rs", "status": "modified", "additions": 37, "deletions": 1, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/2920658da6738de7c693dd178a9939a91df8b865/src%2Flibrustc_trans%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2920658da6738de7c693dd178a9939a91df8b865/src%2Flibrustc_trans%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Flink.rs?ref=2920658da6738de7c693dd178a9939a91df8b865", "patch": "@@ -15,7 +15,7 @@ use super::linker::Linker;\n use super::rpath::RPathConfig;\n use super::rpath;\n use metadata::METADATA_FILENAME;\n-use rustc::session::config::{self, NoDebugInfo, OutputFilenames, OutputType};\n+use rustc::session::config::{self, NoDebugInfo, OutputFilenames, OutputType, PrintRequest};\n use rustc::session::filesearch;\n use rustc::session::search_paths::PathKind;\n use rustc::session::Session;\n@@ -647,13 +647,20 @@ fn link_staticlib(sess: &Session,\n     ab.build();\n \n     if !all_native_libs.is_empty() {\n+        if sess.opts.prints.contains(&PrintRequest::NativeStaticLibs) {\n+            print_native_static_libs(sess, &all_native_libs);\n+        } else {\n+            // Fallback for backwards compatibility only\n             print_native_static_libs_legacy(sess, &all_native_libs);\n+        }\n     }\n }\n \n fn print_native_static_libs_legacy(sess: &Session, all_native_libs: &[NativeLibrary]) {\n     sess.note_without_error(\"link against the following native artifacts when linking against \\\n                              this static library\");\n+    sess.note_without_error(\"This list will not be printed by default. \\\n+        Please add --print=native-static-libs if you need this information\");\n \n     for lib in all_native_libs.iter().filter(|l| relevant_lib(sess, l)) {\n         let name = match lib.kind {\n@@ -667,6 +674,35 @@ fn print_native_static_libs_legacy(sess: &Session, all_native_libs: &[NativeLibr\n     }\n }\n \n+fn print_native_static_libs(sess: &Session, all_native_libs: &[NativeLibrary]) {\n+    let lib_args: Vec<_> = all_native_libs.iter()\n+        .filter(|l| relevant_lib(sess, l))\n+        .filter_map(|lib| match lib.kind {\n+            NativeLibraryKind::NativeStaticNobundle |\n+            NativeLibraryKind::NativeUnknown => {\n+                if sess.target.target.options.is_like_msvc {\n+                    Some(format!(\"{}.lib\", lib.name))\n+                } else {\n+                    Some(format!(\"-l{}\", lib.name))\n+                }\n+            },\n+            NativeLibraryKind::NativeFramework => {\n+                // ld-only syntax, since there are no frameworks in MSVC\n+                Some(format!(\"-framework {}\", lib.name))\n+            },\n+            // These are included, no need to print them\n+            NativeLibraryKind::NativeStatic => None,\n+        })\n+        .collect();\n+    if !lib_args.is_empty() {\n+        sess.note_without_error(\"Link against the following native artifacts when linking \\\n+                                 against this static library. The order and any duplication \\\n+                                 can be significant on some platforms.\");\n+        // Prefix for greppability\n+        sess.note_without_error(format!(\"native-static-libs: {}\", &lib_args.join(\" \")));\n+    }\n+}\n+\n // Create a dynamic library or executable\n //\n // This will invoke the system linker/cc to create the resulting file. This"}]}