{"sha": "4e09e5479ce2aa0964b0543fccfa18b149ec142a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRlMDllNTQ3OWNlMmFhMDk2NGIwNTQzZmNjZmExOGIxNDllYzE0MmE=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2018-06-04T02:11:40Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-06-04T02:11:40Z"}, "message": "Merge pull request #2751 from topecongiro/issue-2749\n\nFix treating the delimiter right after repeat as repeat as well", "tree": {"sha": "6d1e62bd7f8d458194761c70ef2ba16433233f3b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6d1e62bd7f8d458194761c70ef2ba16433233f3b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4e09e5479ce2aa0964b0543fccfa18b149ec142a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbFJ/cCRBK7hj4Ov3rIwAAdHIIAJelsprkTIrdJTah6LbtzpmR\nauMPRVGyA8H2y4K7la8GXxVLrKOFEOWAzPQ16RCIULizSx3zrWClCi0Hk7S0OkJs\nanqwZWz084Dv+6IMtzjt42Vg2M6d8wZUoOF1ozKaNwHLGgyb7l6BZ5jXTe07oHrL\nB3czh2UmlkUebQHr4GMdodyMc3aLkwdcfNzKdMmqeUFZd4a97azkLh2ZN2Iw31og\nE3FCqm8TK8BDZzgRdkF6782lPW2zmC3sPezD4BkaKt7TxhSI0OMKR9W7luL9bw9i\nY10EDLV2tnR9HfShxbbSk6NR2/2eWs43jZvIGEKuHDi8N0Za6XhUTqdja8BQujw=\n=BFlL\n-----END PGP SIGNATURE-----\n", "payload": "tree 6d1e62bd7f8d458194761c70ef2ba16433233f3b\nparent 1903879d885d17589a96c8a8bda47c0480dba397\nparent 22602045ab2e2b20576fbe3f5c7fc6e4b4bcfa22\nauthor Nick Cameron <nrc@ncameron.org> 1528078300 +1200\ncommitter GitHub <noreply@github.com> 1528078300 +1200\n\nMerge pull request #2751 from topecongiro/issue-2749\n\nFix treating the delimiter right after repeat as repeat as well "}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4e09e5479ce2aa0964b0543fccfa18b149ec142a", "html_url": "https://github.com/rust-lang/rust/commit/4e09e5479ce2aa0964b0543fccfa18b149ec142a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4e09e5479ce2aa0964b0543fccfa18b149ec142a/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1903879d885d17589a96c8a8bda47c0480dba397", "url": "https://api.github.com/repos/rust-lang/rust/commits/1903879d885d17589a96c8a8bda47c0480dba397", "html_url": "https://github.com/rust-lang/rust/commit/1903879d885d17589a96c8a8bda47c0480dba397"}, {"sha": "22602045ab2e2b20576fbe3f5c7fc6e4b4bcfa22", "url": "https://api.github.com/repos/rust-lang/rust/commits/22602045ab2e2b20576fbe3f5c7fc6e4b4bcfa22", "html_url": "https://github.com/rust-lang/rust/commit/22602045ab2e2b20576fbe3f5c7fc6e4b4bcfa22"}], "stats": {"total": 63, "additions": 47, "deletions": 16}, "files": [{"sha": "24e8d2e3406e24e764b714aeab8280f20a2bfb19", "filename": "Cargo.lock", "status": "modified", "additions": 6, "deletions": 13, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/4e09e5479ce2aa0964b0543fccfa18b149ec142a/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/4e09e5479ce2aa0964b0543fccfa18b149ec142a/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=4e09e5479ce2aa0964b0543fccfa18b149ec142a", "patch": "@@ -42,7 +42,7 @@ name = \"backtrace\"\n version = \"0.3.8\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n- \"backtrace-sys 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"backtrace-sys 0.1.23 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"cfg-if 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"libc 0.2.41 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rustc-demangle 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -51,12 +51,11 @@ dependencies = [\n \n [[package]]\n name = \"backtrace-sys\"\n-version = \"0.1.22\"\n+version = \"0.1.23\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n- \"cc 1.0.15 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"cc 1.0.17 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"libc 0.2.41 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"pkg-config 0.3.11 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n@@ -83,7 +82,7 @@ dependencies = [\n \n [[package]]\n name = \"cc\"\n-version = \"1.0.15\"\n+version = \"1.0.17\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \n [[package]]\n@@ -339,11 +338,6 @@ dependencies = [\n  \"winapi 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n-[[package]]\n-name = \"pkg-config\"\n-version = \"0.3.11\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-\n [[package]]\n name = \"proc-macro2\"\n version = \"0.3.8\"\n@@ -805,11 +799,11 @@ dependencies = [\n \"checksum assert_cli 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"3f731a115f8e5ec3a316c711f220656aec2db609797048aec6ae4d3934f048fe\"\n \"checksum atty 0.2.10 (registry+https://github.com/rust-lang/crates.io-index)\" = \"2fc4a1aa4c24c0718a250f0681885c1af91419d242f29eb8f2ab28502d80dbd1\"\n \"checksum backtrace 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)\" = \"dbdd17cd962b570302f5297aea8648d5923e22e555c2ed2d8b2e34eca646bf6d\"\n-\"checksum backtrace-sys 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)\" = \"5fd343a2466c4603f76f38de264bc0526cffc7fa38ba52fb9f13237eccc1ced2\"\n+\"checksum backtrace-sys 0.1.23 (registry+https://github.com/rust-lang/crates.io-index)\" = \"bff67d0c06556c0b8e6b5f090f0eac52d950d9dfd1d35ba04e4ca3543eaf6a7e\"\n \"checksum bitflags 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"d0c54bb8f454c567f21197eefcdbf5679d0bd99f2ddbe52e84c77061952e6789\"\n \"checksum byteorder 1.2.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"74c0b906e9446b0a2e4f760cdb3fa4b2c48cdc6db8766a845c54b6ff063fd2e9\"\n \"checksum cargo_metadata 0.5.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"6ebd6272a2ca4fd39dbabbd6611eb03df45c2259b3b80b39a9ff8fbdcf42a4b3\"\n-\"checksum cc 1.0.15 (registry+https://github.com/rust-lang/crates.io-index)\" = \"0ebb87d1116151416c0cf66a0e3fb6430cccd120fd6300794b4dfaa050ac40ba\"\n+\"checksum cc 1.0.17 (registry+https://github.com/rust-lang/crates.io-index)\" = \"49ec142f5768efb5b7622aebc3fdbdbb8950a4b9ba996393cb76ef7466e8747d\"\n \"checksum cfg-if 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"405216fd8fe65f718daa7102ea808a946b6ce40c742998fbfd3463645552de18\"\n \"checksum colored 1.6.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"b0aa3473e85a3161b59845d6096b289bb577874cafeaf75ea1b1beaa6572c7fc\"\n \"checksum crossbeam-deque 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"f739f8c5363aca78cfb059edf753d8f0d36908c348f3d8d1503f03d8b75d9cf3\"\n@@ -844,7 +838,6 @@ dependencies = [\n \"checksum owning_ref 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"cdf84f41639e037b484f93433aa3897863b561ed65c6e59c7073d7c561710f37\"\n \"checksum parking_lot 0.5.5 (registry+https://github.com/rust-lang/crates.io-index)\" = \"d4d05f1349491390b1730afba60bb20d55761bef489a954546b58b4b34e1e2ac\"\n \"checksum parking_lot_core 0.2.14 (registry+https://github.com/rust-lang/crates.io-index)\" = \"4db1a8ccf734a7bce794cc19b3df06ed87ab2f3907036b693c68f56b4d4537fa\"\n-\"checksum pkg-config 0.3.11 (registry+https://github.com/rust-lang/crates.io-index)\" = \"110d5ee3593dbb73f56294327fe5668bcc997897097cbc76b51e7aed3f52452f\"\n \"checksum proc-macro2 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)\" = \"1b06e2f335f48d24442b35a19df506a835fb3547bc3c06ef27340da9acf5cae7\"\n \"checksum proc-macro2 0.4.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"1fa93823f53cfd0f5ac117b189aed6cfdfb2cfc0a9d82e956dd7927595ed7d46\"\n \"checksum quick-error 1.2.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"9274b940887ce9addde99c4eee6b5c44cc494b182b97e73dc8ffdcb3397fd3f0\""}, {"sha": "ae95acaf3016e153534208aa07bebb3472150ee8", "filename": "src/macros.rs", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4e09e5479ce2aa0964b0543fccfa18b149ec142a/src%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e09e5479ce2aa0964b0543fccfa18b149ec142a/src%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmacros.rs?ref=4e09e5479ce2aa0964b0543fccfa18b149ec142a", "patch": "@@ -493,11 +493,18 @@ fn delim_token_to_str(\n     delim_token: &DelimToken,\n     shape: Shape,\n     use_multiple_lines: bool,\n+    inner_is_empty: bool,\n ) -> (String, String) {\n     let (lhs, rhs) = match *delim_token {\n         DelimToken::Paren => (\"(\", \")\"),\n         DelimToken::Bracket => (\"[\", \"]\"),\n-        DelimToken::Brace => (\"{ \", \" }\"),\n+        DelimToken::Brace => {\n+            if inner_is_empty || use_multiple_lines {\n+                (\"{\", \"}\")\n+            } else {\n+                (\"{ \", \" }\")\n+            }\n+        }\n         DelimToken::NoDelim => (\"\", \"\"),\n     };\n     if use_multiple_lines {\n@@ -553,13 +560,13 @@ impl MacroArgKind {\n         use_multiple_lines: bool,\n     ) -> Option<String> {\n         let rewrite_delimited_inner = |delim_tok, args| -> Option<(String, String, String)> {\n-            let (lhs, rhs) = delim_token_to_str(context, delim_tok, shape, false);\n             let inner = wrap_macro_args(context, args, shape)?;\n+            let (lhs, rhs) = delim_token_to_str(context, delim_tok, shape, false, inner.is_empty());\n             if lhs.len() + inner.len() + rhs.len() <= shape.width {\n                 return Some((lhs, inner, rhs));\n             }\n \n-            let (lhs, rhs) = delim_token_to_str(context, delim_tok, shape, true);\n+            let (lhs, rhs) = delim_token_to_str(context, delim_tok, shape, true, false);\n             let nested_shape = shape\n                 .block_indent(context.config.tab_spaces())\n                 .with_max_width(context.config);\n@@ -830,6 +837,7 @@ impl MacroArgParser {\n \n                     if self.is_meta_var {\n                         self.add_repeat(delimited_arg, delimited.delim, &mut iter, *sp)?;\n+                        self.is_meta_var = false;\n                     } else {\n                         self.add_delimited(delimited_arg, delimited.delim, *sp);\n                     }"}, {"sha": "5ed5f90588300cbaa295c784482e221723cd30ad", "filename": "tests/source/macro_rules.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/4e09e5479ce2aa0964b0543fccfa18b149ec142a/tests%2Fsource%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e09e5479ce2aa0964b0543fccfa18b149ec142a/tests%2Fsource%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fmacro_rules.rs?ref=4e09e5479ce2aa0964b0543fccfa18b149ec142a", "patch": "@@ -194,3 +194,13 @@ macro_rules! m {\n     ($x:) => {};\n     ($($foo:expr)()?) => {};\n }\n+\n+// #2749\n+macro_rules! foo {\n+    ($(x)* {}) => {};\n+    ($(x)* ()) => {};\n+    ($(x)* []) => {};\n+}\n+macro_rules! __wundergraph_expand_sqlite_mutation {\n+    ( $mutation_name:ident $((context = $($context:tt)*))*{ $( $entity_name:ident( $(insert = $insert:ident,)* $(update = $update:ident,)* $(delete = $($delete:tt)+)* ), )* } ) => {};\n+}"}, {"sha": "c366d75cf9165ae0925475d1c028fb3b9a989a8b", "filename": "tests/target/macro_rules.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/4e09e5479ce2aa0964b0543fccfa18b149ec142a/tests%2Ftarget%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e09e5479ce2aa0964b0543fccfa18b149ec142a/tests%2Ftarget%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fmacro_rules.rs?ref=4e09e5479ce2aa0964b0543fccfa18b149ec142a", "patch": "@@ -226,3 +226,23 @@ macro_rules! m {\n     ($x:) => {};\n     ($($foo:expr)()?) => {};\n }\n+\n+// #2749\n+macro_rules! foo {\n+    ($(x)* {}) => {};\n+    ($(x)*()) => {};\n+    ($(x)*[]) => {};\n+}\n+macro_rules! __wundergraph_expand_sqlite_mutation {\n+    (\n+        $mutation_name:ident $((context = $($context:tt)*))* {\n+            $(\n+                $entity_name:ident(\n+                    $(insert = $insert:ident,)*\n+                    $(update = $update:ident,)*\n+                    $(delete = $($delete:tt)+)*\n+                ),\n+            )*\n+        }\n+    ) => {};\n+}"}]}