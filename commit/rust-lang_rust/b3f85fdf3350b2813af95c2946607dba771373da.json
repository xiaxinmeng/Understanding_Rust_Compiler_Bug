{"sha": "b3f85fdf3350b2813af95c2946607dba771373da", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIzZjg1ZmRmMzM1MGIyODEzYWY5NWMyOTQ2NjA3ZGJhNzcxMzczZGE=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2018-02-24T16:55:48Z"}, "committer": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2018-02-24T20:48:00Z"}, "message": "Rollup merge of #48258 - nrc:save-proc-nested, r=eddyb\n\nsave-analysis: power through bracket mis-counts\n\nCloses #47981\n\nThis is pretty unsatisfying since it is working around a span bug. However, I can't track down the span bug and it could be in the parser, proc macro expansion, the user macro, or Syn (or any other library that can manipulate spans). Given that user code can cause this error, I think we need to be more robust here.\n\nr? @eddyb", "tree": {"sha": "3f4179a6dec7c5cdcaa603cb59602446a525fe61", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3f4179a6dec7c5cdcaa603cb59602446a525fe61"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b3f85fdf3350b2813af95c2946607dba771373da", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b3f85fdf3350b2813af95c2946607dba771373da", "html_url": "https://github.com/rust-lang/rust/commit/b3f85fdf3350b2813af95c2946607dba771373da", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b3f85fdf3350b2813af95c2946607dba771373da/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "387d177ceb1598717cc01eb0969793447b76fb25", "url": "https://api.github.com/repos/rust-lang/rust/commits/387d177ceb1598717cc01eb0969793447b76fb25", "html_url": "https://github.com/rust-lang/rust/commit/387d177ceb1598717cc01eb0969793447b76fb25"}, {"sha": "10fbdb832b2ad5807b89a005f9d4bccaec231fb1", "url": "https://api.github.com/repos/rust-lang/rust/commits/10fbdb832b2ad5807b89a005f9d4bccaec231fb1", "html_url": "https://github.com/rust-lang/rust/commit/10fbdb832b2ad5807b89a005f9d4bccaec231fb1"}], "stats": {"total": 26, "additions": 14, "deletions": 12}, "files": [{"sha": "d5a58c08cbe5a0d950c2ae9bb89b94ea5f5d3737", "filename": "src/librustc_save_analysis/span_utils.rs", "status": "modified", "additions": 14, "deletions": 12, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/b3f85fdf3350b2813af95c2946607dba771373da/src%2Flibrustc_save_analysis%2Fspan_utils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b3f85fdf3350b2813af95c2946607dba771373da/src%2Flibrustc_save_analysis%2Fspan_utils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fspan_utils.rs?ref=b3f85fdf3350b2813af95c2946607dba771373da", "patch": "@@ -115,7 +115,7 @@ impl<'a> SpanUtils<'a> {\n         // We keep track of the following two counts - the depth of nesting of\n         // angle brackets, and the depth of nesting of square brackets. For the\n         // angle bracket count, we only count tokens which occur outside of any\n-        // square brackets (i.e. bracket_count == 0). The intutition here is\n+        // square brackets (i.e. bracket_count == 0). The intuition here is\n         // that we want to count angle brackets in the type, but not any which\n         // could be in expression context (because these could mean 'less than',\n         // etc.).\n@@ -151,18 +151,20 @@ impl<'a> SpanUtils<'a> {\n             }\n             prev = next;\n         }\n-        if angle_count != 0 || bracket_count != 0 {\n-            let loc = self.sess.codemap().lookup_char_pos(span.lo());\n-            span_bug!(\n-                span,\n-                \"Mis-counted brackets when breaking path? Parsing '{}' \\\n-                 in {}, line {}\",\n-                self.snippet(span),\n-                loc.file.name,\n-                loc.line\n-            );\n+        #[cfg(debug_assertions)] {\n+            if angle_count != 0 || bracket_count != 0 {\n+                let loc = self.sess.codemap().lookup_char_pos(span.lo());\n+                span_bug!(\n+                    span,\n+                    \"Mis-counted brackets when breaking path? Parsing '{}' \\\n+                     in {}, line {}\",\n+                    self.snippet(span),\n+                    loc.file.name,\n+                    loc.line\n+                );\n+            }\n         }\n-        if result.is_none() && prev.tok.is_ident() && angle_count == 0 {\n+        if result.is_none() && prev.tok.is_ident() {\n             return Some(prev.sp);\n         }\n         result"}]}