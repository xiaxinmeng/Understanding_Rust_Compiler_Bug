{"sha": "b55a1c561a4789f3728ad97947ced17d1fac8498", "node_id": "C_kwDOAAsO6NoAKGI1NWExYzU2MWE0Nzg5ZjM3MjhhZDk3OTQ3Y2VkMTdkMWZhYzg0OTg", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-01-27T18:09:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-27T18:09:08Z"}, "message": "Merge #11353\n\n11353: Set current working directory for procedural macros r=vlad20012 a=vlad20012\n\nFixes #11079\n\nCo-authored-by: vlad20012 <beskvlad@gmail.com>", "tree": {"sha": "dd7a99f3bd6ac53f791e134bf962b1da36dc0b7a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dd7a99f3bd6ac53f791e134bf962b1da36dc0b7a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b55a1c561a4789f3728ad97947ced17d1fac8498", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh8t/ECRBK7hj4Ov3rIwAAEu8IAAPIHpKatqHYY1h4b7TeOzVj\n+s4ma5JhzEQwZObZw7+kxk7JNniF+hCK8r95PC+frJrcyaTi9tq1jK3IhGElC0Nz\nW8JoNh4ZGXcsd1pzZz5upKwT+UIErD6zWF4DvErecZW0b20NaeAHII41E95YVYId\nVB6TWo26AyK96dZvc8q0OaUwj86qWON9kOz0tWon8ghNxmZi5GKdFb5d93yWRsF4\nrtXPlyKIv06nKP35/QjDRySmti4O3H4486A+H6riM/4+Ki4el9M4m/exJn0xYF8O\niJJGdmqjt/CMds3DHazGyTZu4oElzenEANCmulSVB2cehL8YIqZ6SuJ/pBveVMo=\n=zYfN\n-----END PGP SIGNATURE-----\n", "payload": "tree dd7a99f3bd6ac53f791e134bf962b1da36dc0b7a\nparent 15d8f0c466d901a60ec321c55c6b45180506cdf9\nparent 6051318744f4743d40d91660d41fd8cbe6583d34\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1643306948 +0000\ncommitter GitHub <noreply@github.com> 1643306948 +0000\n\nMerge #11353\n\n11353: Set current working directory for procedural macros r=vlad20012 a=vlad20012\n\nFixes #11079\n\nCo-authored-by: vlad20012 <beskvlad@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b55a1c561a4789f3728ad97947ced17d1fac8498", "html_url": "https://github.com/rust-lang/rust/commit/b55a1c561a4789f3728ad97947ced17d1fac8498", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b55a1c561a4789f3728ad97947ced17d1fac8498/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "15d8f0c466d901a60ec321c55c6b45180506cdf9", "url": "https://api.github.com/repos/rust-lang/rust/commits/15d8f0c466d901a60ec321c55c6b45180506cdf9", "html_url": "https://github.com/rust-lang/rust/commit/15d8f0c466d901a60ec321c55c6b45180506cdf9"}, {"sha": "6051318744f4743d40d91660d41fd8cbe6583d34", "url": "https://api.github.com/repos/rust-lang/rust/commits/6051318744f4743d40d91660d41fd8cbe6583d34", "html_url": "https://github.com/rust-lang/rust/commit/6051318744f4743d40d91660d41fd8cbe6583d34"}], "stats": {"total": 28, "additions": 28, "deletions": 0}, "files": [{"sha": "0b8a2b6f85710846d5af18acd7dc72df3cb14ac4", "filename": "crates/proc_macro_api/src/lib.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b55a1c561a4789f3728ad97947ced17d1fac8498/crates%2Fproc_macro_api%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b55a1c561a4789f3728ad97947ced17d1fac8498/crates%2Fproc_macro_api%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_api%2Fsrc%2Flib.rs?ref=b55a1c561a4789f3728ad97947ced17d1fac8498", "patch": "@@ -156,12 +156,18 @@ impl ProcMacro {\n         attr: Option<&Subtree>,\n         env: Vec<(String, String)>,\n     ) -> Result<Result<Subtree, PanicMessage>, ServerError> {\n+        let current_dir = env\n+            .iter()\n+            .find(|(name, _)| name == \"CARGO_MANIFEST_DIR\")\n+            .map(|(_, value)| value.clone());\n+\n         let task = ExpandMacro {\n             macro_body: FlatTree::new(subtree),\n             macro_name: self.name.to_string(),\n             attributes: attr.map(FlatTree::new),\n             lib: self.dylib_path.to_path_buf().into(),\n             env,\n+            current_dir,\n         };\n \n         let request = msg::Request::ExpandMacro(task);"}, {"sha": "da96c81d49f71d1a74715f6febf6af8085c2e256", "filename": "crates/proc_macro_api/src/msg.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b55a1c561a4789f3728ad97947ced17d1fac8498/crates%2Fproc_macro_api%2Fsrc%2Fmsg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b55a1c561a4789f3728ad97947ced17d1fac8498/crates%2Fproc_macro_api%2Fsrc%2Fmsg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_api%2Fsrc%2Fmsg.rs?ref=b55a1c561a4789f3728ad97947ced17d1fac8498", "patch": "@@ -48,6 +48,8 @@ pub struct ExpandMacro {\n \n     /// Environment variables to set during macro expansion.\n     pub env: Vec<(String, String)>,\n+\n+    pub current_dir: Option<String>,\n }\n \n pub trait Message: Serialize + DeserializeOwned {\n@@ -143,6 +145,7 @@ mod tests {\n             attributes: None,\n             lib: std::env::current_dir().unwrap(),\n             env: Default::default(),\n+            current_dir: Default::default(),\n         };\n \n         let json = serde_json::to_string(&task).unwrap();"}, {"sha": "1698bc967d73fc12a792758e5e25666d0e2798db", "filename": "crates/proc_macro_srv/src/lib.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/b55a1c561a4789f3728ad97947ced17d1fac8498/crates%2Fproc_macro_srv%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b55a1c561a4789f3728ad97947ced17d1fac8498/crates%2Fproc_macro_srv%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_srv%2Fsrc%2Flib.rs?ref=b55a1c561a4789f3728ad97947ced17d1fac8498", "patch": "@@ -43,6 +43,16 @@ impl ProcMacroSrv {\n             prev_env.insert(k.as_str(), env::var_os(k));\n             env::set_var(k, v);\n         }\n+        let prev_working_dir = match task.current_dir {\n+            Some(dir) => {\n+                let prev_working_dir = std::env::current_dir().ok();\n+                if let Err(err) = std::env::set_current_dir(&dir) {\n+                    eprintln!(\"Failed to set the current working dir to {}. Error: {:?}\", dir, err)\n+                }\n+                prev_working_dir\n+            }\n+            None => None,\n+        };\n \n         let macro_body = task.macro_body.to_subtree();\n         let attributes = task.attributes.map(|it| it.to_subtree());\n@@ -56,6 +66,15 @@ impl ProcMacroSrv {\n                 None => env::remove_var(k),\n             }\n         }\n+        if let Some(dir) = prev_working_dir {\n+            if let Err(err) = std::env::set_current_dir(&dir) {\n+                eprintln!(\n+                    \"Failed to set the current working dir to {}. Error: {:?}\",\n+                    dir.display(),\n+                    err\n+                )\n+            }\n+        }\n \n         result.map_err(PanicMessage)\n     }"}]}