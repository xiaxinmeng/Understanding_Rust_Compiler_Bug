{"sha": "99ad915e32744eb771e9a0968bf7d0d1f52a9a07", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk5YWQ5MTVlMzI3NDRlYjc3MWU5YTA5NjhiZjdkMGQxZjUyYTlhMDc=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-11-08T17:27:33Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-12-16T10:33:51Z"}, "message": "compiletest: add split dwarf compare mode\n\nThis commit adds a Split DWARF compare mode to compiletest so that\ndebuginfo tests are also tested using Split DWARF in split mode (and\nmanually in single mode).\n\nSigned-off-by: David Wood <david@davidtw.co>", "tree": {"sha": "f34d412ccdc0a3e0e3380747c4f02de3647e4c66", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f34d412ccdc0a3e0e3380747c4f02de3647e4c66"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/99ad915e32744eb771e9a0968bf7d0d1f52a9a07", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEfgm2/wUjk9OnjxlyJZLnbIc4H9kFAl/Z4o8ACgkQJZLnbIc4\nH9l4MBAAkE+OJRfcB9xGxvmlfIf1NUi4+4XdTZgVjZ4CoCGZ5z0JUIakCw3HmvJ9\nf0IAoVWL8SogCDtQyXlM4Agbogh3dpoMWpttM4VDg2Ozfu1LGhxgN8Ik0gBxz0Ht\nBueQyKM3mhGzNDI6CbEr0uDmI5/kkqylvzza7vPGwjPSLfag/r5tf7UEoyR0frQE\nBgFvyMlqcDOBCge3UI10f2ogDH2ZuHR6WYvSmAzPoeMX1+SmaazOgf2uq9/8awDF\n4hBCQZ2hcVgMI8udsgcfpS+TM6/PCJi3dLh2o/guV/pq0X8zhDfkYo1mKrQWOgkP\n0FYQjpTjJ5Q83Dm/w0zcnhXsi5EqiWaYNPchC6mwF0j64URwvc/nwRDG4uItRFMX\n3DKMxML9O573UoyAFWOikNhjk/rSZA/zUczu3nanai86B6j8vGYiEEcIpNiGXTig\nYU5oqDO6XTfkMtbwB24joAbBR5UyFxEwYQDCXodsxy96BPSA9ZYk0KRy5Ylv6HpF\nT4wxZaS6/4MnZJBTLj6NF0zjQOMXhP1oNiITafUWvIV1Q1ZEYRRuTjduA4kNv1U0\nEZlDBAivAzcLjeU60GdjP0ll9OJXLsQ2v5/pwnPqYpar0Lh0nfoXO5D/D4/kgNaS\nQXvzmYOAWxBdeYKv3qzTW3T6/+Gy8AODET88xVHqFbyTnYbHc0c=\n=Icvk\n-----END PGP SIGNATURE-----", "payload": "tree f34d412ccdc0a3e0e3380747c4f02de3647e4c66\nparent 2b22670bdf614374b9371a229e9bcf692f58c6b3\nauthor David Wood <david@davidtw.co> 1604856453 +0000\ncommitter David Wood <david@davidtw.co> 1608114831 +0000\n\ncompiletest: add split dwarf compare mode\n\nThis commit adds a Split DWARF compare mode to compiletest so that\ndebuginfo tests are also tested using Split DWARF in split mode (and\nmanually in single mode).\n\nSigned-off-by: David Wood <david@davidtw.co>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/99ad915e32744eb771e9a0968bf7d0d1f52a9a07", "html_url": "https://github.com/rust-lang/rust/commit/99ad915e32744eb771e9a0968bf7d0d1f52a9a07", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/99ad915e32744eb771e9a0968bf7d0d1f52a9a07/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2b22670bdf614374b9371a229e9bcf692f58c6b3", "url": "https://api.github.com/repos/rust-lang/rust/commits/2b22670bdf614374b9371a229e9bcf692f58c6b3", "html_url": "https://github.com/rust-lang/rust/commit/2b22670bdf614374b9371a229e9bcf692f58c6b3"}], "stats": {"total": 28, "additions": 27, "deletions": 1}, "files": [{"sha": "ccd4d103ddb7f3fc3d26a4969065edbc6e0302b2", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/99ad915e32744eb771e9a0968bf7d0d1f52a9a07/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/99ad915e32744eb771e9a0968bf7d0d1f52a9a07/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=99ad915e32744eb771e9a0968bf7d0d1f52a9a07", "patch": "@@ -1037,6 +1037,13 @@ fn preserve_objects_for_their_debuginfo(sess: &Session) -> bool {\n         return false;\n     }\n \n+    // Single mode keeps debuginfo in the same object file, but in such a way that it it skipped\n+    // by the linker - so it's expected that when codegen units are linked together that this\n+    // debuginfo would be lost without keeping around the temps.\n+    if sess.opts.debugging_opts.split_dwarf == config::SplitDwarfKind::Single {\n+        return true;\n+    }\n+\n     // If we're on OSX then the equivalent of split dwarf is turned on by\n     // default. The final executable won't actually have any debug information\n     // except it'll have pointers to elsewhere. Historically we've always run"}, {"sha": "b99692e8ba5b8264a166ba5e071f5cd6ff04c3de", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/99ad915e32744eb771e9a0968bf7d0d1f52a9a07/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/99ad915e32744eb771e9a0968bf7d0d1f52a9a07/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=99ad915e32744eb771e9a0968bf7d0d1f52a9a07", "patch": "@@ -897,7 +897,12 @@ default_test!(Incremental {\n     suite: \"incremental\"\n });\n \n-default_test!(Debuginfo { path: \"src/test/debuginfo\", mode: \"debuginfo\", suite: \"debuginfo\" });\n+default_test_with_compare_mode!(Debuginfo {\n+    path: \"src/test/debuginfo\",\n+    mode: \"debuginfo\",\n+    suite: \"debuginfo\",\n+    compare_mode: \"split-dwarf\"\n+});\n \n host_test!(UiFullDeps { path: \"src/test/ui-fulldeps\", mode: \"ui\", suite: \"ui-fulldeps\" });\n "}, {"sha": "80fbb06b9469109fb3efd1a80603faa9e3d460f7", "filename": "src/tools/compiletest/src/common.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/99ad915e32744eb771e9a0968bf7d0d1f52a9a07/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/99ad915e32744eb771e9a0968bf7d0d1f52a9a07/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs?ref=99ad915e32744eb771e9a0968bf7d0d1f52a9a07", "patch": "@@ -127,6 +127,8 @@ pub enum CompareMode {\n     Nll,\n     Polonius,\n     Chalk,\n+    SplitDwarf,\n+    SplitDwarfSingle,\n }\n \n impl CompareMode {\n@@ -135,6 +137,8 @@ impl CompareMode {\n             CompareMode::Nll => \"nll\",\n             CompareMode::Polonius => \"polonius\",\n             CompareMode::Chalk => \"chalk\",\n+            CompareMode::SplitDwarf => \"split-dwarf\",\n+            CompareMode::SplitDwarfSingle => \"split-dwarf-single\",\n         }\n     }\n \n@@ -143,6 +147,8 @@ impl CompareMode {\n             \"nll\" => CompareMode::Nll,\n             \"polonius\" => CompareMode::Polonius,\n             \"chalk\" => CompareMode::Chalk,\n+            \"split-dwarf\" => CompareMode::SplitDwarf,\n+            \"split-dwarf-single\" => CompareMode::SplitDwarfSingle,\n             x => panic!(\"unknown --compare-mode option: {}\", x),\n         }\n     }"}, {"sha": "a1be0a19f68546be500721d6a8586d13b4b803af", "filename": "src/tools/compiletest/src/header.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/99ad915e32744eb771e9a0968bf7d0d1f52a9a07/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/99ad915e32744eb771e9a0968bf7d0d1f52a9a07/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs?ref=99ad915e32744eb771e9a0968bf7d0d1f52a9a07", "patch": "@@ -852,6 +852,8 @@ impl Config {\n                 Some(CompareMode::Nll) => name == \"compare-mode-nll\",\n                 Some(CompareMode::Polonius) => name == \"compare-mode-polonius\",\n                 Some(CompareMode::Chalk) => name == \"compare-mode-chalk\",\n+                Some(CompareMode::SplitDwarf) => name == \"compare-mode-split-dwarf\",\n+                Some(CompareMode::SplitDwarfSingle) => name == \"compare-mode-split-dwarf-single\",\n                 None => false,\n             } ||\n             (cfg!(debug_assertions) && name == \"debug\") ||"}, {"sha": "828c4e89f0b1fd20e6740a3cc66afd234c3ab928", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/99ad915e32744eb771e9a0968bf7d0d1f52a9a07/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/99ad915e32744eb771e9a0968bf7d0d1f52a9a07/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=99ad915e32744eb771e9a0968bf7d0d1f52a9a07", "patch": "@@ -2017,6 +2017,12 @@ impl<'test> TestCx<'test> {\n             Some(CompareMode::Chalk) => {\n                 rustc.args(&[\"-Zchalk\"]);\n             }\n+            Some(CompareMode::SplitDwarf) => {\n+                rustc.args(&[\"-Zsplit-dwarf=split\"]);\n+            }\n+            Some(CompareMode::SplitDwarfSingle) => {\n+                rustc.args(&[\"-Zsplit-dwarf=single\"]);\n+            }\n             None => {}\n         }\n "}]}