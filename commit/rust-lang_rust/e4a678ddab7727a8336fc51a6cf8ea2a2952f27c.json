{"sha": "e4a678ddab7727a8336fc51a6cf8ea2a2952f27c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU0YTY3OGRkYWI3NzI3YTgzMzZmYzUxYTZjZjhlYTJhMjk1MmYyN2M=", "commit": {"author": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2015-02-02T12:26:54Z"}, "committer": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2015-02-05T23:04:32Z"}, "message": "Ported regions-mock-tcx to use TypedArena rather than Arena since it holds\ncyclic structure (which the Arena API updated for dropck cannot handle).", "tree": {"sha": "6f2a4a717bb1b35f585cd6abfed88bd4c3597786", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6f2a4a717bb1b35f585cd6abfed88bd4c3597786"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e4a678ddab7727a8336fc51a6cf8ea2a2952f27c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e4a678ddab7727a8336fc51a6cf8ea2a2952f27c", "html_url": "https://github.com/rust-lang/rust/commit/e4a678ddab7727a8336fc51a6cf8ea2a2952f27c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e4a678ddab7727a8336fc51a6cf8ea2a2952f27c/comments", "author": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "189930fcae287565dcef856ae8d60a83190a4b92", "url": "https://api.github.com/repos/rust-lang/rust/commits/189930fcae287565dcef856ae8d60a83190a4b92", "html_url": "https://github.com/rust-lang/rust/commit/189930fcae287565dcef856ae8d60a83190a4b92"}], "stats": {"total": 19, "additions": 11, "deletions": 8}, "files": [{"sha": "bf789d5364500df680752103028111dccdb92c33", "filename": "src/test/run-pass/regions-mock-tcx.rs", "status": "modified", "additions": 11, "deletions": 8, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/e4a678ddab7727a8336fc51a6cf8ea2a2952f27c/src%2Ftest%2Frun-pass%2Fregions-mock-tcx.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4a678ddab7727a8336fc51a6cf8ea2a2952f27c/src%2Ftest%2Frun-pass%2Fregions-mock-tcx.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fregions-mock-tcx.rs?ref=e4a678ddab7727a8336fc51a6cf8ea2a2952f27c", "patch": "@@ -21,7 +21,7 @@ extern crate libc;\n \n use TypeStructure::{TypeInt, TypeFunction};\n use AstKind::{ExprInt, ExprVar, ExprLambda};\n-use arena::Arena;\n+use arena::TypedArena;\n use std::collections::HashMap;\n use std::mem;\n \n@@ -45,17 +45,20 @@ impl<'tcx> PartialEq for TypeStructure<'tcx> {\n \n impl<'tcx> Eq for TypeStructure<'tcx> {}\n \n+type TyArena<'tcx> = TypedArena<TypeStructure<'tcx>>;\n+type AstArena<'ast> = TypedArena<AstStructure<'ast>>;\n+\n struct TypeContext<'tcx, 'ast> {\n-    ty_arena: &'tcx Arena,\n+    ty_arena: &'tcx TyArena<'tcx>,\n     types: Vec<Type<'tcx>> ,\n     type_table: HashMap<NodeId, Type<'tcx>>,\n \n-    ast_arena: &'ast Arena,\n+    ast_arena: &'ast AstArena<'ast>,\n     ast_counter: uint,\n }\n \n impl<'tcx,'ast> TypeContext<'tcx, 'ast> {\n-    fn new(ty_arena: &'tcx Arena, ast_arena: &'ast Arena)\n+    fn new(ty_arena: &'tcx TyArena<'tcx>, ast_arena: &'ast AstArena<'ast>)\n            -> TypeContext<'tcx, 'ast> {\n         TypeContext { ty_arena: ty_arena,\n                       types: Vec::new(),\n@@ -72,7 +75,7 @@ impl<'tcx,'ast> TypeContext<'tcx, 'ast> {\n             }\n         }\n \n-        let ty = self.ty_arena.alloc(|| s);\n+        let ty = self.ty_arena.alloc(s);\n         self.types.push(ty);\n         ty\n     }\n@@ -85,7 +88,7 @@ impl<'tcx,'ast> TypeContext<'tcx, 'ast> {\n     fn ast(&mut self, a: AstKind<'ast>) -> Ast<'ast> {\n         let id = self.ast_counter;\n         self.ast_counter += 1;\n-        self.ast_arena.alloc(|| AstStructure { id: NodeId {id:id}, kind: a })\n+        self.ast_arena.alloc(AstStructure { id: NodeId {id:id}, kind: a })\n     }\n }\n \n@@ -127,8 +130,8 @@ fn compute_types<'tcx,'ast>(tcx: &mut TypeContext<'tcx,'ast>,\n }\n \n pub fn main() {\n-    let ty_arena = arena::Arena::new();\n-    let ast_arena = arena::Arena::new();\n+    let ty_arena = TypedArena::new();\n+    let ast_arena = TypedArena::new();\n     let mut tcx = TypeContext::new(&ty_arena, &ast_arena);\n     let ast = tcx.ast(ExprInt);\n     let ty = compute_types(&mut tcx, ast);"}]}