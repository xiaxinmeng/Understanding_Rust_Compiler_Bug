{"sha": "22465b35a608487773f960574a798262b23c4abd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIyNDY1YjM1YTYwODQ4Nzc3M2Y5NjA1NzRhNzk4MjYyYjIzYzRhYmQ=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-10-08T16:20:00Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-10-12T11:46:37Z"}, "message": "Apply same treatment to MISSING_DOC_CODE_EXAMPLES", "tree": {"sha": "bc98130deaf97ee64fb17a3a94b61b3ecc7ccafb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bc98130deaf97ee64fb17a3a94b61b3ecc7ccafb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/22465b35a608487773f960574a798262b23c4abd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/22465b35a608487773f960574a798262b23c4abd", "html_url": "https://github.com/rust-lang/rust/commit/22465b35a608487773f960574a798262b23c4abd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/22465b35a608487773f960574a798262b23c4abd/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b31f5d05b1c10c1f99b5bc3c14499ff537c7b692", "url": "https://api.github.com/repos/rust-lang/rust/commits/b31f5d05b1c10c1f99b5bc3c14499ff537c7b692", "html_url": "https://github.com/rust-lang/rust/commit/b31f5d05b1c10c1f99b5bc3c14499ff537c7b692"}], "stats": {"total": 40, "additions": 34, "deletions": 6}, "files": [{"sha": "7cdd9a590ba3bf96b5d07ee0b7a813821df7fd63", "filename": "src/librustdoc/passes/calculate_doc_coverage.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/22465b35a608487773f960574a798262b23c4abd/src%2Flibrustdoc%2Fpasses%2Fcalculate_doc_coverage.rs", "raw_url": "https://github.com/rust-lang/rust/raw/22465b35a608487773f960574a798262b23c4abd/src%2Flibrustdoc%2Fpasses%2Fcalculate_doc_coverage.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcalculate_doc_coverage.rs?ref=22465b35a608487773f960574a798262b23c4abd", "patch": "@@ -254,12 +254,13 @@ impl<'a, 'b> fold::DocFolder for CoverageCalculator<'a, 'b> {\n                 let has_doc_example = tests.found_tests != 0;\n                 let hir_id = self.ctx.tcx.hir().local_def_id_to_hir_id(i.def_id.expect_local());\n                 let (level, source) = self.ctx.tcx.lint_level_at_node(MISSING_DOCS, hir_id);\n-                let should_have_docs = level != lint::Level::Allow || !matches!(source, LintSource::Node(..));\n+                let should_have_docs =\n+                    level != lint::Level::Allow || !matches!(source, LintSource::Node(..));\n                 debug!(\"counting {:?} {:?} in {}\", i.type_(), i.name, i.source.filename);\n                 self.items.entry(i.source.filename.clone()).or_default().count_item(\n                     has_docs,\n                     has_doc_example,\n-                    should_have_doc_example(&i.inner),\n+                    should_have_doc_example(self.ctx, &i),\n                     should_have_docs,\n                 );\n             }"}, {"sha": "1787d0a99d94e2402395251e06b591e161076d70", "filename": "src/librustdoc/passes/doc_test_lints.rs", "status": "modified", "additions": 11, "deletions": 4, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/22465b35a608487773f960574a798262b23c4abd/src%2Flibrustdoc%2Fpasses%2Fdoc_test_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/22465b35a608487773f960574a798262b23c4abd/src%2Flibrustdoc%2Fpasses%2Fdoc_test_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fdoc_test_lints.rs?ref=22465b35a608487773f960574a798262b23c4abd", "patch": "@@ -9,6 +9,7 @@ use crate::clean::*;\n use crate::core::DocContext;\n use crate::fold::DocFolder;\n use crate::html::markdown::{find_testable_code, ErrorCodes, Ignore, LangString};\n+use rustc_middle::lint::LintSource;\n use rustc_session::lint;\n \n pub const CHECK_PRIVATE_ITEMS_DOC_TESTS: Pass = Pass {\n@@ -56,8 +57,8 @@ impl crate::doctest::Tester for Tests {\n     }\n }\n \n-pub fn should_have_doc_example(item_kind: &clean::ItemEnum) -> bool {\n-    !matches!(item_kind,\n+pub fn should_have_doc_example(cx: &DocContext<'_>, item: &clean::Item) -> bool {\n+    if matches!(item.inner,\n         clean::StructFieldItem(_)\n         | clean::VariantItem(_)\n         | clean::AssocConstItem(_, _)\n@@ -69,7 +70,13 @@ pub fn should_have_doc_example(item_kind: &clean::ItemEnum) -> bool {\n         | clean::ImportItem(_)\n         | clean::PrimitiveItem(_)\n         | clean::KeywordItem(_)\n-    )\n+    ) {\n+        return false;\n+    }\n+    let hir_id = cx.tcx.hir().local_def_id_to_hir_id(item.def_id.expect_local());\n+    let (level, source) =\n+        cx.tcx.lint_level_at_node(lint::builtin::MISSING_DOC_CODE_EXAMPLES, hir_id);\n+    level != lint::Level::Allow || !matches!(source, LintSource::Node(..))\n }\n \n pub fn look_for_tests<'tcx>(cx: &DocContext<'tcx>, dox: &str, item: &Item) {\n@@ -88,7 +95,7 @@ pub fn look_for_tests<'tcx>(cx: &DocContext<'tcx>, dox: &str, item: &Item) {\n     if tests.found_tests == 0\n         && rustc_feature::UnstableFeatures::from_environment().is_nightly_build()\n     {\n-        if should_have_doc_example(&item.inner) {\n+        if should_have_doc_example(cx, &item) {\n             debug!(\"reporting error for {:?} (hir_id={:?})\", item, hir_id);\n             let sp = span_of_attrs(&item.attrs).unwrap_or(item.source.span());\n             cx.tcx.struct_span_lint_hir("}, {"sha": "3d5b512d14d1a851a19b8e6ec77810589eb73ad5", "filename": "src/test/rustdoc-ui/coverage/allow_missing_docs.stderr", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/22465b35a608487773f960574a798262b23c4abd/src%2Ftest%2Frustdoc-ui%2Fcoverage%2Fallow_missing_docs.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/22465b35a608487773f960574a798262b23c4abd/src%2Ftest%2Frustdoc-ui%2Fcoverage%2Fallow_missing_docs.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcoverage%2Fallow_missing_docs.stderr?ref=22465b35a608487773f960574a798262b23c4abd", "patch": "@@ -0,0 +1,20 @@\n+warning: missing documentation for a struct\n+  --> $DIR/allow_missing_docs.rs:36:5\n+   |\n+LL |     pub struct Bar {\n+   |     ^^^^^^^^^^^^^^\n+   |\n+note: the lint level is defined here\n+  --> $DIR/allow_missing_docs.rs:35:12\n+   |\n+LL |     #[warn(missing_docs)]\n+   |            ^^^^^^^^^^^^\n+\n+warning: missing documentation for a struct field\n+  --> $DIR/allow_missing_docs.rs:37:9\n+   |\n+LL |         pub f: u32,\n+   |         ^^^^^^^^^^\n+\n+warning: 2 warnings emitted\n+"}]}