{"sha": "84ccbe2076cf37bc13c32a89ccc57a57281b8708", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg0Y2NiZTIwNzZjZjM3YmMxM2MzMmE4OWNjYzU3YTU3MjgxYjg3MDg=", "commit": {"author": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2019-09-01T10:15:33Z"}, "committer": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2019-09-01T11:05:47Z"}, "message": "librustc_errors: Extract sugg/subst handling into method\n\nAn initial refactoring before working on #61809.\n\nThis moves the whole block into a method so that it can be reused in the\nannotate-snippet output. It's already used in the new emitter, but\nthere's no UI tests with suggestions included in this PR.\n\nA first look at some UI tests with suggestions showed that there's some\nmore work to do in [annotate-snippet-rs][annotate-snippet-rs] before the\nnew output is closer to the current one.", "tree": {"sha": "4ea1758f9ea16991df236fe32efdc15f355fe540", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4ea1758f9ea16991df236fe32efdc15f355fe540"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/84ccbe2076cf37bc13c32a89ccc57a57281b8708", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJEBAABCgAuFiEEj4U0bmbiMSg/mWqvgqphyqETl+YFAl1rpgwQHGRldkBwaGFu\nc2NoLm5ldAAKCRCCqmHKoROX5trsEADMtemlFkk4tTKk6EtBiGPoRlIC0UPWFlk+\nrqy7UyOtQiA31yTpcnQvdISHgrgrBTCEpiKCvfUMXoq1ExByS0ga4pFM6Vkqo7Do\nayHAMeYhZr0n1ooQKVp2ZcG8KBmeOLSShnb9y2oKoVpV8ApZXz6o7pD9NjP4bpG8\noRAFEKSz8Hzb0V82IjTITRr0ekG+szgNzOmiYDVahkOoYILmly19muY2sTL08eDF\nNPhh5OOdbA3UY77r74HVrVAiOSdi+//mBdkuCN53q+gj7P0ZYyADUw2n4dWdU04s\nClXsiPlH+PQLXEG9aoIaSeR/AiCgXPmAqfWlNl2b0f0OS1kLgZaCN6kMa8Q6LTd+\nOCuLAYkikTk4cpP1snxgQenjI98hQdtGZzvceE1AQJJam7FJVejdc7o9WbhGw4x/\nSmhf8I6KvZanX9xWKBPXtJnlxmBTJQaAQt1X2wT9G0gXGdvbARYK5b5UYsIKQwKS\ns8EF/k/UGs/gcbbxA3jXzBLYKsreTYWdOjGfoOCzmEf0E1tnxYQO2c/PBM+a0cOi\nJlOz4PEnQTiTibN5dlNQIJFMX1t7Fc3YsycFvmwMOSX56kYpLy6kdFT4RiuN9C+S\n4X3i5JmNwpJNJiPGiJnoQ4JlPJXPKUaU8o7U1nryfAVcumWQJx8QeaO9uJHWRj8V\nBy1suI5xIA==\n=CdoZ\n-----END PGP SIGNATURE-----", "payload": "tree 4ea1758f9ea16991df236fe32efdc15f355fe540\nparent 2d851b33181b1404856cb1d8b20d261adda54ffb\nauthor Philipp Hansch <dev@phansch.net> 1567332933 +0200\ncommitter Philipp Hansch <dev@phansch.net> 1567335947 +0200\n\nlibrustc_errors: Extract sugg/subst handling into method\n\nAn initial refactoring before working on #61809.\n\nThis moves the whole block into a method so that it can be reused in the\nannotate-snippet output. It's already used in the new emitter, but\nthere's no UI tests with suggestions included in this PR.\n\nA first look at some UI tests with suggestions showed that there's some\nmore work to do in [annotate-snippet-rs][annotate-snippet-rs] before the\nnew output is closer to the current one.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/84ccbe2076cf37bc13c32a89ccc57a57281b8708", "html_url": "https://github.com/rust-lang/rust/commit/84ccbe2076cf37bc13c32a89ccc57a57281b8708", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/84ccbe2076cf37bc13c32a89ccc57a57281b8708/comments", "author": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2d851b33181b1404856cb1d8b20d261adda54ffb", "url": "https://api.github.com/repos/rust-lang/rust/commits/2d851b33181b1404856cb1d8b20d261adda54ffb", "html_url": "https://github.com/rust-lang/rust/commit/2d851b33181b1404856cb1d8b20d261adda54ffb"}], "stats": {"total": 44, "additions": 32, "deletions": 12}, "files": [{"sha": "3bed5d81dc514fcac7c3c96c16ff2e9d8c83ecd1", "filename": "src/librustc_errors/annotate_snippet_emitter_writer.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/84ccbe2076cf37bc13c32a89ccc57a57281b8708/src%2Flibrustc_errors%2Fannotate_snippet_emitter_writer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84ccbe2076cf37bc13c32a89ccc57a57281b8708/src%2Flibrustc_errors%2Fannotate_snippet_emitter_writer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Fannotate_snippet_emitter_writer.rs?ref=84ccbe2076cf37bc13c32a89ccc57a57281b8708", "patch": "@@ -30,10 +30,8 @@ pub struct AnnotateSnippetEmitterWriter {\n impl Emitter for AnnotateSnippetEmitterWriter {\n     /// The entry point for the diagnostics generation\n     fn emit_diagnostic(&mut self, db: &DiagnosticBuilder<'_>) {\n-        let primary_span = db.span.clone();\n         let children = db.children.clone();\n-        // FIXME(#59346): Collect suggestions (see emitter.rs)\n-        let suggestions: &[_] = &[];\n+        let (primary_span, suggestions) = self.primary_span_formatted(&db);\n \n         // FIXME(#59346): Add `fix_multispans_in_std_macros` function from emitter.rs\n "}, {"sha": "0a9c927ef40a1517ccaa6e8d8ba4795019917f47", "filename": "src/librustc_errors/emitter.rs", "status": "modified", "additions": 31, "deletions": 9, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/84ccbe2076cf37bc13c32a89ccc57a57281b8708/src%2Flibrustc_errors%2Femitter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84ccbe2076cf37bc13c32a89ccc57a57281b8708/src%2Flibrustc_errors%2Femitter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Femitter.rs?ref=84ccbe2076cf37bc13c32a89ccc57a57281b8708", "patch": "@@ -191,16 +191,25 @@ pub trait Emitter {\n     fn should_show_explain(&self) -> bool {\n         true\n     }\n-}\n \n-impl Emitter for EmitterWriter {\n-    fn emit_diagnostic(&mut self, db: &DiagnosticBuilder<'_>) {\n+    /// Formats the substitutions of the primary_span\n+    ///\n+    /// The are a lot of conditions to this method, but in short:\n+    ///\n+    /// * If the current `Diagnostic` has only one visible `CodeSuggestion`,\n+    ///   we format the `help` suggestion depending on the content of the\n+    ///   substitutions. In that case, we return the modified span only.\n+    ///\n+    /// * If the current `Diagnostic` has multiple suggestions,\n+    ///   we return the original `primary_span` and the original suggestions.\n+    fn primary_span_formatted<'a>(\n+        &mut self,\n+        db: &'a DiagnosticBuilder<'_>\n+    ) -> (MultiSpan, &'a [CodeSuggestion]) {\n         let mut primary_span = db.span.clone();\n-        let mut children = db.children.clone();\n-        let mut suggestions: &[_] = &[];\n-\n         if let Some((sugg, rest)) = db.suggestions.split_first() {\n             if rest.is_empty() &&\n+               // ^ if there is only one suggestion\n                // don't display multi-suggestions as labels\n                sugg.substitutions.len() == 1 &&\n                // don't display multipart suggestions as labels\n@@ -216,21 +225,34 @@ impl Emitter for EmitterWriter {\n             {\n                 let substitution = &sugg.substitutions[0].parts[0].snippet.trim();\n                 let msg = if substitution.len() == 0 || sugg.style.hide_inline() {\n-                    // This substitution is only removal or we explicitly don't want to show the\n-                    // code inline, don't show it\n+                    // This substitution is only removal OR we explicitly don't want to show the\n+                    // code inline (`hide_inline`). Therefore, we don't show the substitution.\n                     format!(\"help: {}\", sugg.msg)\n                 } else {\n+                    // Show the default suggestion text with the substitution\n                     format!(\"help: {}: `{}`\", sugg.msg, substitution)\n                 };\n                 primary_span.push_span_label(sugg.substitutions[0].parts[0].span, msg);\n+\n+                // We return only the modified primary_span\n+                (primary_span, &[])\n             } else {\n                 // if there are multiple suggestions, print them all in full\n                 // to be consistent. We could try to figure out if we can\n                 // make one (or the first one) inline, but that would give\n                 // undue importance to a semi-random suggestion\n-                suggestions = &db.suggestions;\n+                (primary_span, &db.suggestions)\n             }\n+        } else {\n+            (primary_span, &db.suggestions)\n         }\n+    }\n+}\n+\n+impl Emitter for EmitterWriter {\n+    fn emit_diagnostic(&mut self, db: &DiagnosticBuilder<'_>) {\n+        let mut children = db.children.clone();\n+        let (mut primary_span, suggestions) = self.primary_span_formatted(&db);\n \n         self.fix_multispans_in_std_macros(&mut primary_span,\n                                           &mut children,"}]}