{"sha": "28f9af6074341746eecb8cf1f72651e858996a85", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI4ZjlhZjYwNzQzNDE3NDZlZWNiOGNmMWY3MjY1MWU4NTg5OTZhODU=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2011-12-06T23:19:03Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2011-12-06T23:19:03Z"}, "message": "Merge branch 'master' of github.com:graydon/rust", "tree": {"sha": "ca16423abffb7a1d8594ca51321e80968a0b708c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ca16423abffb7a1d8594ca51321e80968a0b708c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/28f9af6074341746eecb8cf1f72651e858996a85", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/28f9af6074341746eecb8cf1f72651e858996a85", "html_url": "https://github.com/rust-lang/rust/commit/28f9af6074341746eecb8cf1f72651e858996a85", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/28f9af6074341746eecb8cf1f72651e858996a85/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "39b1657b2cb17960f72467c4cb31d8ac7969661d", "url": "https://api.github.com/repos/rust-lang/rust/commits/39b1657b2cb17960f72467c4cb31d8ac7969661d", "html_url": "https://github.com/rust-lang/rust/commit/39b1657b2cb17960f72467c4cb31d8ac7969661d"}, {"sha": "a1b215aea1af1c7131219bec66603eca4b77b8b7", "url": "https://api.github.com/repos/rust-lang/rust/commits/a1b215aea1af1c7131219bec66603eca4b77b8b7", "html_url": "https://github.com/rust-lang/rust/commit/a1b215aea1af1c7131219bec66603eca4b77b8b7"}], "stats": {"total": 95, "additions": 58, "deletions": 37}, "files": [{"sha": "dbcc704cbe5c41d026816123fe4b9f7c9c58829f", "filename": "src/comp/driver/rustc.rs", "status": "modified", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/28f9af6074341746eecb8cf1f72651e858996a85/src%2Fcomp%2Fdriver%2Frustc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28f9af6074341746eecb8cf1f72651e858996a85/src%2Fcomp%2Fdriver%2Frustc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fdriver%2Frustc.rs?ref=28f9af6074341746eecb8cf1f72651e858996a85", "patch": "@@ -108,6 +108,30 @@ fn time<T>(do_it: bool, what: str, thunk: fn@() -> T) -> T {\n     ret rv;\n }\n \n+fn inject_libcore_reference(sess: session::session,\n+                            crate: @ast::crate) -> @ast::crate {\n+\n+    fn spanned<copy T>(x: T) -> @ast::spanned<T> {\n+        ret @{node: x,\n+              span: {lo: 0u, hi: 0u,\n+                     expanded_from: codemap::os_none}};\n+    }\n+\n+    let n1 = sess.next_node_id();\n+    let n2 = sess.next_node_id();\n+\n+    let vi1 = spanned(ast::view_item_use(\"core\", [], n1));\n+    let vi2 = spanned(ast::view_item_import_glob(@[\"core\"], n2));\n+\n+    let cd1 = spanned(ast::cdir_view_item(vi1));\n+    let cd2 = spanned(ast::cdir_view_item(vi2));\n+\n+    let cdirs = [cd1, cd2] + crate.node.directives;\n+\n+    ret @{node: {directives: cdirs with crate.node} with *crate }\n+}\n+\n+\n fn compile_input(sess: session::session, cfg: ast::crate_cfg, input: str,\n                  output: str) {\n     let time_passes = sess.get_opts().time_passes;\n@@ -126,6 +150,10 @@ fn compile_input(sess: session::session, cfg: ast::crate_cfg, input: str,\n         time(time_passes, \"expansion\",\n              bind syntax::ext::expand::expand_crate(sess, crate));\n \n+    if sess.get_opts().libcore {\n+        crate = inject_libcore_reference(sess, crate);\n+    }\n+\n     let ast_map =\n         time(time_passes, \"ast indexing\",\n              bind middle::ast_map::map_crate(*crate));\n@@ -257,6 +285,7 @@ options:\n     -o <filename>      write output to <filename>\n     --lib              compile a library crate\n     --static           use or produce static libraries\n+    --no-core          omit the 'core' library (used and imported by default)\n     --pretty [type]    pretty-print the input instead of compiling\n     --ls               list the symbols defined by a crate file\n     -L <path>          add a directory to the library search path\n@@ -362,6 +391,7 @@ fn build_session_options(match: getopts::match)\n         } else if opt_present(match, \"emit-llvm\") {\n             link::output_type_bitcode\n         } else { link::output_type_exe };\n+    let libcore = !opt_present(match, \"no-core\");\n     let verify = !opt_present(match, \"no-verify\");\n     let save_temps = opt_present(match, \"save-temps\");\n     let debuginfo = opt_present(match, \"g\");\n@@ -409,6 +439,7 @@ fn build_session_options(match: getopts::match)\n     let sopts: @session::options =\n         @{library: library,\n           static: static,\n+          libcore: libcore,\n           optimize: opt_level,\n           debuginfo: debuginfo,\n           verify: verify,\n@@ -465,6 +496,7 @@ fn opts() -> [getopts::opt] {\n          optflag(\"time-passes\"), optflag(\"time-llvm-passes\"),\n          optflag(\"no-verify\"),\n          optmulti(\"cfg\"), optflag(\"test\"),\n+         optflag(\"no-core\"),\n          optflag(\"lib\"), optflag(\"static\"), optflag(\"gc\"),\n          optflag(\"stack-growth\"),\n          optflag(\"no-asm-comments\"),"}, {"sha": "a5dc690edafe604d18d18e10674a36b6e5ecce46", "filename": "src/comp/driver/session.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/28f9af6074341746eecb8cf1f72651e858996a85/src%2Fcomp%2Fdriver%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28f9af6074341746eecb8cf1f72651e858996a85/src%2Fcomp%2Fdriver%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fdriver%2Fsession.rs?ref=28f9af6074341746eecb8cf1f72651e858996a85", "patch": "@@ -26,6 +26,7 @@ type options =\n     // with additional crate configurations during the compile process\n     {library: bool,\n      static: bool,\n+     libcore: bool,\n      optimize: uint,\n      debuginfo: bool,\n      verify: bool,"}, {"sha": "d128cdfac146a3020557a2e58eed62982276899a", "filename": "src/comp/front/test.rs", "status": "modified", "additions": 25, "deletions": 37, "changes": 62, "blob_url": "https://github.com/rust-lang/rust/blob/28f9af6074341746eecb8cf1f72651e858996a85/src%2Fcomp%2Ffront%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28f9af6074341746eecb8cf1f72651e858996a85/src%2Fcomp%2Ffront%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Ffront%2Ftest.rs?ref=28f9af6074341746eecb8cf1f72651e858996a85", "patch": "@@ -19,7 +19,6 @@ type test = {span: span, path: [ast::ident], ignore: bool, should_fail: bool};\n type test_ctxt =\n     @{sess: session::session,\n       crate: @ast::crate,\n-      next_node_id: node_id_gen,\n       mutable path: [ast::ident],\n       mutable testfns: [test]};\n \n@@ -28,22 +27,9 @@ type test_ctxt =\n fn modify_for_testing(sess: session::session,\n                       crate: @ast::crate) -> @ast::crate {\n \n-    // FIXME: This hackasaurus assumes that 200000 is a safe number to start\n-    // generating node_ids at (which is totally not the case). pauls is going\n-    // to land a patch that puts parse_sess into session, which will give us\n-    // access to the real next node_id.\n-    let next_node_id = @mutable 200000;\n-    let next_node_id_fn =\n-        bind fn (next_node_id: @mutable ast::node_id) -> ast::node_id {\n-                  let this_node_id = *next_node_id;\n-                  *next_node_id += 1;\n-                  ret this_node_id;\n-              }(next_node_id);\n-\n     let cx: test_ctxt =\n         @{sess: sess,\n           crate: crate,\n-          next_node_id: next_node_id_fn,\n           mutable path: [],\n           mutable testfns: []};\n \n@@ -187,7 +173,7 @@ fn mk_test_module(cx: test_ctxt) -> @ast::item {\n     let item: ast::item =\n         {ident: \"__test\",\n          attrs: [],\n-         id: cx.next_node_id(),\n+         id: cx.sess.next_node_id(),\n          node: item_,\n          span: dummy_sp()};\n \n@@ -216,7 +202,7 @@ fn mk_tests(cx: test_ctxt) -> @ast::item {\n     let test_descs = mk_test_desc_vec(cx);\n \n     let body_: ast::blk_ =\n-        default_block([], option::some(test_descs), cx.next_node_id());\n+        default_block([], option::some(test_descs), cx.sess.next_node_id());\n     let body = nospan(body_);\n \n     let fn_ = {decl: decl, proto: proto, body: body};\n@@ -225,7 +211,7 @@ fn mk_tests(cx: test_ctxt) -> @ast::item {\n     let item: ast::item =\n         {ident: \"tests\",\n          attrs: [],\n-         id: cx.next_node_id(),\n+         id: cx.sess.next_node_id(),\n          node: item_,\n          span: dummy_sp()};\n     ret @item;\n@@ -240,15 +226,15 @@ fn mk_test_desc_vec_ty(cx: test_ctxt) -> @ast::ty {\n                 idents: [\"std\", \"test\", \"default_test_fn\"],\n                 types: []\n             }),\n-            cx.next_node_id()));\n+            cx.sess.next_node_id()));\n \n     let test_desc_ty_path =\n         @nospan({global: false,\n                  idents: [\"std\", \"test\", \"test_desc\"],\n                  types: [@test_fn_ty]});\n \n     let test_desc_ty: ast::ty =\n-        nospan(ast::ty_path(test_desc_ty_path, cx.next_node_id()));\n+        nospan(ast::ty_path(test_desc_ty_path, cx.sess.next_node_id()));\n \n     let vec_mt: ast::mt = {ty: @test_desc_ty, mut: ast::imm};\n \n@@ -263,7 +249,7 @@ fn mk_test_desc_vec(cx: test_ctxt) -> @ast::expr {\n         descs += [mk_test_desc_rec(cx, test_)];\n     }\n \n-    ret @{id: cx.next_node_id(),\n+    ret @{id: cx.sess.next_node_id(),\n           node: ast::expr_vec(descs, ast::imm),\n           span: dummy_sp()};\n }\n@@ -277,7 +263,7 @@ fn mk_test_desc_rec(cx: test_ctxt, test: test) -> @ast::expr {\n     let name_lit: ast::lit =\n         nospan(ast::lit_str(ast_util::path_name_i(path)));\n     let name_expr: ast::expr =\n-        {id: cx.next_node_id(),\n+        {id: cx.sess.next_node_id(),\n          node: ast::expr_lit(@name_lit),\n          span: span};\n \n@@ -287,7 +273,7 @@ fn mk_test_desc_rec(cx: test_ctxt, test: test) -> @ast::expr {\n     let fn_path = @nospan({global: false, idents: path, types: []});\n \n     let fn_expr: ast::expr =\n-        {id: cx.next_node_id(),\n+        {id: cx.sess.next_node_id(),\n          node: ast::expr_path(fn_path),\n          span: span};\n \n@@ -299,7 +285,7 @@ fn mk_test_desc_rec(cx: test_ctxt, test: test) -> @ast::expr {\n     let ignore_lit: ast::lit = nospan(ast::lit_bool(test.ignore));\n \n     let ignore_expr: ast::expr =\n-        {id: cx.next_node_id(),\n+        {id: cx.sess.next_node_id(),\n          node: ast::expr_lit(@ignore_lit),\n          span: span};\n \n@@ -309,7 +295,7 @@ fn mk_test_desc_rec(cx: test_ctxt, test: test) -> @ast::expr {\n     let fail_lit: ast::lit = nospan(ast::lit_bool(test.should_fail));\n \n     let fail_expr: ast::expr =\n-        {id: cx.next_node_id(),\n+        {id: cx.sess.next_node_id(),\n          node: ast::expr_lit(@fail_lit),\n          span: span};\n \n@@ -320,7 +306,7 @@ fn mk_test_desc_rec(cx: test_ctxt, test: test) -> @ast::expr {\n         ast::expr_rec([name_field, fn_field, ignore_field, fail_field],\n             option::none);\n     let desc_rec: ast::expr =\n-        {id: cx.next_node_id(), node: desc_rec_, span: span};\n+        {id: cx.sess.next_node_id(), node: desc_rec_, span: span};\n     ret @desc_rec;\n }\n \n@@ -330,13 +316,13 @@ fn mk_test_wrapper(cx: test_ctxt,\n                    fn_path_expr: ast::expr,\n                    span: span) -> @ast::expr {\n     let call_expr: ast::expr = {\n-        id: cx.next_node_id(),\n+        id: cx.sess.next_node_id(),\n         node: ast::expr_call(@fn_path_expr, [], false),\n         span: span\n     };\n \n     let call_stmt: ast::stmt = nospan(\n-        ast::stmt_expr(@call_expr, cx.next_node_id()));\n+        ast::stmt_expr(@call_expr, cx.sess.next_node_id()));\n \n     let wrapper_decl: ast::fn_decl = {\n         inputs: [],\n@@ -351,7 +337,7 @@ fn mk_test_wrapper(cx: test_ctxt,\n         view_items: [],\n         stmts: [@call_stmt],\n         expr: option::none,\n-        id: cx.next_node_id(),\n+        id: cx.sess.next_node_id(),\n         rules: ast::default_blk\n     });\n \n@@ -362,7 +348,7 @@ fn mk_test_wrapper(cx: test_ctxt,\n     };\n \n     let wrapper_expr: ast::expr = {\n-        id: cx.next_node_id(),\n+        id: cx.sess.next_node_id(),\n         node: ast::expr_fn(wrapper_fn),\n         span: span\n     };\n@@ -379,7 +365,7 @@ fn mk_main(cx: test_ctxt) -> @ast::item {\n         {mode: ast::by_val,\n          ty: @args_ty,\n          ident: \"args\",\n-         id: cx.next_node_id()};\n+         id: cx.sess.next_node_id()};\n \n     let ret_ty = nospan(ast::ty_nil);\n \n@@ -396,7 +382,7 @@ fn mk_main(cx: test_ctxt) -> @ast::item {\n \n     let body_: ast::blk_ =\n         default_block([], option::some(test_main_call_expr),\n-                      cx.next_node_id());\n+                      cx.sess.next_node_id());\n     let body = {node: body_, span: dummy_sp()};\n \n     let fn_ = {decl: decl, proto: proto, body: body};\n@@ -405,7 +391,7 @@ fn mk_main(cx: test_ctxt) -> @ast::item {\n     let item: ast::item =\n         {ident: \"main\",\n          attrs: [],\n-         id: cx.next_node_id(),\n+         id: cx.sess.next_node_id(),\n          node: item_,\n          span: dummy_sp()};\n     ret @item;\n@@ -420,7 +406,7 @@ fn mk_test_main_call(cx: test_ctxt) -> @ast::expr {\n     let args_path_expr_: ast::expr_ = ast::expr_path(args_path);\n \n     let args_path_expr: ast::expr =\n-        {id: cx.next_node_id(), node: args_path_expr_, span: dummy_sp()};\n+        {id: cx.sess.next_node_id(), node: args_path_expr_, span: dummy_sp()};\n \n     // Call __test::test to generate the vector of test_descs\n     let test_path =\n@@ -429,12 +415,12 @@ fn mk_test_main_call(cx: test_ctxt) -> @ast::expr {\n     let test_path_expr_: ast::expr_ = ast::expr_path(test_path);\n \n     let test_path_expr: ast::expr =\n-        {id: cx.next_node_id(), node: test_path_expr_, span: dummy_sp()};\n+        {id: cx.sess.next_node_id(), node: test_path_expr_, span: dummy_sp()};\n \n     let test_call_expr_ = ast::expr_call(@test_path_expr, [], false);\n \n     let test_call_expr: ast::expr =\n-        {id: cx.next_node_id(), node: test_call_expr_, span: dummy_sp()};\n+        {id: cx.sess.next_node_id(), node: test_call_expr_, span: dummy_sp()};\n \n     // Call std::test::test_main\n     let test_main_path =\n@@ -445,14 +431,16 @@ fn mk_test_main_call(cx: test_ctxt) -> @ast::expr {\n     let test_main_path_expr_: ast::expr_ = ast::expr_path(test_main_path);\n \n     let test_main_path_expr: ast::expr =\n-        {id: cx.next_node_id(), node: test_main_path_expr_, span: dummy_sp()};\n+        {id: cx.sess.next_node_id(), node: test_main_path_expr_,\n+         span: dummy_sp()};\n \n     let test_main_call_expr_: ast::expr_ =\n         ast::expr_call(@test_main_path_expr,\n                        [@args_path_expr, @test_call_expr], false);\n \n     let test_main_call_expr: ast::expr =\n-        {id: cx.next_node_id(), node: test_main_call_expr_, span: dummy_sp()};\n+        {id: cx.sess.next_node_id(), node: test_main_call_expr_,\n+         span: dummy_sp()};\n \n     ret @test_main_call_expr;\n }"}]}