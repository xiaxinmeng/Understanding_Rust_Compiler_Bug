{"sha": "660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY2MGJiZjRmNmY0Y2U3YTNkOWU0ZmE3ZmRmYzVlN2M4NzE0NWUwNDk=", "commit": {"author": {"name": "ashleysommer", "email": "flubba86@gmail.com", "date": "2016-03-01T10:48:03Z"}, "committer": {"name": "Ashley Sommer", "email": "Ashley.Sommer@csiro.au", "date": "2016-03-07T07:22:55Z"}, "message": "Fix building libstd on on emscripten targets.\n\nSquashed 10 commits:\n1) The main cause of the problem is that libstd/os/mod.rs treats emscripten targets as an alias of linux targets, whereas liblibc treats emscripten targets as musl-compliant, so it gets a slightly different struct stat64 defined.\nThis commit adds conditional compilation checks to use the correct timestamp format on fs metadata functions in the case of compiling to emscripten targets.\n\n2) Update previous commit to comply with rust formatting standards.\nRemoved tab characters, remove trailing whitespaces.\n\n3) Move emscripten changes into their own file under libstd/os/emscripten\nPut libstd/os/linux/fs back to the way it was.\n\n4) Cannot use stat.st_ctim on emscripten to get created time.\n\n5) Remove compile-time conditionals for target_env = musl, it looks like musl builds compile fine already.\n\n6) Undone some formatting changes that are no longer needed,\nRemoved some more target_env=\"musl\" compilation checks that I missed from my previous commit.\n\n7) upgrade to liblibc e19309c, it fixes the differences in the musl stat and stat64 definitions.\n\n8) Undo the compile-time checks to check for emscripten (or musl targets) in the FileAttr struct.\nNo longer needed after updating liblibc to e19309c.\n\n9) Change the MetadataExt implementation of emscripten fs.rs module to match the changes in new liblibc.\n\n10) remove a stray return statement, should have been removed in the previous commit.", "tree": {"sha": "fdc981019c478af3aa0e6b518c1b921862b83af9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fdc981019c478af3aa0e6b518c1b921862b83af9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049", "html_url": "https://github.com/rust-lang/rust/commit/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049/comments", "author": {"login": "ashleysommer", "id": 402468, "node_id": "MDQ6VXNlcjQwMjQ2OA==", "avatar_url": "https://avatars.githubusercontent.com/u/402468?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ashleysommer", "html_url": "https://github.com/ashleysommer", "followers_url": "https://api.github.com/users/ashleysommer/followers", "following_url": "https://api.github.com/users/ashleysommer/following{/other_user}", "gists_url": "https://api.github.com/users/ashleysommer/gists{/gist_id}", "starred_url": "https://api.github.com/users/ashleysommer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ashleysommer/subscriptions", "organizations_url": "https://api.github.com/users/ashleysommer/orgs", "repos_url": "https://api.github.com/users/ashleysommer/repos", "events_url": "https://api.github.com/users/ashleysommer/events{/privacy}", "received_events_url": "https://api.github.com/users/ashleysommer/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ashleysommer", "id": 402468, "node_id": "MDQ6VXNlcjQwMjQ2OA==", "avatar_url": "https://avatars.githubusercontent.com/u/402468?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ashleysommer", "html_url": "https://github.com/ashleysommer", "followers_url": "https://api.github.com/users/ashleysommer/followers", "following_url": "https://api.github.com/users/ashleysommer/following{/other_user}", "gists_url": "https://api.github.com/users/ashleysommer/gists{/gist_id}", "starred_url": "https://api.github.com/users/ashleysommer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ashleysommer/subscriptions", "organizations_url": "https://api.github.com/users/ashleysommer/orgs", "repos_url": "https://api.github.com/users/ashleysommer/repos", "events_url": "https://api.github.com/users/ashleysommer/events{/privacy}", "received_events_url": "https://api.github.com/users/ashleysommer/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "979aaafc5179c9bd7235e8871f2f3482b9597386", "url": "https://api.github.com/repos/rust-lang/rust/commits/979aaafc5179c9bd7235e8871f2f3482b9597386", "html_url": "https://github.com/rust-lang/rust/commit/979aaafc5179c9bd7235e8871f2f3482b9597386"}], "stats": {"total": 242, "additions": 233, "deletions": 9}, "files": [{"sha": "e19309c8b4e8bbd11f4d84dfffd75e3d1ac477fe", "filename": "src/liblibc", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliblibc?ref=660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049", "patch": "@@ -1 +1 @@\n-Subproject commit 07a92067930670473dc53300dfdda23ff486344d\n+Subproject commit e19309c8b4e8bbd11f4d84dfffd75e3d1ac477fe"}, {"sha": "8056ce4fdc4ee4ba02365682be02ff5f5000acce", "filename": "src/libstd/os/emscripten/fs.rs", "status": "added", "additions": 128, "deletions": 0, "changes": 128, "blob_url": "https://github.com/rust-lang/rust/blob/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049/src%2Flibstd%2Fos%2Femscripten%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049/src%2Flibstd%2Fos%2Femscripten%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fos%2Femscripten%2Ffs.rs?ref=660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049", "patch": "@@ -0,0 +1,128 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![stable(feature = \"metadata_ext\", since = \"1.1.0\")]\n+\n+use libc;\n+\n+use fs::Metadata;\n+use sys_common::AsInner;\n+\n+#[allow(deprecated)]\n+use os::emscripten::raw;\n+\n+/// OS-specific extension methods for `fs::Metadata`\n+#[stable(feature = \"metadata_ext\", since = \"1.1.0\")]\n+pub trait MetadataExt {\n+    /// Gain a reference to the underlying `stat` structure which contains\n+    /// the raw information returned by the OS.\n+    ///\n+    /// The contents of the returned `stat` are **not** consistent across\n+    /// Unix platforms. The `os::unix::fs::MetadataExt` trait contains the\n+    /// cross-Unix abstractions contained within the raw stat.\n+    #[stable(feature = \"metadata_ext\", since = \"1.1.0\")]\n+    #[rustc_deprecated(since = \"1.8.0\",\n+                       reason = \"deprecated in favor of the accessor \\\n+                                 methods of this trait\")]\n+    #[allow(deprecated)]\n+    fn as_raw_stat(&self) -> &raw::stat;\n+\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_dev(&self) -> u64;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_ino(&self) -> u64;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_mode(&self) -> u32;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_nlink(&self) -> u64;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_uid(&self) -> u32;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_gid(&self) -> u32;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_rdev(&self) -> u64;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_size(&self) -> u64;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_atime(&self) -> i64;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_atime_nsec(&self) -> i64;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_mtime(&self) -> i64;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_mtime_nsec(&self) -> i64;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_ctime(&self) -> i64;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_ctime_nsec(&self) -> i64;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_blksize(&self) -> u64;\n+    #[stable(feature = \"metadata_ext2\", since = \"1.8.0\")]\n+    fn st_blocks(&self) -> u64;\n+}\n+\n+#[stable(feature = \"metadata_ext\", since = \"1.1.0\")]\n+impl MetadataExt for Metadata {\n+    #[allow(deprecated)]\n+    fn as_raw_stat(&self) -> &raw::stat {\n+        unsafe {\n+            &*(self.as_inner().as_inner() as *const libc::stat64\n+                                          as *const raw::stat)\n+        }\n+    }\n+    fn st_dev(&self) -> u64 {\n+        self.as_inner().as_inner().st_dev as u64\n+    }\n+    fn st_ino(&self) -> u64 {\n+        self.as_inner().as_inner().st_ino as u64\n+    }\n+    fn st_mode(&self) -> u32 {\n+        self.as_inner().as_inner().st_mode as u32\n+    }\n+    fn st_nlink(&self) -> u64 {\n+        self.as_inner().as_inner().st_nlink as u64\n+    }\n+    fn st_uid(&self) -> u32 {\n+        self.as_inner().as_inner().st_uid as u32\n+    }\n+    fn st_gid(&self) -> u32 {\n+        self.as_inner().as_inner().st_gid as u32\n+    }\n+    fn st_rdev(&self) -> u64 {\n+        self.as_inner().as_inner().st_rdev as u64\n+    }\n+    fn st_size(&self) -> u64 {\n+        self.as_inner().as_inner().st_size as u64\n+    }\n+    fn st_atime(&self) -> i64 {\n+        self.as_inner().as_inner().st_atime as i64\n+    }\n+    fn st_atime_nsec(&self) -> i64 {\n+        self.as_inner().as_inner().st_atime_nsec as i64\n+    }\n+    fn st_mtime(&self) -> i64 {\n+        self.as_inner().as_inner().st_mtime as i64\n+    }\n+    fn st_mtime_nsec(&self) -> i64 {\n+        self.as_inner().as_inner().st_mtime_nsec as i64\n+    }\n+    fn st_ctime(&self) -> i64 {\n+        self.as_inner().as_inner().st_ctime as i64\n+    }\n+    fn st_ctime_nsec(&self) -> i64 {\n+        self.as_inner().as_inner().st_ctime_nsec as i64\n+    }\n+    fn st_blksize(&self) -> u64 {\n+        self.as_inner().as_inner().st_blksize as u64\n+    }\n+    fn st_blocks(&self) -> u64 {\n+        self.as_inner().as_inner().st_blocks as u64\n+    }\n+}"}, {"sha": "8ec44b9fae49759aef99fb752456b87be4200050", "filename": "src/libstd/os/emscripten/mod.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049/src%2Flibstd%2Fos%2Femscripten%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049/src%2Flibstd%2Fos%2Femscripten%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fos%2Femscripten%2Fmod.rs?ref=660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049", "patch": "@@ -0,0 +1,16 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+//! Linux-specific definitions\n+\n+#![stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+\n+pub mod raw;\n+pub mod fs;"}, {"sha": "9da400a69131b58c155c87eb4e32418cc1f9743f", "filename": "src/libstd/os/emscripten/raw.rs", "status": "added", "additions": 80, "deletions": 0, "changes": 80, "blob_url": "https://github.com/rust-lang/rust/blob/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049/src%2Flibstd%2Fos%2Femscripten%2Fraw.rs", "raw_url": "https://github.com/rust-lang/rust/raw/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049/src%2Flibstd%2Fos%2Femscripten%2Fraw.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fos%2Femscripten%2Fraw.rs?ref=660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049", "patch": "@@ -0,0 +1,80 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+//! Emscripten-specific raw type definitions\n+//! This is basically exactly the same as the linux definitions,\n+//! except using the musl-specific stat64 structure in liblibc.\n+\n+#![stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+#![rustc_deprecated(since = \"1.8.0\",\n+                    reason = \"these type aliases are no longer supported by \\\n+                              the standard library, the `libc` crate on \\\n+                              crates.io should be used instead for the correct \\\n+                              definitions\")]\n+#![allow(deprecated)]\n+\n+use os::raw::{c_long, c_short, c_uint, c_ulong};\n+\n+#[stable(feature = \"raw_ext\", since = \"1.1.0\")] pub type dev_t = u64;\n+#[stable(feature = \"raw_ext\", since = \"1.1.0\")] pub type mode_t = u32;\n+\n+#[unstable(feature = \"pthread_t\", issue = \"29791\")] pub type pthread_t = c_ulong;\n+\n+#[doc(inline)]\n+#[stable(feature = \"raw_ext\", since = \"1.1.0\")] pub type blkcnt_t = u64;\n+#[stable(feature = \"raw_ext\", since = \"1.1.0\")] pub type blksize_t = u64;\n+#[stable(feature = \"raw_ext\", since = \"1.1.0\")] pub type ino_t = u64;\n+#[stable(feature = \"raw_ext\", since = \"1.1.0\")] pub type nlink_t = u64;\n+#[stable(feature = \"raw_ext\", since = \"1.1.0\")] pub type off_t = u64;\n+#[stable(feature = \"raw_ext\", since = \"1.1.0\")] pub type time_t = c_long;\n+\n+#[repr(C)]\n+#[derive(Clone)]\n+#[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+pub struct stat {\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_dev: u64,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub __pad1: c_short,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub __st_ino: u32,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_mode: u32,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_nlink: u32,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_uid: u32,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_gid: u32,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_rdev: u64,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub __pad2: c_uint,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_size: i64,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_blksize: i32,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_blocks: i64,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_atime: time_t,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_atime_nsec: c_long,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_mtime: time_t,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_mtime_nsec: c_long,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_ctime: time_t,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_ctime_nsec: c_long,\n+    #[stable(feature = \"raw_ext\", since = \"1.1.0\")]\n+    pub st_ino: u64,\n+}"}, {"sha": "9d10f6809cceb130ef0b9e82f4c8b3e013f5cd81", "filename": "src/libstd/os/mod.rs", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049/src%2Flibstd%2Fos%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049/src%2Flibstd%2Fos%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fos%2Fmod.rs?ref=660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049", "patch": "@@ -31,10 +31,6 @@ pub use sys::ext as windows;\n #[cfg(target_os = \"netbsd\")]   pub mod netbsd;\n #[cfg(target_os = \"openbsd\")]   pub mod openbsd;\n #[cfg(target_os = \"solaris\")]   pub mod solaris;\n-\n-// Emscripten is just like linux\n-#[cfg(target_os = \"emscripten\")]\n-#[path = \"linux/mod.rs\"]\n-pub mod emscripten;\n+#[cfg(target_os = \"emscripten\")] pub mod emscripten;\n \n pub mod raw;"}, {"sha": "d1b4b1c5c0895e33c3dbdc825d1eb78ab9892f22", "filename": "src/libstd/sys/unix/fs.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049/src%2Flibstd%2Fsys%2Funix%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049/src%2Flibstd%2Fsys%2Funix%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Funix%2Ffs.rs?ref=660bbf4f6f4ce7a3d9e4fa7fdfc5e7c87145e049", "patch": "@@ -25,15 +25,19 @@ use sys::time::SystemTime;\n use sys::{cvt, cvt_r};\n use sys_common::{AsInner, FromInner};\n \n-#[cfg(target_os = \"linux\")]\n+#[cfg(any(target_os = \"linux\", target_os = \"emscripten\"))]\n use libc::{stat64, fstat64, lstat64, off64_t, ftruncate64, lseek64, dirent64, readdir64_r, open64};\n #[cfg(target_os = \"android\")]\n use libc::{stat as stat64, fstat as fstat64, lstat as lstat64, off64_t, ftruncate64, lseek64,\n            dirent as dirent64, open as open64};\n-#[cfg(not(any(target_os = \"linux\", target_os = \"android\")))]\n+#[cfg(not(any(target_os = \"linux\",\n+              target_os = \"emscripten\",\n+              target_os = \"android\")))]\n use libc::{stat as stat64, fstat as fstat64, lstat as lstat64, off_t as off64_t,\n            ftruncate as ftruncate64, lseek as lseek64, dirent as dirent64, open as open64};\n-#[cfg(not(any(target_os = \"linux\", target_os = \"solaris\")))]\n+#[cfg(not(any(target_os = \"linux\",\n+              target_os = \"emscripten\",\n+              target_os = \"solaris\")))]\n use libc::{readdir_r as readdir64_r};\n \n pub struct File(FileDesc);"}]}