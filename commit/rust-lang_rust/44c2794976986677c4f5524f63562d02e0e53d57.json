{"sha": "44c2794976986677c4f5524f63562d02e0e53d57", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ0YzI3OTQ5NzY5ODY2NzdjNGY1NTI0ZjYzNTYyZDAyZTBlNTNkNTc=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-03-01T03:41:05Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-03-02T14:31:38Z"}, "message": "Clean up error reporting for deprecated passes\n\n- Use spans for deprecated attributes\n- Use a proper diagnostic for unknown passes, instead of error logging\n- Add tests for unknown passes\n- Improve some wording in diagnostics", "tree": {"sha": "fe618c7488805400f2c6bf95efb5c5b8e7a3b807", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fe618c7488805400f2c6bf95efb5c5b8e7a3b807"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/44c2794976986677c4f5524f63562d02e0e53d57", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/44c2794976986677c4f5524f63562d02e0e53d57", "html_url": "https://github.com/rust-lang/rust/commit/44c2794976986677c4f5524f63562d02e0e53d57", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/44c2794976986677c4f5524f63562d02e0e53d57/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "edeee915b1c52f97411e57ef6b1a8bd46548a37a", "url": "https://api.github.com/repos/rust-lang/rust/commits/edeee915b1c52f97411e57ef6b1a8bd46548a37a", "html_url": "https://github.com/rust-lang/rust/commit/edeee915b1c52f97411e57ef6b1a8bd46548a37a"}], "stats": {"total": 110, "additions": 74, "deletions": 36}, "files": [{"sha": "6a62cacd34d18abe0266c25c1059c099b5dfaa8d", "filename": "src/librustdoc/config.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/44c2794976986677c4f5524f63562d02e0e53d57/src%2Flibrustdoc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/44c2794976986677c4f5524f63562d02e0e53d57/src%2Flibrustdoc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fconfig.rs?ref=44c2794976986677c4f5524f63562d02e0e53d57", "patch": "@@ -654,9 +654,8 @@ fn check_deprecated_options(matches: &getopts::Matches, diag: &rustc_errors::Han\n             {\n                 continue;\n             }\n-            let mut err =\n-                diag.struct_warn(&format!(\"the '{}' flag is considered deprecated\", flag));\n-            err.warn(\n+            let mut err = diag.struct_warn(&format!(\"the `{}` flag is deprecated\", flag));\n+            err.note(\n                 \"see issue #44136 <https://github.com/rust-lang/rust/issues/44136> \\\n                  for more information\",\n             );"}, {"sha": "a935bd6b456d599fb3ac9016162b696e9da8bb3b", "filename": "src/librustdoc/core.rs", "status": "modified", "additions": 34, "deletions": 23, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/44c2794976986677c4f5524f63562d02e0e53d57/src%2Flibrustdoc%2Fcore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/44c2794976986677c4f5524f63562d02e0e53d57/src%2Flibrustdoc%2Fcore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fcore.rs?ref=44c2794976986677c4f5524f63562d02e0e53d57", "patch": "@@ -22,7 +22,7 @@ use rustc_session::DiagnosticOutput;\n use rustc_session::Session;\n use rustc_span::source_map;\n use rustc_span::symbol::sym;\n-use rustc_span::DUMMY_SP;\n+use rustc_span::{Span, DUMMY_SP};\n \n use std::mem;\n use std::rc::Rc;\n@@ -461,7 +461,7 @@ crate fn run_global_ctxt(\n     tcx: TyCtxt<'_>,\n     resolver: Rc<RefCell<interface::BoxedResolver>>,\n     mut default_passes: passes::DefaultPassOption,\n-    mut manual_passes: Vec<String>,\n+    manual_passes: Vec<String>,\n     render_options: RenderOptions,\n     output_format: OutputFormat,\n ) -> (clean::Crate, RenderOptions, Cache) {\n@@ -562,10 +562,10 @@ crate fn run_global_ctxt(\n         }\n     }\n \n-    fn report_deprecated_attr(name: &str, diag: &rustc_errors::Handler) {\n-        let mut msg = diag\n-            .struct_warn(&format!(\"the `#![doc({})]` attribute is considered deprecated\", name));\n-        msg.warn(\n+    fn report_deprecated_attr(name: &str, diag: &rustc_errors::Handler, sp: Span) {\n+        let mut msg =\n+            diag.struct_span_warn(sp, &format!(\"the `#![doc({})]` attribute is deprecated\", name));\n+        msg.note(\n             \"see issue #44136 <https://github.com/rust-lang/rust/issues/44136> \\\n              for more information\",\n         );\n@@ -577,6 +577,27 @@ crate fn run_global_ctxt(\n         msg.emit();\n     }\n \n+    let parse_pass = |name: &str, sp: Option<Span>| {\n+        if let Some(pass) = passes::find_pass(name) {\n+            Some(ConditionalPass::always(pass))\n+        } else {\n+            let msg = &format!(\"ignoring unknown pass `{}`\", name);\n+            let mut warning = if let Some(sp) = sp {\n+                tcx.sess.struct_span_warn(sp, msg)\n+            } else {\n+                tcx.sess.struct_warn(msg)\n+            };\n+            if name == \"collapse-docs\" {\n+                warning.note(\"the `collapse-docs` pass was removed in #80261 <https://github.com/rust-lang/rust/pull/80261>\");\n+            }\n+            warning.emit();\n+            None\n+        }\n+    };\n+\n+    let mut manual_passes: Vec<_> =\n+        manual_passes.into_iter().flat_map(|name| parse_pass(&name, None)).collect();\n+\n     // Process all of the crate attributes, extracting plugin metadata along\n     // with the passes which we are supposed to run.\n     for attr in krate.module.as_ref().unwrap().attrs.lists(sym::doc) {\n@@ -585,19 +606,18 @@ crate fn run_global_ctxt(\n         let name = attr.name_or_empty();\n         if attr.is_word() {\n             if name == sym::no_default_passes {\n-                report_deprecated_attr(\"no_default_passes\", diag);\n+                report_deprecated_attr(\"no_default_passes\", diag, attr.span());\n                 if default_passes == passes::DefaultPassOption::Default {\n                     default_passes = passes::DefaultPassOption::None;\n                 }\n             }\n         } else if let Some(value) = attr.value_str() {\n-            let sink = match name {\n+            match name {\n                 sym::passes => {\n-                    report_deprecated_attr(\"passes = \\\"...\\\"\", diag);\n-                    &mut manual_passes\n+                    report_deprecated_attr(\"passes = \\\"...\\\"\", diag, attr.span());\n                 }\n                 sym::plugins => {\n-                    report_deprecated_attr(\"plugins = \\\"...\\\"\", diag);\n+                    report_deprecated_attr(\"plugins = \\\"...\\\"\", diag, attr.span());\n                     eprintln!(\n                         \"WARNING: `#![doc(plugins = \\\"...\\\")]` \\\n                          no longer functions; see CVE-2018-1000622\"\n@@ -607,7 +627,8 @@ crate fn run_global_ctxt(\n                 _ => continue,\n             };\n             for name in value.as_str().split_whitespace() {\n-                sink.push(name.to_string());\n+                let span = attr.name_value_literal_span().unwrap_or(attr.span());\n+                manual_passes.extend(parse_pass(name, Some(span)));\n             }\n         }\n \n@@ -616,17 +637,7 @@ crate fn run_global_ctxt(\n         }\n     }\n \n-    let passes = passes::defaults(default_passes).iter().copied().chain(\n-        manual_passes.into_iter().flat_map(|name| {\n-            if let Some(pass) = passes::find_pass(&name) {\n-                Some(ConditionalPass::always(pass))\n-            } else {\n-                error!(\"unknown pass {}, skipping\", name);\n-                None\n-            }\n-        }),\n-    );\n-\n+    let passes = passes::defaults(default_passes).iter().copied().chain(manual_passes);\n     info!(\"Executing passes\");\n \n     for p in passes {"}, {"sha": "a0439acc0240c7f7b4b0d0a66098990588244c51", "filename": "src/test/rustdoc-ui/deprecated-attrs.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/44c2794976986677c4f5524f63562d02e0e53d57/src%2Ftest%2Frustdoc-ui%2Fdeprecated-attrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/44c2794976986677c4f5524f63562d02e0e53d57/src%2Ftest%2Frustdoc-ui%2Fdeprecated-attrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fdeprecated-attrs.rs?ref=44c2794976986677c4f5524f63562d02e0e53d57", "patch": "@@ -1,7 +1,13 @@\n // check-pass\n+// compile-flags: --passes unknown-pass\n+// error-pattern: ignoring unknown pass `unknown-pass`\n \n-#![doc(no_default_passes, passes = \"unindent-comments\")]\n-\n-struct SomeStruct;\n-\n-pub struct OtherStruct;\n+#![doc(no_default_passes)]\n+//~^ WARNING attribute is deprecated\n+//~| NOTE see issue #44136\n+//~| HELP use `#![doc(document_private_items)]`\n+#![doc(passes = \"collapse-docs unindent-comments\")]\n+//~^ WARNING attribute is deprecated\n+//~| NOTE see issue #44136\n+//~| WARNING ignoring unknown pass\n+//~| NOTE `collapse-docs` pass was removed"}, {"sha": "42a229abf58e81e5519200976bde8582fa42fbd9", "filename": "src/test/rustdoc-ui/deprecated-attrs.stderr", "status": "modified", "additions": 27, "deletions": 5, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/44c2794976986677c4f5524f63562d02e0e53d57/src%2Ftest%2Frustdoc-ui%2Fdeprecated-attrs.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/44c2794976986677c4f5524f63562d02e0e53d57/src%2Ftest%2Frustdoc-ui%2Fdeprecated-attrs.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fdeprecated-attrs.stderr?ref=44c2794976986677c4f5524f63562d02e0e53d57", "patch": "@@ -1,11 +1,33 @@\n-warning: the `#![doc(no_default_passes)]` attribute is considered deprecated\n+warning: the `passes` flag is deprecated\n    |\n-   = warning: see issue #44136 <https://github.com/rust-lang/rust/issues/44136> for more information\n+   = note: see issue #44136 <https://github.com/rust-lang/rust/issues/44136> for more information\n+\n+warning: ignoring unknown pass `unknown-pass`\n+\n+warning: the `#![doc(no_default_passes)]` attribute is deprecated\n+  --> $DIR/deprecated-attrs.rs:5:8\n+   |\n+LL | #![doc(no_default_passes)]\n+   |        ^^^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #44136 <https://github.com/rust-lang/rust/issues/44136> for more information\n    = help: you may want to use `#![doc(document_private_items)]`\n \n-warning: the `#![doc(passes = \"...\")]` attribute is considered deprecated\n+warning: the `#![doc(passes = \"...\")]` attribute is deprecated\n+  --> $DIR/deprecated-attrs.rs:9:8\n+   |\n+LL | #![doc(passes = \"collapse-docs unindent-comments\")]\n+   |        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #44136 <https://github.com/rust-lang/rust/issues/44136> for more information\n+\n+warning: ignoring unknown pass `collapse-docs`\n+  --> $DIR/deprecated-attrs.rs:9:17\n+   |\n+LL | #![doc(passes = \"collapse-docs unindent-comments\")]\n+   |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = warning: see issue #44136 <https://github.com/rust-lang/rust/issues/44136> for more information\n+   = note: the `collapse-docs` pass was removed in #80261 <https://github.com/rust-lang/rust/pull/80261>\n \n-warning: 2 warnings emitted\n+warning: 4 warnings emitted\n "}]}