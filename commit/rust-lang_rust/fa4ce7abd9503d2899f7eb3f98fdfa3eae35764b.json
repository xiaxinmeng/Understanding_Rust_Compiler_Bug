{"sha": "fa4ce7abd9503d2899f7eb3f98fdfa3eae35764b", "node_id": "C_kwDOAAsO6NoAKGZhNGNlN2FiZDk1MDNkMjg5OWY3ZWIzZjk4ZmRmYTNlYWUzNTc2NGI", "commit": {"author": {"name": "Andrew Pollack", "email": "andrewpkq@gmail.com", "date": "2022-07-27T23:47:19Z"}, "committer": {"name": "Andrew Pollack", "email": "andrewpkq@gmail.com", "date": "2022-08-07T15:19:14Z"}, "message": "Shifting CI to pull Zircon libraries directly from Fuchsia SDK\n\nPR feedback\n\nPR Followups\n\nUpdating clang download\n\nUpdating clang download\n\nRestructuring env used\n\nRestructuring env used\n\nAdding chmod\n\nAdding chmod\n\nAdding chmod", "tree": {"sha": "c1ac4c7cbe4c81db07a3f7d641c23627ec1aabb9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c1ac4c7cbe4c81db07a3f7d641c23627ec1aabb9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fa4ce7abd9503d2899f7eb3f98fdfa3eae35764b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fa4ce7abd9503d2899f7eb3f98fdfa3eae35764b", "html_url": "https://github.com/rust-lang/rust/commit/fa4ce7abd9503d2899f7eb3f98fdfa3eae35764b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fa4ce7abd9503d2899f7eb3f98fdfa3eae35764b/comments", "author": {"login": "andrewpollack", "id": 24868505, "node_id": "MDQ6VXNlcjI0ODY4NTA1", "avatar_url": "https://avatars.githubusercontent.com/u/24868505?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andrewpollack", "html_url": "https://github.com/andrewpollack", "followers_url": "https://api.github.com/users/andrewpollack/followers", "following_url": "https://api.github.com/users/andrewpollack/following{/other_user}", "gists_url": "https://api.github.com/users/andrewpollack/gists{/gist_id}", "starred_url": "https://api.github.com/users/andrewpollack/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andrewpollack/subscriptions", "organizations_url": "https://api.github.com/users/andrewpollack/orgs", "repos_url": "https://api.github.com/users/andrewpollack/repos", "events_url": "https://api.github.com/users/andrewpollack/events{/privacy}", "received_events_url": "https://api.github.com/users/andrewpollack/received_events", "type": "User", "site_admin": false}, "committer": {"login": "andrewpollack", "id": 24868505, "node_id": "MDQ6VXNlcjI0ODY4NTA1", "avatar_url": "https://avatars.githubusercontent.com/u/24868505?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andrewpollack", "html_url": "https://github.com/andrewpollack", "followers_url": "https://api.github.com/users/andrewpollack/followers", "following_url": "https://api.github.com/users/andrewpollack/following{/other_user}", "gists_url": "https://api.github.com/users/andrewpollack/gists{/gist_id}", "starred_url": "https://api.github.com/users/andrewpollack/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andrewpollack/subscriptions", "organizations_url": "https://api.github.com/users/andrewpollack/orgs", "repos_url": "https://api.github.com/users/andrewpollack/repos", "events_url": "https://api.github.com/users/andrewpollack/events{/privacy}", "received_events_url": "https://api.github.com/users/andrewpollack/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2643b16468fda787470340890212591d8bc832b7", "url": "https://api.github.com/repos/rust-lang/rust/commits/2643b16468fda787470340890212591d8bc832b7", "html_url": "https://github.com/rust-lang/rust/commit/2643b16468fda787470340890212591d8bc832b7"}], "stats": {"total": 118, "additions": 65, "deletions": 53}, "files": [{"sha": "126c292b38ea1f7a179b5ddaea5762ddc648a715", "filename": "src/ci/docker/host-x86_64/dist-various-2/Dockerfile", "status": "modified", "additions": 12, "deletions": 6, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/fa4ce7abd9503d2899f7eb3f98fdfa3eae35764b/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-2%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/fa4ce7abd9503d2899f7eb3f98fdfa3eae35764b/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-2%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-2%2FDockerfile?ref=fa4ce7abd9503d2899f7eb3f98fdfa3eae35764b", "patch": "@@ -32,10 +32,16 @@ RUN add-apt-repository -y 'deb https://apt.dilos.org/dilos dilos2 main'\n ENV \\\n     AR_x86_64_fuchsia=x86_64-fuchsia-ar \\\n     CC_x86_64_fuchsia=x86_64-fuchsia-clang \\\n+    CFLAGS_x86_64_fuchsia=\"--target=x86_64-fuchsia --sysroot=/usr/local/core-linux-amd64-fuchsia-sdk/arch/x64/sysroot -I/usr/local/core-linux-amd64-fuchsia-sdk/pkg/fdio/include\" \\\n     CXX_x86_64_fuchsia=x86_64-fuchsia-clang++ \\\n+    CXXFLAGS_x86_64_fuchsia=\"--target=x86_64-fuchsia --sysroot=/usr/local/core-linux-amd64-fuchsia-sdk/arch/x64/sysroot -I/usr/local/core-linux-amd64-fuchsia-sdk/pkg/fdio/include\" \\\n+    LDFLAGS_x86_64_fuchsia=\"--target=x86_64-fuchsia --sysroot=/usr/local/core-linux-amd64-fuchsia-sdk/arch/x64/sysroot -L/usr/local/core-linux-amd64-fuchsia-sdk/arch/x64/lib\" \\\n     AR_aarch64_fuchsia=aarch64-fuchsia-ar \\\n     CC_aarch64_fuchsia=aarch64-fuchsia-clang \\\n+    CFLAGS_aarch64_fuchsia=\"--target=aarch64-fuchsia --sysroot=/usr/local/core-linux-amd64-fuchsia-sdk/arch/arm64/sysroot -I/usr/local/core-linux-amd64-fuchsia-sdk/pkg/fdio/include\" \\\n     CXX_aarch64_fuchsia=aarch64-fuchsia-clang++ \\\n+    CXXFLAGS_aarch64_fuchsia=\"--target=aarch64-fuchsia --sysroot=/usr/local/core-linux-amd64-fuchsia-sdk/arch/arm64/sysroot -I/usr/local/core-linux-amd64-fuchsia-sdk/pkg/fdio/include\" \\\n+    LDFLAGS_aarch64_fuchsia=\"--target=aarch64-fuchsia --sysroot=/usr/local/core-linux-amd64-fuchsia-sdk/arch/arm64/sysroot -L/usr/local/core-linux-amd64-fuchsia-sdk/arch/arm64/lib\" \\\n     AR_sparcv9_sun_solaris=sparcv9-sun-solaris2.10-ar \\\n     CC_sparcv9_sun_solaris=sparcv9-sun-solaris2.10-gcc \\\n     CXX_sparcv9_sun_solaris=sparcv9-sun-solaris2.10-g++ \\\n@@ -89,14 +95,14 @@ RUN sh /scripts/sccache.sh\n \n ENV CARGO_TARGET_X86_64_FUCHSIA_AR /usr/local/bin/llvm-ar\n ENV CARGO_TARGET_X86_64_FUCHSIA_RUSTFLAGS \\\n--C link-arg=--sysroot=/usr/local/x86_64-fuchsia \\\n--C link-arg=-L/usr/local/x86_64-fuchsia/lib \\\n--C link-arg=-L/usr/local/lib/x86_64-fuchsia/lib\n+-C link-arg=--sysroot=/usr/local/core-linux-amd64-fuchsia-sdk/arch/x64/sysroot \\\n+-Lnative=/usr/local/core-linux-amd64-fuchsia-sdk/arch/x64/sysroot/lib \\\n+-Lnative=/usr/local/core-linux-amd64-fuchsia-sdk/arch/x64/lib\n ENV CARGO_TARGET_AARCH64_FUCHSIA_AR /usr/local/bin/llvm-ar\n ENV CARGO_TARGET_AARCH64_FUCHSIA_RUSTFLAGS \\\n--C link-arg=--sysroot=/usr/local/aarch64-fuchsia \\\n--C link-arg=-L/usr/local/aarch64-fuchsia/lib \\\n--C link-arg=-L/usr/local/lib/aarch64-fuchsia/lib\n+-C link-arg=--sysroot=/usr/local/core-linux-amd64-fuchsia-sdk/arch/arm64/sysroot \\\n+-Lnative=/usr/local/core-linux-amd64-fuchsia-sdk/arch/arm64/sysroot/lib \\\n+-Lnative=/usr/local/core-linux-amd64-fuchsia-sdk/arch/arm64/lib\n \n ENV TARGETS=x86_64-fuchsia\n ENV TARGETS=$TARGETS,aarch64-fuchsia"}, {"sha": "80db925775424c0e052669c9fbc0cf2757a35278", "filename": "src/ci/docker/host-x86_64/dist-various-2/build-fuchsia-toolchain.sh", "status": "modified", "additions": 53, "deletions": 47, "changes": 100, "blob_url": "https://github.com/rust-lang/rust/blob/fa4ce7abd9503d2899f7eb3f98fdfa3eae35764b/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-2%2Fbuild-fuchsia-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/fa4ce7abd9503d2899f7eb3f98fdfa3eae35764b/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-2%2Fbuild-fuchsia-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-2%2Fbuild-fuchsia-toolchain.sh?ref=fa4ce7abd9503d2899f7eb3f98fdfa3eae35764b", "patch": "@@ -3,52 +3,58 @@\n set -ex\n source shared.sh\n \n-ZIRCON=e9a26dbc70d631029f8ee9763103910b7e3a2fe1\n-\n-mkdir -p zircon\n-pushd zircon > /dev/null\n-\n-# Download sources\n-git init\n-git remote add origin https://github.com/rust-lang-nursery/mirror-google-fuchsia-zircon\n-git fetch --depth=1 origin $ZIRCON\n-git reset --hard FETCH_HEAD\n-\n-# Download toolchain\n-./scripts/download-toolchain\n-chmod -R a+rx prebuilt/downloads/clang+llvm-x86_64-linux\n-cp -a prebuilt/downloads/clang+llvm-x86_64-linux/. /usr/local\n-\n-build() {\n-  local arch=\"$1\"\n-\n-  case \"${arch}\" in\n-    x86_64) tgt=\"zircon-pc-x86-64\" ;;\n-    aarch64) tgt=\"zircon-qemu-arm64\" ;;\n-  esac\n-\n-  hide_output make -j$(getconf _NPROCESSORS_ONLN) $tgt\n-  dst=/usr/local/${arch}-fuchsia\n-  mkdir -p $dst\n-  cp -a build-${tgt}/sysroot/include $dst/\n-  cp -a build-${tgt}/sysroot/lib $dst/\n+FUCHSIA_SDK_URL=https://chrome-infra-packages.appspot.com/dl/fuchsia/sdk/core/linux-amd64\n+FUCHSIA_SDK_ID=4xjxrGUrDbQ6_zJwj6cDN1IbWsWV5aCQXC_zO_Hu0XkC\n+FUCHSIA_SDK_SHA256=e318f1ac652b0db43aff32708fa70337521b5ac595e5a0905c2ff33bf1eed179\n+FUCHSIA_SDK_USR_DIR=/usr/local/core-linux-amd64-fuchsia-sdk\n+CLANG_DOWNLOAD_URL=\\\n+https://chrome-infra-packages.appspot.com/dl/fuchsia/third_party/clang/linux-amd64\n+CLANG_DOWNLOAD_ID=vU0vNjSihOV4Q6taQYCpy03JXGiCyVwxen3rFMNMIgsC\n+CLANG_DOWNLOAD_SHA256=bd4d2f3634a284e57843ab5a4180a9cb4dc95c6882c95c317a7deb14c34c220b\n+\n+install_clang() {\n+  mkdir -p clang_download\n+  pushd clang_download > /dev/null\n+\n+  # Download clang+llvm\n+  curl -LO \"${CLANG_DOWNLOAD_URL}/+/${CLANG_DOWNLOAD_ID}\"\n+  echo \"$(echo ${CLANG_DOWNLOAD_SHA256}) ${CLANG_DOWNLOAD_ID}\" | sha256sum --check --status\n+  unzip -qq ${CLANG_DOWNLOAD_ID} -d clang-linux-amd64\n+\n+  # Other dists currently depend on our Clang... moving into /usr/local for other\n+  #  dist usage instead of a Fuchsia /usr/local directory\n+  chmod -R 777 clang-linux-amd64/.\n+  cp -a clang-linux-amd64/. /usr/local\n+\n+  # CFLAGS and CXXFLAGS env variables in main Dockerfile handle sysroot linking\n+  for arch in x86_64 aarch64; do\n+    for tool in clang clang++; do\n+      ln -s /usr/local/bin/${tool} /usr/local/bin/${arch}-fuchsia-${tool}\n+    done\n+    ln -s /usr/local/bin/llvm-ar /usr/local/bin/${arch}-fuchsia-ar\n+  done\n+\n+  popd > /dev/null\n+  rm -rf clang_download\n }\n \n-# Build sysroot\n-for arch in x86_64 aarch64; do\n-  build ${arch}\n-done\n-\n-popd > /dev/null\n-rm -rf zircon\n-\n-for arch in x86_64 aarch64; do\n-  for tool in clang clang++; do\n-    cat >/usr/local/bin/${arch}-fuchsia-${tool} <<EOF\n-#!/bin/sh\n-${tool} --target=${arch}-fuchsia --sysroot=/usr/local/${arch}-fuchsia \"\\$@\"\n-EOF\n-    chmod +x /usr/local/bin/${arch}-fuchsia-${tool}\n-  done\n-  ln -s /usr/local/bin/llvm-ar /usr/local/bin/${arch}-fuchsia-ar\n-done\n+install_zircon_libs() {\n+  mkdir -p zircon\n+  pushd zircon > /dev/null\n+\n+  # Download Fuchsia SDK (with Zircon libs)\n+  curl -LO \"${FUCHSIA_SDK_URL}/+/${FUCHSIA_SDK_ID}\"\n+  echo \"$(echo ${FUCHSIA_SDK_SHA256}) ${FUCHSIA_SDK_ID}\" | sha256sum --check --status\n+  unzip -qq ${FUCHSIA_SDK_ID} -d core-linux-amd64\n+\n+  # Moving SDK into Docker's user-space\n+  mkdir -p ${FUCHSIA_SDK_USR_DIR}\n+  chmod -R 777 core-linux-amd64/.\n+  cp -r core-linux-amd64/* ${FUCHSIA_SDK_USR_DIR}\n+\n+  popd > /dev/null\n+  rm -rf zircon\n+}\n+\n+hide_output install_clang\n+hide_output install_zircon_libs"}]}