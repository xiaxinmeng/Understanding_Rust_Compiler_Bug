{"sha": "bd6536f8687b1b4fb166594ed5cf79db0ec1436d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJkNjUzNmY4Njg3YjFiNGZiMTY2NTk0ZWQ1Y2Y3OWRiMGVjMTQzNmQ=", "commit": {"author": {"name": "Brian Anderson", "email": "andersrb@gmail.com", "date": "2013-01-16T01:27:45Z"}, "committer": {"name": "Brian Anderson", "email": "andersrb@gmail.com", "date": "2013-01-16T01:27:45Z"}, "message": "Merge pull request #4497 from ILyoan/i4488\n\nWhen building a test runner, don't remove the main function", "tree": {"sha": "b4976ef0f602b614d705eab2b3e2b0639b66eabc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b4976ef0f602b614d705eab2b3e2b0639b66eabc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bd6536f8687b1b4fb166594ed5cf79db0ec1436d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bd6536f8687b1b4fb166594ed5cf79db0ec1436d", "html_url": "https://github.com/rust-lang/rust/commit/bd6536f8687b1b4fb166594ed5cf79db0ec1436d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bd6536f8687b1b4fb166594ed5cf79db0ec1436d/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a4eb76abd0b43c3e0d38cebd2c227a06e3b6edc4", "url": "https://api.github.com/repos/rust-lang/rust/commits/a4eb76abd0b43c3e0d38cebd2c227a06e3b6edc4", "html_url": "https://github.com/rust-lang/rust/commit/a4eb76abd0b43c3e0d38cebd2c227a06e3b6edc4"}, {"sha": "a63b11a009fef9207232bbde0392f9ec18a3e7a4", "url": "https://api.github.com/repos/rust-lang/rust/commits/a63b11a009fef9207232bbde0392f9ec18a3e7a4", "html_url": "https://github.com/rust-lang/rust/commit/a63b11a009fef9207232bbde0392f9ec18a3e7a4"}], "stats": {"total": 20, "additions": 8, "deletions": 12}, "files": [{"sha": "17de40b96425638c5da73efe77153bf4e1b27de3", "filename": "src/librustc/front/test.rs", "status": "modified", "additions": 8, "deletions": 12, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/bd6536f8687b1b4fb166594ed5cf79db0ec1436d/src%2Flibrustc%2Ffront%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd6536f8687b1b4fb166594ed5cf79db0ec1436d/src%2Flibrustc%2Ffront%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ffront%2Ftest.rs?ref=bd6536f8687b1b4fb166594ed5cf79db0ec1436d", "patch": "@@ -86,24 +86,20 @@ fn strip_test_functions(crate: @ast::crate) -> @ast::crate {\n \n fn fold_mod(cx: test_ctxt, m: ast::_mod, fld: fold::ast_fold) -> ast::_mod {\n \n-    // Remove any defined main function from the AST so it doesn't clash with\n+    // Remove any #[main] from the AST so it doesn't clash with\n     // the one we're going to add. Only if compiling an executable.\n \n-    fn nomain(cx: test_ctxt, item: @ast::item) -> Option<@ast::item> {\n-        match item.node {\n-          ast::item_fn(*) => {\n-            if attrs_contains_name(item.attrs, ~\"main\")\n-                    && !cx.sess.building_library {\n-                option::None\n-            } else { option::Some(item) }\n-          }\n-          _ => option::Some(item)\n-        }\n+    fn nomain(cx: test_ctxt, item: @ast::item) -> @ast::item {\n+        if !cx.sess.building_library {\n+            @ast::item{attrs: item.attrs.filtered(|attr| {\n+                               attr::get_attr_name(*attr) != ~\"main\"\n+                           }),.. copy *item}\n+        } else { item }\n     }\n \n     let mod_nomain =\n         {view_items: /*bad*/copy m.view_items,\n-         items: vec::filter_map(m.items, |i| nomain(cx, *i))};\n+         items: vec::map(m.items, |i| nomain(cx, *i))};\n     return fold::noop_fold_mod(mod_nomain, fld);\n }\n "}]}