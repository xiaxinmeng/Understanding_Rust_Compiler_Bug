{"sha": "eec64ec01b0553aca855df8146965ed6c6746e7d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVlYzY0ZWMwMWIwNTUzYWNhODU1ZGY4MTQ2OTY1ZWQ2YzY3NDZlN2Q=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-03-15T15:53:15Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-15T15:53:15Z"}, "message": "Merge #7992\n\n7992: improved completion sorting for functions and methods r=JoshMcguigan a=JoshMcguigan\n\nThis PR improves completion sorting for functions and methods. Related to #7935.\r\n\r\n### Before\r\n\r\nThe methods are being sorted by `coc` by closeness in file. \r\n\r\n![pre-fn-relevance](https://user-images.githubusercontent.com/22216761/111018669-fe3d3f00-836e-11eb-9607-cc05af080a6a.png)\r\n\r\n### After\r\n\r\nNotice `bbb()` on top (type + name match), followed by `ddd()` (type match).\r\n\r\n![image](https://user-images.githubusercontent.com/22216761/111018680-0e551e80-836f-11eb-94b1-c88336ecbc6e.png)\r\n\n\nCo-authored-by: Josh Mcguigan <joshmcg88@gmail.com>", "tree": {"sha": "40e81ae73928c85bbd6ab452fd317383cf5322d8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/40e81ae73928c85bbd6ab452fd317383cf5322d8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eec64ec01b0553aca855df8146965ed6c6746e7d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgT4LrCRBK7hj4Ov3rIwAAdHIIAKyQLCTEcU5pFaUui9/wXdWw\n4/m5VvlMfpf+rfG/iGlUna1bF963f0/uXH1Kmnhl9Q64ha/TfxdW8tkDMXr3NKi3\nOhPGQeii70ki7xLd46MrLxJgv69Gvjj6G+zuAuyKUe+slS0SEgJJAWTag4+gTK8S\n+RKqydZNt3NthhU2juHEfdEZievZjB+/xummiRLsJsv3WLSb7VVxMuOoy2maP60t\nJwxlCwHS6wviUZab1v6FmMVpUkOtYDi//chBPDkk8FJ9I8kuEfGVYH+eBTiE+uzh\nmuj919PCAc+CTsCCQ+IUjRIuYcORipgNDsYhaPEhlta8gFg5A3A/3EyqMHNlRNI=\n=Wkdu\n-----END PGP SIGNATURE-----\n", "payload": "tree 40e81ae73928c85bbd6ab452fd317383cf5322d8\nparent b8a85e960398ebab4624574f9c2ed9c655612d56\nparent db8bcf132c901cc9b9f993b17b1e648f55c35e78\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1615823595 +0000\ncommitter GitHub <noreply@github.com> 1615823595 +0000\n\nMerge #7992\n\n7992: improved completion sorting for functions and methods r=JoshMcguigan a=JoshMcguigan\n\nThis PR improves completion sorting for functions and methods. Related to #7935.\r\n\r\n### Before\r\n\r\nThe methods are being sorted by `coc` by closeness in file. \r\n\r\n![pre-fn-relevance](https://user-images.githubusercontent.com/22216761/111018669-fe3d3f00-836e-11eb-9607-cc05af080a6a.png)\r\n\r\n### After\r\n\r\nNotice `bbb()` on top (type + name match), followed by `ddd()` (type match).\r\n\r\n![image](https://user-images.githubusercontent.com/22216761/111018680-0e551e80-836f-11eb-94b1-c88336ecbc6e.png)\r\n\n\nCo-authored-by: Josh Mcguigan <joshmcg88@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eec64ec01b0553aca855df8146965ed6c6746e7d", "html_url": "https://github.com/rust-lang/rust/commit/eec64ec01b0553aca855df8146965ed6c6746e7d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eec64ec01b0553aca855df8146965ed6c6746e7d/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8a85e960398ebab4624574f9c2ed9c655612d56", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8a85e960398ebab4624574f9c2ed9c655612d56", "html_url": "https://github.com/rust-lang/rust/commit/b8a85e960398ebab4624574f9c2ed9c655612d56"}, {"sha": "db8bcf132c901cc9b9f993b17b1e648f55c35e78", "url": "https://api.github.com/repos/rust-lang/rust/commits/db8bcf132c901cc9b9f993b17b1e648f55c35e78", "html_url": "https://github.com/rust-lang/rust/commit/db8bcf132c901cc9b9f993b17b1e648f55c35e78"}], "stats": {"total": 77, "additions": 76, "deletions": 1}, "files": [{"sha": "2514dda7c70096a25f8cddf74d94614d6bb9591a", "filename": "crates/ide_completion/src/render.rs", "status": "modified", "additions": 60, "deletions": 0, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/eec64ec01b0553aca855df8146965ed6c6746e7d/crates%2Fide_completion%2Fsrc%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eec64ec01b0553aca855df8146965ed6c6746e7d/crates%2Fide_completion%2Fsrc%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Frender.rs?ref=eec64ec01b0553aca855df8146965ed6c6746e7d", "patch": "@@ -927,6 +927,66 @@ fn f(foo: &Foo) { f(foo, w$0) }\n         );\n     }\n \n+    #[test]\n+    fn score_fn_type_and_name_match() {\n+        check_relevance(\n+            r#\"\n+struct A { bar: u8 }\n+fn baz() -> u8 { 0 }\n+fn bar() -> u8 { 0 }\n+fn f() { A { bar: b$0 }; }\n+\"#,\n+            expect![[r#\"\n+                fn baz() [type]\n+                st A []\n+                fn bar() [type+name]\n+                fn f() []\n+            \"#]],\n+        );\n+    }\n+\n+    #[test]\n+    fn score_method_type_and_name_match() {\n+        check_relevance(\n+            r#\"\n+fn baz(aaa: u32){}\n+struct Foo;\n+impl Foo {\n+fn aaa(&self) -> u32 { 0 }\n+fn bbb(&self) -> u32 { 0 }\n+fn ccc(&self) -> u64 { 0 }\n+}\n+fn f() {\n+    baz(Foo.$0\n+}\n+\"#,\n+            expect![[r#\"\n+                me aaa() [type+name]\n+                me bbb() [type]\n+                me ccc() []\n+            \"#]],\n+        );\n+    }\n+\n+    #[test]\n+    fn score_method_name_match_only() {\n+        check_relevance(\n+            r#\"\n+fn baz(aaa: u32){}\n+struct Foo;\n+impl Foo {\n+fn aaa(&self) -> u64 { 0 }\n+}\n+fn f() {\n+    baz(Foo.$0\n+}\n+\"#,\n+            expect![[r#\"\n+                me aaa() [name]\n+            \"#]],\n+        );\n+    }\n+\n     #[test]\n     fn suggest_ref_mut() {\n         cov_mark::check!(suggest_ref);"}, {"sha": "47e26a5d8d4cf886fbeb29b6cb66c2ac46764657", "filename": "crates/ide_completion/src/render/function.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/eec64ec01b0553aca855df8146965ed6c6746e7d/crates%2Fide_completion%2Fsrc%2Frender%2Ffunction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eec64ec01b0553aca855df8146965ed6c6746e7d/crates%2Fide_completion%2Fsrc%2Frender%2Ffunction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Frender%2Ffunction.rs?ref=eec64ec01b0553aca855df8146965ed6c6746e7d", "patch": "@@ -5,7 +5,7 @@ use ide_db::SymbolKind;\n use syntax::ast::Fn;\n \n use crate::{\n-    item::{CompletionItem, CompletionItemKind, CompletionKind, ImportEdit},\n+    item::{CompletionItem, CompletionItemKind, CompletionKind, CompletionRelevance, ImportEdit},\n     render::{builder_ext::Params, RenderContext},\n };\n \n@@ -55,6 +55,21 @@ impl<'a> FunctionRender<'a> {\n             .add_call_parens(self.ctx.completion, self.name, params)\n             .add_import(import_to_add);\n \n+        let mut relevance = CompletionRelevance::default();\n+        if let Some(expected_type) = &self.ctx.completion.expected_type {\n+            let ret_ty = self.func.ret_type(self.ctx.db());\n+\n+            // We don't ever consider a function which returns unit type to be an\n+            // exact type match, since nearly always this is not meaningful to the\n+            // user.\n+            relevance.exact_type_match = &ret_ty == expected_type && !ret_ty.is_unit();\n+        }\n+        if let Some(expected_name) = &self.ctx.completion.expected_name {\n+            relevance.exact_name_match =\n+                expected_name == &self.func.name(self.ctx.db()).to_string();\n+        }\n+        item.set_relevance(relevance);\n+\n         item.build()\n     }\n "}]}