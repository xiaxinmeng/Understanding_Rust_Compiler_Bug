{"sha": "d29491aba00fd879c437943aa7629b9867129d9f", "node_id": "C_kwDOAAsO6NoAKGQyOTQ5MWFiYTAwZmQ4NzljNDM3OTQzYWE3NjI5Yjk4NjcxMjlkOWY", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-11-22T11:06:38Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-22T11:06:38Z"}, "message": "Rollup merge of #104669 - LeSeulArtichaut:88015-if-let-guard-bindings, r=cjgillot\n\nOnly declare bindings for if-let guards once per arm\n\nCurrently, each candidate for a match arm uses separate locals for the bindings in the if-let guard, causing problems (#88015) when those branches converge in the arm body.\n\nFixes #88015 (\ud83e\udd1e)", "tree": {"sha": "8991b5eaf8184c712b9daf1591d4a05815a02a89", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8991b5eaf8184c712b9daf1591d4a05815a02a89"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d29491aba00fd879c437943aa7629b9867129d9f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjfK0+CRBK7hj4Ov3rIwAAnaMIAJrl3PnuEFg8ZPLdnRSGRU4Z\nCtzmxhiyKnJUEYTUWaeN5jiGjHA2k67LkBzFYIFf/oPmerUnZofrnP1Pjsa5LR/8\nVBlL/LRRi2LUZNx23FHSkBcI2G8lRHjdhNpcB8ehztdm0F5JYTS/a5RxqC2g12r7\nlY7kc3r0RYgTjwDdecOvnT174QSBr5/a9i2rI2H4GIz+IRTo0qBhQEjepCS/p5du\npXrf816hLO8jrRF2ghbbDd7xGKrESGQzGbnB6nuhmQo835psXhnvYHkxOL2XW9Ha\nk6tzrd4LVSHCXBBLhTMboq31HOYY5kebz1+qAQcgVwX4Nd2jbzS40X+1YQKgMdk=\n=ycyq\n-----END PGP SIGNATURE-----\n", "payload": "tree 8991b5eaf8184c712b9daf1591d4a05815a02a89\nparent 88542a31504ccc39f0e75a7cd5d1b4bee0fbc329\nparent baa59d1a77cfc21442df60c1e34c05e361107e37\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1669115198 +0530\ncommitter GitHub <noreply@github.com> 1669115198 +0530\n\nRollup merge of #104669 - LeSeulArtichaut:88015-if-let-guard-bindings, r=cjgillot\n\nOnly declare bindings for if-let guards once per arm\n\nCurrently, each candidate for a match arm uses separate locals for the bindings in the if-let guard, causing problems (#88015) when those branches converge in the arm body.\n\nFixes #88015 (\ud83e\udd1e)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d29491aba00fd879c437943aa7629b9867129d9f", "html_url": "https://github.com/rust-lang/rust/commit/d29491aba00fd879c437943aa7629b9867129d9f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d29491aba00fd879c437943aa7629b9867129d9f/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "88542a31504ccc39f0e75a7cd5d1b4bee0fbc329", "url": "https://api.github.com/repos/rust-lang/rust/commits/88542a31504ccc39f0e75a7cd5d1b4bee0fbc329", "html_url": "https://github.com/rust-lang/rust/commit/88542a31504ccc39f0e75a7cd5d1b4bee0fbc329"}, {"sha": "baa59d1a77cfc21442df60c1e34c05e361107e37", "url": "https://api.github.com/repos/rust-lang/rust/commits/baa59d1a77cfc21442df60c1e34c05e361107e37", "html_url": "https://github.com/rust-lang/rust/commit/baa59d1a77cfc21442df60c1e34c05e361107e37"}], "stats": {"total": 44, "additions": 27, "deletions": 17}, "files": [{"sha": "49d7136a2f1ffd26faff815c99bfbf1467149acd", "filename": "compiler/rustc_mir_build/src/build/block.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d29491aba00fd879c437943aa7629b9867129d9f/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d29491aba00fd879c437943aa7629b9867129d9f/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fblock.rs?ref=d29491aba00fd879c437943aa7629b9867129d9f", "patch": "@@ -1,4 +1,3 @@\n-use crate::build::matches::ArmHasGuard;\n use crate::build::ForGuard::OutsideGuard;\n use crate::build::{BlockAnd, BlockAndExtension, BlockFrame, Builder};\n use rustc_middle::middle::region::Scope;\n@@ -231,7 +230,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                                         visibility_scope,\n                                         remainder_span,\n                                         pattern,\n-                                        ArmHasGuard(false),\n+                                        None,\n                                         Some((None, initializer_span)),\n                                     );\n                                     this.visit_primary_bindings(\n@@ -308,7 +307,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                                             visibility_scope,\n                                             remainder_span,\n                                             pattern,\n-                                            ArmHasGuard(false),\n+                                            None,\n                                             Some((None, initializer_span)),\n                                         );\n                                         this.expr_into_pattern(block, &pattern, init)\n@@ -324,7 +323,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                                 visibility_scope,\n                                 remainder_span,\n                                 pattern,\n-                                ArmHasGuard(false),\n+                                None,\n                                 None,\n                             );\n                             block.unit()"}, {"sha": "33e4fa58399e2e235e3e0d8290345d99b73c7787", "filename": "compiler/rustc_mir_build/src/build/expr/into.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d29491aba00fd879c437943aa7629b9867129d9f/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Finto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d29491aba00fd879c437943aa7629b9867129d9f/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Finto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Finto.rs?ref=d29491aba00fd879c437943aa7629b9867129d9f", "patch": "@@ -108,7 +108,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             ExprKind::Let { expr, ref pat } => {\n                 let scope = this.local_scope();\n                 let (true_block, false_block) = this.in_if_then_scope(scope, expr_span, |this| {\n-                    this.lower_let_expr(block, &this.thir[expr], pat, scope, None, expr_span)\n+                    this.lower_let_expr(block, &this.thir[expr], pat, scope, None, expr_span, true)\n                 });\n \n                 this.cfg.push_assign_constant("}, {"sha": "802704d6ca77da75ff9db4fcf1cb45969eccfdf1", "filename": "compiler/rustc_mir_build/src/build/matches/mod.rs", "status": "modified", "additions": 15, "deletions": 11, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/d29491aba00fd879c437943aa7629b9867129d9f/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmatches%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d29491aba00fd879c437943aa7629b9867129d9f/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmatches%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmatches%2Fmod.rs?ref=d29491aba00fd879c437943aa7629b9867129d9f", "patch": "@@ -84,6 +84,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                 break_scope,\n                 Some(variable_source_info.scope),\n                 variable_source_info.span,\n+                true,\n             ),\n             _ => {\n                 let temp_scope = temp_scope_override.unwrap_or_else(|| this.local_scope());\n@@ -357,7 +358,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                         None,\n                         arm.span,\n                         &arm.pattern,\n-                        ArmHasGuard(arm.guard.is_some()),\n+                        arm.guard.as_ref(),\n                         opt_scrutinee_place,\n                     );\n \n@@ -645,7 +646,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         mut visibility_scope: Option<SourceScope>,\n         scope_span: Span,\n         pattern: &Pat<'tcx>,\n-        has_guard: ArmHasGuard,\n+        guard: Option<&Guard<'tcx>>,\n         opt_match_place: Option<(Option<&Place<'tcx>>, Span)>,\n     ) -> Option<SourceScope> {\n         self.visit_primary_bindings(\n@@ -667,12 +668,16 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                     var,\n                     ty,\n                     user_ty,\n-                    has_guard,\n+                    ArmHasGuard(guard.is_some()),\n                     opt_match_place.map(|(x, y)| (x.cloned(), y)),\n                     pattern.span,\n                 );\n             },\n         );\n+        if let Some(Guard::IfLet(guard_pat, _)) = guard {\n+            // FIXME: pass a proper `opt_match_place`\n+            self.declare_bindings(visibility_scope, scope_span, guard_pat, None, None);\n+        }\n         visibility_scope\n     }\n \n@@ -1766,6 +1771,8 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n // Pat binding - used for `let` and function parameters as well.\n \n impl<'a, 'tcx> Builder<'a, 'tcx> {\n+    /// If the bindings have already been declared, set `declare_bindings` to\n+    /// `false` to avoid duplicated bindings declaration. Used for if-let guards.\n     pub(crate) fn lower_let_expr(\n         &mut self,\n         mut block: BasicBlock,\n@@ -1774,6 +1781,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         else_target: region::Scope,\n         source_scope: Option<SourceScope>,\n         span: Span,\n+        declare_bindings: bool,\n     ) -> BlockAnd<()> {\n         let expr_span = expr.span;\n         let expr_place_builder = unpack!(block = self.lower_scrutinee(block, expr, expr_span));\n@@ -1797,13 +1805,9 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         let otherwise_post_guard_block = otherwise_candidate.pre_binding_block.unwrap();\n         self.break_for_else(otherwise_post_guard_block, else_target, self.source_info(expr_span));\n \n-        self.declare_bindings(\n-            source_scope,\n-            pat.span.to(span),\n-            pat,\n-            ArmHasGuard(false),\n-            opt_expr_place,\n-        );\n+        if declare_bindings {\n+            self.declare_bindings(source_scope, pat.span.to(span), pat, None, opt_expr_place);\n+        }\n \n         let post_guard_block = self.bind_pattern(\n             self.source_info(pat.span),\n@@ -1984,7 +1988,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                     Guard::IfLet(ref pat, scrutinee) => {\n                         let s = &this.thir[scrutinee];\n                         guard_span = s.span;\n-                        this.lower_let_expr(block, s, pat, match_scope, None, arm.span)\n+                        this.lower_let_expr(block, s, pat, match_scope, None, arm.span, false)\n                     }\n                 });\n "}, {"sha": "0b76122913ebe35899cc52004e3afa55193e60b9", "filename": "compiler/rustc_mir_build/src/build/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d29491aba00fd879c437943aa7629b9867129d9f/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d29491aba00fd879c437943aa7629b9867129d9f/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmod.rs?ref=d29491aba00fd879c437943aa7629b9867129d9f", "patch": "@@ -924,7 +924,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                         scope,\n                         expr.span,\n                         &pat,\n-                        matches::ArmHasGuard(false),\n+                        None,\n                         Some((Some(&place), span)),\n                     );\n                     let place_builder = PlaceBuilder::from(local);"}, {"sha": "a303a0d1fcee3052a2b05133da5e70c540b9a9de", "filename": "src/test/ui/rfc-2294-if-let-guard/run-pass.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d29491aba00fd879c437943aa7629b9867129d9f/src%2Ftest%2Fui%2Frfc-2294-if-let-guard%2Frun-pass.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d29491aba00fd879c437943aa7629b9867129d9f/src%2Ftest%2Fui%2Frfc-2294-if-let-guard%2Frun-pass.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2294-if-let-guard%2Frun-pass.rs?ref=d29491aba00fd879c437943aa7629b9867129d9f", "patch": "@@ -30,4 +30,11 @@ fn main() {\n         Some(x) if let Foo::Qux(y) = qux(x) => assert_eq!(y, 84),\n         _ => panic!(),\n     }\n+\n+    // issue #88015\n+    #[allow(irrefutable_let_patterns)]\n+    match () {\n+        () | () if let x = 42 => assert_eq!(x, 42),\n+        _ => panic!()\n+    }\n }"}]}