{"sha": "90abfe9ce27c81808e3f74861072df6734f6a45d", "node_id": "C_kwDOAAsO6NoAKDkwYWJmZTljZTI3YzgxODA4ZTNmNzQ4NjEwNzJkZjY3MzRmNmE0NWQ", "commit": {"author": {"name": "ouz-a", "email": "oguz.agcayazi@gmail.com", "date": "2022-06-17T13:34:00Z"}, "committer": {"name": "ouz-a", "email": "oguz.agcayazi@gmail.com", "date": "2022-06-17T18:38:26Z"}, "message": "expand inner `or` pattern", "tree": {"sha": "61cfcf41bca34020e47d0c1280609bdd3eb7c1d3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/61cfcf41bca34020e47d0c1280609bdd3eb7c1d3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/90abfe9ce27c81808e3f74861072df6734f6a45d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/90abfe9ce27c81808e3f74861072df6734f6a45d", "html_url": "https://github.com/rust-lang/rust/commit/90abfe9ce27c81808e3f74861072df6734f6a45d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/90abfe9ce27c81808e3f74861072df6734f6a45d/comments", "author": {"login": "ouz-a", "id": 90461915, "node_id": "MDQ6VXNlcjkwNDYxOTE1", "avatar_url": "https://avatars.githubusercontent.com/u/90461915?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ouz-a", "html_url": "https://github.com/ouz-a", "followers_url": "https://api.github.com/users/ouz-a/followers", "following_url": "https://api.github.com/users/ouz-a/following{/other_user}", "gists_url": "https://api.github.com/users/ouz-a/gists{/gist_id}", "starred_url": "https://api.github.com/users/ouz-a/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ouz-a/subscriptions", "organizations_url": "https://api.github.com/users/ouz-a/orgs", "repos_url": "https://api.github.com/users/ouz-a/repos", "events_url": "https://api.github.com/users/ouz-a/events{/privacy}", "received_events_url": "https://api.github.com/users/ouz-a/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ouz-a", "id": 90461915, "node_id": "MDQ6VXNlcjkwNDYxOTE1", "avatar_url": "https://avatars.githubusercontent.com/u/90461915?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ouz-a", "html_url": "https://github.com/ouz-a", "followers_url": "https://api.github.com/users/ouz-a/followers", "following_url": "https://api.github.com/users/ouz-a/following{/other_user}", "gists_url": "https://api.github.com/users/ouz-a/gists{/gist_id}", "starred_url": "https://api.github.com/users/ouz-a/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ouz-a/subscriptions", "organizations_url": "https://api.github.com/users/ouz-a/orgs", "repos_url": "https://api.github.com/users/ouz-a/repos", "events_url": "https://api.github.com/users/ouz-a/events{/privacy}", "received_events_url": "https://api.github.com/users/ouz-a/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3a8b0144c82197a70e919ad371d56f82c2282833", "url": "https://api.github.com/repos/rust-lang/rust/commits/3a8b0144c82197a70e919ad371d56f82c2282833", "html_url": "https://github.com/rust-lang/rust/commit/3a8b0144c82197a70e919ad371d56f82c2282833"}], "stats": {"total": 89, "additions": 88, "deletions": 1}, "files": [{"sha": "5bb2f00d3cf47d7525a7ca21fe1889b80020b21f", "filename": "compiler/rustc_mir_build/src/thir/pattern/usefulness.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/90abfe9ce27c81808e3f74861072df6734f6a45d/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fusefulness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90abfe9ce27c81808e3f74861072df6734f6a45d/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fusefulness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fusefulness.rs?ref=90abfe9ce27c81808e3f74861072df6734f6a45d", "patch": "@@ -453,7 +453,17 @@ impl<'p, 'tcx> Matrix<'p, 'tcx> {\n     /// expands it.\n     fn push(&mut self, row: PatStack<'p, 'tcx>) {\n         if !row.is_empty() && row.head().is_or_pat() {\n-            self.patterns.extend(row.expand_or_pat());\n+            let pats = row.expand_or_pat();\n+            let mut no_inner_or = true;\n+            for pat in pats {\n+                if !pat.is_empty() && pat.head().is_or_pat() {\n+                    self.patterns.extend(pat.expand_or_pat());\n+                    no_inner_or = false;\n+                }\n+            }\n+            if no_inner_or {\n+                self.patterns.extend(row.expand_or_pat());\n+            }\n         } else {\n             self.patterns.push(row);\n         }"}, {"sha": "3053d97345320d8e28e6487c84b5b72080c7aa02", "filename": "src/test/ui/or-patterns/inner-or-pat-2.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/90abfe9ce27c81808e3f74861072df6734f6a45d/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90abfe9ce27c81808e3f74861072df6734f6a45d/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-2.rs?ref=90abfe9ce27c81808e3f74861072df6734f6a45d", "patch": "@@ -0,0 +1,13 @@\n+#[allow(unused_variables)]\n+#[allow(unused_parens)]\n+fn main() {\n+    let x = \"foo\";\n+    match x {\n+        x @ (((\"h\" | \"ho\" | \"yo\" | (\"dude\" | \"w\")) | () | \"nop\") | (\"hey\" | \"gg\")) |\n+        //~^ ERROR mismatched types\n+        x @ (\"black\" | \"pink\") |\n+        x @ (\"red\" | \"blue\") => {\n+        }\n+        _ => (),\n+    }\n+}"}, {"sha": "505b6c64a22232bd7327c1ba758161539836b76a", "filename": "src/test/ui/or-patterns/inner-or-pat-2.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/90abfe9ce27c81808e3f74861072df6734f6a45d/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/90abfe9ce27c81808e3f74861072df6734f6a45d/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-2.stderr?ref=90abfe9ce27c81808e3f74861072df6734f6a45d", "patch": "@@ -0,0 +1,11 @@\n+error[E0308]: mismatched types\n+  --> $DIR/inner-or-pat-2.rs:6:54\n+   |\n+LL |     match x {\n+   |           - this expression has type `&str`\n+LL |         x @ (((\"h\" | \"ho\" | \"yo\" | (\"dude\" | \"w\")) | () | \"nop\") | (\"hey\" | \"gg\")) |\n+   |                                                      ^^ expected `str`, found `()`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0308`."}, {"sha": "f6fe8a4dd59dc7a33feae238ac5d2d2cba35b4d5", "filename": "src/test/ui/or-patterns/inner-or-pat-3.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/90abfe9ce27c81808e3f74861072df6734f6a45d/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-3.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90abfe9ce27c81808e3f74861072df6734f6a45d/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-3.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-3.rs?ref=90abfe9ce27c81808e3f74861072df6734f6a45d", "patch": "@@ -0,0 +1,15 @@\n+// run-pass\n+\n+#[allow(unreachable_patterns)]\n+#[allow(unused_variables)]\n+#[allow(unused_parens)]\n+fn main() {\n+    let x = \"foo\";\n+\n+    match x {\n+        x @ (\"foo\" | \"bar\") |\n+        (x @ \"red\" | (x @ \"blue\" | x @ \"red\")) => {\n+        }\n+        _ => (),\n+    }\n+}"}, {"sha": "fe771e2e9301f252bfe1fcf32b078b2141649630", "filename": "src/test/ui/or-patterns/inner-or-pat-4.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/90abfe9ce27c81808e3f74861072df6734f6a45d/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-4.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90abfe9ce27c81808e3f74861072df6734f6a45d/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-4.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-4.rs?ref=90abfe9ce27c81808e3f74861072df6734f6a45d", "patch": "@@ -0,0 +1,13 @@\n+#[allow(unused_variables)]\n+#[allow(unused_parens)]\n+fn main() {\n+    let x = \"foo\";\n+\n+    match x {\n+        x @ (\"foo\" | \"bar\") |\n+        (x @ \"red\" | (x @ \"blue\" |  \"red\")) => {\n+        //~^ variable `x` is not bound in all patterns\n+        }\n+        _ => (),\n+    }\n+}"}, {"sha": "177c7f983125650605f9b3bf23cb4f3fd5006300", "filename": "src/test/ui/or-patterns/inner-or-pat-4.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/90abfe9ce27c81808e3f74861072df6734f6a45d/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-4.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/90abfe9ce27c81808e3f74861072df6734f6a45d/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-4.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat-4.stderr?ref=90abfe9ce27c81808e3f74861072df6734f6a45d", "patch": "@@ -0,0 +1,11 @@\n+error[E0408]: variable `x` is not bound in all patterns\n+  --> $DIR/inner-or-pat-4.rs:8:37\n+   |\n+LL |         (x @ \"red\" | (x @ \"blue\" |  \"red\")) => {\n+   |                       -             ^^^^^ pattern doesn't bind `x`\n+   |                       |\n+   |                       variable not in all patterns\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0408`."}, {"sha": "c49b04aa65b1e7467fbc24fb3622e9a0f35e5f05", "filename": "src/test/ui/or-patterns/inner-or-pat.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/90abfe9ce27c81808e3f74861072df6734f6a45d/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90abfe9ce27c81808e3f74861072df6734f6a45d/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Finner-or-pat.rs?ref=90abfe9ce27c81808e3f74861072df6734f6a45d", "patch": "@@ -0,0 +1,14 @@\n+// run-pass\n+\n+#[allow(unused_variables)]\n+#[allow(unused_parens)]\n+fn main() {\n+    let x = \"foo\";\n+    match x {\n+        x @ (((\"h\" | \"ho\" | \"yo\" | (\"dude\" | \"w\")) | \"no\" | \"nop\") | (\"hey\" | \"gg\")) |\n+        x @ (\"black\" | \"pink\") |\n+        x @ (\"red\" | \"blue\") => {\n+        }\n+        _ => (),\n+    }\n+}"}]}