{"sha": "2b2045d16173b3db25c74680b25cae67d41248df", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJiMjA0NWQxNjE3M2IzZGIyNWM3NDY4MGIyNWNhZTY3ZDQxMjQ4ZGY=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-02-17T21:24:13Z"}, "committer": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-02-18T14:28:10Z"}, "message": "ci: fix docker cache hash collision\n\nBefore this commit the hash used to cache docker images was calculated\nfrom the image's files and the files in the scripts/ directory. This\nworked fine when all the files used by an image were in those\ndirectories, but some images pull files from other images, causing hash\ncollisions in some cases.\n\nThis commit changes the hash to include the files of all the docker\nimages, causing a rebuild of all the images when a single one changes.\nThat's a bit heavy-handed, but we have no way to track which files an\nimage pulls in and hash collisions are really painful to deal with.", "tree": {"sha": "36c588f9ce2db8ad8ab2a3c9495fea87402b181d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/36c588f9ce2db8ad8ab2a3c9495fea87402b181d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2b2045d16173b3db25c74680b25cae67d41248df", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v2\n\niQIcBAABCAAGBQJcasD8AAoJED4Gq+gLqvGcdWMP/1eWm44pvhw0RKjWO+OMjWjK\nw2I8223koLuJyrmkqEiMD3tGUUcDy0zJWFCh0zTcq9SRMwnTwrN0koCIy7nU7+vP\ngy6Lz8WH3lZzKY7fTOhN/v7WkGT3vqoM9RgVgE02XLVE7VCA+IkhpmMH4l7/tjnn\nYGZqAwb70XALMc7jAZhj5w6kXMlTnmcLhyr/TFUIxoZgyP+fOZQxteXCmugZeq+C\nrwyUDNYKAN/QsVm3S5KXO5+DW2HjE1oftDpAXGVpypvsu6ihDeTnmMCa1qNE7wwZ\nbgy5yWL0A3VCif0aphSMbfdK1uLoYQhhx+DaFGOkNcyL5UXIrerx1c+hMqPAYIgo\ncvjGxPv1Hyn7EJAukX4AAhsvV+gVPxdVa4vQ4FqQrq7s8MQn230NoZz6VfVK7GVs\nVS/jbwaz04LPUQhNDnvEFu09uF+NyiTO2irtqRiNXfNGvEWdPDh/4kOdz/AAYbjz\nXTxZhjF1rYmkSBoqwbSm3h/CuK0JVUuyAZUF2a7+uTtljfSJ3t1vRQSHz4JjYnue\nNYNcrPSOolEdM5QuY5WeRUL+E06RElZy+dZQTQNPiGk80Vh9sPrm9hIUgTI/ssSz\nLXAwL7C9WVEFDhSCfqVe9TB555l15w9w84tBfp7F7H+yVowvOsVfrKs1YW38wLsZ\ngE2+P4VQOS2LFS+UFQR7\n=odO7\n-----END PGP SIGNATURE-----", "payload": "tree 36c588f9ce2db8ad8ab2a3c9495fea87402b181d\nparent 8af675a07576940ba24e3d91abd10b029b937946\nauthor Pietro Albini <pietro@pietroalbini.org> 1550438653 +0100\ncommitter Pietro Albini <pietro@pietroalbini.org> 1550500090 +0100\n\nci: fix docker cache hash collision\n\nBefore this commit the hash used to cache docker images was calculated\nfrom the image's files and the files in the scripts/ directory. This\nworked fine when all the files used by an image were in those\ndirectories, but some images pull files from other images, causing hash\ncollisions in some cases.\n\nThis commit changes the hash to include the files of all the docker\nimages, causing a rebuild of all the images when a single one changes.\nThat's a bit heavy-handed, but we have no way to track which files an\nimage pulls in and hash collisions are really painful to deal with.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2b2045d16173b3db25c74680b25cae67d41248df", "html_url": "https://github.com/rust-lang/rust/commit/2b2045d16173b3db25c74680b25cae67d41248df", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2b2045d16173b3db25c74680b25cae67d41248df/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8af675a07576940ba24e3d91abd10b029b937946", "url": "https://api.github.com/repos/rust-lang/rust/commits/8af675a07576940ba24e3d91abd10b029b937946", "html_url": "https://github.com/rust-lang/rust/commit/8af675a07576940ba24e3d91abd10b029b937946"}], "stats": {"total": 6, "additions": 3, "deletions": 3}, "files": [{"sha": "25d4d73c7fe039290b63616b099e2d0181d7f080", "filename": "src/ci/docker/run.sh", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/2b2045d16173b3db25c74680b25cae67d41248df/src%2Fci%2Fdocker%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/2b2045d16173b3db25c74680b25cae67d41248df/src%2Fci%2Fdocker%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Frun.sh?ref=2b2045d16173b3db25c74680b25cae67d41248df", "patch": "@@ -20,9 +20,9 @@ travis_time_start\n if [ -f \"$docker_dir/$image/Dockerfile\" ]; then\n     if [ \"$CI\" != \"\" ]; then\n       hash_key=/tmp/.docker-hash-key.txt\n-      find $docker_dir/$image $docker_dir/scripts -type f | \\\n-        sort | \\\n-        xargs cat >> $hash_key\n+      rm -f \"${hash_key}\"\n+      echo $image >> $hash_key\n+      find $docker_dir -type f | sort | xargs cat >> $hash_key\n       docker --version >> $hash_key\n       cksum=$(sha512sum $hash_key | \\\n         awk '{print $1}')"}]}