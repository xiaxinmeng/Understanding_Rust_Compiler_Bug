{"sha": "4cef648c1ee90f064e3fdd7d5e0e30e283c6993c", "node_id": "C_kwDOAAsO6NoAKDRjZWY2NDhjMWVlOTBmMDY0ZTNmZGQ3ZDVlMGUzMGUyODNjNjk5M2M", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-09-27T19:42:22Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-09-27T19:42:22Z"}, "message": "Rollup merge of #102253 - jsha:css-contain, r=notriddle\n\nrustdoc: use CSS containment to speed up render\n\nhttps://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Containment\n\nThis affected layout a little and required adjustments to the CSS to keep spacing the same. In particular, the margins of adjacent items usually overlap with each other. However, when an item has contain: layout, any margins of child nodes push out the size of the item itself. This was making spacing between items a little too big. To solve that, I removed margins in some places: in particular for certain classes that often occur at the end of a `details.rustdoc-toggle` block, I removed their bottom margin. Generally, the margins provided by the next item down are sufficient.\n\nAlso remove an unnecessary margin-top on .code-header.\n\nIn particular this helps with the problem that rustdoc in some situations can generate giant HTML pages, which can crash a Chrome tab on typical modern hardware, for instance: `https://docs.rs/iced-x86/1.16.0/iced_x86/code_asm/struct.CodeAssembler.html` (26MB, 409k DOM nodes). This doesn't, of course, universally solve the problem, but it pushes out the boundary of the largest page rustdoc can produce without crashing a browser tab.\n\nDemos:\n\nhttps://rustdoc.crud.net/jsha/css-contain/std/string/struct.String.html\n(warning: giant page, _may_ crash a browser tab) https://rustdoc.crud.net/jsha/css-contain-icedx86/iced_x86/code_asm/struct.CodeAssembler.html\n\nr? `@notriddle`", "tree": {"sha": "9ac9bd23dccd97ce5f5e0211d52686d38fb065b8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9ac9bd23dccd97ce5f5e0211d52686d38fb065b8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4cef648c1ee90f064e3fdd7d5e0e30e283c6993c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjM1IeCRBK7hj4Ov3rIwAALrYIADvux2Q+YlBBR4NYnCs/vlKd\n+UmYpYmi/ZBuR/Ik3k3UB4kENOE/TDiLcaRjzE8NED+1PkvAIsC1K2obcueaM6Td\nxcz1KilyaOgJjwxtQMt5R4kaadnRsMEVp9kjwjy5j73XgNZ0vBLRk33yJOyyW91m\nRsEYoPHMk+ncUd7mqpmWEThUzFGH7DwsX6CMU3ZOfR9Yw/GdWdfhL1PDLCbOczH7\nHusufYimYbIGlm3+l67cI2/KEQVdLidGmAjR85U6cbdhtxPWOS2g2yLoiVD/bCET\nSii6rVLuRqkTSV1FoJNwMoQPv3OU+7fapK7RQUCYA3awvNf5DXzvAJ/+O4yYx0w=\n=zLDz\n-----END PGP SIGNATURE-----\n", "payload": "tree 9ac9bd23dccd97ce5f5e0211d52686d38fb065b8\nparent ad57d5f27c9ce7752e3e7de50536065136a14f0c\nparent b5b77a295972307c24dc0095ce693102c8e4884c\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1664307742 +0200\ncommitter GitHub <noreply@github.com> 1664307742 +0200\n\nRollup merge of #102253 - jsha:css-contain, r=notriddle\n\nrustdoc: use CSS containment to speed up render\n\nhttps://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Containment\n\nThis affected layout a little and required adjustments to the CSS to keep spacing the same. In particular, the margins of adjacent items usually overlap with each other. However, when an item has contain: layout, any margins of child nodes push out the size of the item itself. This was making spacing between items a little too big. To solve that, I removed margins in some places: in particular for certain classes that often occur at the end of a `details.rustdoc-toggle` block, I removed their bottom margin. Generally, the margins provided by the next item down are sufficient.\n\nAlso remove an unnecessary margin-top on .code-header.\n\nIn particular this helps with the problem that rustdoc in some situations can generate giant HTML pages, which can crash a Chrome tab on typical modern hardware, for instance: `https://docs.rs/iced-x86/1.16.0/iced_x86/code_asm/struct.CodeAssembler.html` (26MB, 409k DOM nodes). This doesn't, of course, universally solve the problem, but it pushes out the boundary of the largest page rustdoc can produce without crashing a browser tab.\n\nDemos:\n\nhttps://rustdoc.crud.net/jsha/css-contain/std/string/struct.String.html\n(warning: giant page, _may_ crash a browser tab) https://rustdoc.crud.net/jsha/css-contain-icedx86/iced_x86/code_asm/struct.CodeAssembler.html\n\nr? `@notriddle`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4cef648c1ee90f064e3fdd7d5e0e30e283c6993c", "html_url": "https://github.com/rust-lang/rust/commit/4cef648c1ee90f064e3fdd7d5e0e30e283c6993c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4cef648c1ee90f064e3fdd7d5e0e30e283c6993c/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ad57d5f27c9ce7752e3e7de50536065136a14f0c", "url": "https://api.github.com/repos/rust-lang/rust/commits/ad57d5f27c9ce7752e3e7de50536065136a14f0c", "html_url": "https://github.com/rust-lang/rust/commit/ad57d5f27c9ce7752e3e7de50536065136a14f0c"}, {"sha": "b5b77a295972307c24dc0095ce693102c8e4884c", "url": "https://api.github.com/repos/rust-lang/rust/commits/b5b77a295972307c24dc0095ce693102c8e4884c", "html_url": "https://github.com/rust-lang/rust/commit/b5b77a295972307c24dc0095ce693102c8e4884c"}], "stats": {"total": 48, "additions": 32, "deletions": 16}, "files": [{"sha": "a3712a73b5195f99c65d7f0e2c72b004d45473f3", "filename": "src/librustdoc/html/static/css/rustdoc.css", "status": "modified", "additions": 29, "deletions": 13, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/4cef648c1ee90f064e3fdd7d5e0e30e283c6993c/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "raw_url": "https://github.com/rust-lang/rust/raw/4cef648c1ee90f064e3fdd7d5e0e30e283c6993c/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css?ref=4cef648c1ee90f064e3fdd7d5e0e30e283c6993c", "patch": "@@ -132,7 +132,7 @@ h1, h2, h3, h4, h5, h6 {\n \tfont-weight: 500;\n }\n h1, h2, h3, h4 {\n-\tmargin: 20px 0 15px 0;\n+\tmargin: 25px 0 15px 0;\n \tpadding-bottom: 6px;\n }\n .docblock h3, .docblock h4, h5, h6 {\n@@ -176,8 +176,6 @@ h4.code-header {\n \tborder-bottom-style: none;\n \tmargin: 0;\n \tpadding: 0;\n-\tmargin-top: 0.6rem;\n-\tmargin-bottom: 0.4rem;\n }\n .impl,\n .impl-items .method,\n@@ -292,6 +290,11 @@ p {\n \t   https://www.w3.org/WAI/WCAG21/Understanding/visual-presentation.html */\n \tmargin: 0 0 .75em 0;\n }\n+/* For the last child of a div, the margin will be taken care of\n+\tby the margin-top of the next item. */\n+p:last-child {\n+\tmargin: 0;\n+}\n \n summary {\n \toutline: none;\n@@ -565,9 +568,16 @@ h2.location a {\n \n .rustdoc .example-wrap {\n \tdisplay: flex;\n-\tmargin-bottom: 10px;\n \tposition: relative;\n }\n+.rustdoc .example-wrap {\n+\tmargin-bottom: 10px;\n+}\n+/* For the last child of a div, the margin will be taken care of\n+\tby the margin-top of the next item. */\n+.rustdoc .example-wrap:last-child {\n+\tmargin-bottom: 0px;\n+}\n \n pre.example-line-numbers {\n \toverflow: initial;\n@@ -726,10 +736,6 @@ pre, .rustdoc.source .example-wrap {\n \tmargin-left: 24px;\n }\n \n-.content .impl-items .docblock, .content .impl-items .item-info {\n-\tmargin-bottom: .6em;\n-}\n-\n #main-content > .item-info {\n \tmargin-top: 0;\n \tmargin-left: 0;\n@@ -1532,6 +1538,16 @@ details.dir-entry a {\n \tdisplay: block;\n }\n \n+/* We use CSS containment on the details elements because most sizeable elements\n+\tof the page are contained in one of these. This also makes re-rendering\n+\tfaster on document changes (like closing and opening toggles).\n+\tUnfortunately we can't yet specify contain: content or contain: strict\n+\tbecause the [-]/[+] toggles extend past the boundaries of the <details>\n+\thttps://developer.mozilla.org/en-US/docs/Web/CSS/contain */\n+details.rustdoc-toggle {\n+\tcontain: layout;\n+}\n+\n /* The hideme class is used on summary tags that contain a span with\n \tplaceholder text shown only when the toggle is closed. For instance,\n \t\"Expand description\" or \"Show methods\". */\n@@ -2012,17 +2028,17 @@ in storage.js plus the media query with (min-width: 701px)\n \tmargin-bottom: 0.75em;\n }\n \n-.method-toggle[open] {\n+.method-toggle[open]:not(:last-child) {\n \tmargin-bottom: 2em;\n }\n \n-.implementors-toggle[open]  {\n+.implementors-toggle[open]:not(:last-child) {\n \tmargin-bottom: 2em;\n }\n \n-#trait-implementations-list .method-toggle,\n-#synthetic-implementations-list .method-toggle,\n-#blanket-implementations-list .method-toggle {\n+#trait-implementations-list .method-toggle:not(:last-child),\n+#synthetic-implementations-list .method-toggle:not(:last-child),\n+#blanket-implementations-list .method-toggle:not(:last-child) {\n \tmargin-bottom: 1em;\n }\n "}, {"sha": "9af7c636a0cac6d24af4f51b41327c5469d744f3", "filename": "src/test/rustdoc-gui/sidebar-mobile-scroll.goml", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4cef648c1ee90f064e3fdd7d5e0e30e283c6993c/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile-scroll.goml", "raw_url": "https://github.com/rust-lang/rust/raw/4cef648c1ee90f064e3fdd7d5e0e30e283c6993c/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile-scroll.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile-scroll.goml?ref=4cef648c1ee90f064e3fdd7d5e0e30e283c6993c", "patch": "@@ -6,7 +6,7 @@ assert-css: (\".sidebar\", {\"display\": \"block\", \"left\": \"-1000px\"})\n \n // Scroll down.\n scroll-to: \"//h2[@id='blanket-implementations']\"\n-assert-window-property: {\"pageYOffset\": \"643\"}\n+assert-window-property: {\"pageYOffset\": \"639\"}\n \n // Open the sidebar menu.\n click: \".sidebar-menu-toggle\"\n@@ -21,11 +21,11 @@ assert-window-property: {\"pageYOffset\": \"0\"}\n // Close the sidebar menu. Make sure the scroll position gets restored.\n click: \".sidebar-menu-toggle\"\n wait-for-css: (\".sidebar\", {\"left\": \"-1000px\"})\n-assert-window-property: {\"pageYOffset\": \"643\"}\n+assert-window-property: {\"pageYOffset\": \"639\"}\n \n // Now test that scrollability returns when the browser window is just resized.\n click: \".sidebar-menu-toggle\"\n wait-for-css: (\".sidebar\", {\"left\": \"0px\"})\n assert-window-property: {\"pageYOffset\": \"0\"}\n size: (900, 600)\n-assert-window-property: {\"pageYOffset\": \"643\"}\n+assert-window-property: {\"pageYOffset\": \"639\"}"}]}