{"sha": "31c2ad0d4cdd06622353a57b3a678586077b84fe", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMxYzJhZDBkNGNkZDA2NjIyMzUzYTU3YjNhNjc4NTg2MDc3Yjg0ZmU=", "commit": {"author": {"name": "Joshua M. Clulow", "email": "jmc@oxide.computer", "date": "2021-05-07T00:01:50Z"}, "committer": {"name": "Joshua M. Clulow", "email": "jmc@oxide.computer", "date": "2021-05-07T00:08:10Z"}, "message": "illumos should put libc last in library search order\n\nUnder some conditions, the toolchain will produce a sequence of linker\narguments that result in a NEEDED list that puts libc before libgcc_s;\ne.g.,\n\n    [0]  NEEDED            0x2046ba            libc.so.1\n    [1]  NEEDED            0x204723            libm.so.2\n    [2]  NEEDED            0x204736            libsocket.so.1\n    [3]  NEEDED            0x20478b            libumem.so.1\n    [4]  NEEDED            0x204763            libgcc_s.so.1\n\nBoth libc and libgcc_s provide an unwinder implementation, but libgcc_s\nprovides some extra symbols upon which Rust directly depends.  If libc\nis first in the NEEDED list we will find some of those symbols in libc\nbut others in libgcc_s, resulting in undefined behaviour as the two\nimplementations do not use compatible interior data structures.\n\nThis solution is not perfect, but is the simplest way to produce correct\nbinaries on illumos for now.", "tree": {"sha": "49d6d58a796c83a9801bc32165bf3bdf2d64105b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/49d6d58a796c83a9801bc32165bf3bdf2d64105b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/31c2ad0d4cdd06622353a57b3a678586077b84fe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/31c2ad0d4cdd06622353a57b3a678586077b84fe", "html_url": "https://github.com/rust-lang/rust/commit/31c2ad0d4cdd06622353a57b3a678586077b84fe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/31c2ad0d4cdd06622353a57b3a678586077b84fe/comments", "author": {"login": "jclulow", "id": 304070, "node_id": "MDQ6VXNlcjMwNDA3MA==", "avatar_url": "https://avatars.githubusercontent.com/u/304070?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jclulow", "html_url": "https://github.com/jclulow", "followers_url": "https://api.github.com/users/jclulow/followers", "following_url": "https://api.github.com/users/jclulow/following{/other_user}", "gists_url": "https://api.github.com/users/jclulow/gists{/gist_id}", "starred_url": "https://api.github.com/users/jclulow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jclulow/subscriptions", "organizations_url": "https://api.github.com/users/jclulow/orgs", "repos_url": "https://api.github.com/users/jclulow/repos", "events_url": "https://api.github.com/users/jclulow/events{/privacy}", "received_events_url": "https://api.github.com/users/jclulow/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jclulow", "id": 304070, "node_id": "MDQ6VXNlcjMwNDA3MA==", "avatar_url": "https://avatars.githubusercontent.com/u/304070?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jclulow", "html_url": "https://github.com/jclulow", "followers_url": "https://api.github.com/users/jclulow/followers", "following_url": "https://api.github.com/users/jclulow/following{/other_user}", "gists_url": "https://api.github.com/users/jclulow/gists{/gist_id}", "starred_url": "https://api.github.com/users/jclulow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jclulow/subscriptions", "organizations_url": "https://api.github.com/users/jclulow/orgs", "repos_url": "https://api.github.com/users/jclulow/repos", "events_url": "https://api.github.com/users/jclulow/events{/privacy}", "received_events_url": "https://api.github.com/users/jclulow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "676ee14729462585b969bbc52f32c307403f4126", "url": "https://api.github.com/repos/rust-lang/rust/commits/676ee14729462585b969bbc52f32c307403f4126", "html_url": "https://github.com/rust-lang/rust/commit/676ee14729462585b969bbc52f32c307403f4126"}], "stats": {"total": 19, "additions": 19, "deletions": 0}, "files": [{"sha": "a66de89f6817996a6ba13390ede306cf1d1e05b7", "filename": "compiler/rustc_codegen_ssa/src/back/linker.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/31c2ad0d4cdd06622353a57b3a678586077b84fe/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31c2ad0d4cdd06622353a57b3a678586077b84fe/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs?ref=31c2ad0d4cdd06622353a57b3a678586077b84fe", "patch": "@@ -340,6 +340,14 @@ impl<'a> Linker for GccLinker<'a> {\n     }\n \n     fn link_dylib(&mut self, lib: Symbol, verbatim: bool, as_needed: bool) {\n+        if self.sess.target.os == \"illumos\" && lib.as_str() == \"c\" {\n+            // libc will be added via late_link_args on illumos so that it will\n+            // appear last in the library search order.\n+            // FIXME: This should be replaced by a more complete and generic\n+            // mechanism for controlling the order of library arguments passed\n+            // to the linker.\n+            return;\n+        }\n         if !as_needed {\n             if self.sess.target.is_like_osx {\n                 // FIXME(81490): ld64 doesn't support these flags but macOS 11"}, {"sha": "2b8e046c46b0e7135ce9893b3eb4375e87760547", "filename": "compiler/rustc_target/src/spec/illumos_base.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/31c2ad0d4cdd06622353a57b3a678586077b84fe/compiler%2Frustc_target%2Fsrc%2Fspec%2Fillumos_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31c2ad0d4cdd06622353a57b3a678586077b84fe/compiler%2Frustc_target%2Fsrc%2Fspec%2Fillumos_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fillumos_base.rs?ref=31c2ad0d4cdd06622353a57b3a678586077b84fe", "patch": "@@ -6,6 +6,17 @@ pub fn opts() -> TargetOptions {\n     late_link_args.insert(\n         LinkerFlavor::Gcc,\n         vec![\n+            // The illumos libc contains a stack unwinding implementation, as\n+            // does libgcc_s.  The latter implementation includes several\n+            // additional symbols that are not always in base libc.  To force\n+            // the consistent use of just one unwinder, we ensure libc appears\n+            // after libgcc_s in the NEEDED list for the resultant binary by\n+            // ignoring any attempts to add it as a dynamic dependency until the\n+            // very end.\n+            // FIXME: This should be replaced by a more complete and generic\n+            // mechanism for controlling the order of library arguments passed\n+            // to the linker.\n+            \"-lc\".to_string(),\n             // LLVM will insert calls to the stack protector functions\n             // \"__stack_chk_fail\" and \"__stack_chk_guard\" into code in native\n             // object files.  Some platforms include these symbols directly in"}]}