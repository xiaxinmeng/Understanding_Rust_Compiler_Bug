{"sha": "9492de584319c0331619991e5b201ea6e00b9b2f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk0OTJkZTU4NDMxOWMwMzMxNjE5OTkxZTViMjAxZWE2ZTAwYjliMmY=", "commit": {"author": {"name": "Devin Ragotzy", "email": "devin.ragotzy@gmail.com", "date": "2021-05-31T18:15:17Z"}, "committer": {"name": "Devin Ragotzy", "email": "devin.ragotzy@gmail.com", "date": "2021-06-24T20:13:02Z"}, "message": "Add import_rename lint, this adds a field on the Conf struct\n\nRename lint and fix review issues", "tree": {"sha": "3dd215ca0c8977319593dd73c9bf3f94620102e5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3dd215ca0c8977319593dd73c9bf3f94620102e5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9492de584319c0331619991e5b201ea6e00b9b2f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9492de584319c0331619991e5b201ea6e00b9b2f", "html_url": "https://github.com/rust-lang/rust/commit/9492de584319c0331619991e5b201ea6e00b9b2f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9492de584319c0331619991e5b201ea6e00b9b2f/comments", "author": {"login": "DevinR528", "id": 29749111, "node_id": "MDQ6VXNlcjI5NzQ5MTEx", "avatar_url": "https://avatars.githubusercontent.com/u/29749111?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DevinR528", "html_url": "https://github.com/DevinR528", "followers_url": "https://api.github.com/users/DevinR528/followers", "following_url": "https://api.github.com/users/DevinR528/following{/other_user}", "gists_url": "https://api.github.com/users/DevinR528/gists{/gist_id}", "starred_url": "https://api.github.com/users/DevinR528/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DevinR528/subscriptions", "organizations_url": "https://api.github.com/users/DevinR528/orgs", "repos_url": "https://api.github.com/users/DevinR528/repos", "events_url": "https://api.github.com/users/DevinR528/events{/privacy}", "received_events_url": "https://api.github.com/users/DevinR528/received_events", "type": "User", "site_admin": false}, "committer": {"login": "DevinR528", "id": 29749111, "node_id": "MDQ6VXNlcjI5NzQ5MTEx", "avatar_url": "https://avatars.githubusercontent.com/u/29749111?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DevinR528", "html_url": "https://github.com/DevinR528", "followers_url": "https://api.github.com/users/DevinR528/followers", "following_url": "https://api.github.com/users/DevinR528/following{/other_user}", "gists_url": "https://api.github.com/users/DevinR528/gists{/gist_id}", "starred_url": "https://api.github.com/users/DevinR528/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DevinR528/subscriptions", "organizations_url": "https://api.github.com/users/DevinR528/orgs", "repos_url": "https://api.github.com/users/DevinR528/repos", "events_url": "https://api.github.com/users/DevinR528/events{/privacy}", "received_events_url": "https://api.github.com/users/DevinR528/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "86bf28dfab88118a22e5c9b46ac7d9634ac54908", "url": "https://api.github.com/repos/rust-lang/rust/commits/86bf28dfab88118a22e5c9b46ac7d9634ac54908", "html_url": "https://github.com/rust-lang/rust/commit/86bf28dfab88118a22e5c9b46ac7d9634ac54908"}], "stats": {"total": 185, "additions": 184, "deletions": 1}, "files": [{"sha": "5f62a172035d08aca158c30959ecbc67f2d8a792", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9492de584319c0331619991e5b201ea6e00b9b2f/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/9492de584319c0331619991e5b201ea6e00b9b2f/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=9492de584319c0331619991e5b201ea6e00b9b2f", "patch": "@@ -2657,6 +2657,7 @@ Released 2018-09-13\n [`misrefactored_assign_op`]: https://rust-lang.github.io/rust-clippy/master/index.html#misrefactored_assign_op\n [`missing_const_for_fn`]: https://rust-lang.github.io/rust-clippy/master/index.html#missing_const_for_fn\n [`missing_docs_in_private_items`]: https://rust-lang.github.io/rust-clippy/master/index.html#missing_docs_in_private_items\n+[`missing_enforced_import_renames`]: https://rust-lang.github.io/rust-clippy/master/index.html#missing_enforced_import_renames\n [`missing_errors_doc`]: https://rust-lang.github.io/rust-clippy/master/index.html#missing_errors_doc\n [`missing_inline_in_public_items`]: https://rust-lang.github.io/rust-clippy/master/index.html#missing_inline_in_public_items\n [`missing_panics_doc`]: https://rust-lang.github.io/rust-clippy/master/index.html#missing_panics_doc"}, {"sha": "9cffeeb02249fcde4e695dc6de65ca076d045a0f", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/9492de584319c0331619991e5b201ea6e00b9b2f/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9492de584319c0331619991e5b201ea6e00b9b2f/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=9492de584319c0331619991e5b201ea6e00b9b2f", "patch": "@@ -267,6 +267,7 @@ mod misc;\n mod misc_early;\n mod missing_const_for_fn;\n mod missing_doc;\n+mod missing_enforced_import_rename;\n mod missing_inline;\n mod modulo_arithmetic;\n mod multiple_crate_versions;\n@@ -813,6 +814,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         misc_early::ZERO_PREFIXED_LITERAL,\n         missing_const_for_fn::MISSING_CONST_FOR_FN,\n         missing_doc::MISSING_DOCS_IN_PRIVATE_ITEMS,\n+        missing_enforced_import_rename::MISSING_ENFORCED_IMPORT_RENAMES,\n         missing_inline::MISSING_INLINE_IN_PUBLIC_ITEMS,\n         modulo_arithmetic::MODULO_ARITHMETIC,\n         multiple_crate_versions::MULTIPLE_CRATE_VERSIONS,\n@@ -1017,6 +1019,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(misc::FLOAT_CMP_CONST),\n         LintId::of(misc_early::UNNEEDED_FIELD_PATTERN),\n         LintId::of(missing_doc::MISSING_DOCS_IN_PRIVATE_ITEMS),\n+        LintId::of(missing_enforced_import_rename::MISSING_ENFORCED_IMPORT_RENAMES),\n         LintId::of(missing_inline::MISSING_INLINE_IN_PUBLIC_ITEMS),\n         LintId::of(modulo_arithmetic::MODULO_ARITHMETIC),\n         LintId::of(panic_in_result_fn::PANIC_IN_RESULT_FN),\n@@ -2077,6 +2080,8 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(|| box unused_async::UnusedAsync);\n     let disallowed_types = conf.disallowed_types.iter().cloned().collect::<FxHashSet<_>>();\n     store.register_late_pass(move || box disallowed_type::DisallowedType::new(&disallowed_types));\n+    let import_renames = conf.enforced_import_renames.clone();\n+    store.register_late_pass(move || box missing_enforced_import_rename::ImportRename::new(import_renames.clone()));\n \n }\n "}, {"sha": "59565350f72966260ad0913d0c208e8b498acb4b", "filename": "clippy_lints/src/missing_enforced_import_rename.rs", "status": "added", "additions": 102, "deletions": 0, "changes": 102, "blob_url": "https://github.com/rust-lang/rust/blob/9492de584319c0331619991e5b201ea6e00b9b2f/clippy_lints%2Fsrc%2Fmissing_enforced_import_rename.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9492de584319c0331619991e5b201ea6e00b9b2f/clippy_lints%2Fsrc%2Fmissing_enforced_import_rename.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmissing_enforced_import_rename.rs?ref=9492de584319c0331619991e5b201ea6e00b9b2f", "patch": "@@ -0,0 +1,102 @@\n+use clippy_utils::{diagnostics::span_lint_and_sugg, source::snippet_opt};\n+\n+use rustc_data_structures::fx::FxHashMap;\n+use rustc_errors::Applicability;\n+use rustc_hir::{def::Res, def_id::DefId, Crate, Item, ItemKind, UseKind};\n+use rustc_lint::{LateContext, LateLintPass, LintContext};\n+use rustc_session::{declare_tool_lint, impl_lint_pass};\n+use rustc_span::Symbol;\n+\n+use crate::utils::conf::Rename;\n+\n+declare_clippy_lint! {\n+    /// **What it does:** Checks for imports that do not rename the item as specified\n+    /// in the `enforce-import-renames` config option.\n+    ///\n+    /// **Why is this bad?** Consistency is important, if a project has defined import\n+    /// renames they should be followed. More practically, some item names are too\n+    /// vague outside of their defining scope this can enforce a more meaningful naming.\n+    ///\n+    /// **Known problems:** None\n+    ///\n+    /// **Example:**\n+    ///\n+    /// An example clippy.toml configuration:\n+    /// ```toml\n+    /// # clippy.toml\n+    /// enforced-import-renames = [ { path = \"serde_json::Value\", rename = \"JsonValue\" }]\n+    /// ```\n+    ///\n+    /// ```rust,ignore\n+    /// use serde_json::Value;\n+    /// ```\n+    /// Use instead:\n+    /// ```rust,ignore\n+    /// use serde_json::Value as JsonValue;\n+    /// ```\n+    pub MISSING_ENFORCED_IMPORT_RENAMES,\n+    restriction,\n+    \"enforce import renames\"\n+}\n+\n+pub struct ImportRename {\n+    conf_renames: Vec<Rename>,\n+    renames: FxHashMap<DefId, Symbol>,\n+}\n+\n+impl ImportRename {\n+    pub fn new(conf_renames: Vec<Rename>) -> Self {\n+        Self {\n+            conf_renames,\n+            renames: FxHashMap::default(),\n+        }\n+    }\n+}\n+\n+impl_lint_pass!(ImportRename => [MISSING_ENFORCED_IMPORT_RENAMES]);\n+\n+impl LateLintPass<'_> for ImportRename {\n+    fn check_crate(&mut self, cx: &LateContext<'_>, _: &Crate<'_>) {\n+        for Rename { path, rename } in &self.conf_renames {\n+            if let Res::Def(_, id) = clippy_utils::path_to_res(cx, &path.split(\"::\").collect::<Vec<_>>()) {\n+                self.renames.insert(id, Symbol::intern(rename));\n+            }\n+        }\n+    }\n+\n+    fn check_item(&mut self, cx: &LateContext<'_>, item: &Item<'_>) {\n+        if_chain! {\n+            if let ItemKind::Use(path, UseKind::Single) = &item.kind;\n+            if let Res::Def(_, id) = path.res;\n+            if let Some(name) = self.renames.get(&id);\n+            // Remove semicolon since it is not present for nested imports\n+            let span_without_semi = cx.sess().source_map().span_until_char(item.span, ';');\n+            if let Some(snip) = snippet_opt(cx, span_without_semi);\n+            if let Some(import) = match snip.split_once(\" as \") {\n+                None => Some(snip.as_str()),\n+                Some((import, rename)) => {\n+                    if rename.trim() == &*name.as_str() {\n+                        None\n+                    } else {\n+                        Some(import.trim())\n+                    }\n+                },\n+            };\n+            then {\n+                span_lint_and_sugg(\n+                    cx,\n+                    MISSING_ENFORCED_IMPORT_RENAMES,\n+                    span_without_semi,\n+                    \"this import should be renamed\",\n+                    \"try\",\n+                    format!(\n+                        \"{} as {}\",\n+                        import,\n+                        name,\n+                    ),\n+                    Applicability::MachineApplicable,\n+                );\n+            }\n+        }\n+    }\n+}"}, {"sha": "6fc4998318ccf14324deb092bb1f4405c34ece33", "filename": "clippy_lints/src/utils/conf.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/9492de584319c0331619991e5b201ea6e00b9b2f/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9492de584319c0331619991e5b201ea6e00b9b2f/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fconf.rs?ref=9492de584319c0331619991e5b201ea6e00b9b2f", "patch": "@@ -8,6 +8,13 @@ use std::error::Error;\n use std::path::{Path, PathBuf};\n use std::{env, fmt, fs, io};\n \n+/// Holds information used by `MISSING_ENFORCED_IMPORT_RENAMES` lint.\n+#[derive(Clone, Debug, Deserialize)]\n+pub struct Rename {\n+    pub path: String,\n+    pub rename: String,\n+}\n+\n /// Conf with parse errors\n #[derive(Default)]\n pub struct TryConf {\n@@ -203,6 +210,8 @@ define_Conf! {\n     (cargo_ignore_publish: bool = false),\n     /// Lint: NONSTANDARD_MACRO_BRACES. Enforce the named macros always use the braces specified. <br> A `MacroMatcher` can be added like so `{ name = \"macro_name\", brace = \"(\" }`. If the macro is could be used with a full path two `MacroMatcher`s have to be added one with the full path `crate_name::macro_name` and one with just the macro name.\n     (standard_macro_braces: Vec<crate::nonstandard_macro_braces::MacroMatcher> = Vec::new()),\n+    /// Lint: MISSING_ENFORCED_IMPORT_RENAMES. The list of imports to always rename, a fully qualified path followed by the rename.\n+    (enforced_import_renames: Vec<crate::utils::conf::Rename> = Vec::new()),\n }\n \n /// Search for the configuration file."}, {"sha": "05ba822874d596f86c1acff77e0a9a285bb49d44", "filename": "tests/ui-toml/missing_enforced_import_rename/clippy.toml", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/9492de584319c0331619991e5b201ea6e00b9b2f/tests%2Fui-toml%2Fmissing_enforced_import_rename%2Fclippy.toml", "raw_url": "https://github.com/rust-lang/rust/raw/9492de584319c0331619991e5b201ea6e00b9b2f/tests%2Fui-toml%2Fmissing_enforced_import_rename%2Fclippy.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-toml%2Fmissing_enforced_import_rename%2Fclippy.toml?ref=9492de584319c0331619991e5b201ea6e00b9b2f", "patch": "@@ -0,0 +1,10 @@\n+enforced-import-renames = [\n+    { path = \"std::option::Option\", rename = \"Maybe\" },\n+    { path = \"std::process::Child\", rename = \"Kid\" },\n+    { path = \"std::process::exit\", rename = \"goodbye\" },\n+    { path = \"std::collections::BTreeMap\", rename = \"Map\" },\n+    { path = \"std::clone\", rename = \"foo\" },\n+    { path = \"std::thread::sleep\", rename = \"thread_sleep\" },\n+    { path = \"std::any::type_name\", rename = \"ident\" },\n+    { path = \"std::sync::Mutex\", rename = \"StdMutie\" }\n+]"}, {"sha": "f60058c862888670b741b9229c8ff6d3ce549f38", "filename": "tests/ui-toml/missing_enforced_import_rename/conf_missing_enforced_import_rename.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/9492de584319c0331619991e5b201ea6e00b9b2f/tests%2Fui-toml%2Fmissing_enforced_import_rename%2Fconf_missing_enforced_import_rename.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9492de584319c0331619991e5b201ea6e00b9b2f/tests%2Fui-toml%2Fmissing_enforced_import_rename%2Fconf_missing_enforced_import_rename.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-toml%2Fmissing_enforced_import_rename%2Fconf_missing_enforced_import_rename.rs?ref=9492de584319c0331619991e5b201ea6e00b9b2f", "patch": "@@ -0,0 +1,16 @@\n+#![warn(clippy::missing_enforced_import_renames)]\n+\n+use std::alloc as colla;\n+use std::option::Option as Maybe;\n+use std::process::{exit as wrong_exit, Child as Kid};\n+use std::thread::sleep;\n+#[rustfmt::skip]\n+use std::{\n+    any::{type_name, Any},\n+    clone,\n+    sync :: Mutex,\n+};\n+\n+fn main() {\n+    use std::collections::BTreeMap as OopsWrongRename;\n+}"}, {"sha": "45de8fdffef76d3e22687d9becc41b61d0a9590e", "filename": "tests/ui-toml/missing_enforced_import_rename/conf_missing_enforced_import_rename.stderr", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/9492de584319c0331619991e5b201ea6e00b9b2f/tests%2Fui-toml%2Fmissing_enforced_import_rename%2Fconf_missing_enforced_import_rename.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9492de584319c0331619991e5b201ea6e00b9b2f/tests%2Fui-toml%2Fmissing_enforced_import_rename%2Fconf_missing_enforced_import_rename.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-toml%2Fmissing_enforced_import_rename%2Fconf_missing_enforced_import_rename.stderr?ref=9492de584319c0331619991e5b201ea6e00b9b2f", "patch": "@@ -0,0 +1,40 @@\n+error: this import should be renamed\n+  --> $DIR/conf_missing_enforced_import_rename.rs:5:20\n+   |\n+LL | use std::process::{exit as wrong_exit, Child as Kid};\n+   |                    ^^^^^^^^^^^^^^^^^^ help: try: `exit as goodbye`\n+   |\n+   = note: `-D clippy::missing-enforced-import-renames` implied by `-D warnings`\n+\n+error: this import should be renamed\n+  --> $DIR/conf_missing_enforced_import_rename.rs:6:1\n+   |\n+LL | use std::thread::sleep;\n+   | ^^^^^^^^^^^^^^^^^^^^^^ help: try: `use std::thread::sleep as thread_sleep`\n+\n+error: this import should be renamed\n+  --> $DIR/conf_missing_enforced_import_rename.rs:9:11\n+   |\n+LL |     any::{type_name, Any},\n+   |           ^^^^^^^^^ help: try: `type_name as ident`\n+\n+error: this import should be renamed\n+  --> $DIR/conf_missing_enforced_import_rename.rs:10:5\n+   |\n+LL |     clone,\n+   |     ^^^^^ help: try: `clone as foo`\n+\n+error: this import should be renamed\n+  --> $DIR/conf_missing_enforced_import_rename.rs:11:5\n+   |\n+LL |     sync :: Mutex,\n+   |     ^^^^^^^^^^^^^ help: try: `sync :: Mutex as StdMutie`\n+\n+error: this import should be renamed\n+  --> $DIR/conf_missing_enforced_import_rename.rs:15:5\n+   |\n+LL |     use std::collections::BTreeMap as OopsWrongRename;\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try: `use std::collections::BTreeMap as Map`\n+\n+error: aborting due to 6 previous errors\n+"}, {"sha": "aa7bfa2cc8cdac29268028afbd7e3ba7cfba7067", "filename": "tests/ui-toml/toml_unknown_key/conf_unknown_key.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9492de584319c0331619991e5b201ea6e00b9b2f/tests%2Fui-toml%2Ftoml_unknown_key%2Fconf_unknown_key.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9492de584319c0331619991e5b201ea6e00b9b2f/tests%2Fui-toml%2Ftoml_unknown_key%2Fconf_unknown_key.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-toml%2Ftoml_unknown_key%2Fconf_unknown_key.stderr?ref=9492de584319c0331619991e5b201ea6e00b9b2f", "patch": "@@ -1,4 +1,4 @@\n-error: error reading Clippy's configuration file `$DIR/clippy.toml`: unknown field `foobar`, expected one of `avoid-breaking-exported-api`, `msrv`, `blacklisted-names`, `cognitive-complexity-threshold`, `cyclomatic-complexity-threshold`, `doc-valid-idents`, `too-many-arguments-threshold`, `type-complexity-threshold`, `single-char-binding-names-threshold`, `too-large-for-stack`, `enum-variant-name-threshold`, `enum-variant-size-threshold`, `verbose-bit-mask-threshold`, `literal-representation-threshold`, `trivial-copy-size-limit`, `pass-by-value-size-limit`, `too-many-lines-threshold`, `array-size-threshold`, `vec-box-size-threshold`, `max-trait-bounds`, `max-struct-bools`, `max-fn-params-bools`, `warn-on-all-wildcard-imports`, `disallowed-methods`, `disallowed-types`, `unreadable-literal-lint-fractions`, `upper-case-acronyms-aggressive`, `cargo-ignore-publish`, `standard-macro-braces`, `third-party` at line 5 column 1\n+error: error reading Clippy's configuration file `$DIR/clippy.toml`: unknown field `foobar`, expected one of `avoid-breaking-exported-api`, `msrv`, `blacklisted-names`, `cognitive-complexity-threshold`, `cyclomatic-complexity-threshold`, `doc-valid-idents`, `too-many-arguments-threshold`, `type-complexity-threshold`, `single-char-binding-names-threshold`, `too-large-for-stack`, `enum-variant-name-threshold`, `enum-variant-size-threshold`, `verbose-bit-mask-threshold`, `literal-representation-threshold`, `trivial-copy-size-limit`, `pass-by-value-size-limit`, `too-many-lines-threshold`, `array-size-threshold`, `vec-box-size-threshold`, `max-trait-bounds`, `max-struct-bools`, `max-fn-params-bools`, `warn-on-all-wildcard-imports`, `disallowed-methods`, `disallowed-types`, `unreadable-literal-lint-fractions`, `upper-case-acronyms-aggressive`, `cargo-ignore-publish`, `standard-macro-braces`, `enforced-import-renames`, `third-party` at line 5 column 1\n \n error: aborting due to previous error\n "}]}