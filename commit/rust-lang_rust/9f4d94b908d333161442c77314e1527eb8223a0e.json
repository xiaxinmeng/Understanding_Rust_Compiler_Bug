{"sha": "9f4d94b908d333161442c77314e1527eb8223a0e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlmNGQ5NGI5MDhkMzMzMTYxNDQyYzc3MzE0ZTE1MjdlYjgyMjNhMGU=", "commit": {"author": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-05-31T08:35:57Z"}, "committer": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-06-06T12:31:54Z"}, "message": "[const-prop] Handle Rvalue::Ref", "tree": {"sha": "59b3ef5bcf5c686735070ee1577c274bfff07dea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/59b3ef5bcf5c686735070ee1577c274bfff07dea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9f4d94b908d333161442c77314e1527eb8223a0e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9f4d94b908d333161442c77314e1527eb8223a0e", "html_url": "https://github.com/rust-lang/rust/commit/9f4d94b908d333161442c77314e1527eb8223a0e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9f4d94b908d333161442c77314e1527eb8223a0e/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71", "url": "https://api.github.com/repos/rust-lang/rust/commits/529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71", "html_url": "https://github.com/rust-lang/rust/commit/529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71"}], "stats": {"total": 23, "additions": 22, "deletions": 1}, "files": [{"sha": "a3297666113d4aabd4245b130e63f63c452a4f80", "filename": "src/librustc_mir/interpret/place.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/9f4d94b908d333161442c77314e1527eb8223a0e/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f4d94b908d333161442c77314e1527eb8223a0e/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fplace.rs?ref=9f4d94b908d333161442c77314e1527eb8223a0e", "patch": "@@ -663,6 +663,23 @@ where\n         Ok(())\n     }\n \n+    /// Write an `Immediate` to memory.\n+    #[inline(always)]\n+    pub fn write_immediate_to_mplace(\n+        &mut self,\n+        src: Immediate<M::PointerTag>,\n+        dest: MPlaceTy<'tcx, M::PointerTag>,\n+    ) -> EvalResult<'tcx> {\n+        self.write_immediate_to_mplace_no_validate(src, dest)?;\n+\n+        if M::enforce_validity(self) {\n+            // Data got changed, better make sure it matches the type!\n+            self.validate_operand(dest.into(), vec![], None, /*const_mode*/ false)?;\n+        }\n+\n+        Ok(())\n+    }\n+\n     /// Write an immediate to a place.\n     /// If you use this you are responsible for validating that things got copied at the\n     /// right type."}, {"sha": "8e7093b833d441e3f678005b2e079a0ddd769593", "filename": "src/librustc_mir/transform/const_prop.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9f4d94b908d333161442c77314e1527eb8223a0e/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f4d94b908d333161442c77314e1527eb8223a0e/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs?ref=9f4d94b908d333161442c77314e1527eb8223a0e", "patch": "@@ -363,8 +363,12 @@ impl<'a, 'mir, 'tcx> ConstPropagator<'a, 'mir, 'tcx> {\n             Rvalue::Use(ref op) => {\n                 self.eval_operand(op, source_info)\n             },\n+            Rvalue::Ref(_, _, ref place) => {\n+                let src = self.eval_place(place, source_info)?;\n+                let mplace = src.try_as_mplace().ok()?;\n+                Some(ImmTy::from_scalar(mplace.ptr.into(), place_layout).into())\n+            },\n             Rvalue::Repeat(..) |\n-            Rvalue::Ref(..) |\n             Rvalue::Aggregate(..) |\n             Rvalue::NullaryOp(NullOp::Box, _) |\n             Rvalue::Discriminant(..) => None,"}]}