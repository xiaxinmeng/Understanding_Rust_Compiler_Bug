{"sha": "cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "node_id": "C_kwDOAAsO6NoAKGNjOGRkZGJhYzllMDRmMTI1YzdlODFkYmU5ZmI2YTAxOTkwZThiMjU", "commit": {"author": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2022-10-23T22:32:40Z"}, "committer": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2022-11-21T01:04:11Z"}, "message": "Factor out conservative_is_privately_uninhabited", "tree": {"sha": "d3e9773b74566031a5d1baff33bba3e8906e38be", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d3e9773b74566031a5d1baff33bba3e8906e38be"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "html_url": "https://github.com/rust-lang/rust/commit/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/comments", "author": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "34cbe727806429a8a034f492cff1b588e70c33dc", "url": "https://api.github.com/repos/rust-lang/rust/commits/34cbe727806429a8a034f492cff1b588e70c33dc", "html_url": "https://github.com/rust-lang/rust/commit/34cbe727806429a8a034f492cff1b588e70c33dc"}], "stats": {"total": 106, "additions": 25, "deletions": 81}, "files": [{"sha": "9b6c7d27c791b23923b3fd3c47a0cb779f2062bf", "filename": "compiler/rustc_borrowck/src/type_check/mod.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs?ref=cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "patch": "@@ -1564,10 +1564,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n                 }\n             }\n             None => {\n-                if !self\n-                    .tcx()\n-                    .conservative_is_privately_uninhabited(self.param_env.and(sig.output()))\n-                {\n+                if !sig.output().is_privately_uninhabited(self.tcx(), self.param_env) {\n                     span_mirbug!(self, term, \"call to converging function {:?} w/o dest\", sig);\n                 }\n             }"}, {"sha": "21097b1fec6dea198c9aaa12709116d4c10733ad", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 0, "deletions": 11, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "patch": "@@ -2078,17 +2078,6 @@ rustc_queries! {\n         desc { \"normalizing opaque types in `{:?}`\", key }\n     }\n \n-    /// Checks whether a type is definitely uninhabited. This is\n-    /// conservative: for some types that are uninhabited we return `false`,\n-    /// but we only return `true` for types that are definitely uninhabited.\n-    /// `ty.conservative_is_privately_uninhabited` implies that any value of type `ty`\n-    /// will be `Abi::Uninhabited`. (Note that uninhabited types may have nonzero\n-    /// size, to account for partial initialisation. See #49298 for details.)\n-    query conservative_is_privately_uninhabited(key: ty::ParamEnvAnd<'tcx, Ty<'tcx>>) -> bool {\n-        desc { \"conservatively checking if `{}` is privately uninhabited\", key.value }\n-        remap_env_constness\n-    }\n-\n     query limits(key: ()) -> Limits {\n         desc { \"looking up limits\" }\n     }"}, {"sha": "33f72729798dca93e38753e6332892c5cf835cf9", "filename": "compiler/rustc_middle/src/ty/inhabitedness/inhabited_predicate.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_middle%2Fsrc%2Fty%2Finhabitedness%2Finhabited_predicate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_middle%2Fsrc%2Fty%2Finhabitedness%2Finhabited_predicate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Finhabitedness%2Finhabited_predicate.rs?ref=cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "patch": "@@ -41,6 +41,13 @@ impl<'tcx> InhabitedPredicate<'tcx> {\n         self.apply_inner(tcx, param_env, &|_| Err(())).ok()\n     }\n \n+    /// Same as `apply`, but `NotInModule(_)` predicates yield `false`. That is,\n+    /// privately uninhabited types are considered always uninhabited.\n+    pub fn apply_ignore_module(self, tcx: TyCtxt<'tcx>, param_env: ParamEnv<'tcx>) -> bool {\n+        let Ok(result) = self.apply_inner::<!>(tcx, param_env, &|_| Ok(true));\n+        result\n+    }\n+\n     fn apply_inner<E>(\n         self,\n         tcx: TyCtxt<'tcx>,"}, {"sha": "ace81bc4f8352e155330d5178968f369eed30054", "filename": "compiler/rustc_middle/src/ty/inhabitedness/mod.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_middle%2Fsrc%2Fty%2Finhabitedness%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_middle%2Fsrc%2Fty%2Finhabitedness%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Finhabitedness%2Fmod.rs?ref=cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "patch": "@@ -169,6 +169,15 @@ impl<'tcx> Ty<'tcx> {\n     ) -> bool {\n         self.inhabited_predicate(tcx).apply(tcx, param_env, module)\n     }\n+\n+    /// Returns true if the type is uninhabited without regard to visibility\n+    pub fn is_privately_uninhabited(\n+        self,\n+        tcx: TyCtxt<'tcx>,\n+        param_env: ty::ParamEnv<'tcx>,\n+    ) -> bool {\n+        !self.inhabited_predicate(tcx).apply_ignore_module(tcx, param_env)\n+    }\n }\n \n /// N.B. this query should only be called through `Ty::inhabited_predicate`"}, {"sha": "caf27eb39d7d4b1d3303fdca934c3c891cf894b1", "filename": "compiler/rustc_mir_build/src/build/matches/simplify.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmatches%2Fsimplify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmatches%2Fsimplify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmatches%2Fsimplify.rs?ref=cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "patch": "@@ -264,10 +264,10 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                 let irrefutable = adt_def.variants().iter_enumerated().all(|(i, v)| {\n                     i == variant_index || {\n                         self.tcx.features().exhaustive_patterns\n-                            && v.inhabited_predicate(self.tcx, adt_def)\n+                            && !v\n+                                .inhabited_predicate(self.tcx, adt_def)\n                                 .subst(self.tcx, substs)\n-                                .apply_any_module(self.tcx, self.param_env)\n-                                != Some(true)\n+                                .apply_ignore_module(self.tcx, self.param_env)\n                     }\n                 }) && (adt_def.did().is_local()\n                     || !adt_def.is_variant_list_non_exhaustive());"}, {"sha": "fcd63b6cfa17843bdb91f87b838d5c5c1eefadf4", "filename": "compiler/rustc_mir_transform/src/generator.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs?ref=cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "patch": "@@ -1015,7 +1015,7 @@ fn insert_panic_block<'tcx>(\n \n fn can_return<'tcx>(tcx: TyCtxt<'tcx>, body: &Body<'tcx>, param_env: ty::ParamEnv<'tcx>) -> bool {\n     // Returning from a function with an uninhabited return type is undefined behavior.\n-    if tcx.conservative_is_privately_uninhabited(param_env.and(body.return_ty())) {\n+    if body.return_ty().is_privately_uninhabited(tcx, param_env) {\n         return false;\n     }\n "}, {"sha": "92e8542795faea78ae7790c5cca6ed3fa89decb1", "filename": "compiler/rustc_ty_utils/src/layout.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_ty_utils%2Fsrc%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_ty_utils%2Fsrc%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Flayout.rs?ref=cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "patch": "@@ -442,8 +442,7 @@ fn layout_of_uncached<'tcx>(\n             let element = cx.layout_of(element)?;\n             let size = element.size.checked_mul(count, dl).ok_or(LayoutError::SizeOverflow(ty))?;\n \n-            let abi = if count != 0 && tcx.conservative_is_privately_uninhabited(param_env.and(ty))\n-            {\n+            let abi = if count != 0 && ty.is_privately_uninhabited(tcx, param_env) {\n                 Abi::Uninhabited\n             } else {\n                 Abi::Aggregate { sized: true }"}, {"sha": "ee5e7bc235974a3097e13a1267c4ad846c1e013d", "filename": "compiler/rustc_ty_utils/src/layout_sanity_check.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_ty_utils%2Fsrc%2Flayout_sanity_check.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_ty_utils%2Fsrc%2Flayout_sanity_check.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Flayout_sanity_check.rs?ref=cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "patch": "@@ -12,7 +12,7 @@ pub(super) fn sanity_check_layout<'tcx>(\n     layout: &TyAndLayout<'tcx>,\n ) {\n     // Type-level uninhabitedness should always imply ABI uninhabitedness.\n-    if cx.tcx.conservative_is_privately_uninhabited(cx.param_env.and(layout.ty)) {\n+    if layout.ty.is_privately_uninhabited(cx.tcx, cx.param_env) {\n         assert!(layout.abi.is_uninhabited());\n     }\n "}, {"sha": "c60ade360dfb194cd5b2777b9b6f02c66191fe91", "filename": "compiler/rustc_ty_utils/src/ty.rs", "status": "modified", "additions": 0, "deletions": 57, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_ty_utils%2Fsrc%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/compiler%2Frustc_ty_utils%2Fsrc%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Fty.rs?ref=cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "patch": "@@ -416,62 +416,6 @@ fn asyncness(tcx: TyCtxt<'_>, def_id: DefId) -> hir::IsAsync {\n     node.fn_sig().map_or(hir::IsAsync::NotAsync, |sig| sig.header.asyncness)\n }\n \n-/// Don't call this directly: use ``tcx.conservative_is_privately_uninhabited`` instead.\n-pub fn conservative_is_privately_uninhabited_raw<'tcx>(\n-    tcx: TyCtxt<'tcx>,\n-    param_env_and: ty::ParamEnvAnd<'tcx, Ty<'tcx>>,\n-) -> bool {\n-    let (param_env, ty) = param_env_and.into_parts();\n-    match ty.kind() {\n-        ty::Never => {\n-            debug!(\"ty::Never =>\");\n-            true\n-        }\n-        ty::Adt(def, _) if def.is_union() => {\n-            debug!(\"ty::Adt(def, _) if def.is_union() =>\");\n-            // For now, `union`s are never considered uninhabited.\n-            false\n-        }\n-        ty::Adt(def, substs) => {\n-            debug!(\"ty::Adt(def, _) if def.is_not_union() =>\");\n-            // Any ADT is uninhabited if either:\n-            // (a) It has no variants (i.e. an empty `enum`);\n-            // (b) Each of its variants (a single one in the case of a `struct`) has at least\n-            //     one uninhabited field.\n-            def.variants().iter().all(|var| {\n-                var.fields.iter().any(|field| {\n-                    let ty = tcx.bound_type_of(field.did).subst(tcx, substs);\n-                    tcx.conservative_is_privately_uninhabited(param_env.and(ty))\n-                })\n-            })\n-        }\n-        ty::Tuple(fields) => {\n-            debug!(\"ty::Tuple(..) =>\");\n-            fields.iter().any(|ty| tcx.conservative_is_privately_uninhabited(param_env.and(ty)))\n-        }\n-        ty::Array(ty, len) => {\n-            debug!(\"ty::Array(ty, len) =>\");\n-            match len.try_eval_usize(tcx, param_env) {\n-                Some(0) | None => false,\n-                // If the array is definitely non-empty, it's uninhabited if\n-                // the type of its elements is uninhabited.\n-                Some(1..) => tcx.conservative_is_privately_uninhabited(param_env.and(*ty)),\n-            }\n-        }\n-        ty::Ref(..) => {\n-            debug!(\"ty::Ref(..) =>\");\n-            // References to uninitialised memory is valid for any type, including\n-            // uninhabited types, in unsafe code, so we treat all references as\n-            // inhabited.\n-            false\n-        }\n-        _ => {\n-            debug!(\"_ =>\");\n-            false\n-        }\n-    }\n-}\n-\n pub fn provide(providers: &mut ty::query::Providers) {\n     *providers = ty::query::Providers {\n         asyncness,\n@@ -481,7 +425,6 @@ pub fn provide(providers: &mut ty::query::Providers) {\n         instance_def_size_estimate,\n         issue33140_self_ty,\n         impl_defaultness,\n-        conservative_is_privately_uninhabited: conservative_is_privately_uninhabited_raw,\n         ..*providers\n     };\n }"}, {"sha": "b385406b0202ffd97359814ccea4f1f75cd089cc", "filename": "src/test/ui/const-generics/inhabited-assoc-ty-ice-1.rs", "status": "renamed", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/src%2Ftest%2Fui%2Fconst-generics%2Finhabited-assoc-ty-ice-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/src%2Ftest%2Fui%2Fconst-generics%2Finhabited-assoc-ty-ice-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Finhabited-assoc-ty-ice-1.rs?ref=cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "patch": "@@ -2,7 +2,7 @@\n #![feature(generic_const_exprs)]\n #![allow(incomplete_features)]\n \n-// This tests that the `conservative_is_privately_uninhabited` fn doesn't cause\n+// This tests that the inhabited check doesn't cause\n // ICEs by trying to evaluate `T::ASSOC` with an incorrect `ParamEnv`.\n \n trait Foo {", "previous_filename": "src/test/ui/const-generics/conservative_is_privately_uninhabited_uses_correct_param_env-1.rs"}, {"sha": "216d29c7cd4d0ad687b20663599677db6271ab25", "filename": "src/test/ui/const-generics/inhabited-assoc-ty-ice-2.rs", "status": "renamed", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/src%2Ftest%2Fui%2Fconst-generics%2Finhabited-assoc-ty-ice-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25/src%2Ftest%2Fui%2Fconst-generics%2Finhabited-assoc-ty-ice-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Finhabited-assoc-ty-ice-2.rs?ref=cc8dddbac9e04f125c7e81dbe9fb6a01990e8b25", "patch": "@@ -2,7 +2,7 @@\n #![feature(generic_const_exprs)]\n #![allow(incomplete_features)]\n \n-// This tests that the `conservative_is_privately_uninhabited` fn doesn't cause\n+// This tests that the inhabited check doesn't cause\n // ICEs by trying to evaluate `T::ASSOC` with an incorrect `ParamEnv`.\n \n trait Foo {", "previous_filename": "src/test/ui/const-generics/conservative_is_privately_uninhabited_uses_correct_param_env-2.rs"}]}