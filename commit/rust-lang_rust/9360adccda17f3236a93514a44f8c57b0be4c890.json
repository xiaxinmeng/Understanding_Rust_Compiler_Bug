{"sha": "9360adccda17f3236a93514a44f8c57b0be4c890", "node_id": "C_kwDOAAsO6NoAKDkzNjBhZGNjZGExN2YzMjM2YTkzNTE0YTQ0ZjhjNTdiMGJlNGM4OTA", "commit": {"author": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2023-05-06T16:31:36Z"}, "committer": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2023-05-06T16:31:36Z"}, "message": "Ignore impls with `#[rustc_reservation_impl]`", "tree": {"sha": "f66acb1c012382757b2f57d2c810a34de3b13719", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f66acb1c012382757b2f57d2c810a34de3b13719"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9360adccda17f3236a93514a44f8c57b0be4c890", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEkSbsQIURluxz4rzf4laYqTBYYXEFAmRWgOgACgkQ4laYqTBY\nYXGqVhAAjniDOq3eMUR38WTfy745yd8TabVIt7nT8NHRC912T1ztzMKy6U8jAAZF\ni3W+4ceua5AEIyDBhKOvrzGKs7imNjuGyoTpWdnNgC5aBtcnTfZzV/In30++KTD6\nGcPgTRBvHLI8qg00wlaZ0H3mTYF6BHgZImvxhcYd16qtbQ5BDgBp7FxBc+h6WaVD\nXAfdQY9txY674gxPL9Ss+H/HsbonzA6eKQj3QhvqswX6gGKTGQnF0gxeAIwEl0Uz\non5lF9McMvV0bOmpi3+lgNtLpPee9VcNjOhEsvGyHo+k6k7t9CPv+E9Cugf3cIXA\niUb7mlvdgCJ2aimPOy8v4rFZL+JYrpnFEq+yWdOIIABVe1X1iI8DGiv4dPRXxunM\nM+pOeg2wABqnDeJtf8586Bc/yNADLfXHOnbVnCIgYmHV5/l+qr2eM2SR5O7sl4XA\ncOCaZkJB4cnP0GFpTtwq6zSN1LplKzG5Hsgvefkq8PQw4kD0NAdj6BoybCjK2tTm\n05J5bWp+22o5JKhFRtgYUbmihhR9hucvbT96TQDRMOlH2/aj1/RTpuGUt4lg5PhB\nWGMYH8fMuZU0NRk6Bl9UNJ2eAoaCs10gnBGbzicqlwnMZwMYukc+aZzLCW1IKjNM\nRiDooEY6JOSBhr6IfMTcyFtdR1mph65JHHWdZ/Amr866G2aH60Y=\n=A1RD\n-----END PGP SIGNATURE-----", "payload": "tree f66acb1c012382757b2f57d2c810a34de3b13719\nparent a4966c92829f945d3846eb0ca0e240ac7f7c8c60\nauthor Ryo Yoshida <low.ryoshida@gmail.com> 1683390696 +0900\ncommitter Ryo Yoshida <low.ryoshida@gmail.com> 1683390696 +0900\n\nIgnore impls with `#[rustc_reservation_impl]`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9360adccda17f3236a93514a44f8c57b0be4c890", "html_url": "https://github.com/rust-lang/rust/commit/9360adccda17f3236a93514a44f8c57b0be4c890", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9360adccda17f3236a93514a44f8c57b0be4c890/comments", "author": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a4966c92829f945d3846eb0ca0e240ac7f7c8c60", "url": "https://api.github.com/repos/rust-lang/rust/commits/a4966c92829f945d3846eb0ca0e240ac7f7c8c60", "html_url": "https://github.com/rust-lang/rust/commit/a4966c92829f945d3846eb0ca0e240ac7f7c8c60"}], "stats": {"total": 30, "additions": 29, "deletions": 1}, "files": [{"sha": "983cc22212421c0aba234243c61a38c3baf1c7a7", "filename": "crates/hir-ty/src/chalk_db.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9360adccda17f3236a93514a44f8c57b0be4c890/crates%2Fhir-ty%2Fsrc%2Fchalk_db.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9360adccda17f3236a93514a44f8c57b0be4c890/crates%2Fhir-ty%2Fsrc%2Fchalk_db.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Fchalk_db.rs?ref=9360adccda17f3236a93514a44f8c57b0be4c890", "patch": "@@ -453,7 +453,7 @@ impl<'a> chalk_solve::RustIrDatabase<Interner> for ChalkContext<'a> {\n     }\n }\n \n-impl<'a> chalk_ir::UnificationDatabase<Interner> for &'a dyn HirDatabase {\n+impl chalk_ir::UnificationDatabase<Interner> for &dyn HirDatabase {\n     fn fn_def_variance(\n         &self,\n         fn_def_id: chalk_ir::FnDefId<Interner>,"}, {"sha": "8d57211db0778f198e9dd6ea2fe70790cda8b0b6", "filename": "crates/hir-ty/src/method_resolution.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/9360adccda17f3236a93514a44f8c57b0be4c890/crates%2Fhir-ty%2Fsrc%2Fmethod_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9360adccda17f3236a93514a44f8c57b0be4c890/crates%2Fhir-ty%2Fsrc%2Fmethod_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Fmethod_resolution.rs?ref=9360adccda17f3236a93514a44f8c57b0be4c890", "patch": "@@ -187,6 +187,15 @@ impl TraitImpls {\n     fn collect_def_map(&mut self, db: &dyn HirDatabase, def_map: &DefMap) {\n         for (_module_id, module_data) in def_map.modules() {\n             for impl_id in module_data.scope.impls() {\n+                // Reservation impls should be ignored during trait resolution, so we never need\n+                // them during type analysis. See rust-lang/rust#64631 for details.\n+                //\n+                // FIXME: Reservation impls should be considered during coherence checks. If we are\n+                // (ever) to implement coherence checks, this filtering should be done by the trait\n+                // solver.\n+                if db.attrs(impl_id.into()).by_key(\"rustc_reservation_impl\").exists() {\n+                    continue;\n+                }\n                 let target_trait = match db.impl_trait(impl_id) {\n                     Some(tr) => tr.skip_binders().hir_trait_id(),\n                     None => continue,"}, {"sha": "09c63f873ee6259b63f0f3342614e81f39325a9f", "filename": "crates/hir-ty/src/tests/never_type.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/9360adccda17f3236a93514a44f8c57b0be4c890/crates%2Fhir-ty%2Fsrc%2Ftests%2Fnever_type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9360adccda17f3236a93514a44f8c57b0be4c890/crates%2Fhir-ty%2Fsrc%2Ftests%2Fnever_type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Ftests%2Fnever_type.rs?ref=9360adccda17f3236a93514a44f8c57b0be4c890", "patch": "@@ -483,3 +483,22 @@ fn example() -> bool {\n \"#,\n     );\n }\n+\n+#[test]\n+fn reservation_impl_should_be_ignored() {\n+    // See rust-lang/rust#64631.\n+    check_types(\n+        r#\"\n+//- minicore: from\n+struct S;\n+#[rustc_reservation_impl]\n+impl<T> From<!> for T {}\n+fn foo<T, U: From<T>>(_: U) -> T { loop {} }\n+\n+fn test() {\n+    let s = foo(S);\n+      //^ S\n+}\n+\"#,\n+    );\n+}"}]}