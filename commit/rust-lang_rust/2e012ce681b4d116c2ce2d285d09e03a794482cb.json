{"sha": "2e012ce681b4d116c2ce2d285d09e03a794482cb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJlMDEyY2U2ODFiNGQxMTZjMmNlMmQyODVkMDllMDNhNzk0NDgyY2I=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-24T12:02:13Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-24T12:02:13Z"}, "message": "Auto merge of #83050 - osa1:issue83048, r=matthewjasper\n\nRun analyses before thir-tree dumps\n\nFixes #83048", "tree": {"sha": "41f333b1d22ff9d329d53d6ea38830b065bd7867", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/41f333b1d22ff9d329d53d6ea38830b065bd7867"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2e012ce681b4d116c2ce2d285d09e03a794482cb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2e012ce681b4d116c2ce2d285d09e03a794482cb", "html_url": "https://github.com/rust-lang/rust/commit/2e012ce681b4d116c2ce2d285d09e03a794482cb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2e012ce681b4d116c2ce2d285d09e03a794482cb/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "680d9fcac1dec4b671707e0ffc6bf95ac7115ebe", "url": "https://api.github.com/repos/rust-lang/rust/commits/680d9fcac1dec4b671707e0ffc6bf95ac7115ebe", "html_url": "https://github.com/rust-lang/rust/commit/680d9fcac1dec4b671707e0ffc6bf95ac7115ebe"}, {"sha": "b24902ea18e53fde6ec1814953e68be62e71b8ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/b24902ea18e53fde6ec1814953e68be62e71b8ee", "html_url": "https://github.com/rust-lang/rust/commit/b24902ea18e53fde6ec1814953e68be62e71b8ee"}], "stats": {"total": 69, "additions": 45, "deletions": 24}, "files": [{"sha": "1544c9758387f81ed3312577d77bb34427d32083", "filename": "compiler/rustc_driver/src/pretty.rs", "status": "modified", "additions": 30, "deletions": 23, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/2e012ce681b4d116c2ce2d285d09e03a794482cb/compiler%2Frustc_driver%2Fsrc%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e012ce681b4d116c2ce2d285d09e03a794482cb/compiler%2Frustc_driver%2Fsrc%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_driver%2Fsrc%2Fpretty.rs?ref=2e012ce681b4d116c2ce2d285d09e03a794482cb", "patch": "@@ -471,21 +471,6 @@ pub fn print_after_hir_lowering<'tcx>(\n             format!(\"{:#?}\", krate)\n         }),\n \n-        ThirTree => {\n-            let mut out = String::new();\n-            abort_on_err(rustc_typeck::check_crate(tcx), tcx.sess);\n-            debug!(\"pretty printing THIR tree\");\n-            for did in tcx.body_owners() {\n-                let hir = tcx.hir();\n-                let body = hir.body(hir.body_owned_by(hir.local_def_id_to_hir_id(did)));\n-                let arena = thir::Arena::default();\n-                let thir =\n-                    thir::build_thir(tcx, ty::WithOptConstParam::unknown(did), &arena, &body.value);\n-                let _ = writeln!(out, \"{:?}:\\n{:#?}\\n\", did, thir);\n-            }\n-            out\n-        }\n-\n         _ => unreachable!(),\n     };\n \n@@ -501,18 +486,40 @@ fn print_with_analysis(\n     ppm: PpMode,\n     ofile: Option<&Path>,\n ) -> Result<(), ErrorReported> {\n-    let mut out = Vec::new();\n-\n     tcx.analysis(LOCAL_CRATE)?;\n \n-    match ppm {\n-        Mir => write_mir_pretty(tcx, None, &mut out).unwrap(),\n-        MirCFG => write_mir_graphviz(tcx, None, &mut out).unwrap(),\n+    let out = match ppm {\n+        Mir => {\n+            let mut out = Vec::new();\n+            write_mir_pretty(tcx, None, &mut out).unwrap();\n+            String::from_utf8(out).unwrap()\n+        }\n+\n+        MirCFG => {\n+            let mut out = Vec::new();\n+            write_mir_graphviz(tcx, None, &mut out).unwrap();\n+            String::from_utf8(out).unwrap()\n+        }\n+\n+        ThirTree => {\n+            let mut out = String::new();\n+            abort_on_err(rustc_typeck::check_crate(tcx), tcx.sess);\n+            debug!(\"pretty printing THIR tree\");\n+            for did in tcx.body_owners() {\n+                let hir = tcx.hir();\n+                let body = hir.body(hir.body_owned_by(hir.local_def_id_to_hir_id(did)));\n+                let arena = thir::Arena::default();\n+                let thir =\n+                    thir::build_thir(tcx, ty::WithOptConstParam::unknown(did), &arena, &body.value);\n+                let _ = writeln!(out, \"{:?}:\\n{:#?}\\n\", did, thir);\n+            }\n+            out\n+        }\n+\n         _ => unreachable!(),\n-    }\n+    };\n \n-    let out = std::str::from_utf8(&out).unwrap();\n-    write_or_print(out, ofile);\n+    write_or_print(&out, ofile);\n \n     Ok(())\n }"}, {"sha": "8d47ddca18824c5f0fa6752c3c6912627da0bcad", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2e012ce681b4d116c2ce2d285d09e03a794482cb/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e012ce681b4d116c2ce2d285d09e03a794482cb/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=2e012ce681b4d116c2ce2d285d09e03a794482cb", "patch": "@@ -2274,7 +2274,7 @@ impl PpMode {\n \n     pub fn needs_analysis(&self) -> bool {\n         use PpMode::*;\n-        matches!(*self, Mir | MirCFG)\n+        matches!(*self, Mir | MirCFG | ThirTree)\n     }\n }\n "}, {"sha": "520ae974398b4c4d3aa0bc68f0ca103d5e43ee93", "filename": "src/test/ui/issues/issue-83048.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/2e012ce681b4d116c2ce2d285d09e03a794482cb/src%2Ftest%2Fui%2Fissues%2Fissue-83048.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e012ce681b4d116c2ce2d285d09e03a794482cb/src%2Ftest%2Fui%2Fissues%2Fissue-83048.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-83048.rs?ref=2e012ce681b4d116c2ce2d285d09e03a794482cb", "patch": "@@ -0,0 +1,5 @@\n+// compile-flags: -Z unpretty=thir-tree\n+\n+pub fn main() {\n+    break; //~ ERROR: `break` outside of a loop [E0268]\n+}"}, {"sha": "62d67d75844a46f040cc4f8c3b93985a64721d0b", "filename": "src/test/ui/issues/issue-83048.stderr", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/2e012ce681b4d116c2ce2d285d09e03a794482cb/src%2Ftest%2Fui%2Fissues%2Fissue-83048.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2e012ce681b4d116c2ce2d285d09e03a794482cb/src%2Ftest%2Fui%2Fissues%2Fissue-83048.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-83048.stderr?ref=2e012ce681b4d116c2ce2d285d09e03a794482cb", "patch": "@@ -0,0 +1,9 @@\n+error[E0268]: `break` outside of a loop\n+  --> $DIR/issue-83048.rs:4:5\n+   |\n+LL |     break;\n+   |     ^^^^^ cannot `break` outside of a loop\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0268`."}]}