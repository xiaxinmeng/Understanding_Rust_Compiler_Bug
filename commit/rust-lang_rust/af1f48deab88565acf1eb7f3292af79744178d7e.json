{"sha": "af1f48deab88565acf1eb7f3292af79744178d7e", "node_id": "C_kwDOAAsO6NoAKGFmMWY0OGRlYWI4ODU2NWFjZjFlYjdmMzI5MmFmNzk3NDQxNzhkN2U", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-11-02T10:50:08Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-11-02T10:50:08Z"}, "message": "Auto merge of #13359 - feniljain:feat-must-use-option, r=Veykril\n\nfeat: add config for inserting must_use in `generate_enum_as_method`\n\nShould fix #13312\n\nDidn't add a test because I was not sure on how to add test for a specific configuration option, tried to look for the usages for other `AssistConfig` variants but couldn't find any in `tests`. If there is a way to test this, do point me towards it.\n\nI tried to extract the formatting string as a common `template_string` and only have if-else for that, but it didn't compile :(\n\nAlso it seems these tests are failing:\n\n```\ntest config::tests::generate_config_documentation ... FAILED\ntest config::tests::generate_package_json_config ... FAILED\n```\n\nCan you also point me to how to correct these \ud83d\ude05  ( I guess there is some command to automatically generate these? )", "tree": {"sha": "b581f6c1c36ed989369a519ebb9f069422caa217", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b581f6c1c36ed989369a519ebb9f069422caa217"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/af1f48deab88565acf1eb7f3292af79744178d7e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/af1f48deab88565acf1eb7f3292af79744178d7e", "html_url": "https://github.com/rust-lang/rust/commit/af1f48deab88565acf1eb7f3292af79744178d7e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/af1f48deab88565acf1eb7f3292af79744178d7e/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "12ced8f9dbe800824a03ab7502c908c2167b7e9b", "url": "https://api.github.com/repos/rust-lang/rust/commits/12ced8f9dbe800824a03ab7502c908c2167b7e9b", "html_url": "https://github.com/rust-lang/rust/commit/12ced8f9dbe800824a03ab7502c908c2167b7e9b"}, {"sha": "691ce306df39b4c99f7f5b2a366b603532a3b063", "url": "https://api.github.com/repos/rust-lang/rust/commits/691ce306df39b4c99f7f5b2a366b603532a3b063", "html_url": "https://github.com/rust-lang/rust/commit/691ce306df39b4c99f7f5b2a366b603532a3b063"}], "stats": {"total": 36, "additions": 32, "deletions": 4}, "files": [{"sha": "b273ebc85a50687c8afc65097e8f182a40c935a4", "filename": "crates/ide-assists/src/assist_config.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/af1f48deab88565acf1eb7f3292af79744178d7e/crates%2Fide-assists%2Fsrc%2Fassist_config.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af1f48deab88565acf1eb7f3292af79744178d7e/crates%2Fide-assists%2Fsrc%2Fassist_config.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fassist_config.rs?ref=af1f48deab88565acf1eb7f3292af79744178d7e", "patch": "@@ -14,4 +14,5 @@ pub struct AssistConfig {\n     pub allowed: Option<Vec<AssistKind>>,\n     pub insert_use: InsertUseConfig,\n     pub prefer_no_std: bool,\n+    pub assist_emit_must_use: bool,\n }"}, {"sha": "c9aa41c845ad5c0b0a964cb6d0d059167dd1d416", "filename": "crates/ide-assists/src/handlers/generate_enum_projection_method.rs", "status": "modified", "additions": 15, "deletions": 4, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/af1f48deab88565acf1eb7f3292af79744178d7e/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fgenerate_enum_projection_method.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af1f48deab88565acf1eb7f3292af79744178d7e/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fgenerate_enum_projection_method.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fgenerate_enum_projection_method.rs?ref=af1f48deab88565acf1eb7f3292af79744178d7e", "patch": "@@ -124,6 +124,7 @@ fn generate_enum_projection_method(\n         happy_case,\n         sad_case,\n     } = props;\n+\n     let variant = ctx.find_node_at_offset::<ast::Variant>()?;\n     let variant_name = variant.name()?;\n     let parent_enum = ast::Adt::Enum(variant.parent_enum());\n@@ -144,7 +145,7 @@ fn generate_enum_projection_method(\n         ast::StructKind::Unit => return None,\n     };\n \n-    let fn_name = format!(\"{}_{}\", fn_name_prefix, &to_lower_snake_case(&variant_name.text()));\n+    let fn_name = format!(\"{fn_name_prefix}_{}\", &to_lower_snake_case(&variant_name.text()));\n \n     // Return early if we've found an existing new fn\n     let impl_def = find_struct_impl(ctx, &parent_enum, &[fn_name.clone()])?;\n@@ -156,15 +157,25 @@ fn generate_enum_projection_method(\n         assist_description,\n         target,\n         |builder| {\n-            let vis = parent_enum.visibility().map_or(String::new(), |v| format!(\"{v} \"));\n+            let vis = parent_enum.visibility().map_or(String::new(), |v| format!(\"{} \", v));\n+\n+            let field_type_syntax = field_type.syntax();\n+\n+            let must_use = if ctx.config.assist_emit_must_use {\n+                \"#[must_use]\\n    \"\n+            } else {\n+                \"\"\n+            };\n+\n             let method = format!(\n-                \"    {vis}fn {fn_name}({self_param}) -> {return_prefix}{field_type}{return_suffix} {{\n+                \"    {must_use}{vis}fn {fn_name}({self_param}) -> {return_prefix}{field_type_syntax}{return_suffix} {{\n         if let Self::{variant_name}{pattern_suffix} = self {{\n             {happy_case}({bound_name})\n         }} else {{\n             {sad_case}\n         }}\n-    }}\");\n+    }}\"\n+            );\n \n             add_method_to_adt(builder, &parent_enum, impl_def, &method);\n         },"}, {"sha": "92ced27c78aedf801b3c5eee80a066aea043be72", "filename": "crates/ide-assists/src/tests.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/af1f48deab88565acf1eb7f3292af79744178d7e/crates%2Fide-assists%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af1f48deab88565acf1eb7f3292af79744178d7e/crates%2Fide-assists%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Ftests.rs?ref=af1f48deab88565acf1eb7f3292af79744178d7e", "patch": "@@ -30,6 +30,7 @@ pub(crate) const TEST_CONFIG: AssistConfig = AssistConfig {\n         skip_glob_imports: true,\n     },\n     prefer_no_std: false,\n+    assist_emit_must_use: false,\n };\n \n pub(crate) fn with_single_file(text: &str) -> (RootDatabase, FileId) {"}, {"sha": "4072ae585dbd913d036fbaad37a559db33af3117", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/af1f48deab88565acf1eb7f3292af79744178d7e/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af1f48deab88565acf1eb7f3292af79744178d7e/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=af1f48deab88565acf1eb7f3292af79744178d7e", "patch": "@@ -56,6 +56,9 @@ mod patch_old_style;\n // parsing the old name.\n config_data! {\n     struct ConfigData {\n+        /// Whether to insert #[must_use] when generating `as_` methods\n+        /// for enum variants.\n+        assist_emitMustUse: bool               = \"false\",\n         /// Placeholder expression to use for missing expressions in assists.\n         assist_expressionFillDefault: ExprFillDefaultDef              = \"\\\"todo\\\"\",\n \n@@ -1276,6 +1279,7 @@ impl Config {\n             allowed: None,\n             insert_use: self.insert_use_config(),\n             prefer_no_std: self.data.imports_prefer_no_std,\n+            assist_emit_must_use: self.data.assist_emitMustUse,\n         }\n     }\n "}, {"sha": "36794efe42726126311af4cfcdb3e2500ca1c7ec", "filename": "docs/user/generated_config.adoc", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/af1f48deab88565acf1eb7f3292af79744178d7e/docs%2Fuser%2Fgenerated_config.adoc", "raw_url": "https://github.com/rust-lang/rust/raw/af1f48deab88565acf1eb7f3292af79744178d7e/docs%2Fuser%2Fgenerated_config.adoc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Fgenerated_config.adoc?ref=af1f48deab88565acf1eb7f3292af79744178d7e", "patch": "@@ -1,3 +1,9 @@\n+[[rust-analyzer.assist.emitMustUse]]rust-analyzer.assist.emitMustUse (default: `false`)::\n++\n+--\n+Whether to insert #[must_use] when generating `as_` methods\n+for enum variants.\n+--\n [[rust-analyzer.assist.expressionFillDefault]]rust-analyzer.assist.expressionFillDefault (default: `\"todo\"`)::\n +\n --"}, {"sha": "0ff66527451d30720a99c4ce0285cda592d83799", "filename": "editors/code/package.json", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/af1f48deab88565acf1eb7f3292af79744178d7e/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/af1f48deab88565acf1eb7f3292af79744178d7e/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=af1f48deab88565acf1eb7f3292af79744178d7e", "patch": "@@ -397,6 +397,11 @@\n                     \"type\": \"boolean\"\n                 },\n                 \"$generated-start\": {},\n+                \"rust-analyzer.assist.emitMustUse\": {\n+                    \"markdownDescription\": \"Whether to insert #[must_use] when generating `as_` methods\\nfor enum variants.\",\n+                    \"default\": false,\n+                    \"type\": \"boolean\"\n+                },\n                 \"rust-analyzer.assist.expressionFillDefault\": {\n                     \"markdownDescription\": \"Placeholder expression to use for missing expressions in assists.\",\n                     \"default\": \"todo\","}]}