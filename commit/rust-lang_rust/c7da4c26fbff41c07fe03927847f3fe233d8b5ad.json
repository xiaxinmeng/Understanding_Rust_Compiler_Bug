{"sha": "c7da4c26fbff41c07fe03927847f3fe233d8b5ad", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM3ZGE0YzI2ZmJmZjQxYzA3ZmUwMzkyNzg0N2YzZmUyMzNkOGI1YWQ=", "commit": {"author": {"name": "Jeremy Stucki", "email": "stucki.jeremy@gmail.com", "date": "2019-06-24T13:08:26Z"}, "committer": {"name": "Jeremy Stucki", "email": "stucki.jeremy@gmail.com", "date": "2019-07-08T15:11:54Z"}, "message": "Implement flat_map lint", "tree": {"sha": "f7cc7571aa02ee2ecf94c7f019cf276f8672e53a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f7cc7571aa02ee2ecf94c7f019cf276f8672e53a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c7da4c26fbff41c07fe03927847f3fe233d8b5ad", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEnLVrz+MJS3aQxZ9oj1SKWi7RP1gFAl0jXToACgkQj1SKWi7R\nP1giyQ/+Mkv0eqjYbD3sJNMCIrouSxi8NnAKcJA9K4u3QJ1ad7HPwtI9xHxID/CM\n+KdeL0UM6Ybtvur5ja+Hd+X7tWSq64qcbCvi5k2t08S+fuIzyI9hwE3LkskMz3tH\nsAOKzEQeamGtsjts5HhMTOxcj/poRgf+SgePWbWBcARIF/3pyDFFq0Qc+DY7tBid\neM+n+CNrrjRKCMJevXLFzGN2rO5PUPfmZBpcu0L2F2sN13ionhITllBy14mCaNIP\nR9HOGRb5c9mX/cCnwdr2ujWBbqGvpQo2+XQa6GlrQu9V+Vc3WqB0UT6MxFWP0CRB\n+yfhFfkI6QGY8LLLr3PthGMQ9yFzVr8fMHzjbHTlAGZlVxzguZB9DrmG5OPQf3/C\ngyq20GP8bSum2ys9ALVyrcTSCo4rOqRwL5i2DT53jmcoSWbGH+8QGB+glSSrIMqh\n/rJTUCHSBqw3ciObAe228uDoirdDH9o76fow00UOAnz7QVFaTsjrgqH7VZ7W34rh\niG81di6htWsilDeqChBn9zSYhEBk0snpV9A7uMwnzN2fQiwAHijMPvHhJMy55Xsv\nhNJsR3ZeHaxIP/gagCqPFjO/dq0pVzuVjBz/uk7JHjclubhuxM+vz0GUvcZitorQ\nrZDUWAO3GLogTNWeBogNH1REnEpKZLkVZXf7vusz8fO8FrPCy0k=\n=owxW\n-----END PGP SIGNATURE-----", "payload": "tree f7cc7571aa02ee2ecf94c7f019cf276f8672e53a\nparent 1fd617d6df6055516b5cc4b265037e4188806d1d\nauthor Jeremy Stucki <stucki.jeremy@gmail.com> 1561381706 +0200\ncommitter Jeremy Stucki <stucki.jeremy@gmail.com> 1562598714 +0200\n\nImplement flat_map lint\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c7da4c26fbff41c07fe03927847f3fe233d8b5ad", "html_url": "https://github.com/rust-lang/rust/commit/c7da4c26fbff41c07fe03927847f3fe233d8b5ad", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c7da4c26fbff41c07fe03927847f3fe233d8b5ad/comments", "author": {"login": "jeremystucki", "id": 7629727, "node_id": "MDQ6VXNlcjc2Mjk3Mjc=", "avatar_url": "https://avatars.githubusercontent.com/u/7629727?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jeremystucki", "html_url": "https://github.com/jeremystucki", "followers_url": "https://api.github.com/users/jeremystucki/followers", "following_url": "https://api.github.com/users/jeremystucki/following{/other_user}", "gists_url": "https://api.github.com/users/jeremystucki/gists{/gist_id}", "starred_url": "https://api.github.com/users/jeremystucki/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jeremystucki/subscriptions", "organizations_url": "https://api.github.com/users/jeremystucki/orgs", "repos_url": "https://api.github.com/users/jeremystucki/repos", "events_url": "https://api.github.com/users/jeremystucki/events{/privacy}", "received_events_url": "https://api.github.com/users/jeremystucki/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jeremystucki", "id": 7629727, "node_id": "MDQ6VXNlcjc2Mjk3Mjc=", "avatar_url": "https://avatars.githubusercontent.com/u/7629727?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jeremystucki", "html_url": "https://github.com/jeremystucki", "followers_url": "https://api.github.com/users/jeremystucki/followers", "following_url": "https://api.github.com/users/jeremystucki/following{/other_user}", "gists_url": "https://api.github.com/users/jeremystucki/gists{/gist_id}", "starred_url": "https://api.github.com/users/jeremystucki/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jeremystucki/subscriptions", "organizations_url": "https://api.github.com/users/jeremystucki/orgs", "repos_url": "https://api.github.com/users/jeremystucki/repos", "events_url": "https://api.github.com/users/jeremystucki/events{/privacy}", "received_events_url": "https://api.github.com/users/jeremystucki/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1fd617d6df6055516b5cc4b265037e4188806d1d", "url": "https://api.github.com/repos/rust-lang/rust/commits/1fd617d6df6055516b5cc4b265037e4188806d1d", "html_url": "https://github.com/rust-lang/rust/commit/1fd617d6df6055516b5cc4b265037e4188806d1d"}], "stats": {"total": 55, "additions": 55, "deletions": 0}, "files": [{"sha": "b907b7f0e79a01d931ef7db28b70b3ec368f9c30", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c7da4c26fbff41c07fe03927847f3fe233d8b5ad/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/c7da4c26fbff41c07fe03927847f3fe233d8b5ad/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=c7da4c26fbff41c07fe03927847f3fe233d8b5ad", "patch": "@@ -947,6 +947,7 @@ Released 2018-09-13\n [`filter_map_next`]: https://rust-lang.github.io/rust-clippy/master/index.html#filter_map_next\n [`filter_next`]: https://rust-lang.github.io/rust-clippy/master/index.html#filter_next\n [`find_map`]: https://rust-lang.github.io/rust-clippy/master/index.html#find_map\n+[`flat_map`]: https://rust-lang.github.io/rust-clippy/master/index.html#flat_map\n [`float_arithmetic`]: https://rust-lang.github.io/rust-clippy/master/index.html#float_arithmetic\n [`float_cmp`]: https://rust-lang.github.io/rust-clippy/master/index.html#float_cmp\n [`float_cmp_const`]: https://rust-lang.github.io/rust-clippy/master/index.html#float_cmp_const"}, {"sha": "5548bb0ab6229630d715d3c98638f0207867c11c", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c7da4c26fbff41c07fe03927847f3fe233d8b5ad/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c7da4c26fbff41c07fe03927847f3fe233d8b5ad/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=c7da4c26fbff41c07fe03927847f3fe233d8b5ad", "patch": "@@ -637,6 +637,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n         methods::FILTER_MAP,\n         methods::FILTER_MAP_NEXT,\n         methods::FIND_MAP,\n+        methods::FLAT_MAP,\n         methods::MAP_FLATTEN,\n         methods::OPTION_MAP_UNWRAP_OR,\n         methods::OPTION_MAP_UNWRAP_OR_ELSE,"}, {"sha": "1578976ed853bff49a0a2a4a7d86257b11acfd6a", "filename": "clippy_lints/src/methods/mod.rs", "status": "modified", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/c7da4c26fbff41c07fe03927847f3fe233d8b5ad/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c7da4c26fbff41c07fe03927847f3fe233d8b5ad/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs?ref=c7da4c26fbff41c07fe03927847f3fe233d8b5ad", "patch": "@@ -312,6 +312,26 @@ declare_clippy_lint! {\n     \"using combination of `filter_map` and `next` which can usually be written as a single method call\"\n }\n \n+declare_clippy_lint! {\n+    /// **What it does:** Checks for usage of `flat_map(|x| x)`.\n+    ///\n+    /// **Why is this bad?** Readability, this can be written more concisely by using `flatten`.\n+    ///\n+    /// **Known problems:** None\n+    ///\n+    /// **Example:**\n+    /// ```rust\n+    /// iter.flat_map(|x| x)\n+    /// ```\n+    /// Can be written as\n+    /// ```rust\n+    /// iter.flatten()\n+    /// ```\n+    pub FLAT_MAP,\n+    pedantic,\n+    \"call to `flat_map` where `flatten` is sufficient\"\n+}\n+\n declare_clippy_lint! {\n     /// **What it does:** Checks for usage of `_.find(_).map(_)`.\n     ///\n@@ -844,6 +864,7 @@ declare_lint_pass!(Methods => [\n     FILTER_NEXT,\n     FILTER_MAP,\n     FILTER_MAP_NEXT,\n+    FLAT_MAP,\n     FIND_MAP,\n     MAP_FLATTEN,\n     ITER_NTH,\n@@ -884,6 +905,7 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Methods {\n             [\"map\", \"find\"] => lint_find_map(cx, expr, arg_lists[1], arg_lists[0]),\n             [\"flat_map\", \"filter\"] => lint_filter_flat_map(cx, expr, arg_lists[1], arg_lists[0]),\n             [\"flat_map\", \"filter_map\"] => lint_filter_map_flat_map(cx, expr, arg_lists[1], arg_lists[0]),\n+            [\"flat_map\", ..] => lint_flat_map(cx, expr, arg_lists[0]),\n             [\"flatten\", \"map\"] => lint_map_flatten(cx, expr, arg_lists[1]),\n             [\"is_some\", \"find\"] => lint_search_is_some(cx, expr, \"find\", arg_lists[1], arg_lists[0]),\n             [\"is_some\", \"position\"] => lint_search_is_some(cx, expr, \"position\", arg_lists[1], arg_lists[0]),\n@@ -2092,6 +2114,30 @@ fn lint_filter_map_flat_map<'a, 'tcx>(\n     }\n }\n \n+/// lint use of `flat_map` for `Iterators` where `flatten` would be sufficient\n+fn lint_flat_map<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, expr: &'tcx hir::Expr, flat_map_args: &'tcx [hir::Expr]) {\n+    if_chain! {\n+        if match_trait_method(cx, expr, &paths::ITERATOR);\n+\n+        if flat_map_args.len() == 2;\n+        if let hir::ExprKind::Closure(_, _, body_id, _, _) = flat_map_args[1].node;\n+        let body = cx.tcx.hir().body(body_id);\n+\n+        if body.arguments.len() == 1;\n+        if let hir::PatKind::Binding(_, _, binding_ident, _) = body.arguments[0].pat.node;\n+        if let hir::ExprKind::Path(hir::QPath::Resolved(_, ref path)) = body.value.node;\n+\n+        if path.segments.len() == 1;\n+        if path.segments[0].ident.as_str() == binding_ident.as_str();\n+\n+        then {\n+            let msg = \"called `flat_map(|x| x)` on an `Iterator`. \\\n+                       This can be simplified by calling `flatten().`\";\n+            span_lint(cx, FLAT_MAP, expr.span, msg);\n+        }\n+    }\n+}\n+\n /// lint searching an Iterator followed by `is_some()`\n fn lint_search_is_some<'a, 'tcx>(\n     cx: &LateContext<'a, 'tcx>,"}, {"sha": "a7727258b53ee4e53b3ad1547a5d697a9fa8c41d", "filename": "src/lintlist/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c7da4c26fbff41c07fe03927847f3fe233d8b5ad/src%2Flintlist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c7da4c26fbff41c07fe03927847f3fe233d8b5ad/src%2Flintlist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flintlist%2Fmod.rs?ref=c7da4c26fbff41c07fe03927847f3fe233d8b5ad", "patch": "@@ -553,6 +553,13 @@ pub const ALL_LINTS: [Lint; 306] = [\n         deprecation: None,\n         module: \"methods\",\n     },\n+    Lint {\n+        name: \"flat_map\",\n+        group: \"pedantic\",\n+        desc: \"call to `flat_map` where `flatten` is sufficient\",\n+        deprecation: None,\n+        module: \"methods\",\n+    },\n     Lint {\n         name: \"float_arithmetic\",\n         group: \"restriction\","}]}