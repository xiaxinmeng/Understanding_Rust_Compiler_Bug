{"sha": "384ec80d2b3dd61a5f9910dc660bffea8710002e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM4NGVjODBkMmIzZGQ2MWE1Zjk5MTBkYzY2MGJmZmVhODcxMDAwMmU=", "commit": {"author": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2017-04-11T20:52:51Z"}, "committer": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2017-04-11T20:52:51Z"}, "message": "store Spans for all MIR locals", "tree": {"sha": "9d9b1b3f7a4980207f149db45a4a8375b70e25a2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9d9b1b3f7a4980207f149db45a4a8375b70e25a2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/384ec80d2b3dd61a5f9910dc660bffea8710002e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/384ec80d2b3dd61a5f9910dc660bffea8710002e", "html_url": "https://github.com/rust-lang/rust/commit/384ec80d2b3dd61a5f9910dc660bffea8710002e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/384ec80d2b3dd61a5f9910dc660bffea8710002e/comments", "author": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c58c928e658d2e45f816fd05796a964aa83759da", "url": "https://api.github.com/repos/rust-lang/rust/commits/c58c928e658d2e45f816fd05796a964aa83759da", "html_url": "https://github.com/rust-lang/rust/commit/c58c928e658d2e45f816fd05796a964aa83759da"}], "stats": {"total": 173, "additions": 96, "deletions": 77}, "files": [{"sha": "3ff8ffb35054ad4be9764f6c80ea5b4f8b1481a1", "filename": "src/librustc/ich/impls_mir.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc%2Fich%2Fimpls_mir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc%2Fich%2Fimpls_mir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_mir.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -22,7 +22,8 @@ impl_stable_hash_for!(struct mir::SourceInfo { span, scope });\n impl_stable_hash_for!(enum mir::Mutability { Mut, Not });\n impl_stable_hash_for!(enum mir::BorrowKind { Shared, Unique, Mut });\n impl_stable_hash_for!(enum mir::LocalKind { Var, Temp, Arg, ReturnPointer });\n-impl_stable_hash_for!(struct mir::LocalDecl<'tcx> { mutability, ty, name, source_info });\n+impl_stable_hash_for!(struct mir::LocalDecl<'tcx> { mutability, ty, name, source_info,\n+is_user_variable});\n impl_stable_hash_for!(struct mir::UpvarDecl { debug_name, by_ref });\n impl_stable_hash_for!(struct mir::BasicBlockData<'tcx> { statements, terminator, is_cleanup });\n impl_stable_hash_for!(struct mir::Terminator<'tcx> { source_info, kind });"}, {"sha": "9ff64b295b765ee8a5f67026f15312c2938cadc0", "filename": "src/librustc/mir/mod.rs", "status": "modified", "additions": 23, "deletions": 17, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fmod.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -197,10 +197,10 @@ impl<'tcx> Mir<'tcx> {\n     pub fn temps_iter<'a>(&'a self) -> impl Iterator<Item=Local> + 'a {\n         (self.arg_count+1..self.local_decls.len()).filter_map(move |index| {\n             let local = Local::new(index);\n-            if self.local_decls[local].source_info.is_none() {\n-                Some(local)\n-            } else {\n+            if self.local_decls[local].is_user_variable {\n                 None\n+            } else {\n+                Some(local)\n             }\n         })\n     }\n@@ -210,10 +210,10 @@ impl<'tcx> Mir<'tcx> {\n     pub fn vars_iter<'a>(&'a self) -> impl Iterator<Item=Local> + 'a {\n         (self.arg_count+1..self.local_decls.len()).filter_map(move |index| {\n             let local = Local::new(index);\n-            if self.local_decls[local].source_info.is_none() {\n-                None\n-            } else {\n+            if self.local_decls[local].is_user_variable {\n                 Some(local)\n+            } else {\n+                None\n             }\n         })\n     }\n@@ -370,6 +370,9 @@ pub struct LocalDecl<'tcx> {\n     /// Temporaries and the return pointer are always mutable.\n     pub mutability: Mutability,\n \n+    /// True if this corresponds to a user-declared local variable.\n+    pub is_user_variable: bool,\n+\n     /// Type of this local.\n     pub ty: Ty<'tcx>,\n \n@@ -379,37 +382,40 @@ pub struct LocalDecl<'tcx> {\n     /// to generate better debuginfo.\n     pub name: Option<Name>,\n \n-    /// For user-declared variables, stores their source information.\n-    ///\n-    /// For temporaries, this is `None`.\n-    ///\n-    /// This is the primary way to differentiate between user-declared\n-    /// variables and compiler-generated temporaries.\n-    pub source_info: Option<SourceInfo>,\n+    /// Source info of the local.\n+    pub source_info: SourceInfo,\n }\n \n impl<'tcx> LocalDecl<'tcx> {\n     /// Create a new `LocalDecl` for a temporary.\n     #[inline]\n-    pub fn new_temp(ty: Ty<'tcx>) -> Self {\n+    pub fn new_temp(ty: Ty<'tcx>, span: Span) -> Self {\n         LocalDecl {\n             mutability: Mutability::Mut,\n             ty: ty,\n             name: None,\n-            source_info: None,\n+            source_info: SourceInfo {\n+                span: span,\n+                scope: ARGUMENT_VISIBILITY_SCOPE\n+            },\n+            is_user_variable: false\n         }\n     }\n \n     /// Builds a `LocalDecl` for the return pointer.\n     ///\n     /// This must be inserted into the `local_decls` list as the first local.\n     #[inline]\n-    pub fn new_return_pointer(return_ty: Ty) -> LocalDecl {\n+    pub fn new_return_pointer(return_ty: Ty, span: Span) -> LocalDecl {\n         LocalDecl {\n             mutability: Mutability::Mut,\n             ty: return_ty,\n-            source_info: None,\n+            source_info: SourceInfo {\n+                span: span,\n+                scope: ARGUMENT_VISIBILITY_SCOPE\n+            },\n             name: None,     // FIXME maybe we do want some name here?\n+            is_user_variable: false\n         }\n     }\n }"}, {"sha": "83963de8b0014e69df865ebad04a3db22be49328", "filename": "src/librustc/mir/visit.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc%2Fmir%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc%2Fmir%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fvisit.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -630,12 +630,11 @@ macro_rules! make_mir_visitor {\n                     ref $($mutability)* ty,\n                     name: _,\n                     ref $($mutability)* source_info,\n+                    is_user_variable: _,\n                 } = *local_decl;\n \n                 self.visit_ty(ty);\n-                if let Some(ref $($mutability)* info) = *source_info {\n-                    self.visit_source_info(info);\n-                }\n+                self.visit_source_info(source_info);\n             }\n \n             fn super_visibility_scope(&mut self,"}, {"sha": "ca313622a3afd1928e5f2ffd1210d6a119f0fbc0", "filename": "src/librustc_borrowck/borrowck/mir/elaborate_drops.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_borrowck%2Fborrowck%2Fmir%2Felaborate_drops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_borrowck%2Fborrowck%2Fmir%2Felaborate_drops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_borrowck%2Fborrowck%2Fmir%2Felaborate_drops.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -307,12 +307,12 @@ impl<'b, 'tcx> ElaborateDropsCtxt<'b, 'tcx> {\n         data\n     }\n \n-    fn create_drop_flag(&mut self, index: MovePathIndex) {\n+    fn create_drop_flag(&mut self, index: MovePathIndex, span: Span) {\n         let tcx = self.tcx;\n         let patch = &mut self.patch;\n         debug!(\"create_drop_flag({:?})\", self.mir.span);\n         self.drop_flags.entry(index).or_insert_with(|| {\n-            patch.new_temp(tcx.types.bool)\n+            patch.new_temp(tcx.types.bool, span)\n         });\n     }\n \n@@ -374,7 +374,7 @@ impl<'b, 'tcx> ElaborateDropsCtxt<'b, 'tcx> {\n                 debug!(\"collect_drop_flags: collecting {:?} from {:?}@{:?} - {:?}\",\n                        child, location, path, (maybe_live, maybe_dead));\n                 if maybe_live && maybe_dead {\n-                    self.create_drop_flag(child)\n+                    self.create_drop_flag(child, terminator.source_info.span)\n                 }\n             });\n         }"}, {"sha": "df2841a66826980d6cd1ae96739c3ed4cba53b05", "filename": "src/librustc_mir/build/expr/as_lvalue.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_lvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_lvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_lvalue.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -62,7 +62,8 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                 let idx = unpack!(block = this.as_operand(block, None, index));\n \n                 // bounds check:\n-                let (len, lt) = (this.temp(usize_ty.clone()), this.temp(bool_ty));\n+                let (len, lt) = (this.temp(usize_ty.clone(), expr_span),\n+                                 this.temp(bool_ty, expr_span));\n                 this.cfg.push_assign(block, source_info, // len = len(slice)\n                                      &len, Rvalue::Len(slice.clone()));\n                 this.cfg.push_assign(block, source_info, // lt = idx < len"}, {"sha": "fb547332c5f58b79bffe08dd478bdcc26d9c4a32", "filename": "src/librustc_mir/build/expr/as_rvalue.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_rvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_rvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_rvalue.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -82,7 +82,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                     let bool_ty = this.hir.bool_ty();\n \n                     let minval = this.minval_literal(expr_span, expr.ty);\n-                    let is_min = this.temp(bool_ty);\n+                    let is_min = this.temp(bool_ty, expr_span);\n \n                     this.cfg.push_assign(block, source_info, &is_min,\n                                          Rvalue::BinaryOp(BinOp::Eq, arg.clone(), minval));\n@@ -95,7 +95,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n             }\n             ExprKind::Box { value, value_extents } => {\n                 let value = this.hir.mirror(value);\n-                let result = this.temp(expr.ty);\n+                let result = this.temp(expr.ty, expr_span);\n                 // to start, malloc some memory of suitable type (thus far, uninitialized):\n                 this.cfg.push_assign(block, source_info, &result, Rvalue::Box(value.ty));\n                 this.in_scope(value_extents, block, |this| {\n@@ -260,7 +260,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n         let bool_ty = self.hir.bool_ty();\n         if self.hir.check_overflow() && op.is_checkable() && ty.is_integral() {\n             let result_tup = self.hir.tcx().intern_tup(&[ty, bool_ty], false);\n-            let result_value = self.temp(result_tup);\n+            let result_value = self.temp(result_tup, span);\n \n             self.cfg.push_assign(block, source_info,\n                                  &result_value, Rvalue::CheckedBinaryOp(op,\n@@ -301,7 +301,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                 };\n \n                 // Check for / 0\n-                let is_zero = self.temp(bool_ty);\n+                let is_zero = self.temp(bool_ty, span);\n                 let zero = self.zero_literal(span, ty);\n                 self.cfg.push_assign(block, source_info, &is_zero,\n                                      Rvalue::BinaryOp(BinOp::Eq, rhs.clone(), zero));\n@@ -315,9 +315,9 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                     let neg_1 = self.neg_1_literal(span, ty);\n                     let min = self.minval_literal(span, ty);\n \n-                    let is_neg_1 = self.temp(bool_ty);\n-                    let is_min   = self.temp(bool_ty);\n-                    let of       = self.temp(bool_ty);\n+                    let is_neg_1 = self.temp(bool_ty, span);\n+                    let is_min   = self.temp(bool_ty, span);\n+                    let of       = self.temp(bool_ty, span);\n \n                     // this does (rhs == -1) & (lhs == MIN). It could short-circuit instead\n "}, {"sha": "e4598b4143871e2bc3a6f059ab7188f61d8c2b83", "filename": "src/librustc_mir/build/expr/as_temp.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_temp.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_temp.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_temp.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -44,8 +44,8 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n         }\n \n         let expr_ty = expr.ty.clone();\n-        let temp = this.temp(expr_ty.clone());\n         let expr_span = expr.span;\n+        let temp = this.temp(expr_ty.clone(), expr_span);\n         let source_info = this.source_info(expr_span);\n \n         if expr.temp_lifetime_was_shrunk && this.hir.needs_drop(expr_ty) {"}, {"sha": "c03432312b0ab6c4adc235e2a3036603c6f3854b", "filename": "src/librustc_mir/build/expr/stmt.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fstmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fstmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fstmt.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -138,7 +138,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n             }\n             _ => {\n                 let expr_ty = expr.ty;\n-                let temp = this.temp(expr.ty.clone());\n+                let temp = this.temp(expr.ty.clone(), expr_span);\n                 unpack!(block = this.into(&temp, block, expr));\n                 unpack!(block = this.build_drop(block, expr_span, temp, expr_ty));\n                 block.unit()"}, {"sha": "ddeec1fe6d0bae009c53f07e9896dd31da33f93c", "filename": "src/librustc_mir/build/matches/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fmod.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -710,7 +710,8 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n             mutability: mutability,\n             ty: var_ty.clone(),\n             name: Some(name),\n-            source_info: Some(source_info),\n+            source_info: source_info,\n+            is_user_variable: true,\n         });\n         self.var_indices.insert(var_id, var);\n "}, {"sha": "5fece4d6a5d2387aae043ceb46cd070b98ea66e5", "filename": "src/librustc_mir/build/matches/test.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Ftest.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -210,7 +210,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                 debug!(\"num_enum_variants: {}, tested variants: {:?}, variants: {:?}\",\n                        num_enum_variants, values, variants);\n                 let discr_ty = adt_def.repr.discr_type().to_ty(tcx);\n-                let discr = self.temp(discr_ty);\n+                let discr = self.temp(discr_ty, test.span);\n                 self.cfg.push_assign(block, source_info, &discr,\n                                      Rvalue::Discriminant(lvalue.clone()));\n                 assert_eq!(values.len() + 1, targets.len());\n@@ -270,7 +270,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                     if let ty::TyRef(region, mt) = ty.sty {\n                         if let ty::TyArray(_, _) = mt.ty.sty {\n                             ty = tcx.mk_imm_ref(region, tcx.mk_slice(tcx.types.u8));\n-                            let val_slice = self.temp(ty);\n+                            let val_slice = self.temp(ty, test.span);\n                             self.cfg.push_assign(block, source_info, &val_slice,\n                                                  Rvalue::Cast(CastKind::Unsize, val, ty));\n                             val = Operand::Consume(val_slice);\n@@ -285,7 +285,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                         value: value.clone()\n                     });\n \n-                    let slice = self.temp(ty);\n+                    let slice = self.temp(ty, test.span);\n                     self.cfg.push_assign(block, source_info, &slice,\n                                          Rvalue::Cast(CastKind::Unsize, array, ty));\n                     Operand::Consume(slice)\n@@ -304,7 +304,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                     let (mty, method) = self.hir.trait_method(eq_def_id, \"eq\", ty, &[ty]);\n \n                     let bool_ty = self.hir.bool_ty();\n-                    let eq_result = self.temp(bool_ty);\n+                    let eq_result = self.temp(bool_ty, test.span);\n                     let eq_block = self.cfg.start_new_block();\n                     let cleanup = self.diverge_cleanup();\n                     self.cfg.terminate(block, source_info, TerminatorKind::Call {\n@@ -349,7 +349,8 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n \n             TestKind::Len { len, op } => {\n                 let (usize_ty, bool_ty) = (self.hir.usize_ty(), self.hir.bool_ty());\n-                let (actual, result) = (self.temp(usize_ty), self.temp(bool_ty));\n+                let (actual, result) = (self.temp(usize_ty, test.span),\n+                                        self.temp(bool_ty, test.span));\n \n                 // actual = len(lvalue)\n                 self.cfg.push_assign(block, source_info,\n@@ -383,7 +384,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                left: Operand<'tcx>,\n                right: Operand<'tcx>) -> BasicBlock {\n         let bool_ty = self.hir.bool_ty();\n-        let result = self.temp(bool_ty);\n+        let result = self.temp(bool_ty, span);\n \n         // result = op(left, right)\n         let source_info = self.source_info(span);"}, {"sha": "35a8b245f2bb64203a7e19e14d8c891015e02821", "filename": "src/librustc_mir/build/misc.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fmisc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fmisc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmisc.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -27,8 +27,8 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n     ///\n     /// NB: **No cleanup is scheduled for this temporary.** You should\n     /// call `schedule_drop` once the temporary is initialized.\n-    pub fn temp(&mut self, ty: Ty<'tcx>) -> Lvalue<'tcx> {\n-        let temp = self.local_decls.push(LocalDecl::new_temp(ty));\n+    pub fn temp(&mut self, ty: Ty<'tcx>, span: Span) -> Lvalue<'tcx> {\n+        let temp = self.local_decls.push(LocalDecl::new_temp(ty, span));\n         let lvalue = Lvalue::Local(temp);\n         debug!(\"temp: created temp {:?} with type {:?}\",\n                lvalue, self.local_decls[temp].ty);\n@@ -106,7 +106,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                       value: u64)\n                       -> Lvalue<'tcx> {\n         let usize_ty = self.hir.usize_ty();\n-        let temp = self.temp(usize_ty);\n+        let temp = self.temp(usize_ty, source_info.span);\n         self.cfg.push_assign_constant(\n             block, source_info, &temp,\n             Constant {"}, {"sha": "ef3fa23500b34395b9f79ce79fc841beac3d75ad", "filename": "src/librustc_mir/build/mod.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmod.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -249,7 +249,8 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n             visibility_scopes: IndexVec::new(),\n             visibility_scope: ARGUMENT_VISIBILITY_SCOPE,\n             breakable_scopes: vec![],\n-            local_decls: IndexVec::from_elem_n(LocalDecl::new_return_pointer(return_ty), 1),\n+            local_decls: IndexVec::from_elem_n(LocalDecl::new_return_pointer(return_ty,\n+                                                                             span), 1),\n             var_indices: NodeMap(),\n             unit_temp: None,\n             cached_resume_block: None,\n@@ -304,8 +305,12 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n             self.local_decls.push(LocalDecl {\n                 mutability: Mutability::Not,\n                 ty: ty,\n-                source_info: None,\n+                source_info: SourceInfo {\n+                    scope: ARGUMENT_VISIBILITY_SCOPE,\n+                    span: pattern.map_or(self.fn_span, |pat| pat.span)\n+                },\n                 name: name,\n+                is_user_variable: false,\n             });\n         }\n \n@@ -341,7 +346,8 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n             Some(ref tmp) => tmp.clone(),\n             None => {\n                 let ty = self.hir.unit_ty();\n-                let tmp = self.temp(ty);\n+                let fn_span = self.fn_span;\n+                let tmp = self.temp(ty, fn_span);\n                 self.unit_temp = Some(tmp.clone());\n                 tmp\n             }"}, {"sha": "0cec84d16a81c44740e5b0399c73351c28f01cd7", "filename": "src/librustc_mir/shim.rs", "status": "modified", "additions": 14, "deletions": 9, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fshim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Fshim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fshim.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -137,16 +137,20 @@ enum CallKind {\n     Direct(DefId),\n }\n \n-fn temp_decl(mutability: Mutability, ty: Ty) -> LocalDecl {\n-    LocalDecl { mutability, ty, name: None, source_info: None }\n+fn temp_decl(mutability: Mutability, ty: Ty, span: Span) -> LocalDecl {\n+    LocalDecl {\n+        mutability, ty, name: None,\n+        source_info: SourceInfo { scope: ARGUMENT_VISIBILITY_SCOPE, span },\n+        is_user_variable: false\n+    }\n }\n \n-fn local_decls_for_sig<'tcx>(sig: &ty::FnSig<'tcx>)\n+fn local_decls_for_sig<'tcx>(sig: &ty::FnSig<'tcx>, span: Span)\n     -> IndexVec<Local, LocalDecl<'tcx>>\n {\n-    iter::once(temp_decl(Mutability::Mut, sig.output()))\n+    iter::once(temp_decl(Mutability::Mut, sig.output(), span))\n         .chain(sig.inputs().iter().map(\n-            |ity| temp_decl(Mutability::Not, ity)))\n+            |ity| temp_decl(Mutability::Not, ity, span)))\n         .collect()\n }\n \n@@ -188,7 +192,7 @@ fn build_drop_shim<'a, 'tcx>(tcx: ty::TyCtxt<'a, 'tcx, 'tcx>,\n         ),\n         IndexVec::new(),\n         sig.output(),\n-        local_decls_for_sig(&sig),\n+        local_decls_for_sig(&sig, span),\n         sig.inputs().len(),\n         vec![],\n         span\n@@ -297,7 +301,7 @@ fn build_call_shim<'a, 'tcx>(tcx: ty::TyCtxt<'a, 'tcx, 'tcx>,\n \n     debug!(\"build_call_shim: sig={:?}\", sig);\n \n-    let mut local_decls = local_decls_for_sig(&sig);\n+    let mut local_decls = local_decls_for_sig(&sig, span);\n     let source_info = SourceInfo { span, scope: ARGUMENT_VISIBILITY_SCOPE };\n \n     let rcvr_arg = Local::new(1+0);\n@@ -317,7 +321,8 @@ fn build_call_shim<'a, 'tcx>(tcx: ty::TyCtxt<'a, 'tcx, 'tcx>,\n                 tcx.mk_ref(re_erased, ty::TypeAndMut {\n                     ty: sig.inputs()[0],\n                     mutbl: hir::Mutability::MutMutable\n-                })\n+                }),\n+                span\n             ));\n             statements.push(Statement {\n                 source_info: source_info,\n@@ -442,7 +447,7 @@ pub fn build_adt_ctor<'a, 'gcx, 'tcx>(infcx: &infer::InferCtxt<'a, 'gcx, 'tcx>,\n \n     debug!(\"build_ctor: def_id={:?} sig={:?} fields={:?}\", def_id, sig, fields);\n \n-    let local_decls = local_decls_for_sig(&sig);\n+    let local_decls = local_decls_for_sig(&sig, span);\n \n     let source_info = SourceInfo {\n         span: span,"}, {"sha": "ac2bdaad24f766a397d2f5c53da0b3bc0bf877f1", "filename": "src/librustc_mir/transform/inline.rs", "status": "modified", "additions": 6, "deletions": 9, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Finline.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -461,11 +461,8 @@ impl<'a, 'tcx> Inliner<'a, 'tcx> {\n                 for loc in callee_mir.vars_and_temps_iter() {\n                     let mut local = callee_mir.local_decls[loc].clone();\n \n-                    if let Some(ref mut source_info) = local.source_info {\n-                        source_info.scope = scope_map[source_info.scope];\n-\n-                        source_info.span = callsite.location.span;\n-                    }\n+                    local.source_info.scope = scope_map[local.source_info.scope];\n+                    local.source_info.span = callsite.location.span;\n \n                     let idx = caller_mir.local_decls.push(local);\n                     local_map.push(idx);\n@@ -506,7 +503,7 @@ impl<'a, 'tcx> Inliner<'a, 'tcx> {\n \n                     let ty = dest.ty(caller_mir, self.tcx);\n \n-                    let temp = LocalDecl::new_temp(ty);\n+                    let temp = LocalDecl::new_temp(ty, callsite.location.span);\n \n                     let tmp = caller_mir.local_decls.push(temp);\n                     let tmp = Lvalue::Local(tmp);\n@@ -590,7 +587,7 @@ impl<'a, 'tcx> Inliner<'a, 'tcx> {\n             arg.deref());\n \n         let ty = arg.ty(caller_mir, self.tcx);\n-        let ref_tmp = LocalDecl::new_temp(ty);\n+        let ref_tmp = LocalDecl::new_temp(ty, callsite.location.span);\n         let ref_tmp = caller_mir.local_decls.push(ref_tmp);\n         let ref_tmp = Lvalue::Local(ref_tmp);\n \n@@ -611,7 +608,7 @@ impl<'a, 'tcx> Inliner<'a, 'tcx> {\n \n         let raw_ptr = Rvalue::Cast(CastKind::Misc, Operand::Consume(ref_tmp), ptr_ty);\n \n-        let cast_tmp = LocalDecl::new_temp(ptr_ty);\n+        let cast_tmp = LocalDecl::new_temp(ptr_ty, callsite.location.span);\n         let cast_tmp = caller_mir.local_decls.push(cast_tmp);\n         let cast_tmp = Lvalue::Local(cast_tmp);\n \n@@ -645,7 +642,7 @@ impl<'a, 'tcx> Inliner<'a, 'tcx> {\n \n             let ty = arg.ty(caller_mir, tcx);\n \n-            let arg_tmp = LocalDecl::new_temp(ty);\n+            let arg_tmp = LocalDecl::new_temp(ty, callsite.location.span);\n             let arg_tmp = caller_mir.local_decls.push(arg_tmp);\n             let arg_tmp = Lvalue::Local(arg_tmp);\n "}, {"sha": "ed9a0d3809f245886e0aa6e41bee1c7f76ba3d7f", "filename": "src/librustc_mir/transform/promote_consts.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -208,7 +208,8 @@ impl<'a, 'tcx> Promoter<'a, 'tcx> {\n \n         let no_stmts = self.source[loc.block].statements.len();\n         let new_temp = self.promoted.local_decls.push(\n-            LocalDecl::new_temp(self.source.local_decls[temp].ty));\n+            LocalDecl::new_temp(self.source.local_decls[temp].ty,\n+                                self.source.local_decls[temp].source_info.span));\n \n         debug!(\"promote({:?} @ {:?}/{:?}, {:?})\",\n                temp, loc, no_stmts, self.keep_original);\n@@ -379,7 +380,8 @@ pub fn promote_candidates<'a, 'tcx>(mir: &mut Mir<'tcx>,\n         };\n \n         // Declare return pointer local\n-        let initial_locals = iter::once(LocalDecl::new_return_pointer(ty)).collect();\n+        let initial_locals = iter::once(LocalDecl::new_return_pointer(ty, span))\n+            .collect();\n \n         let mut promoter = Promoter {\n             promoted: Mir::new("}, {"sha": "1313b24fa74f5eecc5311586c9f12e10f406b51c", "filename": "src/librustc_mir/transform/qualify_consts.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -881,7 +881,7 @@ impl<'a, 'tcx> Visitor<'tcx> for Qualifier<'a, 'tcx, 'tcx> {\n                 // Avoid a generic error for other uses of arguments.\n                 if self.qualif.intersects(Qualif::FN_ARGUMENT) {\n                     let decl = &self.mir.local_decls[index];\n-                    span_err!(self.tcx.sess, decl.source_info.unwrap().span, E0022,\n+                    span_err!(self.tcx.sess, decl.source_info.span, E0022,\n                               \"arguments of constant functions can only \\\n                                be immutable by-value bindings\");\n                     return;"}, {"sha": "04a1fc891cf1e582e2ef50d2b4271bf8df16bd6c", "filename": "src/librustc_mir/util/elaborate_drops.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Futil%2Felaborate_drops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Futil%2Felaborate_drops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Felaborate_drops.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -686,7 +686,7 @@ impl<'l, 'b, 'tcx, D> DropCtxt<'l, 'b, 'tcx, D>\n     }\n \n     fn new_temp(&mut self, ty: Ty<'tcx>) -> Local {\n-        self.elaborator.patch().new_temp(ty)\n+        self.elaborator.patch().new_temp(ty, self.source_info.span)\n     }\n \n     fn terminator_loc(&mut self, bb: BasicBlock) -> Location {"}, {"sha": "7898d93c22e3b7cec2b167b0a06afa5f30d592fd", "filename": "src/librustc_mir/util/patch.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Futil%2Fpatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Futil%2Fpatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Fpatch.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -11,6 +11,7 @@\n use rustc::ty::Ty;\n use rustc::mir::*;\n use rustc_data_structures::indexed_vec::{IndexVec, Idx};\n+use syntax_pos::Span;\n \n /// This struct represents a patch to MIR, which can add\n /// new statements and basic blocks and patch over block\n@@ -92,10 +93,10 @@ impl<'tcx> MirPatch<'tcx> {\n         }\n     }\n \n-    pub fn new_temp(&mut self, ty: Ty<'tcx>) -> Local {\n+    pub fn new_temp(&mut self, ty: Ty<'tcx>, span: Span) -> Local {\n         let index = self.next_local;\n         self.next_local += 1;\n-        self.new_locals.push(LocalDecl::new_temp(ty));\n+        self.new_locals.push(LocalDecl::new_temp(ty, span));\n         Local::new(index as usize)\n     }\n "}, {"sha": "b202e1495104e52f82973fe2015940e2d4e8340a", "filename": "src/librustc_mir/util/pretty.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Futil%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_mir%2Futil%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Fpretty.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -196,8 +196,8 @@ fn write_scope_tree(tcx: TyCtxt,\n         // User variable types (including the user's name in a comment).\n         for local in mir.vars_iter() {\n             let var = &mir.local_decls[local];\n-            let (name, source_info) = if var.source_info.unwrap().scope == child {\n-                (var.name.unwrap(), var.source_info.unwrap())\n+            let (name, source_info) = if var.source_info.scope == child {\n+                (var.name.unwrap(), var.source_info)\n             } else {\n                 // Not a variable or not declared in this scope.\n                 continue;"}, {"sha": "3d074c31c8a32f23c215dbb061b25330083272e3", "filename": "src/librustc_trans/debuginfo/create_scope_map.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_trans%2Fdebuginfo%2Fcreate_scope_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_trans%2Fdebuginfo%2Fcreate_scope_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fdebuginfo%2Fcreate_scope_map.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -65,7 +65,7 @@ pub fn create_mir_scopes(ccx: &CrateContext, mir: &Mir, debug_context: &Function\n     let mut has_variables = BitVector::new(mir.visibility_scopes.len());\n     for var in mir.vars_iter() {\n         let decl = &mir.local_decls[var];\n-        has_variables.insert(decl.source_info.unwrap().scope.index());\n+        has_variables.insert(decl.source_info.scope.index());\n     }\n \n     // Instantiate all scopes."}, {"sha": "892a27e4550a74a264bab2eed6d57c1563cceaf0", "filename": "src/librustc_trans/mir/mod.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_trans%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/384ec80d2b3dd61a5f9910dc660bffea8710002e/src%2Flibrustc_trans%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fmir%2Fmod.rs?ref=384ec80d2b3dd61a5f9910dc660bffea8710002e", "patch": "@@ -255,8 +255,7 @@ pub fn trans_mir<'a, 'tcx: 'a>(\n \n             if let Some(name) = decl.name {\n                 // User variable\n-                let source_info = decl.source_info.unwrap();\n-                let debug_scope = mircx.scopes[source_info.scope];\n+                let debug_scope = mircx.scopes[decl.source_info.scope];\n                 let dbg = debug_scope.is_valid() && bcx.sess().opts.debuginfo == FullDebugInfo;\n \n                 if !lvalue_locals.contains(local.index()) && !dbg {\n@@ -268,7 +267,7 @@ pub fn trans_mir<'a, 'tcx: 'a>(\n                 assert!(!ty.has_erasable_regions());\n                 let lvalue = LvalueRef::alloca(&bcx, ty, &name.as_str());\n                 if dbg {\n-                    let (scope, span) = mircx.debug_loc(source_info);\n+                    let (scope, span) = mircx.debug_loc(decl.source_info);\n                     declare_local(&bcx, &mircx.debug_context, name, ty, scope,\n                         VariableAccess::DirectVariable { alloca: lvalue.llval },\n                         VariableKind::LocalVariable, span);"}]}