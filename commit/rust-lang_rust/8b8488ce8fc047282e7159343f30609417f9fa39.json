{"sha": "8b8488ce8fc047282e7159343f30609417f9fa39", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhiODQ4OGNlOGZjMDQ3MjgyZTcxNTkzNDNmMzA2MDk0MTdmOWZhMzk=", "commit": {"author": {"name": "Jorge Aparicio", "email": "jorge@japaric.io", "date": "2019-03-24T16:49:49Z"}, "committer": {"name": "Jorge Aparicio", "email": "jorge@japaric.io", "date": "2019-03-24T16:49:49Z"}, "message": "bootstrap: build compiler-builtins with -Z emit-stack-sizes", "tree": {"sha": "adae41e98f717af2bb8aa85bca06bce2b305af5a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/adae41e98f717af2bb8aa85bca06bce2b305af5a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8b8488ce8fc047282e7159343f30609417f9fa39", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8b8488ce8fc047282e7159343f30609417f9fa39", "html_url": "https://github.com/rust-lang/rust/commit/8b8488ce8fc047282e7159343f30609417f9fa39", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8b8488ce8fc047282e7159343f30609417f9fa39/comments", "author": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "committer": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fb5ed488ff1a251db895c545592488a67be67112", "url": "https://api.github.com/repos/rust-lang/rust/commits/fb5ed488ff1a251db895c545592488a67be67112", "html_url": "https://github.com/rust-lang/rust/commit/fb5ed488ff1a251db895c545592488a67be67112"}], "stats": {"total": 24, "additions": 24, "deletions": 0}, "files": [{"sha": "6f68775a85fd38b0412f6dfae54acb53dc60a12c", "filename": "src/bootstrap/bin/rustc.rs", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/8b8488ce8fc047282e7159343f30609417f9fa39/src%2Fbootstrap%2Fbin%2Frustc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8b8488ce8fc047282e7159343f30609417f9fa39/src%2Fbootstrap%2Fbin%2Frustc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Frustc.rs?ref=8b8488ce8fc047282e7159343f30609417f9fa39", "patch": "@@ -181,6 +181,30 @@ fn main() {\n             cmd.arg(\"-C\").arg(format!(\"debug-assertions={}\", debug_assertions));\n         }\n \n+        // Build `compiler_builtins` with `-Z emit-stack-sizes` to add stack usage information.\n+        //\n+        // When you use this flag with Cargo you get stack usage information on all crates compiled\n+        // from source, and when you are using LTO you also get information on pre-compiled crates\n+        // like `core` and `std`. However, there's an exception: `compiler_builtins`. This crate\n+        // is special and doesn't participate in LTO because it's always linked as a separate object\n+        // file. Due to this it's impossible to get information about this crate using `RUSTFLAGS`\n+        // + Cargo, or `cargo rustc`.\n+        //\n+        // To make the stack usage information of this crate available to Cargo based stack usage\n+        // analysis tools we compile `compiler_builtins` with the `-Z emit-stack-sizes` flag. The\n+        // flag is known to currently work with targets that produce ELF files so we limit the use\n+        // of the flag to those targets.\n+        //\n+        // NOTE(japaric) if this ever causes problem with an LLVM upgrade or any PR feel free to\n+        // remove it or comment it out\n+        if crate_name == \"compiler_builtins\"\n+            && (target.contains(\"-linux-\")\n+                || target.contains(\"-none-eabi\")\n+                || target.ends_with(\"-none-elf\"))\n+        {\n+            cmd.arg(\"-Z\").arg(\"emit-stack-sizes\");\n+        }\n+\n         if let Ok(s) = env::var(\"RUSTC_CODEGEN_UNITS\") {\n             cmd.arg(\"-C\").arg(format!(\"codegen-units={}\", s));\n         }"}]}