{"sha": "fd59d058ec10b5c4cca977240b1f82ac99482166", "node_id": "C_kwDOAAsO6NoAKGZkNTlkMDU4ZWMxMGI1YzRjY2E5NzcyNDBiMWY4MmFjOTk0ODIxNjY", "commit": {"author": {"name": "lcnr", "email": "rust@lcnr.de", "date": "2022-07-25T17:27:52Z"}, "committer": {"name": "lcnr", "email": "rust@lcnr.de", "date": "2022-07-28T14:13:47Z"}, "message": "`BoundVarReplacer`: trait object instead of 3 fns", "tree": {"sha": "90b86693a25dba5f0043395d464fb1e4a9eb518b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/90b86693a25dba5f0043395d464fb1e4a9eb518b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fd59d058ec10b5c4cca977240b1f82ac99482166", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fd59d058ec10b5c4cca977240b1f82ac99482166", "html_url": "https://github.com/rust-lang/rust/commit/fd59d058ec10b5c4cca977240b1f82ac99482166", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fd59d058ec10b5c4cca977240b1f82ac99482166/comments", "author": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "05e678ccca974a8d0c26991083fb4cf8fff84e74", "url": "https://api.github.com/repos/rust-lang/rust/commits/05e678ccca974a8d0c26991083fb4cf8fff84e74", "html_url": "https://github.com/rust-lang/rust/commit/05e678ccca974a8d0c26991083fb4cf8fff84e74"}], "stats": {"total": 292, "additions": 164, "deletions": 128}, "files": [{"sha": "34b6113427d489a0b1ab9d588e6184086363c69b", "filename": "compiler/rustc_infer/src/infer/canonical/substitute.rs", "status": "modified", "additions": 15, "deletions": 15, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/fd59d058ec10b5c4cca977240b1f82ac99482166/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fcanonical%2Fsubstitute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd59d058ec10b5c4cca977240b1f82ac99482166/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fcanonical%2Fsubstitute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fcanonical%2Fsubstitute.rs?ref=fd59d058ec10b5c4cca977240b1f82ac99482166", "patch": "@@ -7,7 +7,7 @@\n //! [c]: https://rust-lang.github.io/chalk/book/canonical_queries/canonicalization.html\n \n use crate::infer::canonical::{Canonical, CanonicalVarValues};\n-use rustc_middle::ty::fold::TypeFoldable;\n+use rustc_middle::ty::fold::{FnMutDelegate, TypeFoldable};\n use rustc_middle::ty::subst::GenericArgKind;\n use rustc_middle::ty::{self, TyCtxt};\n \n@@ -71,21 +71,21 @@ where\n     if var_values.var_values.is_empty() {\n         value\n     } else {\n-        let fld_r = |br: ty::BoundRegion| match var_values.var_values[br.var].unpack() {\n-            GenericArgKind::Lifetime(l) => l,\n-            r => bug!(\"{:?} is a region but value is {:?}\", br, r),\n+        let delegate = FnMutDelegate {\n+            regions: |br: ty::BoundRegion| match var_values.var_values[br.var].unpack() {\n+                GenericArgKind::Lifetime(l) => l,\n+                r => bug!(\"{:?} is a region but value is {:?}\", br, r),\n+            },\n+            types: |bound_ty: ty::BoundTy| match var_values.var_values[bound_ty.var].unpack() {\n+                GenericArgKind::Type(ty) => ty,\n+                r => bug!(\"{:?} is a type but value is {:?}\", bound_ty, r),\n+            },\n+            consts: |bound_ct: ty::BoundVar, _| match var_values.var_values[bound_ct].unpack() {\n+                GenericArgKind::Const(ct) => ct,\n+                c => bug!(\"{:?} is a const but value is {:?}\", bound_ct, c),\n+            },\n         };\n \n-        let fld_t = |bound_ty: ty::BoundTy| match var_values.var_values[bound_ty.var].unpack() {\n-            GenericArgKind::Type(ty) => ty,\n-            r => bug!(\"{:?} is a type but value is {:?}\", bound_ty, r),\n-        };\n-\n-        let fld_c = |bound_ct: ty::BoundVar, _| match var_values.var_values[bound_ct].unpack() {\n-            GenericArgKind::Const(ct) => ct,\n-            c => bug!(\"{:?} is a const but value is {:?}\", bound_ct, c),\n-        };\n-\n-        tcx.replace_escaping_bound_vars_uncached(value, fld_r, fld_t, fld_c)\n+        tcx.replace_escaping_bound_vars_uncached(value, delegate)\n     }\n }"}, {"sha": "ed257c144e0aacb3b1d9cf2d7da7cd2f907d7123", "filename": "compiler/rustc_infer/src/infer/higher_ranked/mod.rs", "status": "modified", "additions": 23, "deletions": 22, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/fd59d058ec10b5c4cca977240b1f82ac99482166/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fhigher_ranked%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd59d058ec10b5c4cca977240b1f82ac99482166/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fhigher_ranked%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fhigher_ranked%2Fmod.rs?ref=fd59d058ec10b5c4cca977240b1f82ac99482166", "patch": "@@ -4,6 +4,7 @@\n use super::combine::CombineFields;\n use super::{HigherRankedType, InferCtxt};\n use crate::infer::CombinedSnapshot;\n+use rustc_middle::ty::fold::FnMutDelegate;\n use rustc_middle::ty::relate::{Relate, RelateResult, TypeRelation};\n use rustc_middle::ty::{self, Binder, TypeFoldable};\n \n@@ -79,31 +80,31 @@ impl<'a, 'tcx> InferCtxt<'a, 'tcx> {\n \n         let next_universe = self.create_next_universe();\n \n-        let fld_r = |br: ty::BoundRegion| {\n-            self.tcx.mk_region(ty::RePlaceholder(ty::PlaceholderRegion {\n-                universe: next_universe,\n-                name: br.kind,\n-            }))\n-        };\n-\n-        let fld_t = |bound_ty: ty::BoundTy| {\n-            self.tcx.mk_ty(ty::Placeholder(ty::PlaceholderType {\n-                universe: next_universe,\n-                name: bound_ty.var,\n-            }))\n-        };\n-\n-        let fld_c = |bound_var: ty::BoundVar, ty| {\n-            self.tcx.mk_const(ty::ConstS {\n-                kind: ty::ConstKind::Placeholder(ty::PlaceholderConst {\n+        let delegate = FnMutDelegate {\n+            regions: |br: ty::BoundRegion| {\n+                self.tcx.mk_region(ty::RePlaceholder(ty::PlaceholderRegion {\n+                    universe: next_universe,\n+                    name: br.kind,\n+                }))\n+            },\n+            types: |bound_ty: ty::BoundTy| {\n+                self.tcx.mk_ty(ty::Placeholder(ty::PlaceholderType {\n                     universe: next_universe,\n-                    name: ty::BoundConst { var: bound_var, ty },\n-                }),\n-                ty,\n-            })\n+                    name: bound_ty.var,\n+                }))\n+            },\n+            consts: |bound_var: ty::BoundVar, ty| {\n+                self.tcx.mk_const(ty::ConstS {\n+                    kind: ty::ConstKind::Placeholder(ty::PlaceholderConst {\n+                        universe: next_universe,\n+                        name: ty::BoundConst { var: bound_var, ty },\n+                    }),\n+                    ty,\n+                })\n+            },\n         };\n \n-        let result = self.tcx.replace_bound_vars_uncached(binder, fld_r, fld_t, fld_c);\n+        let result = self.tcx.replace_bound_vars_uncached(binder, delegate);\n         debug!(?next_universe, ?result);\n         result\n     }"}, {"sha": "21045a0585c625eafe4621637eb38bfbbd8e505f", "filename": "compiler/rustc_infer/src/infer/mod.rs", "status": "modified", "additions": 50, "deletions": 25, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/fd59d058ec10b5c4cca977240b1f82ac99482166/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd59d058ec10b5c4cca977240b1f82ac99482166/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fmod.rs?ref=fd59d058ec10b5c4cca977240b1f82ac99482166", "patch": "@@ -23,6 +23,7 @@ use rustc_middle::mir::interpret::{ErrorHandled, EvalToValTreeResult};\n use rustc_middle::traits::select;\n use rustc_middle::ty::abstract_const::{AbstractConst, FailureKind};\n use rustc_middle::ty::error::{ExpectedFound, TypeError};\n+use rustc_middle::ty::fold::BoundVarReplacerDelegate;\n use rustc_middle::ty::fold::{TypeFoldable, TypeFolder, TypeSuperFoldable};\n use rustc_middle::ty::relate::RelateResult;\n use rustc_middle::ty::subst::{GenericArg, GenericArgKind, InternalSubsts, SubstsRef};\n@@ -1564,32 +1565,56 @@ impl<'a, 'tcx> InferCtxt<'a, 'tcx> {\n             return inner;\n         }\n \n-        let mut region_map = FxHashMap::default();\n-        let fld_r = |br: ty::BoundRegion| {\n-            *region_map\n-                .entry(br)\n-                .or_insert_with(|| self.next_region_var(LateBoundRegion(span, br.kind, lbrct)))\n-        };\n+        struct ToFreshVars<'a, 'tcx> {\n+            infcx: &'a InferCtxt<'a, 'tcx>,\n+            span: Span,\n+            lbrct: LateBoundRegionConversionTime,\n+            map: FxHashMap<ty::BoundVar, ty::GenericArg<'tcx>>,\n+        }\n \n-        let mut ty_map = FxHashMap::default();\n-        let fld_t = |bt: ty::BoundTy| {\n-            *ty_map.entry(bt).or_insert_with(|| {\n-                self.next_ty_var(TypeVariableOrigin {\n-                    kind: TypeVariableOriginKind::MiscVariable,\n-                    span,\n-                })\n-            })\n-        };\n-        let mut ct_map = FxHashMap::default();\n-        let fld_c = |bc: ty::BoundVar, ty| {\n-            *ct_map.entry(bc).or_insert_with(|| {\n-                self.next_const_var(\n-                    ty,\n-                    ConstVariableOrigin { kind: ConstVariableOriginKind::MiscVariable, span },\n-                )\n-            })\n-        };\n-        self.tcx.replace_bound_vars_uncached(value, fld_r, fld_t, fld_c)\n+        impl<'tcx> BoundVarReplacerDelegate<'tcx> for ToFreshVars<'_, 'tcx> {\n+            fn replace_region(&mut self, br: ty::BoundRegion) -> ty::Region<'tcx> {\n+                self.map\n+                    .entry(br.var)\n+                    .or_insert_with(|| {\n+                        self.infcx\n+                            .next_region_var(LateBoundRegion(self.span, br.kind, self.lbrct))\n+                            .into()\n+                    })\n+                    .expect_region()\n+            }\n+            fn replace_ty(&mut self, bt: ty::BoundTy) -> Ty<'tcx> {\n+                self.map\n+                    .entry(bt.var)\n+                    .or_insert_with(|| {\n+                        self.infcx\n+                            .next_ty_var(TypeVariableOrigin {\n+                                kind: TypeVariableOriginKind::MiscVariable,\n+                                span: self.span,\n+                            })\n+                            .into()\n+                    })\n+                    .expect_ty()\n+            }\n+            fn replace_const(&mut self, bv: ty::BoundVar, ty: Ty<'tcx>) -> ty::Const<'tcx> {\n+                self.map\n+                    .entry(bv)\n+                    .or_insert_with(|| {\n+                        self.infcx\n+                            .next_const_var(\n+                                ty,\n+                                ConstVariableOrigin {\n+                                    kind: ConstVariableOriginKind::MiscVariable,\n+                                    span: self.span,\n+                                },\n+                            )\n+                            .into()\n+                    })\n+                    .expect_const()\n+            }\n+        }\n+        let delegate = ToFreshVars { infcx: self, span, lbrct, map: Default::default() };\n+        self.tcx.replace_bound_vars_uncached(value, delegate)\n     }\n \n     /// See the [`region_constraints::RegionConstraintCollector::verify_generic_bound`] method."}, {"sha": "273604fc22139e4d13a29f32dea89ff098637aa0", "filename": "compiler/rustc_middle/src/ty/fold.rs", "status": "modified", "additions": 68, "deletions": 66, "changes": 134, "blob_url": "https://github.com/rust-lang/rust/blob/fd59d058ec10b5c4cca977240b1f82ac99482166/compiler%2Frustc_middle%2Fsrc%2Fty%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd59d058ec10b5c4cca977240b1f82ac99482166/compiler%2Frustc_middle%2Fsrc%2Fty%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Ffold.rs?ref=fd59d058ec10b5c4cca977240b1f82ac99482166", "patch": "@@ -370,6 +370,34 @@ impl<'a, 'tcx> TypeFolder<'tcx> for RegionFolder<'a, 'tcx> {\n ///////////////////////////////////////////////////////////////////////////\n // Bound vars replacer\n \n+pub trait BoundVarReplacerDelegate<'tcx> {\n+    fn replace_region(&mut self, br: ty::BoundRegion) -> ty::Region<'tcx>;\n+    fn replace_ty(&mut self, bt: ty::BoundTy) -> Ty<'tcx>;\n+    fn replace_const(&mut self, bv: ty::BoundVar, ty: Ty<'tcx>) -> ty::Const<'tcx>;\n+}\n+\n+pub struct FnMutDelegate<R, T, C> {\n+    pub regions: R,\n+    pub types: T,\n+    pub consts: C,\n+}\n+impl<'tcx, R, T, C> BoundVarReplacerDelegate<'tcx> for FnMutDelegate<R, T, C>\n+where\n+    R: FnMut(ty::BoundRegion) -> ty::Region<'tcx>,\n+    T: FnMut(ty::BoundTy) -> Ty<'tcx>,\n+    C: FnMut(ty::BoundVar, Ty<'tcx>) -> ty::Const<'tcx>,\n+{\n+    fn replace_region(&mut self, br: ty::BoundRegion) -> ty::Region<'tcx> {\n+        (self.regions)(br)\n+    }\n+    fn replace_ty(&mut self, bt: ty::BoundTy) -> Ty<'tcx> {\n+        (self.types)(bt)\n+    }\n+    fn replace_const(&mut self, bv: ty::BoundVar, ty: Ty<'tcx>) -> ty::Const<'tcx> {\n+        (self.consts)(bv, ty)\n+    }\n+}\n+\n /// Replaces the escaping bound vars (late bound regions or bound types) in a type.\n struct BoundVarReplacer<'a, 'tcx> {\n     tcx: TyCtxt<'tcx>,\n@@ -378,19 +406,12 @@ struct BoundVarReplacer<'a, 'tcx> {\n     /// the ones we have visited.\n     current_index: ty::DebruijnIndex,\n \n-    fld_r: &'a mut (dyn FnMut(ty::BoundRegion) -> ty::Region<'tcx> + 'a),\n-    fld_t: &'a mut (dyn FnMut(ty::BoundTy) -> Ty<'tcx> + 'a),\n-    fld_c: &'a mut (dyn FnMut(ty::BoundVar, Ty<'tcx>) -> ty::Const<'tcx> + 'a),\n+    delegate: &'a mut dyn BoundVarReplacerDelegate<'tcx>,\n }\n \n impl<'a, 'tcx> BoundVarReplacer<'a, 'tcx> {\n-    fn new(\n-        tcx: TyCtxt<'tcx>,\n-        fld_r: &'a mut (dyn FnMut(ty::BoundRegion) -> ty::Region<'tcx> + 'a),\n-        fld_t: &'a mut (dyn FnMut(ty::BoundTy) -> Ty<'tcx> + 'a),\n-        fld_c: &'a mut (dyn FnMut(ty::BoundVar, Ty<'tcx>) -> ty::Const<'tcx> + 'a),\n-    ) -> Self {\n-        BoundVarReplacer { tcx, current_index: ty::INNERMOST, fld_r, fld_t, fld_c }\n+    fn new(tcx: TyCtxt<'tcx>, delegate: &'a mut dyn BoundVarReplacerDelegate<'tcx>) -> Self {\n+        BoundVarReplacer { tcx, current_index: ty::INNERMOST, delegate }\n     }\n }\n \n@@ -412,7 +433,7 @@ impl<'a, 'tcx> TypeFolder<'tcx> for BoundVarReplacer<'a, 'tcx> {\n     fn fold_ty(&mut self, t: Ty<'tcx>) -> Ty<'tcx> {\n         match *t.kind() {\n             ty::Bound(debruijn, bound_ty) if debruijn == self.current_index => {\n-                let ty = (self.fld_t)(bound_ty);\n+                let ty = self.delegate.replace_ty(bound_ty);\n                 ty::fold::shift_vars(self.tcx, ty, self.current_index.as_u32())\n             }\n             _ if t.has_vars_bound_at_or_above(self.current_index) => t.super_fold_with(self),\n@@ -423,7 +444,7 @@ impl<'a, 'tcx> TypeFolder<'tcx> for BoundVarReplacer<'a, 'tcx> {\n     fn fold_region(&mut self, r: ty::Region<'tcx>) -> ty::Region<'tcx> {\n         match *r {\n             ty::ReLateBound(debruijn, br) if debruijn == self.current_index => {\n-                let region = (self.fld_r)(br);\n+                let region = self.delegate.replace_region(br);\n                 if let ty::ReLateBound(debruijn1, br) = *region {\n                     // If the callback returns a late-bound region,\n                     // that region should always use the INNERMOST\n@@ -442,7 +463,7 @@ impl<'a, 'tcx> TypeFolder<'tcx> for BoundVarReplacer<'a, 'tcx> {\n     fn fold_const(&mut self, ct: ty::Const<'tcx>) -> ty::Const<'tcx> {\n         match ct.kind() {\n             ty::ConstKind::Bound(debruijn, bound_const) if debruijn == self.current_index => {\n-                let ct = (self.fld_c)(bound_const, ct.ty());\n+                let ct = self.delegate.replace_const(bound_const, ct.ty());\n                 ty::fold::shift_vars(self.tcx, ct, self.current_index.as_u32())\n             }\n             _ => ct.super_fold_with(self),\n@@ -486,64 +507,51 @@ impl<'tcx> TyCtxt<'tcx> {\n     pub fn replace_late_bound_regions_uncached<T, F>(\n         self,\n         value: Binder<'tcx, T>,\n-        mut fld_r: F,\n+        replace_regions: F,\n     ) -> T\n     where\n         F: FnMut(ty::BoundRegion) -> ty::Region<'tcx>,\n         T: TypeFoldable<'tcx>,\n     {\n-        let mut fld_t = |b| bug!(\"unexpected bound ty in binder: {b:?}\");\n-        let mut fld_c = |b, ty| bug!(\"unexpected bound ct in binder: {b:?} {ty}\");\n         let value = value.skip_binder();\n         if !value.has_escaping_bound_vars() {\n             value\n         } else {\n-            let mut replacer = BoundVarReplacer::new(self, &mut fld_r, &mut fld_t, &mut fld_c);\n+            let mut delegate = FnMutDelegate {\n+                regions: replace_regions,\n+                types: |b| bug!(\"unexpected bound ty in binder: {b:?}\"),\n+                consts: |b, ty| bug!(\"unexpected bound ct in binder: {b:?} {ty}\"),\n+            };\n+            let mut replacer = BoundVarReplacer::new(self, &mut delegate);\n             value.fold_with(&mut replacer)\n         }\n     }\n \n     /// Replaces all escaping bound vars. The `fld_r` closure replaces escaping\n     /// bound regions; the `fld_t` closure replaces escaping bound types and the `fld_c`\n     /// closure replaces escaping bound consts.\n-    pub fn replace_escaping_bound_vars_uncached<T, F, G, H>(\n+    pub fn replace_escaping_bound_vars_uncached<T: TypeFoldable<'tcx>>(\n         self,\n         value: T,\n-        mut fld_r: F,\n-        mut fld_t: G,\n-        mut fld_c: H,\n-    ) -> T\n-    where\n-        F: FnMut(ty::BoundRegion) -> ty::Region<'tcx>,\n-        G: FnMut(ty::BoundTy) -> Ty<'tcx>,\n-        H: FnMut(ty::BoundVar, Ty<'tcx>) -> ty::Const<'tcx>,\n-        T: TypeFoldable<'tcx>,\n-    {\n+        mut delegate: impl BoundVarReplacerDelegate<'tcx>,\n+    ) -> T {\n         if !value.has_escaping_bound_vars() {\n             value\n         } else {\n-            let mut replacer = BoundVarReplacer::new(self, &mut fld_r, &mut fld_t, &mut fld_c);\n+            let mut replacer = BoundVarReplacer::new(self, &mut delegate);\n             value.fold_with(&mut replacer)\n         }\n     }\n \n     /// Replaces all types or regions bound by the given `Binder`. The `fld_r`\n     /// closure replaces bound regions, the `fld_t` closure replaces bound\n     /// types, and `fld_c` replaces bound constants.\n-    pub fn replace_bound_vars_uncached<T, F, G, H>(\n+    pub fn replace_bound_vars_uncached<T: TypeFoldable<'tcx>>(\n         self,\n         value: Binder<'tcx, T>,\n-        fld_r: F,\n-        fld_t: G,\n-        fld_c: H,\n-    ) -> T\n-    where\n-        F: FnMut(ty::BoundRegion) -> ty::Region<'tcx>,\n-        G: FnMut(ty::BoundTy) -> Ty<'tcx>,\n-        H: FnMut(ty::BoundVar, Ty<'tcx>) -> ty::Const<'tcx>,\n-        T: TypeFoldable<'tcx>,\n-    {\n-        self.replace_escaping_bound_vars_uncached(value.skip_binder(), fld_r, fld_t, fld_c)\n+        delegate: impl BoundVarReplacerDelegate<'tcx>,\n+    ) -> T {\n+        self.replace_escaping_bound_vars_uncached(value.skip_binder(), delegate)\n     }\n \n     /// Replaces any late-bound regions bound in `value` with\n@@ -568,34 +576,28 @@ impl<'tcx> TyCtxt<'tcx> {\n     where\n         T: TypeFoldable<'tcx>,\n     {\n+        let shift_bv = |bv: ty::BoundVar| ty::BoundVar::from_usize(bv.as_usize() + bound_vars);\n         self.replace_escaping_bound_vars_uncached(\n             value,\n-            |r| {\n-                self.mk_region(ty::ReLateBound(\n-                    ty::INNERMOST,\n-                    ty::BoundRegion {\n-                        var: ty::BoundVar::from_usize(r.var.as_usize() + bound_vars),\n-                        kind: r.kind,\n-                    },\n-                ))\n-            },\n-            |t| {\n-                self.mk_ty(ty::Bound(\n-                    ty::INNERMOST,\n-                    ty::BoundTy {\n-                        var: ty::BoundVar::from_usize(t.var.as_usize() + bound_vars),\n-                        kind: t.kind,\n-                    },\n-                ))\n-            },\n-            |c, ty| {\n-                self.mk_const(ty::ConstS {\n-                    kind: ty::ConstKind::Bound(\n+            FnMutDelegate {\n+                regions: |r: ty::BoundRegion| {\n+                    self.mk_region(ty::ReLateBound(\n                         ty::INNERMOST,\n-                        ty::BoundVar::from_usize(c.as_usize() + bound_vars),\n-                    ),\n-                    ty,\n-                })\n+                        ty::BoundRegion { var: shift_bv(r.var), kind: r.kind },\n+                    ))\n+                },\n+                types: |t: ty::BoundTy| {\n+                    self.mk_ty(ty::Bound(\n+                        ty::INNERMOST,\n+                        ty::BoundTy { var: shift_bv(t.var), kind: t.kind },\n+                    ))\n+                },\n+                consts: |c, ty: Ty<'tcx>| {\n+                    self.mk_const(ty::ConstS {\n+                        kind: ty::ConstKind::Bound(ty::INNERMOST, shift_bv(c)),\n+                        ty,\n+                    })\n+                },\n             },\n         )\n     }"}, {"sha": "6262aa180757786a22ed16d2a677f1f577198878", "filename": "compiler/rustc_middle/src/ty/subst.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/fd59d058ec10b5c4cca977240b1f82ac99482166/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsubst.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd59d058ec10b5c4cca977240b1f82ac99482166/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsubst.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsubst.rs?ref=fd59d058ec10b5c4cca977240b1f82ac99482166", "patch": "@@ -164,6 +164,14 @@ impl<'tcx> GenericArg<'tcx> {\n         }\n     }\n \n+    /// Unpack the `GenericArg` as a region when it is known certainly to be a region.\n+    pub fn expect_region(self) -> ty::Region<'tcx> {\n+        match self.unpack() {\n+            GenericArgKind::Lifetime(lt) => lt,\n+            _ => bug!(\"expected a region, but found another kind\"),\n+        }\n+    }\n+\n     /// Unpack the `GenericArg` as a type when it is known certainly to be a type.\n     /// This is true in cases where `Substs` is used in places where the kinds are known\n     /// to be limited (e.g. in tuples, where the only parameters are type parameters)."}]}