{"sha": "a06c664328c2b2793c9d6a390ec3f63a28ef7e1b", "node_id": "C_kwDOAAsO6NoAKGEwNmM2NjQzMjhjMmIyNzkzYzlkNmEzOTBlYzNmNjNhMjhlZjdlMWI", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2021-10-09T09:56:06Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-10-09T09:56:06Z"}, "message": "Rollup merge of #89687 - Nicholas-Baron:move_read2_abbreviated, r=Mark-Simulacrum\n\nMove `read2_abbreviated` function into read2.rs\n\nWork towards #89475.", "tree": {"sha": "ea0d539f9f70a5f59e3eaf431492970681b62961", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ea0d539f9f70a5f59e3eaf431492970681b62961"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a06c664328c2b2793c9d6a390ec3f63a28ef7e1b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhYWc2CRBK7hj4Ov3rIwAAhn8IAJ0P0wXBr6ePpO8si41cTDHJ\nbRZq+a4RrmHMBTXtHgDVTZLP73jvLnGVCr2Hpd9BG7C3oOq9AKgjVoeGC6cK73XT\nJ4ReNxoCCgsnpK0qt7P3iXncxnlD114vyISgPjKasoZSlVZ1PXF3cXdvDx8LMtOQ\nXGUSRviD49JyhxM3mW/YZB9vtKLvL6iND82TNCAQKQzXd+v1BxNABRFo9iIfNlTR\nAAWvBX2CL7dho/3I9m7X7i1rA0pv8m/G4YRsRgfijZcspSAxgo7JJiQPaXPvG0+u\nyNdxRe44+RvJhjdYUFCqtU0J9j8FM0QhI6q5mqneMRyZk7LgpKGt31MB8FSdMfA=\n=O41V\n-----END PGP SIGNATURE-----\n", "payload": "tree ea0d539f9f70a5f59e3eaf431492970681b62961\nparent 0481c67dd46bfdb7f82616872236f0616bc6e11a\nparent 8a4085d370a5ca6cd97887d28871ab6aa8f7fd64\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1633773366 +0200\ncommitter GitHub <noreply@github.com> 1633773366 +0200\n\nRollup merge of #89687 - Nicholas-Baron:move_read2_abbreviated, r=Mark-Simulacrum\n\nMove `read2_abbreviated` function into read2.rs\n\nWork towards #89475.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a06c664328c2b2793c9d6a390ec3f63a28ef7e1b", "html_url": "https://github.com/rust-lang/rust/commit/a06c664328c2b2793c9d6a390ec3f63a28ef7e1b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a06c664328c2b2793c9d6a390ec3f63a28ef7e1b/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0481c67dd46bfdb7f82616872236f0616bc6e11a", "url": "https://api.github.com/repos/rust-lang/rust/commits/0481c67dd46bfdb7f82616872236f0616bc6e11a", "html_url": "https://github.com/rust-lang/rust/commit/0481c67dd46bfdb7f82616872236f0616bc6e11a"}, {"sha": "8a4085d370a5ca6cd97887d28871ab6aa8f7fd64", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a4085d370a5ca6cd97887d28871ab6aa8f7fd64", "html_url": "https://github.com/rust-lang/rust/commit/8a4085d370a5ca6cd97887d28871ab6aa8f7fd64"}], "stats": {"total": 143, "additions": 73, "deletions": 70}, "files": [{"sha": "897b9dd4007939b07acded6460dc01737eb7c4d8", "filename": "src/tools/compiletest/src/read2.rs", "status": "modified", "additions": 71, "deletions": 0, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/a06c664328c2b2793c9d6a390ec3f63a28ef7e1b/src%2Ftools%2Fcompiletest%2Fsrc%2Fread2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a06c664328c2b2793c9d6a390ec3f63a28ef7e1b/src%2Ftools%2Fcompiletest%2Fsrc%2Fread2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fread2.rs?ref=a06c664328c2b2793c9d6a390ec3f63a28ef7e1b", "patch": "@@ -2,6 +2,77 @@\n // Consider unify the read2() in libstd, cargo and this to prevent further code duplication.\n \n pub use self::imp::read2;\n+use std::io;\n+use std::process::{Child, Output};\n+\n+pub fn read2_abbreviated(mut child: Child) -> io::Result<Output> {\n+    use io::Write;\n+    use std::mem::replace;\n+\n+    const HEAD_LEN: usize = 160 * 1024;\n+    const TAIL_LEN: usize = 256 * 1024;\n+\n+    enum ProcOutput {\n+        Full(Vec<u8>),\n+        Abbreviated { head: Vec<u8>, skipped: usize, tail: Box<[u8]> },\n+    }\n+\n+    impl ProcOutput {\n+        fn extend(&mut self, data: &[u8]) {\n+            let new_self = match *self {\n+                ProcOutput::Full(ref mut bytes) => {\n+                    bytes.extend_from_slice(data);\n+                    let new_len = bytes.len();\n+                    if new_len <= HEAD_LEN + TAIL_LEN {\n+                        return;\n+                    }\n+                    let tail = bytes.split_off(new_len - TAIL_LEN).into_boxed_slice();\n+                    let head = replace(bytes, Vec::new());\n+                    let skipped = new_len - HEAD_LEN - TAIL_LEN;\n+                    ProcOutput::Abbreviated { head, skipped, tail }\n+                }\n+                ProcOutput::Abbreviated { ref mut skipped, ref mut tail, .. } => {\n+                    *skipped += data.len();\n+                    if data.len() <= TAIL_LEN {\n+                        tail[..data.len()].copy_from_slice(data);\n+                        tail.rotate_left(data.len());\n+                    } else {\n+                        tail.copy_from_slice(&data[(data.len() - TAIL_LEN)..]);\n+                    }\n+                    return;\n+                }\n+            };\n+            *self = new_self;\n+        }\n+\n+        fn into_bytes(self) -> Vec<u8> {\n+            match self {\n+                ProcOutput::Full(bytes) => bytes,\n+                ProcOutput::Abbreviated { mut head, skipped, tail } => {\n+                    write!(&mut head, \"\\n\\n<<<<<< SKIPPED {} BYTES >>>>>>\\n\\n\", skipped).unwrap();\n+                    head.extend_from_slice(&tail);\n+                    head\n+                }\n+            }\n+        }\n+    }\n+\n+    let mut stdout = ProcOutput::Full(Vec::new());\n+    let mut stderr = ProcOutput::Full(Vec::new());\n+\n+    drop(child.stdin.take());\n+    read2(\n+        child.stdout.take().unwrap(),\n+        child.stderr.take().unwrap(),\n+        &mut |is_stdout, data, _| {\n+            if is_stdout { &mut stdout } else { &mut stderr }.extend(data);\n+            data.clear();\n+        },\n+    )?;\n+    let status = child.wait()?;\n+\n+    Ok(Output { status, stdout: stdout.into_bytes(), stderr: stderr.into_bytes() })\n+}\n \n #[cfg(not(any(unix, windows)))]\n mod imp {"}, {"sha": "934839bbd605b0202a7fadf64ec20393d746f953", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 2, "deletions": 70, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/a06c664328c2b2793c9d6a390ec3f63a28ef7e1b/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a06c664328c2b2793c9d6a390ec3f63a28ef7e1b/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=a06c664328c2b2793c9d6a390ec3f63a28ef7e1b", "patch": "@@ -12,6 +12,7 @@ use crate::compute_diff::{write_diff, write_filtered_diff};\n use crate::errors::{self, Error, ErrorKind};\n use crate::header::TestProps;\n use crate::json;\n+use crate::read2::read2_abbreviated;\n use crate::util::get_pointer_width;\n use crate::util::{logv, PathBufExt};\n use crate::ColorConfig;\n@@ -27,7 +28,7 @@ use std::hash::{Hash, Hasher};\n use std::io::prelude::*;\n use std::io::{self, BufReader};\n use std::path::{Path, PathBuf};\n-use std::process::{Child, Command, ExitStatus, Output, Stdio};\n+use std::process::{Command, ExitStatus, Output, Stdio};\n use std::str;\n \n use glob::glob;\n@@ -3820,72 +3821,3 @@ enum AllowUnused {\n     Yes,\n     No,\n }\n-\n-fn read2_abbreviated(mut child: Child) -> io::Result<Output> {\n-    use crate::read2::read2;\n-    use std::mem::replace;\n-\n-    const HEAD_LEN: usize = 160 * 1024;\n-    const TAIL_LEN: usize = 256 * 1024;\n-\n-    enum ProcOutput {\n-        Full(Vec<u8>),\n-        Abbreviated { head: Vec<u8>, skipped: usize, tail: Box<[u8]> },\n-    }\n-\n-    impl ProcOutput {\n-        fn extend(&mut self, data: &[u8]) {\n-            let new_self = match *self {\n-                ProcOutput::Full(ref mut bytes) => {\n-                    bytes.extend_from_slice(data);\n-                    let new_len = bytes.len();\n-                    if new_len <= HEAD_LEN + TAIL_LEN {\n-                        return;\n-                    }\n-                    let tail = bytes.split_off(new_len - TAIL_LEN).into_boxed_slice();\n-                    let head = replace(bytes, Vec::new());\n-                    let skipped = new_len - HEAD_LEN - TAIL_LEN;\n-                    ProcOutput::Abbreviated { head, skipped, tail }\n-                }\n-                ProcOutput::Abbreviated { ref mut skipped, ref mut tail, .. } => {\n-                    *skipped += data.len();\n-                    if data.len() <= TAIL_LEN {\n-                        tail[..data.len()].copy_from_slice(data);\n-                        tail.rotate_left(data.len());\n-                    } else {\n-                        tail.copy_from_slice(&data[(data.len() - TAIL_LEN)..]);\n-                    }\n-                    return;\n-                }\n-            };\n-            *self = new_self;\n-        }\n-\n-        fn into_bytes(self) -> Vec<u8> {\n-            match self {\n-                ProcOutput::Full(bytes) => bytes,\n-                ProcOutput::Abbreviated { mut head, skipped, tail } => {\n-                    write!(&mut head, \"\\n\\n<<<<<< SKIPPED {} BYTES >>>>>>\\n\\n\", skipped).unwrap();\n-                    head.extend_from_slice(&tail);\n-                    head\n-                }\n-            }\n-        }\n-    }\n-\n-    let mut stdout = ProcOutput::Full(Vec::new());\n-    let mut stderr = ProcOutput::Full(Vec::new());\n-\n-    drop(child.stdin.take());\n-    read2(\n-        child.stdout.take().unwrap(),\n-        child.stderr.take().unwrap(),\n-        &mut |is_stdout, data, _| {\n-            if is_stdout { &mut stdout } else { &mut stderr }.extend(data);\n-            data.clear();\n-        },\n-    )?;\n-    let status = child.wait()?;\n-\n-    Ok(Output { status, stdout: stdout.into_bytes(), stderr: stderr.into_bytes() })\n-}"}]}