{"sha": "91be1258993b592531e8e66181f26ad23ab5b2f4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkxYmUxMjU4OTkzYjU5MjUzMWU4ZTY2MTgxZjI2YWQyM2FiNWIyZjQ=", "commit": {"author": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2015-08-15T18:03:10Z"}, "committer": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2015-08-15T18:03:10Z"}, "message": "prevent non-dict-structs from being intialized via FRU\n\nFixes #27831", "tree": {"sha": "5ae529f6afc901c5b4d07b3d7ef5082aea8666bc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5ae529f6afc901c5b4d07b3d7ef5082aea8666bc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/91be1258993b592531e8e66181f26ad23ab5b2f4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/91be1258993b592531e8e66181f26ad23ab5b2f4", "html_url": "https://github.com/rust-lang/rust/commit/91be1258993b592531e8e66181f26ad23ab5b2f4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/91be1258993b592531e8e66181f26ad23ab5b2f4/comments", "author": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ba98228b4d4c2676edd074e39029952d8e841502", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba98228b4d4c2676edd074e39029952d8e841502", "html_url": "https://github.com/rust-lang/rust/commit/ba98228b4d4c2676edd074e39029952d8e841502"}], "stats": {"total": 53, "additions": 47, "deletions": 6}, "files": [{"sha": "74df7d8e58a112f1846e8924daa169cff4f917d8", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/91be1258993b592531e8e66181f26ad23ab5b2f4/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/91be1258993b592531e8e66181f26ad23ab5b2f4/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=91be1258993b592531e8e66181f26ad23ab5b2f4", "patch": "@@ -1415,24 +1415,31 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         }\n     }\n \n+    /// Return the dict-like variant corresponding to a given `Def`.\n     pub fn def_struct_variant(&self,\n                               def: def::Def)\n                               -> Option<(ty::AdtDef<'tcx>, ty::VariantDef<'tcx>)>\n     {\n-        match def {\n+        let (adt, variant) = match def {\n             def::DefVariant(enum_id, variant_id, true) => {\n                 let adt = self.tcx().lookup_adt_def(enum_id);\n-                Some((adt, adt.variant_with_id(variant_id)))\n+                (adt, adt.variant_with_id(variant_id))\n             }\n             def::DefTy(did, _) | def::DefStruct(did) => {\n                 let typ = self.tcx().lookup_item_type(did);\n                 if let ty::TyStruct(adt, _) = typ.ty.sty {\n-                    Some((adt, adt.struct_variant()))\n+                    (adt, adt.struct_variant())\n                 } else {\n-                    None\n+                    return None;\n                 }\n             }\n-            _ => None\n+            _ => return None\n+        };\n+\n+        if let ty::VariantKind::Dict = variant.kind() {\n+            Some((adt, variant))\n+        } else {\n+            None\n         }\n     }\n "}, {"sha": "336368cf8a49d73e948893533dcfea9091bafc6e", "filename": "src/test/compile-fail/issue-27831.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/91be1258993b592531e8e66181f26ad23ab5b2f4/src%2Ftest%2Fcompile-fail%2Fissue-27831.rs", "raw_url": "https://github.com/rust-lang/rust/raw/91be1258993b592531e8e66181f26ad23ab5b2f4/src%2Ftest%2Fcompile-fail%2Fissue-27831.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-27831.rs?ref=91be1258993b592531e8e66181f26ad23ab5b2f4", "patch": "@@ -0,0 +1,34 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+struct Foo(u32);\n+struct Bar;\n+\n+enum Enum {\n+    Foo(u32),\n+    Bar\n+}\n+\n+fn main() {\n+    let x = Foo(1);\n+    Foo { ..x }; //~ ERROR `Foo` does not name a structure\n+    let Foo { .. } = x; //~ ERROR `Foo` does not name a struct\n+\n+    let x = Bar;\n+    Bar { ..x }; //~ ERROR `Bar` does not name a structure\n+    let Bar { .. } = x; //~ ERROR `Bar` does not name a struct\n+\n+    match Enum::Bar {\n+        Enum::Bar { .. } //~ ERROR `Enum::Bar` does not name a struct\n+           => {}\n+        Enum::Foo { .. } //~ ERROR `Enum::Foo` does not name a struct\n+           => {}\n+    }\n+}"}, {"sha": "843ff38df49cb6527e53e5b6af644f1b6e6bb444", "filename": "src/test/compile-fail/issue-4736.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/91be1258993b592531e8e66181f26ad23ab5b2f4/src%2Ftest%2Fcompile-fail%2Fissue-4736.rs", "raw_url": "https://github.com/rust-lang/rust/raw/91be1258993b592531e8e66181f26ad23ab5b2f4/src%2Ftest%2Fcompile-fail%2Fissue-4736.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-4736.rs?ref=91be1258993b592531e8e66181f26ad23ab5b2f4", "patch": "@@ -11,5 +11,5 @@\n struct NonCopyable(());\n \n fn main() {\n-    let z = NonCopyable{ p: () }; //~ ERROR structure `NonCopyable` has no field named `p`\n+    let z = NonCopyable{ p: () }; //~ ERROR `NonCopyable` does not name a structure\n }"}]}