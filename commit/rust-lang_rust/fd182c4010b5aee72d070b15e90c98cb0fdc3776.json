{"sha": "fd182c4010b5aee72d070b15e90c98cb0fdc3776", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZkMTgyYzQwMTBiNWFlZTcyZDA3MGIxNWU5MGM5OGNiMGZkYzM3NzY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-03-13T15:31:51Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-03-13T15:31:51Z"}, "message": "Auto merge of #40329 - petrochenkov:llreuse, r=alexcrichton\n\nrustbuild: Add option for enabling partial LLVM rebuilds\n\n@alexcrichton , you probably didn't notice my [late comment](https://github.com/rust-lang/rust/pull/40236#issuecomment-284160749) on https://github.com/rust-lang/rust/pull/40236, but here's an implementation of that suggestion, it supersedes https://github.com/rust-lang/rust/pull/40236/commits/c652a4fb566ac4bec1d62c66769dd055ad239df6.\n\nr? @alexcrichton", "tree": {"sha": "20dfb70909275e39554bc05ed7d15caa35866623", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/20dfb70909275e39554bc05ed7d15caa35866623"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fd182c4010b5aee72d070b15e90c98cb0fdc3776", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fd182c4010b5aee72d070b15e90c98cb0fdc3776", "html_url": "https://github.com/rust-lang/rust/commit/fd182c4010b5aee72d070b15e90c98cb0fdc3776", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fd182c4010b5aee72d070b15e90c98cb0fdc3776/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a5483a7f36dfb97c2500c0ed4eedc4a665f3f5b1", "url": "https://api.github.com/repos/rust-lang/rust/commits/a5483a7f36dfb97c2500c0ed4eedc4a665f3f5b1", "html_url": "https://github.com/rust-lang/rust/commit/a5483a7f36dfb97c2500c0ed4eedc4a665f3f5b1"}, {"sha": "4cda4d67f169109bb0c09a2bd2abf5dfd2f41b0d", "url": "https://api.github.com/repos/rust-lang/rust/commits/4cda4d67f169109bb0c09a2bd2abf5dfd2f41b0d", "html_url": "https://github.com/rust-lang/rust/commit/4cda4d67f169109bb0c09a2bd2abf5dfd2f41b0d"}], "stats": {"total": 44, "additions": 26, "deletions": 18}, "files": [{"sha": "744ef2b2b24e443d76bb897212ae786b272de88a", "filename": "appveyor.yml", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/fd182c4010b5aee72d070b15e90c98cb0fdc3776/appveyor.yml", "raw_url": "https://github.com/rust-lang/rust/raw/fd182c4010b5aee72d070b15e90c98cb0fdc3776/appveyor.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/appveyor.yml?ref=fd182c4010b5aee72d070b15e90c98cb0fdc3776", "patch": "@@ -144,10 +144,10 @@ on_failure:\n   - cat %CD%/sccache.log\n \n cache:\n-  - \"build/i686-pc-windows-msvc/llvm -> src/rustllvm/llvm-auto-clean-trigger\"\n-  - \"build/x86_64-pc-windows-msvc/llvm -> src/rustllvm/llvm-auto-clean-trigger\"\n-  - \"i686-pc-windows-msvc/llvm -> src/rustllvm/llvm-auto-clean-trigger\"\n-  - \"x86_64-pc-windows-msvc/llvm -> src/rustllvm/llvm-auto-clean-trigger\"\n+  - \"build/i686-pc-windows-msvc/llvm -> src/rustllvm/llvm-rebuild-trigger\"\n+  - \"build/x86_64-pc-windows-msvc/llvm -> src/rustllvm/llvm-rebuild-trigger\"\n+  - \"i686-pc-windows-msvc/llvm -> src/rustllvm/llvm-rebuild-trigger\"\n+  - \"x86_64-pc-windows-msvc/llvm -> src/rustllvm/llvm-rebuild-trigger\"\n \n branches:\n   only:"}, {"sha": "35b376d5f27b8c498d3691e720c9d3dcde558f45", "filename": "configure", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fd182c4010b5aee72d070b15e90c98cb0fdc3776/configure", "raw_url": "https://github.com/rust-lang/rust/raw/fd182c4010b5aee72d070b15e90c98cb0fdc3776/configure", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/configure?ref=fd182c4010b5aee72d070b15e90c98cb0fdc3776", "patch": "@@ -437,6 +437,7 @@ opt local-rust 0 \"use an installed rustc rather than downloading a snapshot\"\n opt local-rebuild 0 \"assume local-rust matches the current version, for rebuilds; implies local-rust, and is implied if local-rust already matches the current version\"\n opt llvm-static-stdcpp 0 \"statically link to libstdc++ for LLVM\"\n opt llvm-link-shared 0 \"prefer shared linking to LLVM (llvm-config --link-shared)\"\n+opt llvm-clean-rebuild 0 \"delete LLVM build directory on rebuild\"\n opt rpath 1 \"build rpaths into rustc itself\"\n opt stage0-landing-pads 1 \"enable landing pads during bootstrap with stage0\"\n # This is used by the automation to produce single-target nightlies"}, {"sha": "dcd49c51e3a99b026da705ebd963714e31b6ea5a", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fd182c4010b5aee72d070b15e90c98cb0fdc3776/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd182c4010b5aee72d070b15e90c98cb0fdc3776/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=fd182c4010b5aee72d070b15e90c98cb0fdc3776", "patch": "@@ -60,6 +60,7 @@ pub struct Config {\n     pub llvm_link_shared: bool,\n     pub llvm_targets: Option<String>,\n     pub llvm_link_jobs: Option<u32>,\n+    pub llvm_clean_rebuild: bool,\n \n     // rust codegen options\n     pub rust_optimize: bool,\n@@ -181,6 +182,7 @@ struct Llvm {\n     static_libstdcpp: Option<bool>,\n     targets: Option<String>,\n     link_jobs: Option<u32>,\n+    clean_rebuild: Option<bool>,\n }\n \n #[derive(RustcDecodable, Default, Clone)]\n@@ -334,6 +336,7 @@ impl Config {\n             set(&mut config.llvm_release_debuginfo, llvm.release_debuginfo);\n             set(&mut config.llvm_version_check, llvm.version_check);\n             set(&mut config.llvm_static_stdcpp, llvm.static_libstdcpp);\n+            set(&mut config.llvm_clean_rebuild, llvm.clean_rebuild);\n             config.llvm_targets = llvm.targets.clone();\n             config.llvm_link_jobs = llvm.link_jobs;\n         }\n@@ -439,6 +442,7 @@ impl Config {\n                 (\"LLVM_VERSION_CHECK\", self.llvm_version_check),\n                 (\"LLVM_STATIC_STDCPP\", self.llvm_static_stdcpp),\n                 (\"LLVM_LINK_SHARED\", self.llvm_link_shared),\n+                (\"LLVM_CLEAN_REBUILD\", self.llvm_clean_rebuild),\n                 (\"OPTIMIZE\", self.rust_optimize),\n                 (\"DEBUG_ASSERTIONS\", self.rust_debug_assertions),\n                 (\"DEBUGINFO\", self.rust_debuginfo),"}, {"sha": "5a00e90f370b5f78bfc0183981c524683a98c7c4", "filename": "src/bootstrap/config.toml.example", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fd182c4010b5aee72d070b15e90c98cb0fdc3776/src%2Fbootstrap%2Fconfig.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/fd182c4010b5aee72d070b15e90c98cb0fdc3776/src%2Fbootstrap%2Fconfig.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.toml.example?ref=fd182c4010b5aee72d070b15e90c98cb0fdc3776", "patch": "@@ -61,6 +61,11 @@\n # controlled by rustbuild's -j parameter.\n #link-jobs = 0\n \n+# Delete LLVM build directory on LLVM rebuild.\n+# This option defaults to `false` for local development, but CI may want to\n+# always perform clean full builds (possibly accelerated by (s)ccache).\n+#clean-rebuild = false\n+\n # =============================================================================\n # General build configuration options\n # ============================================================================="}, {"sha": "6cc1ca8d02ed04e33eaa9baa12dc82d7bbd290e8", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 10, "deletions": 13, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/fd182c4010b5aee72d070b15e90c98cb0fdc3776/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd182c4010b5aee72d070b15e90c98cb0fdc3776/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=fd182c4010b5aee72d070b15e90c98cb0fdc3776", "patch": "@@ -41,28 +41,25 @@ pub fn llvm(build: &Build, target: &str) {\n         }\n     }\n \n-    let clean_trigger = build.src.join(\"src/rustllvm/llvm-auto-clean-trigger\");\n-    let mut clean_trigger_contents = String::new();\n-    t!(t!(File::open(&clean_trigger)).read_to_string(&mut clean_trigger_contents));\n+    let rebuild_trigger = build.src.join(\"src/rustllvm/llvm-rebuild-trigger\");\n+    let mut rebuild_trigger_contents = String::new();\n+    t!(t!(File::open(&rebuild_trigger)).read_to_string(&mut rebuild_trigger_contents));\n \n     let out_dir = build.llvm_out(target);\n     let done_stamp = out_dir.join(\"llvm-finished-building\");\n     if done_stamp.exists() {\n         let mut done_contents = String::new();\n         t!(t!(File::open(&done_stamp)).read_to_string(&mut done_contents));\n \n-        // LLVM was already built previously.\n-        // We don't track changes in LLVM sources, so we need to choose between reusing\n-        // what was built previously, or cleaning the directory and doing a fresh build.\n-        // The choice depends on contents of the clean-trigger file.\n-        // If the contents are the same as during the previous build, then no action is required.\n-        // If the contents differ from the previous build, then cleaning is triggered.\n-        if done_contents == clean_trigger_contents {\n+        // If LLVM was already built previously and contents of the rebuild-trigger file\n+        // didn't change from the previous build, then no action is required.\n+        if done_contents == rebuild_trigger_contents {\n             return\n-        } else {\n-            t!(fs::remove_dir_all(&out_dir));\n         }\n     }\n+    if build.config.llvm_clean_rebuild {\n+        drop(fs::remove_dir_all(&out_dir));\n+    }\n \n     println!(\"Building LLVM for {}\", target);\n     let _time = util::timeit();\n@@ -154,7 +151,7 @@ pub fn llvm(build: &Build, target: &str) {\n     //        tools and libs on all platforms.\n     cfg.build();\n \n-    t!(t!(File::create(&done_stamp)).write_all(clean_trigger_contents.as_bytes()));\n+    t!(t!(File::create(&done_stamp)).write_all(rebuild_trigger_contents.as_bytes()));\n }\n \n fn check_llvm_version(build: &Build, llvm_config: &Path) {"}, {"sha": "19bea9ced064289478dfc5cd05b2d9ed7104012e", "filename": "src/ci/run.sh", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fd182c4010b5aee72d070b15e90c98cb0fdc3776/src%2Fci%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/fd182c4010b5aee72d070b15e90c98cb0fdc3776/src%2Fci%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Frun.sh?ref=fd182c4010b5aee72d070b15e90c98cb0fdc3776", "patch": "@@ -28,6 +28,7 @@ RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --enable-quiet-tests\"\n RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --disable-manage-submodules\"\n RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --enable-locked-deps\"\n RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --enable-cargo-openssl-static\"\n+RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --enable-llvm-clean-rebuild\"\n \n if [ \"$DIST_SRC\" = \"\" ]; then\n   RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --disable-dist-src\""}, {"sha": "aeabf4a1dd3768284138f5bc434da6f604abc654", "filename": "src/rustllvm/llvm-rebuild-trigger", "status": "renamed", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd182c4010b5aee72d070b15e90c98cb0fdc3776/src%2Frustllvm%2Fllvm-rebuild-trigger", "raw_url": "https://github.com/rust-lang/rust/raw/fd182c4010b5aee72d070b15e90c98cb0fdc3776/src%2Frustllvm%2Fllvm-rebuild-trigger", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustllvm%2Fllvm-rebuild-trigger?ref=fd182c4010b5aee72d070b15e90c98cb0fdc3776", "patch": "@@ -1,4 +1,4 @@\n-# If this file is modified, then llvm will be forcibly cleaned and then rebuilt.\n+# If this file is modified, then llvm will be (optionally) cleaned and then rebuilt.\n # The actual contents of this file do not matter, but to trigger a change on the\n # build bots then the contents should be changed so git updates the mtime.\n 2017-03-04", "previous_filename": "src/rustllvm/llvm-auto-clean-trigger"}]}