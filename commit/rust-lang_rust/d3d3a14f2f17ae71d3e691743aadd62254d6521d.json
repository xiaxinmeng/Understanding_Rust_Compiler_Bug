{"sha": "d3d3a14f2f17ae71d3e691743aadd62254d6521d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQzZDNhMTRmMmYxN2FlNzFkM2U2OTE3NDNhYWRkNjIyNTRkNjUyMWQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-06-14T03:10:53Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-06-14T03:10:53Z"}, "message": "Auto merge of #73188 - mati865:use-preinstalled-msys2, r=pietroalbini\n\nUse preinstalled msys2\n\nFixes https://github.com/rust-lang/rust/issues/65767", "tree": {"sha": "186fa68e8abf37d7cd98f5f3ea5a92bf59144c50", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/186fa68e8abf37d7cd98f5f3ea5a92bf59144c50"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d3d3a14f2f17ae71d3e691743aadd62254d6521d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d3d3a14f2f17ae71d3e691743aadd62254d6521d", "html_url": "https://github.com/rust-lang/rust/commit/d3d3a14f2f17ae71d3e691743aadd62254d6521d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d3d3a14f2f17ae71d3e691743aadd62254d6521d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "06e47688bf15d0215edbe05b21603062f6d2eb5d", "url": "https://api.github.com/repos/rust-lang/rust/commits/06e47688bf15d0215edbe05b21603062f6d2eb5d", "html_url": "https://github.com/rust-lang/rust/commit/06e47688bf15d0215edbe05b21603062f6d2eb5d"}, {"sha": "91b6f1585d99b3d8978cfca7bd2fdcc75dac9412", "url": "https://api.github.com/repos/rust-lang/rust/commits/91b6f1585d99b3d8978cfca7bd2fdcc75dac9412", "html_url": "https://github.com/rust-lang/rust/commit/91b6f1585d99b3d8978cfca7bd2fdcc75dac9412"}], "stats": {"total": 79, "additions": 20, "deletions": 59}, "files": [{"sha": "355f28292153779fe9dd41a07288a20425131a8b", "filename": ".github/workflows/ci.yml", "status": "modified", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d3d3a14f2f17ae71d3e691743aadd62254d6521d/.github%2Fworkflows%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/d3d3a14f2f17ae71d3e691743aadd62254d6521d/.github%2Fworkflows%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yml?ref=d3d3a14f2f17ae71d3e691743aadd62254d6521d", "patch": "@@ -102,9 +102,6 @@ jobs:\n       - name: install MSYS2\n         run: src/ci/scripts/install-msys2.sh\n         if: success() && !env.SKIP_JOB\n-      - name: install MSYS2 packages\n-        run: src/ci/scripts/install-msys2-packages.sh\n-        if: success() && !env.SKIP_JOB\n       - name: install MinGW\n         run: src/ci/scripts/install-mingw.sh\n         if: success() && !env.SKIP_JOB\n@@ -212,9 +209,6 @@ jobs:\n       - name: install MSYS2\n         run: src/ci/scripts/install-msys2.sh\n         if: success() && !env.SKIP_JOB\n-      - name: install MSYS2 packages\n-        run: src/ci/scripts/install-msys2-packages.sh\n-        if: success() && !env.SKIP_JOB\n       - name: install MinGW\n         run: src/ci/scripts/install-mingw.sh\n         if: success() && !env.SKIP_JOB\n@@ -564,9 +558,6 @@ jobs:\n       - name: install MSYS2\n         run: src/ci/scripts/install-msys2.sh\n         if: success() && !env.SKIP_JOB\n-      - name: install MSYS2 packages\n-        run: src/ci/scripts/install-msys2-packages.sh\n-        if: success() && !env.SKIP_JOB\n       - name: install MinGW\n         run: src/ci/scripts/install-mingw.sh\n         if: success() && !env.SKIP_JOB"}, {"sha": "e43116c06b6b7f3718abd2c1348617f0f59c367c", "filename": "src/ci/azure-pipelines/steps/run.yml", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d3d3a14f2f17ae71d3e691743aadd62254d6521d/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "raw_url": "https://github.com/rust-lang/rust/raw/d3d3a14f2f17ae71d3e691743aadd62254d6521d/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml?ref=d3d3a14f2f17ae71d3e691743aadd62254d6521d", "patch": "@@ -82,10 +82,6 @@ steps:\n   displayName: Install msys2\n   condition: and(succeeded(), not(variables.SKIP_JOB))\n \n-- bash: src/ci/scripts/install-msys2-packages.sh\n-  displayName: Install msys2 packages\n-  condition: and(succeeded(), not(variables.SKIP_JOB))\n-\n - bash: src/ci/scripts/install-mingw.sh\n   displayName: Install MinGW\n   condition: and(succeeded(), not(variables.SKIP_JOB))"}, {"sha": "590845b33cda77931ef2a48688920b450be82e6a", "filename": "src/ci/github-actions/ci.yml", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d3d3a14f2f17ae71d3e691743aadd62254d6521d/src%2Fci%2Fgithub-actions%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/d3d3a14f2f17ae71d3e691743aadd62254d6521d/src%2Fci%2Fgithub-actions%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fgithub-actions%2Fci.yml?ref=d3d3a14f2f17ae71d3e691743aadd62254d6521d", "patch": "@@ -147,10 +147,6 @@ x--expand-yaml-anchors--remove:\n         run: src/ci/scripts/install-msys2.sh\n         <<: *step\n \n-      - name: install MSYS2 packages\n-        run: src/ci/scripts/install-msys2-packages.sh\n-        <<: *step\n-\n       - name: install MinGW\n         run: src/ci/scripts/install-mingw.sh\n         <<: *step"}, {"sha": "ff7479c05d04e5d7821b220646862ea03290bbcf", "filename": "src/ci/scripts/install-msys2-packages.sh", "status": "removed", "additions": 0, "deletions": 27, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/06e47688bf15d0215edbe05b21603062f6d2eb5d/src%2Fci%2Fscripts%2Finstall-msys2-packages.sh", "raw_url": "https://github.com/rust-lang/rust/raw/06e47688bf15d0215edbe05b21603062f6d2eb5d/src%2Fci%2Fscripts%2Finstall-msys2-packages.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fscripts%2Finstall-msys2-packages.sh?ref=06e47688bf15d0215edbe05b21603062f6d2eb5d", "patch": "@@ -1,27 +0,0 @@\n-#!/bin/bash\n-\n-set -euo pipefail\n-IFS=$'\\n\\t'\n-\n-source \"$(cd \"$(dirname \"$0\")\" && pwd)/../shared.sh\"\n-\n-if isWindows; then\n-    pacman -S --noconfirm --needed base-devel ca-certificates make diffutils tar \\\n-        binutils\n-\n-    # Detect the native Python version installed on the agent. On GitHub\n-    # Actions, the C:\\hostedtoolcache\\windows\\Python directory contains a\n-    # subdirectory for each installed Python version.\n-    #\n-    # The -V flag of the sort command sorts the input by version number.\n-    native_python_version=\"$(ls /c/hostedtoolcache/windows/Python | sort -Vr | head -n 1)\"\n-\n-    # Make sure we use the native python interpreter instead of some msys equivalent\n-    # one way or another. The msys interpreters seem to have weird path conversions\n-    # baked in which break LLVM's build system one way or another, so let's use the\n-    # native version which keeps everything as native as possible.\n-    python_home=\"/c/hostedtoolcache/windows/Python/${native_python_version}/x64\"\n-    cp \"${python_home}/python.exe\" \"${python_home}/python3.exe\"\n-    ciCommandAddPath \"C:\\\\hostedtoolcache\\\\windows\\\\Python\\\\${native_python_version}\\\\x64\"\n-    ciCommandAddPath \"C:\\\\hostedtoolcache\\\\windows\\\\Python\\\\${native_python_version}\\\\x64\\\\Scripts\"\n-fi"}, {"sha": "3a0c965a67710ba45d3e66b5553b50ab83df5c2a", "filename": "src/ci/scripts/install-msys2.sh", "status": "modified", "additions": 20, "deletions": 15, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/d3d3a14f2f17ae71d3e691743aadd62254d6521d/src%2Fci%2Fscripts%2Finstall-msys2.sh", "raw_url": "https://github.com/rust-lang/rust/raw/d3d3a14f2f17ae71d3e691743aadd62254d6521d/src%2Fci%2Fscripts%2Finstall-msys2.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fscripts%2Finstall-msys2.sh?ref=d3d3a14f2f17ae71d3e691743aadd62254d6521d", "patch": "@@ -1,28 +1,33 @@\n #!/bin/bash\n # Download and install MSYS2, needed primarily for the test suite (run-make) but\n # also used by the MinGW toolchain for assembling things.\n-#\n-# FIXME: we should probe the default azure image and see if we can use the MSYS2\n-# toolchain there. (if there's even one there). For now though this gets the job\n-# done.\n \n set -euo pipefail\n IFS=$'\\n\\t'\n \n source \"$(cd \"$(dirname \"$0\")\" && pwd)/../shared.sh\"\n \n if isWindows; then\n-    # Pre-followed the api/v2 URL to the CDN since the API can be a bit flakey\n-    curl -sSL https://packages.chocolatey.org/msys2.20190524.0.0.20191030.nupkg > \\\n-        msys2.nupkg\n-    curl -sSL https://packages.chocolatey.org/chocolatey-core.extension.1.3.5.1.nupkg > \\\n-        chocolatey-core.extension.nupkg\n-    choco install -s . msys2 \\\n-        --params=\"/InstallDir:$(ciCheckoutPath)/msys2 /NoPath\" -y --no-progress\n-    rm msys2.nupkg chocolatey-core.extension.nupkg\n-    mkdir -p \"$(ciCheckoutPath)/msys2/home/${USERNAME}\"\n-    ciCommandAddPath \"$(ciCheckoutPath)/msys2/usr/bin\"\n+    msys2Path=\"c:/msys64\"\n+    mkdir -p \"${msys2Path}/home/${USERNAME}\"\n+    ciCommandAddPath \"${msys2Path}/usr/bin\"\n \n     echo \"switching shell to use our own bash\"\n-    ciCommandSetEnv CI_OVERRIDE_SHELL \"$(ciCheckoutPath)/msys2/usr/bin/bash.exe\"\n+    ciCommandSetEnv CI_OVERRIDE_SHELL \"${msys2Path}/usr/bin/bash.exe\"\n+\n+    # Detect the native Python version installed on the agent. On GitHub\n+    # Actions, the C:\\hostedtoolcache\\windows\\Python directory contains a\n+    # subdirectory for each installed Python version.\n+    #\n+    # The -V flag of the sort command sorts the input by version number.\n+    native_python_version=\"$(ls /c/hostedtoolcache/windows/Python | sort -Vr | head -n 1)\"\n+\n+    # Make sure we use the native python interpreter instead of some msys equivalent\n+    # one way or another. The msys interpreters seem to have weird path conversions\n+    # baked in which break LLVM's build system one way or another, so let's use the\n+    # native version which keeps everything as native as possible.\n+    python_home=\"/c/hostedtoolcache/windows/Python/${native_python_version}/x64\"\n+    cp \"${python_home}/python.exe\" \"${python_home}/python3.exe\"\n+    ciCommandAddPath \"C:\\\\hostedtoolcache\\\\windows\\\\Python\\\\${native_python_version}\\\\x64\"\n+    ciCommandAddPath \"C:\\\\hostedtoolcache\\\\windows\\\\Python\\\\${native_python_version}\\\\x64\\\\Scripts\"\n fi"}]}