{"sha": "bfc897ec07eece6a180c2279bc470d08d6f2e23e", "node_id": "C_kwDOAAsO6NoAKGJmYzg5N2VjMDdlZWNlNmExODBjMjI3OWJjNDcwZDA4ZDZmMmUyM2U", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2023-05-31T09:00:34Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2023-05-31T09:00:34Z"}, "message": "CI: test ./miri bench", "tree": {"sha": "a6dafa156886d5cc5702118b278ad29c93830c27", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a6dafa156886d5cc5702118b278ad29c93830c27"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bfc897ec07eece6a180c2279bc470d08d6f2e23e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bfc897ec07eece6a180c2279bc470d08d6f2e23e", "html_url": "https://github.com/rust-lang/rust/commit/bfc897ec07eece6a180c2279bc470d08d6f2e23e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bfc897ec07eece6a180c2279bc470d08d6f2e23e/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f9cff630a10c99702db597c8640fd62d9a5d1ba9", "url": "https://api.github.com/repos/rust-lang/rust/commits/f9cff630a10c99702db597c8640fd62d9a5d1ba9", "html_url": "https://github.com/rust-lang/rust/commit/f9cff630a10c99702db597c8640fd62d9a5d1ba9"}], "stats": {"total": 30, "additions": 15, "deletions": 15}, "files": [{"sha": "a8aae524e7101fd35a214c48329c55a65f865737", "filename": "src/tools/miri/ci.sh", "status": "modified", "additions": 10, "deletions": 11, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/bfc897ec07eece6a180c2279bc470d08d6f2e23e/src%2Ftools%2Fmiri%2Fci.sh", "raw_url": "https://github.com/rust-lang/rust/raw/bfc897ec07eece6a180c2279bc470d08d6f2e23e/src%2Ftools%2Fmiri%2Fci.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Fci.sh?ref=bfc897ec07eece6a180c2279bc470d08d6f2e23e", "patch": "@@ -17,11 +17,11 @@ begingroup \"Building Miri\"\n echo \"Installing release version of Miri\"\n export RUSTFLAGS=\"-D warnings\"\n export CARGO_INCREMENTAL=0\n-./miri install # implicitly locked\n+export CARGO_EXTRA_FLAGS=\"--locked\"\n+./miri install\n \n # Prepare debug build for direct `./miri` invocations\n echo \"Building debug version of Miri\"\n-export CARGO_EXTRA_FLAGS=\"--locked\"\n ./miri check --no-default-features # make sure this can be built\n ./miri check --all-features # and this, too\n ./miri build --all-targets # the build that all the `./miri test` below will use\n@@ -39,8 +39,11 @@ function run_tests {\n   ## ui test suite\n   ./miri test\n   if [ -z \"${MIRI_TEST_TARGET+exists}\" ]; then\n-    # Only for host architecture: tests with optimizations (`-O` is what cargo passes, but crank MIR\n-    # optimizations up all the way, too).\n+    # Host-only tests: running these on all targets is unlikely to catch more problems and would\n+    # cost a lot of CI time.\n+\n+    # Tests with optimizations (`-O` is what cargo passes, but crank MIR optimizations up all the\n+    # way, too).\n     # Optimizations change diagnostics (mostly backtraces), so we don't check\n     # them. Also error locations change so we don't run the failing tests.\n     # We explicitly enable debug-assertions here, they are disabled by -O but we have tests\n@@ -51,6 +54,9 @@ function run_tests {\n     for FILE in tests/many-seeds/*.rs; do\n       MIRI_SEEDS=64 CARGO_EXTRA_FLAGS=\"$CARGO_EXTRA_FLAGS -q\" ./miri many-seeds ./miri run \"$FILE\"\n     done\n+\n+    # Check that the benchmarks build and run, but without actually benchmarking.\n+    HYPERFINE=\"bash -c\" ./miri bench\n   fi\n \n   ## test-cargo-miri\n@@ -75,13 +81,6 @@ function run_tests {\n   unset RUSTC MIRI\n   rm -rf .cargo\n \n-  # Ensure that our benchmarks all work, but only on Linux hosts.\n-  if [ -z \"${MIRI_TEST_TARGET+exists}\" ] && [ \"$HOST_TARGET\" = x86_64-unknown-linux-gnu ] ; then\n-    for BENCH in $(ls \"bench-cargo-miri\"); do\n-      cargo miri run --manifest-path bench-cargo-miri/$BENCH/Cargo.toml\n-    done\n-  fi\n-\n   endgroup\n }\n "}, {"sha": "ce3fcbba118c978bbd712ce8cf16e9998a157dbf", "filename": "src/tools/miri/miri", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/bfc897ec07eece6a180c2279bc470d08d6f2e23e/src%2Ftools%2Fmiri%2Fmiri", "raw_url": "https://github.com/rust-lang/rust/raw/bfc897ec07eece6a180c2279bc470d08d6f2e23e/src%2Ftools%2Fmiri%2Fmiri", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Fmiri?ref=bfc897ec07eece6a180c2279bc470d08d6f2e23e", "patch": "@@ -184,6 +184,8 @@ many-seeds)\n     exit 0\n     ;;\n bench)\n+    # The hyperfine to use\n+    HYPERFINE=${HYPERFINE:-hyperfine -w 1 -m 5 --shell=none}\n     # Make sure we have an up-to-date Miri installed\n     \"$0\" install\n     # Run the requested benchmarks\n@@ -193,7 +195,7 @@ bench)\n         BENCHES=(\"$@\")\n     fi\n     for BENCH in \"${BENCHES[@]}\"; do\n-        hyperfine -w 1 -m 5 --shell=none \"cargo +$TOOLCHAIN miri run --manifest-path $MIRIDIR/bench-cargo-miri/$BENCH/Cargo.toml\"\n+        $HYPERFINE \"cargo +$TOOLCHAIN miri run --manifest-path $MIRIDIR/bench-cargo-miri/$BENCH/Cargo.toml\"\n     done\n     exit 0\n     ;;\n@@ -280,10 +282,9 @@ find_sysroot() {\n # Run command.\n case \"$COMMAND\" in\n install)\n-    # \"--locked\" to respect the Cargo.lock file if it exists.\n     # Install binaries to the miri toolchain's sysroot so they do not interact with other toolchains.\n-    $CARGO install $CARGO_EXTRA_FLAGS --path \"$MIRIDIR\" --force --locked --root \"$SYSROOT\" \"$@\"\n-    $CARGO install $CARGO_EXTRA_FLAGS --path \"$MIRIDIR\"/cargo-miri --force --locked --root \"$SYSROOT\" \"$@\"\n+    $CARGO install $CARGO_EXTRA_FLAGS --path \"$MIRIDIR\" --force --root \"$SYSROOT\" \"$@\"\n+    $CARGO install $CARGO_EXTRA_FLAGS --path \"$MIRIDIR\"/cargo-miri --force --root \"$SYSROOT\" \"$@\"\n     ;;\n check)\n     # Check, and let caller control flags."}]}