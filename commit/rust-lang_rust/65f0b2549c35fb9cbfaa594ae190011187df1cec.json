{"sha": "65f0b2549c35fb9cbfaa594ae190011187df1cec", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY1ZjBiMjU0OWMzNWZiOWNiZmFhNTk0YWUxOTAwMTExODdkZjFjZWM=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2020-12-28T18:28:29Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-03-01T03:01:45Z"}, "message": "Always compile rustdoc with debug logging enabled when `download-rustc` is set\n\nPreviously, logging at DEBUG or below would always be silenced, because\nrustc compiles tracing with the `static_max_level_info` feature. That\nmakes sense for release artifacts, but not for developing rustdoc.\n\nInstead, this compiles two different versions of tracing: one in the\nrelease artifacts, distributed in the sysroot, and a new version\ncompiled by rustdoc. Since `rustc_driver` is always linked to the\nversion of sysroot, this copy/pastes `init_env_logging` into rustdoc.\n\nThe builds the second version of tracing unconditionally; see the code\nfor details on why.", "tree": {"sha": "0a961c230e4caf58124679bdcf6f67a4e739aafa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0a961c230e4caf58124679bdcf6f67a4e739aafa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/65f0b2549c35fb9cbfaa594ae190011187df1cec", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/65f0b2549c35fb9cbfaa594ae190011187df1cec", "html_url": "https://github.com/rust-lang/rust/commit/65f0b2549c35fb9cbfaa594ae190011187df1cec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/65f0b2549c35fb9cbfaa594ae190011187df1cec/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fe1bf8e05c39bdcc73fc09e246b7209444e389bc", "url": "https://api.github.com/repos/rust-lang/rust/commits/fe1bf8e05c39bdcc73fc09e246b7209444e389bc", "html_url": "https://github.com/rust-lang/rust/commit/fe1bf8e05c39bdcc73fc09e246b7209444e389bc"}], "stats": {"total": 84, "additions": 84, "deletions": 0}, "files": [{"sha": "73d3529b2211ae2a002e3262a4950d1b4d637343", "filename": "Cargo.lock", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/65f0b2549c35fb9cbfaa594ae190011187df1cec/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/65f0b2549c35fb9cbfaa594ae190011187df1cec/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=65f0b2549c35fb9cbfaa594ae190011187df1cec", "patch": "@@ -4452,6 +4452,9 @@ dependencies = [\n  \"serde_json\",\n  \"smallvec 1.6.1\",\n  \"tempfile\",\n+ \"tracing\",\n+ \"tracing-subscriber\",\n+ \"tracing-tree\",\n ]\n \n [[package]]"}, {"sha": "44c2c3b17860b29d944b45deb1c1d4528e77b905", "filename": "src/librustdoc/Cargo.toml", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/65f0b2549c35fb9cbfaa594ae190011187df1cec/src%2Flibrustdoc%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/65f0b2549c35fb9cbfaa594ae190011187df1cec/src%2Flibrustdoc%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2FCargo.toml?ref=65f0b2549c35fb9cbfaa594ae190011187df1cec", "patch": "@@ -19,6 +19,13 @@ tempfile = \"3\"\n itertools = \"0.9\"\n regex = \"1\"\n rustdoc-json-types = { path = \"../rustdoc-json-types\" }\n+tracing = \"0.1\"\n+tracing-tree = \"0.1.6\"\n+\n+[dependencies.tracing-subscriber]\n+version = \"0.2.13\"\n+default-features = false\n+features = [\"fmt\", \"env-filter\", \"smallvec\", \"parking_lot\", \"ansi\"]\n \n [dev-dependencies]\n expect-test = \"1.0\""}, {"sha": "2c43489e989ee50da6415e201d41b72bb140a736", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 74, "deletions": 0, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/65f0b2549c35fb9cbfaa594ae190011187df1cec/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/65f0b2549c35fb9cbfaa594ae190011187df1cec/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=65f0b2549c35fb9cbfaa594ae190011187df1cec", "patch": "@@ -95,14 +95,88 @@ mod visit_lib;\n pub fn main() {\n     rustc_driver::set_sigpipe_handler();\n     rustc_driver::install_ice_hook();\n+\n+    // When using CI artifacts (with `download_stage1 = true`), tracing is unconditionally built\n+    // with `--features=static_max_level_info`, which disables almost all rustdoc logging. To avoid\n+    // this, compile our own version of `tracing` that logs all levels.\n+    // NOTE: this compiles both versions of tracing unconditionally, because\n+    // - The compile time hit is not that bad, especially compared to rustdoc's incremental times, and\n+    // - Otherwise, there's no warning that logging is being ignored when `download_stage1 = true`.\n+    // NOTE: The reason this doesn't show double logging when `download_stage1 = false` and\n+    // `debug_logging = true` is because all rustc logging goes to its version of tracing (the one\n+    // in the sysroot), and all of rustdoc's logging goes to its version (the one in Cargo.toml).\n+    init_logging();\n     rustc_driver::init_env_logger(\"RUSTDOC_LOG\");\n+\n     let exit_code = rustc_driver::catch_with_exit_code(|| match get_args() {\n         Some(args) => main_args(&args),\n         _ => Err(ErrorReported),\n     });\n     process::exit(exit_code);\n }\n \n+fn init_logging() {\n+    use std::io;\n+\n+    // FIXME remove these and use winapi 0.3 instead\n+    // Duplicates: bootstrap/compile.rs, librustc_errors/emitter.rs, rustc_driver/lib.rs\n+    #[cfg(unix)]\n+    fn stdout_isatty() -> bool {\n+        extern crate libc;\n+        unsafe { libc::isatty(libc::STDOUT_FILENO) != 0 }\n+    }\n+\n+    #[cfg(windows)]\n+    fn stdout_isatty() -> bool {\n+        extern crate winapi;\n+        use winapi::um::consoleapi::GetConsoleMode;\n+        use winapi::um::processenv::GetStdHandle;\n+        use winapi::um::winbase::STD_OUTPUT_HANDLE;\n+\n+        unsafe {\n+            let handle = GetStdHandle(STD_OUTPUT_HANDLE);\n+            let mut out = 0;\n+            GetConsoleMode(handle, &mut out) != 0\n+        }\n+    }\n+\n+    let color_logs = match std::env::var(\"RUSTDOC_LOG_COLOR\") {\n+        Ok(value) => match value.as_ref() {\n+            \"always\" => true,\n+            \"never\" => false,\n+            \"auto\" => stdout_isatty(),\n+            _ => early_error(\n+                ErrorOutputType::default(),\n+                &format!(\n+                    \"invalid log color value '{}': expected one of always, never, or auto\",\n+                    value\n+                ),\n+            ),\n+        },\n+        Err(std::env::VarError::NotPresent) => stdout_isatty(),\n+        Err(std::env::VarError::NotUnicode(_value)) => early_error(\n+            ErrorOutputType::default(),\n+            \"non-Unicode log color value: expected one of always, never, or auto\",\n+        ),\n+    };\n+    let filter = tracing_subscriber::EnvFilter::from_env(\"RUSTDOC_LOG\");\n+    let layer = tracing_tree::HierarchicalLayer::default()\n+        .with_writer(io::stderr)\n+        .with_indent_lines(true)\n+        .with_ansi(color_logs)\n+        .with_targets(true)\n+        .with_wraparound(10)\n+        .with_verbose_exit(true)\n+        .with_verbose_entry(true)\n+        .with_indent_amount(2);\n+    #[cfg(parallel_compiler)]\n+    let layer = layer.with_thread_ids(true).with_thread_names(true);\n+\n+    use tracing_subscriber::layer::SubscriberExt;\n+    let subscriber = tracing_subscriber::Registry::default().with(filter).with(layer);\n+    tracing::subscriber::set_global_default(subscriber).unwrap();\n+}\n+\n fn get_args() -> Option<Vec<String>> {\n     env::args_os()\n         .enumerate()"}]}