{"sha": "75f4c54d8c1304966dff2e1d45cff88ac96a9d0f", "node_id": "C_kwDOAAsO6NoAKDc1ZjRjNTRkOGMxMzA0OTY2ZGZmMmUxZDQ1Y2ZmODhhYzk2YTlkMGY", "commit": {"author": {"name": "btwotwo", "email": "10519967+btwotwo@users.noreply.github.com", "date": "2022-10-04T22:02:03Z"}, "committer": {"name": "btwotwo", "email": "10519967+btwotwo@users.noreply.github.com", "date": "2022-10-06T14:32:19Z"}, "message": "Add stub for cargo environment variables auto completion", "tree": {"sha": "0932f43760636104e6fb3a4e74235bebde2e2d38", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0932f43760636104e6fb3a4e74235bebde2e2d38"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/75f4c54d8c1304966dff2e1d45cff88ac96a9d0f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE7WZLfNy5oeDQue2p1FagNJ1zoKMFAmM+5vMACgkQ1FagNJ1z\noKN6Dw//XT8zOL5zFQTANataksOy/4sYHqF1dhY/4slUQ+mhh0eNleORYrwZ5J1h\nLk64vQlUmn9bwMrumMW9oC0vtMOEVnvhLIiIrpkW0c7dvlYbOKj7nctQBMEitaIG\npBELiKeJrIWp3CbI88qaPTOS40CxOVXg7IUJtLZvif8ncJir6FPatOhXTmkV/Ibl\nJI7mgSl39E1BfNMj2PAzFFAT3YzFcybNaize3GLqQ5DuZTrsWHva9zYC6foWMpbe\nbYRJLEB8Kw/xVfz9RYrzYFwJpa3XkC6zA9h6Q116NXOsnkNVThotGeF8wcJzsumD\nJjqpDOUDX4MCFL/wM8lR1Kl32VqeAiHK9LPGGWeshkCwgM7yYOLRmJLZZDyV5QKs\npap//g+3bG7wCrX+P1nn/0m6CpRjJXWEFOXnIiRA5QrunzgjpGdyybf2liKcx+GP\nEnZjLPYGaVD/Z4hlqZU72rPMgTBo6ZH/Of+1sN7UUr842rj/3KaTK21BFqtyw+Ko\nYdxhhWA8g99yAw6nzuplsgr2tHIQxYSmwRqB5CM0l7fYrRlrzPKWKrxriz/tVZYy\n2GbSqnAPCIgJ6UqQ2vdaQdl0rxfEq0Fcvu+Dqv3dsr8w/gUMWdCyyNf7M16yEU7A\nHQtt3lKwG1/zd8F2RAqzBV7KygF/wg2Jp0/wdsZJdkyJ+4bOIxE=\n=ybC3\n-----END PGP SIGNATURE-----", "payload": "tree 0932f43760636104e6fb3a4e74235bebde2e2d38\nparent a415fb4c4e00da1b4138f5a7787ae9838e8ab576\nauthor btwotwo <10519967+btwotwo@users.noreply.github.com> 1664920923 +0200\ncommitter btwotwo <10519967+btwotwo@users.noreply.github.com> 1665066739 +0200\n\nAdd stub for cargo environment variables auto completion\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/75f4c54d8c1304966dff2e1d45cff88ac96a9d0f", "html_url": "https://github.com/rust-lang/rust/commit/75f4c54d8c1304966dff2e1d45cff88ac96a9d0f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/75f4c54d8c1304966dff2e1d45cff88ac96a9d0f/comments", "author": {"login": "btwotwo", "id": 10519967, "node_id": "MDQ6VXNlcjEwNTE5OTY3", "avatar_url": "https://avatars.githubusercontent.com/u/10519967?v=4", "gravatar_id": "", "url": "https://api.github.com/users/btwotwo", "html_url": "https://github.com/btwotwo", "followers_url": "https://api.github.com/users/btwotwo/followers", "following_url": "https://api.github.com/users/btwotwo/following{/other_user}", "gists_url": "https://api.github.com/users/btwotwo/gists{/gist_id}", "starred_url": "https://api.github.com/users/btwotwo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/btwotwo/subscriptions", "organizations_url": "https://api.github.com/users/btwotwo/orgs", "repos_url": "https://api.github.com/users/btwotwo/repos", "events_url": "https://api.github.com/users/btwotwo/events{/privacy}", "received_events_url": "https://api.github.com/users/btwotwo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "btwotwo", "id": 10519967, "node_id": "MDQ6VXNlcjEwNTE5OTY3", "avatar_url": "https://avatars.githubusercontent.com/u/10519967?v=4", "gravatar_id": "", "url": "https://api.github.com/users/btwotwo", "html_url": "https://github.com/btwotwo", "followers_url": "https://api.github.com/users/btwotwo/followers", "following_url": "https://api.github.com/users/btwotwo/following{/other_user}", "gists_url": "https://api.github.com/users/btwotwo/gists{/gist_id}", "starred_url": "https://api.github.com/users/btwotwo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/btwotwo/subscriptions", "organizations_url": "https://api.github.com/users/btwotwo/orgs", "repos_url": "https://api.github.com/users/btwotwo/repos", "events_url": "https://api.github.com/users/btwotwo/events{/privacy}", "received_events_url": "https://api.github.com/users/btwotwo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a415fb4c4e00da1b4138f5a7787ae9838e8ab576", "url": "https://api.github.com/repos/rust-lang/rust/commits/a415fb4c4e00da1b4138f5a7787ae9838e8ab576", "html_url": "https://github.com/rust-lang/rust/commit/a415fb4c4e00da1b4138f5a7787ae9838e8ab576"}], "stats": {"total": 62, "additions": 62, "deletions": 0}, "files": [{"sha": "296dfc14250f75013e748352511adcf8b26ff066", "filename": "crates/ide-completion/src/completions.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/75f4c54d8c1304966dff2e1d45cff88ac96a9d0f/crates%2Fide-completion%2Fsrc%2Fcompletions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75f4c54d8c1304966dff2e1d45cff88ac96a9d0f/crates%2Fide-completion%2Fsrc%2Fcompletions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions.rs?ref=75f4c54d8c1304966dff2e1d45cff88ac96a9d0f", "patch": "@@ -19,6 +19,7 @@ pub(crate) mod snippet;\n pub(crate) mod r#type;\n pub(crate) mod use_;\n pub(crate) mod vis;\n+pub(crate) mod env_vars;\n \n use std::iter;\n "}, {"sha": "6cfbd0f922f8a2c1a3bc151125300ca8021983fe", "filename": "crates/ide-completion/src/completions/env_vars.rs", "status": "added", "additions": 60, "deletions": 0, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/75f4c54d8c1304966dff2e1d45cff88ac96a9d0f/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fenv_vars.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75f4c54d8c1304966dff2e1d45cff88ac96a9d0f/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fenv_vars.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fenv_vars.rs?ref=75f4c54d8c1304966dff2e1d45cff88ac96a9d0f", "patch": "@@ -0,0 +1,60 @@\n+//! Completes environment variables defined by Cargo (https://doc.rust-lang.org/cargo/reference/environment-variables.html)\n+\n+use syntax::{ast, AstToken, AstNode, TextRange, TextSize};\n+\n+use crate::{context::CompletionContext, CompletionItem, CompletionItemKind};\n+\n+use super::Completions;\n+\n+pub(crate) fn complete_cargo_env_vars(\n+    acc: &mut Completions,\n+    ctx: &CompletionContext<'_>,\n+    original: &ast::String\n+) {\n+    if !is_env_macro(original) {\n+        return;\n+    }\n+\n+    let start = ctx.original_token.text_range().start() + TextSize::from(1);\n+    let cursor = ctx.position.offset;\n+\n+    CompletionItem::new(CompletionItemKind::Binding, TextRange::new(start, cursor), \"CARGO\").add_to(acc);\n+}\n+\n+fn is_env_macro(string: &ast::String) -> bool {\n+    //todo: replace copypaste from format_string with separate function\n+    (|| {\n+        let macro_call = string.syntax().parent_ancestors().find_map(ast::MacroCall::cast)?;\n+        let name = macro_call.path()?.segment()?.name_ref()?;\n+\n+        if !matches!(name.text().as_str(), \n+        \"env\" | \"option_env\") {\n+            return None;\n+        }\n+\n+\n+        Some(())\n+    })()\n+    .is_some()\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use expect_test::{expect, Expect};\n+    use crate::tests::{check_edit};\n+\n+    #[test]\n+    fn completes_env_variables() {\n+        check_edit(\"CARGO\", \n+        r#\"\n+            fn main() {\n+                let foo = env!(\"CA$0);\n+            }\n+        \"#\n+        ,r#\"\n+            fn main() {\n+                let foo = env!(\"CARGO);\n+            }\n+        \"#)\n+    }\n+}\n\\ No newline at end of file"}, {"sha": "cd9da0d3dcf04e093b742565278b1facdd45a304", "filename": "crates/ide-completion/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/75f4c54d8c1304966dff2e1d45cff88ac96a9d0f/crates%2Fide-completion%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75f4c54d8c1304966dff2e1d45cff88ac96a9d0f/crates%2Fide-completion%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Flib.rs?ref=75f4c54d8c1304966dff2e1d45cff88ac96a9d0f", "patch": "@@ -183,6 +183,7 @@ pub fn completions(\n             CompletionAnalysis::String { original, expanded: Some(expanded) } => {\n                 completions::extern_abi::complete_extern_abi(acc, ctx, expanded);\n                 completions::format_string::format_string(acc, ctx, original, expanded);\n+                completions::env_vars::complete_cargo_env_vars(acc, ctx, original)\n             }\n             CompletionAnalysis::UnexpandedAttrTT {\n                 colon_prefix,"}]}