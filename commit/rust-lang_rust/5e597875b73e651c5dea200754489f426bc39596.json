{"sha": "5e597875b73e651c5dea200754489f426bc39596", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVlNTk3ODc1YjczZTY1MWM1ZGVhMjAwNzU0NDg5ZjQyNmJjMzk1OTY=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-08-17T09:13:44Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-08-17T09:13:44Z"}, "message": "Rollup merge of #63505 - jgalenson:sysroot-hash, r=alexcrichton\n\nHash the remapped sysroot instead of the original.\n\nOne of the reasons that rustc builds are not reproducible is because the --sysroot path is dependent on the current directory.  We can fix this by hashing the remapped sysroot instead of the original when applicable.\n\nNote that with this patch, the hash will stay the same if both the sysroot and the remapped path change.  However, given that if the contents of the sysroot change the hash will also stay the same, this might be acceptable.  I would appreciate feedback on the best way to do this.\n\nThis helps #34902, although it does not fix it by itself.", "tree": {"sha": "44ae9984f188d9c75112b797362979f2f157dc78", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/44ae9984f188d9c75112b797362979f2f157dc78"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5e597875b73e651c5dea200754489f426bc39596", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdV8VICRBK7hj4Ov3rIwAAdHIIALDOGuY9HYJVdB9l6i78qUo2\nEioIMEczOoo53PFvtALM4Cu/wxxOzXsXjkgGA8Beye8kOSNfuPOI3PI7BHuUXnNn\nQ8WRggzg7QkR+2Fg71YTbmmEH0Klp6PZFw0TU2xXRm1STYULkAcJcYGLtN1L4TUd\nRjjYd6dHl4qpERhLnil+aX+BY/mnmWLz5NGWle4xVkxpqg0Gso23V4/QMC4iiKr/\n4TZmtotJ5W4HhDQbhAbaHKKOfOon7rIOn0FOrYLhVIVfe0x1WltYmkOrvjMCK23M\nUq+D/HgxTN6RBQ6aPyz76PPT8Bg+M8702fpgUzMAAqk7OgTVhQRzFEDXTjJ+/eY=\n=dMFd\n-----END PGP SIGNATURE-----\n", "payload": "tree 44ae9984f188d9c75112b797362979f2f157dc78\nparent 477db0506658a7db06808e24c11a1f0514da7c1c\nparent 692c0bf4ff8d1f551850962bd8d3af62033dee39\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1566033224 +0200\ncommitter GitHub <noreply@github.com> 1566033224 +0200\n\nRollup merge of #63505 - jgalenson:sysroot-hash, r=alexcrichton\n\nHash the remapped sysroot instead of the original.\n\nOne of the reasons that rustc builds are not reproducible is because the --sysroot path is dependent on the current directory.  We can fix this by hashing the remapped sysroot instead of the original when applicable.\n\nNote that with this patch, the hash will stay the same if both the sysroot and the remapped path change.  However, given that if the contents of the sysroot change the hash will also stay the same, this might be acceptable.  I would appreciate feedback on the best way to do this.\n\nThis helps #34902, although it does not fix it by itself.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5e597875b73e651c5dea200754489f426bc39596", "html_url": "https://github.com/rust-lang/rust/commit/5e597875b73e651c5dea200754489f426bc39596", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5e597875b73e651c5dea200754489f426bc39596/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "477db0506658a7db06808e24c11a1f0514da7c1c", "url": "https://api.github.com/repos/rust-lang/rust/commits/477db0506658a7db06808e24c11a1f0514da7c1c", "html_url": "https://github.com/rust-lang/rust/commit/477db0506658a7db06808e24c11a1f0514da7c1c"}, {"sha": "692c0bf4ff8d1f551850962bd8d3af62033dee39", "url": "https://api.github.com/repos/rust-lang/rust/commits/692c0bf4ff8d1f551850962bd8d3af62033dee39", "html_url": "https://github.com/rust-lang/rust/commit/692c0bf4ff8d1f551850962bd8d3af62033dee39"}], "stats": {"total": 14, "additions": 12, "deletions": 2}, "files": [{"sha": "8e3b910e0da3a89a0b8c8c56baa192f4adbc4d63", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5e597875b73e651c5dea200754489f426bc39596/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e597875b73e651c5dea200754489f426bc39596/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=5e597875b73e651c5dea200754489f426bc39596", "patch": "@@ -395,7 +395,7 @@ top_level_options!(\n         output_types: OutputTypes [TRACKED],\n         search_paths: Vec<SearchPath> [UNTRACKED],\n         libs: Vec<(String, Option<String>, Option<cstore::NativeLibraryKind>)> [TRACKED],\n-        maybe_sysroot: Option<PathBuf> [TRACKED],\n+        maybe_sysroot: Option<PathBuf> [UNTRACKED],\n \n         target_triple: TargetTriple [TRACKED],\n "}, {"sha": "45c9a7427230b0d573b6d60c42573d0423f9c4a9", "filename": "src/test/run-make-fulldeps/reproducible-build-2/Makefile", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5e597875b73e651c5dea200754489f426bc39596/src%2Ftest%2Frun-make-fulldeps%2Freproducible-build-2%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/5e597875b73e651c5dea200754489f426bc39596/src%2Ftest%2Frun-make-fulldeps%2Freproducible-build-2%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Freproducible-build-2%2FMakefile?ref=5e597875b73e651c5dea200754489f426bc39596", "patch": "@@ -5,7 +5,8 @@\n # Objects are reproducible but their path is not.\n \n all:  \\\n-\tfat_lto\n+\tfat_lto \\\n+\tsysroot\n \n fat_lto:\n \trm -rf $(TMPDIR) && mkdir $(TMPDIR)\n@@ -14,3 +15,12 @@ fat_lto:\n \tcp $(TMPDIR)/reproducible-build $(TMPDIR)/reproducible-build-a\n \t$(RUSTC) reproducible-build.rs -C lto=fat\n \tcmp \"$(TMPDIR)/reproducible-build-a\" \"$(TMPDIR)/reproducible-build\" || exit 1\n+\n+sysroot:\n+\trm -rf $(TMPDIR) && mkdir $(TMPDIR)\n+\t$(RUSTC) reproducible-build-aux.rs\n+\t$(RUSTC) reproducible-build.rs --crate-type rlib --sysroot $(shell $(RUSTC) --print sysroot) --remap-path-prefix=$(shell $(RUSTC) --print sysroot)=/sysroot\n+\tcp -r $(shell $(RUSTC) --print sysroot) $(TMPDIR)/sysroot\n+\tcp $(TMPDIR)/libreproducible_build.rlib $(TMPDIR)/libfoo.rlib\n+\t$(RUSTC) reproducible-build.rs --crate-type rlib --sysroot $(TMPDIR)/sysroot --remap-path-prefix=$(TMPDIR)/sysroot=/sysroot\n+\tcmp \"$(TMPDIR)/libreproducible_build.rlib\" \"$(TMPDIR)/libfoo.rlib\" || exit 1"}]}