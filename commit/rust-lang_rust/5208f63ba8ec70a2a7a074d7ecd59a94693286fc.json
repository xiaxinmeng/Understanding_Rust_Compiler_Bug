{"sha": "5208f63ba8ec70a2a7a074d7ecd59a94693286fc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUyMDhmNjNiYThlYzcwYTJhN2EwNzRkN2VjZDU5YTk0NjkzMjg2ZmM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-28T06:32:34Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-28T06:32:34Z"}, "message": "Auto merge of #81728 - Qwaz:fix-80335, r=joshtriplett\n\nFixes API soundness issue in join()\n\nFixes #80335", "tree": {"sha": "b7cf431d74816b089406921bb79739f94ebe0b0d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b7cf431d74816b089406921bb79739f94ebe0b0d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5208f63ba8ec70a2a7a074d7ecd59a94693286fc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5208f63ba8ec70a2a7a074d7ecd59a94693286fc", "html_url": "https://github.com/rust-lang/rust/commit/5208f63ba8ec70a2a7a074d7ecd59a94693286fc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5208f63ba8ec70a2a7a074d7ecd59a94693286fc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1df20569dd07d91ed270ea9cfc2dbb9f56700703", "url": "https://api.github.com/repos/rust-lang/rust/commits/1df20569dd07d91ed270ea9cfc2dbb9f56700703", "html_url": "https://github.com/rust-lang/rust/commit/1df20569dd07d91ed270ea9cfc2dbb9f56700703"}, {"sha": "26a62701e42d10c03ce5f2f911e7d5edeefa2f0f", "url": "https://api.github.com/repos/rust-lang/rust/commits/26a62701e42d10c03ce5f2f911e7d5edeefa2f0f", "html_url": "https://github.com/rust-lang/rust/commit/26a62701e42d10c03ce5f2f911e7d5edeefa2f0f"}], "stats": {"total": 74, "additions": 55, "deletions": 19}, "files": [{"sha": "879af7cf4dd4d5ce536569ebe79a2c43e6890f3d", "filename": "library/alloc/src/str.rs", "status": "modified", "additions": 25, "deletions": 19, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/5208f63ba8ec70a2a7a074d7ecd59a94693286fc/library%2Falloc%2Fsrc%2Fstr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5208f63ba8ec70a2a7a074d7ecd59a94693286fc/library%2Falloc%2Fsrc%2Fstr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fstr.rs?ref=5208f63ba8ec70a2a7a074d7ecd59a94693286fc", "patch": "@@ -92,8 +92,8 @@ impl<S: Borrow<str>> Join<&str> for [S] {\n     }\n }\n \n-macro_rules! spezialize_for_lengths {\n-    ($separator:expr, $target:expr, $iter:expr; $($num:expr),*) => {\n+macro_rules! specialize_for_lengths {\n+    ($separator:expr, $target:expr, $iter:expr; $($num:expr),*) => {{\n         let mut target = $target;\n         let iter = $iter;\n         let sep_bytes = $separator;\n@@ -104,19 +104,22 @@ macro_rules! spezialize_for_lengths {\n                 $num => {\n                     for s in iter {\n                         copy_slice_and_advance!(target, sep_bytes);\n-                        copy_slice_and_advance!(target, s.borrow().as_ref());\n+                        let content_bytes = s.borrow().as_ref();\n+                        copy_slice_and_advance!(target, content_bytes);\n                     }\n                 },\n             )*\n             _ => {\n                 // arbitrary non-zero size fallback\n                 for s in iter {\n                     copy_slice_and_advance!(target, sep_bytes);\n-                    copy_slice_and_advance!(target, s.borrow().as_ref());\n+                    let content_bytes = s.borrow().as_ref();\n+                    copy_slice_and_advance!(target, content_bytes);\n                 }\n             }\n         }\n-    };\n+        target\n+    }}\n }\n \n macro_rules! copy_slice_and_advance {\n@@ -155,30 +158,33 @@ where\n     // if the `len` calculation overflows, we'll panic\n     // we would have run out of memory anyway and the rest of the function requires\n     // the entire Vec pre-allocated for safety\n-    let len = sep_len\n+    let reserved_len = sep_len\n         .checked_mul(iter.len())\n         .and_then(|n| {\n             slice.iter().map(|s| s.borrow().as_ref().len()).try_fold(n, usize::checked_add)\n         })\n         .expect(\"attempt to join into collection with len > usize::MAX\");\n \n-    // crucial for safety\n-    let mut result = Vec::with_capacity(len);\n-    assert!(result.capacity() >= len);\n+    // prepare an uninitialized buffer\n+    let mut result = Vec::with_capacity(reserved_len);\n+    debug_assert!(result.capacity() >= reserved_len);\n \n     result.extend_from_slice(first.borrow().as_ref());\n \n     unsafe {\n-        {\n-            let pos = result.len();\n-            let target = result.get_unchecked_mut(pos..len);\n-\n-            // copy separator and slices over without bounds checks\n-            // generate loops with hardcoded offsets for small separators\n-            // massive improvements possible (~ x2)\n-            spezialize_for_lengths!(sep, target, iter; 0, 1, 2, 3, 4);\n-        }\n-        result.set_len(len);\n+        let pos = result.len();\n+        let target = result.get_unchecked_mut(pos..reserved_len);\n+\n+        // copy separator and slices over without bounds checks\n+        // generate loops with hardcoded offsets for small separators\n+        // massive improvements possible (~ x2)\n+        let remain = specialize_for_lengths!(sep, target, iter; 0, 1, 2, 3, 4);\n+\n+        // A weird borrow implementation may return different\n+        // slices for the length calculation and the actual copy.\n+        // Make sure we don't expose uninitialized bytes to the caller.\n+        let result_len = reserved_len - remain.len();\n+        result.set_len(result_len);\n     }\n     result\n }"}, {"sha": "6df8d8c2f354f9a6256bde30bc4e97fa9bfd68d4", "filename": "library/alloc/tests/str.rs", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/5208f63ba8ec70a2a7a074d7ecd59a94693286fc/library%2Falloc%2Ftests%2Fstr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5208f63ba8ec70a2a7a074d7ecd59a94693286fc/library%2Falloc%2Ftests%2Fstr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Ftests%2Fstr.rs?ref=5208f63ba8ec70a2a7a074d7ecd59a94693286fc", "patch": "@@ -160,6 +160,36 @@ fn test_join_for_different_lengths_with_long_separator() {\n     test_join!(\"\uff5e\uff5e\uff5e\uff5e\uff5ea\uff5e\uff5e\uff5e\uff5e\uff5ebc\", [\"\", \"a\", \"bc\"], \"\uff5e\uff5e\uff5e\uff5e\uff5e\");\n }\n \n+#[test]\n+fn test_join_isue_80335() {\n+    use core::{borrow::Borrow, cell::Cell};\n+\n+    struct WeirdBorrow {\n+        state: Cell<bool>,\n+    }\n+\n+    impl Default for WeirdBorrow {\n+        fn default() -> Self {\n+            WeirdBorrow { state: Cell::new(false) }\n+        }\n+    }\n+\n+    impl Borrow<str> for WeirdBorrow {\n+        fn borrow(&self) -> &str {\n+            let state = self.state.get();\n+            if state {\n+                \"0\"\n+            } else {\n+                self.state.set(true);\n+                \"123456\"\n+            }\n+        }\n+    }\n+\n+    let arr: [WeirdBorrow; 3] = Default::default();\n+    test_join!(\"0-0-0\", arr, \"-\");\n+}\n+\n #[test]\n #[cfg_attr(miri, ignore)] // Miri is too slow\n fn test_unsafe_slice() {"}]}