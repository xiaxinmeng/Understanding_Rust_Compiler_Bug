{"sha": "bdbe392a13bc9782b98de193c3751b9d96bb5fcc", "node_id": "C_kwDOAAsO6NoAKGJkYmUzOTJhMTNiYzk3ODJiOThkZTE5M2MzNzUxYjlkOTZiYjVmY2M", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-21T23:20:04Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-21T23:20:04Z"}, "message": "Auto merge of #105613 - Nilstrieb:rename-assert_uninit_valid, r=RalfJung\n\nRename `assert_uninit_valid` intrinsic\n\nIt's not about \"uninit\" anymore but about \"filling with 0x01 bytes\" so the name should at least try to reflect that.\n\nThis is actually not fully correct though, as it does still panic for all uninit with `-Zstrict-init-checks`. I'm not sure what the best way is to deal with that not causing confusion. I guess we could just remove the flag? I don't think having it makes a lot of sense anymore with the direction that we have chose to go. It could be relevant again if #100423 lands so removing it may be a bit over eager.\n\nr? `@RalfJung`", "tree": {"sha": "860c50e7741ae8896129546d16d0a65956364b33", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/860c50e7741ae8896129546d16d0a65956364b33"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bdbe392a13bc9782b98de193c3751b9d96bb5fcc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bdbe392a13bc9782b98de193c3751b9d96bb5fcc", "html_url": "https://github.com/rust-lang/rust/commit/bdbe392a13bc9782b98de193c3751b9d96bb5fcc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b569c9dc57ee22b6ff94563af856909763dfa24b", "url": "https://api.github.com/repos/rust-lang/rust/commits/b569c9dc57ee22b6ff94563af856909763dfa24b", "html_url": "https://github.com/rust-lang/rust/commit/b569c9dc57ee22b6ff94563af856909763dfa24b"}, {"sha": "6f21ba4a06b7fa17113b7029c4aa7805db16aa32", "url": "https://api.github.com/repos/rust-lang/rust/commits/6f21ba4a06b7fa17113b7029c4aa7805db16aa32", "html_url": "https://github.com/rust-lang/rust/commit/6f21ba4a06b7fa17113b7029c4aa7805db16aa32"}], "stats": {"total": 43, "additions": 24, "deletions": 19}, "files": [{"sha": "e4ac89a7bec6b245d17cf41828f392a76df8e4dc", "filename": "compiler/rustc_codegen_cranelift/src/intrinsics/mod.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fmod.rs?ref=bdbe392a13bc9782b98de193c3751b9d96bb5fcc", "patch": "@@ -644,7 +644,7 @@ fn codegen_regular_intrinsic_call<'tcx>(\n             let res = CValue::by_val(res, arg.layout());\n             ret.write_cvalue(fx, res);\n         }\n-        sym::assert_inhabited | sym::assert_zero_valid | sym::assert_uninit_valid => {\n+        sym::assert_inhabited | sym::assert_zero_valid | sym::assert_mem_uninitialized_valid => {\n             intrinsic_args!(fx, args => (); intrinsic);\n \n             let layout = fx.layout_of(substs.type_at(0));\n@@ -673,7 +673,9 @@ fn codegen_regular_intrinsic_call<'tcx>(\n                 return;\n             }\n \n-            if intrinsic == sym::assert_uninit_valid && !fx.tcx.permits_uninit_init(layout) {\n+            if intrinsic == sym::assert_mem_uninitialized_valid\n+                && !fx.tcx.permits_uninit_init(layout)\n+            {\n                 with_no_trimmed_paths!({\n                     crate::base::codegen_panic(\n                         fx,"}, {"sha": "cff72048ead08058c20171a520d0b0b9cd42ed20", "filename": "compiler/rustc_codegen_ssa/src/mir/block.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs?ref=bdbe392a13bc9782b98de193c3751b9d96bb5fcc", "patch": "@@ -663,12 +663,12 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n         enum AssertIntrinsic {\n             Inhabited,\n             ZeroValid,\n-            UninitValid,\n+            MemUninitializedValid,\n         }\n         let panic_intrinsic = intrinsic.and_then(|i| match i {\n             sym::assert_inhabited => Some(AssertIntrinsic::Inhabited),\n             sym::assert_zero_valid => Some(AssertIntrinsic::ZeroValid),\n-            sym::assert_uninit_valid => Some(AssertIntrinsic::UninitValid),\n+            sym::assert_mem_uninitialized_valid => Some(AssertIntrinsic::MemUninitializedValid),\n             _ => None,\n         });\n         if let Some(intrinsic) = panic_intrinsic {\n@@ -679,7 +679,7 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n             let do_panic = match intrinsic {\n                 Inhabited => layout.abi.is_uninhabited(),\n                 ZeroValid => !bx.tcx().permits_zero_init(layout),\n-                UninitValid => !bx.tcx().permits_uninit_init(layout),\n+                MemUninitializedValid => !bx.tcx().permits_uninit_init(layout),\n             };\n             Some(if do_panic {\n                 let msg_str = with_no_visible_paths!({"}, {"sha": "d4c99af43c3863ef6fdc1e4c56435018c5b56f7e", "filename": "compiler/rustc_const_eval/src/interpret/intrinsics.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics.rs?ref=bdbe392a13bc9782b98de193c3751b9d96bb5fcc", "patch": "@@ -428,7 +428,9 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n             sym::transmute => {\n                 self.copy_op(&args[0], dest, /*allow_transmute*/ true)?;\n             }\n-            sym::assert_inhabited | sym::assert_zero_valid | sym::assert_uninit_valid => {\n+            sym::assert_inhabited\n+            | sym::assert_zero_valid\n+            | sym::assert_mem_uninitialized_valid => {\n                 let ty = instance.substs.type_at(0);\n                 let layout = self.layout_of(ty)?;\n \n@@ -460,7 +462,7 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n                     }\n                 }\n \n-                if intrinsic_name == sym::assert_uninit_valid {\n+                if intrinsic_name == sym::assert_mem_uninitialized_valid {\n                     let should_panic = !self.tcx.permits_uninit_init(layout);\n \n                     if should_panic {"}, {"sha": "598dc2dca5c6288b88eab85e96c9f95d0de8fa1b", "filename": "compiler/rustc_hir_analysis/src/check/intrinsic.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fintrinsic.rs?ref=bdbe392a13bc9782b98de193c3751b9d96bb5fcc", "patch": "@@ -75,7 +75,7 @@ pub fn intrinsic_operation_unsafety(tcx: TyCtxt<'_>, intrinsic_id: DefId) -> hir\n         sym::abort\n         | sym::assert_inhabited\n         | sym::assert_zero_valid\n-        | sym::assert_uninit_valid\n+        | sym::assert_mem_uninitialized_valid\n         | sym::size_of\n         | sym::min_align_of\n         | sym::needs_drop\n@@ -193,9 +193,9 @@ pub fn check_intrinsic_type(tcx: TyCtxt<'_>, it: &hir::ForeignItem<'_>) {\n             }\n             sym::rustc_peek => (1, vec![param(0)], param(0)),\n             sym::caller_location => (0, vec![], tcx.caller_location_ty()),\n-            sym::assert_inhabited | sym::assert_zero_valid | sym::assert_uninit_valid => {\n-                (1, Vec::new(), tcx.mk_unit())\n-            }\n+            sym::assert_inhabited\n+            | sym::assert_zero_valid\n+            | sym::assert_mem_uninitialized_valid => (1, Vec::new(), tcx.mk_unit()),\n             sym::forget => (1, vec![param(0)], tcx.mk_unit()),\n             sym::transmute => (2, vec![param(0)], param(1)),\n             sym::prefetch_read_data"}, {"sha": "e802663471341cdd1eba4b0549c313e2d98ea969", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=bdbe392a13bc9782b98de193c3751b9d96bb5fcc", "patch": "@@ -376,9 +376,9 @@ symbols! {\n         assert_eq_macro,\n         assert_inhabited,\n         assert_macro,\n+        assert_mem_uninitialized_valid,\n         assert_ne_macro,\n         assert_receiver_is_total_eq,\n-        assert_uninit_valid,\n         assert_zero_valid,\n         asserting,\n         associated_const_equality,"}, {"sha": "a521905a9e735b37296ef50bd906a30fe5eb7779", "filename": "library/core/src/intrinsics.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/library%2Fcore%2Fsrc%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/library%2Fcore%2Fsrc%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fintrinsics.rs?ref=bdbe392a13bc9782b98de193c3751b9d96bb5fcc", "patch": "@@ -959,13 +959,13 @@ extern \"rust-intrinsic\" {\n     #[rustc_safe_intrinsic]\n     pub fn assert_zero_valid<T>();\n \n-    /// A guard for unsafe functions that cannot ever be executed if `T` has invalid\n-    /// bit patterns: This will statically either panic, or do nothing.\n+    /// A guard for `std::mem::uninitialized`. This will statically either panic, or do nothing.\n     ///\n     /// This intrinsic does not have a stable counterpart.\n     #[rustc_const_unstable(feature = \"const_assert_type2\", issue = \"none\")]\n     #[rustc_safe_intrinsic]\n-    pub fn assert_uninit_valid<T>();\n+    #[cfg(not(bootstrap))]\n+    pub fn assert_mem_uninitialized_valid<T>();\n \n     /// Gets a reference to a static `Location` indicating where it was called.\n     ///"}, {"sha": "5e01ccc07d8fdbf7d1b559004688fb8916311e1f", "filename": "library/core/src/mem/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/library%2Fcore%2Fsrc%2Fmem%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/library%2Fcore%2Fsrc%2Fmem%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fmem%2Fmod.rs?ref=bdbe392a13bc9782b98de193c3751b9d96bb5fcc", "patch": "@@ -682,7 +682,8 @@ pub unsafe fn zeroed<T>() -> T {\n pub unsafe fn uninitialized<T>() -> T {\n     // SAFETY: the caller must guarantee that an uninitialized value is valid for `T`.\n     unsafe {\n-        intrinsics::assert_uninit_valid::<T>();\n+        #[cfg(not(bootstrap))] // If the compiler hits this itself then it deserves the UB.\n+        intrinsics::assert_mem_uninitialized_valid::<T>();\n         let mut val = MaybeUninit::<T>::uninit();\n \n         // Fill memory with 0x01, as an imperfect mitigation for old code that uses this function on"}, {"sha": "b4fd423becd9d15bb5c880a5b1265b32551c5c81", "filename": "src/test/ui/consts/assert-type-intrinsics.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/src%2Ftest%2Fui%2Fconsts%2Fassert-type-intrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/src%2Ftest%2Fui%2Fconsts%2Fassert-type-intrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fassert-type-intrinsics.rs?ref=bdbe392a13bc9782b98de193c3751b9d96bb5fcc", "patch": "@@ -13,7 +13,7 @@ fn main() {\n         //~^ERROR: evaluation of constant value failed\n     };\n     const _BAD2: () = {\n-        intrinsics::assert_uninit_valid::<&'static i32>();\n+        intrinsics::assert_mem_uninitialized_valid::<&'static i32>();\n         //~^ERROR: evaluation of constant value failed\n     };\n     const _BAD3: () = {"}, {"sha": "70aec91e22622c6ace0b5f046330c6d939d6a518", "filename": "src/test/ui/consts/assert-type-intrinsics.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/src%2Ftest%2Fui%2Fconsts%2Fassert-type-intrinsics.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bdbe392a13bc9782b98de193c3751b9d96bb5fcc/src%2Ftest%2Fui%2Fconsts%2Fassert-type-intrinsics.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fassert-type-intrinsics.stderr?ref=bdbe392a13bc9782b98de193c3751b9d96bb5fcc", "patch": "@@ -7,8 +7,8 @@ LL |         MaybeUninit::<!>::uninit().assume_init();\n error[E0080]: evaluation of constant value failed\n   --> $DIR/assert-type-intrinsics.rs:16:9\n    |\n-LL |         intrinsics::assert_uninit_valid::<&'static i32>();\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ aborted execution: attempted to leave type `&i32` uninitialized, which is invalid\n+LL |         intrinsics::assert_mem_uninitialized_valid::<&'static i32>();\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ aborted execution: attempted to leave type `&i32` uninitialized, which is invalid\n \n error[E0080]: evaluation of constant value failed\n   --> $DIR/assert-type-intrinsics.rs:20:9"}]}