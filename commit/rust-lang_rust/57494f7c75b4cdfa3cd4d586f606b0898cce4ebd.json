{"sha": "57494f7c75b4cdfa3cd4d586f606b0898cce4ebd", "node_id": "C_kwDOAAsO6NoAKDU3NDk0ZjdjNzViNGNkZmEzY2Q0ZDU4NmY2MDZiMDg5OGNjZTRlYmQ", "commit": {"author": {"name": "Ken Matsui", "email": "26405363+ken-matsui@users.noreply.github.com", "date": "2021-11-13T07:39:54Z"}, "committer": {"name": "Ken Matsui", "email": "26405363+ken-matsui@users.noreply.github.com", "date": "2021-11-23T15:24:13Z"}, "message": "Suggestion to wrap inner types using `allocator_api` in tuple", "tree": {"sha": "4bb36bb385a75808633d247a4b30b6163ba9066d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4bb36bb385a75808633d247a4b30b6163ba9066d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEENhGM023oMzS0St3kEDNgsymO5DMFAmGdB50ACgkQEDNgsymO\n5DN3kBAAzG1au6vyIuThYML70eH7XXsRHRfeRBkuZrOv/3gPAygniHQdx9BtJX/g\nECQAjUbnNMp+pAx1g0wujCvguJaJZwoVJndJAd4LrJf/xLuaX2txMshjSm7IA2O2\n/fJ5+C3NCoBh1ZM8v8EkcguBTcV8Wczu3uyq73GFsdcaixhUgeE6rWjf8UacDRxb\n4TvpUGB9rBUEyECBJuF3OMTu30Um/h468sbPVSAWB5/gZsgextbZdo/3I7kjAYBQ\nZNmNg1j1jWq0ySEfhqUqsY+8DfJXRZybFOVUZ2HzHiszFcPIHAXv7ohOp0D6nLzj\nk8zBh070XfPX/6erd1X4WHiBE6mVJ9x9nS3gN1OA+n10SLytU0S7/JrExrr3H83q\nm2FNe5BkJoiiGtioO3wrSjjgzZeMo1OYlIuBC0vJ48LdtzqtxvSYwUgvQ+mwpc9A\nfO6n3wnZc9zdkgw8Q7R0EYYZPZOwmPg4u0OfOHZ+R7fCfzI5Cge59e5dW7TcNN7x\nsKIEyDUqLw36o/op1EvaGFXAj3EYPpnc3XY6b+bD8R6GEQH+mKyJsAalIW6Mav5a\n82qfFEK90HabieMTp7ZL4hEeq5Y3XJ+Ut72b9XLHuNoqoiV9bfv98bQG3JnYrm/5\n3rVeqKd57Rr9wjf4bHgeO3zWT/VbSCN3aAADqbIS8U7BpFdfb+w=\n=lldU\n-----END PGP SIGNATURE-----", "payload": "tree 4bb36bb385a75808633d247a4b30b6163ba9066d\nparent e90c5fbbc5df5c81267747daeb937d4e955ce6ad\nauthor Ken Matsui <26405363+ken-matsui@users.noreply.github.com> 1636789194 +0900\ncommitter Ken Matsui <26405363+ken-matsui@users.noreply.github.com> 1637681053 +0900\n\nSuggestion to wrap inner types using `allocator_api` in tuple\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd", "html_url": "https://github.com/rust-lang/rust/commit/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd/comments", "author": {"login": "ken-matsui", "id": 26405363, "node_id": "MDQ6VXNlcjI2NDA1MzYz", "avatar_url": "https://avatars.githubusercontent.com/u/26405363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ken-matsui", "html_url": "https://github.com/ken-matsui", "followers_url": "https://api.github.com/users/ken-matsui/followers", "following_url": "https://api.github.com/users/ken-matsui/following{/other_user}", "gists_url": "https://api.github.com/users/ken-matsui/gists{/gist_id}", "starred_url": "https://api.github.com/users/ken-matsui/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ken-matsui/subscriptions", "organizations_url": "https://api.github.com/users/ken-matsui/orgs", "repos_url": "https://api.github.com/users/ken-matsui/repos", "events_url": "https://api.github.com/users/ken-matsui/events{/privacy}", "received_events_url": "https://api.github.com/users/ken-matsui/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ken-matsui", "id": 26405363, "node_id": "MDQ6VXNlcjI2NDA1MzYz", "avatar_url": "https://avatars.githubusercontent.com/u/26405363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ken-matsui", "html_url": "https://github.com/ken-matsui", "followers_url": "https://api.github.com/users/ken-matsui/followers", "following_url": "https://api.github.com/users/ken-matsui/following{/other_user}", "gists_url": "https://api.github.com/users/ken-matsui/gists{/gist_id}", "starred_url": "https://api.github.com/users/ken-matsui/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ken-matsui/subscriptions", "organizations_url": "https://api.github.com/users/ken-matsui/orgs", "repos_url": "https://api.github.com/users/ken-matsui/repos", "events_url": "https://api.github.com/users/ken-matsui/events{/privacy}", "received_events_url": "https://api.github.com/users/ken-matsui/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e90c5fbbc5df5c81267747daeb937d4e955ce6ad", "url": "https://api.github.com/repos/rust-lang/rust/commits/e90c5fbbc5df5c81267747daeb937d4e955ce6ad", "html_url": "https://github.com/rust-lang/rust/commit/e90c5fbbc5df5c81267747daeb937d4e955ce6ad"}], "stats": {"total": 121, "additions": 113, "deletions": 8}, "files": [{"sha": "8a5fc5feeb71b2d65dc0192c2f7dea996db2e224", "filename": "compiler/rustc_middle/src/middle/stability.rs", "status": "modified", "additions": 53, "deletions": 8, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd/compiler%2Frustc_middle%2Fsrc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd/compiler%2Frustc_middle%2Fsrc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmiddle%2Fstability.rs?ref=57494f7c75b4cdfa3cd4d586f606b0898cce4ebd", "patch": "@@ -3,7 +3,7 @@\n \n pub use self::StabilityLevel::*;\n \n-use crate::ty::{self, TyCtxt};\n+use crate::ty::{self, DefIdTree, TyCtxt};\n use rustc_ast::NodeId;\n use rustc_attr::{self as attr, ConstStability, Deprecation, Stability};\n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n@@ -90,6 +90,7 @@ pub fn report_unstable(\n     feature: Symbol,\n     reason: Option<Symbol>,\n     issue: Option<NonZeroU32>,\n+    suggestion: Option<(Span, String, String, Applicability)>,\n     is_soft: bool,\n     span: Span,\n     soft_handler: impl FnOnce(&'static Lint, Span, &str),\n@@ -116,8 +117,12 @@ pub fn report_unstable(\n         if is_soft {\n             soft_handler(SOFT_UNSTABLE, span, &msg)\n         } else {\n-            feature_err_issue(&sess.parse_sess, feature, span, GateIssue::Library(issue), &msg)\n-                .emit();\n+            let mut err =\n+                feature_err_issue(&sess.parse_sess, feature, span, GateIssue::Library(issue), &msg);\n+            if let Some((inner_types, ref msg, sugg, applicability)) = suggestion {\n+                err.span_suggestion(inner_types, msg, sugg, applicability);\n+            }\n+            err.emit();\n         }\n     }\n }\n@@ -271,7 +276,13 @@ pub enum EvalResult {\n     Allow,\n     /// We cannot use the item because it is unstable and we did not provide the\n     /// corresponding feature gate.\n-    Deny { feature: Symbol, reason: Option<Symbol>, issue: Option<NonZeroU32>, is_soft: bool },\n+    Deny {\n+        feature: Symbol,\n+        reason: Option<Symbol>,\n+        issue: Option<NonZeroU32>,\n+        suggestion: Option<(Span, String, String, Applicability)>,\n+        is_soft: bool,\n+    },\n     /// The item does not have the `#[stable]` or `#[unstable]` marker assigned.\n     Unmarked,\n }\n@@ -292,6 +303,32 @@ fn skip_stability_check_due_to_privacy(tcx: TyCtxt<'_>, def_id: DefId) -> bool {\n     }\n }\n \n+// See issue #83250.\n+fn suggestion_for_allocator_api(\n+    tcx: TyCtxt<'_>,\n+    def_id: DefId,\n+    span: Span,\n+    feature: Symbol,\n+) -> Option<(Span, String, String, Applicability)> {\n+    if feature == sym::allocator_api {\n+        if let Some(trait_) = tcx.parent(def_id) {\n+            if tcx.is_diagnostic_item(sym::Vec, trait_) {\n+                let sm = tcx.sess.parse_sess.source_map();\n+                let inner_types = sm.span_extend_to_prev_char(span, '<', true);\n+                if let Ok(snippet) = sm.span_to_snippet(inner_types) {\n+                    return Some((\n+                        inner_types,\n+                        \"consider wrapping the inner types in tuple\".to_string(),\n+                        format!(\"({})\", snippet),\n+                        Applicability::MaybeIncorrect,\n+                    ));\n+                }\n+            }\n+        }\n+    }\n+    None\n+}\n+\n impl<'tcx> TyCtxt<'tcx> {\n     /// Evaluates the stability of an item.\n     ///\n@@ -406,7 +443,8 @@ impl<'tcx> TyCtxt<'tcx> {\n                     }\n                 }\n \n-                EvalResult::Deny { feature, reason, issue, is_soft }\n+                let suggestion = suggestion_for_allocator_api(self, def_id, span, feature);\n+                EvalResult::Deny { feature, reason, issue, suggestion, is_soft }\n             }\n             Some(_) => {\n                 // Stable APIs are always ok to call and deprecated APIs are\n@@ -457,9 +495,16 @@ impl<'tcx> TyCtxt<'tcx> {\n         };\n         match self.eval_stability(def_id, id, span, method_span) {\n             EvalResult::Allow => {}\n-            EvalResult::Deny { feature, reason, issue, is_soft } => {\n-                report_unstable(self.sess, feature, reason, issue, is_soft, span, soft_handler)\n-            }\n+            EvalResult::Deny { feature, reason, issue, suggestion, is_soft } => report_unstable(\n+                self.sess,\n+                feature,\n+                reason,\n+                issue,\n+                suggestion,\n+                is_soft,\n+                span,\n+                soft_handler,\n+            ),\n             EvalResult::Unmarked => unmarked(span, def_id),\n         }\n     }"}, {"sha": "28dbce0471eaf87a92adf72e408c66799b9aad2a", "filename": "compiler/rustc_resolve/src/macros.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs?ref=57494f7c75b4cdfa3cd4d586f606b0898cce4ebd", "patch": "@@ -1133,6 +1133,7 @@ impl<'a> Resolver<'a> {\n                         feature,\n                         reason,\n                         issue,\n+                        None,\n                         is_soft,\n                         span,\n                         soft_handler,"}, {"sha": "eb4d5d17674072201517179457f1b502181b3970", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=57494f7c75b4cdfa3cd4d586f606b0898cce4ebd", "patch": "@@ -308,6 +308,7 @@ symbols! {\n         alloc_layout,\n         alloc_zeroed,\n         allocator,\n+        allocator_api,\n         allocator_internals,\n         allow,\n         allow_fail,"}, {"sha": "fac52ab77c68ca919fc358afe1444b0c88bf1d8f", "filename": "src/test/ui/stability-attribute/suggest-vec-allocator-api.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd/src%2Ftest%2Fui%2Fstability-attribute%2Fsuggest-vec-allocator-api.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd/src%2Ftest%2Fui%2Fstability-attribute%2Fsuggest-vec-allocator-api.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fstability-attribute%2Fsuggest-vec-allocator-api.rs?ref=57494f7c75b4cdfa3cd4d586f606b0898cce4ebd", "patch": "@@ -0,0 +1,9 @@\n+fn main() {\n+    let _: Vec<u8, _> = vec![]; //~ ERROR use of unstable library feature 'allocator_api'\n+    #[rustfmt::skip]\n+    let _: Vec<\n+        String,\n+        _> = vec![]; //~ ERROR use of unstable library feature 'allocator_api'\n+    let _ = Vec::<u16, _>::new(); //~ ERROR use of unstable library feature 'allocator_api'\n+    let _boxed: Box<u32, _> = Box::new(10); //~ ERROR use of unstable library feature 'allocator_api'\n+}"}, {"sha": "41e5787b8c2debfde5ba550be9b33baf1568e286", "filename": "src/test/ui/stability-attribute/suggest-vec-allocator-api.stderr", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd/src%2Ftest%2Fui%2Fstability-attribute%2Fsuggest-vec-allocator-api.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/57494f7c75b4cdfa3cd4d586f606b0898cce4ebd/src%2Ftest%2Fui%2Fstability-attribute%2Fsuggest-vec-allocator-api.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fstability-attribute%2Fsuggest-vec-allocator-api.stderr?ref=57494f7c75b4cdfa3cd4d586f606b0898cce4ebd", "patch": "@@ -0,0 +1,49 @@\n+error[E0658]: use of unstable library feature 'allocator_api'\n+  --> $DIR/suggest-vec-allocator-api.rs:2:20\n+   |\n+LL |     let _: Vec<u8, _> = vec![];\n+   |                ----^\n+   |                |\n+   |                help: consider wrapping the inner types in tuple: `(u8, _)`\n+   |\n+   = note: see issue #32838 <https://github.com/rust-lang/rust/issues/32838> for more information\n+   = help: add `#![feature(allocator_api)]` to the crate attributes to enable\n+\n+error[E0658]: use of unstable library feature 'allocator_api'\n+  --> $DIR/suggest-vec-allocator-api.rs:6:9\n+   |\n+LL |         _> = vec![];\n+   |         ^\n+   |\n+   = note: see issue #32838 <https://github.com/rust-lang/rust/issues/32838> for more information\n+   = help: add `#![feature(allocator_api)]` to the crate attributes to enable\n+help: consider wrapping the inner types in tuple\n+   |\n+LL ~     let _: Vec<(\n+LL +         String,\n+LL ~         _)> = vec![];\n+   |\n+\n+error[E0658]: use of unstable library feature 'allocator_api'\n+  --> $DIR/suggest-vec-allocator-api.rs:8:26\n+   |\n+LL |     let _boxed: Box<u32, _> = Box::new(10);\n+   |                          ^\n+   |\n+   = note: see issue #32838 <https://github.com/rust-lang/rust/issues/32838> for more information\n+   = help: add `#![feature(allocator_api)]` to the crate attributes to enable\n+\n+error[E0658]: use of unstable library feature 'allocator_api'\n+  --> $DIR/suggest-vec-allocator-api.rs:7:24\n+   |\n+LL |     let _ = Vec::<u16, _>::new();\n+   |                   -----^\n+   |                   |\n+   |                   help: consider wrapping the inner types in tuple: `(u16, _)`\n+   |\n+   = note: see issue #32838 <https://github.com/rust-lang/rust/issues/32838> for more information\n+   = help: add `#![feature(allocator_api)]` to the crate attributes to enable\n+\n+error: aborting due to 4 previous errors\n+\n+For more information about this error, try `rustc --explain E0658`."}]}