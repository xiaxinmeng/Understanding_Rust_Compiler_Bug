{"sha": "4c686721c0fe4dd8fef74acb502c2327e0054dff", "node_id": "C_kwDOAAsO6NoAKDRjNjg2NzIxYzBmZTRkZDhmZWY3NGFjYjUwMmMyMzI3ZTAwNTRkZmY", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-12-18T18:32:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-12-18T18:32:20Z"}, "message": "Merge #11047\n\n11047: internal: Prepare Code extension for bundling r=lnicola a=lnicola\n\nCC #10483\r\n\r\nThis is slightly ugly, but we'll be able to clean it up after ripping the download parts (unless we decide to temporarily drop support for the nightlies).\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>", "tree": {"sha": "01132deef76e0bbe7e0af0c3dde7db79de4d52fc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/01132deef76e0bbe7e0af0c3dde7db79de4d52fc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4c686721c0fe4dd8fef74acb502c2327e0054dff", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhvik0CRBK7hj4Ov3rIwAAYgUIADdegGAJOuTKOyG4gjR44iKy\nDxzKB0VKJQYqyyqaNhwQmg2EAOjrkH0hLvNKOK8QPhw2ewQXzaXOs1iC6UyQHIbl\n8GOTmSuuv9Ro8WLxdpTP/iExFdQHe9Lj6iRRTUg5hBReqLRxmLDsITvHUKFkFuQC\nCTmTGkKFEEkPt3vdsA6de34CheDMs2v8UB6iA+cLhZNNw7yU6BQ66yj4u23FegIZ\nPq64OP942NeY9mUti5DCIboidkJgmS2Gnt8d0JEbSgQQOAWPgQEhlv0dsijhn2Gr\nzksLNIoppSFQxHrpYLAqq22jRuHHeRvXacN9u4wDaM5I8Fzegdy2hlwf5BDbfEg=\n=EKoT\n-----END PGP SIGNATURE-----\n", "payload": "tree 01132deef76e0bbe7e0af0c3dde7db79de4d52fc\nparent 81d0096000dd2e30144143235f76546c34ddf5cd\nparent 262a698875b4b46b63137777e8d948ee22fef240\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1639852340 +0000\ncommitter GitHub <noreply@github.com> 1639852340 +0000\n\nMerge #11047\n\n11047: internal: Prepare Code extension for bundling r=lnicola a=lnicola\n\nCC #10483\r\n\r\nThis is slightly ugly, but we'll be able to clean it up after ripping the download parts (unless we decide to temporarily drop support for the nightlies).\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4c686721c0fe4dd8fef74acb502c2327e0054dff", "html_url": "https://github.com/rust-lang/rust/commit/4c686721c0fe4dd8fef74acb502c2327e0054dff", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4c686721c0fe4dd8fef74acb502c2327e0054dff/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "81d0096000dd2e30144143235f76546c34ddf5cd", "url": "https://api.github.com/repos/rust-lang/rust/commits/81d0096000dd2e30144143235f76546c34ddf5cd", "html_url": "https://github.com/rust-lang/rust/commit/81d0096000dd2e30144143235f76546c34ddf5cd"}, {"sha": "262a698875b4b46b63137777e8d948ee22fef240", "url": "https://api.github.com/repos/rust-lang/rust/commits/262a698875b4b46b63137777e8d948ee22fef240", "html_url": "https://github.com/rust-lang/rust/commit/262a698875b4b46b63137777e8d948ee22fef240"}], "stats": {"total": 20, "additions": 19, "deletions": 1}, "files": [{"sha": "cfcad7c66b7c876b751b13237a5f7a8c8153e786", "filename": "docs/user/manual.adoc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4c686721c0fe4dd8fef74acb502c2327e0054dff/docs%2Fuser%2Fmanual.adoc", "raw_url": "https://github.com/rust-lang/rust/raw/4c686721c0fe4dd8fef74acb502c2327e0054dff/docs%2Fuser%2Fmanual.adoc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Fmanual.adoc?ref=4c686721c0fe4dd8fef74acb502c2327e0054dff", "patch": "@@ -74,6 +74,8 @@ The server binary is stored in:\n * macOS: `~/Library/Application\\ Support/Code/User/globalStorage/matklad.rust-analyzer`\n * Windows: `%APPDATA%\\Code\\User\\globalStorage\\matklad.rust-analyzer`\n \n+However, if you are using a version of the extension with a bundled server binary and you are not running NixOS, the server binary might be instead running from: `~/.vscode/extensions/matklad.rust-analyzer-VERSION`.\n+\n Note that we only support two most recent versions of VS Code.\n \n ==== Updates"}, {"sha": "09dc27056b37a52c24f0a33ccb6049200a7f9de5", "filename": "editors/code/.vscodeignore", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4c686721c0fe4dd8fef74acb502c2327e0054dff/editors%2Fcode%2F.vscodeignore", "raw_url": "https://github.com/rust-lang/rust/raw/4c686721c0fe4dd8fef74acb502c2327e0054dff/editors%2Fcode%2F.vscodeignore", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2F.vscodeignore?ref=4c686721c0fe4dd8fef74acb502c2327e0054dff", "patch": "@@ -10,4 +10,5 @@\n !package-lock.json\n !package.json\n !ra_syntax_tree.tmGrammar.json\n+!server\n !README.md"}, {"sha": "cb0868db59798702252ba66f4793aad1fcd26ae7", "filename": "editors/code/src/config.ts", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4c686721c0fe4dd8fef74acb502c2327e0054dff/editors%2Fcode%2Fsrc%2Fconfig.ts", "raw_url": "https://github.com/rust-lang/rust/raw/4c686721c0fe4dd8fef74acb502c2327e0054dff/editors%2Fcode%2Fsrc%2Fconfig.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fconfig.ts?ref=4c686721c0fe4dd8fef74acb502c2327e0054dff", "patch": "@@ -36,9 +36,11 @@ export class Config {\n     } = vscode.extensions.getExtension(this.extensionId)!.packageJSON;\n \n     readonly globalStorageUri: vscode.Uri;\n+    readonly installUri: vscode.Uri;\n \n     constructor(ctx: vscode.ExtensionContext) {\n         this.globalStorageUri = ctx.globalStorageUri;\n+        this.installUri = ctx.extensionUri;\n         vscode.workspace.onDidChangeConfiguration(this.onDidChangeConfiguration, this, ctx.subscriptions);\n         this.refreshLogging();\n     }"}, {"sha": "e2a9c4c737deee7c665ed800748f39f4d9fab571", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/4c686721c0fe4dd8fef74acb502c2327e0054dff/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/4c686721c0fe4dd8fef74acb502c2327e0054dff/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=4c686721c0fe4dd8fef74acb502c2327e0054dff", "patch": "@@ -345,7 +345,20 @@ async function getServer(config: Config, state: PersistentState): Promise<string\n     }\n     const ext = platform.indexOf(\"-windows-\") !== -1 ? \".exe\" : \"\";\n     const dest = vscode.Uri.joinPath(config.globalStorageUri, `rust-analyzer-${platform}${ext}`);\n-    const exists = await vscode.workspace.fs.stat(dest).then(() => true, () => false);\n+    const bundled = vscode.Uri.joinPath(config.installUri, \"server\", `rust-analyzer${ext}`);\n+    const bundledExists = await vscode.workspace.fs.stat(bundled).then(() => true, () => false);\n+    let exists = await vscode.workspace.fs.stat(dest).then(() => true, () => false);\n+    if (bundledExists) {\n+        await state.updateServerVersion(config.package.version);\n+        if (!await isNixOs()) {\n+            return bundled.fsPath;\n+        }\n+        if (!exists) {\n+            await vscode.workspace.fs.copy(bundled, dest);\n+            await patchelf(dest);\n+            exists = true;\n+        }\n+    }\n     if (!exists) {\n         await state.updateServerVersion(undefined);\n     }"}]}