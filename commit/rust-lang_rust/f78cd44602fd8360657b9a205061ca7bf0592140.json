{"sha": "f78cd44602fd8360657b9a205061ca7bf0592140", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY3OGNkNDQ2MDJmZDgzNjA2NTdiOWEyMDUwNjFjYTdiZjA1OTIxNDA=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2021-09-16T12:48:33Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2021-09-16T12:48:33Z"}, "message": "Optimize ThreadInfo::with\n\nThe RefCell is now borrowed exactly once. In addition a code sequence\nthat contains an unwrap that is guaranteed to never panic at runtime is\nreplaced with get_or_insert_with, which makes the intended behavior\nclearer and will not emit code to panic even without optimizations.", "tree": {"sha": "128288bda3e581e946307d0f4e0f8f4266e28cc9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/128288bda3e581e946307d0f4e0f8f4266e28cc9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f78cd44602fd8360657b9a205061ca7bf0592140", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f78cd44602fd8360657b9a205061ca7bf0592140", "html_url": "https://github.com/rust-lang/rust/commit/f78cd44602fd8360657b9a205061ca7bf0592140", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f78cd44602fd8360657b9a205061ca7bf0592140/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "af7eededaa2a239c1e23c40024cf557a4b83fffa", "url": "https://api.github.com/repos/rust-lang/rust/commits/af7eededaa2a239c1e23c40024cf557a4b83fffa", "html_url": "https://github.com/rust-lang/rust/commit/af7eededaa2a239c1e23c40024cf557a4b83fffa"}], "stats": {"total": 13, "additions": 7, "deletions": 6}, "files": [{"sha": "a0dbdcd979addb8f792bc4c33cfac1864298c86c", "filename": "library/std/src/sys_common/thread_info.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/f78cd44602fd8360657b9a205061ca7bf0592140/library%2Fstd%2Fsrc%2Fsys_common%2Fthread_info.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f78cd44602fd8360657b9a205061ca7bf0592140/library%2Fstd%2Fsrc%2Fsys_common%2Fthread_info.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys_common%2Fthread_info.rs?ref=f78cd44602fd8360657b9a205061ca7bf0592140", "patch": "@@ -17,12 +17,13 @@ impl ThreadInfo {\n         F: FnOnce(&mut ThreadInfo) -> R,\n     {\n         THREAD_INFO\n-            .try_with(move |c| {\n-                if c.borrow().is_none() {\n-                    *c.borrow_mut() =\n-                        Some(ThreadInfo { stack_guard: None, thread: Thread::new(None) })\n-                }\n-                f(c.borrow_mut().as_mut().unwrap())\n+            .try_with(move |thread_info| {\n+                let mut thread_info = thread_info.borrow_mut();\n+                let thread_info = thread_info.get_or_insert_with(|| ThreadInfo {\n+                    stack_guard: None,\n+                    thread: Thread::new(None),\n+                });\n+                f(thread_info)\n             })\n             .ok()\n     }"}]}