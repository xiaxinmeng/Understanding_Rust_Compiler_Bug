{"sha": "e7295294103665a747bde485286491c7e601d96e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU3Mjk1Mjk0MTAzNjY1YTc0N2JkZTQ4NTI4NjQ5MWM3ZTYwMWQ5NmU=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-08-10T12:58:14Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-08-10T13:08:35Z"}, "message": "Do not drop `..Default::default()` completion when typing `..`", "tree": {"sha": "b481501f1029e7b16ed023d34d5f6f6e19ade36f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b481501f1029e7b16ed023d34d5f6f6e19ade36f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e7295294103665a747bde485286491c7e601d96e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e7295294103665a747bde485286491c7e601d96e", "html_url": "https://github.com/rust-lang/rust/commit/e7295294103665a747bde485286491c7e601d96e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e7295294103665a747bde485286491c7e601d96e/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f2246fecef40fb86806fbe440df3b1eeb19a0f34", "url": "https://api.github.com/repos/rust-lang/rust/commits/f2246fecef40fb86806fbe440df3b1eeb19a0f34", "html_url": "https://github.com/rust-lang/rust/commit/f2246fecef40fb86806fbe440df3b1eeb19a0f34"}], "stats": {"total": 133, "additions": 84, "deletions": 49}, "files": [{"sha": "acce10addf72c38de9b64846d56f2f7251372858", "filename": "crates/ide_completion/src/completions/record.rs", "status": "modified", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/e7295294103665a747bde485286491c7e601d96e/crates%2Fide_completion%2Fsrc%2Fcompletions%2Frecord.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e7295294103665a747bde485286491c7e601d96e/crates%2Fide_completion%2Fsrc%2Fcompletions%2Frecord.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Frecord.rs?ref=e7295294103665a747bde485286491c7e601d96e", "patch": "@@ -178,6 +178,38 @@ impl Default for Struct {\n     fn default() -> Self {}\n }\n \n+fn foo() {\n+    let other = Struct {\n+        foo: 5,\n+        ..Default::default()\n+    };\n+}\n+\"#,\n+        );\n+        check_edit(\n+            \"..Default::default()\",\n+            r#\"\n+//- minicore: default\n+struct Struct { foo: u32, bar: usize }\n+\n+impl Default for Struct {\n+    fn default() -> Self {}\n+}\n+\n+fn foo() {\n+    let other = Struct {\n+        foo: 5,\n+        ..$0\n+    };\n+}\n+\"#,\n+            r#\"\n+struct Struct { foo: u32, bar: usize }\n+\n+impl Default for Struct {\n+    fn default() -> Self {}\n+}\n+\n fn foo() {\n     let other = Struct {\n         foo: 5,"}, {"sha": "ac34a3fac81c445a0be8c2881b56f27de14b3457", "filename": "crates/ide_completion/src/patterns.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e7295294103665a747bde485286491c7e601d96e/crates%2Fide_completion%2Fsrc%2Fpatterns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e7295294103665a747bde485286491c7e601d96e/crates%2Fide_completion%2Fsrc%2Fpatterns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fpatterns.rs?ref=e7295294103665a747bde485286491c7e601d96e", "patch": "@@ -191,6 +191,7 @@ pub(crate) fn determine_location(\n             }\n         }\n     };\n+\n     let res = match_ast! {\n         match parent {\n             ast::IdentPat(_it) => ImmediateLocation::IdentPat,\n@@ -206,6 +207,9 @@ pub(crate) fn determine_location(\n             } else {\n                 ImmediateLocation::RecordField\n             },\n+            ast::RecordExprFieldList(_it) => sema\n+                .find_node_at_offset_with_macros(original_file, offset)\n+                .map(ImmediateLocation::RecordExpr)?,\n             ast::TupleField(_it) => ImmediateLocation::TupleField,\n             ast::TupleFieldList(_it) => ImmediateLocation::TupleField,\n             ast::TypeBound(_it) => ImmediateLocation::TypeBound,"}, {"sha": "2a26fc3dabc54604d8d7e338bec33c6cf970d83f", "filename": "crates/ide_completion/src/tests/record.rs", "status": "modified", "additions": 48, "deletions": 49, "changes": 97, "blob_url": "https://github.com/rust-lang/rust/blob/e7295294103665a747bde485286491c7e601d96e/crates%2Fide_completion%2Fsrc%2Ftests%2Frecord.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e7295294103665a747bde485286491c7e601d96e/crates%2Fide_completion%2Fsrc%2Ftests%2Frecord.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Ftests%2Frecord.rs?ref=e7295294103665a747bde485286491c7e601d96e", "patch": "@@ -7,36 +7,6 @@ fn check(ra_fixture: &str, expect: Expect) {\n     expect.assert_eq(&actual);\n }\n \n-#[test]\n-fn with_default_impl() {\n-    check(\n-        r#\"\n-//- minicore: default\n-struct Struct { foo: u32, bar: usize }\n-\n-impl Default for Struct {\n-    fn default() -> Self {\n-        Struct {\n-            foo: 0,\n-            bar: 0,\n-        }\n-    }\n-}\n-\n-fn foo() {\n-    let other = Struct {\n-        foo: 5,\n-        $0\n-    };\n-}\n-\"#,\n-        expect![[r#\"\n-            fd ..Default::default()\n-            fd bar                  usize\n-        \"#]],\n-    );\n-}\n-\n #[test]\n fn without_default_impl() {\n     check(\n@@ -129,9 +99,54 @@ fn foo(f: Struct) {\n #[test]\n fn functional_update() {\n     // FIXME: This should filter out all completions that do not have the type `Foo`\n+    // FIXME: Fields should not show up after `.`\n     check(\n         r#\"\n+//- minicore:default\n struct Foo { foo1: u32, foo2: u32 }\n+impl Default for Foo {\n+    fn default() -> Self { loop {} }\n+}\n+\n+fn main() {\n+    let thing = 1;\n+    let foo = Foo { foo1: 0, foo2: 0 };\n+    let foo2 = Foo { thing, $0 }\n+}\n+\"#,\n+        expect![[r#\"\n+            fd ..Default::default()\n+            fd foo1                 u32\n+            fd foo2                 u32\n+        \"#]],\n+    );\n+    check(\n+        r#\"\n+//- minicore:default\n+struct Foo { foo1: u32, foo2: u32 }\n+impl Default for Foo {\n+    fn default() -> Self { loop {} }\n+}\n+\n+fn main() {\n+    let thing = 1;\n+    let foo = Foo { foo1: 0, foo2: 0 };\n+    let foo2 = Foo { thing, .$0 }\n+}\n+\"#,\n+        expect![[r#\"\n+            fd ..Default::default()\n+            fd foo1                 u32\n+            fd foo2                 u32\n+        \"#]],\n+    );\n+    check(\n+        r#\"\n+//- minicore:default\n+struct Foo { foo1: u32, foo2: u32 }\n+impl Default for Foo {\n+    fn default() -> Self { loop {} }\n+}\n \n fn main() {\n     let thing = 1;\n@@ -140,25 +155,9 @@ fn main() {\n }\n \"#,\n         expect![[r#\"\n-            kw unsafe\n-            kw match\n-            kw while\n-            kw while let\n-            kw loop\n-            kw if\n-            kw if let\n-            kw for\n-            kw true\n-            kw false\n-            kw return\n-            kw self\n-            kw super\n-            kw crate\n-            lc foo       Foo\n-            lc thing     i32\n-            st Foo\n-            fn main()    fn()\n-            bt u32\n+            fd ..Default::default()\n+            fd foo1                 u32\n+            fd foo2                 u32\n         \"#]],\n     );\n }"}]}