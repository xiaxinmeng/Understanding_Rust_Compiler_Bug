{"sha": "ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4", "node_id": "C_kwDOAAsO6NoAKGNhOGJkM2VjNDJjOWFiOThiNTNjMzQwMjA0MWUxZTc4YmNjOTQ4YTQ", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-01-08T13:55:18Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-08T13:55:18Z"}, "message": "Merge #11237\n\n11237: fix: Fix outline modules spilling inner doc injections into their parent r=Veykril a=Veykril\n\nFixes another regression caused by https://github.com/rust-analyzer/rust-analyzer/pull/11225\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "35eb8484182270733740a20ff88bccd40e9118af", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/35eb8484182270733740a20ff88bccd40e9118af"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh2ZfGCRBK7hj4Ov3rIwAAFZ4IAGfzTUpNZ0Ghsw+VE1Six0Y0\nsBb+sNmDv/KN0j9OzgTYwSrl6CQIZZP8MU/L7HoHrw9izlh/2SLPjvFwLhTyXTnq\nr8v0ElXO+tN1kQ2B2w/jsXlq/XCYsHiUx0c0gcv0ee9qsWM9jsi1RbMX6+7xE4fe\nQwyFx7Dc3I6OUknXm4u+85/540K+OQ01j+NrPY/t1NfMAdZ7k7CErD+5iFt8C06b\n/Kx0Cxr6HSOfYcZnmivFoz1lGHWOLWTMDwc2XLQmDa1A0VYhQF9eZqVJcrsPEXW7\n93HZ/HSkT+0H7uu0h6HChKeaCMl8eBiqJagmAkDxyFZFsP4rXZkhcrOsO0E+3qE=\n=xCE2\n-----END PGP SIGNATURE-----\n", "payload": "tree 35eb8484182270733740a20ff88bccd40e9118af\nparent 01c3303270139fea66e797e7e93e502aef1e8eb9\nparent b32f611b6e23805a159819314fecec95feb21159\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1641650118 +0000\ncommitter GitHub <noreply@github.com> 1641650118 +0000\n\nMerge #11237\n\n11237: fix: Fix outline modules spilling inner doc injections into their parent r=Veykril a=Veykril\n\nFixes another regression caused by https://github.com/rust-analyzer/rust-analyzer/pull/11225\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4", "html_url": "https://github.com/rust-lang/rust/commit/ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "01c3303270139fea66e797e7e93e502aef1e8eb9", "url": "https://api.github.com/repos/rust-lang/rust/commits/01c3303270139fea66e797e7e93e502aef1e8eb9", "html_url": "https://github.com/rust-lang/rust/commit/01c3303270139fea66e797e7e93e502aef1e8eb9"}, {"sha": "b32f611b6e23805a159819314fecec95feb21159", "url": "https://api.github.com/repos/rust-lang/rust/commits/b32f611b6e23805a159819314fecec95feb21159", "html_url": "https://github.com/rust-lang/rust/commit/b32f611b6e23805a159819314fecec95feb21159"}], "stats": {"total": 45, "additions": 40, "deletions": 5}, "files": [{"sha": "a244d321495123925a7165222af5fba0d77e5b2e", "filename": "crates/hir_def/src/attr.rs", "status": "modified", "additions": 25, "deletions": 4, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4/crates%2Fhir_def%2Fsrc%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4/crates%2Fhir_def%2Fsrc%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fattr.rs?ref=ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4", "patch": "@@ -390,7 +390,9 @@ impl AttrsWithOwner {\n                         if let InFile { file_id, value: ModuleSource::SourceFile(file) } =\n                             mod_data.definition_source(db)\n                         {\n-                            map.merge(AttrSourceMap::new(InFile::new(file_id, &file)));\n+                            map.append_module_inline_attrs(AttrSourceMap::new(InFile::new(\n+                                file_id, &file,\n+                            )));\n                         }\n                         return map;\n                     }\n@@ -552,18 +554,31 @@ fn inner_attributes(\n pub struct AttrSourceMap {\n     source: Vec<Either<ast::Attr, ast::Comment>>,\n     file_id: HirFileId,\n+    /// If this map is for a module, this will be the [`HirFileId`] of the module's definition site,\n+    /// while `file_id` will be the one of the module declaration site.\n+    /// The usize is the index into `source` from which point on the entries reside in the def site\n+    /// file.\n+    mod_def_site_file_id: Option<(HirFileId, usize)>,\n }\n \n impl AttrSourceMap {\n     fn new(owner: InFile<&dyn ast::HasAttrs>) -> Self {\n         Self {\n             source: collect_attrs(owner.value).map(|(_, it)| it).collect(),\n             file_id: owner.file_id,\n+            mod_def_site_file_id: None,\n         }\n     }\n \n-    fn merge(&mut self, other: Self) {\n+    /// Append a second source map to this one, this is required for modules, whose outline and inline\n+    /// attributes can reside in different files\n+    fn append_module_inline_attrs(&mut self, other: Self) {\n+        assert!(self.mod_def_site_file_id.is_none() && other.mod_def_site_file_id.is_none());\n+        let len = self.source.len();\n         self.source.extend(other.source);\n+        if other.file_id != self.file_id {\n+            self.mod_def_site_file_id = Some((other.file_id, len));\n+        }\n     }\n \n     /// Maps the lowered `Attr` back to its original syntax node.\n@@ -577,9 +592,15 @@ impl AttrSourceMap {\n     }\n \n     fn source_of_id(&self, id: AttrId) -> InFile<&Either<ast::Attr, ast::Comment>> {\n+        let ast_idx = id.ast_index as usize;\n+        let file_id = match self.mod_def_site_file_id {\n+            Some((file_id, def_site_cut)) if def_site_cut <= ast_idx => file_id,\n+            _ => self.file_id,\n+        };\n+\n         self.source\n-            .get(id.ast_index as usize)\n-            .map(|it| InFile::new(self.file_id, it))\n+            .get(ast_idx)\n+            .map(|it| InFile::new(file_id, it))\n             .unwrap_or_else(|| panic!(\"cannot find attr at index {:?}\", id))\n     }\n }"}, {"sha": "a04a211825d4d175f29f14540580b9559e439502", "filename": "crates/ide/src/syntax_highlighting/test_data/highlight_doctest.html", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlight_doctest.html", "raw_url": "https://github.com/rust-lang/rust/raw/ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlight_doctest.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlight_doctest.html?ref=ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4", "patch": "@@ -46,6 +46,8 @@\n <span class=\"comment documentation\">//! </span><span class=\"keyword injected\">fn</span><span class=\"none injected\"> </span><span class=\"function declaration injected\">test</span><span class=\"parenthesis injected\">(</span><span class=\"parenthesis injected\">)</span><span class=\"none injected\"> </span><span class=\"brace injected\">{</span><span class=\"brace injected\">}</span>\n <span class=\"comment documentation\">//! ```</span>\n \n+<span class=\"keyword\">mod</span> <span class=\"module declaration\">outline_module</span><span class=\"semicolon\">;</span>\n+\n <span class=\"comment documentation\">/// ```</span>\n <span class=\"comment documentation\">/// </span><span class=\"keyword injected\">let</span><span class=\"none injected\"> </span><span class=\"punctuation injected\">_</span><span class=\"none injected\"> </span><span class=\"operator injected\">=</span><span class=\"none injected\"> </span><span class=\"string_literal injected\">\"early doctests should not go boom\"</span><span class=\"semicolon injected\">;</span>\n <span class=\"comment documentation\">/// ```</span>\n@@ -170,4 +172,6 @@\n     ```\n     </span><span class=\"function documentation injected intra_doc_link\">[`block_comments`]</span><span class=\"comment documentation\"> tests these without indentation\n */</span>\n-<span class=\"keyword\">pub</span> <span class=\"keyword\">fn</span> <span class=\"function declaration public\">block_comments2</span><span class=\"parenthesis\">(</span><span class=\"parenthesis\">)</span> <span class=\"brace\">{</span><span class=\"brace\">}</span></code></pre>\n\\ No newline at end of file\n+<span class=\"keyword\">pub</span> <span class=\"keyword\">fn</span> <span class=\"function declaration public\">block_comments2</span><span class=\"parenthesis\">(</span><span class=\"parenthesis\">)</span> <span class=\"brace\">{</span><span class=\"brace\">}</span>\n+\n+</code></pre>\n\\ No newline at end of file"}, {"sha": "4beab9909c41a1be9be9fd1e131899797bc6cbd3", "filename": "crates/ide/src/syntax_highlighting/tests.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs?ref=ca8bd3ec42c9ab98b53c3402041e1e78bcc948a4", "patch": "@@ -641,11 +641,14 @@ fn main() {\n fn test_highlight_doc_comment() {\n     check_highlighting(\n         r#\"\n+//- /main.rs\n //! This is a module to test doc injection.\n //! ```\n //! fn test() {}\n //! ```\n \n+mod outline_module;\n+\n /// ```\n /// let _ = \"early doctests should not go boom\";\n /// ```\n@@ -771,6 +774,13 @@ pub fn block_comments() {}\n     [`block_comments`] tests these without indentation\n */\n pub fn block_comments2() {}\n+\n+//- /outline_module.rs\n+//! This is an outline module whose purpose is to test that its inline attribute injection does not\n+//! spill into its parent.\n+//! ```\n+//! fn test() {}\n+//! ```\n \"#\n         .trim(),\n         expect_file![\"./test_data/highlight_doctest.html\"],"}]}