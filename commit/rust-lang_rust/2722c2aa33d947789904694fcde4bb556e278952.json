{"sha": "2722c2aa33d947789904694fcde4bb556e278952", "node_id": "C_kwDOAAsO6NoAKDI3MjJjMmFhMzNkOTQ3Nzg5OTA0Njk0ZmNkZTRiYjU1NmUyNzg5NTI", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-06-15T03:02:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-06-15T03:02:03Z"}, "message": "Rollup merge of #98078 - erikdesjardins:uncheckedsize, r=petrochenkov\n\nUse unchecked mul to compute slice sizes\n\nThis allows LLVM to realize that `slice.len() > 0` iff `slice.len() * size_of::<T>() > 0`, allowing a branch on the latter to be folded into the former when dropping vecs and boxed slices, in some cases.\n\nFixes (partially) #96497", "tree": {"sha": "dbb096fb235cfcfd2dec11c22e48e0ee271ef318", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dbb096fb235cfcfd2dec11c22e48e0ee271ef318"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2722c2aa33d947789904694fcde4bb556e278952", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiqUusCRBK7hj4Ov3rIwAAw9QIAA9s7DpYFZTwz7xvm9wWI8L1\n5+PEXwMmkW6lZAxpgIt6AgjBlBNt/8kD8bpYzDTvsylk0Z7Y5TJgvx8rihL/44VT\nLa6J6r/ZYmHj38YpmV1LnSausNPg1340xwzAAD/1FF4cwZMmAW/Aw5nZxJEiP0dJ\nTY9BS4mxW1bMbrowI2QSbzmv2gHmU3E8P/qpqe/8hHUHBb6NpOLbeaxi42VdY1eL\nOA+5dn49v70zMtWIWxmWCcv2rEghwReWVhqRJWPGHrt/Kvg+1pSKcOUki0+nrW95\nn2kDrsStoNCQDuUxCyY7q4cOJ6pFH0YthRY2oT7w/4weFmKNMVs7ekeLEvUEfNg=\n=p62M\n-----END PGP SIGNATURE-----\n", "payload": "tree dbb096fb235cfcfd2dec11c22e48e0ee271ef318\nparent bb4805118a6274a83e21c78bb96e3cbd9e9dca36\nparent 50f6a9ed87e47c7a8ff6aefcde01a33821e80e20\nauthor Yuki Okushi <jtitor@2k36.org> 1655262123 +0900\ncommitter GitHub <noreply@github.com> 1655262123 +0900\n\nRollup merge of #98078 - erikdesjardins:uncheckedsize, r=petrochenkov\n\nUse unchecked mul to compute slice sizes\n\nThis allows LLVM to realize that `slice.len() > 0` iff `slice.len() * size_of::<T>() > 0`, allowing a branch on the latter to be folded into the former when dropping vecs and boxed slices, in some cases.\n\nFixes (partially) #96497\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2722c2aa33d947789904694fcde4bb556e278952", "html_url": "https://github.com/rust-lang/rust/commit/2722c2aa33d947789904694fcde4bb556e278952", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2722c2aa33d947789904694fcde4bb556e278952/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bb4805118a6274a83e21c78bb96e3cbd9e9dca36", "url": "https://api.github.com/repos/rust-lang/rust/commits/bb4805118a6274a83e21c78bb96e3cbd9e9dca36", "html_url": "https://github.com/rust-lang/rust/commit/bb4805118a6274a83e21c78bb96e3cbd9e9dca36"}, {"sha": "50f6a9ed87e47c7a8ff6aefcde01a33821e80e20", "url": "https://api.github.com/repos/rust-lang/rust/commits/50f6a9ed87e47c7a8ff6aefcde01a33821e80e20", "html_url": "https://github.com/rust-lang/rust/commit/50f6a9ed87e47c7a8ff6aefcde01a33821e80e20"}], "stats": {"total": 36, "additions": 35, "deletions": 1}, "files": [{"sha": "e6f402ef19d870b69516a5bf5cefc0adb4fcfb82", "filename": "compiler/rustc_codegen_ssa/src/glue.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/2722c2aa33d947789904694fcde4bb556e278952/compiler%2Frustc_codegen_ssa%2Fsrc%2Fglue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2722c2aa33d947789904694fcde4bb556e278952/compiler%2Frustc_codegen_ssa%2Fsrc%2Fglue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fglue.rs?ref=2722c2aa33d947789904694fcde4bb556e278952", "patch": "@@ -39,7 +39,12 @@ pub fn size_and_align_of_dst<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n             // The info in this case is the length of the str, so the size is that\n             // times the unit size.\n             (\n-                bx.mul(info.unwrap(), bx.const_usize(unit.size.bytes())),\n+                // All slice sizes must fit into `isize`, so this multiplication cannot (signed) wrap.\n+                // NOTE: ideally, we want the effects of both `unchecked_smul` and `unchecked_umul`\n+                // (resulting in `mul nsw nuw` in LLVM IR), since we know that the multiplication\n+                // cannot signed wrap, and that both operands are non-negative. But at the time of writing,\n+                // `BuilderMethods` can't do this, and it doesn't seem to enable any further optimizations.\n+                bx.unchecked_smul(info.unwrap(), bx.const_usize(unit.size.bytes())),\n                 bx.const_usize(unit.align.abi.bytes()),\n             )\n         }"}, {"sha": "a5dbef93460272a18a8c9857fc0df95bc7bf90e8", "filename": "src/test/codegen/issue-96497-slice-size-nowrap.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/2722c2aa33d947789904694fcde4bb556e278952/src%2Ftest%2Fcodegen%2Fissue-96497-slice-size-nowrap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2722c2aa33d947789904694fcde4bb556e278952/src%2Ftest%2Fcodegen%2Fissue-96497-slice-size-nowrap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fissue-96497-slice-size-nowrap.rs?ref=2722c2aa33d947789904694fcde4bb556e278952", "patch": "@@ -0,0 +1,29 @@\n+// This test case checks that LLVM is aware that computing the size of a slice cannot wrap.\n+// The possibility of wrapping results in an additional branch when dropping boxed slices\n+// in some situations, see https://github.com/rust-lang/rust/issues/96497#issuecomment-1112865218\n+\n+// compile-flags: -O\n+// min-llvm-version: 14.0\n+\n+#![crate_type=\"lib\"]\n+\n+// CHECK-LABEL: @simple_size_of_nowrap\n+#[no_mangle]\n+pub fn simple_size_of_nowrap(x: &[u32]) -> usize {\n+    // Make sure the shift used to compute the size has a nowrap flag.\n+\n+    // CHECK: [[A:%.*]] = shl nsw {{.*}}, 2\n+    // CHECK-NEXT: ret {{.*}} [[A]]\n+    core::mem::size_of_val(x)\n+}\n+\n+// CHECK-LABEL: @drop_write\n+#[no_mangle]\n+pub fn drop_write(mut x: Box<[u32]>) {\n+    // Check that this write is optimized out.\n+    // This depends on the size calculation not wrapping,\n+    // since otherwise LLVM can't tell that the memory is always deallocated if the slice len > 0.\n+\n+    // CHECK-NOT: store i32 42\n+    x[1] = 42;\n+}"}]}