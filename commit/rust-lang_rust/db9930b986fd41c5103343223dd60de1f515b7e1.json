{"sha": "db9930b986fd41c5103343223dd60de1f515b7e1", "node_id": "C_kwDOAAsO6NoAKGRiOTkzMGI5ODZmZDQxYzUxMDMzNDMyMjNkZDYwZGUxZjUxNWI3ZTE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-23T14:12:35Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-23T14:12:35Z"}, "message": "Auto merge of #12357 - Veykril:find-ref-macro, r=Veykril\n\nfix: When reference searching macro inputs, don't search everything that was downmapped\n\nFixes https://github.com/rust-lang/rust-analyzer/issues/11668", "tree": {"sha": "d0385e267e8b0df80ce8fc1a859d749128fbfcdc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d0385e267e8b0df80ce8fc1a859d749128fbfcdc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/db9930b986fd41c5103343223dd60de1f515b7e1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/db9930b986fd41c5103343223dd60de1f515b7e1", "html_url": "https://github.com/rust-lang/rust/commit/db9930b986fd41c5103343223dd60de1f515b7e1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/db9930b986fd41c5103343223dd60de1f515b7e1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "238253c22d34e035c92e5b667ec31bd96691f97b", "url": "https://api.github.com/repos/rust-lang/rust/commits/238253c22d34e035c92e5b667ec31bd96691f97b", "html_url": "https://github.com/rust-lang/rust/commit/238253c22d34e035c92e5b667ec31bd96691f97b"}, {"sha": "377c9247e6c8c5392acc5b6e935aee89457bd6f4", "url": "https://api.github.com/repos/rust-lang/rust/commits/377c9247e6c8c5392acc5b6e935aee89457bd6f4", "html_url": "https://github.com/rust-lang/rust/commit/377c9247e6c8c5392acc5b6e935aee89457bd6f4"}], "stats": {"total": 25, "additions": 16, "deletions": 9}, "files": [{"sha": "282e9c0a4bdd2bbc44a0b2ad9efd4eeeae8391e9", "filename": "crates/hir/src/semantics.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/db9930b986fd41c5103343223dd60de1f515b7e1/crates%2Fhir%2Fsrc%2Fsemantics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db9930b986fd41c5103343223dd60de1f515b7e1/crates%2Fhir%2Fsrc%2Fsemantics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fsemantics.rs?ref=db9930b986fd41c5103343223dd60de1f515b7e1", "patch": "@@ -208,14 +208,14 @@ impl<'db, DB: HirDatabase> Semantics<'db, DB> {\n         self.imp.descend_into_macros(token)\n     }\n \n-    /// Descend the token into macrocalls to all its mapped counterparts.\n+    /// Descend the token into macrocalls to all its mapped counterparts that have the same text as the input token.\n     ///\n-    /// Returns the original non descended token if none of the mapped counterparts have the same syntax kind.\n-    pub fn descend_into_macros_with_same_kind(\n+    /// Returns the original non descended token if none of the mapped counterparts have the same text.\n+    pub fn descend_into_macros_with_same_text(\n         &self,\n         token: SyntaxToken,\n     ) -> SmallVec<[SyntaxToken; 1]> {\n-        self.imp.descend_into_macros_with_same_kind(token)\n+        self.imp.descend_into_macros_with_same_text(token)\n     }\n \n     /// Maps a node down by mapping its first and last token down.\n@@ -666,11 +666,11 @@ impl<'db> SemanticsImpl<'db> {\n         res\n     }\n \n-    fn descend_into_macros_with_same_kind(&self, token: SyntaxToken) -> SmallVec<[SyntaxToken; 1]> {\n-        let kind = token.kind();\n+    fn descend_into_macros_with_same_text(&self, token: SyntaxToken) -> SmallVec<[SyntaxToken; 1]> {\n+        let text = token.text();\n         let mut res = smallvec![];\n         self.descend_into_macros_impl(token.clone(), &mut |InFile { value, .. }| {\n-            if value.kind() == kind {\n+            if value.text() == text {\n                 res.push(value);\n             }\n             false"}, {"sha": "d2d367c8c5583b70d8739089295d77789d1c0ddb", "filename": "crates/ide/src/hover.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/db9930b986fd41c5103343223dd60de1f515b7e1/crates%2Fide%2Fsrc%2Fhover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db9930b986fd41c5103343223dd60de1f515b7e1/crates%2Fide%2Fsrc%2Fhover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover.rs?ref=db9930b986fd41c5103343223dd60de1f515b7e1", "patch": "@@ -115,7 +115,7 @@ pub(crate) fn hover(\n         });\n     }\n \n-    let descended = sema.descend_into_macros(original_token.clone());\n+    let descended = sema.descend_into_macros_with_same_text(original_token.clone());\n \n     // FIXME: Definition should include known lints and the like instead of having this special case here\n     let hovered_lint = descended.iter().find_map(|token| {"}, {"sha": "626e8fe34a9e656253ba4db381a6702e8ff602df", "filename": "crates/ide/src/references.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/db9930b986fd41c5103343223dd60de1f515b7e1/crates%2Fide%2Fsrc%2Freferences.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db9930b986fd41c5103343223dd60de1f515b7e1/crates%2Fide%2Fsrc%2Freferences.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Freferences.rs?ref=db9930b986fd41c5103343223dd60de1f515b7e1", "patch": "@@ -122,7 +122,7 @@ pub(crate) fn find_defs<'a>(\n         )\n     });\n     token.map(|token| {\n-        sema.descend_into_macros_with_same_kind(token)\n+        sema.descend_into_macros_with_same_text(token)\n             .into_iter()\n             .filter_map(|it| ast::NameLike::cast(it.parent()?))\n             .filter_map(move |name_like| {"}, {"sha": "b7bf45c04c910b9b5b90e713fe8f664ffc1f4d45", "filename": "crates/syntax/src/ast/node_ext.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/db9930b986fd41c5103343223dd60de1f515b7e1/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db9930b986fd41c5103343223dd60de1f515b7e1/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs?ref=db9930b986fd41c5103343223dd60de1f515b7e1", "patch": "@@ -432,6 +432,13 @@ impl NameLike {\n             _ => None,\n         }\n     }\n+    pub fn text(&self) -> TokenText {\n+        match self {\n+            NameLike::NameRef(name_ref) => name_ref.text(),\n+            NameLike::Name(name) => name.text(),\n+            NameLike::Lifetime(lifetime) => lifetime.text(),\n+        }\n+    }\n }\n \n impl ast::AstNode for NameLike {"}]}