{"sha": "8dabf5da9e0318f8c324dc224ad49dc91472c2ec", "node_id": "C_kwDOAAsO6NoAKDhkYWJmNWRhOWUwMzE4ZjhjMzI0ZGMyMjRhZDQ5ZGM5MTQ3MmMyZWM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-11T15:08:30Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-11T15:08:30Z"}, "message": "Auto merge of #107167 - the8472:rawvec-simpler-layout, r=thomcc\n\nsimplify layout calculations in rawvec\n\nThe use of `Layout::array` was introduced in #83706 which lead to a [perf regression](https://github.com/rust-lang/rust/pull/83706#issuecomment-1048377719).\n\nThis PR basically reverts that change since rust currently only supports stride == size types, but to be on the safe side it leaves a const-assert there to make sure this gets caught if those assumptions ever change.", "tree": {"sha": "0a9bc43bba1ce13b519e1ee3bed52fae5dd9865c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0a9bc43bba1ce13b519e1ee3bed52fae5dd9865c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8dabf5da9e0318f8c324dc224ad49dc91472c2ec", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8dabf5da9e0318f8c324dc224ad49dc91472c2ec", "html_url": "https://github.com/rust-lang/rust/commit/8dabf5da9e0318f8c324dc224ad49dc91472c2ec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8dabf5da9e0318f8c324dc224ad49dc91472c2ec/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5b450244876154bc1bd134694398e80c12e00b5c", "url": "https://api.github.com/repos/rust-lang/rust/commits/5b450244876154bc1bd134694398e80c12e00b5c", "html_url": "https://github.com/rust-lang/rust/commit/5b450244876154bc1bd134694398e80c12e00b5c"}, {"sha": "6fcf1758feb63c7c70a40241f0ac8931a3ba46a9", "url": "https://api.github.com/repos/rust-lang/rust/commits/6fcf1758feb63c7c70a40241f0ac8931a3ba46a9", "html_url": "https://github.com/rust-lang/rust/commit/6fcf1758feb63c7c70a40241f0ac8931a3ba46a9"}], "stats": {"total": 19, "additions": 13, "deletions": 6}, "files": [{"sha": "3751f2a245456042f5d8f840969ff9ff439f6c06", "filename": "library/alloc/src/raw_vec.rs", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/8dabf5da9e0318f8c324dc224ad49dc91472c2ec/library%2Falloc%2Fsrc%2Fraw_vec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8dabf5da9e0318f8c324dc224ad49dc91472c2ec/library%2Falloc%2Fsrc%2Fraw_vec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fraw_vec.rs?ref=8dabf5da9e0318f8c324dc224ad49dc91472c2ec", "patch": "@@ -241,10 +241,15 @@ impl<T, A: Allocator> RawVec<T, A> {\n         if T::IS_ZST || self.cap == 0 {\n             None\n         } else {\n-            // We have an allocated chunk of memory, so we can bypass runtime\n-            // checks to get our current layout.\n+            // We could use Layout::array here which ensures the absence of isize and usize overflows\n+            // and could hypothetically handle differences between stride and size, but this memory\n+            // has already been allocated so we know it can't overflow and currently rust does not\n+            // support such types. So we can do better by skipping some checks and avoid an unwrap.\n+            let _: () = const { assert!(mem::size_of::<T>() % mem::align_of::<T>() == 0) };\n             unsafe {\n-                let layout = Layout::array::<T>(self.cap).unwrap_unchecked();\n+                let align = mem::align_of::<T>();\n+                let size = mem::size_of::<T>().unchecked_mul(self.cap);\n+                let layout = Layout::from_size_align_unchecked(size, align);\n                 Some((self.ptr.cast().into(), layout))\n             }\n         }\n@@ -426,11 +431,13 @@ impl<T, A: Allocator> RawVec<T, A> {\n         assert!(cap <= self.capacity(), \"Tried to shrink to a larger capacity\");\n \n         let (ptr, layout) = if let Some(mem) = self.current_memory() { mem } else { return Ok(()) };\n-\n+        // See current_memory() why this assert is here\n+        let _: () = const { assert!(mem::size_of::<T>() % mem::align_of::<T>() == 0) };\n         let ptr = unsafe {\n             // `Layout::array` cannot overflow here because it would have\n             // overflowed earlier when capacity was larger.\n-            let new_layout = Layout::array::<T>(cap).unwrap_unchecked();\n+            let new_size = mem::size_of::<T>().unchecked_mul(cap);\n+            let new_layout = Layout::from_size_align_unchecked(new_size, layout.align());\n             self.alloc\n                 .shrink(ptr, layout, new_layout)\n                 .map_err(|_| AllocError { layout: new_layout, non_exhaustive: () })?"}, {"sha": "1c6a7b02f8e77e01bc0b23d4577c8fab8fdcf1d0", "filename": "tests/ui/hygiene/panic-location.run.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8dabf5da9e0318f8c324dc224ad49dc91472c2ec/tests%2Fui%2Fhygiene%2Fpanic-location.run.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8dabf5da9e0318f8c324dc224ad49dc91472c2ec/tests%2Fui%2Fhygiene%2Fpanic-location.run.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fhygiene%2Fpanic-location.run.stderr?ref=8dabf5da9e0318f8c324dc224ad49dc91472c2ec", "patch": "@@ -1,2 +1,2 @@\n-thread 'main' panicked at 'capacity overflow', library/alloc/src/raw_vec.rs:518:5\n+thread 'main' panicked at 'capacity overflow', library/alloc/src/raw_vec.rs:525:5\n note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace"}]}