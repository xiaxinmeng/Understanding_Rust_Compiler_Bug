{"sha": "39ffabbb40e91f50fb20243b2fd6198b446663c6", "node_id": "C_kwDOAAsO6NoAKDM5ZmZhYmJiNDBlOTFmNTBmYjIwMjQzYjJmZDYxOThiNDQ2NjYzYzY", "commit": {"author": {"name": "Yiming Lei", "email": "yiming.lei@futurewei.com", "date": "2022-08-24T02:30:04Z"}, "committer": {"name": "Yiming Lei", "email": "yiming.lei@futurewei.com", "date": "2022-08-29T18:58:20Z"}, "message": "Point at the string inside literal and mention if we need string interpolation\n\tmodified:   compiler/rustc_passes/src/liveness.rs\n\n\tnew file:   src/test/ui/type/issue-100584.rs\n\tnew file:   src/test/ui/type/issue-100584.stderr", "tree": {"sha": "d17f87c8864aef5d6800344744a776d76fcc207e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d17f87c8864aef5d6800344744a776d76fcc207e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/39ffabbb40e91f50fb20243b2fd6198b446663c6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/39ffabbb40e91f50fb20243b2fd6198b446663c6", "html_url": "https://github.com/rust-lang/rust/commit/39ffabbb40e91f50fb20243b2fd6198b446663c6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/39ffabbb40e91f50fb20243b2fd6198b446663c6/comments", "author": null, "committer": null, "parents": [{"sha": "a1bea1551b8312b6abfbbf7d49bafac2e6ce8ee4", "url": "https://api.github.com/repos/rust-lang/rust/commits/a1bea1551b8312b6abfbbf7d49bafac2e6ce8ee4", "html_url": "https://github.com/rust-lang/rust/commit/a1bea1551b8312b6abfbbf7d49bafac2e6ce8ee4"}], "stats": {"total": 141, "additions": 130, "deletions": 11}, "files": [{"sha": "0c3281fbf066af518b372f9f1bfee79edc2a1113", "filename": "compiler/rustc_passes/src/liveness.rs", "status": "modified", "additions": 71, "deletions": 11, "changes": 82, "blob_url": "https://github.com/rust-lang/rust/blob/39ffabbb40e91f50fb20243b2fd6198b446663c6/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39ffabbb40e91f50fb20243b2fd6198b446663c6/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs?ref=39ffabbb40e91f50fb20243b2fd6198b446663c6", "patch": "@@ -188,6 +188,19 @@ enum VarKind {\n     Upvar(HirId, Symbol),\n }\n \n+struct CollectLitsVisitor<'tcx> {\n+    lit_exprs: Vec<&'tcx hir::Expr<'tcx>>,\n+}\n+\n+impl<'tcx> Visitor<'tcx> for CollectLitsVisitor<'tcx> {\n+    fn visit_expr(&mut self, expr: &'tcx Expr<'tcx>) {\n+        if let hir::ExprKind::Lit(_) = expr.kind {\n+            self.lit_exprs.push(expr);\n+        }\n+        intravisit::walk_expr(self, expr);\n+    }\n+}\n+\n struct IrMaps<'tcx> {\n     tcx: TyCtxt<'tcx>,\n     live_node_map: HirIdMap<LiveNode>,\n@@ -1342,7 +1355,7 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n \n impl<'a, 'tcx> Visitor<'tcx> for Liveness<'a, 'tcx> {\n     fn visit_local(&mut self, local: &'tcx hir::Local<'tcx>) {\n-        self.check_unused_vars_in_pat(&local.pat, None, |spans, hir_id, ln, var| {\n+        self.check_unused_vars_in_pat(&local.pat, None, None, |spans, hir_id, ln, var| {\n             if local.init.is_some() {\n                 self.warn_about_dead_assign(spans, hir_id, ln, var);\n             }\n@@ -1357,7 +1370,7 @@ impl<'a, 'tcx> Visitor<'tcx> for Liveness<'a, 'tcx> {\n     }\n \n     fn visit_arm(&mut self, arm: &'tcx hir::Arm<'tcx>) {\n-        self.check_unused_vars_in_pat(&arm.pat, None, |_, _, _, _| {});\n+        self.check_unused_vars_in_pat(&arm.pat, None, None, |_, _, _, _| {});\n         intravisit::walk_arm(self, arm);\n     }\n }\n@@ -1396,7 +1409,7 @@ fn check_expr<'tcx>(this: &mut Liveness<'_, 'tcx>, expr: &'tcx Expr<'tcx>) {\n         }\n \n         hir::ExprKind::Let(let_expr) => {\n-            this.check_unused_vars_in_pat(let_expr.pat, None, |_, _, _, _| {});\n+            this.check_unused_vars_in_pat(let_expr.pat, None, None, |_, _, _, _| {});\n         }\n \n         // no correctness conditions related to liveness\n@@ -1517,20 +1530,26 @@ impl<'tcx> Liveness<'_, 'tcx> {\n \n     fn warn_about_unused_args(&self, body: &hir::Body<'_>, entry_ln: LiveNode) {\n         for p in body.params {\n-            self.check_unused_vars_in_pat(&p.pat, Some(entry_ln), |spans, hir_id, ln, var| {\n-                if !self.live_on_entry(ln, var) {\n-                    self.report_unused_assign(hir_id, spans, var, |name| {\n-                        format!(\"value passed to `{}` is never read\", name)\n-                    });\n-                }\n-            });\n+            self.check_unused_vars_in_pat(\n+                &p.pat,\n+                Some(entry_ln),\n+                Some(body),\n+                |spans, hir_id, ln, var| {\n+                    if !self.live_on_entry(ln, var) {\n+                        self.report_unused_assign(hir_id, spans, var, |name| {\n+                            format!(\"value passed to `{}` is never read\", name)\n+                        });\n+                    }\n+                },\n+            );\n         }\n     }\n \n     fn check_unused_vars_in_pat(\n         &self,\n         pat: &hir::Pat<'_>,\n         entry_ln: Option<LiveNode>,\n+        opt_body: Option<&hir::Body<'_>>,\n         on_used_on_entry: impl Fn(Vec<Span>, HirId, LiveNode, Variable),\n     ) {\n         // In an or-pattern, only consider the variable; any later patterns must have the same\n@@ -1558,7 +1577,7 @@ impl<'tcx> Liveness<'_, 'tcx> {\n                     hir_ids_and_spans.into_iter().map(|(_, _, ident_span)| ident_span).collect();\n                 on_used_on_entry(spans, id, ln, var);\n             } else {\n-                self.report_unused(hir_ids_and_spans, ln, var, can_remove);\n+                self.report_unused(hir_ids_and_spans, ln, var, can_remove, pat, opt_body);\n             }\n         }\n     }\n@@ -1570,6 +1589,8 @@ impl<'tcx> Liveness<'_, 'tcx> {\n         ln: LiveNode,\n         var: Variable,\n         can_remove: bool,\n+        pat: &hir::Pat<'_>,\n+        opt_body: Option<&hir::Body<'_>>,\n     ) {\n         let first_hir_id = hir_ids_and_spans[0].0;\n \n@@ -1673,6 +1694,9 @@ impl<'tcx> Liveness<'_, 'tcx> {\n                             .collect::<Vec<_>>(),\n                         |lint| {\n                             let mut err = lint.build(&format!(\"unused variable: `{}`\", name));\n+                            if self.has_added_lit_match_name_span(&name, opt_body, &mut err) {\n+                                err.span_label(pat.span, \"unused variable\");\n+                            }\n                             err.multipart_suggestion(\n                                 \"if this is intentional, prefix it with an underscore\",\n                                 non_shorthands,\n@@ -1686,6 +1710,42 @@ impl<'tcx> Liveness<'_, 'tcx> {\n         }\n     }\n \n+    fn has_added_lit_match_name_span(\n+        &self,\n+        name: &str,\n+        opt_body: Option<&hir::Body<'_>>,\n+        err: &mut rustc_errors::DiagnosticBuilder<'_, ()>,\n+    ) -> bool {\n+        let mut has_litstring = false;\n+        let Some(opt_body) = opt_body else {return false;};\n+        let mut visitor = CollectLitsVisitor { lit_exprs: vec![] };\n+        intravisit::walk_body(&mut visitor, opt_body);\n+        for lit_expr in visitor.lit_exprs {\n+            let hir::ExprKind::Lit(litx) = &lit_expr.kind else { continue };\n+            let rustc_ast::LitKind::Str(syb, _) = litx.node else{ continue; };\n+            let name_str: &str = syb.as_str();\n+            let mut name_pa = String::from(\"{\");\n+            name_pa.push_str(&name);\n+            name_pa.push('}');\n+            if name_str.contains(&name_pa) {\n+                err.span_label(\n+                    lit_expr.span,\n+                    \"you might have meant to use string interpolation in this string literal\",\n+                );\n+                err.multipart_suggestion(\n+                    \"string interpolation only works in `format!` invocations\",\n+                    vec![\n+                        (lit_expr.span.shrink_to_lo(), \"format!(\".to_string()),\n+                        (lit_expr.span.shrink_to_hi(), \")\".to_string()),\n+                    ],\n+                    Applicability::MachineApplicable,\n+                );\n+                has_litstring = true;\n+            }\n+        }\n+        has_litstring\n+    }\n+\n     fn warn_about_dead_assign(&self, spans: Vec<Span>, hir_id: HirId, ln: LiveNode, var: Variable) {\n         if !self.live_on_exit(ln, var) {\n             self.report_unused_assign(hir_id, spans, var, |name| {"}, {"sha": "102846563231e25157226b39e7280e1286be9099", "filename": "src/test/ui/type/issue-100584.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/39ffabbb40e91f50fb20243b2fd6198b446663c6/src%2Ftest%2Fui%2Ftype%2Fissue-100584.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39ffabbb40e91f50fb20243b2fd6198b446663c6/src%2Ftest%2Fui%2Ftype%2Fissue-100584.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftype%2Fissue-100584.rs?ref=39ffabbb40e91f50fb20243b2fd6198b446663c6", "patch": "@@ -0,0 +1,15 @@\n+#![deny(unused)]\n+fn foo(xyza: &str) {\n+//~^ ERROR unused variable: `xyza`\n+    let _ = \"{xyza}\";\n+}\n+\n+fn foo3(xyza: &str) {\n+//~^ ERROR unused variable: `xyza`\n+    let _ = \"aaa{xyza}bbb\";\n+}\n+\n+fn main() {\n+  foo(\"x\");\n+  foo3(\"xx\");\n+}"}, {"sha": "e1db14d1f001bd1dfe18a14d45f297654d1fcf8f", "filename": "src/test/ui/type/issue-100584.stderr", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/39ffabbb40e91f50fb20243b2fd6198b446663c6/src%2Ftest%2Fui%2Ftype%2Fissue-100584.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/39ffabbb40e91f50fb20243b2fd6198b446663c6/src%2Ftest%2Fui%2Ftype%2Fissue-100584.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftype%2Fissue-100584.stderr?ref=39ffabbb40e91f50fb20243b2fd6198b446663c6", "patch": "@@ -0,0 +1,44 @@\n+error: unused variable: `xyza`\n+  --> $DIR/issue-100584.rs:2:8\n+   |\n+LL | fn foo(xyza: &str) {\n+   |        ^^^^ unused variable\n+LL |\n+LL |     let _ = \"{xyza}\";\n+   |             -------- you might have meant to use string interpolation in this string literal\n+   |\n+note: the lint level is defined here\n+  --> $DIR/issue-100584.rs:1:9\n+   |\n+LL | #![deny(unused)]\n+   |         ^^^^^^\n+   = note: `#[deny(unused_variables)]` implied by `#[deny(unused)]`\n+help: string interpolation only works in `format!` invocations\n+   |\n+LL |     let _ = format!(\"{xyza}\");\n+   |             ++++++++        +\n+help: if this is intentional, prefix it with an underscore\n+   |\n+LL | fn foo(_xyza: &str) {\n+   |        ~~~~~\n+\n+error: unused variable: `xyza`\n+  --> $DIR/issue-100584.rs:7:9\n+   |\n+LL | fn foo3(xyza: &str) {\n+   |         ^^^^ unused variable\n+LL |\n+LL |     let _ = \"aaa{xyza}bbb\";\n+   |             -------------- you might have meant to use string interpolation in this string literal\n+   |\n+help: string interpolation only works in `format!` invocations\n+   |\n+LL |     let _ = format!(\"aaa{xyza}bbb\");\n+   |             ++++++++              +\n+help: if this is intentional, prefix it with an underscore\n+   |\n+LL | fn foo3(_xyza: &str) {\n+   |         ~~~~~\n+\n+error: aborting due to 2 previous errors\n+"}]}