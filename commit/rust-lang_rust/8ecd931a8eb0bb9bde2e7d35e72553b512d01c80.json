{"sha": "8ecd931a8eb0bb9bde2e7d35e72553b512d01c80", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhlY2Q5MzFhOGViMGJiOWJkZTJlN2QzNWU3MjU1M2I1MTJkMDFjODA=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2021-03-25T19:40:50Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2021-03-25T19:41:31Z"}, "message": "Don't ICE when using `#[global_alloc]` on a non-item statement\n\nFixes #83469\n\nWe need to return an `Annotatable::Stmt` if we were passed an\n`Annotatable::Stmt`", "tree": {"sha": "b564308e942c85f29774402b8a1c9fad2d157db2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b564308e942c85f29774402b8a1c9fad2d157db2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8ecd931a8eb0bb9bde2e7d35e72553b512d01c80", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAmBc53sACgkQtAh+UQ6Y\nsWTu7hAAnNx8sgyTilnpPQVAzg8PDRyQ9yDtPyr8N8E+nmuemaKi+GwCoqpv4N+c\nrxFTYpMgGFlTSQ921JZ1yL/YZI6K2LgN/voJPYD4dzfuc6pYA3DUHd0JUoi7EO7F\nObVaU3moXfVcvr468VJ2HfE+5TbnnPtov+uJfbZcXP+xGhzG+8/n5ZGTn7HlIX4X\nguR/n9pwRPPxAO+1+Bcu/LShIlC2C5phCE3wbw3CnZslr33lkrGzrQfOJKbMeEQg\nYSqe6dnLz6KcINMECXUp22ImomMl98wg5dSeycHgyC0CDuN4lqcjcQEh4SnvQ0SS\n7dLw6s1WDBixV00l3AdaNNFKi4f0nf3cnPklUUJ4vEjmhDU0BDuYIRvR5wGmO1Lq\nda+Da/wbfUFBrl2gu1p/gJDLLIOMjSJk3Aux6vgjHrYedb0DLIm14J8A0imlm38k\nky6Da8xYgsmkPZM3v6Hz4+KJITw2mZO+hJG6YrD778JY3utrzxhAPZ+HSNBmxsrm\n1xx7zMKnVfFNHxbr7bLExO5l4NEEEWJAPo6z3YUiNN8gfUgk20ATyliHnyrMdpUj\nOgK/rQ3tq2iY1ew5ydthtxF6wy4VsNR8XidSKICHTApsr2d0TXowECKGuUYF/Q2I\nwPkeW4M8KZVJipBiP7EdXJDyUZZ6ff1vueVnvKgYN7t8i+TuErU=\n=tn0U\n-----END PGP SIGNATURE-----", "payload": "tree b564308e942c85f29774402b8a1c9fad2d157db2\nparent 6e17a5c5fd086ebe6f57216fb3ce5d1d8d6c83e5\nauthor Aaron Hill <aa1ronham@gmail.com> 1616701250 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1616701291 -0400\n\nDon't ICE when using `#[global_alloc]` on a non-item statement\n\nFixes #83469\n\nWe need to return an `Annotatable::Stmt` if we were passed an\n`Annotatable::Stmt`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8ecd931a8eb0bb9bde2e7d35e72553b512d01c80", "html_url": "https://github.com/rust-lang/rust/commit/8ecd931a8eb0bb9bde2e7d35e72553b512d01c80", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8ecd931a8eb0bb9bde2e7d35e72553b512d01c80/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6e17a5c5fd086ebe6f57216fb3ce5d1d8d6c83e5", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e17a5c5fd086ebe6f57216fb3ce5d1d8d6c83e5", "html_url": "https://github.com/rust-lang/rust/commit/6e17a5c5fd086ebe6f57216fb3ce5d1d8d6c83e5"}], "stats": {"total": 50, "additions": 34, "deletions": 16}, "files": [{"sha": "a97cac7e514c98082c8591acaa441840ac9edacc", "filename": "compiler/rustc_builtin_macros/src/global_allocator.rs", "status": "modified", "additions": 16, "deletions": 16, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/8ecd931a8eb0bb9bde2e7d35e72553b512d01c80/compiler%2Frustc_builtin_macros%2Fsrc%2Fglobal_allocator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ecd931a8eb0bb9bde2e7d35e72553b512d01c80/compiler%2Frustc_builtin_macros%2Fsrc%2Fglobal_allocator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fglobal_allocator.rs?ref=8ecd931a8eb0bb9bde2e7d35e72553b512d01c80", "patch": "@@ -14,31 +14,31 @@ pub fn expand(\n     ecx: &mut ExtCtxt<'_>,\n     _span: Span,\n     meta_item: &ast::MetaItem,\n-    mut item: Annotatable,\n+    item: Annotatable,\n ) -> Vec<Annotatable> {\n     check_builtin_macro_attribute(ecx, meta_item, sym::global_allocator);\n \n-    let not_static = |item: Annotatable| {\n+    let orig_item = item.clone();\n+    let not_static = || {\n         ecx.sess.parse_sess.span_diagnostic.span_err(item.span(), \"allocators must be statics\");\n-        vec![item]\n+        vec![orig_item.clone()]\n     };\n-    let orig_item = item.clone();\n-    let mut is_stmt = false;\n \n     // Allow using `#[global_allocator]` on an item statement\n-    if let Annotatable::Stmt(stmt) = &item {\n-        if let StmtKind::Item(item_) = &stmt.kind {\n-            item = Annotatable::Item(item_.clone());\n-            is_stmt = true;\n-        }\n-    }\n-\n-    let item = match item {\n+    // FIXME - if we get deref patterns, use them to reduce duplication here\n+    let (item, is_stmt) = match &item {\n         Annotatable::Item(item) => match item.kind {\n-            ItemKind::Static(..) => item,\n-            _ => return not_static(Annotatable::Item(item)),\n+            ItemKind::Static(..) => (item, false),\n+            _ => return not_static(),\n+        },\n+        Annotatable::Stmt(stmt) => match &stmt.kind {\n+            StmtKind::Item(item_) => match item_.kind {\n+                ItemKind::Static(..) => (item_, true),\n+                _ => return not_static(),\n+            },\n+            _ => return not_static(),\n         },\n-        _ => return not_static(item),\n+        _ => return not_static(),\n     };\n \n     // Generate a bunch of new items using the AllocFnFactory"}, {"sha": "25adc5d25780b1f0e1bc6895258f85dd4cacca1d", "filename": "src/test/ui/proc-macro/issue-83469-global-alloc-invalid-stmt.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8ecd931a8eb0bb9bde2e7d35e72553b512d01c80/src%2Ftest%2Fui%2Fproc-macro%2Fissue-83469-global-alloc-invalid-stmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ecd931a8eb0bb9bde2e7d35e72553b512d01c80/src%2Ftest%2Fui%2Fproc-macro%2Fissue-83469-global-alloc-invalid-stmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fissue-83469-global-alloc-invalid-stmt.rs?ref=8ecd931a8eb0bb9bde2e7d35e72553b512d01c80", "patch": "@@ -0,0 +1,10 @@\n+// Regression test for issue #83469\n+// Ensures that we recover from `#[global_alloc]` on an invalid\n+// stmt without an ICE\n+\n+fn outer() {\n+    #[global_allocator]\n+    fn inner() {} //~ ERROR allocators must be statics\n+}\n+\n+fn main() {}"}, {"sha": "ec0e3c4c7546f8c28f9a3f647f1e85a8d25ac733", "filename": "src/test/ui/proc-macro/issue-83469-global-alloc-invalid-stmt.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8ecd931a8eb0bb9bde2e7d35e72553b512d01c80/src%2Ftest%2Fui%2Fproc-macro%2Fissue-83469-global-alloc-invalid-stmt.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8ecd931a8eb0bb9bde2e7d35e72553b512d01c80/src%2Ftest%2Fui%2Fproc-macro%2Fissue-83469-global-alloc-invalid-stmt.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fissue-83469-global-alloc-invalid-stmt.stderr?ref=8ecd931a8eb0bb9bde2e7d35e72553b512d01c80", "patch": "@@ -0,0 +1,8 @@\n+error: allocators must be statics\n+  --> $DIR/issue-83469-global-alloc-invalid-stmt.rs:7:5\n+   |\n+LL |     fn inner() {}\n+   |     ^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}]}