{"sha": "729892961c9e3b00919fd13d7ea2a704d03dd6a8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcyOTg5Mjk2MWM5ZTNiMDA5MTlmZDEzZDdlYTJhNzA0ZDAzZGQ2YTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-03-14T07:52:00Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-03-14T07:52:00Z"}, "message": "Auto merge of #3880 - phansch:uicleanup9001, r=oli-obk\n\nUI test cleanup: Extract manual_memcpy tests\n\ncc #2038", "tree": {"sha": "e4b08e3eaad741f61e7bcc8277bcd8817ad335cb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e4b08e3eaad741f61e7bcc8277bcd8817ad335cb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/729892961c9e3b00919fd13d7ea2a704d03dd6a8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/729892961c9e3b00919fd13d7ea2a704d03dd6a8", "html_url": "https://github.com/rust-lang/rust/commit/729892961c9e3b00919fd13d7ea2a704d03dd6a8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/729892961c9e3b00919fd13d7ea2a704d03dd6a8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "99fdf2607e600f31d202092a48202bccaff6f04b", "url": "https://api.github.com/repos/rust-lang/rust/commits/99fdf2607e600f31d202092a48202bccaff6f04b", "html_url": "https://github.com/rust-lang/rust/commit/99fdf2607e600f31d202092a48202bccaff6f04b"}, {"sha": "5e4a7eb1fc19afc6ff13ec373413ead0eeff74b6", "url": "https://api.github.com/repos/rust-lang/rust/commits/5e4a7eb1fc19afc6ff13ec373413ead0eeff74b6", "html_url": "https://github.com/rust-lang/rust/commit/5e4a7eb1fc19afc6ff13ec373413ead0eeff74b6"}], "stats": {"total": 368, "additions": 186, "deletions": 182}, "files": [{"sha": "41ac824e869dd25f4e139d2b5d6b2c4a69d06691", "filename": "tests/ui/for_loop.rs", "status": "modified", "additions": 0, "deletions": 108, "changes": 108, "blob_url": "https://github.com/rust-lang/rust/blob/729892961c9e3b00919fd13d7ea2a704d03dd6a8/tests%2Fui%2Ffor_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/729892961c9e3b00919fd13d7ea2a704d03dd6a8/tests%2Fui%2Ffor_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffor_loop.rs?ref=729892961c9e3b00919fd13d7ea2a704d03dd6a8", "patch": "@@ -355,114 +355,6 @@ fn partition<T: PartialOrd + Send>(v: &mut [T]) -> usize {\n     i\n }\n \n-const LOOP_OFFSET: usize = 5000;\n-\n-#[warn(clippy::needless_range_loop)]\n-pub fn manual_copy(src: &[i32], dst: &mut [i32], dst2: &mut [i32]) {\n-    // plain manual memcpy\n-    for i in 0..src.len() {\n-        dst[i] = src[i];\n-    }\n-\n-    // dst offset memcpy\n-    for i in 0..src.len() {\n-        dst[i + 10] = src[i];\n-    }\n-\n-    // src offset memcpy\n-    for i in 0..src.len() {\n-        dst[i] = src[i + 10];\n-    }\n-\n-    // src offset memcpy\n-    for i in 11..src.len() {\n-        dst[i] = src[i - 10];\n-    }\n-\n-    // overwrite entire dst\n-    for i in 0..dst.len() {\n-        dst[i] = src[i];\n-    }\n-\n-    // manual copy with branch - can't easily convert to memcpy!\n-    for i in 0..src.len() {\n-        dst[i] = src[i];\n-        if dst[i] > 5 {\n-            break;\n-        }\n-    }\n-\n-    // multiple copies - suggest two memcpy statements\n-    for i in 10..256 {\n-        dst[i] = src[i - 5];\n-        dst2[i + 500] = src[i]\n-    }\n-\n-    // this is a reversal - the copy lint shouldn't be triggered\n-    for i in 10..LOOP_OFFSET {\n-        dst[i + LOOP_OFFSET] = src[LOOP_OFFSET - i];\n-    }\n-\n-    let some_var = 5;\n-    // Offset in variable\n-    for i in 10..LOOP_OFFSET {\n-        dst[i + LOOP_OFFSET] = src[i - some_var];\n-    }\n-\n-    // Non continuous copy - don't trigger lint\n-    for i in 0..10 {\n-        dst[i + i] = src[i];\n-    }\n-\n-    let src_vec = vec![1, 2, 3, 4, 5];\n-    let mut dst_vec = vec![0, 0, 0, 0, 0];\n-\n-    // make sure vectors are supported\n-    for i in 0..src_vec.len() {\n-        dst_vec[i] = src_vec[i];\n-    }\n-\n-    // lint should not trigger when either\n-    // source or destination type is not\n-    // slice-like, like DummyStruct\n-    struct DummyStruct(i32);\n-\n-    impl ::std::ops::Index<usize> for DummyStruct {\n-        type Output = i32;\n-\n-        fn index(&self, _: usize) -> &i32 {\n-            &self.0\n-        }\n-    }\n-\n-    let src = DummyStruct(5);\n-    let mut dst_vec = vec![0; 10];\n-\n-    for i in 0..10 {\n-        dst_vec[i] = src[i];\n-    }\n-\n-    // Simplify suggestion (issue #3004)\n-    let src = [0, 1, 2, 3, 4];\n-    let mut dst = [0, 0, 0, 0, 0, 0];\n-    let from = 1;\n-\n-    for i in from..from + src.len() {\n-        dst[i] = src[i - from];\n-    }\n-\n-    for i in from..from + 3 {\n-        dst[i] = src[i - from];\n-    }\n-}\n-\n-#[warn(clippy::needless_range_loop)]\n-pub fn manual_clone(src: &[String], dst: &mut [String]) {\n-    for i in 0..src.len() {\n-        dst[i] = src[i].clone();\n-    }\n-}\n-\n #[warn(clippy::needless_range_loop)]\n pub fn manual_copy_same_destination(dst: &mut [i32], d: usize, s: usize) {\n     // Same source and destination - don't trigger lint"}, {"sha": "e8964c26796e95301b556bec78daa602de3bc0a0", "filename": "tests/ui/for_loop.stderr", "status": "modified", "additions": 1, "deletions": 74, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/729892961c9e3b00919fd13d7ea2a704d03dd6a8/tests%2Fui%2Ffor_loop.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/729892961c9e3b00919fd13d7ea2a704d03dd6a8/tests%2Fui%2Ffor_loop.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffor_loop.stderr?ref=729892961c9e3b00919fd13d7ea2a704d03dd6a8", "patch": "@@ -292,78 +292,5 @@ LL |     vec.iter().cloned().map(|x| out.push(x)).collect::<Vec<_>>();\n    |\n    = note: `-D clippy::unused-collect` implied by `-D warnings`\n \n-error: it looks like you're manually copying between slices\n-  --> $DIR/for_loop.rs:363:14\n-   |\n-LL |     for i in 0..src.len() {\n-   |              ^^^^^^^^^^^^ help: try replacing the loop by: `dst[..src.len()].clone_from_slice(&src[..])`\n-   |\n-   = note: `-D clippy::manual-memcpy` implied by `-D warnings`\n-\n-error: it looks like you're manually copying between slices\n-  --> $DIR/for_loop.rs:368:14\n-   |\n-LL |     for i in 0..src.len() {\n-   |              ^^^^^^^^^^^^ help: try replacing the loop by: `dst[10..(src.len() + 10)].clone_from_slice(&src[..])`\n-\n-error: it looks like you're manually copying between slices\n-  --> $DIR/for_loop.rs:373:14\n-   |\n-LL |     for i in 0..src.len() {\n-   |              ^^^^^^^^^^^^ help: try replacing the loop by: `dst[..src.len()].clone_from_slice(&src[10..])`\n-\n-error: it looks like you're manually copying between slices\n-  --> $DIR/for_loop.rs:378:14\n-   |\n-LL |     for i in 11..src.len() {\n-   |              ^^^^^^^^^^^^^ help: try replacing the loop by: `dst[11..src.len()].clone_from_slice(&src[(11 - 10)..(src.len() - 10)])`\n-\n-error: it looks like you're manually copying between slices\n-  --> $DIR/for_loop.rs:383:14\n-   |\n-LL |     for i in 0..dst.len() {\n-   |              ^^^^^^^^^^^^ help: try replacing the loop by: `dst.clone_from_slice(&src[..dst.len()])`\n-\n-error: it looks like you're manually copying between slices\n-  --> $DIR/for_loop.rs:396:14\n-   |\n-LL |     for i in 10..256 {\n-   |              ^^^^^^^\n-help: try replacing the loop by\n-   |\n-LL |     for i in dst[10..256].clone_from_slice(&src[(10 - 5)..(256 - 5)])\n-LL |     dst2[(10 + 500)..(256 + 500)].clone_from_slice(&src[10..256]) {\n-   |\n-\n-error: it looks like you're manually copying between slices\n-  --> $DIR/for_loop.rs:408:14\n-   |\n-LL |     for i in 10..LOOP_OFFSET {\n-   |              ^^^^^^^^^^^^^^^ help: try replacing the loop by: `dst[(10 + LOOP_OFFSET)..(LOOP_OFFSET + LOOP_OFFSET)].clone_from_slice(&src[(10 - some_var)..(LOOP_OFFSET - some_var)])`\n-\n-error: it looks like you're manually copying between slices\n-  --> $DIR/for_loop.rs:421:14\n-   |\n-LL |     for i in 0..src_vec.len() {\n-   |              ^^^^^^^^^^^^^^^^ help: try replacing the loop by: `dst_vec[..src_vec.len()].clone_from_slice(&src_vec[..])`\n-\n-error: it looks like you're manually copying between slices\n-  --> $DIR/for_loop.rs:450:14\n-   |\n-LL |     for i in from..from + src.len() {\n-   |              ^^^^^^^^^^^^^^^^^^^^^^ help: try replacing the loop by: `dst[from..from + src.len()].clone_from_slice(&src[0..(from + src.len() - from)])`\n-\n-error: it looks like you're manually copying between slices\n-  --> $DIR/for_loop.rs:454:14\n-   |\n-LL |     for i in from..from + 3 {\n-   |              ^^^^^^^^^^^^^^ help: try replacing the loop by: `dst[from..from + 3].clone_from_slice(&src[0..(from + 3 - from)])`\n-\n-error: it looks like you're manually copying between slices\n-  --> $DIR/for_loop.rs:461:14\n-   |\n-LL |     for i in 0..src.len() {\n-   |              ^^^^^^^^^^^^ help: try replacing the loop by: `dst[..src.len()].clone_from_slice(&src[..])`\n-\n-error: aborting due to 46 previous errors\n+error: aborting due to 35 previous errors\n "}, {"sha": "aa347288875d5cc5f89058de21964be3230e3f55", "filename": "tests/ui/manual_memcpy.rs", "status": "added", "additions": 110, "deletions": 0, "changes": 110, "blob_url": "https://github.com/rust-lang/rust/blob/729892961c9e3b00919fd13d7ea2a704d03dd6a8/tests%2Fui%2Fmanual_memcpy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/729892961c9e3b00919fd13d7ea2a704d03dd6a8/tests%2Fui%2Fmanual_memcpy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_memcpy.rs?ref=729892961c9e3b00919fd13d7ea2a704d03dd6a8", "patch": "@@ -0,0 +1,110 @@\n+#![warn(clippy::needless_range_loop, clippy::manual_memcpy)]\n+\n+const LOOP_OFFSET: usize = 5000;\n+\n+pub fn manual_copy(src: &[i32], dst: &mut [i32], dst2: &mut [i32]) {\n+    // plain manual memcpy\n+    for i in 0..src.len() {\n+        dst[i] = src[i];\n+    }\n+\n+    // dst offset memcpy\n+    for i in 0..src.len() {\n+        dst[i + 10] = src[i];\n+    }\n+\n+    // src offset memcpy\n+    for i in 0..src.len() {\n+        dst[i] = src[i + 10];\n+    }\n+\n+    // src offset memcpy\n+    for i in 11..src.len() {\n+        dst[i] = src[i - 10];\n+    }\n+\n+    // overwrite entire dst\n+    for i in 0..dst.len() {\n+        dst[i] = src[i];\n+    }\n+\n+    // manual copy with branch - can't easily convert to memcpy!\n+    for i in 0..src.len() {\n+        dst[i] = src[i];\n+        if dst[i] > 5 {\n+            break;\n+        }\n+    }\n+\n+    // multiple copies - suggest two memcpy statements\n+    for i in 10..256 {\n+        dst[i] = src[i - 5];\n+        dst2[i + 500] = src[i]\n+    }\n+\n+    // this is a reversal - the copy lint shouldn't be triggered\n+    for i in 10..LOOP_OFFSET {\n+        dst[i + LOOP_OFFSET] = src[LOOP_OFFSET - i];\n+    }\n+\n+    let some_var = 5;\n+    // Offset in variable\n+    for i in 10..LOOP_OFFSET {\n+        dst[i + LOOP_OFFSET] = src[i - some_var];\n+    }\n+\n+    // Non continuous copy - don't trigger lint\n+    for i in 0..10 {\n+        dst[i + i] = src[i];\n+    }\n+\n+    let src_vec = vec![1, 2, 3, 4, 5];\n+    let mut dst_vec = vec![0, 0, 0, 0, 0];\n+\n+    // make sure vectors are supported\n+    for i in 0..src_vec.len() {\n+        dst_vec[i] = src_vec[i];\n+    }\n+\n+    // lint should not trigger when either\n+    // source or destination type is not\n+    // slice-like, like DummyStruct\n+    struct DummyStruct(i32);\n+\n+    impl ::std::ops::Index<usize> for DummyStruct {\n+        type Output = i32;\n+\n+        fn index(&self, _: usize) -> &i32 {\n+            &self.0\n+        }\n+    }\n+\n+    let src = DummyStruct(5);\n+    let mut dst_vec = vec![0; 10];\n+\n+    for i in 0..10 {\n+        dst_vec[i] = src[i];\n+    }\n+\n+    // Simplify suggestion (issue #3004)\n+    let src = [0, 1, 2, 3, 4];\n+    let mut dst = [0, 0, 0, 0, 0, 0];\n+    let from = 1;\n+\n+    for i in from..from + src.len() {\n+        dst[i] = src[i - from];\n+    }\n+\n+    for i in from..from + 3 {\n+        dst[i] = src[i - from];\n+    }\n+}\n+\n+#[warn(clippy::needless_range_loop, clippy::manual_memcpy)]\n+pub fn manual_clone(src: &[String], dst: &mut [String]) {\n+    for i in 0..src.len() {\n+        dst[i] = src[i].clone();\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "49ab83f2dd2a8e8abac24deaf907cf4308c35fac", "filename": "tests/ui/manual_memcpy.stderr", "status": "added", "additions": 75, "deletions": 0, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/729892961c9e3b00919fd13d7ea2a704d03dd6a8/tests%2Fui%2Fmanual_memcpy.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/729892961c9e3b00919fd13d7ea2a704d03dd6a8/tests%2Fui%2Fmanual_memcpy.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_memcpy.stderr?ref=729892961c9e3b00919fd13d7ea2a704d03dd6a8", "patch": "@@ -0,0 +1,75 @@\n+error: it looks like you're manually copying between slices\n+  --> $DIR/manual_memcpy.rs:7:14\n+   |\n+LL |     for i in 0..src.len() {\n+   |              ^^^^^^^^^^^^ help: try replacing the loop by: `dst[..src.len()].clone_from_slice(&src[..])`\n+   |\n+   = note: `-D clippy::manual-memcpy` implied by `-D warnings`\n+\n+error: it looks like you're manually copying between slices\n+  --> $DIR/manual_memcpy.rs:12:14\n+   |\n+LL |     for i in 0..src.len() {\n+   |              ^^^^^^^^^^^^ help: try replacing the loop by: `dst[10..(src.len() + 10)].clone_from_slice(&src[..])`\n+\n+error: it looks like you're manually copying between slices\n+  --> $DIR/manual_memcpy.rs:17:14\n+   |\n+LL |     for i in 0..src.len() {\n+   |              ^^^^^^^^^^^^ help: try replacing the loop by: `dst[..src.len()].clone_from_slice(&src[10..])`\n+\n+error: it looks like you're manually copying between slices\n+  --> $DIR/manual_memcpy.rs:22:14\n+   |\n+LL |     for i in 11..src.len() {\n+   |              ^^^^^^^^^^^^^ help: try replacing the loop by: `dst[11..src.len()].clone_from_slice(&src[(11 - 10)..(src.len() - 10)])`\n+\n+error: it looks like you're manually copying between slices\n+  --> $DIR/manual_memcpy.rs:27:14\n+   |\n+LL |     for i in 0..dst.len() {\n+   |              ^^^^^^^^^^^^ help: try replacing the loop by: `dst.clone_from_slice(&src[..dst.len()])`\n+\n+error: it looks like you're manually copying between slices\n+  --> $DIR/manual_memcpy.rs:40:14\n+   |\n+LL |     for i in 10..256 {\n+   |              ^^^^^^^\n+help: try replacing the loop by\n+   |\n+LL |     for i in dst[10..256].clone_from_slice(&src[(10 - 5)..(256 - 5)])\n+LL |     dst2[(10 + 500)..(256 + 500)].clone_from_slice(&src[10..256]) {\n+   |\n+\n+error: it looks like you're manually copying between slices\n+  --> $DIR/manual_memcpy.rs:52:14\n+   |\n+LL |     for i in 10..LOOP_OFFSET {\n+   |              ^^^^^^^^^^^^^^^ help: try replacing the loop by: `dst[(10 + LOOP_OFFSET)..(LOOP_OFFSET + LOOP_OFFSET)].clone_from_slice(&src[(10 - some_var)..(LOOP_OFFSET - some_var)])`\n+\n+error: it looks like you're manually copying between slices\n+  --> $DIR/manual_memcpy.rs:65:14\n+   |\n+LL |     for i in 0..src_vec.len() {\n+   |              ^^^^^^^^^^^^^^^^ help: try replacing the loop by: `dst_vec[..src_vec.len()].clone_from_slice(&src_vec[..])`\n+\n+error: it looks like you're manually copying between slices\n+  --> $DIR/manual_memcpy.rs:94:14\n+   |\n+LL |     for i in from..from + src.len() {\n+   |              ^^^^^^^^^^^^^^^^^^^^^^ help: try replacing the loop by: `dst[from..from + src.len()].clone_from_slice(&src[0..(from + src.len() - from)])`\n+\n+error: it looks like you're manually copying between slices\n+  --> $DIR/manual_memcpy.rs:98:14\n+   |\n+LL |     for i in from..from + 3 {\n+   |              ^^^^^^^^^^^^^^ help: try replacing the loop by: `dst[from..from + 3].clone_from_slice(&src[0..(from + 3 - from)])`\n+\n+error: it looks like you're manually copying between slices\n+  --> $DIR/manual_memcpy.rs:105:14\n+   |\n+LL |     for i in 0..src.len() {\n+   |              ^^^^^^^^^^^^ help: try replacing the loop by: `dst[..src.len()].clone_from_slice(&src[..])`\n+\n+error: aborting due to 11 previous errors\n+"}]}