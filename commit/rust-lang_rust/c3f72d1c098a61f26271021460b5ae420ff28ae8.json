{"sha": "c3f72d1c098a61f26271021460b5ae420ff28ae8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMzZjcyZDFjMDk4YTYxZjI2MjcxMDIxNDYwYjVhZTQyMGZmMjhhZTg=", "commit": {"author": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2019-09-20T23:06:32Z"}, "committer": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2019-09-20T23:06:32Z"}, "message": "Fix the span used to suggest avoiding for-loop moves\n\nIt was using the snippet from the \"use\" span, which often renders the\nsame, but with closures that snippet is on the start of the closure\nwhere the value is captured. We should be using the snippet from the\nspan where it was moved into the `for` loop, which is `move_span`.", "tree": {"sha": "4dac1b2b81d05bdd68647b84c591db2aeee05112", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4dac1b2b81d05bdd68647b84c591db2aeee05112"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c3f72d1c098a61f26271021460b5ae420ff28ae8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c3f72d1c098a61f26271021460b5ae420ff28ae8", "html_url": "https://github.com/rust-lang/rust/commit/c3f72d1c098a61f26271021460b5ae420ff28ae8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c3f72d1c098a61f26271021460b5ae420ff28ae8/comments", "author": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9ad1e7c46cf690b7ec6953b142430d21ca2d8799", "url": "https://api.github.com/repos/rust-lang/rust/commits/9ad1e7c46cf690b7ec6953b142430d21ca2d8799", "html_url": "https://github.com/rust-lang/rust/commit/9ad1e7c46cf690b7ec6953b142430d21ca2d8799"}], "stats": {"total": 27, "additions": 26, "deletions": 1}, "files": [{"sha": "599a0ad0d0c52641d2daeee4d6575aca42bb614c", "filename": "src/librustc_mir/borrow_check/conflict_errors.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c3f72d1c098a61f26271021460b5ae420ff28ae8/src%2Flibrustc_mir%2Fborrow_check%2Fconflict_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c3f72d1c098a61f26271021460b5ae420ff28ae8/src%2Flibrustc_mir%2Fborrow_check%2Fconflict_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fconflict_errors.rs?ref=c3f72d1c098a61f26271021460b5ae420ff28ae8", "patch": "@@ -180,7 +180,8 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                     );\n                 }\n                 if Some(DesugaringKind::ForLoop) == move_span.desugaring_kind() {\n-                    if let Ok(snippet) = self.infcx.tcx.sess.source_map().span_to_snippet(span) {\n+                    let sess = self.infcx.tcx.sess;\n+                    if let Ok(snippet) = sess.source_map().span_to_snippet(move_span) {\n                         err.span_suggestion(\n                             move_span,\n                             \"consider borrowing to avoid moving into the for loop\","}, {"sha": "71e054b5d9876a47f9ffeebc720ee43a31dac3a5", "filename": "src/test/ui/issues/issue-64559.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c3f72d1c098a61f26271021460b5ae420ff28ae8/src%2Ftest%2Fui%2Fissues%2Fissue-64559.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c3f72d1c098a61f26271021460b5ae420ff28ae8/src%2Ftest%2Fui%2Fissues%2Fissue-64559.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-64559.rs?ref=c3f72d1c098a61f26271021460b5ae420ff28ae8", "patch": "@@ -0,0 +1,6 @@\n+fn main() {\n+    let orig = vec![true];\n+    for _val in orig {}\n+    let _closure = || orig;\n+    //~^ ERROR use of moved value: `orig`\n+}"}, {"sha": "3c685dc8d089a145dc8ce0bd95ba2941905eab0a", "filename": "src/test/ui/issues/issue-64559.stderr", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/c3f72d1c098a61f26271021460b5ae420ff28ae8/src%2Ftest%2Fui%2Fissues%2Fissue-64559.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c3f72d1c098a61f26271021460b5ae420ff28ae8/src%2Ftest%2Fui%2Fissues%2Fissue-64559.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-64559.stderr?ref=c3f72d1c098a61f26271021460b5ae420ff28ae8", "patch": "@@ -0,0 +1,18 @@\n+error[E0382]: use of moved value: `orig`\n+  --> $DIR/issue-64559.rs:4:20\n+   |\n+LL |     let orig = vec![true];\n+   |         ---- move occurs because `orig` has type `std::vec::Vec<bool>`, which does not implement the `Copy` trait\n+LL |     for _val in orig {}\n+   |                 ----\n+   |                 |\n+   |                 value moved here\n+   |                 help: consider borrowing to avoid moving into the for loop: `&orig`\n+LL |     let _closure = || orig;\n+   |                    ^^ ---- use occurs due to use in closure\n+   |                    |\n+   |                    value used here after move\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0382`."}]}