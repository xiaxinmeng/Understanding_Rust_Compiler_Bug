{"sha": "68b596408dd6cdd0827e61458fc09c374548218f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY4YjU5NjQwOGRkNmNkZDA4MjdlNjE0NThmYzA5YzM3NDU0ODIxOGY=", "commit": {"author": {"name": "Emerentius", "email": "emerentius@arcor.de", "date": "2018-08-20T11:26:57Z"}, "committer": {"name": "Emerentius", "email": "emerentius@arcor.de", "date": "2018-10-13T22:57:50Z"}, "message": "refactor filter_tests\n\nsame behaviour, just shorter", "tree": {"sha": "79e1360d0a090ad5dd43612efd1060ece9177a5d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/79e1360d0a090ad5dd43612efd1060ece9177a5d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/68b596408dd6cdd0827e61458fc09c374548218f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/68b596408dd6cdd0827e61458fc09c374548218f", "html_url": "https://github.com/rust-lang/rust/commit/68b596408dd6cdd0827e61458fc09c374548218f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/68b596408dd6cdd0827e61458fc09c374548218f/comments", "author": {"login": "Emerentius", "id": 9992929, "node_id": "MDQ6VXNlcjk5OTI5Mjk=", "avatar_url": "https://avatars.githubusercontent.com/u/9992929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Emerentius", "html_url": "https://github.com/Emerentius", "followers_url": "https://api.github.com/users/Emerentius/followers", "following_url": "https://api.github.com/users/Emerentius/following{/other_user}", "gists_url": "https://api.github.com/users/Emerentius/gists{/gist_id}", "starred_url": "https://api.github.com/users/Emerentius/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Emerentius/subscriptions", "organizations_url": "https://api.github.com/users/Emerentius/orgs", "repos_url": "https://api.github.com/users/Emerentius/repos", "events_url": "https://api.github.com/users/Emerentius/events{/privacy}", "received_events_url": "https://api.github.com/users/Emerentius/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Emerentius", "id": 9992929, "node_id": "MDQ6VXNlcjk5OTI5Mjk=", "avatar_url": "https://avatars.githubusercontent.com/u/9992929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Emerentius", "html_url": "https://github.com/Emerentius", "followers_url": "https://api.github.com/users/Emerentius/followers", "following_url": "https://api.github.com/users/Emerentius/following{/other_user}", "gists_url": "https://api.github.com/users/Emerentius/gists{/gist_id}", "starred_url": "https://api.github.com/users/Emerentius/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Emerentius/subscriptions", "organizations_url": "https://api.github.com/users/Emerentius/orgs", "repos_url": "https://api.github.com/users/Emerentius/repos", "events_url": "https://api.github.com/users/Emerentius/events{/privacy}", "received_events_url": "https://api.github.com/users/Emerentius/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8f19cadf9508963ca3af9c9b184b65f4e0ff70e4", "url": "https://api.github.com/repos/rust-lang/rust/commits/8f19cadf9508963ca3af9c9b184b65f4e0ff70e4", "html_url": "https://github.com/rust-lang/rust/commit/8f19cadf9508963ca3af9c9b184b65f4e0ff70e4"}], "stats": {"total": 66, "additions": 23, "deletions": 43}, "files": [{"sha": "e37a26422903fc9373c3f542a60ef56b68422c41", "filename": "src/libtest/lib.rs", "status": "modified", "additions": 23, "deletions": 43, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/68b596408dd6cdd0827e61458fc09c374548218f/src%2Flibtest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68b596408dd6cdd0827e61458fc09c374548218f/src%2Flibtest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Flib.rs?ref=68b596408dd6cdd0827e61458fc09c374548218f", "patch": "@@ -1305,54 +1305,34 @@ fn get_concurrency() -> usize {\n \n pub fn filter_tests(opts: &TestOpts, tests: Vec<TestDescAndFn>) -> Vec<TestDescAndFn> {\n     let mut filtered = tests;\n-    // Remove tests that don't match the test filter\n-    filtered = match opts.filter {\n-        None => filtered,\n-        Some(ref filter) => filtered\n-            .into_iter()\n-            .filter(|test| {\n-                if opts.filter_exact {\n-                    test.desc.name.as_slice() == &filter[..]\n-                } else {\n-                    test.desc.name.as_slice().contains(&filter[..])\n-                }\n-            })\n-            .collect(),\n+    let matches_filter = |test: &TestDescAndFn, filter: &str| {\n+        let test_name = test.desc.name.as_slice();\n+\n+        match opts.filter_exact {\n+            true => test_name == filter,\n+            false => test_name.contains(filter),\n+        }\n     };\n \n+    // Remove tests that don't match the test filter\n+    if let Some(ref filter) = opts.filter {\n+        filtered.retain(|test| matches_filter(test, filter));\n+    }\n+\n     // Skip tests that match any of the skip filters\n-    filtered = filtered\n-        .into_iter()\n-        .filter(|t| {\n-            !opts.skip.iter().any(|sf| {\n-                if opts.filter_exact {\n-                    t.desc.name.as_slice() == &sf[..]\n-                } else {\n-                    t.desc.name.as_slice().contains(&sf[..])\n-                }\n-            })\n-        })\n-        .collect();\n+    filtered.retain(|test| {\n+        !opts.skip.iter().any(|sf| matches_filter(test, sf))\n+    });\n \n     // Maybe pull out the ignored test and unignore them\n-    filtered = if !opts.run_ignored {\n-        filtered\n-    } else {\n-        fn filter(test: TestDescAndFn) -> Option<TestDescAndFn> {\n-            if test.desc.ignore {\n-                let TestDescAndFn { desc, testfn } = test;\n-                Some(TestDescAndFn {\n-                    desc: TestDesc {\n-                        ignore: false,\n-                        ..desc\n-                    },\n-                    testfn,\n-                })\n-            } else {\n-                None\n-            }\n-        }\n-        filtered.into_iter().filter_map(filter).collect()\n+    if opts.run_ignored {\n+        filtered = filtered.into_iter()\n+            .filter(|test| test.desc.ignore)\n+            .map(|mut test| {\n+                test.desc.ignore = false;\n+                test\n+            })\n+            .collect();\n     };\n \n     // Sort the tests alphabetically"}]}