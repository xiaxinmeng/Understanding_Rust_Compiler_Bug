{"sha": "4d0b567efb3407af5bd9c7452ddec193f9792c56", "node_id": "C_kwDOAAsO6NoAKDRkMGI1NjdlZmIzNDA3YWY1YmQ5Yzc0NTJkZGVjMTkzZjk3OTJjNTY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-01-06T11:01:01Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-06T11:01:01Z"}, "message": "Rollup merge of #92349 - avitex:fix-rustdoc-private-doc-tests, r=GuillaumeGomez\n\nFix rustdoc::private_doc_tests lint for public re-exported items\n\nCloses #72081\n\nThis involves changing the lint to check the access level is exported, rather than public.\nThe [exported access level](https://github.com/rust-lang/rust/blob/e91ad5fc62bdee4a29c18baa5fad2ca42fc91bf4/compiler/rustc_middle/src/middle/privacy.rs#L24) accounts for public items and items accessible to other crates with the help of `pub use` re-exports.\nThe pattern of re-exporting public items from a private module is usage seen in a number of popular crates.", "tree": {"sha": "34cc70b71932704ba8e1de12b2f21363ca9e184f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/34cc70b71932704ba8e1de12b2f21363ca9e184f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4d0b567efb3407af5bd9c7452ddec193f9792c56", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh1svtCRBK7hj4Ov3rIwAA9eEIAAEUVnIJsZksNjzsxGDoMNxp\n1d6Rt9OmpoDc0tK32BhTiZvxFZlQrX229jed5NC8tmuI/Wg0sQgl/BVtm4bUu1qD\nPx9N3jfo29iaxGFA6gTeRPFvR0QNeg8c0CW9DZhNuIzneimEiISkLx7ZtYSnKeym\nxwiHNfC484VCqxRGqJduAdoXpFvMDJ9IIOCC9YNQ1/YH0wfqWJDfYozuvW+mqdRG\nkURZybKB9Cm1r5RhKoEb/h6msLpcSsflTqsK39pR2iyXhyuSNiw85XudiWpL38F9\nTi3GH444t7uvHihRGxDFQy3aLvnmVHT+5dgccxHqaoMKEXOFY5IWInilMLZgZXw=\n=Jvht\n-----END PGP SIGNATURE-----\n", "payload": "tree 34cc70b71932704ba8e1de12b2f21363ca9e184f\nparent 2647ce21659253596fffbd7b1ac57ec64d75b4bd\nparent 992646b9ebfc6eb6240ffaa2c2eec38f8502f168\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1641466861 +0100\ncommitter GitHub <noreply@github.com> 1641466861 +0100\n\nRollup merge of #92349 - avitex:fix-rustdoc-private-doc-tests, r=GuillaumeGomez\n\nFix rustdoc::private_doc_tests lint for public re-exported items\n\nCloses #72081\n\nThis involves changing the lint to check the access level is exported, rather than public.\nThe [exported access level](https://github.com/rust-lang/rust/blob/e91ad5fc62bdee4a29c18baa5fad2ca42fc91bf4/compiler/rustc_middle/src/middle/privacy.rs#L24) accounts for public items and items accessible to other crates with the help of `pub use` re-exports.\nThe pattern of re-exporting public items from a private module is usage seen in a number of popular crates.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4d0b567efb3407af5bd9c7452ddec193f9792c56", "html_url": "https://github.com/rust-lang/rust/commit/4d0b567efb3407af5bd9c7452ddec193f9792c56", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4d0b567efb3407af5bd9c7452ddec193f9792c56/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2647ce21659253596fffbd7b1ac57ec64d75b4bd", "url": "https://api.github.com/repos/rust-lang/rust/commits/2647ce21659253596fffbd7b1ac57ec64d75b4bd", "html_url": "https://github.com/rust-lang/rust/commit/2647ce21659253596fffbd7b1ac57ec64d75b4bd"}, {"sha": "992646b9ebfc6eb6240ffaa2c2eec38f8502f168", "url": "https://api.github.com/repos/rust-lang/rust/commits/992646b9ebfc6eb6240ffaa2c2eec38f8502f168", "html_url": "https://github.com/rust-lang/rust/commit/992646b9ebfc6eb6240ffaa2c2eec38f8502f168"}], "stats": {"total": 47, "additions": 46, "deletions": 1}, "files": [{"sha": "e8f8ff988c1f0233b7db810c0e1f045491880092", "filename": "src/librustdoc/passes/check_doc_test_visibility.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4d0b567efb3407af5bd9c7452ddec193f9792c56/src%2Flibrustdoc%2Fpasses%2Fcheck_doc_test_visibility.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d0b567efb3407af5bd9c7452ddec193f9792c56/src%2Flibrustdoc%2Fpasses%2Fcheck_doc_test_visibility.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcheck_doc_test_visibility.rs?ref=4d0b567efb3407af5bd9c7452ddec193f9792c56", "patch": "@@ -131,7 +131,7 @@ crate fn look_for_tests<'tcx>(cx: &DocContext<'tcx>, dox: &str, item: &Item) {\n             );\n         }\n     } else if tests.found_tests > 0\n-        && !cx.cache.access_levels.is_public(item.def_id.expect_def_id())\n+        && !cx.cache.access_levels.is_exported(item.def_id.expect_def_id())\n     {\n         cx.tcx.struct_span_lint_hir(\n             crate::lint::PRIVATE_DOC_TESTS,"}, {"sha": "7cc62b38cc26080174a39ef01c3ff1b64176dfce", "filename": "src/test/rustdoc-ui/private-public-item-doc-test.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/4d0b567efb3407af5bd9c7452ddec193f9792c56/src%2Ftest%2Frustdoc-ui%2Fprivate-public-item-doc-test.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d0b567efb3407af5bd9c7452ddec193f9792c56/src%2Ftest%2Frustdoc-ui%2Fprivate-public-item-doc-test.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fprivate-public-item-doc-test.rs?ref=4d0b567efb3407af5bd9c7452ddec193f9792c56", "patch": "@@ -0,0 +1,11 @@\n+#![deny(rustdoc::private_doc_tests)]\n+\n+mod foo {\n+    /// private doc test\n+    ///\n+    /// ```\n+    /// assert!(false);\n+    /// ```\n+    //~^^^^^ ERROR documentation test in private item\n+    pub fn bar() {}\n+}"}, {"sha": "f50dbd1844e7afc0972a8a764c2921e241504d5f", "filename": "src/test/rustdoc-ui/private-public-item-doc-test.stderr", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/4d0b567efb3407af5bd9c7452ddec193f9792c56/src%2Ftest%2Frustdoc-ui%2Fprivate-public-item-doc-test.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4d0b567efb3407af5bd9c7452ddec193f9792c56/src%2Ftest%2Frustdoc-ui%2Fprivate-public-item-doc-test.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fprivate-public-item-doc-test.stderr?ref=4d0b567efb3407af5bd9c7452ddec193f9792c56", "patch": "@@ -0,0 +1,18 @@\n+error: documentation test in private item\n+  --> $DIR/private-public-item-doc-test.rs:4:5\n+   |\n+LL | /     /// private doc test\n+LL | |     ///\n+LL | |     /// ```\n+LL | |     /// assert!(false);\n+LL | |     /// ```\n+   | |___________^\n+   |\n+note: the lint level is defined here\n+  --> $DIR/private-public-item-doc-test.rs:1:9\n+   |\n+LL | #![deny(rustdoc::private_doc_tests)]\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}, {"sha": "b86a53305a175fb66c83a60288dc50396e35abd7", "filename": "src/test/rustdoc-ui/public-reexported-item-doc-test.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/4d0b567efb3407af5bd9c7452ddec193f9792c56/src%2Ftest%2Frustdoc-ui%2Fpublic-reexported-item-doc-test.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d0b567efb3407af5bd9c7452ddec193f9792c56/src%2Ftest%2Frustdoc-ui%2Fpublic-reexported-item-doc-test.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fpublic-reexported-item-doc-test.rs?ref=4d0b567efb3407af5bd9c7452ddec193f9792c56", "patch": "@@ -0,0 +1,16 @@\n+// check-pass\n+\n+#![deny(rustdoc::private_doc_tests)]\n+\n+pub fn foo() {}\n+\n+mod private {\n+    /// re-exported doc test\n+    ///\n+    /// ```\n+    /// assert!(true);\n+    /// ```\n+    pub fn bar() {}\n+}\n+\n+pub use private::bar;"}]}