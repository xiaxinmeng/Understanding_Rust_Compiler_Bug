{"sha": "72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2", "node_id": "C_kwDOAAsO6NoAKDcyZmJiNTRjNWQ4Y2I3ZTMzM2QxNGUyOGQwZTY4M2E0MzYzYTVhYjI", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-11-01T22:28:40Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-11-01T23:25:24Z"}, "message": "Don't remap early-bound RPITIT regions that originate from impl", "tree": {"sha": "5f792ca6237785b115f150ee2e48ac008d5da620", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5f792ca6237785b115f150ee2e48ac008d5da620"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2", "html_url": "https://github.com/rust-lang/rust/commit/72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ab5a2bc7316012ee9b2a4a4f3821673f2677f3d5", "url": "https://api.github.com/repos/rust-lang/rust/commits/ab5a2bc7316012ee9b2a4a4f3821673f2677f3d5", "html_url": "https://github.com/rust-lang/rust/commit/ab5a2bc7316012ee9b2a4a4f3821673f2677f3d5"}], "stats": {"total": 40, "additions": 39, "deletions": 1}, "files": [{"sha": "b695de137509a65f9cab8d90ff2898cfc0976038", "filename": "compiler/rustc_hir_analysis/src/check/compare_method.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_method.rs", "raw_url": "https://github.com/rust-lang/rust/raw/72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_method.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_method.rs?ref=72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2", "patch": "@@ -590,7 +590,13 @@ pub fn collect_trait_impl_trait_tys<'tcx>(\n                 let num_trait_substs = trait_to_impl_substs.len();\n                 let num_impl_substs = tcx.generics_of(impl_m.container_id(tcx)).params.len();\n                 let ty = tcx.fold_regions(ty, |region, _| {\n-                    let (ty::ReFree(_) | ty::ReEarlyBound(_)) = region.kind() else { return region; };\n+                    match region.kind() {\n+                        // Remap all free regions, which correspond to late-bound regions in the function.\n+                        ty::ReFree(_) => {}\n+                        // Remap early-bound regions as long as they don't come from the `impl` itself.\n+                        ty::ReEarlyBound(ebr) if tcx.parent(ebr.def_id) != impl_m.container_id(tcx) => {}\n+                        _ => return region,\n+                    }\n                     let Some(ty::ReEarlyBound(e)) = map.get(&region.into()).map(|r| r.expect_region().kind())\n                     else {\n                         tcx"}, {"sha": "6b3b142014bd37933668e357733538584d9a4940", "filename": "src/test/ui/async-await/in-trait/early-bound-1.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2/src%2Ftest%2Fui%2Fasync-await%2Fin-trait%2Fearly-bound-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2/src%2Ftest%2Fui%2Fasync-await%2Fin-trait%2Fearly-bound-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fin-trait%2Fearly-bound-1.rs?ref=72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2", "patch": "@@ -0,0 +1,17 @@\n+// check-pass\n+// edition:2021\n+\n+#![feature(async_fn_in_trait)]\n+#![allow(incomplete_features)]\n+\n+pub trait Foo {\n+    async fn foo(&mut self);\n+}\n+\n+struct MyFoo<'a>(&'a mut ());\n+\n+impl<'a> Foo for MyFoo<'a> {\n+    async fn foo(&mut self) {}\n+}\n+\n+fn main() {}"}, {"sha": "270443229b05416db70cb8c38f37cd7cd0d2f8f2", "filename": "src/test/ui/async-await/in-trait/early-bound-2.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2/src%2Ftest%2Fui%2Fasync-await%2Fin-trait%2Fearly-bound-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2/src%2Ftest%2Fui%2Fasync-await%2Fin-trait%2Fearly-bound-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fin-trait%2Fearly-bound-2.rs?ref=72fbb54c5d8cb7e333d14e28d0e683a4363a5ab2", "patch": "@@ -0,0 +1,15 @@\n+// check-pass\n+// edition:2021\n+\n+#![feature(async_fn_in_trait)]\n+#![allow(incomplete_features)]\n+\n+pub trait Foo {\n+    async fn foo(&mut self);\n+}\n+\n+impl<T: Foo> Foo for &mut T {\n+    async fn foo(&mut self) {}\n+}\n+\n+fn main() {}"}]}