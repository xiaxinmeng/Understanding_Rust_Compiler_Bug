{"sha": "a58f7acc97198af1e2d511a90609be9a8b67882b", "node_id": "C_kwDOAAsO6NoAKGE1OGY3YWNjOTcxOThhZjFlMmQ1MTFhOTA2MDliZTlhOGI2Nzg4MmI", "commit": {"author": {"name": "rainy-me", "email": "github@yue.coffee", "date": "2022-04-20T08:56:20Z"}, "committer": {"name": "rainy-me", "email": "github@yue.coffee", "date": "2022-04-20T08:56:20Z"}, "message": "fix: improve parameter completion", "tree": {"sha": "cbeea49b8e1d87158a560b37f8a8eed8b357d22c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cbeea49b8e1d87158a560b37f8a8eed8b357d22c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a58f7acc97198af1e2d511a90609be9a8b67882b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a58f7acc97198af1e2d511a90609be9a8b67882b", "html_url": "https://github.com/rust-lang/rust/commit/a58f7acc97198af1e2d511a90609be9a8b67882b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a58f7acc97198af1e2d511a90609be9a8b67882b/comments", "author": {"login": "yue4u", "id": 26110087, "node_id": "MDQ6VXNlcjI2MTEwMDg3", "avatar_url": "https://avatars.githubusercontent.com/u/26110087?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yue4u", "html_url": "https://github.com/yue4u", "followers_url": "https://api.github.com/users/yue4u/followers", "following_url": "https://api.github.com/users/yue4u/following{/other_user}", "gists_url": "https://api.github.com/users/yue4u/gists{/gist_id}", "starred_url": "https://api.github.com/users/yue4u/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yue4u/subscriptions", "organizations_url": "https://api.github.com/users/yue4u/orgs", "repos_url": "https://api.github.com/users/yue4u/repos", "events_url": "https://api.github.com/users/yue4u/events{/privacy}", "received_events_url": "https://api.github.com/users/yue4u/received_events", "type": "User", "site_admin": false}, "committer": {"login": "yue4u", "id": 26110087, "node_id": "MDQ6VXNlcjI2MTEwMDg3", "avatar_url": "https://avatars.githubusercontent.com/u/26110087?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yue4u", "html_url": "https://github.com/yue4u", "followers_url": "https://api.github.com/users/yue4u/followers", "following_url": "https://api.github.com/users/yue4u/following{/other_user}", "gists_url": "https://api.github.com/users/yue4u/gists{/gist_id}", "starred_url": "https://api.github.com/users/yue4u/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yue4u/subscriptions", "organizations_url": "https://api.github.com/users/yue4u/orgs", "repos_url": "https://api.github.com/users/yue4u/repos", "events_url": "https://api.github.com/users/yue4u/events{/privacy}", "received_events_url": "https://api.github.com/users/yue4u/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e3ec87730aaabccff4200b218528bd5f7fa57ff9", "url": "https://api.github.com/repos/rust-lang/rust/commits/e3ec87730aaabccff4200b218528bd5f7fa57ff9", "html_url": "https://github.com/rust-lang/rust/commit/e3ec87730aaabccff4200b218528bd5f7fa57ff9"}], "stats": {"total": 105, "additions": 96, "deletions": 9}, "files": [{"sha": "5bfd2bc1df1b11295d53196e75c49e896ad663aa", "filename": "crates/ide_completion/src/completions/fn_param.rs", "status": "modified", "additions": 11, "deletions": 9, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/a58f7acc97198af1e2d511a90609be9a8b67882b/crates%2Fide_completion%2Fsrc%2Fcompletions%2Ffn_param.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a58f7acc97198af1e2d511a90609be9a8b67882b/crates%2Fide_completion%2Fsrc%2Fcompletions%2Ffn_param.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Ffn_param.rs?ref=a58f7acc97198af1e2d511a90609be9a8b67882b", "patch": "@@ -5,7 +5,7 @@ use rustc_hash::FxHashMap;\n use syntax::{\n     algo,\n     ast::{self, HasModuleItem},\n-    match_ast, AstNode, Direction, SyntaxKind,\n+    match_ast, AstNode, Direction, SyntaxKind, TextRange,\n };\n \n use crate::{\n@@ -27,12 +27,12 @@ pub(crate) fn complete_fn_param(acc: &mut Completions, ctx: &CompletionContext)\n \n     let comma_wrapper = comma_wrapper(ctx);\n     let mut add_new_item_to_acc = |label: &str, lookup: String| {\n-        let mk_item = |label: &str| {\n-            CompletionItem::new(CompletionItemKind::Binding, ctx.source_range(), label)\n+        let mk_item = |label: &str, range: TextRange| {\n+            CompletionItem::new(CompletionItemKind::Binding, range, label)\n         };\n         let mut item = match &comma_wrapper {\n-            Some(fmt) => mk_item(&fmt(label)),\n-            None => mk_item(label),\n+            Some((fmt, range)) => mk_item(&fmt(label), *range),\n+            None => mk_item(label, ctx.source_range()),\n         };\n         item.lookup_by(lookup);\n         item.add_to(acc)\n@@ -162,14 +162,16 @@ fn should_add_self_completions(ctx: &CompletionContext, param_list: &ast::ParamL\n     inside_impl && no_params\n }\n \n-fn comma_wrapper(ctx: &CompletionContext) -> Option<impl Fn(&str) -> String> {\n+fn comma_wrapper(ctx: &CompletionContext) -> Option<(impl Fn(&str) -> String, TextRange)> {\n+    let param = ctx.token.ancestors().find(|node| node.kind() == SyntaxKind::PARAM)?;\n+\n     let next_token_kind = {\n-        let t = ctx.token.next_token()?;\n+        let t = param.last_token()?.next_token()?;\n         let t = algo::skip_whitespace_token(t, Direction::Next)?;\n         t.kind()\n     };\n     let prev_token_kind = {\n-        let t = ctx.previous_token.clone()?;\n+        let t = param.first_token()?.prev_token()?;\n         let t = algo::skip_whitespace_token(t, Direction::Prev)?;\n         t.kind()\n     };\n@@ -182,5 +184,5 @@ fn comma_wrapper(ctx: &CompletionContext) -> Option<impl Fn(&str) -> String> {\n         matches!(prev_token_kind, SyntaxKind::COMMA | SyntaxKind::L_PAREN | SyntaxKind::PIPE);\n     let leading = if has_leading_comma { \"\" } else { \", \" };\n \n-    Some(move |param: &_| format!(\"{}{}{}\", leading, param, trailing))\n+    Some((move |label: &_| (format!(\"{}{}{}\", leading, label, trailing)), param.text_range()))\n }"}, {"sha": "2ae300ab653e3f2e0d744e1c9cbdf3ca568bee01", "filename": "crates/ide_completion/src/render/function.rs", "status": "modified", "additions": 72, "deletions": 0, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/a58f7acc97198af1e2d511a90609be9a8b67882b/crates%2Fide_completion%2Fsrc%2Frender%2Ffunction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a58f7acc97198af1e2d511a90609be9a8b67882b/crates%2Fide_completion%2Fsrc%2Frender%2Ffunction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Frender%2Ffunction.rs?ref=a58f7acc97198af1e2d511a90609be9a8b67882b", "patch": "@@ -562,6 +562,78 @@ fn qux(Foo { bar }: Foo) {\n fn main() {\n   qux(${1:foo})$0\n }\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn complete_fn_param() {\n+        // has mut kw\n+        check_edit(\n+            \"mut bar\",\n+            r#\"\n+fn f(foo: (), mut bar: u32) {}\n+fn g(foo: (), mut ba$0)\n+\"#,\n+            r#\"\n+fn f(foo: (), mut bar: u32) {}\n+fn g(foo: (), mut bar: u32)\n+\"#,\n+        );\n+\n+        // has type param\n+        check_edit(\n+            \"mut bar\",\n+            r#\"\n+fn g(foo: (), mut ba$0: u32)\n+fn f(foo: (), mut bar: u32) {}\n+\"#,\n+            r#\"\n+fn g(foo: (), mut bar: u32)\n+fn f(foo: (), mut bar: u32) {}\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn complete_fn_mut_param_add_comma() {\n+        // add leading and trailing comma\n+        check_edit(\n+            \"mut bar\",\n+            r#\"\n+fn f(foo: (), mut bar: u32) {}\n+fn g(foo: ()mut ba$0 baz: ())\n+\"#,\n+            r#\"\n+fn f(foo: (), mut bar: u32) {}\n+fn g(foo: (), mut bar: u32, baz: ())\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn complete_fn_mut_param_has_attribute() {\n+        check_edit(\n+            \"mut bar\",\n+            r#\"\n+fn f(foo: (), #[baz = \"qux\"] mut bar: u32) {}\n+fn g(foo: (), mut ba$0)\n+\"#,\n+            r#\"\n+fn f(foo: (), #[baz = \"qux\"] mut bar: u32) {}\n+fn g(foo: (), #[baz = \"qux\"] mut bar: u32)\n+\"#,\n+        );\n+\n+        check_edit(\n+            \"mut bar\",\n+            r#\"\n+fn f(foo: (), #[baz = \"qux\"] mut bar: u32) {}\n+fn g(foo: (), #[baz = \"qux\"] mut ba$0)\n+\"#,\n+            r#\"\n+fn f(foo: (), #[baz = \"qux\"] mut bar: u32) {}\n+fn g(foo: (), #[baz = \"qux\"] mut bar: u32)\n \"#,\n         );\n     }"}, {"sha": "678c99aa7ad90c3f368fbd506d1adde23f652d59", "filename": "crates/ide_completion/src/tests/fn_param.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/a58f7acc97198af1e2d511a90609be9a8b67882b/crates%2Fide_completion%2Fsrc%2Ftests%2Ffn_param.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a58f7acc97198af1e2d511a90609be9a8b67882b/crates%2Fide_completion%2Fsrc%2Ftests%2Ffn_param.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Ftests%2Ffn_param.rs?ref=a58f7acc97198af1e2d511a90609be9a8b67882b", "patch": "@@ -232,3 +232,16 @@ fn bar(bar$0) {}\n         \"#]],\n     )\n }\n+\n+#[test]\n+fn completes_for_params_with_attributes() {\n+    check(\n+        r#\"\n+fn f(foo: (), #[baz = \"qux\"] mut bar: u32) {}\n+fn g(foo: (), #[baz = \"qux\"] mut ba$0)\n+\"#,\n+        expect![[r##\"\n+            bn #[baz = \"qux\"] mut bar: u32\n+        \"##]],\n+    )\n+}"}]}