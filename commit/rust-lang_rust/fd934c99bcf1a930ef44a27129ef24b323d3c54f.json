{"sha": "fd934c99bcf1a930ef44a27129ef24b323d3c54f", "node_id": "C_kwDOAAsO6NoAKGZkOTM0Yzk5YmNmMWE5MzBlZjQ0YTI3MTI5ZWYyNGIzMjNkM2M1NGY", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-07-21T22:00:15Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-08-16T00:59:06Z"}, "message": "Do not allow Drop impl on foreign fundamental types", "tree": {"sha": "d9b3906d9c0b43f00807efc1cc7563e259893011", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d9b3906d9c0b43f00807efc1cc7563e259893011"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fd934c99bcf1a930ef44a27129ef24b323d3c54f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fd934c99bcf1a930ef44a27129ef24b323d3c54f", "html_url": "https://github.com/rust-lang/rust/commit/fd934c99bcf1a930ef44a27129ef24b323d3c54f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fd934c99bcf1a930ef44a27129ef24b323d3c54f/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "40336865fe7d4a01139a3336639c6971647e885c", "url": "https://api.github.com/repos/rust-lang/rust/commits/40336865fe7d4a01139a3336639c6971647e885c", "html_url": "https://github.com/rust-lang/rust/commit/40336865fe7d4a01139a3336639c6971647e885c"}], "stats": {"total": 69, "additions": 51, "deletions": 18}, "files": [{"sha": "2a8488cc5487e12890596b6f2fddc3c1563d0935", "filename": "compiler/rustc_error_messages/locales/en-US/typeck.ftl", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fd934c99bcf1a930ef44a27129ef24b323d3c54f/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Ftypeck.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/fd934c99bcf1a930ef44a27129ef24b323d3c54f/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Ftypeck.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Ftypeck.ftl?ref=fd934c99bcf1a930ef44a27129ef24b323d3c54f", "patch": "@@ -24,8 +24,8 @@ typeck_lifetimes_or_bounds_mismatch_on_trait =\n     .generics_label = lifetimes in impl do not match this {$item_kind} in trait\n \n typeck_drop_impl_on_wrong_item =\n-    the `Drop` trait may only be implemented for structs, enums, and unions\n-    .label = must be a struct, enum, or union\n+    the `Drop` trait may only be implemented for local structs, enums, and unions\n+    .label = must be a struct, enum, or union in the current crate\n \n typeck_field_already_declared =\n     field `{$field_name}` is already declared"}, {"sha": "2467a81638f75bfa0828c61473d9cfde368154a3", "filename": "compiler/rustc_typeck/src/coherence/builtin.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/fd934c99bcf1a930ef44a27129ef24b323d3c54f/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd934c99bcf1a930ef44a27129ef24b323d3c54f/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Fbuiltin.rs?ref=fd934c99bcf1a930ef44a27129ef24b323d3c54f", "patch": "@@ -47,9 +47,11 @@ impl<'tcx> Checker<'tcx> {\n }\n \n fn visit_implementation_of_drop(tcx: TyCtxt<'_>, impl_did: LocalDefId) {\n-    // Destructors only work on nominal types.\n-    if let ty::Adt(..) | ty::Error(_) = tcx.type_of(impl_did).kind() {\n-        return;\n+    // Destructors only work on local ADT types.\n+    match tcx.type_of(impl_did).kind() {\n+        ty::Adt(def, _) if def.did().is_local() => return,\n+        ty::Error(_) => return,\n+        _ => {}\n     }\n \n     let sp = match tcx.hir().expect_item(impl_did).kind {"}, {"sha": "c43df40d6c26ad1a374a820881eb9b1ed6381cda", "filename": "src/test/ui/drop/drop-foreign-fundamental.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Fdrop%2Fdrop-foreign-fundamental.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Fdrop%2Fdrop-foreign-fundamental.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdrop%2Fdrop-foreign-fundamental.rs?ref=fd934c99bcf1a930ef44a27129ef24b323d3c54f", "patch": "@@ -0,0 +1,23 @@\n+use std::ops::Deref;\n+use std::pin::Pin;\n+\n+struct Whatever<T>(T);\n+\n+impl<T> Deref for Whatever<T> {\n+    type Target = T;\n+\n+    fn deref(&self) -> &T {\n+        &self.0\n+    }\n+}\n+\n+struct A;\n+\n+impl Drop for Pin<Whatever<A>> {\n+    //~^ ERROR  the `Drop` trait may only be implemented for local structs, enums, and unions\n+    fn drop(&mut self) {}\n+}\n+\n+fn main() {\n+    let x = Pin::new(Whatever(1.0f32));\n+}"}, {"sha": "fbd1ba0859134b8ea4b33b54655bed8bdb2d59e6", "filename": "src/test/ui/drop/drop-foreign-fundamental.stderr", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Fdrop%2Fdrop-foreign-fundamental.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Fdrop%2Fdrop-foreign-fundamental.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdrop%2Fdrop-foreign-fundamental.stderr?ref=fd934c99bcf1a930ef44a27129ef24b323d3c54f", "patch": "@@ -0,0 +1,9 @@\n+error[E0120]: the `Drop` trait may only be implemented for local structs, enums, and unions\n+  --> $DIR/drop-foreign-fundamental.rs:16:15\n+   |\n+LL | impl Drop for Pin<Whatever<A>> {\n+   |               ^^^^^^^^^^^^^^^^ must be a struct, enum, or union in the current crate\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0120`."}, {"sha": "145eab126c28deb1771cde394d7c2a120696c419", "filename": "src/test/ui/dropck/drop-on-non-struct.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Fdropck%2Fdrop-on-non-struct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Fdropck%2Fdrop-on-non-struct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdropck%2Fdrop-on-non-struct.rs?ref=fd934c99bcf1a930ef44a27129ef24b323d3c54f", "patch": "@@ -1,5 +1,5 @@\n impl<'a> Drop for &'a mut isize {\n-    //~^ ERROR the `Drop` trait may only be implemented for structs, enums, and unions\n+    //~^ ERROR the `Drop` trait may only be implemented for local structs, enums, and unions\n     //~^^ ERROR E0117\n     fn drop(&mut self) {\n         println!(\"kaboom\");\n@@ -8,8 +8,7 @@ impl<'a> Drop for &'a mut isize {\n \n impl Drop for Nonexistent {\n     //~^ ERROR cannot find type `Nonexistent`\n-    fn drop(&mut self) { }\n+    fn drop(&mut self) {}\n }\n \n-fn main() {\n-}\n+fn main() {}"}, {"sha": "e8fbe5e972642ebc870ba85f308fa70bb2e1bf0a", "filename": "src/test/ui/dropck/drop-on-non-struct.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Fdropck%2Fdrop-on-non-struct.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Fdropck%2Fdrop-on-non-struct.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdropck%2Fdrop-on-non-struct.stderr?ref=fd934c99bcf1a930ef44a27129ef24b323d3c54f", "patch": "@@ -15,11 +15,11 @@ LL | impl<'a> Drop for &'a mut isize {\n    |\n    = note: define and implement a trait or new type instead\n \n-error[E0120]: the `Drop` trait may only be implemented for structs, enums, and unions\n+error[E0120]: the `Drop` trait may only be implemented for local structs, enums, and unions\n   --> $DIR/drop-on-non-struct.rs:1:19\n    |\n LL | impl<'a> Drop for &'a mut isize {\n-   |                   ^^^^^^^^^^^^^ must be a struct, enum, or union\n+   |                   ^^^^^^^^^^^^^ must be a struct, enum, or union in the current crate\n \n error: aborting due to 3 previous errors\n "}, {"sha": "406d24e36661449a7ab28ea6eb36dc75314daa8c", "filename": "src/test/ui/error-codes/E0117.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Ferror-codes%2FE0117.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Ferror-codes%2FE0117.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferror-codes%2FE0117.rs?ref=fd934c99bcf1a930ef44a27129ef24b323d3c54f", "patch": "@@ -1,4 +1,4 @@\n impl Drop for u32 {} //~ ERROR E0117\n-//~| ERROR the `Drop` trait may only be implemented for structs, enums, and unions\n+//~| ERROR the `Drop` trait may only be implemented for local structs, enums, and unions\n \n fn main() {}"}, {"sha": "f144aa9f72c131d0e1dfd1140ac2668df3bbdbe8", "filename": "src/test/ui/error-codes/E0117.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Ferror-codes%2FE0117.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Ferror-codes%2FE0117.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferror-codes%2FE0117.stderr?ref=fd934c99bcf1a930ef44a27129ef24b323d3c54f", "patch": "@@ -9,11 +9,11 @@ LL | impl Drop for u32 {}\n    |\n    = note: define and implement a trait or new type instead\n \n-error[E0120]: the `Drop` trait may only be implemented for structs, enums, and unions\n+error[E0120]: the `Drop` trait may only be implemented for local structs, enums, and unions\n   --> $DIR/E0117.rs:1:15\n    |\n LL | impl Drop for u32 {}\n-   |               ^^^ must be a struct, enum, or union\n+   |               ^^^ must be a struct, enum, or union in the current crate\n \n error: aborting due to 2 previous errors\n "}, {"sha": "75778f1f94a16ac61cc233b183cd7c30cbfd6f0c", "filename": "src/test/ui/error-codes/E0120.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Ferror-codes%2FE0120.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Ferror-codes%2FE0120.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferror-codes%2FE0120.stderr?ref=fd934c99bcf1a930ef44a27129ef24b323d3c54f", "patch": "@@ -1,8 +1,8 @@\n-error[E0120]: the `Drop` trait may only be implemented for structs, enums, and unions\n+error[E0120]: the `Drop` trait may only be implemented for local structs, enums, and unions\n   --> $DIR/E0120.rs:3:15\n    |\n LL | impl Drop for dyn MyTrait {\n-   |               ^^^^^^^^^^^ must be a struct, enum, or union\n+   |               ^^^^^^^^^^^ must be a struct, enum, or union in the current crate\n \n error: aborting due to previous error\n "}, {"sha": "e249db9df5324998595eecbf2e3d0c92ad13a053", "filename": "src/test/ui/issues/issue-41974.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Fissues%2Fissue-41974.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fd934c99bcf1a930ef44a27129ef24b323d3c54f/src%2Ftest%2Fui%2Fissues%2Fissue-41974.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-41974.stderr?ref=fd934c99bcf1a930ef44a27129ef24b323d3c54f", "patch": "@@ -7,11 +7,11 @@ LL | impl<T> Drop for T where T: A {\n    = note: implementing a foreign trait is only possible if at least one of the types for which it is implemented is local\n    = note: only traits defined in the current crate can be implemented for a type parameter\n \n-error[E0120]: the `Drop` trait may only be implemented for structs, enums, and unions\n+error[E0120]: the `Drop` trait may only be implemented for local structs, enums, and unions\n   --> $DIR/issue-41974.rs:7:18\n    |\n LL | impl<T> Drop for T where T: A {\n-   |                  ^ must be a struct, enum, or union\n+   |                  ^ must be a struct, enum, or union in the current crate\n \n error: aborting due to 2 previous errors\n "}]}