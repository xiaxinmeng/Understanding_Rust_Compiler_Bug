{"sha": "39f5563e73a46f3393d33f501e51be59a4927f98", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM5ZjU1NjNlNzNhNDZmMzM5M2QzM2Y1MDFlNTFiZTU5YTQ5MjdmOTg=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2020-11-03T18:32:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-03T18:32:34Z"}, "message": "Rollup merge of #78624 - bjorn3:update_cg_clif-2020-11-01, r=jyn514\n\nSync rustc_codegen_cranelift\n\nThis fixes bootstrapping of rustc using cg_clif again. It regressed a while before #77975 got merged.\n\nFixes https://github.com/bjorn3/rustc_codegen_cranelift/issues/743", "tree": {"sha": "5939283ecade4fa746b61f07a9ff59f209ed9fbc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5939283ecade4fa746b61f07a9ff59f209ed9fbc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/39f5563e73a46f3393d33f501e51be59a4927f98", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfoaJDCRBK7hj4Ov3rIwAAdHIIAF7NrOTLpVoVpCSXE/F0Q78c\nJCjUoHz+BqT3xW8dBAlKQRUAlDFtfJPwBmPn+8k7oWU6/li0fOa93bzTE/U1iGzq\nDTw+wEJhzTgCTzNxunCDMA7a2r9WHBGKkMTEzBupr5YEmWv65WnNHORCX7NyPZlo\naG7QCVphKIHHqY5dCT2zinHq+AzlOpm6ish7DHhx0qxcLzxzlfVApcEFNOiMhfHX\n1QwOc+jvntRVzI5Ed+UZtRSiIQMOnbBdRpo325GqeejeJG0b0cECWaANClS62b0U\nUwbHa8JL3Nty2N0VLBgXX7ZVFcN7pqg6axqibeZ/Hef1S5SgqB6ptZiOG/TNVbA=\n=5ESS\n-----END PGP SIGNATURE-----\n", "payload": "tree 5939283ecade4fa746b61f07a9ff59f209ed9fbc\nparent 52405f7c0cc3e8cc52293ea19b78da88eb79af2d\nparent 216c4ae46352330bc7962f132fe226a7e73ab8fa\nauthor Mara Bos <m-ou.se@m-ou.se> 1604428354 +0100\ncommitter GitHub <noreply@github.com> 1604428354 +0100\n\nRollup merge of #78624 - bjorn3:update_cg_clif-2020-11-01, r=jyn514\n\nSync rustc_codegen_cranelift\n\nThis fixes bootstrapping of rustc using cg_clif again. It regressed a while before #77975 got merged.\n\nFixes https://github.com/bjorn3/rustc_codegen_cranelift/issues/743\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/39f5563e73a46f3393d33f501e51be59a4927f98", "html_url": "https://github.com/rust-lang/rust/commit/39f5563e73a46f3393d33f501e51be59a4927f98", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/39f5563e73a46f3393d33f501e51be59a4927f98/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "52405f7c0cc3e8cc52293ea19b78da88eb79af2d", "url": "https://api.github.com/repos/rust-lang/rust/commits/52405f7c0cc3e8cc52293ea19b78da88eb79af2d", "html_url": "https://github.com/rust-lang/rust/commit/52405f7c0cc3e8cc52293ea19b78da88eb79af2d"}, {"sha": "216c4ae46352330bc7962f132fe226a7e73ab8fa", "url": "https://api.github.com/repos/rust-lang/rust/commits/216c4ae46352330bc7962f132fe226a7e73ab8fa", "html_url": "https://github.com/rust-lang/rust/commit/216c4ae46352330bc7962f132fe226a7e73ab8fa"}], "stats": {"total": 1000, "additions": 612, "deletions": 388}, "files": [{"sha": "8c94a0aa5e6ebe7beba14d52e5ed817053529f8e", "filename": "compiler/rustc_codegen_cranelift/.github/workflows/bootstrap_rustc.yml", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2F.github%2Fworkflows%2Fbootstrap_rustc.yml", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2F.github%2Fworkflows%2Fbootstrap_rustc.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2F.github%2Fworkflows%2Fbootstrap_rustc.yml?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -0,0 +1,44 @@\n+name: Bootstrap rustc using cg_clif\n+\n+on:\n+  - push\n+\n+jobs:\n+  bootstrap_rustc:\n+    runs-on: ubuntu-latest\n+\n+    steps:\n+    - uses: actions/checkout@v2\n+\n+    - name: Cache cargo installed crates\n+      uses: actions/cache@v2\n+      with:\n+        path: ~/.cargo/bin\n+        key: ${{ runner.os }}-cargo-installed-crates\n+\n+    - name: Cache cargo registry and index\n+      uses: actions/cache@v2\n+      with:\n+        path: |\n+            ~/.cargo/registry\n+            ~/.cargo/git\n+        key: ${{ runner.os }}-cargo-registry-and-index-${{ hashFiles('**/Cargo.lock') }}\n+\n+    - name: Cache cargo target dir\n+      uses: actions/cache@v2\n+      with:\n+        path: target\n+        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('rust-toolchain', '**/Cargo.lock') }}\n+\n+    - name: Prepare dependencies\n+      run: |\n+        git config --global user.email \"user@example.com\"\n+        git config --global user.name \"User\"\n+        ./prepare.sh\n+\n+    - name: Test\n+      run: |\n+        # Enable backtraces for easier debugging\n+        export RUST_BACKTRACE=1\n+\n+        ./scripts/test_bootstrap.sh"}, {"sha": "e6d3375fb1bab6240d6d309259aa84657547a559", "filename": "compiler/rustc_codegen_cranelift/.github/workflows/main.yml", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2F.github%2Fworkflows%2Fmain.yml", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2F.github%2Fworkflows%2Fmain.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2F.github%2Fworkflows%2Fmain.yml?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -51,4 +51,13 @@ jobs:\n         export COMPILE_RUNS=2\n         export RUN_RUNS=2\n \n-        ./test.sh --release\n+        ./test.sh\n+\n+    - name: Package prebuilt cg_clif\n+      run: tar cvfJ cg_clif.tar.xz build\n+\n+    - name: Upload prebuilt cg_clif\n+      uses: actions/upload-artifact@v2\n+      with:\n+        name: cg_clif-${{ runner.os }}\n+        path: cg_clif.tar.xz"}, {"sha": "18196bce0094597d583e6e4420c32e0d85022f73", "filename": "compiler/rustc_codegen_cranelift/.gitignore", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2F.gitignore", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2F.gitignore", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2F.gitignore?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -6,7 +6,7 @@ perf.data\n perf.data.old\n *.events\n *.string*\n-/build_sysroot/sysroot\n+/build\n /build_sysroot/sysroot_src\n /rust\n /rand"}, {"sha": "2889fac77f6a4616fd9b976932cd09a15a91c738", "filename": "compiler/rustc_codegen_cranelift/Cargo.lock", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2FCargo.lock?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -44,15 +44,15 @@ checksum = \"4785bdd1c96b2a846b2bd7cc02e86b6b3dbf14e7e53446c4f54c92a361040822\"\n [[package]]\n name = \"cranelift-bforest\"\n version = \"0.67.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#4fd90dccabb266e983740e1f5daf8bde9266b286\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#44cbdecea03c360ea82e6482f0cf6c614effef21\"\n dependencies = [\n  \"cranelift-entity\",\n ]\n \n [[package]]\n name = \"cranelift-codegen\"\n version = \"0.67.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#4fd90dccabb266e983740e1f5daf8bde9266b286\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#44cbdecea03c360ea82e6482f0cf6c614effef21\"\n dependencies = [\n  \"byteorder\",\n  \"cranelift-bforest\",\n@@ -70,7 +70,7 @@ dependencies = [\n [[package]]\n name = \"cranelift-codegen-meta\"\n version = \"0.67.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#4fd90dccabb266e983740e1f5daf8bde9266b286\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#44cbdecea03c360ea82e6482f0cf6c614effef21\"\n dependencies = [\n  \"cranelift-codegen-shared\",\n  \"cranelift-entity\",\n@@ -79,17 +79,17 @@ dependencies = [\n [[package]]\n name = \"cranelift-codegen-shared\"\n version = \"0.67.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#4fd90dccabb266e983740e1f5daf8bde9266b286\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#44cbdecea03c360ea82e6482f0cf6c614effef21\"\n \n [[package]]\n name = \"cranelift-entity\"\n version = \"0.67.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#4fd90dccabb266e983740e1f5daf8bde9266b286\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#44cbdecea03c360ea82e6482f0cf6c614effef21\"\n \n [[package]]\n name = \"cranelift-frontend\"\n version = \"0.67.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#4fd90dccabb266e983740e1f5daf8bde9266b286\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#44cbdecea03c360ea82e6482f0cf6c614effef21\"\n dependencies = [\n  \"cranelift-codegen\",\n  \"log\",\n@@ -100,7 +100,7 @@ dependencies = [\n [[package]]\n name = \"cranelift-module\"\n version = \"0.67.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#4fd90dccabb266e983740e1f5daf8bde9266b286\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#44cbdecea03c360ea82e6482f0cf6c614effef21\"\n dependencies = [\n  \"anyhow\",\n  \"cranelift-codegen\",\n@@ -112,7 +112,7 @@ dependencies = [\n [[package]]\n name = \"cranelift-native\"\n version = \"0.67.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#4fd90dccabb266e983740e1f5daf8bde9266b286\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#44cbdecea03c360ea82e6482f0cf6c614effef21\"\n dependencies = [\n  \"cranelift-codegen\",\n  \"raw-cpuid\",\n@@ -122,7 +122,7 @@ dependencies = [\n [[package]]\n name = \"cranelift-object\"\n version = \"0.67.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#4fd90dccabb266e983740e1f5daf8bde9266b286\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#44cbdecea03c360ea82e6482f0cf6c614effef21\"\n dependencies = [\n  \"anyhow\",\n  \"cranelift-codegen\",\n@@ -135,7 +135,7 @@ dependencies = [\n [[package]]\n name = \"cranelift-simplejit\"\n version = \"0.67.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#4fd90dccabb266e983740e1f5daf8bde9266b286\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime/?branch=main#44cbdecea03c360ea82e6482f0cf6c614effef21\"\n dependencies = [\n  \"cranelift-codegen\",\n  \"cranelift-entity\","}, {"sha": "f8a5e13ed54c177be18e3dd234369b02b79a4d85", "filename": "compiler/rustc_codegen_cranelift/Readme.md", "status": "modified", "additions": 26, "deletions": 11, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2FReadme.md", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2FReadme.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2FReadme.md?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -2,41 +2,56 @@\n \n > \u26a0\u26a0\u26a0 Certain kinds of FFI don't work yet. \u26a0\u26a0\u26a0\n \n-The goal of this project is to create an alternative codegen backend for the rust compiler based on [Cranelift](https://github.com/bytecodealliance/wasmtime/blob/master/cranelift). This has the potential to improve compilation times in debug mode. If your project doesn't use any of the things listed under \"Not yet supported\", it should work fine. If not please open an issue.\n+The goal of this project is to create an alternative codegen backend for the rust compiler based on [Cranelift](https://github.com/bytecodealliance/wasmtime/blob/master/cranelift).\n+This has the potential to improve compilation times in debug mode.\n+If your project doesn't use any of the things listed under \"Not yet supported\", it should work fine.\n+If not please open an issue.\n \n-## Building\n+## Building and testing\n \n ```bash\n $ git clone https://github.com/bjorn3/rustc_codegen_cranelift.git\n $ cd rustc_codegen_cranelift\n $ ./prepare.sh # download and patch sysroot src and install hyperfine for benchmarking\n-$ ./test.sh --release\n+$ ./build.sh\n ```\n \n+To run the test suite replace the last command with:\n+\n+```bash\n+$ ./test.sh\n+```\n+\n+This will implicitly build cg_clif too. Both `build.sh` and `test.sh` accept a `--debug` argument to\n+build in debug mode.\n+\n+Alternatively you can download a pre built version from [GHA]. It is listed in the artifacts section\n+of workflow runs. Unfortunately due to GHA restrictions you need to be logged in to access it.\n+\n+[GHA]: https://github.com/bjorn3/rustc_codegen_cranelift/actions?query=branch%3Amaster+event%3Apush+is%3Asuccess\n+\n ## Usage\n \n rustc_codegen_cranelift can be used as a near-drop-in replacement for `cargo build` or `cargo run` for existing projects.\n \n-Assuming `$cg_clif_dir` is the directory you cloned this repo into and you followed the instructions (`prepare.sh` and `test.sh`).\n+Assuming `$cg_clif_dir` is the directory you cloned this repo into and you followed the instructions (`prepare.sh` and `build.sh` or `test.sh`).\n \n ### Cargo\n \n In the directory with your project (where you can do the usual `cargo build`), run:\n \n ```bash\n-$ $cg_clif_dir/cargo.sh run\n+$ $cg_clif_dir/build/cargo.sh run\n ```\n \n This should build and run your project with rustc_codegen_cranelift instead of the usual LLVM backend.\n \n-If you compiled cg_clif in debug mode (aka you didn't pass `--release` to `./test.sh`) you should set `CHANNEL=\"debug\"`.\n-\n ### Rustc\n \n > You should prefer using the Cargo method.\n \n ```bash\n-$ $cg_clif_dir/target/release/cg_clif my_crate.rs\n+$ $cg_clif_dir/build/cg_clif my_crate.rs\n ```\n \n ### Jit mode\n@@ -47,13 +62,13 @@ In jit mode cg_clif will immediately execute your code without creating an execu\n > The jit mode will probably need cargo integration to make this possible.\n \n ```bash\n-$ $cg_clif_dir/cargo.sh jit\n+$ $cg_clif_dir/build/cargo.sh jit\n ```\n \n or\n \n ```bash\n-$ $cg_clif_dir/target/release/cg_clif --jit my_crate.rs\n+$ $cg_clif_dir/build/cg_clif --jit my_crate.rs\n ```\n \n ### Shell\n@@ -62,7 +77,7 @@ These are a few functions that allow you to easily run rust code from the shell\n \n ```bash\n function jit_naked() {\n-    echo \"$@\" | $cg_clif_dir/target/release/cg_clif - --jit\n+    echo \"$@\" | $cg_clif_dir/build/cg_clif - --jit\n }\n \n function jit() {"}, {"sha": "f9a87e68a046a7f7c7960f5a1ee0858685886e17", "filename": "compiler/rustc_codegen_cranelift/build.sh", "status": "added", "additions": 47, "deletions": 0, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fbuild.sh", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fbuild.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fbuild.sh?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -0,0 +1,47 @@\n+#!/bin/bash\n+set -e\n+\n+# Settings\n+export CHANNEL=\"release\"\n+build_sysroot=1\n+target_dir='build'\n+while [[ $# != 0 ]]; do\n+    case $1 in\n+        \"--debug\")\n+            export CHANNEL=\"debug\"\n+            ;;\n+        \"--without-sysroot\")\n+            build_sysroot=0\n+            ;;\n+        \"--target-dir\")\n+            target_dir=$2\n+            shift\n+            ;;\n+        *)\n+            echo \"Unknown flag '$1'\"\n+            echo \"Usage: ./build.sh [--debug] [--without-sysroot] [--target-dir DIR]\"\n+            ;;\n+    esac\n+    shift\n+done\n+\n+# Build cg_clif\n+export RUSTFLAGS=\"-Zrun_dsymutil=no\"\n+if [[ \"$CHANNEL\" == \"release\" ]]; then\n+    cargo build --release\n+else\n+    cargo build\n+fi\n+\n+rm -rf $target_dir\n+mkdir $target_dir\n+cp -a target/$CHANNEL/cg_clif{,_build_sysroot} target/$CHANNEL/*rustc_codegen_cranelift* $target_dir/\n+cp -a rust-toolchain scripts/config.sh scripts/cargo.sh $target_dir\n+\n+if [[ \"$build_sysroot\" == \"1\" ]]; then\n+    echo \"[BUILD] sysroot\"\n+    export CG_CLIF_INCR_CACHE_DISABLED=1\n+    dir=$(pwd)\n+    cd $target_dir\n+    time $dir/build_sysroot/build_sysroot.sh\n+fi"}, {"sha": "eba15c0dd4308ee2eb8218d3455917554c29eac3", "filename": "compiler/rustc_codegen_cranelift/build_sysroot/build_sysroot.sh", "status": "modified", "additions": 15, "deletions": 12, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fbuild_sysroot%2Fbuild_sysroot.sh", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fbuild_sysroot%2Fbuild_sysroot.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fbuild_sysroot%2Fbuild_sysroot.sh?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -3,25 +3,28 @@\n # Requires the CHANNEL env var to be set to `debug` or `release.`\n \n set -e\n-cd $(dirname \"$0\")\n \n-pushd ../ >/dev/null\n-source ./scripts/config.sh\n-popd >/dev/null\n+source ./config.sh\n \n-# Cleanup for previous run\n-#     v Clean target dir except for build scripts and incremental cache\n-rm -r target/*/{debug,release}/{build,deps,examples,libsysroot*,native} 2>/dev/null || true\n-rm -r sysroot/ 2>/dev/null || true\n+dir=$(pwd)\n \n # Use rustc with cg_clif as hotpluggable backend instead of the custom cg_clif driver so that\n # build scripts are still compiled using cg_llvm.\n-export RUSTC=$(pwd)/../\"target/\"$CHANNEL\"/cg_clif_build_sysroot\"\n+export RUSTC=$dir\"/cg_clif_build_sysroot\"\n export RUSTFLAGS=$RUSTFLAGS\" --clif\"\n \n+cd $(dirname \"$0\")\n+\n+# Cleanup for previous run\n+#     v Clean target dir except for build scripts and incremental cache\n+rm -r target/*/{debug,release}/{build,deps,examples,libsysroot*,native} 2>/dev/null || true\n+\n+# We expect the target dir in the default location. Guard against the user changing it.\n+export CARGO_TARGET_DIR=target\n+\n # Build libs\n export RUSTFLAGS=\"$RUSTFLAGS -Zforce-unstable-if-unmarked -Cpanic=abort\"\n-if [[ \"$1\" == \"--release\" ]]; then\n+if [[ \"$1\" != \"--debug\" ]]; then\n     sysroot_channel='release'\n     # FIXME Enable incremental again once rust-lang/rust#74946 is fixed\n     # FIXME Enable -Zmir-opt-level=2 again once it doesn't ice anymore\n@@ -32,5 +35,5 @@ else\n fi\n \n # Copy files to sysroot\n-mkdir -p sysroot/lib/rustlib/$TARGET_TRIPLE/lib/\n-cp -r target/$TARGET_TRIPLE/$sysroot_channel/deps/* sysroot/lib/rustlib/$TARGET_TRIPLE/lib/\n+mkdir -p $dir/sysroot/lib/rustlib/$TARGET_TRIPLE/lib/\n+cp -a target/$TARGET_TRIPLE/$sysroot_channel/deps/* $dir/sysroot/lib/rustlib/$TARGET_TRIPLE/lib/"}, {"sha": "d0fb09ce745d4daf860ed9d70d223880d46dc587", "filename": "compiler/rustc_codegen_cranelift/build_sysroot/prepare_sysroot_src.sh", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fbuild_sysroot%2Fprepare_sysroot_src.sh", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fbuild_sysroot%2Fprepare_sysroot_src.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fbuild_sysroot%2Fprepare_sysroot_src.sh?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -12,7 +12,7 @@ fi\n \n rm -rf $DST_DIR\n mkdir -p $DST_DIR/library\n-cp -r $SRC_DIR/library $DST_DIR/\n+cp -a $SRC_DIR/library $DST_DIR/\n \n pushd $DST_DIR\n echo \"[GIT] init\""}, {"sha": "5a69c862d016d616d967d413d42b598cea2d934f", "filename": "compiler/rustc_codegen_cranelift/clean_all.sh", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fclean_all.sh", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fclean_all.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fclean_all.sh?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -1,5 +1,5 @@\n #!/bin/bash --verbose\n set -e\n \n-rm -rf target/ build_sysroot/{sysroot/,sysroot_src/,target/} perf.data{,.old}\n+rm -rf target/ build/ build_sysroot/{sysroot_src/,target/} perf.data{,.old}\n rm -rf rand/ regex/ simple-raytracer/"}, {"sha": "f0a0a6ad42ef52af66cc35678e57cb2b415b783d", "filename": "compiler/rustc_codegen_cranelift/docs/env_vars.md", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fdocs%2Fenv_vars.md", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fdocs%2Fenv_vars.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fdocs%2Fenv_vars.md?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -9,7 +9,4 @@\n     object files when their content should have been changed by a change to cg_clif.</dd>\n     <dt>CG_CLIF_DISPLAY_CG_TIME</dt>\n     <dd>If \"1\", display the time it took to perform codegen for a crate</dd>\n-    <dt>CG_CLIF_FUNCTION_SECTIONS</dt>\n-    <dd>Use a single section for each function. This will often reduce the executable size at the\n-        cost of making linking significantly slower.</dd>\n </dl>"}, {"sha": "ce07fe83df18f2b09f663113aad431002e98e956", "filename": "compiler/rustc_codegen_cranelift/example/mini_core.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fexample%2Fmini_core.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fexample%2Fmini_core.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fexample%2Fmini_core.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -48,6 +48,7 @@ unsafe impl Copy for u8 {}\n unsafe impl Copy for u16 {}\n unsafe impl Copy for u32 {}\n unsafe impl Copy for u64 {}\n+unsafe impl Copy for u128 {}\n unsafe impl Copy for usize {}\n unsafe impl Copy for i8 {}\n unsafe impl Copy for i16 {}\n@@ -283,6 +284,15 @@ impl PartialEq for u64 {\n     }\n }\n \n+impl PartialEq for u128 {\n+    fn eq(&self, other: &u128) -> bool {\n+        (*self) == (*other)\n+    }\n+    fn ne(&self, other: &u128) -> bool {\n+        (*self) != (*other)\n+    }\n+}\n+\n impl PartialEq for usize {\n     fn eq(&self, other: &usize) -> bool {\n         (*self) == (*other)"}, {"sha": "4a8375afac3cef46815d38becae87267dcc7461c", "filename": "compiler/rustc_codegen_cranelift/example/mini_core_hello_world.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fexample%2Fmini_core_hello_world.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fexample%2Fmini_core_hello_world.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fexample%2Fmini_core_hello_world.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -287,6 +287,8 @@ fn main() {\n     assert_eq!(repeat[0], Some(42));\n     assert_eq!(repeat[1], Some(42));\n \n+    from_decimal_string();\n+\n     #[cfg(not(jit))]\n     test_tls();\n \n@@ -446,3 +448,23 @@ fn check_niche_behavior () {\n         intrinsics::abort();\n     }\n }\n+\n+fn from_decimal_string() {\n+    loop {\n+        let multiplier = 1;\n+\n+        take_multiplier_ref(&multiplier);\n+\n+        if multiplier == 1 {\n+            break;\n+        }\n+\n+        unreachable();\n+    }\n+}\n+\n+fn take_multiplier_ref(_multiplier: &u128) {}\n+\n+fn unreachable() -> ! {\n+    panic(\"unreachable\")\n+}"}, {"sha": "cb512a4aa335e65106967ed7470bd5b45949a0c5", "filename": "compiler/rustc_codegen_cranelift/example/std_example.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fexample%2Fstd_example.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fexample%2Fstd_example.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fexample%2Fstd_example.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -315,13 +315,13 @@ fn test_checked_mul() {\n     assert_eq!(1i8.checked_mul(-128i8), Some(-128i8));\n     assert_eq!((-128i8).checked_mul(-128i8), None);\n \n-    assert_eq!(1u64.checked_mul(u64::max_value()), Some(u64::max_value()));\n-    assert_eq!(u64::max_value().checked_mul(u64::max_value()), None);\n-    assert_eq!(1i64.checked_mul(i64::max_value()), Some(i64::max_value()));\n-    assert_eq!(i64::max_value().checked_mul(i64::max_value()), None);\n-    assert_eq!((-1i64).checked_mul(i64::min_value() + 1), Some(i64::max_value()));\n-    assert_eq!(1i64.checked_mul(i64::min_value()), Some(i64::min_value()));\n-    assert_eq!(i64::min_value().checked_mul(i64::min_value()), None);\n+    assert_eq!(1u64.checked_mul(u64::MAX), Some(u64::MAX));\n+    assert_eq!(u64::MAX.checked_mul(u64::MAX), None);\n+    assert_eq!(1i64.checked_mul(i64::MAX), Some(i64::MAX));\n+    assert_eq!(i64::MAX.checked_mul(i64::MAX), None);\n+    assert_eq!((-1i64).checked_mul(i64::MIN + 1), Some(i64::MAX));\n+    assert_eq!(1i64.checked_mul(i64::MIN), Some(i64::MIN));\n+    assert_eq!(i64::MIN.checked_mul(i64::MIN), None);\n }\n \n #[derive(PartialEq)]"}, {"sha": "0ca96be9ae731fdcecf8e10ade0c9f3130b6b8d6", "filename": "compiler/rustc_codegen_cranelift/rust-toolchain", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Frust-toolchain", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Frust-toolchain", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Frust-toolchain?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -1 +1 @@\n-nightly-2020-10-26\n+nightly-2020-10-31"}, {"sha": "e63daa40f354099a4b3fdbe3612f73dfb7b8ac70", "filename": "compiler/rustc_codegen_cranelift/scripts/cargo.sh", "status": "renamed", "additions": 4, "deletions": 10, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fscripts%2Fcargo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fscripts%2Fcargo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fscripts%2Fcargo.sh?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -1,19 +1,13 @@\n #!/bin/bash\n \n-if [ -z $CHANNEL ]; then\n-export CHANNEL='release'\n-fi\n-\n-pushd $(dirname \"$0\") >/dev/null\n-source scripts/config.sh\n+dir=$(dirname \"$0\")\n+source $dir/config.sh\n \n # read nightly compiler from rust-toolchain file\n-TOOLCHAIN=$(cat rust-toolchain)\n-\n-popd >/dev/null\n+TOOLCHAIN=$(cat $dir/rust-toolchain)\n \n cmd=$1\n-shift\n+shift || true\n \n if [[ \"$cmd\" = \"jit\" ]]; then\n cargo +${TOOLCHAIN} rustc $@ -- --jit", "previous_filename": "compiler/rustc_codegen_cranelift/cargo.sh"}, {"sha": "af181f4f724395dab2f756b25ef948ecbeb6a0fb", "filename": "compiler/rustc_codegen_cranelift/scripts/config.sh", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fscripts%2Fconfig.sh", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fscripts%2Fconfig.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fscripts%2Fconfig.sh?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -39,18 +39,19 @@ echo\n export RUSTC_WRAPPER=\n fi\n \n-export RUSTC=$(pwd)/\"target/\"$CHANNEL\"/cg_clif\"\n+dir=$(cd $(dirname \"$BASH_SOURCE\"); pwd)\n+\n+export RUSTC=$dir\"/cg_clif\"\n export RUSTFLAGS=$linker\n export RUSTDOCFLAGS=$linker' -Ztrim-diagnostic-paths=no -Cpanic=abort -Zpanic-abort-tests '\\\n-'-Zcodegen-backend='$(pwd)'/target/'$CHANNEL'/librustc_codegen_cranelift.'$dylib_ext' --sysroot '$(pwd)'/build_sysroot/sysroot'\n+'-Zcodegen-backend='$dir'/librustc_codegen_cranelift.'$dylib_ext' --sysroot '$dir'/sysroot'\n \n # FIXME remove once the atomic shim is gone\n if [[ `uname` == 'Darwin' ]]; then\n    export RUSTFLAGS=\"$RUSTFLAGS -Clink-arg=-undefined -Clink-arg=dynamic_lookup\"\n fi\n \n-export LD_LIBRARY_PATH=\"$(pwd)/target/out:$(pwd)/build_sysroot/sysroot/lib/rustlib/\"$TARGET_TRIPLE\"/lib:\\\n-$(pwd)/target/\"$CHANNEL\":$(rustc --print sysroot)/lib\"\n+export LD_LIBRARY_PATH=\"$dir:$(rustc --print sysroot)/lib:$dir/target/out:$dir/sysroot/lib/rustlib/\"$TARGET_TRIPLE\"/lib\"\n export DYLD_LIBRARY_PATH=$LD_LIBRARY_PATH\n \n export CG_CLIF_DISPLAY_CG_TIME=1"}, {"sha": "3327c10089d9b0847fe9fbdccf12c03f91aab412", "filename": "compiler/rustc_codegen_cranelift/scripts/filter_profile.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fscripts%2Ffilter_profile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fscripts%2Ffilter_profile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fscripts%2Ffilter_profile.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -1,9 +1,8 @@\n #!/bin/bash\n #![forbid(unsafe_code)]/* This line is ignored by bash\n # This block is ignored by rustc\n-CHANNEL=\"release\"\n pushd $(dirname \"$0\")/../\n-source scripts/config.sh\n+source build/config.sh\n popd\n PROFILE=$1 OUTPUT=$2 exec $RUSTC $RUSTFLAGS --jit $0\n #*/"}, {"sha": "541b3c6563bab74816241c2f94d33ec5fb164684", "filename": "compiler/rustc_codegen_cranelift/scripts/rustup.sh", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fscripts%2Frustup.sh", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fscripts%2Frustup.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fscripts%2Frustup.sh?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -26,6 +26,15 @@ case $1 in\n         git add rust-toolchain build_sysroot/Cargo.lock\n         git commit -m \"Rustup to $(rustc -V)\"\n         ;;\n+    \"push\")\n+\tcg_clif=$(pwd)\n+\tpushd ../rust\n+\tbranch=update_cg_clif-$(date +%Y-%m-%d)\n+\tgit checkout -b $branch\n+\tgit subtree pull --prefix=compiler/rustc_codegen_cranelift/ https://github.com/bjorn3/rustc_codegen_cranelift.git master\n+\tgit push -u my $branch\n+\tpopd\n+\t;;\n     *)\n         echo \"Unknown command '$1'\"\n         echo \"Usage: ./rustup.sh prepare|commit\""}, {"sha": "7f43f81a6cdcd4aa9f5a539d7c9b50c898f70dce", "filename": "compiler/rustc_codegen_cranelift/scripts/test_bootstrap.sh", "status": "added", "additions": 65, "deletions": 0, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fscripts%2Ftest_bootstrap.sh", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fscripts%2Ftest_bootstrap.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fscripts%2Ftest_bootstrap.sh?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -0,0 +1,65 @@\n+#!/bin/bash\n+set -e\n+\n+cd $(dirname \"$0\")/../\n+\n+./build.sh\n+source build/config.sh\n+\n+echo \"[TEST] Bootstrap of rustc\"\n+git clone https://github.com/rust-lang/rust.git || true\n+pushd rust\n+git fetch\n+git checkout -- .\n+git checkout $(rustc -V | cut -d' ' -f3 | tr -d '(')\n+\n+git apply - <<EOF\n+diff --git a/.gitmodules b/.gitmodules\n+index 984113151de..c1e9d960d56 100644\n+--- a/.gitmodules\n++++ b/.gitmodules\n+@@ -34,10 +34,6 @@\n+ [submodule \"src/doc/edition-guide\"]\n+ \tpath = src/doc/edition-guide\n+ \turl = https://github.com/rust-lang/edition-guide.git\n+-[submodule \"src/llvm-project\"]\n+-\tpath = src/llvm-project\n+-\turl = https://github.com/rust-lang/llvm-project.git\n+-\tbranch = rustc/11.0-2020-10-12\n+ [submodule \"src/doc/embedded-book\"]\n+ \tpath = src/doc/embedded-book\n+ \turl = https://github.com/rust-embedded/book.git\n+diff --git a/compiler/rustc_data_structures/Cargo.toml b/compiler/rustc_data_structures/Cargo.toml\n+index 23e689fcae7..5f077b765b6 100644\n+--- a/compiler/rustc_data_structures/Cargo.toml\n++++ b/compiler/rustc_data_structures/Cargo.toml\n+@@ -32,7 +32,6 @@ tempfile = \"3.0.5\"\n+\n+ [dependencies.parking_lot]\n+ version = \"0.11\"\n+-features = [\"nightly\"]\n+\n+ [target.'cfg(windows)'.dependencies]\n+ winapi = { version = \"0.3\", features = [\"fileapi\", \"psapi\"] }\n+EOF\n+\n+cat > config.toml <<EOF\n+[llvm]\n+ninja = false\n+\n+[build]\n+rustc = \"$(pwd)/../build/cg_clif\"\n+cargo = \"$(rustup which cargo)\"\n+full-bootstrap = true\n+local-rebuild = true\n+\n+[rust]\n+codegen-backends = [\"cranelift\"]\n+EOF\n+\n+rm -r compiler/rustc_codegen_cranelift/{Cargo.*,src}\n+cp ../Cargo.* compiler/rustc_codegen_cranelift/\n+cp -r ../src compiler/rustc_codegen_cranelift/src\n+\n+./x.py build --stage 1 library/std\n+popd"}, {"sha": "d941b73c81bcc01a4796a69ea0fff796e9a5e337", "filename": "compiler/rustc_codegen_cranelift/scripts/tests.sh", "status": "added", "additions": 123, "deletions": 0, "changes": 123, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fscripts%2Ftests.sh", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fscripts%2Ftests.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fscripts%2Ftests.sh?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -0,0 +1,123 @@\n+#!/bin/bash\n+\n+set -e\n+\n+source build/config.sh\n+export CG_CLIF_INCR_CACHE_DISABLED=1\n+MY_RUSTC=$RUSTC\" \"$RUSTFLAGS\" -L crate=target/out --out-dir target/out -Cdebuginfo=2\"\n+\n+function no_sysroot_tests() {\n+    echo \"[BUILD] mini_core\"\n+    $MY_RUSTC example/mini_core.rs --crate-name mini_core --crate-type lib,dylib --target $TARGET_TRIPLE\n+\n+    echo \"[BUILD] example\"\n+    $MY_RUSTC example/example.rs --crate-type lib --target $TARGET_TRIPLE\n+\n+    if [[ \"$JIT_SUPPORTED\" = \"1\" ]]; then\n+        echo \"[JIT] mini_core_hello_world\"\n+        CG_CLIF_JIT_ARGS=\"abc bcd\" $MY_RUSTC --jit example/mini_core_hello_world.rs --cfg jit --target $HOST_TRIPLE\n+    else\n+        echo \"[JIT] mini_core_hello_world (skipped)\"\n+    fi\n+\n+    echo \"[AOT] mini_core_hello_world\"\n+    $MY_RUSTC example/mini_core_hello_world.rs --crate-name mini_core_hello_world --crate-type bin -g --target $TARGET_TRIPLE\n+    $RUN_WRAPPER ./target/out/mini_core_hello_world abc bcd\n+    # (echo \"break set -n main\"; echo \"run\"; sleep 1; echo \"si -c 10\"; sleep 1; echo \"frame variable\") | lldb -- ./target/out/mini_core_hello_world abc bcd\n+\n+    echo \"[AOT] arbitrary_self_types_pointers_and_wrappers\"\n+    $MY_RUSTC example/arbitrary_self_types_pointers_and_wrappers.rs --crate-name arbitrary_self_types_pointers_and_wrappers --crate-type bin --target $TARGET_TRIPLE\n+    $RUN_WRAPPER ./target/out/arbitrary_self_types_pointers_and_wrappers\n+}\n+\n+function base_sysroot_tests() {\n+    echo \"[AOT] alloc_example\"\n+    $MY_RUSTC example/alloc_example.rs --crate-type bin --target $TARGET_TRIPLE\n+    $RUN_WRAPPER ./target/out/alloc_example\n+\n+    if [[ \"$JIT_SUPPORTED\" = \"1\" ]]; then\n+        echo \"[JIT] std_example\"\n+        $MY_RUSTC --jit example/std_example.rs --target $HOST_TRIPLE\n+    else\n+        echo \"[JIT] std_example (skipped)\"\n+    fi\n+\n+    echo \"[AOT] dst_field_align\"\n+    # FIXME Re-add -Zmir-opt-level=2 once rust-lang/rust#67529 is fixed.\n+    $MY_RUSTC example/dst-field-align.rs --crate-name dst_field_align --crate-type bin --target $TARGET_TRIPLE\n+    $RUN_WRAPPER ./target/out/dst_field_align || (echo $?; false)\n+\n+    echo \"[AOT] std_example\"\n+    $MY_RUSTC example/std_example.rs --crate-type bin --target $TARGET_TRIPLE\n+    $RUN_WRAPPER ./target/out/std_example arg\n+\n+    echo \"[AOT] subslice-patterns-const-eval\"\n+    $MY_RUSTC example/subslice-patterns-const-eval.rs --crate-type bin -Cpanic=abort --target $TARGET_TRIPLE\n+    $RUN_WRAPPER ./target/out/subslice-patterns-const-eval\n+\n+    echo \"[AOT] track-caller-attribute\"\n+    $MY_RUSTC example/track-caller-attribute.rs --crate-type bin -Cpanic=abort --target $TARGET_TRIPLE\n+    $RUN_WRAPPER ./target/out/track-caller-attribute\n+\n+    echo \"[AOT] mod_bench\"\n+    $MY_RUSTC example/mod_bench.rs --crate-type bin --target $TARGET_TRIPLE\n+    $RUN_WRAPPER ./target/out/mod_bench\n+\n+    pushd rand\n+    rm -r ./target || true\n+    ../build/cargo.sh test --workspace\n+    popd\n+}\n+\n+function extended_sysroot_tests() {\n+    pushd simple-raytracer\n+    if [[ \"$HOST_TRIPLE\" = \"$TARGET_TRIPLE\" ]]; then\n+        echo \"[BENCH COMPILE] ebobby/simple-raytracer\"\n+        hyperfine --runs ${RUN_RUNS:-10} --warmup 1 --prepare \"cargo clean\" \\\n+        \"RUSTC=rustc RUSTFLAGS='' cargo build\" \\\n+        \"../build/cargo.sh build\"\n+\n+        echo \"[BENCH RUN] ebobby/simple-raytracer\"\n+        cp ./target/debug/main ./raytracer_cg_clif\n+        hyperfine --runs ${RUN_RUNS:-10} ./raytracer_cg_llvm ./raytracer_cg_clif\n+    else\n+        echo \"[BENCH COMPILE] ebobby/simple-raytracer (skipped)\"\n+        echo \"[COMPILE] ebobby/simple-raytracer\"\n+        ../cargo.sh build\n+        echo \"[BENCH RUN] ebobby/simple-raytracer (skipped)\"\n+    fi\n+    popd\n+\n+    pushd build_sysroot/sysroot_src/library/core/tests\n+    echo \"[TEST] libcore\"\n+    rm -r ./target || true\n+    ../../../../../build/cargo.sh test\n+    popd\n+\n+    pushd regex\n+    echo \"[TEST] rust-lang/regex example shootout-regex-dna\"\n+    ../build/cargo.sh clean\n+    # Make sure `[codegen mono items] start` doesn't poison the diff\n+    ../build/cargo.sh build --example shootout-regex-dna\n+    cat examples/regexdna-input.txt | ../build/cargo.sh run --example shootout-regex-dna | grep -v \"Spawned thread\" > res.txt\n+    diff -u res.txt examples/regexdna-output.txt\n+\n+    echo \"[TEST] rust-lang/regex tests\"\n+    ../build/cargo.sh test --tests -- --exclude-should-panic --test-threads 1 -Zunstable-options -q\n+    popd\n+}\n+\n+case \"$1\" in\n+    \"no_sysroot\")\n+        no_sysroot_tests\n+        ;;\n+    \"base_sysroot\")\n+        base_sysroot_tests\n+        ;;\n+    \"extended_sysroot\")\n+        extended_sysroot_tests\n+        ;;\n+    *)\n+        echo \"unknown test suite\"\n+        ;;\n+esac"}, {"sha": "01073d26e832a98fd68cf6ac7463c6fe17abde98", "filename": "compiler/rustc_codegen_cranelift/src/abi/comments.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fabi%2Fcomments.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fabi%2Fcomments.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fabi%2Fcomments.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -11,9 +11,9 @@ use crate::abi::pass_mode::*;\n use crate::prelude::*;\n \n pub(super) fn add_args_header_comment(fx: &mut FunctionCx<'_, '_, impl Module>) {\n-    fx.add_global_comment(format!(\n-        \"kind  loc.idx   param    pass mode                            ty\"\n-    ));\n+    fx.add_global_comment(\n+        \"kind  loc.idx   param    pass mode                            ty\".to_string(),\n+    );\n }\n \n pub(super) fn add_arg_comment<'tcx>(\n@@ -56,9 +56,9 @@ pub(super) fn add_arg_comment<'tcx>(\n \n pub(super) fn add_locals_header_comment(fx: &mut FunctionCx<'_, '_, impl Module>) {\n     fx.add_global_comment(String::new());\n-    fx.add_global_comment(format!(\n-        \"kind  local ty                              size align (abi,pref)\"\n-    ));\n+    fx.add_global_comment(\n+        \"kind  local ty                              size align (abi,pref)\".to_string(),\n+    );\n }\n \n pub(super) fn add_local_place_comments<'tcx>("}, {"sha": "81091728692f3f4d21017fb04a977bcb7066e1ca", "filename": "compiler/rustc_codegen_cranelift/src/abi/mod.rs", "status": "modified", "additions": 30, "deletions": 33, "changes": 63, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fabi%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fabi%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fabi%2Fmod.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -300,7 +300,7 @@ impl<'tcx, M: Module> FunctionCx<'_, 'tcx, M> {\n         return_ty: Ty<'tcx>,\n     ) -> CValue<'tcx> {\n         let (input_tys, args): (Vec<_>, Vec<_>) = args\n-            .into_iter()\n+            .iter()\n             .map(|arg| {\n                 (\n                     self.clif_type(arg.layout().ty).unwrap(),\n@@ -421,34 +421,31 @@ pub(crate) fn codegen_fn_prelude<'tcx>(\n \n         // While this is normally an optimization to prevent an unnecessary copy when an argument is\n         // not mutated by the current function, this is necessary to support unsized arguments.\n-        match arg_kind {\n-            ArgKind::Normal(Some(val)) => {\n-                if let Some((addr, meta)) = val.try_to_ptr() {\n-                    let local_decl = &fx.mir.local_decls[local];\n-                    //                       v this ! is important\n-                    let internally_mutable = !val.layout().ty.is_freeze(\n-                        fx.tcx.at(local_decl.source_info.span),\n-                        ParamEnv::reveal_all(),\n-                    );\n-                    if local_decl.mutability == mir::Mutability::Not && !internally_mutable {\n-                        // We wont mutate this argument, so it is fine to borrow the backing storage\n-                        // of this argument, to prevent a copy.\n-\n-                        let place = if let Some(meta) = meta {\n-                            CPlace::for_ptr_with_extra(addr, meta, val.layout())\n-                        } else {\n-                            CPlace::for_ptr(addr, val.layout())\n-                        };\n-\n-                        #[cfg(debug_assertions)]\n-                        self::comments::add_local_place_comments(fx, place, local);\n-\n-                        assert_eq!(fx.local_map.push(place), local);\n-                        continue;\n-                    }\n+        if let ArgKind::Normal(Some(val)) = arg_kind {\n+            if let Some((addr, meta)) = val.try_to_ptr() {\n+                let local_decl = &fx.mir.local_decls[local];\n+                //                       v this ! is important\n+                let internally_mutable = !val.layout().ty.is_freeze(\n+                    fx.tcx.at(local_decl.source_info.span),\n+                    ParamEnv::reveal_all(),\n+                );\n+                if local_decl.mutability == mir::Mutability::Not && !internally_mutable {\n+                    // We wont mutate this argument, so it is fine to borrow the backing storage\n+                    // of this argument, to prevent a copy.\n+\n+                    let place = if let Some(meta) = meta {\n+                        CPlace::for_ptr_with_extra(addr, meta, val.layout())\n+                    } else {\n+                        CPlace::for_ptr(addr, val.layout())\n+                    };\n+\n+                    #[cfg(debug_assertions)]\n+                    self::comments::add_local_place_comments(fx, place, local);\n+\n+                    assert_eq!(fx.local_map.push(place), local);\n+                    continue;\n                 }\n             }\n-            _ => {}\n         }\n \n         let place = make_local_place(fx, local, layout, is_ssa);\n@@ -500,7 +497,7 @@ pub(crate) fn codegen_terminator_call<'tcx>(\n         .tcx\n         .normalize_erasing_late_bound_regions(ParamEnv::reveal_all(), &fn_ty.fn_sig(fx.tcx));\n \n-    let destination = destination.map(|(place, bb)| (trans_place(fx, place), bb));\n+    let destination = destination.map(|(place, bb)| (codegen_place(fx, place), bb));\n \n     // Handle special calls like instrinsics and empty drop glue.\n     let instance = if let ty::FnDef(def_id, substs) = *fn_ty.kind() {\n@@ -553,8 +550,8 @@ pub(crate) fn codegen_terminator_call<'tcx>(\n     // Unpack arguments tuple for closures\n     let args = if fn_sig.abi == Abi::RustCall {\n         assert_eq!(args.len(), 2, \"rust-call abi requires two arguments\");\n-        let self_arg = trans_operand(fx, &args[0]);\n-        let pack_arg = trans_operand(fx, &args[1]);\n+        let self_arg = codegen_operand(fx, &args[0]);\n+        let pack_arg = codegen_operand(fx, &args[1]);\n \n         let tupled_arguments = match pack_arg.layout().ty.kind() {\n             ty::Tuple(ref tupled_arguments) => tupled_arguments,\n@@ -568,8 +565,8 @@ pub(crate) fn codegen_terminator_call<'tcx>(\n         }\n         args\n     } else {\n-        args.into_iter()\n-            .map(|arg| trans_operand(fx, arg))\n+        args.iter()\n+            .map(|arg| codegen_operand(fx, arg))\n             .collect::<Vec<_>>()\n     };\n \n@@ -613,7 +610,7 @@ pub(crate) fn codegen_terminator_call<'tcx>(\n                 let nop_inst = fx.bcx.ins().nop();\n                 fx.add_comment(nop_inst, \"indirect call\");\n             }\n-            let func = trans_operand(fx, func).load_scalar(fx);\n+            let func = codegen_operand(fx, func).load_scalar(fx);\n             (\n                 Some(func),\n                 args.get(0)"}, {"sha": "6c5916550ff639f52a99c14bd8ce34c0321f4da0", "filename": "compiler/rustc_codegen_cranelift/src/allocator.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fallocator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fallocator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fallocator.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -123,15 +123,15 @@ fn codegen_inner(\n         .unwrap();\n \n     let mut ctx = Context::new();\n-    ctx.func = Function::with_name_signature(ExternalName::user(0, 0), sig.clone());\n+    ctx.func = Function::with_name_signature(ExternalName::user(0, 0), sig);\n     {\n         let mut func_ctx = FunctionBuilderContext::new();\n         let mut bcx = FunctionBuilder::new(&mut ctx.func, &mut func_ctx);\n \n         let block = bcx.create_block();\n         bcx.switch_to_block(block);\n         let args = (&[usize_ty, usize_ty])\n-            .into_iter()\n+            .iter()\n             .map(|&ty| bcx.append_block_param(block, ty))\n             .collect::<Vec<Value>>();\n "}, {"sha": "9a970efbcfd0b6c653e936a7de28aed4426d129a", "filename": "compiler/rustc_codegen_cranelift/src/archive.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Farchive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Farchive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Farchive.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -132,7 +132,7 @@ impl<'a> ArchiveBuilder<'a> for ArArchiveBuilder<'a> {\n             }\n \n             // ok, don't skip this\n-            return false;\n+            false\n         })\n     }\n "}, {"sha": "2f0157c257b98cb74ad02b18ab1e02b2ed5d629a", "filename": "compiler/rustc_codegen_cranelift/src/atomic_shim.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fatomic_shim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fatomic_shim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fatomic_shim.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -7,7 +7,7 @@ use crate::prelude::*;\n \n #[cfg(all(feature = \"jit\", unix))]\n #[no_mangle]\n-pub static mut __cg_clif_global_atomic_mutex: libc::pthread_mutex_t =\n+static mut __cg_clif_global_atomic_mutex: libc::pthread_mutex_t =\n     libc::PTHREAD_MUTEX_INITIALIZER;\n \n pub(crate) fn init_global_lock("}, {"sha": "9e32259716f5105508d59d8bc0edbc01a5b30f7c", "filename": "compiler/rustc_codegen_cranelift/src/backend.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbackend.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbackend.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbackend.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -73,7 +73,7 @@ impl WriteDebugInfo for ObjectProduct {\n         // FIXME use SHT_X86_64_UNWIND for .eh_frame\n         let section_id = self.object.add_section(\n             segment,\n-            name.clone(),\n+            name,\n             if id == SectionId::EhFrame {\n                 SectionKind::ReadOnlyData\n             } else {\n@@ -198,9 +198,9 @@ pub(crate) fn make_module(sess: &Session, name: String) -> ObjectModule {\n         cranelift_module::default_libcall_names(),\n     )\n     .unwrap();\n-    if std::env::var(\"CG_CLIF_FUNCTION_SECTIONS\").is_ok() {\n-        builder.per_function_section(true);\n-    }\n-    let module = ObjectModule::new(builder);\n-    module\n+    // Unlike cg_llvm, cg_clif defaults to disabling -Zfunction-sections. For cg_llvm binary size\n+    // is important, while cg_clif cares more about compilation times. Enabling -Zfunction-sections\n+    // can easily double the amount of time necessary to perform linking.\n+    builder.per_function_section(sess.opts.debugging_opts.function_sections.unwrap_or(false));\n+    ObjectModule::new(builder)\n }"}, {"sha": "5474e5960f100a03f9626a8ff3e504db380adf41", "filename": "compiler/rustc_codegen_cranelift/src/base.rs", "status": "modified", "additions": 42, "deletions": 42, "changes": 84, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbase.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -5,7 +5,7 @@ use rustc_middle::ty::adjustment::PointerCast;\n \n use crate::prelude::*;\n \n-pub(crate) fn trans_fn<'tcx>(\n+pub(crate) fn codegen_fn<'tcx>(\n     cx: &mut crate::CodegenCx<'tcx, impl Module>,\n     instance: Instance<'tcx>,\n     linkage: Linkage,\n@@ -202,7 +202,7 @@ fn codegen_fn_content(fx: &mut FunctionCx<'_, '_, impl Module>) {\n         fx.bcx.ins().nop();\n         for stmt in &bb_data.statements {\n             fx.set_debug_loc(stmt.source_info);\n-            trans_stmt(fx, block, stmt);\n+            codegen_stmt(fx, block, stmt);\n         }\n \n         #[cfg(debug_assertions)]\n@@ -258,7 +258,7 @@ fn codegen_fn_content(fx: &mut FunctionCx<'_, '_, impl Module>) {\n                         continue;\n                     }\n                 }\n-                let cond = trans_operand(fx, cond).load_scalar(fx);\n+                let cond = codegen_operand(fx, cond).load_scalar(fx);\n \n                 let target = fx.get_block(*target);\n                 let failure = fx.bcx.create_block();\n@@ -276,8 +276,8 @@ fn codegen_fn_content(fx: &mut FunctionCx<'_, '_, impl Module>) {\n \n                 match msg {\n                     AssertKind::BoundsCheck { ref len, ref index } => {\n-                        let len = trans_operand(fx, len).load_scalar(fx);\n-                        let index = trans_operand(fx, index).load_scalar(fx);\n+                        let len = codegen_operand(fx, len).load_scalar(fx);\n+                        let index = codegen_operand(fx, index).load_scalar(fx);\n                         let location = fx\n                             .get_caller_location(bb_data.terminator().source_info.span)\n                             .load_scalar(fx);\n@@ -301,7 +301,7 @@ fn codegen_fn_content(fx: &mut FunctionCx<'_, '_, impl Module>) {\n                 switch_ty,\n                 targets,\n             } => {\n-                let discr = trans_operand(fx, discr).load_scalar(fx);\n+                let discr = codegen_operand(fx, discr).load_scalar(fx);\n \n                 if switch_ty.kind() == fx.tcx.types.bool.kind() {\n                     assert_eq!(targets.iter().count(), 1);\n@@ -396,14 +396,14 @@ fn codegen_fn_content(fx: &mut FunctionCx<'_, '_, impl Module>) {\n             | TerminatorKind::FalseUnwind { .. }\n             | TerminatorKind::DropAndReplace { .. }\n             | TerminatorKind::GeneratorDrop => {\n-                bug!(\"shouldn't exist at trans {:?}\", bb_data.terminator());\n+                bug!(\"shouldn't exist at codegen {:?}\", bb_data.terminator());\n             }\n             TerminatorKind::Drop {\n                 place,\n                 target,\n                 unwind: _,\n             } => {\n-                let drop_place = trans_place(fx, *place);\n+                let drop_place = codegen_place(fx, *place);\n                 crate::abi::codegen_drop(fx, bb_data.terminator().source_info.span, drop_place);\n \n                 let target_block = fx.get_block(*target);\n@@ -416,7 +416,7 @@ fn codegen_fn_content(fx: &mut FunctionCx<'_, '_, impl Module>) {\n     fx.bcx.finalize();\n }\n \n-fn trans_stmt<'tcx>(\n+fn codegen_stmt<'tcx>(\n     fx: &mut FunctionCx<'_, 'tcx, impl Module>,\n     #[allow(unused_variables)] cur_block: Block,\n     stmt: &Statement<'tcx>,\n@@ -439,19 +439,19 @@ fn trans_stmt<'tcx>(\n             place,\n             variant_index,\n         } => {\n-            let place = trans_place(fx, **place);\n+            let place = codegen_place(fx, **place);\n             crate::discriminant::codegen_set_discriminant(fx, place, *variant_index);\n         }\n         StatementKind::Assign(to_place_and_rval) => {\n-            let lval = trans_place(fx, to_place_and_rval.0);\n+            let lval = codegen_place(fx, to_place_and_rval.0);\n             let dest_layout = lval.layout();\n             match &to_place_and_rval.1 {\n                 Rvalue::Use(operand) => {\n-                    let val = trans_operand(fx, operand);\n+                    let val = codegen_operand(fx, operand);\n                     lval.write_cvalue(fx, val);\n                 }\n                 Rvalue::Ref(_, _, place) | Rvalue::AddressOf(_, place) => {\n-                    let place = trans_place(fx, *place);\n+                    let place = codegen_place(fx, *place);\n                     let ref_ = place.place_ref(fx, lval.layout());\n                     lval.write_cvalue(fx, ref_);\n                 }\n@@ -460,29 +460,29 @@ fn trans_stmt<'tcx>(\n                     lval.write_cvalue(fx, val);\n                 }\n                 Rvalue::BinaryOp(bin_op, lhs, rhs) => {\n-                    let lhs = trans_operand(fx, lhs);\n-                    let rhs = trans_operand(fx, rhs);\n+                    let lhs = codegen_operand(fx, lhs);\n+                    let rhs = codegen_operand(fx, rhs);\n \n                     let res = crate::num::codegen_binop(fx, *bin_op, lhs, rhs);\n                     lval.write_cvalue(fx, res);\n                 }\n                 Rvalue::CheckedBinaryOp(bin_op, lhs, rhs) => {\n-                    let lhs = trans_operand(fx, lhs);\n-                    let rhs = trans_operand(fx, rhs);\n+                    let lhs = codegen_operand(fx, lhs);\n+                    let rhs = codegen_operand(fx, rhs);\n \n                     let res = if !fx.tcx.sess.overflow_checks() {\n                         let val =\n-                            crate::num::trans_int_binop(fx, *bin_op, lhs, rhs).load_scalar(fx);\n+                            crate::num::codegen_int_binop(fx, *bin_op, lhs, rhs).load_scalar(fx);\n                         let is_overflow = fx.bcx.ins().iconst(types::I8, 0);\n                         CValue::by_val_pair(val, is_overflow, lval.layout())\n                     } else {\n-                        crate::num::trans_checked_int_binop(fx, *bin_op, lhs, rhs)\n+                        crate::num::codegen_checked_int_binop(fx, *bin_op, lhs, rhs)\n                     };\n \n                     lval.write_cvalue(fx, res);\n                 }\n                 Rvalue::UnaryOp(un_op, operand) => {\n-                    let operand = trans_operand(fx, operand);\n+                    let operand = codegen_operand(fx, operand);\n                     let layout = operand.layout();\n                     let val = operand.load_scalar(fx);\n                     let res = match un_op {\n@@ -500,7 +500,7 @@ fn trans_stmt<'tcx>(\n                             ty::Int(IntTy::I128) => {\n                                 // FIXME remove this case once ineg.i128 works\n                                 let zero = CValue::const_val(fx, layout, 0);\n-                                crate::num::trans_int_binop(fx, BinOp::Sub, zero, operand)\n+                                crate::num::codegen_int_binop(fx, BinOp::Sub, zero, operand)\n                             }\n                             ty::Int(_) => CValue::by_val(fx.bcx.ins().ineg(val), layout),\n                             ty::Float(_) => CValue::by_val(fx.bcx.ins().fneg(val), layout),\n@@ -534,11 +534,11 @@ fn trans_stmt<'tcx>(\n                 | Rvalue::Cast(CastKind::Pointer(PointerCast::MutToConstPointer), operand, to_ty)\n                 | Rvalue::Cast(CastKind::Pointer(PointerCast::ArrayToPointer), operand, to_ty) => {\n                     let to_layout = fx.layout_of(fx.monomorphize(to_ty));\n-                    let operand = trans_operand(fx, operand);\n+                    let operand = codegen_operand(fx, operand);\n                     lval.write_cvalue(fx, operand.cast_pointer_to(to_layout));\n                 }\n                 Rvalue::Cast(CastKind::Misc, operand, to_ty) => {\n-                    let operand = trans_operand(fx, operand);\n+                    let operand = codegen_operand(fx, operand);\n                     let from_ty = operand.layout().ty;\n                     let to_ty = fx.monomorphize(to_ty);\n \n@@ -639,7 +639,7 @@ fn trans_stmt<'tcx>(\n                     operand,\n                     _to_ty,\n                 ) => {\n-                    let operand = trans_operand(fx, operand);\n+                    let operand = codegen_operand(fx, operand);\n                     match *operand.layout().ty.kind() {\n                         ty::Closure(def_id, substs) => {\n                             let instance = Instance::resolve_closure(\n@@ -657,18 +657,18 @@ fn trans_stmt<'tcx>(\n                     }\n                 }\n                 Rvalue::Cast(CastKind::Pointer(PointerCast::Unsize), operand, _to_ty) => {\n-                    let operand = trans_operand(fx, operand);\n+                    let operand = codegen_operand(fx, operand);\n                     operand.unsize_value(fx, lval);\n                 }\n                 Rvalue::Discriminant(place) => {\n-                    let place = trans_place(fx, *place);\n+                    let place = codegen_place(fx, *place);\n                     let value = place.to_cvalue(fx);\n                     let discr =\n                         crate::discriminant::codegen_get_discriminant(fx, value, dest_layout);\n                     lval.write_cvalue(fx, discr);\n                 }\n                 Rvalue::Repeat(operand, times) => {\n-                    let operand = trans_operand(fx, operand);\n+                    let operand = codegen_operand(fx, operand);\n                     let times = fx\n                         .monomorphize(times)\n                         .eval(fx.tcx, ParamEnv::reveal_all())\n@@ -706,7 +706,7 @@ fn trans_stmt<'tcx>(\n                     }\n                 }\n                 Rvalue::Len(place) => {\n-                    let place = trans_place(fx, *place);\n+                    let place = codegen_place(fx, *place);\n                     let usize_layout = fx.layout_of(fx.tcx.types.usize);\n                     let len = codegen_array_len(fx, place);\n                     lval.write_cvalue(fx, CValue::by_val(len, usize_layout));\n@@ -753,14 +753,14 @@ fn trans_stmt<'tcx>(\n                 }\n                 Rvalue::Aggregate(kind, operands) => match **kind {\n                     AggregateKind::Array(_ty) => {\n-                        for (i, operand) in operands.into_iter().enumerate() {\n-                            let operand = trans_operand(fx, operand);\n+                        for (i, operand) in operands.iter().enumerate() {\n+                            let operand = codegen_operand(fx, operand);\n                             let index = fx.bcx.ins().iconst(fx.pointer_type, i as i64);\n                             let to = lval.place_index(fx, index);\n                             to.write_cvalue(fx, operand);\n                         }\n                     }\n-                    _ => unreachable!(\"shouldn't exist at trans {:?}\", to_place_and_rval.1),\n+                    _ => unreachable!(\"shouldn't exist at codegen {:?}\", to_place_and_rval.1),\n                 },\n             }\n         }\n@@ -813,20 +813,20 @@ fn trans_stmt<'tcx>(\n                     assert!(!alignstack);\n \n                     assert_eq!(inputs.len(), 2);\n-                    let leaf = trans_operand(fx, &inputs[0].1).load_scalar(fx); // %eax\n-                    let subleaf = trans_operand(fx, &inputs[1].1).load_scalar(fx); // %ecx\n+                    let leaf = codegen_operand(fx, &inputs[0].1).load_scalar(fx); // %eax\n+                    let subleaf = codegen_operand(fx, &inputs[1].1).load_scalar(fx); // %ecx\n \n                     let (eax, ebx, ecx, edx) =\n                         crate::intrinsics::codegen_cpuid_call(fx, leaf, subleaf);\n \n                     assert_eq!(outputs.len(), 4);\n-                    trans_place(fx, outputs[0])\n+                    codegen_place(fx, outputs[0])\n                         .write_cvalue(fx, CValue::by_val(eax, fx.layout_of(fx.tcx.types.u32)));\n-                    trans_place(fx, outputs[1])\n+                    codegen_place(fx, outputs[1])\n                         .write_cvalue(fx, CValue::by_val(ebx, fx.layout_of(fx.tcx.types.u32)));\n-                    trans_place(fx, outputs[2])\n+                    codegen_place(fx, outputs[2])\n                         .write_cvalue(fx, CValue::by_val(ecx, fx.layout_of(fx.tcx.types.u32)));\n-                    trans_place(fx, outputs[3])\n+                    codegen_place(fx, outputs[3])\n                         .write_cvalue(fx, CValue::by_val(edx, fx.layout_of(fx.tcx.types.u32)));\n                 }\n                 \"xgetbv\" => {\n@@ -892,7 +892,7 @@ fn codegen_array_len<'tcx>(\n     }\n }\n \n-pub(crate) fn trans_place<'tcx>(\n+pub(crate) fn codegen_place<'tcx>(\n     fx: &mut FunctionCx<'_, 'tcx, impl Module>,\n     place: Place<'tcx>,\n ) -> CPlace<'tcx> {\n@@ -938,7 +938,7 @@ pub(crate) fn trans_place<'tcx>(\n                         let ptr = cplace.to_ptr();\n                         cplace = CPlace::for_ptr(\n                             ptr.offset_i64(fx, elem_layout.size.bytes() as i64 * (from as i64)),\n-                            fx.layout_of(fx.tcx.mk_array(elem_ty, u64::from(to) - u64::from(from))),\n+                            fx.layout_of(fx.tcx.mk_array(elem_ty, to - from)),\n                         );\n                     }\n                     ty::Slice(elem_ty) => {\n@@ -964,16 +964,16 @@ pub(crate) fn trans_place<'tcx>(\n     cplace\n }\n \n-pub(crate) fn trans_operand<'tcx>(\n+pub(crate) fn codegen_operand<'tcx>(\n     fx: &mut FunctionCx<'_, 'tcx, impl Module>,\n     operand: &Operand<'tcx>,\n ) -> CValue<'tcx> {\n     match operand {\n         Operand::Move(place) | Operand::Copy(place) => {\n-            let cplace = trans_place(fx, *place);\n+            let cplace = codegen_place(fx, *place);\n             cplace.to_cvalue(fx)\n         }\n-        Operand::Constant(const_) => crate::constant::trans_constant(fx, const_),\n+        Operand::Constant(const_) => crate::constant::codegen_constant(fx, const_),\n     }\n }\n "}, {"sha": "71ef4d2267368467d97492a6e1919298a3762ae8", "filename": "compiler/rustc_codegen_cranelift/src/bin/cg_clif.rs", "status": "modified", "additions": 7, "deletions": 13, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbin%2Fcg_clif.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbin%2Fcg_clif.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbin%2Fcg_clif.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -24,22 +24,16 @@ impl rustc_driver::Callbacks for CraneliftPassesCallbacks {\n         self.time_passes = config.opts.prints.is_empty()\n             && (config.opts.debugging_opts.time_passes || config.opts.debugging_opts.time);\n \n-        // FIXME workaround for an ICE\n-        config.opts.debugging_opts.trim_diagnostic_paths = false;\n-\n         config.opts.cg.panic = Some(PanicStrategy::Abort);\n         config.opts.debugging_opts.panic_abort_tests = true;\n         config.opts.maybe_sysroot = Some(\n-            std::env::current_exe()\n-                .unwrap()\n-                .parent()\n-                .unwrap()\n-                .parent()\n-                .unwrap()\n-                .parent()\n-                .unwrap()\n-                .join(\"build_sysroot\")\n-                .join(\"sysroot\"),\n+            config.opts.maybe_sysroot.clone().unwrap_or(\n+                std::env::current_exe()\n+                    .unwrap()\n+                    .parent()\n+                    .unwrap()\n+                    .join(\"sysroot\"),\n+            ),\n         );\n     }\n }"}, {"sha": "165d33dcfb50919a625fd0d60cdf51052a82ca1f", "filename": "compiler/rustc_codegen_cranelift/src/bin/cg_clif_build_sysroot.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbin%2Fcg_clif_build_sysroot.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbin%2Fcg_clif_build_sysroot.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbin%2Fcg_clif_build_sysroot.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -44,9 +44,6 @@ impl rustc_driver::Callbacks for CraneliftPassesCallbacks {\n             return;\n         }\n \n-        // FIXME workaround for an ICE\n-        config.opts.debugging_opts.trim_diagnostic_paths = false;\n-\n         config.opts.cg.panic = Some(PanicStrategy::Abort);\n         config.opts.debugging_opts.panic_abort_tests = true;\n         config.opts.maybe_sysroot = Some("}, {"sha": "57204de1135be435c524b2fbbb3ce69d608da6ff", "filename": "compiler/rustc_codegen_cranelift/src/cast.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fcast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fcast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fcast.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -181,12 +181,10 @@ pub(crate) fn clif_int_or_float_cast(\n                 fx.bcx.ins().select(has_overflow, max_val, val)\n             };\n             fx.bcx.ins().ireduce(to_ty, val)\n+        } else if to_signed {\n+            fx.bcx.ins().fcvt_to_sint_sat(to_ty, from)\n         } else {\n-            if to_signed {\n-                fx.bcx.ins().fcvt_to_sint_sat(to_ty, from)\n-            } else {\n-                fx.bcx.ins().fcvt_to_uint_sat(to_ty, from)\n-            }\n+            fx.bcx.ins().fcvt_to_uint_sat(to_ty, from)\n         }\n     } else if from_ty.is_float() && to_ty.is_float() {\n         // float -> float"}, {"sha": "d6a38bdafc9ba36c413b4a302af57884d1ad9a60", "filename": "compiler/rustc_codegen_cranelift/src/codegen_i128.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fcodegen_i128.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fcodegen_i128.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fcodegen_i128.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -21,9 +21,9 @@ pub(crate) fn maybe_codegen<'tcx>(\n     match bin_op {\n         BinOp::BitAnd | BinOp::BitOr | BinOp::BitXor => {\n             assert!(!checked);\n-            return None;\n+            None\n         }\n-        BinOp::Add | BinOp::Sub if !checked => return None,\n+        BinOp::Add | BinOp::Sub if !checked => None,\n         BinOp::Add => {\n             let out_ty = fx.tcx.mk_tup([lhs.layout().ty, fx.tcx.types.bool].iter());\n             return Some(if is_signed {\n@@ -57,7 +57,7 @@ pub(crate) fn maybe_codegen<'tcx>(\n                 };\n                 fx.easy_call(\"__multi3\", &[lhs, rhs], val_ty)\n             };\n-            return Some(res);\n+            Some(res)\n         }\n         BinOp::Div => {\n             assert!(!checked);\n@@ -77,7 +77,7 @@ pub(crate) fn maybe_codegen<'tcx>(\n         }\n         BinOp::Lt | BinOp::Le | BinOp::Eq | BinOp::Ge | BinOp::Gt | BinOp::Ne => {\n             assert!(!checked);\n-            return None;\n+            None\n         }\n         BinOp::Shl | BinOp::Shr => {\n             let is_overflow = if checked {"}, {"sha": "eda77bf19d3547f4b3e18b5b03d81d478ab6b412", "filename": "compiler/rustc_codegen_cranelift/src/common.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fcommon.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -406,7 +406,7 @@ impl<'tcx, M: Module> FunctionCx<'_, 'tcx, M> {\n             caller.line as u32,\n             caller.col_display as u32 + 1,\n         ));\n-        crate::constant::trans_const_value(self, const_loc, self.tcx.caller_location_ty())\n+        crate::constant::codegen_const_value(self, const_loc, self.tcx.caller_location_ty())\n     }\n \n     pub(crate) fn triple(&self) -> &target_lexicon::Triple {"}, {"sha": "ce1d5ed2e61780686600c738a02109c3949980a1", "filename": "compiler/rustc_codegen_cranelift/src/constant.rs", "status": "modified", "additions": 12, "deletions": 14, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fconstant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fconstant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fconstant.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -106,7 +106,7 @@ fn codegen_static_ref<'tcx>(\n     CPlace::for_ptr(crate::pointer::Pointer::new(global_ptr), layout)\n }\n \n-pub(crate) fn trans_constant<'tcx>(\n+pub(crate) fn codegen_constant<'tcx>(\n     fx: &mut FunctionCx<'_, 'tcx, impl Module>,\n     constant: &Constant<'tcx>,\n ) -> CValue<'tcx> {\n@@ -151,10 +151,10 @@ pub(crate) fn trans_constant<'tcx>(\n         | ConstKind::Error(_) => unreachable!(\"{:?}\", const_),\n     };\n \n-    trans_const_value(fx, const_val, const_.ty)\n+    codegen_const_value(fx, const_val, const_.ty)\n }\n \n-pub(crate) fn trans_const_value<'tcx>(\n+pub(crate) fn codegen_const_value<'tcx>(\n     fx: &mut FunctionCx<'_, 'tcx, impl Module>,\n     const_val: ConstValue<'tcx>,\n     ty: Ty<'tcx>,\n@@ -164,7 +164,7 @@ pub(crate) fn trans_const_value<'tcx>(\n \n     if layout.is_zst() {\n         return CValue::by_ref(\n-            crate::Pointer::const_addr(fx, i64::try_from(layout.align.pref.bytes()).unwrap()),\n+            crate::Pointer::dangling(layout.align.pref),\n             layout,\n         );\n     }\n@@ -188,7 +188,7 @@ pub(crate) fn trans_const_value<'tcx>(\n             match x {\n                 Scalar::Raw { data, size } => {\n                     assert_eq!(u64::from(size), layout.size.bytes());\n-                    return CValue::const_val(fx, layout, data);\n+                    CValue::const_val(fx, layout, data)\n                 }\n                 Scalar::Ptr(ptr) => {\n                     let alloc_kind = fx.tcx.get_global_alloc(ptr.alloc_id);\n@@ -232,7 +232,7 @@ pub(crate) fn trans_const_value<'tcx>(\n                     } else {\n                         base_addr\n                     };\n-                    return CValue::by_val(val, layout);\n+                    CValue::by_val(val, layout)\n                 }\n             }\n         }\n@@ -276,7 +276,7 @@ fn data_id_for_alloc_id(\n ) -> DataId {\n     module\n         .declare_data(\n-            &format!(\"__alloc_{:x}\", alloc_id.0),\n+            &format!(\".L__alloc_{:x}\", alloc_id.0),\n             Linkage::Local,\n             mutability == rustc_hir::Mutability::Mut,\n             false,\n@@ -293,14 +293,12 @@ fn data_id_for_static(\n     let rlinkage = tcx.codegen_fn_attrs(def_id).linkage;\n     let linkage = if definition {\n         crate::linkage::get_static_linkage(tcx, def_id)\n+    } else if rlinkage == Some(rustc_middle::mir::mono::Linkage::ExternalWeak)\n+        || rlinkage == Some(rustc_middle::mir::mono::Linkage::WeakAny)\n+    {\n+        Linkage::Preemptible\n     } else {\n-        if rlinkage == Some(rustc_middle::mir::mono::Linkage::ExternalWeak)\n-            || rlinkage == Some(rustc_middle::mir::mono::Linkage::WeakAny)\n-        {\n-            Linkage::Preemptible\n-        } else {\n-            Linkage::Import\n-        }\n+        Linkage::Import\n     };\n \n     let instance = Instance::mono(tcx, def_id).polymorphize(tcx);"}, {"sha": "f6f795e45615c9d39c898f89e1eac52b68a3fcd9", "filename": "compiler/rustc_codegen_cranelift/src/debuginfo/emit.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdebuginfo%2Femit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdebuginfo%2Femit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdebuginfo%2Femit.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -195,9 +195,7 @@ impl Writer for WriterRelocate {\n                     });\n                     self.write_udata(0, size)\n                 }\n-                _ => {\n-                    return Err(gimli::write::Error::UnsupportedPointerEncoding(eh_pe));\n-                }\n+                _ => Err(gimli::write::Error::UnsupportedPointerEncoding(eh_pe)),\n             },\n         }\n     }"}, {"sha": "d226755d85de0eb631ce6f5978dd5251c74c5434", "filename": "compiler/rustc_codegen_cranelift/src/debuginfo/line_info.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdebuginfo%2Fline_info.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdebuginfo%2Fline_info.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdebuginfo%2Fline_info.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -49,7 +49,7 @@ fn osstr_as_utf8_bytes(path: &OsStr) -> &[u8] {\n \n pub(crate) const MD5_LEN: usize = 16;\n \n-pub fn make_file_info(hash: SourceFileHash) -> Option<FileInfo> {\n+pub(crate) fn make_file_info(hash: SourceFileHash) -> Option<FileInfo> {\n     if hash.kind == SourceFileHashAlgorithm::Md5 {\n         let mut buf = [0u8; MD5_LEN];\n         buf.copy_from_slice(hash.hash_bytes());\n@@ -190,7 +190,7 @@ impl<'tcx> DebugContext<'tcx> {\n             if current_file_changed {\n                 let file_id = line_program_add_file(line_program, line_strings, &file);\n                 line_program.row().file = file_id;\n-                last_file = Some(file.clone());\n+                last_file = Some(file);\n             }\n \n             line_program.row().line = line;"}, {"sha": "68138404c2436819efc9ca440681f85db1d7a1c6", "filename": "compiler/rustc_codegen_cranelift/src/debuginfo/unwind.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdebuginfo%2Funwind.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdebuginfo%2Funwind.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdebuginfo%2Funwind.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -55,6 +55,7 @@ impl<'tcx> UnwindContext<'tcx> {\n             UnwindInfo::WindowsX64(_) => {\n                 // FIXME implement this\n             }\n+            unwind_info => unimplemented!(\"{:?}\", unwind_info),\n         }\n     }\n "}, {"sha": "3f47df7d844b326dc47cc4a7dfd12bae2da29cf0", "filename": "compiler/rustc_codegen_cranelift/src/driver/jit.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdriver%2Fjit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdriver%2Fjit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdriver%2Fjit.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -94,7 +94,7 @@ pub(super) fn run_jit(tcx: TyCtxt<'_>) -> ! {\n \n     let args = ::std::env::var(\"CG_CLIF_JIT_ARGS\").unwrap_or_else(|_| String::new());\n     let args = std::iter::once(&*tcx.crate_name(LOCAL_CRATE).as_str().to_string())\n-        .chain(args.split(\" \"))\n+        .chain(args.split(' '))\n         .map(|arg| CString::new(arg).unwrap())\n         .collect::<Vec<_>>();\n     let mut argv = args.iter().map(|arg| arg.as_ptr()).collect::<Vec<_>>();\n@@ -151,7 +151,7 @@ fn load_imported_symbols_for_jit(tcx: TyCtxt<'_>) -> Vec<(String, *const u8)> {\n             }\n             let dlsym_name = if cfg!(target_os = \"macos\") {\n                 // On macOS `dlsym` expects the name without leading `_`.\n-                assert!(name.starts_with(\"_\"), \"{:?}\", name);\n+                assert!(name.starts_with('_'), \"{:?}\", name);\n                 &name[1..]\n             } else {\n                 &name"}, {"sha": "a11dc57ee64536ce9893d0033e77932bff09e133", "filename": "compiler/rustc_codegen_cranelift/src/driver/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdriver%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdriver%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdriver%2Fmod.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -64,11 +64,11 @@ fn codegen_mono_items<'tcx>(\n \n     for (mono_item, (linkage, visibility)) in mono_items {\n         let linkage = crate::linkage::get_clif_linkage(mono_item, linkage, visibility);\n-        trans_mono_item(cx, mono_item, linkage);\n+        codegen_mono_item(cx, mono_item, linkage);\n     }\n }\n \n-fn trans_mono_item<'tcx, M: Module>(\n+fn codegen_mono_item<'tcx, M: Module>(\n     cx: &mut crate::CodegenCx<'tcx, M>,\n     mono_item: MonoItem<'tcx>,\n     linkage: Linkage,\n@@ -80,7 +80,7 @@ fn trans_mono_item<'tcx, M: Module>(\n                 crate::PrintOnPanic(|| format!(\"{:?} {}\", inst, tcx.symbol_name(inst).name));\n             debug_assert!(!inst.substs.needs_infer());\n             tcx.sess\n-                .time(\"codegen fn\", || crate::base::trans_fn(cx, inst, linkage));\n+                .time(\"codegen fn\", || crate::base::codegen_fn(cx, inst, linkage));\n         }\n         MonoItem::Static(def_id) => {\n             crate::constant::codegen_static(&mut cx.constants_cx, def_id);"}, {"sha": "04aac780125d93a354eff2a1f5ef18a69e5fda16", "filename": "compiler/rustc_codegen_cranelift/src/inline_asm.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Finline_asm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Finline_asm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Finline_asm.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -50,7 +50,7 @@ pub(crate) fn codegen_inline_asm<'tcx>(\n                 inputs.push((\n                     reg,\n                     new_slot(reg.reg_class()),\n-                    crate::base::trans_operand(fx, value).load_scalar(fx),\n+                    crate::base::codegen_operand(fx, value).load_scalar(fx),\n                 ));\n             }\n             InlineAsmOperand::Out {\n@@ -64,7 +64,7 @@ pub(crate) fn codegen_inline_asm<'tcx>(\n                     outputs.push((\n                         reg,\n                         new_slot(reg.reg_class()),\n-                        crate::base::trans_place(fx, place),\n+                        crate::base::codegen_place(fx, place),\n                     ));\n                 }\n             }\n@@ -79,13 +79,13 @@ pub(crate) fn codegen_inline_asm<'tcx>(\n                 inputs.push((\n                     reg,\n                     new_slot(reg.reg_class()),\n-                    crate::base::trans_operand(fx, in_value).load_scalar(fx),\n+                    crate::base::codegen_operand(fx, in_value).load_scalar(fx),\n                 ));\n                 if let Some(out_place) = out_place {\n                     outputs.push((\n                         reg,\n                         new_slot(reg.reg_class()),\n-                        crate::base::trans_place(fx, out_place),\n+                        crate::base::codegen_place(fx, out_place),\n                     ));\n                 }\n             }"}, {"sha": "171445f2d71b62840204f24837e835ea7c3712ee", "filename": "compiler/rustc_codegen_cranelift/src/intrinsics/llvm.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fllvm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fllvm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fllvm.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -53,7 +53,7 @@ pub(crate) fn codegen_llvm_intrinsic_call<'tcx>(\n         };\n         llvm.x86.sse2.cmp.ps | llvm.x86.sse2.cmp.pd, (c x, c y, o kind) {\n             let kind_const = crate::constant::mir_operand_get_const_val(fx, kind).expect(\"llvm.x86.sse2.cmp.* kind not const\");\n-            let flt_cc = match kind_const.val.try_to_bits(Size::from_bytes(1)).expect(&format!(\"kind not scalar: {:?}\", kind_const)) {\n+            let flt_cc = match kind_const.val.try_to_bits(Size::from_bytes(1)).unwrap_or_else(|| panic!(\"kind not scalar: {:?}\", kind_const)) {\n                 0 => FloatCC::Equal,\n                 1 => FloatCC::LessThan,\n                 2 => FloatCC::LessThanOrEqual,\n@@ -84,7 +84,7 @@ pub(crate) fn codegen_llvm_intrinsic_call<'tcx>(\n         llvm.x86.sse2.psrli.d, (c a, o imm8) {\n             let imm8 = crate::constant::mir_operand_get_const_val(fx, imm8).expect(\"llvm.x86.sse2.psrli.d imm8 not const\");\n             simd_for_each_lane(fx, a, ret, |fx, _lane_layout, res_lane_layout, lane| {\n-                let res_lane = match imm8.val.try_to_bits(Size::from_bytes(4)).expect(&format!(\"imm8 not scalar: {:?}\", imm8)) {\n+                let res_lane = match imm8.val.try_to_bits(Size::from_bytes(4)).unwrap_or_else(|| panic!(\"imm8 not scalar: {:?}\", imm8)) {\n                     imm8 if imm8 < 32 => fx.bcx.ins().ushr_imm(lane, i64::from(imm8 as u8)),\n                     _ => fx.bcx.ins().iconst(types::I32, 0),\n                 };\n@@ -94,7 +94,7 @@ pub(crate) fn codegen_llvm_intrinsic_call<'tcx>(\n         llvm.x86.sse2.pslli.d, (c a, o imm8) {\n             let imm8 = crate::constant::mir_operand_get_const_val(fx, imm8).expect(\"llvm.x86.sse2.psrli.d imm8 not const\");\n             simd_for_each_lane(fx, a, ret, |fx, _lane_layout, res_lane_layout, lane| {\n-                let res_lane = match imm8.val.try_to_bits(Size::from_bytes(4)).expect(&format!(\"imm8 not scalar: {:?}\", imm8)) {\n+                let res_lane = match imm8.val.try_to_bits(Size::from_bytes(4)).unwrap_or_else(|| panic!(\"imm8 not scalar: {:?}\", imm8)) {\n                     imm8 if imm8 < 32 => fx.bcx.ins().ishl_imm(lane, i64::from(imm8 as u8)),\n                     _ => fx.bcx.ins().iconst(types::I32, 0),\n                 };"}, {"sha": "a5f45b7abf4c802118edab6131b5a16303163ed6", "filename": "compiler/rustc_codegen_cranelift/src/intrinsics/mod.rs", "status": "modified", "additions": 18, "deletions": 17, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fmod.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -9,6 +9,7 @@ pub(crate) use cpuid::codegen_cpuid_call;\n pub(crate) use llvm::codegen_llvm_intrinsic_call;\n \n use crate::prelude::*;\n+use rustc_middle::ty::print::with_no_trimmed_paths;\n \n macro intrinsic_pat {\n     (_) => {\n@@ -30,10 +31,10 @@ macro intrinsic_arg {\n         $arg\n     },\n     (c $fx:expr, $arg:ident) => {\n-        trans_operand($fx, $arg)\n+        codegen_operand($fx, $arg)\n     },\n     (v $fx:expr, $arg:ident) => {\n-        trans_operand($fx, $arg).load_scalar($fx)\n+        codegen_operand($fx, $arg).load_scalar($fx)\n     }\n }\n \n@@ -89,7 +90,7 @@ macro call_intrinsic_match {\n                     assert!($substs.is_noop());\n                     if let [$(ref $arg),*] = *$args {\n                         let ($($arg,)*) = (\n-                            $(trans_operand($fx, $arg),)*\n+                            $(codegen_operand($fx, $arg),)*\n                         );\n                         let res = $fx.easy_call(stringify!($func), &[$($arg),*], $fx.tcx.types.$ty);\n                         $ret.write_cvalue($fx, res);\n@@ -576,7 +577,7 @@ pub(crate) fn codegen_intrinsic_call<'tcx>(\n                 \"unchecked_shr\" => BinOp::Shr,\n                 _ => unreachable!(\"intrinsic {}\", intrinsic),\n             };\n-            let res = crate::num::trans_int_binop(fx, bin_op, x, y);\n+            let res = crate::num::codegen_int_binop(fx, bin_op, x, y);\n             ret.write_cvalue(fx, res);\n         };\n         _ if intrinsic.ends_with(\"_with_overflow\"), (c x, c y) {\n@@ -588,7 +589,7 @@ pub(crate) fn codegen_intrinsic_call<'tcx>(\n                 _ => unreachable!(\"intrinsic {}\", intrinsic),\n             };\n \n-            let res = crate::num::trans_checked_int_binop(\n+            let res = crate::num::codegen_checked_int_binop(\n                 fx,\n                 bin_op,\n                 x,\n@@ -604,7 +605,7 @@ pub(crate) fn codegen_intrinsic_call<'tcx>(\n                 \"wrapping_mul\" => BinOp::Mul,\n                 _ => unreachable!(\"intrinsic {}\", intrinsic),\n             };\n-            let res = crate::num::trans_int_binop(\n+            let res = crate::num::codegen_int_binop(\n                 fx,\n                 bin_op,\n                 x,\n@@ -622,7 +623,7 @@ pub(crate) fn codegen_intrinsic_call<'tcx>(\n \n             let signed = type_sign(T);\n \n-            let checked_res = crate::num::trans_checked_int_binop(\n+            let checked_res = crate::num::codegen_checked_int_binop(\n                 fx,\n                 bin_op,\n                 lhs,\n@@ -819,29 +820,29 @@ pub(crate) fn codegen_intrinsic_call<'tcx>(\n         assert_inhabited | assert_zero_valid | assert_uninit_valid, <T> () {\n             let layout = fx.layout_of(T);\n             if layout.abi.is_uninhabited() {\n-                crate::base::codegen_panic(\n+                with_no_trimmed_paths(|| crate::base::codegen_panic(\n                     fx,\n                     &format!(\"attempted to instantiate uninhabited type `{}`\", T),\n                     span,\n-                );\n+                ));\n                 return;\n             }\n \n             if intrinsic == \"assert_zero_valid\" && !layout.might_permit_raw_init(fx, /*zero:*/ true).unwrap() {\n-                crate::base::codegen_panic(\n+                with_no_trimmed_paths(|| crate::base::codegen_panic(\n                     fx,\n                     &format!(\"attempted to zero-initialize type `{}`, which is invalid\", T),\n                     span,\n-                );\n+                ));\n                 return;\n             }\n \n             if intrinsic == \"assert_uninit_valid\" && !layout.might_permit_raw_init(fx, /*zero:*/ false).unwrap() {\n-                crate::base::codegen_panic(\n+                with_no_trimmed_paths(|| crate::base::codegen_panic(\n                     fx,\n                     &format!(\"attempted to leave type `{}` uninitialized, which is invalid\", T),\n                     span,\n-                );\n+                ));\n                 return;\n             }\n         };\n@@ -866,7 +867,7 @@ pub(crate) fn codegen_intrinsic_call<'tcx>(\n         size_of | pref_align_of | min_align_of | needs_drop | type_id | type_name | variant_count, () {\n             let const_val =\n                 fx.tcx.const_eval_instance(ParamEnv::reveal_all(), instance, None).unwrap();\n-            let val = crate::constant::trans_const_value(\n+            let val = crate::constant::codegen_const_value(\n                 fx,\n                 const_val,\n                 ret.layout().ty,\n@@ -885,12 +886,12 @@ pub(crate) fn codegen_intrinsic_call<'tcx>(\n         };\n \n         ptr_guaranteed_eq, (c a, c b) {\n-            let val = crate::num::trans_ptr_binop(fx, BinOp::Eq, a, b);\n+            let val = crate::num::codegen_ptr_binop(fx, BinOp::Eq, a, b);\n             ret.write_cvalue(fx, val);\n         };\n \n         ptr_guaranteed_ne, (c a, c b) {\n-            let val = crate::num::trans_ptr_binop(fx, BinOp::Ne, a, b);\n+            let val = crate::num::codegen_ptr_binop(fx, BinOp::Ne, a, b);\n             ret.write_cvalue(fx, val);\n         };\n \n@@ -1068,7 +1069,7 @@ pub(crate) fn codegen_intrinsic_call<'tcx>(\n         };\n \n         fadd_fast | fsub_fast | fmul_fast | fdiv_fast | frem_fast, (c x, c y) {\n-            let res = crate::num::trans_float_binop(fx, match intrinsic {\n+            let res = crate::num::codegen_float_binop(fx, match intrinsic {\n                 \"fadd_fast\" => BinOp::Add,\n                 \"fsub_fast\" => BinOp::Sub,\n                 \"fmul_fast\" => BinOp::Mul,"}, {"sha": "2e31c4669e25bb16be06813d419695493377566e", "filename": "compiler/rustc_codegen_cranelift/src/intrinsics/simd.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fsimd.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fsimd.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fsimd.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -127,7 +127,7 @@ pub(super) fn codegen_simd_intrinsic_call<'tcx>(\n                 );\n             };\n \n-            let idx = idx_const.val.try_to_bits(Size::from_bytes(4 /* u32*/)).expect(&format!(\"kind not scalar: {:?}\", idx_const));\n+            let idx = idx_const.val.try_to_bits(Size::from_bytes(4 /* u32*/)).unwrap_or_else(|| panic!(\"kind not scalar: {:?}\", idx_const));\n             let (_lane_type, lane_count) = lane_type_and_count(fx.tcx, base.layout());\n             if idx >= lane_count.into() {\n                 fx.tcx.sess.span_fatal(fx.mir.span, &format!(\"[simd_insert] idx {} >= lane_count {}\", idx, lane_count));\n@@ -149,7 +149,7 @@ pub(super) fn codegen_simd_intrinsic_call<'tcx>(\n                 );\n             };\n \n-            let idx = idx_const.val.try_to_bits(Size::from_bytes(4 /* u32*/)).expect(&format!(\"kind not scalar: {:?}\", idx_const));\n+            let idx = idx_const.val.try_to_bits(Size::from_bytes(4 /* u32*/)).unwrap_or_else(|| panic!(\"kind not scalar: {:?}\", idx_const));\n             let (_lane_type, lane_count) = lane_type_and_count(fx.tcx, v.layout());\n             if idx >= lane_count.into() {\n                 fx.tcx.sess.span_fatal(fx.mir.span, &format!(\"[simd_extract] idx {} >= lane_count {}\", idx, lane_count));"}, {"sha": "ba9ee0d450ee66c68821acab3f094304f92c0ba3", "filename": "compiler/rustc_codegen_cranelift/src/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flib.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -9,6 +9,7 @@\n )]\n #![warn(rust_2018_idioms)]\n #![warn(unused_lifetimes)]\n+#![warn(unreachable_pub)]\n \n #[cfg(feature = \"jit\")]\n extern crate libc;\n@@ -110,7 +111,7 @@ mod prelude {\n     pub(crate) use cranelift_module::{self, DataContext, DataId, FuncId, Linkage, Module};\n \n     pub(crate) use crate::abi::*;\n-    pub(crate) use crate::base::{trans_operand, trans_place};\n+    pub(crate) use crate::base::{codegen_operand, codegen_place};\n     pub(crate) use crate::cast::*;\n     pub(crate) use crate::common::*;\n     pub(crate) use crate::debuginfo::{DebugContext, UnwindContext};"}, {"sha": "dc1e2107ce712d2cf51032434ddbbfe77316e3a6", "filename": "compiler/rustc_codegen_cranelift/src/linkage.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flinkage.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flinkage.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flinkage.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -25,11 +25,9 @@ pub(crate) fn get_static_linkage(tcx: TyCtxt<'_>, def_id: DefId) -> Linkage {\n             RLinkage::ExternalWeak | RLinkage::WeakAny => Linkage::Preemptible,\n             _ => panic!(\"{:?}\", linkage),\n         }\n+    } else if tcx.is_reachable_non_generic(def_id) {\n+        Linkage::Export\n     } else {\n-        if tcx.is_reachable_non_generic(def_id) {\n-            Linkage::Export\n-        } else {\n-            Linkage::Hidden\n-        }\n+        Linkage::Hidden\n     }\n }"}, {"sha": "10f515e38ead279f1a080d3b94511e10fe10a4f6", "filename": "compiler/rustc_codegen_cranelift/src/main_shim.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmain_shim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmain_shim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmain_shim.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -76,7 +76,7 @@ pub(crate) fn maybe_create_entry_wrapper(\n             .unwrap();\n \n         let mut ctx = Context::new();\n-        ctx.func = Function::with_name_signature(ExternalName::user(0, 0), cmain_sig.clone());\n+        ctx.func = Function::with_name_signature(ExternalName::user(0, 0), cmain_sig);\n         {\n             let mut func_ctx = FunctionBuilderContext::new();\n             let mut bcx = FunctionBuilder::new(&mut ctx.func, &mut func_ctx);"}, {"sha": "cda2a187ff9b7c1f4ac0b3f3755c7f9429db90e0", "filename": "compiler/rustc_codegen_cranelift/src/metadata.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmetadata.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -29,7 +29,7 @@ impl MetadataLoader for CraneliftMetadataLoader {\n                         .expect(\"Rlib metadata file too big to load into memory.\"),\n                 );\n                 ::std::io::copy(&mut entry, &mut buf).map_err(|e| format!(\"{:?}\", e))?;\n-                let buf: OwningRef<Vec<u8>, [u8]> = OwningRef::new(buf).into();\n+                let buf: OwningRef<Vec<u8>, [u8]> = OwningRef::new(buf);\n                 return Ok(rustc_erase_owner!(buf.map_owner_box()));\n             }\n         }\n@@ -47,7 +47,7 @@ impl MetadataLoader for CraneliftMetadataLoader {\n             .data()\n             .map_err(|e| format!(\"failed to read .rustc section: {:?}\", e))?\n             .to_owned();\n-        let buf: OwningRef<Vec<u8>, [u8]> = OwningRef::new(buf).into();\n+        let buf: OwningRef<Vec<u8>, [u8]> = OwningRef::new(buf);\n         Ok(rustc_erase_owner!(buf.map_owner_box()))\n     }\n }"}, {"sha": "41f4a9b9662bcfc8ce9d9f722dd9e8df96ebb829", "filename": "compiler/rustc_codegen_cranelift/src/num.rs", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fnum.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fnum.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fnum.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -89,10 +89,10 @@ pub(crate) fn codegen_binop<'tcx>(\n     }\n \n     match in_lhs.layout().ty.kind() {\n-        ty::Bool => crate::num::trans_bool_binop(fx, bin_op, in_lhs, in_rhs),\n-        ty::Uint(_) | ty::Int(_) => crate::num::trans_int_binop(fx, bin_op, in_lhs, in_rhs),\n-        ty::Float(_) => crate::num::trans_float_binop(fx, bin_op, in_lhs, in_rhs),\n-        ty::RawPtr(..) | ty::FnPtr(..) => crate::num::trans_ptr_binop(fx, bin_op, in_lhs, in_rhs),\n+        ty::Bool => crate::num::codegen_bool_binop(fx, bin_op, in_lhs, in_rhs),\n+        ty::Uint(_) | ty::Int(_) => crate::num::codegen_int_binop(fx, bin_op, in_lhs, in_rhs),\n+        ty::Float(_) => crate::num::codegen_float_binop(fx, bin_op, in_lhs, in_rhs),\n+        ty::RawPtr(..) | ty::FnPtr(..) => crate::num::codegen_ptr_binop(fx, bin_op, in_lhs, in_rhs),\n         _ => unreachable!(\n             \"{:?}({:?}, {:?})\",\n             bin_op,\n@@ -102,7 +102,7 @@ pub(crate) fn codegen_binop<'tcx>(\n     }\n }\n \n-pub(crate) fn trans_bool_binop<'tcx>(\n+pub(crate) fn codegen_bool_binop<'tcx>(\n     fx: &mut FunctionCx<'_, 'tcx, impl Module>,\n     bin_op: BinOp,\n     in_lhs: CValue<'tcx>,\n@@ -123,7 +123,7 @@ pub(crate) fn trans_bool_binop<'tcx>(\n     CValue::by_val(res, fx.layout_of(fx.tcx.types.bool))\n }\n \n-pub(crate) fn trans_int_binop<'tcx>(\n+pub(crate) fn codegen_int_binop<'tcx>(\n     fx: &mut FunctionCx<'_, 'tcx, impl Module>,\n     bin_op: BinOp,\n     in_lhs: CValue<'tcx>,\n@@ -196,7 +196,7 @@ pub(crate) fn trans_int_binop<'tcx>(\n     CValue::by_val(val, in_lhs.layout())\n }\n \n-pub(crate) fn trans_checked_int_binop<'tcx>(\n+pub(crate) fn codegen_checked_int_binop<'tcx>(\n     fx: &mut FunctionCx<'_, 'tcx, impl Module>,\n     bin_op: BinOp,\n     in_lhs: CValue<'tcx>,\n@@ -357,7 +357,7 @@ pub(crate) fn trans_checked_int_binop<'tcx>(\n     out_place.to_cvalue(fx)\n }\n \n-pub(crate) fn trans_float_binop<'tcx>(\n+pub(crate) fn codegen_float_binop<'tcx>(\n     fx: &mut FunctionCx<'_, 'tcx, impl Module>,\n     bin_op: BinOp,\n     in_lhs: CValue<'tcx>,\n@@ -402,7 +402,7 @@ pub(crate) fn trans_float_binop<'tcx>(\n     CValue::by_val(res, in_lhs.layout())\n }\n \n-pub(crate) fn trans_ptr_binop<'tcx>(\n+pub(crate) fn codegen_ptr_binop<'tcx>(\n     fx: &mut FunctionCx<'_, 'tcx, impl Module>,\n     bin_op: BinOp,\n     in_lhs: CValue<'tcx>,"}, {"sha": "3c939d5a58639869e2dc22dc8b0ec1dd602a51df", "filename": "compiler/rustc_codegen_cranelift/src/optimize/stack2reg.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Foptimize%2Fstack2reg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Foptimize%2Fstack2reg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Foptimize%2Fstack2reg.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -228,7 +228,8 @@ pub(super) fn optimize_function(\n             match *potential_stores {\n                 [] => {\n                     #[cfg(debug_assertions)]\n-                    clif_comments.add_comment(load, format!(\"[BUG?] Reading uninitialized memory\"));\n+                    clif_comments\n+                        .add_comment(load, \"[BUG?] Reading uninitialized memory\".to_string());\n                 }\n                 [store]\n                     if spatial_overlap(&opt_ctx.ctx.func, store, load) == SpatialOverlap::Full"}, {"sha": "ff878af7f5eef9049199acd55e2c4a8405b7b8d6", "filename": "compiler/rustc_codegen_cranelift/src/pretty_clif.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fpretty_clif.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fpretty_clif.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fpretty_clif.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -131,11 +131,11 @@ impl FuncWriter for &'_ CommentWriter {\n             if !comment.is_empty() {\n                 writeln!(w, \"; {}\", comment)?;\n             } else {\n-                writeln!(w, \"\")?;\n+                writeln!(w)?;\n             }\n         }\n         if !self.global_comments.is_empty() {\n-            writeln!(w, \"\")?;\n+            writeln!(w)?;\n         }\n \n         self.super_preamble(w, func, reg_info)\n@@ -153,7 +153,7 @@ impl FuncWriter for &'_ CommentWriter {\n         if let Some(comment) = self.entity_comments.get(&entity) {\n             writeln!(w, \" ; {}\", comment.replace('\\n', \"\\n; \"))\n         } else {\n-            writeln!(w, \"\")\n+            writeln!(w)\n         }\n     }\n \n@@ -261,7 +261,7 @@ pub(crate) fn write_clif_file<'tcx>(\n         writeln!(file, \"set is_pic\")?;\n         writeln!(file, \"set enable_simd\")?;\n         writeln!(file, \"target {} haswell\", target_triple)?;\n-        writeln!(file, \"\")?;\n+        writeln!(file)?;\n         file.write_all(clif.as_bytes())?;\n     };\n     if let Err(err) = res {"}, {"sha": "690d96764a8f588d1e8ed0e5827c71aec89c0d05", "filename": "compiler/rustc_codegen_cranelift/src/trap.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Ftrap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Ftrap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Ftrap.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -67,4 +67,3 @@ pub(crate) fn trap_unimplemented(fx: &mut FunctionCx<'_, '_, impl Module>, msg:\n     let true_ = fx.bcx.ins().iconst(types::I32, 1);\n     fx.bcx.ins().trapnz(true_, TrapCode::User(!0));\n }\n-"}, {"sha": "2b9ea5273b608221abebd5fb84b6531aada3ee11", "filename": "compiler/rustc_codegen_cranelift/src/value_and_place.rs", "status": "modified", "additions": 27, "deletions": 12, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fvalue_and_place.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fvalue_and_place.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fvalue_and_place.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -27,10 +27,10 @@ fn codegen_field<'tcx>(\n             return simple(fx);\n         }\n         match field_layout.ty.kind() {\n-            ty::Slice(..) | ty::Str | ty::Foreign(..) => return simple(fx),\n+            ty::Slice(..) | ty::Str | ty::Foreign(..) => simple(fx),\n             ty::Adt(def, _) if def.repr.packed() => {\n                 assert_eq!(layout.align.abi.bytes(), 1);\n-                return simple(fx);\n+                simple(fx)\n             }\n             _ => {\n                 // We have to align the offset for DST's\n@@ -237,15 +237,12 @@ impl<'tcx> CValue<'tcx> {\n \n         let clif_ty = fx.clif_type(layout.ty).unwrap();\n \n-        match layout.ty.kind() {\n-            ty::Bool => {\n-                assert!(\n-                    const_val == 0 || const_val == 1,\n-                    \"Invalid bool 0x{:032X}\",\n-                    const_val\n-                );\n-            }\n-            _ => {}\n+        if let ty::Bool = layout.ty.kind() {\n+            assert!(\n+                const_val == 0 || const_val == 1,\n+                \"Invalid bool 0x{:032X}\",\n+                const_val\n+            );\n         }\n \n         let val = match layout.ty.kind() {\n@@ -335,7 +332,7 @@ impl<'tcx> CPlace<'tcx> {\n \n         let stack_slot = fx.bcx.create_stack_slot(StackSlotData {\n             kind: StackSlotKind::ExplicitSlot,\n-            size: layout.size.bytes() as u32,\n+            size: u32::try_from(layout.size.bytes()).unwrap(),\n             offset: None,\n         });\n         CPlace {\n@@ -533,6 +530,13 @@ impl<'tcx> CPlace<'tcx> {\n             dst_ty: Type,\n         ) {\n             let src_ty = fx.bcx.func.dfg.value_type(data);\n+            assert_eq!(\n+                src_ty.bytes(),\n+                dst_ty.bytes(),\n+                \"write_cvalue_transmute: {:?} -> {:?}\",\n+                src_ty,\n+                dst_ty,\n+            );\n             let data = match (src_ty, dst_ty) {\n                 (_, _) if src_ty == dst_ty => data,\n \n@@ -544,6 +548,17 @@ impl<'tcx> CPlace<'tcx> {\n                 _ if src_ty.is_vector() && dst_ty.is_vector() => {\n                     fx.bcx.ins().raw_bitcast(dst_ty, data)\n                 }\n+                _ if src_ty.is_vector() || dst_ty.is_vector() => {\n+                    // FIXME do something more efficient for transmutes between vectors and integers.\n+                    let stack_slot = fx.bcx.create_stack_slot(StackSlotData {\n+                        kind: StackSlotKind::ExplicitSlot,\n+                        size: src_ty.bytes(),\n+                        offset: None,\n+                    });\n+                    let ptr = Pointer::stack_slot(stack_slot);\n+                    ptr.store(fx, data, MemFlags::trusted());\n+                    ptr.load(fx, dst_ty, MemFlags::trusted())\n+                }\n                 _ => unreachable!(\"write_cvalue_transmute: {:?} -> {:?}\", src_ty, dst_ty),\n             };\n             fx.bcx"}, {"sha": "238abc0d8bdfa557ecd65611a91af4063383d8c8", "filename": "compiler/rustc_codegen_cranelift/src/vtable.rs", "status": "modified", "additions": 4, "deletions": 12, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fvtable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fvtable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fvtable.rs?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -108,14 +108,14 @@ fn build_vtable<'tcx>(\n         (&[]).iter()\n     };\n     let methods = methods.cloned().map(|opt_mth| {\n-        opt_mth.map_or(None, |(def_id, substs)| {\n-            Some(import_function(\n+        opt_mth.map(|(def_id, substs)| {\n+            import_function(\n                 tcx,\n                 &mut fx.cx.module,\n                 Instance::resolve_for_vtable(tcx, ParamEnv::reveal_all(), def_id, substs)\n                     .unwrap()\n                     .polymorphize(fx.tcx),\n-            ))\n+            )\n         })\n     });\n     components.extend(methods);\n@@ -137,15 +137,7 @@ fn build_vtable<'tcx>(\n         }\n     }\n \n-    data_ctx.set_align(\n-        fx.tcx\n-            .data_layout\n-            .pointer_align\n-            .pref\n-            .bytes()\n-            .try_into()\n-            .unwrap(),\n-    );\n+    data_ctx.set_align(fx.tcx.data_layout.pointer_align.pref.bytes());\n \n     let data_id = fx\n         .cx"}, {"sha": "3cdd4119d794cda6c8a045dce1c5a80566986030", "filename": "compiler/rustc_codegen_cranelift/test.sh", "status": "modified", "additions": 5, "deletions": 109, "changes": 114, "blob_url": "https://github.com/rust-lang/rust/blob/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Ftest.sh", "raw_url": "https://github.com/rust-lang/rust/raw/39f5563e73a46f3393d33f501e51be59a4927f98/compiler%2Frustc_codegen_cranelift%2Ftest.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Ftest.sh?ref=39f5563e73a46f3393d33f501e51be59a4927f98", "patch": "@@ -1,119 +1,15 @@\n #!/bin/bash\n set -e\n \n-# Build cg_clif\n export RUSTFLAGS=\"-Zrun_dsymutil=no\"\n-if [[ \"$1\" == \"--release\" ]]; then\n-    export CHANNEL='release'\n-    cargo build --release\n-else\n-    export CHANNEL='debug'\n-    cargo build --bin cg_clif\n-fi\n \n-# Config\n-source scripts/config.sh\n-export CG_CLIF_INCR_CACHE_DISABLED=1\n-RUSTC=$RUSTC\" \"$RUSTFLAGS\" -L crate=target/out --out-dir target/out -Cdebuginfo=2\"\n+./build.sh --without-sysroot $@\n \n-# Cleanup\n rm -r target/out || true\n \n-# Perform all tests\n-echo \"[BUILD] mini_core\"\n-$RUSTC example/mini_core.rs --crate-name mini_core --crate-type lib,dylib --target $TARGET_TRIPLE\n+scripts/tests.sh no_sysroot\n \n-echo \"[BUILD] example\"\n-$RUSTC example/example.rs --crate-type lib --target $TARGET_TRIPLE\n+./build.sh $@\n \n-if [[ \"$JIT_SUPPORTED\" = \"1\" ]]; then\n-    echo \"[JIT] mini_core_hello_world\"\n-    CG_CLIF_JIT_ARGS=\"abc bcd\" $RUSTC --jit example/mini_core_hello_world.rs --cfg jit --target $HOST_TRIPLE\n-else\n-    echo \"[JIT] mini_core_hello_world (skipped)\"\n-fi\n-\n-echo \"[AOT] mini_core_hello_world\"\n-$RUSTC example/mini_core_hello_world.rs --crate-name mini_core_hello_world --crate-type bin -g --target $TARGET_TRIPLE\n-$RUN_WRAPPER ./target/out/mini_core_hello_world abc bcd\n-# (echo \"break set -n main\"; echo \"run\"; sleep 1; echo \"si -c 10\"; sleep 1; echo \"frame variable\") | lldb -- ./target/out/mini_core_hello_world abc bcd\n-\n-echo \"[AOT] arbitrary_self_types_pointers_and_wrappers\"\n-$RUSTC example/arbitrary_self_types_pointers_and_wrappers.rs --crate-name arbitrary_self_types_pointers_and_wrappers --crate-type bin --target $TARGET_TRIPLE\n-$RUN_WRAPPER ./target/out/arbitrary_self_types_pointers_and_wrappers\n-\n-echo \"[BUILD] sysroot\"\n-time ./build_sysroot/build_sysroot.sh --release\n-\n-echo \"[AOT] alloc_example\"\n-$RUSTC example/alloc_example.rs --crate-type bin --target $TARGET_TRIPLE\n-$RUN_WRAPPER ./target/out/alloc_example\n-\n-if [[ \"$JIT_SUPPORTED\" = \"1\" ]]; then\n-    echo \"[JIT] std_example\"\n-    $RUSTC --jit example/std_example.rs --target $HOST_TRIPLE\n-else\n-    echo \"[JIT] std_example (skipped)\"\n-fi\n-\n-echo \"[AOT] dst_field_align\"\n-# FIXME Re-add -Zmir-opt-level=2 once rust-lang/rust#67529 is fixed.\n-$RUSTC example/dst-field-align.rs --crate-name dst_field_align --crate-type bin --target $TARGET_TRIPLE\n-$RUN_WRAPPER ./target/out/dst_field_align || (echo $?; false)\n-\n-echo \"[AOT] std_example\"\n-$RUSTC example/std_example.rs --crate-type bin --target $TARGET_TRIPLE\n-$RUN_WRAPPER ./target/out/std_example arg\n-\n-echo \"[AOT] subslice-patterns-const-eval\"\n-$RUSTC example/subslice-patterns-const-eval.rs --crate-type bin -Cpanic=abort --target $TARGET_TRIPLE\n-$RUN_WRAPPER ./target/out/subslice-patterns-const-eval\n-\n-echo \"[AOT] track-caller-attribute\"\n-$RUSTC example/track-caller-attribute.rs --crate-type bin -Cpanic=abort --target $TARGET_TRIPLE\n-$RUN_WRAPPER ./target/out/track-caller-attribute\n-\n-echo \"[AOT] mod_bench\"\n-$RUSTC example/mod_bench.rs --crate-type bin --target $TARGET_TRIPLE\n-$RUN_WRAPPER ./target/out/mod_bench\n-\n-pushd rand\n-rm -r ./target || true\n-../cargo.sh test --workspace\n-popd\n-\n-pushd simple-raytracer\n-if [[ \"$HOST_TRIPLE\" = \"$TARGET_TRIPLE\" ]]; then\n-    echo \"[BENCH COMPILE] ebobby/simple-raytracer\"\n-    hyperfine --runs ${RUN_RUNS:-10} --warmup 1 --prepare \"cargo clean\" \\\n-    \"RUSTC=rustc RUSTFLAGS='' cargo build\" \\\n-    \"../cargo.sh build\"\n-\n-    echo \"[BENCH RUN] ebobby/simple-raytracer\"\n-    cp ./target/debug/main ./raytracer_cg_clif\n-    hyperfine --runs ${RUN_RUNS:-10} ./raytracer_cg_llvm ./raytracer_cg_clif\n-else\n-    echo \"[BENCH COMPILE] ebobby/simple-raytracer (skipped)\"\n-    echo \"[COMPILE] ebobby/simple-raytracer\"\n-    ../cargo.sh build\n-    echo \"[BENCH RUN] ebobby/simple-raytracer (skipped)\"\n-fi\n-popd\n-\n-pushd build_sysroot/sysroot_src/library/core/tests\n-echo \"[TEST] libcore\"\n-rm -r ./target || true\n-../../../../../cargo.sh test\n-popd\n-\n-pushd regex\n-echo \"[TEST] rust-lang/regex example shootout-regex-dna\"\n-../cargo.sh clean\n-# Make sure `[codegen mono items] start` doesn't poison the diff\n-../cargo.sh build --example shootout-regex-dna\n-cat examples/regexdna-input.txt | ../cargo.sh run --example shootout-regex-dna | grep -v \"Spawned thread\" > res.txt\n-diff -u res.txt examples/regexdna-output.txt\n-\n-echo \"[TEST] rust-lang/regex tests\"\n-../cargo.sh test --tests -- --exclude-should-panic --test-threads 1 -Zunstable-options\n-popd\n+scripts/tests.sh base_sysroot\n+scripts/tests.sh extended_sysroot"}]}