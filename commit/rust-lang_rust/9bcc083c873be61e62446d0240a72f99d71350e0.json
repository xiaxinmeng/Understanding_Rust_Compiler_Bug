{"sha": "9bcc083c873be61e62446d0240a72f99d71350e0", "node_id": "C_kwDOAAsO6NoAKDliY2MwODNjODczYmU2MWU2MjQ0NmQwMjQwYTcyZjk5ZDcxMzUwZTA", "commit": {"author": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2022-11-07T14:43:28Z"}, "committer": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2022-11-08T10:35:52Z"}, "message": "run-make-fulldeps: fix split debuginfo test\n\nAdd lots of comments to this test and enable parts of the test that were\nadded but never ran.\n\nSigned-off-by: David Wood <david.wood@huawei.com>", "tree": {"sha": "b0aea36673a6587be67a40163fa68a681c7bfccb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0aea36673a6587be67a40163fa68a681c7bfccb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9bcc083c873be61e62446d0240a72f99d71350e0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9bcc083c873be61e62446d0240a72f99d71350e0", "html_url": "https://github.com/rust-lang/rust/commit/9bcc083c873be61e62446d0240a72f99d71350e0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9bcc083c873be61e62446d0240a72f99d71350e0/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "391ba78ab442610a63310b9a3d24646082628081", "url": "https://api.github.com/repos/rust-lang/rust/commits/391ba78ab442610a63310b9a3d24646082628081", "html_url": "https://github.com/rust-lang/rust/commit/391ba78ab442610a63310b9a3d24646082628081"}], "stats": {"total": 160, "additions": 145, "deletions": 15}, "files": [{"sha": "a511aff4f3af2b36ea07bccf120ed3aae1cf37a5", "filename": "src/test/run-make-fulldeps/split-debuginfo/Makefile", "status": "modified", "additions": 145, "deletions": 15, "changes": 160, "blob_url": "https://github.com/rust-lang/rust/blob/9bcc083c873be61e62446d0240a72f99d71350e0/src%2Ftest%2Frun-make-fulldeps%2Fsplit-debuginfo%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/9bcc083c873be61e62446d0240a72f99d71350e0/src%2Ftest%2Frun-make-fulldeps%2Fsplit-debuginfo%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fsplit-debuginfo%2FMakefile?ref=9bcc083c873be61e62446d0240a72f99d71350e0", "patch": "@@ -3,7 +3,7 @@ include ../tools.mk\n all: off packed unpacked\n \n ifeq ($(UNAME),Darwin)\n-# If disabled, don't run dsymutil\n+# If disabled, don't run `dsymutil`.\n off:\n \trm -rf $(TMPDIR)/*.dSYM\n \t$(RUSTC) foo.rs -g -C split-debuginfo=off\n@@ -29,98 +29,228 @@ unpacked:\n \t[ ! -d $(TMPDIR)/foo.dSYM ]\n else\n ifdef IS_WINDOWS\n-# Windows only supports =packed\n+# Windows only supports packed debuginfo - nothing to test.\n off:\n packed:\n unpacked:\n else\n+# Some non-Windows, non-Darwin platforms are not stable, and some are.\n ifeq ($(UNAME),Linux)\n   UNSTABLEOPTS :=\n else\n   UNSTABLEOPTS := -Zunstable-options\n endif\n \n+# - Debuginfo in `.o` files\n+# - `.o` deleted\n+# - `.dwo` never created\n+# - `.dwp` never created\n off:\n \t$(RUSTC) foo.rs -g -C $(UNSTABLEOPTS) split-debuginfo=off\n \t[ ! -f $(TMPDIR)/*.dwp ]\n \t[ ! -f $(TMPDIR)/*.dwo ]\n-\n \t$(RUSTC) foo.rs -g\n \t[ ! -f $(TMPDIR)/*.dwp ]\n \t[ ! -f $(TMPDIR)/*.dwo ]\n \n-packed: packed-split packed-single\n+packed: packed-split packed-single packed-remapped packed-crosscrate\n \n+# - Debuginfo in `.dwo` files\n+# - `.o` deleted\n+# - `.dwo` deleted\n+# - `.dwp` present\n packed-split:\n \t$(RUSTC) foo.rs -g $(UNSTABLEOPTS) -C split-debuginfo=packed -Zsplit-dwarf-kind=split\n-\tls $(TMPDIR)/*.dwp\n-\trm -rf $(TMPDIR)/*.dwp $(TMPDIR)/*.dwo\n+\tls $(TMPDIR)/*.o && exit 1 || exit 0\n+\tls $(TMPDIR)/*.dwo && exit 1 || exit 0\n+\trm $(TMPDIR)/foo.dwp\n+\trm $(TMPDIR)/$(call BIN,foo)\n \n+# - Debuginfo in `.o` files\n+# - `.o` deleted\n+# - `.dwo` never created\n+# - `.dwp` present\n packed-single:\n \t$(RUSTC) foo.rs -g $(UNSTABLEOPTS) -C split-debuginfo=packed -Zsplit-dwarf-kind=single\n-\tls $(TMPDIR)/*.dwp\n+\tls $(TMPDIR)/*.o && exit 1 || exit 0\n \tls $(TMPDIR)/*.dwo && exit 1 || exit 0\n-\trm -rf $(TMPDIR)/*.dwp\n+\trm $(TMPDIR)/foo.dwp\n+\trm $(TMPDIR)/$(call BIN,foo)\n \n packed-remapped: packed-remapped-split packed-remapped-single\n \n+# - Debuginfo in `.dwo` files\n+# - `.o` and binary refer to remapped `.dwo` paths which do not exist\n+# - `.o` deleted\n+# - `.dwo` deleted\n+# - `.dwp` present\n packed-remapped-split:\n \t$(RUSTC) $(UNSTABLEOPTS) -C split-debuginfo=packed -C debuginfo=2 \\\n \t\t-Z split-dwarf-kind=split --remap-path-prefix $(TMPDIR)=/a foo.rs -g\n \tobjdump -Wi $(TMPDIR)/foo | grep DW_AT_GNU_dwo_name | (! grep $(TMPDIR)) || exit 1\n+\tls $(TMPDIR)/*.o && exit 1 || exit 0\n+\tls $(TMPDIR)/*.dwo && exit 1 || exit 0\n+\trm $(TMPDIR)/foo.dwp\n+\trm $(TMPDIR)/$(call BIN,foo)\n \n+# - Debuginfo in `.o` files\n+# - `.o` and binary refer to remapped `.o` paths which do not exist\n+# - `.o` deleted\n+# - `.dwo` never created\n+# - `.dwp` present\n packed-remapped-single:\n \t$(RUSTC) $(UNSTABLEOPTS) -C split-debuginfo=packed -C debuginfo=2 \\\n \t\t-Z split-dwarf-kind=single --remap-path-prefix $(TMPDIR)=/a foo.rs -g\n \tobjdump -Wi $(TMPDIR)/foo | grep DW_AT_GNU_dwo_name | (! grep $(TMPDIR)) || exit 1\n+\tls $(TMPDIR)/*.o && exit 1 || exit 0\n+\tls $(TMPDIR)/*.dwo && exit 1 || exit 0\n+\trm $(TMPDIR)/foo.dwp\n+\trm $(TMPDIR)/$(call BIN,foo)\n \n packed-crosscrate: packed-crosscrate-split packed-crosscrate-single\n \n+# - Debuginfo in `.dwo` files\n+# - (bar) `.rlib` file created, contains `.dwo`\n+# - (bar) `.o` deleted\n+# - (bar) `.dwo` deleted\n+# - (bar) `.dwp` never created\n+# - (main) `.o` deleted\n+# - (main) `.dwo` deleted\n+# - (main) `.dwp` present\n packed-crosscrate-split:\n \t$(RUSTC) --crate-type lib $(UNSTABLEOPTS) -C split-debuginfo=packed \\\n \t\t-Zsplit-dwarf-kind=split -C debuginfo=2 -g bar.rs\n \tls $(TMPDIR)/*.rlib\n+\tls $(TMPDIR)/*.o && exit 1 || exit 0\n \tls $(TMPDIR)/*.dwo && exit 1 || exit 0\n \tls $(TMPDIR)/*.dwp && exit 1 || exit 0\n-\t$(RUSTC) --extern bar=$(TMPDIR)/libbar.rlib -Z unstable-options $(UNSTABLEOPTS) \\\n+\t$(RUSTC) --extern bar=$(TMPDIR)/libbar.rlib $(UNSTABLEOPTS) \\\n \t\t-C split-debuginfo=packed -Zsplit-dwarf-kind=split -C debuginfo=2 -g main.rs\n-\trm $(TMPDIR)/*.dwo\n+\tls $(TMPDIR)/*.o && exit 1 || exit 0\n+\tls $(TMPDIR)/*.dwo && exit 1 || exit 0\n \trm $(TMPDIR)/main.dwp\n \trm $(TMPDIR)/$(call BIN,main)\n \n+# - Debuginfo in `.o` files\n+# - (bar) `.rlib` file created, contains `.o`\n+# - (bar) `.o` deleted\n+# - (bar) `.dwo` never created\n+# - (bar) `.dwp` never created\n+# - (main) `.o` deleted\n+# - (main) `.dwo` never created\n+# - (main) `.dwp` present\n packed-crosscrate-single:\n \t$(RUSTC) --crate-type lib $(UNSTABLEOPTS) -C split-debuginfo=packed \\\n \t\t-Zsplit-dwarf-kind=single -C debuginfo=2 -g bar.rs\n \tls $(TMPDIR)/*.rlib\n+\tls $(TMPDIR)/*.o && exit 1 || exit 0\n \tls $(TMPDIR)/*.dwo && exit 1 || exit 0\n \tls $(TMPDIR)/*.dwp && exit 1 || exit 0\n-\t$(RUSTC) --extern bar=$(TMPDIR)/libbar.rlib -Z unstable-options $(UNSTABLEOPTS) \\\n+\t$(RUSTC) --extern bar=$(TMPDIR)/libbar.rlib $(UNSTABLEOPTS) \\\n \t\t-C split-debuginfo=packed -Zsplit-dwarf-kind=single -C debuginfo=2 -g main.rs\n+\tls $(TMPDIR)/*.o && exit 1 || exit 0\n \tls $(TMPDIR)/*.dwo && exit 1 || exit 0\n \trm $(TMPDIR)/main.dwp\n \trm $(TMPDIR)/$(call BIN,main)\n \n-unpacked: unpacked-split unpacked-single unpacked-remapped-split unpacked-remapped-single\n+unpacked: unpacked-split unpacked-single unpacked-remapped unpacked-crosscrate\n \n+# - Debuginfo in `.dwo` files\n+# - `.o` deleted\n+# - `.dwo` present\n+# - `.dwp` never created\n unpacked-split:\n \t$(RUSTC) foo.rs -g $(UNSTABLEOPTS) -C split-debuginfo=unpacked -Zsplit-dwarf-kind=split\n+\tls $(TMPDIR)/*.o && exit 1 || exit 0\n+\trm $(TMPDIR)/*.dwo\n \tls $(TMPDIR)/*.dwp && exit 1 || exit 0\n-\tls $(TMPDIR)/*.dwo\n-\trm -rf $(TMPDIR)/*.dwp $(TMPDIR)/*.dwo\n+\trm $(TMPDIR)/$(call BIN,foo)\n \n+# - Debuginfo in `.o` files\n+# - `.o` present\n+# - `.dwo` never created\n+# - `.dwp` never created\n unpacked-single:\n \t$(RUSTC) foo.rs -g $(UNSTABLEOPTS) -C split-debuginfo=unpacked -Zsplit-dwarf-kind=single\n-\tls $(TMPDIR)/*.dwp && exit 1 || exit 0\n+\tls $(TMPDIR)/*.o\n \tls $(TMPDIR)/*.dwo && exit 1 || exit 0\n+\tls $(TMPDIR)/*.dwp && exit 1 || exit 0\n+\trm $(TMPDIR)/$(call BIN,foo)\n+\n+unpacked-remapped: unpacked-remapped-split unpacked-remapped-single\n \n+# - Debuginfo in `.dwo` files\n+# - `.o` and binary refer to remapped `.dwo` paths which do not exist\n+# - `.o` deleted\n+# - `.dwo` present\n+# - `.dwp` never created\n unpacked-remapped-split:\n \t$(RUSTC) $(UNSTABLEOPTS) -C split-debuginfo=unpacked -C debuginfo=2 \\\n \t\t-Z split-dwarf-kind=split --remap-path-prefix $(TMPDIR)=/a foo.rs -g\n \tobjdump -Wi $(TMPDIR)/foo | grep DW_AT_GNU_dwo_name | (! grep $(TMPDIR)) || exit 1\n+\tls $(TMPDIR)/*.o && exit 1 || exit 0\n+\trm $(TMPDIR)/*.dwo\n+\tls $(TMPDIR)/*.dwp && exit 1 || exit 0\n+\trm $(TMPDIR)/$(call BIN,foo)\n \n+# - Debuginfo in `.o` files\n+# - `.o` and binary refer to remapped `.o` paths which do not exist\n+# - `.o` present\n+# - `.dwo` never created\n+# - `.dwp` never created\n unpacked-remapped-single:\n \t$(RUSTC) $(UNSTABLEOPTS) -C split-debuginfo=unpacked -C debuginfo=2 \\\n \t\t-Z split-dwarf-kind=single --remap-path-prefix $(TMPDIR)=/a foo.rs -g\n \tobjdump -Wi $(TMPDIR)/foo | grep DW_AT_GNU_dwo_name | (! grep $(TMPDIR)) || exit 1\n+\tls $(TMPDIR)/*.o\n+\tls $(TMPDIR)/*.dwo && exit 1 || exit 0\n+\tls $(TMPDIR)/*.dwp && exit 1 || exit 0\n+\trm $(TMPDIR)/$(call BIN,foo)\n+\n+unpacked-crosscrate: packed-crosscrate-split packed-crosscrate-single\n+\n+# - Debuginfo in `.dwo` files\n+# - (bar) `.rlib` file created, contains `.dwo`\n+# - (bar) `.o` deleted\n+# - (bar) `.dwo` present\n+# - (bar) `.dwp` never created\n+# - (main) `.o` deleted\n+# - (main) `.dwo` present\n+# - (main) `.dwp` never created\n+unpacked-crosscrate-split:\n+\t$(RUSTC) --crate-type lib $(UNSTABLEOPTS) -C split-debuginfo=unpacked \\\n+\t\t-Zsplit-dwarf-kind=split -C debuginfo=2 -g bar.rs\n+\tls $(TMPDIR)/*.rlib\n+\tls $(TMPDIR)/*.o && exit 1 || exit 0\n+\tls $(TMPDIR)/*.dwo\n+\tls $(TMPDIR)/*.dwp && exit 1 || exit 0\n+\t$(RUSTC) --extern bar=$(TMPDIR)/libbar.rlib $(UNSTABLEOPTS) \\\n+\t\t-C split-debuginfo=unpacked -Zsplit-dwarf-kind=split -C debuginfo=2 -g main.rs\n+\tls $(TMPDIR)/*.o && exit 1 || exit 0\n+\trm $(TMPDIR)/*.dwo\n+\tls $(TMPDIR)/*.dwp && exit 1 || exit 0\n+\trm $(TMPDIR)/$(call BIN,main)\n+\n+# - Debuginfo in `.o` files\n+# - (bar) `.rlib` file created, contains `.o`\n+# - (bar) `.o` present\n+# - (bar) `.dwo` never created\n+# - (bar) `.dwp` never created\n+# - (main) `.o` present\n+# - (main) `.dwo` never created\n+# - (main) `.dwp` never created\n+unpacked-crosscrate-single:\n+\t$(RUSTC) --crate-type lib $(UNSTABLEOPTS) -C split-debuginfo=unpacked \\\n+\t\t-Zsplit-dwarf-kind=single -C debuginfo=2 -g bar.rs\n+\tls $(TMPDIR)/*.rlib\n+\tls $(TMPDIR)/*.o\n+\tls $(TMPDIR)/*.dwo && exit 1 || exit 0\n+\tls $(TMPDIR)/*.dwp && exit 1 || exit 0\n+\t$(RUSTC) --extern bar=$(TMPDIR)/libbar.rlib $(UNSTABLEOPTS) \\\n+\t\t-C split-debuginfo=unpacked -Zsplit-dwarf-kind=single -C debuginfo=2 -g main.rs\n+\tls $(TMPDIR)/*.o\n+\tls $(TMPDIR)/*.dwo && exit 1 || exit 0\n+\tls $(TMPDIR)/*.dwp && exit 1 || exit 0\n+\trm $(TMPDIR)/$(call BIN,main)\n endif\n endif"}]}