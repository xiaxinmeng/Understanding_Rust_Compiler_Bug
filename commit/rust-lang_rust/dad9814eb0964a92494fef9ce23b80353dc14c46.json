{"sha": "dad9814eb0964a92494fef9ce23b80353dc14c46", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRhZDk4MTRlYjA5NjRhOTI0OTRmZWY5Y2UyM2I4MDM1M2RjMTRjNDY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-04-26T06:18:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-04-26T06:18:17Z"}, "message": "Auto merge of #41258 - clarcharr:str_box_extras, r=Kimundi\n\nMore methods for str boxes. (reduce Box<[u8]> \u2194 Box<str> transmutes)\n\nThis is a follow-up to #41096 that adds safer methods for converting between `Box<str>` and `Box<[u8]>`. They're gated under a different feature from the `&mut str` methods because they may be too niche to include in public APIs, although having them internally helps reduce the number of transmutes the standard library uses.\n\nWhat's added:\n\n* `From<Box<str>> for Box<[u8]>`\n* `<Box<str>>::into_boxed_bytes` (just calls `Into::into`)\n* `alloc::str` (new module)\n* `from_boxed_utf8` and `from_boxed_utf8_unchecked`, defined in `alloc:str`, exported in `collections::str`\n* exports `from_utf8_mut` in `collections::str` (missed from previous PR)", "tree": {"sha": "4d2fa1e7f6cbdf2c7606bceea1cc8c09a6660239", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4d2fa1e7f6cbdf2c7606bceea1cc8c09a6660239"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dad9814eb0964a92494fef9ce23b80353dc14c46", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dad9814eb0964a92494fef9ce23b80353dc14c46", "html_url": "https://github.com/rust-lang/rust/commit/dad9814eb0964a92494fef9ce23b80353dc14c46", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dad9814eb0964a92494fef9ce23b80353dc14c46/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4512424391768cfad54efb8ccdb1191f61e338c2", "url": "https://api.github.com/repos/rust-lang/rust/commits/4512424391768cfad54efb8ccdb1191f61e338c2", "html_url": "https://github.com/rust-lang/rust/commit/4512424391768cfad54efb8ccdb1191f61e338c2"}, {"sha": "c66c6e96978cd81130587e9f4d1fa52dc1b183d6", "url": "https://api.github.com/repos/rust-lang/rust/commits/c66c6e96978cd81130587e9f4d1fa52dc1b183d6", "html_url": "https://github.com/rust-lang/rust/commit/c66c6e96978cd81130587e9f4d1fa52dc1b183d6"}], "stats": {"total": 68, "additions": 60, "deletions": 8}, "files": [{"sha": "2cb376301121821cabbd8c3fa0a6498d9e21c34b", "filename": "src/doc/unstable-book/src/SUMMARY.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md", "raw_url": "https://github.com/rust-lang/rust/raw/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md?ref=dad9814eb0964a92494fef9ce23b80353dc14c46", "patch": "@@ -202,6 +202,7 @@\n     - [str_checked_slicing](library-features/str-checked-slicing.md)\n     - [str_escape](library-features/str-escape.md)\n     - [str_internals](library-features/str-internals.md)\n+    - [str_box_extras](library-features/str-box-extras.md)\n     - [str_mut_extras](library-features/str-mut-extras.md)\n     - [test](library-features/test.md)\n     - [thread_id](library-features/thread-id.md)"}, {"sha": "d05dcafa84da9adf74d6c497d4648436c69895c6", "filename": "src/doc/unstable-book/src/library-features/str-box-extras.md", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Fdoc%2Funstable-book%2Fsrc%2Flibrary-features%2Fstr-box-extras.md", "raw_url": "https://github.com/rust-lang/rust/raw/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Fdoc%2Funstable-book%2Fsrc%2Flibrary-features%2Fstr-box-extras.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Flibrary-features%2Fstr-box-extras.md?ref=dad9814eb0964a92494fef9ce23b80353dc14c46", "patch": "@@ -0,0 +1,9 @@\n+# `str_box_extras`\n+\n+The tracking issue for this feature is: [#str_box_extras]\n+\n+[#str_box_extras]: https://github.com/rust-lang/rust/issues/41119\n+\n+------------------------\n+\n+"}, {"sha": "b03e3bb7a4bdc9afa4e0bd8cb8361166c4188f83", "filename": "src/liballoc/boxed.rs", "status": "modified", "additions": 13, "deletions": 5, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Fliballoc%2Fboxed.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Fliballoc%2Fboxed.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Fboxed.rs?ref=dad9814eb0964a92494fef9ce23b80353dc14c46", "patch": "@@ -68,6 +68,7 @@ use core::ops::{CoerceUnsized, Deref, DerefMut};\n use core::ops::{BoxPlace, Boxed, InPlace, Place, Placer};\n use core::ptr::{self, Unique};\n use core::convert::From;\n+use str::from_boxed_utf8_unchecked;\n \n /// A value that represents the heap. This is the default place that the `box`\n /// keyword allocates into when no place is supplied.\n@@ -320,8 +321,7 @@ impl<T> Default for Box<[T]> {\n #[stable(feature = \"default_box_extra\", since = \"1.17.0\")]\n impl Default for Box<str> {\n     fn default() -> Box<str> {\n-        let default: Box<[u8]> = Default::default();\n-        unsafe { mem::transmute(default) }\n+        unsafe { from_boxed_utf8_unchecked(Default::default()) }\n     }\n }\n \n@@ -366,7 +366,7 @@ impl Clone for Box<str> {\n         let buf = RawVec::with_capacity(len);\n         unsafe {\n             ptr::copy_nonoverlapping(self.as_ptr(), buf.ptr(), len);\n-            mem::transmute(buf.into_box()) // bytes to str ~magic\n+            from_boxed_utf8_unchecked(buf.into_box())\n         }\n     }\n }\n@@ -441,8 +441,16 @@ impl<'a, T: Copy> From<&'a [T]> for Box<[T]> {\n #[stable(feature = \"box_from_slice\", since = \"1.17.0\")]\n impl<'a> From<&'a str> for Box<str> {\n     fn from(s: &'a str) -> Box<str> {\n-        let boxed: Box<[u8]> = Box::from(s.as_bytes());\n-        unsafe { mem::transmute(boxed) }\n+        unsafe { from_boxed_utf8_unchecked(Box::from(s.as_bytes())) }\n+    }\n+}\n+\n+#[stable(feature = \"boxed_str_conv\", since = \"1.18.0\")]\n+impl From<Box<str>> for Box<[u8]> {\n+    fn from(s: Box<str>) -> Self {\n+        unsafe {\n+            mem::transmute(s)\n+        }\n     }\n }\n "}, {"sha": "fee0e1eb2608380389ae435becb44d565c0e7404", "filename": "src/liballoc/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Fliballoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Fliballoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Flib.rs?ref=dad9814eb0964a92494fef9ce23b80353dc14c46", "patch": "@@ -129,6 +129,8 @@ mod boxed_test;\n pub mod arc;\n pub mod rc;\n pub mod raw_vec;\n+#[unstable(feature = \"str_box_extras\", issue = \"41119\")]\n+pub mod str;\n pub mod oom;\n \n pub use oom::oom;"}, {"sha": "c87db16a0f417595c1bacc46c4b5df12c7d33ac7", "filename": "src/liballoc/str.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Fliballoc%2Fstr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Fliballoc%2Fstr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Fstr.rs?ref=dad9814eb0964a92494fef9ce23b80353dc14c46", "patch": "@@ -0,0 +1,21 @@\n+// Copyright 2012-2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+//! Methods for dealing with boxed strings.\n+use core::mem;\n+\n+use boxed::Box;\n+\n+/// Converts a boxed slice of bytes to a boxed string slice without checking\n+/// that the string contains valid UTF-8.\n+#[unstable(feature = \"str_box_extras\", issue = \"41119\")]\n+pub unsafe fn from_boxed_utf8_unchecked(v: Box<[u8]>) -> Box<str> {\n+    mem::transmute(v)\n+}"}, {"sha": "842f2f44fff9e8166652695f93e50fdfdf96ca9c", "filename": "src/libcollections/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Flibcollections%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Flibcollections%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Flib.rs?ref=dad9814eb0964a92494fef9ce23b80353dc14c46", "patch": "@@ -60,6 +60,7 @@\n #![feature(specialization)]\n #![feature(staged_api)]\n #![feature(str_internals)]\n+#![feature(str_box_extras)]\n #![feature(str_mut_extras)]\n #![feature(trusted_len)]\n #![feature(unicode)]"}, {"sha": "964660183e751c31f6a465e248c7e37b28ba74a3", "filename": "src/libcollections/str.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Flibcollections%2Fstr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Flibcollections%2Fstr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fstr.rs?ref=dad9814eb0964a92494fef9ce23b80353dc14c46", "patch": "@@ -70,14 +70,17 @@ pub use core::str::{Matches, RMatches};\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n pub use core::str::{MatchIndices, RMatchIndices};\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-pub use core::str::{from_utf8, Chars, CharIndices, Bytes};\n+pub use core::str::{from_utf8, from_utf8_mut, Chars, CharIndices, Bytes};\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n pub use core::str::{from_utf8_unchecked, from_utf8_unchecked_mut, ParseBoolError};\n+#[unstable(feature = \"str_box_extras\", issue = \"41119\")]\n+pub use alloc::str::from_boxed_utf8_unchecked;\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n pub use std_unicode::str::SplitWhitespace;\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n pub use core::str::pattern;\n \n+\n #[unstable(feature = \"slice_concat_ext\",\n            reason = \"trait should not have to exist\",\n            issue = \"27747\")]\n@@ -1715,6 +1718,12 @@ impl str {\n         core_str::StrExt::parse(self)\n     }\n \n+    /// Converts a `Box<str>` into a `Box<[u8]>` without copying or allocating.\n+    #[unstable(feature = \"str_box_extras\", issue = \"41119\")]\n+    pub fn into_boxed_bytes(self: Box<str>) -> Box<[u8]> {\n+        self.into()\n+    }\n+\n     /// Replaces all matches of a pattern with another string.\n     ///\n     /// `replace` creates a new [`String`], and copies the data from this string slice into it."}, {"sha": "aa9628c535a997fb18939a2a7f66a85c61f10acb", "filename": "src/libcollections/string.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Flibcollections%2Fstring.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dad9814eb0964a92494fef9ce23b80353dc14c46/src%2Flibcollections%2Fstring.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fstring.rs?ref=dad9814eb0964a92494fef9ce23b80353dc14c46", "patch": "@@ -56,10 +56,11 @@\n \n #![stable(feature = \"rust1\", since = \"1.0.0\")]\n \n+use alloc::str as alloc_str;\n+\n use core::fmt;\n use core::hash;\n use core::iter::{FromIterator, FusedIterator};\n-use core::mem;\n use core::ops::{self, Add, AddAssign, Index, IndexMut};\n use core::ptr;\n use core::str as core_str;\n@@ -1463,7 +1464,7 @@ impl String {\n     #[stable(feature = \"box_str\", since = \"1.4.0\")]\n     pub fn into_boxed_str(self) -> Box<str> {\n         let slice = self.vec.into_boxed_slice();\n-        unsafe { mem::transmute::<Box<[u8]>, Box<str>>(slice) }\n+        unsafe { alloc_str::from_boxed_utf8_unchecked(slice) }\n     }\n }\n "}]}