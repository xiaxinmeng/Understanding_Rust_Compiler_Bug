{"sha": "72ab4b4f0128cc94c5e0281ab48e68597d9c0d51", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcyYWI0YjRmMDEyOGNjOTRjNWUwMjgxYWI0OGU2ODU5N2Q5YzBkNTE=", "commit": {"author": {"name": "Matt Brubeck", "email": "mbrubeck@limpet.net", "date": "2018-05-29T18:26:10Z"}, "committer": {"name": "Matt Brubeck", "email": "mbrubeck@limpet.net", "date": "2018-05-31T13:37:53Z"}, "message": "Add std/core to prelude if extern_prelude enabled\n\nFixes #50605", "tree": {"sha": "01ffb795aab89778299d668981ddc1a3c9f615dd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/01ffb795aab89778299d668981ddc1a3c9f615dd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/72ab4b4f0128cc94c5e0281ab48e68597d9c0d51", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/72ab4b4f0128cc94c5e0281ab48e68597d9c0d51", "html_url": "https://github.com/rust-lang/rust/commit/72ab4b4f0128cc94c5e0281ab48e68597d9c0d51", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/72ab4b4f0128cc94c5e0281ab48e68597d9c0d51/comments", "author": {"login": "mbrubeck", "id": 5920, "node_id": "MDQ6VXNlcjU5MjA=", "avatar_url": "https://avatars.githubusercontent.com/u/5920?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mbrubeck", "html_url": "https://github.com/mbrubeck", "followers_url": "https://api.github.com/users/mbrubeck/followers", "following_url": "https://api.github.com/users/mbrubeck/following{/other_user}", "gists_url": "https://api.github.com/users/mbrubeck/gists{/gist_id}", "starred_url": "https://api.github.com/users/mbrubeck/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mbrubeck/subscriptions", "organizations_url": "https://api.github.com/users/mbrubeck/orgs", "repos_url": "https://api.github.com/users/mbrubeck/repos", "events_url": "https://api.github.com/users/mbrubeck/events{/privacy}", "received_events_url": "https://api.github.com/users/mbrubeck/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mbrubeck", "id": 5920, "node_id": "MDQ6VXNlcjU5MjA=", "avatar_url": "https://avatars.githubusercontent.com/u/5920?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mbrubeck", "html_url": "https://github.com/mbrubeck", "followers_url": "https://api.github.com/users/mbrubeck/followers", "following_url": "https://api.github.com/users/mbrubeck/following{/other_user}", "gists_url": "https://api.github.com/users/mbrubeck/gists{/gist_id}", "starred_url": "https://api.github.com/users/mbrubeck/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mbrubeck/subscriptions", "organizations_url": "https://api.github.com/users/mbrubeck/orgs", "repos_url": "https://api.github.com/users/mbrubeck/repos", "events_url": "https://api.github.com/users/mbrubeck/events{/privacy}", "received_events_url": "https://api.github.com/users/mbrubeck/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "30cae5870907e7ae9e74a39eee5bcf55ee5d2809", "url": "https://api.github.com/repos/rust-lang/rust/commits/30cae5870907e7ae9e74a39eee5bcf55ee5d2809", "html_url": "https://github.com/rust-lang/rust/commit/30cae5870907e7ae9e74a39eee5bcf55ee5d2809"}], "stats": {"total": 61, "additions": 60, "deletions": 1}, "files": [{"sha": "453627f3c36b99636308526bbdc1b1f520764287", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/72ab4b4f0128cc94c5e0281ab48e68597d9c0d51/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/72ab4b4f0128cc94c5e0281ab48e68597d9c0d51/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=72ab4b4f0128cc94c5e0281ab48e68597d9c0d51", "patch": "@@ -1610,6 +1610,16 @@ impl<'a> Resolver<'a> {\n         DefCollector::new(&mut definitions, Mark::root())\n             .collect_root(crate_name, session.local_crate_disambiguator());\n \n+        let mut extern_prelude: FxHashSet<Name> =\n+            session.opts.externs.iter().map(|kv| Symbol::intern(kv.0)).collect();\n+        if !attr::contains_name(&krate.attrs, \"no_core\") {\n+            if !attr::contains_name(&krate.attrs, \"no_std\") {\n+                extern_prelude.insert(Symbol::intern(\"std\"));\n+            } else {\n+                extern_prelude.insert(Symbol::intern(\"core\"));\n+            }\n+        }\n+\n         let mut invocations = FxHashMap();\n         invocations.insert(Mark::root(),\n                            arenas.alloc_invocation_data(InvocationData::root(graph_root)));\n@@ -1630,7 +1640,7 @@ impl<'a> Resolver<'a> {\n             // AST.\n             graph_root,\n             prelude: None,\n-            extern_prelude: session.opts.externs.iter().map(|kv| Symbol::intern(kv.0)).collect(),\n+            extern_prelude,\n \n             has_self: FxHashSet(),\n             field_names: FxHashMap(),"}, {"sha": "d0d01b34c6e92e4aaf12207c021f58e9670111bd", "filename": "src/test/run-pass/extern-prelude-core.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/72ab4b4f0128cc94c5e0281ab48e68597d9c0d51/src%2Ftest%2Frun-pass%2Fextern-prelude-core.rs", "raw_url": "https://github.com/rust-lang/rust/raw/72ab4b4f0128cc94c5e0281ab48e68597d9c0d51/src%2Ftest%2Frun-pass%2Fextern-prelude-core.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fextern-prelude-core.rs?ref=72ab4b4f0128cc94c5e0281ab48e68597d9c0d51", "patch": "@@ -0,0 +1,27 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(extern_prelude, lang_items, start, alloc)]\n+#![no_std]\n+\n+extern crate std as other;\n+\n+mod foo {\n+    pub fn test() {\n+        let x = core::cmp::min(2, 3);\n+        assert_eq!(x, 2);\n+    }\n+}\n+\n+#[start]\n+fn start(_argc: isize, _argv: *const *const u8) -> isize {\n+    foo::test();\n+    0\n+}"}, {"sha": "de73f1d22783e7db3191c55591ba6d95a2080c66", "filename": "src/test/run-pass/extern-prelude-std.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/72ab4b4f0128cc94c5e0281ab48e68597d9c0d51/src%2Ftest%2Frun-pass%2Fextern-prelude-std.rs", "raw_url": "https://github.com/rust-lang/rust/raw/72ab4b4f0128cc94c5e0281ab48e68597d9c0d51/src%2Ftest%2Frun-pass%2Fextern-prelude-std.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fextern-prelude-std.rs?ref=72ab4b4f0128cc94c5e0281ab48e68597d9c0d51", "patch": "@@ -0,0 +1,22 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(extern_prelude)]\n+\n+mod foo {\n+    pub fn test() {\n+        let x = std::cmp::min(2, 3);\n+        assert_eq!(x, 2);\n+    }\n+}\n+\n+fn main() {\n+    foo::test();\n+}"}]}