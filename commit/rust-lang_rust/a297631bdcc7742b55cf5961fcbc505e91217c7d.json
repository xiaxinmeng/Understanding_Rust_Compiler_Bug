{"sha": "a297631bdcc7742b55cf5961fcbc505e91217c7d", "node_id": "C_kwDOAAsO6NoAKGEyOTc2MzFiZGNjNzc0MmI1NWNmNTk2MWZjYmM1MDVlOTEyMTdjN2Q", "commit": {"author": {"name": "KaDiWa", "email": "kalle.wachsmuth@gmail.com", "date": "2022-08-19T16:53:27Z"}, "committer": {"name": "KaDiWa", "email": "kalle.wachsmuth@gmail.com", "date": "2022-08-19T17:00:37Z"}, "message": "use <[u8]>::escape_ascii instead of core::ascii::escape_default", "tree": {"sha": "ffb205fe634306af914f19c6965466e95b2b7b0b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ffb205fe634306af914f19c6965466e95b2b7b0b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a297631bdcc7742b55cf5961fcbc505e91217c7d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEcFQWTVq3UZxSk8EiC1KuORxnTOUFAmL/wbUACgkQC1KuORxn\nTOW2SQ//am+d140addDp4r5qkkxK7j8nedNQm486BgEslJ5VLc3JYyg00ukEWJ4j\n+JAIUH0bb8szqWb8axzKRfqM3oo+gPUAfUCX2lT8WYEsJnSA/Foe0tsHzdbJvwMA\n3nqgwLiu31W+IzSCD8BgfC/1k4jetNmnChQ7jG8DzaELsWDqZGaB1Frx71Jg7EzY\nGxrvfvTdm0O6ast45K/hO4gJv53MDgqczZ3jxRTNE719Mj9WXnjVJmBPYYGGHWh+\n3DrbbN/CzbJnXimdL3FXjZSvh+LfQ6oZ6Xv0/xfimiQzmS9Hyq/meWC4GaaSmusY\nL4q9RRX261ErrzA2k1dw6LObFWp4K/Ue2GgbpCwHGXYVPDEXuNt/etj7Mmyjz8vf\nYN2V6OiXLCi5vpadcdTa4aXUoh8zV+Vd/7IxaLtwCCAQCwSKKJbwUhCXyzRFs+n8\nVZ0MnJslPnV9gOey2dYg+L9xsROOuKM7dJbryCzCRnH5aiS3ZZANjrA4I08LI2i3\nfhoTd23MAVzoBVWYSkclilF4Xv8YBfox8e2NKCJ3yE5xrK5d2OeeHfZHH+qq0SPN\nnWuMtK6vpyW5huFQqOZk1QrHSk6YljXJGjyOdvUrLEVpjwJ/vCz45NHJmgvXkvOk\nUAsqv6rjf7DJGtMGxW3Tbr8uvpPL1LuGSeRutBf5zwD44STaEZ0=\n=H8Fh\n-----END PGP SIGNATURE-----", "payload": "tree ffb205fe634306af914f19c6965466e95b2b7b0b\nparent 6c943bad02626dddc5e5135b23c77429b6e4a063\nauthor KaDiWa <kalle.wachsmuth@gmail.com> 1660928007 +0200\ncommitter KaDiWa <kalle.wachsmuth@gmail.com> 1660928437 +0200\n\nuse <[u8]>::escape_ascii instead of core::ascii::escape_default\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a297631bdcc7742b55cf5961fcbc505e91217c7d", "html_url": "https://github.com/rust-lang/rust/commit/a297631bdcc7742b55cf5961fcbc505e91217c7d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a297631bdcc7742b55cf5961fcbc505e91217c7d/comments", "author": {"login": "kadiwa4", "id": 25464294, "node_id": "MDQ6VXNlcjI1NDY0Mjk0", "avatar_url": "https://avatars.githubusercontent.com/u/25464294?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kadiwa4", "html_url": "https://github.com/kadiwa4", "followers_url": "https://api.github.com/users/kadiwa4/followers", "following_url": "https://api.github.com/users/kadiwa4/following{/other_user}", "gists_url": "https://api.github.com/users/kadiwa4/gists{/gist_id}", "starred_url": "https://api.github.com/users/kadiwa4/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kadiwa4/subscriptions", "organizations_url": "https://api.github.com/users/kadiwa4/orgs", "repos_url": "https://api.github.com/users/kadiwa4/repos", "events_url": "https://api.github.com/users/kadiwa4/events{/privacy}", "received_events_url": "https://api.github.com/users/kadiwa4/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kadiwa4", "id": 25464294, "node_id": "MDQ6VXNlcjI1NDY0Mjk0", "avatar_url": "https://avatars.githubusercontent.com/u/25464294?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kadiwa4", "html_url": "https://github.com/kadiwa4", "followers_url": "https://api.github.com/users/kadiwa4/followers", "following_url": "https://api.github.com/users/kadiwa4/following{/other_user}", "gists_url": "https://api.github.com/users/kadiwa4/gists{/gist_id}", "starred_url": "https://api.github.com/users/kadiwa4/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kadiwa4/subscriptions", "organizations_url": "https://api.github.com/users/kadiwa4/orgs", "repos_url": "https://api.github.com/users/kadiwa4/repos", "events_url": "https://api.github.com/users/kadiwa4/events{/privacy}", "received_events_url": "https://api.github.com/users/kadiwa4/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6c943bad02626dddc5e5135b23c77429b6e4a063", "url": "https://api.github.com/repos/rust-lang/rust/commits/6c943bad02626dddc5e5135b23c77429b6e4a063", "html_url": "https://github.com/rust-lang/rust/commit/6c943bad02626dddc5e5135b23c77429b6e4a063"}], "stats": {"total": 83, "additions": 16, "deletions": 67}, "files": [{"sha": "8b84631ea76ae94f43b891ea0a6980e7a5c1c44c", "filename": "compiler/rustc_ast/src/util/literal.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a297631bdcc7742b55cf5961fcbc505e91217c7d/compiler%2Frustc_ast%2Fsrc%2Futil%2Fliteral.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a297631bdcc7742b55cf5961fcbc505e91217c7d/compiler%2Frustc_ast%2Fsrc%2Futil%2Fliteral.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Futil%2Fliteral.rs?ref=a297631bdcc7742b55cf5961fcbc505e91217c7d", "patch": "@@ -164,12 +164,7 @@ impl LitKind {\n             }\n             LitKind::Str(symbol, ast::StrStyle::Raw(n)) => (token::StrRaw(n), symbol, None),\n             LitKind::ByteStr(ref bytes) => {\n-                let string = bytes\n-                    .iter()\n-                    .cloned()\n-                    .flat_map(ascii::escape_default)\n-                    .map(Into::<char>::into)\n-                    .collect::<String>();\n+                let string = bytes.escape_ascii().to_string();\n                 (token::ByteStr, Symbol::intern(&string), None)\n             }\n             LitKind::Byte(byte) => {"}, {"sha": "5be7fec230c7bf5e85847f378d6ecf4cf1cf72eb", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 8, "deletions": 17, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/a297631bdcc7742b55cf5961fcbc505e91217c7d/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a297631bdcc7742b55cf5961fcbc505e91217c7d/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=a297631bdcc7742b55cf5961fcbc505e91217c7d", "patch": "@@ -44,7 +44,7 @@ use std::io::{BufWriter, Write};\n use std::ops::Deref;\n use std::path::{Path, PathBuf};\n use std::process::{ExitStatus, Output, Stdio};\n-use std::{ascii, char, env, fmt, fs, io, mem, str};\n+use std::{env, fmt, fs, io, mem, str};\n \n pub fn ensure_removed(diag_handler: &Handler, path: &Path) {\n     if let Err(e) = fs::remove_file(path) {\n@@ -552,14 +552,6 @@ fn link_staticlib<'a>(\n     Ok(())\n }\n \n-fn escape_stdout_stderr_string(s: &[u8]) -> String {\n-    str::from_utf8(s).map(|s| s.to_owned()).unwrap_or_else(|_| {\n-        let mut x = \"Non-UTF-8 output: \".to_string();\n-        x.extend(s.iter().flat_map(|&b| ascii::escape_default(b)).map(char::from));\n-        x\n-    })\n-}\n-\n /// Use `thorin` (rust implementation of a dwarf packaging utility) to link DWARF objects into a\n /// DWARF package.\n fn link_dwarf_object<'a>(\n@@ -866,7 +858,7 @@ fn link_natively<'a>(\n             if !prog.status.success() {\n                 let mut output = prog.stderr.clone();\n                 output.extend_from_slice(&prog.stdout);\n-                let escaped_output = escape_stdout_stderr_string(&output);\n+                let escaped_output = escape_string(&output);\n                 let mut err = sess.struct_err(&format!(\n                     \"linking with `{}` failed: {}\",\n                     linker_path.display(),\n@@ -934,8 +926,8 @@ fn link_natively<'a>(\n \n                 sess.abort_if_errors();\n             }\n-            info!(\"linker stderr:\\n{}\", escape_stdout_stderr_string(&prog.stderr));\n-            info!(\"linker stdout:\\n{}\", escape_stdout_stderr_string(&prog.stdout));\n+            info!(\"linker stderr:\\n{}\", escape_string(&prog.stderr));\n+            info!(\"linker stdout:\\n{}\", escape_string(&prog.stdout));\n         }\n         Err(e) => {\n             let linker_not_found = e.kind() == io::ErrorKind::NotFound;\n@@ -1065,11 +1057,10 @@ fn strip_symbols_in_osx<'a>(sess: &'a Session, out_filename: &Path, option: Opti\n }\n \n fn escape_string(s: &[u8]) -> String {\n-    str::from_utf8(s).map(|s| s.to_owned()).unwrap_or_else(|_| {\n-        let mut x = \"Non-UTF-8 output: \".to_string();\n-        x.extend(s.iter().flat_map(|&b| ascii::escape_default(b)).map(char::from));\n-        x\n-    })\n+    match str::from_utf8(s) {\n+        Ok(s) => s.to_owned(),\n+        Err(_) => format!(\"Non-UTF-8 output: {}\", s.escape_ascii()),\n+    }\n }\n \n fn add_sanitizer_libraries(sess: &Session, crate_type: CrateType, linker: &mut dyn Linker) {"}, {"sha": "d3a205a533dbd1d08e0e83cb54afc2068603cfae", "filename": "compiler/rustc_middle/src/mir/mod.rs", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/a297631bdcc7742b55cf5961fcbc505e91217c7d/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a297631bdcc7742b55cf5961fcbc505e91217c7d/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs?ref=a297631bdcc7742b55cf5961fcbc505e91217c7d", "patch": "@@ -2643,15 +2643,7 @@ fn pretty_print_const<'tcx>(\n }\n \n fn pretty_print_byte_str(fmt: &mut Formatter<'_>, byte_str: &[u8]) -> fmt::Result {\n-    fmt.write_str(\"b\\\"\")?;\n-    for &c in byte_str {\n-        for e in std::ascii::escape_default(c) {\n-            fmt.write_char(e as char)?;\n-        }\n-    }\n-    fmt.write_str(\"\\\"\")?;\n-\n-    Ok(())\n+    write!(fmt, \"b\\\"{}\\\"\", byte_str.escape_ascii())\n }\n \n fn comma_sep<'tcx>(fmt: &mut Formatter<'_>, elems: Vec<ConstantKind<'tcx>>) -> fmt::Result {"}, {"sha": "753c92f8885cfb653b75939bbab2d7cf8ce14a85", "filename": "compiler/rustc_middle/src/ty/print/pretty.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a297631bdcc7742b55cf5961fcbc505e91217c7d/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a297631bdcc7742b55cf5961fcbc505e91217c7d/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs?ref=a297631bdcc7742b55cf5961fcbc505e91217c7d", "patch": "@@ -1401,14 +1401,7 @@ pub trait PrettyPrinter<'tcx>:\n     }\n \n     fn pretty_print_byte_str(mut self, byte_str: &'tcx [u8]) -> Result<Self::Const, Self::Error> {\n-        define_scoped_cx!(self);\n-        p!(\"b\\\"\");\n-        for &c in byte_str {\n-            for e in std::ascii::escape_default(c) {\n-                self.write_char(e as char)?;\n-            }\n-        }\n-        p!(\"\\\"\");\n+        write!(self, \"b\\\"{}\\\"\", byte_str.escape_ascii())?;\n         Ok(self)\n     }\n "}, {"sha": "970830045b8124667964bd6e8d3dd51333b2f284", "filename": "library/core/src/ffi/c_str.rs", "status": "modified", "additions": 2, "deletions": 7, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a297631bdcc7742b55cf5961fcbc505e91217c7d/library%2Fcore%2Fsrc%2Fffi%2Fc_str.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a297631bdcc7742b55cf5961fcbc505e91217c7d/library%2Fcore%2Fsrc%2Fffi%2Fc_str.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fffi%2Fc_str.rs?ref=a297631bdcc7742b55cf5961fcbc505e91217c7d", "patch": "@@ -1,7 +1,6 @@\n-use crate::ascii;\n use crate::cmp::Ordering;\n use crate::ffi::c_char;\n-use crate::fmt::{self, Write};\n+use crate::fmt;\n use crate::intrinsics;\n use crate::ops;\n use crate::slice;\n@@ -161,11 +160,7 @@ impl fmt::Display for FromBytesUntilNulError {\n #[stable(feature = \"cstr_debug\", since = \"1.3.0\")]\n impl fmt::Debug for CStr {\n     fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n-        write!(f, \"\\\"\")?;\n-        for byte in self.to_bytes().iter().flat_map(|&b| ascii::escape_default(b)) {\n-            f.write_char(byte as char)?;\n-        }\n-        write!(f, \"\\\"\")\n+        write!(f, \"\\\"{}\\\"\", self.to_bytes().escape_ascii())\n     }\n }\n "}, {"sha": "495c1c5ae46c155bb0877a3a22dbc5756f3b2a83", "filename": "library/proc_macro/src/lib.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a297631bdcc7742b55cf5961fcbc505e91217c7d/library%2Fproc_macro%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a297631bdcc7742b55cf5961fcbc505e91217c7d/library%2Fproc_macro%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fproc_macro%2Fsrc%2Flib.rs?ref=a297631bdcc7742b55cf5961fcbc505e91217c7d", "patch": "@@ -1353,12 +1353,7 @@ impl Literal {\n     /// Byte string literal.\n     #[stable(feature = \"proc_macro_lib2\", since = \"1.29.0\")]\n     pub fn byte_string(bytes: &[u8]) -> Literal {\n-        let string = bytes\n-            .iter()\n-            .cloned()\n-            .flat_map(std::ascii::escape_default)\n-            .map(Into::<char>::into)\n-            .collect::<String>();\n+        let string = bytes.escape_ascii().to_string();\n         Literal::new(bridge::LitKind::ByteStr, &string, None)\n     }\n "}, {"sha": "6fcf9351256df9c7b153f1c4bb5bdd6a5f93e673", "filename": "library/std/src/os/unix/net/addr.rs", "status": "modified", "additions": 2, "deletions": 14, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/a297631bdcc7742b55cf5961fcbc505e91217c7d/library%2Fstd%2Fsrc%2Fos%2Funix%2Fnet%2Faddr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a297631bdcc7742b55cf5961fcbc505e91217c7d/library%2Fstd%2Fsrc%2Fos%2Funix%2Fnet%2Faddr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fos%2Funix%2Fnet%2Faddr.rs?ref=a297631bdcc7742b55cf5961fcbc505e91217c7d", "patch": "@@ -2,7 +2,7 @@ use crate::ffi::OsStr;\n use crate::os::unix::ffi::OsStrExt;\n use crate::path::Path;\n use crate::sys::cvt;\n-use crate::{ascii, fmt, io, mem, ptr};\n+use crate::{fmt, io, mem, ptr};\n \n // FIXME(#43348): Make libc adapt #[doc(cfg(...))] so we don't need these fake definitions here?\n #[cfg(not(unix))]\n@@ -64,18 +64,6 @@ enum AddressKind<'a> {\n     Abstract(&'a [u8]),\n }\n \n-struct AsciiEscaped<'a>(&'a [u8]);\n-\n-impl<'a> fmt::Display for AsciiEscaped<'a> {\n-    fn fmt(&self, fmt: &mut fmt::Formatter<'_>) -> fmt::Result {\n-        write!(fmt, \"\\\"\")?;\n-        for byte in self.0.iter().cloned().flat_map(ascii::escape_default) {\n-            write!(fmt, \"{}\", byte as char)?;\n-        }\n-        write!(fmt, \"\\\"\")\n-    }\n-}\n-\n /// An address associated with a Unix socket.\n ///\n /// # Examples\n@@ -343,7 +331,7 @@ impl fmt::Debug for SocketAddr {\n     fn fmt(&self, fmt: &mut fmt::Formatter<'_>) -> fmt::Result {\n         match self.address() {\n             AddressKind::Unnamed => write!(fmt, \"(unnamed)\"),\n-            AddressKind::Abstract(name) => write!(fmt, \"{} (abstract)\", AsciiEscaped(name)),\n+            AddressKind::Abstract(name) => write!(fmt, \"\\\"{}\\\" (abstract)\", name.escape_ascii()),\n             AddressKind::Pathname(path) => write!(fmt, \"{path:?} (pathname)\"),\n         }\n     }"}]}