{"sha": "30165e059c0a111a53020108686b6fd11fcc1d03", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMwMTY1ZTA1OWMwYTExMWE1MzAyMDEwODY4NmI2ZmQxMWZjYzFkMDM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-03-22T11:56:49Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-03-22T11:56:49Z"}, "message": "auto merge of #13052 : sfackler/rust/clean-refcell, r=alexcrichton\n\nThese are superfluous now that we have fixed rvalue lifetimes and Deref.\r\n\r\nI'd also like to kill off `get` and `set`, but that'll be a large change so I want to make sure that we actually want to do that first.", "tree": {"sha": "01b0aed8f6ae7a510cf52699b0dea7b1143b2688", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/01b0aed8f6ae7a510cf52699b0dea7b1143b2688"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/30165e059c0a111a53020108686b6fd11fcc1d03", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/30165e059c0a111a53020108686b6fd11fcc1d03", "html_url": "https://github.com/rust-lang/rust/commit/30165e059c0a111a53020108686b6fd11fcc1d03", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/30165e059c0a111a53020108686b6fd11fcc1d03/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "092afdba3c81d122b4b24aa49dd445023b5daef6", "url": "https://api.github.com/repos/rust-lang/rust/commits/092afdba3c81d122b4b24aa49dd445023b5daef6", "html_url": "https://github.com/rust-lang/rust/commit/092afdba3c81d122b4b24aa49dd445023b5daef6"}, {"sha": "1d98fe12a8b2ad954f01935552d23643e96a53af", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d98fe12a8b2ad954f01935552d23643e96a53af", "html_url": "https://github.com/rust-lang/rust/commit/1d98fe12a8b2ad954f01935552d23643e96a53af"}], "stats": {"total": 113, "additions": 23, "deletions": 90}, "files": [{"sha": "14244d7d2e9158e4639de975a6ac14f8e702e74d", "filename": "src/librustc/driver/driver.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/30165e059c0a111a53020108686b6fd11fcc1d03/src%2Flibrustc%2Fdriver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/30165e059c0a111a53020108686b6fd11fcc1d03/src%2Flibrustc%2Fdriver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdriver%2Fdriver.rs?ref=30165e059c0a111a53020108686b6fd11fcc1d03", "patch": "@@ -313,10 +313,10 @@ pub fn phase_3_run_analysis_passes(sess: Session,\n     time(time_passes, \"looking for entry point\", (),\n          |_| middle::entry::find_entry_point(&sess, krate, &ast_map));\n \n-    sess.macro_registrar_fn.with_mut(|r| *r =\n+    *sess.macro_registrar_fn.borrow_mut() =\n         time(time_passes, \"looking for macro registrar\", (), |_|\n             syntax::ext::registrar::find_macro_registrar(\n-                sess.diagnostic(), krate)));\n+                sess.diagnostic(), krate));\n \n     let freevars = time(time_passes, \"freevar finding\", (), |_|\n                         freevars::annotate_freevars(def_map, krate));"}, {"sha": "f1089891ea5fb464a497c57f287367ceaee22301", "filename": "src/librustc/metadata/cstore.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/30165e059c0a111a53020108686b6fd11fcc1d03/src%2Flibrustc%2Fmetadata%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/30165e059c0a111a53020108686b6fd11fcc1d03/src%2Flibrustc%2Fmetadata%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Fcstore.rs?ref=30165e059c0a111a53020108686b6fd11fcc1d03", "patch": "@@ -135,11 +135,11 @@ impl CStore {\n     }\n \n     pub fn reset(&self) {\n-        self.metas.with_mut(|s| s.clear());\n-        self.extern_mod_crate_map.with_mut(|s| s.clear());\n-        self.used_crate_sources.with_mut(|s| s.clear());\n-        self.used_libraries.with_mut(|s| s.clear());\n-        self.used_link_args.with_mut(|s| s.clear());\n+        self.metas.borrow_mut().clear();\n+        self.extern_mod_crate_map.borrow_mut().clear();\n+        self.used_crate_sources.borrow_mut().clear();\n+        self.used_libraries.borrow_mut().clear();\n+        self.used_link_args.borrow_mut().clear();\n     }\n \n     // This method is used when generating the command line to pass through to"}, {"sha": "b54396efec505c68c0ca9d13c380e00251c9fb23", "filename": "src/libstd/cell.rs", "status": "modified", "additions": 12, "deletions": 75, "changes": 87, "blob_url": "https://github.com/rust-lang/rust/blob/30165e059c0a111a53020108686b6fd11fcc1d03/src%2Flibstd%2Fcell.rs", "raw_url": "https://github.com/rust-lang/rust/raw/30165e059c0a111a53020108686b6fd11fcc1d03/src%2Flibstd%2Fcell.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fcell.rs?ref=30165e059c0a111a53020108686b6fd11fcc1d03", "patch": "@@ -22,19 +22,17 @@ use ty::Unsafe;\n /// A mutable memory location that admits only `Pod` data.\n pub struct Cell<T> {\n     priv value: Unsafe<T>,\n-    priv marker1: marker::InvariantType<T>,\n-    priv marker2: marker::NoFreeze,\n-    priv marker3: marker::NoShare,\n+    priv marker1: marker::NoFreeze,\n+    priv marker2: marker::NoShare,\n }\n \n impl<T:Pod> Cell<T> {\n     /// Creates a new `Cell` containing the given value.\n     pub fn new(value: T) -> Cell<T> {\n         Cell {\n-            value: Unsafe{value: value, marker1: marker::InvariantType::<T>},\n-            marker1: marker::InvariantType::<T>,\n-            marker2: marker::NoFreeze,\n-            marker3: marker::NoShare,\n+            value: Unsafe::new(value),\n+            marker1: marker::NoFreeze,\n+            marker2: marker::NoShare,\n         }\n     }\n \n@@ -75,10 +73,9 @@ impl<T: fmt::Show> fmt::Show for Cell<T> {\n pub struct RefCell<T> {\n     priv value: Unsafe<T>,\n     priv borrow: BorrowFlag,\n-    priv marker1: marker::InvariantType<T>,\n-    priv marker2: marker::NoFreeze,\n-    priv marker3: marker::NoPod,\n-    priv marker4: marker::NoShare,\n+    priv marker1: marker::NoFreeze,\n+    priv marker2: marker::NoPod,\n+    priv marker3: marker::NoShare,\n }\n \n // Values [1, MAX-1] represent the number of `Ref` active\n@@ -91,11 +88,10 @@ impl<T> RefCell<T> {\n     /// Create a new `RefCell` containing `value`\n     pub fn new(value: T) -> RefCell<T> {\n         RefCell {\n-            marker1: marker::InvariantType::<T>,\n-            marker2: marker::NoFreeze,\n-            marker3: marker::NoPod,\n-            marker4: marker::NoShare,\n-            value: Unsafe{value: value, marker1: marker::InvariantType::<T>},\n+            marker1: marker::NoFreeze,\n+            marker2: marker::NoPod,\n+            marker3: marker::NoShare,\n+            value: Unsafe::new(value),\n             borrow: UNUSED,\n         }\n     }\n@@ -173,28 +169,6 @@ impl<T> RefCell<T> {\n         }\n     }\n \n-    /// Immutably borrows the wrapped value and applies `blk` to it.\n-    ///\n-    /// # Failure\n-    ///\n-    /// Fails if the value is currently mutably borrowed.\n-    #[inline]\n-    pub fn with<U>(&self, blk: |&T| -> U) -> U {\n-        let ptr = self.borrow();\n-        blk(ptr.get())\n-    }\n-\n-    /// Mutably borrows the wrapped value and applies `blk` to it.\n-    ///\n-    /// # Failure\n-    ///\n-    /// Fails if the value is currently borrowed.\n-    #[inline]\n-    pub fn with_mut<U>(&self, blk: |&mut T| -> U) -> U {\n-        let mut ptr = self.borrow_mut();\n-        blk(ptr.get())\n-    }\n-\n     /// Sets the value, replacing what was there.\n     ///\n     /// # Failure\n@@ -372,43 +346,6 @@ mod test {\n         assert!(x.try_borrow_mut().is_none());\n     }\n \n-    #[test]\n-    fn with_ok() {\n-        let x = RefCell::new(0);\n-        assert_eq!(1, x.with(|x| *x+1));\n-    }\n-\n-    #[test]\n-    #[should_fail]\n-    fn mut_borrow_with() {\n-        let x = RefCell::new(0);\n-        let _b1 = x.borrow_mut();\n-        x.with(|x| *x+1);\n-    }\n-\n-    #[test]\n-    fn borrow_with() {\n-        let x = RefCell::new(0);\n-        let _b1 = x.borrow();\n-        assert_eq!(1, x.with(|x| *x+1));\n-    }\n-\n-    #[test]\n-    fn with_mut_ok() {\n-        let x = RefCell::new(0);\n-        x.with_mut(|x| *x += 1);\n-        let b = x.borrow();\n-        assert_eq!(1, *b.get());\n-    }\n-\n-    #[test]\n-    #[should_fail]\n-    fn borrow_with_mut() {\n-        let x = RefCell::new(0);\n-        let _b = x.borrow();\n-        x.with_mut(|x| *x += 1);\n-    }\n-\n     #[test]\n     #[should_fail]\n     fn discard_doesnt_unborrow() {"}, {"sha": "7fb23d77f3c6cb94b90c257a5e37ba0249e3f4e0", "filename": "src/libstd/gc.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/30165e059c0a111a53020108686b6fd11fcc1d03/src%2Flibstd%2Fgc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/30165e059c0a111a53020108686b6fd11fcc1d03/src%2Flibstd%2Fgc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fgc.rs?ref=30165e059c0a111a53020108686b6fd11fcc1d03", "patch": "@@ -87,10 +87,8 @@ mod tests {\n     fn test_clone() {\n         let x = Gc::new(RefCell::new(5));\n         let y = x.clone();\n-        x.borrow().with_mut(|inner| {\n-            *inner = 20;\n-        });\n-        assert_eq!(y.borrow().with(|x| *x), 20);\n+        *x.borrow().borrow_mut() = 20;\n+        assert_eq!(*y.borrow().borrow(), 20);\n     }\n \n     #[test]"}, {"sha": "03be4fea5eeb08650cbc562e32404ec7252e7acf", "filename": "src/libstd/rc.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/30165e059c0a111a53020108686b6fd11fcc1d03/src%2Flibstd%2Frc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/30165e059c0a111a53020108686b6fd11fcc1d03/src%2Flibstd%2Frc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Frc.rs?ref=30165e059c0a111a53020108686b6fd11fcc1d03", "patch": "@@ -229,10 +229,8 @@ mod tests {\n     fn test_clone() {\n         let x = Rc::new(RefCell::new(5));\n         let y = x.clone();\n-        x.deref().with_mut(|inner| {\n-            *inner = 20;\n-        });\n-        assert_eq!(y.deref().with(|v| *v), 20);\n+        *x.borrow_mut() = 20;\n+        assert_eq!(*y.borrow(), 20);\n     }\n \n     #[test]"}]}