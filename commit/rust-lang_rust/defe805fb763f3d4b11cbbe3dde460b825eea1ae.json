{"sha": "defe805fb763f3d4b11cbbe3dde460b825eea1ae", "node_id": "C_kwDOAAsO6NoAKGRlZmU4MDVmYjc2M2YzZDRiMTFjYmJlM2RkZTQ2MGI4MjVlZWExYWU", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-09-26T12:49:23Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-09-26T12:49:23Z"}, "message": "internal: fix and force-disable block validation ;-(\n\nOriginally we tried to maintain the invariant that `{}` always match.\nThat is, that in the parse tree the pair of corresponding `{}` is always\nfirst and last tokens of some nodes.\n\nWe had the code to validate that, but apparently it's been broken for\n**years** since we introduced tokens/nodes split. Fixing it now makes\nsome tests fail.\n\nIt's unclear if we want to keep this invariant: there's a strong\nmotivation for breaking it in the following case:\n\n```\nuse std::{ // unclosed paren\n\nfn main() {\n\n}\n\n} // don't actually want to pair up this with the one from `use`\n```\n\nSo let's fix the code, but disable it for the time being", "tree": {"sha": "1cb0a06d6cf0ffa03b9e48944c2b627d3fd99a65", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1cb0a06d6cf0ffa03b9e48944c2b627d3fd99a65"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/defe805fb763f3d4b11cbbe3dde460b825eea1ae", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/defe805fb763f3d4b11cbbe3dde460b825eea1ae", "html_url": "https://github.com/rust-lang/rust/commit/defe805fb763f3d4b11cbbe3dde460b825eea1ae", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/defe805fb763f3d4b11cbbe3dde460b825eea1ae/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "06181008551b4f920d6e91e1f6bc270d78428bc6", "url": "https://api.github.com/repos/rust-lang/rust/commits/06181008551b4f920d6e91e1f6bc270d78428bc6", "html_url": "https://github.com/rust-lang/rust/commit/06181008551b4f920d6e91e1f6bc270d78428bc6"}], "stats": {"total": 13, "additions": 5, "deletions": 8}, "files": [{"sha": "40460e18c36b59ffffd7b9c623a0d65144a38855", "filename": "crates/syntax/src/lib.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/defe805fb763f3d4b11cbbe3dde460b825eea1ae/crates%2Fsyntax%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/defe805fb763f3d4b11cbbe3dde460b825eea1ae/crates%2Fsyntax%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Flib.rs?ref=defe805fb763f3d4b11cbbe3dde460b825eea1ae", "patch": "@@ -162,10 +162,6 @@ impl SourceFile {\n         let (green, mut errors) = parsing::parse_text(text);\n         let root = SyntaxNode::new_root(green.clone());\n \n-        if cfg!(debug_assertions) {\n-            validation::validate_block_structure(&root);\n-        }\n-\n         errors.extend(validation::validate(&root));\n \n         assert_eq!(root.kind(), SyntaxKind::SOURCE_FILE);"}, {"sha": "0ddfd439dceb082dab0b85c320f9f749a97c5a10", "filename": "crates/syntax/src/syntax_node.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/defe805fb763f3d4b11cbbe3dde460b825eea1ae/crates%2Fsyntax%2Fsrc%2Fsyntax_node.rs", "raw_url": "https://github.com/rust-lang/rust/raw/defe805fb763f3d4b11cbbe3dde460b825eea1ae/crates%2Fsyntax%2Fsrc%2Fsyntax_node.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fsyntax_node.rs?ref=defe805fb763f3d4b11cbbe3dde460b825eea1ae", "patch": "@@ -47,7 +47,7 @@ impl SyntaxTreeBuilder {\n \n     pub fn finish(self) -> Parse<SyntaxNode> {\n         let (green, errors) = self.finish_raw();\n-        if cfg!(debug_assertions) {\n+        if cfg!(debug_assertions) && false {\n             let node = SyntaxNode::new_root(green.clone());\n             crate::validation::validate_block_structure(&node);\n         }"}, {"sha": "a7c469ffdf208cbd7ce3d8122f9df218846a73d7", "filename": "crates/syntax/src/validation.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/defe805fb763f3d4b11cbbe3dde460b825eea1ae/crates%2Fsyntax%2Fsrc%2Fvalidation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/defe805fb763f3d4b11cbbe3dde460b825eea1ae/crates%2Fsyntax%2Fsrc%2Fvalidation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fvalidation.rs?ref=defe805fb763f3d4b11cbbe3dde460b825eea1ae", "patch": "@@ -170,7 +170,7 @@ fn validate_literal(literal: ast::Literal, acc: &mut Vec<SyntaxError>) {\n \n pub(crate) fn validate_block_structure(root: &SyntaxNode) {\n     let mut stack = Vec::new();\n-    for node in root.descendants() {\n+    for node in root.descendants_with_tokens() {\n         match node.kind() {\n             T!['{'] => stack.push(node),\n             T!['}'] => {\n@@ -183,11 +183,12 @@ pub(crate) fn validate_block_structure(root: &SyntaxNode) {\n                         root,\n                     );\n                     assert!(\n-                        node.next_sibling().is_none() && pair.prev_sibling().is_none(),\n+                        node.next_sibling_or_token().is_none()\n+                            && pair.prev_sibling_or_token().is_none(),\n                         \"\\nfloating curlys at {:?}\\nfile:\\n{}\\nerror:\\n{}\\n\",\n                         node,\n                         root.text(),\n-                        node.text(),\n+                        node,\n                     );\n                 }\n             }"}]}