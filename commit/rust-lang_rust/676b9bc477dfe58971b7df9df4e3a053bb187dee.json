{"sha": "676b9bc477dfe58971b7df9df4e3a053bb187dee", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY3NmI5YmM0NzdkZmU1ODk3MWI3ZGY5ZGY0ZTNhMDUzYmIxODdkZWU=", "commit": {"author": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2020-03-03T23:04:57Z"}, "committer": {"name": "Josh Stone", "email": "cuviper@gmail.com", "date": "2020-03-09T01:44:12Z"}, "message": "unix: Don't override existing SIGSEGV/BUS handlers\n\nAlthough `stack_overflow::init` runs very early in the process, even\nbefore `main`, there may already be signal handlers installed for things\nlike the address sanitizer. In that case, just leave it alone, and don't\nbother trying to allocate our own signal stacks either.", "tree": {"sha": "02cf5638192c881ed7d17c5c5f496bd6e8efca37", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/02cf5638192c881ed7d17c5c5f496bd6e8efca37"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/676b9bc477dfe58971b7df9df4e3a053bb187dee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/676b9bc477dfe58971b7df9df4e3a053bb187dee", "html_url": "https://github.com/rust-lang/rust/commit/676b9bc477dfe58971b7df9df4e3a053bb187dee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/676b9bc477dfe58971b7df9df4e3a053bb187dee/comments", "author": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2cb0b8582ebbf9784db9cec06fff517badbf4553", "url": "https://api.github.com/repos/rust-lang/rust/commits/2cb0b8582ebbf9784db9cec06fff517badbf4553", "html_url": "https://github.com/rust-lang/rust/commit/2cb0b8582ebbf9784db9cec06fff517badbf4553"}], "stats": {"total": 47, "additions": 39, "deletions": 8}, "files": [{"sha": "9e8be55075578611593cf9e71f1f7c2972f90c44", "filename": "src/libstd/sys/unix/stack_overflow.rs", "status": "modified", "additions": 20, "deletions": 8, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/676b9bc477dfe58971b7df9df4e3a053bb187dee/src%2Flibstd%2Fsys%2Funix%2Fstack_overflow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/676b9bc477dfe58971b7df9df4e3a053bb187dee/src%2Flibstd%2Fsys%2Funix%2Fstack_overflow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Funix%2Fstack_overflow.rs?ref=676b9bc477dfe58971b7df9df4e3a053bb187dee", "patch": "@@ -13,6 +13,10 @@ impl Handler {\n     pub unsafe fn new() -> Handler {\n         make_handler()\n     }\n+\n+    fn null() -> Handler {\n+        Handler { _data: crate::ptr::null_mut() }\n+    }\n }\n \n impl Drop for Handler {\n@@ -108,13 +112,20 @@ mod imp {\n     }\n \n     static mut MAIN_ALTSTACK: *mut libc::c_void = ptr::null_mut();\n+    static mut NEED_ALTSTACK: bool = false;\n \n     pub unsafe fn init() {\n         let mut action: sigaction = mem::zeroed();\n-        action.sa_flags = SA_SIGINFO | SA_ONSTACK;\n-        action.sa_sigaction = signal_handler as sighandler_t;\n-        sigaction(SIGSEGV, &action, ptr::null_mut());\n-        sigaction(SIGBUS, &action, ptr::null_mut());\n+        for &signal in &[SIGSEGV, SIGBUS] {\n+            sigaction(signal, ptr::null_mut(), &mut action);\n+            // Configure our signal handler if one is not already set.\n+            if action.sa_sigaction == SIG_DFL {\n+                action.sa_flags = SA_SIGINFO | SA_ONSTACK;\n+                action.sa_sigaction = signal_handler as sighandler_t;\n+                sigaction(signal, &action, ptr::null_mut());\n+                NEED_ALTSTACK = true;\n+            }\n+        }\n \n         let handler = make_handler();\n         MAIN_ALTSTACK = handler._data;\n@@ -152,6 +163,9 @@ mod imp {\n     }\n \n     pub unsafe fn make_handler() -> Handler {\n+        if !NEED_ALTSTACK {\n+            return Handler::null();\n+        }\n         let mut stack = mem::zeroed();\n         sigaltstack(ptr::null(), &mut stack);\n         // Configure alternate signal stack, if one is not already set.\n@@ -160,7 +174,7 @@ mod imp {\n             sigaltstack(&stack, ptr::null_mut());\n             Handler { _data: stack.ss_sp as *mut libc::c_void }\n         } else {\n-            Handler { _data: ptr::null_mut() }\n+            Handler::null()\n         }\n     }\n \n@@ -191,14 +205,12 @@ mod imp {\n     target_os = \"openbsd\"\n )))]\n mod imp {\n-    use crate::ptr;\n-\n     pub unsafe fn init() {}\n \n     pub unsafe fn cleanup() {}\n \n     pub unsafe fn make_handler() -> super::Handler {\n-        super::Handler { _data: ptr::null_mut() }\n+        super::Handler::null()\n     }\n \n     pub unsafe fn drop_handler(_handler: &mut super::Handler) {}"}, {"sha": "1ca082c8b47042f8444a34801e2ca12c0515b34b", "filename": "src/test/ui/sanitize/badfree.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/676b9bc477dfe58971b7df9df4e3a053bb187dee/src%2Ftest%2Fui%2Fsanitize%2Fbadfree.rs", "raw_url": "https://github.com/rust-lang/rust/raw/676b9bc477dfe58971b7df9df4e3a053bb187dee/src%2Ftest%2Fui%2Fsanitize%2Fbadfree.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Fbadfree.rs?ref=676b9bc477dfe58971b7df9df4e3a053bb187dee", "patch": "@@ -0,0 +1,19 @@\n+// needs-sanitizer-support\n+// only-x86_64\n+//\n+// compile-flags: -Z sanitizer=address -O\n+//\n+// run-fail\n+// error-pattern: AddressSanitizer: SEGV\n+\n+use std::ffi::c_void;\n+\n+extern \"C\" {\n+    fn free(ptr: *mut c_void);\n+}\n+\n+fn main() {\n+    unsafe {\n+        free(1 as *mut c_void);\n+    }\n+}"}]}