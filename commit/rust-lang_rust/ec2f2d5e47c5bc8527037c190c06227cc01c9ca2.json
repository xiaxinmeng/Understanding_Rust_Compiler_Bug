{"sha": "ec2f2d5e47c5bc8527037c190c06227cc01c9ca2", "node_id": "C_kwDOAAsO6NoAKGVjMmYyZDVlNDdjNWJjODUyNzAzN2MxOTBjMDYyMjdjYzAxYzljYTI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-23T00:14:01Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-23T00:14:01Z"}, "message": "Auto merge of #10806 - y21:issue10741, r=giraffate\n\n[`large_stack_arrays`]: check array initializer expressions\n\nFixes #10741.\nPrior to this PR, the lint only checked array repeat expressions (ie. `[T; n]`). Now it also checks array initializer expressions.\n\nchangelog: [`large_stack_arrays`]: check array initializer expressions", "tree": {"sha": "efec0d15b49f83f281323f572ed1b1d378090309", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/efec0d15b49f83f281323f572ed1b1d378090309"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ec2f2d5e47c5bc8527037c190c06227cc01c9ca2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ec2f2d5e47c5bc8527037c190c06227cc01c9ca2", "html_url": "https://github.com/rust-lang/rust/commit/ec2f2d5e47c5bc8527037c190c06227cc01c9ca2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ec2f2d5e47c5bc8527037c190c06227cc01c9ca2/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "73198643314e6a3b5cff1af2823db56729bc4778", "url": "https://api.github.com/repos/rust-lang/rust/commits/73198643314e6a3b5cff1af2823db56729bc4778", "html_url": "https://github.com/rust-lang/rust/commit/73198643314e6a3b5cff1af2823db56729bc4778"}, {"sha": "e9a98d925f8fa3a95e62034954d090e7d142022a", "url": "https://api.github.com/repos/rust-lang/rust/commits/e9a98d925f8fa3a95e62034954d090e7d142022a", "html_url": "https://github.com/rust-lang/rust/commit/e9a98d925f8fa3a95e62034954d090e7d142022a"}], "stats": {"total": 45, "additions": 37, "deletions": 8}, "files": [{"sha": "0a5901bce046e2fd1376ce5587a79aa7603ad4f9", "filename": "clippy_lints/src/large_stack_arrays.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ec2f2d5e47c5bc8527037c190c06227cc01c9ca2/clippy_lints%2Fsrc%2Flarge_stack_arrays.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec2f2d5e47c5bc8527037c190c06227cc01c9ca2/clippy_lints%2Fsrc%2Flarge_stack_arrays.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flarge_stack_arrays.rs?ref=ec2f2d5e47c5bc8527037c190c06227cc01c9ca2", "patch": "@@ -38,7 +38,7 @@ impl_lint_pass!(LargeStackArrays => [LARGE_STACK_ARRAYS]);\n \n impl<'tcx> LateLintPass<'tcx> for LargeStackArrays {\n     fn check_expr(&mut self, cx: &LateContext<'_>, expr: &Expr<'_>) {\n-        if let ExprKind::Repeat(_, _) = expr.kind\n+        if let ExprKind::Repeat(_, _) | ExprKind::Array(_) = expr.kind\n           && let ty::Array(element_type, cst) = cx.typeck_results().expr_ty(expr).kind()\n           && let ConstKind::Value(ty::ValTree::Leaf(element_count)) = cst.kind()\n           && let Ok(element_count) = element_count.try_to_target_usize(cx.tcx)"}, {"sha": "3e9d5e6a4ca320f00ab1fe26bdf07a2554a6031c", "filename": "tests/ui/large_stack_arrays.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/ec2f2d5e47c5bc8527037c190c06227cc01c9ca2/tests%2Fui%2Flarge_stack_arrays.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec2f2d5e47c5bc8527037c190c06227cc01c9ca2/tests%2Fui%2Flarge_stack_arrays.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flarge_stack_arrays.rs?ref=ec2f2d5e47c5bc8527037c190c06227cc01c9ca2", "patch": "@@ -18,6 +18,19 @@ pub static DOESNOTLINT2: [u8; 512_001] = {\n     [x; 512_001]\n };\n \n+fn issue_10741() {\n+    #[derive(Copy, Clone)]\n+    struct Large([u32; 100_000]);\n+\n+    fn build() -> Large {\n+        Large([0; 100_000])\n+    }\n+\n+    let _x = [build(); 3];\n+\n+    let _y = [build(), build(), build()];\n+}\n+\n fn main() {\n     let bad = (\n         [0u32; 20_000_000],"}, {"sha": "118d39566abee36e56fe7589847a2163e801e140", "filename": "tests/ui/large_stack_arrays.stderr", "status": "modified", "additions": 23, "deletions": 7, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/ec2f2d5e47c5bc8527037c190c06227cc01c9ca2/tests%2Fui%2Flarge_stack_arrays.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ec2f2d5e47c5bc8527037c190c06227cc01c9ca2/tests%2Fui%2Flarge_stack_arrays.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flarge_stack_arrays.stderr?ref=ec2f2d5e47c5bc8527037c190c06227cc01c9ca2", "patch": "@@ -1,43 +1,59 @@\n error: allocating a local array larger than 512000 bytes\n-  --> $DIR/large_stack_arrays.rs:23:9\n+  --> $DIR/large_stack_arrays.rs:29:14\n+   |\n+LL |     let _x = [build(); 3];\n+   |              ^^^^^^^^^^^^\n+   |\n+   = help: consider allocating on the heap with `vec![build(); 3].into_boxed_slice()`\n+   = note: `-D clippy::large-stack-arrays` implied by `-D warnings`\n+\n+error: allocating a local array larger than 512000 bytes\n+  --> $DIR/large_stack_arrays.rs:31:14\n+   |\n+LL |     let _y = [build(), build(), build()];\n+   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: consider allocating on the heap with `vec![build(), build(), build()].into_boxed_slice()`\n+\n+error: allocating a local array larger than 512000 bytes\n+  --> $DIR/large_stack_arrays.rs:36:9\n    |\n LL |         [0u32; 20_000_000],\n    |         ^^^^^^^^^^^^^^^^^^\n    |\n    = help: consider allocating on the heap with `vec![0u32; 20_000_000].into_boxed_slice()`\n-   = note: `-D clippy::large-stack-arrays` implied by `-D warnings`\n \n error: allocating a local array larger than 512000 bytes\n-  --> $DIR/large_stack_arrays.rs:24:9\n+  --> $DIR/large_stack_arrays.rs:37:9\n    |\n LL |         [S { data: [0; 32] }; 5000],\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = help: consider allocating on the heap with `vec![S { data: [0; 32] }; 5000].into_boxed_slice()`\n \n error: allocating a local array larger than 512000 bytes\n-  --> $DIR/large_stack_arrays.rs:25:9\n+  --> $DIR/large_stack_arrays.rs:38:9\n    |\n LL |         [Some(\"\"); 20_000_000],\n    |         ^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = help: consider allocating on the heap with `vec![Some(\"\"); 20_000_000].into_boxed_slice()`\n \n error: allocating a local array larger than 512000 bytes\n-  --> $DIR/large_stack_arrays.rs:26:9\n+  --> $DIR/large_stack_arrays.rs:39:9\n    |\n LL |         [E::T(0); 5000],\n    |         ^^^^^^^^^^^^^^^\n    |\n    = help: consider allocating on the heap with `vec![E::T(0); 5000].into_boxed_slice()`\n \n error: allocating a local array larger than 512000 bytes\n-  --> $DIR/large_stack_arrays.rs:27:9\n+  --> $DIR/large_stack_arrays.rs:40:9\n    |\n LL |         [0u8; usize::MAX],\n    |         ^^^^^^^^^^^^^^^^^\n    |\n    = help: consider allocating on the heap with `vec![0u8; usize::MAX].into_boxed_slice()`\n \n-error: aborting due to 5 previous errors\n+error: aborting due to 7 previous errors\n "}]}