{"sha": "7dc3839b50d1ddb623aef0fbe76e982af460a18a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdkYzM4MzliNTBkMWRkYjYyM2FlZjBmYmU3NmU5ODJhZjQ2MGExOGE=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-09-07T16:34:25Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-09-07T18:30:42Z"}, "message": "resolve: Mark more erroneous imports as used", "tree": {"sha": "ec823b916f40de18745cbbc6ba8402063bc1547d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ec823b916f40de18745cbbc6ba8402063bc1547d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7dc3839b50d1ddb623aef0fbe76e982af460a18a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7dc3839b50d1ddb623aef0fbe76e982af460a18a", "html_url": "https://github.com/rust-lang/rust/commit/7dc3839b50d1ddb623aef0fbe76e982af460a18a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7dc3839b50d1ddb623aef0fbe76e982af460a18a/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ef54f57c5b9d894a38179d09b00610c1b337b086", "url": "https://api.github.com/repos/rust-lang/rust/commits/ef54f57c5b9d894a38179d09b00610c1b337b086", "html_url": "https://github.com/rust-lang/rust/commit/ef54f57c5b9d894a38179d09b00610c1b337b086"}], "stats": {"total": 48, "additions": 37, "deletions": 11}, "files": [{"sha": "132690dcd7df22b6355f317753b0b1329c5baab0", "filename": "src/librustc_resolve/resolve_imports.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7dc3839b50d1ddb623aef0fbe76e982af460a18a/src%2Flibrustc_resolve%2Fresolve_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7dc3839b50d1ddb623aef0fbe76e982af460a18a/src%2Flibrustc_resolve%2Fresolve_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fresolve_imports.rs?ref=7dc3839b50d1ddb623aef0fbe76e982af460a18a", "patch": "@@ -673,6 +673,10 @@ impl<'a, 'b> ImportResolver<'a, 'b> {\n             self.throw_unresolved_import_error(errors.clone(), None);\n         }\n \n+        for import in &self.r.indeterminate_imports {\n+            // Consider erroneous imports used to avoid duplicate diagnostics.\n+            self.r.used_imports.insert((import.id, TypeNS));\n+        }\n         // Report unresolved imports only if no hard error was already reported\n         // to avoid generating multiple errors on the same import.\n         if !has_errors {\n@@ -839,6 +843,10 @@ impl<'a, 'b> ImportResolver<'a, 'b> {\n                                          true, directive.span, directive.crate_lint());\n         let no_ambiguity = self.r.ambiguity_errors.len() == prev_ambiguity_errors_len;\n         directive.vis.set(orig_vis);\n+        if let PathResult::Failed { .. } | PathResult::NonModule(..) = path_res {\n+            // Consider erroneous imports used to avoid duplicate diagnostics.\n+            self.r.used_imports.insert((directive.id, TypeNS));\n+        }\n         let module = match path_res {\n             PathResult::Module(module) => {\n                 // Consistency checks, analogous to `finalize_macro_resolutions`."}, {"sha": "5398dd63c89294873d158ebc25b1de3d1816f092", "filename": "src/test/ui/imports/unresolved-imports-used.rs", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/7dc3839b50d1ddb623aef0fbe76e982af460a18a/src%2Ftest%2Fui%2Fimports%2Funresolved-imports-used.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7dc3839b50d1ddb623aef0fbe76e982af460a18a/src%2Ftest%2Fui%2Fimports%2Funresolved-imports-used.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimports%2Funresolved-imports-used.rs?ref=7dc3839b50d1ddb623aef0fbe76e982af460a18a", "patch": "@@ -1,12 +1,18 @@\n-// There should be *no* unused import errors.\n+// There should be *one* unused import error.\n #![deny(unused_imports)]\n \n mod qux {\n    fn quz() {}\n+   pub fn quy() {}\n }\n \n-use qux::quz; //~ ERROR function `quz` is private\n-use qux::bar; //~ ERROR unresolved import `qux::bar`\n-use foo::bar; //~ ERROR unresolved import `foo`\n+use qux::quz;  //~ ERROR function `quz` is private\n+use qux::bar;  //~ ERROR unresolved import `qux::bar`\n+use foo::bar;\n+use baz::*;\n+use qux::bar2; //~ ERROR unresolved import `qux::bar2`\n+use foo2::bar2;\n+use baz2::*;\n+use qux::quy;  //~ ERROR unused import\n \n fn main() {}"}, {"sha": "c9342d17a49d7c453d99876663f0d5b18f4172be", "filename": "src/test/ui/imports/unresolved-imports-used.stderr", "status": "modified", "additions": 19, "deletions": 7, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/7dc3839b50d1ddb623aef0fbe76e982af460a18a/src%2Ftest%2Fui%2Fimports%2Funresolved-imports-used.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7dc3839b50d1ddb623aef0fbe76e982af460a18a/src%2Ftest%2Fui%2Fimports%2Funresolved-imports-used.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimports%2Funresolved-imports-used.stderr?ref=7dc3839b50d1ddb623aef0fbe76e982af460a18a", "patch": "@@ -1,22 +1,34 @@\n error[E0432]: unresolved import `qux::bar`\n-  --> $DIR/unresolved-imports-used.rs:9:5\n+  --> $DIR/unresolved-imports-used.rs:10:5\n    |\n LL | use qux::bar;\n    |     ^^^^^^^^ no `bar` in `qux`\n \n-error[E0432]: unresolved import `foo`\n-  --> $DIR/unresolved-imports-used.rs:10:5\n+error[E0432]: unresolved import `qux::bar2`\n+  --> $DIR/unresolved-imports-used.rs:13:5\n    |\n-LL | use foo::bar;\n-   |     ^^^ maybe a missing crate `foo`?\n+LL | use qux::bar2;\n+   |     ^^^^^^^^^ no `bar2` in `qux`\n \n error[E0603]: function `quz` is private\n-  --> $DIR/unresolved-imports-used.rs:8:10\n+  --> $DIR/unresolved-imports-used.rs:9:10\n    |\n LL | use qux::quz;\n    |          ^^^\n \n-error: aborting due to 3 previous errors\n+error: unused import: `qux::quy`\n+  --> $DIR/unresolved-imports-used.rs:16:5\n+   |\n+LL | use qux::quy;\n+   |     ^^^^^^^^\n+   |\n+note: lint level defined here\n+  --> $DIR/unresolved-imports-used.rs:2:9\n+   |\n+LL | #![deny(unused_imports)]\n+   |         ^^^^^^^^^^^^^^\n+\n+error: aborting due to 4 previous errors\n \n Some errors have detailed explanations: E0432, E0603.\n For more information about an error, try `rustc --explain E0432`."}]}