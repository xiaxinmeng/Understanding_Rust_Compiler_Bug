{"sha": "b122908617436af187252572ed5db96850551380", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIxMjI5MDg2MTc0MzZhZjE4NzI1MjU3MmVkNWRiOTY4NTA1NTEzODA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-01-29T13:10:09Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-01-29T13:10:09Z"}, "message": "Auto merge of #81470 - tmiasko:remove-allocations, r=matthewjasper\n\nAvoid memory allocation when removing dead blocks\n\nUse `reachable_as_bitset` to reuse a bitset from the traversal rather\nthan allocating it seprately. Additionally check if there are any\nunreachable blocks before proceeding.", "tree": {"sha": "e80be6c8312d12a5801ce54d129cb94b873479ae", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e80be6c8312d12a5801ce54d129cb94b873479ae"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b122908617436af187252572ed5db96850551380", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b122908617436af187252572ed5db96850551380", "html_url": "https://github.com/rust-lang/rust/commit/b122908617436af187252572ed5db96850551380", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b122908617436af187252572ed5db96850551380/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c4e33b51c1a2d5e599b949fa3006467b88df253a", "url": "https://api.github.com/repos/rust-lang/rust/commits/c4e33b51c1a2d5e599b949fa3006467b88df253a", "html_url": "https://github.com/rust-lang/rust/commit/c4e33b51c1a2d5e599b949fa3006467b88df253a"}, {"sha": "dc6ec3596b7a08c66ee3e98ca6996536ef742121", "url": "https://api.github.com/repos/rust-lang/rust/commits/dc6ec3596b7a08c66ee3e98ca6996536ef742121", "html_url": "https://github.com/rust-lang/rust/commit/dc6ec3596b7a08c66ee3e98ca6996536ef742121"}], "stats": {"total": 13, "additions": 6, "deletions": 7}, "files": [{"sha": "11539d3ef30f4a9aa244b71c4df880b90fe22798", "filename": "compiler/rustc_mir/src/transform/simplify.rs", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/b122908617436af187252572ed5db96850551380/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fsimplify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b122908617436af187252572ed5db96850551380/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fsimplify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fsimplify.rs?ref=b122908617436af187252572ed5db96850551380", "patch": "@@ -28,7 +28,6 @@\n //! return.\n \n use crate::transform::MirPass;\n-use rustc_index::bit_set::BitSet;\n use rustc_index::vec::{Idx, IndexVec};\n use rustc_middle::mir::visit::{MutVisitor, MutatingUseContext, PlaceContext, Visitor};\n use rustc_middle::mir::*;\n@@ -288,17 +287,17 @@ impl<'a, 'tcx> CfgSimplifier<'a, 'tcx> {\n }\n \n pub fn remove_dead_blocks(body: &mut Body<'_>) {\n-    let mut seen = BitSet::new_empty(body.basic_blocks().len());\n-    for (bb, _) in traversal::preorder(body) {\n-        seen.insert(bb.index());\n+    let reachable = traversal::reachable_as_bitset(body);\n+    let num_blocks = body.basic_blocks().len();\n+    if num_blocks == reachable.count() {\n+        return;\n     }\n \n     let basic_blocks = body.basic_blocks_mut();\n-\n-    let num_blocks = basic_blocks.len();\n     let mut replacements: Vec<_> = (0..num_blocks).map(BasicBlock::new).collect();\n     let mut used_blocks = 0;\n-    for alive_index in seen.iter() {\n+    for alive_index in reachable.iter() {\n+        let alive_index = alive_index.index();\n         replacements[alive_index] = BasicBlock::new(used_blocks);\n         if alive_index != used_blocks {\n             // Swap the next alive block data with the current available slot. Since"}]}