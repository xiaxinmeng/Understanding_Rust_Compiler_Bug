{"sha": "14db0809335f51e5f239682d63895866f4ebdb8c", "node_id": "C_kwDOAAsO6NoAKDE0ZGIwODA5MzM1ZjUxZTVmMjM5NjgyZDYzODk1ODY2ZjRlYmRiOGM", "commit": {"author": {"name": "Aleksandr Pak", "email": "aleksandr.vl.pak@gmail.com", "date": "2022-08-16T14:06:32Z"}, "committer": {"name": "Aleksandr Pak", "email": "aleksandr.vl.pak@gmail.com", "date": "2022-08-16T14:24:56Z"}, "message": "feat: add inline_type_alias_uses assist", "tree": {"sha": "f8a208f29f85c4a2c929c4555dd512dc5b63df76", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f8a208f29f85c4a2c929c4555dd512dc5b63df76"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/14db0809335f51e5f239682d63895866f4ebdb8c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCgAdFiEE7xHno2sGEErwYcGQo/bjwOzEZzYFAmL7qMEACgkQo/bjwOzE\nZzbDEgv/Ve5DNNJdyT0yyX4I1aO1wajmzzMKRqWQRHkiZ/yAEeyZB2RJqeG+mc12\ntnVRGk4hWEVA23eUfNIF+U+/DstCUEFxd7TB4foAKDEUiUeWdM34z/Af9JJPc9BJ\n+2A8A4yWBk+zGu+u5QRro/n88k04Rmyh5kkCoWNPNbEOZRdy9xwOhuoyyw2nAqqa\nSrvF5SZq1dE/0hUtq3SjbCF594cOOeVdNYHxBP/pk3rM4NgF+ri3g+BG+qtvX5Pi\nGd4Ue/tgRiJLktNMiDnrG0K9YIyWLrjbyE8GJFhcLTRLCbGiPy+cYoDj9X4Su4Xw\n9GDaMq/9sOKIzwX1Yol+RLQvFiie7k/1pIOfJ9S5qzoOze2KdY8KsHBiRYu9vzct\nR7g0uhH9fCaiUY6ngBibFhHj3WBi1Ad2HB0hYJAIg0ad4QSgjdpT8UurzW6wvF/2\nNq1vtiE5bl1lQokAGcAcAS4s7d8TIHOrZF9SJaLG839c7vJhm9AfID6+6Y7zsa53\n5HoNyQql\n=r+hd\n-----END PGP SIGNATURE-----", "payload": "tree f8a208f29f85c4a2c929c4555dd512dc5b63df76\nparent b6fae56e38f7eac1472df250712c7987510343f1\nauthor Aleksandr Pak <aleksandr.vl.pak@gmail.com> 1660658792 +0300\ncommitter Aleksandr Pak <aleksandr.vl.pak@gmail.com> 1660659896 +0300\n\nfeat: add inline_type_alias_uses assist\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/14db0809335f51e5f239682d63895866f4ebdb8c", "html_url": "https://github.com/rust-lang/rust/commit/14db0809335f51e5f239682d63895866f4ebdb8c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/14db0809335f51e5f239682d63895866f4ebdb8c/comments", "author": {"login": "sancho20021", "id": 45790125, "node_id": "MDQ6VXNlcjQ1NzkwMTI1", "avatar_url": "https://avatars.githubusercontent.com/u/45790125?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sancho20021", "html_url": "https://github.com/sancho20021", "followers_url": "https://api.github.com/users/sancho20021/followers", "following_url": "https://api.github.com/users/sancho20021/following{/other_user}", "gists_url": "https://api.github.com/users/sancho20021/gists{/gist_id}", "starred_url": "https://api.github.com/users/sancho20021/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sancho20021/subscriptions", "organizations_url": "https://api.github.com/users/sancho20021/orgs", "repos_url": "https://api.github.com/users/sancho20021/repos", "events_url": "https://api.github.com/users/sancho20021/events{/privacy}", "received_events_url": "https://api.github.com/users/sancho20021/received_events", "type": "User", "site_admin": false}, "committer": {"login": "sancho20021", "id": 45790125, "node_id": "MDQ6VXNlcjQ1NzkwMTI1", "avatar_url": "https://avatars.githubusercontent.com/u/45790125?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sancho20021", "html_url": "https://github.com/sancho20021", "followers_url": "https://api.github.com/users/sancho20021/followers", "following_url": "https://api.github.com/users/sancho20021/following{/other_user}", "gists_url": "https://api.github.com/users/sancho20021/gists{/gist_id}", "starred_url": "https://api.github.com/users/sancho20021/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sancho20021/subscriptions", "organizations_url": "https://api.github.com/users/sancho20021/orgs", "repos_url": "https://api.github.com/users/sancho20021/repos", "events_url": "https://api.github.com/users/sancho20021/events{/privacy}", "received_events_url": "https://api.github.com/users/sancho20021/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b6fae56e38f7eac1472df250712c7987510343f1", "url": "https://api.github.com/repos/rust-lang/rust/commits/b6fae56e38f7eac1472df250712c7987510343f1", "html_url": "https://github.com/rust-lang/rust/commit/b6fae56e38f7eac1472df250712c7987510343f1"}], "stats": {"total": 260, "additions": 227, "deletions": 33}, "files": [{"sha": "6b1cf9b90dc2853f893b5d75c4db8afc75d0acb7", "filename": "crates/ide-assists/src/handlers/inline_type_alias.rs", "status": "modified", "additions": 201, "deletions": 33, "changes": 234, "blob_url": "https://github.com/rust-lang/rust/blob/14db0809335f51e5f239682d63895866f4ebdb8c/crates%2Fide-assists%2Fsrc%2Fhandlers%2Finline_type_alias.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14db0809335f51e5f239682d63895866f4ebdb8c/crates%2Fide-assists%2Fsrc%2Fhandlers%2Finline_type_alias.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Finline_type_alias.rs?ref=14db0809335f51e5f239682d63895866f4ebdb8c", "patch": "@@ -1,9 +1,9 @@\n // Some ideas for future improvements:\n // - Support replacing aliases which are used in expressions, e.g. `A::new()`.\n-// - \"inline_alias_to_users\" assist #10881.\n // - Remove unused aliases if there are no longer any users, see inline_call.rs.\n \n use hir::{HasSource, PathResolution};\n+use ide_db::{defs::Definition, search::FileReference};\n use itertools::Itertools;\n use std::collections::HashMap;\n use syntax::{\n@@ -16,6 +16,78 @@ use crate::{\n     AssistId, AssistKind,\n };\n \n+// Assist: inline_type_alias_uses\n+//\n+// Inline a type alias into all of its uses where possible.\n+//\n+// ```\n+// type $0A = i32;\n+// fn id(x: A) -> A {\n+//     x\n+// };\n+// fn foo() {\n+//     let _: A = 3;\n+// }\n+// ```\n+// ->\n+// ```\n+// type A = i32;\n+// fn id(x: i32) -> i32 {\n+//     x\n+// };\n+// fn foo() {\n+//     let _: i32 = 3;\n+// }\n+pub(crate) fn inline_type_alias_uses(acc: &mut Assists, ctx: &AssistContext<'_>) -> Option<()> {\n+    let name = ctx.find_node_at_offset::<ast::Name>()?;\n+    let ast_alias = name.syntax().parent().and_then(ast::TypeAlias::cast)?;\n+\n+    let hir_alias = ctx.sema.to_def(&ast_alias)?;\n+    let concrete_type = ast_alias.ty()?;\n+\n+    let usages = Definition::TypeAlias(hir_alias).usages(&ctx.sema);\n+    if !usages.at_least_one() {\n+        return None;\n+    }\n+\n+    // until this is ok\n+\n+    acc.add(\n+        AssistId(\"inline_type_alias_uses\", AssistKind::RefactorInline),\n+        \"Inline type alias into all uses\",\n+        name.syntax().text_range(),\n+        |builder| {\n+            let usages = usages.all();\n+\n+            let mut inline_refs_for_file = |file_id, refs: Vec<FileReference>| {\n+                builder.edit_file(file_id);\n+\n+                let path_types: Vec<ast::PathType> = refs\n+                    .into_iter()\n+                    .filter_map(|file_ref| match file_ref.name {\n+                        ast::NameLike::NameRef(path_type) => {\n+                            path_type.syntax().ancestors().find_map(ast::PathType::cast)\n+                        }\n+                        _ => None,\n+                    })\n+                    .collect();\n+\n+                for (target, replacement) in path_types.into_iter().filter_map(|path_type| {\n+                    let replacement = inline(&ast_alias, &path_type)?.to_text(&concrete_type);\n+                    let target = path_type.syntax().text_range();\n+                    Some((target, replacement))\n+                }) {\n+                    builder.replace(target, replacement);\n+                }\n+            };\n+\n+            for (file_id, refs) in usages.into_iter() {\n+                inline_refs_for_file(file_id, refs);\n+            }\n+        },\n+    )\n+}\n+\n // Assist: inline_type_alias\n //\n // Replace a type alias with its concrete type.\n@@ -36,11 +108,6 @@ use crate::{\n // }\n // ```\n pub(crate) fn inline_type_alias(acc: &mut Assists, ctx: &AssistContext<'_>) -> Option<()> {\n-    enum Replacement {\n-        Generic { lifetime_map: LifetimeMap, const_and_type_map: ConstAndTypeMap },\n-        Plain,\n-    }\n-\n     let alias_instance = ctx.find_node_at_offset::<ast::PathType>()?;\n     let concrete_type;\n     let replacement;\n@@ -59,23 +126,7 @@ pub(crate) fn inline_type_alias(acc: &mut Assists, ctx: &AssistContext<'_>) -> O\n         _ => {\n             let alias = get_type_alias(&ctx, &alias_instance)?;\n             concrete_type = alias.ty()?;\n-\n-            replacement = if let Some(alias_generics) = alias.generic_param_list() {\n-                if alias_generics.generic_params().next().is_none() {\n-                    cov_mark::hit!(no_generics_params);\n-                    return None;\n-                }\n-\n-                let instance_args =\n-                    alias_instance.syntax().descendants().find_map(ast::GenericArgList::cast);\n-\n-                Replacement::Generic {\n-                    lifetime_map: LifetimeMap::new(&instance_args, &alias_generics)?,\n-                    const_and_type_map: ConstAndTypeMap::new(&instance_args, &alias_generics)?,\n-                }\n-            } else {\n-                Replacement::Plain\n-            };\n+            replacement = inline(&alias, &alias_instance)?;\n         }\n     }\n \n@@ -85,19 +136,45 @@ pub(crate) fn inline_type_alias(acc: &mut Assists, ctx: &AssistContext<'_>) -> O\n         AssistId(\"inline_type_alias\", AssistKind::RefactorInline),\n         \"Inline type alias\",\n         target,\n-        |builder| {\n-            let replacement_text = match replacement {\n-                Replacement::Generic { lifetime_map, const_and_type_map } => {\n-                    create_replacement(&lifetime_map, &const_and_type_map, &concrete_type)\n-                }\n-                Replacement::Plain => concrete_type.to_string(),\n-            };\n-\n-            builder.replace(target, replacement_text);\n-        },\n+        |builder| builder.replace(target, replacement.to_text(&concrete_type)),\n     )\n }\n \n+impl Replacement {\n+    fn to_text(&self, concrete_type: &ast::Type) -> String {\n+        match self {\n+            Replacement::Generic { lifetime_map, const_and_type_map } => {\n+                create_replacement(&lifetime_map, &const_and_type_map, &concrete_type)\n+            }\n+            Replacement::Plain => concrete_type.to_string(),\n+        }\n+    }\n+}\n+\n+enum Replacement {\n+    Generic { lifetime_map: LifetimeMap, const_and_type_map: ConstAndTypeMap },\n+    Plain,\n+}\n+\n+fn inline(alias_def: &ast::TypeAlias, alias_instance: &ast::PathType) -> Option<Replacement> {\n+    let repl = if let Some(alias_generics) = alias_def.generic_param_list() {\n+        if alias_generics.generic_params().next().is_none() {\n+            cov_mark::hit!(no_generics_params);\n+            return None;\n+        }\n+        let instance_args =\n+            alias_instance.syntax().descendants().find_map(ast::GenericArgList::cast);\n+\n+        Replacement::Generic {\n+            lifetime_map: LifetimeMap::new(&instance_args, &alias_generics)?,\n+            const_and_type_map: ConstAndTypeMap::new(&instance_args, &alias_generics)?,\n+        }\n+    } else {\n+        Replacement::Plain\n+    };\n+    Some(repl)\n+}\n+\n struct LifetimeMap(HashMap<String, ast::Lifetime>);\n \n impl LifetimeMap {\n@@ -835,4 +912,95 @@ trait Tr {\n \"#,\n         );\n     }\n+\n+    mod inline_type_alias_uses {\n+        use crate::{handlers::inline_type_alias::inline_type_alias_uses, tests::check_assist};\n+\n+        #[test]\n+        fn inline_uses() {\n+            check_assist(\n+                inline_type_alias_uses,\n+                r#\"\n+type $0A = u32;\n+\n+fn foo() {\n+    let _: A = 3;\n+    let _: A = 4;\n+}\n+\"#,\n+                r#\"\n+type A = u32;\n+\n+fn foo() {\n+    let _: u32 = 3;\n+    let _: u32 = 4;\n+}\n+\"#,\n+            );\n+        }\n+\n+        #[test]\n+        fn inline_uses_across_files() {\n+            check_assist(\n+                inline_type_alias_uses,\n+                r#\"\n+//- /lib.rs\n+mod foo;\n+type $0T<E> = Vec<E>;\n+fn f() -> T<&str> {\n+    vec![\"hello\"]\n+}\n+\n+//- /foo.rs\n+use super::T;\n+fn foo() {\n+    let _: T<i8> = Vec::new();\n+}\n+\"#,\n+                r#\"\n+//- /lib.rs\n+mod foo;\n+type T<E> = Vec<E>;\n+fn f() -> Vec<&str> {\n+    vec![\"hello\"]\n+}\n+\n+//- /foo.rs\n+use super::T;\n+fn foo() {\n+    let _: Vec<i8> = Vec::new();\n+}\n+\"#,\n+            );\n+        }\n+\n+        #[test]\n+        fn inline_uses_across_files_fails() {\n+            check_assist(\n+                inline_type_alias_uses,\n+                r#\"\n+//- /lib.rs\n+mod foo;\n+type $0I = i32;\n+\n+//- /foo.rs\n+use super::I;\n+fn foo() {\n+    let _: I = 0;\n+}\n+\"#,\n+                r#\"\n+//- /lib.rs\n+mod foo;\n+type I = i32;\n+\n+//- /foo.rs\n+use super::I;\n+fn foo() {\n+    let _: i32 = 0;\n+}\n+\"#,\n+            );\n+        }\n+    }\n }"}, {"sha": "7fb35143fa2ff1303459cedde3579f16221d7fa7", "filename": "crates/ide-assists/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/14db0809335f51e5f239682d63895866f4ebdb8c/crates%2Fide-assists%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14db0809335f51e5f239682d63895866f4ebdb8c/crates%2Fide-assists%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Flib.rs?ref=14db0809335f51e5f239682d63895866f4ebdb8c", "patch": "@@ -243,6 +243,7 @@ mod handlers {\n             inline_call::inline_into_callers,\n             inline_local_variable::inline_local_variable,\n             inline_type_alias::inline_type_alias,\n+            inline_type_alias::inline_type_alias_uses,\n             introduce_named_generic::introduce_named_generic,\n             introduce_named_lifetime::introduce_named_lifetime,\n             invert_if::invert_if,"}, {"sha": "22319f36134fb6b6d0ee259ae1f2245754d36917", "filename": "crates/ide-assists/src/tests/generated.rs", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/14db0809335f51e5f239682d63895866f4ebdb8c/crates%2Fide-assists%2Fsrc%2Ftests%2Fgenerated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14db0809335f51e5f239682d63895866f4ebdb8c/crates%2Fide-assists%2Fsrc%2Ftests%2Fgenerated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Ftests%2Fgenerated.rs?ref=14db0809335f51e5f239682d63895866f4ebdb8c", "patch": "@@ -1356,6 +1356,31 @@ fn main() {\n     )\n }\n \n+#[test]\n+fn doctest_inline_type_alias_uses() {\n+    check_doc_test(\n+        \"inline_type_alias_uses\",\n+        r#####\"\n+type $0A = i32;\n+fn id(x: A) -> A {\n+    x\n+};\n+fn foo() {\n+    let _: A = 3;\n+}\n+\"#####,\n+        r#####\"\n+type A = i32;\n+fn id(x: i32) -> i32 {\n+    x\n+};\n+fn foo() {\n+    let _: i32 = 3;\n+}\n+\"#####,\n+    )\n+}\n+\n #[test]\n fn doctest_introduce_named_generic() {\n     check_doc_test("}]}