{"sha": "d2232506629b3de71db97694889928bf91330566", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQyMjMyNTA2NjI5YjNkZTcxZGI5NzY5NDg4OTkyOGJmOTEzMzA1NjY=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2021-02-17T22:51:14Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-02-17T22:51:14Z"}, "message": "Rollup merge of #81860 - osa1:issue81800, r=estebank\n\nFix SourceMap::start_point\n\n`start_point` needs to return the *first* character's span, but it would\npreviously call `find_width_of_character_at_span` which returns the span\nof the *last* character. The implementation is now fixed.\n\nOther changes:\n\n- Docs for start_point, end_point, find_width_of_character_at_span\n  updated\n\n- Minor simplification in find_width_of_character_at_span code\n\nFixes #81800", "tree": {"sha": "ef3d134ec91ee6a8a8a237a7d7b53494f0f450a9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ef3d134ec91ee6a8a8a237a7d7b53494f0f450a9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d2232506629b3de71db97694889928bf91330566", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgLZ3jCRBK7hj4Ov3rIwAAdHIIADqz+jlPJi1xDP+SRcRErYAO\nFwtzUHdKLX2CthJx0qyEo02VvkcCGOlg4rgiW/XPMw01rjKgfoBWkGaDeUp48Iij\n8QpCLPf1IL0A470xQF+wPpta4W5LGyu9KUQsEU7uHKjuVmtX5+0qT/NKNtKN3nOu\ndRw3JcfKKEiZ8/LRnWuPT7dbuZSk+yEgnwQ4wIgCphvUMXqeZv63NZsAFN3XYB6n\nBqteQtCChaTgN2xo/4vDlVn6pZYuNVf8HkvGJWUQpSeAz0GzjCVZmEF4cdS2SfYd\nQdJHXLYIUgwnl57MrVKez3BFUcapN2EFLXmdpsVAcgSp87MYtXjljYPnTqg7gGk=\n=oxjr\n-----END PGP SIGNATURE-----\n", "payload": "tree ef3d134ec91ee6a8a8a237a7d7b53494f0f450a9\nparent 40e3af5a2131f0f211e2f247faceae4008c94ec9\nparent 7e94641ee956989d57492975a1214fc79dcd1fce\nauthor Dylan DPC <dylan.dpc@gmail.com> 1613602274 +0100\ncommitter GitHub <noreply@github.com> 1613602274 +0100\n\nRollup merge of #81860 - osa1:issue81800, r=estebank\n\nFix SourceMap::start_point\n\n`start_point` needs to return the *first* character's span, but it would\npreviously call `find_width_of_character_at_span` which returns the span\nof the *last* character. The implementation is now fixed.\n\nOther changes:\n\n- Docs for start_point, end_point, find_width_of_character_at_span\n  updated\n\n- Minor simplification in find_width_of_character_at_span code\n\nFixes #81800\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d2232506629b3de71db97694889928bf91330566", "html_url": "https://github.com/rust-lang/rust/commit/d2232506629b3de71db97694889928bf91330566", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d2232506629b3de71db97694889928bf91330566/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "40e3af5a2131f0f211e2f247faceae4008c94ec9", "url": "https://api.github.com/repos/rust-lang/rust/commits/40e3af5a2131f0f211e2f247faceae4008c94ec9", "html_url": "https://github.com/rust-lang/rust/commit/40e3af5a2131f0f211e2f247faceae4008c94ec9"}, {"sha": "7e94641ee956989d57492975a1214fc79dcd1fce", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e94641ee956989d57492975a1214fc79dcd1fce", "html_url": "https://github.com/rust-lang/rust/commit/7e94641ee956989d57492975a1214fc79dcd1fce"}], "stats": {"total": 63, "additions": 51, "deletions": 12}, "files": [{"sha": "b7eb6d5b3790b3371f63f549f5ecde10036c9e91", "filename": "compiler/rustc_span/src/source_map.rs", "status": "modified", "additions": 30, "deletions": 12, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/d2232506629b3de71db97694889928bf91330566/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2232506629b3de71db97694889928bf91330566/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs?ref=d2232506629b3de71db97694889928bf91330566", "patch": "@@ -778,16 +778,35 @@ impl SourceMap {\n         self.span_until_char(sp, '{')\n     }\n \n-    /// Returns a new span representing just the start point of this span.\n+    /// Returns a new span representing just the first character of the given span.\n     pub fn start_point(&self, sp: Span) -> Span {\n-        let pos = sp.lo().0;\n-        let width = self.find_width_of_character_at_span(sp, false);\n-        let corrected_start_position = pos.checked_add(width).unwrap_or(pos);\n-        let end_point = BytePos(cmp::max(corrected_start_position, sp.lo().0));\n-        sp.with_hi(end_point)\n+        let width = {\n+            let sp = sp.data();\n+            let local_begin = self.lookup_byte_offset(sp.lo);\n+            let start_index = local_begin.pos.to_usize();\n+            let src = local_begin.sf.external_src.borrow();\n+\n+            let snippet = if let Some(ref src) = local_begin.sf.src {\n+                Some(&src[start_index..])\n+            } else if let Some(src) = src.get_source() {\n+                Some(&src[start_index..])\n+            } else {\n+                None\n+            };\n+\n+            match snippet {\n+                None => 1,\n+                Some(snippet) => match snippet.chars().next() {\n+                    None => 1,\n+                    Some(c) => c.len_utf8(),\n+                },\n+            }\n+        };\n+\n+        sp.with_hi(BytePos(sp.lo().0 + width as u32))\n     }\n \n-    /// Returns a new span representing just the end point of this span.\n+    /// Returns a new span representing just the last character of this span.\n     pub fn end_point(&self, sp: Span) -> Span {\n         let pos = sp.hi().0;\n \n@@ -816,7 +835,8 @@ impl SourceMap {\n         Span::new(BytePos(start_of_next_point), end_of_next_point, sp.ctxt())\n     }\n \n-    /// Finds the width of a character, either before or after the provided span.\n+    /// Finds the width of the character, either before or after the end of provided span,\n+    /// depending on the `forwards` parameter.\n     fn find_width_of_character_at_span(&self, sp: Span, forwards: bool) -> u32 {\n         let sp = sp.data();\n         if sp.lo == sp.hi {\n@@ -863,11 +883,9 @@ impl SourceMap {\n         // We need to extend the snippet to the end of the src rather than to end_index so when\n         // searching forwards for boundaries we've got somewhere to search.\n         let snippet = if let Some(ref src) = local_begin.sf.src {\n-            let len = src.len();\n-            &src[start_index..len]\n+            &src[start_index..]\n         } else if let Some(src) = src.get_source() {\n-            let len = src.len();\n-            &src[start_index..len]\n+            &src[start_index..]\n         } else {\n             return 1;\n         };"}, {"sha": "6ac66fdcb65ad5e6b28ca7855ec694bbed3950b1", "filename": "src/test/ui/span/issue-81800.rs", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d2232506629b3de71db97694889928bf91330566/src%2Ftest%2Fui%2Fspan%2Fissue-81800.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2232506629b3de71db97694889928bf91330566/src%2Ftest%2Fui%2Fspan%2Fissue-81800.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fspan%2Fissue-81800.rs?ref=d2232506629b3de71db97694889928bf91330566", "patch": "@@ -0,0 +1,2 @@\n+fn x\u02c2- //~ ERROR: unknown start of token\n+       //~^ ERROR: expected one of `#`, `>`, `const`, identifier, or lifetime, found `-`"}, {"sha": "d37f13a6683b05d8c3afd812ff8e38c9eca10a4a", "filename": "src/test/ui/span/issue-81800.stderr", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/d2232506629b3de71db97694889928bf91330566/src%2Ftest%2Fui%2Fspan%2Fissue-81800.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d2232506629b3de71db97694889928bf91330566/src%2Ftest%2Fui%2Fspan%2Fissue-81800.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fspan%2Fissue-81800.stderr?ref=d2232506629b3de71db97694889928bf91330566", "patch": "@@ -0,0 +1,19 @@\n+error: unknown start of token: \\u{2c2}\n+  --> $DIR/issue-81800.rs:1:5\n+   |\n+LL | fn x\u02c2-\n+   |     ^\n+   |\n+help: Unicode character '\u02c2' (Modifier Letter Left Arrowhead) looks like '<' (Less-Than Sign), but it is not\n+   |\n+LL | fn x<-\n+   |     ^\n+\n+error: expected one of `#`, `>`, `const`, identifier, or lifetime, found `-`\n+  --> $DIR/issue-81800.rs:1:6\n+   |\n+LL | fn x\u02c2-\n+   |      ^ expected one of `#`, `>`, `const`, identifier, or lifetime\n+\n+error: aborting due to 2 previous errors\n+"}]}