{"sha": "7837058073722f1d4a591cdd8d68b6a81466f5f2", "node_id": "C_kwDOAAsO6NoAKDc4MzcwNTgwNzM3MjJmMWQ0YTU5MWNkZDhkNjhiNmE4MTQ2NmY1ZjI", "commit": {"author": {"name": "bjorn3", "email": "17426603+bjorn3@users.noreply.github.com", "date": "2022-12-13T11:30:58Z"}, "committer": {"name": "bjorn3", "email": "17426603+bjorn3@users.noreply.github.com", "date": "2022-12-31T17:20:13Z"}, "message": "Add help for the error message when missing rustc_driver", "tree": {"sha": "2b2307aceca81d0596e4ca80528056206ce8ebc0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2b2307aceca81d0596e4ca80528056206ce8ebc0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7837058073722f1d4a591cdd8d68b6a81466f5f2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7837058073722f1d4a591cdd8d68b6a81466f5f2", "html_url": "https://github.com/rust-lang/rust/commit/7837058073722f1d4a591cdd8d68b6a81466f5f2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7837058073722f1d4a591cdd8d68b6a81466f5f2/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5c84f76f576e351607bccef3ad344df9cd5499f9", "url": "https://api.github.com/repos/rust-lang/rust/commits/5c84f76f576e351607bccef3ad344df9cd5499f9", "html_url": "https://github.com/rust-lang/rust/commit/5c84f76f576e351607bccef3ad344df9cd5499f9"}], "stats": {"total": 55, "additions": 53, "deletions": 2}, "files": [{"sha": "b6a371b23c24af868d7fa304dc658fa237a8ecaa", "filename": "compiler/rustc_error_messages/locales/en-US/metadata.ftl", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/7837058073722f1d4a591cdd8d68b6a81466f5f2/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmetadata.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/7837058073722f1d4a591cdd8d68b6a81466f5f2/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmetadata.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmetadata.ftl?ref=7837058073722f1d4a591cdd8d68b6a81466f5f2", "patch": "@@ -4,6 +4,11 @@ metadata_rlib_required =\n metadata_lib_required =\n     crate `{$crate_name}` required to be available in {$kind} format, but was not found in this form\n \n+metadata_rustc_lib_required =\n+    crate `{$crate_name}` required to be available in {$kind} format, but was not found in this form\n+    .note = only .rmeta files are distributed for `rustc_private` crates other than `rustc_driver`\n+    .help = try adding `extern crate rustc_driver;` at the top level of this crate\n+\n metadata_crate_dep_multiple =\n     cannot satisfy dependencies so `{$crate_name}` only shows up once\n     .help = having upstream crates all available in one format will likely make this go away"}, {"sha": "cee4ba56a9d8f863180eefcb1c3bb4e7745ae23c", "filename": "compiler/rustc_metadata/src/dependency_format.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7837058073722f1d4a591cdd8d68b6a81466f5f2/compiler%2Frustc_metadata%2Fsrc%2Fdependency_format.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7837058073722f1d4a591cdd8d68b6a81466f5f2/compiler%2Frustc_metadata%2Fsrc%2Fdependency_format.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Fdependency_format.rs?ref=7837058073722f1d4a591cdd8d68b6a81466f5f2", "patch": "@@ -54,7 +54,7 @@\n use crate::creader::CStore;\n use crate::errors::{\n     BadPanicStrategy, CrateDepMultiple, IncompatiblePanicInDropStrategy, LibRequired,\n-    RequiredPanicStrategy, RlibRequired, TwoPanicRuntimes,\n+    RequiredPanicStrategy, RlibRequired, RustcLibRequired, TwoPanicRuntimes,\n };\n \n use rustc_data_structures::fx::FxHashMap;\n@@ -224,7 +224,12 @@ fn calculate_type(tcx: TyCtxt<'_>, ty: CrateType) -> DependencyList {\n                     Linkage::Static => \"rlib\",\n                     _ => \"dylib\",\n                 };\n-                sess.emit_err(LibRequired { crate_name: tcx.crate_name(cnum), kind: kind });\n+                let crate_name = tcx.crate_name(cnum);\n+                if crate_name.as_str().starts_with(\"rustc_\") {\n+                    sess.emit_err(RustcLibRequired { crate_name, kind });\n+                } else {\n+                    sess.emit_err(LibRequired { crate_name, kind });\n+                }\n             }\n         }\n     }"}, {"sha": "c6e7dc2bfda5a885818c031474374af78c18160e", "filename": "compiler/rustc_metadata/src/errors.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7837058073722f1d4a591cdd8d68b6a81466f5f2/compiler%2Frustc_metadata%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7837058073722f1d4a591cdd8d68b6a81466f5f2/compiler%2Frustc_metadata%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Ferrors.rs?ref=7837058073722f1d4a591cdd8d68b6a81466f5f2", "patch": "@@ -24,6 +24,14 @@ pub struct LibRequired<'a> {\n     pub kind: &'a str,\n }\n \n+#[derive(Diagnostic)]\n+#[diag(metadata_rustc_lib_required)]\n+#[help]\n+pub struct RustcLibRequired<'a> {\n+    pub crate_name: Symbol,\n+    pub kind: &'a str,\n+}\n+\n #[derive(Diagnostic)]\n #[diag(metadata_crate_dep_multiple)]\n #[help]"}, {"sha": "e2193c38d50a7ef00bdde444a3e06414e2d00691", "filename": "src/test/ui-fulldeps/missing-rustc-driver-error.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7837058073722f1d4a591cdd8d68b6a81466f5f2/src%2Ftest%2Fui-fulldeps%2Fmissing-rustc-driver-error.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7837058073722f1d4a591cdd8d68b6a81466f5f2/src%2Ftest%2Fui-fulldeps%2Fmissing-rustc-driver-error.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fmissing-rustc-driver-error.rs?ref=7837058073722f1d4a591cdd8d68b6a81466f5f2", "patch": "@@ -0,0 +1,9 @@\n+// Test that we get the following hint when trying to use a compiler crate without rustc_driver.\n+// error-pattern: try adding `extern crate rustc_driver;` at the top level of this crate\n+// compile-flags: --emit link\n+\n+#![feature(rustc_private)]\n+\n+extern crate rustc_serialize;\n+\n+fn main() {}"}, {"sha": "ad03ba0103c520cd7b28de8896afd0d8c3d75872", "filename": "src/test/ui-fulldeps/missing-rustc-driver-error.stderr", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/7837058073722f1d4a591cdd8d68b6a81466f5f2/src%2Ftest%2Fui-fulldeps%2Fmissing-rustc-driver-error.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7837058073722f1d4a591cdd8d68b6a81466f5f2/src%2Ftest%2Fui-fulldeps%2Fmissing-rustc-driver-error.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fmissing-rustc-driver-error.stderr?ref=7837058073722f1d4a591cdd8d68b6a81466f5f2", "patch": "@@ -0,0 +1,24 @@\n+error: crate `rustc_serialize` required to be available in rlib format, but was not found in this form\n+   |\n+   = help: try adding `extern crate rustc_driver;` at the top level of this crate\n+\n+error: crate `smallvec` required to be available in rlib format, but was not found in this form\n+\n+error: crate `thin_vec` required to be available in rlib format, but was not found in this form\n+\n+error: crate `indexmap` required to be available in rlib format, but was not found in this form\n+\n+error: crate `hashbrown` required to be available in rlib format, but was not found in this form\n+\n+error: crate `ahash` required to be available in rlib format, but was not found in this form\n+\n+error: crate `once_cell` required to be available in rlib format, but was not found in this form\n+\n+error: crate `getrandom` required to be available in rlib format, but was not found in this form\n+\n+error: crate `cfg_if` required to be available in rlib format, but was not found in this form\n+\n+error: crate `libc` required to be available in rlib format, but was not found in this form\n+\n+error: aborting due to 10 previous errors\n+"}]}