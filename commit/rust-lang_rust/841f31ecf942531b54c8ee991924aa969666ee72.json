{"sha": "841f31ecf942531b54c8ee991924aa969666ee72", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg0MWYzMWVjZjk0MjUzMWI1NGM4ZWU5OTE5MjRhYTk2OTY2NmVlNzI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-03-23T21:01:52Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-03-23T21:01:52Z"}, "message": "auto merge of #13074 : pczarn/rust/build-rlib, r=alexcrichton\n\nFixes #12992\r\n\r\nI tried to increase the number of deflate's probes. Reduction of 0.5% or 2% is not enough.", "tree": {"sha": "a217a74cb15b14e126332095818b9882f35d410e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a217a74cb15b14e126332095818b9882f35d410e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/841f31ecf942531b54c8ee991924aa969666ee72", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/841f31ecf942531b54c8ee991924aa969666ee72", "html_url": "https://github.com/rust-lang/rust/commit/841f31ecf942531b54c8ee991924aa969666ee72", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/841f31ecf942531b54c8ee991924aa969666ee72/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bc37b8fde5626f5405c8424a9fa59bf622013eb3", "url": "https://api.github.com/repos/rust-lang/rust/commits/bc37b8fde5626f5405c8424a9fa59bf622013eb3", "html_url": "https://github.com/rust-lang/rust/commit/bc37b8fde5626f5405c8424a9fa59bf622013eb3"}, {"sha": "f0f5072566549e8da327849036c1ac9b85c9c4bf", "url": "https://api.github.com/repos/rust-lang/rust/commits/f0f5072566549e8da327849036c1ac9b85c9c4bf", "html_url": "https://github.com/rust-lang/rust/commit/f0f5072566549e8da327849036c1ac9b85c9c4bf"}], "stats": {"total": 16, "additions": 10, "deletions": 6}, "files": [{"sha": "f198a41af655754fa3c8e5fe67412a04423f3658", "filename": "src/librustc/back/link.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/841f31ecf942531b54c8ee991924aa969666ee72/src%2Flibrustc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/841f31ecf942531b54c8ee991924aa969666ee72/src%2Flibrustc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Flink.rs?ref=841f31ecf942531b54c8ee991924aa969666ee72", "patch": "@@ -937,16 +937,18 @@ fn link_rlib<'a>(sess: &'a Session,\n             // For LTO purposes, the bytecode of this library is also inserted\n             // into the archive.\n             let bc = obj_filename.with_extension(\"bc\");\n+            let bc_deflated = obj_filename.with_extension(\"bc.deflate\");\n             match fs::File::open(&bc).read_to_end().and_then(|data| {\n-                fs::File::create(&bc).write(flate::deflate_bytes(data).as_slice())\n+                fs::File::create(&bc_deflated).write(flate::deflate_bytes(data).as_slice())\n             }) {\n                 Ok(()) => {}\n                 Err(e) => {\n                     sess.err(format!(\"failed to compress bytecode: {}\", e));\n                     sess.abort_if_errors()\n                 }\n             }\n-            a.add_file(&bc, false);\n+            a.add_file(&bc_deflated, false);\n+            remove(sess, &bc_deflated);\n             if !sess.opts.cg.save_temps &&\n                !sess.opts.output_types.contains(&OutputTypeBitcode) {\n                 remove(sess, &bc);"}, {"sha": "ef3496f113b599fdc8dae389ee93a88bf68bdfc3", "filename": "src/librustc/back/lto.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/841f31ecf942531b54c8ee991924aa969666ee72/src%2Flibrustc%2Fback%2Flto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/841f31ecf942531b54c8ee991924aa969666ee72/src%2Flibrustc%2Fback%2Flto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Flto.rs?ref=841f31ecf942531b54c8ee991924aa969666ee72", "patch": "@@ -52,9 +52,9 @@ pub fn run(sess: &session::Session, llmod: ModuleRef,\n \n         let archive = ArchiveRO::open(&path).expect(\"wanted an rlib\");\n         debug!(\"reading {}\", name);\n-        let bc = time(sess.time_passes(), format!(\"read {}.bc\", name), (), |_|\n-                      archive.read(format!(\"{}.bc\", name)));\n-        let bc = bc.expect(\"missing bytecode in archive!\");\n+        let bc = time(sess.time_passes(), format!(\"read {}.bc.deflate\", name), (), |_|\n+                      archive.read(format!(\"{}.bc.deflate\", name)));\n+        let bc = bc.expect(\"missing compressed bytecode in archive!\");\n         let bc = time(sess.time_passes(), format!(\"inflate {}.bc\", name), (), |_|\n                       flate::inflate_bytes(bc));\n         let ptr = bc.as_slice().as_ptr();"}, {"sha": "94e0ce833438f1e72b22fa84da64ce61b402b4ed", "filename": "src/test/run-make/output-type-permutations/Makefile", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/841f31ecf942531b54c8ee991924aa969666ee72/src%2Ftest%2Frun-make%2Foutput-type-permutations%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/841f31ecf942531b54c8ee991924aa969666ee72/src%2Ftest%2Frun-make%2Foutput-type-permutations%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Foutput-type-permutations%2FMakefile?ref=841f31ecf942531b54c8ee991924aa969666ee72", "patch": "@@ -15,7 +15,6 @@ all:\n \trm $(TMPDIR)/bar\n \t$(RUSTC) foo.rs --emit=asm,ir,bc,obj,link --crate-type=staticlib\n \trm $(TMPDIR)/bar.ll\n-\trm $(TMPDIR)/bar.bc\n \trm $(TMPDIR)/bar.s\n \trm $(TMPDIR)/bar.o\n \trm $(TMPDIR)/$(call STATICLIB_GLOB,bar)\n@@ -37,6 +36,9 @@ all:\n \trm $(TMPDIR)/foo\n \t$(RUSTC) foo.rs --crate-type=bin -o $(TMPDIR)/foo\n \trm $(TMPDIR)/foo\n+\tmv $(TMPDIR)/bar.bc $(TMPDIR)/foo.bc\n \t$(RUSTC) foo.rs --emit=bc,link --crate-type=rlib\n+\tcmp $(TMPDIR)/foo.bc $(TMPDIR)/bar.bc\n \trm $(TMPDIR)/bar.bc\n+\trm $(TMPDIR)/foo.bc\n \trm $(TMPDIR)/$(call RLIB_GLOB,bar)"}]}