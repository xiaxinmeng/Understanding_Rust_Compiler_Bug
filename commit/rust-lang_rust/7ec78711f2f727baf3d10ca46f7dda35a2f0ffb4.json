{"sha": "7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdlYzc4NzExZjJmNzI3YmFmM2QxMGNhNDZmN2RkYTM1YTJmMGZmYjQ=", "commit": {"author": {"name": "Seiichi Uchida", "email": "topecongiro@localhost.localdomain", "date": "2017-05-13T09:20:18Z"}, "committer": {"name": "Seiichi Uchida", "email": "topecongiro@localhost.localdomain", "date": "2017-05-13T09:32:25Z"}, "message": "Prevent rewriting closure block to expr inside macro", "tree": {"sha": "7aa7f9dc2a35749ac62e75ff1319818e5980c696", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7aa7f9dc2a35749ac62e75ff1319818e5980c696"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4", "html_url": "https://github.com/rust-lang/rust/commit/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4/comments", "author": null, "committer": null, "parents": [{"sha": "d7ed9b50d153f1a35949af273abc1cef4ea4f44c", "url": "https://api.github.com/repos/rust-lang/rust/commits/d7ed9b50d153f1a35949af273abc1cef4ea4f44c", "html_url": "https://github.com/rust-lang/rust/commit/d7ed9b50d153f1a35949af273abc1cef4ea4f44c"}], "stats": {"total": 70, "additions": 38, "deletions": 32}, "files": [{"sha": "858103489fd7e4cae14edbbda1a1becb1173a863", "filename": "src/chains.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4/src%2Fchains.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4/src%2Fchains.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fchains.rs?ref=7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4", "patch": "@@ -440,5 +440,5 @@ fn rewrite_method_call(method_name: ast::Ident,\n     let callee_str = format!(\".{}{}\", method_name, type_str);\n     let span = mk_sp(lo, span.hi);\n \n-    rewrite_call(context, &callee_str, &args[1..], span, shape, false)\n+    rewrite_call(context, &callee_str, &args[1..], span, shape)\n }"}, {"sha": "a52e163ac7abd3b9cd23d300d33c6ecaddf1a7f3", "filename": "src/expr.rs", "status": "modified", "additions": 12, "deletions": 26, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4", "patch": "@@ -70,7 +70,7 @@ fn format_expr(expr: &ast::Expr,\n         }\n         ast::ExprKind::Call(ref callee, ref args) => {\n             let inner_span = mk_sp(callee.span.hi, expr.span.hi);\n-            rewrite_call(context, &**callee, args, inner_span, shape, false)\n+            rewrite_call(context, &**callee, args, inner_span, shape)\n         }\n         ast::ExprKind::Paren(ref subexpr) => rewrite_paren(context, subexpr, shape),\n         ast::ExprKind::Binary(ref op, ref lhs, ref rhs) => {\n@@ -512,7 +512,8 @@ fn rewrite_closure(capture: ast::CaptureBy,\n         }\n \n         // Figure out if the block is necessary.\n-        let needs_block = block.rules != ast::BlockCheckMode::Default || block.stmts.len() > 1 ||\n+        let needs_block = block.rules != ast::BlockCheckMode::Default ||\n+                          block.stmts.len() > 1 || context.inside_macro ||\n                           block_contains_comment(block, context.codemap) ||\n                           prefix.contains('\\n');\n \n@@ -1599,20 +1600,12 @@ pub fn rewrite_call<R>(context: &RewriteContext,\n                        callee: &R,\n                        args: &[ptr::P<ast::Expr>],\n                        span: Span,\n-                       shape: Shape,\n-                       force_no_trailing_comma: bool)\n+                       shape: Shape)\n                        -> Option<String>\n     where R: Rewrite\n {\n-    let closure = |callee_max_width| {\n-        rewrite_call_inner(context,\n-                           callee,\n-                           callee_max_width,\n-                           args,\n-                           span,\n-                           shape,\n-                           force_no_trailing_comma)\n-    };\n+    let closure =\n+        |callee_max_width| rewrite_call_inner(context, callee, callee_max_width, args, span, shape);\n \n     // 2 is for parens\n     let max_width = try_opt!(shape.width.checked_sub(2));\n@@ -1624,8 +1617,7 @@ fn rewrite_call_inner<R>(context: &RewriteContext,\n                          max_callee_width: usize,\n                          args: &[ptr::P<ast::Expr>],\n                          span: Span,\n-                         shape: Shape,\n-                         force_no_trailing_comma: bool)\n+                         shape: Shape)\n                          -> Result<String, Ordering>\n     where R: Rewrite\n {\n@@ -1665,13 +1657,8 @@ fn rewrite_call_inner<R>(context: &RewriteContext,\n     let span_lo = context.codemap.span_after(span, \"(\");\n     let span = mk_sp(span_lo, span.hi);\n \n-    let list_str = rewrite_call_args(context,\n-                                     args,\n-                                     span,\n-                                     nested_shape,\n-                                     one_line_width,\n-                                     force_no_trailing_comma)\n-            .ok_or(Ordering::Less)?;\n+    let list_str = rewrite_call_args(context, args, span, nested_shape, one_line_width)\n+        .ok_or(Ordering::Less)?;\n \n     let result = if context.config.fn_call_style == IndentStyle::Visual ||\n                     (!list_str.contains('\\n') && list_str.chars().last().unwrap_or(' ') != ',') {\n@@ -1695,8 +1682,7 @@ fn rewrite_call_args(context: &RewriteContext,\n                      args: &[ptr::P<ast::Expr>],\n                      span: Span,\n                      shape: Shape,\n-                     one_line_width: usize,\n-                     force_no_trailing_comma: bool)\n+                     one_line_width: usize)\n                      -> Option<String> {\n     let arg_count = args.len();\n \n@@ -1766,7 +1752,7 @@ fn rewrite_call_args(context: &RewriteContext,\n     let mut fmt = ListFormatting {\n         tactic: tactic,\n         separator: \",\",\n-        trailing_separator: if force_no_trailing_comma ||\n+        trailing_separator: if context.inside_macro ||\n                                context.config.fn_call_style == IndentStyle::Visual ||\n                                arg_count <= 1 {\n             SeparatorTactic::Never\n@@ -1783,7 +1769,7 @@ fn rewrite_call_args(context: &RewriteContext,\n         // try to put it on the next line. Try this only when we are in block mode\n         // and not rewriting macro.\n         Some(ref s) if context.config.fn_call_style == IndentStyle::Block &&\n-                       !force_no_trailing_comma &&\n+                       !context.inside_macro &&\n                        (!s.contains('\\n') &&\n                         (s.len() > one_line_width || s.len() > context.config.fn_call_width)) => {\n             fmt.trailing_separator = SeparatorTactic::Vertical;"}, {"sha": "d644e32bb6d595fe8b9a1b8089bb8bbe230394c6", "filename": "src/macros.rs", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4/src%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4/src%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmacros.rs?ref=7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4", "patch": "@@ -65,6 +65,8 @@ pub fn rewrite_macro(mac: &ast::Mac,\n                      shape: Shape,\n                      position: MacroPosition)\n                      -> Option<String> {\n+    let mut context = &mut context.clone();\n+    context.inside_macro = true;\n     if context.config.use_try_shorthand {\n         if let Some(expr) = convert_try_mac(mac, context) {\n             return expr.rewrite(context, shape);\n@@ -146,11 +148,12 @@ pub fn rewrite_macro(mac: &ast::Mac,\n         MacroStyle::Parens => {\n             // Format macro invocation as function call, forcing no trailing\n             // comma because not all macros support them.\n-            rewrite_call(context, &macro_name, &expr_vec, mac.span, shape, true)\n-                .map(|rw| match position {\n-                         MacroPosition::Item => format!(\"{};\", rw),\n-                         _ => rw,\n-                     })\n+            rewrite_call(context, &macro_name, &expr_vec, mac.span, shape).map(|rw| {\n+                match position {\n+                    MacroPosition::Item => format!(\"{};\", rw),\n+                    _ => rw,\n+                }\n+            })\n         }\n         MacroStyle::Brackets => {\n             // Format macro invocation as array literal."}, {"sha": "c1047e41b33c2332f0571f4503aa55b625bbff89", "filename": "src/rewrite.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4/src%2Frewrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4/src%2Frewrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frewrite.rs?ref=7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4", "patch": "@@ -26,6 +26,7 @@ pub struct RewriteContext<'a> {\n     pub parse_session: &'a ParseSess,\n     pub codemap: &'a CodeMap,\n     pub config: &'a Config,\n+    pub inside_macro: bool,\n }\n \n impl<'a> RewriteContext<'a> {"}, {"sha": "e813f3a181304245dad226a275170e22492bd5e4", "filename": "src/visitor.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4", "patch": "@@ -574,6 +574,7 @@ impl<'a> FmtVisitor<'a> {\n             parse_session: self.parse_session,\n             codemap: self.codemap,\n             config: self.config,\n+            inside_macro: false,\n         }\n     }\n }"}, {"sha": "b58527eb8fbbd5a19c1f626c2b154cc51b3cae2c", "filename": "tests/target/closure-block-inside-macro.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4/tests%2Ftarget%2Fclosure-block-inside-macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4/tests%2Ftarget%2Fclosure-block-inside-macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fclosure-block-inside-macro.rs?ref=7ec78711f2f727baf3d10ca46f7dda35a2f0ffb4", "patch": "@@ -0,0 +1,15 @@\n+// rustfmt-fn_call_style: Block\n+\n+// #1547\n+fuzz_target!(\n+    |data: &[u8]| {\n+        if let Some(first) = data.first() {\n+            let index = *first as usize;\n+            if index >= ENCODINGS.len() {\n+                return;\n+            }\n+            let encoding = ENCODINGS[index];\n+            dispatch_test(encoding, &data[1..]);\n+        }\n+    }\n+);"}]}