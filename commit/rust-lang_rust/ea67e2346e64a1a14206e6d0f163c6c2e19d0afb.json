{"sha": "ea67e2346e64a1a14206e6d0f163c6c2e19d0afb", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVhNjdlMjM0NmU2NGExYTE0MjA2ZTZkMGYxNjNjNmMyZTE5ZDBhZmI=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-03-01T13:36:44Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-01T13:36:44Z"}, "message": "Merge #3384\n\n3384: fix #2377 super::super::* r=flodiebold a=JoshMcguigan\n\nThanks @matklad for the detailed explanation on #2377. I believe this fixes it.\r\n\r\nOne thing I'm not sure about is you said the fix would involve changing `crates/ra_hir_def/src/path/lower/lower.rs`, but I only changed `crates/ra_hir_def/src/path/lower/lower_use.rs`. I'm not sure what kind of test code I'd have to write to expose the issue in `lower.rs`, but I'd be happy to add it if you are able to provide additional guidance. \r\n\r\ncloses #2377\n\nCo-authored-by: Josh Mcguigan <joshmcg88@gmail.com>", "tree": {"sha": "80a4f5c9b04008df8502ed75b230661fb9041742", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/80a4f5c9b04008df8502ed75b230661fb9041742"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ea67e2346e64a1a14206e6d0f163c6c2e19d0afb", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeW7psCRBK7hj4Ov3rIwAAdHIIAHUYCOne1cbDA8U6+759o0Kh\nluCFjxVf4bpLi5wVnIY57bKq0e8Wyv5i5Gk4rq2832ibL4i8rkBvbF4LrLx4vorS\nBnQZ+TisCWZLqADLrNWDehqjBLDRmB8cne6wjd6BqdS963DJV/s0qHumTdq1ewM2\nhOQ8UR6SkBjQDJ8PfqyYKiT8XD/DMALhrx4dJOEJTSY+lw8AX5yfH3fbXpPHv7vI\nuKNSQXL57M3UK3BJSpiAta4mHfeCtKCZTsrCgg1637mRVqAGrjOCPJd4HZ+IzorY\nIz/XkA5HAVcZyrUEsuQwKVWw7FdTh54dprpy+OR85qp7FaaBW3IhOZlrLJlYyz8=\n=c/pN\n-----END PGP SIGNATURE-----\n", "payload": "tree 80a4f5c9b04008df8502ed75b230661fb9041742\nparent 6db2da4993d3956fc7c8ebf152963a132611426a\nparent 0057d1e10d1bc94557e94e551079be0c9c281d3f\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1583069804 +0000\ncommitter GitHub <noreply@github.com> 1583069804 +0000\n\nMerge #3384\n\n3384: fix #2377 super::super::* r=flodiebold a=JoshMcguigan\n\nThanks @matklad for the detailed explanation on #2377. I believe this fixes it.\r\n\r\nOne thing I'm not sure about is you said the fix would involve changing `crates/ra_hir_def/src/path/lower/lower.rs`, but I only changed `crates/ra_hir_def/src/path/lower/lower_use.rs`. I'm not sure what kind of test code I'd have to write to expose the issue in `lower.rs`, but I'd be happy to add it if you are able to provide additional guidance. \r\n\r\ncloses #2377\n\nCo-authored-by: Josh Mcguigan <joshmcg88@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ea67e2346e64a1a14206e6d0f163c6c2e19d0afb", "html_url": "https://github.com/rust-lang/rust/commit/ea67e2346e64a1a14206e6d0f163c6c2e19d0afb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ea67e2346e64a1a14206e6d0f163c6c2e19d0afb/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6db2da4993d3956fc7c8ebf152963a132611426a", "url": "https://api.github.com/repos/rust-lang/rust/commits/6db2da4993d3956fc7c8ebf152963a132611426a", "html_url": "https://github.com/rust-lang/rust/commit/6db2da4993d3956fc7c8ebf152963a132611426a"}, {"sha": "0057d1e10d1bc94557e94e551079be0c9c281d3f", "url": "https://api.github.com/repos/rust-lang/rust/commits/0057d1e10d1bc94557e94e551079be0c9c281d3f", "html_url": "https://github.com/rust-lang/rust/commit/0057d1e10d1bc94557e94e551079be0c9c281d3f"}], "stats": {"total": 94, "additions": 88, "deletions": 6}, "files": [{"sha": "dda5ed699c1bd49a79314f0484a5538d556f864d", "filename": "crates/ra_hir_def/src/nameres/tests.rs", "status": "modified", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/ea67e2346e64a1a14206e6d0f163c6c2e19d0afb/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea67e2346e64a1a14206e6d0f163c6c2e19d0afb/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Ftests.rs?ref=ea67e2346e64a1a14206e6d0f163c6c2e19d0afb", "patch": "@@ -65,6 +65,42 @@ fn crate_def_map_smoke_test() {\n     \"###)\n }\n \n+#[test]\n+fn crate_def_map_super_super() {\n+    let map = def_map(\n+        \"\n+        //- /lib.rs\n+        mod a {\n+            const A: usize = 0;\n+\n+            mod b {\n+                const B: usize = 0;\n+\n+                mod c {\n+                    use super::super::*;\n+                }\n+            }\n+        }\n+        \",\n+    );\n+    assert_snapshot!(map, @r###\"\n+        \u22eecrate\n+        \u22eea: t\n+        \u22ee\n+        \u22eecrate::a\n+        \u22eeA: v\n+        \u22eeb: t\n+        \u22ee\n+        \u22eecrate::a::b\n+        \u22eeB: v\n+        \u22eec: t\n+        \u22ee\n+        \u22eecrate::a::b::c\n+        \u22eeA: v\n+        \u22eeb: t\n+    \"###)\n+}\n+\n #[test]\n fn bogus_paths() {\n     covers!(bogus_paths);"}, {"sha": "0934520d70fc0ade07900ac25cebee4036b1fc1f", "filename": "crates/ra_hir_def/src/path/lower.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ea67e2346e64a1a14206e6d0f163c6c2e19d0afb/crates%2Fra_hir_def%2Fsrc%2Fpath%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea67e2346e64a1a14206e6d0f163c6c2e19d0afb/crates%2Fra_hir_def%2Fsrc%2Fpath%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fpath%2Flower.rs?ref=ea67e2346e64a1a14206e6d0f163c6c2e19d0afb", "patch": "@@ -101,8 +101,12 @@ pub(super) fn lower_path(mut path: ast::Path, hygiene: &Hygiene) -> Option<Path>\n                 break;\n             }\n             ast::PathSegmentKind::SuperKw => {\n-                kind = PathKind::Super(1);\n-                break;\n+                let nested_super_count = if let PathKind::Super(n) = kind {\n+                    n\n+                } else {\n+                    0\n+                };\n+                kind = PathKind::Super(nested_super_count + 1);\n             }\n         }\n         path = match qualifier(&path) {"}, {"sha": "278d5196e7bc0dd70f61e57b322f11054a18414f", "filename": "crates/ra_hir_def/src/path/lower/lower_use.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ea67e2346e64a1a14206e6d0f163c6c2e19d0afb/crates%2Fra_hir_def%2Fsrc%2Fpath%2Flower%2Flower_use.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea67e2346e64a1a14206e6d0f163c6c2e19d0afb/crates%2Fra_hir_def%2Fsrc%2Fpath%2Flower%2Flower_use.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fpath%2Flower%2Flower_use.rs?ref=ea67e2346e64a1a14206e6d0f163c6c2e19d0afb", "patch": "@@ -103,10 +103,13 @@ fn convert_path(prefix: Option<ModPath>, path: ast::Path, hygiene: &Hygiene) ->\n             ModPath::from_segments(PathKind::Super(0), iter::empty())\n         }\n         ast::PathSegmentKind::SuperKw => {\n-            if prefix.is_some() {\n-                return None;\n-            }\n-            ModPath::from_segments(PathKind::Super(1), iter::empty())\n+            let nested_super_count = match prefix.map(|p| p.kind) {\n+                Some(PathKind::Super(n)) => n,\n+                Some(_) => return None,\n+                None => 0,\n+            };\n+\n+            ModPath::from_segments(PathKind::Super(nested_super_count + 1), iter::empty())\n         }\n         ast::PathSegmentKind::Type { .. } => {\n             // not allowed in imports"}, {"sha": "9145aa183dc7b1c4bde1b23cad1a8d41fe0e35c4", "filename": "crates/ra_ide/src/completion/complete_dot.rs", "status": "modified", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/ea67e2346e64a1a14206e6d0f163c6c2e19d0afb/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_dot.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea67e2346e64a1a14206e6d0f163c6c2e19d0afb/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_dot.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_dot.rs?ref=ea67e2346e64a1a14206e6d0f163c6c2e19d0afb", "patch": "@@ -545,4 +545,43 @@ mod tests {\n         \"###\n         )\n     }\n+\n+    #[test]\n+    fn test_super_super_completion() {\n+        assert_debug_snapshot!(\n+        do_ref_completion(\n+                r\"\n+                mod a {\n+                    const A: usize = 0;\n+\n+                    mod b {\n+                        const B: usize = 0;\n+\n+                        mod c {\n+                            use super::super::<|>\n+                        }\n+                    }\n+                }\n+                \",\n+        ),\n+            @r###\"\n+        [\n+            CompletionItem {\n+                label: \"A\",\n+                source_range: [217; 217),\n+                delete: [217; 217),\n+                insert: \"A\",\n+                kind: Const,\n+            },\n+            CompletionItem {\n+                label: \"b\",\n+                source_range: [217; 217),\n+                delete: [217; 217),\n+                insert: \"b\",\n+                kind: Module,\n+            },\n+        ]\n+        \"###\n+        );\n+    }\n }"}]}