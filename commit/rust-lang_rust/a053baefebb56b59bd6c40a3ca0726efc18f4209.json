{"sha": "a053baefebb56b59bd6c40a3ca0726efc18f4209", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEwNTNiYWVmZWJiNTZiNTliZDZjNDBhM2NhMDcyNmVmYzE4ZjQyMDk=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-08-17T09:13:45Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-08-17T09:13:45Z"}, "message": "Rollup merge of #63559 - eddyb:v0-mangling-off-by-1, r=estebank\n\nrustc_codegen_utils: account for 1-indexed anonymous lifetimes in v0 mangling.\n\nI don't really understand why `anonymize_late_bound_regions` starts with `BrAnon(1)` instead of `BrAnon(0)`, but it does (maybe @nikomatsakis knows?): https://github.com/rust-lang/rust/blob/c43d03a19f326f4a323569328cc501e86eb6d22e/src/librustc/ty/fold.rs#L696-L712\n\nThankfully, the mangling format and demangler implementations are fine, and I just needed to offset the anonymized lifetime indices by `1` to get the correct mangling.\n\ncc @alexcrichton @michaelwoerister", "tree": {"sha": "9e2ce2113c54731fea9051ebedf67d7647bba973", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9e2ce2113c54731fea9051ebedf67d7647bba973"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a053baefebb56b59bd6c40a3ca0726efc18f4209", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdV8VJCRBK7hj4Ov3rIwAAdHIIAITjUTJy5IT4vGtAJh7sfAGB\nzDN/BxZg9uawCa41RFY0N/XmcP2akQpdeXDSwzNxzWvWNF8/O/03kWu8AxEoMCof\nwaCk+Er+uKn5d4p1jZu5+g7U9ZFjZmleHAZKxy/JnTtgA3suDsK2OjEIRmb3x09A\nphGQaU8KwmeO1GG3DQMyi6VXD1yS6s4vKLSnAnQl0eR6t3Z11tAD7OlLbDB1zUhh\nEzgUMHJN2WEJjZIe+i9XMLJM2RtG06NaxyU5gOMnFSVX5oBfcDsk6vmlOE56htu8\ntnJHERe849Y8A+VkqQMlGm+Gf8p0vCcGJCda5fM8OVOrH0a8ektwAgwGNdqmTIg=\n=T855\n-----END PGP SIGNATURE-----\n", "payload": "tree 9e2ce2113c54731fea9051ebedf67d7647bba973\nparent 5e597875b73e651c5dea200754489f426bc39596\nparent c1758d5918b8c5e99b34c83e83266dc5f79b0da7\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1566033225 +0200\ncommitter GitHub <noreply@github.com> 1566033225 +0200\n\nRollup merge of #63559 - eddyb:v0-mangling-off-by-1, r=estebank\n\nrustc_codegen_utils: account for 1-indexed anonymous lifetimes in v0 mangling.\n\nI don't really understand why `anonymize_late_bound_regions` starts with `BrAnon(1)` instead of `BrAnon(0)`, but it does (maybe @nikomatsakis knows?): https://github.com/rust-lang/rust/blob/c43d03a19f326f4a323569328cc501e86eb6d22e/src/librustc/ty/fold.rs#L696-L712\n\nThankfully, the mangling format and demangler implementations are fine, and I just needed to offset the anonymized lifetime indices by `1` to get the correct mangling.\n\ncc @alexcrichton @michaelwoerister\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a053baefebb56b59bd6c40a3ca0726efc18f4209", "html_url": "https://github.com/rust-lang/rust/commit/a053baefebb56b59bd6c40a3ca0726efc18f4209", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a053baefebb56b59bd6c40a3ca0726efc18f4209/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5e597875b73e651c5dea200754489f426bc39596", "url": "https://api.github.com/repos/rust-lang/rust/commits/5e597875b73e651c5dea200754489f426bc39596", "html_url": "https://github.com/rust-lang/rust/commit/5e597875b73e651c5dea200754489f426bc39596"}, {"sha": "c1758d5918b8c5e99b34c83e83266dc5f79b0da7", "url": "https://api.github.com/repos/rust-lang/rust/commits/c1758d5918b8c5e99b34c83e83266dc5f79b0da7", "html_url": "https://github.com/rust-lang/rust/commit/c1758d5918b8c5e99b34c83e83266dc5f79b0da7"}], "stats": {"total": 24, "additions": 16, "deletions": 8}, "files": [{"sha": "8d6a1d757e014977420ea636bcf74b73b9e2a139", "filename": "src/librustc_codegen_utils/symbol_names/v0.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/a053baefebb56b59bd6c40a3ca0726efc18f4209/src%2Flibrustc_codegen_utils%2Fsymbol_names%2Fv0.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a053baefebb56b59bd6c40a3ca0726efc18f4209/src%2Flibrustc_codegen_utils%2Fsymbol_names%2Fv0.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_utils%2Fsymbol_names%2Fv0.rs?ref=a053baefebb56b59bd6c40a3ca0726efc18f4209", "patch": "@@ -198,10 +198,14 @@ impl SymbolMangler<'tcx> {\n \n         let lifetimes = regions.into_iter().map(|br| {\n             match br {\n-                ty::BrAnon(i) => i + 1,\n+                ty::BrAnon(i) => {\n+                    // FIXME(eddyb) for some reason, `anonymize_late_bound_regions` starts at `1`.\n+                    assert_ne!(i, 0);\n+                    i - 1\n+                },\n                 _ => bug!(\"symbol_names: non-anonymized region `{:?}` in `{:?}`\", br, value),\n             }\n-        }).max().unwrap_or(0);\n+        }).max().map_or(0, |max| max + 1);\n \n         self.push_opt_integer_62(\"G\", lifetimes as u64);\n         lifetime_depths.end += lifetimes;\n@@ -297,6 +301,10 @@ impl Printer<'tcx> for SymbolMangler<'tcx> {\n             // Late-bound lifetimes use indices starting at 1,\n             // see `BinderLevel` for more details.\n             ty::ReLateBound(debruijn, ty::BrAnon(i)) => {\n+                // FIXME(eddyb) for some reason, `anonymize_late_bound_regions` starts at `1`.\n+                assert_ne!(i, 0);\n+                let i = i - 1;\n+\n                 let binder = &self.binders[self.binders.len() - 1 - debruijn.index()];\n                 let depth = binder.lifetime_depths.start + i;\n "}, {"sha": "137b72dcd9c4468338e90305c105b00f5d28394c", "filename": "src/test/ui/symbol-names/impl1.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a053baefebb56b59bd6c40a3ca0726efc18f4209/src%2Ftest%2Fui%2Fsymbol-names%2Fimpl1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a053baefebb56b59bd6c40a3ca0726efc18f4209/src%2Ftest%2Fui%2Fsymbol-names%2Fimpl1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsymbol-names%2Fimpl1.rs?ref=a053baefebb56b59bd6c40a3ca0726efc18f4209", "patch": "@@ -64,9 +64,9 @@ fn main() {\n             //[legacy]~^ ERROR symbol-name(_ZN198_$LT$$u5b$$RF$dyn$u20$impl1..Foo$u2b$Assoc$u20$$u3d$$u20$extern$u20$$u22$C$u22$$u20$fn$LP$$RF$u8$RP$$u2b$impl1..AutoTrait$u3b$$u20$_$u5d$$u20$as$u20$impl1..main..$u7b$$u7b$closure$u7d$$u7d$..Bar$GT$6method\n             //[legacy]~| ERROR demangling(<[&dyn impl1::Foo+Assoc = extern \"C\" fn(&u8)+impl1::AutoTrait; _] as impl1::main::{{closure}}::Bar>::method\n             //[legacy]~| ERROR demangling-alt(<[&dyn impl1::Foo+Assoc = extern \"C\" fn(&u8)+impl1::AutoTrait; _] as impl1::main::{{closure}}::Bar>::method)\n-             //[v0]~^^^^ ERROR symbol-name(_RNvXNCNvCs4fqI2P2rA04_5impl14mains_0ARDNtB6_3Foop5AssocFG0_KCRL0_hEuNtB6_9AutoTraitEL_j3_NtB2_3Bar6method)\n-                //[v0]~| ERROR demangling(<[&dyn impl1[317d481089b8c8fe]::Foo<Assoc = for<'a, 'b> extern \"C\" fn(&'b u8)> + impl1[317d481089b8c8fe]::AutoTrait; 3: usize] as impl1[317d481089b8c8fe]::main::{closure#1}::Bar>::method)\n-                //[v0]~| ERROR demangling-alt(<[&dyn impl1::Foo<Assoc = for<'a, 'b> extern \"C\" fn(&'b u8)> + impl1::AutoTrait; 3] as impl1::main::{closure#1}::Bar>::method)\n+             //[v0]~^^^^ ERROR symbol-name(_RNvXNCNvCs4fqI2P2rA04_5impl14mains_0ARDNtB6_3Foop5AssocFG_KCRL0_hEuNtB6_9AutoTraitEL_j3_NtB2_3Bar6method)\n+                //[v0]~| ERROR demangling(<[&dyn impl1[317d481089b8c8fe]::Foo<Assoc = for<'a> extern \"C\" fn(&'a u8)> + impl1[317d481089b8c8fe]::AutoTrait; 3: usize] as impl1[317d481089b8c8fe]::main::{closure#1}::Bar>::method)\n+                //[v0]~| ERROR demangling-alt(<[&dyn impl1::Foo<Assoc = for<'a> extern \"C\" fn(&'a u8)> + impl1::AutoTrait; 3] as impl1::main::{closure#1}::Bar>::method)\n             #[rustc_def_path]\n             //[legacy]~^ ERROR def-path(<[&dyn Foo<Assoc = for<'r> extern \"C\" fn(&'r u8)> + AutoTrait; _] as main::{{closure}}#1::Bar>::method)\n                //[v0]~^^ ERROR def-path(<[&dyn Foo<Assoc = for<'r> extern \"C\" fn(&'r u8)> + AutoTrait; _] as main::{{closure}}#1::Bar>::method)"}, {"sha": "e024799df867cf4dc7c55e86ebec6dfd37805cc0", "filename": "src/test/ui/symbol-names/impl1.v0.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a053baefebb56b59bd6c40a3ca0726efc18f4209/src%2Ftest%2Fui%2Fsymbol-names%2Fimpl1.v0.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a053baefebb56b59bd6c40a3ca0726efc18f4209/src%2Ftest%2Fui%2Fsymbol-names%2Fimpl1.v0.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsymbol-names%2Fimpl1.v0.stderr?ref=a053baefebb56b59bd6c40a3ca0726efc18f4209", "patch": "@@ -46,19 +46,19 @@ error: def-path(bar::<impl foo::Foo>::baz)\n LL |         #[rustc_def_path]\n    |         ^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RNvXNCNvCs4fqI2P2rA04_5impl14mains_0ARDNtB6_3Foop5AssocFG0_KCRL0_hEuNtB6_9AutoTraitEL_j3_NtB2_3Bar6method)\n+error: symbol-name(_RNvXNCNvCs4fqI2P2rA04_5impl14mains_0ARDNtB6_3Foop5AssocFG_KCRL0_hEuNtB6_9AutoTraitEL_j3_NtB2_3Bar6method)\n   --> $DIR/impl1.rs:63:13\n    |\n LL |             #[rustc_symbol_name]\n    |             ^^^^^^^^^^^^^^^^^^^^\n \n-error: demangling(<[&dyn impl1[317d481089b8c8fe]::Foo<Assoc = for<'a, 'b> extern \"C\" fn(&'b u8)> + impl1[317d481089b8c8fe]::AutoTrait; 3: usize] as impl1[317d481089b8c8fe]::main::{closure#1}::Bar>::method)\n+error: demangling(<[&dyn impl1[317d481089b8c8fe]::Foo<Assoc = for<'a> extern \"C\" fn(&'a u8)> + impl1[317d481089b8c8fe]::AutoTrait; 3: usize] as impl1[317d481089b8c8fe]::main::{closure#1}::Bar>::method)\n   --> $DIR/impl1.rs:63:13\n    |\n LL |             #[rustc_symbol_name]\n    |             ^^^^^^^^^^^^^^^^^^^^\n \n-error: demangling-alt(<[&dyn impl1::Foo<Assoc = for<'a, 'b> extern \"C\" fn(&'b u8)> + impl1::AutoTrait; 3] as impl1::main::{closure#1}::Bar>::method)\n+error: demangling-alt(<[&dyn impl1::Foo<Assoc = for<'a> extern \"C\" fn(&'a u8)> + impl1::AutoTrait; 3] as impl1::main::{closure#1}::Bar>::method)\n   --> $DIR/impl1.rs:63:13\n    |\n LL |             #[rustc_symbol_name]"}]}