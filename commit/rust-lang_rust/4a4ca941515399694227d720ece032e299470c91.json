{"sha": "4a4ca941515399694227d720ece032e299470c91", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRhNGNhOTQxNTE1Mzk5Njk0MjI3ZDcyMGVjZTAzMmUyOTk0NzBjOTE=", "commit": {"author": {"name": "Caleb Zulawski", "email": "caleb.zulawski@gmail.com", "date": "2021-09-16T02:59:49Z"}, "committer": {"name": "Caleb Zulawski", "email": "caleb.zulawski@gmail.com", "date": "2021-09-16T02:59:49Z"}, "message": "Fix shuffle index constant not being monomorphized.", "tree": {"sha": "3c80702cc4ac3f93a893e8ea38788f3ecfa25321", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3c80702cc4ac3f93a893e8ea38788f3ecfa25321"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4a4ca941515399694227d720ece032e299470c91", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4a4ca941515399694227d720ece032e299470c91", "html_url": "https://github.com/rust-lang/rust/commit/4a4ca941515399694227d720ece032e299470c91", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4a4ca941515399694227d720ece032e299470c91/comments", "author": {"login": "calebzulawski", "id": 563826, "node_id": "MDQ6VXNlcjU2MzgyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/563826?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebzulawski", "html_url": "https://github.com/calebzulawski", "followers_url": "https://api.github.com/users/calebzulawski/followers", "following_url": "https://api.github.com/users/calebzulawski/following{/other_user}", "gists_url": "https://api.github.com/users/calebzulawski/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebzulawski/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebzulawski/subscriptions", "organizations_url": "https://api.github.com/users/calebzulawski/orgs", "repos_url": "https://api.github.com/users/calebzulawski/repos", "events_url": "https://api.github.com/users/calebzulawski/events{/privacy}", "received_events_url": "https://api.github.com/users/calebzulawski/received_events", "type": "User", "site_admin": false}, "committer": {"login": "calebzulawski", "id": 563826, "node_id": "MDQ6VXNlcjU2MzgyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/563826?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebzulawski", "html_url": "https://github.com/calebzulawski", "followers_url": "https://api.github.com/users/calebzulawski/followers", "following_url": "https://api.github.com/users/calebzulawski/following{/other_user}", "gists_url": "https://api.github.com/users/calebzulawski/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebzulawski/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebzulawski/subscriptions", "organizations_url": "https://api.github.com/users/calebzulawski/orgs", "repos_url": "https://api.github.com/users/calebzulawski/repos", "events_url": "https://api.github.com/users/calebzulawski/events{/privacy}", "received_events_url": "https://api.github.com/users/calebzulawski/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1b3fe755ea3d39a1875f627fab5def4eae03e912", "url": "https://api.github.com/repos/rust-lang/rust/commits/1b3fe755ea3d39a1875f627fab5def4eae03e912", "html_url": "https://github.com/rust-lang/rust/commit/1b3fe755ea3d39a1875f627fab5def4eae03e912"}], "stats": {"total": 48, "additions": 46, "deletions": 2}, "files": [{"sha": "c7c577e6c78d1dc548f090d968508de8254cd9e5", "filename": "compiler/rustc_codegen_ssa/src/mir/block.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/4a4ca941515399694227d720ece032e299470c91/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4a4ca941515399694227d720ece032e299470c91/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs?ref=4a4ca941515399694227d720ece032e299470c91", "patch": "@@ -665,8 +665,12 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                         if i == 2 && intrinsic.as_str().starts_with(\"simd_shuffle\") {\n                             if let mir::Operand::Constant(constant) = arg {\n                                 let c = self.eval_mir_constant(constant);\n-                                let (llval, ty) =\n-                                    self.simd_shuffle_indices(&bx, constant.span, constant.ty(), c);\n+                                let (llval, ty) = self.simd_shuffle_indices(\n+                                    &bx,\n+                                    constant.span,\n+                                    self.monomorphize(constant.ty()),\n+                                    c,\n+                                );\n                                 return OperandRef {\n                                     val: Immediate(llval),\n                                     layout: bx.layout_of(ty),"}, {"sha": "2467baa08b0a721011f74c63fc0b97fb27617436", "filename": "src/test/ui/simd/monomorphize-shuffle-index.rs", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/4a4ca941515399694227d720ece032e299470c91/src%2Ftest%2Fui%2Fsimd%2Fmonomorphize-shuffle-index.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4a4ca941515399694227d720ece032e299470c91/src%2Ftest%2Fui%2Fsimd%2Fmonomorphize-shuffle-index.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsimd%2Fmonomorphize-shuffle-index.rs?ref=4a4ca941515399694227d720ece032e299470c91", "patch": "@@ -0,0 +1,40 @@\n+//run-pass\n+#![feature(repr_simd, platform_intrinsics)]\n+\n+extern \"platform-intrinsic\" {\n+    fn simd_shuffle<T, I, U>(a: T, b: T, i: I) -> U;\n+}\n+\n+#[derive(Copy, Clone)]\n+#[repr(simd)]\n+struct Simd<T, const N: usize>([T; N]);\n+\n+trait Shuffle<const N: usize> {\n+    const I: [u32; N];\n+\n+    unsafe fn shuffle<T, const M: usize>(&self, a: Simd<T, M>, b: Simd<T, M>) -> Simd<T, N> {\n+        simd_shuffle(a, b, Self::I)\n+    }\n+}\n+\n+fn main() {\n+    struct I1;\n+    impl Shuffle<4> for I1 {\n+        const I: [u32; 4] = [0, 2, 4, 6];\n+    }\n+\n+    struct I2;\n+    impl Shuffle<2> for I2 {\n+        const I: [u32; 2] = [1, 5];\n+    }\n+\n+    let a = Simd::<u8, 4>([0, 1, 2, 3]);\n+    let b = Simd::<u8, 4>([4, 5, 6, 7]);\n+    unsafe {\n+        let x: Simd<u8, 4> = I1.shuffle(a, b);\n+        assert_eq!(x.0, [0, 2, 4, 6]);\n+\n+        let y: Simd<u8, 2> = I2.shuffle(a, b);\n+        assert_eq!(y.0, [1, 5]);\n+    }\n+}"}]}