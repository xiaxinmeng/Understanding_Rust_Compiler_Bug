{"sha": "55492de54557c3308795282bd96c8120ad66b62e", "node_id": "C_kwDOAAsO6NoAKDU1NDkyZGU1NDU1N2MzMzA4Nzk1MjgyYmQ5NmM4MTIwYWQ2NmI2MmU", "commit": {"author": {"name": "Scott McMurray", "email": "scottmcm@users.noreply.github.com", "date": "2022-09-26T07:51:42Z"}, "committer": {"name": "Scott McMurray", "email": "scottmcm@users.noreply.github.com", "date": "2022-09-26T18:38:18Z"}, "message": "Use a macro to not have to copy-paste `ConstFnMutClosure::new(&mut fold, NeverShortCircuit::wrap_mut_2_imp)).0` everywhere\n\nAlso use that macro to replace a bunch of places that had custom closure-wrappers.", "tree": {"sha": "3a308f771ff9061c6600bbdd4fb90aa2936a9fbf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3a308f771ff9061c6600bbdd4fb90aa2936a9fbf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/55492de54557c3308795282bd96c8120ad66b62e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/55492de54557c3308795282bd96c8120ad66b62e", "html_url": "https://github.com/rust-lang/rust/commit/55492de54557c3308795282bd96c8120ad66b62e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/55492de54557c3308795282bd96c8120ad66b62e/comments", "author": {"login": "scottmcm", "id": 18526288, "node_id": "MDQ6VXNlcjE4NTI2Mjg4", "avatar_url": "https://avatars.githubusercontent.com/u/18526288?v=4", "gravatar_id": "", "url": "https://api.github.com/users/scottmcm", "html_url": "https://github.com/scottmcm", "followers_url": "https://api.github.com/users/scottmcm/followers", "following_url": "https://api.github.com/users/scottmcm/following{/other_user}", "gists_url": "https://api.github.com/users/scottmcm/gists{/gist_id}", "starred_url": "https://api.github.com/users/scottmcm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/scottmcm/subscriptions", "organizations_url": "https://api.github.com/users/scottmcm/orgs", "repos_url": "https://api.github.com/users/scottmcm/repos", "events_url": "https://api.github.com/users/scottmcm/events{/privacy}", "received_events_url": "https://api.github.com/users/scottmcm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "scottmcm", "id": 18526288, "node_id": "MDQ6VXNlcjE4NTI2Mjg4", "avatar_url": "https://avatars.githubusercontent.com/u/18526288?v=4", "gravatar_id": "", "url": "https://api.github.com/users/scottmcm", "html_url": "https://github.com/scottmcm", "followers_url": "https://api.github.com/users/scottmcm/followers", "following_url": "https://api.github.com/users/scottmcm/following{/other_user}", "gists_url": "https://api.github.com/users/scottmcm/gists{/gist_id}", "starred_url": "https://api.github.com/users/scottmcm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/scottmcm/subscriptions", "organizations_url": "https://api.github.com/users/scottmcm/orgs", "repos_url": "https://api.github.com/users/scottmcm/repos", "events_url": "https://api.github.com/users/scottmcm/events{/privacy}", "received_events_url": "https://api.github.com/users/scottmcm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fe217c28ffc6955f0927d8e8715d43d727debe5a", "url": "https://api.github.com/repos/rust-lang/rust/commits/fe217c28ffc6955f0927d8e8715d43d727debe5a", "html_url": "https://github.com/rust-lang/rust/commit/fe217c28ffc6955f0927d8e8715d43d727debe5a"}], "stats": {"total": 149, "additions": 35, "deletions": 114}, "files": [{"sha": "d4fb886101fe78aff33812627e5c10748edeb4b3", "filename": "library/core/src/iter/adapters/array_chunks.rs", "status": "modified", "additions": 3, "deletions": 16, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Farray_chunks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Farray_chunks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Farray_chunks.rs?ref=55492de54557c3308795282bd96c8120ad66b62e", "patch": "@@ -1,7 +1,6 @@\n use crate::array;\n-use crate::const_closure::ConstFnMutClosure;\n use crate::iter::{ByRefSized, FusedIterator, Iterator};\n-use crate::ops::{ControlFlow, NeverShortCircuit, Try};\n+use crate::ops::{ControlFlow, Try};\n \n /// An iterator over `N` elements of the iterator at a time.\n ///\n@@ -83,13 +82,7 @@ where\n         }\n     }\n \n-    fn fold<B, F>(mut self, init: B, mut f: F) -> B\n-    where\n-        Self: Sized,\n-        F: FnMut(B, Self::Item) -> B,\n-    {\n-        self.try_fold(init, ConstFnMutClosure::new(&mut f, NeverShortCircuit::wrap_mut_2_imp)).0\n-    }\n+    impl_fold_via_try_fold! { fold -> try_fold }\n }\n \n #[unstable(feature = \"iter_array_chunks\", reason = \"recently added\", issue = \"100450\")]\n@@ -127,13 +120,7 @@ where\n         try { acc }\n     }\n \n-    fn rfold<B, F>(mut self, init: B, mut f: F) -> B\n-    where\n-        Self: Sized,\n-        F: FnMut(B, Self::Item) -> B,\n-    {\n-        self.try_rfold(init, ConstFnMutClosure::new(&mut f, NeverShortCircuit::wrap_mut_2_imp)).0\n-    }\n+    impl_fold_via_try_fold! { rfold -> try_rfold }\n }\n \n impl<I, const N: usize> ArrayChunks<I, N>"}, {"sha": "fbdeca4d4ee4f7e689e8f7fdfb0a8b57e75ebb83", "filename": "library/core/src/iter/adapters/map_while.rs", "status": "modified", "additions": 1, "deletions": 13, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fmap_while.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fmap_while.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fmap_while.rs?ref=55492de54557c3308795282bd96c8120ad66b62e", "patch": "@@ -64,19 +64,7 @@ where\n         .into_try()\n     }\n \n-    #[inline]\n-    fn fold<Acc, Fold>(mut self, init: Acc, fold: Fold) -> Acc\n-    where\n-        Self: Sized,\n-        Fold: FnMut(Acc, Self::Item) -> Acc,\n-    {\n-        #[inline]\n-        fn ok<B, T>(mut f: impl FnMut(B, T) -> B) -> impl FnMut(B, T) -> Result<B, !> {\n-            move |acc, x| Ok(f(acc, x))\n-        }\n-\n-        self.try_fold(init, ok(fold)).unwrap()\n-    }\n+    impl_fold_via_try_fold! { fold -> try_fold }\n }\n \n #[unstable(issue = \"none\", feature = \"inplace_iteration\")]"}, {"sha": "8cc2b7cec41650f273669b836593f809cbe4a899", "filename": "library/core/src/iter/adapters/mod.rs", "status": "modified", "additions": 2, "deletions": 9, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fmod.rs?ref=55492de54557c3308795282bd96c8120ad66b62e", "patch": "@@ -1,6 +1,5 @@\n-use crate::const_closure::ConstFnMutClosure;\n use crate::iter::{InPlaceIterable, Iterator};\n-use crate::ops::{ChangeOutputType, ControlFlow, FromResidual, NeverShortCircuit, Residual, Try};\n+use crate::ops::{ChangeOutputType, ControlFlow, FromResidual, Residual, Try};\n \n mod array_chunks;\n mod by_ref_sized;\n@@ -204,13 +203,7 @@ where\n             .into_try()\n     }\n \n-    fn fold<B, F>(mut self, init: B, mut fold: F) -> B\n-    where\n-        Self: Sized,\n-        F: FnMut(B, Self::Item) -> B,\n-    {\n-        self.try_fold(init, ConstFnMutClosure::new(&mut fold, NeverShortCircuit::wrap_mut_2_imp)).0\n-    }\n+    impl_fold_via_try_fold! { fold -> try_fold }\n }\n \n #[unstable(issue = \"none\", feature = \"inplace_iteration\")]"}, {"sha": "62470512cc747f9ee3ea975584de5a21944ae8fb", "filename": "library/core/src/iter/adapters/scan.rs", "status": "modified", "additions": 1, "deletions": 13, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fscan.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fscan.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fscan.rs?ref=55492de54557c3308795282bd96c8120ad66b62e", "patch": "@@ -74,19 +74,7 @@ where\n         self.iter.try_fold(init, scan(state, f, fold)).into_try()\n     }\n \n-    #[inline]\n-    fn fold<Acc, Fold>(mut self, init: Acc, fold: Fold) -> Acc\n-    where\n-        Self: Sized,\n-        Fold: FnMut(Acc, Self::Item) -> Acc,\n-    {\n-        #[inline]\n-        fn ok<B, T>(mut f: impl FnMut(B, T) -> B) -> impl FnMut(B, T) -> Result<B, !> {\n-            move |acc, x| Ok(f(acc, x))\n-        }\n-\n-        self.try_fold(init, ok(fold)).unwrap()\n-    }\n+    impl_fold_via_try_fold! { fold -> try_fold }\n }\n \n #[unstable(issue = \"none\", feature = \"inplace_iteration\")]"}, {"sha": "c6334880db57cdbc346f42c0b2e3f779f6fef1e3", "filename": "library/core/src/iter/adapters/skip.rs", "status": "modified", "additions": 1, "deletions": 11, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fskip.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fskip.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fskip.rs?ref=55492de54557c3308795282bd96c8120ad66b62e", "patch": "@@ -206,17 +206,7 @@ where\n         if n == 0 { try { init } } else { self.iter.try_rfold(init, check(n, fold)).into_try() }\n     }\n \n-    fn rfold<Acc, Fold>(mut self, init: Acc, fold: Fold) -> Acc\n-    where\n-        Fold: FnMut(Acc, Self::Item) -> Acc,\n-    {\n-        #[inline]\n-        fn ok<Acc, T>(mut f: impl FnMut(Acc, T) -> Acc) -> impl FnMut(Acc, T) -> Result<Acc, !> {\n-            move |acc, x| Ok(f(acc, x))\n-        }\n-\n-        self.try_rfold(init, ok(fold)).unwrap()\n-    }\n+    impl_fold_via_try_fold! { rfold -> try_rfold }\n \n     #[inline]\n     fn advance_back_by(&mut self, n: usize) -> Result<(), usize> {"}, {"sha": "58a0b9d7bbe99cd9c6965a61ef5e1509147cef07", "filename": "library/core/src/iter/adapters/take.rs", "status": "modified", "additions": 1, "deletions": 13, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Ftake.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Ftake.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Ftake.rs?ref=55492de54557c3308795282bd96c8120ad66b62e", "patch": "@@ -98,19 +98,7 @@ where\n         }\n     }\n \n-    #[inline]\n-    fn fold<Acc, Fold>(mut self, init: Acc, fold: Fold) -> Acc\n-    where\n-        Self: Sized,\n-        Fold: FnMut(Acc, Self::Item) -> Acc,\n-    {\n-        #[inline]\n-        fn ok<B, T>(mut f: impl FnMut(B, T) -> B) -> impl FnMut(B, T) -> Result<B, !> {\n-            move |acc, x| Ok(f(acc, x))\n-        }\n-\n-        self.try_fold(init, ok(fold)).unwrap()\n-    }\n+    impl_fold_via_try_fold! { fold -> try_fold }\n \n     #[inline]\n     #[rustc_inherit_overflow_checks]"}, {"sha": "ec66dc3aec3602cc814c0345df547d5f8c8854c5", "filename": "library/core/src/iter/adapters/take_while.rs", "status": "modified", "additions": 1, "deletions": 13, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Ftake_while.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Ftake_while.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Ftake_while.rs?ref=55492de54557c3308795282bd96c8120ad66b62e", "patch": "@@ -94,19 +94,7 @@ where\n         }\n     }\n \n-    #[inline]\n-    fn fold<Acc, Fold>(mut self, init: Acc, fold: Fold) -> Acc\n-    where\n-        Self: Sized,\n-        Fold: FnMut(Acc, Self::Item) -> Acc,\n-    {\n-        #[inline]\n-        fn ok<B, T>(mut f: impl FnMut(B, T) -> B) -> impl FnMut(B, T) -> Result<B, !> {\n-            move |acc, x| Ok(f(acc, x))\n-        }\n-\n-        self.try_fold(init, ok(fold)).unwrap()\n-    }\n+    impl_fold_via_try_fold! { fold -> try_fold }\n }\n \n #[stable(feature = \"fused\", since = \"1.26.0\")]"}, {"sha": "ef0f397825b15ebb0c96d17fea966d2201321aae", "filename": "library/core/src/iter/mod.rs", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Fmod.rs?ref=55492de54557c3308795282bd96c8120ad66b62e", "patch": "@@ -352,6 +352,29 @@\n \n #![stable(feature = \"rust1\", since = \"1.0.0\")]\n \n+// This needs to be up here in order to be usable in the child modules\n+macro_rules! impl_fold_via_try_fold {\n+    (fold -> try_fold) => {\n+        impl_fold_via_try_fold! { @internal fold -> try_fold }\n+    };\n+    (rfold -> try_rfold) => {\n+        impl_fold_via_try_fold! { @internal rfold -> try_rfold }\n+    };\n+    (@internal $fold:ident -> $try_fold:ident) => {\n+        #[inline]\n+        fn $fold<AAA, FFF>(mut self, init: AAA, mut fold: FFF) -> AAA\n+        where\n+            FFF: FnMut(AAA, Self::Item) -> AAA,\n+        {\n+            use crate::const_closure::ConstFnMutClosure;\n+            use crate::ops::NeverShortCircuit;\n+\n+            let fold = ConstFnMutClosure::new(&mut fold, NeverShortCircuit::wrap_mut_2_imp);\n+            self.$try_fold(init, fold).0\n+        }\n+    };\n+}\n+\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n pub use self::traits::Iterator;\n "}, {"sha": "ac7b389b15b4d5e9e00e99ef2a4740a7c51b2971", "filename": "library/core/src/iter/range.rs", "status": "modified", "additions": 2, "deletions": 26, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Frange.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55492de54557c3308795282bd96c8120ad66b62e/library%2Fcore%2Fsrc%2Fiter%2Frange.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Frange.rs?ref=55492de54557c3308795282bd96c8120ad66b62e", "patch": "@@ -1150,19 +1150,7 @@ impl<A: Step> Iterator for ops::RangeInclusive<A> {\n         self.spec_try_fold(init, f)\n     }\n \n-    #[inline]\n-    fn fold<B, F>(mut self, init: B, f: F) -> B\n-    where\n-        Self: Sized,\n-        F: FnMut(B, Self::Item) -> B,\n-    {\n-        #[inline]\n-        fn ok<B, T>(mut f: impl FnMut(B, T) -> B) -> impl FnMut(B, T) -> Result<B, !> {\n-            move |acc, x| Ok(f(acc, x))\n-        }\n-\n-        self.try_fold(init, ok(f)).unwrap()\n-    }\n+    impl_fold_via_try_fold! { fold -> try_fold }\n \n     #[inline]\n     fn last(mut self) -> Option<A> {\n@@ -1230,19 +1218,7 @@ impl<A: Step> DoubleEndedIterator for ops::RangeInclusive<A> {\n         self.spec_try_rfold(init, f)\n     }\n \n-    #[inline]\n-    fn rfold<B, F>(mut self, init: B, f: F) -> B\n-    where\n-        Self: Sized,\n-        F: FnMut(B, Self::Item) -> B,\n-    {\n-        #[inline]\n-        fn ok<B, T>(mut f: impl FnMut(B, T) -> B) -> impl FnMut(B, T) -> Result<B, !> {\n-            move |acc, x| Ok(f(acc, x))\n-        }\n-\n-        self.try_rfold(init, ok(f)).unwrap()\n-    }\n+    impl_fold_via_try_fold! { rfold -> try_rfold }\n }\n \n // Safety: See above implementation for `ops::Range<A>`"}]}