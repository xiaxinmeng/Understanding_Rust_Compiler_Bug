{"sha": "797507c58390662098f0d20a9ee89d200f93f11c", "node_id": "C_kwDOAAsO6NoAKDc5NzUwN2M1ODM5MDY2MjA5OGYwZDIwYTllZTg5ZDIwMGY5M2YxMWM", "commit": {"author": {"name": "Nathaniel Hamovitz", "email": "18648574+nhamovitz@users.noreply.github.com", "date": "2021-10-15T03:08:38Z"}, "committer": {"name": "Nathaniel Hamovitz", "email": "18648574+nhamovitz@users.noreply.github.com", "date": "2021-10-18T10:05:18Z"}, "message": "Add boilerplate and basic tests", "tree": {"sha": "32d4c714cff5c958c6cd447fe095648cc9e6b3ad", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/32d4c714cff5c958c6cd447fe095648cc9e6b3ad"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/797507c58390662098f0d20a9ee89d200f93f11c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/797507c58390662098f0d20a9ee89d200f93f11c", "html_url": "https://github.com/rust-lang/rust/commit/797507c58390662098f0d20a9ee89d200f93f11c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/797507c58390662098f0d20a9ee89d200f93f11c/comments", "author": {"login": "nhamovitz", "id": 18648574, "node_id": "MDQ6VXNlcjE4NjQ4NTc0", "avatar_url": "https://avatars.githubusercontent.com/u/18648574?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nhamovitz", "html_url": "https://github.com/nhamovitz", "followers_url": "https://api.github.com/users/nhamovitz/followers", "following_url": "https://api.github.com/users/nhamovitz/following{/other_user}", "gists_url": "https://api.github.com/users/nhamovitz/gists{/gist_id}", "starred_url": "https://api.github.com/users/nhamovitz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nhamovitz/subscriptions", "organizations_url": "https://api.github.com/users/nhamovitz/orgs", "repos_url": "https://api.github.com/users/nhamovitz/repos", "events_url": "https://api.github.com/users/nhamovitz/events{/privacy}", "received_events_url": "https://api.github.com/users/nhamovitz/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nhamovitz", "id": 18648574, "node_id": "MDQ6VXNlcjE4NjQ4NTc0", "avatar_url": "https://avatars.githubusercontent.com/u/18648574?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nhamovitz", "html_url": "https://github.com/nhamovitz", "followers_url": "https://api.github.com/users/nhamovitz/followers", "following_url": "https://api.github.com/users/nhamovitz/following{/other_user}", "gists_url": "https://api.github.com/users/nhamovitz/gists{/gist_id}", "starred_url": "https://api.github.com/users/nhamovitz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nhamovitz/subscriptions", "organizations_url": "https://api.github.com/users/nhamovitz/orgs", "repos_url": "https://api.github.com/users/nhamovitz/repos", "events_url": "https://api.github.com/users/nhamovitz/events{/privacy}", "received_events_url": "https://api.github.com/users/nhamovitz/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "389a74b31aabca4aac3289763eeb2eccedd1b988", "url": "https://api.github.com/repos/rust-lang/rust/commits/389a74b31aabca4aac3289763eeb2eccedd1b988", "html_url": "https://github.com/rust-lang/rust/commit/389a74b31aabca4aac3289763eeb2eccedd1b988"}], "stats": {"total": 85, "additions": 85, "deletions": 0}, "files": [{"sha": "a124bebe92443831df3c5a33d2f150f1d61f1545", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/797507c58390662098f0d20a9ee89d200f93f11c/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/797507c58390662098f0d20a9ee89d200f93f11c/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=797507c58390662098f0d20a9ee89d200f93f11c", "patch": "@@ -3021,6 +3021,7 @@ Released 2018-09-13\n [`too_many_arguments`]: https://rust-lang.github.io/rust-clippy/master/index.html#too_many_arguments\n [`too_many_lines`]: https://rust-lang.github.io/rust-clippy/master/index.html#too_many_lines\n [`toplevel_ref_arg`]: https://rust-lang.github.io/rust-clippy/master/index.html#toplevel_ref_arg\n+[`trailing_zero_sized_array_without_repr_c`]: https://rust-lang.github.io/rust-clippy/master/index.html#trailing_zero_sized_array_without_repr_c\n [`trait_duplication_in_bounds`]: https://rust-lang.github.io/rust-clippy/master/index.html#trait_duplication_in_bounds\n [`transmute_bytes_to_str`]: https://rust-lang.github.io/rust-clippy/master/index.html#transmute_bytes_to_str\n [`transmute_float_to_int`]: https://rust-lang.github.io/rust-clippy/master/index.html#transmute_float_to_int"}, {"sha": "34b87002fa36f161e7a1ef5fa1e71fe6d119a6f0", "filename": "clippy_lints/src/lib.register_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/797507c58390662098f0d20a9ee89d200f93f11c/clippy_lints%2Fsrc%2Flib.register_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/797507c58390662098f0d20a9ee89d200f93f11c/clippy_lints%2Fsrc%2Flib.register_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_lints.rs?ref=797507c58390662098f0d20a9ee89d200f93f11c", "patch": "@@ -443,6 +443,7 @@ store.register_lints(&[\n     temporary_assignment::TEMPORARY_ASSIGNMENT,\n     to_digit_is_some::TO_DIGIT_IS_SOME,\n     to_string_in_display::TO_STRING_IN_DISPLAY,\n+    trailing_zero_sized_array_without_repr_c::TRAILING_ZERO_SIZED_ARRAY_WITHOUT_REPR_C,\n     trait_bounds::TRAIT_DUPLICATION_IN_BOUNDS,\n     trait_bounds::TYPE_REPETITION_IN_BOUNDS,\n     transmute::CROSSPOINTER_TRANSMUTE,"}, {"sha": "325706746db586878a28e8969fb902599aa4d720", "filename": "clippy_lints/src/lib.register_nursery.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/797507c58390662098f0d20a9ee89d200f93f11c/clippy_lints%2Fsrc%2Flib.register_nursery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/797507c58390662098f0d20a9ee89d200f93f11c/clippy_lints%2Fsrc%2Flib.register_nursery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_nursery.rs?ref=797507c58390662098f0d20a9ee89d200f93f11c", "patch": "@@ -25,6 +25,7 @@ store.register_group(true, \"clippy::nursery\", Some(\"clippy_nursery\"), vec![\n     LintId::of(regex::TRIVIAL_REGEX),\n     LintId::of(strings::STRING_LIT_AS_BYTES),\n     LintId::of(suspicious_operation_groupings::SUSPICIOUS_OPERATION_GROUPINGS),\n+    LintId::of(trailing_zero_sized_array_without_repr_c::TRAILING_ZERO_SIZED_ARRAY_WITHOUT_REPR_C),\n     LintId::of(transmute::USELESS_TRANSMUTE),\n     LintId::of(use_self::USE_SELF),\n ])"}, {"sha": "17bffc0830961d7d7c544236a9820085934a942c", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/797507c58390662098f0d20a9ee89d200f93f11c/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/797507c58390662098f0d20a9ee89d200f93f11c/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=797507c58390662098f0d20a9ee89d200f93f11c", "patch": "@@ -355,6 +355,7 @@ mod tabs_in_doc_comments;\n mod temporary_assignment;\n mod to_digit_is_some;\n mod to_string_in_display;\n+mod trailing_zero_sized_array_without_repr_c;\n mod trait_bounds;\n mod transmute;\n mod transmuting_null;"}, {"sha": "9aea22af274fd98e5685ce758d64473f68aaea59", "filename": "clippy_lints/src/trailing_zero_sized_array_without_repr_c.rs", "status": "added", "additions": 58, "deletions": 0, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/797507c58390662098f0d20a9ee89d200f93f11c/clippy_lints%2Fsrc%2Ftrailing_zero_sized_array_without_repr_c.rs", "raw_url": "https://github.com/rust-lang/rust/raw/797507c58390662098f0d20a9ee89d200f93f11c/clippy_lints%2Fsrc%2Ftrailing_zero_sized_array_without_repr_c.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftrailing_zero_sized_array_without_repr_c.rs?ref=797507c58390662098f0d20a9ee89d200f93f11c", "patch": "@@ -0,0 +1,58 @@\n+use clippy_utils::diagnostics::span_lint_and_sugg;\n+use rustc_hir::*;\n+use rustc_lint::{LateContext, LateLintPass};\n+use rustc_session::{declare_lint_pass, declare_tool_lint};\n+\n+declare_clippy_lint! {\n+    /// ### What it does\n+    /// Displays a warning when a struct with a trailing zero-sized array is declared without the `repr(C)` attribute.\n+    ///\n+    /// ### Why is this bad?\n+    /// Zero-sized arrays aren't very useful in Rust itself, so such a struct is likely being created to pass to C code (or in conjuction with manual allocation to make it easy to compute the offset of the array). Either way, `#[repr(C)]` is needed.\n+    ///\n+    /// ### Example\n+    /// ```rust\n+    /// struct RarelyUseful {\n+    ///     some_field: usize,\n+    ///     last: [SomeType; 0],\n+    /// }\n+    /// ```\n+    ///\n+    /// Use instead:\n+    /// ```rust\n+    /// #[repr(C)]\n+    /// struct MakesSense {\n+    ///     some_field: usize,\n+    ///     last: [SomeType; 0],\n+    /// }\n+    /// ```\n+    pub TRAILING_ZERO_SIZED_ARRAY_WITHOUT_REPR_C,\n+    nursery,\n+    \"struct with a trailing zero-sized array but without `repr(C)`\"\n+}\n+declare_lint_pass!(TrailingZeroSizedArrayWithoutReprC => [TRAILING_ZERO_SIZED_ARRAY_WITHOUT_REPR_C]);\n+\n+impl LateLintPass<'_> for TrailingZeroSizedArrayWithoutReprC {\n+    fn check_struct_def(&mut self, _: &LateContext<'tcx>, _: &'tcx rustc_hir::VariantData<'tcx>) {}\n+\n+    fn check_struct_def_post(&mut self, _: &LateContext<'tcx>, _: &'tcx rustc_hir::VariantData<'tcx>) {}\n+    // https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/sty/enum.TyKind.html#variant.Array in latepass\n+    // or https://doc.rust-lang.org/nightly/nightly-rustc/rustc_ast/ast/enum.TyKind.html#variant.Array in early pass\n+\n+    fn check_field_def(&mut self, _: &LateContext<'tcx>, _: &'tcx rustc_hir::FieldDef<'tcx>) {}\n+\n+    fn check_attribute(&mut self, _: &LateContext<'tcx>, _: &'tcx rustc_ast::Attribute) {}\n+\n+    fn enter_lint_attrs(&mut self, _: &LateContext<'tcx>, _: &'tcx [rustc_ast::Attribute]) {}\n+\n+    fn exit_lint_attrs(&mut self, _: &LateContext<'tcx>, _: &'tcx [rustc_ast::Attribute]) {}\n+}\n+//\n+// TODO: Register the lint pass in `clippy_lints/src/lib.rs`,\n+//       e.g. store.register_late_pass(||\n+// Box::new(trailing_zero_sized_array_without_repr_c::TrailingZeroSizedArrayWithoutReprC));\n+\n+\n+fn temp_alert() {\n+    span_lint_and_sugg(cx, lint, sp, msg, help, sugg, applicability)\n+}\n\\ No newline at end of file"}, {"sha": "2a0f432bc2d0e84f3a189b8f88f670b42441dee1", "filename": "tests/ui/trailing_zero_sized_array_without_repr_c.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/797507c58390662098f0d20a9ee89d200f93f11c/tests%2Fui%2Ftrailing_zero_sized_array_without_repr_c.rs", "raw_url": "https://github.com/rust-lang/rust/raw/797507c58390662098f0d20a9ee89d200f93f11c/tests%2Fui%2Ftrailing_zero_sized_array_without_repr_c.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftrailing_zero_sized_array_without_repr_c.rs?ref=797507c58390662098f0d20a9ee89d200f93f11c", "patch": "@@ -0,0 +1,23 @@\n+#![warn(clippy::trailing_zero_sized_array_without_repr_c)]\n+\n+struct RarelyUseful {\n+    field: i32,\n+    last: [SomeType; 0],\n+}\n+\n+#[repr(C)]\n+struct GoodReason {\n+    field: i32,\n+    last: [SomeType; 0],\n+}\n+\n+struct OnlyFieldIsZeroSizeArray {\n+    first_and_last: [SomeType; 0],\n+}\n+\n+struct GenericArrayType<T> {\n+    field: i32,\n+    last: [T; 0],\n+}\n+\n+fn main() {}"}]}