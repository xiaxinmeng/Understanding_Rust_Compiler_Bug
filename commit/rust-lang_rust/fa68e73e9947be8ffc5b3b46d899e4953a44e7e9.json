{"sha": "fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "node_id": "C_kwDOAAsO6NoAKGZhNjhlNzNlOTk0N2JlOGZmYzViM2I0NmQ4OTllNDk1M2E0NGU3ZTk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-11T08:46:21Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-11T08:46:21Z"}, "message": "Auto merge of #97903 - est31:unused_macro_rules_compile_error, r=petrochenkov\n\nNever regard macro rules with compile_error! invocations as unused\n\nThe very point of compile_error! is to never be reached, and one of\nthe use cases of the macro, currently also listed as examples in the\ndocumentation of compile_error, is to create nicer errors for wrong\nmacro invocations. Thus, we should never warn about unused macro arms\nthat contain invocations of compile_error.\n\nSee also https://github.com/rust-lang/rust/pull/96150#issuecomment-1126599107 and the discussion after that.\n\nFurthermore, the PR also contains two commits to silence `unused_macro_rules` when a macro has an invalid rule, and to add a test that `unused_macros` does not behave badly in the same situation.\n\nr? `@petrochenkov` as I've talked to them about this", "tree": {"sha": "db2e51830b65497d144628e16f86e76893791f64", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/db2e51830b65497d144628e16f86e76893791f64"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "html_url": "https://github.com/rust-lang/rust/commit/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7092d42c04a56378d2e748f98169b728b1f1d5d1", "url": "https://api.github.com/repos/rust-lang/rust/commits/7092d42c04a56378d2e748f98169b728b1f1d5d1", "html_url": "https://github.com/rust-lang/rust/commit/7092d42c04a56378d2e748f98169b728b1f1d5d1"}, {"sha": "787e24cdfd5bef5136540287dd918e48b8a645db", "url": "https://api.github.com/repos/rust-lang/rust/commits/787e24cdfd5bef5136540287dd918e48b8a645db", "html_url": "https://github.com/rust-lang/rust/commit/787e24cdfd5bef5136540287dd918e48b8a645db"}], "stats": {"total": 168, "additions": 158, "deletions": 10}, "files": [{"sha": "86ff110eec183f954910fdabc1a0813a5fe44d76", "filename": "compiler/rustc_expand/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/compiler%2Frustc_expand%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/compiler%2Frustc_expand%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Flib.rs?ref=fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "patch": "@@ -1,4 +1,5 @@\n #![allow(rustc::potential_query_instability)]\n+#![feature(array_windows)]\n #![feature(associated_type_bounds)]\n #![feature(associated_type_defaults)]\n #![feature(if_let_guard)]"}, {"sha": "04af1eaf67b6d187d9c6d1a81bf9405f46bf45b5", "filename": "compiler/rustc_expand/src/mbe/macro_rules.rs", "status": "modified", "additions": 40, "deletions": 6, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_rules.rs?ref=fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "patch": "@@ -380,7 +380,7 @@ pub fn compile_declarative_macro(\n     features: &Features,\n     def: &ast::Item,\n     edition: Edition,\n-) -> (SyntaxExtension, Vec<Span>) {\n+) -> (SyntaxExtension, Vec<(usize, Span)>) {\n     debug!(\"compile_declarative_macro: {:?}\", def);\n     let mk_syn_ext = |expander| {\n         SyntaxExtension::new(\n@@ -539,11 +539,22 @@ pub fn compile_declarative_macro(\n         None => {}\n     }\n \n-    // Compute the spans of the macro rules\n-    // We only take the span of the lhs here,\n-    // so that the spans of created warnings are smaller.\n-    let rule_spans = if def.id != DUMMY_NODE_ID {\n-        lhses.iter().map(|lhs| lhs.span()).collect::<Vec<_>>()\n+    // Compute the spans of the macro rules for unused rule linting.\n+    // To avoid warning noise, only consider the rules of this\n+    // macro for the lint, if all rules are valid.\n+    // Also, we are only interested in non-foreign macros.\n+    let rule_spans = if valid && def.id != DUMMY_NODE_ID {\n+        lhses\n+            .iter()\n+            .zip(rhses.iter())\n+            .enumerate()\n+            // If the rhs contains an invocation like compile_error!,\n+            // don't consider the rule for the unused rule lint.\n+            .filter(|(_idx, (_lhs, rhs))| !has_compile_error_macro(rhs))\n+            // We only take the span of the lhs here,\n+            // so that the spans of created warnings are smaller.\n+            .map(|(idx, (lhs, _rhs))| (idx, lhs.span()))\n+            .collect::<Vec<_>>()\n     } else {\n         Vec::new()\n     };\n@@ -651,6 +662,29 @@ fn check_matcher(sess: &ParseSess, def: &ast::Item, matcher: &[mbe::TokenTree])\n     err == sess.span_diagnostic.err_count()\n }\n \n+fn has_compile_error_macro(rhs: &mbe::TokenTree) -> bool {\n+    match rhs {\n+        mbe::TokenTree::Delimited(_sp, d) => {\n+            let has_compile_error = d.tts.array_windows::<3>().any(|[ident, bang, args]| {\n+                if let mbe::TokenTree::Token(ident) = ident &&\n+                        let TokenKind::Ident(ident, _) = ident.kind &&\n+                        ident == sym::compile_error &&\n+                        let mbe::TokenTree::Token(bang) = bang &&\n+                        let TokenKind::Not = bang.kind &&\n+                        let mbe::TokenTree::Delimited(_, del) = args &&\n+                        del.delim != Delimiter::Invisible\n+                    {\n+                        true\n+                    } else {\n+                        false\n+                    }\n+            });\n+            if has_compile_error { true } else { d.tts.iter().any(has_compile_error_macro) }\n+        }\n+        _ => false,\n+    }\n+}\n+\n // `The FirstSets` for a matcher is a mapping from subsequences in the\n // matcher to the FIRST set for that subsequence.\n //"}, {"sha": "f8fa7a0941d00064c4d03674da1da9b2326c45d0", "filename": "compiler/rustc_resolve/src/build_reduced_graph.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/compiler%2Frustc_resolve%2Fsrc%2Fbuild_reduced_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/compiler%2Frustc_resolve%2Fsrc%2Fbuild_reduced_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fbuild_reduced_graph.rs?ref=fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "patch": "@@ -1220,12 +1220,12 @@ impl<'a, 'b> BuildReducedGraphVisitor<'a, 'b> {\n         ident: Ident,\n         def_id: LocalDefId,\n         node_id: NodeId,\n-        rule_spans: &[Span],\n+        rule_spans: &[(usize, Span)],\n     ) {\n         if !ident.as_str().starts_with('_') {\n             self.r.unused_macros.insert(def_id, (node_id, ident));\n-            for (rule_i, rule_span) in rule_spans.iter().enumerate() {\n-                self.r.unused_macro_rules.insert((def_id, rule_i), (ident, *rule_span));\n+            for (rule_i, rule_span) in rule_spans.iter() {\n+                self.r.unused_macro_rules.insert((def_id, *rule_i), (ident, *rule_span));\n             }\n         }\n     }"}, {"sha": "3fb34cdcd9bd96c77913f708b60232e8f67e0809", "filename": "compiler/rustc_resolve/src/macros.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs?ref=fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "patch": "@@ -870,7 +870,7 @@ impl<'a> Resolver<'a> {\n         &mut self,\n         item: &ast::Item,\n         edition: Edition,\n-    ) -> (SyntaxExtension, Vec<Span>) {\n+    ) -> (SyntaxExtension, Vec<(usize, Span)>) {\n         let (mut result, mut rule_spans) = compile_declarative_macro(\n             &self.session,\n             self.session.features_untracked(),"}, {"sha": "4d51db89bc0b3cb91f818056bc31eba2d76378d3", "filename": "src/test/ui/lint/unused/unused-macro-rules-compile-error.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-compile-error.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-compile-error.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-compile-error.rs?ref=fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "patch": "@@ -0,0 +1,27 @@\n+#![deny(unused_macro_rules)]\n+// To make sure we are not hitting this\n+#![deny(unused_macros)]\n+\n+macro_rules! num {\n+    (one) => { 1 };\n+    // Most simple (and common) case\n+    (two) => { compile_error!(\"foo\"); };\n+    // Some nested use\n+    (two_) => { foo(compile_error!(\"foo\")); };\n+    (three) => { 3 };\n+    (four) => { 4 }; //~ ERROR: rule of macro\n+}\n+const _NUM: u8 = num!(one) + num!(three);\n+\n+// compile_error not used as a macro invocation\n+macro_rules! num2 {\n+    (one) => { 1 };\n+    // Only identifier present\n+    (two) => { fn compile_error() {} }; //~ ERROR: rule of macro\n+    // Only identifier and bang present\n+    (two_) => { compile_error! }; //~ ERROR: rule of macro\n+    (three) => { 3 };\n+}\n+const _NUM2: u8 = num2!(one) + num2!(three);\n+\n+fn main() {}"}, {"sha": "76af8c967db1e42085b4b2b63cf2b4e7f7f64ef6", "filename": "src/test/ui/lint/unused/unused-macro-rules-compile-error.stderr", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-compile-error.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-compile-error.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-compile-error.stderr?ref=fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "patch": "@@ -0,0 +1,26 @@\n+error: 5th rule of macro `num` is never used\n+  --> $DIR/unused-macro-rules-compile-error.rs:12:5\n+   |\n+LL |     (four) => { 4 };\n+   |     ^^^^^^\n+   |\n+note: the lint level is defined here\n+  --> $DIR/unused-macro-rules-compile-error.rs:1:9\n+   |\n+LL | #![deny(unused_macro_rules)]\n+   |         ^^^^^^^^^^^^^^^^^^\n+\n+error: 3rd rule of macro `num2` is never used\n+  --> $DIR/unused-macro-rules-compile-error.rs:22:5\n+   |\n+LL |     (two_) => { compile_error! };\n+   |     ^^^^^^\n+\n+error: 2nd rule of macro `num2` is never used\n+  --> $DIR/unused-macro-rules-compile-error.rs:20:5\n+   |\n+LL |     (two) => { fn compile_error() {} };\n+   |     ^^^^^\n+\n+error: aborting due to 3 previous errors\n+"}, {"sha": "a826026ec405cc66cdef1cfbabc8bbae67f96dbf", "filename": "src/test/ui/lint/unused/unused-macro-rules-malformed-rule.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-malformed-rule.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-malformed-rule.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-malformed-rule.rs?ref=fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "patch": "@@ -0,0 +1,11 @@\n+#![deny(unused_macro_rules)]\n+\n+macro_rules! foo {\n+    (v) => {};\n+    (w) => {};\n+    () => 0; //~ ERROR: macro rhs must be delimited\n+}\n+\n+fn main() {\n+    foo!(v);\n+}"}, {"sha": "797c867103f030f88491294099e4651969a0785c", "filename": "src/test/ui/lint/unused/unused-macro-rules-malformed-rule.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-malformed-rule.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-malformed-rule.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-malformed-rule.stderr?ref=fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "patch": "@@ -0,0 +1,8 @@\n+error: macro rhs must be delimited\n+  --> $DIR/unused-macro-rules-malformed-rule.rs:6:11\n+   |\n+LL |     () => 0;\n+   |           ^\n+\n+error: aborting due to previous error\n+"}, {"sha": "d4c35fad9b0f0fa0b0ba8e73e4be8b47653356d9", "filename": "src/test/ui/lint/unused/unused-macros-malformed-rule.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macros-malformed-rule.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macros-malformed-rule.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macros-malformed-rule.rs?ref=fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "patch": "@@ -0,0 +1,15 @@\n+#![deny(unused_macros)]\n+\n+macro_rules! foo { //~ ERROR: unused macro definition\n+    (v) => {};\n+    () => 0; //~ ERROR: macro rhs must be delimited\n+}\n+\n+macro_rules! bar {\n+    (v) => {};\n+    () => 0; //~ ERROR: macro rhs must be delimited\n+}\n+\n+fn main() {\n+    bar!(v);\n+}"}, {"sha": "9a880dccfbf6dbe650c819af940b41e50d224b65", "filename": "src/test/ui/lint/unused/unused-macros-malformed-rule.stderr", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macros-malformed-rule.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fa68e73e9947be8ffc5b3b46d899e4953a44e7e9/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macros-malformed-rule.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macros-malformed-rule.stderr?ref=fa68e73e9947be8ffc5b3b46d899e4953a44e7e9", "patch": "@@ -0,0 +1,26 @@\n+error: macro rhs must be delimited\n+  --> $DIR/unused-macros-malformed-rule.rs:5:11\n+   |\n+LL |     () => 0;\n+   |           ^\n+\n+error: macro rhs must be delimited\n+  --> $DIR/unused-macros-malformed-rule.rs:10:11\n+   |\n+LL |     () => 0;\n+   |           ^\n+\n+error: unused macro definition: `foo`\n+  --> $DIR/unused-macros-malformed-rule.rs:3:14\n+   |\n+LL | macro_rules! foo {\n+   |              ^^^\n+   |\n+note: the lint level is defined here\n+  --> $DIR/unused-macros-malformed-rule.rs:1:9\n+   |\n+LL | #![deny(unused_macros)]\n+   |         ^^^^^^^^^^^^^\n+\n+error: aborting due to 3 previous errors\n+"}]}