{"sha": "15844bf48ce6bd4aaba7c26fa3df76415903aec1", "node_id": "C_kwDOAAsO6NoAKDE1ODQ0YmY0OGNlNmJkNGFhYmE3YzI2ZmEzZGY3NjQxNTkwM2FlYzE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-13T22:53:31Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-13T22:53:31Z"}, "message": "Auto merge of #11956 - fee1-dead:master, r=flodiebold\n\nfeat: allow customizing the command for running build scripts\n\nI have tested this locally and it fixed #9201 with some small changes on the compiler side with suggestions from https://github.com/rust-analyzer/rust-analyzer/issues/9201#issuecomment-1019554086.\n\nI have also added an environment variable `IS_RA_BUILDSCRIPT_CHECK` for crates to detect that it is a check for buildscripts, and allows defaulting to bogus values for expected environment variables.", "tree": {"sha": "8be1a2f07997f5011df0fb55f5f64f3f44470902", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8be1a2f07997f5011df0fb55f5f64f3f44470902"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/15844bf48ce6bd4aaba7c26fa3df76415903aec1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/15844bf48ce6bd4aaba7c26fa3df76415903aec1", "html_url": "https://github.com/rust-lang/rust/commit/15844bf48ce6bd4aaba7c26fa3df76415903aec1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/15844bf48ce6bd4aaba7c26fa3df76415903aec1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8ab26f6abcf3d2617b229813846f9a72264e83b6", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ab26f6abcf3d2617b229813846f9a72264e83b6", "html_url": "https://github.com/rust-lang/rust/commit/8ab26f6abcf3d2617b229813846f9a72264e83b6"}, {"sha": "73a033e77c830ef793a1c302a4794bf73a8c61c4", "url": "https://api.github.com/repos/rust-lang/rust/commits/73a033e77c830ef793a1c302a4794bf73a8c61c4", "html_url": "https://github.com/rust-lang/rust/commit/73a033e77c830ef793a1c302a4794bf73a8c61c4"}], "stats": {"total": 68, "additions": 53, "deletions": 15}, "files": [{"sha": "d96c135ba5e359439b9a75771d1a54d934a4d994", "filename": "crates/project_model/src/build_scripts.rs", "status": "modified", "additions": 28, "deletions": 15, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/15844bf48ce6bd4aaba7c26fa3df76415903aec1/crates%2Fproject_model%2Fsrc%2Fbuild_scripts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/15844bf48ce6bd4aaba7c26fa3df76415903aec1/crates%2Fproject_model%2Fsrc%2Fbuild_scripts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject_model%2Fsrc%2Fbuild_scripts.rs?ref=15844bf48ce6bd4aaba7c26fa3df76415903aec1", "patch": "@@ -42,22 +42,15 @@ pub(crate) struct BuildScriptOutput {\n }\n \n impl WorkspaceBuildScripts {\n-    pub(crate) fn run(\n-        config: &CargoConfig,\n-        workspace: &CargoWorkspace,\n-        progress: &dyn Fn(String),\n-    ) -> Result<WorkspaceBuildScripts> {\n+    fn build_command(config: &CargoConfig) -> Command {\n+        if let Some([program, args @ ..]) = config.run_build_script_command.as_deref() {\n+            let mut cmd = Command::new(program);\n+            cmd.args(args);\n+            return cmd;\n+        }\n+\n         let mut cmd = Command::new(toolchain::cargo());\n \n-        if config.wrap_rustc_in_build_scripts {\n-            // Setup RUSTC_WRAPPER to point to `rust-analyzer` binary itself. We use\n-            // that to compile only proc macros and build scripts during the initial\n-            // `cargo check`.\n-            let myself = std::env::current_exe()?;\n-            cmd.env(\"RUSTC_WRAPPER\", myself);\n-            cmd.env(\"RA_RUSTC_WRAPPER\", \"1\");\n-        }\n-        cmd.current_dir(workspace.workspace_root());\n         cmd.args(&[\"check\", \"--quiet\", \"--workspace\", \"--message-format=json\"]);\n \n         // --all-targets includes tests, benches and examples in addition to the\n@@ -81,6 +74,26 @@ impl WorkspaceBuildScripts {\n             }\n         }\n \n+        cmd\n+    }\n+    pub(crate) fn run(\n+        config: &CargoConfig,\n+        workspace: &CargoWorkspace,\n+        progress: &dyn Fn(String),\n+    ) -> Result<WorkspaceBuildScripts> {\n+        let mut cmd = Self::build_command(config);\n+\n+        if config.wrap_rustc_in_build_scripts {\n+            // Setup RUSTC_WRAPPER to point to `rust-analyzer` binary itself. We use\n+            // that to compile only proc macros and build scripts during the initial\n+            // `cargo check`.\n+            let myself = std::env::current_exe()?;\n+            cmd.env(\"RUSTC_WRAPPER\", myself);\n+            cmd.env(\"RA_RUSTC_WRAPPER\", \"1\");\n+        }\n+\n+        cmd.current_dir(workspace.workspace_root());\n+\n         cmd.stdout(Stdio::piped()).stderr(Stdio::piped()).stdin(Stdio::null());\n \n         let mut res = WorkspaceBuildScripts::default();\n@@ -104,7 +117,7 @@ impl WorkspaceBuildScripts {\n                 }\n \n                 // Copy-pasted from existing cargo_metadata. It seems like we\n-                // should be using sered_stacker here?\n+                // should be using serde_stacker here?\n                 let mut deserializer = serde_json::Deserializer::from_str(line);\n                 deserializer.disable_recursion_limit();\n                 let message = Message::deserialize(&mut deserializer)"}, {"sha": "76ef44e1471ee35c357f89512524544649e49913", "filename": "crates/project_model/src/cargo_workspace.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/15844bf48ce6bd4aaba7c26fa3df76415903aec1/crates%2Fproject_model%2Fsrc%2Fcargo_workspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/15844bf48ce6bd4aaba7c26fa3df76415903aec1/crates%2Fproject_model%2Fsrc%2Fcargo_workspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject_model%2Fsrc%2Fcargo_workspace.rs?ref=15844bf48ce6bd4aaba7c26fa3df76415903aec1", "patch": "@@ -96,6 +96,8 @@ pub struct CargoConfig {\n     pub unset_test_crates: UnsetTestCrates,\n \n     pub wrap_rustc_in_build_scripts: bool,\n+\n+    pub run_build_script_command: Option<Vec<String>>,\n }\n \n impl CargoConfig {"}, {"sha": "64b60a23a6e6f83a65b7d7c22fc58afd7bc54801", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/15844bf48ce6bd4aaba7c26fa3df76415903aec1/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/15844bf48ce6bd4aaba7c26fa3df76415903aec1/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=15844bf48ce6bd4aaba7c26fa3df76415903aec1", "patch": "@@ -78,6 +78,10 @@ config_data! {\n         /// Run build scripts (`build.rs`) for more precise code analysis.\n         cargo_runBuildScripts |\n         cargo_loadOutDirsFromCheck: bool = \"true\",\n+        /// Advanced option, fully override the command rust-analyzer uses to\n+        /// run build scripts and build procedural macros. The command should\n+        /// include `--message-format=json` or a similar option.\n+        cargo_runBuildScriptsCommand: Option<Vec<String>> = \"null\",\n         /// Use `RUSTC_WRAPPER=rust-analyzer` when running build scripts to\n         /// avoid compiling unnecessary things.\n         cargo_useRustcWrapperForBuildScripts: bool = \"true\",\n@@ -834,6 +838,7 @@ impl Config {\n             rustc_source,\n             unset_test_crates: UnsetTestCrates::Only(self.data.cargo_unsetTest.clone()),\n             wrap_rustc_in_build_scripts: self.data.cargo_useRustcWrapperForBuildScripts,\n+            run_build_script_command: self.data.cargo_runBuildScriptsCommand.clone(),\n         }\n     }\n "}, {"sha": "ace74f8e08af58d3ee32b6f4e7474cabbbae663d", "filename": "docs/user/generated_config.adoc", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/15844bf48ce6bd4aaba7c26fa3df76415903aec1/docs%2Fuser%2Fgenerated_config.adoc", "raw_url": "https://github.com/rust-lang/rust/raw/15844bf48ce6bd4aaba7c26fa3df76415903aec1/docs%2Fuser%2Fgenerated_config.adoc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Fgenerated_config.adoc?ref=15844bf48ce6bd4aaba7c26fa3df76415903aec1", "patch": "@@ -64,6 +64,13 @@ List of features to activate.\n --\n Run build scripts (`build.rs`) for more precise code analysis.\n --\n+[[rust-analyzer.cargo.runBuildScriptsCommand]]rust-analyzer.cargo.runBuildScriptsCommand (default: `null`)::\n++\n+--\n+Advanced option, fully override the command rust-analyzer uses to\n+run build scripts and build procedural macros. The command should\n+include `--message-format=json` or a similar option.\n+--\n [[rust-analyzer.cargo.useRustcWrapperForBuildScripts]]rust-analyzer.cargo.useRustcWrapperForBuildScripts (default: `true`)::\n +\n --"}, {"sha": "7860d18758a27336787d19a8e5431566ae6295c1", "filename": "editors/code/package.json", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/15844bf48ce6bd4aaba7c26fa3df76415903aec1/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/15844bf48ce6bd4aaba7c26fa3df76415903aec1/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=15844bf48ce6bd4aaba7c26fa3df76415903aec1", "patch": "@@ -476,6 +476,17 @@\n                     \"default\": true,\n                     \"type\": \"boolean\"\n                 },\n+                \"rust-analyzer.cargo.runBuildScriptsCommand\": {\n+                    \"markdownDescription\": \"Advanced option, fully override the command rust-analyzer uses to\\nrun build scripts and build procedural macros. The command should\\ninclude `--message-format=json` or a similar option.\",\n+                    \"default\": null,\n+                    \"type\": [\n+                        \"null\",\n+                        \"array\"\n+                    ],\n+                    \"items\": {\n+                        \"type\": \"string\"\n+                    }\n+                },\n                 \"rust-analyzer.cargo.useRustcWrapperForBuildScripts\": {\n                     \"markdownDescription\": \"Use `RUSTC_WRAPPER=rust-analyzer` when running build scripts to\\navoid compiling unnecessary things.\",\n                     \"default\": true,"}]}