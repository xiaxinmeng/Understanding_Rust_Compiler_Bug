{"sha": "5844dd0bb4e30d96156f6ee1cb7dc097a51e5610", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU4NDRkZDBiYjRlMzBkOTYxNTZmNmVlMWNiN2RjMDk3YTUxZTU2MTA=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-07-30T12:26:04Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-30T12:26:04Z"}, "message": "Merge #5586\n\n5586: Add workaround for changing sysroot paths r=jonas-schievink a=lnicola\n\nFixes #5577\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>", "tree": {"sha": "f26f6f048c1d1d4772bf14259702a431b9684de0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f26f6f048c1d1d4772bf14259702a431b9684de0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5844dd0bb4e30d96156f6ee1cb7dc097a51e5610", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfIrxcCRBK7hj4Ov3rIwAAdHIIAIEL8sr119GRiQp7vd1ZopfG\ntwl/ZEQobcv9liFQLwrrbXT2hUKPzXvNVLpKqLnIKp2ANc2Ew/Or83A/IakGlWLO\nD6roy3KqKDRCBH+4KSViaMd0SPy2FjVZ8izR68iYF8AiEp9bOJyyQCTumOHMYChJ\nrwJUe++rY+R4NFQv/Bp0XfHALbF80bOQPBQLO/GXmOoDfY78DbwTl7s3m/sXQNw+\nXRkI+CqjkDCLqwFgHXtlbGuy92whmj43hP3gl13LwrOoG+VDsjNMWa0w1y2yHl3h\no4LnIszAn8XF0dsK1ujOMACQ6ahbiSCZPMgEkqnLcLWlXGoGrLrlWmZej57piNQ=\n=qUb8\n-----END PGP SIGNATURE-----\n", "payload": "tree f26f6f048c1d1d4772bf14259702a431b9684de0\nparent 51b18ee2f1c3c9f7ea58c5f00b451e683048f618\nparent a538e0fbe815a4543f3b547d7a20469bebc2e3ed\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1596111964 +0000\ncommitter GitHub <noreply@github.com> 1596111964 +0000\n\nMerge #5586\n\n5586: Add workaround for changing sysroot paths r=jonas-schievink a=lnicola\n\nFixes #5577\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5844dd0bb4e30d96156f6ee1cb7dc097a51e5610", "html_url": "https://github.com/rust-lang/rust/commit/5844dd0bb4e30d96156f6ee1cb7dc097a51e5610", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5844dd0bb4e30d96156f6ee1cb7dc097a51e5610/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "51b18ee2f1c3c9f7ea58c5f00b451e683048f618", "url": "https://api.github.com/repos/rust-lang/rust/commits/51b18ee2f1c3c9f7ea58c5f00b451e683048f618", "html_url": "https://github.com/rust-lang/rust/commit/51b18ee2f1c3c9f7ea58c5f00b451e683048f618"}, {"sha": "a538e0fbe815a4543f3b547d7a20469bebc2e3ed", "url": "https://api.github.com/repos/rust-lang/rust/commits/a538e0fbe815a4543f3b547d7a20469bebc2e3ed", "html_url": "https://github.com/rust-lang/rust/commit/a538e0fbe815a4543f3b547d7a20469bebc2e3ed"}], "stats": {"total": 42, "additions": 34, "deletions": 8}, "files": [{"sha": "9e23b5805a1a61491f8e93ea6ac3663478fec40d", "filename": "crates/ra_project_model/src/sysroot.rs", "status": "modified", "additions": 34, "deletions": 8, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/5844dd0bb4e30d96156f6ee1cb7dc097a51e5610/crates%2Fra_project_model%2Fsrc%2Fsysroot.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5844dd0bb4e30d96156f6ee1cb7dc097a51e5610/crates%2Fra_project_model%2Fsrc%2Fsysroot.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_project_model%2Fsrc%2Fsysroot.rs?ref=5844dd0bb4e30d96156f6ee1cb7dc097a51e5610", "patch": "@@ -54,13 +54,24 @@ impl Sysroot {\n         let src = get_or_install_rust_src(cargo_toml)?;\n         let mut sysroot = Sysroot { crates: Arena::default() };\n         for name in SYSROOT_CRATES.trim().lines() {\n+            // FIXME: remove this path when 1.47 comes out\n+            // https://github.com/rust-lang/rust/pull/73265\n             let root = src.join(format!(\"lib{}\", name)).join(\"lib.rs\");\n             if root.exists() {\n                 sysroot.crates.alloc(SysrootCrateData {\n                     name: name.into(),\n                     root,\n                     deps: Vec::new(),\n                 });\n+            } else {\n+                let root = src.join(name).join(\"src/lib.rs\");\n+                if root.exists() {\n+                    sysroot.crates.alloc(SysrootCrateData {\n+                        name: name.into(),\n+                        root,\n+                        deps: Vec::new(),\n+                    });\n+                }\n             }\n         }\n         if let Some(std) = sysroot.std() {\n@@ -94,23 +105,38 @@ fn get_or_install_rust_src(cargo_toml: &AbsPath) -> Result<AbsPathBuf> {\n     rustc.current_dir(current_dir).args(&[\"--print\", \"sysroot\"]);\n     let stdout = utf8_stdout(rustc)?;\n     let sysroot_path = AbsPath::assert(Path::new(stdout.trim()));\n-    let src_path = sysroot_path.join(\"lib/rustlib/src/rust/src\");\n-\n-    if !src_path.exists() {\n+    let mut src = get_rust_src(sysroot_path);\n+    if src.is_none() {\n         let mut rustup = Command::new(ra_toolchain::rustup());\n         rustup.current_dir(current_dir).args(&[\"component\", \"add\", \"rust-src\"]);\n         utf8_stdout(rustup)?;\n+        src = get_rust_src(sysroot_path);\n     }\n-    if !src_path.exists() {\n-        bail!(\n+    match src {\n+        Some(r) => Ok(r),\n+        None => bail!(\n             \"can't load standard library from sysroot\\n\\\n             {}\\n\\\n             (discovered via `rustc --print sysroot`)\\n\\\n             try running `rustup component add rust-src` or set `RUST_SRC_PATH`\",\n-            src_path.display(),\n-        )\n+            sysroot_path.display(),\n+        ),\n+    }\n+}\n+\n+fn get_rust_src(sysroot_path: &AbsPath) -> Option<AbsPathBuf> {\n+    // try the new path first since the old one still exists\n+    let mut src_path = sysroot_path.join(\"lib/rustlib/src/rust/library\");\n+    if !src_path.exists() {\n+        // FIXME: remove this path when 1.47 comes out\n+        // https://github.com/rust-lang/rust/pull/73265\n+        src_path = sysroot_path.join(\"lib/rustlib/src/rust/src\");\n+    }\n+    if src_path.exists() {\n+        Some(src_path)\n+    } else {\n+        None\n     }\n-    Ok(src_path)\n }\n \n impl SysrootCrateData {"}]}