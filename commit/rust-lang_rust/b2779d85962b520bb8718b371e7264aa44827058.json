{"sha": "b2779d85962b520bb8718b371e7264aa44827058", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIyNzc5ZDg1OTYyYjUyMGJiODcxOGIzNzFlNzI2NGFhNDQ4MjcwNTg=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-03-09T23:17:33Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-03-14T13:09:48Z"}, "message": "Use smaller discriminants for generators", "tree": {"sha": "17b2b7b165f1f268231d65d9b64ef12e2f76d08b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/17b2b7b165f1f268231d65d9b64ef12e2f76d08b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b2779d85962b520bb8718b371e7264aa44827058", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b2779d85962b520bb8718b371e7264aa44827058", "html_url": "https://github.com/rust-lang/rust/commit/b2779d85962b520bb8718b371e7264aa44827058", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b2779d85962b520bb8718b371e7264aa44827058/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "42ce9b4e9054d63c8f352f994e2d5dae7d04130f", "url": "https://api.github.com/repos/rust-lang/rust/commits/42ce9b4e9054d63c8f352f994e2d5dae7d04130f", "html_url": "https://github.com/rust-lang/rust/commit/42ce9b4e9054d63c8f352f994e2d5dae7d04130f"}], "stats": {"total": 59, "additions": 31, "deletions": 28}, "files": [{"sha": "f5ef9bda0eedabcefcbf03be9319c81cdda92dca", "filename": "src/librustc/ty/layout.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b2779d85962b520bb8718b371e7264aa44827058/src%2Flibrustc%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2779d85962b520bb8718b371e7264aa44827058/src%2Flibrustc%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Flayout.rs?ref=b2779d85962b520bb8718b371e7264aa44827058", "patch": "@@ -1409,12 +1409,15 @@ impl<'tcx> LayoutCx<'tcx, TyCtxt<'tcx>> {\n         // locals as part of the prefix. We compute the layout of all of\n         // these fields at once to get optimal packing.\n         let discr_index = substs.as_generator().prefix_tys(def_id, tcx).count();\n-        // FIXME(eddyb) set the correct vaidity range for the discriminant.\n-        let discr_layout = self.layout_of(substs.as_generator().discr_ty(tcx))?;\n-        let discr = match &discr_layout.abi {\n-            Abi::Scalar(s) => s.clone(),\n-            _ => bug!(),\n-        };\n+\n+        // `info.variant_fields` already accounts for the reserved variants, so no need to add them.\n+        let max_discr = (info.variant_fields.len() - 1) as u128;\n+        let discr_int = Integer::fit_unsigned(max_discr);\n+        let discr_int_ty = discr_int.to_ty(tcx, false);\n+        let discr = Scalar { value: Primitive::Int(discr_int, false), valid_range: 0..=max_discr };\n+        let discr_layout = self.tcx.intern_layout(LayoutDetails::scalar(self, discr.clone()));\n+        let discr_layout = TyLayout { ty: discr_int_ty, details: discr_layout };\n+\n         let promoted_layouts = ineligible_locals\n             .iter()\n             .map(|local| subst_field(info.field_tys[local]))"}, {"sha": "636fafc2bc44a248731973987639c545c49daf4f", "filename": "src/test/ui/async-await/async-fn-size-moved-locals.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/b2779d85962b520bb8718b371e7264aa44827058/src%2Ftest%2Fui%2Fasync-await%2Fasync-fn-size-moved-locals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2779d85962b520bb8718b371e7264aa44827058/src%2Ftest%2Fui%2Fasync-await%2Fasync-fn-size-moved-locals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fasync-fn-size-moved-locals.rs?ref=b2779d85962b520bb8718b371e7264aa44827058", "patch": "@@ -110,9 +110,9 @@ async fn mixed_sizes() {\n }\n \n fn main() {\n-    assert_eq!(1028, std::mem::size_of_val(&single()));\n-    assert_eq!(1032, std::mem::size_of_val(&single_with_noop()));\n-    assert_eq!(3084, std::mem::size_of_val(&joined()));\n-    assert_eq!(3084, std::mem::size_of_val(&joined_with_noop()));\n-    assert_eq!(7188, std::mem::size_of_val(&mixed_sizes()));\n+    assert_eq!(1025, std::mem::size_of_val(&single()));\n+    assert_eq!(1026, std::mem::size_of_val(&single_with_noop()));\n+    assert_eq!(3078, std::mem::size_of_val(&joined()));\n+    assert_eq!(3079, std::mem::size_of_val(&joined_with_noop()));\n+    assert_eq!(7181, std::mem::size_of_val(&mixed_sizes()));\n }"}, {"sha": "d5d7b3fc3f0bd10c7438002ba5f0a391f962c929", "filename": "src/test/ui/async-await/async-fn-size-uninit-locals.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/b2779d85962b520bb8718b371e7264aa44827058/src%2Ftest%2Fui%2Fasync-await%2Fasync-fn-size-uninit-locals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2779d85962b520bb8718b371e7264aa44827058/src%2Ftest%2Fui%2Fasync-await%2Fasync-fn-size-uninit-locals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fasync-fn-size-uninit-locals.rs?ref=b2779d85962b520bb8718b371e7264aa44827058", "patch": "@@ -95,9 +95,9 @@ async fn join_retval() -> Joiner {\n }\n \n fn main() {\n-    assert_eq!(8, std::mem::size_of_val(&single()));\n-    assert_eq!(12, std::mem::size_of_val(&single_with_noop()));\n-    assert_eq!(3084, std::mem::size_of_val(&joined()));\n-    assert_eq!(3084, std::mem::size_of_val(&joined_with_noop()));\n-    assert_eq!(3080, std::mem::size_of_val(&join_retval()));\n+    assert_eq!(2, std::mem::size_of_val(&single()));\n+    assert_eq!(3, std::mem::size_of_val(&single_with_noop()));\n+    assert_eq!(3078, std::mem::size_of_val(&joined()));\n+    assert_eq!(3078, std::mem::size_of_val(&joined_with_noop()));\n+    assert_eq!(3074, std::mem::size_of_val(&join_retval()));\n }"}, {"sha": "0c1f3636446c9ee5b493df779d4d9a23021b6019", "filename": "src/test/ui/async-await/async-fn-size.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/b2779d85962b520bb8718b371e7264aa44827058/src%2Ftest%2Fui%2Fasync-await%2Fasync-fn-size.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2779d85962b520bb8718b371e7264aa44827058/src%2Ftest%2Fui%2Fasync-await%2Fasync-fn-size.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fasync-fn-size.rs?ref=b2779d85962b520bb8718b371e7264aa44827058", "patch": "@@ -86,13 +86,13 @@ async fn await3_level5() -> u8 {\n \n fn main() {\n     assert_eq!(2, std::mem::size_of_val(&base()));\n-    assert_eq!(8, std::mem::size_of_val(&await1_level1()));\n-    assert_eq!(12, std::mem::size_of_val(&await2_level1()));\n-    assert_eq!(12, std::mem::size_of_val(&await3_level1()));\n-    assert_eq!(24, std::mem::size_of_val(&await3_level2()));\n-    assert_eq!(36, std::mem::size_of_val(&await3_level3()));\n-    assert_eq!(48, std::mem::size_of_val(&await3_level4()));\n-    assert_eq!(60, std::mem::size_of_val(&await3_level5()));\n+    assert_eq!(3, std::mem::size_of_val(&await1_level1()));\n+    assert_eq!(4, std::mem::size_of_val(&await2_level1()));\n+    assert_eq!(5, std::mem::size_of_val(&await3_level1()));\n+    assert_eq!(8, std::mem::size_of_val(&await3_level2()));\n+    assert_eq!(11, std::mem::size_of_val(&await3_level3()));\n+    assert_eq!(14, std::mem::size_of_val(&await3_level4()));\n+    assert_eq!(17, std::mem::size_of_val(&await3_level5()));\n \n     assert_eq!(1,   wait(base()));\n     assert_eq!(1,   wait(await1_level1()));"}, {"sha": "74c60d98154dd3da107bb7672c5d40afa5129c65", "filename": "src/test/ui/generator/size-moved-locals.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/b2779d85962b520bb8718b371e7264aa44827058/src%2Ftest%2Fui%2Fgenerator%2Fsize-moved-locals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2779d85962b520bb8718b371e7264aa44827058/src%2Ftest%2Fui%2Fgenerator%2Fsize-moved-locals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fsize-moved-locals.rs?ref=b2779d85962b520bb8718b371e7264aa44827058", "patch": "@@ -58,7 +58,7 @@ fn overlap_move_points() -> impl Generator<Yield = (), Return = ()> {\n     }\n }\n \n-fn overlap_x_and_y() -> impl Generator<Yield = (), Return = ()>{\n+fn overlap_x_and_y() -> impl Generator<Yield = (), Return = ()> {\n     static || {\n         let x = Foo([0; FOO_SIZE]);\n         yield;\n@@ -70,8 +70,8 @@ fn overlap_x_and_y() -> impl Generator<Yield = (), Return = ()>{\n }\n \n fn main() {\n-    assert_eq!(1028, std::mem::size_of_val(&move_before_yield()));\n-    assert_eq!(1032, std::mem::size_of_val(&move_before_yield_with_noop()));\n-    assert_eq!(2056, std::mem::size_of_val(&overlap_move_points()));\n-    assert_eq!(1032, std::mem::size_of_val(&overlap_x_and_y()));\n+    assert_eq!(1025, std::mem::size_of_val(&move_before_yield()));\n+    assert_eq!(1026, std::mem::size_of_val(&move_before_yield_with_noop()));\n+    assert_eq!(2051, std::mem::size_of_val(&overlap_move_points()));\n+    assert_eq!(1026, std::mem::size_of_val(&overlap_x_and_y()));\n }"}]}