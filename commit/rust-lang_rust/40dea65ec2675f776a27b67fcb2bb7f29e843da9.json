{"sha": "40dea65ec2675f776a27b67fcb2bb7f29e843da9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQwZGVhNjVlYzI2NzVmNzc2YTI3YjY3ZmNiMmJiN2YyOWU4NDNkYTk=", "commit": {"author": {"name": "Mark Simulacrum", "email": "mark.simulacrum@gmail.com", "date": "2017-08-03T16:53:56Z"}, "committer": {"name": "Mark Simulacrum", "email": "mark.simulacrum@gmail.com", "date": "2017-08-13T00:15:43Z"}, "message": "Add ability to ignore git when building rust.\n\nSome users of the build system change the git sha on every build due to\nutilizing git to push changes to a remote server. This allows them to\nsimply configure that away instead of depending on custom patches to\nrustbuild.", "tree": {"sha": "dbbd7b28040dbf1104817de05002b44ea038625e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dbbd7b28040dbf1104817de05002b44ea038625e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/40dea65ec2675f776a27b67fcb2bb7f29e843da9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/40dea65ec2675f776a27b67fcb2bb7f29e843da9", "html_url": "https://github.com/rust-lang/rust/commit/40dea65ec2675f776a27b67fcb2bb7f29e843da9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/40dea65ec2675f776a27b67fcb2bb7f29e843da9/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5290c6c8f158004b19fa38aab36ac29511ec1a8a", "url": "https://api.github.com/repos/rust-lang/rust/commits/5290c6c8f158004b19fa38aab36ac29511ec1a8a", "html_url": "https://github.com/rust-lang/rust/commit/5290c6c8f158004b19fa38aab36ac29511ec1a8a"}], "stats": {"total": 20, "additions": 14, "deletions": 6}, "files": [{"sha": "962be2e608501659cfafe2e0a7d559e1a0c1263a", "filename": "config.toml.example", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/40dea65ec2675f776a27b67fcb2bb7f29e843da9/config.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/40dea65ec2675f776a27b67fcb2bb7f29e843da9/config.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.toml.example?ref=40dea65ec2675f776a27b67fcb2bb7f29e843da9", "patch": "@@ -258,6 +258,9 @@\n # saying that the FileCheck executable is missing, you may want to disable this.\n #codegen-tests = true\n \n+# Flag indicating whether git info will be retrieved from .git automatically.\n+#ignore-git = false\n+\n # =============================================================================\n # Options for specific targets\n #"}, {"sha": "9c1ae83d3828189362fe6af0a9e8858f5bcdd37a", "filename": "src/bootstrap/channel.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/40dea65ec2675f776a27b67fcb2bb7f29e843da9/src%2Fbootstrap%2Fchannel.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40dea65ec2675f776a27b67fcb2bb7f29e843da9/src%2Fbootstrap%2Fchannel.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fchannel.rs?ref=40dea65ec2675f776a27b67fcb2bb7f29e843da9", "patch": "@@ -21,6 +21,7 @@ use std::process::Command;\n use build_helper::output;\n \n use Build;\n+use config::Config;\n \n // The version number\n pub const CFG_RELEASE_NUM: &str = \"1.21.0\";\n@@ -41,9 +42,9 @@ struct Info {\n }\n \n impl GitInfo {\n-    pub fn new(dir: &Path) -> GitInfo {\n+    pub fn new(config: &Config, dir: &Path) -> GitInfo {\n         // See if this even begins to look like a git dir\n-        if !dir.join(\".git\").exists() {\n+        if config.ignore_git || !dir.join(\".git\").exists() {\n             return GitInfo { inner: None }\n         }\n "}, {"sha": "3ec1c205dc0026d888d55a9c8f5acdc0a9149f55", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/40dea65ec2675f776a27b67fcb2bb7f29e843da9/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40dea65ec2675f776a27b67fcb2bb7f29e843da9/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=40dea65ec2675f776a27b67fcb2bb7f29e843da9", "patch": "@@ -54,6 +54,7 @@ pub struct Config {\n     pub extended: bool,\n     pub sanitizers: bool,\n     pub profiler: bool,\n+    pub ignore_git: bool,\n \n     pub on_fail: Option<String>,\n     pub stage: Option<u32>,\n@@ -260,6 +261,7 @@ struct Rust {\n     optimize_tests: Option<bool>,\n     debuginfo_tests: Option<bool>,\n     codegen_tests: Option<bool>,\n+    ignore_git: Option<bool>,\n }\n \n /// TOML representation of how each build target is configured.\n@@ -292,6 +294,7 @@ impl Config {\n         config.rust_codegen_units = 1;\n         config.channel = \"dev\".to_string();\n         config.codegen_tests = true;\n+        config.ignore_git = false;\n         config.rust_dist_src = true;\n \n         config.on_fail = flags.on_fail;\n@@ -410,6 +413,7 @@ impl Config {\n             set(&mut config.use_jemalloc, rust.use_jemalloc);\n             set(&mut config.backtrace, rust.backtrace);\n             set(&mut config.channel, rust.channel.clone());\n+            set(&mut config.ignore_git, rust.ignore_git);\n             config.rustc_default_linker = rust.default_linker.clone();\n             config.rustc_default_ar = rust.default_ar.clone();\n             config.musl_root = rust.musl_root.clone().map(PathBuf::from);"}, {"sha": "1452a38f6ed283b1433d1a63ea28cc144406473e", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/40dea65ec2675f776a27b67fcb2bb7f29e843da9/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40dea65ec2675f776a27b67fcb2bb7f29e843da9/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=40dea65ec2675f776a27b67fcb2bb7f29e843da9", "patch": "@@ -299,9 +299,9 @@ impl Build {\n             }\n             None => false,\n         };\n-        let rust_info = channel::GitInfo::new(&src);\n-        let cargo_info = channel::GitInfo::new(&src.join(\"src/tools/cargo\"));\n-        let rls_info = channel::GitInfo::new(&src.join(\"src/tools/rls\"));\n+        let rust_info = channel::GitInfo::new(&config, &src);\n+        let cargo_info = channel::GitInfo::new(&config, &src.join(\"src/tools/cargo\"));\n+        let rls_info = channel::GitInfo::new(&config, &src.join(\"src/tools/rls\"));\n \n         Build {\n             initial_rustc: config.initial_rustc.clone(),"}, {"sha": "da61ad44289995b36ff6ca6c801040bfa52f3243", "filename": "src/bootstrap/tool.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/40dea65ec2675f776a27b67fcb2bb7f29e843da9/src%2Fbootstrap%2Ftool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40dea65ec2675f776a27b67fcb2bb7f29e843da9/src%2Fbootstrap%2Ftool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftool.rs?ref=40dea65ec2675f776a27b67fcb2bb7f29e843da9", "patch": "@@ -109,7 +109,7 @@ impl Step for ToolBuild {\n \n         cargo.env(\"CFG_RELEASE_CHANNEL\", &build.config.channel);\n \n-        let info = GitInfo::new(&dir);\n+        let info = GitInfo::new(&build.config, &dir);\n         if let Some(sha) = info.sha() {\n             cargo.env(\"CFG_COMMIT_HASH\", sha);\n         }"}]}