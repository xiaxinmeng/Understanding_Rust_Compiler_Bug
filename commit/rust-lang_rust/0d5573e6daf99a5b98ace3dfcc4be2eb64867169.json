{"sha": "0d5573e6daf99a5b98ace3dfcc4be2eb64867169", "node_id": "C_kwDOAAsO6NoAKDBkNTU3M2U2ZGFmOTlhNWI5OGFjZTNkZmNjNGJlMmViNjQ4NjcxNjk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-09T21:27:35Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-09T21:27:35Z"}, "message": "Auto merge of #105363 - WaffleLapkin:thin2win_box_next_argument, r=nnethercote\n\nShrink `rustc_parse_format::Piece`\n\nThis makes both variants closer together in size (previously they were different by 208 bytes -- 16 vs 224). This may make things worse, but it's worth a try.\n\nr? `@nnethercote`", "tree": {"sha": "4b028ce3145de6b24167567d430a3c770853b1bc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4b028ce3145de6b24167567d430a3c770853b1bc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0d5573e6daf99a5b98ace3dfcc4be2eb64867169", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0d5573e6daf99a5b98ace3dfcc4be2eb64867169", "html_url": "https://github.com/rust-lang/rust/commit/0d5573e6daf99a5b98ace3dfcc4be2eb64867169", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0d5573e6daf99a5b98ace3dfcc4be2eb64867169/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dfe3fe710181738a2cb3060c23ec5efb3c68ca09", "url": "https://api.github.com/repos/rust-lang/rust/commits/dfe3fe710181738a2cb3060c23ec5efb3c68ca09", "html_url": "https://github.com/rust-lang/rust/commit/dfe3fe710181738a2cb3060c23ec5efb3c68ca09"}, {"sha": "c44c82de2b174d0ca6184d15602ffc33fdbd8ae6", "url": "https://api.github.com/repos/rust-lang/rust/commits/c44c82de2b174d0ca6184d15602ffc33fdbd8ae6", "html_url": "https://github.com/rust-lang/rust/commit/c44c82de2b174d0ca6184d15602ffc33fdbd8ae6"}], "stats": {"total": 94, "additions": 50, "deletions": 44}, "files": [{"sha": "0c36cc93b9d10902fa1b6a2b2f88c381374ba03b", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0d5573e6daf99a5b98ace3dfcc4be2eb64867169/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/0d5573e6daf99a5b98ace3dfcc4be2eb64867169/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=0d5573e6daf99a5b98ace3dfcc4be2eb64867169", "patch": "@@ -4168,6 +4168,7 @@ dependencies = [\n name = \"rustc_parse_format\"\n version = \"0.0.0\"\n dependencies = [\n+ \"rustc_data_structures\",\n  \"rustc_lexer\",\n ]\n "}, {"sha": "63bc0d552c11e7e24e17bbb45ff095590fd1f18b", "filename": "compiler/rustc_builtin_macros/src/format.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0d5573e6daf99a5b98ace3dfcc4be2eb64867169/compiler%2Frustc_builtin_macros%2Fsrc%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d5573e6daf99a5b98ace3dfcc4be2eb64867169/compiler%2Frustc_builtin_macros%2Fsrc%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fformat.rs?ref=0d5573e6daf99a5b98ace3dfcc4be2eb64867169", "patch": "@@ -333,7 +333,7 @@ pub fn make_format_args(\n             parse::Piece::String(s) => {\n                 unfinished_literal.push_str(s);\n             }\n-            parse::Piece::NextArgument(parse::Argument { position, position_span, format }) => {\n+            parse::Piece::NextArgument(box parse::Argument { position, position_span, format }) => {\n                 if !unfinished_literal.is_empty() {\n                     template.push(FormatArgsPiece::Literal(Symbol::intern(&unfinished_literal)));\n                     unfinished_literal.clear();"}, {"sha": "72da398d3fc1984282fd422763c3fb0a73fe7da5", "filename": "compiler/rustc_parse_format/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0d5573e6daf99a5b98ace3dfcc4be2eb64867169/compiler%2Frustc_parse_format%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/0d5573e6daf99a5b98ace3dfcc4be2eb64867169/compiler%2Frustc_parse_format%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse_format%2FCargo.toml?ref=0d5573e6daf99a5b98ace3dfcc4be2eb64867169", "patch": "@@ -5,3 +5,4 @@ edition = \"2021\"\n \n [dependencies]\n rustc_lexer = { path = \"../rustc_lexer\" }\n+rustc_data_structures = { path = \"../rustc_data_structures\" }"}, {"sha": "9cbe04c1288effe53ad31e764541f49ef032a23a", "filename": "compiler/rustc_parse_format/src/lib.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0d5573e6daf99a5b98ace3dfcc4be2eb64867169/compiler%2Frustc_parse_format%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d5573e6daf99a5b98ace3dfcc4be2eb64867169/compiler%2Frustc_parse_format%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse_format%2Fsrc%2Flib.rs?ref=0d5573e6daf99a5b98ace3dfcc4be2eb64867169", "patch": "@@ -58,13 +58,13 @@ impl InnerOffset {\n \n /// A piece is a portion of the format string which represents the next part\n /// to emit. These are emitted as a stream by the `Parser` class.\n-#[derive(Copy, Clone, Debug, PartialEq)]\n+#[derive(Clone, Debug, PartialEq)]\n pub enum Piece<'a> {\n     /// A literal string which should directly be emitted\n     String(&'a str),\n     /// This describes that formatting should process the next argument (as\n     /// specified inside) for emission.\n-    NextArgument(Argument<'a>),\n+    NextArgument(Box<Argument<'a>>),\n }\n \n /// Representation of an argument specification.\n@@ -244,7 +244,7 @@ impl<'a> Iterator for Parser<'a> {\n                         } else {\n                             self.suggest_positional_arg_instead_of_captured_arg(arg);\n                         }\n-                        Some(NextArgument(arg))\n+                        Some(NextArgument(Box::new(arg)))\n                     }\n                 }\n                 '}' => {\n@@ -908,5 +908,9 @@ fn find_skips_from_snippet(\n     (skips, true)\n }\n \n+// Assert a reasonable size for `Piece`\n+#[cfg(all(target_arch = \"x86_64\", target_pointer_width = \"64\"))]\n+rustc_data_structures::static_assert_size!(Piece<'_>, 16);\n+\n #[cfg(test)]\n mod tests;"}, {"sha": "2992ba845ab16aab0b3da5da04096c2978ce9900", "filename": "compiler/rustc_parse_format/src/tests.rs", "status": "modified", "additions": 40, "deletions": 40, "changes": 80, "blob_url": "https://github.com/rust-lang/rust/blob/0d5573e6daf99a5b98ace3dfcc4be2eb64867169/compiler%2Frustc_parse_format%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d5573e6daf99a5b98ace3dfcc4be2eb64867169/compiler%2Frustc_parse_format%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse_format%2Fsrc%2Ftests.rs?ref=0d5573e6daf99a5b98ace3dfcc4be2eb64867169", "patch": "@@ -76,51 +76,51 @@ fn invalid_precision() {\n fn format_nothing() {\n     same(\n         \"{}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentImplicitlyIs(0),\n             position_span: InnerSpan { start: 2, end: 2 },\n             format: fmtdflt(),\n-        })],\n+        }))],\n     );\n }\n #[test]\n fn format_position() {\n     same(\n         \"{3}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentIs(3),\n             position_span: InnerSpan { start: 2, end: 3 },\n             format: fmtdflt(),\n-        })],\n+        }))],\n     );\n }\n #[test]\n fn format_position_nothing_else() {\n     same(\n         \"{3:}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentIs(3),\n             position_span: InnerSpan { start: 2, end: 3 },\n             format: fmtdflt(),\n-        })],\n+        }))],\n     );\n }\n #[test]\n fn format_named() {\n     same(\n         \"{name}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentNamed(\"name\"),\n             position_span: InnerSpan { start: 2, end: 6 },\n             format: fmtdflt(),\n-        })],\n+        }))],\n     )\n }\n #[test]\n fn format_type() {\n     same(\n         \"{3:x}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentIs(3),\n             position_span: InnerSpan { start: 2, end: 3 },\n             format: FormatSpec {\n@@ -134,14 +134,14 @@ fn format_type() {\n                 ty: \"x\",\n                 ty_span: None,\n             },\n-        })],\n+        }))],\n     );\n }\n #[test]\n fn format_align_fill() {\n     same(\n         \"{3:>}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentIs(3),\n             position_span: InnerSpan { start: 2, end: 3 },\n             format: FormatSpec {\n@@ -155,11 +155,11 @@ fn format_align_fill() {\n                 ty: \"\",\n                 ty_span: None,\n             },\n-        })],\n+        }))],\n     );\n     same(\n         \"{3:0<}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentIs(3),\n             position_span: InnerSpan { start: 2, end: 3 },\n             format: FormatSpec {\n@@ -173,11 +173,11 @@ fn format_align_fill() {\n                 ty: \"\",\n                 ty_span: None,\n             },\n-        })],\n+        }))],\n     );\n     same(\n         \"{3:*<abcd}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentIs(3),\n             position_span: InnerSpan { start: 2, end: 3 },\n             format: FormatSpec {\n@@ -191,14 +191,14 @@ fn format_align_fill() {\n                 ty: \"abcd\",\n                 ty_span: Some(InnerSpan::new(6, 10)),\n             },\n-        })],\n+        }))],\n     );\n }\n #[test]\n fn format_counts() {\n     same(\n         \"{:10x}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentImplicitlyIs(0),\n             position_span: InnerSpan { start: 2, end: 2 },\n             format: FormatSpec {\n@@ -212,11 +212,11 @@ fn format_counts() {\n                 ty: \"x\",\n                 ty_span: None,\n             },\n-        })],\n+        }))],\n     );\n     same(\n         \"{:10$.10x}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentImplicitlyIs(0),\n             position_span: InnerSpan { start: 2, end: 2 },\n             format: FormatSpec {\n@@ -230,11 +230,11 @@ fn format_counts() {\n                 ty: \"x\",\n                 ty_span: None,\n             },\n-        })],\n+        }))],\n     );\n     same(\n         \"{1:0$.10x}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentIs(1),\n             position_span: InnerSpan { start: 2, end: 3 },\n             format: FormatSpec {\n@@ -248,11 +248,11 @@ fn format_counts() {\n                 ty: \"x\",\n                 ty_span: None,\n             },\n-        })],\n+        }))],\n     );\n     same(\n         \"{:.*x}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentImplicitlyIs(1),\n             position_span: InnerSpan { start: 2, end: 2 },\n             format: FormatSpec {\n@@ -266,11 +266,11 @@ fn format_counts() {\n                 ty: \"x\",\n                 ty_span: None,\n             },\n-        })],\n+        }))],\n     );\n     same(\n         \"{:.10$x}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentImplicitlyIs(0),\n             position_span: InnerSpan { start: 2, end: 2 },\n             format: FormatSpec {\n@@ -284,11 +284,11 @@ fn format_counts() {\n                 ty: \"x\",\n                 ty_span: None,\n             },\n-        })],\n+        }))],\n     );\n     same(\n         \"{:a$.b$?}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentImplicitlyIs(0),\n             position_span: InnerSpan { start: 2, end: 2 },\n             format: FormatSpec {\n@@ -302,11 +302,11 @@ fn format_counts() {\n                 ty: \"?\",\n                 ty_span: None,\n             },\n-        })],\n+        }))],\n     );\n     same(\n         \"{:.4}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentImplicitlyIs(0),\n             position_span: InnerSpan { start: 2, end: 2 },\n             format: FormatSpec {\n@@ -320,14 +320,14 @@ fn format_counts() {\n                 ty: \"\",\n                 ty_span: None,\n             },\n-        })],\n+        }))],\n     )\n }\n #[test]\n fn format_flags() {\n     same(\n         \"{:-}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentImplicitlyIs(0),\n             position_span: InnerSpan { start: 2, end: 2 },\n             format: FormatSpec {\n@@ -341,11 +341,11 @@ fn format_flags() {\n                 ty: \"\",\n                 ty_span: None,\n             },\n-        })],\n+        }))],\n     );\n     same(\n         \"{:+#}\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentImplicitlyIs(0),\n             position_span: InnerSpan { start: 2, end: 2 },\n             format: FormatSpec {\n@@ -359,7 +359,7 @@ fn format_flags() {\n                 ty: \"\",\n                 ty_span: None,\n             },\n-        })],\n+        }))],\n     );\n }\n #[test]\n@@ -368,7 +368,7 @@ fn format_mixture() {\n         \"abcd {3:x} efg\",\n         &[\n             String(\"abcd \"),\n-            NextArgument(Argument {\n+            NextArgument(Box::new(Argument {\n                 position: ArgumentIs(3),\n                 position_span: InnerSpan { start: 7, end: 8 },\n                 format: FormatSpec {\n@@ -382,7 +382,7 @@ fn format_mixture() {\n                     ty: \"x\",\n                     ty_span: None,\n                 },\n-            }),\n+            })),\n             String(\" efg\"),\n         ],\n     );\n@@ -391,18 +391,18 @@ fn format_mixture() {\n fn format_whitespace() {\n     same(\n         \"{ }\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentImplicitlyIs(0),\n             position_span: InnerSpan { start: 2, end: 3 },\n             format: fmtdflt(),\n-        })],\n+        }))],\n     );\n     same(\n         \"{  }\",\n-        &[NextArgument(Argument {\n+        &[NextArgument(Box::new(Argument {\n             position: ArgumentImplicitlyIs(0),\n             position_span: InnerSpan { start: 2, end: 4 },\n             format: fmtdflt(),\n-        })],\n+        }))],\n     );\n }"}]}