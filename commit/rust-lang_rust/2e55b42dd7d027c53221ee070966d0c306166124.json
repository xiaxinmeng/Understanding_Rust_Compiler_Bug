{"sha": "2e55b42dd7d027c53221ee070966d0c306166124", "node_id": "C_kwDOAAsO6NoAKDJlNTViNDJkZDdkMDI3YzUzMjIxZWUwNzA5NjZkMGMzMDYxNjYxMjQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-13T12:44:16Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-13T12:44:16Z"}, "message": "Auto merge of #9454 - kraktus:use_self, r=flip1995\n\nDo not lint `use_self` in proc macro expansion\n\nfix https://github.com/rust-lang/rust-clippy/issues/9440\nfix https://github.com/rust-lang/rust-clippy/issues/8910\nfix https://github.com/rust-lang/rust-clippy/issues/6902\n\nchangelog: [`use_self`]: Do not lint in proc macro expansion", "tree": {"sha": "bfc7e8d4db8310e5b16b56dcee034a83b8ef7767", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bfc7e8d4db8310e5b16b56dcee034a83b8ef7767"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2e55b42dd7d027c53221ee070966d0c306166124", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2e55b42dd7d027c53221ee070966d0c306166124", "html_url": "https://github.com/rust-lang/rust/commit/2e55b42dd7d027c53221ee070966d0c306166124", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2e55b42dd7d027c53221ee070966d0c306166124/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d574216f2f8d4529df0a0905f1d04da58629e1ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/d574216f2f8d4529df0a0905f1d04da58629e1ca", "html_url": "https://github.com/rust-lang/rust/commit/d574216f2f8d4529df0a0905f1d04da58629e1ca"}, {"sha": "59ee6a89a3e6dc9547002e014470573647f22a8f", "url": "https://api.github.com/repos/rust-lang/rust/commits/59ee6a89a3e6dc9547002e014470573647f22a8f", "html_url": "https://github.com/rust-lang/rust/commit/59ee6a89a3e6dc9547002e014470573647f22a8f"}], "stats": {"total": 26, "additions": 21, "deletions": 5}, "files": [{"sha": "44ab9bca79596bd8763d52e5c6d9fd3fbad9d7af", "filename": "clippy_lints/src/use_self.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2e55b42dd7d027c53221ee070966d0c306166124/clippy_lints%2Fsrc%2Fuse_self.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e55b42dd7d027c53221ee070966d0c306166124/clippy_lints%2Fsrc%2Fuse_self.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fuse_self.rs?ref=2e55b42dd7d027c53221ee070966d0c306166124", "patch": "@@ -1,6 +1,6 @@\n use clippy_utils::diagnostics::span_lint_and_sugg;\n use clippy_utils::ty::same_type_and_consts;\n-use clippy_utils::{meets_msrv, msrvs};\n+use clippy_utils::{is_from_proc_macro, meets_msrv, msrvs};\n use if_chain::if_chain;\n use rustc_data_structures::fx::FxHashSet;\n use rustc_errors::Applicability;\n@@ -87,7 +87,7 @@ impl_lint_pass!(UseSelf => [USE_SELF]);\n const SEGMENTS_MSG: &str = \"segments should be composed of at least 1 element\";\n \n impl<'tcx> LateLintPass<'tcx> for UseSelf {\n-    fn check_item(&mut self, _cx: &LateContext<'_>, item: &Item<'_>) {\n+    fn check_item(&mut self, cx: &LateContext<'tcx>, item: &Item<'tcx>) {\n         if matches!(item.kind, ItemKind::OpaqueTy(_)) {\n             // skip over `ItemKind::OpaqueTy` in order to lint `foo() -> impl <..>`\n             return;\n@@ -103,6 +103,7 @@ impl<'tcx> LateLintPass<'tcx> for UseSelf {\n             if parameters.as_ref().map_or(true, |params| {\n                 !params.parenthesized && !params.args.iter().any(|arg| matches!(arg, GenericArg::Lifetime(_)))\n             });\n+            if !is_from_proc_macro(cx, item); // expensive, should be last check\n             then {\n                 StackItem::Check {\n                     impl_id: item.def_id,\n@@ -213,9 +214,6 @@ impl<'tcx> LateLintPass<'tcx> for UseSelf {\n                 hir_ty_to_ty(cx.tcx, hir_ty)\n             };\n             if same_type_and_consts(ty, cx.tcx.type_of(impl_id));\n-            let hir = cx.tcx.hir();\n-            // prevents false positive on `#[derive(serde::Deserialize)]`\n-            if !hir.span(hir.get_parent_node(hir_ty.hir_id)).in_derive_expansion();\n             then {\n                 span_lint(cx, hir_ty.span);\n             }"}, {"sha": "37986187da179b6acd40a6a006596a48343ae28a", "filename": "tests/ui/use_self.fixed", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/2e55b42dd7d027c53221ee070966d0c306166124/tests%2Fui%2Fuse_self.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/2e55b42dd7d027c53221ee070966d0c306166124/tests%2Fui%2Fuse_self.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fuse_self.fixed?ref=2e55b42dd7d027c53221ee070966d0c306166124", "patch": "@@ -608,3 +608,12 @@ mod issue8845 {\n         }\n     }\n }\n+\n+mod issue6902 {\n+    use serde::Serialize;\n+\n+    #[derive(Serialize)]\n+    pub enum Foo {\n+        Bar = 1,\n+    }\n+}"}, {"sha": "1b2b3337c92ed00fc30a08d00bb405c9dd4abe8d", "filename": "tests/ui/use_self.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/2e55b42dd7d027c53221ee070966d0c306166124/tests%2Fui%2Fuse_self.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e55b42dd7d027c53221ee070966d0c306166124/tests%2Fui%2Fuse_self.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fuse_self.rs?ref=2e55b42dd7d027c53221ee070966d0c306166124", "patch": "@@ -608,3 +608,12 @@ mod issue8845 {\n         }\n     }\n }\n+\n+mod issue6902 {\n+    use serde::Serialize;\n+\n+    #[derive(Serialize)]\n+    pub enum Foo {\n+        Bar = 1,\n+    }\n+}"}]}