{"sha": "6737549aaf9e93bc444fc8409698d0cc1109457e", "node_id": "C_kwDOAAsO6NoAKDY3Mzc1NDlhYWY5ZTkzYmM0NDRmYzg0MDk2OThkMGNjMTEwOTQ1N2U", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-08-11T20:52:58Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-11T20:52:58Z"}, "message": "Rollup merge of #99421 - Bryanskiy:android-crt-static, r=petrochenkov\n\nadd crt-static for android", "tree": {"sha": "e1153a0900aa1ed432adef979490337b3cde1bac", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e1153a0900aa1ed432adef979490337b3cde1bac"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6737549aaf9e93bc444fc8409698d0cc1109457e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi9WwqCRBK7hj4Ov3rIwAAYFsIAIQMh6+9+FRq9Uzt0tzcY/Kl\nTjeYDw9gEVExfMLzFgW9Oja0DFU3NjAeX6R3YUJEQANwoDKYU3yBToeP2gw/Oxoo\nJAWAycd1cI9WbSM2+pPDqHB/AMf7Zp0gBBp5ttbhtOimRJ0emLUA+yFP46CG0Vz5\nF4HECE2G+PnFqg/GENVY5Kjg6wqj/lcEA4oDmODORY23XY6tDZTVBSPvkz5LkcDF\nmGAxX1gIKIq46AQaK+59dAGngHLJmgngOInQCa1KwTk/Fm4KrJVi4RuPAhhgnkeF\nw4vYjuJJ/KxR3t3WrDgvOg+YWbAohViOszS5lIlaBe8Nx4caflbrgxtn++QfOPQ=\n=7Eiz\n-----END PGP SIGNATURE-----\n", "payload": "tree e1153a0900aa1ed432adef979490337b3cde1bac\nparent 9606408688df29931e68cadb1558b1f9740d3d9b\nparent 874ee5bede53bf0c3ff55359df5fa5b04daa32d6\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1660251178 +0200\ncommitter GitHub <noreply@github.com> 1660251178 +0200\n\nRollup merge of #99421 - Bryanskiy:android-crt-static, r=petrochenkov\n\nadd crt-static for android\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6737549aaf9e93bc444fc8409698d0cc1109457e", "html_url": "https://github.com/rust-lang/rust/commit/6737549aaf9e93bc444fc8409698d0cc1109457e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6737549aaf9e93bc444fc8409698d0cc1109457e/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9606408688df29931e68cadb1558b1f9740d3d9b", "url": "https://api.github.com/repos/rust-lang/rust/commits/9606408688df29931e68cadb1558b1f9740d3d9b", "html_url": "https://github.com/rust-lang/rust/commit/9606408688df29931e68cadb1558b1f9740d3d9b"}, {"sha": "874ee5bede53bf0c3ff55359df5fa5b04daa32d6", "url": "https://api.github.com/repos/rust-lang/rust/commits/874ee5bede53bf0c3ff55359df5fa5b04daa32d6", "html_url": "https://github.com/rust-lang/rust/commit/874ee5bede53bf0c3ff55359df5fa5b04daa32d6"}], "stats": {"total": 40, "additions": 29, "deletions": 11}, "files": [{"sha": "e81d6d68d41017dc6069b6eae94a292c7264869b", "filename": "Cargo.lock", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6737549aaf9e93bc444fc8409698d0cc1109457e/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/6737549aaf9e93bc444fc8409698d0cc1109457e/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=6737549aaf9e93bc444fc8409698d0cc1109457e", "patch": "@@ -2142,9 +2142,9 @@ checksum = \"830d08ce1d1d941e6b30645f1a0eb5643013d835ce3779a5fc208261dbe10f55\"\n \n [[package]]\n name = \"libc\"\n-version = \"0.2.126\"\n+version = \"0.2.129\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"349d5a591cd28b49e1d1037471617a32ddcda5731b99419008085f72d5a53836\"\n+checksum = \"64de3cc433455c14174d42e554d4027ee631c4d046d43e3ecc6efc4636cdc7a7\"\n dependencies = [\n  \"rustc-std-workspace-core\",\n ]"}, {"sha": "2bf83a8782a1273a56eeeb04c4b52548bea9260f", "filename": "compiler/rustc_target/src/spec/android_base.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6737549aaf9e93bc444fc8409698d0cc1109457e/compiler%2Frustc_target%2Fsrc%2Fspec%2Fandroid_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6737549aaf9e93bc444fc8409698d0cc1109457e/compiler%2Frustc_target%2Fsrc%2Fspec%2Fandroid_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fandroid_base.rs?ref=6737549aaf9e93bc444fc8409698d0cc1109457e", "patch": "@@ -10,6 +10,6 @@ pub fn opts() -> TargetOptions {\n     // for context. (At that time, there was no `-C force-unwind-tables`, so the only solution\n     // was to always emit `uwtable`).\n     base.default_uwtable = true;\n-    base.crt_static_respected = false;\n+    base.crt_static_respected = true;\n     base\n }"}, {"sha": "ebe0ccbdc0b2d4211b047bef1ba739d640c8f067", "filename": "library/std/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6737549aaf9e93bc444fc8409698d0cc1109457e/library%2Fstd%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6737549aaf9e93bc444fc8409698d0cc1109457e/library%2Fstd%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Flib.rs?ref=6737549aaf9e93bc444fc8409698d0cc1109457e", "patch": "@@ -246,6 +246,7 @@\n #![cfg_attr(bootstrap, feature(let_chains))]\n #![feature(let_else)]\n #![feature(linkage)]\n+#![feature(link_cfg)]\n #![feature(min_specialization)]\n #![feature(must_not_suspend)]\n #![feature(needs_panic_runtime)]"}, {"sha": "3a3750930998509fca767f8decf488a8f30797d5", "filename": "library/std/src/sys/unix/mod.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6737549aaf9e93bc444fc8409698d0cc1109457e/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6737549aaf9e93bc444fc8409698d0cc1109457e/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fmod.rs?ref=6737549aaf9e93bc444fc8409698d0cc1109457e", "patch": "@@ -295,8 +295,10 @@ pub fn abort_internal() -> ! {\n \n cfg_if::cfg_if! {\n     if #[cfg(target_os = \"android\")] {\n-        #[link(name = \"dl\")]\n-        #[link(name = \"log\")]\n+        #[link(name = \"dl\", kind = \"static\", modifiers = \"-bundle\",\n+            cfg(target_feature = \"crt-static\"))]\n+        #[link(name = \"dl\", cfg(not(target_feature = \"crt-static\")))]\n+        #[link(name = \"log\", cfg(not(target_feature = \"crt-static\")))]\n         extern \"C\" {}\n     } else if #[cfg(target_os = \"freebsd\")] {\n         #[link(name = \"execinfo\")]"}, {"sha": "126e41d1e2015ecc5c930904222c1f45598dba06", "filename": "library/unwind/build.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6737549aaf9e93bc444fc8409698d0cc1109457e/library%2Funwind%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6737549aaf9e93bc444fc8409698d0cc1109457e/library%2Funwind%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Funwind%2Fbuild.rs?ref=6737549aaf9e93bc444fc8409698d0cc1109457e", "patch": "@@ -13,13 +13,8 @@ fn main() {\n         let has_unwind = build.is_flag_supported(\"-lunwind\").expect(\"Unable to invoke compiler\");\n \n         if has_unwind {\n-            println!(\"cargo:rustc-link-lib=unwind\");\n-        } else {\n-            println!(\"cargo:rustc-link-lib=gcc\");\n+            println!(\"cargo:rustc-cfg=feature=\\\"system-llvm-libunwind\\\"\");\n         }\n-\n-        // Android's unwinding library depends on dl_iterate_phdr in `libdl`.\n-        println!(\"cargo:rustc-link-lib=dl\");\n     } else if target.contains(\"freebsd\") {\n         println!(\"cargo:rustc-link-lib=gcc_s\");\n     } else if target.contains(\"netbsd\") {"}, {"sha": "46fe50cb9453d9b045d95688e178146ff7b608ed", "filename": "library/unwind/src/lib.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/6737549aaf9e93bc444fc8409698d0cc1109457e/library%2Funwind%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6737549aaf9e93bc444fc8409698d0cc1109457e/library%2Funwind%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Funwind%2Fsrc%2Flib.rs?ref=6737549aaf9e93bc444fc8409698d0cc1109457e", "patch": "@@ -55,6 +55,26 @@ cfg_if::cfg_if! {\n     }\n }\n \n+#[cfg(target_os = \"android\")]\n+cfg_if::cfg_if! {\n+    if #[cfg(feature = \"llvm-libunwind\")] {\n+        compile_error!(\"`llvm-libunwind` is not supported for Android targets\");\n+    } else if #[cfg(feature = \"system-llvm-libunwind\")] {\n+        #[link(name = \"unwind\", kind = \"static\", modifiers = \"-bundle\", cfg(target_feature = \"crt-static\"))]\n+        #[link(name = \"unwind\", cfg(not(target_feature = \"crt-static\")))]\n+        extern \"C\" {}\n+    } else {\n+        #[link(name = \"gcc\", kind = \"static\", modifiers = \"-bundle\", cfg(target_feature = \"crt-static\"))]\n+        #[link(name = \"gcc\", cfg(not(target_feature = \"crt-static\")))]\n+        extern \"C\" {}\n+    }\n+}\n+// Android's unwinding library depends on dl_iterate_phdr in `libdl`.\n+#[cfg(target_os = \"android\")]\n+#[link(name = \"dl\", kind = \"static\", modifiers = \"-bundle\", cfg(target_feature = \"crt-static\"))]\n+#[link(name = \"dl\", cfg(not(target_feature = \"crt-static\")))]\n+extern \"C\" {}\n+\n // When building with crt-static, we get `gcc_eh` from the `libc` crate, since\n // glibc needs it, and needs it listed later on the linker command line. We\n // don't want to duplicate it here."}]}