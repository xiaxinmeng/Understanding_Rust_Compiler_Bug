{"sha": "75a0be98f25a4b9de5afa0e15eb016e7f9627032", "node_id": "C_kwDOAAsO6NoAKDc1YTBiZTk4ZjI1YTRiOWRlNWFmYTBlMTVlYjAxNmU3Zjk2MjcwMzI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-05T20:33:05Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-05T20:33:05Z"}, "message": "Auto merge of #107526 - obeis:for-missing-iterator, r=estebank,compiler-errors\n\nRecover form missing expression in `for` loop\n\nClose #78537\nr? `@estebank`", "tree": {"sha": "7f417a69f7d64017ffabc3291f6d8adafbdad700", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7f417a69f7d64017ffabc3291f6d8adafbdad700"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/75a0be98f25a4b9de5afa0e15eb016e7f9627032", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/75a0be98f25a4b9de5afa0e15eb016e7f9627032", "html_url": "https://github.com/rust-lang/rust/commit/75a0be98f25a4b9de5afa0e15eb016e7f9627032", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/75a0be98f25a4b9de5afa0e15eb016e7f9627032/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a67649675014546ce454d65bc8fe3ebd18e6a319", "url": "https://api.github.com/repos/rust-lang/rust/commits/a67649675014546ce454d65bc8fe3ebd18e6a319", "html_url": "https://github.com/rust-lang/rust/commit/a67649675014546ce454d65bc8fe3ebd18e6a319"}, {"sha": "17b6bd6b70fd49c034b32b5b9b2869d139ed4d46", "url": "https://api.github.com/repos/rust-lang/rust/commits/17b6bd6b70fd49c034b32b5b9b2869d139ed4d46", "html_url": "https://github.com/rust-lang/rust/commit/17b6bd6b70fd49c034b32b5b9b2869d139ed4d46"}], "stats": {"total": 48, "additions": 48, "deletions": 0}, "files": [{"sha": "2ef3dba557ea5f32ca4891395c56aea0a7237b64", "filename": "compiler/rustc_error_messages/locales/en-US/parse.ftl", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/75a0be98f25a4b9de5afa0e15eb016e7f9627032/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fparse.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/75a0be98f25a4b9de5afa0e15eb016e7f9627032/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fparse.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fparse.ftl?ref=75a0be98f25a4b9de5afa0e15eb016e7f9627032", "patch": "@@ -128,6 +128,9 @@ parse_missing_in_in_for_loop = missing `in` in `for` loop\n     .use_in_not_of = try using `in` here instead\n     .add_in = try adding `in` here\n \n+parse_missing_expression_in_for_loop = missing expression to iterate on in `for` loop\n+    .suggestion = try adding an expression to the `for` loop\n+\n parse_missing_comma_after_match_arm = expected `,` following `match` arm\n     .suggestion = missing a comma here to end this `match` arm\n "}, {"sha": "fc7c839f1c461f4033e4aee2c43b85b1ef96bde1", "filename": "compiler/rustc_parse/src/errors.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/75a0be98f25a4b9de5afa0e15eb016e7f9627032/compiler%2Frustc_parse%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75a0be98f25a4b9de5afa0e15eb016e7f9627032/compiler%2Frustc_parse%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Ferrors.rs?ref=75a0be98f25a4b9de5afa0e15eb016e7f9627032", "patch": "@@ -433,6 +433,18 @@ pub(crate) enum MissingInInForLoopSub {\n     AddIn(#[primary_span] Span),\n }\n \n+#[derive(Diagnostic)]\n+#[diag(parse_missing_expression_in_for_loop)]\n+pub(crate) struct MissingExpressionInForLoop {\n+    #[primary_span]\n+    #[suggestion(\n+        code = \"/* expression */ \",\n+        applicability = \"has-placeholders\",\n+        style = \"verbose\"\n+    )]\n+    pub span: Span,\n+}\n+\n #[derive(Diagnostic)]\n #[diag(parse_missing_comma_after_match_arm)]\n pub(crate) struct MissingCommaAfterMatchArm {"}, {"sha": "c37808f8c3d19b244e01abe806ef5f50e59ccba9", "filename": "compiler/rustc_parse/src/parser/expr.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/75a0be98f25a4b9de5afa0e15eb016e7f9627032/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75a0be98f25a4b9de5afa0e15eb016e7f9627032/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs?ref=75a0be98f25a4b9de5afa0e15eb016e7f9627032", "patch": "@@ -2471,6 +2471,21 @@ impl<'a> Parser<'a> {\n \n         let pat = self.recover_parens_around_for_head(pat, begin_paren);\n \n+        // Recover from missing expression in `for` loop\n+        if matches!(expr.kind, ExprKind::Block(..))\n+            && !matches!(self.token.kind, token::OpenDelim(token::Delimiter::Brace))\n+            && self.may_recover()\n+        {\n+            self.sess\n+                .emit_err(errors::MissingExpressionInForLoop { span: expr.span.shrink_to_lo() });\n+            let err_expr = self.mk_expr(expr.span, ExprKind::Err);\n+            let block = self.mk_block(vec![], BlockCheckMode::Default, self.prev_token.span);\n+            return Ok(self.mk_expr(\n+                lo.to(self.prev_token.span),\n+                ExprKind::ForLoop(pat, err_expr, block, opt_label),\n+            ));\n+        }\n+\n         let (attrs, loop_block) = self.parse_inner_attrs_and_block()?;\n \n         let kind = ExprKind::ForLoop(pat, expr, loop_block, opt_label);"}, {"sha": "518a89a0e6fcf92cfc194218827f02efd568ae4a", "filename": "tests/ui/parser/missing-expression-in-for-loop.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/75a0be98f25a4b9de5afa0e15eb016e7f9627032/tests%2Fui%2Fparser%2Fmissing-expression-in-for-loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75a0be98f25a4b9de5afa0e15eb016e7f9627032/tests%2Fui%2Fparser%2Fmissing-expression-in-for-loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Fmissing-expression-in-for-loop.rs?ref=75a0be98f25a4b9de5afa0e15eb016e7f9627032", "patch": "@@ -0,0 +1,5 @@\n+fn main() {\n+    for i in {\n+        //~^ ERROR missing expression to iterate on in `for` loop\n+    }\n+}"}, {"sha": "74a7c4224fae1a420d022e6ac15043d34483d398", "filename": "tests/ui/parser/missing-expression-in-for-loop.stderr", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/75a0be98f25a4b9de5afa0e15eb016e7f9627032/tests%2Fui%2Fparser%2Fmissing-expression-in-for-loop.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/75a0be98f25a4b9de5afa0e15eb016e7f9627032/tests%2Fui%2Fparser%2Fmissing-expression-in-for-loop.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Fmissing-expression-in-for-loop.stderr?ref=75a0be98f25a4b9de5afa0e15eb016e7f9627032", "patch": "@@ -0,0 +1,13 @@\n+error: missing expression to iterate on in `for` loop\n+  --> $DIR/missing-expression-in-for-loop.rs:2:14\n+   |\n+LL |     for i in {\n+   |              ^\n+   |\n+help: try adding an expression to the `for` loop\n+   |\n+LL |     for i in /* expression */ {\n+   |              ++++++++++++++++\n+\n+error: aborting due to previous error\n+"}]}