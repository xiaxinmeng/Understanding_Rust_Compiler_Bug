{"sha": "10f870eff44f07e3e8dc241e5cc11e0fa4d50ae3", "node_id": "C_kwDOAAsO6NoAKDEwZjg3MGVmZjQ0ZjA3ZTNlOGRjMjQxZTVjYzExZTBmYTRkNTBhZTM", "commit": {"author": {"name": "oxalica", "email": "oxalicc@pm.me", "date": "2022-08-03T10:16:05Z"}, "committer": {"name": "oxalica", "email": "oxalicc@pm.me", "date": "2022-08-03T10:31:52Z"}, "message": "Impl entry-API for la_arena::ArenaMap\n\nWe enforce integral and `Copy` key, so some key-related functions are\nnot necessary since user can just reuse the index for the `entry` call.", "tree": {"sha": "c9eba69d40dda301cca2ad332c892ee5440238ff", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c9eba69d40dda301cca2ad332c892ee5440238ff"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/10f870eff44f07e3e8dc241e5cc11e0fa4d50ae3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/10f870eff44f07e3e8dc241e5cc11e0fa4d50ae3", "html_url": "https://github.com/rust-lang/rust/commit/10f870eff44f07e3e8dc241e5cc11e0fa4d50ae3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/10f870eff44f07e3e8dc241e5cc11e0fa4d50ae3/comments", "author": {"login": "oxalica", "id": 14816024, "node_id": "MDQ6VXNlcjE0ODE2MDI0", "avatar_url": "https://avatars.githubusercontent.com/u/14816024?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oxalica", "html_url": "https://github.com/oxalica", "followers_url": "https://api.github.com/users/oxalica/followers", "following_url": "https://api.github.com/users/oxalica/following{/other_user}", "gists_url": "https://api.github.com/users/oxalica/gists{/gist_id}", "starred_url": "https://api.github.com/users/oxalica/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oxalica/subscriptions", "organizations_url": "https://api.github.com/users/oxalica/orgs", "repos_url": "https://api.github.com/users/oxalica/repos", "events_url": "https://api.github.com/users/oxalica/events{/privacy}", "received_events_url": "https://api.github.com/users/oxalica/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oxalica", "id": 14816024, "node_id": "MDQ6VXNlcjE0ODE2MDI0", "avatar_url": "https://avatars.githubusercontent.com/u/14816024?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oxalica", "html_url": "https://github.com/oxalica", "followers_url": "https://api.github.com/users/oxalica/followers", "following_url": "https://api.github.com/users/oxalica/following{/other_user}", "gists_url": "https://api.github.com/users/oxalica/gists{/gist_id}", "starred_url": "https://api.github.com/users/oxalica/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oxalica/subscriptions", "organizations_url": "https://api.github.com/users/oxalica/orgs", "repos_url": "https://api.github.com/users/oxalica/repos", "events_url": "https://api.github.com/users/oxalica/events{/privacy}", "received_events_url": "https://api.github.com/users/oxalica/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c203ac2cf5aaf7b7ed759e0f84426debc063d3e8", "url": "https://api.github.com/repos/rust-lang/rust/commits/c203ac2cf5aaf7b7ed759e0f84426debc063d3e8", "html_url": "https://github.com/rust-lang/rust/commit/c203ac2cf5aaf7b7ed759e0f84426debc063d3e8"}], "stats": {"total": 109, "additions": 108, "deletions": 1}, "files": [{"sha": "a3fe59e946ee9be8e60789c8b016d8231c9c48b4", "filename": "lib/la-arena/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/10f870eff44f07e3e8dc241e5cc11e0fa4d50ae3/lib%2Fla-arena%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10f870eff44f07e3e8dc241e5cc11e0fa4d50ae3/lib%2Fla-arena%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/lib%2Fla-arena%2Fsrc%2Flib.rs?ref=10f870eff44f07e3e8dc241e5cc11e0fa4d50ae3", "patch": "@@ -12,7 +12,7 @@ use std::{\n };\n \n mod map;\n-pub use map::ArenaMap;\n+pub use map::{ArenaMap, Entry, OccupiedEntry, VacantEntry};\n \n /// The raw index of a value in an arena.\n #[derive(Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash)]"}, {"sha": "f74ec5d97cb95bfde9783d58382d2725abc5088a", "filename": "lib/la-arena/src/map.rs", "status": "modified", "additions": 107, "deletions": 0, "changes": 107, "blob_url": "https://github.com/rust-lang/rust/blob/10f870eff44f07e3e8dc241e5cc11e0fa4d50ae3/lib%2Fla-arena%2Fsrc%2Fmap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10f870eff44f07e3e8dc241e5cc11e0fa4d50ae3/lib%2Fla-arena%2Fsrc%2Fmap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/lib%2Fla-arena%2Fsrc%2Fmap.rs?ref=10f870eff44f07e3e8dc241e5cc11e0fa4d50ae3", "patch": "@@ -56,6 +56,16 @@ impl<T, V> ArenaMap<Idx<T>, V> {\n         self.v.iter().enumerate().filter_map(|(idx, o)| Some((Self::from_idx(idx), o.as_ref()?)))\n     }\n \n+    /// Gets the given key's corresponding entry in the map for in-place manipulation.\n+    pub fn entry(&mut self, idx: Idx<T>) -> Entry<'_, Idx<T>, V> {\n+        let idx = Self::to_idx(idx);\n+        self.v.resize_with((idx + 1).max(self.v.len()), || None);\n+        match &mut self.v[idx] {\n+            slot @ Some(_) => Entry::Occupied(OccupiedEntry { slot, _ty: PhantomData }),\n+            slot @ None => Entry::Vacant(VacantEntry { slot, _ty: PhantomData }),\n+        }\n+    }\n+\n     fn to_idx(idx: Idx<T>) -> usize {\n         u32::from(idx.into_raw()) as usize\n     }\n@@ -83,3 +93,100 @@ impl<T, V> Default for ArenaMap<Idx<V>, T> {\n         Self::new()\n     }\n }\n+\n+/// A view into a single entry in a map, which may either be vacant or occupied.\n+///\n+/// This `enum` is constructed from the [`entry`] method on [`ArenaMap`].\n+///\n+/// [`entry`]: ArenaMap::entry\n+pub enum Entry<'a, IDX, V> {\n+    /// A vacant entry.\n+    Vacant(VacantEntry<'a, IDX, V>),\n+    /// An occupied entry.\n+    Occupied(OccupiedEntry<'a, IDX, V>),\n+}\n+\n+impl<'a, IDX, V> Entry<'a, IDX, V> {\n+    /// Ensures a value is in the entry by inserting the default if empty, and returns a mutable reference to\n+    /// the value in the entry.\n+    pub fn or_insert(self, default: V) -> &'a mut V {\n+        match self {\n+            Self::Vacant(ent) => ent.insert(default),\n+            Self::Occupied(ent) => ent.into_mut(),\n+        }\n+    }\n+\n+    /// Ensures a value is in the entry by inserting the result of the default function if empty, and returns\n+    /// a mutable reference to the value in the entry.\n+    pub fn or_insert_with<F: FnOnce() -> V>(self, default: F) -> &'a mut V {\n+        match self {\n+            Self::Vacant(ent) => ent.insert(default()),\n+            Self::Occupied(ent) => ent.into_mut(),\n+        }\n+    }\n+\n+    /// Provides in-place mutable access to an occupied entry before any potential inserts into the map.\n+    pub fn and_modify<F: FnOnce(&mut V)>(mut self, f: F) -> Self {\n+        if let Self::Occupied(ent) = &mut self {\n+            f(ent.get_mut());\n+        }\n+        self\n+    }\n+}\n+\n+impl<'a, IDX, V> Entry<'a, IDX, V>\n+where\n+    V: Default,\n+{\n+    /// Ensures a value is in the entry by inserting the default value if empty, and returns a mutable reference\n+    /// to the value in the entry.\n+    pub fn or_default(self) -> &'a mut V {\n+        self.or_insert_with(Default::default)\n+    }\n+}\n+\n+/// A view into an vacant entry in a [`ArenaMap`]. It is part of the [`Entry`] enum.\n+pub struct VacantEntry<'a, IDX, V> {\n+    slot: &'a mut Option<V>,\n+    _ty: PhantomData<IDX>,\n+}\n+\n+impl<'a, IDX, V> VacantEntry<'a, IDX, V> {\n+    /// Sets the value of the entry with the `VacantEntry`\u2019s key, and returns a mutable reference to it.\n+    pub fn insert(self, value: V) -> &'a mut V {\n+        self.slot.insert(value)\n+    }\n+}\n+\n+/// A view into an occupied entry in a [`ArenaMap`]. It is part of the [`Entry`] enum.\n+pub struct OccupiedEntry<'a, IDX, V> {\n+    slot: &'a mut Option<V>,\n+    _ty: PhantomData<IDX>,\n+}\n+\n+impl<'a, IDX, V> OccupiedEntry<'a, IDX, V> {\n+    /// Gets a reference to the value in the entry.\n+    pub fn get(&self) -> &V {\n+        self.slot.as_ref().expect(\"Occupied\")\n+    }\n+\n+    /// Gets a mutable reference to the value in the entry.\n+    pub fn get_mut(&mut self) -> &mut V {\n+        self.slot.as_mut().expect(\"Occupied\")\n+    }\n+\n+    /// Converts the entry into a mutable reference to its value.\n+    pub fn into_mut(self) -> &'a mut V {\n+        self.slot.as_mut().expect(\"Occupied\")\n+    }\n+\n+    /// Sets the value of the entry with the `OccupiedEntry`\u2019s key, and returns the entry\u2019s old value.\n+    pub fn insert(&mut self, value: V) -> V {\n+        self.slot.replace(value).expect(\"Occupied\")\n+    }\n+\n+    /// Takes the value of the entry out of the map, and returns it.\n+    pub fn remove(self) -> V {\n+        self.slot.take().expect(\"Occupied\")\n+    }\n+}"}]}