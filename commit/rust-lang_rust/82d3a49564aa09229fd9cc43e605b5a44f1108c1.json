{"sha": "82d3a49564aa09229fd9cc43e605b5a44f1108c1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgyZDNhNDk1NjRhYTA5MjI5ZmQ5Y2M0M2U2MDViNWE0NGYxMTA4YzE=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2018-06-08T06:07:46Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2018-06-08T22:25:20Z"}, "message": "Suggestion for 'static impl Trait return\n\nWhen encountering a named or anonymous sup requirement (for example,\n`&'a self`) and a `'static` impl Trait return type, suggest adding the\n`'_` lifetime constraing to the return type.", "tree": {"sha": "1eb8bfb02deae69d5df4e2dbca911a078ec8fad0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1eb8bfb02deae69d5df4e2dbca911a078ec8fad0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/82d3a49564aa09229fd9cc43e605b5a44f1108c1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/82d3a49564aa09229fd9cc43e605b5a44f1108c1", "html_url": "https://github.com/rust-lang/rust/commit/82d3a49564aa09229fd9cc43e605b5a44f1108c1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/82d3a49564aa09229fd9cc43e605b5a44f1108c1/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "41affd03eb169830773cd1b11efda562ab81fad0", "url": "https://api.github.com/repos/rust-lang/rust/commits/41affd03eb169830773cd1b11efda562ab81fad0", "html_url": "https://github.com/rust-lang/rust/commit/41affd03eb169830773cd1b11efda562ab81fad0"}], "stats": {"total": 176, "additions": 175, "deletions": 1}, "files": [{"sha": "f50c23b0aa75209e498c70f3d2df5ddb2d546a9b", "filename": "src/librustc/infer/error_reporting/nice_region_error/mod.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fmod.rs?ref=82d3a49564aa09229fd9cc43e605b5a44f1108c1", "patch": "@@ -19,6 +19,7 @@ mod different_lifetimes;\n mod find_anon_type;\n mod named_anon_conflict;\n mod outlives_closure;\n+mod static_impl_trait;\n mod util;\n \n impl<'cx, 'gcx, 'tcx> InferCtxt<'cx, 'gcx, 'tcx> {\n@@ -67,6 +68,7 @@ impl<'cx, 'gcx, 'tcx> NiceRegionError<'cx, 'gcx, 'tcx> {\n         self.try_report_named_anon_conflict()\n             .or_else(|| self.try_report_anon_anon_conflict())\n             .or_else(|| self.try_report_outlives_closure())\n+            .or_else(|| self.try_report_static_impl_trait())\n     }\n \n     pub fn get_regions(&self) -> (Span, ty::Region<'tcx>, ty::Region<'tcx>) {"}, {"sha": "dd25edfa31e933216284bb77e2a9defcb4d7fea6", "filename": "src/librustc/infer/error_reporting/nice_region_error/static_impl_trait.rs", "status": "added", "additions": 78, "deletions": 0, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fstatic_impl_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fstatic_impl_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fstatic_impl_trait.rs?ref=82d3a49564aa09229fd9cc43e605b5a44f1108c1", "patch": "@@ -0,0 +1,78 @@\n+// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+//! Error Reporting for static impl Traits.\n+\n+use infer::error_reporting::nice_region_error::NiceRegionError;\n+use infer::lexical_region_resolve::RegionResolutionError;\n+use ty::RegionKind;\n+use util::common::ErrorReported;\n+\n+impl<'a, 'gcx, 'tcx> NiceRegionError<'a, 'gcx, 'tcx> {\n+    /// Print the error message for lifetime errors when the return type is a static impl Trait.\n+    pub(super) fn try_report_static_impl_trait(&self) -> Option<ErrorReported> {\n+        if let Some(ref error) = self.error {\n+            match error.clone() {\n+                RegionResolutionError::SubSupConflict(\n+                    var_origin,\n+                    sub_origin,\n+                    sub_r,\n+                    sup_origin,\n+                    sup_r,\n+                ) => {\n+                    let anon_reg_sup = self.is_suitable_region(sup_r)?;\n+                    if sub_r == &RegionKind::ReStatic &&\n+                        self._is_return_type_impl_trait(anon_reg_sup.def_id)\n+                    {\n+                        let sp = var_origin.span();\n+                        let return_sp = sub_origin.span();\n+                        let mut err = self.tcx.sess.struct_span_err(\n+                            sp,\n+                            \"can't infer an appropriate lifetime\",\n+                        );\n+                        err.span_label(sp, \"can't infer an appropriate lifetime\");\n+                        err.span_label(\n+                            return_sp,\n+                            \"this return type evaluates to the `'static` lifetime...\",\n+                        );\n+                        err.span_label(\n+                            sup_origin.span(),\n+                            \"...but this borrow...\",\n+                        );\n+\n+                        let (lifetime, lt_sp_opt) = self.tcx.msg_span_from_free_region(sup_r);\n+                        if let Some(lifetime_sp) = lt_sp_opt {\n+                            err.span_note(\n+                                lifetime_sp,\n+                                &format!(\"...can't outlive {}\", lifetime),\n+                            );\n+                        }\n+\n+                        if let Ok(snippet) = self.tcx.sess.codemap().span_to_snippet(return_sp) {\n+                            err.span_suggestion(\n+                                return_sp,\n+                                &format!(\n+                                    \"you can add a constraint to the return type to make it last \\\n+                                     less than `'static` and match {}\",\n+                                    lifetime,\n+                                ),\n+                                format!(\"{} + '_\", snippet),\n+                            );\n+                        }\n+                        err.emit();\n+                        return Some(ErrorReported);\n+                    }\n+                }\n+                _ => {}\n+            }\n+        }\n+        None\n+    }\n+}"}, {"sha": "63e036166f8d7cba74447d0408d3bb47a9bb923b", "filename": "src/librustc/infer/error_reporting/nice_region_error/util.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Futil.rs?ref=82d3a49564aa09229fd9cc43e605b5a44f1108c1", "patch": "@@ -167,6 +167,23 @@ impl<'a, 'gcx, 'tcx> NiceRegionError<'a, 'gcx, 'tcx> {\n         }\n         None\n     }\n+\n+    pub(super) fn _is_return_type_impl_trait(\n+        &self,\n+        scope_def_id: DefId,\n+    ) -> bool {\n+        let ret_ty = self.tcx.type_of(scope_def_id);\n+        match ret_ty.sty {\n+            ty::TyFnDef(_, _) => {\n+                let sig = ret_ty.fn_sig(self.tcx);\n+                let output = self.tcx.erase_late_bound_regions(&sig.output());\n+                return output.is_impl_trait();\n+            }\n+            _ => {}\n+        }\n+        false\n+    }\n+\n     // Here we check for the case where anonymous region\n     // corresponds to self and if yes, we display E0312.\n     // FIXME(#42700) - Need to format self properly to"}, {"sha": "abccad5a148cfbeba27d8ebe63f3c61f35a5d0de", "filename": "src/librustc/middle/mem_categorization.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs?ref=82d3a49564aa09229fd9cc43e605b5a44f1108c1", "patch": "@@ -179,7 +179,7 @@ pub enum Note {\n // and how it is located, as well as the mutability of the memory in\n // which the value is stored.\n //\n-// *WARNING* The field `cmt.type` is NOT necessarily the same as the\n+// *WARNING* The field `cmt.ty` is NOT necessarily the same as the\n // result of `node_id_to_type(cmt.id)`. This is because the `id` is\n // always the `id` of the node producing the type; in an expression\n // like `*x`, the type of this deref node is the deref'd type (`T`),"}, {"sha": "fcdd48d62a371c6b5d3e843e53ff0977d973a7b9", "filename": "src/librustc/ty/sty.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Flibrustc%2Fty%2Fsty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Flibrustc%2Fty%2Fsty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fsty.rs?ref=82d3a49564aa09229fd9cc43e605b5a44f1108c1", "patch": "@@ -1754,6 +1754,13 @@ impl<'a, 'gcx, 'tcx> TyS<'tcx> {\n         }\n     }\n \n+    pub fn is_impl_trait(&self) -> bool {\n+        match self.sty {\n+            TyAnon(..) => true,\n+            _ => false,\n+        }\n+    }\n+\n     pub fn ty_to_def_id(&self) -> Option<DefId> {\n         match self.sty {\n             TyDynamic(ref tt, ..) => tt.principal().map(|p| p.def_id()),"}, {"sha": "412950d9671a03785d41a69cf13c51ee7937e531", "filename": "src/test/ui/impl-trait/static-return-lifetime-infered.rs", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Ftest%2Fui%2Fimpl-trait%2Fstatic-return-lifetime-infered.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Ftest%2Fui%2Fimpl-trait%2Fstatic-return-lifetime-infered.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fstatic-return-lifetime-infered.rs?ref=82d3a49564aa09229fd9cc43e605b5a44f1108c1", "patch": "@@ -0,0 +1,26 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+struct A {\n+    x: [(u32, u32); 10]\n+}\n+\n+impl A {\n+    fn iter_values_anon(&self) -> impl Iterator<Item=u32> {\n+        self.x.iter().map(|a| a.0)\n+    }\n+    //~^^^ ERROR can't infer an appropriate lifetime\n+    fn iter_values<'a>(&'a self) -> impl Iterator<Item=u32> {\n+        self.x.iter().map(|a| a.0)\n+    }\n+    //~^^^ ERROR can't infer an appropriate lifetime\n+}\n+\n+fn main() {}"}, {"sha": "d115e88453b5545aa5bda23169025ec992134970", "filename": "src/test/ui/impl-trait/static-return-lifetime-infered.stderr", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Ftest%2Fui%2Fimpl-trait%2Fstatic-return-lifetime-infered.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/82d3a49564aa09229fd9cc43e605b5a44f1108c1/src%2Ftest%2Fui%2Fimpl-trait%2Fstatic-return-lifetime-infered.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fstatic-return-lifetime-infered.stderr?ref=82d3a49564aa09229fd9cc43e605b5a44f1108c1", "patch": "@@ -0,0 +1,44 @@\n+error: can't infer an appropriate lifetime\n+  --> $DIR/static-return-lifetime-infered.rs:17:16\n+   |\n+LL |     fn iter_values_anon(&self) -> impl Iterator<Item=u32> {\n+   |                                   ----------------------- this return type evaluates to the `'static` lifetime...\n+LL |         self.x.iter().map(|a| a.0)\n+   |         ------ ^^^^ can't infer an appropriate lifetime\n+   |         |\n+   |         ...but this borrow...\n+   |\n+note: ...can't outlive the anonymous lifetime #1 defined on the method body at 16:5\n+  --> $DIR/static-return-lifetime-infered.rs:16:5\n+   |\n+LL | /     fn iter_values_anon(&self) -> impl Iterator<Item=u32> {\n+LL | |         self.x.iter().map(|a| a.0)\n+LL | |     }\n+   | |_____^\n+help: you can add a constraint to the return type to make it last less than `'static` and match the anonymous lifetime #1 defined on the method body at 16:5\n+   |\n+LL |     fn iter_values_anon(&self) -> impl Iterator<Item=u32> + '_ {\n+   |                                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: can't infer an appropriate lifetime\n+  --> $DIR/static-return-lifetime-infered.rs:21:16\n+   |\n+LL |     fn iter_values<'a>(&'a self) -> impl Iterator<Item=u32> {\n+   |                                     ----------------------- this return type evaluates to the `'static` lifetime...\n+LL |         self.x.iter().map(|a| a.0)\n+   |         ------ ^^^^ can't infer an appropriate lifetime\n+   |         |\n+   |         ...but this borrow...\n+   |\n+note: ...can't outlive the lifetime 'a as defined on the method body at 20:5\n+  --> $DIR/static-return-lifetime-infered.rs:20:5\n+   |\n+LL |     fn iter_values<'a>(&'a self) -> impl Iterator<Item=u32> {\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+help: you can add a constraint to the return type to make it last less than `'static` and match the lifetime 'a as defined on the method body at 20:5\n+   |\n+LL |     fn iter_values<'a>(&'a self) -> impl Iterator<Item=u32> + '_ {\n+   |                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 2 previous errors\n+"}]}