{"sha": "eff865ca7605c0c1297aea51b377b53dbda48b3f", "node_id": "C_kwDOAAsO6NoAKGVmZjg2NWNhNzYwNWMwYzEyOTdhZWE1MWIzNzdiNTNkYmRhNDhiM2Y", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-06-25T21:59:45Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-06-25T21:59:45Z"}, "message": "Fix span issues in object safety suggestions", "tree": {"sha": "f0acdc9ca511ce0a6c07bcb81ff80bfb91a81930", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f0acdc9ca511ce0a6c07bcb81ff80bfb91a81930"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eff865ca7605c0c1297aea51b377b53dbda48b3f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eff865ca7605c0c1297aea51b377b53dbda48b3f", "html_url": "https://github.com/rust-lang/rust/commit/eff865ca7605c0c1297aea51b377b53dbda48b3f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eff865ca7605c0c1297aea51b377b53dbda48b3f/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8aab472d52ba7314dc193c73abcd384e2586123c", "url": "https://api.github.com/repos/rust-lang/rust/commits/8aab472d52ba7314dc193c73abcd384e2586123c", "html_url": "https://github.com/rust-lang/rust/commit/8aab472d52ba7314dc193c73abcd384e2586123c"}], "stats": {"total": 195, "additions": 121, "deletions": 74}, "files": [{"sha": "6ec950b05e7a00aff49e4a88754a174cb1738f60", "filename": "compiler/rustc_middle/src/traits/mod.rs", "status": "modified", "additions": 29, "deletions": 38, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/eff865ca7605c0c1297aea51b377b53dbda48b3f/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eff865ca7605c0c1297aea51b377b53dbda48b3f/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fmod.rs?ref=eff865ca7605c0c1297aea51b377b53dbda48b3f", "patch": "@@ -863,7 +863,7 @@ pub enum ObjectSafetyViolation {\n \n impl ObjectSafetyViolation {\n     pub fn error_msg(&self) -> Cow<'static, str> {\n-        match *self {\n+        match self {\n             ObjectSafetyViolation::SizedSelf(_) => \"it requires `Self: Sized`\".into(),\n             ObjectSafetyViolation::SupertraitSelf(ref spans) => {\n                 if spans.iter().any(|sp| *sp != DUMMY_SP) {\n@@ -873,7 +873,7 @@ impl ObjectSafetyViolation {\n                         .into()\n                 }\n             }\n-            ObjectSafetyViolation::Method(name, MethodViolationCode::StaticMethod(_, _, _), _) => {\n+            ObjectSafetyViolation::Method(name, MethodViolationCode::StaticMethod(_), _) => {\n                 format!(\"associated function `{}` has no `self` parameter\", name).into()\n             }\n             ObjectSafetyViolation::Method(\n@@ -897,9 +897,11 @@ impl ObjectSafetyViolation {\n             ObjectSafetyViolation::Method(name, MethodViolationCode::Generic, _) => {\n                 format!(\"method `{}` has generic type parameters\", name).into()\n             }\n-            ObjectSafetyViolation::Method(name, MethodViolationCode::UndispatchableReceiver, _) => {\n-                format!(\"method `{}`'s `self` parameter cannot be dispatched on\", name).into()\n-            }\n+            ObjectSafetyViolation::Method(\n+                name,\n+                MethodViolationCode::UndispatchableReceiver(_),\n+                _,\n+            ) => format!(\"method `{}`'s `self` parameter cannot be dispatched on\", name).into(),\n             ObjectSafetyViolation::AssocConst(name, DUMMY_SP) => {\n                 format!(\"it contains associated `const` `{}`\", name).into()\n             }\n@@ -911,51 +913,40 @@ impl ObjectSafetyViolation {\n     }\n \n     pub fn solution(&self, err: &mut Diagnostic) {\n-        match *self {\n+        match self {\n             ObjectSafetyViolation::SizedSelf(_) | ObjectSafetyViolation::SupertraitSelf(_) => {}\n             ObjectSafetyViolation::Method(\n                 name,\n-                MethodViolationCode::StaticMethod(sugg, self_span, has_args),\n+                MethodViolationCode::StaticMethod(Some((add_self_sugg, make_sized_sugg))),\n                 _,\n             ) => {\n                 err.span_suggestion(\n-                    self_span,\n-                    &format!(\n+                    add_self_sugg.1,\n+                    format!(\n                         \"consider turning `{}` into a method by giving it a `&self` argument\",\n                         name\n                     ),\n-                    format!(\"&self{}\", if has_args { \", \" } else { \"\" }),\n+                    add_self_sugg.0.to_string(),\n+                    Applicability::MaybeIncorrect,\n+                );\n+                err.span_suggestion(\n+                    make_sized_sugg.1,\n+                    format!(\n+                        \"alternatively, consider constraining `{}` so it does not apply to \\\n+                             trait objects\",\n+                        name\n+                    ),\n+                    make_sized_sugg.0.to_string(),\n                     Applicability::MaybeIncorrect,\n                 );\n-                match sugg {\n-                    Some((sugg, span)) => {\n-                        err.span_suggestion(\n-                            span,\n-                            &format!(\n-                                \"alternatively, consider constraining `{}` so it does not apply to \\\n-                                 trait objects\",\n-                                name\n-                            ),\n-                            sugg,\n-                            Applicability::MaybeIncorrect,\n-                        );\n-                    }\n-                    None => {\n-                        err.help(&format!(\n-                            \"consider turning `{}` into a method by giving it a `&self` \\\n-                             argument or constraining it so it does not apply to trait objects\",\n-                            name\n-                        ));\n-                    }\n-                }\n             }\n             ObjectSafetyViolation::Method(\n                 name,\n-                MethodViolationCode::UndispatchableReceiver,\n-                span,\n+                MethodViolationCode::UndispatchableReceiver(Some(span)),\n+                _,\n             ) => {\n                 err.span_suggestion(\n-                    span,\n+                    *span,\n                     &format!(\n                         \"consider changing method `{}`'s `self` parameter to be `&self`\",\n                         name\n@@ -991,13 +982,13 @@ impl ObjectSafetyViolation {\n }\n \n /// Reasons a method might not be object-safe.\n-#[derive(Copy, Clone, Debug, PartialEq, Eq, Hash, HashStable, PartialOrd, Ord)]\n+#[derive(Clone, Debug, PartialEq, Eq, Hash, HashStable, PartialOrd, Ord)]\n pub enum MethodViolationCode {\n     /// e.g., `fn foo()`\n-    StaticMethod(Option<(&'static str, Span)>, Span, bool /* has args */),\n+    StaticMethod(Option<(/* add &self */ (String, Span), /* add Self: Sized */ (String, Span))>),\n \n     /// e.g., `fn foo(&self, x: Self)`\n-    ReferencesSelfInput(usize),\n+    ReferencesSelfInput(Option<Span>),\n \n     /// e.g., `fn foo(&self) -> Self`\n     ReferencesSelfOutput,\n@@ -1009,7 +1000,7 @@ pub enum MethodViolationCode {\n     Generic,\n \n     /// the method's receiver (`self` argument) can't be dispatched on\n-    UndispatchableReceiver,\n+    UndispatchableReceiver(Option<Span>),\n }\n \n /// These are the error cases for `codegen_fulfill_obligation`."}, {"sha": "8d3445919156fd0c77d4c82f46971b1b81b93e26", "filename": "compiler/rustc_trait_selection/src/traits/object_safety.rs", "status": "modified", "additions": 45, "deletions": 33, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/eff865ca7605c0c1297aea51b377b53dbda48b3f/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fobject_safety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eff865ca7605c0c1297aea51b377b53dbda48b3f/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fobject_safety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fobject_safety.rs?ref=eff865ca7605c0c1297aea51b377b53dbda48b3f", "patch": "@@ -366,15 +366,9 @@ fn object_safety_violation_for_method(\n     // Get an accurate span depending on the violation.\n     violation.map(|v| {\n         let node = tcx.hir().get_if_local(method.def_id);\n-        let span = match (v, node) {\n-            (MethodViolationCode::ReferencesSelfInput(arg), Some(node)) => node\n-                .fn_decl()\n-                .and_then(|decl| decl.inputs.get(arg + 1))\n-                .map_or(method.ident(tcx).span, |arg| arg.span),\n-            (MethodViolationCode::UndispatchableReceiver, Some(node)) => node\n-                .fn_decl()\n-                .and_then(|decl| decl.inputs.get(0))\n-                .map_or(method.ident(tcx).span, |arg| arg.span),\n+        let span = match (&v, node) {\n+            (MethodViolationCode::ReferencesSelfInput(Some(span)), _) => *span,\n+            (MethodViolationCode::UndispatchableReceiver(Some(span)), _) => *span,\n             (MethodViolationCode::ReferencesSelfOutput, Some(node)) => {\n                 node.fn_decl().map_or(method.ident(tcx).span, |decl| decl.output.span())\n             }\n@@ -397,32 +391,41 @@ fn virtual_call_violation_for_method<'tcx>(\n \n     // The method's first parameter must be named `self`\n     if !method.fn_has_self_parameter {\n-        // We'll attempt to provide a structured suggestion for `Self: Sized`.\n-        let sugg =\n-            tcx.hir().get_if_local(method.def_id).as_ref().and_then(|node| node.generics()).map(\n-                |generics| match generics.predicates {\n-                    [] => (\" where Self: Sized\", generics.where_clause_span),\n-                    [.., pred] => (\", Self: Sized\", pred.span().shrink_to_hi()),\n-                },\n-            );\n-        // Get the span pointing at where the `self` receiver should be.\n-        let sm = tcx.sess.source_map();\n-        let self_span = method.ident(tcx).span.to(tcx\n-            .hir()\n-            .span_if_local(method.def_id)\n-            .unwrap_or_else(|| sm.next_point(method.ident(tcx).span))\n-            .shrink_to_hi());\n-        let self_span = sm.span_through_char(self_span, '(').shrink_to_hi();\n-        return Some(MethodViolationCode::StaticMethod(\n-            sugg,\n-            self_span,\n-            !sig.inputs().skip_binder().is_empty(),\n-        ));\n+        let sugg = if let Some(hir::Node::TraitItem(hir::TraitItem {\n+            generics,\n+            kind: hir::TraitItemKind::Fn(sig, _),\n+            ..\n+        })) = tcx.hir().get_if_local(method.def_id).as_ref()\n+        {\n+            let sm = tcx.sess.source_map();\n+            Some((\n+                (\n+                    format!(\"&self{}\", if sig.decl.inputs.is_empty() { \"\" } else { \", \" }),\n+                    sm.span_through_char(sig.span, '(').shrink_to_hi(),\n+                ),\n+                (\n+                    format!(\"{} Self: Sized\", generics.add_where_or_trailing_comma()),\n+                    generics.tail_span_for_predicate_suggestion(),\n+                ),\n+            ))\n+        } else {\n+            None\n+        };\n+        return Some(MethodViolationCode::StaticMethod(sugg));\n     }\n \n-    for (i, &input_ty) in sig.skip_binder().inputs()[1..].iter().enumerate() {\n+    for (i, &input_ty) in sig.skip_binder().inputs().iter().enumerate().skip(1) {\n         if contains_illegal_self_type_reference(tcx, trait_def_id, sig.rebind(input_ty)) {\n-            return Some(MethodViolationCode::ReferencesSelfInput(i));\n+            let span = if let Some(hir::Node::TraitItem(hir::TraitItem {\n+                kind: hir::TraitItemKind::Fn(sig, _),\n+                ..\n+            })) = tcx.hir().get_if_local(method.def_id).as_ref()\n+            {\n+                Some(sig.decl.inputs[i].span)\n+            } else {\n+                None\n+            };\n+            return Some(MethodViolationCode::ReferencesSelfInput(span));\n         }\n     }\n     if contains_illegal_self_type_reference(tcx, trait_def_id, sig.output()) {\n@@ -456,7 +459,16 @@ fn virtual_call_violation_for_method<'tcx>(\n     // `Receiver: Unsize<Receiver[Self => dyn Trait]>`.\n     if receiver_ty != tcx.types.self_param {\n         if !receiver_is_dispatchable(tcx, method, receiver_ty) {\n-            return Some(MethodViolationCode::UndispatchableReceiver);\n+            let span = if let Some(hir::Node::TraitItem(hir::TraitItem {\n+                kind: hir::TraitItemKind::Fn(sig, _),\n+                ..\n+            })) = tcx.hir().get_if_local(method.def_id).as_ref()\n+            {\n+                Some(sig.decl.inputs[0].span)\n+            } else {\n+                None\n+            };\n+            return Some(MethodViolationCode::UndispatchableReceiver(span));\n         } else {\n             // Do sanity check to make sure the receiver actually has the layout of a pointer.\n "}, {"sha": "7c9829b823ede6510af1368a6282776ee4662d4f", "filename": "src/test/ui/suggestions/auxiliary/not-object-safe.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/eff865ca7605c0c1297aea51b377b53dbda48b3f/src%2Ftest%2Fui%2Fsuggestions%2Fauxiliary%2Fnot-object-safe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eff865ca7605c0c1297aea51b377b53dbda48b3f/src%2Ftest%2Fui%2Fsuggestions%2Fauxiliary%2Fnot-object-safe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fauxiliary%2Fnot-object-safe.rs?ref=eff865ca7605c0c1297aea51b377b53dbda48b3f", "patch": "@@ -0,0 +1,6 @@\n+use std::sync::Arc;\n+\n+pub trait A {\n+    fn f();\n+    fn f2(self: &Arc<Self>);\n+}"}, {"sha": "a2717fd9206d10d128d9cdd1ab97d7e10d018d8a", "filename": "src/test/ui/suggestions/issue-98500.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/eff865ca7605c0c1297aea51b377b53dbda48b3f/src%2Ftest%2Fui%2Fsuggestions%2Fissue-98500.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eff865ca7605c0c1297aea51b377b53dbda48b3f/src%2Ftest%2Fui%2Fsuggestions%2Fissue-98500.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fissue-98500.rs?ref=eff865ca7605c0c1297aea51b377b53dbda48b3f", "patch": "@@ -0,0 +1,14 @@\n+// aux-build:not-object-safe.rs\n+\n+extern crate not_object_safe;\n+\n+pub trait B where\n+    Self: not_object_safe::A,\n+{\n+    fn f2(&self);\n+}\n+\n+struct S(Box<dyn B>);\n+//~^ ERROR the trait `B` cannot be made into an object\n+\n+fn main() {}"}, {"sha": "e7251d735e38e6e9dc8dc01ee5edb6041a43b71a", "filename": "src/test/ui/suggestions/issue-98500.stderr", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/eff865ca7605c0c1297aea51b377b53dbda48b3f/src%2Ftest%2Fui%2Fsuggestions%2Fissue-98500.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/eff865ca7605c0c1297aea51b377b53dbda48b3f/src%2Ftest%2Fui%2Fsuggestions%2Fissue-98500.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fissue-98500.stderr?ref=eff865ca7605c0c1297aea51b377b53dbda48b3f", "patch": "@@ -0,0 +1,24 @@\n+error[E0038]: the trait `B` cannot be made into an object\n+  --> $DIR/issue-98500.rs:11:14\n+   |\n+LL | struct S(Box<dyn B>);\n+   |              ^^^^^ `B` cannot be made into an object\n+   |\n+note: for a trait to be \"object safe\" it needs to allow building a vtable to allow the call to be resolvable dynamically; for more information visit <https://doc.rust-lang.org/reference/items/traits.html#object-safety>\n+  --> $DIR/auxiliary/not-object-safe.rs:4:8\n+   |\n+LL |     fn f();\n+   |        ^ ...because associated function `f` has no `self` parameter\n+LL |     fn f2(self: &Arc<Self>);\n+   |        ^^ ...because method `f2`'s `self` parameter cannot be dispatched on\n+   |\n+  ::: $DIR/issue-98500.rs:5:11\n+   |\n+LL | pub trait B where\n+   |           - this trait cannot be made into an object...\n+   = help: consider moving `f` to another trait\n+   = help: consider moving `f2` to another trait\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0038`."}, {"sha": "69487c565c933e00e1d77beddaaec98c6bf3714f", "filename": "src/test/ui/suggestions/object-unsafe-trait-should-use-where-sized.fixed", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/eff865ca7605c0c1297aea51b377b53dbda48b3f/src%2Ftest%2Fui%2Fsuggestions%2Fobject-unsafe-trait-should-use-where-sized.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/eff865ca7605c0c1297aea51b377b53dbda48b3f/src%2Ftest%2Fui%2Fsuggestions%2Fobject-unsafe-trait-should-use-where-sized.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fobject-unsafe-trait-should-use-where-sized.fixed?ref=eff865ca7605c0c1297aea51b377b53dbda48b3f", "patch": "@@ -2,7 +2,7 @@\n #![allow(unused_variables, dead_code)]\n \n trait Trait {\n-    fn foo(&self) where Self: Other, Self: Sized, { }\n+    fn foo(&self) where Self: Other, Self: Sized { }\n     fn bar(self: &Self) {} //~ ERROR invalid `self` parameter type\n }\n "}, {"sha": "66969c170665421031a884ec3797a89adea89746", "filename": "src/test/ui/suggestions/object-unsafe-trait-should-use-where-sized.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/eff865ca7605c0c1297aea51b377b53dbda48b3f/src%2Ftest%2Fui%2Fsuggestions%2Fobject-unsafe-trait-should-use-where-sized.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/eff865ca7605c0c1297aea51b377b53dbda48b3f/src%2Ftest%2Fui%2Fsuggestions%2Fobject-unsafe-trait-should-use-where-sized.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fobject-unsafe-trait-should-use-where-sized.stderr?ref=eff865ca7605c0c1297aea51b377b53dbda48b3f", "patch": "@@ -28,8 +28,8 @@ LL |     fn foo(&self) where Self: Other, { }\n    |            +++++\n help: alternatively, consider constraining `foo` so it does not apply to trait objects\n    |\n-LL |     fn foo() where Self: Other, Self: Sized, { }\n-   |                               +++++++++++++\n+LL |     fn foo() where Self: Other, Self: Sized { }\n+   |                               ~~~~~~~~~~~~~\n help: consider changing method `bar`'s `self` parameter to be `&self`\n    |\n LL |     fn bar(self: &Self) {}"}]}