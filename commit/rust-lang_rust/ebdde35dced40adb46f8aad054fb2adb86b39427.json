{"sha": "ebdde35dced40adb46f8aad054fb2adb86b39427", "node_id": "C_kwDOAAsO6NoAKGViZGRlMzVkY2VkNDBhZGI0NmY4YWFkMDU0ZmIyYWRiODZiMzk0Mjc", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-20T03:07:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-20T03:07:17Z"}, "message": "Auto merge of #103205 - spastorino:fix-rpits-lifetime-remapping, r=cjgillot\n\nDo anonymous lifetimes remapping correctly for nested rpits\n\nCloses #103141\n\nr? `@cjgillot` `@nikomatsakis`\n\nThis fixes a stable to stable regression that in my opinion is `P-critical` so, we probably want to backport it all the way up to stable.", "tree": {"sha": "948e9386989e7b398a996dc4d3a98bc75b6cad6a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/948e9386989e7b398a996dc4d3a98bc75b6cad6a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ebdde35dced40adb46f8aad054fb2adb86b39427", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ebdde35dced40adb46f8aad054fb2adb86b39427", "html_url": "https://github.com/rust-lang/rust/commit/ebdde35dced40adb46f8aad054fb2adb86b39427", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ebdde35dced40adb46f8aad054fb2adb86b39427/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cb9467515b5a9b15aaa905683c6b4dd9e851056c", "url": "https://api.github.com/repos/rust-lang/rust/commits/cb9467515b5a9b15aaa905683c6b4dd9e851056c", "html_url": "https://github.com/rust-lang/rust/commit/cb9467515b5a9b15aaa905683c6b4dd9e851056c"}, {"sha": "49ce8a22b05d779da4ffc531a44380656d51404b", "url": "https://api.github.com/repos/rust-lang/rust/commits/49ce8a22b05d779da4ffc531a44380656d51404b", "html_url": "https://github.com/rust-lang/rust/commit/49ce8a22b05d779da4ffc531a44380656d51404b"}], "stats": {"total": 66, "additions": 46, "deletions": 20}, "files": [{"sha": "427b71722abcc5cfc4cc8cb5668d6aefb8f0976a", "filename": "compiler/rustc_ast_lowering/src/lib.rs", "status": "modified", "additions": 23, "deletions": 20, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/ebdde35dced40adb46f8aad054fb2adb86b39427/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ebdde35dced40adb46f8aad054fb2adb86b39427/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs?ref=ebdde35dced40adb46f8aad054fb2adb86b39427", "patch": "@@ -506,6 +506,17 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n         start\n     }\n \n+    /// Given the id of some node in the AST, finds the `LocalDefId` associated with it by the name\n+    /// resolver (if any).\n+    fn orig_opt_local_def_id(&self, node: NodeId) -> Option<LocalDefId> {\n+        self.resolver.node_id_to_def_id.get(&node).map(|local_def_id| *local_def_id)\n+    }\n+\n+    fn orig_local_def_id(&self, node: NodeId) -> LocalDefId {\n+        self.orig_opt_local_def_id(node)\n+            .unwrap_or_else(|| panic!(\"no entry for node id: `{:?}`\", node))\n+    }\n+\n     /// Given the id of some node in the AST, finds the `LocalDefId` associated with it by the name\n     /// resolver (if any), after applying any remapping from `get_remapped_def_id`.\n     ///\n@@ -520,10 +531,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n     /// we would create an opaque type `type FooReturn<'a1> = impl Debug + 'a1`.\n     /// When lowering the `Debug + 'a` bounds, we add a remapping to map `'a` to `'a1`.\n     fn opt_local_def_id(&self, node: NodeId) -> Option<LocalDefId> {\n-        self.resolver\n-            .node_id_to_def_id\n-            .get(&node)\n-            .map(|local_def_id| self.get_remapped_def_id(*local_def_id))\n+        self.orig_opt_local_def_id(node).map(|local_def_id| self.get_remapped_def_id(local_def_id))\n     }\n \n     fn local_def_id(&self, node: NodeId) -> LocalDefId {\n@@ -532,9 +540,9 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n \n     /// Get the previously recorded `to` local def id given the `from` local def id, obtained using\n     /// `generics_def_id_map` field.\n-    fn get_remapped_def_id(&self, mut local_def_id: LocalDefId) -> LocalDefId {\n+    fn get_remapped_def_id(&self, local_def_id: LocalDefId) -> LocalDefId {\n         // `generics_def_id_map` is a stack of mappings. As we go deeper in impl traits nesting we\n-        // push new mappings so we need to try first the latest mappings, hence `iter().rev()`.\n+        // push new mappings, so we first need to get the latest (innermost) mappings, hence `iter().rev()`.\n         //\n         // Consider:\n         //\n@@ -544,18 +552,13 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n         //\n         // `[[fn#'b -> impl_trait#'b], [fn#'b -> impl_sized#'b]]`\n         //\n-        // for the opaque type generated on `impl Sized + 'b`, We want the result to be:\n-        // impl_sized#'b, so iterating forward is the wrong thing to do.\n-        for map in self.generics_def_id_map.iter().rev() {\n-            if let Some(r) = map.get(&local_def_id) {\n-                debug!(\"def_id_remapper: remapping from `{local_def_id:?}` to `{r:?}`\");\n-                local_def_id = *r;\n-            } else {\n-                debug!(\"def_id_remapper: no remapping for `{local_def_id:?}` found in map\");\n-            }\n-        }\n-\n-        local_def_id\n+        // for the opaque type generated on `impl Sized + 'b`, we want the result to be: impl_sized#'b.\n+        // So, if we were trying to find first from the start (outermost) would give the wrong result, impl_trait#'b.\n+        self.generics_def_id_map\n+            .iter()\n+            .rev()\n+            .find_map(|map| map.get(&local_def_id).map(|local_def_id| *local_def_id))\n+            .unwrap_or(local_def_id)\n     }\n \n     /// Freshen the `LoweringContext` and ready it to lower a nested item.\n@@ -1633,7 +1636,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n \n                 LifetimeRes::Fresh { param, binder: _ } => {\n                     debug_assert_eq!(lifetime.ident.name, kw::UnderscoreLifetime);\n-                    if let Some(old_def_id) = self.opt_local_def_id(param) && remapping.get(&old_def_id).is_none() {\n+                    if let Some(old_def_id) = self.orig_opt_local_def_id(param) && remapping.get(&old_def_id).is_none() {\n                         let node_id = self.next_node_id();\n \n                         let new_def_id = self.create_def(\n@@ -1878,7 +1881,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n         let extra_lifetime_params = self.resolver.take_extra_lifetime_params(opaque_ty_node_id);\n         debug!(?extra_lifetime_params);\n         for (ident, outer_node_id, outer_res) in extra_lifetime_params {\n-            let outer_def_id = self.local_def_id(outer_node_id);\n+            let outer_def_id = self.orig_local_def_id(outer_node_id);\n             let inner_node_id = self.next_node_id();\n \n             // Add a definition for the in scope lifetime def."}, {"sha": "287a030cf876b851b58669ce99ee59660e374a6a", "filename": "src/test/ui/impl-trait/nested-rpit-with-anonymous-lifetimes.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/ebdde35dced40adb46f8aad054fb2adb86b39427/src%2Ftest%2Fui%2Fimpl-trait%2Fnested-rpit-with-anonymous-lifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ebdde35dced40adb46f8aad054fb2adb86b39427/src%2Ftest%2Fui%2Fimpl-trait%2Fnested-rpit-with-anonymous-lifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fnested-rpit-with-anonymous-lifetimes.rs?ref=ebdde35dced40adb46f8aad054fb2adb86b39427", "patch": "@@ -0,0 +1,23 @@\n+// check-pass\n+\n+pub struct VecNumber<'s> {\n+    pub vec_number: Vec<Number<'s>>,\n+    pub auxiliary_object: &'s Vec<usize>,\n+}\n+\n+pub struct Number<'s> {\n+    pub number: &'s usize,\n+}\n+\n+impl<'s> VecNumber<'s> {\n+    pub fn vec_number_iterable_per_item_in_auxiliary_object(\n+        &self,\n+    ) -> impl Iterator<Item = (&'s usize, impl Iterator<Item = &Number<'s>>)> {\n+        self.auxiliary_object.iter().map(move |n| {\n+            let iter_number = self.vec_number.iter();\n+            (n, iter_number)\n+        })\n+    }\n+}\n+\n+fn main() {}"}]}