{"sha": "bed54cf85457d76f479fcd406f07b39c5e8abb12", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJlZDU0Y2Y4NTQ1N2Q3NmY0NzlmY2Q0MDZmMDdiMzljNWU4YWJiMTI=", "commit": {"author": {"name": "QuietMisdreavus", "email": "grey@quietmisdreavus.net", "date": "2019-06-28T15:31:27Z"}, "committer": {"name": "QuietMisdreavus", "email": "grey@quietmisdreavus.net", "date": "2019-07-07T02:37:17Z"}, "message": "rustdoc: set cfg(doctest) when collecting doctests", "tree": {"sha": "6f57cc26d9d118bbe1b59afd1e08cebe9659c126", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6f57cc26d9d118bbe1b59afd1e08cebe9659c126"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bed54cf85457d76f479fcd406f07b39c5e8abb12", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bed54cf85457d76f479fcd406f07b39c5e8abb12", "html_url": "https://github.com/rust-lang/rust/commit/bed54cf85457d76f479fcd406f07b39c5e8abb12", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bed54cf85457d76f479fcd406f07b39c5e8abb12/comments", "author": {"login": "QuietMisdreavus", "id": 5217170, "node_id": "MDQ6VXNlcjUyMTcxNzA=", "avatar_url": "https://avatars.githubusercontent.com/u/5217170?v=4", "gravatar_id": "", "url": "https://api.github.com/users/QuietMisdreavus", "html_url": "https://github.com/QuietMisdreavus", "followers_url": "https://api.github.com/users/QuietMisdreavus/followers", "following_url": "https://api.github.com/users/QuietMisdreavus/following{/other_user}", "gists_url": "https://api.github.com/users/QuietMisdreavus/gists{/gist_id}", "starred_url": "https://api.github.com/users/QuietMisdreavus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/QuietMisdreavus/subscriptions", "organizations_url": "https://api.github.com/users/QuietMisdreavus/orgs", "repos_url": "https://api.github.com/users/QuietMisdreavus/repos", "events_url": "https://api.github.com/users/QuietMisdreavus/events{/privacy}", "received_events_url": "https://api.github.com/users/QuietMisdreavus/received_events", "type": "User", "site_admin": false}, "committer": {"login": "QuietMisdreavus", "id": 5217170, "node_id": "MDQ6VXNlcjUyMTcxNzA=", "avatar_url": "https://avatars.githubusercontent.com/u/5217170?v=4", "gravatar_id": "", "url": "https://api.github.com/users/QuietMisdreavus", "html_url": "https://github.com/QuietMisdreavus", "followers_url": "https://api.github.com/users/QuietMisdreavus/followers", "following_url": "https://api.github.com/users/QuietMisdreavus/following{/other_user}", "gists_url": "https://api.github.com/users/QuietMisdreavus/gists{/gist_id}", "starred_url": "https://api.github.com/users/QuietMisdreavus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/QuietMisdreavus/subscriptions", "organizations_url": "https://api.github.com/users/QuietMisdreavus/orgs", "repos_url": "https://api.github.com/users/QuietMisdreavus/repos", "events_url": "https://api.github.com/users/QuietMisdreavus/events{/privacy}", "received_events_url": "https://api.github.com/users/QuietMisdreavus/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b0bd5f236d9bea38b8c9048f379fec179b09984c", "url": "https://api.github.com/repos/rust-lang/rust/commits/b0bd5f236d9bea38b8c9048f379fec179b09984c", "html_url": "https://github.com/rust-lang/rust/commit/b0bd5f236d9bea38b8c9048f379fec179b09984c"}], "stats": {"total": 80, "additions": 77, "deletions": 3}, "files": [{"sha": "1d9510c9aacabcc9f4bd9940e712f8f105ac4510", "filename": "src/doc/rustdoc/src/unstable-features.md", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md", "raw_url": "https://github.com/rust-lang/rust/raw/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md?ref=bed54cf85457d76f479fcd406f07b39c5e8abb12", "patch": "@@ -212,6 +212,36 @@ pub struct BigX;\n Then, when looking for it through the `rustdoc` search, if you enter \"x\" or\n \"big\", search will show the `BigX` struct first.\n \n+### Include items only when collecting doctests\n+\n+Rustdoc's [documentation tests] can do some things that regular unit tests can't, so it can\n+sometimes be useful to extend your doctests with samples that wouldn't otherwise need to be in\n+documentation. To this end, Rustdoc allows you to have certain items only appear when it's\n+collecting doctests, so you can utilize doctest functionality without forcing the test to appear in\n+docs, or to find an arbitrary private item to include it on.\n+\n+If you add `#![feature(cfg_doctest)]` to your crate, Rustdoc will set `cfg(doctest)` when collecting\n+doctests. Note that they will still link against only the public items of your crate; if you need to\n+test private items, unit tests are still the way to go.\n+\n+In this example, we're adding doctests that we know won't compile, to verify that our struct can\n+only take in valid data:\n+\n+```rust\n+#![feature(cfg_doctest)]\n+\n+/// We have a struct here. Remember it doesn't accept negative numbers!\n+pub struct MyStruct(usize);\n+\n+/// ```compile_fail\n+/// let x = my_crate::MyStruct(-5);\n+/// ```\n+#[cfg(doctest)]\n+pub struct MyStructOnlyTakesUsize;\n+```\n+\n+[documentation tests]: documentation-tests.html\n+\n ## Unstable command-line arguments\n \n These features are enabled by passing a command-line flag to Rustdoc, but the flags in question are"}, {"sha": "9fae246155e06dcc411d8ef31b68d9243c3cceef", "filename": "src/librustdoc/config.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Flibrustdoc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Flibrustdoc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fconfig.rs?ref=bed54cf85457d76f479fcd406f07b39c5e8abb12", "patch": "@@ -351,6 +351,9 @@ impl Options {\n                             .unwrap_or_else(|| PathBuf::from(\"doc\"));\n         let mut cfgs = matches.opt_strs(\"cfg\");\n         cfgs.push(\"rustdoc\".to_string());\n+        if should_test {\n+            cfgs.push(\"doctest\".to_string());\n+        }\n \n         let extension_css = matches.opt_str(\"e\").map(|s| PathBuf::from(&s));\n "}, {"sha": "c1a794a0d006a94e840458f2013dfd6f58c689c2", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=bed54cf85457d76f479fcd406f07b39c5e8abb12", "patch": "@@ -577,6 +577,9 @@ declare_features! (\n     // Allows `async || body` closures.\n     (active, async_closure, \"1.37.0\", Some(62290), None),\n \n+    // Allows the use of `#[cfg(doctest)]`, set when rustdoc is collecting doctests\n+    (active, cfg_doctest, \"1.37.0\", Some(62210), None),\n+\n     // -------------------------------------------------------------------------\n     // feature-group-end: actual feature gates\n     // -------------------------------------------------------------------------\n@@ -1592,6 +1595,7 @@ const GATED_CFGS: &[(Symbol, Symbol, fn(&Features) -> bool)] = &[\n     (sym::target_thread_local, sym::cfg_target_thread_local, cfg_fn!(cfg_target_thread_local)),\n     (sym::target_has_atomic, sym::cfg_target_has_atomic, cfg_fn!(cfg_target_has_atomic)),\n     (sym::rustdoc, sym::doc_cfg, cfg_fn!(doc_cfg)),\n+    (sym::doctest, sym::cfg_doctest, cfg_fn!(cfg_doctest)),\n ];\n \n #[derive(Debug)]"}, {"sha": "bfcb185785266c916f3960cc763f68f83c848a57", "filename": "src/libsyntax_pos/symbol.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Flibsyntax_pos%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Flibsyntax_pos%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_pos%2Fsymbol.rs?ref=bed54cf85457d76f479fcd406f07b39c5e8abb12", "patch": "@@ -170,6 +170,7 @@ symbols! {\n         cfg,\n         cfg_attr,\n         cfg_attr_multi,\n+        cfg_doctest,\n         cfg_target_feature,\n         cfg_target_has_atomic,\n         cfg_target_thread_local,\n@@ -235,6 +236,7 @@ symbols! {\n         doc_keyword,\n         doc_masked,\n         doc_spotlight,\n+        doctest,\n         document_private_items,\n         dotdoteq_in_patterns,\n         dotdot_in_tuple_patterns,"}, {"sha": "5360354d77a85bcee5ef89d6977145891dde4278", "filename": "src/test/rustdoc-ui/cfg-test.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Ftest%2Frustdoc-ui%2Fcfg-test.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Ftest%2Frustdoc-ui%2Fcfg-test.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcfg-test.rs?ref=bed54cf85457d76f479fcd406f07b39c5e8abb12", "patch": "@@ -5,6 +5,8 @@\n // Crates like core have doctests gated on `cfg(not(test))` so we need to make\n // sure `cfg(test)` is not active when running `rustdoc --test`.\n \n+#![feature(cfg_doctest)]\n+\n /// this doctest will be ignored:\n ///\n /// ```\n@@ -20,3 +22,11 @@ pub struct Foo;\n /// ```\n #[cfg(not(test))]\n pub struct Foo;\n+\n+/// this doctest will be tested, but will not appear in documentation:\n+///\n+/// ```\n+/// assert!(true)\n+/// ```\n+#[cfg(doctest)]\n+pub struct Bar;"}, {"sha": "de7e6097fb788ca16aa0a29e858b28542d4b77bf", "filename": "src/test/rustdoc-ui/cfg-test.stdout", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Ftest%2Frustdoc-ui%2Fcfg-test.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Ftest%2Frustdoc-ui%2Fcfg-test.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcfg-test.stdout?ref=bed54cf85457d76f479fcd406f07b39c5e8abb12", "patch": "@@ -1,6 +1,7 @@\n \n-running 1 test\n-test $DIR/cfg-test.rs - Foo (line 18) ... ok\n+running 2 tests\n+test $DIR/cfg-test.rs - Foo (line 20) ... ok\n+test $DIR/cfg-test.rs - Bar (line 28) ... ok\n \n-test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out\n+test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out\n "}, {"sha": "fca6d1029f981ea7b108b4bd40c553d481b5fe9d", "filename": "src/test/rustdoc/cfg-doctest.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Ftest%2Frustdoc%2Fcfg-doctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Ftest%2Frustdoc%2Fcfg-doctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fcfg-doctest.rs?ref=bed54cf85457d76f479fcd406f07b39c5e8abb12", "patch": "@@ -0,0 +1,8 @@\n+#![feature(cfg_doctest)]\n+\n+// @!has cfg_doctest/struct.SomeStruct.html\n+// @!has cfg_doctest/index.html '//a/@href' 'struct.SomeStruct.html'\n+\n+/// Sneaky, this isn't actually part of docs.\n+#[cfg(doctest)]\n+pub struct SomeStruct;"}, {"sha": "308f68bd52a79de82bf4011938a1c8547fc33626", "filename": "src/test/ui/feature-gate/feature-gate-cfg_doctest.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.rs?ref=bed54cf85457d76f479fcd406f07b39c5e8abb12", "patch": "@@ -0,0 +1,4 @@\n+#[cfg(doctest)] //~ ERROR\n+pub struct SomeStruct;\n+\n+fn main() {}"}, {"sha": "aa1d18a6f759de55ea8757dbde5de902326a6161", "filename": "src/test/ui/feature-gate/feature-gate-cfg_doctest.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bed54cf85457d76f479fcd406f07b39c5e8abb12/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.stderr?ref=bed54cf85457d76f479fcd406f07b39c5e8abb12", "patch": "@@ -0,0 +1,12 @@\n+error[E0658]: `cfg(doctest)` is experimental and subject to change\n+  --> $DIR/feature-gate-cfg_doctest.rs:1:7\n+   |\n+LL | #[cfg(doctest)]\n+   |       ^^^^^^^\n+   |\n+   = note: for more information, see https://github.com/rust-lang/rust/issues/62210\n+   = help: add #![feature(cfg_doctest)] to the crate attributes to enable\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0658`."}]}