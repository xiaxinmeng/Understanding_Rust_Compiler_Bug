{"sha": "d29d5545b6a5485bb1a51e035889e20330b2e4f7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQyOWQ1NTQ1YjZhNTQ4NWJiMWE1MWUwMzU4ODllMjAzMzBiMmU0Zjc=", "commit": {"author": {"name": "Simonas Kazlauskas", "email": "git@kazlauskas.me", "date": "2015-03-23T17:06:09Z"}, "committer": {"name": "Simonas Kazlauskas", "email": "git@kazlauskas.me", "date": "2015-03-23T18:08:12Z"}, "message": "prctl instead of pthread on linux for name setup\n\nThis is more portable as far as linux is concerned.", "tree": {"sha": "c91950088e3ad52b098fef944bf047e0fa1beef0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c91950088e3ad52b098fef944bf047e0fa1beef0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d29d5545b6a5485bb1a51e035889e20330b2e4f7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d29d5545b6a5485bb1a51e035889e20330b2e4f7", "html_url": "https://github.com/rust-lang/rust/commit/d29d5545b6a5485bb1a51e035889e20330b2e4f7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d29d5545b6a5485bb1a51e035889e20330b2e4f7/comments", "author": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b0aad7dd4fad8d7e2e2f877a511a637258949597", "url": "https://api.github.com/repos/rust-lang/rust/commits/b0aad7dd4fad8d7e2e2f877a511a637258949597", "html_url": "https://github.com/rust-lang/rust/commit/b0aad7dd4fad8d7e2e2f877a511a637258949597"}], "stats": {"total": 19, "additions": 8, "deletions": 11}, "files": [{"sha": "4ba0d6472b62e889682e610ba49d68b3dcbc6bae", "filename": "src/libstd/sys/unix/thread.rs", "status": "modified", "additions": 8, "deletions": 11, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/d29d5545b6a5485bb1a51e035889e20330b2e4f7/src%2Flibstd%2Fsys%2Funix%2Fthread.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d29d5545b6a5485bb1a51e035889e20330b2e4f7/src%2Flibstd%2Fsys%2Funix%2Fthread.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Funix%2Fthread.rs?ref=d29d5545b6a5485bb1a51e035889e20330b2e4f7", "patch": "@@ -227,19 +227,16 @@ pub unsafe fn create(stack: usize, p: Thunk) -> io::Result<rust_thread> {\n \n #[cfg(any(target_os = \"linux\", target_os = \"android\"))]\n pub unsafe fn set_name(name: &str) {\n-    // pthread_setname_np() since glibc 2.12\n-    // availability autodetected via weak linkage\n-    type F = unsafe extern fn(libc::pthread_t, *const libc::c_char)\n-                              -> libc::c_int;\n+    // pthread wrapper only appeared in glibc 2.12, so we use syscall directly.\n     extern {\n-        #[linkage = \"extern_weak\"]\n-        static pthread_setname_np: *const ();\n-    }\n-    if !pthread_setname_np.is_null() {\n-        let cname = CString::new(name).unwrap();\n-        mem::transmute::<*const (), F>(pthread_setname_np)(pthread_self(),\n-                                                           cname.as_ptr());\n+        fn prctl(option: libc::c_int, arg2: libc::c_ulong, arg3: libc::c_ulong,\n+                 arg4: libc::c_ulong, arg5: libc::c_ulong) -> libc::c_int;\n     }\n+    const PR_SET_NAME: libc::c_int = 15;\n+    let cname = CString::new(name).unwrap_or_else(|_| {\n+        panic!(\"thread name may not contain interior null bytes\")\n+    });\n+    prctl(PR_SET_NAME, cname.as_ptr() as libc::c_ulong, 0, 0, 0);\n }\n \n #[cfg(any(target_os = \"freebsd\","}]}