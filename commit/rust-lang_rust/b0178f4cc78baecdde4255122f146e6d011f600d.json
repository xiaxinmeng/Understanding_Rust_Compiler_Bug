{"sha": "b0178f4cc78baecdde4255122f146e6d011f600d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIwMTc4ZjRjYzc4YmFlY2RkZTQyNTUxMjJmMTQ2ZTZkMDExZjYwMGQ=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-11-15T12:39:57Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-15T12:39:57Z"}, "message": "Rollup merge of #79034 - petrochenkov:mrscopes3, r=eddyb\n\nrustc_resolve: Make `macro_rules` scope chain compression lazy\n\nAs suggested in https://github.com/rust-lang/rust/pull/78826#issuecomment-723420664.", "tree": {"sha": "1bb0516f216dc07cf1511b4205e6488f32f9c57a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1bb0516f216dc07cf1511b4205e6488f32f9c57a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b0178f4cc78baecdde4255122f146e6d011f600d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfsSGeCRBK7hj4Ov3rIwAAdHIIAI/ZONCF4vTbId2k+IMEIA+J\nxrAIMnM7k1/YJKP88jujzSjj0COXBpC6Bzcn3hLIBFQyhWMnclKJlHizifyPo4aD\n3taLCRAQ9LnBtLpqNjmRfHExPehJei0eRnj/p9gabIzcyd7xR1GuL4r8G6ZG48lH\nGU8Z0xOiMu6cUS+xkC5AHuP0G2/zLhQsie82hIeyK9doPXqV5WB+FaFZN1vc9VD8\n26oOpDlTRXnKN6IYilfUxUwXXtk6X6nApdZvu3jBHSZdI5CcvRcbMt5P5W0Z17Wk\nUAD3ChK1ngi6KHDLCSj3fP0P2WRhEWa13gtAEnzvmFZh2kcHwLz7uZYdsUvx75I=\n=FdPZ\n-----END PGP SIGNATURE-----\n", "payload": "tree 1bb0516f216dc07cf1511b4205e6488f32f9c57a\nparent 9c6d3c09404ba8f7504f8889b7afd82fa4bcee97\nparent ac4c1f58b9fe1b4182b8af598751afd88caa5db5\nauthor Jonas Schievink <jonasschievink@gmail.com> 1605443997 +0100\ncommitter GitHub <noreply@github.com> 1605443997 +0100\n\nRollup merge of #79034 - petrochenkov:mrscopes3, r=eddyb\n\nrustc_resolve: Make `macro_rules` scope chain compression lazy\n\nAs suggested in https://github.com/rust-lang/rust/pull/78826#issuecomment-723420664.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b0178f4cc78baecdde4255122f146e6d011f600d", "html_url": "https://github.com/rust-lang/rust/commit/b0178f4cc78baecdde4255122f146e6d011f600d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b0178f4cc78baecdde4255122f146e6d011f600d/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9c6d3c09404ba8f7504f8889b7afd82fa4bcee97", "url": "https://api.github.com/repos/rust-lang/rust/commits/9c6d3c09404ba8f7504f8889b7afd82fa4bcee97", "html_url": "https://github.com/rust-lang/rust/commit/9c6d3c09404ba8f7504f8889b7afd82fa4bcee97"}, {"sha": "ac4c1f58b9fe1b4182b8af598751afd88caa5db5", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac4c1f58b9fe1b4182b8af598751afd88caa5db5", "html_url": "https://github.com/rust-lang/rust/commit/ac4c1f58b9fe1b4182b8af598751afd88caa5db5"}], "stats": {"total": 57, "additions": 21, "deletions": 36}, "files": [{"sha": "493b9f15271ef8258fbf63f8846bdc75fb85690d", "filename": "compiler/rustc_resolve/src/build_reduced_graph.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b0178f4cc78baecdde4255122f146e6d011f600d/compiler%2Frustc_resolve%2Fsrc%2Fbuild_reduced_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0178f4cc78baecdde4255122f146e6d011f600d/compiler%2Frustc_resolve%2Fsrc%2Fbuild_reduced_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fbuild_reduced_graph.rs?ref=b0178f4cc78baecdde4255122f146e6d011f600d", "patch": "@@ -1163,9 +1163,7 @@ impl<'a, 'b> BuildReducedGraphVisitor<'a, 'b> {\n         let old_parent_scope = self.r.invocation_parent_scopes.insert(invoc_id, self.parent_scope);\n         assert!(old_parent_scope.is_none(), \"invocation data is reset for an invocation\");\n \n-        let scope = self.r.arenas.alloc_macro_rules_scope(MacroRulesScope::Invocation(invoc_id));\n-        self.r.invocation_macro_rules_scopes.entry(invoc_id).or_default().insert(scope);\n-        scope\n+        self.r.arenas.alloc_macro_rules_scope(MacroRulesScope::Invocation(invoc_id))\n     }\n \n     fn proc_macro_stub(&self, item: &ast::Item) -> Option<(MacroKind, Ident, Span)> {"}, {"sha": "d18335ef2e63a205d755e3a85241d75a96a12461", "filename": "compiler/rustc_resolve/src/lib.rs", "status": "modified", "additions": 17, "deletions": 10, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/b0178f4cc78baecdde4255122f146e6d011f600d/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0178f4cc78baecdde4255122f146e6d011f600d/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flib.rs?ref=b0178f4cc78baecdde4255122f146e6d011f600d", "patch": "@@ -976,9 +976,6 @@ pub struct Resolver<'a> {\n     /// `macro_rules` scopes *produced* by expanding the macro invocations,\n     /// include all the `macro_rules` items and other invocations generated by them.\n     output_macro_rules_scopes: FxHashMap<ExpnId, MacroRulesScopeRef<'a>>,\n-    /// References to all `MacroRulesScope::Invocation(invoc_id)`s, used to update such scopes\n-    /// when their corresponding `invoc_id`s get expanded.\n-    invocation_macro_rules_scopes: FxHashMap<ExpnId, FxHashSet<MacroRulesScopeRef<'a>>>,\n     /// Helper attributes that are in scope for the given expansion.\n     helper_attrs: FxHashMap<ExpnId, Vec<Ident>>,\n \n@@ -1310,7 +1307,6 @@ impl<'a> Resolver<'a> {\n             non_macro_attrs: [non_macro_attr(false), non_macro_attr(true)],\n             invocation_parent_scopes: Default::default(),\n             output_macro_rules_scopes: Default::default(),\n-            invocation_macro_rules_scopes: Default::default(),\n             helper_attrs: Default::default(),\n             local_macro_def_scopes: FxHashMap::default(),\n             name_already_seen: FxHashMap::default(),\n@@ -1680,7 +1676,20 @@ impl<'a> Resolver<'a> {\n                     !(expn_id == parent_scope.expansion && macro_kind == Some(MacroKind::Derive))\n                 }\n                 Scope::DeriveHelpersCompat => true,\n-                Scope::MacroRules(..) => true,\n+                Scope::MacroRules(macro_rules_scope) => {\n+                    // Use \"path compression\" on `macro_rules` scope chains. This is an optimization\n+                    // used to avoid long scope chains, see the comments on `MacroRulesScopeRef`.\n+                    // As another consequence of this optimization visitors never observe invocation\n+                    // scopes for macros that were already expanded.\n+                    while let MacroRulesScope::Invocation(invoc_id) = macro_rules_scope.get() {\n+                        if let Some(next_scope) = self.output_macro_rules_scopes.get(&invoc_id) {\n+                            macro_rules_scope.set(next_scope.get());\n+                        } else {\n+                            break;\n+                        }\n+                    }\n+                    true\n+                }\n                 Scope::CrateRoot => true,\n                 Scope::Module(..) => true,\n                 Scope::RegisteredAttrs => use_prelude,\n@@ -1716,11 +1725,9 @@ impl<'a> Resolver<'a> {\n                     MacroRulesScope::Binding(binding) => {\n                         Scope::MacroRules(binding.parent_macro_rules_scope)\n                     }\n-                    MacroRulesScope::Invocation(invoc_id) => Scope::MacroRules(\n-                        self.output_macro_rules_scopes.get(&invoc_id).cloned().unwrap_or_else(\n-                            || self.invocation_parent_scopes[&invoc_id].macro_rules,\n-                        ),\n-                    ),\n+                    MacroRulesScope::Invocation(invoc_id) => {\n+                        Scope::MacroRules(self.invocation_parent_scopes[&invoc_id].macro_rules)\n+                    }\n                     MacroRulesScope::Empty => Scope::Module(module),\n                 },\n                 Scope::CrateRoot => match ns {"}, {"sha": "e052b6b334529c036ee4ba29e5f443f96abe4023", "filename": "compiler/rustc_resolve/src/macros.rs", "status": "modified", "additions": 3, "deletions": 23, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/b0178f4cc78baecdde4255122f146e6d011f600d/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0178f4cc78baecdde4255122f146e6d011f600d/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs?ref=b0178f4cc78baecdde4255122f146e6d011f600d", "patch": "@@ -62,8 +62,8 @@ pub enum MacroRulesScope<'a> {\n }\n \n /// `macro_rules!` scopes are always kept by reference and inside a cell.\n-/// The reason is that we update all scopes with value `MacroRulesScope::Invocation(invoc_id)`\n-/// in-place immediately after `invoc_id` gets expanded.\n+/// The reason is that we update scopes with value `MacroRulesScope::Invocation(invoc_id)`\n+/// in-place after `invoc_id` gets expanded.\n /// This helps to avoid uncontrollable growth of `macro_rules!` scope chains,\n /// which usually grow lineraly with the number of macro invocations\n /// in a module (including derives) and hurt performance.\n@@ -173,22 +173,6 @@ impl<'a> ResolverExpand for Resolver<'a> {\n         let output_macro_rules_scope = self.build_reduced_graph(fragment, parent_scope);\n         self.output_macro_rules_scopes.insert(expansion, output_macro_rules_scope);\n \n-        // Update all `macro_rules` scopes referring to this invocation. This is an optimization\n-        // used to avoid long scope chains, see the comments on `MacroRulesScopeRef`.\n-        if let Some(invocation_scopes) = self.invocation_macro_rules_scopes.remove(&expansion) {\n-            for invocation_scope in &invocation_scopes {\n-                invocation_scope.set(output_macro_rules_scope.get());\n-            }\n-            // All `macro_rules` scopes that previously referred to `expansion`\n-            // are now rerouted to its output scope, if it's also an invocation.\n-            if let MacroRulesScope::Invocation(invoc_id) = output_macro_rules_scope.get() {\n-                self.invocation_macro_rules_scopes\n-                    .entry(invoc_id)\n-                    .or_default()\n-                    .extend(invocation_scopes);\n-            }\n-        }\n-\n         parent_scope.module.unexpanded_invocations.borrow_mut().remove(&expansion);\n     }\n \n@@ -687,11 +671,7 @@ impl<'a> Resolver<'a> {\n                         {\n                             Ok((macro_rules_binding.binding, Flags::MACRO_RULES))\n                         }\n-                        MacroRulesScope::Invocation(invoc_id)\n-                            if !this.output_macro_rules_scopes.contains_key(&invoc_id) =>\n-                        {\n-                            Err(Determinacy::Undetermined)\n-                        }\n+                        MacroRulesScope::Invocation(_) => Err(Determinacy::Undetermined),\n                         _ => Err(Determinacy::Determined),\n                     },\n                     Scope::CrateRoot => {"}]}