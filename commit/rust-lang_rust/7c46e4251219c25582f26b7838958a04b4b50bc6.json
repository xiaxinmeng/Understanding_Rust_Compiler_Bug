{"sha": "7c46e4251219c25582f26b7838958a04b4b50bc6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdjNDZlNDI1MTIxOWMyNTU4MmYyNmI3ODM4OTU4YTA0YjRiNTBiYzY=", "commit": {"author": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2020-06-26T00:41:32Z"}, "committer": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2020-06-28T17:08:11Z"}, "message": "Stop checking for `while` and `loop` in a const context", "tree": {"sha": "19a26dedaf1c45344f77f4ebb2fcf826433e987f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/19a26dedaf1c45344f77f4ebb2fcf826433e987f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7c46e4251219c25582f26b7838958a04b4b50bc6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7c46e4251219c25582f26b7838958a04b4b50bc6", "html_url": "https://github.com/rust-lang/rust/commit/7c46e4251219c25582f26b7838958a04b4b50bc6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7c46e4251219c25582f26b7838958a04b4b50bc6/comments", "author": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5bed94cda405f157bafae010da90d201a2875e42", "url": "https://api.github.com/repos/rust-lang/rust/commits/5bed94cda405f157bafae010da90d201a2875e42", "html_url": "https://github.com/rust-lang/rust/commit/5bed94cda405f157bafae010da90d201a2875e42"}], "stats": {"total": 32, "additions": 6, "deletions": 26}, "files": [{"sha": "ea025f208e49d733a25a3be51bf856cdcfb0a101", "filename": "src/librustc_mir/transform/check_consts/ops.rs", "status": "modified", "additions": 0, "deletions": 13, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/7c46e4251219c25582f26b7838958a04b4b50bc6/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c46e4251219c25582f26b7838958a04b4b50bc6/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fops.rs?ref=7c46e4251219c25582f26b7838958a04b4b50bc6", "patch": "@@ -164,19 +164,6 @@ impl NonConstOp for LiveDrop {\n     }\n }\n \n-#[derive(Debug)]\n-pub struct Loop;\n-impl NonConstOp for Loop {\n-    fn feature_gate() -> Option<Symbol> {\n-        Some(sym::const_loop)\n-    }\n-\n-    fn emit_error(&self, ccx: &ConstCx<'_, '_>, span: Span) {\n-        // This should be caught by the HIR const-checker.\n-        ccx.tcx.sess.delay_span_bug(span, \"complex control flow is forbidden in a const context\");\n-    }\n-}\n-\n #[derive(Debug)]\n pub struct CellBorrow;\n impl NonConstOp for CellBorrow {"}, {"sha": "ca1f0aecd048a9d4adac6c72b59a2dc46bdafd41", "filename": "src/librustc_mir/transform/check_consts/validation.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7c46e4251219c25582f26b7838958a04b4b50bc6/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fvalidation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c46e4251219c25582f26b7838958a04b4b50bc6/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fvalidation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fvalidation.rs?ref=7c46e4251219c25582f26b7838958a04b4b50bc6", "patch": "@@ -207,12 +207,6 @@ impl Validator<'mir, 'tcx> {\n             }\n         }\n \n-        if body.is_cfg_cyclic() {\n-            // We can't provide a good span for the error here, but this should be caught by the\n-            // HIR const-checker anyways.\n-            self.check_op_spanned(ops::Loop, body.span);\n-        }\n-\n         self.visit_body(&body);\n \n         // Ensure that the end result is `Sync` in a non-thread local `static`."}, {"sha": "a385d96d974a482e7d35ec15f348b85f4e51b45f", "filename": "src/librustc_passes/check_const.rs", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/7c46e4251219c25582f26b7838958a04b4b50bc6/src%2Flibrustc_passes%2Fcheck_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c46e4251219c25582f26b7838958a04b4b50bc6/src%2Flibrustc_passes%2Fcheck_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Fcheck_const.rs?ref=7c46e4251219c25582f26b7838958a04b4b50bc6", "patch": "@@ -40,18 +40,17 @@ impl NonConstExpr {\n \n         let gates: &[_] = match self {\n             // A `for` loop's desugaring contains a call to `IntoIterator::into_iter`,\n-            // so they are not yet allowed with `#![feature(const_loop)]`.\n+            // so they are not yet allowed.\n             // Likewise, `?` desugars to a call to `Try::into_result`.\n             Self::Loop(ForLoop) | Self::Match(ForLoopDesugar | TryDesugar | AwaitDesugar) => {\n                 return None;\n             }\n \n-            Self::Loop(Loop | While | WhileLet) | Self::Match(WhileDesugar | WhileLetDesugar) => {\n-                &[sym::const_loop]\n-            }\n-\n-            // All other matches are allowed.\n-            Self::Match(Normal | IfDesugar { .. } | IfLetDesugar { .. }) => &[],\n+            // All other expressions are allowed.\n+            Self::Loop(Loop | While | WhileLet)\n+            | Self::Match(\n+                WhileDesugar | WhileLetDesugar | Normal | IfDesugar { .. } | IfLetDesugar { .. },\n+            ) => &[],\n         };\n \n         Some(gates)"}]}