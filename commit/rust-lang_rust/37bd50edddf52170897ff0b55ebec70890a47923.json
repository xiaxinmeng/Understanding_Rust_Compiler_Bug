{"sha": "37bd50edddf52170897ff0b55ebec70890a47923", "node_id": "C_kwDOAAsO6NoAKDM3YmQ1MGVkZGRmNTIxNzA4OTdmZjBiNTVlYmVjNzA4OTBhNDc5MjM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-03-03T19:45:02Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-03-03T19:45:02Z"}, "message": "Rollup merge of #108681 - nnethercote:needs_process_obligation-comments, r=lqd\n\nImprove comments in `needs_process_obligation`.\n\nAnd a couple of other places.\n\nr? `@lqd`", "tree": {"sha": "0994fecac7ecfc7e80614a193e682aa39f09c3f8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0994fecac7ecfc7e80614a193e682aa39f09c3f8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/37bd50edddf52170897ff0b55ebec70890a47923", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkAk4+CRBK7hj4Ov3rIwAAQdcIAJ1ZyTdbOzWtquvSsmzAdK1S\n63kbBoddxfZonP4xNxawsw7Tak9bFLR4iTavmbkgdw34x3wE2PwPTisNkoFhn73i\nndxrZuredof5Zp99cWsudEDsyy0XayNRLpMTeqPAd2qpRMLzDf/XezY+1Rma3+M6\n1vx8A1sIiufBuYU4iGcyzSlnFr3fdZNob0Sz7Zpi2AoDbQPCfbh2If0zJAvviHqg\nzADrNPpZ87XG+i5yAGZH1gr8Is95ivmREIe8/kJdpFdoBfs8IkC3zElnpRSdOXdr\nq2MGQD4mKi1Yo3BhdtmUT3vtxKUupz/CDu6E6sy/DCFBP6PkYKQs5ZJjY7eSA48=\n=vpWA\n-----END PGP SIGNATURE-----\n", "payload": "tree 0994fecac7ecfc7e80614a193e682aa39f09c3f8\nparent efc79bc65450f284251d7f3c3ace78b029bc8d59\nparent 3bcea5f97988af0e113128666cfabf335053d1d5\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1677872702 +0100\ncommitter GitHub <noreply@github.com> 1677872702 +0100\n\nRollup merge of #108681 - nnethercote:needs_process_obligation-comments, r=lqd\n\nImprove comments in `needs_process_obligation`.\n\nAnd a couple of other places.\n\nr? `@lqd`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/37bd50edddf52170897ff0b55ebec70890a47923", "html_url": "https://github.com/rust-lang/rust/commit/37bd50edddf52170897ff0b55ebec70890a47923", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/37bd50edddf52170897ff0b55ebec70890a47923/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "efc79bc65450f284251d7f3c3ace78b029bc8d59", "url": "https://api.github.com/repos/rust-lang/rust/commits/efc79bc65450f284251d7f3c3ace78b029bc8d59", "html_url": "https://github.com/rust-lang/rust/commit/efc79bc65450f284251d7f3c3ace78b029bc8d59"}, {"sha": "3bcea5f97988af0e113128666cfabf335053d1d5", "url": "https://api.github.com/repos/rust-lang/rust/commits/3bcea5f97988af0e113128666cfabf335053d1d5", "html_url": "https://github.com/rust-lang/rust/commit/3bcea5f97988af0e113128666cfabf335053d1d5"}], "stats": {"total": 58, "additions": 34, "deletions": 24}, "files": [{"sha": "91abdaadabdbd4453fc38881ab96ebc0d0805394", "filename": "compiler/rustc_data_structures/src/obligation_forest/mod.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/37bd50edddf52170897ff0b55ebec70890a47923/compiler%2Frustc_data_structures%2Fsrc%2Fobligation_forest%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37bd50edddf52170897ff0b55ebec70890a47923/compiler%2Frustc_data_structures%2Fsrc%2Fobligation_forest%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fobligation_forest%2Fmod.rs?ref=37bd50edddf52170897ff0b55ebec70890a47923", "patch": "@@ -426,6 +426,7 @@ impl<O: ForestObligation> ObligationForest<O> {\n             // nodes. Therefore we use a `while` loop.\n             let mut index = 0;\n             while let Some(node) = self.nodes.get_mut(index) {\n+                // This test is extremely hot.\n                 if node.state.get() != NodeState::Pending\n                     || !processor.needs_process_obligation(&node.obligation)\n                 {\n@@ -439,6 +440,7 @@ impl<O: ForestObligation> ObligationForest<O> {\n                 // out of sync with `nodes`. It's not very common, but it does\n                 // happen, and code in `compress` has to allow for it.\n \n+                // This code is much less hot.\n                 match processor.process_obligation(&mut node.obligation) {\n                     ProcessResult::Unchanged => {\n                         // No change in state."}, {"sha": "944436ab82f91cc79522d1dc5c9acc02e0280f4b", "filename": "compiler/rustc_trait_selection/src/traits/fulfill.rs", "status": "modified", "additions": 32, "deletions": 24, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/37bd50edddf52170897ff0b55ebec70890a47923/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ffulfill.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37bd50edddf52170897ff0b55ebec70890a47923/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ffulfill.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ffulfill.rs?ref=37bd50edddf52170897ff0b55ebec70890a47923", "patch": "@@ -212,36 +212,44 @@ impl<'a, 'tcx> ObligationProcessor for FulfillProcessor<'a, 'tcx> {\n \n     /// Identifies whether a predicate obligation needs processing.\n     ///\n-    /// This is always inlined, despite its size, because it has a single\n-    /// callsite and it is called *very* frequently.\n+    /// This is always inlined because it has a single callsite and it is\n+    /// called *very* frequently. Be careful modifying this code! Several\n+    /// compile-time benchmarks are very sensitive to even small changes.\n     #[inline(always)]\n     fn needs_process_obligation(&self, pending_obligation: &Self::Obligation) -> bool {\n         // If we were stalled on some unresolved variables, first check whether\n         // any of them have been resolved; if not, don't bother doing more work\n         // yet.\n-        match pending_obligation.stalled_on.len() {\n-            // Match arms are in order of frequency, which matters because this\n-            // code is so hot. 1 and 0 dominate; 2+ is fairly rare.\n-            1 => {\n-                let infer_var = pending_obligation.stalled_on[0];\n-                self.selcx.infcx.ty_or_const_infer_var_changed(infer_var)\n-            }\n-            0 => {\n-                // In this case we haven't changed, but wish to make a change.\n-                true\n-            }\n-            _ => {\n-                // This `for` loop was once a call to `all()`, but this lower-level\n-                // form was a perf win. See #64545 for details.\n-                (|| {\n-                    for &infer_var in &pending_obligation.stalled_on {\n-                        if self.selcx.infcx.ty_or_const_infer_var_changed(infer_var) {\n-                            return true;\n-                        }\n+        let stalled_on = &pending_obligation.stalled_on;\n+        match stalled_on.len() {\n+            // This case is the hottest most of the time, being hit up to 99%\n+            // of the time. `keccak` and `cranelift-codegen-0.82.1` are\n+            // benchmarks that particularly stress this path.\n+            1 => self.selcx.infcx.ty_or_const_infer_var_changed(stalled_on[0]),\n+\n+            // In this case we haven't changed, but wish to make a change. Note\n+            // that this is a special case, and is not equivalent to the `_`\n+            // case below, which would return `false` for an empty `stalled_on`\n+            // vector.\n+            //\n+            // This case is usually hit only 1% of the time or less, though it\n+            // reaches 20% in `wasmparser-0.101.0`.\n+            0 => true,\n+\n+            // This case is usually hit only 1% of the time or less, though it\n+            // reaches 95% in `mime-0.3.16`, 64% in `wast-54.0.0`, and 12% in\n+            // `inflate-0.4.5`.\n+            //\n+            // The obvious way of writing this, with a call to `any()` and no\n+            // closure, is currently slower than this version.\n+            _ => (|| {\n+                for &infer_var in stalled_on {\n+                    if self.selcx.infcx.ty_or_const_infer_var_changed(infer_var) {\n+                        return true;\n                     }\n-                    false\n-                })()\n-            }\n+                }\n+                false\n+            })(),\n         }\n     }\n "}]}