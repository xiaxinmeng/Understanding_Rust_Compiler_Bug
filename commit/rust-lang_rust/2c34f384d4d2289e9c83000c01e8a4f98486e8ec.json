{"sha": "2c34f384d4d2289e9c83000c01e8a4f98486e8ec", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJjMzRmMzg0ZDRkMjI4OWU5YzgzMDAwYzAxZThhNGY5ODQ4NmU4ZWM=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-11-10T16:48:47Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-11-10T16:48:47Z"}, "message": "Move lock into CodeStats\n\nPrevent accidental too-long borrows by ensuring only encapsulated\nlocking.", "tree": {"sha": "af7679c9ac58914c94e7c4edd221e3da9e3f49c9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/af7679c9ac58914c94e7c4edd221e3da9e3f49c9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2c34f384d4d2289e9c83000c01e8a4f98486e8ec", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2c34f384d4d2289e9c83000c01e8a4f98486e8ec", "html_url": "https://github.com/rust-lang/rust/commit/2c34f384d4d2289e9c83000c01e8a4f98486e8ec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2c34f384d4d2289e9c83000c01e8a4f98486e8ec/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "86c28325ff813e5cf4d0cab320a7c9f6fb0766b8", "url": "https://api.github.com/repos/rust-lang/rust/commits/86c28325ff813e5cf4d0cab320a7c9f6fb0766b8", "html_url": "https://github.com/rust-lang/rust/commit/86c28325ff813e5cf4d0cab320a7c9f6fb0766b8"}], "stats": {"total": 30, "additions": 16, "deletions": 14}, "files": [{"sha": "5baf0c5948f28a5481a25ee1111f52494d9c7349", "filename": "src/librustc/session/code_stats.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/2c34f384d4d2289e9c83000c01e8a4f98486e8ec/src%2Flibrustc%2Fsession%2Fcode_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2c34f384d4d2289e9c83000c01e8a4f98486e8ec/src%2Flibrustc%2Fsession%2Fcode_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fcode_stats.rs?ref=2c34f384d4d2289e9c83000c01e8a4f98486e8ec", "patch": "@@ -1,6 +1,7 @@\n use rustc_target::abi::{Align, Size};\n use rustc_data_structures::fx::{FxHashSet};\n use std::cmp::{self, Ordering};\n+use rustc_data_structures::sync::Lock;\n \n #[derive(Clone, PartialEq, Eq, Hash, Debug)]\n pub struct VariantInfo {\n@@ -44,13 +45,13 @@ pub struct TypeSizeInfo {\n     pub variants: Vec<VariantInfo>,\n }\n \n-#[derive(PartialEq, Eq, Debug, Default)]\n+#[derive(Default)]\n pub struct CodeStats {\n-    type_sizes: FxHashSet<TypeSizeInfo>,\n+    type_sizes: Lock<FxHashSet<TypeSizeInfo>>,\n }\n \n impl CodeStats {\n-    pub fn record_type_size<S: ToString>(&mut self,\n+    pub fn record_type_size<S: ToString>(&self,\n                                          kind: DataTypeKind,\n                                          type_desc: S,\n                                          align: Align,\n@@ -73,11 +74,12 @@ impl CodeStats {\n             opt_discr_size: opt_discr_size.map(|s| s.bytes()),\n             variants,\n         };\n-        self.type_sizes.insert(info);\n+        self.type_sizes.borrow_mut().insert(info);\n     }\n \n     pub fn print_type_sizes(&self) {\n-        let mut sorted: Vec<_> = self.type_sizes.iter().collect();\n+        let type_sizes = self.type_sizes.borrow();\n+        let mut sorted: Vec<_> = type_sizes.iter().collect();\n \n         // Primary sort: large-to-small.\n         // Secondary sort: description (dictionary order)"}, {"sha": "920438da0d6387db44d14cb32a5e6873e9afb673", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2c34f384d4d2289e9c83000c01e8a4f98486e8ec/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2c34f384d4d2289e9c83000c01e8a4f98486e8ec/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=2c34f384d4d2289e9c83000c01e8a4f98486e8ec", "patch": "@@ -124,7 +124,7 @@ pub struct Session {\n     pub perf_stats: PerfStats,\n \n     /// Data about code being compiled, gathered during compilation.\n-    pub code_stats: Lock<CodeStats>,\n+    pub code_stats: CodeStats,\n \n     /// If `-zfuel=crate=n` is specified, `Some(crate)`.\n     optimization_fuel_crate: Option<String>,"}, {"sha": "56fa2d6e89dcaf505b34e0022eeb66a6e0780b3d", "filename": "src/librustc/ty/layout.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/2c34f384d4d2289e9c83000c01e8a4f98486e8ec/src%2Flibrustc%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2c34f384d4d2289e9c83000c01e8a4f98486e8ec/src%2Flibrustc%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Flayout.rs?ref=2c34f384d4d2289e9c83000c01e8a4f98486e8ec", "patch": "@@ -1614,13 +1614,13 @@ impl<'tcx> LayoutCx<'tcx, TyCtxt<'tcx>> {\n         // (delay format until we actually need it)\n         let record = |kind, packed, opt_discr_size, variants| {\n             let type_desc = format!(\"{:?}\", layout.ty);\n-            self.tcx.sess.code_stats.borrow_mut().record_type_size(kind,\n-                                                                   type_desc,\n-                                                                   layout.align.abi,\n-                                                                   layout.size,\n-                                                                   packed,\n-                                                                   opt_discr_size,\n-                                                                   variants);\n+            self.tcx.sess.code_stats.record_type_size(kind,\n+                                                      type_desc,\n+                                                      layout.align.abi,\n+                                                      layout.size,\n+                                                      packed,\n+                                                      opt_discr_size,\n+                                                      variants);\n         };\n \n         let adt_def = match layout.ty.kind {"}, {"sha": "294019496e1c515f6035261ea17ad99f71f8cbd4", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2c34f384d4d2289e9c83000c01e8a4f98486e8ec/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2c34f384d4d2289e9c83000c01e8a4f98486e8ec/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=2c34f384d4d2289e9c83000c01e8a4f98486e8ec", "patch": "@@ -394,7 +394,7 @@ pub fn run_compiler(\n         mem::drop(compiler.global_ctxt()?.take());\n \n         if sess.opts.debugging_opts.print_type_sizes {\n-            sess.code_stats.borrow().print_type_sizes();\n+            sess.code_stats.print_type_sizes();\n         }\n \n         compiler.link()?;"}]}