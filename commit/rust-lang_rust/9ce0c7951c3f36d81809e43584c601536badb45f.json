{"sha": "9ce0c7951c3f36d81809e43584c601536badb45f", "node_id": "C_kwDOAAsO6NoAKDljZTBjNzk1MWMzZjM2ZDgxODA5ZTQzNTg0YzYwMTUzNmJhZGI0NWY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-06-05T21:47:58Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-06-05T21:47:58Z"}, "message": "Rollup merge of #112196 - compiler-errors:new-solver-resolv, r=lcnr\n\nResolve vars in result from `scrape_region_constraints`\n\nSince we perform `type_op::Normalize` in the local infcx when the new solver is enabled, vars aren't necessarily resolved, which triggers this ICE:\n\nhttps://github.com/rust-lang/rust/blob/f85ab544dfbbce7448993c490ad16c176339b939/compiler/rustc_infer/src/infer/nll_relate/mod.rs#L481\n\nThere are more tests that go from ICE -> pass due to this change, but I just added revisions to a few for CI.\n\nr? `@lcnr`", "tree": {"sha": "c12edb8098e5d4a9dadca3fe61f6c3be732c8427", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c12edb8098e5d4a9dadca3fe61f6c3be732c8427"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9ce0c7951c3f36d81809e43584c601536badb45f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkflgOCRBK7hj4Ov3rIwAAuJEIAKXZIqPI6zSNwWmI7AsXvya8\nUQkKPiXTNG1hUy8Us9icXTkCPRuzIf4vpjDWNan6cItA759w/RW9qZyxrKWRSq9U\nMT3bNbHhOOPaLAxEP/JDtfJiNcdg1eMuMox3P4lmurpeOJdvSKWhAHM0Irliw2Hh\n8PGFsUBW7SjFFBkwCaCEEn2NcPHfYQxhOYgjD3UCoRUv8rshL0bvyyIZUIcJO94o\ntHYGwpu+fndMN2eLGMsR9cyrnu16alEhtLkLvn1F5BX3W971XiTogJSwKKmjRDgp\n8KfcZdhC8nKZihlTpr23jUxIPmnic2cL4CqzvtbXhHOyNko3yCqow9JLZUq0Ncs=\n=sdq7\n-----END PGP SIGNATURE-----\n", "payload": "tree c12edb8098e5d4a9dadca3fe61f6c3be732c8427\nparent 129a57a9f6f7824ce59e70c3dcc6584447d38898\nparent 979379aff720ec20e99eeaef3d015088de0ae93d\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1686001678 +0200\ncommitter GitHub <noreply@github.com> 1686001678 +0200\n\nRollup merge of #112196 - compiler-errors:new-solver-resolv, r=lcnr\n\nResolve vars in result from `scrape_region_constraints`\n\nSince we perform `type_op::Normalize` in the local infcx when the new solver is enabled, vars aren't necessarily resolved, which triggers this ICE:\n\nhttps://github.com/rust-lang/rust/blob/f85ab544dfbbce7448993c490ad16c176339b939/compiler/rustc_infer/src/infer/nll_relate/mod.rs#L481\n\nThere are more tests that go from ICE -> pass due to this change, but I just added revisions to a few for CI.\n\nr? `@lcnr`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9ce0c7951c3f36d81809e43584c601536badb45f", "html_url": "https://github.com/rust-lang/rust/commit/9ce0c7951c3f36d81809e43584c601536badb45f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9ce0c7951c3f36d81809e43584c601536badb45f/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "129a57a9f6f7824ce59e70c3dcc6584447d38898", "url": "https://api.github.com/repos/rust-lang/rust/commits/129a57a9f6f7824ce59e70c3dcc6584447d38898", "html_url": "https://github.com/rust-lang/rust/commit/129a57a9f6f7824ce59e70c3dcc6584447d38898"}, {"sha": "979379aff720ec20e99eeaef3d015088de0ae93d", "url": "https://api.github.com/repos/rust-lang/rust/commits/979379aff720ec20e99eeaef3d015088de0ae93d", "html_url": "https://github.com/rust-lang/rust/commit/979379aff720ec20e99eeaef3d015088de0ae93d"}], "stats": {"total": 23, "additions": 18, "deletions": 5}, "files": [{"sha": "8b0973021bcc83ef7463bf711553bc49461491fd", "filename": "compiler/rustc_trait_selection/src/traits/query/type_op/custom.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/9ce0c7951c3f36d81809e43584c601536badb45f/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fcustom.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ce0c7951c3f36d81809e43584c601536badb45f/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fcustom.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fcustom.rs?ref=9ce0c7951c3f36d81809e43584c601536badb45f", "patch": "@@ -5,6 +5,7 @@ use crate::traits::ObligationCtxt;\n use rustc_errors::ErrorGuaranteed;\n use rustc_infer::infer::region_constraints::RegionConstraintData;\n use rustc_middle::traits::query::NoSolution;\n+use rustc_middle::ty::{TyCtxt, TypeFoldable};\n use rustc_span::source_map::DUMMY_SP;\n use rustc_span::Span;\n \n@@ -24,9 +25,10 @@ impl<F> CustomTypeOp<F> {\n     }\n }\n \n-impl<'tcx, F, R: fmt::Debug> super::TypeOp<'tcx> for CustomTypeOp<F>\n+impl<'tcx, F, R> super::TypeOp<'tcx> for CustomTypeOp<F>\n where\n     F: FnOnce(&ObligationCtxt<'_, 'tcx>) -> Result<R, NoSolution>,\n+    R: fmt::Debug + TypeFoldable<TyCtxt<'tcx>>,\n {\n     type Output = R;\n     /// We can't do any custom error reporting for `CustomTypeOp`, so\n@@ -57,12 +59,16 @@ impl<F> fmt::Debug for CustomTypeOp<F> {\n \n /// Executes `op` and then scrapes out all the \"old style\" region\n /// constraints that result, creating query-region-constraints.\n-pub fn scrape_region_constraints<'tcx, Op: super::TypeOp<'tcx, Output = R>, R>(\n+pub fn scrape_region_constraints<'tcx, Op, R>(\n     infcx: &InferCtxt<'tcx>,\n     op: impl FnOnce(&ObligationCtxt<'_, 'tcx>) -> Result<R, NoSolution>,\n     name: &'static str,\n     span: Span,\n-) -> Result<(TypeOpOutput<'tcx, Op>, RegionConstraintData<'tcx>), ErrorGuaranteed> {\n+) -> Result<(TypeOpOutput<'tcx, Op>, RegionConstraintData<'tcx>), ErrorGuaranteed>\n+where\n+    R: TypeFoldable<TyCtxt<'tcx>>,\n+    Op: super::TypeOp<'tcx, Output = R>,\n+{\n     // During NLL, we expect that nobody will register region\n     // obligations **except** as part of a custom type op (and, at the\n     // end of each custom type op, we scrape out the region\n@@ -91,6 +97,9 @@ pub fn scrape_region_constraints<'tcx, Op: super::TypeOp<'tcx, Output = R>, R>(\n         }\n     })?;\n \n+    // Next trait solver performs operations locally, and normalize goals should resolve vars.\n+    let value = infcx.resolve_vars_if_possible(value);\n+\n     let region_obligations = infcx.take_registered_region_obligations();\n     let region_constraint_data = infcx.take_and_reset_region_constraints();\n     let region_constraints = query_response::make_query_region_constraints("}, {"sha": "9a9f129ec3ab659edbdfcbf1dc17779b5e924e8d", "filename": "tests/ui/issues/issue-13167.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9ce0c7951c3f36d81809e43584c601536badb45f/tests%2Fui%2Fissues%2Fissue-13167.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ce0c7951c3f36d81809e43584c601536badb45f/tests%2Fui%2Fissues%2Fissue-13167.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fissues%2Fissue-13167.rs?ref=9ce0c7951c3f36d81809e43584c601536badb45f", "patch": "@@ -1,5 +1,7 @@\n // check-pass\n // pretty-expanded FIXME #23616\n+// revisions: current next\n+//[next] compile-flags: -Ztrait-solver=next\n \n use std::slice;\n "}, {"sha": "27410d4c3b08e24c536daf8369361b235a29146b", "filename": "tests/ui/issues/issue-15734.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9ce0c7951c3f36d81809e43584c601536badb45f/tests%2Fui%2Fissues%2Fissue-15734.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ce0c7951c3f36d81809e43584c601536badb45f/tests%2Fui%2Fissues%2Fissue-15734.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fissues%2Fissue-15734.rs?ref=9ce0c7951c3f36d81809e43584c601536badb45f", "patch": "@@ -1,6 +1,6 @@\n // run-pass\n-// If `Index` used an associated type for its output, this test would\n-// work more smoothly.\n+// revisions: current next\n+//[next] compile-flags: -Ztrait-solver=next\n \n use std::ops::Index;\n "}, {"sha": "015b72367f1d740f19c1a3ee192c425e105fe58f", "filename": "tests/ui/nll/issue-53119.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9ce0c7951c3f36d81809e43584c601536badb45f/tests%2Fui%2Fnll%2Fissue-53119.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ce0c7951c3f36d81809e43584c601536badb45f/tests%2Fui%2Fnll%2Fissue-53119.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fnll%2Fissue-53119.rs?ref=9ce0c7951c3f36d81809e43584c601536badb45f", "patch": "@@ -1,4 +1,6 @@\n // check-pass\n+// revisions: current next\n+//[next] compile-flags: -Ztrait-solver=next\n \n use std::ops::Deref;\n "}]}