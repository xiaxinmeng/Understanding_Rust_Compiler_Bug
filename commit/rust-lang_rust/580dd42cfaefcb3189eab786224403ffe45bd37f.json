{"sha": "580dd42cfaefcb3189eab786224403ffe45bd37f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU4MGRkNDJjZmFlZmNiMzE4OWVhYjc4NjIyNDQwM2ZmZTQ1YmQzN2Y=", "commit": {"author": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2018-02-13T12:37:32Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2018-02-13T12:37:32Z"}, "message": "incr.comp.: Run cache directory garbage collection before loading dep-graph.", "tree": {"sha": "ffb0508e16a3f2173db891fc2f453b8fc635a661", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ffb0508e16a3f2173db891fc2f453b8fc635a661"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/580dd42cfaefcb3189eab786224403ffe45bd37f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/580dd42cfaefcb3189eab786224403ffe45bd37f", "html_url": "https://github.com/rust-lang/rust/commit/580dd42cfaefcb3189eab786224403ffe45bd37f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/580dd42cfaefcb3189eab786224403ffe45bd37f/comments", "author": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4d2d3fc5dadf894a8ad709a5860a549f2c0b1032", "url": "https://api.github.com/repos/rust-lang/rust/commits/4d2d3fc5dadf894a8ad709a5860a549f2c0b1032", "html_url": "https://github.com/rust-lang/rust/commit/4d2d3fc5dadf894a8ad709a5860a549f2c0b1032"}], "stats": {"total": 29, "additions": 27, "deletions": 2}, "files": [{"sha": "b8a1fe99105406b63edbe42f6bb6e343a38578d6", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/580dd42cfaefcb3189eab786224403ffe45bd37f/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/580dd42cfaefcb3189eab786224403ffe45bd37f/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=580dd42cfaefcb3189eab786224403ffe45bd37f", "patch": "@@ -660,6 +660,15 @@ pub fn phase_2_configure_and_expand_inner<'a, F>(sess: &'a Session,\n         disambiguator,\n     );\n \n+    if sess.opts.incremental.is_some() {\n+        time(time_passes, \"garbage collect incremental cache directory\", || {\n+            if let Err(e) = rustc_incremental::garbage_collect_session_directories(sess) {\n+                warn!(\"Error while trying to garbage collect incremental \\\n+                       compilation cache directory: {}\", e);\n+            }\n+        });\n+    }\n+\n     // If necessary, compute the dependency graph (in the background).\n     let future_dep_graph = if sess.opts.build_dep_graph() {\n         Some(rustc_incremental::load_dep_graph(sess, time_passes))"}, {"sha": "65fbd9d0bf8f1a213a02dbe72347c60a1c1def77", "filename": "src/librustc_incremental/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/580dd42cfaefcb3189eab786224403ffe45bd37f/src%2Flibrustc_incremental%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/580dd42cfaefcb3189eab786224403ffe45bd37f/src%2Flibrustc_incremental%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Flib.rs?ref=580dd42cfaefcb3189eab786224403ffe45bd37f", "patch": "@@ -46,3 +46,4 @@ pub use persist::in_incr_comp_dir;\n pub use persist::prepare_session_directory;\n pub use persist::finalize_session_directory;\n pub use persist::delete_workproduct_files;\n+pub use persist::garbage_collect_session_directories;"}, {"sha": "795825f180c9dfdcb0658b1c2a1e6898043fff7a", "filename": "src/librustc_incremental/persist/fs.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/580dd42cfaefcb3189eab786224403ffe45bd37f/src%2Flibrustc_incremental%2Fpersist%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/580dd42cfaefcb3189eab786224403ffe45bd37f/src%2Flibrustc_incremental%2Fpersist%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Ffs.rs?ref=580dd42cfaefcb3189eab786224403ffe45bd37f", "patch": "@@ -603,7 +603,7 @@ fn timestamp_to_string(timestamp: SystemTime) -> String {\n }\n \n fn string_to_timestamp(s: &str) -> Result<SystemTime, ()> {\n-    let micros_since_unix_epoch = u64::from_str_radix(s, 36);\n+    let micros_since_unix_epoch = u64::from_str_radix(s, INT_ENCODE_BASE as u32);\n \n     if micros_since_unix_epoch.is_err() {\n         return Err(())\n@@ -733,6 +733,20 @@ pub fn garbage_collect_session_directories(sess: &Session) -> io::Result<()> {\n                                 })\n                                 .collect();\n \n+    // Delete all session directories that don't have a lock file.\n+    for directory_name in session_directories {\n+        if !lock_file_to_session_dir.values().any(|dir| *dir == directory_name) {\n+            let path = crate_directory.join(directory_name);\n+            if let Err(err) = safe_remove_dir_all(&path) {\n+                sess.warn(&format!(\"Failed to garbage collect invalid incremental \\\n+                                    compilation session directory `{}`: {}\",\n+                                    path.display(),\n+                                    err));\n+            }\n+        }\n+    }\n+\n+    // Now garbage collect the valid session directories.\n     let mut deletion_candidates = vec![];\n     let mut definitely_delete = vec![];\n "}, {"sha": "2f864aaefba89df6fb0a9075260e1ba0f8d53344", "filename": "src/librustc_incremental/persist/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/580dd42cfaefcb3189eab786224403ffe45bd37f/src%2Flibrustc_incremental%2Fpersist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/580dd42cfaefcb3189eab786224403ffe45bd37f/src%2Flibrustc_incremental%2Fpersist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fmod.rs?ref=580dd42cfaefcb3189eab786224403ffe45bd37f", "patch": "@@ -20,9 +20,10 @@ mod save;\n mod work_product;\n mod file_format;\n \n-pub use self::fs::prepare_session_directory;\n pub use self::fs::finalize_session_directory;\n+pub use self::fs::garbage_collect_session_directories;\n pub use self::fs::in_incr_comp_dir;\n+pub use self::fs::prepare_session_directory;\n pub use self::load::dep_graph_tcx_init;\n pub use self::load::load_dep_graph;\n pub use self::load::load_query_result_cache;"}]}