{"sha": "7d4bd54f751db36a32a7d4594f075bf1a0b92bbf", "node_id": "C_kwDOAAsO6NoAKDdkNGJkNTRmNzUxZGIzNmEzMmE3ZDQ1OTRmMDc1YmYxYTBiOTJiYmY", "commit": {"author": {"name": "Joshua Nelson", "email": "jnelson@cloudflare.com", "date": "2022-07-10T22:24:43Z"}, "committer": {"name": "Joshua Nelson", "email": "jnelson@cloudflare.com", "date": "2022-07-10T22:50:09Z"}, "message": "Fix `x build library/std compiler/rustc`\n\nPreviously, this was broken because of improper caching:\n1. `StepDescription::maybe_run` builds `Compile::Std`, which only built `std` and not `proc_macro`\n1. `Std` calls `builder.ensure(StdLink)`\n1. `Rustc` calls `ensure(Std)`, which builds all crates, including `proc_macro`\n1. `Rustc` calls `ensure(StdLink)`. `ensure` would see that it had already been run and do nothing.  <-- bug is here\n1. Cargo gives an error that `proc_macro` doesn't exist.\n\nThis fixes the caching by adding `crates` to `StdLink`, so it will get rerun if the crates that are\nbuilt change.  This also does the same for `RustcLink`; it doesn't matter in practice currently\nbecause nothing uses it except `impl Step for Rustc`, but it will avoid bugs if we start using it in\nthe future (e.g. to build individual crates for rustfmt).", "tree": {"sha": "741d63651584b541533641e7a2aad6268170fdb2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/741d63651584b541533641e7a2aad6268170fdb2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7d4bd54f751db36a32a7d4594f075bf1a0b92bbf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7d4bd54f751db36a32a7d4594f075bf1a0b92bbf", "html_url": "https://github.com/rust-lang/rust/commit/7d4bd54f751db36a32a7d4594f075bf1a0b92bbf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7d4bd54f751db36a32a7d4594f075bf1a0b92bbf/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "17355a3b9f30e16870a1890033bd13463c664f81", "url": "https://api.github.com/repos/rust-lang/rust/commits/17355a3b9f30e16870a1890033bd13463c664f81", "html_url": "https://github.com/rust-lang/rust/commit/17355a3b9f30e16870a1890033bd13463c664f81"}], "stats": {"total": 60, "additions": 38, "deletions": 22}, "files": [{"sha": "c099fedc3a72ce3f18b2ba0e58c286d233415fa8", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 38, "deletions": 22, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/7d4bd54f751db36a32a7d4594f075bf1a0b92bbf/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d4bd54f751db36a32a7d4594f075bf1a0b92bbf/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=7d4bd54f751db36a32a7d4594f075bf1a0b92bbf", "patch": "@@ -104,7 +104,7 @@ impl Step for Std {\n             || builder.config.keep_stage_std.contains(&compiler.stage)\n         {\n             builder.info(\"Warning: Using a potentially old libstd. This may not behave well.\");\n-            builder.ensure(StdLink { compiler, target_compiler: compiler, target });\n+            builder.ensure(StdLink::from_std(self, compiler));\n             return;\n         }\n \n@@ -122,11 +122,7 @@ impl Step for Std {\n             copy_third_party_objects(builder, &compiler, target);\n             copy_self_contained_objects(builder, &compiler, target);\n \n-            builder.ensure(StdLink {\n-                compiler: compiler_to_use,\n-                target_compiler: compiler,\n-                target,\n-            });\n+            builder.ensure(StdLink::from_std(self, compiler_to_use));\n             return;\n         }\n \n@@ -149,11 +145,10 @@ impl Step for Std {\n             false,\n         );\n \n-        builder.ensure(StdLink {\n-            compiler: builder.compiler(compiler.stage, builder.config.build),\n-            target_compiler: compiler,\n-            target,\n-        });\n+        builder.ensure(StdLink::from_std(\n+            self,\n+            builder.compiler(compiler.stage, builder.config.build),\n+        ));\n     }\n }\n \n@@ -394,6 +389,19 @@ struct StdLink {\n     pub compiler: Compiler,\n     pub target_compiler: Compiler,\n     pub target: TargetSelection,\n+    /// Not actually used; only present to make sure the cache invalidation is correct.\n+    crates: Interned<Vec<String>>,\n+}\n+\n+impl StdLink {\n+    fn from_std(std: Std, host_compiler: Compiler) -> Self {\n+        Self {\n+            compiler: host_compiler,\n+            target_compiler: std.compiler,\n+            target: std.target,\n+            crates: std.crates,\n+        }\n+    }\n }\n \n impl Step for StdLink {\n@@ -614,7 +622,7 @@ impl Step for Rustc {\n         if builder.config.keep_stage.contains(&compiler.stage) {\n             builder.info(\"Warning: Using a potentially old librustc. This may not behave well.\");\n             builder.info(\"Warning: Use `--keep-stage-std` if you want to rebuild the compiler when it changes\");\n-            builder.ensure(RustcLink { compiler, target_compiler: compiler, target });\n+            builder.ensure(RustcLink::from_rustc(self, compiler));\n             return;\n         }\n \n@@ -623,11 +631,7 @@ impl Step for Rustc {\n             builder.ensure(Rustc::new(compiler_to_use, target));\n             builder\n                 .info(&format!(\"Uplifting stage1 rustc ({} -> {})\", builder.config.build, target));\n-            builder.ensure(RustcLink {\n-                compiler: compiler_to_use,\n-                target_compiler: compiler,\n-                target,\n-            });\n+            builder.ensure(RustcLink::from_rustc(self, compiler_to_use));\n             return;\n         }\n \n@@ -688,11 +692,10 @@ impl Step for Rustc {\n             false,\n         );\n \n-        builder.ensure(RustcLink {\n-            compiler: builder.compiler(compiler.stage, builder.config.build),\n-            target_compiler: compiler,\n-            target,\n-        });\n+        builder.ensure(RustcLink::from_rustc(\n+            self,\n+            builder.compiler(compiler.stage, builder.config.build),\n+        ));\n     }\n }\n \n@@ -807,6 +810,19 @@ struct RustcLink {\n     pub compiler: Compiler,\n     pub target_compiler: Compiler,\n     pub target: TargetSelection,\n+    /// Not actually used; only present to make sure the cache invalidation is correct.\n+    crates: Interned<Vec<String>>,\n+}\n+\n+impl RustcLink {\n+    fn from_rustc(rustc: Rustc, host_compiler: Compiler) -> Self {\n+        Self {\n+            compiler: host_compiler,\n+            target_compiler: rustc.compiler,\n+            target: rustc.target,\n+            crates: rustc.crates,\n+        }\n+    }\n }\n \n impl Step for RustcLink {"}]}