{"sha": "e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU2OTllYTA5NmZjYzJmYzljZThlOGJjZjg4NGUxMTQ5NmEzMWNjOWY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-06-14T09:39:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-06-14T09:39:17Z"}, "message": "Auto merge of #61679 - zackmdavis:maybe_dont_indicate_the_anonymous_lifetime, r=oli-obk\n\nin which we decline to suggest the anonymous lifetime in declarations\n\nThe elided-lifetimes-in-path lint (part of our suite of Rust 2018 idiom lints which we are hoping to promote to Warn status) was firing with an illegal suggestion to write an anonymous lifetime in a\nstruct/item declaration (where we don't allow it). The linting code was already deciding whether to act on the basis of a `ParamMode` enum, indicating whether the present path-segment was part of an\nexpression, or anywhere else. The present case seemed to be part of the \"anywhere else\", and yet meriting different rules as far as the lint was concerned, so it seemed expedient to introduce a new enum member. We yank out `TyKind::Path` arm into its own method so that we can call it with our new `ParamMode` specifically when lowering struct fields\u2014one would have hoped to think of something more elegant than this, but it definitely beats changing the signature of `lower_ty` to take a `ParamMode`!\n\nResolves #61124.\n\ncc @memoryruins\nr? @oli-obk", "tree": {"sha": "39efd442986e401b1660ffe94258b39cd5e177fd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/39efd442986e401b1660ffe94258b39cd5e177fd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f", "html_url": "https://github.com/rust-lang/rust/commit/e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "42503d57907ca13e062ee614b1753ab818c7b016", "url": "https://api.github.com/repos/rust-lang/rust/commits/42503d57907ca13e062ee614b1753ab818c7b016", "html_url": "https://github.com/rust-lang/rust/commit/42503d57907ca13e062ee614b1753ab818c7b016"}, {"sha": "7a3184a04c4023d9ab93fe793c0d0ffb5e91240b", "url": "https://api.github.com/repos/rust-lang/rust/commits/7a3184a04c4023d9ab93fe793c0d0ffb5e91240b", "html_url": "https://github.com/rust-lang/rust/commit/7a3184a04c4023d9ab93fe793c0d0ffb5e91240b"}], "stats": {"total": 60, "additions": 52, "deletions": 8}, "files": [{"sha": "373f255e6366d6c40d06cbe3a186eaa3b22c02a5", "filename": "src/librustc/hir/lowering.rs", "status": "modified", "additions": 33, "deletions": 8, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f/src%2Flibrustc%2Fhir%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f/src%2Flibrustc%2Fhir%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Flowering.rs?ref=e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f", "patch": "@@ -274,6 +274,8 @@ pub fn lower_crate(\n enum ParamMode {\n     /// Any path in a type context.\n     Explicit,\n+    /// Path in a type definition, where the anonymous lifetime `'_` is not allowed.\n+    ExplicitNamed,\n     /// The `module::Type` in `module::Type::method` in an expression.\n     Optional,\n }\n@@ -1489,6 +1491,23 @@ impl<'a> LoweringContext<'a> {\n         P(self.lower_ty_direct(t, itctx))\n     }\n \n+    fn lower_path_ty(\n+        &mut self,\n+        t: &Ty,\n+        qself: &Option<QSelf>,\n+        path: &Path,\n+        param_mode: ParamMode,\n+        itctx: ImplTraitContext<'_>\n+    ) -> hir::Ty {\n+        let id = self.lower_node_id(t.id);\n+        let qpath = self.lower_qpath(t.id, qself, path, param_mode, itctx);\n+        let ty = self.ty_path(id, t.span, qpath);\n+        if let hir::TyKind::TraitObject(..) = ty.node {\n+            self.maybe_lint_bare_trait(t.span, t.id, qself.is_none() && path.is_global());\n+        }\n+        ty\n+    }\n+\n     fn lower_ty_direct(&mut self, t: &Ty, mut itctx: ImplTraitContext<'_>) -> hir::Ty {\n         let kind = match t.node {\n             TyKind::Infer => hir::TyKind::Infer,\n@@ -1534,13 +1553,7 @@ impl<'a> LoweringContext<'a> {\n                 return self.lower_ty_direct(ty, itctx);\n             }\n             TyKind::Path(ref qself, ref path) => {\n-                let id = self.lower_node_id(t.id);\n-                let qpath = self.lower_qpath(t.id, qself, path, ParamMode::Explicit, itctx);\n-                let ty = self.ty_path(id, t.span, qpath);\n-                if let hir::TyKind::TraitObject(..) = ty.node {\n-                    self.maybe_lint_bare_trait(t.span, t.id, qself.is_none() && path.is_global());\n-                }\n-                return ty;\n+                return self.lower_path_ty(t, qself, path, ParamMode::Explicit, itctx);\n             }\n             TyKind::ImplicitSelf => {\n                 let res = self.expect_full_res(t.id);\n@@ -3086,6 +3099,18 @@ impl<'a> LoweringContext<'a> {\n     }\n \n     fn lower_struct_field(&mut self, (index, f): (usize, &StructField)) -> hir::StructField {\n+        let ty = if let TyKind::Path(ref qself, ref path) = f.ty.node {\n+            let t = self.lower_path_ty(\n+                &f.ty,\n+                qself,\n+                path,\n+                ParamMode::ExplicitNamed, // no `'_` in declarations (Issue #61124)\n+                ImplTraitContext::disallowed()\n+            );\n+            P(t)\n+        } else {\n+            self.lower_ty(&f.ty, ImplTraitContext::disallowed())\n+        };\n         hir::StructField {\n             span: f.span,\n             hir_id: self.lower_node_id(f.id),\n@@ -3095,7 +3120,7 @@ impl<'a> LoweringContext<'a> {\n                 None => Ident::new(sym::integer(index), f.span),\n             },\n             vis: self.lower_visibility(&f.vis, None),\n-            ty: self.lower_ty(&f.ty, ImplTraitContext::disallowed()),\n+            ty,\n             attrs: self.lower_attrs(&f.attrs),\n         }\n     }"}, {"sha": "cf08cb7eeacd856a241baf1c3e31d953809b7ac0", "filename": "src/test/ui/in-band-lifetimes/issue-61124-anon-lifetime-in-struct-declaration.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f/src%2Ftest%2Fui%2Fin-band-lifetimes%2Fissue-61124-anon-lifetime-in-struct-declaration.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f/src%2Ftest%2Fui%2Fin-band-lifetimes%2Fissue-61124-anon-lifetime-in-struct-declaration.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fin-band-lifetimes%2Fissue-61124-anon-lifetime-in-struct-declaration.rs?ref=e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f", "patch": "@@ -0,0 +1,10 @@\n+#![deny(elided_lifetimes_in_paths)]\n+\n+// Previously, the elided-lifetimes-in-path lint would fire, but we don't want\n+// that, because `'_` isn't legal in struct declarations.\n+\n+struct Betrayal<'a> { x: &'a u8 }\n+\n+struct Heartbreak(Betrayal);  //~ ERROR missing lifetime specifier\n+\n+fn main() {}"}, {"sha": "9579abb76b32f265179c8e1011ea2f2ecbba3762", "filename": "src/test/ui/in-band-lifetimes/issue-61124-anon-lifetime-in-struct-declaration.stderr", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f/src%2Ftest%2Fui%2Fin-band-lifetimes%2Fissue-61124-anon-lifetime-in-struct-declaration.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f/src%2Ftest%2Fui%2Fin-band-lifetimes%2Fissue-61124-anon-lifetime-in-struct-declaration.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fin-band-lifetimes%2Fissue-61124-anon-lifetime-in-struct-declaration.stderr?ref=e699ea096fcc2fc9ce8e8bcf884e11496a31cc9f", "patch": "@@ -0,0 +1,9 @@\n+error[E0106]: missing lifetime specifier\n+  --> $DIR/issue-61124-anon-lifetime-in-struct-declaration.rs:8:19\n+   |\n+LL | struct Heartbreak(Betrayal);\n+   |                   ^^^^^^^^ expected lifetime parameter\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0106`."}]}