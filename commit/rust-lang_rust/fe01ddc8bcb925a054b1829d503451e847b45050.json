{"sha": "fe01ddc8bcb925a054b1829d503451e847b45050", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZlMDFkZGM4YmNiOTI1YTA1NGIxODI5ZDUwMzQ1MWU4NDdiNDUwNTA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-02-22T09:29:20Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-02-22T09:29:20Z"}, "message": "Auto merge of #6769 - Y-Nak:inconsistent-struct-constructor, r=matthiaskrgr\n\nInconsistent struct constructor\n\nfixes: #6352\nr? `@matthiaskrgr`\n\nI added the lint that checks for the struct constructors where the order of the field init shorthands is inconsistent with that in the struct definition.\n\nchangelog: Add style lint: `inconsistent_struct_constructor`", "tree": {"sha": "221022fc8634d807d8fb56bf04bf573f700998f0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/221022fc8634d807d8fb56bf04bf573f700998f0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fe01ddc8bcb925a054b1829d503451e847b45050", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fe01ddc8bcb925a054b1829d503451e847b45050", "html_url": "https://github.com/rust-lang/rust/commit/fe01ddc8bcb925a054b1829d503451e847b45050", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fe01ddc8bcb925a054b1829d503451e847b45050/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "728f3976f0dc0efee8f686d7ec7ecf2d3e7d9d6d", "url": "https://api.github.com/repos/rust-lang/rust/commits/728f3976f0dc0efee8f686d7ec7ecf2d3e7d9d6d", "html_url": "https://github.com/rust-lang/rust/commit/728f3976f0dc0efee8f686d7ec7ecf2d3e7d9d6d"}, {"sha": "bfdf0fa03f14be82d668036df221326374f7a321", "url": "https://api.github.com/repos/rust-lang/rust/commits/bfdf0fa03f14be82d668036df221326374f7a321", "html_url": "https://github.com/rust-lang/rust/commit/bfdf0fa03f14be82d668036df221326374f7a321"}], "stats": {"total": 290, "additions": 288, "deletions": 2}, "files": [{"sha": "c51557943e57a21872436c0007d76ea77e897538", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fe01ddc8bcb925a054b1829d503451e847b45050/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/fe01ddc8bcb925a054b1829d503451e847b45050/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=fe01ddc8bcb925a054b1829d503451e847b45050", "patch": "@@ -2109,6 +2109,7 @@ Released 2018-09-13\n [`implicit_saturating_sub`]: https://rust-lang.github.io/rust-clippy/master/index.html#implicit_saturating_sub\n [`imprecise_flops`]: https://rust-lang.github.io/rust-clippy/master/index.html#imprecise_flops\n [`inconsistent_digit_grouping`]: https://rust-lang.github.io/rust-clippy/master/index.html#inconsistent_digit_grouping\n+[`inconsistent_struct_constructor`]: https://rust-lang.github.io/rust-clippy/master/index.html#inconsistent_struct_constructor\n [`indexing_slicing`]: https://rust-lang.github.io/rust-clippy/master/index.html#indexing_slicing\n [`ineffective_bit_mask`]: https://rust-lang.github.io/rust-clippy/master/index.html#ineffective_bit_mask\n [`inefficient_to_string`]: https://rust-lang.github.io/rust-clippy/master/index.html#inefficient_to_string"}, {"sha": "c5afdf530eb70da76cbfa7d9dcfee0091243b84f", "filename": "clippy_lints/src/inconsistent_struct_constructor.rs", "status": "added", "additions": 134, "deletions": 0, "changes": 134, "blob_url": "https://github.com/rust-lang/rust/blob/fe01ddc8bcb925a054b1829d503451e847b45050/clippy_lints%2Fsrc%2Finconsistent_struct_constructor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe01ddc8bcb925a054b1829d503451e847b45050/clippy_lints%2Fsrc%2Finconsistent_struct_constructor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Finconsistent_struct_constructor.rs?ref=fe01ddc8bcb925a054b1829d503451e847b45050", "patch": "@@ -0,0 +1,134 @@\n+use rustc_data_structures::fx::FxHashMap;\n+use rustc_errors::Applicability;\n+use rustc_hir::{self as hir, ExprKind};\n+use rustc_lint::{LateContext, LateLintPass};\n+use rustc_session::{declare_lint_pass, declare_tool_lint};\n+use rustc_span::symbol::Symbol;\n+\n+use if_chain::if_chain;\n+\n+use crate::utils::{snippet, span_lint_and_sugg};\n+\n+declare_clippy_lint! {\n+    /// **What it does:** Checks for struct constructors where the order of the field init\n+    /// shorthand in the constructor is inconsistent with the order in the struct definition.\n+    ///\n+    /// **Why is this bad?** Since the order of fields in a constructor doesn't affect the\n+    /// resulted instance as the below example indicates,\n+    ///\n+    /// ```rust\n+    /// #[derive(Debug, PartialEq, Eq)]\n+    /// struct Foo {\n+    ///     x: i32,\n+    ///     y: i32,\n+    /// }\n+    /// let x = 1;\n+    /// let y = 2;\n+    ///\n+    /// // This assertion never fails.\n+    /// assert_eq!(Foo { x, y }, Foo { y, x });\n+    /// ```\n+    ///\n+    /// inconsistent order means nothing and just decreases readability and consistency.\n+    ///\n+    /// **Known problems:** None.\n+    ///\n+    /// **Example:**\n+    ///\n+    /// ```rust\n+    /// struct Foo {\n+    ///     x: i32,\n+    ///     y: i32,\n+    /// }\n+    /// let x = 1;\n+    /// let y = 2;\n+    /// Foo { y, x };\n+    /// ```\n+    ///\n+    /// Use instead:\n+    /// ```rust\n+    /// # struct Foo {\n+    /// #     x: i32,\n+    /// #     y: i32,\n+    /// # }\n+    /// # let x = 1;\n+    /// # let y = 2;\n+    /// Foo { x, y };\n+    /// ```\n+    pub INCONSISTENT_STRUCT_CONSTRUCTOR,\n+    style,\n+    \"the order of the field init shorthand is inconsistent with the order in the struct definition\"\n+}\n+\n+declare_lint_pass!(InconsistentStructConstructor => [INCONSISTENT_STRUCT_CONSTRUCTOR]);\n+\n+impl LateLintPass<'_> for InconsistentStructConstructor {\n+    fn check_expr(&mut self, cx: &LateContext<'tcx>, expr: &'tcx hir::Expr<'_>) {\n+        if_chain! {\n+            if let ExprKind::Struct(qpath, fields, base) = expr.kind;\n+            if let Some(def_id)  = cx.qpath_res(qpath, expr.hir_id).opt_def_id();\n+            let ty = cx.tcx.type_of(def_id);\n+            if let Some(adt_def) = ty.ty_adt_def();\n+            if adt_def.is_struct();\n+            if let Some(variant) = adt_def.variants.iter().next();\n+            if fields.iter().all(|f| f.is_shorthand);\n+            then {\n+                let mut def_order_map = FxHashMap::default();\n+                for (idx, field) in variant.fields.iter().enumerate() {\n+                    def_order_map.insert(field.ident.name, idx);\n+                }\n+\n+                if is_consistent_order(fields, &def_order_map) {\n+                    return;\n+                }\n+\n+                let mut ordered_fields: Vec<_> = fields.iter().map(|f| f.ident.name).collect();\n+                ordered_fields.sort_unstable_by_key(|id| def_order_map[id]);\n+\n+                let mut fields_snippet = String::new();\n+                let (last_ident, idents) = ordered_fields.split_last().unwrap();\n+                for ident in idents {\n+                    fields_snippet.push_str(&format!(\"{}, \", ident));\n+                }\n+                fields_snippet.push_str(&last_ident.to_string());\n+\n+                let base_snippet = if let Some(base) = base {\n+                        format!(\", ..{}\", snippet(cx, base.span, \"..\"))\n+                    } else {\n+                        String::new()\n+                    };\n+\n+                let sugg = format!(\"{} {{ {}{} }}\",\n+                    snippet(cx, qpath.span(), \"..\"),\n+                    fields_snippet,\n+                    base_snippet,\n+                    );\n+\n+                span_lint_and_sugg(\n+                    cx,\n+                    INCONSISTENT_STRUCT_CONSTRUCTOR,\n+                    expr.span,\n+                    \"inconsistent struct constructor\",\n+                    \"try\",\n+                    sugg,\n+                    Applicability::MachineApplicable,\n+                )\n+            }\n+        }\n+    }\n+}\n+\n+// Check whether the order of the fields in the constructor is consistent with the order in the\n+// definition.\n+fn is_consistent_order<'tcx>(fields: &'tcx [hir::Field<'tcx>], def_order_map: &FxHashMap<Symbol, usize>) -> bool {\n+    let mut cur_idx = usize::MIN;\n+    for f in fields {\n+        let next_idx = def_order_map[&f.ident.name];\n+        if cur_idx > next_idx {\n+            return false;\n+        }\n+        cur_idx = next_idx;\n+    }\n+\n+    true\n+}"}, {"sha": "7dcf7a260c87accd27a0797b45ce27bd06f482da", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fe01ddc8bcb925a054b1829d503451e847b45050/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe01ddc8bcb925a054b1829d503451e847b45050/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=fe01ddc8bcb925a054b1829d503451e847b45050", "patch": "@@ -221,6 +221,7 @@ mod if_let_some_result;\n mod if_not_else;\n mod implicit_return;\n mod implicit_saturating_sub;\n+mod inconsistent_struct_constructor;\n mod indexing_slicing;\n mod infinite_iter;\n mod inherent_impl;\n@@ -656,6 +657,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         &if_not_else::IF_NOT_ELSE,\n         &implicit_return::IMPLICIT_RETURN,\n         &implicit_saturating_sub::IMPLICIT_SATURATING_SUB,\n+        &inconsistent_struct_constructor::INCONSISTENT_STRUCT_CONSTRUCTOR,\n         &indexing_slicing::INDEXING_SLICING,\n         &indexing_slicing::OUT_OF_BOUNDS_INDEXING,\n         &infinite_iter::INFINITE_ITER,\n@@ -1036,6 +1038,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(|| box implicit_return::ImplicitReturn);\n     store.register_late_pass(|| box implicit_saturating_sub::ImplicitSaturatingSub);\n     store.register_late_pass(|| box default_numeric_fallback::DefaultNumericFallback);\n+    store.register_late_pass(|| box inconsistent_struct_constructor::InconsistentStructConstructor);\n \n     let msrv = conf.msrv.as_ref().and_then(|s| {\n         parse_msrv(s, None, None).or_else(|| {\n@@ -1486,6 +1489,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&identity_op::IDENTITY_OP),\n         LintId::of(&if_let_mutex::IF_LET_MUTEX),\n         LintId::of(&if_let_some_result::IF_LET_SOME_RESULT),\n+        LintId::of(&inconsistent_struct_constructor::INCONSISTENT_STRUCT_CONSTRUCTOR),\n         LintId::of(&indexing_slicing::OUT_OF_BOUNDS_INDEXING),\n         LintId::of(&infinite_iter::INFINITE_ITER),\n         LintId::of(&inherent_to_string::INHERENT_TO_STRING),\n@@ -1737,6 +1741,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&functions::MUST_USE_UNIT),\n         LintId::of(&functions::RESULT_UNIT_ERR),\n         LintId::of(&if_let_some_result::IF_LET_SOME_RESULT),\n+        LintId::of(&inconsistent_struct_constructor::INCONSISTENT_STRUCT_CONSTRUCTOR),\n         LintId::of(&inherent_to_string::INHERENT_TO_STRING),\n         LintId::of(&len_zero::COMPARISON_TO_EMPTY),\n         LintId::of(&len_zero::LEN_WITHOUT_IS_EMPTY),"}, {"sha": "00a707107bce91f8404057d367c1fe74d757879d", "filename": "clippy_lints/src/unnecessary_sort_by.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fe01ddc8bcb925a054b1829d503451e847b45050/clippy_lints%2Fsrc%2Funnecessary_sort_by.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe01ddc8bcb925a054b1829d503451e847b45050/clippy_lints%2Fsrc%2Funnecessary_sort_by.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Funnecessary_sort_by.rs?ref=fe01ddc8bcb925a054b1829d503451e847b45050", "patch": "@@ -212,10 +212,10 @@ fn detect_lint(cx: &LateContext<'_>, expr: &Expr<'_>) -> Option<LintTrigger> {\n             if !expr_borrows(cx, left_expr) {\n                 return Some(LintTrigger::SortByKey(SortByKeyDetection {\n                     vec_name,\n-                    unstable,\n                     closure_arg,\n                     closure_body,\n-                    reverse\n+                    reverse,\n+                    unstable,\n                 }));\n             }\n         }"}, {"sha": "8d9c311003508173c227ebaef88e3d090a9e6ed7", "filename": "tests/ui/inconsistent_struct_constructor.fixed", "status": "added", "additions": 61, "deletions": 0, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/fe01ddc8bcb925a054b1829d503451e847b45050/tests%2Fui%2Finconsistent_struct_constructor.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/fe01ddc8bcb925a054b1829d503451e847b45050/tests%2Fui%2Finconsistent_struct_constructor.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Finconsistent_struct_constructor.fixed?ref=fe01ddc8bcb925a054b1829d503451e847b45050", "patch": "@@ -0,0 +1,61 @@\n+// run-rustfix\n+// edition:2018\n+#![warn(clippy::inconsistent_struct_constructor)]\n+#![allow(clippy::redundant_field_names)]\n+#![allow(clippy::unnecessary_operation)]\n+#![allow(clippy::no_effect)]\n+#![allow(dead_code)]\n+\n+#[derive(Default)]\n+struct Foo {\n+    x: i32,\n+    y: i32,\n+    z: i32,\n+}\n+\n+mod without_base {\n+    use super::Foo;\n+\n+    fn test() {\n+        let x = 1;\n+        let y = 1;\n+        let z = 1;\n+\n+        // Should lint.\n+        Foo { x, y, z };\n+\n+        // Shoule NOT lint because the order is the same as in the definition.\n+        Foo { x, y, z };\n+\n+        // Should NOT lint because z is not a shorthand init.\n+        Foo { y, x, z: z };\n+    }\n+}\n+\n+mod with_base {\n+    use super::Foo;\n+\n+    fn test() {\n+        let x = 1;\n+        let z = 1;\n+\n+        // Should lint.\n+        Foo { x, z, ..Default::default() };\n+\n+        // Should NOT lint because the order is consistent with the definition.\n+        Foo {\n+            x,\n+            z,\n+            ..Default::default()\n+        };\n+\n+        // Should NOT lint because z is not a shorthand init.\n+        Foo {\n+            z: z,\n+            x,\n+            ..Default::default()\n+        };\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "63fac9105015d3756b5be6edc83c52777c5d5179", "filename": "tests/ui/inconsistent_struct_constructor.rs", "status": "added", "additions": 65, "deletions": 0, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/fe01ddc8bcb925a054b1829d503451e847b45050/tests%2Fui%2Finconsistent_struct_constructor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe01ddc8bcb925a054b1829d503451e847b45050/tests%2Fui%2Finconsistent_struct_constructor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Finconsistent_struct_constructor.rs?ref=fe01ddc8bcb925a054b1829d503451e847b45050", "patch": "@@ -0,0 +1,65 @@\n+// run-rustfix\n+// edition:2018\n+#![warn(clippy::inconsistent_struct_constructor)]\n+#![allow(clippy::redundant_field_names)]\n+#![allow(clippy::unnecessary_operation)]\n+#![allow(clippy::no_effect)]\n+#![allow(dead_code)]\n+\n+#[derive(Default)]\n+struct Foo {\n+    x: i32,\n+    y: i32,\n+    z: i32,\n+}\n+\n+mod without_base {\n+    use super::Foo;\n+\n+    fn test() {\n+        let x = 1;\n+        let y = 1;\n+        let z = 1;\n+\n+        // Should lint.\n+        Foo { y, x, z };\n+\n+        // Shoule NOT lint because the order is the same as in the definition.\n+        Foo { x, y, z };\n+\n+        // Should NOT lint because z is not a shorthand init.\n+        Foo { y, x, z: z };\n+    }\n+}\n+\n+mod with_base {\n+    use super::Foo;\n+\n+    fn test() {\n+        let x = 1;\n+        let z = 1;\n+\n+        // Should lint.\n+        Foo {\n+            z,\n+            x,\n+            ..Default::default()\n+        };\n+\n+        // Should NOT lint because the order is consistent with the definition.\n+        Foo {\n+            x,\n+            z,\n+            ..Default::default()\n+        };\n+\n+        // Should NOT lint because z is not a shorthand init.\n+        Foo {\n+            z: z,\n+            x,\n+            ..Default::default()\n+        };\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "d7abe44f2540834bb8dc842af33f3eefb341dc26", "filename": "tests/ui/inconsistent_struct_constructor.stderr", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/fe01ddc8bcb925a054b1829d503451e847b45050/tests%2Fui%2Finconsistent_struct_constructor.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fe01ddc8bcb925a054b1829d503451e847b45050/tests%2Fui%2Finconsistent_struct_constructor.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Finconsistent_struct_constructor.stderr?ref=fe01ddc8bcb925a054b1829d503451e847b45050", "patch": "@@ -0,0 +1,20 @@\n+error: inconsistent struct constructor\n+  --> $DIR/inconsistent_struct_constructor.rs:25:9\n+   |\n+LL |         Foo { y, x, z };\n+   |         ^^^^^^^^^^^^^^^ help: try: `Foo { x, y, z }`\n+   |\n+   = note: `-D clippy::inconsistent-struct-constructor` implied by `-D warnings`\n+\n+error: inconsistent struct constructor\n+  --> $DIR/inconsistent_struct_constructor.rs:43:9\n+   |\n+LL | /         Foo {\n+LL | |             z,\n+LL | |             x,\n+LL | |             ..Default::default()\n+LL | |         };\n+   | |_________^ help: try: `Foo { x, z, ..Default::default() }`\n+\n+error: aborting due to 2 previous errors\n+"}]}