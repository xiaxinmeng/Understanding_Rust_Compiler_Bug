{"sha": "c87e3feaee3625b943d5297d5ba9ffd5b2c5d872", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM4N2UzZmVhZWUzNjI1Yjk0M2Q1Mjk3ZDViYTlmZmQ1YjJjNWQ4NzI=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-07-12T12:25:23Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-07-12T12:25:23Z"}, "message": "Rollup merge of #51816 - nodakai:conf-py-tmpfile, r=kennytm\n\nbootstrap: write texts to a .tmp file first for atomicity\n\nIf you are using a hard-linked file as your config.toml, this change will affect the way other instances of the file is modified.\nThe original version would modify all other instances whereas the new version will leave others unchanged, reducing the ref count by one.", "tree": {"sha": "f4d56f33ed746cd582e693b7191b029e7069a115", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f4d56f33ed746cd582e693b7191b029e7069a115"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c87e3feaee3625b943d5297d5ba9ffd5b2c5d872", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbR0izCRBK7hj4Ov3rIwAAdHIIAJajk84q2bhI+2TFxGEF4smL\nR33Hd04rVGT9SdITZ4qJsyg/7oa+pihnfXW3dfUo/UMCB71XniczwYfJ52QY/Mpj\nrhOLvFhMGsHhJ0Xyj+7Uq3dsGp1R41R6siiISJUNOkzbU4QDRzGAtqmLgKhywcKa\nEo6XOJyGJJKXe4RyFljqbz1LzlvekhV5dgYH4h9bSPX89P3AH3bqktRI7hwfdAMZ\nvIzB4rs9Z3rlIedDACnPo6/oBHn8VbHPh0K5WLAUf6suYBQeZBPux168bPWeN2OX\nc05pMgATJ4Ew2t+38DrYGiFhjbQ69ngtRa0l7fjvmK07b5IiUCVDHubX/DUOPBY=\n=WkrG\n-----END PGP SIGNATURE-----\n", "payload": "tree f4d56f33ed746cd582e693b7191b029e7069a115\nparent d334027c58060449cc45b8e5cc37dd51ca077d30\nparent 97d0bc3f044a2f105ec760f78da800a1e44c8f05\nauthor kennytm <kennytm@gmail.com> 1531398323 +0800\ncommitter GitHub <noreply@github.com> 1531398323 +0800\n\nRollup merge of #51816 - nodakai:conf-py-tmpfile, r=kennytm\n\nbootstrap: write texts to a .tmp file first for atomicity\n\nIf you are using a hard-linked file as your config.toml, this change will affect the way other instances of the file is modified.\nThe original version would modify all other instances whereas the new version will leave others unchanged, reducing the ref count by one.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c87e3feaee3625b943d5297d5ba9ffd5b2c5d872", "html_url": "https://github.com/rust-lang/rust/commit/c87e3feaee3625b943d5297d5ba9ffd5b2c5d872", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c87e3feaee3625b943d5297d5ba9ffd5b2c5d872/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d334027c58060449cc45b8e5cc37dd51ca077d30", "url": "https://api.github.com/repos/rust-lang/rust/commits/d334027c58060449cc45b8e5cc37dd51ca077d30", "html_url": "https://github.com/rust-lang/rust/commit/d334027c58060449cc45b8e5cc37dd51ca077d30"}, {"sha": "97d0bc3f044a2f105ec760f78da800a1e44c8f05", "url": "https://api.github.com/repos/rust-lang/rust/commits/97d0bc3f044a2f105ec760f78da800a1e44c8f05", "html_url": "https://github.com/rust-lang/rust/commit/97d0bc3f044a2f105ec760f78da800a1e44c8f05"}], "stats": {"total": 23, "additions": 18, "deletions": 5}, "files": [{"sha": "71c1c61e3d97ebd51e9bd8cf5b9946cbcbe5ca5c", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 16, "deletions": 3, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/c87e3feaee3625b943d5297d5ba9ffd5b2c5d872/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/c87e3feaee3625b943d5297d5ba9ffd5b2c5d872/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=c87e3feaee3625b943d5297d5ba9ffd5b2c5d872", "patch": "@@ -303,6 +303,19 @@ def default_build_triple():\n     return \"{}-{}\".format(cputype, ostype)\n \n \n+@contextlib.contextmanager\n+def output(filepath):\n+    tmp = filepath + '.tmp'\n+    with open(tmp, 'w') as f:\n+        yield f\n+    try:\n+        os.remove(filepath)  # PermissionError/OSError on Win32 if in use\n+        os.rename(tmp, filepath)\n+    except OSError:\n+        shutil.copy2(tmp, filepath)\n+        os.remove(tmp)\n+\n+\n class RustBuild(object):\n     \"\"\"Provide all the methods required to build Rust\"\"\"\n     def __init__(self):\n@@ -346,7 +359,7 @@ def download_stage0(self):\n             self._download_stage0_helper(filename, \"rustc\")\n             self.fix_executable(\"{}/bin/rustc\".format(self.bin_root()))\n             self.fix_executable(\"{}/bin/rustdoc\".format(self.bin_root()))\n-            with open(self.rustc_stamp(), 'w') as rust_stamp:\n+            with output(self.rustc_stamp()) as rust_stamp:\n                 rust_stamp.write(self.date)\n \n             # This is required so that we don't mix incompatible MinGW\n@@ -363,7 +376,7 @@ def download_stage0(self):\n             filename = \"cargo-{}-{}.tar.gz\".format(cargo_channel, self.build)\n             self._download_stage0_helper(filename, \"cargo\")\n             self.fix_executable(\"{}/bin/cargo\".format(self.bin_root()))\n-            with open(self.cargo_stamp(), 'w') as cargo_stamp:\n+            with output(self.cargo_stamp()) as cargo_stamp:\n                 cargo_stamp.write(self.date)\n \n     def _download_stage0_helper(self, filename, pattern):\n@@ -776,7 +789,7 @@ def bootstrap(help_triggered):\n     if build.use_vendored_sources:\n         if not os.path.exists('.cargo'):\n             os.makedirs('.cargo')\n-        with open('.cargo/config', 'w') as cargo_config:\n+        with output('.cargo/config') as cargo_config:\n             cargo_config.write(\"\"\"\n                 [source.crates-io]\n                 replace-with = 'vendored-sources'"}, {"sha": "9fdba044f4be3da82b035e5bc110c4a477f9085d", "filename": "src/bootstrap/configure.py", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c87e3feaee3625b943d5297d5ba9ffd5b2c5d872/src%2Fbootstrap%2Fconfigure.py", "raw_url": "https://github.com/rust-lang/rust/raw/c87e3feaee3625b943d5297d5ba9ffd5b2c5d872/src%2Fbootstrap%2Fconfigure.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfigure.py?ref=c87e3feaee3625b943d5297d5ba9ffd5b2c5d872", "patch": "@@ -432,7 +432,7 @@ def configure_section(lines, config):\n # order that we read it in.\n p(\"\")\n p(\"writing `config.toml` in current directory\")\n-with open('config.toml', 'w') as f:\n+with bootstrap.output('config.toml') as f:\n     for section in section_order:\n         if section == 'target':\n             for target in targets:\n@@ -442,7 +442,7 @@ def configure_section(lines, config):\n             for line in sections[section]:\n                 f.write(line + \"\\n\")\n \n-with open('Makefile', 'w') as f:\n+with bootstrap.output('Makefile') as f:\n     contents = os.path.join(rust_dir, 'src', 'bootstrap', 'mk', 'Makefile.in')\n     contents = open(contents).read()\n     contents = contents.replace(\"$(CFG_SRC_DIR)\", rust_dir + '/')"}]}