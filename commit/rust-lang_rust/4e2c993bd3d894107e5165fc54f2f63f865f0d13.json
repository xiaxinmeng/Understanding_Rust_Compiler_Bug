{"sha": "4e2c993bd3d894107e5165fc54f2f63f865f0d13", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRlMmM5OTNiZDNkODk0MTA3ZTUxNjVmYzU0ZjJmNjNmODY1ZjBkMTM=", "commit": {"author": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2017-02-23T17:03:30Z"}, "committer": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2017-02-23T18:03:18Z"}, "message": "trans: don't ICE when trying to create ADT trans-items\n\nADTs are translated in-place from rustc_trans::callee, so no trans-items\nare needed.\n\nThis fix will be superseded by the shimmir branch, but I prefer not to\nbackport that to beta.\n\nFixes #39823.", "tree": {"sha": "c032cf54e0b27776dc91350bcad2a0c8b53ae7d0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c032cf54e0b27776dc91350bcad2a0c8b53ae7d0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4e2c993bd3d894107e5165fc54f2f63f865f0d13", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4e2c993bd3d894107e5165fc54f2f63f865f0d13", "html_url": "https://github.com/rust-lang/rust/commit/4e2c993bd3d894107e5165fc54f2f63f865f0d13", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4e2c993bd3d894107e5165fc54f2f63f865f0d13/comments", "author": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "306035c21741928bef75b8915d2195cce400b70a", "url": "https://api.github.com/repos/rust-lang/rust/commits/306035c21741928bef75b8915d2195cce400b70a", "html_url": "https://github.com/rust-lang/rust/commit/306035c21741928bef75b8915d2195cce400b70a"}], "stats": {"total": 69, "additions": 62, "deletions": 7}, "files": [{"sha": "9de667fc77c8cb07b52700eb2576311db32a23b2", "filename": "src/librustc_trans/collector.rs", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/4e2c993bd3d894107e5165fc54f2f63f865f0d13/src%2Flibrustc_trans%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e2c993bd3d894107e5165fc54f2f63f865f0d13/src%2Flibrustc_trans%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fcollector.rs?ref=4e2c993bd3d894107e5165fc54f2f63f865f0d13", "patch": "@@ -615,19 +615,13 @@ impl<'a, 'tcx> MirVisitor<'tcx> for MirNeighborCollector<'a, 'tcx> {\n                                               def_id: DefId)\n                                               -> bool {\n             match tcx.item_type(def_id).sty {\n-                ty::TyFnDef(def_id, _, f) => {\n+                ty::TyFnDef(def_id, _, _) => {\n                     // Some constructors also have type TyFnDef but they are\n                     // always instantiated inline and don't result in a\n                     // translation item. Same for FFI functions.\n                     if let Some(hir_map::NodeForeignItem(_)) = tcx.hir.get_if_local(def_id) {\n                         return false;\n                     }\n-\n-                    if let Some(adt_def) = f.sig.output().skip_binder().ty_adt_def() {\n-                        if adt_def.variants.iter().any(|v| def_id == v.did) {\n-                            return false;\n-                        }\n-                    }\n                 }\n                 ty::TyClosure(..) => {}\n                 _ => return false\n@@ -689,6 +683,16 @@ impl<'a, 'tcx> MirVisitor<'tcx> for MirNeighborCollector<'a, 'tcx> {\n fn should_trans_locally<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n                                   def_id: DefId)\n                                   -> bool {\n+    if let ty::TyFnDef(_, _, f) = tcx.item_type(def_id).sty {\n+        if let Some(adt_def) = f.sig.output().skip_binder().ty_adt_def() {\n+            if adt_def.variants.iter().any(|v| def_id == v.did) {\n+                // HACK: ADT constructors are translated in-place and\n+                // do not have a trans-item.\n+                return false;\n+            }\n+        }\n+    }\n+\n     if def_id.is_local() {\n         true\n     } else {"}, {"sha": "5342601ac14ff9a937b00a9732eb8b04e6f868c9", "filename": "src/test/run-pass/auxiliary/issue_39823.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/4e2c993bd3d894107e5165fc54f2f63f865f0d13/src%2Ftest%2Frun-pass%2Fauxiliary%2Fissue_39823.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e2c993bd3d894107e5165fc54f2f63f865f0d13/src%2Ftest%2Frun-pass%2Fauxiliary%2Fissue_39823.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fauxiliary%2Fissue_39823.rs?ref=4e2c993bd3d894107e5165fc54f2f63f865f0d13", "patch": "@@ -0,0 +1,17 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![crate_type=\"rlib\"]\n+\n+#[derive(Debug, PartialEq)]\n+pub struct RemoteC(pub u32);\n+\n+#[derive(Debug, PartialEq)]\n+pub struct RemoteG<T>(pub T);"}, {"sha": "061a55b03b21884ba097dc0ea71dcff9c4a39f03", "filename": "src/test/run-pass/issue-39823.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/4e2c993bd3d894107e5165fc54f2f63f865f0d13/src%2Ftest%2Frun-pass%2Fissue-39823.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e2c993bd3d894107e5165fc54f2f63f865f0d13/src%2Ftest%2Frun-pass%2Fissue-39823.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-39823.rs?ref=4e2c993bd3d894107e5165fc54f2f63f865f0d13", "patch": "@@ -0,0 +1,34 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:issue_39823.rs\n+\n+extern crate issue_39823;\n+use issue_39823::{RemoteC, RemoteG};\n+\n+#[derive(Debug, PartialEq)]\n+struct LocalC(u32);\n+\n+#[derive(Debug, PartialEq)]\n+struct LocalG<T>(T);\n+\n+fn main() {\n+    let virtual_localc : &Fn(_) -> LocalC = &LocalC;\n+    assert_eq!(virtual_localc(1), LocalC(1));\n+\n+    let virtual_localg : &Fn(_) -> LocalG<u32> = &LocalG;\n+    assert_eq!(virtual_localg(1), LocalG(1));\n+\n+    let virtual_remotec : &Fn(_) -> RemoteC = &RemoteC;\n+    assert_eq!(virtual_remotec(1), RemoteC(1));\n+\n+    let virtual_remoteg : &Fn(_) -> RemoteG<u32> = &RemoteG;\n+    assert_eq!(virtual_remoteg(1), RemoteG(1));\n+}"}]}