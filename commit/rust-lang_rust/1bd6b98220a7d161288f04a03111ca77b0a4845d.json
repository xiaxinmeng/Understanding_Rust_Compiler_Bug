{"sha": "1bd6b98220a7d161288f04a03111ca77b0a4845d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFiZDZiOTgyMjBhN2QxNjEyODhmMDRhMDMxMTFjYTc3YjBhNDg0NWQ=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2020-02-15T12:29:45Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2020-02-15T12:29:45Z"}, "message": "Emit some additional `unused_doc_comments` lints outside of the main pass", "tree": {"sha": "a02e2ea0dc1670c2fded9e1531f286cc80743d5c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a02e2ea0dc1670c2fded9e1531f286cc80743d5c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1bd6b98220a7d161288f04a03111ca77b0a4845d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1bd6b98220a7d161288f04a03111ca77b0a4845d", "html_url": "https://github.com/rust-lang/rust/commit/1bd6b98220a7d161288f04a03111ca77b0a4845d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1bd6b98220a7d161288f04a03111ca77b0a4845d/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bcd7e2b38b3eb26004bf94a63814341329233491", "url": "https://api.github.com/repos/rust-lang/rust/commits/bcd7e2b38b3eb26004bf94a63814341329233491", "html_url": "https://github.com/rust-lang/rust/commit/bcd7e2b38b3eb26004bf94a63814341329233491"}], "stats": {"total": 60, "additions": 44, "deletions": 16}, "files": [{"sha": "3c720271e4bcbb2c63e92e47856110549705d076", "filename": "src/librustc_expand/expand.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/1bd6b98220a7d161288f04a03111ca77b0a4845d/src%2Flibrustc_expand%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1bd6b98220a7d161288f04a03111ca77b0a4845d/src%2Flibrustc_expand%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_expand%2Fexpand.rs?ref=1bd6b98220a7d161288f04a03111ca77b0a4845d", "patch": "@@ -14,6 +14,7 @@ use rustc_parse::configure;\n use rustc_parse::parser::Parser;\n use rustc_parse::validate_attr;\n use rustc_parse::DirectoryOwnership;\n+use rustc_session::lint::builtin::UNUSED_DOC_COMMENTS;\n use rustc_session::parse::{feature_err, ParseSess};\n use rustc_span::source_map::respan;\n use rustc_span::symbol::{sym, Symbol};\n@@ -1090,6 +1091,10 @@ impl<'a, 'b> InvocationCollector<'a, 'b> {\n                     .note(\"this may become a hard error in a future release\")\n                     .emit();\n             }\n+\n+            if attr.doc_str().is_some() {\n+                self.cx.parse_sess.buffer_lint(&UNUSED_DOC_COMMENTS, attr.span, ast::CRATE_NODE_ID, \"yep, it's unused\");\n+            }\n         }\n     }\n }"}, {"sha": "c0eee7e05c80d76bcbc9b1793340442e44352fab", "filename": "src/librustc_lint/builtin.rs", "status": "modified", "additions": 10, "deletions": 7, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/1bd6b98220a7d161288f04a03111ca77b0a4845d/src%2Flibrustc_lint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1bd6b98220a7d161288f04a03111ca77b0a4845d/src%2Flibrustc_lint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Fbuiltin.rs?ref=1bd6b98220a7d161288f04a03111ca77b0a4845d", "patch": "@@ -738,15 +738,18 @@ impl EarlyLintPass for DeprecatedAttr {\n     }\n }\n \n-declare_lint! {\n-    pub UNUSED_DOC_COMMENTS,\n-    Warn,\n-    \"detects doc comments that aren't used by rustdoc\"\n+trait UnusedDocCommentExt {\n+    fn warn_if_doc(\n+        &self,\n+        cx: &EarlyContext<'_>,\n+        node_span: Span,\n+        node_kind: &str,\n+        is_macro_expansion: bool,\n+        attrs: &[ast::Attribute],\n+    );\n }\n \n-declare_lint_pass!(UnusedDocComment => [UNUSED_DOC_COMMENTS]);\n-\n-impl UnusedDocComment {\n+impl UnusedDocCommentExt for UnusedDocComment {\n     fn warn_if_doc(\n         &self,\n         cx: &EarlyContext<'_>,"}, {"sha": "5e3367f869657f3f092cdbe5565738233f9179ec", "filename": "src/librustc_session/lint/builtin.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/1bd6b98220a7d161288f04a03111ca77b0a4845d/src%2Flibrustc_session%2Flint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1bd6b98220a7d161288f04a03111ca77b0a4845d/src%2Flibrustc_session%2Flint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Flint%2Fbuiltin.rs?ref=1bd6b98220a7d161288f04a03111ca77b0a4845d", "patch": "@@ -557,3 +557,11 @@ declare_lint_pass! {\n         INLINE_NO_SANITIZE,\n     ]\n }\n+\n+declare_lint! {\n+    pub UNUSED_DOC_COMMENTS,\n+    Warn,\n+    \"detects doc comments that aren't used by rustdoc\"\n+}\n+\n+declare_lint_pass!(UnusedDocComment => [UNUSED_DOC_COMMENTS]);"}, {"sha": "d13db2f8f78b82cd544469e09f64806a9e6710d7", "filename": "src/test/ui/useless-comment.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1bd6b98220a7d161288f04a03111ca77b0a4845d/src%2Ftest%2Fui%2Fuseless-comment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1bd6b98220a7d161288f04a03111ca77b0a4845d/src%2Ftest%2Fui%2Fuseless-comment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fuseless-comment.rs?ref=1bd6b98220a7d161288f04a03111ca77b0a4845d", "patch": "@@ -6,7 +6,7 @@ macro_rules! mac {\n     () => {}\n }\n \n-/// foo //FIXME ERROR unused doc comment\n+/// foo //~ ERROR yep, it's unused\n mac!();\n \n fn foo() {\n@@ -29,7 +29,7 @@ fn foo() {\n     #[doc = \"bar\"] //~ ERROR unused doc comment\n     3;\n \n-    /// bar //FIXME ERROR unused doc comment\n+    /// bar //~ ERROR yep, it's unused\n     mac!();\n \n     let x = /** comment */ 47; //~ ERROR unused doc comment"}, {"sha": "76b37cfec71a4a8816c4141b24c7082d5c0fac58", "filename": "src/test/ui/useless-comment.stderr", "status": "modified", "additions": 19, "deletions": 7, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/1bd6b98220a7d161288f04a03111ca77b0a4845d/src%2Ftest%2Fui%2Fuseless-comment.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1bd6b98220a7d161288f04a03111ca77b0a4845d/src%2Ftest%2Fui%2Fuseless-comment.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fuseless-comment.stderr?ref=1bd6b98220a7d161288f04a03111ca77b0a4845d", "patch": "@@ -1,17 +1,29 @@\n-error: unused doc comment\n-  --> $DIR/useless-comment.rs:13:5\n+error: yep, it's unused\n+  --> $DIR/useless-comment.rs:9:1\n    |\n-LL |     /// a\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-LL |     let x = 12;\n-   |     ----------- rustdoc does not generate documentation for statements\n+LL | /// foo\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n note: the lint level is defined here\n   --> $DIR/useless-comment.rs:3:9\n    |\n LL | #![deny(unused_doc_comments)]\n    |         ^^^^^^^^^^^^^^^^^^^\n \n+error: yep, it's unused\n+  --> $DIR/useless-comment.rs:32:5\n+   |\n+LL |     /// bar\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: unused doc comment\n+  --> $DIR/useless-comment.rs:13:5\n+   |\n+LL |     /// a\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL |     let x = 12;\n+   |     ----------- rustdoc does not generate documentation for statements\n+\n error: unused doc comment\n   --> $DIR/useless-comment.rs:16:5\n    |\n@@ -75,5 +87,5 @@ LL | |\n LL | |     }\n    | |_____- rustdoc does not generate documentation for expressions\n \n-error: aborting due to 8 previous errors\n+error: aborting due to 10 previous errors\n "}]}