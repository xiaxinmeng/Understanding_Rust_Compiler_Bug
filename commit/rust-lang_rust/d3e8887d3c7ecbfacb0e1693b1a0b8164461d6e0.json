{"sha": "d3e8887d3c7ecbfacb0e1693b1a0b8164461d6e0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQzZTg4ODdkM2M3ZWNiZmFjYjBlMTY5M2IxYTBiODE2NDQ2MWQ2ZTA=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-09-06T21:15:01Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-09-06T21:15:01Z"}, "message": "rt: Implement poison-on-free, for debugging memory issues", "tree": {"sha": "c41e086f5d74a420e0a85c860ba0a75532a1b62f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c41e086f5d74a420e0a85c860ba0a75532a1b62f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d3e8887d3c7ecbfacb0e1693b1a0b8164461d6e0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d3e8887d3c7ecbfacb0e1693b1a0b8164461d6e0", "html_url": "https://github.com/rust-lang/rust/commit/d3e8887d3c7ecbfacb0e1693b1a0b8164461d6e0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d3e8887d3c7ecbfacb0e1693b1a0b8164461d6e0/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "23210a3293d34822579d8a58b043694286595daf", "url": "https://api.github.com/repos/rust-lang/rust/commits/23210a3293d34822579d8a58b043694286595daf", "html_url": "https://github.com/rust-lang/rust/commit/23210a3293d34822579d8a58b043694286595daf"}], "stats": {"total": 24, "additions": 23, "deletions": 1}, "files": [{"sha": "ef8a92b427fd03b0f7fde73c982b8da97e70955e", "filename": "src/rt/memory_region.cpp", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/d3e8887d3c7ecbfacb0e1693b1a0b8164461d6e0/src%2Frt%2Fmemory_region.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/d3e8887d3c7ecbfacb0e1693b1a0b8164461d6e0/src%2Frt%2Fmemory_region.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Fmemory_region.cpp?ref=d3e8887d3c7ecbfacb0e1693b1a0b8164461d6e0", "patch": "@@ -43,6 +43,7 @@ void memory_region::free(void *mem) {\n         _srv->fatal(\"live_allocs < 1\", __FILE__, __LINE__, \"\");\n     }\n     release_alloc(mem);\n+    maybe_poison(mem);\n     _srv->free(alloc);\n }\n \n@@ -52,9 +53,11 @@ memory_region::realloc(void *mem, size_t size) {\n     if (!mem) {\n         add_alloc();\n     }\n+    size_t old_size = size;\n     size += sizeof(alloc_header);\n     alloc_header *alloc = get_header(mem);\n     assert(alloc->magic == MAGIC);\n+    alloc->size = old_size;\n     alloc_header *newMem = (alloc_header *)_srv->realloc(alloc, size);\n #ifdef TRACK_ALLOCATIONS\n     if (_allocation_list[newMem->index] != alloc) {\n@@ -82,6 +85,7 @@ memory_region::malloc(size_t size, const char *tag, bool zero) {\n     mem->magic = MAGIC;\n     mem->tag = tag;\n     mem->index = -1;\n+    mem->size = old_size;\n     claim_alloc(mem->data);\n \n     if(zero) {\n@@ -169,6 +173,22 @@ memory_region::claim_alloc(void *mem) {\n     add_alloc();\n }\n \n+void\n+memory_region::maybe_poison(void *mem) {\n+    // TODO: We should lock this, in case the compiler doesn't.\n+    static int poison = -1;\n+    if (poison < 0) {\n+        char *env_str = getenv(\"RUST_POISON_ON_FREE\");\n+        poison = env_str != NULL && env_str[0] != '\\0';\n+    }\n+\n+    if (!poison)\n+        return;\n+\n+    alloc_header *alloc = get_header(mem);\n+    memset(mem, '\\xcd', alloc->size);\n+}\n+\n //\n // Local Variables:\n // mode: C++"}, {"sha": "0197057268cb8bdcd347292ff2f4b664da810e44", "filename": "src/rt/memory_region.h", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d3e8887d3c7ecbfacb0e1693b1a0b8164461d6e0/src%2Frt%2Fmemory_region.h", "raw_url": "https://github.com/rust-lang/rust/raw/d3e8887d3c7ecbfacb0e1693b1a0b8164461d6e0/src%2Frt%2Fmemory_region.h", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Fmemory_region.h?ref=d3e8887d3c7ecbfacb0e1693b1a0b8164461d6e0", "patch": "@@ -19,7 +19,7 @@ class memory_region {\n         uint32_t magic;\n         int index;\n         const char *tag;\n-        uint32_t pad;       // To stay 16 byte aligned.\n+        uint32_t size;\n         char data[];\n     };\n \n@@ -36,6 +36,8 @@ class memory_region {\n \n     void add_alloc();\n     void dec_alloc();\n+    void maybe_poison(void *mem);\n+\n public:\n     memory_region(rust_srv *srv, bool synchronized);\n     memory_region(memory_region *parent);"}]}