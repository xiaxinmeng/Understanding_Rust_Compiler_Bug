{"sha": "ca7e3c4a83e2adddf74d9a45301a84024ce1f730", "node_id": "C_kwDOAAsO6NoAKGNhN2UzYzRhODNlMmFkZGRmNzRkOWE0NTMwMWE4NDAyNGNlMWY3MzA", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-08-09T09:41:23Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-08-09T09:41:28Z"}, "message": "Keep going if normalized projection has unevaluated consts in QueryNormalizer", "tree": {"sha": "5d83f6be57d1b5be23157c9df71969154d32dfea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5d83f6be57d1b5be23157c9df71969154d32dfea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ca7e3c4a83e2adddf74d9a45301a84024ce1f730", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ca7e3c4a83e2adddf74d9a45301a84024ce1f730", "html_url": "https://github.com/rust-lang/rust/commit/ca7e3c4a83e2adddf74d9a45301a84024ce1f730", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6f18f0a9d4548bc87afff1e4c0fe9081c35002c2", "url": "https://api.github.com/repos/rust-lang/rust/commits/6f18f0a9d4548bc87afff1e4c0fe9081c35002c2", "html_url": "https://github.com/rust-lang/rust/commit/6f18f0a9d4548bc87afff1e4c0fe9081c35002c2"}], "stats": {"total": 288, "additions": 287, "deletions": 1}, "files": [{"sha": "b5e5f14064f82bc3da88de6c794b91623ca0c5c0", "filename": "compiler/rustc_trait_selection/src/traits/query/normalize.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fnormalize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fnormalize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fnormalize.rs?ref=ca7e3c4a83e2adddf74d9a45301a84024ce1f730", "patch": "@@ -194,7 +194,7 @@ impl<'cx, 'tcx> FallibleTypeFolder<'tcx> for QueryNormalizer<'cx, 'tcx> {\n         // wait to fold the substs.\n \n         // Wrap this in a closure so we don't accidentally return from the outer function\n-        let res = (|| match *ty.kind() {\n+        let mut res = (|| match *ty.kind() {\n             // This is really important. While we *can* handle this, this has\n             // severe performance implications for large opaque types with\n             // late-bound regions. See `issue-88862` benchmark.\n@@ -317,6 +317,13 @@ impl<'cx, 'tcx> FallibleTypeFolder<'tcx> for QueryNormalizer<'cx, 'tcx> {\n \n             _ => ty.try_super_fold_with(self),\n         })()?;\n+\n+        // `tcx.normalize_projection_ty` may normalize to a type that still has\n+        // unevaluated consts, so keep normalizing here if that's the case.\n+        if res != ty && res.has_type_flags(ty::TypeFlags::HAS_CT_PROJECTION) {\n+            res = res.try_super_fold_with(self)?;\n+        }\n+\n         self.cache.insert(ty, res);\n         Ok(res)\n     }"}, {"sha": "acdc348a385a310d7ed79bee44f13d0bcd63eb0f", "filename": "src/test/ui/const-generics/generic_const_exprs/issue-100217.rs", "status": "added", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-100217.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-100217.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-100217.rs?ref=ca7e3c4a83e2adddf74d9a45301a84024ce1f730", "patch": "@@ -0,0 +1,42 @@\n+// build-pass\n+\n+#![allow(incomplete_features)]\n+#![feature(generic_const_exprs)]\n+\n+trait TraitOne {\n+    const MY_NUM: usize;\n+    type MyErr: std::fmt::Debug;\n+\n+    fn do_one_stuff(arr: [u8; Self::MY_NUM]) -> Result<(), Self::MyErr>;\n+}\n+\n+trait TraitTwo {\n+    fn do_two_stuff();\n+}\n+\n+impl<O: TraitOne> TraitTwo for O\n+where\n+    [(); Self::MY_NUM]:,\n+{\n+    fn do_two_stuff() {\n+        O::do_one_stuff([5; Self::MY_NUM]).unwrap()\n+    }\n+}\n+\n+struct Blargotron;\n+\n+#[derive(Debug)]\n+struct ErrTy<const N: usize>([(); N]);\n+\n+impl TraitOne for Blargotron {\n+    const MY_NUM: usize = 3;\n+    type MyErr = ErrTy<{ Self::MY_NUM }>;\n+\n+    fn do_one_stuff(_arr: [u8; Self::MY_NUM]) -> Result<(), Self::MyErr> {\n+        Ok(())\n+    }\n+}\n+\n+fn main() {\n+    Blargotron::do_two_stuff();\n+}"}, {"sha": "3c59e1b790a12498457cc68f28d1e48d75b52dbd", "filename": "src/test/ui/const-generics/generic_const_exprs/issue-73298.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-73298.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-73298.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-73298.rs?ref=ca7e3c4a83e2adddf74d9a45301a84024ce1f730", "patch": "@@ -0,0 +1,23 @@\n+// build-pass\n+\n+#![allow(incomplete_features)]\n+#![feature(generic_const_exprs)]\n+\n+use std::convert::AsMut;\n+use std::default::Default;\n+\n+trait Foo: Sized {\n+    type Baz: Default + AsMut<[u8]>;\n+    fn bar() {\n+        Self::Baz::default().as_mut();\n+    }\n+}\n+\n+impl Foo for () {\n+    type Baz = [u8; 1 * 1];\n+    //type Baz = [u8; 1];\n+}\n+\n+fn main() {\n+    <() as Foo>::bar();\n+}"}, {"sha": "d08fc5beb75f616fed697e31f2eb6e843e0a37f3", "filename": "src/test/ui/const-generics/generic_const_exprs/issue-82268.rs", "status": "added", "additions": 73, "deletions": 0, "changes": 73, "blob_url": "https://github.com/rust-lang/rust/blob/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-82268.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-82268.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-82268.rs?ref=ca7e3c4a83e2adddf74d9a45301a84024ce1f730", "patch": "@@ -0,0 +1,73 @@\n+// build-pass\n+\n+#![allow(incomplete_features)]\n+#![feature(generic_const_exprs)]\n+\n+trait Collate<Op> {\n+    type Pass;\n+    type Fail;\n+\n+    fn collate(self) -> (Self::Pass, Self::Fail);\n+}\n+\n+impl<Op> Collate<Op> for () {\n+    type Pass = ();\n+    type Fail = ();\n+\n+    fn collate(self) -> ((), ()) {\n+        ((), ())\n+    }\n+}\n+\n+trait CollateStep<X, Prev> {\n+    type Pass;\n+    type Fail;\n+    fn collate_step(x: X, prev: Prev) -> (Self::Pass, Self::Fail);\n+}\n+\n+impl<X, P, F> CollateStep<X, (P, F)> for () {\n+    type Pass = (X, P);\n+    type Fail = F;\n+\n+    fn collate_step(x: X, (p, f): (P, F)) -> ((X, P), F) {\n+        ((x, p), f)\n+    }\n+}\n+\n+struct CollateOpImpl<const MASK: u32>;\n+trait CollateOpStep {\n+    type NextOp;\n+    type Apply;\n+}\n+\n+impl<const MASK: u32> CollateOpStep for CollateOpImpl<MASK>\n+where\n+    CollateOpImpl<{ MASK >> 1 }>: Sized,\n+{\n+    type NextOp = CollateOpImpl<{ MASK >> 1 }>;\n+    type Apply = ();\n+}\n+\n+impl<H, T, Op: CollateOpStep> Collate<Op> for (H, T)\n+where\n+    T: Collate<Op::NextOp>,\n+    Op::Apply: CollateStep<H, (T::Pass, T::Fail)>,\n+{\n+    type Pass = <Op::Apply as CollateStep<H, (T::Pass, T::Fail)>>::Pass;\n+    type Fail = <Op::Apply as CollateStep<H, (T::Pass, T::Fail)>>::Fail;\n+\n+    fn collate(self) -> (Self::Pass, Self::Fail) {\n+        <Op::Apply as CollateStep<H, (T::Pass, T::Fail)>>::collate_step(self.0, self.1.collate())\n+    }\n+}\n+\n+fn collate<X, const MASK: u32>(x: X) -> (X::Pass, X::Fail)\n+where\n+    X: Collate<CollateOpImpl<MASK>>,\n+{\n+    x.collate()\n+}\n+\n+fn main() {\n+    dbg!(collate::<_, 5>((\"Hello\", (42, ('!', ())))));\n+}"}, {"sha": "0063719b8528cb5325a6d1fcfabcf27839ffb6fd", "filename": "src/test/ui/const-generics/generic_const_exprs/issue-83972.rs", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-83972.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-83972.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-83972.rs?ref=ca7e3c4a83e2adddf74d9a45301a84024ce1f730", "patch": "@@ -0,0 +1,38 @@\n+// build-pass\n+\n+#![allow(incomplete_features)]\n+#![feature(generic_const_exprs)]\n+\n+pub trait Foo {\n+    fn foo(&self);\n+}\n+\n+pub struct FooImpl<const N: usize>;\n+impl<const N: usize> Foo for FooImpl<N> {\n+    fn foo(&self) {}\n+}\n+\n+pub trait Bar: 'static {\n+    type Foo: Foo;\n+    fn get() -> &'static Self::Foo;\n+}\n+\n+struct BarImpl;\n+impl Bar for BarImpl {\n+    type Foo = FooImpl<\n+        {\n+            { 4 }\n+        },\n+    >;\n+    fn get() -> &'static Self::Foo {\n+        &FooImpl\n+    }\n+}\n+\n+pub fn boom<B: Bar>() {\n+    B::get().foo();\n+}\n+\n+fn main() {\n+    boom::<BarImpl>();\n+}"}, {"sha": "3933ff20a49c54362d6eb69a0eeaa7498c9f5d9b", "filename": "src/test/ui/const-generics/generic_const_exprs/issue-84669.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-84669.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-84669.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-84669.rs?ref=ca7e3c4a83e2adddf74d9a45301a84024ce1f730", "patch": "@@ -0,0 +1,30 @@\n+// build-pass\n+\n+#![feature(generic_const_exprs)]\n+#![allow(incomplete_features)]\n+\n+trait Foo {\n+    type Output;\n+\n+    fn foo() -> Self::Output;\n+}\n+\n+impl Foo for [u8; 3] {\n+    type Output = [u8; 1 + 2];\n+\n+    fn foo() -> [u8; 3] {\n+        [1u8; 3]\n+    }\n+}\n+\n+fn bug<const N: usize>()\n+where\n+    [u8; N]: Foo,\n+    <[u8; N] as Foo>::Output: AsRef<[u8]>,\n+{\n+    <[u8; N]>::foo().as_ref();\n+}\n+\n+fn main() {\n+    bug::<3>();\n+}"}, {"sha": "bdd8a21b3b9918c3fc7600f8bb1f511264f866dd", "filename": "src/test/ui/const-generics/generic_const_exprs/issue-86710.rs", "status": "added", "additions": 73, "deletions": 0, "changes": 73, "blob_url": "https://github.com/rust-lang/rust/blob/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-86710.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ca7e3c4a83e2adddf74d9a45301a84024ce1f730/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-86710.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-86710.rs?ref=ca7e3c4a83e2adddf74d9a45301a84024ce1f730", "patch": "@@ -0,0 +1,73 @@\n+// build-pass\n+\n+#![allow(incomplete_features)]\n+#![feature(generic_const_exprs)]\n+\n+use std::marker::PhantomData;\n+\n+fn main() {\n+    let x = FooImpl::<BarImpl<1>> { phantom: PhantomData };\n+    let _ = x.foo::<BarImpl<1>>();\n+}\n+\n+trait Foo<T>\n+where\n+    T: Bar,\n+{\n+    fn foo<U>(&self)\n+    where\n+        T: Operation<U>,\n+        <T as Operation<U>>::Output: Bar;\n+}\n+\n+struct FooImpl<T>\n+where\n+    T: Bar,\n+{\n+    phantom: PhantomData<T>,\n+}\n+\n+impl<T> Foo<T> for FooImpl<T>\n+where\n+    T: Bar,\n+{\n+    fn foo<U>(&self)\n+    where\n+        T: Operation<U>,\n+        <T as Operation<U>>::Output: Bar,\n+    {\n+        <<T as Operation<U>>::Output as Bar>::error_occurs_here();\n+    }\n+}\n+\n+trait Bar {\n+    fn error_occurs_here();\n+}\n+\n+struct BarImpl<const N: usize>;\n+\n+impl<const N: usize> Bar for BarImpl<N> {\n+    fn error_occurs_here() {}\n+}\n+\n+trait Operation<Rhs> {\n+    type Output;\n+}\n+\n+//// Part-A: This causes error.\n+impl<const M: usize, const N: usize> Operation<BarImpl<M>> for BarImpl<N>\n+where\n+    BarImpl<{ N + M }>: Sized,\n+{\n+    type Output = BarImpl<{ N + M }>;\n+}\n+\n+//// Part-B: This doesn't cause error.\n+// impl<const M: usize, const N: usize> Operation<BarImpl<M>> for BarImpl<N> {\n+//     type Output = BarImpl<M>;\n+// }\n+\n+//// Part-C: This also doesn't cause error.\n+// impl<const M: usize, const N: usize> Operation<BarImpl<M>> for BarImpl<N> {\n+//     type Output = BarImpl<{ M }>;\n+// }"}]}