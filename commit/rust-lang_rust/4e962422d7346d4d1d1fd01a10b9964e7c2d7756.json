{"sha": "4e962422d7346d4d1d1fd01a10b9964e7c2d7756", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRlOTYyNDIyZDczNDZkNGQxZDFmZDAxYTEwYjk5NjRlN2MyZDc3NTY=", "commit": {"author": {"name": "Corey Farwell", "email": "coreyf@rwell.org", "date": "2017-03-23T13:42:45Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-03-23T13:42:45Z"}, "message": "Rollup merge of #40612 - TimNN:new-netbsd-cross, r=alexcrichton\n\nUse the \"official\" cross compiler for NetBSD\n\nThe current NetBSD cross compiler is lacking, for example `std::thread` is not available (which causes problems for LLVM 4.0). This PR uses the official netbsd build system to compiler the cross compiler.\n\n@alexcrichton: Can you please mirror `ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-7.0/source/sets/{src,gnusrc,sharesrc,syssrc}.tgz`. (Optionally you may want to use NetBSD versions 7.0.2 or 7.1, in that case you'll probably want to update the binary downloads used today as well).\n\nI'll update the URL's afterwards (or feel free to use \"allow edits from maintainers\").\n\nr? @alexcrichton", "tree": {"sha": "73eb1b3eb60e8b2b6a6ed3df81f08575d756c2eb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/73eb1b3eb60e8b2b6a6ed3df81f08575d756c2eb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4e962422d7346d4d1d1fd01a10b9964e7c2d7756", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4e962422d7346d4d1d1fd01a10b9964e7c2d7756", "html_url": "https://github.com/rust-lang/rust/commit/4e962422d7346d4d1d1fd01a10b9964e7c2d7756", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4e962422d7346d4d1d1fd01a10b9964e7c2d7756/comments", "author": {"login": "frewsxcv", "id": 416575, "node_id": "MDQ6VXNlcjQxNjU3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/416575?v=4", "gravatar_id": "", "url": "https://api.github.com/users/frewsxcv", "html_url": "https://github.com/frewsxcv", "followers_url": "https://api.github.com/users/frewsxcv/followers", "following_url": "https://api.github.com/users/frewsxcv/following{/other_user}", "gists_url": "https://api.github.com/users/frewsxcv/gists{/gist_id}", "starred_url": "https://api.github.com/users/frewsxcv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/frewsxcv/subscriptions", "organizations_url": "https://api.github.com/users/frewsxcv/orgs", "repos_url": "https://api.github.com/users/frewsxcv/repos", "events_url": "https://api.github.com/users/frewsxcv/events{/privacy}", "received_events_url": "https://api.github.com/users/frewsxcv/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "90346eae18e83887517e096c17678a74838ff995", "url": "https://api.github.com/repos/rust-lang/rust/commits/90346eae18e83887517e096c17678a74838ff995", "html_url": "https://github.com/rust-lang/rust/commit/90346eae18e83887517e096c17678a74838ff995"}, {"sha": "43a51b78b8c24f2bd40b20d1a082db1443075c19", "url": "https://api.github.com/repos/rust-lang/rust/commits/43a51b78b8c24f2bd40b20d1a082db1443075c19", "html_url": "https://github.com/rust-lang/rust/commit/43a51b78b8c24f2bd40b20d1a082db1443075c19"}], "stats": {"total": 192, "additions": 83, "deletions": 109}, "files": [{"sha": "c68f30a6e563b4fe39e2b2e59c4f5db28fb0fe88", "filename": "src/ci/docker/dist-s390x-linux-netbsd/Dockerfile", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/4e962422d7346d4d1d1fd01a10b9964e7c2d7756/src%2Fci%2Fdocker%2Fdist-s390x-linux-netbsd%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/4e962422d7346d4d1d1fd01a10b9964e7c2d7756/src%2Fci%2Fdocker%2Fdist-s390x-linux-netbsd%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-s390x-linux-netbsd%2FDockerfile?ref=4e962422d7346d4d1d1fd01a10b9964e7c2d7756", "patch": "@@ -64,17 +64,17 @@ COPY patches/ /tmp/patches/\n COPY s390x-linux-gnu.config build-s390x-toolchain.sh /tmp/\n RUN ./build-s390x-toolchain.sh\n \n-USER root\n-\n COPY build-netbsd-toolchain.sh /tmp/\n RUN ./build-netbsd-toolchain.sh\n \n-ENV PATH=$PATH:/x-tools/s390x-ibm-linux-gnu/bin\n+USER root\n+\n+ENV PATH=$PATH:/x-tools/s390x-ibm-linux-gnu/bin:/x-tools/x86_64-unknown-netbsd/bin\n \n ENV \\\n-    AR_x86_64_unknown_netbsd=x86_64-unknown-netbsd-ar \\\n-    CC_x86_64_unknown_netbsd=x86_64-unknown-netbsd-gcc \\\n-    CXX_x86_64_unknown_netbsd=x86_64-unknown-netbsd-g++ \\\n+    AR_x86_64_unknown_netbsd=x86_64--netbsd-ar \\\n+    CC_x86_64_unknown_netbsd=x86_64--netbsd-gcc-sysroot \\\n+    CXX_x86_64_unknown_netbsd=x86_64--netbsd-g++-sysroot \\\n     CC_s390x_unknown_linux_gnu=s390x-ibm-linux-gnu-gcc \\\n     AR_s390x_unknown_linux_gnu=s390x-ibm-linux-gnu-ar \\\n     CXX_s390x_unknown_linux_gnu=s390x-ibm-linux-gnu-g++"}, {"sha": "ea335a249736c703296840774638e609961625c1", "filename": "src/ci/docker/dist-s390x-linux-netbsd/build-netbsd-toolchain.sh", "status": "modified", "additions": 64, "deletions": 101, "changes": 165, "blob_url": "https://github.com/rust-lang/rust/blob/4e962422d7346d4d1d1fd01a10b9964e7c2d7756/src%2Fci%2Fdocker%2Fdist-s390x-linux-netbsd%2Fbuild-netbsd-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/4e962422d7346d4d1d1fd01a10b9964e7c2d7756/src%2Fci%2Fdocker%2Fdist-s390x-linux-netbsd%2Fbuild-netbsd-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-s390x-linux-netbsd%2Fbuild-netbsd-toolchain.sh?ref=4e962422d7346d4d1d1fd01a10b9964e7c2d7756", "patch": "@@ -13,108 +13,71 @@\n \n set -ex\n \n-BINUTILS=2.25.1\n-GCC=5.3.0\n-\n-# First up, build binutils\n-mkdir binutils\n-cd binutils\n-curl https://ftp.gnu.org/gnu/binutils/binutils-$BINUTILS.tar.bz2 | tar xjf -\n-mkdir binutils-build\n-cd binutils-build\n-../binutils-$BINUTILS/configure \\\n-  --target=x86_64-unknown-netbsd\n-make -j10\n-make install\n-cd ../..\n-rm -rf binutils\n+hide_output() {\n+  set +x\n+  on_err=\"\n+echo ERROR: An error was encountered with the build.\n+cat /tmp/build.log\n+exit 1\n+\"\n+  trap \"$on_err\" ERR\n+  bash -c \"while true; do sleep 30; echo \\$(date) - building ...; done\" &\n+  PING_LOOP_PID=$!\n+  $@ &> /tmp/build.log\n+  rm /tmp/build.log\n+  trap - ERR\n+  kill $PING_LOOP_PID\n+  set -x\n+}\n \n-# Next, download the NetBSD libc and relevant header files\n mkdir netbsd\n-# originally from:\n-# https://ftp.netbsd.org/pub/NetBSD/NetBSD-7.0/amd64/binary/sets/base.tgz\n-curl https://s3.amazonaws.com/rust-lang-ci/rust-ci-mirror/2017-01-16-netbsd-base.tgz | \\\n-  tar xzf - -C netbsd ./usr/include ./usr/lib ./lib\n-# originally from:\n-# https://ftp.netbsd.org/pub/NetBSD/NetBSD-7.0/amd64/binary/sets/comp.tgz\n-curl https://s3.amazonaws.com/rust-lang-ci/rust-ci-mirror/2017-01-16-netbsd-comp.tgz | \\\n-  tar xzf - -C netbsd ./usr/include ./usr/lib\n-\n-dst=/usr/local/x86_64-unknown-netbsd\n-cp -r netbsd/usr/include $dst\n-cp netbsd/usr/lib/crt0.o $dst/lib\n-cp netbsd/usr/lib/crti.o $dst/lib\n-cp netbsd/usr/lib/crtn.o $dst/lib\n-cp netbsd/usr/lib/crtbeginS.o $dst/lib\n-cp netbsd/usr/lib/crtendS.o $dst/lib\n-cp netbsd/usr/lib/crtbegin.o $dst/lib\n-cp netbsd/usr/lib/crtend.o $dst/lib\n-cp netbsd/usr/lib/gcrt0.o $dst/lib\n-cp netbsd/usr/lib/libc.a $dst/lib\n-cp netbsd/usr/lib/libc_p.a $dst/lib\n-cp netbsd/usr/lib/libc_pic.a $dst/lib\n-cp netbsd/lib/libc.so.12.193.1 $dst/lib\n-cp netbsd/lib/libutil.so.7.21 $dst/lib\n-cp netbsd/usr/lib/libm.a $dst/lib\n-cp netbsd/usr/lib/libm_p.a $dst/lib\n-cp netbsd/usr/lib/libm_pic.a $dst/lib\n-cp netbsd/lib/libm.so.0.11 $dst/lib\n-cp netbsd/usr/lib/librt.so.1.1 $dst/lib\n-cp netbsd/usr/lib/libpthread.a $dst/lib\n-cp netbsd/usr/lib/libpthread_p.a $dst/lib\n-cp netbsd/usr/lib/libpthread_pic.a $dst/lib\n-cp netbsd/usr/lib/libpthread.so.1.2 $dst/lib\n-\n-ln -s libc.so.12.193.1 $dst/lib/libc.so\n-ln -s libc.so.12.193.1 $dst/lib/libc.so.12\n-ln -s libm.so.0.11 $dst/lib/libm.so\n-ln -s libm.so.0.11 $dst/lib/libm.so.0\n-ln -s libutil.so.7.21 $dst/lib/libutil.so\n-ln -s libutil.so.7.21 $dst/lib/libutil.so.7\n-ln -s libpthread.so.1.2 $dst/lib/libpthread.so\n-ln -s libpthread.so.1.2 $dst/lib/libpthread.so.1\n-ln -s librt.so.1.1 $dst/lib/librt.so\n-\n-rm -rf netbsd\n-\n-# Finally, download and build gcc to target NetBSD\n-mkdir gcc\n-cd gcc\n-curl https://ftp.gnu.org/gnu/gcc/gcc-$GCC/gcc-$GCC.tar.bz2 | tar xjf -\n-cd gcc-$GCC\n-./contrib/download_prerequisites\n-\n-# Originally from\n-# ftp://ftp.netbsd.org/pub/pkgsrc/pkgsrc-2016Q4/pkgsrc/lang/gcc5/patches/patch-libstdc%2B%2B-v3_config_os_bsd_netbsd_ctype__base.h\n-PATCHES=\"https://s3.amazonaws.com/rust-lang-ci/rust-ci-mirror/2017-01-13-netbsd-patch1.patch\"\n-\n-# Originally from\n-# ftp://ftp.netbsd.org/pub/pkgsrc/pkgsrc-2016Q4/pkgsrc/lang/gcc5/patches/patch-libstdc%2B%2B-v3_config_os_bsd_netbsd_ctype__configure__char.cc\n-PATCHES=\"$PATCHES https://s3.amazonaws.com/rust-lang-ci/rust-ci-mirror/2017-01-13-netbsd-patch2.patch\"\n-\n-for patch in $PATCHES; do\n-  curl $patch | patch -Np0\n-done\n-\n-mkdir ../gcc-build\n-cd ../gcc-build\n-../gcc-$GCC/configure                            \\\n-  --enable-languages=c,c++                       \\\n-  --target=x86_64-unknown-netbsd                 \\\n-  --disable-libcilkrts                           \\\n-  --disable-multilib                             \\\n-  --disable-nls                                  \\\n-  --disable-libgomp                              \\\n-  --disable-libquadmath                          \\\n-  --disable-libssp                               \\\n-  --disable-libvtv                               \\\n-  --disable-libcilkrt                            \\\n-  --disable-libada                               \\\n-  --disable-libsanitizer                         \\\n-  --disable-libquadmath-support                  \\\n-  --disable-lto\n-make -j10\n-make install\n+cd netbsd\n+\n+mkdir -p /x-tools/x86_64-unknown-netbsd/sysroot\n+\n+URL=https://s3.amazonaws.com/rust-lang-ci/rust-ci-mirror\n+\n+# Originally from ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-$BSD/source/sets/*.tgz\n+curl $URL/2017-03-17-netbsd-src.tgz | tar xzf -\n+curl $URL/2017-03-17-netbsd-gnusrc.tgz | tar xzf -\n+curl $URL/2017-03-17-netbsd-sharesrc.tgz | tar xzf -\n+curl $URL/2017-03-17-netbsd-syssrc.tgz | tar xzf -\n+\n+# Originally from ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-$BSD/amd64/binary/sets/*.tgz\n+curl $URL/2017-03-17-netbsd-base.tgz | \\\n+  tar xzf - -C /x-tools/x86_64-unknown-netbsd/sysroot ./usr/include ./usr/lib ./lib\n+curl $URL/2017-03-17-netbsd-comp.tgz | \\\n+  tar xzf - -C /x-tools/x86_64-unknown-netbsd/sysroot ./usr/include ./usr/lib\n+\n+cd usr/src\n+\n+# The options, in order, do the following\n+# * this is an unpriviledged build\n+# * output to a predictable location\n+# * disable various uneeded stuff\n+MKUNPRIVED=yes TOOLDIR=/x-tools/x86_64-unknown-netbsd \\\n+MKSHARE=no MKDOC=no MKHTML=no MKINFO=no MKKMOD=no MKLINT=no MKMAN=no MKNLS=no MKPROFILE=no \\\n+hide_output ./build.sh -j10 -m amd64 tools\n \n cd ../..\n-rm -rf gcc\n+\n+rm -rf usr\n+\n+cat > /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-gcc-sysroot <<'EOF'\n+#!/bin/bash\n+exec /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-gcc --sysroot=/x-tools/x86_64-unknown-netbsd/sysroot \"$@\"\n+EOF\n+\n+cat > /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-g++-sysroot <<'EOF'\n+#!/bin/bash\n+exec /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-g++ --sysroot=/x-tools/x86_64-unknown-netbsd/sysroot \"$@\"\n+EOF\n+\n+GCC_SHA1=`sha1sum -b /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-gcc | cut -d' ' -f1`\n+GPP_SHA1=`sha1sum -b /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-g++ | cut -d' ' -f1`\n+\n+echo \"# $GCC_SHA1\" >> /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-gcc-sysroot\n+echo \"# $GPP_SHA1\" >> /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-g++-sysroot\n+\n+chmod +x /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-gcc-sysroot\n+chmod +x /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-g++-sysroot"}, {"sha": "42717ec289c34d019bf2b6f1a462b214f39fab59", "filename": "src/librustc_llvm/build.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/4e962422d7346d4d1d1fd01a10b9964e7c2d7756/src%2Flibrustc_llvm%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e962422d7346d4d1d1fd01a10b9964e7c2d7756/src%2Flibrustc_llvm%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_llvm%2Fbuild.rs?ref=4e962422d7346d4d1d1fd01a10b9964e7c2d7756", "patch": "@@ -131,6 +131,12 @@ fn main() {\n         if is_crossed && flag.starts_with(\"-m\") {\n             continue;\n         }\n+\n+        // -Wdate-time is not supported by the netbsd cross compiler\n+        if is_crossed && target.contains(\"netbsd\") && flag.contains(\"date-time\") {\n+            continue;\n+        }\n+\n         cfg.flag(flag);\n     }\n \n@@ -227,16 +233,21 @@ fn main() {\n         }\n     }\n \n-    // OpenBSD has a particular C++ runtime library name\n+    let llvm_static_stdcpp = env::var_os(\"LLVM_STATIC_STDCPP\");\n+\n     let stdcppname = if target.contains(\"openbsd\") {\n+        // OpenBSD has a particular C++ runtime library name\n         \"estdc++\"\n+    } else if target.contains(\"netbsd\") && llvm_static_stdcpp.is_some() {\n+        // NetBSD uses a separate library when relocation is required\n+        \"stdc++_pic\"\n     } else {\n         \"stdc++\"\n     };\n \n     // C++ runtime library\n     if !target.contains(\"msvc\") {\n-        if let Some(s) = env::var_os(\"LLVM_STATIC_STDCPP\") {\n+        if let Some(s) = llvm_static_stdcpp {\n             assert!(!cxxflags.contains(\"stdlib=libc++\"));\n             let path = PathBuf::from(s);\n             println!(\"cargo:rustc-link-search=native={}\","}]}