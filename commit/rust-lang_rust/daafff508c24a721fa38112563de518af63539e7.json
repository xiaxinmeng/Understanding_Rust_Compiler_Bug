{"sha": "daafff508c24a721fa38112563de518af63539e7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRhYWZmZjUwOGMyNGE3MjFmYTM4MTEyNTYzZGU1MThhZjYzNTM5ZTc=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-12-05T05:32:34Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-12-08T22:29:24Z"}, "message": "rustc: Prepend a length to all metadata\n\nOne of the causes of #19501 was that the metadata on OSX was getting corrupted.\nFor any one particular invocation of the compiler the metadata file inside of an\nrlib archive would have extra bytes appended to the end of it. These extra bytes\nend up confusing rbml and have it run off the end of the array (resulting in the\nout of bounds detected).\n\nThis commit prepends the length of metadata to the start of the metadata to\nensure that we always slice the precise amount that we want, and it also\nun-ignores the test from #19502.\n\nCloses #19501", "tree": {"sha": "aff56e3b5950be69e56f391f0b6c3b6507bcf357", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/aff56e3b5950be69e56f391f0b6c3b6507bcf357"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/daafff508c24a721fa38112563de518af63539e7", "comment_count": 13, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/daafff508c24a721fa38112563de518af63539e7", "html_url": "https://github.com/rust-lang/rust/commit/daafff508c24a721fa38112563de518af63539e7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/daafff508c24a721fa38112563de518af63539e7/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "361baabb07b2fb921d0f556d0787b3ea7ef86746", "url": "https://api.github.com/repos/rust-lang/rust/commits/361baabb07b2fb921d0f556d0787b3ea7ef86746", "html_url": "https://github.com/rust-lang/rust/commit/361baabb07b2fb921d0f556d0787b3ea7ef86746"}], "stats": {"total": 39, "additions": 36, "deletions": 3}, "files": [{"sha": "5a5165f344df338bd1def3228336711d57a8f995", "filename": "src/librustc/metadata/cstore.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/daafff508c24a721fa38112563de518af63539e7/src%2Flibrustc%2Fmetadata%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/daafff508c24a721fa38112563de518af63539e7/src%2Flibrustc%2Fmetadata%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Fcstore.rs?ref=daafff508c24a721fa38112563de518af63539e7", "patch": "@@ -227,9 +227,18 @@ impl crate_metadata {\n \n impl MetadataBlob {\n     pub fn as_slice<'a>(&'a self) -> &'a [u8] {\n-        match *self {\n+        let slice = match *self {\n             MetadataVec(ref vec) => vec.as_slice(),\n             MetadataArchive(ref ar) => ar.as_slice(),\n+        };\n+        if slice.len() < 4 {\n+            &[]\n+        } else {\n+            let len = ((slice[0] as u32) << 24) |\n+                      ((slice[1] as u32) << 16) |\n+                      ((slice[2] as u32) << 8) |\n+                      ((slice[3] as u32) << 0);\n+            slice.slice(4, len as uint + 4)\n         }\n     }\n }"}, {"sha": "d980d8b725562e57c93c30f00a58f65238236eca", "filename": "src/librustc/metadata/encoder.rs", "status": "modified", "additions": 26, "deletions": 1, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/daafff508c24a721fa38112563de518af63539e7/src%2Flibrustc%2Fmetadata%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/daafff508c24a721fa38112563de518af63539e7/src%2Flibrustc%2Fmetadata%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Fencoder.rs?ref=daafff508c24a721fa38112563de518af63539e7", "patch": "@@ -1979,7 +1979,32 @@ pub const metadata_encoding_version : &'static [u8] = &[b'r', b'u', b's', b't',\n pub fn encode_metadata(parms: EncodeParams, krate: &ast::Crate) -> Vec<u8> {\n     let mut wr = SeekableMemWriter::new();\n     encode_metadata_inner(&mut wr, parms, krate);\n-    wr.unwrap().into_iter().collect()\n+    let mut v = wr.unwrap();\n+\n+    // And here we run into yet another obscure archive bug: in which metadata\n+    // loaded from archives may have trailing garbage bytes. Awhile back one of\n+    // our tests was failing sporadially on the OSX 64-bit builders (both nopt\n+    // and opt) by having rbml generate an out-of-bounds panic when looking at\n+    // metadata.\n+    //\n+    // Upon investigation it turned out that the metadata file inside of an rlib\n+    // (and ar archive) was being corrupted. Some compilations would generate a\n+    // metadata file which would end in a few extra bytes, while other\n+    // compilations would not have these extra bytes appended to the end. These\n+    // extra bytes were interpreted by rbml as an extra tag, so they ended up\n+    // being interpreted causing the out-of-bounds.\n+    //\n+    // The root cause of why these extra bytes were appearing was never\n+    // discovered, and in the meantime the solution we're employing is to insert\n+    // the length of the metadata to the start of the metadata. Later on this\n+    // will allow us to slice the metadata to the precise length that we just\n+    // generated regardless of trailing bytes that end up in it.\n+    let len = v.len() as u32;\n+    v.insert(0, (len >>  0) as u8);\n+    v.insert(0, (len >>  8) as u8);\n+    v.insert(0, (len >> 16) as u8);\n+    v.insert(0, (len >> 24) as u8);\n+    return v;\n }\n \n fn encode_metadata_inner(wr: &mut SeekableMemWriter,"}, {"sha": "cd79a95dace7afcef69ac94f66e180f2218617d6", "filename": "src/test/run-pass-fulldeps/issue-13560.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/daafff508c24a721fa38112563de518af63539e7/src%2Ftest%2Frun-pass-fulldeps%2Fissue-13560.rs", "raw_url": "https://github.com/rust-lang/rust/raw/daafff508c24a721fa38112563de518af63539e7/src%2Ftest%2Frun-pass-fulldeps%2Fissue-13560.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fissue-13560.rs?ref=daafff508c24a721fa38112563de518af63539e7", "patch": "@@ -11,7 +11,6 @@\n // aux-build:issue-13560-1.rs\n // aux-build:issue-13560-2.rs\n // aux-build:issue-13560-3.rs\n-// ignore-pretty FIXME #19501\n // ignore-stage1\n \n // Regression test for issue #13560, the test itself is all in the dependent"}]}