{"sha": "3a8932d9b0d12a67c9b92e0370de708a089d50b4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNhODkzMmQ5YjBkMTJhNjdjOWI5MmUwMzcwZGU3MDhhMDg5ZDUwYjQ=", "commit": {"author": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-10-02T09:58:26Z"}, "committer": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-10-02T10:18:45Z"}, "message": "[const-prop] Correctly handle locals that can't be propagated\n\n`const_prop()` now handles writing the Rvalue into the Place in the\nstack frame for us. So if we're not supported to propagate that value,\nwe need to clear it.", "tree": {"sha": "b943be58253f56d94a9f29e42530458d7c6a7ba7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b943be58253f56d94a9f29e42530458d7c6a7ba7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3a8932d9b0d12a67c9b92e0370de708a089d50b4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3a8932d9b0d12a67c9b92e0370de708a089d50b4", "html_url": "https://github.com/rust-lang/rust/commit/3a8932d9b0d12a67c9b92e0370de708a089d50b4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3a8932d9b0d12a67c9b92e0370de708a089d50b4/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f2023ac599c38a59f86552089e6791c5a73412d3", "url": "https://api.github.com/repos/rust-lang/rust/commits/f2023ac599c38a59f86552089e6791c5a73412d3", "html_url": "https://github.com/rust-lang/rust/commit/f2023ac599c38a59f86552089e6791c5a73412d3"}], "stats": {"total": 57, "additions": 28, "deletions": 29}, "files": [{"sha": "49ac1de8fef64fe59b1cd1974f76965f3a06327d", "filename": "src/librustc_mir/transform/const_prop.rs", "status": "modified", "additions": 5, "deletions": 29, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/3a8932d9b0d12a67c9b92e0370de708a089d50b4/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a8932d9b0d12a67c9b92e0370de708a089d50b4/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs?ref=3a8932d9b0d12a67c9b92e0370de708a089d50b4", "patch": "@@ -335,34 +335,9 @@ impl<'mir, 'tcx> ConstPropagator<'mir, 'tcx> {\n     }\n \n     fn get_const(&self, local: Local) -> Option<Const<'tcx>> {\n-        let l = &self.ecx.frame().locals[local];\n-\n-        // If the local is `Unitialized` or `Dead` then we haven't propagated a value into it.\n-        //\n-        // `InterpCx::access_local()` mostly takes care of this for us however, for ZSTs,\n-        // it will synthesize a value for us. In doing so, that will cause the\n-        // `get_const(l).is_empty()` assert right before we call `set_const()` in `visit_statement`\n-        // to fail.\n-        if let LocalValue::Uninitialized | LocalValue::Dead = l.value {\n-            return None;\n-        }\n-\n         self.ecx.access_local(self.ecx.frame(), local, None).ok()\n     }\n \n-    fn set_const(&mut self, local: Local, c: Const<'tcx>) {\n-        let frame = self.ecx.frame_mut();\n-\n-        if let Some(layout) = frame.locals[local].layout.get() {\n-            debug_assert_eq!(c.layout, layout);\n-        }\n-\n-        frame.locals[local] = LocalState {\n-            value: LocalValue::Live(*c),\n-            layout: Cell::new(Some(c.layout)),\n-        };\n-    }\n-\n     fn remove_const(&mut self, local: Local) {\n         self.ecx.frame_mut().locals[local] = LocalState {\n             value: LocalValue::Uninitialized,\n@@ -735,10 +710,8 @@ impl<'mir, 'tcx> MutVisitor<'tcx> for ConstPropagator<'mir, 'tcx> {\n                                                          place) {\n                         trace!(\"checking whether {:?} can be stored to {:?}\", value, local);\n                         if self.can_const_prop[local] {\n-                            trace!(\"storing {:?} to {:?}\", value, local);\n-                            assert!(self.get_const(local).is_none() ||\n-                                    self.get_const(local) == Some(value));\n-                            self.set_const(local, value);\n+                            trace!(\"stored {:?} to {:?}\", value, local);\n+                            assert_eq!(self.get_const(local), Some(value));\n \n                             if self.should_const_prop() {\n                                 self.replace_with_const(\n@@ -747,6 +720,9 @@ impl<'mir, 'tcx> MutVisitor<'tcx> for ConstPropagator<'mir, 'tcx> {\n                                     statement.source_info,\n                                 );\n                             }\n+                        } else {\n+                            trace!(\"can't propagate {:?} to {:?}\", value, local);\n+                            self.remove_const(local);\n                         }\n                     }\n                 }"}, {"sha": "ede5081c8a5c299f28eddcc9015dd2340c4b1e1a", "filename": "src/test/ui/consts/const-eval/issue-64970.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/3a8932d9b0d12a67c9b92e0370de708a089d50b4/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fissue-64970.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a8932d9b0d12a67c9b92e0370de708a089d50b4/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fissue-64970.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fissue-64970.rs?ref=3a8932d9b0d12a67c9b92e0370de708a089d50b4", "patch": "@@ -0,0 +1,15 @@\n+// run-pass\n+\n+fn main() {\n+    foo(10);\n+}\n+\n+fn foo(mut n: i32) {\n+    if false {\n+        n = 0i32;\n+    }\n+\n+    if n > 0i32 {\n+        1i32 / n;\n+    }\n+}"}, {"sha": "2c44b68cbd1d1921213f1cf1533f0d05dd5e5b89", "filename": "src/test/ui/consts/const-eval/issue-64970.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3a8932d9b0d12a67c9b92e0370de708a089d50b4/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fissue-64970.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3a8932d9b0d12a67c9b92e0370de708a089d50b4/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fissue-64970.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fissue-64970.stderr?ref=3a8932d9b0d12a67c9b92e0370de708a089d50b4", "patch": "@@ -0,0 +1,8 @@\n+warning: unused arithmetic operation that must be used\n+  --> $DIR/issue-64970.rs:13:9\n+   |\n+LL |         1i32 / n;\n+   |         ^^^^^^^^\n+   |\n+   = note: `#[warn(unused_must_use)]` on by default\n+"}]}