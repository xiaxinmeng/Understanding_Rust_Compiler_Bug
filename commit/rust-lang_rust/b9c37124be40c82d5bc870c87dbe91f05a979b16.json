{"sha": "b9c37124be40c82d5bc870c87dbe91f05a979b16", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI5YzM3MTI0YmU0MGM4MmQ1YmM4NzBjODdkYmU5MWYwNWE5NzliMTY=", "commit": {"author": {"name": "Scott Olson", "email": "scott@solson.me", "date": "2016-05-10T03:01:12Z"}, "committer": {"name": "Scott Olson", "email": "scott@solson.me", "date": "2016-05-10T03:01:12Z"}, "message": "Handle size_of_val for slice types.", "tree": {"sha": "f2d9f5d03ffc1a09c0727290df017376eb2d9218", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f2d9f5d03ffc1a09c0727290df017376eb2d9218"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b9c37124be40c82d5bc870c87dbe91f05a979b16", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b9c37124be40c82d5bc870c87dbe91f05a979b16", "html_url": "https://github.com/rust-lang/rust/commit/b9c37124be40c82d5bc870c87dbe91f05a979b16", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b9c37124be40c82d5bc870c87dbe91f05a979b16/comments", "author": {"login": "solson", "id": 26806, "node_id": "MDQ6VXNlcjI2ODA2", "avatar_url": "https://avatars.githubusercontent.com/u/26806?v=4", "gravatar_id": "", "url": "https://api.github.com/users/solson", "html_url": "https://github.com/solson", "followers_url": "https://api.github.com/users/solson/followers", "following_url": "https://api.github.com/users/solson/following{/other_user}", "gists_url": "https://api.github.com/users/solson/gists{/gist_id}", "starred_url": "https://api.github.com/users/solson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/solson/subscriptions", "organizations_url": "https://api.github.com/users/solson/orgs", "repos_url": "https://api.github.com/users/solson/repos", "events_url": "https://api.github.com/users/solson/events{/privacy}", "received_events_url": "https://api.github.com/users/solson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "solson", "id": 26806, "node_id": "MDQ6VXNlcjI2ODA2", "avatar_url": "https://avatars.githubusercontent.com/u/26806?v=4", "gravatar_id": "", "url": "https://api.github.com/users/solson", "html_url": "https://github.com/solson", "followers_url": "https://api.github.com/users/solson/followers", "following_url": "https://api.github.com/users/solson/following{/other_user}", "gists_url": "https://api.github.com/users/solson/gists{/gist_id}", "starred_url": "https://api.github.com/users/solson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/solson/subscriptions", "organizations_url": "https://api.github.com/users/solson/orgs", "repos_url": "https://api.github.com/users/solson/repos", "events_url": "https://api.github.com/users/solson/events{/privacy}", "received_events_url": "https://api.github.com/users/solson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6d9a74885827e6e3e8e2fce857e2e45c80da7c09", "url": "https://api.github.com/repos/rust-lang/rust/commits/6d9a74885827e6e3e8e2fce857e2e45c80da7c09", "html_url": "https://github.com/rust-lang/rust/commit/6d9a74885827e6e3e8e2fce857e2e45c80da7c09"}], "stats": {"total": 36, "additions": 26, "deletions": 10}, "files": [{"sha": "3c91998b4a768e30841cd8796c50d87efe7d10a4", "filename": "src/interpreter.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/b9c37124be40c82d5bc870c87dbe91f05a979b16/src%2Finterpreter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9c37124be40c82d5bc870c87dbe91f05a979b16/src%2Finterpreter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Finterpreter.rs?ref=b9c37124be40c82d5bc870c87dbe91f05a979b16", "patch": "@@ -580,7 +580,17 @@ impl<'a, 'b, 'mir, 'tcx> FnEvalContext<'a, 'b, 'mir, 'tcx> {\n                     let size = self.type_size(ty) as u64;\n                     self.memory.write_uint(dest, size, dest_size)?;\n                 } else {\n-                    panic!(\"unimplemented: size_of_val::<{:?}>\", ty);\n+                    match ty.sty {\n+                        ty::TySlice(_) | ty::TyStr => {\n+                            let elem_ty = ty.sequence_element_type(self.tcx);\n+                            let elem_size = self.type_size(elem_ty) as u64;\n+                            let ptr_size = self.memory.pointer_size as isize;\n+                            let n = self.memory.read_usize(args[0].offset(ptr_size))?;\n+                            self.memory.write_uint(dest, n * elem_size, dest_size)?;\n+                        }\n+\n+                        _ => panic!(\"unimplemented: size_of_val::<{:?}>\", ty),\n+                    }\n                 }\n             }\n "}, {"sha": "d433310a6a89d8cc8ed6cda870b7fc51bca642f8", "filename": "tests/run-pass/arrays.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b9c37124be40c82d5bc870c87dbe91f05a979b16/tests%2Frun-pass%2Farrays.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9c37124be40c82d5bc870c87dbe91f05a979b16/tests%2Frun-pass%2Farrays.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Farrays.rs?ref=b9c37124be40c82d5bc870c87dbe91f05a979b16", "patch": "@@ -46,7 +46,7 @@ fn slice_index() -> u8 {\n \n #[miri_run]\n fn main() {\n-    //assert_eq!(empty_array(), []);\n+    // assert_eq!(empty_array(), []);\n     assert_eq!(index_unsafe(), 20);\n     assert_eq!(index(), 20);\n     assert_eq!(slice_index(), 106);"}, {"sha": "be975320bba93459ef12c289386bd71b93add79f", "filename": "tests/run-pass/calls.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/b9c37124be40c82d5bc870c87dbe91f05a979b16/tests%2Frun-pass%2Fcalls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9c37124be40c82d5bc870c87dbe91f05a979b16/tests%2Frun-pass%2Fcalls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fcalls.rs?ref=b9c37124be40c82d5bc870c87dbe91f05a979b16", "patch": "@@ -33,17 +33,10 @@ fn cross_crate_fn_call() -> i64 {\n     if 1i32.is_positive() { 1 } else { 0 }\n }\n \n-// Test one of the simplest intrinsics.\n-#[miri_run]\n-fn test_size_of() -> usize {\n-    ::std::mem::size_of::<Option<i32>>()\n-}\n-\n #[miri_run]\n fn main() {\n     assert_eq!(call(), 2);\n     assert_eq!(factorial_recursive(), 3628800);\n-    //assert_eq!(call_generic(), (42, true));\n+    assert_eq!(call_generic(), (42, true));\n     assert_eq!(cross_crate_fn_call(), 1);\n-    //assert_eq!(test_size_of(), 8);\n }"}, {"sha": "5666e191fd3736b01050ca5e0f51b715e3fa40df", "filename": "tests/run-pass/intrinsics.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/b9c37124be40c82d5bc870c87dbe91f05a979b16/tests%2Frun-pass%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9c37124be40c82d5bc870c87dbe91f05a979b16/tests%2Frun-pass%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fintrinsics.rs?ref=b9c37124be40c82d5bc870c87dbe91f05a979b16", "patch": "@@ -0,0 +1,13 @@\n+#![feature(custom_attribute)]\n+#![allow(dead_code, unused_attributes)]\n+\n+use std::mem::{size_of, size_of_val};\n+\n+#[miri_run]\n+fn main() {\n+    assert_eq!(size_of::<Option<i32>>(), 8);\n+    assert_eq!(size_of_val(&()), 0);\n+    assert_eq!(size_of_val(&42), 4);\n+    assert_eq!(size_of_val(&[] as &[i32]), 0);\n+    assert_eq!(size_of_val(&[1, 2, 3] as &[i32]), 12);\n+}"}]}