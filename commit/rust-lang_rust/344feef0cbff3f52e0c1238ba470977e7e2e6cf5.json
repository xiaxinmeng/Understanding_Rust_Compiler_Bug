{"sha": "344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "node_id": "C_kwDOAAsO6NoAKDM0NGZlZWYwY2JmZjNmNTJlMGMxMjM4YmE0NzA5NzdlN2UyZTZjZjU", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-05-29T05:22:04Z"}, "committer": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-05-29T05:22:04Z"}, "message": "Harden bad placeholder checks on statics/consts\n\nCo-authored-by: Fabian Wolff <fabian.wolff@alumni.ethz.ch>", "tree": {"sha": "db8e42a5275f46f6affbbf3505f93cb77a794cb8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/db8e42a5275f46f6affbbf3505f93cb77a794cb8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEClCZYSKPPkQPouAvN5zu/dY+XdcFAmKTA34ACgkQN5zu/dY+\nXdc33w/+KziEf7hFvTIrER8neyLpBSVKC3IK8QSaONuE+XL7Qov1qjo619ko5YrK\nJJ1QQdURuAcPJmeYhcrHk8p6SWo2GOp+puSjpwjvnhfz16UB0F8UoDM40VVLEltP\nTBFmSqOGoq+9ftHTDoq6JCEqqzPswN8GWBsgc5GB5T5ABMFgLyScN+687KJOhHNN\nfSYQf8elqP1j9MpJE9/V4uPPUnmhhU6gqzgPfB23Nn+ohVXYwzV09iOXZpZ7TVop\n3SWmixrctnmFnq52Sf2Tdk1ESWeWuhnyRBVzsHmJVVKFEbfz91KOfe++q+fvTzov\nrqgLKnwQ6EUAaugSOL89wtk1f7s+/yuO5gDzt2jf2QPWlIn8Gh0KX2Od9gdMWC70\nfnr4+QM87bJQ+QVnNUipU+y6oSU9/cM01bpzeRTOzagJD9qXaq4Y9TQj8iKV/rzb\nLP5PYF1GBTh34H4lG+X5ZaJnjpECJyqTXkTw6FpYGeku4elzDRUoNur9s47KtPOM\ntSImB0zUYjhIQ+sNFI2z7Hfk2nJY8moZfxD5DQCY8vC02A3OA4Oar+ML5w8k3yGB\nkyoa97iKJvrcGvO04dVYMYmGZvhxbwyDDLlHawH6IOrULA6NFAjxibTD30/8pnHd\n3l6CXOx4V+Ps4gUSuhWGSTHufhQ97TCVUSVq9khHg7+eozvX67M=\n=2swd\n-----END PGP SIGNATURE-----", "payload": "tree db8e42a5275f46f6affbbf3505f93cb77a794cb8\nparent 84288ed6d5307ed44a0f78e2f1ee55fbadf4e978\nauthor Yuki Okushi <jtitor@2k36.org> 1653801724 +0900\ncommitter Yuki Okushi <jtitor@2k36.org> 1653801724 +0900\n\nHarden bad placeholder checks on statics/consts\n\nCo-authored-by: Fabian Wolff <fabian.wolff@alumni.ethz.ch>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "html_url": "https://github.com/rust-lang/rust/commit/344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "84288ed6d5307ed44a0f78e2f1ee55fbadf4e978", "url": "https://api.github.com/repos/rust-lang/rust/commits/84288ed6d5307ed44a0f78e2f1ee55fbadf4e978", "html_url": "https://github.com/rust-lang/rust/commit/84288ed6d5307ed44a0f78e2f1ee55fbadf4e978"}], "stats": {"total": 84, "additions": 75, "deletions": 9}, "files": [{"sha": "81e0809592a697f8d5c77f6978fec980358bc30a", "filename": "compiler/rustc_typeck/src/collect.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs?ref=344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "patch": "@@ -805,8 +805,7 @@ fn convert_item(tcx: TyCtxt<'_>, item_id: hir::ItemId) {\n                 hir::ItemKind::Fn(..) => tcx.ensure().fn_sig(def_id),\n                 hir::ItemKind::OpaqueTy(..) => tcx.ensure().item_bounds(def_id),\n                 hir::ItemKind::Const(ty, ..) | hir::ItemKind::Static(ty, ..) => {\n-                    // (#75889): Account for `const C: dyn Fn() -> _ = \"\";`\n-                    if let hir::TyKind::TraitObject(..) = ty.kind {\n+                    if !is_suggestable_infer_ty(ty) {\n                         let mut visitor = HirPlaceholderCollector::default();\n                         visitor.visit_item(it);\n                         placeholder_type_error(tcx, None, visitor.0, false, None, it.kind.descr());"}, {"sha": "9b7c0d7cc6e2e4671c31ea8234674dda1b7afbc4", "filename": "src/test/ui/typeck/issue-74086.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Fissue-74086.rs", "raw_url": "https://github.com/rust-lang/rust/raw/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Fissue-74086.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-74086.rs?ref=344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "patch": "@@ -1,4 +1,5 @@\n fn main() {\n     static BUG: fn(_) -> u8 = |_| 8;\n     //~^ ERROR the placeholder `_` is not allowed within types on item signatures for functions [E0121]\n+    //~| ERROR the placeholder `_` is not allowed within types on item signatures for static items\n }"}, {"sha": "95ebf9a906c142beac58223f9f84cb8aed9b255a", "filename": "src/test/ui/typeck/issue-74086.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Fissue-74086.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Fissue-74086.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-74086.stderr?ref=344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "patch": "@@ -4,6 +4,12 @@ error[E0121]: the placeholder `_` is not allowed within types on item signatures\n LL |     static BUG: fn(_) -> u8 = |_| 8;\n    |                    ^ not allowed in type signatures\n \n-error: aborting due to previous error\n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for static items\n+  --> $DIR/issue-74086.rs:2:20\n+   |\n+LL |     static BUG: fn(_) -> u8 = |_| 8;\n+   |                    ^ not allowed in type signatures\n+\n+error: aborting due to 2 previous errors\n \n For more information about this error, try `rustc --explain E0121`."}, {"sha": "fb3949478a4d3e758ecd33a2ed602a2341d49de4", "filename": "src/test/ui/typeck/issue-81885.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Fissue-81885.rs", "raw_url": "https://github.com/rust-lang/rust/raw/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Fissue-81885.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-81885.rs?ref=344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "patch": "@@ -1,8 +1,9 @@\n const TEST4: fn() -> _ = 42;\n                   //~^ ERROR the placeholder `_` is not allowed within types on item signatures for functions\n+                  //~| ERROR the placeholder `_` is not allowed within types on item signatures for constant items\n \n fn main() {\n     const TEST5: fn() -> _ = 42;\n                       //~^ ERROR the placeholder `_` is not allowed within types on item signatures for functions\n-\n+                      //~| ERROR the placeholder `_` is not allowed within types on item signatures for constant items\n }"}, {"sha": "91c08bd8235029634b22313c37754ecd02746b0f", "filename": "src/test/ui/typeck/issue-81885.stderr", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Fissue-81885.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Fissue-81885.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-81885.stderr?ref=344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "patch": "@@ -4,12 +4,24 @@ error[E0121]: the placeholder `_` is not allowed within types on item signatures\n LL | const TEST4: fn() -> _ = 42;\n    |                      ^ not allowed in type signatures\n \n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for constant items\n+  --> $DIR/issue-81885.rs:1:22\n+   |\n+LL | const TEST4: fn() -> _ = 42;\n+   |                      ^ not allowed in type signatures\n+\n error[E0121]: the placeholder `_` is not allowed within types on item signatures for functions\n-  --> $DIR/issue-81885.rs:5:26\n+  --> $DIR/issue-81885.rs:6:26\n+   |\n+LL |     const TEST5: fn() -> _ = 42;\n+   |                          ^ not allowed in type signatures\n+\n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for constant items\n+  --> $DIR/issue-81885.rs:6:26\n    |\n LL |     const TEST5: fn() -> _ = 42;\n    |                          ^ not allowed in type signatures\n \n-error: aborting due to 2 previous errors\n+error: aborting due to 4 previous errors\n \n For more information about this error, try `rustc --explain E0121`."}, {"sha": "4435cba0207651dbc1c87f9fa61f6e73b58db997", "filename": "src/test/ui/typeck/issue-88643.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Fissue-88643.rs", "raw_url": "https://github.com/rust-lang/rust/raw/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Fissue-88643.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-88643.rs?ref=344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "patch": "@@ -0,0 +1,19 @@\n+// Regression test for the ICE described in #88643. Specifically:\n+// https://github.com/rust-lang/rust/issues/88643#issuecomment-913128893\n+// and https://github.com/rust-lang/rust/issues/88643#issuecomment-913171935\n+// and https://github.com/rust-lang/rust/issues/88643#issuecomment-913765984\n+\n+use std::collections::HashMap;\n+\n+pub trait T {}\n+\n+static CALLBACKS: HashMap<*const dyn T, dyn FnMut(&mut _) + 'static> = HashMap::new();\n+//~^ ERROR: the placeholder `_` is not allowed within types on item signatures for static items [E0121]\n+\n+static CALLBACKS2: Vec<dyn Fn(& _)> = Vec::new();\n+//~^ ERROR: the placeholder `_` is not allowed within types on item signatures for static items [E0121]\n+\n+static CALLBACKS3: Option<dyn Fn(& _)> = None;\n+//~^ ERROR: the placeholder `_` is not allowed within types on item signatures for static items [E0121]\n+\n+fn main() {}"}, {"sha": "d5d596b6f428444b6a3b96adaa819aba54e0f1bc", "filename": "src/test/ui/typeck/issue-88643.stderr", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Fissue-88643.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Fissue-88643.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-88643.stderr?ref=344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "patch": "@@ -0,0 +1,21 @@\n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for static items\n+  --> $DIR/issue-88643.rs:10:56\n+   |\n+LL | static CALLBACKS: HashMap<*const dyn T, dyn FnMut(&mut _) + 'static> = HashMap::new();\n+   |                                                        ^ not allowed in type signatures\n+\n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for static items\n+  --> $DIR/issue-88643.rs:13:33\n+   |\n+LL | static CALLBACKS2: Vec<dyn Fn(& _)> = Vec::new();\n+   |                                 ^ not allowed in type signatures\n+\n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for static items\n+  --> $DIR/issue-88643.rs:16:36\n+   |\n+LL | static CALLBACKS3: Option<dyn Fn(& _)> = None;\n+   |                                    ^ not allowed in type signatures\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0121`."}, {"sha": "c459d8c3cdc17663f567cc8dcfd9016394864558", "filename": "src/test/ui/typeck/typeck_type_placeholder_item_help.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item_help.rs", "raw_url": "https://github.com/rust-lang/rust/raw/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item_help.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item_help.rs?ref=344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "patch": "@@ -12,6 +12,7 @@ const TEST3: _ = Some(42);\n \n const TEST4: fn() -> _ = 42;\n //~^ ERROR the placeholder `_` is not allowed within types on item signatures for functions\n+//~| ERROR the placeholder `_` is not allowed within types on item signatures for constant items\n \n trait Test5 {\n     const TEST5: _ = 42;"}, {"sha": "07a5dbd93c7432019860cc177d5b5a6bb481da0b", "filename": "src/test/ui/typeck/typeck_type_placeholder_item_help.stderr", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item_help.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/344feef0cbff3f52e0c1238ba470977e7e2e6cf5/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item_help.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item_help.stderr?ref=344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "patch": "@@ -31,8 +31,14 @@ error[E0121]: the placeholder `_` is not allowed within types on item signatures\n LL | const TEST4: fn() -> _ = 42;\n    |                      ^ not allowed in type signatures\n \n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for constant items\n+  --> $DIR/typeck_type_placeholder_item_help.rs:13:22\n+   |\n+LL | const TEST4: fn() -> _ = 42;\n+   |                      ^ not allowed in type signatures\n+\n error[E0121]: the placeholder `_` is not allowed within types on item signatures for constants\n-  --> $DIR/typeck_type_placeholder_item_help.rs:17:18\n+  --> $DIR/typeck_type_placeholder_item_help.rs:18:18\n    |\n LL |     const TEST5: _ = 42;\n    |                  ^\n@@ -41,14 +47,14 @@ LL |     const TEST5: _ = 42;\n    |                  help: replace with the correct type: `i32`\n \n error[E0121]: the placeholder `_` is not allowed within types on item signatures for constants\n-  --> $DIR/typeck_type_placeholder_item_help.rs:24:18\n+  --> $DIR/typeck_type_placeholder_item_help.rs:25:18\n    |\n LL |     const TEST6: _ = 13;\n    |                  ^\n    |                  |\n    |                  not allowed in type signatures\n    |                  help: replace with the correct type: `i32`\n \n-error: aborting due to 6 previous errors\n+error: aborting due to 7 previous errors\n \n For more information about this error, try `rustc --explain E0121`."}]}